=== Content from github.com_33647aaf_20250115_081806.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fblob%2Fn7.0%2Flibavcodec%2Frkmppdec.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fblob%2Fn7.0%2Flibavcodec%2Frkmppdec.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=FFmpeg%2FFFmpeg)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FFmpeg](/FFmpeg)
/
**[FFmpeg](/FFmpeg/FFmpeg)**
Public

* [Notifications](/login?return_to=%2FFFmpeg%2FFFmpeg) You must be signed in to change notification settings
* [Fork
  12.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)
* [Star
   47.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)

* [Code](/FFmpeg/FFmpeg/tree/n7.0)
* [Pull requests
  1](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

Additional navigation options

* [Code](/FFmpeg/FFmpeg/tree/n7.0)
* [Pull requests](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

## Files

 n7.0
## Breadcrumbs

1. [FFmpeg](/FFmpeg/FFmpeg/tree/n7.0)
2. /[libavcodec](/FFmpeg/FFmpeg/tree/n7.0/libavcodec)
/
# rkmppdec.c

Copy path Blame  Blame
## Latest commit

## History

[History](/FFmpeg/FFmpeg/commits/n7.0/libavcodec/rkmppdec.c)587 lines (491 loc) · 19.2 KB n7.0
## Breadcrumbs

1. [FFmpeg](/FFmpeg/FFmpeg/tree/n7.0)
2. /[libavcodec](/FFmpeg/FFmpeg/tree/n7.0/libavcodec)
/
# rkmppdec.c

Top
## File metadata and controls

* Code
* Blame

587 lines (491 loc) · 19.2 KB[Raw](https://github.com/FFmpeg/FFmpeg/raw/refs/tags/n7.0/libavcodec/rkmppdec.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587/\* \* RockChip MPP Video Decoder \* Copyright (c) 2017 Lionel CHAZALLON \* \* This file is part of FFmpeg. \* \* FFmpeg is free software; you can redistribute it and/or \* modify it under the terms of the GNU Lesser General Public \* License as published by the Free Software Foundation; either \* version 2.1 of the License, or (at your option) any later version. \* \* FFmpeg is distributed in the hope that it will be useful, \* but WITHOUT ANY WARRANTY; without even the implied warranty of \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU \* Lesser General Public License for more details. \* \* You should have received a copy of the GNU Lesser General Public \* License along with FFmpeg; if not, write to the Free Software \* Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA \*/
#include <drm\_fourcc.h>#include <pthread.h>#include <rockchip/mpp\_buffer.h>#include <rockchip/rk\_mpi.h>#include <time.h>#include <unistd.h>
#include "avcodec.h"#include "codec\_internal.h"#include "decode.h"#include "hwconfig.h"#include "libavutil/buffer.h"#include "libavutil/common.h"#include "libavutil/frame.h"#include "libavutil/hwcontext.h"#include "libavutil/hwcontext\_drm.h"#include "libavutil/imgutils.h"#include "libavutil/log.h"
#define RECEIVE\_FRAME\_TIMEOUT 100#define FRAMEGROUP\_MAX\_FRAMES 16#define INPUT\_MAX\_PACKETS 4
typedef struct { MppCtx ctx; MppApi \*mpi; MppBufferGroup frame\_group;
 char first\_packet; char eos\_reached;
 AVBufferRef \*frames\_ref; AVBufferRef \*device\_ref;} RKMPPDecoder;
typedef struct { AVClass \*av\_class; AVBufferRef \*decoder\_ref;} RKMPPDecodeContext;
typedef struct { MppFrame frame; AVBufferRef \*decoder\_ref;} RKMPPFrameContext;
static MppCodingType rkmpp\_get\_codingtype(AVCodecContext \*avctx){ switch (avctx->codec\_id) { case AV\_CODEC\_ID\_H264: return MPP\_VIDEO\_CodingAVC; case AV\_CODEC\_ID\_HEVC: return MPP\_VIDEO\_CodingHEVC; case AV\_CODEC\_ID\_VP8: return MPP\_VIDEO\_CodingVP8; case AV\_CODEC\_ID\_VP9: return MPP\_VIDEO\_CodingVP9; default: return MPP\_VIDEO\_CodingUnused; }}
static uint32\_t rkmpp\_get\_frameformat(MppFrameFormat mppformat){ switch (mppformat) { case MPP\_FMT\_YUV420SP: return DRM\_FORMAT\_NV12;#ifdef DRM\_FORMAT\_NV12\_10 case MPP\_FMT\_YUV420SP\_10BIT: return DRM\_FORMAT\_NV12\_10;#endif default: return 0; }}
static int rkmpp\_write\_data(AVCodecContext \*avctx, uint8\_t \*buffer, int size, int64\_t pts){ RKMPPDecodeContext \*rk\_context = avctx->priv\_data; RKMPPDecoder \*decoder = (RKMPPDecoder \*)rk\_context->decoder\_ref->data; int ret; MppPacket packet;
 // create the MPP packet ret = mpp\_packet\_init(&packet, buffer, size); if (ret != MPP\_OK) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to init MPP packet (code = %d)\n", ret); return AVERROR\_UNKNOWN; }
 mpp\_packet\_set\_pts(packet, pts);
 if (!buffer) mpp\_packet\_set\_eos(packet);
 ret = decoder->mpi->decode\_put\_packet(decoder->ctx, packet); if (ret != MPP\_OK) { if (ret == MPP\_ERR\_BUFFER\_FULL) { av\_log(avctx, AV\_LOG\_DEBUG, "Buffer full writing %d bytes to decoder\n", size); ret = AVERROR(EAGAIN); } else ret = AVERROR\_UNKNOWN; } else av\_log(avctx, AV\_LOG\_DEBUG, "Wrote %d bytes to decoder\n", size);
 mpp\_packet\_deinit(&packet);
 return ret;}
static int rkmpp\_close\_decoder(AVCodecContext \*avctx){ RKMPPDecodeContext \*rk\_context = avctx->priv\_data; av\_buffer\_unref(&rk\_context->decoder\_ref); return 0;}
static void rkmpp\_release\_decoder(void \*opaque, uint8\_t \*data){ RKMPPDecoder \*decoder = (RKMPPDecoder \*)data;
 if (decoder->mpi) { decoder->mpi->reset(decoder->ctx); mpp\_destroy(decoder->ctx); decoder->ctx = NULL; }
 if (decoder->frame\_group) { mpp\_buffer\_group\_put(decoder->frame\_group); decoder->frame\_group = NULL; }
 av\_buffer\_unref(&decoder->frames\_ref); av\_buffer\_unref(&decoder->device\_ref);
 av\_free(decoder);}
static int rkmpp\_init\_decoder(AVCodecContext \*avctx){ RKMPPDecodeContext \*rk\_context = avctx->priv\_data; RKMPPDecoder \*decoder = NULL; MppCodingType codectype = MPP\_VIDEO\_CodingUnused; int ret; RK\_S64 paramS64; RK\_S32 paramS32;
 avctx->pix\_fmt = AV\_PIX\_FMT\_DRM\_PRIME;
 // create a decoder and a ref to it decoder = av\_mallocz(sizeof(RKMPPDecoder)); if (!decoder) { ret = AVERROR(ENOMEM); goto fail; }
 rk\_context->decoder\_ref = av\_buffer\_create((uint8\_t \*)decoder, sizeof(\*decoder), rkmpp\_release\_decoder, NULL, AV\_BUFFER\_FLAG\_READONLY); if (!rk\_context->decoder\_ref) { av\_free(decoder); ret = AVERROR(ENOMEM); goto fail; }
 av\_log(avctx, AV\_LOG\_DEBUG, "Initializing RKMPP decoder.\n");
 codectype = rkmpp\_get\_codingtype(avctx); if (codectype == MPP\_VIDEO\_CodingUnused) { av\_log(avctx, AV\_LOG\_ERROR, "Unknown codec type (%d).\n", avctx->codec\_id); ret = AVERROR\_UNKNOWN; goto fail; }
 ret = mpp\_check\_support\_format(MPP\_CTX\_DEC, codectype); if (ret != MPP\_OK) { av\_log(avctx, AV\_LOG\_ERROR, "Codec type (%d) unsupported by MPP\n", avctx->codec\_id); ret = AVERROR\_UNKNOWN; goto fail; }
 // Create the MPP context ret = mpp\_create(&decoder->ctx, &decoder->mpi); if (ret != MPP\_OK) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to create MPP context (code = %d).\n", ret); ret = AVERROR\_UNKNOWN; goto fail; }
 // initialize mpp ret = mpp\_init(decoder->ctx, MPP\_CTX\_DEC, codectype); if (ret != MPP\_OK) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to initialize MPP context (code = %d).\n", ret); ret = AVERROR\_UNKNOWN; goto fail; }
 // make decode calls blocking with a timeout paramS32 = MPP\_POLL\_BLOCK; ret = decoder->mpi->control(decoder->ctx, MPP\_SET\_OUTPUT\_BLOCK, &paramS32); if (ret != MPP\_OK) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to set blocking mode on MPI (code = %d).\n", ret); ret = AVERROR\_UNKNOWN; goto fail; }
 paramS64 = RECEIVE\_FRAME\_TIMEOUT; ret = decoder->mpi->control(decoder->ctx, MPP\_SET\_OUTPUT\_BLOCK\_TIMEOUT, &paramS64); if (ret != MPP\_OK) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to set block timeout on MPI (code = %d).\n", ret); ret = AVERROR\_UNKNOWN; goto fail; }
 ret = mpp\_buffer\_group\_get\_internal(&decoder->frame\_group, MPP\_BUFFER\_TYPE\_ION); if (ret) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to retrieve buffer group (code = %d)\n", ret); ret = AVERROR\_UNKNOWN; goto fail; }
 ret = decoder->mpi->control(decoder->ctx, MPP\_DEC\_SET\_EXT\_BUF\_GROUP, decoder->frame\_group); if (ret) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to assign buffer group (code = %d)\n", ret); ret = AVERROR\_UNKNOWN; goto fail; }
 ret = mpp\_buffer\_group\_limit\_config(decoder->frame\_group, 0, FRAMEGROUP\_MAX\_FRAMES); if (ret) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to set buffer group limit (code = %d)\n", ret); ret = AVERROR\_UNKNOWN; goto fail; }
 decoder->first\_packet = 1;
 av\_log(avctx, AV\_LOG\_DEBUG, "RKMPP decoder initialized successfully.\n");
 decoder->device\_ref = av\_hwdevice\_ctx\_alloc(AV\_HWDEVICE\_TYPE\_DRM); if (!decoder->device\_ref) { ret = AVERROR(ENOMEM); goto fail; } ret = av\_hwdevice\_ctx\_init(decoder->device\_ref); if (ret < 0) goto fail;
 return 0;
fail: av\_log(avctx, AV\_LOG\_ERROR, "Failed to initialize RKMPP decoder.\n"); rkmpp\_close\_decoder(avctx); return ret;}
static int rkmpp\_send\_packet(AVCodecContext \*avctx, const AVPacket \*avpkt){ RKMPPDecodeContext \*rk\_context = avctx->priv\_data; RKMPPDecoder \*decoder = (RKMPPDecoder \*)rk\_context->decoder\_ref->data; int ret;
 // handle EOF if (!avpkt->size) { av\_log(avctx, AV\_LOG\_DEBUG, "End of stream.\n"); decoder->eos\_reached = 1; ret = rkmpp\_write\_data(avctx, NULL, 0, 0); if (ret) av\_log(avctx, AV\_LOG\_ERROR, "Failed to send EOS to decoder (code = %d)\n", ret); return ret; }
 // on first packet, send extradata if (decoder->first\_packet) { if (avctx->extradata\_size) { ret = rkmpp\_write\_data(avctx, avctx->extradata, avctx->extradata\_size, avpkt->pts); if (ret) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to write extradata to decoder (code = %d)\n", ret); return ret; } } decoder->first\_packet = 0; }
 // now send packet ret = rkmpp\_write\_data(avctx, avpkt->data, avpkt->size, avpkt->pts); if (ret && ret!=AVERROR(EAGAIN)) av\_log(avctx, AV\_LOG\_ERROR, "Failed to write data to decoder (code = %d)\n", ret);
 return ret;}
static void rkmpp\_release\_frame(void \*opaque, uint8\_t \*data){ AVDRMFrameDescriptor \*desc = (AVDRMFrameDescriptor \*)data; AVBufferRef \*framecontextref = (AVBufferRef \*)opaque; RKMPPFrameContext \*framecontext = (RKMPPFrameContext \*)framecontextref->data;
 mpp\_frame\_deinit(&framecontext->frame); av\_buffer\_unref(&framecontext->decoder\_ref); av\_buffer\_unref(&framecontextref);
 av\_free(desc);}
static int rkmpp\_retrieve\_frame(AVCodecContext \*avctx, AVFrame \*frame){ RKMPPDecodeContext \*rk\_context = avctx->priv\_data; RKMPPDecoder \*decoder = (RKMPPDecoder \*)rk\_context->decoder\_ref->data; RKMPPFrameContext \*framecontext = NULL; AVBufferRef \*framecontextref = NULL; int ret; MppFrame mppframe = NULL; MppBuffer buffer = NULL; AVDRMFrameDescriptor \*desc = NULL; AVDRMLayerDescriptor \*layer = NULL; int mode; MppFrameFormat mppformat; uint32\_t drmformat;
 ret = decoder->mpi->decode\_get\_frame(decoder->ctx, &mppframe); if (ret != MPP\_OK && ret != MPP\_ERR\_TIMEOUT) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to get a frame from MPP (code = %d)\n", ret); goto fail; }
 if (mppframe) { // Check whether we have a special frame or not if (mpp\_frame\_get\_info\_change(mppframe)) { AVHWFramesContext \*hwframes;
 av\_log(avctx, AV\_LOG\_INFO, "Decoder noticed an info change (%dx%d), format=%d\n", (int)mpp\_frame\_get\_width(mppframe), (int)mpp\_frame\_get\_height(mppframe), (int)mpp\_frame\_get\_fmt(mppframe));
 avctx->width = mpp\_frame\_get\_width(mppframe); avctx->height = mpp\_frame\_get\_height(mppframe);
 decoder->mpi->control(decoder->ctx, MPP\_DEC\_SET\_INFO\_CHANGE\_READY, NULL);
 av\_buffer\_unref(&decoder->frames\_ref);
 decoder->frames\_ref = av\_hwframe\_ctx\_alloc(decoder->device\_ref); if (!decoder->frames\_ref) { ret = AVERROR(ENOMEM); goto fail; }
 mppformat = mpp\_frame\_get\_fmt(mppframe); drmformat = rkmpp\_get\_frameformat(mppformat);
 hwframes = (AVHWFramesContext\*)decoder->frames\_ref->data; hwframes->format = AV\_PIX\_FMT\_DRM\_PRIME; hwframes->sw\_format = drmformat == DRM\_FORMAT\_NV12 ? AV\_PIX\_FMT\_NV12 : AV\_PIX\_FMT\_NONE; hwframes->width = avctx->width; hwframes->height = avctx->height; ret = av\_hwframe\_ctx\_init(decoder->frames\_ref); if (ret < 0) goto fail;
 // here decoder is fully initialized, we need to feed it again with data ret = AVERROR(EAGAIN); goto fail; } else if (mpp\_frame\_get\_eos(mppframe)) { av\_log(avctx, AV\_LOG\_DEBUG, "Received a EOS frame.\n"); decoder->eos\_reached = 1; ret = AVERROR\_EOF; goto fail; } else if (mpp\_frame\_get\_discard(mppframe)) { av\_log(avctx, AV\_LOG\_DEBUG, "Received a discard frame.\n"); ret = AVERROR(EAGAIN); goto fail; } else if (mpp\_frame\_get\_errinfo(mppframe)) { av\_log(avctx, AV\_LOG\_ERROR, "Received a errinfo frame.\n"); ret = AVERROR\_UNKNOWN; goto fail; }
 // here we should have a valid frame av\_log(avctx, AV\_LOG\_DEBUG, "Received a frame.\n");
 // setup general frame fields frame->format = AV\_PIX\_FMT\_DRM\_PRIME; frame->width = mpp\_frame\_get\_width(mppframe); frame->height = mpp\_frame\_get\_height(mppframe); frame->pts = mpp\_frame\_get\_pts(mppframe); frame->color\_range = mpp\_frame\_get\_color\_range(mppframe); frame->color\_primaries = mpp\_frame\_get\_color\_primaries(mppframe); frame->color\_trc = mpp\_frame\_get\_color\_trc(mppframe); frame->colorspace = mpp\_frame\_get\_colorspace(mppframe);
 mode = mpp\_frame\_get\_mode(mppframe); if ((mode & MPP\_FRAME\_FLAG\_FIELD\_ORDER\_MASK) == MPP\_FRAME\_FLAG\_DEINTERLACED) frame->flags |= AV\_FRAME\_FLAG\_INTERLACED; if ((mode & MPP\_FRAME\_FLAG\_FIELD\_ORDER\_MASK) == MPP\_FRAME\_FLAG\_TOP\_FIRST) frame->flags |= AV\_FRAME\_FLAG\_TOP\_FIELD\_FIRST;
 mppformat = mpp\_frame\_get\_fmt(mppframe); drmformat = rkmpp\_get\_frameformat(mppformat);
 // now setup the frame buffer info buffer = mpp\_frame\_get\_buffer(mppframe); if (buffer) { desc = av\_mallocz(sizeof(AVDRMFrameDescriptor)); if (!desc) { ret = AVERROR(ENOMEM); goto fail; }
 desc->nb\_objects = 1; desc->objects[0].fd = mpp\_buffer\_get\_fd(buffer); desc->objects[0].size = mpp\_buffer\_get\_size(buffer);
 desc->nb\_layers = 1; layer = &desc->layers[0]; layer->format = drmformat; layer->nb\_planes = 2;
 layer->planes[0].object\_index = 0; layer->planes[0].offset = 0; layer->planes[0].pitch = mpp\_frame\_get\_hor\_stride(mppframe);
 layer->planes[1].object\_index = 0; layer->planes[1].offset = layer->planes[0].pitch \* mpp\_frame\_get\_ver\_stride(mppframe); layer->planes[1].pitch = layer->planes[0].pitch;
 // we also allocate a struct in buf[0] that will allow to hold additionnal information // for releasing properly MPP frames and decoder framecontextref = av\_buffer\_allocz(sizeof(\*framecontext)); if (!framecontextref) { ret = AVERROR(ENOMEM); goto fail; }
 // MPP decoder needs to be closed only when all frames have been released. framecontext = (RKMPPFrameContext \*)framecontextref->data; framecontext->decoder\_ref = av\_buffer\_ref(rk\_context->decoder\_ref); framecontext->frame = mppframe;
 frame->data[0] = (uint8\_t \*)desc; frame->buf[0] = av\_buffer\_create((uint8\_t \*)desc, sizeof(\*desc), rkmpp\_release\_frame, framecontextref, AV\_BUFFER\_FLAG\_READONLY);
 if (!frame->buf[0]) { ret = AVERROR(ENOMEM); goto fail; }
 frame->hw\_frames\_ctx = av\_buffer\_ref(decoder->frames\_ref); if (!frame->hw\_frames\_ctx) { ret = AVERROR(ENOMEM); goto fail; }
 return 0; } else { av\_log(avctx, AV\_LOG\_ERROR, "Failed to retrieve the frame buffer, frame is dropped (code = %d)\n", ret); mpp\_frame\_deinit(&mppframe); } } else if (decoder->eos\_reached) { return AVERROR\_EOF; } else if (ret == MPP\_ERR\_TIMEOUT) { av\_log(avctx, AV\_LOG\_DEBUG, "Timeout when trying to get a frame from MPP\n"); }
 return AVERROR(EAGAIN);
fail: if (mppframe) mpp\_frame\_deinit(&mppframe);
 if (framecontext) av\_buffer\_unref(&framecontext->decoder\_ref);
 if (framecontextref) av\_buffer\_unref(&framecontextref);
 if (desc) av\_free(desc);
 return ret;}
static int rkmpp\_receive\_frame(AVCodecContext \*avctx, AVFrame \*frame){ RKMPPDecodeContext \*rk\_context = avctx->priv\_data; RKMPPDecoder \*decoder = (RKMPPDecoder \*)rk\_context->decoder\_ref->data; int ret = MPP\_NOK; AVPacket pkt = {0}; RK\_S32 usedslots, freeslots;
 if (!decoder->eos\_reached) { // we get the available slots in decoder ret = decoder->mpi->control(decoder->ctx, MPP\_DEC\_GET\_STREAM\_COUNT, &usedslots); if (ret != MPP\_OK) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to get decoder used slots (code = %d).\n", ret); return ret; }
 freeslots = INPUT\_MAX\_PACKETS - usedslots; if (freeslots > 0) { ret = ff\_decode\_get\_packet(avctx, &pkt); if (ret < 0 && ret != AVERROR\_EOF) { return ret; }
 ret = rkmpp\_send\_packet(avctx, &pkt); av\_packet\_unref(&pkt);
 if (ret < 0) { av\_log(avctx, AV\_LOG\_ERROR, "Failed to send packet to decoder (code = %d)\n", ret); return ret; } }
 // make sure we keep decoder full if (freeslots > 1) return AVERROR(EAGAIN); }
 return rkmpp\_retrieve\_frame(avctx, frame);}
static void rkmpp\_flush(AVCodecContext \*avctx){ RKMPPDecodeContext \*rk\_context = avctx->priv\_data; RKMPPDecoder \*decoder = (RKMPPDecoder \*)rk\_context->decoder\_ref->data; int ret = MPP\_NOK;
 av\_log(avctx, AV\_LOG\_DEBUG, "Flush.\n");
 ret = decoder->mpi->reset(decoder->ctx); if (ret == MPP\_OK) { decoder->first\_packet = 1; } else av\_log(avctx, AV\_LOG\_ERROR, "Failed to reset MPI (code = %d)\n", ret);}
static const AVCodecHWConfigInternal \*const rkmpp\_hw\_configs[] = { HW\_CONFIG\_INTERNAL(DRM\_PRIME), NULL};
#define RKMPP\_DEC\_CLASS(NAME) \ static const AVClass rkmpp\_##NAME##\_dec\_class = { \ .class\_name = "rkmpp\_" #NAME "\_dec", \ .version = LIBAVUTIL\_VERSION\_INT, \ };
#define RKMPP\_DEC(NAME, ID, BSFS) \ RKMPP\_DEC\_CLASS(NAME) \ const FFCodec ff\_##NAME##\_rkmpp\_decoder = { \ .p.name = #NAME "\_rkmpp", \ CODEC\_LONG\_NAME(#NAME " (rkmpp)"), \ .p.type = AVMEDIA\_TYPE\_VIDEO, \ .p.id = ID, \ .priv\_data\_size = sizeof(RKMPPDecodeContext), \ .init = rkmpp\_init\_decoder, \ .close = rkmpp\_close\_decoder, \ FF\_CODEC\_RECEIVE\_FRAME\_CB(rkmpp\_receive\_frame), \ .flush = rkmpp\_flush, \ .p.priv\_class = &rkmpp\_##NAME##\_dec\_class, \ .p.capabilities = AV\_CODEC\_CAP\_DELAY | AV\_CODEC\_CAP\_AVOID\_PROBING | AV\_CODEC\_CAP\_HARDWARE, \ .hw\_configs = rkmpp\_hw\_configs, \ .bsfs = BSFS, \ .p.wrapper\_name = "rkmpp", \ .caps\_internal = FF\_CODEC\_CAP\_NOT\_INIT\_THREADSAFE, \ };
RKMPP\_DEC(h264, AV\_CODEC\_ID\_H264, "h264\_mp4toannexb")RKMPP\_DEC(hevc, AV\_CODEC\_ID\_HEVC, "hevc\_mp4toannexb")RKMPP\_DEC(vp8, AV\_CODEC\_ID\_VP8, NULL)RKMPP\_DEC(vp9, AV\_CODEC\_ID\_VP9, NULL)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from gist.github.com_16957070_20250115_081804.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F7e6e47220ae2b2d2fb4611f0d8a31ec5)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F7e6e47220ae2b2d2fb4611f0d8a31ec5&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F7e6e47220ae2b2d2fb4611f0d8a31ec5) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F7e6e47220ae2b2d2fb4611f0d8a31ec5&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@1047524396](https://avatars.githubusercontent.com/u/77877041?s=64&v=4)](/1047524396)

# [1047524396](/1047524396)/**[CVE-2024-35368](/1047524396/7e6e47220ae2b2d2fb4611f0d8a31ec5)**

Last active
November 29, 2024 04:11

Show Gist options

* [Download ZIP](/1047524396/7e6e47220ae2b2d2fb4611f0d8a31ec5/archive/b61685835647f02d0b966b22657a8bf773aa7afd.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F7e6e47220ae2b2d2fb4611f0d8a31ec5)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F7e6e47220ae2b2d2fb4611f0d8a31ec5)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/1047524396/7e6e47220ae2b2d2fb4611f0d8a31ec5.js&quot;&gt;&lt;/script&gt;
* Save 1047524396/7e6e47220ae2b2d2fb4611f0d8a31ec5 to your computer and use it in GitHub Desktop.

[Code](/1047524396/7e6e47220ae2b2d2fb4611f0d8a31ec5)
[Revisions
2](/1047524396/7e6e47220ae2b2d2fb4611f0d8a31ec5/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/1047524396/7e6e47220ae2b2d2fb4611f0d8a31ec5.js&quot;&gt;&lt;/script&gt;

Save 1047524396/7e6e47220ae2b2d2fb4611f0d8a31ec5 to your computer and use it in GitHub Desktop.

[Download ZIP](/1047524396/7e6e47220ae2b2d2fb4611f0d8a31ec5/archive/b61685835647f02d0b966b22657a8bf773aa7afd.zip)

CVE-2024-35368

 [Raw](/1047524396/7e6e47220ae2b2d2fb4611f0d8a31ec5/raw/b61685835647f02d0b966b22657a8bf773aa7afd/CVE-2024-35368)

[**CVE-2024-35368**](#file-cve-2024-35368)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | [CVE ID] |
| --- | --- |
|  | CVE-2024-35368 |
|  | [PRODUCT] |
|  | FFmpeg |
|  | [VERSION] |
|  | n7.0 |
|  | [PROBLEM TYPE] |
|  | Double Free |
|  | [DESCRIPTION] |
|  | FFmpeg n7.0 is affected by a Double Free via the rkmpp\_retrieve\_frame function within libavcodec/rkmppdec.c. |
|  | [PATCH LINK] |
|  | https://github.com/ffmpeg/ffmpeg/commit/4513300989502090c4fd6560544dce399a8cd53c |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F7e6e47220ae2b2d2fb4611f0d8a31ec5)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0197d4a3_20250115_081807.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fffmpeg%2Fffmpeg%2Fcommit%2F4513300989502090c4fd6560544dce399a8cd53c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fffmpeg%2Fffmpeg%2Fcommit%2F4513300989502090c4fd6560544dce399a8cd53c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=FFmpeg%2FFFmpeg)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FFmpeg](/FFmpeg)
/
**[FFmpeg](/FFmpeg/FFmpeg)**
Public

* [Notifications](/login?return_to=%2FFFmpeg%2FFFmpeg) You must be signed in to change notification settings
* [Fork
  12.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)
* [Star
   47.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)

* [Code](/FFmpeg/FFmpeg)
* [Pull requests
  1](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

Additional navigation options

* [Code](/FFmpeg/FFmpeg)
* [Pull requests](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

## Commit

[Permalink](/FFmpeg/FFmpeg/commit/4513300989502090c4fd6560544dce399a8cd53c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

avcodec/rkmppdec: Fix double-free on error

[Browse files](/FFmpeg/FFmpeg/tree/4513300989502090c4fd6560544dce399a8cd53c)
Browse the repository at this point in the history

```
After having created the AVBuffer that is put into frame->buf[0],
ownership of several objects (namely an AVDRMFrameDescriptor,
an MppFrame and some AVBufferRefs framecontextref and decoder_ref)
has passed to the AVBuffer and therefore to the frame.
Yet it has nevertheless been freed manually on error
afterwards, which would lead to a double-free as soon
as the AVFrame is unreferenced.

Signed-off-by: Andreas Rheinhardt <andreas.rheinhardt@outlook.com>
```

* Loading branch information

[![@mkver](https://avatars.githubusercontent.com/u/18448094?s=40&v=4)](/mkver)

[mkver](/FFmpeg/FFmpeg/commits?author=mkver "View all commits by mkver")
committed
Apr 19, 2024

1 parent
[d692c42](/FFmpeg/FFmpeg/commit/d692c429380ff254ea449ef62b07fb0542109200)

commit 4513300

Showing
**1 changed file**
with
**2 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

4 changes: 2 additions & 2 deletions

4
[libavcodec/rkmppdec.c](#diff-9b62a122bdcc988d8fc3ae9e4ffb26432777816b68fad28fe93f18dae4b337be "libavcodec/rkmppdec.c")

Show comments

[View file](/FFmpeg/FFmpeg/blob/4513300989502090c4fd6560544dce399a8cd53c/libavcodec/rkmppdec.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -463,8 +463,8 @@ static int rkmpp\_retrieve\_frame(AVCodecContext \*avctx, AVFrame \*frame) |
|  |  |  |
|  |  | frame->hw\_frames\_ctx = av\_buffer\_ref(decoder->frames\_ref); |
|  |  | if (!frame->hw\_frames\_ctx) { |
|  |  | ret = AVERROR(ENOMEM); |
|  |  | goto fail; |
|  |  | av\_frame\_unref(frame); |
|  |  | return AVERROR(ENOMEM); |
|  |  | } |
|  |  |  |
|  |  | return 0; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4513300`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fffmpeg%2Fffmpeg%2Fcommit%2F4513300989502090c4fd6560544dce399a8cd53c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


