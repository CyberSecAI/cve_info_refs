=== Content from plugins.trac.wordpress.org_94d53fe1_20250114_212659.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3184852)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3184851 "Changeset 3184851")
* [Next Changeset](/changeset/3184853 "Changeset 3184853") →

---

# Changeset 3184852

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
11/09/2024 01:17:57 PM
([2 months](/timeline?from=2024-11-09T13%3A17%3A57Z&precision=second "See timeline at 11/09/2024 01:17:57 PM") ago)

Author:
opajaap
Message:

8.9.02.001

Location:
[wp-photo-album-plus/trunk](/browser/wp-photo-album-plus/trunk?rev=3184852)
Files:

5 edited

* [changelog.txt](/browser/wp-photo-album-plus/trunk/changelog.txt?rev=3184852 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [js/wppa-all.js](/browser/wp-photo-album-plus/trunk/js/wppa-all.js?rev=3184852 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [js/wppa-slideshow.js](/browser/wp-photo-album-plus/trunk/js/wppa-slideshow.js?rev=3184852 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [wppa-links.php](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852 "Show entry in browser")
  (modified)
  ([10 diffs](#file3 "Show differences"))
* [wppa.php](/browser/wp-photo-album-plus/trunk/wppa.php?rev=3184852 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-photo-album-plus/trunk/changelog.txt](/changeset/3184852/wp-photo-album-plus/trunk/changelog.txt "Show the changeset 3184852 restricted to wp-photo-album-plus/trunk/changelog.txt")

  | [r3184388](/browser/wp-photo-album-plus/trunk/changelog.txt?rev=3184388#L1 "Show revision 3184388 of this file in browser") | [r3184852](/browser/wp-photo-album-plus/trunk/changelog.txt?rev=3184852#L1 "Show revision 3184852 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | WP Photo Album Plus Changelog |
  |  | 2 |  |
  |  | 3 | = 8.9.02 = |
  |  | 4 |  |
  |  | 5 | \* Slideshow to thumbnails link failed due to unencrypted album id. Fixed. |
  |  | 6 | \* Autostart video on slideshow not worked always. Fixed. |
  | 2 | 7 |  |
  | 3 | 8 | = 8.9.01 = |
* ## [wp-photo-album-plus/trunk/js/wppa-all.js](/changeset/3184852/wp-photo-album-plus/trunk/js/wppa-all.js "Show the changeset 3184852 restricted to wp-photo-album-plus/trunk/js/wppa-all.js")

  | [r3183783](/browser/wp-photo-album-plus/trunk/js/wppa-all.js?rev=3183783#L4 "Show revision 3183783 of this file in browser") | [r3184852](/browser/wp-photo-album-plus/trunk/js/wppa-all.js?rev=3184852#L4 "Show revision 3184852 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | function wppaTabbyClick(){jQuery(window).trigger("resize"),jQuery(document).trigger("tabbychange"),jQuery(window).trigger("orientationchange"),wppaAdjustAllFilmstrips(wppaEasingSlide)}function wppaQRUpdate(e){wppaAjaxSetQrCodeSrc(e,"#wppa-qr-img")}function wppaDoInit(){jQuery(document).ready(function(){\_wppaTextDelay=wppaAnimationSpeed,wppaFadeInAfterFadeOut&&(\_wppaTextDelay\*=2),wppaIsMobile&&wppaNoAnimateOnMobile&&(\_wppaTextDelay=10),jQuery(".wppa-ajax-spin").hide(),jQuery(".wppa-ovl-spin").hide(),setTimeout(function(){jQuery(".wppa-ubb").each(function(){var e=jQuery(this).attr("id").substr(6);wppaUbb(e,"l","hide"),wppaUbb(e,"r","hide")})},3e3),jQuery(window).on("DOMContentLoaded load resize scroll orientationchange",wppaDoAllAutocols),jQuery(window).on("DOMContentLoaded load resize scroll wheel orientationchange",wppaSizeArea),jQuery(window).on("DOMContentLoaded load resize scroll wheel orientationchange",function(){wppaMakeLazyVisible("DOM loaded 2")}),jQuery(".wppa-divnicewrap").on("DOMContentLoaded load resize scroll wheel orientationchange",function(){wppaMakeLazyVisible("scroll div nicewrap")}),jQuery(window).on("DOMContentLoaded load resize scroll orientationchange",wppaInitMasonryPlus),jQuery(window).on("resize",function(){wppaAdjustAllFilmstrips(wppaEasingSlide)}),jQuery(window).on("DOMContentLoaded load resize scroll orientationchange",function(){setTimeout(function(){wppaResizeNice("wppaDoInit")},1e3)}),jQuery(window).trigger("resize"),wppaProtect(),setTimeout(function(){jQuery(".responsive-tabs\_\_heading").on("click",wppaTabbyClick),jQuery(".responsive-tabs\_\_list\_\_item").on("click",wppaTabbyClick)},10),jQuery(document).on("tabbychange",function(){wppaResizeNice("tabbychange"),setTimeout(function(){wppaDoAllAutocols(),jQuery(window).trigger("resize"),jQuery("#wppa-ovl-spin").hide(),wppaMakeLazyVisible("tabbychange")},1500)}),wppaOvlGlobal&&jQuery("a").each(function(){var e=jQuery(this).attr("href");e&&("jpg"!=(e=(e=e.split("."))[e.length-1])&&"jpeg"!=e&&"png"!=e||jQuery(this).attr("data-rel")||(jQuery(this).attr("data-rel",wppaOvlGlobal),jQuery(this).css("cursor","wait")))}),jQuery("div").on("touchmove",function(){wppaMakeLazyVisible("div touchmove")}),jQuery(".wppa-ajax-spin").css({top:wppaWindowHeight()/2,left:wppaWindowWidth()/2})})}var wppaResizeNiceTimer,wppaResizeNiceTimestamp,wppaResizeEndTimer;function wppaResizeNice(e){console.log("Nice resize called from "+e),clearTimeout(wppaResizeNiceTimer),wppaResizeNiceTimestamp=Date.now(),wppaResizeNiceTimer=setTimeout(function(){\_wppaResizeNice(e)},Math.max(wppaResizeEndDelay,wppaScrollEndDelay))}function \_wppaResizeNice(e){"wppaMakeLazyVisible"!=e&&"function"==typeof jQuery("body").getNiceScroll&&(jQuery("body").getNiceScroll().resize(),console.log("Nice resized body after "+(Date.now()-wppaResizeNiceTimestamp)+" millisec")),jQuery(".wppa-nicescroll").each(function(){jQuery(this).getNiceScroll().resize(),console.log("Nice resized "+jQuery(this).attr("id")+" after "+(Date.now()-wppaResizeNiceTimestamp)+" millisec")})}function wppaSizeAutoDiv(){jQuery(".wppa-autodiv").each(function(e){var p=jQuery(window).height(),a=jQuery(this).attr("data-max-height");jQuery(this).css({maxHeight:p\*a})})}wppaWppaVer="8.8.08.006",jQuery(document).ready(function(){wppaDoInit()}),jQuery(document).ready(function(){jQuery().niceScroll&&jQuery(document).ready(function(){jQuery(".wppa-edit-area").niceScroll(".wppa-nicewrap",wppaNiceScrollOpts)})}),jQuery(document).ready(function(){wppaQRUpdate(document.location.href)}),window.onpopstate=function(e){wppaQRUpdate(document.location.href)},jQuery(document).ready(function(){jQuery(window).on("resize load",function(){clearTimeout(wppaResizeEndTimer),wppaResizeEndTimer=setTimeout(function(){jQuery(window).trigger("wpparesizeend")},wppaResizeEndDelay)})}),jQuery(document).ready(function(){jQuery(window).on("scroll wheel touchmove",function(){wppaMakeLazyVisible("scroll window")})}),jQuery(document).ready(function(){jQuery(window).on("DOMContentLoaded load resize scroll wheel orientationchange",wppaSizeAutoDiv)});var wppaLastAllAutocols=0,wppaLastAllAutocolsTimer=0;function wppaDoAllAutocols(e){wppaTimNow()<wppaLastAllAutocols+200?wppaLastAllAutocolsTimer=wppaLastAllAutocolsTimer||setTimeout(wppaDoAllAutocols,200):(clearTimeout(wppaLastAllAutocolsTimer),wppaLastAllAutocols=wppaTimNow(),\_wppaDoAllAutocols(0))}function \_wppaDoAllAutocols(p){return jQuery(".wppa-container").each(function(){var e=jQuery(this).attr("id").substr(15);wppaAutoColumnWidth[e]&&\_wppaDoAutocol(e,p)}),(p<wppaExtendedResizeCount||-1==wppaExtendedResizeCount)&&setTimeout(function(){\_wppaDoAllAutocols(p+1)},wppaExtendedResizeDelay),wppaResizeNice("wppaDoAllAutocols"),!0}function wppaProtect(){wppaHideRightClick&&(jQuery("img").bind("contextmenu",function(e){return!1}),jQuery("video").bind("contextmenu",function(e){return!1}),jQuery("canvas").bind("contextmenu",function(e){return!1}))}function wppaUpdateLightboxes(){"function"==typeof wppaInitOverlay&&wppaInitOverlay(),"undefined"!=typeof myLightbox&&"function"==typeof myLightbox.updateImageList&&myLightbox.updateImageList(),jQuery().prettyPhoto&&jQuery("a[rel^='prettyPhoto']").prettyPhoto({deeplinking:!1})}function wppaStopVideo(e){var p,a,t=[];for(t[1]="wppa-overlay-img",t[2]="theimg0-"+e,t[3]="theimg1-"+e,a=0;a<3;)1==++a&&0!=e||(p=document.getElementById(t[a]))&&"function"==typeof p.pause&&p.pause()}function wppaStopAudio(e){for(var p=jQuery(".wppa-audio-"+e),a=0;a<p.length;)p[a].pause(),a++}function wppaMakeFullsizeUrl(e){var p,a;e=(p=(e=e.replace("/thumbs/","/")).split("//"))[1]?(a=p[1].split("/"),p[0]+"//"):(a=p[0].split("/"),"");for(var t=0;t<a.length;){var o=a[t];"w"!=o.split("\_")[0]&&(0!=t&&(e+="/"),e+=o),t++}return e}function wppaGetContainerWidth(e){var p=document.getElementById("wppa-container-"+e);if(p){var a=0;if(!wppaAutoColumnWidth[e])return p.clientWidth;for(;0==a;)p=p.parentNode,a=jQuery(p).width();return parseInt(a)}}function \_wppaDoAutocol(e,p){if(!wppaAutoColumnWidth[e])return!0;var a,t,o=wppaGetContainerWidth(e);if(document.getElementById("wppa-container-"+e)){if(wppaCoverImageResponsive[e]||1<(a=jQuery(".wppa-asym-text-frame-"+e)).length&&(jQuery(a[0]).width(),0==wppaResponseSpeed?(jQuery(".wppa-asym-text-frame-"+e).css({width:o-wppaTextFrameDelta}),jQuery(".wppa-cover-box-"+e).css({width:o})):(wppaAnimate(".wppa-asym-text-frame-"+e,{width:o-wppaTextFrameDelta},wppaResponseSpeed,wppaEasingDefault),wppaAnimate(".wppa-cover-box-"+e,{width:o},wppaResponseSpeed,wppaEasingDefault))),1<(a=jQuery(".wppa-cover-box-mcr-"+e)).length){var n=document.getElementById("wppa-albumlist-"+e).clientWidth,r=parseInt((n+wppaCoverSpacing)/(wppaMaxCoverWidth+wppaCoverSpacing))+1,s=r-1,i=parseInt((n+wppaCoverSpacing)/r-wppaCoverSpacing);if(wppaColWidth[e]!=n||wppaMCRWidth[e]!=i){wppaColWidth[e]=n,wppaMCRWidth[e]=i;for(var u=0;u<a.length;){switch(u%r){case 0:jQuery(a[u]).css({marginLeft:"0px",clear:"both",float:"left"});break;case s:jQuery(a[u]).css({marginLeft:"0px",clear:"none",float:"right"});break;default:jQuery(a[u]).css({marginLeft:wppaCoverSpacing,clear:"none",float:"left"})}u++}wppaCoverImageResponsive[e]||wppaAnimate(".wppa-asym-text-frame-mcr-"+e,{width:i-wppaTextFrameDelta},wppaResponseSpeed,wppaEasingDefault),jQuery(a[0]).width(),wppaAnimate(".wppa-cover-box-mcr-"+e,{width:i},wppaResponseSpeed,wppaEasingDefault)}}else 1==a.length&&(wppaCoverImageResponsive[e]||(wppaAnimate(".wppa-asym-text-frame-mcr-"+e,{width:o-wppaTextFrameDelta},wppaResponseSpeed,wppaEasingDefault),jQuery(".wppa-cover-box-mcr-"+e).css({marginLeft:"0px",float:"left"})));0<jQuery(".wppa-album-cover-grid-"+e).length&&(jQuery("#wppa-container-"+e).css("line-height","0"),(t=parseInt(o/wppaMaxCoverWidth+.9999))<1&&(t=1),jQuery(".wppa-album-cover-grid-"+e).css({width:100/t+"%"})),!wppaThumbSpaceAuto||(n=parseInt(jQuery(".thumbnail-frame-"+e).css("width")))&&(i=wppaMinThumbSpace,t=o-wppaThumbnailAreaDelta-7,i=Math.max(1,parseInt(t/(n+i))),i=parseInt((t-i\*n)/(i+1)),jQuery(".thumbnail-frame-"+e).css({marginLeft:i})),jQuery(".thumbnail-frame-comalt-"+e).css("width",o-wppaThumbnailAreaDelta),jQuery(".wppa-com-alt-"+e).css("width",o-wppaThumbnailAreaDelta-wppaComAltSize-16);for(var l,c=1,w=jQuery("#wppa-mas-h-"+c+"-"+e).attr("data-height-perc");w;)l=w\*(o-wppaThumbnailAreaDelta)/100,jQuery("#wppa-mas-h-"+c+"-"+e).css("height",l),c++,w=jQuery("#wppa-mas-h-"+c+"-"+e).attr("data-height-perc");return wppaSetMasHorFrameWidthsForIeAndChrome(e),document.getElementById("slide\_frame-"+e)&&wppaFormatSlide(e),jQuery("#audio-slide-"+e).css("width",o-wppaBoxDelta-6),jQuery(".wppa-comment-textarea-"+e).css("width",.7\*o),\_wppaAdjustFilmstrip(e,wppaEasingSlide),wppaIsMini[e]||void 0===\_wppaSlides[e]||(wppaColWidth[e]<wppaMiniTreshold?(jQuery("#wppa-avg-rat-"+e).html(\_\_("Avg","wp-photo-album-plus")),jQuery("#wppa-my-rat-"+e).html(\_\_("Mine","wp-photo-album-plus")),jQuery("#counter-"+e).html(\_wppaCurIdx[e]+1+" / "+\_wppaSlides[e].length)):(jQuery("#wppa-avg-rat-"+e).html(\_\_("Average&nbsp;rating","wp-photo-album-plus")),jQuery("#wppa-my-rat-"+e).html(\_\_("My&nbsp;rating","wp-photo-album-plus")),jQuery("#counter-"+e).html(\_\_("Photo","wp-photo-album-plus")+" "+(\_wppaCurIdx[e]+1)+" "+\_\_("of","wp-photo-album-plus")+" "+\_wppaSlides[e].length))),jQuery(".wppa-sphoto-"+e).css("width",o),jQuery(".wppa-simg-"+e).css("width",o-2\*wppaSlideBorderWidth),jQuery(".wppa-simg-"+e).css("height",""),jQuery(".wppa-mphoto-"+e).css("width",o+10),jQuery(".wppa-mimg-"+e).css("width",o),jQuery(".wppa-mimg-"+e).css("height",""),jQuery(".smxpdf-"+e).css("height",.8\*wppaWindowHeight()),0<wppaSearchBoxSelItems[e]&&(o/wppaSearchBoxSelItems[e]<125?jQuery(".wppa-searchsel-item-"+e).css("width","100%"):jQuery(".wppa-searchsel-item-"+e).css("width",100/wppaSearchBoxSelItems[e]+"%")),jQuery(".wppa-upload-album-"+e).css("maxWidth",.6\*o),wppaSetRealCalendarHeights(e),!0}}function wppaSetRealCalendarHeights(p){var a,t,o,e=jQuery("#wppa-real-calendar-"+p).width();0<e&&(a=!0,t=e\*wppaThumbAspect/7,jQuery(".wppa-real-calendar-day-"+p).css({height:t}),e=e/50+2,jQuery("#wppa-real-calendar-"+p).css({fontSize:e}),e=e/4,jQuery(".wppa-real-calendar-head-td-"+p).css({marginTop:e,marginBottom:e}),o=t/2,jQuery(".wppa-realcalimg-"+p).each(function(){var e;0==this.height?a=!1:(e=jQuery(this).attr("data-day"),thisb=o-(t-this.height)/2,jQuery(".wppa-real-calendar-day-content-"+e+"-"+p).css({bottom:thisb}))}),a||setTimeout(function(){wppaSetRealCalendarHeights(p)},100))}function wppaSetMasHorFrameWidthsForIeAndChrome(e){for(var p=jQuery(".wppa-mas-h-"+e),a=wppaMinThumbSpace,t=0;t<p.length;t++){var o=wppaGetChildI(p[t]);if(o){if("IMG"==o.nodeName&&!o.complete)return void setTimeout("wppaSetMasHorFrameWidthsForIeAndChrome( "+e+" )",400);o=o.naturalWidth/o.naturalHeight\*o.height+a;jQuery(p[t]).css({width:o})}}}function wppaGetChildI(e){for(var p=e.childNodes,a=0;a<p.length;a++){var t=p[a];if(t.id&&"i-"==t.id.substr(0,2))return t;t=wppaGetChildI(t);if(t)return t}return!1}jQuery(document).ready(function(e){jQuery(document).ready(function(){wppaAllowAjax&&jQuery.ajax&&(wppaCanAjaxRender=!0)}),void 0!==history.pushState&&(wppaCanPushState=!0)});var wppaFotomotoLoaded=!1,wppaFotomotoToolbarIds=[];function fotomoto\_loaded(){wppaFotomotoLoaded=!0}function wppaFotomotoToolbar(e,p){if(!(wppaColWidth[e]>=wppaFotomotoMinWidth))return jQuery("#wppa-fotomoto-container-"+e).css("display","none"),void jQuery("#wppa-fotomoto-checkout-"+e).css("display","none");jQuery("#wppa-fotomoto-container-"+e).css("display","inline"),jQuery("#wppa-fotomoto-checkout-"+e).css("display","inline"),wppaFotomoto&&document.getElementById("wppa-fotomoto-container-"+e)&&(wppaFotomotoLoaded?(FOTOMOTO.API.checkinImage(p),wppaFotomotoToolbarIds[e]=FOTOMOTO.API.showToolbar("wppa-fotomoto-container-"+e,p)):setTimeout("wppaFotomotoToolbar( "+e+',"'+p+'" )',200))}function wppaFotomotoHide(e){jQuery("#wppa-fotomoto-container-"+e).css("display","none"),jQuery("#wppa-fotomoto-checkout-"+e).css("display","none")}function wppaStringContainsForbiddenChars(e){for(var p=["?","&","#","/",'"',"'"],a=0;a<p.length;){if(-1!=e.indexOf(p[a]))return!0;a++}return!1}function wppaPushStateSlide(e,p,a){wppaNoStackPush?wppaNoStackPush=!1:wppaIsMini[e]||wppaCanPushState&&wppaUpdateAddressLine&&""!=a&&jQuery(document).ready(function(){setTimeout(function(){try{history.pushState({type:"slide",slide:p,occur:e},"",a),wppaQRUpdate(a)}catch(e){wppaConsoleLog("Slide history stack update failed")}},1e3)})}function wppaRepairScriptTags(e){if(void 0===e)return"";for(;-1!=e.indexOf("[script");)e=e.replace("[script","<script");for(;-1!=e.indexOf("[/script");)e=e.replace("[/script","</script");return e}function wppaRepairBrTags(e){return void 0===e?"":e.replace("[br /]","<br />").replace("[a","<a").replace(/&quot;/g,'"').replace('"]','">').replace("[/a]","</a>").replace("[img","<img").replace("/]","/>")}function wppaTrimAlt(e){return void 0===e?"":13<e.length?e.substr(0,10)+"...":e}window.onpopstate=function(e){if(wppaCanPushState&&e.state&&e.state.type){if("slide"==e.state.type)return wppaNoStackPush=!0,void \_wppaGoto(e.state.occur,e.state.slide);if("ajax"==e.state.type)return void document.location.reload()}if(-1!=document.location.href.indexOf("wp-admin/admin.php"))return!0;document.location.reload()};var wppaFbInitBusy=!1;function wppaFbInit(){wppaFbInitBusy||("undefined"!=typeof FB?(wppaFbInitBusy=!0,setTimeout("\_wppaFbInit()",10)):setTimeout("wppaFbInit()",200))}var wppaFbInitDone=!1,wppaAudioSeqno;function \_wppaFbInit(){wppaFbInitDone||(FB.init({status:!0,xfbml:!0}),wppaFbInitDone=!(wppaFbInitBusy=!1))}function wppaInsertAtCursor(e,p){var a,t;document.selection?(e.focus(),sel=document.selection.createRange(),sel.text=p):e.selectionStart||"0"==e.selectionStart?(a=e.selectionStart,t=e.selectionEnd,e.value=e.value.substring(0,a)+p+e.value.substring(t,e.value.length),e.selectionStart=a+p.length,e.selectionEnd=a+p.length):e.value+=p}function wppaGeoInit(e,p,a){var t,o;document.getElementById("map-canvas-"+e)&&(p=new google.maps.LatLng(p,a),a={disableDefaultUI:!1,panControl:!1,zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,overviewMapControl:!0,zoom:wppaGeoZoom,center:p},t=new google.maps.Map(document.getElementById("map-canvas-"+e),a),o=new google.maps.Marker({position:p,map:t,title:""}),google.maps.event.addListener(t,"center\_changed",function(){window.setTimeout(function(){t.panTo(o.getPosition())},1e3)}))}function wppaEncode(e){if(void 0!==e){for(var p=(t=(t=String(e).replace(/#/g,"%23")).replace(/&/g,"%26")).split("+"),a=0,t="";a<p.length;)t+=p[a],++a<p.length&&(t+="%2B");return t}}function wppaUrlToId(e){var p=e.split("/wppa/");return 1==p.length&&(p=e.split("/upload/")),1==p.length?0:p=(p=(p=(p=(p=(p=(p=p[1]).split("."))[0].replace("/","")).replace("/","")).replace("/","")).replace("/","")).replace("/","")}function wppaSuperSearchSelect(e,p){jQuery("#wppa-ss-albumopt-"+e).css("display","none"),jQuery("#wppa-ss-albumcat-"+e).css("display","none"),jQuery("#wppa-ss-albumname-"+e).css("display","none"),jQuery("#wppa-ss-albumtext-"+e).css("display","none"),jQuery("#wppa-ss-photoopt-"+e).css("display","none"),jQuery("#wppa-ss-photoname-"+e).css("display","none"),jQuery("#wppa-ss-photoowner-"+e).css("display","none"),jQuery("#wppa-ss-phototag-"+e).css("display","none"),jQuery("#wppa-ss-phototext-"+e).css("display","none"),jQuery("#wppa-ss-photoexif-"+e).css("display","none"),jQuery("#wppa-ss-photoiptc-"+e).css("display","none"),jQuery("#wppa-ss-exifopts-"+e).css("display","none"),jQuery("#wppa-ss-iptcopts-"+e).css("display","none"),jQuery("#wppa-ss-spinner-"+e).css("display","none"),jQuery("#wppa-ss-button-"+e).css("display","none");var a=jQuery("#wppa-ss-pa-"+e).val(),t="",o="",n="";switch(a){case"a":switch(jQuery("#wppa-ss-albumopt-"+e).css("display",""),t=jQuery("#wppa-ss-albumopt-"+e).val()){case"c":jQuery("#wppa-ss-albumcat-"+e).css("display","");var r=jQuery(".wppa-ss-albumcat-"+e),n="";for(s=0;s<r.length;s++)jQuery(r[s]).prop("selected")&&(n+="."+jQuery(r[s]).val());""!=(n=n.substr(1))&&jQuery("#wppa-ss-button-"+e).css("display","");break;case"n":jQuery("#wppa-ss-albumname-"+e).css("display",""),null!=(n=jQuery("#wppa-ss-albumname-"+e).val())&&jQuery("#wppa-ss-button-"+e).css("display","");break;case"t":jQuery("#wppa-ss-albumtext-"+e).css("display","");r=jQuery(".wppa-ss-albumtext-"+e);for(n="",s=0;s<r.length;s++)jQuery(r[s]).prop("selected")&&(n+="."+jQuery(r[s]).val());""!=(n=n.substr(1))&&jQuery("#wppa-ss-button-"+e).css("display","")}break;case"p":switch(jQuery("#wppa-ss-photoopt-"+e).css("display",""),t=jQuery("#wppa-ss-photoopt-"+e).val()){case"n":jQuery("#wppa-ss-photoname-"+e).css("display",""),null!=(n=jQuery("#wppa-ss-photoname-"+e).val())&&jQuery("#wppa-ss-button-"+e).css("display","");break;case"o":jQuery("#wppa-ss-photoowner-"+e).css("display",""),null!=(n=jQuery("#wppa-ss-photoowner-"+e).val())&&jQuery("#wppa-ss-button-"+e).css("display","");break;case"g":jQuery("#wppa-ss-phototag-"+e).css("display","");r=jQuery(".wppa-ss-phototag-"+e);for(n="",s=0;s<r.length;s++)jQuery(r[s]).prop("selected")&&(n+="."+jQuery(r[s]).val());""!=(n=n.substr(1))&&jQuery("#wppa-ss-button-"+e).css("display","");break;case"t":jQuery("#wppa-ss-phototext-"+e).css("display","");var s,r=jQuery(".wppa-ss-phototext-"+e);for(n="",s=0;s<r.length;s++)jQuery(r[s]).prop("selected")&&(n+="."+jQuery(r[s]).val());""!=(n=n.substr(1))&&jQuery("#wppa-ss-button-"+e).css("display","");break;case"i":jQuery("#wppa-ss-photoiptc-"+e).css("display",""),(o=jQuery("#wppa-ss-photoiptc-"+e).val())&&(2<o.length&&(o=o.replace("#","H")),""!=o&&(jQuery("#wppa-ss-iptcopts-"+e).css("display",""),wppaLastIptc!=o?(wppaAjaxGetSsIptcList(e,o,"wppa-ss-iptcopts-"+e),wppaLastIptc=o):null!=(n=jQuery("#wppa-ss-iptcopts-"+e).val())&&""!=n&&jQuery("#wppa-ss-button-"+e).css("display","")));break;case"e":jQuery("#wppa-ss-photoexif-"+e).css("display",""),(o=jQuery("#wppa-ss-photoexif-"+e).val())&&(2<o.length&&(o=o.replace("#","H")),""!=o&&(jQuery("#wppa-ss-exifopts-"+e).css("display",""),wppaLastExif!=o?(wppaAjaxGetSsExifList(e,o,"wppa-ss-exifopts-"+e),wppaLastExif=o):null!=(n=jQuery("#wppa-ss-exifopts-"+e).val())&&""!=n&&jQuery("#wppa-ss-button-"+e).css("display","")))}}p&&(-1==(p=jQuery("#wppa-ss-pageurl-"+e).val()).indexOf("?")?p+="?":p+="&",p+="occur=1&wppa-supersearch="+a+","+t+","+o+","+n,document.location.href=p)}function wppaSetIptcExifSize(e,p){e=jQuery(e).length;6<e&&(e=6),e<2&&(e=2),jQuery(p).attr("size",e)}function wppaUpdateSearchRoot(e,p){for(var a=jQuery(".wppa-search-root"),t=0;t<a.length;)jQuery(a[t]).html(e),t++;for(a=jQuery(".wppa-rootbox"),t=0;t<a.length;)p?(jQuery(a[t]).prop("checked",!1),jQuery(a[t]).prop("disabled",!1)):(jQuery(a[t]).prop("checked",!0),jQuery(a[t]).prop("disabled",!0)),t++;for(a=jQuery(".wppa-search-root-id"),t=0;t<a.length;)jQuery(a[t]).val(p),t++}function wppaSubboxChange(e){jQuery(e).prop("checked")&&jQuery(".wppa-rootbox").each(function(e){jQuery(this).prop("checked",!0)})}function wppaClearSubsearch(){for(var e=jQuery(".wppa-display-searchstring"),p=0;p<e.length;)jQuery(e[p]).html(""),p++;for(e=jQuery(".wppa-search-sub-box"),p=0;p<e.length;)jQuery(e[p]).prop("disabled",!0),p++}function wppaEnableSubsearch(){for(var e=jQuery(".wppa-search-sub-box"),p=0;p<e.length;)jQuery(e[p]).removeAttr("disabled"),p++}function wppaDisplaySelectedFiles(e,p){var a=jQuery("#"+e),t=0,o="";for(p=p||" ";t<a[0].files.length;)o+=a[0].files[t].name+p,t++;jQuery("#"+e+"-display").val(o),jQuery("#"+e+"-display").html(o)}function wppaIsEmpty(e){return null==e||(void 0===e||(""==e||(0==e||(0==e||void 0))))}function wppaGetUploadOptions(yalb,mocc,where,onComplete){var options={beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce),jQuery("#progress-"+yalb+"-"+mocc).show(),jQuery("#bar-"+yalb+"-"+mocc).width("0%"),jQuery("#message-"+yalb+"-"+mocc).html(""),jQuery("#percent-"+yalb+"-"+mocc).html("")},uploadProgress:function(e,p,a,t){jQuery("#bar-"+yalb+"-"+mocc).css("backgroundColor","#7F7"),jQuery("#bar-"+yalb+"-"+mocc).width(t+"%"),t<95?jQuery("#percent-"+yalb+"-"+mocc).html(t+"%"):jQuery("#percent-"+yalb+"-"+mocc).html(\_\_("Processing...","wp-photo-album-plus"))},success:function(){jQuery("#bar-"+yalb+"-"+mocc).width("100%"),jQuery("#percent-"+yalb+"-"+mocc).html(\_\_("Done!","wp-photo-album-plus")),wppaUploadButtonText&&jQuery(".wppa-upload-button").val(wppaUploadButtonText)},complete:function(response){var txt,txt="rest"==wppaAjaxMethod?response.responseJSON.html:(theResult=JSON.parse(response.responseText),theResult.html);-1!=txt.indexOf(\_\_("Upload failed","wp-photo-album-plus"))?(jQuery("#bar-"+yalb+"-"+mocc).css("backgroundColor","#F77"),jQuery("#percent-"+yalb+"-"+mocc).html(\_\_("Upload failed","wp-photo-album-plus")),jQuery("#message-"+yalb+"-"+mocc).html('<span style="font-size: 10px;" >'+txt+"</span>")):(jQuery("#message-"+yalb+"-"+mocc).html('<span style="font-size: 10px;" >'+txt+"</span>"),"thumb"!=where&&"cover"!=where||eval(onComplete))},error:function(e,p,a){jQuery("#message-"+yalb+"-"+mocc).html('<span style="color: red;" >'+\_\_("Server error.","wp-photo-album-plus")+"</span>"),jQuery("#bar-"+yalb+"-"+mocc).css("backgroundColor","#F77"),jQuery("#percent-"+yalb+"-"+mocc).html(\_\_("Upload failed","wp-photo-album-plus")),wppaConsoleLog("Error = "+a+", status = "+p)}};return options}function wppaInitMasonryPlus(){jQuery(".grid-masonryplus").each(function(){var e=jQuery(this).attr("id").substr(5),p=wppaGetContainerWidth(e)-wppaThumbnailAreaDelta,a=parseInt((p+wppaTfMargin)/(.75\*wppaThumbSize+wppaTfMargin));0==a&&(a=1);a=parseInt(p/a);jQuery(".grid-item").css("visibility","visible"),jQuery(".grid-item-"+e).css("width",a+"px"),jQuery("#grid-"+e).masonry({itemSelector:".grid-item-"+e,columnWidth:a,fitWidth:!0})})}function wppaFsChange(){wppaFsShow(),wppaOvlShowSame()}function wppaGlobalFS(){if(wppaIsIpad)return!1;if(wppaIsSafari)return!1;var e=parseInt(wppaGlobalFsIconSize/4),p=e;!wppaIsMobile&&0<jQuery("#wpadminbar").length&&(e+=jQuery("#wpadminbar").height()),jQuery("body").append('<div id="wppa-fulls-btn-1" class="wppa-fulls-btn" style="position:fixed;top:'+e+"px;right:"+p+'px;display:none;" title="Enter fullscreen" onclick="wppaFsOn()" >'+wppaSvgHtml("Full-Screen",wppaGlobalFsIconSize+"px",!0,!1,"0","0","0","0")+"</div>"),jQuery("body").append('<div id="wppa-exit-fulls-btn-1" class="wppa-exit-fulls-btn" style="position:fixed;top:'+e+"px;right:"+p+'px;display:none;" title="Leave fullscreen" onclick="wppaFsOff()" >'+wppaSvgHtml("Exit-Full-Screen",wppaGlobalFsIconSize+"px",!0,!1,"0","0","0","0")+"</div>"),wppaFsShow()}function wppaFsOn(){var e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen()}function wppaFsOff(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()}function wppaIsFs(){return!wppaIsIpad&&(!wppaIsSafari&&null!==document.fullscreenElement)}function wppaFsShow(){wppaIsFs()?(jQuery(".wppa-fulls-btn").hide(),jQuery(".wppa-exit-fulls-btn").show()):(jQuery(".wppa-fulls-btn").show(),jQuery(".wppa-exit-fulls-btn").hide()),wppaOvlOpen&&"global"==wppaFsPolicy&&wppaOvlBigBrowse&&(jQuery("#wppa-fulls-btn-1").hide(),jQuery("#wppa-exit-fulls-btn-1").hide())}jQuery(document).ready(function(){jQuery(".wppa-ss-button").each(function(){mocc=jQuery(this).attr("data-mocc"),wppaSuperSearchSelect(mocc)})}),jQuery(document).ready(function(){jQuery(document).ready(function(){"global"==wppaFsPolicy&&wppaGlobalFS()}),jQuery(window).on("DOMContentLoaded load",wppaFsShow),jQuery(document).on("fullscreenchange mozfullscreenchange webkitfullscreenchange msfullscreenchange",wppaFsChange)});var wppaAudioOnlyRuns=[];function wppaDoAudioOnly(e,p,a,t){var o;wppaAudioSeqno=a;var n=p[0],r="";p.forEach(function(e,p){var a=e.split("."),a=a[a.length-1];r+='<source id="wppa-audio-source-'+p+"-"+t+'" src="'+e+'" type="audio/'+a+'">'}),r+="Your browser does not support the audio element.",""==(o=jQuery("#wppa-audio-source-0-"+t).attr("src"))&&(wppaAudioOnlyRuns[t]=!1),o==n&&wppaAudioOnlyRuns[t]?(document.getElementById("wppa-audioonly-"+t).pause(),wppaAudioOnlyRuns[t]=!1):(o==p[0]?document.getElementById("wppa-audioonly-"+t).play():(jQuery("#"+e).html(r),document.getElementById("wppa-audioonly-"+t).load(),document.getElementById("wppa-audioonly-"+t).play(),jQuery(".wppa-audiolabel-"+t).css("font-weight","normal"),jQuery("#audiolabel-"+t+"-"+a).css("font-weight","bold"),jQuery("#audiolabel-"+t+"-"+(a-1)).blur(),jQuery("#audiolabel-"+t+"-"+a).blur(),wppaHideAudioDesc(wppaAudioOnlyRuns[t],t,!0)),wppaShowAudioDesc(wppaAudioOnlyRuns[t]=a,t))}function wppaAudioOnlyNext(e){jQuery("#audiolabel-"+e+"-"+(wppaAudioSeqno+1)).trigger("click")}function wppaShowAudioDesc(e,p){jQuery("#"+("audiodesc-"+p+"-"+e)).show()}function wppaHideAudioDesc(e,p,a){var t;e&&(t="audiodesc-"+p+"-"+e,!a&&wppaAudioOnlyRuns[p]==e||jQuery("#"+t).hide())} |
  | 5 | 5 | // wppa-slideshow |
  | 6 |  | var wppaJsSlideshowVersion="8.~~8.04.001",wppaHasControlbar=!1;function wppaStoreSlideInfo(p,a,e,t,i,w,r,o,n,l,s,d,u,\_,m,h,c,y,S,g,f,x,j,I,Q,b,v,T,N,C,R,k,F,L,M,H){n=wppaRepairScriptTags(n),\_wppaSlides[p]&&"0"!=a||(\_wppaSlides[p]=[],\_wppaNames[p]=[],\_wppaFilmThumbTitles[p]=[],\_wppaFullNames[p]=[],\_wppaDsc[p]=[],\_wppaOgDsc[p]=[],\_wppaCurIdx[p]=-1,\_wppaNxtIdx[p]=0,wppaSavedSlideshowTimeout[p]?\_wppaTimeOut[p]=wppaSavedSlideshowTimeout[p]:(\_wppaTimeOut[p]=S,wppaSavedSlideshowTimeout[p]=\_wppaTimeOut[p]),\_wppaSSRuns[p]=!1,\_wppaTP[p]=-2,\_wppaFg[p]=0,\_wppaIsBusy[p]=!1,\_wppaFirst[p]=!0,\_wppaId[p]=[],\_wppaRealId[p]=[],\_wppaAvg[p]=[],\_wppaDisc[p]=[],\_wppaMyr[p]=[],\_wppaVRU[p]=[],\_wppaLinkUrl[p]=[],\_wppaLinkTitle[p]=[],\_wppaLinkTarget[p]=[],\_wppaCommentHtml[p]=[],\_wppaIptcHtml[p]=[],\_wppaExifHtml[p]=[],\_wppaUrl[p]=[],\_wppaSkipRated[p]=!1,\_wppaLbTitle[p]=[],\_wppaDidGoto[p]=!1,wppaSlidePause[p]=!1,\_wppaShareUrl[p]=[],\_wppaShareHtml[p]=[],\_wppaFilmNoMove[p]=!1,\_wppaHiresUrl[p]=[],\_wppaIsVideo[p]=[],\_wppaIsAudio[p]=[],\_wppaVideoHtml[p]=[],\_wppaAudioHtml[p]=[],\_wppaVideoNatWidth[p]=[],\_wppaVideoNatHeight[p]=[],wppaVideoPlaying[p]=!1,wppaAudioPlaying[p]=!1,\_wppaWaitTexts[p]=[],\_wppaImageAlt[p]=[],\_wppaFilename[p]=[],\_wppaPanoramaHtml[p]=[],\_wppaPanControlHeight[p]=[],\_wppaRatio[p]=[]),S="default",""!=h?S="pointer":""!=wppaLightBox[p]&&(S="url( "+wppaImageDirectory+wppaMagnifierCursor+" ),pointer"),\_wppaIsVideo[p][a]=""!=T,\_wppaIsAudio[p][a]=""!=N,\_wppaIsVideo[p][a]?(\_wppaSlides[p][a]=' alt="'+R+'" class="theimg theimg-'+p+' big" ',wppaSlideVideoStart&&""==wppaLightBox[p]&&(\_wppaSlides[p][a]+=" autoplay "),0<k.length&&(\_wppaSlides[p][a]+=' poster="'+k+'" ')):(\_wppaIsAudio[p][a]&&(\_wppaSlides[p][a]=' alt="'+R+'" class="theimg theimg-'+p+' big" ',wppaSlideAudioStart&&""==wppaLightBox[p]&&(\_wppaSlides[p][a]+=" autoplay ")),\_wppaSlides[p][a]=' src="'+e+'" alt="'+R+'" class="theimg theimg-'+p+' big stereo" '),wppaSlideSwipe&&(\_wppaSlides[p][a]+=' ontouchstart="wppaTouchStart( event, this.id, '+p+' );" ontouchend="wppaTouchEnd( event );" ontouchmove="wppaTouchMove( event );" ontouchcancel="wppaTouchCancel( event );" '),wppaAutoColumnWidth[p]||(\_wppaSlides[p][a]+='width="'+i+'" height="'+w+'" '),\_wppaIsVideo[p][a]?(k="wppa"==wppaLightBox[p]?"":"controls",\_wppaSlides[p][a]+='style="'+t+"; cursor:"+S+'; display:none;" '+k+">"~~+T+"</video>"):\_wppaSlides[p][a]+='style="'+t+"; cursor:"+S+'; display:none; vertical-align:middle;">',\_wppaFullNames[p][a]='<span class="sdf-'+p+'" >'+wppaRepairBrTags(r)+"</span>",\_wppaNames[p][a]='<span class="sdn-'+p+'" >'+o+"</span>",\_wppaFilmThumbTitles[p][a]=o,\_wppaDsc[p][a]=n,\_wppaOgDsc[p][a]=b,\_wppaId[p][a]=l,\_wppaRealId[p][a]=s,\_wppaAvg[p][a]=d,\_wppaDisc[p][a]=u,\_wppaMyr[p][a]=\_,\_wppaVRU[p][a]=m,\_wppaLinkUrl[p][a]=h,\_wppaLinkTitle[p][a]=c,""!=y?\_wppaLinkTarget[p][a]=y:wppaSlideBlank[p]?\_wppaLinkTarget[p][a]="\_blank":\_wppaLinkTarget[p][a]="\_self",\_wppaCommentHtml[p][a]=g,\_wppaIptcHtml[p][a]=f,\_wppaExifHtml[p][a]=x,\_wppaUrl[p][a]=e,\_wppaLbTitle[p][a]=wppaRepairScriptTags(j),\_wppaShareUrl[p][a]=I,\_wppaShareHtml[p][a]=wppaRepairScriptTags(Q),\_wppaHiresUrl[p][a]=v,\_wppaVideoHtml[p][a]=T,\_wppaAudioHtml[p][a]=N,\_wppaVideoNatWidth[p][a]=i,\_wppaVideoNatHeight[p][a]=w,\_wppaWaitTexts[p][a]=C,\_wppaImageAlt[p][a]=R,\_wppaFilename[p][a]=F,\_wppaPanoramaHtml[p][a]=L,\_wppaPanControlHeight[p][a]=M,\_wppaRatio[p][a]=H}function wppaSpeed(p,a){\_wppaSSRuns[p]&&\_wppaSpeed(p,a)}function wppaStopShow(p){\_wppaSSRuns[p]&&\_wppaStop(p)}function wppaStopMedia(p){wppaStopAudio(p),wppaStopVideo(p),wppaStopShow(p)}function wppaStartStop(p,a){wppaSlideInitRunning[p]&&("start"==wppaSlideInitRunning[p]?a=-1:"stopprev"==wppaSlideInitRunning[p]?(a=\_wppaSlides[p].length-1,\_wppaStop(p)):"stopnext"==wppaSlideInitRunning[p]&&(a=0,\_wppaStop(p)),wppaSlideInitRunning[p]=""),\_wppaIsBusy[p]&&(\_wppaTP[p]=a),\_wppaSSRuns[p]?\_wppaStop(p):\_wppaStart(p,a),wppaIsMobile&&(jQuery("#wppa-startstop-icon-"+p).stop().fadeTo(10,1).fadeTo(3e3,0),jQuery(".ubb-"+p).stop().fadeTo(10,1).fadeTo(3e3,0))}function wppaBbb(p,a,e){\_wppaSSRuns[p]||\_wppaBbb(p,a,e)}function wppaUbb(p,a,e){\_wppaUbb(p,a,e)}function wppaRateIt(p,a){\_wppaRateIt(p,a)}function wppaOvlRateIt(p,a,e,t){\_wppaOvlRateIt(p,a,e,t)}function wppaPrev(p){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaPrev(p)}function wppaPrevN(p,a){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaPrevN(p,a)}function wppaFirst(p){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaGoto(p,0)}function wppaNext(p){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaNext(p)}function wppaNextN(p,a){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaNextN(p,a)}function wppaLast(p){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaGoto(p,\_wppaSlides[p].length-1)}function wppaFollowMe(p,a){wppaStopMedia(p),\_wppaSSRuns[p]||\_wppaFollowMe(p,a)}function wppaLeaveMe(p,a){wppaStopMedia(p),\_wppaSSRuns[p]||\_wppaLeaveMe(p,a)}function wppaGoto(p,a){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaGoto(p,a)}function wppaGotoFilmNoMove(p,a){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||(\_wppaFilmNoMove[p]=!0,\_wppaGoto(p,a))}function wppaGotoKeepState(p,a){wppaStopMedia(p),\_wppaNxtIdx[p]!=a&&(\_wppaDidGoto[p]=!0,\_wppaGotoKeepState(p,a))}function \_wppaGotoKeepState(p,a){(\_wppaSSRuns[p]?\_wppaGotoRunning:\_wppaGoto)(p,a)}function wppaGotoRunning(p,a){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaGotoRunning(p,a)}function wppaValidateComment(p){return \_wppaValidateComment(p)}function \_wppaNextSlide(p,a){var e=!document.getElementById("slide\_frame-"+p);if(wppaLazyLoad&&!e&&!wppaIsSlidshowVisible(p))return wppaFilmInit[p]=!1,void setTimeout(function(){\_wppaNextSlide(p,a)},400);if(\_wppaLastIdx[p]=\_wppaCurIdx[p],!document.getElementById("slide\_frame-"+p)&&document.getElementById("filmwindow-"+p)&&wppaFilmonlyContinuous)return \_wppaSSRuns[p]?(\_wppaCurIdx[p]++,\_wppaCurIdx[p]==\_wppaSlides[p].length&&(\_wppaCurIdx[p]=0),\_wppaAdjustFilmstrip(p,"linear"),\_wppaNxtIdx[p]=\_wppaCurIdx[p],void setTimeout("\_wppaNextSlide( "+p+", '"+a+"' )",wppaAnimationSpeed)):(\_wppaCurIdx[p]=\_wppaNxtIdx[p],wppaFilmInit[p]=!1,void \_wppaAdjustFilmstrip(p,"linear"));if(document.getElementById("slide\_frame-"+p)||document.getElementById("filmwindow-"+p)){var t=\_wppaFg[p],e=1-t;if((wppaVideoPlaying[p]||wppaAudioPlaying[p])&&\_wppaSSRuns[p])setTimeout("\_wppaNextSlide( "+p+", '"+a+"' )",500);else{if("auto"==a){if(wppaSlidePause[p])return jQuery("#theimg"+t+"-"+p).attr("title",wppaSlidePause[p]),jQuery("#slide\_frame-"+p).attr("title",wppaSlidePause[p]),void setTimeout("\_wppaNextSlide( "+p+', "auto" )',250)}else jQuery("#slide\_frame-"+p).removeAttr("title");if((\_wppaSSRuns[p]||"auto"!=a)&&\_wppaSlides[p]&&(!(\_wppaSlides[p].length<2)||\_wppaFirst[p])){if(\_wppaSSRuns[p]||"reset"!=a||(\_wppaSSRuns[p]=!0,\_\_wppaOverruleRun=!1),\_wppaVoteInProgress=!1,\_wppaIsBusy[p]=!0,\_wppaSSRuns[p]&&\_wppaShowMetaData(p,"hide"),\_wppaSSRuns[p]&&(\_wppaNxtIdx[p]=\_wppaCurIdx[p]+1,\_wppaNxtIdx[p]==\_wppaSlides[p].length&&(\_wppaNxtIdx[p]=0)),jQuery("#geodiv-"+p+"-"+\_wppaId[p][\_wppaCurIdx[p]]).css({display:"none"}),jQuery("#geodiv-"+p+"-"+\_wppaId[p][\_wppaNxtIdx[p]]).css({display:""}),"undefined"!=typeof \_wppaLat&&\_wppaLat[p]?(o=\_wppaRealId[p],\_wppaLat[p][o[\_wppaNxtIdx[p]]]?(jQuery("#map-canvas-"+p).css("display",""),wppaGeoInit(p,\_wppaLat[p][o[\_wppaNxtIdx[p]]],\_wppaLon[p][o[\_wppaNxtIdx[p]]])):jQuery("#map-canvas-"+p).css("display","none")):jQuery("#map-canvas-"+p).css("display","none"),jQuery("[id^=wppa-numbar-"+p+"-]").css({backgroundColor:wppaBGcolorNumbar,borderColor:wppaBcolorNumbar,fontFamily:wppaFontFamilyNumbar,fontSize:wppaFontSizeNumbar,color:wppaFontColorNumbar,fontWeight:wppaFontWeightNumbar}),jQuery("#wppa-numbar-"+p+"-"+\_wppaNxtIdx[p]).css({backgroundColor:wppaBGcolorNumbarActive,borderColor:wppaBcolorNumbarActive,fontFamily:wppaFontFamilyNumbarActive,fontSize:wppaFontSizeNumbarActive,color:wppaFontColorNumbarActive,fontWeight:wppaFontWeightNumbarActive}),\_wppaSlides[p].length>wppaNumbarMax){var i,w,r=\_wppaSlides[p].length-1,o=\_wppaNxtIdx[p],n=(wppaNumbarMax-1)/2;o<n?(i=0,w=wppaNumbarMax-1-1,jQuery("#wppa-nbar-"+p+"-lodots").css({display:"none"}),jQuery("#wppa-nbar-"+p+"-hidots").css({display:"block"})):r-n<o?(i=(w=r)-wppaNumbarMax+1+1,jQuery("#wppa-nbar-"+p+"-lodots").css({display:"block"}),jQuery("#wppa-nbar-"+p+"-hidots").css({display:"none"})):(w=o+n+.5-1,(i=o-n+1)<2?(jQuery("#wppa-nbar-"+p+"-lodots").css({display:"none"}),jQuery("#wppa-nbar-"+p+"-hidots").css({display:"block"})):r-1<w?(jQuery("#wppa-nbar-"+p+"-lodots").css({display:"block"}),jQuery("#wppa-nbar-"+p+"-hidots").css({display:"none"})):(jQuery("#wppa-nbar-"+p+"-lodots").css({display:"block"}),jQuery("#wppa-nbar-"+p+"-hidots").css({display:"block"})));for(var l=0;l<\_wppaSlides[p].length;)0!=l&&l!=r&&(l<i||w<l)?jQuery("#wppa-numbar-"+p+"-"+l).css({display:"none"}):jQuery("#wppa-numbar-"+p+"-"+l).css({display:"block"}),l++}\_wppaFirst[p]?(-1!=\_wppaCurIdx[p]&&wppaMakeTheSlideHtml(p,"0",\_wppaCurIdx[p]),wppaMakeTheSlideHtml(p,"1",\_wppaNxtIdx[p]),jQuery("#imagedesc-"+p).html(\_wppaDsc[p][\_wppaCurIdx[p]]),jQuery("#imagetitle-"+p).html(wppaMakeNameHtml(p)),"void"==\_wppaCommentHtml[p][\_wppaCurIdx[p]]?(jQuery("#wppa-comments-"+p).hide(),jQuery("#wppa-comments-"+p).html("")):(jQuery("#wppa-comments-"+p).show(),jQuery("#wppa-comments-"+p).html(\_wppaCommentHtml[p][\_wppaCurIdx[p]])),jQuery("#iptc-"+p).html(\_wppaIptcHtml[p][\_wppaCurIdx[p]]),jQuery("#exif-"+p).html(\_wppaExifHtml[p][\_wppaCurIdx[p]]),"icons"==wppaSlideshowNavigationType?(n=wppaIconSize(p,"1.5em",!1),jQuery("#prev-arrow-"+p).html(wppaSvgHtml("Prev-Button",n,!1,!0)),jQuery("#next-arrow-"+p).html(wppaSvgHtml("Next-Button",n,!1,!0))):wppaIsMini[p]||wppaGetContainerWidth(p)<wppaMiniTreshold?(jQuery("#prev-arrow-"+p).html("&laquo;&nbsp;"+\_\_("Previous","wp-photo-album-plus")),jQuery("#next-arrow-"+p).html(\_\_("Next","wp-photo-album-plus")+"&nbsp;&raquo;")):(jQuery("#prev-arrow-"+p).html("&laquo;&nbsp;"+\_\_("Previous photo","wp-photo-album-plus")),jQuery("#next-arrow-"+p).html(\_\_("Next photo","wp-photo-album-plus")+"&nbsp;&raquo;")),wppaIsMini[p]||wppaGetContainerWidth(p)<wppaMiniTreshold?(jQuery("#wppa-avg-rat-"+p).html(\_\_("Avg","wp-photo-album-plus")),jQuery("#wppa-my-rat-"+p).html(\_\_("Mine","wp-photo-album-plus"))):(jQuery("#wppa-avg-rat-"+p).html(\_\_("Average&nbsp;rating","wp-photo-album-plus")),jQuery("#wppa-my-rat-"+p).html(\_\_("My&nbsp;rating","wp-photo-album-plus")))):wppaMakeTheSlideHtml(p,e,\_wppaNxtIdx[p]),\_wppaFirst[p]=!1,setTimeout("\_wppaNextSlide\_2( "+p+" )",10)}}}}function \_wppaNextSlide\_2(p){var a=\_wppaFg[p],e=1-a,t=document.getElementById("theimg"+e+"-"+p);!t||1!=t.nodeType||"IMG"!=t.nodeName||t.complete?(wppaUpdateLightboxes(),jQuery("#wppa-slide-spin-"+p).hide(),-1!=\_wppaSSRuns[p]&&(\_wppaToTheSame||\_wppaShowMetaData(p,"hide")),\_wppaFg[p]=1-\_wppaFg[p],\_wppaFg[p],setTimeout("\_wppaNextSlide\_3( "+p+" )",10)):setTimeout("\_wppaNextSlide\_2( "+p+" )",200)}function \_wppaNextSlide\_3(p){var a=\_wppaFg[p],e=1-a,t=\_wppaCurIdx[p],i=\_wppaNxtIdx[p],w="#theslide"+e+"-"+p,r="#theslide"+a+"-"+p,o="#theimg"+e+"-"+p,n="#theimg"+a+"-"+p,l=parseInt(jQuery(w).css("width")),s=t==i+1?"right":t==i-1?"left":t==i?"none":"nil";switch(t==\_wppaSlides[p].length-1&&0==i&&wppaSlideWrap[p]&&(s="left"),0==t&&i==\_wppaSlides[p].length-1&&wppaSlideWrap[p]&&(s="right"),"nil"==s&&(s=t<i?"left":"right"),jQuery(w).css({marginLeft:0,width:l}),jQuery(r).css({marginLeft:0,width:l}),wppaFormatSlide(p),wppaAnimationType){case"fadeafter":wppaFadeOut(o,wppaAnimationSpeed),jQuery("#theslide"+e+"-"+p).find("canvas").fadeOut(wppaAnimationSpeed),jQuery("#theslide"+e+"-"+p).find("video").fadeOut(wppaAnimationSpeed),setTimeout(wppaFadeIn(n,wppaAnimationSpeed,\_wppaNextSlide\_4(p)),wppaAnimationSpeed);break;case"swipe":switch(s){case"left":wppaAnimate(w,{marginLeft:-l},wppaAnimationSpeed,wppaEasingSlide),jQuery(r).css({marginLeft:l}),wppaFadeIn(n,10),wppaAnimate(r,{marginLeft:0},wppaAnimationSpeed,wppaEasingSlide,\_wppaNextSlide\_4(p));break;case"right":wppaAnimate(w,{marginLeft:l},wppaAnimationSpeed,wppaEasingSlide),jQuery(r).css({marginLeft:-l}),wppaFadeIn(n,10),wppaAnimate(r,{marginLeft:0},wppaAnimationSpeed,wppaEasingSlide,\_wppaNextSlide\_4(p));break;case"none":wppaFadeIn(n,10),setTimeout("\_wppaNextSlide\_4( "+p+" )",10)}break;default:wppaFadeOut(o,wppaAnimationSpeed),jQuery("#theslide"+e+"-"+p).find("canvas").fadeOut(wppaAnimationSpeed),jQuery("#theslide"+e+"-"+p).find("video").fadeOut(wppaAnimationSpeed),wppaFadeIn(n,wppaAnimationSpeed,\_wppaNextSlide\_4(p))}}function \_wppaNextSlide\_4(p){var a=\_wppaFg[p],e="#theslide"+a+"-"+p;jQuery("#theslide"+(1-a)+"-"+p).css({zIndex:80}),jQuery(e).css({zIndex:81}),\_wppaCurIdx[p]=\_wppaNxtIdx[p],wppaFormatSlide(p),wppaIsMini[p]||wppaGetContainerWidth(p)<wppaMiniTreshold?jQuery("#counter-"+p).html(\_wppaCurIdx[p]+1+" / "+\_wppaSlides[p].length):jQuery("#counter-"+p).html(\_\_("Photo","wp-photo-album-plus")+" "+(\_wppaCurIdx[p]+1)+" "+\_\_("of","wp-photo-album-plus")+" "+\_wppaSlides[p].length),jQuery("#bc-pname-modal-"+p).html(\_wppaNames[p][\_wppaCurIdx[p]]),jQuery("#bc-pname-"+p).html(\_wppaNames[p][\_wppaCurIdx[p]]),\_wppaAdjustFilmstrip(p,wppaEasingSlide),\_wppaSetRatingDisplay(p),setTimeout("\_wppaNextSlide\_5( "+p+" )",\_wppaTextDelay)}function \_wppaNextSlide\_5(p){var a,e,t;if(\_wppaToTheSame||(a=\_wppaDsc[p][\_wppaCurIdx[p]],jQuery("#imagedesc-"+p).html(a),wppaHideWhenEmpty&&(""==(i=\_wppaDsc[p][\_wppaCurIdx[p]])||"&nbsp;"==i?jQuery("#descbox-"+p).css("display","none"):jQuery("#descbox-"+p).css("display","")),jQuery("#imagetitle-"+p).html(wppaMakeNameHtml(p)),"void"==\_wppaCommentHtml[p][\_wppaCurIdx[p]]?(jQuery("#wppa-comments-"+p).hide(),jQuery("#wppa-comments-"+p).html("")):(jQuery("#wppa-comments-"+p).show(),jQuery("#wppa-comments-"+p).html(\_wppaCommentHtml[p][\_wppaCurIdx[p]])),jQuery("#iptc-"+p).html(\_wppaIptcHtml[p][\_wppaCurIdx[p]]),jQuery("#exif-"+p).html(\_wppaExifHtml[p][\_wppaCurIdx[p]]),jQuery("#wppa-share-"+p).html(\_wppaShareHtml[p][\_wppaCurIdx[p]])),\_wppaToTheSame=!1,wppaThumbPageSize?wppaThumbPage[p]=parseInt(((0|wppaSlideOffset[p])+\_wppaCurIdx[p])/wppaThumbPageSize)+1:wppaThumbPage[p]=1,\_wppaSSRuns[p]&&!wppaSlideWrap[p]&&\_wppaCurIdx[p]+1==\_wppaSlides[p].length)return \_wppaIsBusy[p]=!1,void \_wppaStop(p);if(\_wppaShowMetaData(p,"show"),-2!=\_wppaTP[p]){var i=\_wppaTP[p];return \_wppaTP[p]=-2,\_wppaDidGoto[p]=!1,\_wppaIsBusy[p]=!1,wppaIsMini[p]||\_bumpViewCount(\_wppaId[p][\_wppaCurIdx[p]]),\_wppaDoAutocol(p,"next\_5"),void wppaStartStop(p,i)}wppaUpdateLightboxes(),wppaIsMini[p]||(e=\_wppaShareUrl[p][\_wppaCurIdx[p]],"undefined"!=typeof wppaQRUpdate&&wppaQRUpdate(\_wppaShareUrl[p][\_wppaCurIdx[p]]),1<\_wppaSlides[p].length&&wppaPushStateSlide(p,\_wppaCurIdx[p],e)),\_wppaSSRuns[p]&&(\_wppaCurIdx[p]+1==\_wppaSlides[p].length?(e=jQuery("#wppa-next-pagelink-"+p),t=jQuery("#wppa-first-pagelink-"+p),0<e.length&&"hidden"!=jQuery(e).css("visibility")?setTimeout(function(){wppaSlideInitRunning[p]="start",jQuery("#wppa-next-pagelink-"+p).trigger("click")},wppaGetSlideshowTimeout(p,"next page trigger")):0<t.length?setTimeout(function(){jQuery(t).trigger("click")},wppaGetSlideshowTimeout(p,"first page trigger")):setTimeout("\_wppaNextSlide( "+p+', "auto" )',wppaGetSlideshowTimeout(p,"just wait for next in current(1)"))):setTimeout("\_wppaNextSlide( "+p+', "auto" )',wppaGetSlideshowTimeout(p,"just wait for next in current(2)"))),jQuery(document).trigger("glossaryTooltipReady"),\_wppaDidGoto[p]=!1,\_wppaIsBusy[p]=!1,wppaIsMini[p]||\_bumpViewCount(\_wppaId[p][\_wppaCurIdx[p]]),wppaProtect(),"none"==jQuery("#wppa-overlay-bg").css("display")&&jQuery(window).trigger("resize"),wppaHasControlbar||jQuery("#wppa-pctl-div-"+p).hide()}function wppaFormatSlide(p){var a="theimg"+\_wppaFg[p]+"-"+p,e=document.getElementById(a);if(e){var t="theslide"+\_wppaFg[p]+"-"+p,i="slide\_frame-"+p,w=wppaGetContainerWidth(p);wppaColWidth[p]=w;var r=jQuery(".wppa-audio-"+p),o=e.naturalWidth;void 0===o&&(o=parseInt(e.style.maxWidth));var n=e.naturalHeight;void 0===n&&(n=parseInt(e.style.maxHeight));var l=wppaAspectRatio[p],s=wppaFullSize[p],d=wppaFullFrameDelta[p],u=wppaPortraitOnly[p],\_=wppaFullValign[p];void 0===\_&&(\_="none");var m=wppaFullHalign[p];void 0===m&&(m="none");var h,c,y,S,g,f,e=wppaStretch;if(u)h=w-d,y=0,j=S=w,f=g=(c=parseInt(h\*n/o))+d,jQuery("#"+i).css({width:j,height:f}),jQuery("#"+t).css({width:S,height:g}),jQuery("#"+a).css({width:h,height:c});else{if(s<(j=w)&&(j=s),S=j,g=f=parseInt(j\*l),e||j-d<=o||f-d<=n?l<(n+d)/(o+d)?(c=f-d,h=parseInt(c\*o/n)):(h=j-d,c=parseInt(h\*n/o)):(h=o,c=n),"default"!=\_&&"none"!=\_){switch(\_){case"top":y=0;break;case"center":y=parseInt((f-(c+d))/2);break;case"bottom":y=f-(c+d);break;case"fit":y=0,g=f=c+d}jQuery("#"+a).css({marginTop:y,marginBottom:0})}if(jQuery("#"+i).css({width:j,height:f}),jQuery("#"+t).css({width:S,height:g}),jQuery("#"+a).css({width:h,height:c}),"default"!=\_&&"none"!=\_&&"none"!=m&&"default"!=m)switch(m){case"left":jQuery("#"+a).css({marginLeft:0,marginRight:"auto"});break;case"center":jQuery("#"+a).css({marginLeft:"auto",marginRight:"auto"});break;case"right":jQuery("#"+a).css({marginLeft:"auto",marginRight:0});break;default:jQuery("#"+a).css({marginLeft:"auto",marginRight:"auto"})}var m=jQuery(r).height(),x=(j-h)/2;m&&0<m&&(wppaAudioHeight=m,jQuery(r).css({height:wppaAudioHeight,width:h,left:x}))}x=\_wppaHiresUrl[p][\_wppaCurIdx[p]]||"";".pdf"==x.substr(x.length-4,x.length)&&jQuery("#"+t).css({width:"100%",height:"100%"});var j=parseInt(j/3);jQuery("#bbb-"+p+"-l").css({width:j}),jQuery("#bbb-"+p+"-r").css({width:j})}}function wppaMakeNameHtml(p){return \_wppaCurIdx[p]<0?"":"void"==\_wppaFullNames[p][\_wppaCurIdx[p]]?(jQuery("#namebox-"+p).hide(),""):(jQuery("#namebox-"+p).show(),wppaRepairBrTags(\_wppaFullNames[p][\_wppaCurIdx[p]]))}function wppaMakeTheSlideHtml(p,a,e){var t,i,w=\_wppaIsVideo[p][e]?"video":"img",r="title";"wppa"==wppaLightBox[p]&&(r="data-lbtitle");var o,n,l=""==wppaLightBox[p]?' onpause="wppaVideoPlaying['+p+'] = false;" onplay="wppaVideoPlaying['+p+'] = true;"':"",s=0<\_wppaPanoramaHtml[p][e].length;if(wppaHasControlbar=s,jQuery("body").trigger("quitimage",[p]),s){t=\_wppaPanoramaHtml[p][e].replace(/title=""/g,""),jQuery("#theslide"+(1-a)+"-"+p).html(""),jQuery("#theslide"+a+"-"+p).html(t);s=wppaGetContainerWidth(p)\*wppaAspectRatio[p];jQuery("#slide\_frame-"+p).css({height:s})}else{if(n=".pdf"==(o=\_wppaHiresUrl[p][e]||"").substr(o.length-4,o.length),""!=\_wppaLinkUrl[p][e])t=wppaSlideToFullpopup?'<a onclick="wppaStopAudio();wppaStopShow('+p+");"+\_wppaLinkUrl[p][e]+'" target="'+\_wppaLinkTarget[p][e]+'" title="'+\_wppaLinkTitle[p][e]+'">'+(n?"<iframe "+l+' src="'+o+'" title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" style="width:100%;height:100%;" ></iframe>':"<"+w+l+' title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" '+\_wppaSlides[p][e])+"</a>":"<a onclick=\"\_bumpClickCount('"+\_wppaId[p][e]+"');wppaStopAudio();wppaStopShow("+p+");window.open('"+\_wppaLinkUrl[p][e]+"', '"+\_wppaLinkTarget[p][e]+'\');" title="'+\_wppaLinkTitle[p][e]+'">'+(n?"<iframe "+l+' src="'+o+'" title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" style="width:100%;height:100%;" ></iframe>':"<"+w+l+' title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" '+\_wppaSlides[p][e])+"</a>";else if(""==wppaLightBox[p])t=n?"<iframe "+l+' src="'+o+'" title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" style="width:100%;height:100%;" ></iframe>':"<"+w+l+' title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" '+\_wppaSlides[p][e];else{for(var d="",u=0,\_=wppaLightboxSingle[p]?"":"[slide-"+p+"-"+a+"]";u<e;)i=wppaOvlHires||"wppa"!=wppaLightBox[p]?\_wppaHiresUrl[p][u]:wppaMakeFullsizeUrl(\_wppaUrl[p][u]),n=".pdf"==(o=\_wppaHiresUrl[p][u]||"").substr(o.length-4,o.length),d+='<a href="'+i+'"'+(\_wppaIsVideo[p][u]?' data-videonatwidth="'+\_wppaVideoNatWidth[p][u]+'" data-videonatheight="'+\_wppaVideoNatHeight[p][u]+'" data-videohtml="'+encodeURI(\_wppaVideoHtml[p][u])+'"':"")+(n?" data-pdfhtml=\"src='"+o+"'\"":"")+(""!=\_wppaAudioHtml[p][u]?' data-audiohtml="'+encodeURI(\_wppaAudioHtml[p][u])+'"':"")+" "+r+'="'+\_wppaLbTitle[p][u]+'" '+wppaRel+'="'+wppaLightBox[p]+\_+'"></a>',u++;for(i=wppaOvlHires||"wppa"!=wppaLightBox[p]?\_wppaHiresUrl[p][e]:wppaMakeFullsizeUrl(\_wppaUrl[p][e]),n=".pdf"==(o=\_wppaHiresUrl[p][e]).substr(o.length-4,o.length),d+='<a href="'+i+'"'+(' onclick="wppaStopAudio();wppaStopShow('+p+');"')+' style="cursor:pointer;" target="'+\_wppaLinkTarget[p][e]+'"'+(\_wppaIsVideo[p][u]?' data-videonatwidth="'+\_wppaVideoNatWidth[p][e]+'" data-videonatheight="'+\_wppaVideoNatHeight[p][e]+'" data-videohtml="'+encodeURI(\_wppaVideoHtml[p][e])+'"':"")+(n?" data-pdfhtml=\"src='"+o+"'\"":"")+(""!=\_wppaAudioHtml[p][u]?' data-audiohtml="'+encodeURI(\_wppaAudioHtml[p][e])+'"':"")+" "+r+'="'+\_wppaLbTitle[p][e]+'" '+wppaRel+'="'+wppaLightBox[p]+\_+'">'+(n?"<iframe "+l+' src="'+o+'" title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" style="width:100%;height:100%;" ></iframe>':"<"+w+l+' title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" '+\_wppaSlides[p][e])+"</a>",u=e+1;u<\_wppaUrl[p].length;)i=wppaOvlHires||"wppa"!=wppaLightBox[p]?\_wppaHiresUrl[p][u]:wppaMakeFullsizeUrl(\_wppaUrl[p][u]),n=".pdf"==(o=\_wppaHiresUrl[p][u]).substr(o.length-4,o.length),d+='<a href="'+i+'"'+(\_wppaIsVideo[p][u]?' data-videonatwidth="'+\_wppaVideoNatWidth[p][u]+'" data-videonatheight="'+\_wppaVideoNatHeight[p][u]+'" data-videohtml="'+encodeURI(\_wppaVideoHtml[p][u])+'"':"")+(n?" data-pdfhtml=\"src='"+o+"'\"":"")+(""!=\_wppaAudioHtml[p][u]?' data-audiohtml="'+encodeURI(\_wppaAudioHtml[p][u])+'"':"")+" "+r+'="'+\_wppaLbTitle[p][u]+'" '+wppaRel+'="'+wppaLightBox[p]+\_+'"></a>',u++;t=d}""!=\_wppaAudioHtml[p][e]&&(t+='<audio controls id="wppa-audio-'+\_wppaId[p][e]+"-"+p+'" class="wppa-audio-'+p+" wppa-audio-"+\_wppaId[p][e]+"-"+p+'" data-from="wppa"'+(wppaSlideAudioStart&&""==wppaLightBox[p]?" autoplay":"")+' onplay="wppaAudioPlaying['+p+'] = true;" onpause="wppaAudioPlaying['+p+'] = false" style="position:relative;top:-'+(wppaAudioHeight+wppaSlideBorderWidth)+"px;z-index:10;width:"+\_wppaVideoNatWidth[p][e]+'px;padding:0;box-sizing:border-box;" >'+\_wppaAudioHtml[p][e]+"</audio>"),t=t.replace(/title=""/g,""),jQuery("#theslide"+a+"-"+p).html(t)}}function wppaAdjustAllFilmstrips(p){jQuery(".wppa-filmstrip").each(function(){\_wppaAdjustFilmstrip(jQuery(this).attr("id").substr(15),p)})}var wppaLastAnimFilmLoc=[];function \_wppaAdjustFilmstrip(p,a){if("linear"!=a&&(a=wppaEasingSlide),document.getElementById("wppa-filmstrip-"+p)&&\_wppaSlides[p]){var e,t,i,w,r=!document.getElementById("slide\_frame-"+p);if(wppaLastAnimFilmLoc[p]||(wppaLastAnimFilmLoc[p]=0),r){var o=jQuery("#wppa-filmstrip-"+p);if(!wppaIsElementInViewport(o))return}if(r||(jQuery(".wppa-film-"+p).find("img").removeClass("wppa-filmthumb-active"),jQuery(".wppa-film-"+p).find("canvas").removeClass("wppa-filmthumb-active")),\_wppaFilmNoMove[p]&&wppaFilmInit[p]?\_wppaFilmNoMove[p]=!1:(wppaFilmWindowLen=wppaGetContainerWidth(p)-wppaFilmStripAreaDelta[p],jQuery("#filmwindow-"+p).width(wppaFilmWindowLen),e=wppaFilmWindowLen/2-(\_wppaCurIdx[p]+.5+wppaPreambule[p])\*wppaThumbnailPitch[p]-wppaFilmStripMargin[p],wppaFilmShowGlue&&(e-=2\*wppaFilmStripMargin[p]+2),i=e+wppaThumbnailPitch[p],w=e-wppaThumbnailPitch[p],t=wppaAnimationSpeed,wppaFilmInit[p]||(t=1),0==\_wppaCurIdx[p]&&\_wppaLastIdx[p]==\_wppaSlides[p].length-1?(jQuery("#wppa-filmstrip-"+p).css({marginLeft:i+"px"}),wppaLastAnimFilmLoc[p]!=e&&(wppaAnimate("#wppa-filmstrip-"+p,{marginLeft:e},t,a),wppaLastAnimFilmLoc[p]=e)):0==\_wppaLastIdx[p]&&\_wppaCurIdx[p]==\_wppaSlides[p].length-1?(jQuery("#wppa-filmstrip-"+p).css({marginLeft:w}),wppaLastAnimFilmLoc[p]!=e&&(wppaAnimate("#wppa-filmstrip-"+p,{marginLeft:e},t,a),wppaLastAnimFilmLoc[p]=e)):(o=parseInt(jQuery("#wppa-filmstrip-"+p).css("margin-left")),i=parseInt(e),w=wppaThumbnailPitch[p],\_wppaSSRuns[p]?(o<i?2:i<o-2\*w?1:0)&&jQuery("#wppa-filmstrip-"+p).css({marginLeft:i+w}):(i<o-1.5\*w||o+1.5\*w<i)&&jQuery("#wppa-filmstrip-"+p).css({marginLeft:i}),wppaAnimate("#wppa-filmstrip-"+p,{marginLeft:e},t,a),wppaLastAnimFilmLoc[p]=e,wppaFilmInit[p]=!0),\_wppaLastIdx[p]=\_wppaCurIdx[p]),wppaMakeLazyVisible("adjust filmstrip"),!r&&-1!=\_wppaCurIdx[p]){\_wppaCurIdx[p];\_wppaCurIdx[p]+10>\_wppaSlides[p].length&&\_wppaSlides[p].length;for(var n=0;n<\_wppaSlides[p].length;)jQuery("#film\_wppatnf\_"+\_wppaId[p][n]+"\_"+p).html()&&(""!=jQuery("#wppa-film-"+n+"-"+p).attr("data-title")?(jQuery("#wppa-film-"+n+"-"+p).attr("title",jQuery("#wppa-film-"+n+"-"+p).attr("data-title")),jQuery("#wppa-pre-"+n+"-"+p).attr("title",jQuery("#wppa-film-"+n+"-"+p).attr("data-title"))):""!=wppaFilmThumbTitle&&\_wppaCurIdx[p]==n?(jQuery("#wppa-film-"+n+"-"+p).attr("title",wppaFilmThumbTitle),jQuery("#wppa-pre-"+n+"-"+p).attr("title",wppaFilmThumbTitle)):(jQuery("#wppa-film-"+n+"-"+p).attr("title",wppaClickToView+" "+\_wppaFilmThumbTitles[p][n]),jQuery("#wppa-pre-"+n+"-"+p).attr("title",wppaClickToView+" "+\_wppaFilmThumbTitles[p][n]))),n++}r||(jQuery("#film\_wppatnf\_"+\_wppaId[p][\_wppaCurIdx[p]]+"\_"+p).find("img").addClass("wppa-filmthumb-active"),jQuery("#film\_wppatnf\_"+\_wppaId[p][\_wppaCurIdx[p]]+"\_"+p).find("canvas").addClass("wppa-filmthumb-active"))}}function \_wppaNext(p){var a,e;!wppaSlideWrap[p]&&\_wppaCurIdx[p]==\_wppaSlides[p].length-1||(\_wppaNxtIdx[p]=\_wppaCurIdx[p]+1,\_wppaNxtIdx[p]==\_wppaSlides[p].length?(a=jQuery("#wppa-next-pagelink-"+p),e=jQuery("#wppa-first-pagelink-"+p),0<a.length&&"hidden"!=jQuery(a).css("visibility")?(wppaSlideInitRunning[p]=\_wppaSSRuns[p]?"start":"stopnext",jQuery("#wppa-next-pagelink-"+p).trigger("click")):0<e.length?(wppaSlideInitRunning[p]=\_wppaSSRuns[p]?"start":"stopnext",jQuery(e).trigger("click")):\_wppaNextSlide(p,\_wppaNxtIdx[p]=0)):\_wppaNextSlide(p,0))}function \_wppaNextN(p,a){if(wppaSlideWrap[p]||!(\_wppaCurIdx[p]>=\_wppaSlides[p].length-a)){for(\_wppaNxtIdx[p]=\_wppaCurIdx[p]+a;\_wppaNxtIdx[p]>=\_wppaSlides[p].length;)\_wppaNxtIdx[p]-=\_wppaSlides[p].length;\_wppaNextSlide(p,0)}}function \_wppaNextOnCallback(p){if(wppaSlideWrap[p]||\_wppaCurIdx[p]!=\_wppaSlides[p].length-1){if(\_wppaSkipRated[p]){var a=\_wppaCurIdx[p]+1;a==\_wppaSlides[p].length&&(a=0);var e=a;if(0!=\_wppaMyr[p][e]){for(++a==\_wppaSlides[p].length&&(a=0);a!=e&&0!=\_wppaMyr[p][a];)++a==\_wppaSlides[p].length&&(a=0);e=a}\_wppaNxtIdx[p]=e}else \_wppaNxtIdx[p]=\_wppaCurIdx[p]+1,\_wppaNxtIdx[p]==\_wppaSlides[p].length&&(\_wppaNxtIdx[p]=0);\_wppaNextSlide(p,0)}}function \_wppaPrev(p){!wppaSlideWrap[p]&&0==\_wppaCurIdx[p]||(\_wppaNxtIdx[p]=\_wppaCurIdx[p]-1,\_wppaNxtIdx[p]<0?jQuery("#wppa-prev-page-last-item-"+p).length?(wppaSlideInitRunning[p]=\_wppaSSRuns[p]?"start":"stopprev",jQuery("#wppa-prev-page-last-item-"+p).trigger("click")):(\_wppaNxtIdx[p]+=\_wppaSlides[p].length,\_wppaNextSlide(p,0)):\_wppaNextSlide(p,0))}function \_wppaPrevN(p,a){if(wppaSlideWrap[p]||!(\_wppaCurIdx[p]<a)){for(\_wppaNxtIdx[p]=\_wppaCurIdx[p]-a;\_wppaNxtIdx[p]<0;)\_wppaNxtIdx[p]+=\_wppaSlides[p].length;\_wppaNextSlide(p,0)}}function \_wppaGoto(p,a){\_wppaToTheSame=\_wppaNxtIdx[p]==a,\_wppaNxtIdx[p]=a,\_wppaNextSlide(p,0)}function \_wppaGotoRunning(p,a){\_wppaIsBusy[p]?setTimeout("\_wppaGotoRunning( "+p+","+a+" )",10):(\_wppaSSRuns[p]=!1,\_wppaToTheSame=\_wppaNxtIdx[p]==a,\_wppaNxtIdx[p]=a,\_\_wppaOverruleRun=!0,\_wppaNextSlide(p,"manual"),\_wppaGotoContinue(p))}function \_wppaGotoContinue(p){\_wppaIsBusy[p]?setTimeout("\_wppaGotoContinue( "+p+" )",10):setTimeout("\_wppaNextSlide( "+p+', "reset" )',wppaGetSlideshowTimeout(p,"\_wppaGotoContinue")+10)}function \_wppaStart(p,a){\_wppaSSRuns[p]||(("icons"==wppaSlideshowNavigationType?\_wppaStartIcons:\_wppaStartText)(p,a),\_wppaSSRuns[p]&&(wppaStartStopNew?jQuery("#wppa-startstop-icon-"+p).html(wppaSvgHtml("Pause-Button-New",wppaIconSize(p,wppaIsMini[p]?"24px":"48px",!0),!1,!0,"0","0","0","0")):jQuery("#wppa-startstop-icon-"+p).html(wppaSvgHtml("Pause-Button",wppaIconSize(p,wppaIsMini[p]?"24px":"48px",!0),!1,!0,"0","10","50","50"))),-1==a&&setTimeout(function(){\_wppaStart(p,a)},200))}var wppaVeryFirst=!0;function \_wppaStartIcons(p,a){if(0<jQuery("#filmwindow-"+p).length&&0==jQuery("#slide\_frame-"+p).length&&(wppaVeryFirst=!1),-2==a){var e=0;if(a=0,\_wppaSkipRated[p]=!0,0!=\_wppaMyr[p][e])for(;e<\_wppaSlides[p].length;)0==a&&0==\_wppaMyr[p][e]&&(a=e),e++}var t=wppaIconSize(p,"1.5em",!1);-1<a?(jQuery("#startstop-"+p).html(wppaSvgHtml("Play-Button",t,!1,!0,"0","10","20","50")),jQuery("#speed0-"+p).hide(),jQuery("#speed1-"+p).hide(),\_wppaNxtIdx[p]=a,\_wppaCurIdx[p]=a,\_wppaNextSlide(p,0),\_wppaShowMetaData(p,"show")):(wppaVeryFirst||(\_wppaSSRuns[p]=!0),\_wppaNextSlide(p,0),wppaVeryFirst&&(\_wppaSSRuns[p]=!0),jQuery("#startstop-"+p).html(wppaSvgHtml("Pause-Button",t,!1,!0,"0","10","20","50")),jQuery("#speed0-"+p).show(),jQuery("#speed1-"+p).show(),\_wppaShowMetaData(p,"hide"),(jQuery("#bc-pname-modal-"+p)?jQuery("#bc-pname-modal-"+p):jQuery("#bc-pname-"+p)).html(\_\_("Slideshow","wp-photo-album-plus"))),wppaVeryFirst=!1,\_wppaSetRatingDisplay(p)}function \_wppaStartText(p,a){if(0<jQuery("#filmwindow-"+p).length&&0==jQuery("#slide\_frame-"+p).length&&(wppaVeryFirst=!1),-2==a){var e=0;if(a=0,\_wppaSkipRated[p]=!0,0!=\_wppaMyr[p][e])for(;e<\_wppaSlides[p].length;)0==a&&0==\_wppaMyr[p][e]&&(a=e),e++}-1<a?(jQuery("#startstop-"+p).html(\_\_("Start","wp-photo-album-plus")+" "+\_\_("Slideshow","wp-photo-album-plus")),jQuery("#speed0-"+p).css("display","none"),jQuery("#speed1-"+p).css("display","none"),\_wppaNxtIdx[p]=a,\_wppaCurIdx[p]=a,\_wppaNextSlide(p,0),\_wppaShowMetaData(p,"show")):(wppaVeryFirst||(\_wppaSSRuns[p]=!0),\_wppaNextSlide(p,0),wppaVeryFirst&&(\_wppaSSRuns[p]=!0),jQuery("#startstop-"+p).html(\_\_("Stop","wp-photo-album-plus")),jQuery("#speed0-"+p).css("display","inline"),jQuery("#speed1-"+p).css("display","inline"),\_wppaShowMetaData(p,"hide"),(jQuery("#bc-pname-modal-"+p)?jQuery("#bc-pname-modal-"+p):jQuery("#bc-pname-"+p)).html(\_\_("Slideshow","wp-photo-album-plus"))),wppaVeryFirst=!1,\_wppaSetRatingDisplay(p)}function \_wppaStop(p){("icons"==wppaSlideshowNavigationType?\_wppaStopIcons:\_wppaStopText)(p),wppaStartStopNew?jQuery("#wppa-startstop-icon-"+p).html(wppaSvgHtml("Play-Button-New",wppaIconSize(p,wppaIsMini[p]?"30px":"60px",!0),!1,!0,"0","0","0","0")):jQuery("#wppa-startstop-icon-"+p).html(wppaSvgHtml("Play-Button",wppaIconSize(p,wppaIsMini[p]?"24px":"48px",!0),!1,!0,"0","10","50","50"))}function \_wppaStopIcons(p){\_wppaSSRuns[p]=!1,jQuery("#startstop-"+p).html(wppaSvgHtml("Play-Button",wppaIconSize(p,"1.5em",!1),!1,!0)),jQuery("#speed0-"+p).hide(),jQuery("#speed1-"+p).hide(),\_wppaShowMetaData(p,"show"),(jQuery("#bc-pname-modal-"+p)?jQuery("#bc-pname-modal-"+p):jQuery("#bc-pname-"+p)).html(\_wppaNames[p][\_wppaCurIdx[p]])}function \_wppaStopText(p){\_wppaSSRuns[p]=!1,jQuery("#startstop-"+p).html(\_\_("Start","wp-photo-album-plus")+" "+\_\_("Slideshow","wp-photo-album-plus")),jQuery("#speed0-"+p).css("display","none"),jQuery("#speed1-"+p).css("display","none"),\_wppaShowMetaData(p,"show"),(jQuery("#bc-pname-modal-"+p)?jQuery("#bc-pname-modal-"+p):jQuery("#bc-pname-"+p)).html(\_wppaNames[p][\_wppaCurIdx[p]])}function \_wppaSpeed(p,a){"random"!=\_wppaTimeOut[p]&&(a?500<\_wppaTimeOut[p]&&(\_wppaTimeOut[p]/=1.5):\_wppaTimeOut[p]<6e4&&(\_wppaTimeOut[p]\*=1.5),wppaSavedSlideshowTimeout[p]=\_wppaTimeOut[p])}function \_wppaUnloadSpinner(p){jQuery("#wppa-slide-spin-"+p).hide(),setTimeout(function(){jQuery("#wppa-slide-spin-"+p).stop().fadeOut()},1e3)}function \_wppaSetRatingDisplay(p){if(document.getElementById("wppa-rating-"+p)){var a,e,t=\_wppaAvg[p][\_wppaCurIdx[p]];if(void 0!==t){if("likes"==wppaRatingDisplayType){"void"==(e=\_wppaMyr[p][\_wppaCurIdx[p]])?(jQuery("#wppa-dislike-imgdiv-"+p).hide(),jQuery("#wppa-like-imgdiv-"+p).hide()):(jQuery("#wppa-dislike-imgdiv-"+p).show(),jQuery("#wppa-like-imgdiv-"+p).show());var w=t.split("|");return jQuery("#wppa-like-"+p).attr("title",w[0]),jQuery("#wppa-liketext-"+p).html(w[1]),void("1"==\_wppaMyr[p][\_wppaCurIdx[p]]?jQuery("#wppa-like-"+p).attr("src",wppaImageDirectory+"thumbdown.png"):jQuery("#wppa-like-"+p).attr("src",wppaImageDirectory+"thumbup.png"))}if(t=(a=t.split("|"))[0],w=a[1],a=\_wppaDisc[p][\_wppaCurIdx[p]],e=\_wppaMyr[p][\_wppaCurIdx[p]],"void"==a)jQuery("#wppa-rating-"+p).hide();else{if(jQuery("#wppa-rating-"+p).show(),"graphic"==wppaRatingDisplayType)\_wppaSetRd(p,t,"#wppa-avg-"),\_wppaSetRd(p,e,"#wppa-rate-"),0==e?(jQuery("#wppa-dislike-"+p).css("display","inline"),jQuery("#wppa-dislike-imgdiv-"+p).css("display","inline"),document.getElementById("wppa-dislike-"+p)&&jQuery("#wppa-filler-"+p).css("display","none"),jQuery("#wppa-dislike-"+p).stop().fadeTo(100,wppaStarOpacity)):(jQuery("#wppa-dislike-"+p).css("display","none"),jQuery("#wppa-dislike-imgdiv-"+p).css("display","none"),jQuery("#wppa-filler-"+p).css("display","inline"),jQuery("#wppa-filler-"+p).stop().fadeTo(100,wppaStarOpacity),jQuery("#wppa-filler-"+p).attr("title",a));else{if(jQuery("#wppa-numrate-avg-"+p).html(t+" ( "+w+" ) "),jQuery(".wppa-my-rat-"+p).show(),"void"==e)jQuery("#wppa-numrate-mine-"+p).html(""),jQuery(".wppa-my-rat-"+p).hide();else if(wppaRatingOnce&&0<e)jQuery("#wppa-numrate-mine-"+p).html(e);else if(e<0)jQuery("#wppa-numrate-mine-"+p).html(" dislike");else{var r="";for(i=1;i<=wppaRatingMax;i++)e==i?r+='<span class="wppa-rating-numeric-mine" style="cursor:pointer; font-weight:bold;" onclick="\_wppaRateIt( '+p+", "+i+' )">&nbsp;'+i+"&nbsp;</span>":(e>i-1&&e<i&&(r+="&nbsp;( "+e+" )&nbsp;"),r+='<span class="wppa-rating-numeric" style="cursor:pointer;" onclick="\_wppaRateIt( '+p+", "+i+' )" onmouseover="this.style.fontWeight=\'bold\'" onmouseout="this.style.fontWeight=\'normal\'" >&nbsp;'+i+"&nbsp;</span>");jQuery("#wppa-numrate-mine-"+p).html(r)}0==e?(jQuery("#wppa-dislike-"+p).css("display","inline"),jQuery("#wppa-dislike-imgdiv-"+p).css("display","inline"),jQuery("#wppa-filler-"+p).css("display","none"),jQuery("#wppa-dislike-"+p).stop().fadeTo(100,wppaStarOpacity)):(jQuery("#wppa-dislike-"+p).css("display","none"),jQuery("#wppa-dislike-imgdiv-"+p).css("display","none"),jQuery("#wppa-filler-"+p).css("display","inline")),jQuery("#wppa-discount-"+p).html(a+"&bull; "),jQuery("#wppa-filler-"+p).css("display","none")}0==e?jQuery("#wppa-vote-button-"+p).val(wppaVoteForMe):jQuery("#wppa-vote-button-"+p).val(wppaVotedForMe),jQuery("#wppa-vote-count-"+p).html(w)}}}}function wppaGetDislikeText(p,a,e){return p}function \_wppaSetRd(p,a,e){var t=parseInt(a),i=t+1,w=wppaStarOpacity+(a-t)\*(1-wppaStarOpacity),r=wppaRatingMax;if("void"==a)jQuery("#wppa-my-rat-"+p).hide(),jQuery(".wppa-my-rat-"+p).hide(),jQuery(".wppa-rate-"+p).hide(),jQuery(".wppa-ratingthumb").hide(),jQuery("#wppa-numrate-mine-"+p).hide();else for(jQuery("#wppa-my-rat-"+p).show(),jQuery(".wppa-my-rat-"+p).show(),jQuery(".wppa-rate-"+p).show(),jQuery(".wppa-ratingthumb").show(),jQuery("#wppa-numrate-mine-"+p).show(),idx=1;idx<=r;idx++)"#wppa-rate-"!=e&&".wppa-rate-"!=e||jQuery(e+p+"-"+idx).attr("src")!=wppaImageDirectory+"star.ico"&&jQuery(e+p+"-"+idx).attr("src",wppaImageDirectory+"star.ico"),idx<=t?jQuery(e+p+"-"+idx).stop().fadeTo(100,1):idx==i?jQuery(e+p+"-"+idx).stop().fadeTo(100,w):jQuery(e+p+"-"+idx).stop().fadeTo(100,wppaStarOpacity)}function \_wppaFollowMe(p,a){\_wppaSSRuns[p]||0!=\_wppaMyr[p][\_wppaCurIdx[p]]&&wppaRatingOnce||\_wppaMyr[p][\_wppaCurIdx[p]]<0||\_wppaVoteInProgress||\_wppaSetRd(p,a,"#wppa-rate-")}function wppaOvlFollowMe(p,a,e){e||\_wppaSetRd(p,a,".wppa-rate-")}function \_wppaLeaveMe(p,a){\_wppaSSRuns[p]||0!=\_wppaMyr[p][\_wppaCurIdx[p]]&&wppaRatingOnce||\_wppaMyr[p][\_wppaCurIdx[p]]<0||\_wppaVoteInProgress||\_wppaSetRd(p,\_wppaMyr[p][\_wppaCurIdx[p]],"#wppa-rate-")}function wppaOvlLeaveMe(p,a,e){\_wppaSetRd(p,e,".wppa-rate-")}function \_wppaValidateComment(p,a){if(a=a||\_wppaId[p][\_wppaCurIdx[p]],jQuery("#wppa-comname-"+p).val().length<1)return alert(\_\_("Please enter your name","wp-photo-album-plus")),!1;if("required"==wppaEmailRequired||"optional"==wppaEmailRequired){var e=jQuery("#wppa-comemail-"+p).val();if("optional"==wppaEmailRequired&&0==e.length)return!0;var t=e.indexOf("@"),a=e.lastIndexOf(".");if(t<1||a<t+2||a+2>=e.length)return alert(\_\_("Please enter a valid email address","wp-photo-album-plus")),!1}return!(jQuery("#wppa-comment-"+p).val().length<1)||(alert(\_\_("Please enter a comment","wp-photo-album-plus")),!1)}function \_wppaGo(p){document.location=p}function \_wppaBbb(p,a,e){if(!\_wppaSSRuns[p]){var t="#bbb-"+p+"-"+a;switch(e){case"show":"l"==a&&jQuery(t).attr("title",\_\_("Previous photo","wp-photo-album-plus")),"r"==a&&jQuery(t).attr("title",\_\_("Next photo","wp-photo-album-plus")),jQuery(".wppa-bbb-"+p).css("cursor","pointer");break;case"hide":jQuery(".wppa-bbb-"+p).removeAttr("title"),jQuery(".wppa-bbb-"+p).css("cursor","default");break;case"click":"l"==a&&wppaPrev(p),"r"==a&&wppaNext(p);break;default:alert("Unimplemented instruction: "+e+" on: "+t)}}}function \_wppaUbb(p,a,e){var t="#ubb-"+p+"-"+a;switch(e){case"show":"l"==a&&jQuery(t).attr("title",\_\_("Previous photo","wp-photo-album-plus")),"r"==a&&jQuery(t).attr("title",\_\_("Next photo","wp-photo-album-plus")),jQuery(".ubb-"+p).css("cursor","pointer"),jQuery(".ubb-"+p).stop().fadeTo(200,.8),jQuery("#wppa-startstop-icon-"+p).stop().fadeTo(200,.8);break;case"hide":jQuery(".ubb-"+p).removeAttr("title"),jQuery(".ubb-"+p).css("cursor","default"),wppaIsMobile?jQuery(".ubb-"+p).stop().fadeTo(200,.1):jQuery(".ubb-"+p).stop().fadeTo(200,0),jQuery("#wppa-startstop-icon-"+p).stop().fadeTo(200,0);break;case"click":wppaIsMobile&&(jQuery(".ubb-"+p).stop().fadeTo(200,1).fadeTo(1e3,0),jQuery("#wppa-startstop-icon-"+p).stop().fadeTo(200,1).fadeTo(1e3,0)),"l"==a&&wppaPrev(p),"r"==a&&wppaNext(p);break;default:alert("Unimplemented instruction: "+e+" on: "+t)}}function wppaOpenComments(p){\_wppaSSRuns[p]&&\_wppaStop(p),jQuery("#wppa-comtable-wrap-"+p).css("display","block"),jQuery("#wppa-comform-wrap-"+p).css("display","block"),jQuery("#wppa-comfooter-wrap-"+p).css("display","none"),wppaColWidth[p]=0,setTimeout("\_wppaDoAutocol( "+p+" )",100)}function \_wppaShowMetaData(p,a){\_wppaSlides[p]&&(\_wppaSSRuns[p]||\_\_wppaOverruleRun?"show"==a?wppaFotomotoHideWhenRunning||wppaFotomotoToolbar(p,\_wppaHiresUrl[p][\_wppaCurIdx[p]]):wppaShareHideWhenRunning&&jQuery("#wppa-share-"+p).css("display","none"):"show"==a?(wppaAutoOpenComments&&(jQuery("#wppa-comtable-wrap-"+p).css("display","block"),jQuery("#wppa-comform-wrap-"+p).css("display","block"),jQuery("#wppa-comfooter-wrap-"+p).css("display","none")),0!=\_wppaCurIdx[p]&&jQuery(".wppa-first-"+p).show(),\_wppaCurIdx[p]!=\_wppaSlides[p].length-1&&jQuery(".wppa-last-"+p).show(),wppaShareHideWhenRunning&&jQuery("#wppa-share-"+p).css("display",""),wppaFotomotoToolbar(p,\_wppaHiresUrl[p][\_wppaCurIdx[p]])):(jQuery("#wppa-comtable-wrap-"+p).css("display","none"),jQuery("#wppa-comform-wrap-"+p).css("display","none"),jQuery("#wppa-comfooter-wrap-"+p).css("display","block"),wppaFotomotoHide(p)),"show"==a?(jQuery("#imagedesc-"+p).css("visibility","visible"),jQuery("#imagetitle-"+p).css("visibility","visible"),jQuery("#counter-"+p).css("visibility","visible"),jQuery("#iptccontent-"+p).css("visibility","visible"),jQuery("#exifcontent-"+p).css("visibility","visible")):(jQuery("#counter-"+p).css("visibility","hidden"),jQuery(".wppa-first-"+p).hide(),jQuery(".wppa-last-"+p).hide(),jQuery("#iptccontent-"+p).css("visibility","hidden"),jQuery("#exifcontent-"+p).css("visibility","hidden")))}function wppaGetSlideshowTimeout(p,a){var e,t;return"random"==\_wppaTimeOut[p]?(e=2\*wppaAnimationSpeed,t=7\*wppaAnimationSpeed,Math.floor(Math.random()\*(t-e+1))+e):\_wppaTimeOut[p]}function wppaIsSlidshowVisible(p){if(!wppaLazyLoad)return!0;for(var a,e=["slide\_frame-"+p,"filmwindow-"+p],t=e.length,i=0;i<t;i++)if(a=document.getElementById(e[i]),a&&(a.getBoundingClientRect(),wppaIsElementInViewport(a)))return!0;return wppaFilmInit[p]=!1}function wppaFilmThumbToCanvas(p){var a,e,t=p+"-canvas",i=document.getElementById(p),w=document.getElementById(t);void 0!==w&&(a=w.getContext("2d"),e=i.naturalWidth|i.videoWidth,p=i.naturalHeight|i.videoHeight,(t=w.width)/(w=w.height)<e/p?(fromWidth=p\*t/w,fromX=(e-fromWidth)/2,a.drawImage(i,fromX,0,fromWidth,p,0,0,t,w)):(fromHeight=e\*w/t,fromY=(p-fromHeight)/2,a.drawImage(i,0,fromY,e,fromHeight,0,0,t,w)),i.pause&&i.pause())} |
  |  | 6 | var wppaJsSlideshowVersion="8.9.02.001",wppaHasControlbar=!1;function wppaStoreSlideInfo(p,a,e,t,i,w,r,o,n,l,s,d,u,\_,m,h,c,y,S,g,f,x,j,I,Q,b,v,T,N,C,R,k,F,L,M,H){n=wppaRepairScriptTags(n),\_wppaSlides[p]&&"0"!=a||(\_wppaSlides[p]=[],\_wppaNames[p]=[],\_wppaFilmThumbTitles[p]=[],\_wppaFullNames[p]=[],\_wppaDsc[p]=[],\_wppaOgDsc[p]=[],\_wppaCurIdx[p]=-1,\_wppaNxtIdx[p]=0,wppaSavedSlideshowTimeout[p]?\_wppaTimeOut[p]=wppaSavedSlideshowTimeout[p]:(\_wppaTimeOut[p]=S,wppaSavedSlideshowTimeout[p]=\_wppaTimeOut[p]),\_wppaSSRuns[p]=!1,\_wppaTP[p]=-2,\_wppaFg[p]=0,\_wppaIsBusy[p]=!1,\_wppaFirst[p]=!0,\_wppaId[p]=[],\_wppaRealId[p]=[],\_wppaAvg[p]=[],\_wppaDisc[p]=[],\_wppaMyr[p]=[],\_wppaVRU[p]=[],\_wppaLinkUrl[p]=[],\_wppaLinkTitle[p]=[],\_wppaLinkTarget[p]=[],\_wppaCommentHtml[p]=[],\_wppaIptcHtml[p]=[],\_wppaExifHtml[p]=[],\_wppaUrl[p]=[],\_wppaSkipRated[p]=!1,\_wppaLbTitle[p]=[],\_wppaDidGoto[p]=!1,wppaSlidePause[p]=!1,\_wppaShareUrl[p]=[],\_wppaShareHtml[p]=[],\_wppaFilmNoMove[p]=!1,\_wppaHiresUrl[p]=[],\_wppaIsVideo[p]=[],\_wppaIsAudio[p]=[],\_wppaVideoHtml[p]=[],\_wppaAudioHtml[p]=[],\_wppaVideoNatWidth[p]=[],\_wppaVideoNatHeight[p]=[],wppaVideoPlaying[p]=!1,wppaAudioPlaying[p]=!1,\_wppaWaitTexts[p]=[],\_wppaImageAlt[p]=[],\_wppaFilename[p]=[],\_wppaPanoramaHtml[p]=[],\_wppaPanControlHeight[p]=[],\_wppaRatio[p]=[]),S="default",""!=h?S="pointer":""!=wppaLightBox[p]&&(S="url( "+wppaImageDirectory+wppaMagnifierCursor+" ),pointer"),\_wppaIsVideo[p][a]=""!=T,\_wppaIsAudio[p][a]=""!=N,\_wppaIsVideo[p][a]?(\_wppaSlides[p][a]=' alt="'+R+'" class="theimg theimg-'+p+' big" ',wppaSlideVideoStart&&""==wppaLightBox[p]&&(\_wppaSlides[p][a]+=" autoplay "),0<k.length&&(\_wppaSlides[p][a]+=' poster="'+k+'" ')):(\_wppaIsAudio[p][a]&&(\_wppaSlides[p][a]=' alt="'+R+'" class="theimg theimg-'+p+' big" ',wppaSlideAudioStart&&""==wppaLightBox[p]&&(\_wppaSlides[p][a]+=" autoplay ")),\_wppaSlides[p][a]=' src="'+e+'" alt="'+R+'" class="theimg theimg-'+p+' big stereo" '),wppaSlideSwipe&&(\_wppaSlides[p][a]+=' ontouchstart="wppaTouchStart( event, this.id, '+p+' );" ontouchend="wppaTouchEnd( event );" ontouchmove="wppaTouchMove( event );" ontouchcancel="wppaTouchCancel( event );" '),wppaAutoColumnWidth[p]||(\_wppaSlides[p][a]+='width="'+i+'" height="'+w+'" '),\_wppaIsVideo[p][a]?(k="wppa"==wppaLightBox[p]?"":"controls",\_wppaSlides[p][a]+='style="'+t+"; cursor:"+S+'; display:none;" '+k+' preload="metadata">'+T+"</video>"):\_wppaSlides[p][a]+='style="'+t+"; cursor:"+S+'; display:none; vertical-align:middle;">',\_wppaFullNames[p][a]='<span class="sdf-'+p+'" >'+wppaRepairBrTags(r)+"</span>",\_wppaNames[p][a]='<span class="sdn-'+p+'" >'+o+"</span>",\_wppaFilmThumbTitles[p][a]=o,\_wppaDsc[p][a]=n,\_wppaOgDsc[p][a]=b,\_wppaId[p][a]=l,\_wppaRealId[p][a]=s,\_wppaAvg[p][a]=d,\_wppaDisc[p][a]=u,\_wppaMyr[p][a]=\_,\_wppaVRU[p][a]=m,\_wppaLinkUrl[p][a]=h,\_wppaLinkTitle[p][a]=c,""!=y?\_wppaLinkTarget[p][a]=y:wppaSlideBlank[p]?\_wppaLinkTarget[p][a]="\_blank":\_wppaLinkTarget[p][a]="\_self",\_wppaCommentHtml[p][a]=g,\_wppaIptcHtml[p][a]=f,\_wppaExifHtml[p][a]=x,\_wppaUrl[p][a]=e,\_wppaLbTitle[p][a]=wppaRepairScriptTags(j),\_wppaShareUrl[p][a]=I,\_wppaShareHtml[p][a]=wppaRepairScriptTags(Q),\_wppaHiresUrl[p][a]=v,\_wppaVideoHtml[p][a]=T,\_wppaAudioHtml[p][a]=N,\_wppaVideoNatWidth[p][a]=i,\_wppaVideoNatHeight[p][a]=w,\_wppaWaitTexts[p][a]=C,\_wppaImageAlt[p][a]=R,\_wppaFilename[p][a]=F,\_wppaPanoramaHtml[p][a]=L,\_wppaPanControlHeight[p][a]=M,\_wppaRatio[p][a]=H}function wppaSpeed(p,a){\_wppaSSRuns[p]&&\_wppaSpeed(p,a)}function wppaStopShow(p){\_wppaSSRuns[p]&&\_wppaStop(p)}function wppaStopMedia(p){wppaStopAudio(p),wppaStopVideo(p),wppaStopShow(p)}function wppaStartStop(p,a){wppaSlideInitRunning[p]&&("start"==wppaSlideInitRunning[p]?a=-1:"stopprev"==wppaSlideInitRunning[p]?(a=\_wppaSlides[p].length-1,\_wppaStop(p)):"stopnext"==wppaSlideInitRunning[p]&&(a=0,\_wppaStop(p)),wppaSlideInitRunning[p]=""),\_wppaIsBusy[p]&&(\_wppaTP[p]=a),\_wppaSSRuns[p]?\_wppaStop(p):\_wppaStart(p,a),wppaIsMobile&&(jQuery("#wppa-startstop-icon-"+p).stop().fadeTo(10,1).fadeTo(3e3,0),jQuery(".ubb-"+p).stop().fadeTo(10,1).fadeTo(3e3,0))}function wppaBbb(p,a,e){\_wppaSSRuns[p]||\_wppaBbb(p,a,e)}function wppaUbb(p,a,e){\_wppaUbb(p,a,e)}function wppaRateIt(p,a){\_wppaRateIt(p,a)}function wppaOvlRateIt(p,a,e,t){\_wppaOvlRateIt(p,a,e,t)}function wppaPrev(p){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaPrev(p)}function wppaPrevN(p,a){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaPrevN(p,a)}function wppaFirst(p){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaGoto(p,0)}function wppaNext(p){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaNext(p)}function wppaNextN(p,a){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaNextN(p,a)}function wppaLast(p){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaGoto(p,\_wppaSlides[p].length-1)}function wppaFollowMe(p,a){wppaStopMedia(p),\_wppaSSRuns[p]||\_wppaFollowMe(p,a)}function wppaLeaveMe(p,a){wppaStopMedia(p),\_wppaSSRuns[p]||\_wppaLeaveMe(p,a)}function wppaGoto(p,a){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||\_wppaGoto(p,a)}function wppaGotoFilmNoMove(p,a){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaSSRuns[p]||(\_wppaFilmNoMove[p]=!0,\_wppaGoto(p,a))}function wppaGotoKeepState(p,a){wppaStopMedia(p),\_wppaNxtIdx[p]!=a&&(\_wppaDidGoto[p]=!0,\_wppaGotoKeepState(p,a))}function \_wppaGotoKeepState(p,a){(\_wppaSSRuns[p]?\_wppaGotoRunning:\_wppaGoto)(p,a)}function wppaGotoRunning(p,a){wppaStopMedia(p),\_wppaDidGoto[p]=!0,\_wppaGotoRunning(p,a)}function wppaValidateComment(p){return \_wppaValidateComment(p)}function \_wppaNextSlide(p,a){var e=!document.getElementById("slide\_frame-"+p);if(wppaLazyLoad&&!e&&!wppaIsSlidshowVisible(p))return wppaFilmInit[p]=!1,void setTimeout(function(){\_wppaNextSlide(p,a)},400);if(\_wppaLastIdx[p]=\_wppaCurIdx[p],!document.getElementById("slide\_frame-"+p)&&document.getElementById("filmwindow-"+p)&&wppaFilmonlyContinuous)return \_wppaSSRuns[p]?(\_wppaCurIdx[p]++,\_wppaCurIdx[p]==\_wppaSlides[p].length&&(\_wppaCurIdx[p]=0),\_wppaAdjustFilmstrip(p,"linear"),\_wppaNxtIdx[p]=\_wppaCurIdx[p],void setTimeout("\_wppaNextSlide( "+p+", '"+a+"' )",wppaAnimationSpeed)):(\_wppaCurIdx[p]=\_wppaNxtIdx[p],wppaFilmInit[p]=!1,void \_wppaAdjustFilmstrip(p,"linear"));if(document.getElementById("slide\_frame-"+p)||document.getElementById("filmwindow-"+p)){var t=\_wppaFg[p],e=1-t;if((wppaVideoPlaying[p]||wppaAudioPlaying[p])&&\_wppaSSRuns[p])setTimeout("\_wppaNextSlide( "+p+", '"+a+"' )",500);else{if("auto"==a){if(wppaSlidePause[p])return jQuery("#theimg"+t+"-"+p).attr("title",wppaSlidePause[p]),jQuery("#slide\_frame-"+p).attr("title",wppaSlidePause[p]),void setTimeout("\_wppaNextSlide( "+p+', "auto" )',250)}else jQuery("#slide\_frame-"+p).removeAttr("title");if((\_wppaSSRuns[p]||"auto"!=a)&&\_wppaSlides[p]&&(!(\_wppaSlides[p].length<2)||\_wppaFirst[p])){if(\_wppaSSRuns[p]||"reset"!=a||(\_wppaSSRuns[p]=!0,\_\_wppaOverruleRun=!1),\_wppaVoteInProgress=!1,\_wppaIsBusy[p]=!0,\_wppaSSRuns[p]&&\_wppaShowMetaData(p,"hide"),\_wppaSSRuns[p]&&(\_wppaNxtIdx[p]=\_wppaCurIdx[p]+1,\_wppaNxtIdx[p]==\_wppaSlides[p].length&&(\_wppaNxtIdx[p]=0)),jQuery("#geodiv-"+p+"-"+\_wppaId[p][\_wppaCurIdx[p]]).css({display:"none"}),jQuery("#geodiv-"+p+"-"+\_wppaId[p][\_wppaNxtIdx[p]]).css({display:""}),"undefined"!=typeof \_wppaLat&&\_wppaLat[p]?(o=\_wppaRealId[p],\_wppaLat[p][o[\_wppaNxtIdx[p]]]?(jQuery("#map-canvas-"+p).css("display",""),wppaGeoInit(p,\_wppaLat[p][o[\_wppaNxtIdx[p]]],\_wppaLon[p][o[\_wppaNxtIdx[p]]])):jQuery("#map-canvas-"+p).css("display","none")):jQuery("#map-canvas-"+p).css("display","none"),jQuery("[id^=wppa-numbar-"+p+"-]").css({backgroundColor:wppaBGcolorNumbar,borderColor:wppaBcolorNumbar,fontFamily:wppaFontFamilyNumbar,fontSize:wppaFontSizeNumbar,color:wppaFontColorNumbar,fontWeight:wppaFontWeightNumbar}),jQuery("#wppa-numbar-"+p+"-"+\_wppaNxtIdx[p]).css({backgroundColor:wppaBGcolorNumbarActive,borderColor:wppaBcolorNumbarActive,fontFamily:wppaFontFamilyNumbarActive,fontSize:wppaFontSizeNumbarActive,color:wppaFontColorNumbarActive,fontWeight:wppaFontWeightNumbarActive}),\_wppaSlides[p].length>wppaNumbarMax){var i,w,r=\_wppaSlides[p].length-1,o=\_wppaNxtIdx[p],n=(wppaNumbarMax-1)/2;o<n?(i=0,w=wppaNumbarMax-1-1,jQuery("#wppa-nbar-"+p+"-lodots").css({display:"none"}),jQuery("#wppa-nbar-"+p+"-hidots").css({display:"block"})):r-n<o?(i=(w=r)-wppaNumbarMax+1+1,jQuery("#wppa-nbar-"+p+"-lodots").css({display:"block"}),jQuery("#wppa-nbar-"+p+"-hidots").css({display:"none"})):(w=o+n+.5-1,(i=o-n+1)<2?(jQuery("#wppa-nbar-"+p+"-lodots").css({display:"none"}),jQuery("#wppa-nbar-"+p+"-hidots").css({display:"block"})):r-1<w?(jQuery("#wppa-nbar-"+p+"-lodots").css({display:"block"}),jQuery("#wppa-nbar-"+p+"-hidots").css({display:"none"})):(jQuery("#wppa-nbar-"+p+"-lodots").css({display:"block"}),jQuery("#wppa-nbar-"+p+"-hidots").css({display:"block"})));for(var l=0;l<\_wppaSlides[p].length;)0!=l&&l!=r&&(l<i||w<l)?jQuery("#wppa-numbar-"+p+"-"+l).css({display:"none"}):jQuery("#wppa-numbar-"+p+"-"+l).css({display:"block"}),l++}\_wppaFirst[p]?(-1!=\_wppaCurIdx[p]&&wppaMakeTheSlideHtml(p,"0",\_wppaCurIdx[p]),wppaMakeTheSlideHtml(p,"1",\_wppaNxtIdx[p]),jQuery("#imagedesc-"+p).html(\_wppaDsc[p][\_wppaCurIdx[p]]),jQuery("#imagetitle-"+p).html(wppaMakeNameHtml(p)),"void"==\_wppaCommentHtml[p][\_wppaCurIdx[p]]?(jQuery("#wppa-comments-"+p).hide(),jQuery("#wppa-comments-"+p).html("")):(jQuery("#wppa-comments-"+p).show(),jQuery("#wppa-comments-"+p).html(\_wppaCommentHtml[p][\_wppaCurIdx[p]])),jQuery("#iptc-"+p).html(\_wppaIptcHtml[p][\_wppaCurIdx[p]]),jQuery("#exif-"+p).html(\_wppaExifHtml[p][\_wppaCurIdx[p]]),"icons"==wppaSlideshowNavigationType?(n=wppaIconSize(p,"1.5em",!1),jQuery("#prev-arrow-"+p).html(wppaSvgHtml("Prev-Button",n,!1,!0)),jQuery("#next-arrow-"+p).html(wppaSvgHtml("Next-Button",n,!1,!0))):wppaIsMini[p]||wppaGetContainerWidth(p)<wppaMiniTreshold?(jQuery("#prev-arrow-"+p).html("&laquo;&nbsp;"+\_\_("Previous","wp-photo-album-plus")),jQuery("#next-arrow-"+p).html(\_\_("Next","wp-photo-album-plus")+"&nbsp;&raquo;")):(jQuery("#prev-arrow-"+p).html("&laquo;&nbsp;"+\_\_("Previous photo","wp-photo-album-plus")),jQuery("#next-arrow-"+p).html(\_\_("Next photo","wp-photo-album-plus")+"&nbsp;&raquo;")),wppaIsMini[p]||wppaGetContainerWidth(p)<wppaMiniTreshold?(jQuery("#wppa-avg-rat-"+p).html(\_\_("Avg","wp-photo-album-plus")),jQuery("#wppa-my-rat-"+p).html(\_\_("Mine","wp-photo-album-plus"))):(jQuery("#wppa-avg-rat-"+p).html(\_\_("Average&nbsp;rating","wp-photo-album-plus")),jQuery("#wppa-my-rat-"+p).html(\_\_("My&nbsp;rating","wp-photo-album-plus")))):wppaMakeTheSlideHtml(p,e,\_wppaNxtIdx[p]),\_wppaFirst[p]=!1,setTimeout("\_wppaNextSlide\_2( "+p+" )",10)}}}}function \_wppaNextSlide\_2(p){var a=\_wppaFg[p],e=1-a,t=document.getElementById("theimg"+e+"-"+p);!t||1!=t.nodeType||"IMG"!=t.nodeName||t.complete?(wppaUpdateLightboxes(),jQuery("#wppa-slide-spin-"+p).hide(),-1!=\_wppaSSRuns[p]&&(\_wppaToTheSame||\_wppaShowMetaData(p,"hide")),\_wppaFg[p]=1-\_wppaFg[p],\_wppaFg[p],setTimeout("\_wppaNextSlide\_3( "+p+" )",10)):setTimeout("\_wppaNextSlide\_2( "+p+" )",200)}function \_wppaNextSlide\_3(p){var a=\_wppaFg[p],e=1-a,t=\_wppaCurIdx[p],i=\_wppaNxtIdx[p],w="#theslide"+e+"-"+p,r="#theslide"+a+"-"+p,o="#theimg"+e+"-"+p,n="#theimg"+a+"-"+p,l=parseInt(jQuery(w).css("width")),s=t==i+1?"right":t==i-1?"left":t==i?"none":"nil";switch(t==\_wppaSlides[p].length-1&&0==i&&wppaSlideWrap[p]&&(s="left"),0==t&&i==\_wppaSlides[p].length-1&&wppaSlideWrap[p]&&(s="right"),"nil"==s&&(s=t<i?"left":"right"),jQuery(w).css({marginLeft:0,width:l}),jQuery(r).css({marginLeft:0,width:l}),wppaFormatSlide(p),wppaAnimationType){case"fadeafter":wppaFadeOut(o,wppaAnimationSpeed),jQuery("#theslide"+e+"-"+p).find("canvas").fadeOut(wppaAnimationSpeed),jQuery("#theslide"+e+"-"+p).find("video").fadeOut(wppaAnimationSpeed),setTimeout(wppaFadeIn(n,wppaAnimationSpeed,\_wppaNextSlide\_4(p)),wppaAnimationSpeed);break;case"swipe":switch(s){case"left":wppaAnimate(w,{marginLeft:-l},wppaAnimationSpeed,wppaEasingSlide),jQuery(r).css({marginLeft:l}),wppaFadeIn(n,10),wppaAnimate(r,{marginLeft:0},wppaAnimationSpeed,wppaEasingSlide,\_wppaNextSlide\_4(p));break;case"right":wppaAnimate(w,{marginLeft:l},wppaAnimationSpeed,wppaEasingSlide),jQuery(r).css({marginLeft:-l}),wppaFadeIn(n,10),wppaAnimate(r,{marginLeft:0},wppaAnimationSpeed,wppaEasingSlide,\_wppaNextSlide\_4(p));break;case"none":wppaFadeIn(n,10),setTimeout("\_wppaNextSlide\_4( "+p+" )",10)}break;default:wppaFadeOut(o,wppaAnimationSpeed),jQuery("#theslide"+e+"-"+p).find("canvas").fadeOut(wppaAnimationSpeed),jQuery("#theslide"+e+"-"+p).find("video").fadeOut(wppaAnimationSpeed),wppaFadeIn(n,wppaAnimationSpeed,\_wppaNextSlide\_4(p))}}function \_wppaNextSlide\_4(p){var a=\_wppaFg[p],e="#theslide"+a+"-"+p;jQuery("#theslide"+(1-a)+"-"+p).css({zIndex:80}),jQuery(e).css({zIndex:81}),\_wppaCurIdx[p]=\_wppaNxtIdx[p],wppaFormatSlide(p),wppaIsMini[p]||wppaGetContainerWidth(p)<wppaMiniTreshold?jQuery("#counter-"+p).html(\_wppaCurIdx[p]+1+" / "+\_wppaSlides[p].length):jQuery("#counter-"+p).html(\_\_("Photo","wp-photo-album-plus")+" "+(\_wppaCurIdx[p]+1)+" "+\_\_("of","wp-photo-album-plus")+" "+\_wppaSlides[p].length),jQuery("#bc-pname-modal-"+p).html(\_wppaNames[p][\_wppaCurIdx[p]]),jQuery("#bc-pname-"+p).html(\_wppaNames[p][\_wppaCurIdx[p]]),\_wppaAdjustFilmstrip(p,wppaEasingSlide),\_wppaSetRatingDisplay(p),setTimeout("\_wppaNextSlide\_5( "+p+" )",\_wppaTextDelay)}function \_wppaNextSlide\_5(p){var a,e,t;if(\_wppaToTheSame||(a=\_wppaDsc[p][\_wppaCurIdx[p]],jQuery("#imagedesc-"+p).html(a),wppaHideWhenEmpty&&(""==(i=\_wppaDsc[p][\_wppaCurIdx[p]])||"&nbsp;"==i?jQuery("#descbox-"+p).css("display","none"):jQuery("#descbox-"+p).css("display","")),jQuery("#imagetitle-"+p).html(wppaMakeNameHtml(p)),"void"==\_wppaCommentHtml[p][\_wppaCurIdx[p]]?(jQuery("#wppa-comments-"+p).hide(),jQuery("#wppa-comments-"+p).html("")):(jQuery("#wppa-comments-"+p).show(),jQuery("#wppa-comments-"+p).html(\_wppaCommentHtml[p][\_wppaCurIdx[p]])),jQuery("#iptc-"+p).html(\_wppaIptcHtml[p][\_wppaCurIdx[p]]),jQuery("#exif-"+p).html(\_wppaExifHtml[p][\_wppaCurIdx[p]]),jQuery("#wppa-share-"+p).html(\_wppaShareHtml[p][\_wppaCurIdx[p]])),\_wppaToTheSame=!1,wppaThumbPageSize?wppaThumbPage[p]=parseInt(((0|wppaSlideOffset[p])+\_wppaCurIdx[p])/wppaThumbPageSize)+1:wppaThumbPage[p]=1,\_wppaSSRuns[p]&&!wppaSlideWrap[p]&&\_wppaCurIdx[p]+1==\_wppaSlides[p].length)return \_wppaIsBusy[p]=!1,void \_wppaStop(p);if(\_wppaShowMetaData(p,"show"),-2!=\_wppaTP[p]){var i=\_wppaTP[p];return \_wppaTP[p]=-2,\_wppaDidGoto[p]=!1,\_wppaIsBusy[p]=!1,wppaIsMini[p]||\_bumpViewCount(\_wppaId[p][\_wppaCurIdx[p]]),\_wppaDoAutocol(p,"next\_5"),void wppaStartStop(p,i)}wppaUpdateLightboxes(),wppaIsMini[p]||(e=\_wppaShareUrl[p][\_wppaCurIdx[p]],"undefined"!=typeof wppaQRUpdate&&wppaQRUpdate(\_wppaShareUrl[p][\_wppaCurIdx[p]]),1<\_wppaSlides[p].length&&wppaPushStateSlide(p,\_wppaCurIdx[p],e)),\_wppaSSRuns[p]&&(\_wppaCurIdx[p]+1==\_wppaSlides[p].length?(e=jQuery("#wppa-next-pagelink-"+p),t=jQuery("#wppa-first-pagelink-"+p),0<e.length&&"hidden"!=jQuery(e).css("visibility")?setTimeout(function(){wppaSlideInitRunning[p]="start",jQuery("#wppa-next-pagelink-"+p).trigger("click")},wppaGetSlideshowTimeout(p,"next page trigger")):0<t.length?setTimeout(function(){jQuery(t).trigger("click")},wppaGetSlideshowTimeout(p,"first page trigger")):setTimeout("\_wppaNextSlide( "+p+', "auto" )',wppaGetSlideshowTimeout(p,"just wait for next in current(1)"))):setTimeout("\_wppaNextSlide( "+p+', "auto" )',wppaGetSlideshowTimeout(p,"just wait for next in current(2)"))),jQuery(document).trigger("glossaryTooltipReady"),\_wppaDidGoto[p]=!1,\_wppaIsBusy[p]=!1,wppaIsMini[p]||\_bumpViewCount(\_wppaId[p][\_wppaCurIdx[p]]),wppaProtect(),"none"==jQuery("#wppa-overlay-bg").css("display")&&jQuery(window).trigger("resize"),wppaHasControlbar||jQuery("#wppa-pctl-div-"+p).hide()}function wppaFormatSlide(p){var a="theimg"+\_wppaFg[p]+"-"+p,e=document.getElementById(a);if(e){var t="theslide"+\_wppaFg[p]+"-"+p,i="slide\_frame-"+p,w=wppaGetContainerWidth(p);wppaColWidth[p]=w;var r=jQuery(".wppa-audio-"+p),o=e.naturalWidth;void 0===o&&(o=parseInt(e.style.maxWidth));var n=e.naturalHeight;void 0===n&&(n=parseInt(e.style.maxHeight));var l=wppaAspectRatio[p],s=wppaFullSize[p],d=wppaFullFrameDelta[p],u=wppaPortraitOnly[p],\_=wppaFullValign[p];void 0===\_&&(\_="none");var m=wppaFullHalign[p];void 0===m&&(m="none");var h,c,y,S,g,f,e=wppaStretch;if(u)h=w-d,y=0,j=S=w,f=g=(c=parseInt(h\*n/o))+d,jQuery("#"+i).css({width:j,height:f}),jQuery("#"+t).css({width:S,height:g}),jQuery("#"+a).css({width:h,height:c});else{if(s<(j=w)&&(j=s),S=j,g=f=parseInt(j\*l),e||j-d<=o||f-d<=n?l<(n+d)/(o+d)?(c=f-d,h=parseInt(c\*o/n)):(h=j-d,c=parseInt(h\*n/o)):(h=o,c=n),"default"!=\_&&"none"!=\_){switch(\_){case"top":y=0;break;case"center":y=parseInt((f-(c+d))/2);break;case"bottom":y=f-(c+d);break;case"fit":y=0,g=f=c+d}jQuery("#"+a).css({marginTop:y,marginBottom:0})}if(jQuery("#"+i).css({width:j,height:f}),jQuery("#"+t).css({width:S,height:g}),jQuery("#"+a).css({width:h,height:c}),"default"!=\_&&"none"!=\_&&"none"!=m&&"default"!=m)switch(m){case"left":jQuery("#"+a).css({marginLeft:0,marginRight:"auto"});break;case"center":jQuery("#"+a).css({marginLeft:"auto",marginRight:"auto"});break;case"right":jQuery("#"+a).css({marginLeft:"auto",marginRight:0});break;default:jQuery("#"+a).css({marginLeft:"auto",marginRight:"auto"})}var m=jQuery(r).height(),x=(j-h)/2;m&&0<m&&(wppaAudioHeight=m,jQuery(r).css({height:wppaAudioHeight,width:h,left:x}))}x=\_wppaHiresUrl[p][\_wppaCurIdx[p]]||"";".pdf"==x.substr(x.length-4,x.length)&&jQuery("#"+t).css({width:"100%",height:"100%"});var j=parseInt(j/3);jQuery("#bbb-"+p+"-l").css({width:j}),jQuery("#bbb-"+p+"-r").css({width:j})}}function wppaMakeNameHtml(p){return \_wppaCurIdx[p]<0?"":"void"==\_wppaFullNames[p][\_wppaCurIdx[p]]?(jQuery("#namebox-"+p).hide(),""):(jQuery("#namebox-"+p).show(),wppaRepairBrTags(\_wppaFullNames[p][\_wppaCurIdx[p]]))}function wppaMakeTheSlideHtml(p,a,e){var t,i,w=\_wppaIsVideo[p][e]?"video":"img",r="title";"wppa"==wppaLightBox[p]&&(r="data-lbtitle");var o,n,l=""==wppaLightBox[p]?' onpause="wppaVideoPlaying['+p+'] = false;" onplay="wppaVideoPlaying['+p+'] = true;"':"",s=0<\_wppaPanoramaHtml[p][e].length;if(wppaHasControlbar=s,jQuery("body").trigger("quitimage",[p]),s){t=\_wppaPanoramaHtml[p][e].replace(/title=""/g,""),jQuery("#theslide"+(1-a)+"-"+p).html(""),jQuery("#theslide"+a+"-"+p).html(t);s=wppaGetContainerWidth(p)\*wppaAspectRatio[p];jQuery("#slide\_frame-"+p).css({height:s})}else{if(n=".pdf"==(o=\_wppaHiresUrl[p][e]||"").substr(o.length-4,o.length),""!=\_wppaLinkUrl[p][e])t=wppaSlideToFullpopup?'<a onclick="wppaStopAudio();wppaStopShow('+p+");"+\_wppaLinkUrl[p][e]+'" target="'+\_wppaLinkTarget[p][e]+'" title="'+\_wppaLinkTitle[p][e]+'">'+(n?"<iframe "+l+' src="'+o+'" title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" style="width:100%;height:100%;" ></iframe>':"<"+w+l+' title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" '+\_wppaSlides[p][e])+"</a>":"<a onclick=\"\_bumpClickCount('"+\_wppaId[p][e]+"');wppaStopAudio();wppaStopShow("+p+");window.open('"+\_wppaLinkUrl[p][e]+"', '"+\_wppaLinkTarget[p][e]+'\');" title="'+\_wppaLinkTitle[p][e]+'">'+(n?"<iframe "+l+' src="'+o+'" title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" style="width:100%;height:100%;" ></iframe>':"<"+w+l+' title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" '+\_wppaSlides[p][e])+"</a>";else if(""==wppaLightBox[p])t=n?"<iframe "+l+' src="'+o+'" title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" style="width:100%;height:100%;" ></iframe>':"<"+w+l+' title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" '+\_wppaSlides[p][e];else{for(var d="",u=0,\_=wppaLightboxSingle[p]?"":"[slide-"+p+"-"+a+"]";u<e;)i=wppaOvlHires||"wppa"!=wppaLightBox[p]?\_wppaHiresUrl[p][u]:wppaMakeFullsizeUrl(\_wppaUrl[p][u]),n=".pdf"==(o=\_wppaHiresUrl[p][u]||"").substr(o.length-4,o.length),d+='<a href="'+i+'"'+(\_wppaIsVideo[p][u]?' data-videonatwidth="'+\_wppaVideoNatWidth[p][u]+'" data-videonatheight="'+\_wppaVideoNatHeight[p][u]+'" data-videohtml="'+encodeURI(\_wppaVideoHtml[p][u])+'"':"")+(n?" data-pdfhtml=\"src='"+o+"'\"":"")+(""!=\_wppaAudioHtml[p][u]?' data-audiohtml="'+encodeURI(\_wppaAudioHtml[p][u])+'"':"")+" "+r+'="'+\_wppaLbTitle[p][u]+'" '+wppaRel+'="'+wppaLightBox[p]+\_+'"></a>',u++;for(i=wppaOvlHires||"wppa"!=wppaLightBox[p]?\_wppaHiresUrl[p][e]:wppaMakeFullsizeUrl(\_wppaUrl[p][e]),n=".pdf"==(o=\_wppaHiresUrl[p][e]).substr(o.length-4,o.length),d+='<a href="'+i+'"'+(' onclick="wppaStopAudio();wppaStopShow('+p+');"')+' style="cursor:pointer;" target="'+\_wppaLinkTarget[p][e]+'"'+(\_wppaIsVideo[p][u]?' data-videonatwidth="'+\_wppaVideoNatWidth[p][e]+'" data-videonatheight="'+\_wppaVideoNatHeight[p][e]+'" data-videohtml="'+encodeURI(\_wppaVideoHtml[p][e])+'"':"")+(n?" data-pdfhtml=\"src='"+o+"'\"":"")+(""!=\_wppaAudioHtml[p][u]?' data-audiohtml="'+encodeURI(\_wppaAudioHtml[p][e])+'"':"")+" "+r+'="'+\_wppaLbTitle[p][e]+'" '+wppaRel+'="'+wppaLightBox[p]+\_+'">'+(n?"<iframe "+l+' src="'+o+'" title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" style="width:100%;height:100%;" ></iframe>':"<"+w+l+' title="'+\_wppaLinkTitle[p][e]+'" id="theimg'+a+"-"+p+'" '+\_wppaSlides[p][e])+"</a>",u=e+1;u<\_wppaUrl[p].length;)i=wppaOvlHires||"wppa"!=wppaLightBox[p]?\_wppaHiresUrl[p][u]:wppaMakeFullsizeUrl(\_wppaUrl[p][u]),n=".pdf"==(o=\_wppaHiresUrl[p][u]).substr(o.length-4,o.length),d+='<a href="'+i+'"'+(\_wppaIsVideo[p][u]?' data-videonatwidth="'+\_wppaVideoNatWidth[p][u]+'" data-videonatheight="'+\_wppaVideoNatHeight[p][u]+'" data-videohtml="'+encodeURI(\_wppaVideoHtml[p][u])+'"':"")+(n?" data-pdfhtml=\"src='"+o+"'\"":"")+(""!=\_wppaAudioHtml[p][u]?' data-audiohtml="'+encodeURI(\_wppaAudioHtml[p][u])+'"':"")+" "+r+'="'+\_wppaLbTitle[p][u]+'" '+wppaRel+'="'+wppaLightBox[p]+\_+'"></a>',u++;t=d}""!=\_wppaAudioHtml[p][e]&&(t+='<audio controls id="wppa-audio-'+\_wppaId[p][e]+"-"+p+'" class="wppa-audio-'+p+" wppa-audio-"+\_wppaId[p][e]+"-"+p+'" data-from="wppa"'+(wppaSlideAudioStart&&""==wppaLightBox[p]?" autoplay":"")+' onplay="wppaAudioPlaying['+p+'] = true;" onpause="wppaAudioPlaying['+p+'] = false" style="position:relative;top:-'+(wppaAudioHeight+wppaSlideBorderWidth)+"px;z-index:10;width:"+\_wppaVideoNatWidth[p][e]+'px;padding:0;box-sizing:border-box;" >'+\_wppaAudioHtml[p][e]+"</audio>"),t=t.replace(/title=""/g,""),jQuery("#theslide"+a+"-"+p).html(t)}}function wppaAdjustAllFilmstrips(p){jQuery(".wppa-filmstrip").each(function(){\_wppaAdjustFilmstrip(jQuery(this).attr("id").substr(15),p)})}var wppaLastAnimFilmLoc=[];function \_wppaAdjustFilmstrip(p,a){if("linear"!=a&&(a=wppaEasingSlide),document.getElementById("wppa-filmstrip-"+p)&&\_wppaSlides[p]){var e,t,i,w,r=!document.getElementById("slide\_frame-"+p);if(wppaLastAnimFilmLoc[p]||(wppaLastAnimFilmLoc[p]=0),r){var o=jQuery("#wppa-filmstrip-"+p);if(!wppaIsElementInViewport(o))return}if(r||(jQuery(".wppa-film-"+p).find("img").removeClass("wppa-filmthumb-active"),jQuery(".wppa-film-"+p).find("canvas").removeClass("wppa-filmthumb-active")),\_wppaFilmNoMove[p]&&wppaFilmInit[p]?\_wppaFilmNoMove[p]=!1:(wppaFilmWindowLen=wppaGetContainerWidth(p)-wppaFilmStripAreaDelta[p],jQuery("#filmwindow-"+p).width(wppaFilmWindowLen),e=wppaFilmWindowLen/2-(\_wppaCurIdx[p]+.5+wppaPreambule[p])\*wppaThumbnailPitch[p]-wppaFilmStripMargin[p],wppaFilmShowGlue&&(e-=2\*wppaFilmStripMargin[p]+2),i=e+wppaThumbnailPitch[p],w=e-wppaThumbnailPitch[p],t=wppaAnimationSpeed,wppaFilmInit[p]||(t=1),0==\_wppaCurIdx[p]&&\_wppaLastIdx[p]==\_wppaSlides[p].length-1?(jQuery("#wppa-filmstrip-"+p).css({marginLeft:i+"px"}),wppaLastAnimFilmLoc[p]!=e&&(wppaAnimate("#wppa-filmstrip-"+p,{marginLeft:e},t,a),wppaLastAnimFilmLoc[p]=e)):0==\_wppaLastIdx[p]&&\_wppaCurIdx[p]==\_wppaSlides[p].length-1?(jQuery("#wppa-filmstrip-"+p).css({marginLeft:w}),wppaLastAnimFilmLoc[p]!=e&&(wppaAnimate("#wppa-filmstrip-"+p,{marginLeft:e},t,a),wppaLastAnimFilmLoc[p]=e)):(o=parseInt(jQuery("#wppa-filmstrip-"+p).css("margin-left")),i=parseInt(e),w=wppaThumbnailPitch[p],\_wppaSSRuns[p]?(o<i?2:i<o-2\*w?1:0)&&jQuery("#wppa-filmstrip-"+p).css({marginLeft:i+w}):(i<o-1.5\*w||o+1.5\*w<i)&&jQuery("#wppa-filmstrip-"+p).css({marginLeft:i}),wppaAnimate("#wppa-filmstrip-"+p,{marginLeft:e},t,a),wppaLastAnimFilmLoc[p]=e,wppaFilmInit[p]=!0),\_wppaLastIdx[p]=\_wppaCurIdx[p]),wppaMakeLazyVisible("adjust filmstrip"),!r&&-1!=\_wppaCurIdx[p]){\_wppaCurIdx[p];\_wppaCurIdx[p]+10>\_wppaSlides[p].length&&\_wppaSlides[p].length;for(var n=0;n<\_wppaSlides[p].length;)jQuery("#film\_wppatnf\_"+\_wppaId[p][n]+"\_"+p).html()&&(""!=jQuery("#wppa-film-"+n+"-"+p).attr("data-title")?(jQuery("#wppa-film-"+n+"-"+p).attr("title",jQuery("#wppa-film-"+n+"-"+p).attr("data-title")),jQuery("#wppa-pre-"+n+"-"+p).attr("title",jQuery("#wppa-film-"+n+"-"+p).attr("data-title"))):""!=wppaFilmThumbTitle&&\_wppaCurIdx[p]==n?(jQuery("#wppa-film-"+n+"-"+p).attr("title",wppaFilmThumbTitle),jQuery("#wppa-pre-"+n+"-"+p).attr("title",wppaFilmThumbTitle)):(jQuery("#wppa-film-"+n+"-"+p).attr("title",wppaClickToView+" "+\_wppaFilmThumbTitles[p][n]),jQuery("#wppa-pre-"+n+"-"+p).attr("title",wppaClickToView+" "+\_wppaFilmThumbTitles[p][n]))),n++}r||(jQuery("#film\_wppatnf\_"+\_wppaId[p][\_wppaCurIdx[p]]+"\_"+p).find("img").addClass("wppa-filmthumb-active"),jQuery("#film\_wppatnf\_"+\_wppaId[p][\_wppaCurIdx[p]]+"\_"+p).find("canvas").addClass("wppa-filmthumb-active"))}}function \_wppaNext(p){var a,e;!wppaSlideWrap[p]&&\_wppaCurIdx[p]==\_wppaSlides[p].length-1||(\_wppaNxtIdx[p]=\_wppaCurIdx[p]+1,\_wppaNxtIdx[p]==\_wppaSlides[p].length?(a=jQuery("#wppa-next-pagelink-"+p),e=jQuery("#wppa-first-pagelink-"+p),0<a.length&&"hidden"!=jQuery(a).css("visibility")?(wppaSlideInitRunning[p]=\_wppaSSRuns[p]?"start":"stopnext",jQuery("#wppa-next-pagelink-"+p).trigger("click")):0<e.length?(wppaSlideInitRunning[p]=\_wppaSSRuns[p]?"start":"stopnext",jQuery(e).trigger("click")):\_wppaNextSlide(p,\_wppaNxtIdx[p]=0)):\_wppaNextSlide(p,0))}function \_wppaNextN(p,a){if(wppaSlideWrap[p]||!(\_wppaCurIdx[p]>=\_wppaSlides[p].length-a)){for(\_wppaNxtIdx[p]=\_wppaCurIdx[p]+a;\_wppaNxtIdx[p]>=\_wppaSlides[p].length;)\_wppaNxtIdx[p]-=\_wppaSlides[p].length;\_wppaNextSlide(p,0)}}function \_wppaNextOnCallback(p){if(wppaSlideWrap[p]||\_wppaCurIdx[p]!=\_wppaSlides[p].length-1){if(\_wppaSkipRated[p]){var a=\_wppaCurIdx[p]+1;a==\_wppaSlides[p].length&&(a=0);var e=a;if(0!=\_wppaMyr[p][e]){for(++a==\_wppaSlides[p].length&&(a=0);a!=e&&0!=\_wppaMyr[p][a];)++a==\_wppaSlides[p].length&&(a=0);e=a}\_wppaNxtIdx[p]=e}else \_wppaNxtIdx[p]=\_wppaCurIdx[p]+1,\_wppaNxtIdx[p]==\_wppaSlides[p].length&&(\_wppaNxtIdx[p]=0);\_wppaNextSlide(p,0)}}function \_wppaPrev(p){!wppaSlideWrap[p]&&0==\_wppaCurIdx[p]||(\_wppaNxtIdx[p]=\_wppaCurIdx[p]-1,\_wppaNxtIdx[p]<0?jQuery("#wppa-prev-page-last-item-"+p).length?(wppaSlideInitRunning[p]=\_wppaSSRuns[p]?"start":"stopprev",jQuery("#wppa-prev-page-last-item-"+p).trigger("click")):(\_wppaNxtIdx[p]+=\_wppaSlides[p].length,\_wppaNextSlide(p,0)):\_wppaNextSlide(p,0))}function \_wppaPrevN(p,a){if(wppaSlideWrap[p]||!(\_wppaCurIdx[p]<a)){for(\_wppaNxtIdx[p]=\_wppaCurIdx[p]-a;\_wppaNxtIdx[p]<0;)\_wppaNxtIdx[p]+=\_wppaSlides[p].length;\_wppaNextSlide(p,0)}}function \_wppaGoto(p,a){\_wppaToTheSame=\_wppaNxtIdx[p]==a,\_wppaNxtIdx[p]=a,\_wppaNextSlide(p,0)}function \_wppaGotoRunning(p,a){\_wppaIsBusy[p]?setTimeout("\_wppaGotoRunning( "+p+","+a+" )",10):(\_wppaSSRuns[p]=!1,\_wppaToTheSame=\_wppaNxtIdx[p]==a,\_wppaNxtIdx[p]=a,\_\_wppaOverruleRun=!0,\_wppaNextSlide(p,"manual"),\_wppaGotoContinue(p))}function \_wppaGotoContinue(p){\_wppaIsBusy[p]?setTimeout("\_wppaGotoContinue( "+p+" )",10):setTimeout("\_wppaNextSlide( "+p+', "reset" )',wppaGetSlideshowTimeout(p,"\_wppaGotoContinue")+10)}function \_wppaStart(p,a){\_wppaSSRuns[p]||(("icons"==wppaSlideshowNavigationType?\_wppaStartIcons:\_wppaStartText)(p,a),\_wppaSSRuns[p]&&(wppaStartStopNew?jQuery("#wppa-startstop-icon-"+p).html(wppaSvgHtml("Pause-Button-New",wppaIconSize(p,wppaIsMini[p]?"24px":"48px",!0),!1,!0,"0","0","0","0")):jQuery("#wppa-startstop-icon-"+p).html(wppaSvgHtml("Pause-Button",wppaIconSize(p,wppaIsMini[p]?"24px":"48px",!0),!1,!0,"0","10","50","50"))),-1==a&&setTimeout(function(){\_wppaStart(p,a)},200))}var wppaVeryFirst=!0;function \_wppaStartIcons(p,a){if(0<jQuery("#filmwindow-"+p).length&&0==jQuery("#slide\_frame-"+p).length&&(wppaVeryFirst=!1),-2==a){var e=0;if(a=0,\_wppaSkipRated[p]=!0,0!=\_wppaMyr[p][e])for(;e<\_wppaSlides[p].length;)0==a&&0==\_wppaMyr[p][e]&&(a=e),e++}var t=wppaIconSize(p,"1.5em",!1);-1<a?(jQuery("#startstop-"+p).html(wppaSvgHtml("Play-Button",t,!1,!0,"0","10","20","50")),jQuery("#speed0-"+p).hide(),jQuery("#speed1-"+p).hide(),\_wppaNxtIdx[p]=a,\_wppaCurIdx[p]=a,\_wppaNextSlide(p,0),\_wppaShowMetaData(p,"show")):(wppaVeryFirst||(\_wppaSSRuns[p]=!0),\_wppaNextSlide(p,0),wppaVeryFirst&&(\_wppaSSRuns[p]=!0),jQuery("#startstop-"+p).html(wppaSvgHtml("Pause-Button",t,!1,!0,"0","10","20","50")),jQuery("#speed0-"+p).show(),jQuery("#speed1-"+p).show(),\_wppaShowMetaData(p,"hide"),(jQuery("#bc-pname-modal-"+p)?jQuery("#bc-pname-modal-"+p):jQuery("#bc-pname-"+p)).html(\_\_("Slideshow","wp-photo-album-plus"))),wppaVeryFirst=!1,\_wppaSetRatingDisplay(p)}function \_wppaStartText(p,a){if(0<jQuery("#filmwindow-"+p).length&&0==jQuery("#slide\_frame-"+p).length&&(wppaVeryFirst=!1),-2==a){var e=0;if(a=0,\_wppaSkipRated[p]=!0,0!=\_wppaMyr[p][e])for(;e<\_wppaSlides[p].length;)0==a&&0==\_wppaMyr[p][e]&&(a=e),e++}-1<a?(jQuery("#startstop-"+p).html(\_\_("Start","wp-photo-album-plus")+" "+\_\_("Slideshow","wp-photo-album-plus")),jQuery("#speed0-"+p).css("display","none"),jQuery("#speed1-"+p).css("display","none"),\_wppaNxtIdx[p]=a,\_wppaCurIdx[p]=a,\_wppaNextSlide(p,0),\_wppaShowMetaData(p,"show")):(wppaVeryFirst||(\_wppaSSRuns[p]=!0),\_wppaNextSlide(p,0),wppaVeryFirst&&(\_wppaSSRuns[p]=!0),jQuery("#startstop-"+p).html(\_\_("Stop","wp-photo-album-plus")),jQuery("#speed0-"+p).css("display","inline"),jQuery("#speed1-"+p).css("display","inline"),\_wppaShowMetaData(p,"hide"),(jQuery("#bc-pname-modal-"+p)?jQuery("#bc-pname-modal-"+p):jQuery("#bc-pname-"+p)).html(\_\_("Slideshow","wp-photo-album-plus"))),wppaVeryFirst=!1,\_wppaSetRatingDisplay(p)}function \_wppaStop(p){("icons"==wppaSlideshowNavigationType?\_wppaStopIcons:\_wppaStopText)(p),wppaStartStopNew?jQuery("#wppa-startstop-icon-"+p).html(wppaSvgHtml("Play-Button-New",wppaIconSize(p,wppaIsMini[p]?"30px":"60px",!0),!1,!0,"0","0","0","0")):jQuery("#wppa-startstop-icon-"+p).html(wppaSvgHtml("Play-Button",wppaIconSize(p,wppaIsMini[p]?"24px":"48px",!0),!1,!0,"0","10","50","50"))}function \_wppaStopIcons(p){\_wppaSSRuns[p]=!1,jQuery("#startstop-"+p).html(wppaSvgHtml("Play-Button",wppaIconSize(p,"1.5em",!1),!1,!0)),jQuery("#speed0-"+p).hide(),jQuery("#speed1-"+p).hide(),\_wppaShowMetaData(p,"show"),(jQuery("#bc-pname-modal-"+p)?jQuery("#bc-pname-modal-"+p):jQuery("#bc-pname-"+p)).html(\_wppaNames[p][\_wppaCurIdx[p]])}function \_wppaStopText(p){\_wppaSSRuns[p]=!1,jQuery("#startstop-"+p).html(\_\_("Start","wp-photo-album-plus")+" "+\_\_("Slideshow","wp-photo-album-plus")),jQuery("#speed0-"+p).css("display","none"),jQuery("#speed1-"+p).css("display","none"),\_wppaShowMetaData(p,"show"),(jQuery("#bc-pname-modal-"+p)?jQuery("#bc-pname-modal-"+p):jQuery("#bc-pname-"+p)).html(\_wppaNames[p][\_wppaCurIdx[p]])}function \_wppaSpeed(p,a){"random"!=\_wppaTimeOut[p]&&(a?500<\_wppaTimeOut[p]&&(\_wppaTimeOut[p]/=1.5):\_wppaTimeOut[p]<6e4&&(\_wppaTimeOut[p]\*=1.5),wppaSavedSlideshowTimeout[p]=\_wppaTimeOut[p])}function \_wppaUnloadSpinner(p){jQuery("#wppa-slide-spin-"+p).hide(),setTimeout(function(){jQuery("#wppa-slide-spin-"+p).stop().fadeOut()},1e3)}function \_wppaSetRatingDisplay(p){if(document.getElementById("wppa-rating-"+p)){var a,e,t=\_wppaAvg[p][\_wppaCurIdx[p]];if(void 0!==t){if("likes"==wppaRatingDisplayType){"void"==(e=\_wppaMyr[p][\_wppaCurIdx[p]])?(jQuery("#wppa-dislike-imgdiv-"+p).hide(),jQuery("#wppa-like-imgdiv-"+p).hide()):(jQuery("#wppa-dislike-imgdiv-"+p).show(),jQuery("#wppa-like-imgdiv-"+p).show());var w=t.split("|");return jQuery("#wppa-like-"+p).attr("title",w[0]),jQuery("#wppa-liketext-"+p).html(w[1]),void("1"==\_wppaMyr[p][\_wppaCurIdx[p]]?jQuery("#wppa-like-"+p).attr("src",wppaImageDirectory+"thumbdown.png"):jQuery("#wppa-like-"+p).attr("src",wppaImageDirectory+"thumbup.png"))}if(t=(a=t.split("|"))[0],w=a[1],a=\_wppaDisc[p][\_wppaCurIdx[p]],e=\_wppaMyr[p][\_wppaCurIdx[p]],"void"==a)jQuery("#wppa-rating-"+p).hide();else{if(jQuery("#wppa-rating-"+p).show(),"graphic"==wppaRatingDisplayType)\_wppaSetRd(p,t,"#wppa-avg-"),\_wppaSetRd(p,e,"#wppa-rate-"),0==e?(jQuery("#wppa-dislike-"+p).css("display","inline"),jQuery("#wppa-dislike-imgdiv-"+p).css("display","inline"),document.getElementById("wppa-dislike-"+p)&&jQuery("#wppa-filler-"+p).css("display","none"),jQuery("#wppa-dislike-"+p).stop().fadeTo(100,wppaStarOpacity)):(jQuery("#wppa-dislike-"+p).css("display","none"),jQuery("#wppa-dislike-imgdiv-"+p).css("display","none"),jQuery("#wppa-filler-"+p).css("display","inline"),jQuery("#wppa-filler-"+p).stop().fadeTo(100,wppaStarOpacity),jQuery("#wppa-filler-"+p).attr("title",a));else{if(jQuery("#wppa-numrate-avg-"+p).html(t+" ( "+w+" ) "),jQuery(".wppa-my-rat-"+p).show(),"void"==e)jQuery("#wppa-numrate-mine-"+p).html(""),jQuery(".wppa-my-rat-"+p).hide();else if(wppaRatingOnce&&0<e)jQuery("#wppa-numrate-mine-"+p).html(e);else if(e<0)jQuery("#wppa-numrate-mine-"+p).html(" dislike");else{var r="";for(i=1;i<=wppaRatingMax;i++)e==i?r+='<span class="wppa-rating-numeric-mine" style="cursor:pointer; font-weight:bold;" onclick="\_wppaRateIt( '+p+", "+i+' )">&nbsp;'+i+"&nbsp;</span>":(e>i-1&&e<i&&(r+="&nbsp;( "+e+" )&nbsp;"),r+='<span class="wppa-rating-numeric" style="cursor:pointer;" onclick="\_wppaRateIt( '+p+", "+i+' )" onmouseover="this.style.fontWeight=\'bold\'" onmouseout="this.style.fontWeight=\'normal\'" >&nbsp;'+i+"&nbsp;</span>");jQuery("#wppa-numrate-mine-"+p).html(r)}0==e?(jQuery("#wppa-dislike-"+p).css("display","inline"),jQuery("#wppa-dislike-imgdiv-"+p).css("display","inline"),jQuery("#wppa-filler-"+p).css("display","none"),jQuery("#wppa-dislike-"+p).stop().fadeTo(100,wppaStarOpacity)):(jQuery("#wppa-dislike-"+p).css("display","none"),jQuery("#wppa-dislike-imgdiv-"+p).css("display","none"),jQuery("#wppa-filler-"+p).css("display","inline")),jQuery("#wppa-discount-"+p).html(a+"&bull; "),jQuery("#wppa-filler-"+p).css("display","none")}0==e?jQuery("#wppa-vote-button-"+p).val(wppaVoteForMe):jQuery("#wppa-vote-button-"+p).val(wppaVotedForMe),jQuery("#wppa-vote-count-"+p).html(w)}}}}function wppaGetDislikeText(p,a,e){return p}function \_wppaSetRd(p,a,e){var t=parseInt(a),i=t+1,w=wppaStarOpacity+(a-t)\*(1-wppaStarOpacity),r=wppaRatingMax;if("void"==a)jQuery("#wppa-my-rat-"+p).hide(),jQuery(".wppa-my-rat-"+p).hide(),jQuery(".wppa-rate-"+p).hide(),jQuery(".wppa-ratingthumb").hide(),jQuery("#wppa-numrate-mine-"+p).hide();else for(jQuery("#wppa-my-rat-"+p).show(),jQuery(".wppa-my-rat-"+p).show(),jQuery(".wppa-rate-"+p).show(),jQuery(".wppa-ratingthumb").show(),jQuery("#wppa-numrate-mine-"+p).show(),idx=1;idx<=r;idx++)"#wppa-rate-"!=e&&".wppa-rate-"!=e||jQuery(e+p+"-"+idx).attr("src")!=wppaImageDirectory+"star.ico"&&jQuery(e+p+"-"+idx).attr("src",wppaImageDirectory+"star.ico"),idx<=t?jQuery(e+p+"-"+idx).stop().fadeTo(100,1):idx==i?jQuery(e+p+"-"+idx).stop().fadeTo(100,w):jQuery(e+p+"-"+idx).stop().fadeTo(100,wppaStarOpacity)}function \_wppaFollowMe(p,a){\_wppaSSRuns[p]||0!=\_wppaMyr[p][\_wppaCurIdx[p]]&&wppaRatingOnce||\_wppaMyr[p][\_wppaCurIdx[p]]<0||\_wppaVoteInProgress||\_wppaSetRd(p,a,"#wppa-rate-")}function wppaOvlFollowMe(p,a,e){e||\_wppaSetRd(p,a,".wppa-rate-")}function \_wppaLeaveMe(p,a){\_wppaSSRuns[p]||0!=\_wppaMyr[p][\_wppaCurIdx[p]]&&wppaRatingOnce||\_wppaMyr[p][\_wppaCurIdx[p]]<0||\_wppaVoteInProgress||\_wppaSetRd(p,\_wppaMyr[p][\_wppaCurIdx[p]],"#wppa-rate-")}function wppaOvlLeaveMe(p,a,e){\_wppaSetRd(p,e,".wppa-rate-")}function \_wppaValidateComment(p,a){if(a=a||\_wppaId[p][\_wppaCurIdx[p]],jQuery("#wppa-comname-"+p).val().length<1)return alert(\_\_("Please enter your name","wp-photo-album-plus")),!1;if("required"==wppaEmailRequired||"optional"==wppaEmailRequired){var e=jQuery("#wppa-comemail-"+p).val();if("optional"==wppaEmailRequired&&0==e.length)return!0;var t=e.indexOf("@"),a=e.lastIndexOf(".");if(t<1||a<t+2||a+2>=e.length)return alert(\_\_("Please enter a valid email address","wp-photo-album-plus")),!1}return!(jQuery("#wppa-comment-"+p).val().length<1)||(alert(\_\_("Please enter a comment","wp-photo-album-plus")),!1)}function \_wppaGo(p){document.location=p}function \_wppaBbb(p,a,e){if(!\_wppaSSRuns[p]){var t="#bbb-"+p+"-"+a;switch(e){case"show":"l"==a&&jQuery(t).attr("title",\_\_("Previous photo","wp-photo-album-plus")),"r"==a&&jQuery(t).attr("title",\_\_("Next photo","wp-photo-album-plus")),jQuery(".wppa-bbb-"+p).css("cursor","pointer");break;case"hide":jQuery(".wppa-bbb-"+p).removeAttr("title"),jQuery(".wppa-bbb-"+p).css("cursor","default");break;case"click":"l"==a&&wppaPrev(p),"r"==a&&wppaNext(p);break;default:alert("Unimplemented instruction: "+e+" on: "+t)}}}function \_wppaUbb(p,a,e){var t="#ubb-"+p+"-"+a;switch(e){case"show":"l"==a&&jQuery(t).attr("title",\_\_("Previous photo","wp-photo-album-plus")),"r"==a&&jQuery(t).attr("title",\_\_("Next photo","wp-photo-album-plus")),jQuery(".ubb-"+p).css("cursor","pointer"),jQuery(".ubb-"+p).stop().fadeTo(200,.8),jQuery("#wppa-startstop-icon-"+p).stop().fadeTo(200,.8);break;case"hide":jQuery(".ubb-"+p).removeAttr("title"),jQuery(".ubb-"+p).css("cursor","default"),wppaIsMobile?jQuery(".ubb-"+p).stop().fadeTo(200,.1):jQuery(".ubb-"+p).stop().fadeTo(200,0),jQuery("#wppa-startstop-icon-"+p).stop().fadeTo(200,0);break;case"click":wppaIsMobile&&(jQuery(".ubb-"+p).stop().fadeTo(200,1).fadeTo(1e3,0),jQuery("#wppa-startstop-icon-"+p).stop().fadeTo(200,1).fadeTo(1e3,0)),"l"==a&&wppaPrev(p),"r"==a&&wppaNext(p);break;default:alert("Unimplemented instruction: "+e+" on: "+t)}}function wppaOpenComments(p){\_wppaSSRuns[p]&&\_wppaStop(p),jQuery("#wppa-comtable-wrap-"+p).css("display","block"),jQuery("#wppa-comform-wrap-"+p).css("display","block"),jQuery("#wppa-comfooter-wrap-"+p).css("display","none"),wppaColWidth[p]=0,setTimeout("\_wppaDoAutocol( "+p+" )",100)}function \_wppaShowMetaData(p,a){\_wppaSlides[p]&&(\_wppaSSRuns[p]||\_\_wppaOverruleRun?"show"==a?wppaFotomotoHideWhenRunning||wppaFotomotoToolbar(p,\_wppaHiresUrl[p][\_wppaCurIdx[p]]):wppaShareHideWhenRunning&&jQuery("#wppa-share-"+p).css("display","none"):"show"==a?(wppaAutoOpenComments&&(jQuery("#wppa-comtable-wrap-"+p).css("display","block"),jQuery("#wppa-comform-wrap-"+p).css("display","block"),jQuery("#wppa-comfooter-wrap-"+p).css("display","none")),0!=\_wppaCurIdx[p]&&jQuery(".wppa-first-"+p).show(),\_wppaCurIdx[p]!=\_wppaSlides[p].length-1&&jQuery(".wppa-last-"+p).show(),wppaShareHideWhenRunning&&jQuery("#wppa-share-"+p).css("display",""),wppaFotomotoToolbar(p,\_wppaHiresUrl[p][\_wppaCurIdx[p]])):(jQuery("#wppa-comtable-wrap-"+p).css("display","none"),jQuery("#wppa-comform-wrap-"+p).css("display","none"),jQuery("#wppa-comfooter-wrap-"+p).css("display","block"),wppaFotomotoHide(p)),"show"==a?(jQuery("#imagedesc-"+p).css("visibility","visible"),jQuery("#imagetitle-"+p).css("visibility","visible"),jQuery("#counter-"+p).css("visibility","visible"),jQuery("#iptccontent-"+p).css("visibility","visible"),jQuery("#exifcontent-"+p).css("visibility","visible")):(jQuery("#counter-"+p).css("visibility","hidden"),jQuery(".wppa-first-"+p).hide(),jQuery(".wppa-last-"+p).hide(),jQuery("#iptccontent-"+p).css("visibility","hidden"),jQuery("#exifcontent-"+p).css("visibility","hidden")))}function wppaGetSlideshowTimeout(p,a){var e,t;return"random"==\_wppaTimeOut[p]?(e=2\*wppaAnimationSpeed,t=7\*wppaAnimationSpeed,Math.floor(Math.random()\*(t-e+1))+e):\_wppaTimeOut[p]}function wppaIsSlidshowVisible(p){if(!wppaLazyLoad)return!0;for(var a,e=["slide\_frame-"+p,"filmwindow-"+p],t=e.length,i=0;i<t;i++)if(a=document.getElementById(e[i]),a&&(a.getBoundingClientRect(),wppaIsElementInViewport(a)))return!0;return wppaFilmInit[p]=!1}function wppaFilmThumbToCanvas(p){var a,e,t=p+"-canvas",i=document.getElementById(p),w=document.getElementById(t);void 0!==w&&(a=w.getContext("2d"),e=i.naturalWidth|i.videoWidth,p=i.naturalHeight|i.videoHeight,(t=w.width)/(w=w.height)<e/p?(fromWidth=p\*t/w,fromX=(e-fromWidth)/2,a.drawImage(i,fromX,0,fromWidth,p,0,0,t,w)):(fromHeight=e\*w/t,fromY=(p-fromHeight)/2,a.drawImage(i,0,fromY,e,fromHeight,0,0,t,w)),i.pause&&i.pause())} |
  | 7 | 7 | // wppa-ajax-front |
  | 8 | 8 | var wppaJsAjaxVersion="8.8.08.006";function wppaDoAjaxRender(o,e,r,a){""!=wppaLang&&(e+="&lang="+wppaLang),wppaAutoColumnWidth[o]&&(e+="&resp=1"),e+="&wppa-cw="+wppaGetContainerWidth(o),a&&\_wppaCurIdx[o]&&\_wppaId[o][\_wppaCurIdx[o]]&&(e+="&wppa-hilite="+\_wppaId[o][\_wppaCurIdx[o]]),wppaCanAjaxRender||!r?jQuery.ajax({url:e,async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce),\_wppaSSRuns[o]&&\_wppaStop(o),jQuery("#wppa-ajax-spin-"+o).fadeIn()},success:function(e,a,t){var p;"string"==typeof e&&"{"!=e.substr(0,1)?(wppaConsoleLog("Ajax render result starts with "+e.substr(0,500),"force"),"<!DOCTYPE"==e.substr(0,8)||"<html"==e.substr(0,5)?0<r.length?document.location.href=r:alert(\_\_("Frontend Ajax request failed. Try a different setting in Advanced settings -> System -> I -> Item 5","wp-photo-album-plus")):alert(\_\_("Unexpected output","wp-photo-album-plus")+": "+e.substr(0,100)+"...")):(p="string"==typeof e?(p=JSON.parse(e)).html+"<script>"+p.js+"<\/script>":e.html+"<script>"+e.js+"<\/script>",wppaRenderModal&&r?(e={modal:!0,resizable:!0,width:wppaGetContainerWidth(o),show:{effect:"fadeIn",duration:400},closeText:"",classes:"wppa-dialog"},wppaPrepareModal(o),jQuery("#wppa-modal-container-"+o).html(p),jQuery("#wppa-modal-container-"+o).dialog(e),e=-1!=p.indexOf("slide-frame")?1==wppaAreaMaxFracSlide?wppaWindowHeight()/20:(wppaWindowHeight()-wppaWindowHeight()\*wppaAreaMaxFracSlide)/2:1==wppaAreaMaxFrac?wppaWindowHeight()/20:(wppaWindowHeight()-wppaWindowHeight()\*wppaAreaMaxFrac)/2,jQuery(".ui-dialog").css({boxShadow:"0px 0px 5px 5px #aaaaaa",borderRadius:wppaBoxRadius+"px",padding:"8px",backgroundColor:wppaModalBgColor,boxSizing:"content-box",zIndex:1e5,margin:"auto",overflow:"hidden",position:"fixed",left:(wppaWindowWidth()-wppaGetContainerWidth(o))/2+"px",top:e+"px"}),jQuery(".ui-dialog-titlebar").css({lineHeight:"0px",height:"32px"}),jQuery(".ui-button").css({backgroundImage:wppaModalQuitImg,padding:0,position:"absolute",right:"8px",top:"8px",width:"16px",height:"16px"}),jQuery(".ui-button").attr("title","Close"),jQuery(".ui-button").on("click",function(){\_wppaStop(o)}),jQuery(".wppa-ajax-spin").stop().fadeOut(),setTimeout(function(){jQuery().niceScroll&&(jQuery(".wppa-albumlist-"+o).niceScroll(".wppa-nicewrap",{}),jQuery(".wppa-slidelist-"+o).niceScroll(".wppa-nicewrap",{}))},1e3),jQuery(document).trigger("resize")):(jQuery("#wppa-container-"+o).html(p),jQuery("#wppa-button-hide-"+o).show()),wppaCanPushState&&wppaUpdateAddressLine&&r&&(r=r.split("&amp;").join("&"),history.pushState({type:"ajax"},"",r)),wppaUpdateLightboxes(),"undefined"!=typeof wppaQRUpdate&&wppaQRUpdate(r),wppaColWidth[o]=0,\_wppaDoAutocol(o,"ajax"))},error:function(e,a,t){wppaConsoleLog("wppaDoAjaxRender failed. Error = "+t+", status = "+a),r?document.location.href=r:document.location.reload(!0)},complete:function(e,a,t){!wppaRenderModal&&wppaAjaxScroll&&jQuery("html, body").animate({scrollTop:jQuery("#wppa-container-"+o).offset().top-32-wppaStickyHeaderHeight},1e3),jQuery(".wppa-ajax-spin").stop().fadeOut(),window.dispatchEvent(new Event("resize")),wppaProtect()}}):(document.location.href=r,wppaColWidth[o]=0,\_wppaDoAutocol(o,"nonajax"))}function wppaDoFetchShortcodeRendered(o,e,a){jQuery.ajax({url:wppaAjaxUrl+"?action=wppa&wppa-action=getshortcodedrenderedfenodelay&wppa-shortcode="+e+"&wppa-nonce="+jQuery("#wppa-nonce").val()+"&wppa-occur="+o+"&wppa-fromp="+a,async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce),wppaConsoleLog("Fetching delayed shortcode content for mocc = "+o),jQuery("#wppa-ajax-spin-"+o).show()},success:function(e,a,t){var p;try{p="rest"==wppaAjaxMethod?e.html+"<script>"+e.js+"<\/script>":(p=JSON.parse(e)).html+"<script>"+p.js+"<\/script>",wppaConsoleLog("Recieved delayed shortcode content for mocc = "+o),jQuery("#wppa-container-"+o).html(p),wppaConsoleLog("Applied delayed shortcode content for mocc = "+o)}catch(e){wppaConsoleLog("wppaDoFetchShortcodeRendered failed. Invalid json data")}},error:function(e,a,t){wppaConsoleLog("wppaDoFetchShortcodeRendered failed. Error = "+t+", status = "+a)},complete:function(e,a){jQuery(document).trigger("resize"),wppaProtect(),jQuery("#wppa-ajax-spin-"+o).hide(),wppaInitOverlay()}})}function wppaAjaxApprovePhoto(p){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=approve&photo-id="+p,async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){e="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);"OK"==e&&jQuery(".wppa-approve-"+p).css("display","none")},error:function(e,a,t){wppaConsoleLog("wppaAjaxApprovePhoto failed. Error = "+t+", status = "+a)}})}function wppaAjaxRemovePhoto(p,o,r){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=remove&photo-id="+o,async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){e="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);rtxt=e.split("||"),"OK"==rtxt[0]?r?(jQuery("#wppa-film-"+\_wppaCurIdx[p]+"-"+p).attr("src",""),jQuery("#wppa-pre-"+\_wppaCurIdx[p]+"-"+p).attr("src",""),jQuery("#wppa-film-"+\_wppaCurIdx[p]+"-"+p).attr("alt","removed"),jQuery("#wppa-pre-"+\_wppaCurIdx[p]+"-"+p).attr("alt","removed"),wppaNext(p)):(jQuery(".wppa-approve-"+o).css("display","none"),jQuery(".thumbnail-frame-photo-"+o).css("display","none")):rtxt[3]?(alert(rtxt[3]),jQuery("#wppa-delete-"+o).css("text-decoration","line-through")):alert(e)},error:function(e,a,t){wppaConsoleLog("wppaAjaxRemovePhoto failed. Error = "+t+", status = "+a)}})}function wppaAjaxApproveComment(p){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=approve&comment-id="+p,async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){e="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);"OK"==e?jQuery(".wppa-approve-"+p).css("display","none"):alert(e)},error:function(e,a,t){wppaConsoleLog("wppaAjaxApproveComment failed. Error = "+t+", status = "+a)}})}function wppaAjaxRemoveComment(p){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=remove&comment-id="+p,async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){e="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);"OK"==e.split("||")[0]?(jQuery(".wppa-approve-"+p).css("display","none"),jQuery(".wppa-comment-"+p).css("display","none")):alert(e)},error:function(e,a,t){wppaConsoleLog("wppaAjaxRemoveComment failed. Error = "+t+", status = "+a)}})}function wppaAjaxAddPhotoToZip(p,o,r){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=addtozip&photo-id="+o,async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){e="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt),e=e.split("||");"OK"==e[0]&&(jQuery("#admin-choice-"+o+"-"+p).html(e[2]),jQuery("#admin-choice-"+o+"-"+p).val(e[2]),jQuery("#admin-choice-"+o+"-"+p).prop("disabled",!0)),alert(e[1]),r&&document.location.reload(!0)},error:function(e,a,t){wppaConsoleLog("wppaAjaxAddPhotoToZip failed. Error = "+t+", status = "+a)}})}function wppaAjaxRemovePhotoFromZip(o,r,n){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=removefromzip&photo-id="+r,async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){var p="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt),e=p.split("||");"OK"==e[0]?(jQuery("#admin-choice-rem-"+r+"-"+o).val(e[1]),jQuery("#admin-choice-rem-"+r+"-"+o).prop("disabled",!0),jQuery("#admin-choice-rem-"+r+"-"+o).css("text-decoration","")):alert(p),n&&document.location.reload(!0)},error:function(e,a,t){wppaConsoleLog("wppaAjaxRemovePhotoFromZip failed. Error = "+t+", status = "+a,"force")}})}function wppaAjaxDeleteMyZip(){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=delmyzip",async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){"rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);document.location.reload(!0)},error:function(e,a,t){wppaConsoleLog("wppaAjaxDeleteMyZip failed. Error = "+t+", status = "+a)}})}function wppaAjaxRequestInfo(e,a,t){dialogHtml='<div class="wppa-modal"><h3>'+\_\_("Please specify your question","wp-photo-album-plus")+'</h3><textarea id="wppa-request-info-text-'+e+'" style="width:98%;" ></textarea><div style="clear:both;" ></div><input type="button" style="float:left;margin-top:8px;margin-right:8px;" value="'+\_\_("Send","wp-photo-album-plus")+'" onclick="wppaAjaxRequestInfoSend( '+e+", '"+a+"', "+t+' )" /><input type="button" style="float:left;margin-top:8px;margin-right:8px;" value="'+\_\_("Cancel","wp-photo-album-plus")+'" onclick="jQuery( \'#wppa-modal-container-'+e+"' ).dialog( 'close' );\" /><div style=\"clear:both;\" ></div></div>";t={modal:!0,resizable:!0,width:wppaGetContainerWidth(e),show:{effect:"fadeIn",duration:400},closeText:"",classes:"wppa-dialog"};wppaPrepareModal(e),jQuery("#wppa-modal-container-"+e).html(dialogHtml),jQuery("#wppa-modal-container-"+e).dialog(t),jQuery(".ui-dialog").css({boxShadow:"0px 0px 5px 5px #aaaaaa",borderRadius:wppaBoxRadius+"px",padding:"8px",backgroundColor:wppaModalBgColor,boxSizing:"content-box",zIndex:1e5,position:"fixed",top:wppaWindowHeight()/10+"px"}),jQuery(".ui-dialog-titlebar").css({lineHeight:"0px",height:"24px"}),jQuery(".ui-button").css({backgroundImage:wppaModalQuitImg,padding:0,position:"absolute",right:"8px",top:"8px",width:"16px",height:"16px"}),jQuery(".ui-button").attr("title","Close"),jQuery(document).trigger("resize")}function wppaAjaxRequestInfoSend(o,r,n){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=requestinfo&photo-id="+r+"&emailtext="+jQuery("#wppa-request-info-text-"+o).val(),async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){var p="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt),e=p.split("||");"OK"==e[0]?(jQuery("#request-info-"+r+"-"+o).val(e[1]),jQuery("#request-info-"+r+"-"+o).prop("disabled",!0)):alert(p),n?document.location.reload(!0):(jQuery("#wppa-modal-container-"+o).dialog("close"),jQuery("#wppa-modal-container-"+o).html(""))},error:function(e,a,t){wppaConsoleLog("wppaAjaxRequestInfoSend failed. Error = "+t+", status = "+a)}})}function wppaEditPhoto(o,e){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=front-edit&photo-id="+e+"&occur="+o,async:!0,type:"POST",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){var p="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt),e={modal:!0,resizable:!0,width:wppaGetContainerWidth(o),show:{effect:"fadeIn",duration:400},closeText:"",classes:"wppa-dialog"};wppaPrepareModal(o),jQuery("#wppa-modal-container-"+o).html(p),jQuery("#wppa-modal-container-"+o).dialog(e),jQuery(".ui-dialog").css({boxShadow:"0px 0px 5px 5px #aaaaaa",borderRadius:wppaBoxRadius+"px",padding:"8px",backgroundColor:wppaModalBgColor,boxSizing:"content-box",zIndex:1e5,position:"fixed",top:wppaWindowHeight()/10+"px"}),jQuery(".ui-dialog-titlebar").css({lineHeight:"0px",height:"24px"}),jQuery(".ui-button").css({backgroundImage:wppaModalQuitImg,padding:0,position:"absolute",right:"8px",top:"8px",width:"16px",height:"16px"}),jQuery(".ui-button").attr("title","Close"),jQuery(document).trigger("resize"),jQuery(".ui-dialog").on("scroll wheel",function(e){e.stopPropagation()})},error:function(e,a,t){wppaConsoleLog("wppaEditPhoto failed. Error = "+t+", status = "+a)},complete:function(e,a,t){}})}function wppaPrevTags(e,a,t,p,o,r,n){var s="action=wppa&wppa-action=sanitizetags&tags="+jQuery("#"+e).val()+","+jQuery("#"+a).val()+","+jQuery("#"+t).val()+","+jQuery("#"+p).val()+"&album="+jQuery("#"+o).val();jQuery.ajax({url:wppaAjaxUrl,data:s,async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce),jQuery("#"+r).html("Working..."),wppaConsoleLog(s)},success:function(e,a,t){e="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);jQuery("#"+n).attr("value",wppaTrim(e,",")),jQuery("#"+r).html(wppaTrim(e,",")),wppaConsoleLog(e+" gepleurt op "+r)},error:function(e,a,t){jQuery("#"+r).html('<span style="color:red" >'+t+"</span>"),wppaConsoleLog("wppaPrevTags failed. Error = "+t+", status = "+a)}})}function wppaAjaxDestroyAlbum(e,a){return confirm("Are you sure you want to delete this album?")&&jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=destroyalbum&album="+e+"&nonce="+a,async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){e="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);alert(e+"\n"+\_\_("Page will be reloaded","wp-photo-album-plus")),document.location.reload(!0)},error:function(e,a,t){wppaConsoleLog("wppaAjaxDestroyAlbum failed. Error = "+t+", status = "+a)}}),!1}function \_bumpClickCount(e){wppaBumpClickCount&&jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=bumpclickcount&wppa-photo="+e+"&wppa-nonce="+jQuery("#wppa-nonce").val(),async:!1,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){"rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt)},error:function(e,a,t){wppaConsoleLog("\_bumpClickCount failed. Error = "+t+", status = "+a)}})}function \_bumpViewCount(p){wppaBumpViewCount&&(wppaPhotoView[p]||jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=bumpviewcount&wppa-photo="+p+"&wppa-nonce="+jQuery("#wppa-nonce").val(),async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){"rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);wppaPhotoView[p]=!0},error:function(e,a,t){wppaConsoleLog("\_bumpViewCount failed. Error = "+t+", status = "+a)}}))}function wppaVoteThumb(p,o){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=rate&wppa-rating=1&wppa-rating-id="+o+"&wppa-occur="+p+"&wppa-index=0&wppa-nonce="+jQuery("#wppa-nonce").val(),async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){"rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);jQuery("#wppa-vote-button-"+p+"-"+o).val(wppaVotedForMe)},error:function(e,a,t){wppaConsoleLog("wppaVoteThumb failed. Error = "+t+", status = "+a)}})}function \_wppaRateIt(o,a){var e,t,p;0!=a&&(\_wppaSSRuns[o]||(e=\_wppaId[o][\_wppaCurIdx[o]],t=\_wppaMyr[o][\_wppaCurIdx[o]],0<(p=\_wppaWaitTexts[o][\_wppaCurIdx[o]]).length?alert(p):0!=t&&wppaRatingOnce||t<0||(\_wppaVoteInProgress=!0,jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=rate&wppa-rating="+a+"&wppa-rating-id="+e+"&wppa-occur="+o+"&wppa-index="+\_wppaCurIdx[o]+"&wppa-nonce="+jQuery("#wppa-nonce").val(),async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce),jQuery("#wppa-rate-"+o+"-"+a).attr("src",wppaImageDirectory+"tick.png"),jQuery("#wppa-rate-"+o+"-"+a).stop().fadeTo(100,1),jQuery("#wppa-like-"+o).attr("src",wppaImageDirectory+"spinner.gif")},success:function(e,a,t){var p="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt),e=p.split("||");0==e[0]?900==e[1]?(alert(e[2]),\_wppaSetRatingDisplay(o)):alert(\_\_("Error Code","wp-photo-album-plus")+" = "+e[1]+"\n\n"+e[2]):(e[7]&&"likes"==e[7]?(p=e[4].split("|"),jQuery("#wppa-like-"+o).attr("title",p[0]),jQuery("#wppa-liketext-"+o).html(p[1]),"1"==e[3]?jQuery("#wppa-like-"+o).attr("src",wppaImageDirectory+"thumbdown.png"):jQuery("#wppa-like-"+o).attr("src",wppaImageDirectory+"thumbup.png"),\_wppaMyr[e[0]][e[2]]=e[3],\_wppaAvg[e[0]][e[2]]=e[4]):(\_wppaMyr[e[0]][e[2]]=e[3],\_wppaAvg[e[0]][e[2]]=e[4],\_wppaDisc[e[0]][e[2]]=e[5],\_wppaSetRatingDisplay(o),wppaCommentRequiredAfterVote&&0==e[6]&&alert(e[7])),wppaNextOnCallback&&\_wppaNextOnCallback(o))},error:function(e,a,t){wppaConsoleLog("\_wppaRateIt failed. Error = "+t+", status = "+a)}}))))}function \_wppaOvlRateIt(o,r,n,s){0!=r&&jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=rate&wppa-rating="+r+"&wppa-rating-id="+o+"&wppa-occur=1&wppa-nonce="+jQuery("#wppa-nonce").val(),async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce),jQuery(".wppa-rate-"+n+"-"+r).attr("src",wppaImageDirectory+"tick.png"),jQuery(".wppa-rate-"+n+"-"+r).stop().fadeTo(100,1),jQuery("#wppa-like-"+o+"-"+n).attr("src",wppaImageDirectory+"spinner.gif"),jQuery("#wppa-like-0").attr("src",wppaImageDirectory+"spinner.gif")},success:function(e,a,t){var p="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt),e=p.split("||");if(0==e[0])900==e[1]?alert(e[2]):alert(\_\_("Error Code","wp-photo-album-plus")+" = "+e[1]+"\n\n"+e[2]),jQuery(".wppa-rate-"+n+"-"+r).attr("src",wppaImageDirectory+"cross.png");else{if(e[7]&&"likes"==e[7]){p=e[4].split("|");return jQuery("#wppa-like-0").attr("title",p[0]),jQuery("#wppa-liketext-0").html(p[1]),"1"==e[3]?jQuery("#wppa-like-0").attr("src",wppaImageDirectory+"thumbdown.png"):jQuery("#wppa-like-0").attr("src",wppaImageDirectory+"thumbup.png"),jQuery("#wppa-like-"+o+"-"+n).attr("title",p[0]),jQuery("#wppa-liketext-"+o+"-"+n).html(p[1]),void("1"==e[3]?jQuery("#wppa-like-"+o+"-"+n).attr("src",wppaImageDirectory+"thumbdown.png"):jQuery("#wppa-like-"+o+"-"+n).attr("src",wppaImageDirectory+"thumbup.png"))}\_wppaSetRd(n,e[4],".wppa-avg-"),\_wppaSetRd(n,e[3],".wppa-rate-"),s||wppaNextOnCallback&&wppaOvlShowNext()}},error:function(e,a,t){wppaConsoleLog("\_wppaOvlRateIt failed. Error = "+t+", status = "+a)}})}function wppaAjaxDownloadAlbum(p,o){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=downloadalbum&album-id="+o,async:!0,type:"GET",timeout:12e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce),jQuery("#dwnspin-"+p+"-"+o).css("display","")},success:function(e,a,t){var p="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt),o=p.split("||"),r=o[0],e=o[1],p=o[2];3==o.length&&""!=p&&alert(\_\_("Attention","wp-photo-album-plus")+":\n\n"+p),"OK"==e?document.location=r:alert(\_\_("The server could not complete the request. Please try again.","wp-photo-album-plus"))},error:function(e,a,t){alert("An error occurred:\n"+t+"\nPlease try again")},complete:function(e,a,t){jQuery("#dwnspin-"+p+"-"+o).css("display","none")}})}function wppaAjaxComment(p,e){var a;\_wppaValidateComment(p,e)&&(a=(a=jQuery("#wppa-comment-"+p).val()).replace(/&/g,"%26"),a={photoid:e,comname:jQuery("#wppa-comname-"+p).val(),comment:a,captcha:jQuery("#wppa-captcha-"+p).val(),nonce:jQuery("#wppa-nonce").val(),occur:p,comemail:jQuery("#wppa-comemail-"+p).val(),comid:jQuery("#wppa-comment-edit-"+p).val(),returnurl:encodeURIComponent(jQuery("#wppa-returnurl-"+p).val()),dbagree:jQuery("#db-agree-"+p).prop("checked")?"yes":"no"},a=JSON.stringify(a),jQuery.ajax({url:wppaAjaxUrl+"?action=wppa&wppa-action=do-comment",data:"data="+a,async:!0,type:"POST",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce),jQuery("#wppa-comment-spin-"+p).css("display","inline")},success:function(e,a,t){e="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);e&&(e=e.replace(/\\/g,""),jQuery("#wppa-comments-"+p).html(e),\_wppaCurIdx[p]&&(\_wppaCommentHtml[p][\_wppaCurIdx[p]]=e)),wppaOpenComments(p)},error:function(e,a,t){wppaConsoleLog("wppaAjaxComment failed. Error = "+t+", status = "+a)},complete:function(e,a,t){jQuery("#wppa-comment-spin-"+p).css("display","none")}}))}function wppaUpdatePhotoNew(e,p){for(var a,t=["upn-name","upn-description","upn-tags","custom\_0","custom\_1","custom\_2","custom\_3","custom\_4","custom\_5","custom\_6","custom\_7","custom\_8","custom\_9"],o="action=wppa&wppa-action=update-photo-new&photo-id="+e+"&wppa-nonce="+jQuery("#wppa-nonce-"+e).val(),r=0;r<t.length;)void 0!==jQuery("#"+t[r]).val()&&(o+="&"+t[r]+"="+jQuery("#"+t[r]).val()),void 0!==(a=wppaGetTinyMceContent(t[r]))&&(o+="&"+t[r]+"="+a),r++;jQuery("#upn-reload").prop("checked")&&(o+="&upn-reload=on"),jQuery.ajax({url:wppaAjaxUrl,data:o,async:!0,type:"POST",timeout:1e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){e="rest"==wppaAjaxMethod?e:JSON.parse(e);e.error?(wppaConsoleLog("Failed to report updates","force"),alert(e.error)):(void 0!==e.description&&jQuery(".sdd-"+p).html(e.description),void 0!==e.name&&jQuery(".sdn-"+p).html(e.name),void 0!==e.fullname&&jQuery(".sdf-"+p).html(e.fullname),\_wppaNames[p]&&(void 0!==e.name&&(\_wppaNames[p][\_wppaCurIdx[p]]=wppaFixHtml(e.name)),void 0!==e.fullname&&(\_wppaFullNames[p][\_wppaCurIdx[p]]=wppaFixHtml(e.fullname)),void 0!==e.description&&(\_wppaDsc[p][\_wppaCurIdx[p]]=wppaFixHtml(e.description)),jQuery("#imagetitle-"+p).html(wppaMakeNameHtml(p))))},error:function(e,a,t){wppaConsoleLog("wppaUpdatePhotoNew failed. Error = "+t+", status = "+a)},complete:function(e,a,t){jQuery("#upn-reload").prop("checked")?document.location.reload(!0):(jQuery("#wppa-modal-container-"+p).dialog("close"),jQuery("#wppa-modal-container-"+p).html(""))}})}function wppaFixHtml(e){return e?e=(e=(e=(e=e.replace(/\[/g,"<")).replace(/\]/g,">")).replace(/&quot;/g,'"')).replace(/\\n/g," "):""}var wppaLastQrcodeUrl="";function wppaAjaxSetQrCodeSrc(e,p){0!=jQuery(p).length&&wppaLastQrcodeUrl!=e&&(wppaLastQrcodeUrl=e,e="action=wppa&wppa-action=getqrcode&wppa-qr-nonce="+jQuery("#wppa-qr-nonce").val()+"&url="+encodeURIComponent(e),jQuery.ajax({url:wppaAjaxUrl,data:e,async:!0,type:"POST",timeout:1e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){e="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt),e=e.split("|");jQuery(p).attr("src",e[0]),jQuery(p).attr("title",e[1])},error:function(e,a,t){wppaConsoleLog("wppaAjaxSetQrCodeSrc failed. Error = "+t+", status = "+a)}}))}function wppaAjaxNotify(e,p,o){e=jQuery(e).prop("checked")?"on":"off",e="action=wppa&wppa-action=mailinglist&wppa-ntfy-nonce="+jQuery("#wppa-ntfy-nonce").val()+"&list="+p+"&onoff="+e;o&&(e+="&wppa-user="+o),jQuery.ajax({url:wppaAdminAjaxUrl,data:e,async:!0,type:"POST",timeout:1e4,beforeSend:function(e){o&&jQuery("#img\_"+p+"-"+o).attr("src",wppaImageDirectory+"spinner.gif")},success:function(e,a,t){o&&(wppaConsoleLog(e,"force"),jQuery("#img\_"+p+"-"+o).attr("src",wppaImageDirectory+"tick.png"))},error:function(e,a,t){wppaConsoleLog("wppaAjaxNotify failed. Error = "+t+", status = "+a),jQuery("#img\_"+p+"-"+o).attr("src",wppaImageDirectory+"cross.png")}})}function wppaAjaxGetSsIptcList(e,a,t,p){wppaAjaxGetSsIptcExifList(e,a,t,p,"iptc")}function wppaAjaxGetSsExifList(e,a,t,p){wppaAjaxGetSsIptcExifList(e,a,t,p,"exif")}function wppaAjaxGetSsIptcExifList(p,o,r,n,s){ajaxurl=wppaAjaxUrl,ajaxurl+="?action=wppa&wppa-action=getss"+s+"list&"+s+"tag="+o+"&occur="+p,jQuery.ajax({url:ajaxurl,async:!0,type:"GET",timeout:1e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce),jQuery("#wppa-ss-spinner-"+p).css("display","")},success:function(e,a,t){e="rest"==wppaAjaxMethod?e.txt:(theResult=JSON.parse(e),theResult.txt);jQuery("#"+r).html(e),jQuery("#wppa-ss-"+s+"opts-"+p).css("display",""),wppaSuperSearchSelect(p),setTimeout('wppaSetIptcExifSize( ".wppa-'+s+"list-"+p+'", "#'+r+'" )',10),n&&wppaConsoleLog("wppaAjaxGetSs"+s+"List success after retry.")},error:function(e,a,t){wppaConsoleLog("wppaAjaxGetSs"+s+"List failed. Error = "+t+", status = "+a),n||wppaAjaxGetSsIptcExifList(p,o,r,!0,s)},complete:function(e,a,t){jQuery("#wppa-ss-spinner-"+p).css("display","none")}})}function wppaPrepareModal(a){try{jQuery("#wppa-modal-container-"+a).dialog("destroy"),jQuery("#wppa-modal-container-"+a).html("")}catch(e){jQuery("#wppa-modal-container-"+a).html("")}}function wppaAjaxBumpDownloadCount(e){jQuery.ajax({url:wppaAjaxUrl,data:"action=wppa&wppa-action=bumpdownloadcount&wppa-photo="+e+"&wppa-nonce="+jQuery("#wppa-nonce").val(),async:!0,type:"GET",timeout:6e4,beforeSend:function(e){"rest"==wppaAjaxMethod&&e.setRequestHeader("X-WP-NONCE",wppaObj.restNonce)},success:function(e,a,t){},error:function(e,a,t){wppaConsoleLog("wppaAjaxBumpDownloadCount. Error = "+t+", status = "+a)}})} |
* ## [wp-photo-album-plus/trunk/js/wppa-slideshow.js](/changeset/3184852/wp-photo-album-plus/trunk/js/wppa-slideshow.js "Show the changeset 3184852 restricted to wp-photo-album-plus/trunk/js/wppa-slideshow.js")

  | [r3128826](/browser/wp-photo-album-plus/trunk/js/wppa-slideshow.js?rev=3128826#L4 "Show revision 3128826 of this file in browser") | [r3184852](/browser/wp-photo-album-plus/trunk/js/wppa-slideshow.js?rev=3184852#L4 "Show revision 3184852 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | // Dependancies: wppa.js and default wp $ library |
  | 5 | 5 | // |
  | 6 |  | var wppaJsSlideshowVersion = '8.~~8.04~~.001'; |
  |  | 6 | var wppaJsSlideshowVersion = '8.9.02.001'; |
  | 7 | 7 | var wppaHasControlbar = false; |
  | 8 | 8 |  |
  | […](/browser/wp-photo-album-plus/trunk/js/wppa-slideshow.js?rev=3128826#L162) | […](/browser/wp-photo-album-plus/trunk/js/wppa-slideshow.js?rev=3184852#L162) |  |
  | 162 | 162 | var controls; |
  | 163 | 163 | controls = 'wppa' == wppaLightBox[mocc] ? '' : 'controls'; |
  | 164 |  | \_wppaSlides[mocc][id] += 'style="' + size + '; cursor:'+cursor+'; display:none;" '+controls+'>'+videohtml+'</video>'; |
  |  | 164 | \_wppaSlides[mocc][id] += 'style="' + size + '; cursor:'+cursor+'; display:none;" '+controls+' preload="metadata">'+videohtml+'</video>'; |
  | 165 | 165 | } |
  | 166 | 166 | else { |
* ## [wp-photo-album-plus/trunk/wppa-links.php](/changeset/3184852/wp-photo-album-plus/trunk/wppa-links.php "Show the changeset 3184852 restricted to wp-photo-album-plus/trunk/wppa-links.php")

  | [r3155960](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3155960#L5 "Show revision 3155960 of this file in browser") | [r3184852](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852#L5 "Show revision 3184852 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Frontend links |
  | 6 | 6 | \* |
  | 7 |  | \* Version: 8.~~8.06.006~~ |
  |  | 7 | \* Version: 8.9.02.001 |
  | 8 | 8 | \*/ |
  | 9 | 9 |  |
  | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3155960#L106) | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852#L106) |  |
  | 106 | 106 | $pl .= 'meonly=1&amp;'; |
  | 107 | 107 | } |
  | 108 |  |  |
  |  | 108 |  |
  | 109 | 109 | if ( $wppa\_url\_set\_extension ) { |
  | 110 | 110 | $pl .= wppa\_encrypt\_set() . '&amp;'; |
  | 111 | 111 | } |
  | 112 |  |  |
  |  | 112 |  |
  | 113 | 113 | if ( $key == 'js' ) { |
  | 114 | 114 | $pl = str\_replace( '&amp;', '&' ); |
  | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3155960#L209) | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852#L209) |  |
  | 209 | 209 |  |
  | 210 | 210 | $al .= '&amp;'; |
  | 211 |  |  |
  |  | 211 |  |
  | 212 | 212 | if ( $key == 'js' ) { |
  | 213 | 213 | $al = str\_replace( '&amp;', '&', $al ); |
  | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3155960#L733) | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852#L733) |  |
  | 733 | 733 | } |
  | 734 | 734 | } |
  | 735 |  |  |
  |  | 735 |  |
  | 736 | 736 | if ( false && $wppa\_url\_set\_extension ) { |
  | 737 | 737 | $newuri .= '?' . $wppa\_url\_set\_extension; |
  | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3155960#L1500) | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852#L1500) |  |
  | 1500 | 1500 | } |
  | 1501 | 1501 | if ( $type == 'thumbs' ) { |
  | 1502 |  | $result['url'] = wppa\_~~encrypt\_url( wppa\_get\_ss\_to\_tn\_link( $page, $id )~~ ); |
  |  | 1502 | $result['url'] = wppa\_get\_ss\_to\_tn\_link( $page, $id ); |
  | 1503 | 1503 | $result['title'] = \_\_('View thumbnails', 'wp-photo-album-plus' ); |
  | 1504 | 1504 | $result['is\_url'] = true; |
  | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3155960#L2013) | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852#L2013) |  |
  | 2013 | 2013 | global $thumbs\_ids; |
  | 2014 | 2014 |  |
  |  | 2015 | $sa = wppa\_encrypt\_album( wppa( 'start\_album' ) ); |
  |  | 2016 |  |
  | 2015 | 2017 | // Search ? |
  | 2016 | 2018 | if ( wppa( 'src' ) && wppa( 'mocc' ) == '1' && ! wppa( 'is\_related' ) ) { |
  | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3155960#L2020) | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852#L2022) |  |
  | 2020 | 2022 | elseif ( wppa( 'is\_upldr' ) ) { |
  | 2021 | 2023 | if ( wppa( 'start\_album' ) ) { |
  | 2022 |  | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-upldr='.wppa( 'is\_upldr' ).'&amp;wppa-album='.~~wppa( 'start\_album' )~~; |
  |  | 2024 | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-upldr='.wppa( 'is\_upldr' ).'&amp;wppa-album='.$sa; |
  | 2023 | 2025 | } |
  | 2024 | 2026 | else { |
  | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3155960#L2028) | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852#L2030) |  |
  | 2028 | 2030 | // Topten ? |
  | 2029 | 2031 | elseif ( wppa( 'is\_topten' ) ) { |
  | 2030 |  | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-topten='.wppa( 'topten\_count' ).'&amp;wppa-album='.~~wppa( 'start\_album' )~~; |
  |  | 2032 | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-topten='.wppa( 'topten\_count' ).'&amp;wppa-album='.$sa; |
  | 2031 | 2033 | } |
  | 2032 | 2034 | // Lasten ? |
  | 2033 | 2035 | elseif ( wppa( 'is\_lasten' ) ) { |
  | 2034 |  | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-lasten='.wppa( 'lasten\_count' ).'&amp;wppa-album='.~~wppa( 'start\_album' )~~; |
  |  | 2036 | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-lasten='.wppa( 'lasten\_count' ).'&amp;wppa-album='.$sa; |
  | 2035 | 2037 | } |
  | 2036 | 2038 | // Comten ? |
  | 2037 | 2039 | elseif ( wppa( 'is\_comten' ) ) { |
  | 2038 |  | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-comten='.wppa( 'comten\_count' ).'&amp;wppa-album='.~~wppa( 'start\_album' )~~; |
  |  | 2040 | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-comten='.wppa( 'comten\_count' ).'&amp;wppa-album='.$sa; |
  | 2039 | 2041 | } |
  | 2040 | 2042 | // Featen ? |
  | 2041 | 2043 | elseif ( wppa( 'is\_featen' ) ) { |
  | 2042 |  | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-featen='.wppa( 'featen\_count' ).'&amp;wppa-album='.~~wppa( 'start\_album' )~~; |
  |  | 2044 | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-featen='.wppa( 'featen\_count' ).'&amp;wppa-album='.$sa; |
  | 2043 | 2045 | } |
  | 2044 | 2046 | // Related ? |
  | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3155960#L2048) | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852#L2050) |  |
  | 2048 | 2050 | // Tag ? |
  | 2049 | 2051 | elseif ( wppa( 'is\_tag' ) ) { |
  | 2050 |  | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-tag='.wppa( 'is\_tag' ).'&amp;wppa-album='.~~wppa( 'start\_album' )~~; |
  |  | 2052 | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-tag='.wppa( 'is\_tag' ).'&amp;wppa-album='.$sa; |
  | 2051 | 2053 | } |
  | 2052 | 2054 | // Cat ? |
  | 2053 | 2055 | elseif ( wppa( 'is\_cat' ) ) { |
  | 2054 |  | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-cat='.wppa( 'is\_cat' ).'&amp;wppa-album='.~~wppa( 'start\_album' )~~; |
  |  | 2056 | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-cat='.wppa( 'is\_cat' ).'&amp;wppa-album='.$sa; |
  | 2055 | 2057 | } |
  | 2056 | 2058 | // Last ? |
  | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3155960#L2060) | […](/browser/wp-photo-album-plus/trunk/wppa-links.php?rev=3184852#L2062) |  |
  | 2060 | 2062 | // Default ? |
  | 2061 | 2063 | else { |
  | 2062 |  | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-album='.~~wppa( 'start\_album' )~~; |
  |  | 2064 | $thumbhref = wppa\_get\_permalink( $page ).'wppa-cover=0&amp;wppa-occur='.wppa( 'mocc' ).'&amp;wppa-album='.$sa; |
  | 2063 | 2065 | } |
  | 2064 | 2066 |  |
* ## [wp-photo-album-plus/trunk/wppa.php](/changeset/3184852/wp-photo-album-plus/trunk/wppa.php "Show the changeset 3184852 restricted to wp-photo-album-plus/trunk/wppa.php")

  | [r3184423](/browser/wp-photo-album-plus/trunk/wppa.php?rev=3184423#L3 "Show revision 3184423 of this file in browser") | [r3184852](/browser/wp-photo-album-plus/trunk/wppa.php?rev=3184852#L3 "Show revision 3184852 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | \* Plugin Name: WP Photo Album Plus |
  | 4 | 4 | \* Description: Easily manage and display your photo albums and slideshows within your WordPress site. |
  | 5 |  | \* Version: 8.9.0~~1~~.001 |
  |  | 5 | \* Version: 8.9.02.001 |
  | 6 | 6 | \* Author: J.N. Breetvelt a.k.a. OpaJaap |
  | 7 | 7 | \* Author URI: http://wppa.opajaap.nl/ |
  | […](/browser/wp-photo-album-plus/trunk/wppa.php?rev=3184423#L23) | […](/browser/wp-photo-album-plus/trunk/wppa.php?rev=3184852#L23) |  |
  | 23 | 23 |  |
  | 24 | 24 | /\* WPPA Version \*/ |
  | 25 |  | global $wppa\_version;       $wppa\_version = '8.9.0~~1~~.001';                           // WPPA software version |
  |  | 25 | global $wppa\_version;       $wppa\_version = '8.9.02.001';                           // WPPA software version |
  | 26 | 26 | global $wppa\_revno;         $wppa\_revno = str\_replace( '.', '', $wppa\_version );    // WPPA db version |
  | 27 | 27 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3184852)
* [Zip Archive](?format=zip&new=3184852)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from wordpress.org_a970d14d_20250114_212701.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

WP Photo Album Plus

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fwp-photo-album-plus&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fwp-photo-album-plus&locale=en_US)

Search plugins

![](https://s.w.org/plugins/geopattern-icon/wp-photo-album-plus.svg)
# WP Photo Album Plus

By [J.N. Breetvelt a.k.a. OpaJaap](http://wppa.opajaap.nl/)

[Download](https://downloads.wordpress.org/plugin/wp-photo-album-plus.8.9.02.005.zip)

* [Details](https://wordpress.org/plugins/wp-photo-album-plus/#description)
* [Reviews](https://wordpress.org/plugins/wp-photo-album-plus/#reviews)
* [Installation](https://wordpress.org/plugins/wp-photo-album-plus/#installation)
* [Development](https://wordpress.org/plugins/wp-photo-album-plus/#developers)

[Support](https://wordpress.org/support/plugin/wp-photo-album-plus/)

## Description

This plugin is more than just a photo album plugin, it is a complete, highly customizable multimedia content management and display system.

Features:

* Any number of albums that contain any type of multimedia file as well as sub albums
* Full control over the display sizes, responsive as well as static
* Full control over links from any type of image
* Full control over metadata: exif, iptc can be used by keywords in item descriptions
* Up to 10 custom defined meta data fields, for albums and for media items
* Front-end uploads
* Bulk imports
* Built-in lightbox overlay system
* Built-in Google Maps to display maps based on the photo gpx exif data
* Built-in search functions on a.o. keywords and tags
* A customizable rating system
* Commenting system
* Moderate user uploads and comments
* Configurable email notification system
* 20 widgets a.o. upload, slideshow, photo of the day, top rated and commented items and many more
* Supports Cloudinary cloud storage service
* Supports Fotomoto print service
* Required maintenace is fully executed by background processes (cron jobs)
* Extended error/event logging system
* Extended documentation site: https://wppa.nl/

Plugin Admin Features:

You can find the plugin admin section under Menu Photo Albums on the admin screen.

* Albums: Create and manage Albums.
* Upload: To upload photos to an album you created.
* Import: To bulk import items to an album that are previously been ftp’d.
* Moderate: Change status of pending
* Export: To export albums
* Settings: To control the various settings to customize your needs.
* photo of the day widget settings
* Help & Info: Credits and link to the documentation site

Translations:

* Dutch translation by OpaJaap himself ([Opa Jaap’s Weblog](http://www.opajaap.nl))
* Slovak translation by Branco Radenovich ([WebHostingGeeks.com](http://webhostinggeeks.com/user-reviews/))
* Polish translation by Maciej Matysiak
* Ukranian translation by Michael Yunat ([http://getvoip.com](http://getvoip.com/blog))
* Italian translation by Giacomo Mazzullo (<http://gidibao.net> & <http://charmingpress.com>)
* German translation by Stefan Eggers
* Portuguese translation by Eric Sornoso (<https://Mealfan.com>)

### Privacy Policy

* When you leave a comment on a photo or other media item on this site, we send your name, email address, IP address and comment text to the server.
* When you enter a rating on a photo or other media item on this site, we send your (login)name or IP address and your rating to the server.
* When you upload a photo or other media item on this site, we send your name to the server.
* If the photo contains EXIF or IPTC data, this data may – dependant of the configuration – be saved on the server.
* If the photo contains GPX location data, this data will be saved on the server.
* If visit the site, the pages you visit, the photos you watch and your IP address will be saved on the server for statistical purposes in your session information. This information will be anonimized after one hour and removed after 24 hours.

### About and Credits

* WP Photo Album Plus is extended with many new features and is maintained by J.N. Breetvelt, ( http://www.opajaap.nl/ ) a.k.a. OpaJaap
* Thanx to R.J. Kaplan for WP Photo Album 1.5.1, the basis of this plugin.

### Licence

WP Photo Album is released under the GNU GPL licence. ( http://www.gnu.org/copyleft/gpl.html )

## Screenshots

* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-1.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-1.png?rev=1836393)

  Typical display of album covers
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-2.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-2.png?rev=1836393)

  Typical display of thumbnails as seen by the owner of the photos and the administrator
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-3.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-3.png?rev=1836393)

  Upper part of a slideshow
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-4.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-4.png?rev=1836393)

  Lower part of a slideshow, including filmstrip, rating and comment sections and exif data. all included optional features
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-5.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-5.png?rev=1836393)

  Album admin: the table of albums
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-6.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-6.png?rev=1836393)

  Album admin: the album specifications edit screen
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-7.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-7.png?rev=1836393)

  Album admin: edit photo information screen
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-8.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-8.png?rev=1836393)

  Bulk edit photo information screen
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-9.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-9.png?rev=1836393)

  Photo sequence editor screen
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-10.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-10.png?rev=1836393)

  Comment admin and moderation screen
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-11.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-11.png?rev=1836393)

  Photo of the day configuration screen
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-12.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-12.png?rev=1836393)

  Embedded lightbox example
* [![](https://ps.w.org/wp-photo-album-plus/assets/screenshot-13.png?rev=1836393)](https://ps.w.org/wp-photo-album-plus/assets/screenshot-13.png?rev=1836393)

  The quick setup screen

## Blocks

This plugin provides 5 blocks.

* WPPA Upload
* WPPA general
* WPPA potd
* WPPA slideshow
* WPPA+ photo

## Installation

* Standard from the plugins page

#### Requirements

* The theme should have a call to wp\_head() in its header.php file and wp\_footer() in its footer.php file.
* The theme should load enqueued scripts in the header if the scripts are enqueued without the $in\_footer switch (like wppa.js and jQuery).
* The theme should not prevent this plugin from loading the jQuery library in its default wp manner, i.e. the library jQuery in safe mode (uses jQuery() and not $()).
* The theme should not use remove\_action() or remove\_all\_actions() when it affects actions added by wppa+.

  Most themes comply with these requirements.

  However, check these requirements in case of problems with new installations with themes you never had used before with wppa+ or when you modified your theme.
* The server should have at least 64MB of memory.

## FAQ

### What do i have to do when converting to multisite?

* See [the installation notes](https://wppa.nl/changelog/installation-notes/#multisite)

### Which other plugins do you recommend to use with WPPA+, and which not?

* Recommended plugins: qTranslate, Comet Cache, Cube Points, Simple Cart & Buy Now.
* Plugins that break up WPPA+: My Live Signature.
* Google Analytics for WordPress will break the slideshow in most cases when *Track outbound clicks & downloads:* has been checked in its configuration.

### Which themes have problems with wppa+ ?

* Photocrati has a problem with the wppa+ embedded lightbox when using page templates with sidebar.

### Are there special requirements for responsive (mobile) themes?

* No, WPPA+ is responsive by default

### After update, many things seem to go wrong

* After an update, always clear your browser cache (CTRL+F5) and clear your temp internetfiles, this will ensure the new versions of js files will be loaded.
* And – most important – if you use a server side caching program (like W3 Total Cache) clear its cache.
* Make sure any minifying plugin (like W3 Total Cache) is also reset to make sure the new version files are used.
* Visit the Photo Albums -> Settings page -> Table VIII-A1 and press Do it!
* When upload fails after an upgrade, one or more columns may be added to one of the db tables. In rare cases this may have been failed.

  Unfortunately this is hard to determine.

  If this happens, make sure (ask your hosting provider) that you have all the rights to modify db tables and run action Table VII-A1 again.

### How does the search widget work?

* See the documentation on the WPPA+ Docs & Demos site: https://wppa.nl/docs-by-subject/search/regular-search/

### How can i translate the plugin into my language?

* See the translators handbook: https://make.wordpress.org/polyglots/handbook/
* Here is the polyglot page for this plugin: https://translate.wordpress.org/projects/wp-plugins/wp-photo-album-plus

### How do i install a hotfix?

* See the documentation on the WPPA+ Docs & Demos site: https://wppa.nl/docs-by-subject/development-version/

## Reviews

![](https://secure.gravatar.com/avatar/6c19d54a3cd9d96e8167fd4f46eae9b174a9c56280460a99f3310d421fbd02f0?s=60&d=retro&r=g)
### [Great plugin](https://wordpress.org/support/topic/great-plugin-38329/)

[neil40](https://profiles.wordpress.org/neil40/ "Posts by neil40")
January 19, 2024

Our website has used this plugin for our Photography galleries for some time now. It is the best one out there in my opinion.
The author Jacob is very pro-active and extremely helpful, resolving issues very quickly.
Highly recommended plugin.

![](https://secure.gravatar.com/avatar/30428ad8f0e641e6260e55f8fbc9c84bd55890e76427d96089742e463c5884e6?s=60&d=retro&r=g)
### [Too heavy](https://wordpress.org/support/topic/too-heavy-3/)

[Oleksandra](https://profiles.wordpress.org/fanficcomua/ "Posts by Oleksandra")
May 10, 2023

Plugin is great and really powerful with lots of settings. But it ”eats” a lot of memory so other plugins stopped working. I do not need all those numerous settings, I just need a gallery with possibility for users to download and comment pictures from frontend, so I decided to look for another decision. I`ve made contribution in translating this plugin into Ukrainian. Wish you luck 🙂

![](https://secure.gravatar.com/avatar/5b45630b6bd40a1f6d695fe8fb9ff0a18bef54f1653380bdaad6f01f6cc266ef?s=60&d=retro&r=g)
### [Best plugin out there.](https://wordpress.org/support/topic/best-plugin-out-there-16/)

[qnkov](https://profiles.wordpress.org/qnkov/ "Posts by qnkov")
December 20, 2021

The plugin is amazing. It has a lot of options.

![](https://secure.gravatar.com/avatar/6d61fdcd404c4cba26db44e0eb7490b869067b0864e1f1d4365caae9cd5eba81?s=60&d=retro&r=g)
### [Great plugin with lots of functionality, great support too!](https://wordpress.org/support/topic/great-plugin-with-lots-of-functionality-great-support-too/)

[mwschaff](https://profiles.wordpress.org/mwschaff/ "Posts by mwschaff")
October 2, 2021

I wanted to display my photo on my website by allowing users to select an album with photos grouped by category (B&W, Landscape, People, etc.) from which they would see a gallery of thumbnails of all the images. By clicking on the thumbnail they could see a larger version of the image. Finally, if they are interested in buying the image they can click on the large version which takes them to my third-party order fulfillment site. WP Photo Album Plus was the only plugin the could provide this type of functionality that I could find. It works great. The developer, Jacob N. Breetvelt, is very responsive and helpful also if there is ever an issue or question. I highly recommend this plugin.

![](https://secure.gravatar.com/avatar/e9f82f61404be3d304c026c554518c4be69a7ae18bf7baf437fd6f3ec3dbe7d3?s=60&d=retro&r=g)
### [Great tool!](https://wordpress.org/support/topic/great-tool-1566/)

[sbuwp](https://profiles.wordpress.org/sbuwp/ "Posts by sbuwp")
March 14, 2021

I use WP Photo Album Plus for the presentation of historical postcards. It is a fantastically powerful tool with a lot of possibilities. Especially the mass import of images with the corresponding data as CSV file were crucial for me. But the other functions are also impressive with very many setting options.
Furthermore, the very fast support for questions of understanding or also function extensions is extremely good. Many thanks to Jakob and the other supporters.

![](https://secure.gravatar.com/avatar/cb1d3868172e2246a38624f1280c87257f6d7200ffa4ccea2ab3e454e3a9db89?s=60&d=retro&r=g)
### [What a wonderful plugin!](https://wordpress.org/support/topic/what-a-wonderful-plugin-4/)

[mlecat](https://profiles.wordpress.org/mlecat/ "Posts by mlecat")
March 2, 2021

Already 6000 albums and nearly 50000 photos in my website and it works perfectly, and “cherry on the cake” the support is very responsive and open to changes.
Great plugin, great developer.

[Read all 200 reviews](https://wordpress.org/support/plugin/wp-photo-album-plus/reviews/)
## Contributors & Developers

“WP Photo Album Plus” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/81eca39d669a1a7e80934482324451aebd4794adf6b438617cd5bd4f9162eaf4?s=32&d=mm&r=g) [Jacob N. Breetvelt](https://profiles.wordpress.org/opajaap/)

“WP Photo Album Plus” has been translated into 14 locales. Thank you to [the translators](https://translate.wordpress.org/projects/wp-plugins/wp-photo-album-plus/contributors) for their contributions.

[Translate “WP Photo Album Plus” into your language.](https://translate.wordpress.org/projects/wp-plugins/wp-photo-album-plus)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/wp-photo-album-plus/), check out the [SVN repository](https://plugins.svn.wordpress.org/wp-photo-album-plus/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/wp-photo-album-plus/) by [RSS](https://plugins.trac.wordpress.org/log/wp-photo-album-plus/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

See for the full changelog: [The documentation website](http://www.wppa.nl/changelog/)

## Meta

* Version **8.9.02.005**
* Last updated **3 weeks ago**
* Active installations **10,000+**
* WordPress version **6.0 or higher**
* Tested up to **6.7.1**
* PHP version **5.5 or higher**
* Languages
  See all 15

  Close

  [Czech](https://cs.wordpress.org/plugins/wp-photo-album-plus/), [Dutch](https://nl.wordpress.org/plugins/wp-photo-album-plus/), [English (Australia)](https://en-au.wordpress.org/plugins/wp-photo-album-plus/), [English (Canada)](https://en-ca.wordpress.org/plugins/wp-photo-album-plus/), [English (New Zealand)](https://en-nz.wordpress.org/plugins/wp-photo-album-plus/), [English (South Africa)](https://en-za.wordpress.org/plugins/wp-photo-album-plus/), [English (UK)](https://en-gb.wordpress.org/plugins/wp-photo-album-plus/), [English (US)](https://wordpress.org/plugins/wp-photo-album-plus/), [French (France)](https://fr.wordpress.org/plugins/wp-photo-album-plus/), [German](https://de.wordpress.org/plugins/wp-photo-album-plus/), [Italian](https://it.wordpress.org/plugins/wp-photo-album-plus/), [Korean](https://ko.wordpress.org/plugins/wp-photo-album-plus/), [Portuguese (Brazil)](https://br.wordpress.org/plugins/wp-photo-album-plus/), [Russian](https://ru.wordpress.org/plugins/wp-photo-album-plus/), and [Swedish](https://sv.wordpress.org/plugins/wp-photo-album-plus/).

  [Translate into your language](https://translate.wordpress.org/projects/wp-plugins/wp-photo-album-plus)
* Tags [audio](https://wordpress.org/plugins/tags/audio/)[lightbox](https://wordpress.org/plugins/tags/lightbox/)[pdf](https://wordpress.org/plugins/tags/pdf/)[photo](https://wordpress.org/plugins/tags/photo/)[video](https://wordpress.org/plugins/tags/video/)
* [Advanced View](https://wordpress.org/plugins/wp-photo-album-plus/advanced/)

## Ratings

4.6 out of 5 stars.

* [171 5-star reviews
  5 stars

  171](https://wordpress.org/support/plugin/wp-photo-album-plus/reviews/?filter=5)
* [12 4-star reviews
  4 stars

  12](https://wordpress.org/support/plugin/wp-photo-album-plus/reviews/?filter=4)
* [2 3-star reviews
  3 stars

  2](https://wordpress.org/support/plugin/wp-photo-album-plus/reviews/?filter=3)
* [2 2-star reviews
  2 stars

  2](https://wordpress.org/support/plugin/wp-photo-album-plus/reviews/?filter=2)
* [12 1-star reviews
  1 star

  12](https://wordpress.org/support/plugin/wp-photo-album-plus/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/wp-photo-album-plus/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/wp-photo-album-plus/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/81eca39d669a1a7e80934482324451aebd4794adf6b438617cd5bd4f9162eaf4?s=32&d=mm&r=g) [Jacob N. Breetvelt](https://profiles.wordpress.org/opajaap/)
## Support

Issues resolved in last two months:

10 out of 15

[View support forum](https://wordpress.org/support/plugin/wp-photo-album-plus/)

## Donate

Would you like to support the advancement of this plugin?

[Donate to this plugin](https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=OpaJaap@OpaJaap.nl&item_name=WP-Photo-Album-Plus&item_number=Support-Open-Source&currency_code=USD&lc=US)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_ad90cb5b_20250114_212641.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-photo-album-plus%2Ftags%2F8.8.08.004%2Fwppa-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-photo-album-plus/trunk/wppa-ajax.php?rev=3157714 "Revision 3157714")
* [Next Revision](/browser/wp-photo-album-plus/trunk/wppa-ajax.php?rev=3184388 "Revision 3184388") →
* [Blame](/browser/wp-photo-album-plus/trunk/wppa-ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-photo-album-plus/tags/8.8.08.004/wppa-ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-photo-album-plus](/browser/wp-photo-album-plus?order=name "View wp-photo-album-plus")/[tags](/browser/wp-photo-album-plus/tags?order=name "View tags")/[8.8.08.004](/browser/wp-photo-album-plus/tags/8.8.08.004?order=name "View 8.8.08.004")/[wppa-ajax.php](/browser/wp-photo-album-plus/tags/8.8.08.004/wppa-ajax.php?order=name "View wppa-ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3172876/wp-photo-album-plus/trunk/wppa-ajax.php "View differences") on this file was [3172876](/changeset/3172876/ "View changeset 3172876"), checked in by opajaap, [3 months ago](/timeline?from=2024-10-21T11%3A51%3A09Z&precision=second "See timeline at 10/21/2024 11:51:09 AM") |
| --- |
| 8.8.08.001 |
| **File size:** 148.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* wppa-ajax.php |
| [3](#L3) | \* |
| [4](#L4) | \* Functions used in ajax requests |
| [5](#L5) | \* Version: 8.8.08.001 |
| [6](#L6) | \* |
| [7](#L7) | \*/ |
| [8](#L8) |  |
| [9](#L9) | if ( ! defined( 'ABSPATH' ) ) die( "Can't load this file directly" ); |
| [10](#L10) |  |
| [11](#L11) | // Load admin-ajax.php if wppa\_ajax is in query args |
| [12](#L12) | function wppa\_ajax\_include() { |
| [13](#L13) | global $wp\_query; |
| [14](#L14) |  |
| [15](#L15) | if ( $wp\_query->get( 'wppa\_ajax' ) === '1' ) { |
| [16](#L16) | include\_once ABSPATH . '/wp-admin/admin-ajax.php'; |
| [17](#L17) | exit; |
| [18](#L18) | } |
| [19](#L19) | } |
| [20](#L20) | add\_action( 'template\_redirect', 'wppa\_ajax\_include' ); |
| [21](#L21) |  |
| [22](#L22) | // Add rewrite rule |
| [23](#L23) | function wppa\_ajax\_rewrite\_rule() { |
| [24](#L24) |  |
| [25](#L25) | add\_rewrite\_rule( 'wppaajax/?$', 'index.php?wppa\_ajax=1', 'top' ); |
| [26](#L26) | $rewrite\_rules = wppa\_get\_option( 'rewrite\_rules', array() ); |
| [27](#L27) | if ( ! is\_array( $rewrite\_rules ) || ! in\_array( 'index.php?wppa\_ajax=1', $rewrite\_rules ) ) { |
| [28](#L28) | flush\_rewrite\_rules(); |
| [29](#L29) | } |
| [30](#L30) | } |
| [31](#L31) | add\_action( 'init', 'wppa\_ajax\_rewrite\_rule' ); |
| [32](#L32) |  |
| [33](#L33) | // Add wppa\_ajax to query vars |
| [34](#L34) | function wppa\_ajax\_query\_vars( $query\_vars ) { |
| [35](#L35) |  |
| [36](#L36) | $query\_vars[] = 'wppa\_ajax'; |
| [37](#L37) | return $query\_vars; |
| [38](#L38) | } |
| [39](#L39) | add\_filter( 'query\_vars', 'wppa\_ajax\_query\_vars' ); |
| [40](#L40) |  |
| [41](#L41) | // Link ajax callback function |
| [42](#L42) | add\_action( 'wp\_ajax\_wppa', 'wppa\_ajax\_callback' ); |
| [43](#L43) | add\_action( 'wp\_ajax\_nopriv\_wppa', 'wppa\_ajax\_callback' ); |
| [44](#L44) |  |
| [45](#L45) | function wppa\_ajax\_callback() { |
| [46](#L46) | global $wpdb; |
| [47](#L47) | global $wppa\_session; |
| [48](#L48) | global $wppa\_log\_file; |
| [49](#L49) | global $wppa\_opt; |
| [50](#L50) | global $wppa; |
| [51](#L51) | global $wppa\_url\_set\_extension; |
| [52](#L52) |  |
| [53](#L53) | wppa( 'ajax', true ); |
| [54](#L54) | if ( ! defined( 'DOING\_WPPA\_AJAX' ) ) { |
| [55](#L55) | define( 'DOING\_WPPA\_AJAX', true ); |
| [56](#L56) | } |
| [57](#L57) | wppa( 'error', '0' ); |
| [58](#L58) | wppa( 'out', '' ); |
| [59](#L59) | if ( ! isset( $wppa\_session['page'] ) ) { |
| [60](#L60) | //              wppa\_begin\_session(); |
| [61](#L61) | } |
| [62](#L62) | if ( ! isset( $wppa\_session['page'] ) ) { |
| [63](#L63) | $wppa\_session['page'] = '0'; |
| [64](#L64) | $wppa\_session['ajax'] = '0'; |
| [65](#L65) | } |
| [66](#L66) | $wppa\_session['page']--; |
| [67](#L67) | $wppa\_session['ajax']++; |
| [68](#L68) |  |
| [69](#L69) | $wppa\_action = wppa\_get( 'action' ); |
| [70](#L70) |  |
| [71](#L71) | if ( wppa\_switch( 'log\_ajax' ) && wppa\_get( 'action' ) != 'heartbeat' && wppa\_get( 'option' ) != 'heartbeat' ) { |
| [72](#L72) | $dummy = wp\_verify\_nonce( 'dummy-code', 'dummy-action' ); // Just to satisfy Plugin Check |
| [73](#L73) | wppa\_log( 'ajax', 'Script = ' . basename( wppa\_script\_filename() ) ); // . ', Args = ' . var\_export($\_REQUEST,true) ); |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | /\* |
| [77](#L77) | // Any runtime modifyable settings? |
| [78](#L78) | foreach( array\_keys( $\_GET ) as $key ) { |
| [79](#L79) | $value = isset( $\_GET[$key] ) ? sanitize\_text\_field( wp\_unslash( $\_GET[$key] ) ) : ''; |
| [80](#L80) | if ( ! substr( $key, 0, 5 ) == 'wppa\_' ) { |
| [81](#L81) | if ( isset( $wppa[$key] ) ) { |
| [82](#L82) | $wppa[$key] = $value; |
| [83](#L83) | wppa\_log('war', 'Unexpected setting in ajax: $wppa['.$key.'] set to '.$value); |
| [84](#L84) | } |
| [85](#L85) | else { |
| [86](#L86) | $key = 'wppa\_' . $key; |
| [87](#L87) | } |
| [88](#L88) | } |
| [89](#L89) | } |
| [90](#L90) | \*/ |
| [91](#L91) | // Interprete encrypted wppa\_set settings |
| [92](#L92) | wppa\_decrypt\_set(); |
| [93](#L93) |  |
| [94](#L94) | switch ( $wppa\_action ) { |
| [95](#L95) | case 'log': |
| [96](#L96) | if ( ! wppa\_get( 'message' ) ) wppa\_exit(); |
| [97](#L97) | wppa\_log( 'cli', wppa\_get( 'message' ) ); |
| [98](#L98) | wppa\_exit(); |
| [99](#L99) | break; |
| [100](#L100) | case 'mailinglist': |
| [101](#L101) |  |
| [102](#L102) | // Sanitize input |
| [103](#L103) | $nonce          = wppa\_get( 'ntfy-nonce' ); |
| [104](#L104) | $crypt          = wppa\_get( 'crypt' ); |
| [105](#L105) | $list\_type      = wppa\_get( 'list' ); |
| [106](#L106) | $onoff          = wppa\_get( 'onoff' ); |
| [107](#L107) | $user\_id        = wppa\_get( 'user' ); |
| [108](#L108) |  |
| [109](#L109) | // If not loggedin, send message and quit |
| [110](#L110) | if ( ! is\_user\_logged\_in() ) { |
| [111](#L111) | wppa\_email\_quit\_message( \_\_( 'You must be loggedin to unsubscribe from a mailinglist', 'wp-photo-album-plus' ), 'red' ); |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | // If can not edit email subscriptions, can only change self |
| [115](#L115) | if ( ! current\_user\_can( 'wppa\_edit\_email' ) || ! $user\_id ) { |
| [116](#L116) | if ( $user\_id != wppa\_get\_user( 'id' ) ) { |
| [117](#L117) | wppa\_email\_quit\_message( \_\_( 'You can only unsubscribe yourself from a mailinglist', 'wp-photo-album-plus' ), 'red' ); |
| [118](#L118) | } |
| [119](#L119) | } |
| [120](#L120) |  |
| [121](#L121) | // From edit\_email admin page or dashboard widget? |
| [122](#L122) | if ( $nonce ) { |
| [123](#L123) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-ntfy-nonce' ) ) { |
| [124](#L124) | wppa\_secfail( '80' ); |
| [125](#L125) | } |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | // From email unsubscribe link |
| [129](#L129) | elseif ( $crypt ) { |
| [130](#L130) | $user = get\_user\_by( 'ID', $user\_id ); |
| [131](#L131) | if ( $user ) { |
| [132](#L132) | if ( $crypt != crypt( $list\_type . $user->ID . $user->login\_name, $user->display\_name ) ) { |
| [133](#L133) | wppa\_secfail( '81' ); // Crypt tampered |
| [134](#L134) | } |
| [135](#L135) | } |
| [136](#L136) | else { // No existing user |
| [137](#L137) | wppa\_secfail( '83' ); // Should never get here |
| [138](#L138) | } |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | // From nothing valid |
| [142](#L142) | else { |
| [143](#L143) | wppa\_secfail( '82' ); |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | // Existing list type? |
| [147](#L147) | if ( ! in\_array( $list\_type, array( 'newalbumnotify', |
| [148](#L148) | 'feuploadnotify', |
| [149](#L149) | 'photoapproved', |
| [150](#L150) | 'commentnotify', |
| [151](#L151) | 'commentapproved', |
| [152](#L152) | 'commentprevious', |
| [153](#L153) | 'moderatephoto', |
| [154](#L154) | 'moderatecomment', |
| [155](#L155) | 'subscribenotify', |
| [156](#L156) | ) ) ) { |
| [157](#L157) | wppa\_email\_quit\_message( \_\_( 'Requested mailinglist does not exist', 'wp-photo-album-plus' ), 'red' ); |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | // On/Off valid? |
| [161](#L161) | if ( ! in\_array( $onoff, array( 'on', 'off' ) ) ) { |
| [162](#L162) | wppa\_email\_quit\_message( \_\_( 'Invalid data found', 'wp-photo-album-plus' ), 'red' ); |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | // Prepare additional data |
| [166](#L166) | $mailinglist    = wppa\_get\_option( 'wppa\_mailinglist\_' . $list\_type, '' ); |
| [167](#L167) | $userarray              = wppa\_index\_string\_to\_array( $mailinglist ); |
| [168](#L168) |  |
| [169](#L169) | $email\_types = array( |
| [170](#L170) | 'newalbumnotify'        => \_\_('New album', 'wp-photo-album-plus'), |
| [171](#L171) | 'feuploadnotify'        => \_\_('Upload', 'wp-photo-album-plus'), |
| [172](#L172) | 'commentnotify'         => \_\_('Comment', 'wp-photo-album-plus'), |
| [173](#L173) | 'commentprevious'       => \_\_('Comment previous', 'wp-photo-album-plus'), |
| [174](#L174) | 'moderatephoto'         => \_\_('Moderate photo', 'wp-photo-album-plus'), |
| [175](#L175) | 'moderatecomment'       => \_\_('Moderate comment', 'wp-photo-album-plus'), |
| [176](#L176) | 'photoapproved'         => \_\_('Photo approved', 'wp-photo-album-plus'), |
| [177](#L177) | 'commentapproved'       => \_\_('Comment approved', 'wp-photo-album-plus'), |
| [178](#L178) | 'subscribenotify'       => \_\_('Subscribe/unsubscribe', 'wp-photo-album-plus'), |
| [179](#L179) | ); |
| [180](#L180) |  |
| [181](#L181) | // Dispatch on list type |
| [182](#L182) | switch( $list\_type ) { |
| [183](#L183) | case 'newalbumnotify': |
| [184](#L184) | case 'feuploadnotify': |
| [185](#L185) | case 'photoapproved': |
| [186](#L186) | case 'commentnotify': |
| [187](#L187) | case 'commentapproved': |
| [188](#L188) | case 'commentprevious': |
| [189](#L189) | case 'moderatephoto': |
| [190](#L190) | case 'moderatecomment': |
| [191](#L191) | case 'subscribenotify': |
| [192](#L192) |  |
| [193](#L193) | if ( $onoff == 'on' ) { |
| [194](#L194) | $userarray[] = $user\_id; |
| [195](#L195) | /\* translators: mailing list name \*/ |
| [196](#L196) | $msg = sprintf( \_\_( 'You have been added to mailinglist %s', 'wp-photo-album-plus' ), $email\_types[$list\_type] ); |
| [197](#L197) | } |
| [198](#L198) | else { |
| [199](#L199) | $userarray = array\_diff( $userarray, array( $user\_id ) ); |
| [200](#L200) | /\* translators: mailing list name \*/ |
| [201](#L201) | $msg = sprintf( \_\_( 'You have been removed from mailinglist %s', 'wp-photo-album-plus' ), $email\_types[$list\_type] ); |
| [202](#L202) | } |
| [203](#L203) | $mailinglist = wppa\_index\_array\_to\_string( $userarray ); |
| [204](#L204) |  |
| [205](#L205) | update\_option( 'wppa\_mailinglist\_' . $list\_type, $mailinglist ); |
| [206](#L206) | wppa\_schedule\_mailinglist( 'subscribenotify', $list\_type, $user\_id, $onoff, 0, 0, 5 ); |
| [207](#L207) |  |
| [208](#L208) | // If unsubscribe link from email. format and send output |
| [209](#L209) | if ( $crypt ) { |
| [210](#L210) | wppa\_email\_quit\_message( $msg, 'green' ); |
| [211](#L211) | } |
| [212](#L212) | break; |
| [213](#L213) |  |
| [214](#L214) | default: |
| [215](#L215) |  |
| [216](#L216) | $msg = \_\_( 'Requested mailinglist is not implemented', 'wp-photo-album-plus' ); |
| [217](#L217) | if ( $crypt ) { |
| [218](#L218) | wppa\_email\_quit\_message( $msg, 'red' ); |
| [219](#L219) | } |
| [220](#L220) | break; |
| [221](#L221) | } |
| [222](#L222) | wppa\_exit(); |
| [223](#L223) | break; |
| [224](#L224) | case 'delexportzips': |
| [225](#L225) | $dir = WPPA\_DEPOT\_PATH; |
| [226](#L226) | $files = wppa\_glob( $dir . '/\*.zip' ); |
| [227](#L227) | if ( $files ) { |
| [228](#L228) | foreach( $files as $file ) { |
| [229](#L229) | wppa\_unlink( $file ); |
| [230](#L230) | $id = substr( wppa\_strip\_ext( basename( $file ) ), 6 ); |
| [231](#L231) | $usr = wppa\_get\_user(); |
| [232](#L232) | $tr = "wppa-album-$id-last-export-$usr"; |
| [233](#L233) | delete\_transient( $tr ); |
| [234](#L234) | } |
| [235](#L235) | } |
| [236](#L236) | wppa\_exit(); |
| [237](#L237) | break; |
| [238](#L238) | case 'getqrcode': |
| [239](#L239) | $nonce  = wppa\_get( 'qr-nonce' ); |
| [240](#L240) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-qr-nonce' ) ) { |
| [241](#L241) | die( 'Security check failure' ); |
| [242](#L242) | } |
| [243](#L243) | $url = wppa\_get( 'url' ); |
| [244](#L244) | $result = wppa\_create\_qrcode\_cache( $url, wppa\_opt( 'qr\_size' ) ); |
| [245](#L245) | wppa\_echo( wp\_json\_encode( ['txt' => $result . '|' . wppa\_convert\_to\_pretty( $url )] ) ); |
| [246](#L246) | wppa\_exit(); |
| [247](#L247) | break; |
| [248](#L248) | case 'gettogo': |
| [249](#L249) | $slug   =       wppa\_get( 'slug' ); |
| [250](#L250) | $result =       wppa\_get\_option( $slug . '\_togo', '' ) . |
| [251](#L251) | '|' . |
| [252](#L252) | wppa\_get\_option( $slug . '\_status', '' ); |
| [253](#L253) | wppa\_echo( $result ); |
| [254](#L254) | if ( wppa\_get\_option( $slug . '\_status', '' ) == \_\_( 'Ready', 'wp-photo-album-plus' ) ) { |
| [255](#L255) | delete\_option( $slug . '\_status' ); |
| [256](#L256) | } |
| [257](#L257) | wppa\_exit(); |
| [258](#L258) | break; |
| [259](#L259) |  |
| [260](#L260) | case 'getssiptclist': |
| [261](#L261) | $tag            = ''; |
| [262](#L262) | $mocc           = '1'; |
| [263](#L263) | $oldvalue       = ''; |
| [264](#L264) |  |
| [265](#L265) | $tag    = str\_replace( 'H', '#', wppa\_get( 'iptctag' ) ); |
| [266](#L266) | $mocc   = wppa\_get( 'occur' ); |
| [267](#L267) |  |
| [268](#L268) | if ( strpos( $wppa\_session['supersearch'], ',' ) !== false ) { |
| [269](#L269) | $ss\_data = explode( ',', $wppa\_session['supersearch'] ); |
| [270](#L270) | if ( count( $ss\_data ) == '4' ) { |
| [271](#L271) | if ( $ss\_data['0'] == 'p' ) { |
| [272](#L272) | if ( $ss\_data['1'] == 'i' ) { |
| [273](#L273) | if ( $ss\_data['2'] == wppa\_get( 'iptctag' ) ) { |
| [274](#L274) | $oldvalue = $ss\_data['3']; |
| [275](#L275) | } |
| [276](#L276) | } |
| [277](#L277) | } |
| [278](#L278) | } |
| [279](#L279) | } |
| [280](#L280) | $query          = $wpdb->prepare( "SELECT DISTINCT description FROM $wpdb->wppa\_iptc WHERE photo > 0 AND tag = %s ORDER BY description", $tag ); |
| [281](#L281) | $iptcdata       = wppa\_get\_results( $query ); |
| [282](#L282) | $last           = ''; |
| [283](#L283) | $any            = false; |
| [284](#L284) | $result         = ''; |
| [285](#L285) | if ( is\_array( $iptcdata ) ) foreach( $iptcdata as $item ) { |
| [286](#L286) | $desc = sanitize\_text\_field( $item['description'] ); |
| [287](#L287) |  |
| [288](#L288) | if ( $desc != $last ) { |
| [289](#L289) | $sel = ( $oldvalue && $oldvalue == $desc ) ? 'selected' : ''; |
| [290](#L290) | if ( $sel ) $result .= 'selected:' . $oldvalue; |
| [291](#L291) | $ddesc = strlen( $desc ) > '32' ? substr( $desc, 0, 30 ) . '...' : $desc; |
| [292](#L292) | $result .=      ' |
| [293](#L293) | <option |
| [294](#L294) | value="' . esc\_attr( $desc ) . '" |
| [295](#L295) | class="wppa-iptclist-' . $mocc . '" ' . |
| [296](#L296) | $sel . ' |
| [297](#L297) | >' . |
| [298](#L298) | $ddesc . ' |
| [299](#L299) | </option>'; |
| [300](#L300) | $last = $desc; |
| [301](#L301) | $any = true; |
| [302](#L302) | } |
| [303](#L303) | } |
| [304](#L304) | if ( ! $any ) { |
| [305](#L305) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_iptc SET status = 'hide' WHERE photo = 0 AND tag = %s", $tag ); |
| [306](#L306) | wppa\_query( $query ); |
| [307](#L307) | } |
| [308](#L308) | wppa\_echo( wp\_json\_encode( ['txt' => $result] ) ); |
| [309](#L309) | wppa\_exit(); |
| [310](#L310) | break; |
| [311](#L311) |  |
| [312](#L312) | case 'getssexiflist': |
| [313](#L313) |  |
| [314](#L314) | $tag            = ''; |
| [315](#L315) | $brand          = ''; |
| [316](#L316) | $mocc           = '1'; |
| [317](#L317) | $oldvalue       = ''; |
| [318](#L318) | $ss\_data        = array(); |
| [319](#L319) | $result         = ''; |
| [320](#L320) |  |
| [321](#L321) | $tag    = str\_replace( 'H', '#', substr( wppa\_get( 'exiftag' ), 0, 6 ) ); |
| [322](#L322) | $brand  = substr( wppa\_get( 'exiftag' ), 6 ); |
| [323](#L323) | $mocc   = wppa\_get( 'occur' ); |
| [324](#L324) |  |
| [325](#L325) | if ( strpos( $wppa\_session['supersearch'], ',' ) !== false ) { |
| [326](#L326) | $data = explode( ',', $wppa\_session['supersearch'] ); |
| [327](#L327) | if ( count( $data ) >= '4' ) { |
| [328](#L328) |  |
| [329](#L329) | // Value may contain commas |
| [330](#L330) | for ( $i=0; $i<3; $i++ ){ |
| [331](#L331) | $ss\_data[$i] = $data[$i]; |
| [332](#L332) | unset( $data[$i] ); |
| [333](#L333) | } |
| [334](#L334) | $ss\_data[3] = implode( ',', $data ); |
| [335](#L335) |  |
| [336](#L336) | if ( $ss\_data['0'] == 'p' ) { |
| [337](#L337) | if ( $ss\_data['1'] == 'e' ) { |
| [338](#L338) | if ( $ss\_data['2'] == wppa\_get( 'exiftag' ) ) { |
| [339](#L339) | $oldvalue = $ss\_data['3']; |
| [340](#L340) | } |
| [341](#L341) | } |
| [342](#L342) | } |
| [343](#L343) | } |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | if ( $brand ) { |
| [347](#L347) | $query = $wpdb->prepare( "SELECT DISTINCT f\_description |
| [348](#L348) | FROM $wpdb->wppa\_exif |
| [349](#L349) | WHERE photo > 0 |
| [350](#L350) | AND tag = %s |
| [351](#L351) | AND brand = %s |
| [352](#L352) | AND f\_description <> '' |
| [353](#L353) | ORDER BY f\_description", $tag, $brand ); |
| [354](#L354) | $exifdata = wppa\_get\_results( $query ); |
| [355](#L355) | } |
| [356](#L356) | else { |
| [357](#L357) | $query = $wpdb->prepare( "SELECT DISTINCT f\_description |
| [358](#L358) | FROM $wpdb->wppa\_exif |
| [359](#L359) | WHERE photo > 0 |
| [360](#L360) | AND tag = %s |
| [361](#L361) | AND f\_description <> '' |
| [362](#L362) | ORDER BY f\_description", $tag ); |
| [363](#L363) | $exifdata = wppa\_get\_results( $query ); |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | // Make the data sortable. |
| [367](#L367) | foreach ( array\_keys( $exifdata ) as $key ) { |
| [368](#L368) | $temp = $exifdata[$key]['f\_description']; |
| [369](#L369) | $temp = trim( $temp, ' smf/.px' ); |
| [370](#L370) |  |
| [371](#L371) | if ( strpos( $temp, '/' ) ) { |
| [372](#L372) |  |
| [373](#L373) | $t = explode( '/', $temp ); |
| [374](#L374) | if ( count( $t ) == 2 && is\_numeric( $t[0] ) && is\_numeric( $t[1] ) ) { |
| [375](#L375) | $temp = $t; |
| [376](#L376) | if ( $temp[1] != 0 ) { |
| [377](#L377) | $temp = $temp[0] / $temp[1]; |
| [378](#L378) | } |
| [379](#L379) | else { |
| [380](#L380) | $temp = 999999; |
| [381](#L381) | } |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) | } |
| [385](#L385) | if ( is\_numeric( $temp ) ) { |
| [386](#L386) | $exifdata[$key]['sort'] = sprintf( '%020.12f', $temp ); |
| [387](#L387) | } |
| [388](#L388) | else { |
| [389](#L389) | $exifdata[$key]['sort'] = $exifdata[$key]['f\_description']; |
| [390](#L390) | } |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | // Sort |
| [394](#L394) | $exifdata = wppa\_array\_sort( $exifdata, 'sort' ); |
| [395](#L395) |  |
| [396](#L396) | // Make the selectionbox content |
| [397](#L397) | $any            = false; |
| [398](#L398) | if ( ! empty( $exifdata ) ) foreach( $exifdata as $item ) { |
| [399](#L399) | $desc = sanitize\_text\_field( $item['f\_description'] ); |
| [400](#L400) |  |
| [401](#L401) | if ( $desc ) { |
| [402](#L402) |  |
| [403](#L403) | $sel = ( $oldvalue && $oldvalue == $desc ) ? 'selected' : ''; |
| [404](#L404) | $ddesc = strlen( $desc ) > '42' ? substr( $desc, 0, 40 ) . '...' : $desc; |
| [405](#L405) | if ( wppa\_is\_valid\_rational( $ddesc, false  ) ) { |
| [406](#L406) | $t = explode( '/', $ddesc ); |
| [407](#L407) | $l = strlen( $ddesc ); |
| [408](#L408) | $ddesc = '(' . sprintf( '%5.2f', $t[0]/$t[1] ) . ') ' . $ddesc; |
| [409](#L409) | } |
| [410](#L410) |  |
| [411](#L411) | $result .= ' |
| [412](#L412) | <option |
| [413](#L413) | value="' . esc\_attr( $desc ) . '" |
| [414](#L414) | class="wppa-exiflist-' . $mocc . '" ' . |
| [415](#L415) | $sel . ' |
| [416](#L416) | >' . |
| [417](#L417) | $ddesc . ' |
| [418](#L418) | </option>'; |
| [419](#L419) | $any = true; |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | // Cleanup possible unused label |
| [424](#L424) | if ( ! $any ) { |
| [425](#L425) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_exif |
| [426](#L426) | SET status = 'hide' |
| [427](#L427) | WHERE photo = 0 |
| [428](#L428) | AND tag = %s", $tag ); |
| [429](#L429) | wppa\_query( $query ); |
| [430](#L430) | } |
| [431](#L431) | wppa\_echo( wp\_json\_encode( ['txt' => $result] ) ); |
| [432](#L432) | wppa\_exit(); |
| [433](#L433) | break; |
| [434](#L434) |  |
| [435](#L435) | case 'front-edit':                              // Fetch the html for edit dialog |
| [436](#L436) |  |
| [437](#L437) | // Is the call valid? |
| [438](#L438) | $photo = wppa\_get( 'photo-id' ); |
| [439](#L439) | if ( ! $photo ) { |
| [440](#L440) | $txt = 'Missing required argument'; |
| [441](#L441) | } |
| [442](#L442) | else { |
| [443](#L443) |  |
| [444](#L444) | // Is this user allowed to edit thisphoto? |
| [445](#L445) | $ok = wppa\_may\_user\_fe\_edit( $photo ); |
| [446](#L446) |  |
| [447](#L447) | if ( $ok ) { |
| [448](#L448) |  |
| [449](#L449) | // Do it |
| [450](#L450) | require\_once 'wppa-photo-admin-autosave.php'; |
| [451](#L451) |  |
| [452](#L452) | $txt = wppa\_fe\_edit\_photo( $photo ); |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | // No rights |
| [456](#L456) | else { |
| [457](#L457) | $txt = 'You do not have sufficient rights to do this'; |
| [458](#L458) | } |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | // Done |
| [462](#L462) | echo wp\_json\_encode( ['txt' => $txt] ); |
| [463](#L463) | wppa\_exit(); |
| [464](#L464) | break; |
| [465](#L465) |  |
| [466](#L466) | case 'update-photo-new':                        // Do the actual edit update |
| [467](#L467) |  |
| [468](#L468) | // Init updatable fields |
| [469](#L469) | $fields = array(); |
| [470](#L470) | $error = ''; |
| [471](#L471) |  |
| [472](#L472) | // Get photo id |
| [473](#L473) | $photo = wppa\_get( 'photo-id' ); |
| [474](#L474) |  |
| [475](#L475) | // Is the call valid? |
| [476](#L476) | $nonce  = wppa\_get( 'nonce' ); |
| [477](#L477) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce-' . $photo ) ) { |
| [478](#L478) | wppa\_log( 'Misc', 'nonce failed on ' . $wppa\_action ); |
| [479](#L479) | $error = \_\_( 'Security check falure', 'wp-photo-album-plus' ); |
| [480](#L480) | } |
| [481](#L481) | if ( ! $photo ) { |
| [482](#L482) | $error = \_\_( 'Missing required argument', 'wp-photo-album-plus' ); |
| [483](#L483) | } |
| [484](#L484) | if ( ! wppa\_may\_user\_fe\_edit( $photo ) ) { |
| [485](#L485) | $error = \_\_( 'Insufficient accessrights', 'wp-photo-album-plus' ); |
| [486](#L486) | } |
| [487](#L487) |  |
| [488](#L488) | // Reload after? |
| [489](#L489) | if ( wppa\_get( 'upn-reload', '', 'text' ) ) { |
| [490](#L490) | set\_transient( 'wppa\_rela\_' . wppa\_get\_user(), 'on', MONTH\_IN\_SECONDS ); |
| [491](#L491) | } |
| [492](#L492) | else { |
| [493](#L493) | set\_transient( 'wppa\_rela\_' . wppa\_get\_user(), 'off', MONTH\_IN\_SECONDS ); |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | // If no error proceed |
| [497](#L497) | if ( ! $error ) { |
| [498](#L498) |  |
| [499](#L499) | // Name |
| [500](#L500) | if ( wppa\_get( 'upn-name' ) ) { |
| [501](#L501) | $name = wppa\_get( 'upn-name' ); |
| [502](#L502) | $old\_name = wppa\_get\_photo\_item( $photo, 'name' ); |
| [503](#L503) | if ( $name != $old\_name ) { |
| [504](#L504) | $fields['name'] = $name; |
| [505](#L505) | } |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | // Description |
| [509](#L509) | if ( wppa\_get( 'upn-description' ) ) { |
| [510](#L510) | $desc = wppa\_get( 'upn-description' ); |
| [511](#L511) | $old\_desc = wppa\_get\_photo\_item( $photo, 'description' ); |
| [512](#L512) | if ( $desc != $old\_desc ) { |
| [513](#L513) | $fields['description'] = $desc; |
| [514](#L514) | } |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | // Tags |
| [518](#L518) | if ( wppa\_get( 'upn-tags' ) ) { |
| [519](#L519) | $tags = wppa\_get( 'upn-tags' ); |
| [520](#L520) | $old\_tags = wppa\_get\_photo\_item( $photo, 'tags' ); |
| [521](#L521) | if ( $tags != $old\_tags ) { |
| [522](#L522) | $fields['tags'] = $tags; |
| [523](#L523) | } |
| [524](#L524) | } |
| [525](#L525) |  |
| [526](#L526) | // Custom fields |
| [527](#L527) | $custom = wppa\_get\_photo\_item( $photo, 'custom' ); |
| [528](#L528) | $custom\_data = array( '', '', '', '', '', '', '', '', '', '' ); |
| [529](#L529) | if ( $custom ) { |
| [530](#L530) | $custom\_data = wppa\_unserialize( $custom ); |
| [531](#L531) | } |
| [532](#L532) | for ( $i=0;$i<10;$i++ ) { |
| [533](#L533) | if ( wppa\_get( 'custom\_' . $i ) && wppa\_opt( 'custom\_caption\_' . $i ) && wppa\_switch( 'custom\_edit\_' . $i ) ) { |
| [534](#L534) | $custom\_data[$i] = wppa\_get( 'custom\_' . $i ); |
| [535](#L535) | } |
| [536](#L536) | } |
| [537](#L537) | $custom = serialize( $custom\_data ); |
| [538](#L538) | $old\_custom = wppa\_get\_photo\_item( $photo, 'custom' ); |
| [539](#L539) | if ( $custom != $old\_custom ) { |
| [540](#L540) | $fields['custom'] = $custom; |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | // Do the update |
| [544](#L544) | wppa\_update\_photo( $photo, $fields ); |
| [545](#L545) | } |
| [546](#L546) | else { |
| [547](#L547) | $fields['error'] = $error; |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | // Report results back to client |
| [551](#L551) | wppa\_echo( wp\_json\_encode( $fields ) ); |
| [552](#L552) |  |
| [553](#L553) | wppa\_exit(); |
| [554](#L554) | break; |
| [555](#L555) |  |
| [556](#L556) | case 'do-comment': |
| [557](#L557) | $data = isset( $\_POST['data'] ) ? json\_decode( sanitize\_text\_field( wp\_unslash( $\_POST['data'] ) ), true ) : array(); |
| [558](#L558) |  |
| [559](#L559) | if ( is\_array( $data ) ) { |
| [560](#L560) | $\_REQUEST = array\_merge( $\_REQUEST, $data ); |
| [561](#L561) | } |
| [562](#L562) |  |
| [563](#L563) | // Validate args |
| [564](#L564) | $mocc           = wppa\_get( 'occur' ); |
| [565](#L565) | $nonce          = $data['nonce']; //wppa\_get( 'nonce' ); |
| [566](#L566) | $photoid        = wppa\_get( 'photoid' ); |
| [567](#L567) | $commentid      = wppa\_get( 'comid' ); |
| [568](#L568) |  |
| [569](#L569) | // Security check |
| [570](#L570) | if ( wppa\_switch( 'direct\_comment' ) ) { |
| [571](#L571) | if ( ! $photoid || ( wppa\_get\_photo\_item( $photoid, 'album' ) < '1' ) ) { |
| [572](#L572) | wppa\_echo( wp\_json\_encode( ['txt' => esc\_html\_\_( 'Missing or invalid photo id' , 'wp-photo-album-plus' )] ) ); |
| [573](#L573) | wppa\_exit(); |
| [574](#L574) | } |
| [575](#L575) | } |
| [576](#L576) | else { |
| [577](#L577) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-check' ) ) { |
| [578](#L578) | wppa\_echo( wp\_json\_encode( ['txt' => wppa\_secfail( '70', true )] ) ); |
| [579](#L579) | wppa\_exit(); |
| [580](#L580) | } |
| [581](#L581) | if ( ! $photoid || ( wppa\_get\_photo\_item( $photoid, 'album' ) < '1' ) ) { |
| [582](#L582) | wppa\_echo( wp\_json\_encode( ['txt' => wppa\_secfail( '71', true )] ) ); |
| [583](#L583) | wppa\_exit(); |
| [584](#L584) | } |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | // Check login |
| [588](#L588) | if ( ! is\_user\_logged\_in() ) { |
| [589](#L589) | wppa\_echo( wp\_json\_encode( ['txt' => wppa\_secfail( '72', true )] ) ); |
| [590](#L590) | } |
| [591](#L591) |  |
| [592](#L592) | // Check role |
| [593](#L593) | if ( ! wppa\_check\_user\_comment\_role() ) { |
| [594](#L594) | wppa\_echo( wp\_json\_encode( ['txt' => wppa\_secfail( '73', true )] ) ); |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | wppa( 'mocc', $mocc ); |
| [598](#L598) | wppa( 'comment\_photo', $photoid ); |
| [599](#L599) | wppa( 'comment\_id', $commentid ); |
| [600](#L600) |  |
| [601](#L601) | $comment\_allowed = ! wppa\_user\_is\_basic() && is\_user\_logged\_in(); |
| [602](#L602) | if ( wppa\_switch( 'show\_comments' ) && $comment\_allowed ) { |
| [603](#L603) | wppa\_do\_comment( $photoid );            // Process the comment |
| [604](#L604) | if ( wppa\_switch( 'search\_comments' ) ) wppa\_index\_update( 'photo', $photoid ); |
| [605](#L605) | } |
| [606](#L606) | wppa( 'no\_esc', true ); |
| [607](#L607) | $result = wppa\_comment\_html( $photoid, $comment\_allowed ); |
| [608](#L608) | echo( wp\_json\_encode( ['txt' => $result.wppa\_alert\_html()] ) ); // Retrieve the new commentbox content |
| [609](#L609) | wppa\_exit(); |
| [610](#L610) | break; |
| [611](#L611) |  |
| [612](#L612) | case 'import': |
| [613](#L613) |  |
| [614](#L614) | // Check User capability |
| [615](#L615) | if ( ! current\_user\_can( 'wppa\_import' ) ) { |
| [616](#L616) | wppa\_secfail( '91' ); |
| [617](#L617) | } |
| [618](#L618) |  |
| [619](#L619) | // Check nonce |
| [620](#L620) | $nonce = wppa\_get( 'nonce' ); |
| [621](#L621) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-import-nonce' ) ) { |
| [622](#L622) | echo wp\_json\_encode( ['code'=>13,'deleted'=>0,'continue'=>0,'reload'=>0,'done'=>0,'skip'=>0] ); |
| [623](#L623) | } |
| [624](#L624) |  |
| [625](#L625) | // All ok, proceed |
| [626](#L626) | else { |
| [627](#L627) | require\_once 'wppa-import.php'; |
| [628](#L628) | wppa\_import\_photos(); |
| [629](#L629) | } |
| [630](#L630) | wppa\_exit(); |
| [631](#L631) | break; |
| [632](#L632) |  |
| [633](#L633) | case 'approve': |
| [634](#L634) | $iret = 0; |
| [635](#L635) | $txt = ''; |
| [636](#L636) | $pid = wppa\_get( 'photo-id' ); |
| [637](#L637) | $cid = wppa\_get( 'comment-id' ); |
| [638](#L638) |  |
| [639](#L639) | if ( ! current\_user\_can( 'wppa\_moderate' ) && ! current\_user\_can( 'wppa\_comments' ) ) { |
| [640](#L640) | $txt = esc\_html\_\_( 'You do not have the rights to moderate photos this way' , 'wp-photo-album-plus' ); |
| [641](#L641) | echo wp\_json\_encode( ['txt' => $txt] ); |
| [642](#L642) | wppa\_exit(); |
| [643](#L643) | } |
| [644](#L644) |  |
| [645](#L645) | if ( $pid && current\_user\_can( 'wppa\_moderate' ) ) { |
| [646](#L646) | $iret = wppa\_update\_photo( $pid, ['status' => 'publish'] ); |
| [647](#L647) | if ( $iret ) { |
| [648](#L648) | wppa\_flush\_upldr\_cache( 'photoid', $pid ); |
| [649](#L649) | $query = $wpdb->prepare( "SELECT album FROM $wpdb->wppa\_photos WHERE id = %d", $pid ); |
| [650](#L650) | $alb = wppa\_get\_var( $query ); |
| [651](#L651) | wppa\_clear\_taglist(); |
| [652](#L652) | wppa\_invalidate\_treecounts( $alb ); |
| [653](#L653) | wppa\_schedule\_mailinglist( 'photoapproved', $alb, $pid ); |
| [654](#L654) | } |
| [655](#L655) | } |
| [656](#L656) |  |
| [657](#L657) | if ( $cid && current\_user\_can( 'wppa\_moderate' ) ) { |
| [658](#L658) | $iret = wppa\_update\_comment( $cid, ['status' => 'approved'] ); |
| [659](#L659) | if ( $iret ) { |
| [660](#L660) | wppa\_schedule\_mailinglist( 'commentapproved', 0, 0, $cid ); |
| [661](#L661) | wppa\_add\_credit\_points( wppa\_opt( 'cp\_points\_comment\_appr' ), |
| [662](#L662) | \_\_( 'Photo comment approved' , 'wp-photo-album-plus' ), |
| [663](#L663) | $pid, |
| [664](#L664) | '', |
| [665](#L665) | wppa\_get\_photo\_item( $pid, 'owner' ) |
| [666](#L666) | ); |
| [667](#L667) | } |
| [668](#L668) | } |
| [669](#L669) |  |
| [670](#L670) | if ( $iret ) { |
| [671](#L671) | if ( wppa\_switch( 'search\_comments' ) ) { |
| [672](#L672) | wppa\_update\_photo( $pid ); |
| [673](#L673) | } |
| [674](#L674) | $txt = 'OK'; |
| [675](#L675) | } |
| [676](#L676) | else { |
| [677](#L677) | if ( $pid ) { |
| [678](#L678) | if ( current\_user\_can( 'wppa\_moderate' ) ) { |
| [679](#L679) | /\* translators: mediatype, mediaitem id \*/ |
| [680](#L680) | $txt = sprintf( \_\_( 'Failed to update status of %1$s %2$d', 'wp-photo-album-plus' ), wppa\_get\_type( $photo, true ), $pid )."\n".\_\_( 'Please refresh the page', 'wp-photo-album-plus' ); |
| [681](#L681) | } |
| [682](#L682) | else { |
| [683](#L683) | $txt = \_\_( 'Security check failure', 'wp-photo-album-plus' ) . ' 21'; |
| [684](#L684) | } |
| [685](#L685) | } |
| [686](#L686) | if ( $cid ) { |
| [687](#L687) | /\* translators: comment id \*/ |
| [688](#L688) | $txt = sprintf( \_\_( 'Failed to update stutus of comment %d' , 'wp-photo-album-plus' ), $cid )."\n".\_\_( 'Please refresh the page', 'wp-photo-album-plus' ); |
| [689](#L689) | } |
| [690](#L690) | } |
| [691](#L691) | echo wp\_json\_encode( ['txt' => $txt] ); |
| [692](#L692) | wppa\_exit(); |
| [693](#L693) |  |
| [694](#L694) | case 'remove': |
| [695](#L695) |  |
| [696](#L696) | $pid = wppa\_get( 'photo-id' ); |
| [697](#L697) | $cid = wppa\_get( 'comment-id' ); |
| [698](#L698) | $txt = ''; |
| [699](#L699) |  |
| [700](#L700) | // Remove photo |
| [701](#L701) | if ( $pid ) { |
| [702](#L702) | if ( wppa\_may\_user\_fe\_delete( $pid ) ) { |
| [703](#L703) |  |
| [704](#L704) | wppa\_delete\_photo( $pid ); |
| [705](#L705) | $txt = 'OK||' . \_\_( 'Photo removed', 'wp-photo-album-plus' ); |
| [706](#L706) | } |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | // Remove comment |
| [710](#L710) | elseif ( $cid ) { |
| [711](#L711) |  |
| [712](#L712) | // Am i allowed to do this? |
| [713](#L713) | if ( ! current\_user\_can( 'wppa\_moderate' ) && ! current\_user\_can( 'wppa\_comments' ) ) { |
| [714](#L714) | $txt = \_\_( 'You do not have the rights to moderate photos this way', 'wp-photo-album-plus' ); |
| [715](#L715) | } |
| [716](#L716) |  |
| [717](#L717) | else { |
| [718](#L718) | $query = $wpdb->prepare( "SELECT photo FROM $wpdb->wppa\_comments WHERE id = %d", $cid ); |
| [719](#L719) | $photo = wppa\_get\_var( $query ); |
| [720](#L720) |  |
| [721](#L721) | $iret = wppa\_del\_row( WPPA\_COMMENTS, 'id', $cid ); |
| [722](#L722) |  |
| [723](#L723) | if ( $iret ) { |
| [724](#L724) | if ( wppa\_opt( 'search\_comments' ) ) { |
| [725](#L725) | wppa\_update\_photo( $pid ); |
| [726](#L726) | } |
| [727](#L727) | $txt = 'OK||' . \_\_( 'Comment removed', 'wp-photo-album-plus' ); |
| [728](#L728) | } |
| [729](#L729) | else { |
| [730](#L730) | $txt = \_\_( 'Could not remove comment', 'wp-photo-album-plus' ); |
| [731](#L731) | } |
| [732](#L732) | } |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | // Remove request issued, but it is not a photo and not a comment |
| [736](#L736) | else { |
| [737](#L737) | $txt = \_\_( 'Unexpected error', 'wp-photo-album-plus' ); |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | echo wp\_json\_encode( ['txt' => $txt] ); |
| [741](#L741) | wppa\_exit(); |
| [742](#L742) |  |
| [743](#L743) | case 'downloadalbum': |
| [744](#L744) |  |
| [745](#L745) | // Feature enabled? |
| [746](#L746) | if ( ! wppa\_switch( 'allow\_download\_album' ) ) { |
| [747](#L747) | wppa\_echo( wp\_json\_encode( ['txt' => '||ER||' . \_\_( 'This feature is not enabled on this website', 'wp-photo-album-plus' )] ) ); |
| [748](#L748) | wppa\_exit(); |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | // Restricted and not admin? |
| [752](#L752) | if ( wppa\_switch( 'download\_album\_is\_restricted' ) && ! wppa\_user\_is\_admin() ) { |
| [753](#L753) | wppa\_echo( wp\_json\_encode( ['txt' => '||ER||' . \_\_( 'This feature is restricted to administrators', 'wp-photo-album-plus' )] ) ); |
| [754](#L754) | wppa\_exit(); |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | // Validate args |
| [758](#L758) | $alb = wppa\_get( 'album-id' ); |
| [759](#L759) |  |
| [760](#L760) | // Get all items in the album |
| [761](#L761) | $query = $wpdb->prepare( "SELECT id FROM $wpdb->wppa\_photos WHERE album = %d", $alb ); |
| [762](#L762) | $photos = wppa\_get\_col( $query ); |
| [763](#L763) |  |
| [764](#L764) | // Only visible photos are downloadable |
| [765](#L765) | if ( is\_array( $photos ) ) foreach( array\_keys( $photos ) as $i ) { |
| [766](#L766) | if ( ! wppa\_is\_photo( $photos[$i] ) || ! wppa\_is\_photo\_visible( $photos[$i] ) ) { |
| [767](#L767) | unset( $photos[$i] ); |
| [768](#L768) | } |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | // Anything left? |
| [772](#L772) | if ( ! $photos || count( $photos ) == '0' ) { |
| [773](#L773) | wppa\_echo( wp\_json\_encode( ['txt' => '||ER||' . \_\_( 'The album is empty', 'wp-photo-album-plus' )] ) ); |
| [774](#L774) | wppa\_exit(); |
| [775](#L775) | } |
| [776](#L776) |  |
| [777](#L777) | // Open zipfile |
| [778](#L778) | if ( ! class\_exists( 'ZipArchive' ) ) { |
| [779](#L779) | wppa\_echo( wp\_json\_encode( ['txt' => '||ER||' . \_\_( 'Unable to create zip archive', 'wp-photo-album-plus' )] ) ); |
| [780](#L780) | wppa\_exit(); |
| [781](#L781) | } |
| [782](#L782) | $zipfilename = wppa\_get\_album\_name( $alb ); |
| [783](#L783) | $zipfilename = sanitize\_file\_name( $zipfilename . '.zip' );                             // Remove illegal chars |
| [784](#L784) | $zipfilepath = WPPA\_UPLOAD\_PATH . '/temp/' . $zipfilename; |
| [785](#L785) | $wppa\_zip = new ZipArchive; |
| [786](#L786) | $iret = $wppa\_zip->open( $zipfilepath, 1 ); |
| [787](#L787) | if ( $iret !== true ) { |
| [788](#L788) | /\* translators: error code \*/ |
| [789](#L789) | wppa\_echo( wp\_json\_encode( ['txt' => '||ER||'.sprintf( \_\_( 'Unable to create zip archive. code = %s' , 'wp-photo-album-plus' ), $iret )] ) ); |
| [790](#L790) | wppa\_exit(); |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | // Add photos to zip |
| [794](#L794) | $stop = false; |
| [795](#L795) | foreach ( $photos as $id ) { |
| [796](#L796) | if ( wppa\_is\_time\_up() ) { |
| [797](#L797) | wppa\_log( 'war', 'Time up during album to zip creation' ); |
| [798](#L798) | $stop = true; |
| [799](#L799) | } |
| [800](#L800) | else { |
| [801](#L801) | $p = wppa\_cache\_photo( $id ); |
| [802](#L802) | $source = ( wppa\_switch( 'download\_album\_source' ) && wppa\_is\_file( wppa\_get\_source\_path( $id ) ) ) ? wppa\_get\_source\_path( $id ) : wppa\_get\_photo\_path( $id ); |
| [803](#L803) | if ( wppa\_is\_file( $source ) ) { |
| [804](#L804) | $dest = $p['filename'] ? wppa\_sanitize\_file\_name( $p['filename'] ) : wppa\_sanitize\_file\_name( wppa\_strip\_ext( $p['name'] ).'.'.$p['ext'] ); |
| [805](#L805) | $dest = wppa\_fix\_poster\_ext( $dest, $id ); |
| [806](#L806) | $iret = $wppa\_zip->addFile( $source, $dest ); |
| [807](#L807) |  |
| [808](#L808) | // To prevent too may files open, and to have at least a file when there are too many photos, close and re-open |
| [809](#L809) | $wppa\_zip->close(); |
| [810](#L810) | $wppa\_zip->open( $zipfilepath ); |
| [811](#L811) | } |
| [812](#L812) | } |
| [813](#L813) | if ( $stop ) break; |
| [814](#L814) | } |
| [815](#L815) |  |
| [816](#L816) | // Close zip and return |
| [817](#L817) | $zipcount = $wppa\_zip->numFiles; |
| [818](#L818) | $wppa\_zip->close(); |
| [819](#L819) |  |
| [820](#L820) | // A zip is created |
| [821](#L821) | $desturl = WPPA\_UPLOAD\_URL.'/temp/'.$zipfilename; |
| [822](#L822) | echo( wp\_json\_encode( ['txt' => $desturl.'||OK||'] ) ); |
| [823](#L823) | if ( $zipcount != count( $photos ) ) { |
| [824](#L824) | /\* translators: number if items processed, total number of items \*/ |
| [825](#L825) | echo( wp\_json\_encode( ['txt' => sprintf( \_\_( 'Only %1$s out of %2$s photos could be added to the zipfile' , 'wp-photo-album-plus' ), $zipcount, count( $photos ) )] ) ); |
| [826](#L826) | } |
| [827](#L827) | wppa\_exit(); |
| [828](#L828) | break; |
| [829](#L829) |  |
| [830](#L830) | case 'getalbumzipurl': |
| [831](#L831) | $alb = wppa\_get( 'album-id' ); |
| [832](#L832) | $zipfilename = wppa\_get\_album\_name( $alb ); |
| [833](#L833) | $zipfilename = wppa\_sanitize\_file\_name( $zipfilename . '.zip' );                                // Remove illegal chars |
| [834](#L834) | $zipfilepath = WPPA\_UPLOAD\_PATH . '/temp/' . $zipfilename; |
| [835](#L835) | $zipfileurl  = WPPA\_UPLOAD\_URL . '/temp/' . $zipfilename; |
| [836](#L836) | if ( wppa\_is\_file( $zipfilepath ) ) { |
| [837](#L837) | wppa\_echo( $zipfileurl ); |
| [838](#L838) | } |
| [839](#L839) | else { |
| [840](#L840) | wppa\_echo( 'ER' ); |
| [841](#L841) | } |
| [842](#L842) | wppa\_exit(); |
| [843](#L843) | break; |
| [844](#L844) |  |
| [845](#L845) | // Admins choice |
| [846](#L846) | case 'addtozip': |
| [847](#L847) |  |
| [848](#L848) | $photo                  = wppa\_get( 'photo-id' ); |
| [849](#L849) | $donetoalbum    = false; |
| [850](#L850) | $alert                  = ''; |
| [851](#L851) | $status                 = 'OK'; // assume success |
| [852](#L852) | $txt                    = ''; |
| [853](#L853) | $ok                     = true; // assume success |
| [854](#L854) |  |
| [855](#L855) | // Check if the user is allowed to do this |
| [856](#L856) | $choice = wppa\_opt( 'admins\_choice' ); |
| [857](#L857) | if ( ( wppa\_user\_is\_admin() && $choice != 'none' ) || |
| [858](#L858) | ( is\_user\_logged\_in() && $choice == 'login' ) ) { |
| [859](#L859) | // Its ok |
| [860](#L860) | } |
| [861](#L861) | else { |
| [862](#L862) | $alert .= \_\_( 'You are not allowed to do this (2)', 'wp-photo-album-plus' ); |
| [863](#L863) | $status = 'ER'; |
| [864](#L864) | $ok = false; |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | if ( $ok ) { |
| [868](#L868) |  |
| [869](#L869) | // Do the copy to album |
| [870](#L870) | if ( wppa\_opt( 'admins\_choice\_action' ) == 'album' || wppa\_opt( 'admins\_choice\_action' ) == 'both' ) { |
| [871](#L871) | $album = wppa\_my\_get\_first\_grant\_album(); |
| [872](#L872) | if ( $album ) { |
| [873](#L873) | $err = wppa\_copy\_photo( $photo, $album ); |
| [874](#L874) | if ( $err ) { |
| [875](#L875) | $alert .= \_\_( 'Could not copy photo', 'wp-photo-album-plus' ) . '. '; |
| [876](#L876) | $status = 'ER'; |
| [877](#L877) | $ok = false; |
| [878](#L878) | } |
| [879](#L879) | else { |
| [880](#L880) | $alert .= \_\_( 'Photo copied to album', 'wp-photo-album-plus' ) . ' ' . str\_replace( ["'",'"'], '', wppa\_get\_album\_name( $album ) ) . '. '; |
| [881](#L881) | $donetoalbum = true; |
| [882](#L882) | } |
| [883](#L883) | } |
| [884](#L884) | else { |
| [885](#L885) | $alert .= \_\_( 'No album available to copy to', 'wp-photo-album-plus' ) . '. '; |
| [886](#L886) | $status = 'ER'; |
| [887](#L887) | $ok = false; |
| [888](#L888) | } |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | // Also copy to zip? |
| [892](#L892) | if ( wppa\_opt( 'admins\_choice\_action' ) == 'zip' || wppa\_opt( 'admins\_choice\_action' ) == 'both' ) { |
| [893](#L893) |  |
| [894](#L894) | // Do we have ziparchive on board? |
| [895](#L895) | if ( ! class\_exists( 'ZipArchive' ) ) { |
| [896](#L896) | $status = 'ER'; |
| [897](#L897) | $alert .= \_\_( 'Unable to create zip archive' , 'wp-photo-album-plus' ) . '. '; |
| [898](#L898) | $ok = false; |
| [899](#L899) | } |
| [900](#L900) |  |
| [901](#L901) | // zip class available |
| [902](#L902) | else { |
| [903](#L903) |  |
| [904](#L904) | // Verify existance of zips dir |
| [905](#L905) | $zipsdir = WPPA\_UPLOAD\_PATH . '/zips/'; |
| [906](#L906) | if ( ! wppa\_is\_dir( $zipsdir ) ) wppa\_mkdir( $zipsdir ); |
| [907](#L907) | if ( ! wppa\_is\_dir( $zipsdir ) ) { |
| [908](#L908) | $status = 'ER'; |
| [909](#L909) | $alert .= \_\_( 'Unable to create zipsdir' , 'wp-photo-album-plus' ) . '. ';; |
| [910](#L910) | $ok = false; |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | if ( $ok ) { |
| [914](#L914) |  |
| [915](#L915) | // Compose the users zip filename |
| [916](#L916) | $zipfile = $zipsdir.wppa\_get\_user().'.zip'; |
| [917](#L917) |  |
| [918](#L918) | // Find the photo data |
| [919](#L919) | $query = $wpdb->prepare( "SELECT \* FROM $wpdb->wppa\_photos WHERE id = %d", $photo ); |
| [920](#L920) | $data = wppa\_get\_row( $query ); |
| [921](#L921) |  |
| [922](#L922) | // Find the photo file |
| [923](#L923) | if ( wppa\_is\_file ( wppa\_get\_source\_path( $photo ) ) ) { |
| [924](#L924) | $source = wppa\_get\_source\_path( $photo ); |
| [925](#L925) | } |
| [926](#L926) | else { |
| [927](#L927) | $source = wppa\_get\_photo\_path( $photo ); |
| [928](#L928) | } |
| [929](#L929) |  |
| [930](#L930) | // Add photo to zip |
| [931](#L931) | $wppa\_zip = new ZipArchive; |
| [932](#L932) | $wppa\_zip->open( $zipfile, 1 ); |
| [933](#L933) | $wppa\_zip->addFile( $source, wppa\_fix\_poster\_ext( $data['filename'], $photo ) ); |
| [934](#L934) | $wppa\_zip->close(); |
| [935](#L935) |  |
| [936](#L936) | // Add user display name as tag to the item if configured |
| [937](#L937) | if ( wppa\_switch( 'choice\_is\_tag' ) ) { |
| [938](#L938) | $tags = wppa\_get\_photo\_item( $photo, 'tags' ); |
| [939](#L939) | $user = wppa\_get\_user( 'display' ); |
| [940](#L940) | $newtags = wppa\_sanitize\_tags( $tags . $user ); |
| [941](#L941) | if ( $tags == $newtags ) { |
| [942](#L942) | $alert .= \_\_( 'Item is already tagged with username', 'wp-photo-album-plus' ) . ' ' . $user . '. '; |
| [943](#L943) | } |
| [944](#L944) | else { |
| [945](#L945) | wppa\_update\_photo( $photo, ['tags' => $newtags] ); |
| [946](#L946) | wppa\_clear\_taglist(); |
| [947](#L947) | $alert .= \_\_( 'Item tagged with username', 'wp-photo-album-plus' ) . ' ' . $user . '. '; |
| [948](#L948) | } |
| [949](#L949) | } |
| [950](#L950) |  |
| [951](#L951) | $alert .= \_\_( 'Photo copied to zipfile', 'wp-photo-album-plus' ) . '. ||' . \_\_( 'Selected', 'wp-photo-album-plus' ); |
| [952](#L952) | $status = 'OK'; |
| [953](#L953) | } |
| [954](#L954) | } |
| [955](#L955) | } |
| [956](#L956) | } |
| [957](#L957) |  |
| [958](#L958) | // Done! |
| [959](#L959) | $txt = $status . '||' . $alert; |
| [960](#L960) | echo wp\_json\_encode( ['txt' => $txt] ); |
| [961](#L961) | wppa\_exit(); |
| [962](#L962) | break; |
| [963](#L963) |  |
| [964](#L964) | case 'removefromzip': |
| [965](#L965) |  |
| [966](#L966) | // Check if the user is allowed to do this |
| [967](#L967) | $photo  = wppa\_get( 'photo-id' ); |
| [968](#L968) | $choice = wppa\_opt( 'admins\_choice' ); |
| [969](#L969) | $txt    = ''; |
| [970](#L970) | $ok     = true; |
| [971](#L971) | if ( ( wppa\_user\_is\_admin() && $choice != 'none' ) || |
| [972](#L972) | ( is\_user\_logged\_in() && $choice == 'login' ) ) { |
| [973](#L973) | // Its ok |
| [974](#L974) | } |
| [975](#L975) | else { |
| [976](#L976) | $txt = 'ER||' . \_\_( 'You are not allowed to do this', 'wp-photo-album-plus' ); |
| [977](#L977) | $ok = false; |
| [978](#L978) | } |
| [979](#L979) |  |
| [980](#L980) | if ( $ok ) { |
| [981](#L981) |  |
| [982](#L982) | // Compose the users zip filename |
| [983](#L983) | $zipsdir = WPPA\_UPLOAD\_PATH.'/zips/'; |
| [984](#L984) | $zipfile = $zipsdir.wppa\_get\_user().'.zip'; |
| [985](#L985) |  |
| [986](#L986) | // Find the photo data |
| [987](#L987) | $query = $wpdb->prepare( "SELECT \* FROM $wpdb->wppa\_photos WHERE id = %d", $photo ); |
| [988](#L988) | $data = wppa\_get\_row( $query ); |
| [989](#L989) |  |
| [990](#L990) | // Remove photo from zip |
| [991](#L991) | $wppa\_zip = new ZipArchive; |
| [992](#L992) | $wppa\_zip->open( $zipfile ); |
| [993](#L993) | $bret = $wppa\_zip->deleteName( wppa\_fix\_poster\_ext( $data['filename'], $photo ) ); |
| [994](#L994) | $wppa\_zip->close(); |
| [995](#L995) |  |
| [996](#L996) | // Remove user id as tag to the item if configured |
| [997](#L997) | if ( wppa\_switch( 'choice\_is\_tag' ) ) { |
| [998](#L998) | $tags = preg\_replace( '/,'.wppa\_get\_user( 'display' ).',/siu', ',', $tags ); |
| [999](#L999) | wppa\_update\_photo( $photo, ['tags' => $tags] ); |
| [1000](#L1000) | } |
| [1001](#L1001) | } |
| [1002](#L1002) | $txt = 'OK||' . \_\_( 'Removed', 'wp-photo-album-plus' ); |
| [1003](#L1003) | echo wp\_json\_encode( ['txt' => $txt] ); |
| [1004](#L1004) | wppa\_exit(); |
| [1005](#L1005) | break; |
| [1006](#L1006) |  |
| [1007](#L1007) | case 'delmyzip': |
| [1008](#L1008) |  |
| [1009](#L1009) | // Verify existance of zips dir |
| [1010](#L1010) | $zipsdir = WPPA\_UPLOAD\_PATH . '/zips/'; |
| [1011](#L1011) | if ( wppa\_is\_dir( $zipsdir ) ) { |
| [1012](#L1012) |  |
| [1013](#L1013) | // Compose the users zip filename |
| [1014](#L1014) | $zipfile = $zipsdir.wppa\_get\_user().'.zip'; |
| [1015](#L1015) |  |
| [1016](#L1016) | // Check file existance and remove |
| [1017](#L1017) | if ( wppa\_is\_file( $zipfile ) ) { |
| [1018](#L1018) | @ wp\_delete\_file( $zipfile ); |
| [1019](#L1019) | } |
| [1020](#L1020) | } |
| [1021](#L1021) |  |
| [1022](#L1022) | // Remove all User displayname tags |
| [1023](#L1023) | $tag = wppa\_get\_user( 'display' ); |
| [1024](#L1024) | $query = "SELECT id, tags FROM $wpdb->wppa\_photos WHERE tags LIKE '%" . str\_replace( "'", "\'", ',' . $wpdb->esc\_like( $tag ) . ',' ) . "%'"; |
| [1025](#L1025) | $items = wppa\_get\_results( $query ); |
| [1026](#L1026) | foreach( $items as $item ) { |
| [1027](#L1027) | $id = $item['id']; |
| [1028](#L1028) | $tags = preg\_replace( '/,'.$tag.',/siu', ',', $item['tags'] ); |
| [1029](#L1029) | $tags = wppa\_sanitize\_tags( $tags ); |
| [1030](#L1030) | wppa\_update\_photo( $id, ['tags' => $tags] ); |
| [1031](#L1031) | } |
| [1032](#L1032) | wppa\_clear\_taglist(); |
| [1033](#L1033) | $txt = 'zip removed'; |
| [1034](#L1034) | echo wp\_json\_encode( ['txt' => $txt] ); |
| [1035](#L1035) | wppa\_exit(); |
| [1036](#L1036) | break; |
| [1037](#L1037) |  |
| [1038](#L1038) | case 'requestinfo': |
| [1039](#L1039) |  |
| [1040](#L1040) | // Check if the user is allowed to do this |
| [1041](#L1041) | if ( ! is\_user\_logged\_in() ) { |
| [1042](#L1042) | echo wp\_json\_encode( ['txt' => 'ER||'. \_\_('You must be logged in to request info', 'wp-photo-album-plus' )] ); |
| [1043](#L1043) | wppa\_exit(); |
| [1044](#L1044) | } |
| [1045](#L1045) |  |
| [1046](#L1046) | // Find the photo |
| [1047](#L1047) | $photo  = wppa\_get( 'photo-id' ); |
| [1048](#L1048) |  |
| [1049](#L1049) | // The mail content |
| [1050](#L1050) | $content = |
| [1051](#L1051) | /\* translators: username, item id, item name \*/ |
| [1052](#L1052) | sprintf( \_\_( 'User %1$s requested more info about item #%2$d (%3$s)', 'wp-photo-album-plus' ), |
| [1053](#L1053) | wppa\_get\_user( 'display' ), |
| [1054](#L1054) | $photo, |
| [1055](#L1055) | wppa\_get\_photo\_name( $photo ) |
| [1056](#L1056) | ); |
| [1057](#L1057) | $content .= |
| [1058](#L1058) | '<br><br>' . \_\_('His request specification is', 'wp-photo-album-plus' ) . '<br>' . |
| [1059](#L1059) |  |
| [1060](#L1060) | '<blockquote style="color:#000077; background-color: #dddddd; border:1px solid black; padding: 6px; border-radius: 4px"> |
| [1061](#L1061) | <em> ' . sanitize\_text\_field( wppa\_get( 'emailtext', 'text' ) ) . '</em> |
| [1062](#L1062) | </blockquote>'; |
| [1063](#L1063) |  |
| [1064](#L1064) | if ( ! function\_exists( 'wppa\_send\_mail' ) ) { |
| [1065](#L1065) | require\_once( 'wppa-mailing.php' ); |
| [1066](#L1066) | } |
| [1067](#L1067) |  |
| [1068](#L1068) | // Send the mail |
| [1069](#L1069) | wppa\_send\_mail( array(  'to' => get\_bloginfo( 'admin\_email' ), |
| [1070](#L1070) | 'subj' => \_\_( 'Request for info', 'wp-photo-album-plus' ), |
| [1071](#L1071) | 'cont' => $content, |
| [1072](#L1072) | 'photo' => $photo, |
| [1073](#L1073) | 'email' => wppa\_get\_user( 'email' ), |
| [1074](#L1074) | 'listtype' => 'showemail', |
| [1075](#L1075) | 'replyurl' => '', |
| [1076](#L1076) | 'unsubscribe' => '', |
| [1077](#L1077) | ) ); |
| [1078](#L1078) |  |
| [1079](#L1079) | // Done |
| [1080](#L1080) | echo wp\_json\_encode( ['txt' => 'OK||Request issued'] ); |
| [1081](#L1081) | wppa\_exit(); |
| [1082](#L1082) | break; |
| [1083](#L1083) |  |
| [1084](#L1084) | case 'tinymcedialog': |
| [1085](#L1085) | $result = wppa\_make\_tinymce\_dialog(); |
| [1086](#L1086) | wppa\_echo( $result ); |
| [1087](#L1087) | wppa\_exit(); |
| [1088](#L1088) | break; |
| [1089](#L1089) |  |
| [1090](#L1090) | case 'tinymcephotodialog': |
| [1091](#L1091) | $result = wppa\_make\_tinymce\_photo\_dialog(); |
| [1092](#L1092) | wppa\_echo( $result ); |
| [1093](#L1093) | wppa\_exit(); |
| [1094](#L1094) | break; |
| [1095](#L1095) |  |
| [1096](#L1096) | case 'tinymcephotodialogfront': |
| [1097](#L1097) | $result = wppa\_make\_tinymce\_photo\_dialog( 'front' ); |
| [1098](#L1098) | wppa\_echo( $result ); |
| [1099](#L1099) | wppa\_exit(); |
| [1100](#L1100) | break; |
| [1101](#L1101) |  |
| [1102](#L1102) | case 'gutenbergphotodialog': |
| [1103](#L1103) | $result = wppa\_make\_gutenberg\_photo\_dialog(); |
| [1104](#L1104) | wppa\_echo( $result ); |
| [1105](#L1105) | wppa\_exit(); |
| [1106](#L1106) | break; |
| [1107](#L1107) |  |
| [1108](#L1108) | case 'gutenbergwppadialog': |
| [1109](#L1109) | $result = wppa\_make\_gutenberg\_wppa\_dialog(); |
| [1110](#L1110) | wppa\_echo( $result ); |
| [1111](#L1111) | wppa\_exit(); |
| [1112](#L1112) | break; |
| [1113](#L1113) |  |
| [1114](#L1114) | case 'getshortcodedrendered': |
| [1115](#L1115) |  |
| [1116](#L1116) | // Used by gutenberg and cover preview in album admin |
| [1117](#L1117) |  |
| [1118](#L1118) | // Are we legally here? |
| [1119](#L1119) | $from = wppa\_get( 'from', '', 'text' ); |
| [1120](#L1120) | switch ( $from ) { |
| [1121](#L1121) | case 'cover': |
| [1122](#L1122) | if ( ! current\_user\_can( 'wppa\_admin' ) ) { |
| [1123](#L1123) | wppa\_echo( \_\_( 'No rights', 'wp-photo-album-plus' ) . ' (c) ' . $from ); |
| [1124](#L1124) | wppa\_exit(); |
| [1125](#L1125) | } |
| [1126](#L1126) | break; |
| [1127](#L1127) | case 'gbphoto': |
| [1128](#L1128) | case 'gbmisc': |
| [1129](#L1129) | if ( ! current\_user\_can( 'edit\_posts' ) && ! current\_user\_can( 'edit\_pages' ) ) { |
| [1130](#L1130) | wppa\_echo( \_\_( 'No rights', 'wp-photo-album-plus' ) . ' (e) ' . $from ); |
| [1131](#L1131) | wppa\_exit(); |
| [1132](#L1132) | } |
| [1133](#L1133) | break; |
| [1134](#L1134) | default: |
| [1135](#L1135) | wppa\_echo( \_\_( 'No rights', 'wp-photo-album-plus' ) . ' (d) ' . $from ); |
| [1136](#L1136) | wppa\_exit(); |
| [1137](#L1137) | } |
| [1138](#L1138) |  |
| [1139](#L1139) | // Force direct script tags |
| [1140](#L1140) | global $wppa\_gutenberg\_preview; |
| [1141](#L1141) | $wppa\_gutenberg\_preview = true; |
| [1142](#L1142) |  |
| [1143](#L1143) | global $wppa\_preview\_container\_width; |
| [1144](#L1144) | $wppa\_preview\_container\_width = 650; |
| [1145](#L1145) |  |
| [1146](#L1146) | // Ignore lazy, cache and delay |
| [1147](#L1147) | $wppa\_opt['wppa\_lazy'] = 'none'; |
| [1148](#L1148) | $wppa\_opt['wppa\_cache\_overrule'] = 'never'; |
| [1149](#L1149) | $wppa\_opt['wppa\_delay\_overrule'] = 'never'; |
| [1150](#L1150) |  |
| [1151](#L1151) | // Make sure slideshow do not run |
| [1152](#L1152) | $wppa\_opt['wppa\_start\_slide'] = 'still'; |
| [1153](#L1153) |  |
| [1154](#L1154) | // Get the shortcode |
| [1155](#L1155) | $shortcode = wppa\_get( 'shortcode', '', 'gutsc' ); |
| [1156](#L1156) |  |
| [1157](#L1157) | // Is it a valid shortcode? |
| [1158](#L1158) | $shortcode = wppa\_get( 'shortcode' ); |
| [1159](#L1159) | if ( $shortcode != '[wppa]' && substr( $shortcode, 0, 6 ) != '[wppa ' && substr( $shortcode, 0, 7 ) != '[photo ' ) { |
| [1160](#L1160) | wppa\_log('war', 'Shortcode '.$shortcode.' rejected'); |
| [1161](#L1161) | wppa\_echo( esc\_html\_\_( 'Shortcode check failure', 'wp-photo-album-plus' ) ); |
| [1162](#L1162) | wppa\_exit(); |
| [1163](#L1163) | } |
| [1164](#L1164) |  |
| [1165](#L1165) | // Prepare environment for rendering |
| [1166](#L1166) | wppa\_load\_theme(); |
| [1167](#L1167) |  |
| [1168](#L1168) | // Render the shortcode |
| [1169](#L1169) | $result = do\_shortcode( $shortcode ); |
| [1170](#L1170) |  |
| [1171](#L1171) | // Make links and clicks unusable in the result |
| [1172](#L1172) | $result = str\_replace( 'href=', 'data-disabled1=', $result ); |
| [1173](#L1173) | $result = str\_replace( 'onclick="', 'onclick="return false;', $result ); |
| [1174](#L1174) | $result = str\_replace( 'data-lbtitle=', 'data-disabled2=', $result ); |
| [1175](#L1175) | $result = str\_replace( 'data-rel=', 'data-disabled3=', $result ); |
| [1176](#L1176) | $result = str\_replace( ['cursor:pointer', 'cursor: pointer'], 'cursor:help', $result ); |
| [1177](#L1177) |  |
| [1178](#L1178) | // Output the result |
| [1179](#L1179) | wppa\_echo ( ' |
| [1180](#L1180) | <style> |
| [1181](#L1181) | #wppa-gutenberg-preview div { |
| [1182](#L1182) | position:relative; |
| [1183](#L1183) | } |
| [1184](#L1184) |  |
| [1185](#L1185) | .filmwindow { |
| [1186](#L1186) | width:622px!important; |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | .wppa-container-wrapper { |
| [1190](#L1190) | max-width: 840px; |
| [1191](#L1191) | } |
| [1192](#L1192) |  |
| [1193](#L1193) | .wppa-container-wrapper img { |
| [1194](#L1194) | cursor: help; |
| [1195](#L1195) | } |
| [1196](#L1196) |  |
| [1197](#L1197) | </style> |
| [1198](#L1198) | <div |
| [1199](#L1199) | id="wppa-container-' . esc\_attr( $wppa['mocc'] ) . '" |
| [1200](#L1200) | style="position:relative;width:100%" > |
| [1201](#L1201) | <div class="wppa-preview-caption" style="font-size:12px;color:green;margin:12px 0;width:100%;text-align:center;"> |
| [1202](#L1202) | <i>' . esc\_html( \_\_('In this preview: links and buttons will not work', 'wp-photo-album-plus' ) ) . ',<br>' . |
| [1203](#L1203) | esc\_html( \_\_('optional size and alignment settings are ignored', 'wp-photo-album-plus' ) ) . '. |
| [1204](#L1204) | </i> |
| [1205](#L1205) | </div>' . |
| [1206](#L1206) | $result . ' |
| [1207](#L1207) | </div>', ['needjs' => true] ); |
| [1208](#L1208) |  |
| [1209](#L1209) | $wppa\_gutenberg\_preview = false; |
| [1210](#L1210) |  |
| [1211](#L1211) | // Done |
| [1212](#L1212) | wppa\_exit(); |
| [1213](#L1213) | break; |
| [1214](#L1214) |  |
| [1215](#L1215) | case 'getshortcodedrenderedfenodelay': |
| [1216](#L1216) |  |
| [1217](#L1217) | // Used by delay feature |
| [1218](#L1218) | $nonce = wppa\_get( 'nonce' ); |
| [1219](#L1219) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-check' ) ) { |
| [1220](#L1220) | $shouldbe = wp\_create\_nonce( 'wppa-check' ); |
| [1221](#L1221) | wppa\_log( 'err', 'Nonce expected = '.$shouldbe.', found = '.$nonce); |
| [1222](#L1222) | echo wp\_json\_encode( ['html' => \_\_( 'Security check failure', 'wp-photo-album-plus' ), 'js' => ''] ); |
| [1223](#L1223) | wppa\_exit(); |
| [1224](#L1224) | } |
| [1225](#L1225) |  |
| [1226](#L1226) | // Is it a valid shortcode? |
| [1227](#L1227) | $shortcode = wppa\_get( 'shortcode' ); |
| [1228](#L1228) | if ( $shortcode != '[wppa]' && substr( $shortcode, 0, 6 ) != '[wppa ' ) { |
| [1229](#L1229) | wppa\_log('war', 'Shortcode '.$shortcode.' rejected'); |
| [1230](#L1230) | echo wp\_json\_encode( ['html' => \_\_( 'Shortcode check failure', 'wp-photo-album-plus' ), 'js' => ''] ); |
| [1231](#L1231) | wppa\_exit(); |
| [1232](#L1232) | } |
| [1233](#L1233) |  |
| [1234](#L1234) | // Yes |
| [1235](#L1235) | ob\_start(); |
| [1236](#L1236) | wppa\_load\_theme(); |
| [1237](#L1237) | //                      wppa( 'mocc', wppa\_get( 'occur' ) - 1 ); |
| [1238](#L1238) | $result = do\_shortcode( str\_replace( '%23', '#', $shortcode ) ); |
| [1239](#L1239) |  |
| [1240](#L1240) | // Get the JS |
| [1241](#L1241) | $js = wppa\_print\_psjs( true ); |
| [1242](#L1242) |  |
| [1243](#L1243) | // Split result into HTML and JS (if any, it should not contain js) |
| [1244](#L1244) | $result = wppa\_split\_html\_js( $result ); |
| [1245](#L1245) |  |
| [1246](#L1246) | // Combine standard js and optional js found during split |
| [1247](#L1247) | if ( $result['js'] ) { |
| [1248](#L1248) | $js .= $result['js']; |
| [1249](#L1249) | } |
| [1250](#L1250) |  |
| [1251](#L1251) | // Compress html |
| [1252](#L1252) | $html = wppa\_compress\_html( $result['html'] ); |
| [1253](#L1253) |  |
| [1254](#L1254) | // Compress js |
| [1255](#L1255) | $js = wppa\_compress\_js( $js ); |
| [1256](#L1256) |  |
| [1257](#L1257) | // Get possible premature output |
| [1258](#L1258) | $unexpected = ob\_get\_clean(); |
| [1259](#L1259) | if ( $unexpected ) { |
| [1260](#L1260) | wppa\_log( 'err', strlen( $unexpected ) . ' chars of unexpected output captured while doing ajax render: ' . str\_replace( '&', '8', htmlspecialchars( $unexpected ) ) ); |
| [1261](#L1261) | } |
| [1262](#L1262) |  |
| [1263](#L1263) | // Output |
| [1264](#L1264) | echo wp\_json\_encode( ['html' => $html, 'js' => $js] ); |
| [1265](#L1265) |  |
| [1266](#L1266) | wppa\_exit(); |
| [1267](#L1267) | break; |
| [1268](#L1268) |  |
| [1269](#L1269) | case 'bumpviewcount': |
| [1270](#L1270) | $nonce  = wppa\_get( 'nonce' ); |
| [1271](#L1271) | if ( wp\_verify\_nonce( $nonce, 'wppa-check' ) ) { |
| [1272](#L1272) | wppa\_bump\_viewcount( 'photo', wppa\_get( 'photo' ) ); |
| [1273](#L1273) | } |
| [1274](#L1274) | else { |
| [1275](#L1275) | wppa\_log( 'Misc', 'nonce failed on ' . $wppa\_action ); |
| [1276](#L1276) | } |
| [1277](#L1277) | echo wp\_json\_encode( ['txt' => ''] ); |
| [1278](#L1278) | wppa\_exit(); |
| [1279](#L1279) | break; |
| [1280](#L1280) |  |
| [1281](#L1281) | case 'bumpdownloadcount': |
| [1282](#L1282) | $nonce  = wppa\_get( 'nonce' ); |
| [1283](#L1283) | if ( wp\_verify\_nonce( $nonce, 'wppa-check' ) ) { |
| [1284](#L1284) | wppa\_bump\_dlcount( wppa\_get( 'photo' ) ); |
| [1285](#L1285) | } |
| [1286](#L1286) | else { |
| [1287](#L1287) | wppa\_log( 'Misc', 'nonce failed on ' . $wppa\_action ); |
| [1288](#L1288) | } |
| [1289](#L1289) | echo '{}'; |
| [1290](#L1290) | wppa\_exit(); |
| [1291](#L1291) | break; |
| [1292](#L1292) |  |
| [1293](#L1293) | case 'bumpclickcount': |
| [1294](#L1294) | $nonce  = wppa\_get( 'nonce' ); |
| [1295](#L1295) | if ( wp\_verify\_nonce( $nonce, 'wppa-check' ) ) { |
| [1296](#L1296) | wppa\_bump\_clickcount( wppa\_get( 'photo' ) ); |
| [1297](#L1297) | } |
| [1298](#L1298) | else { |
| [1299](#L1299) | wppa\_log( 'Misc', 'nonce failed on ' . $wppa\_action ); |
| [1300](#L1300) | } |
| [1301](#L1301) | echo '{}'; |
| [1302](#L1302) | wppa\_exit(); |
| [1303](#L1303) | break; |
| [1304](#L1304) |  |
| [1305](#L1305) | case 'rate': |
| [1306](#L1306) |  |
| [1307](#L1307) | // Get commandline args |
| [1308](#L1308) | $photo  = wppa\_get( 'rating-id' ); |
| [1309](#L1309) | $rating = wppa\_get( 'rating' ); |
| [1310](#L1310) | $occur  = wppa\_get( 'occur' ); |
| [1311](#L1311) | $index  = wppa\_get( 'index' ); |
| [1312](#L1312) | $nonce  = wppa\_get( 'nonce' ); |
| [1313](#L1313) |  |
| [1314](#L1314) | // Make errortext |
| [1315](#L1315) | $errtxt = \_\_( 'An error occurred while processing you rating request.' , 'wp-photo-album-plus' ); |
| [1316](#L1316) | $errtxt .= "\n".\_\_( 'Maybe you opened the page too long ago to recognize you.' , 'wp-photo-album-plus' ); |
| [1317](#L1317) | $errtxt .= "\n".\_\_( 'You may refresh the page and try again.' , 'wp-photo-album-plus' ); |
| [1318](#L1318) | $wartxt = \_\_( 'Althoug an error occurred while processing your rating, your vote has been registered.' , 'wp-photo-album-plus' ); |
| [1319](#L1319) | $wartxt .= "\n".\_\_( 'However, this may not be reflected in the current pageview' , 'wp-photo-album-plus' ); |
| [1320](#L1320) |  |
| [1321](#L1321) | // Security check |
| [1322](#L1322) | if ( wppa\_switch( 'direct\_comment' ) ) { |
| [1323](#L1323) | if ( ! $photo || ( wppa\_get\_photo\_item( $photo, 'album' ) < '1' ) ) { |
| [1324](#L1324) | wppa\_echo( wp\_json\_encode( ['txt' => '0||100||'.\_\_( 'Missing or invalid photo id', 'wp-photo-album-plus' )] ) ); |
| [1325](#L1325) | wppa\_exit(); |
| [1326](#L1326) | } |
| [1327](#L1327) | } |
| [1328](#L1328) | else { |
| [1329](#L1329) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-check' ) ) { |
| [1330](#L1330) | wppa\_echo( wp\_json\_encode( ['txt' => '0||100||'.$errtxt] ) ); |
| [1331](#L1331) | wppa\_exit(); |
| [1332](#L1332) | } |
| [1333](#L1333) | if ( ! $photo || ( wppa\_get\_photo\_item( $photo, 'album' ) < '1' ) ) { |
| [1334](#L1334) | wppa\_echo( wp\_json\_encode( ['txt' => '0||100||'.\_\_( 'Missing or invalid photo id', 'wp-photo-album-plus' )] ) ); |
| [1335](#L1335) | wppa\_exit(); |
| [1336](#L1336) | } |
| [1337](#L1337) | } |
| [1338](#L1338) |  |
| [1339](#L1339) | // Check login |
| [1340](#L1340) | if ( ! is\_user\_logged\_in() ) { |
| [1341](#L1341) | wppa\_echo( wp\_json\_encode( ['txt' => wppa\_secfail( '40', true )] ) ); |
| [1342](#L1342) | wppa\_exit(); |
| [1343](#L1343) | } |
| [1344](#L1344) |  |
| [1345](#L1345) | // Check on validity |
| [1346](#L1346) | if ( wppa\_opt( 'rating\_max' ) == '1' && $rating != '1' ) { |
| [1347](#L1347) | wppa\_echo( wp\_json\_encode( ['txt' => '0||106||'.$errtxt.':'.$rating] ) ); |
| [1348](#L1348) | wppa\_exit();                                                                                                                            // Value out of range |
| [1349](#L1349) | } |
| [1350](#L1350) | elseif ( wppa\_opt( 'rating\_max' ) == '5' && ! in\_array( $rating, array( '-1', '1', '2', '3', '4', '5' ) ) ) { |
| [1351](#L1351) | wppa\_echo( wp\_json\_encode( ['txt' => '0||106||'.$errtxt.':'.$rating] ) ); |
| [1352](#L1352) | wppa\_exit();                                                                                                                            // Value out of range |
| [1353](#L1353) | } |
| [1354](#L1354) | elseif ( wppa\_opt( 'rating\_max' ) == '10' && ! in\_array( $rating, array( '-1', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10' ) ) ) { |
| [1355](#L1355) | wppa\_echo( wp\_json\_encode( ['txt' => '0||106||'.$errtxt.':'.$rating] ) ); |
| [1356](#L1356) | wppa\_exit();                                                                                                                            // Value out of range |
| [1357](#L1357) | } |
| [1358](#L1358) |  |
| [1359](#L1359) | // Check for one rating per period |
| [1360](#L1360) | $wait\_text = wppa\_get\_rating\_wait\_text( $photo ); |
| [1361](#L1361) | if ( $wait\_text ) { |
| [1362](#L1362) | wppa\_echo( wp\_json\_encode( ['txt' => '0||900||'.$wait\_text] ) );        // 900 is recoverable error |
| [1363](#L1363) | wppa\_exit(); |
| [1364](#L1364) | } |
| [1365](#L1365) |  |
| [1366](#L1366) | // Get other data |
| [1367](#L1367) | if ( ! wppa\_photo\_exists( $photo ) ) { |
| [1368](#L1368) | wppa\_echo( wp\_json\_encode( ['txt' => '0||999||'.\_\_( 'Photo has been removed.', 'wp-photo-album-plus' )] ) ); |
| [1369](#L1369) | wppa\_exit(); |
| [1370](#L1370) | } |
| [1371](#L1371) |  |
| [1372](#L1372) | $mylast   = wppa\_get\_my\_last\_vote( $photo ); |
| [1373](#L1373) |  |
| [1374](#L1374) | $myavgrat = '0';                        // Init |
| [1375](#L1375) |  |
| [1376](#L1376) | $user     = wppa\_get\_user( 'display' ); |
| [1377](#L1377) |  |
| [1378](#L1378) | // Rate own photo? |
| [1379](#L1379) | if ( wppa\_get\_photo\_item( $photo, 'owner' ) == wppa\_get\_user( 'login' ) && ! wppa\_switch( 'allow\_owner\_votes' ) ) { |
| [1380](#L1380) | wppa\_echo( wp\_json\_encode( ['txt' => '0||900||' . \_\_( 'Sorry, you can not rate your own photos', 'wp-photo-album-plus' )] ) ); |
| [1381](#L1381) | wppa\_exit(); |
| [1382](#L1382) | } |
| [1383](#L1383) |  |
| [1384](#L1384) | // Already a pending one? |
| [1385](#L1385) | $query = $wpdb->prepare( "SELECT COUNT(\*) FROM $wpdb->wppa\_rating |
| [1386](#L1386) | WHERE photo = %d |
| [1387](#L1387) | AND user = %s |
| [1388](#L1388) | AND status = 'pending'", $photo, $user ); |
| [1389](#L1389) | $pending = wppa\_get\_var( $query ); |
| [1390](#L1390) |  |
| [1391](#L1391) | // Has user motivated his vote? |
| [1392](#L1392) | $hascommented = wppa\_has\_user\_commented( $photo ); |
| [1393](#L1393) |  |
| [1394](#L1394) | // If the user has commented and comment needs vote is active, publish his comment |
| [1395](#L1395) | if ( $hascommented && wppa\_switch( 'comment\_need\_vote' ) ) { |
| [1396](#L1396) | $query = $wpdb->prepare( "SELECT id FROM $wpdb->wppa\_comments |
| [1397](#L1397) | WHERE photo = %d |
| [1398](#L1398) | AND user = %s", $photo, wppa\_get\_user( 'display' ) ); |
| [1399](#L1399) | $comments\_to\_approve = wppa\_get\_col( $query ); |
| [1400](#L1400) |  |
| [1401](#L1401) | // Set the statusses to approved |
| [1402](#L1402) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_comments |
| [1403](#L1403) | SET status = 'approved' |
| [1404](#L1404) | WHERE photo = %d |
| [1405](#L1405) | AND user = %s", $photo, wppa\_get\_user( 'display' ) ); |
| [1406](#L1406) | wppa\_query( $query ); |
| [1407](#L1407) |  |
| [1408](#L1408) | // Do the points and do the mailing |
| [1409](#L1409) | $photo\_owner = wppa\_get\_photo\_item( $photo, 'owner' ); |
| [1410](#L1410) | if ( $comments\_to\_approve ) foreach( $comments\_to\_approve as $com ) { |
| [1411](#L1411) |  |
| [1412](#L1412) | // The points to the commenter |
| [1413](#L1413) | if ( $photo\_owner != wppa\_get\_user() ) { |
| [1414](#L1414) | wppa\_add\_credit\_points( wppa\_opt( 'cp\_points\_comment' ), |
| [1415](#L1415) | \_\_( 'Photo comment' , 'wp-photo-album-plus' ), |
| [1416](#L1416) | $photo |
| [1417](#L1417) | ); |
| [1418](#L1418) | } |
| [1419](#L1419) |  |
| [1420](#L1420) | // Add points to the owner |
| [1421](#L1421) | wppa\_add\_credit\_points( wppa\_opt( 'cp\_points\_comment\_appr' ), |
| [1422](#L1422) | \_\_( 'Photo comment approved' , 'wp-photo-album-plus' ), |
| [1423](#L1423) | $photo, |
| [1424](#L1424) | '', |
| [1425](#L1425) | $photo\_owner |
| [1426](#L1426) | ); |
| [1427](#L1427) |  |
| [1428](#L1428) | // Do the mailing |
| [1429](#L1429) | wppa\_schedule\_mailinglist( 'commentnotify', 0, $photo, $com, wppa\_get( 'returnurl' ) ); |
| [1430](#L1430) | } |
| [1431](#L1431) | } |
| [1432](#L1432) |  |
| [1433](#L1433) | if ( $pending ) { |
| [1434](#L1434) | if ( ! $hascommented ) { |
| [1435](#L1435) | wppa\_echo( wp\_json\_encode( ['txt' => '0||900||' . \_\_( 'Please enter a comment.', 'wp-photo-album-plus' )] ) ); |
| [1436](#L1436) | wppa\_exit(); |
| [1437](#L1437) | } |
| [1438](#L1438) | else { |
| [1439](#L1439) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_rating |
| [1440](#L1440) | SET status = 'publish' |
| [1441](#L1441) | WHERE photo = %d |
| [1442](#L1442) | AND user = %s", $photo, $user ); |
| [1443](#L1443) | wppa\_query( $query ); |
| [1444](#L1444) | } |
| [1445](#L1445) | } |
| [1446](#L1446) |  |
| [1447](#L1447) | if ( wppa\_switch( 'vote\_needs\_comment' ) ) { |
| [1448](#L1448) | $ratingstatus = $hascommented ? 'publish' : 'pending'; |
| [1449](#L1449) | } |
| [1450](#L1450) | else { |
| [1451](#L1451) | $ratingstatus = 'publish'; |
| [1452](#L1452) | } |
| [1453](#L1453) |  |
| [1454](#L1454) | // When done, we have to print $occur.'||'.$photo.'||'.$index.'||'.$myavgrat.'||'.$allavgrat.'||'.$discount.'||'.$hascommented.'||'.$message; |
| [1455](#L1455) | // So we have to do: process rating and find new $myavgrat, $allavgrat and $discount ( $occur, $photo and $index are known ) |
| [1456](#L1456) | // Error message format: '0||<errcode>||<errtext> |
| [1457](#L1457) | // errcode = 900: user error, other codes: real errors |
| [1458](#L1458) |  |
| [1459](#L1459) | // Case -1: Likes only |
| [1460](#L1460) | if ( wppa\_opt( 'rating\_display\_type' ) == 'likes' ) { |
| [1461](#L1461) |  |
| [1462](#L1462) | // If i liked this, i do no longer like this |
| [1463](#L1463) | if ( $mylast ) { |
| [1464](#L1464) |  |
| [1465](#L1465) | // Remove my like |
| [1466](#L1466) | $query = $wpdb->prepare( "DELETE FROM $wpdb->wppa\_rating |
| [1467](#L1467) | WHERE photo = %d |
| [1468](#L1468) | AND user = %s", $photo, $user ); |
| [1469](#L1469) | wppa\_query( $query ); |
| [1470](#L1470) | $myavgrat = '0'; |
| [1471](#L1471) | } |
| [1472](#L1472) | else { |
| [1473](#L1473) |  |
| [1474](#L1474) | // Add my like |
| [1475](#L1475) | wppa\_create\_rating\_entry( array( 'photo' => $photo, 'value' => '1', 'user' => $user ) ); |
| [1476](#L1476) | $myavgrat = '1'; |
| [1477](#L1477) | } |
| [1478](#L1478) |  |
| [1479](#L1479) | // Update photo data |
| [1480](#L1480) | wppa\_rate\_photo( $photo ); |
| [1481](#L1481) |  |
| [1482](#L1482) | // Get callback data |
| [1483](#L1483) | $lt = wppa\_get\_like\_title\_a( $photo ); |
| [1484](#L1484) | $allavgratcombi = $lt['title'] . '|' . $lt['display']; |
| [1485](#L1485) |  |
| [1486](#L1486) | // Output and quit |
| [1487](#L1487) | wppa\_echo( wp\_json\_encode( ['txt' => $occur.'||'.$photo.'||'.$index.'||'.$myavgrat.'||'.esc\_attr( $allavgratcombi ).'||||||likes'] ) ); |
| [1488](#L1488) | wppa\_exit(); |
| [1489](#L1489) | } |
| [1490](#L1490) |  |
| [1491](#L1491) | // Case 0: Test for Illegal second vote. Frontend takes care of this, but a hacker could enter an ajaxlink manually or a program error cause this to happen |
| [1492](#L1492) | elseif ( $mylast ) { |
| [1493](#L1493) |  |
| [1494](#L1494) | // I did vote already |
| [1495](#L1495) |  |
| [1496](#L1496) | // Can vote only once |
| [1497](#L1497) | if ( ! wppa\_switch( 'rating\_change' ) && ! wppa\_switch( 'rating\_multi' ) ) { |
| [1498](#L1498) | wppa\_echo( wp\_json\_encode( ['txt' => '0||900||'.\_\_( 'You can not change your vote', 'wp-photo-album-plus' )] ) ); |
| [1499](#L1499) | wppa\_exit(); |
| [1500](#L1500) | } |
| [1501](#L1501) |  |
| [1502](#L1502) | // I did a dislike, can not modify |
| [1503](#L1503) | if ( $mylast < '0' ) { |
| [1504](#L1504) | wppa\_echo( wp\_json\_encode( ['txt' => '0||900||'.\_\_('You can not change a dislike', 'wp-photo-album-plus' )] ) ); |
| [1505](#L1505) | wppa\_exit(); |
| [1506](#L1506) | } |
| [1507](#L1507) |  |
| [1508](#L1508) | // I did a rating, can not change into dislike |
| [1509](#L1509) | if ( $mylast > '0' && $rating == '-1' ) { |
| [1510](#L1510) | wppa\_echo( wp\_json\_encode( ['txt' => '0||900||'.\_\_('You can not change your vote into a dislike', 'wp-photo-album-plus' )] ) ); |
| [1511](#L1511) | wppa\_exit(); |
| [1512](#L1512) | } |
| [1513](#L1513) | } |
| [1514](#L1514) |  |
| [1515](#L1515) | // Case 1: value = -1 this is a legal dislike vote |
| [1516](#L1516) | if ( $rating == '-1' ) { |
| [1517](#L1517) |  |
| [1518](#L1518) | // Add my dislike |
| [1519](#L1519) | $iret = wppa\_create\_rating\_entry( array( 'photo' => $photo, 'value' => $rating, 'user' => $user, 'status' => $ratingstatus ) ); |
| [1520](#L1520) | if ( ! $iret ) { |
| [1521](#L1521) | wppa\_echo( wp\_json\_encode( ['txt' => '0||101||'.$errtxt] ) ); |
| [1522](#L1522) | wppa\_exit();                                                                                                                    // Fail on storing vote |
| [1523](#L1523) | } |
| [1524](#L1524) |  |
| [1525](#L1525) | // Add points |
| [1526](#L1526) | wppa\_add\_credit\_points( wppa\_opt( 'cp\_points\_rating' ), \_\_( 'Photo rated' , 'wp-photo-album-plus' ), $photo, $rating ); |
| [1527](#L1527) |  |
| [1528](#L1528) | // Check for email to be sent every .. dislikes |
| [1529](#L1529) | wppa\_dislike\_check( $photo ); |
| [1530](#L1530) |  |
| [1531](#L1531) | // Photo is removed? |
| [1532](#L1532) | if ( ! wppa\_is\_file( wppa\_get\_thumb\_path( $photo ) ) ) { |
| [1533](#L1533) | wppa\_echo( wp\_json\_encode( ['txt' => $occur.'||'.$photo.'||'.$index.'||-1||-1|0||'.wppa\_opt( 'dislike\_delete' )] ) ); |
| [1534](#L1534) | wppa\_exit(); |
| [1535](#L1535) | } |
| [1536](#L1536) | } |
| [1537](#L1537) |  |
| [1538](#L1538) | // Case 2: This is my first vote for this photo |
| [1539](#L1539) | elseif ( ! $mylast ) { |
| [1540](#L1540) | // Add my vote |
| [1541](#L1541) | $iret = wppa\_create\_rating\_entry( array( 'photo' => $photo, 'value' => $rating, 'user' => $user, 'status' => $ratingstatus ) ); |
| [1542](#L1542) | if ( ! $iret ) { |
| [1543](#L1543) | wppa\_echo( wp\_json\_encode( ['txt' => '0||102||'.$errtxt] ) ); |
| [1544](#L1544) | wppa\_exit();                                                                                                                    // Fail on storing vote |
| [1545](#L1545) | } |
| [1546](#L1546) | // Add points |
| [1547](#L1547) | wppa\_add\_credit\_points( wppa\_opt( 'cp\_points\_rating' ), \_\_( 'Photo rated' , 'wp-photo-album-plus' ), $photo, $rating ); |
| [1548](#L1548) | } |
| [1549](#L1549) |  |
| [1550](#L1550) | // Case 3: I will change my previously given vote |
| [1551](#L1551) | elseif ( wppa\_switch( 'rating\_change' ) ) {                                     // Votechanging is allowed |
| [1552](#L1552) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_rating |
| [1553](#L1553) | SET value = %s |
| [1554](#L1554) | WHERE photo = %d |
| [1555](#L1555) | AND user = %s |
| [1556](#L1556) | LIMIT 1", $rating, $photo, $user ); |
| [1557](#L1557) | $iret = wppa\_query( $query ); |
| [1558](#L1558) |  |
| [1559](#L1559) | wppa\_clear\_cache( ['photo' => $photo, 'other' => 'R'] ); |
| [1560](#L1560) |  |
| [1561](#L1561) | if ( $iret === false ) { |
| [1562](#L1562) | wppa\_echo( wp\_json\_encode( ['txt' => '0||103||' . $errtxt] ) ); |
| [1563](#L1563) | wppa\_exit();                                                                                                                    // Fail on update |
| [1564](#L1564) | } |
| [1565](#L1565) | } |
| [1566](#L1566) |  |
| [1567](#L1567) | // Case 4: Add another vote from me |
| [1568](#L1568) | elseif ( wppa\_switch( 'rating\_multi' ) ) {                                      // Rating multi is allowed |
| [1569](#L1569) | $iret = wppa\_create\_rating\_entry( array( 'photo' => $photo, 'value' => $rating, 'user' => $user, 'status' => $ratingstatus ) ); |
| [1570](#L1570) | if ( ! $iret ) { |
| [1571](#L1571) | wppa\_echo( wp\_json\_encode( ['txt' => '0||104||'.$errtxt] ) ); |
| [1572](#L1572) | wppa\_exit();                                                                                                                    // Fail on storing vote |
| [1573](#L1573) | } |
| [1574](#L1574) | } |
| [1575](#L1575) |  |
| [1576](#L1576) | else {                                                                                                                                  // Should never get here.... |
| [1577](#L1577) | wppa\_echo( wp\_json\_encode( ['txt' => '0||110||'.\_\_( 'Unexpected error' , 'wp-photo-album-plus' )] ) ); |
| [1578](#L1578) | wppa\_exit(); |
| [1579](#L1579) | } |
| [1580](#L1580) |  |
| [1581](#L1581) | // Compute my avg rating |
| [1582](#L1582) | $query = $wpdb->prepare( "SELECT \* FROM $wpdb->wppa\_rating |
| [1583](#L1583) | WHERE photo = %d |
| [1584](#L1584) | AND user = %s |
| [1585](#L1585) | AND status = 'publish'", $photo, $user ); |
| [1586](#L1586) | $myrats = wppa\_get\_results( $query ); |
| [1587](#L1587) |  |
| [1588](#L1588) | if ( $myrats ) { |
| [1589](#L1589) | $sum = 0; |
| [1590](#L1590) | $cnt = 0; |
| [1591](#L1591) | foreach ( $myrats as $rat ) { |
| [1592](#L1592) | if ( $rat['value'] == '-1' ) { |
| [1593](#L1593) | $sum += wppa\_opt( 'dislike\_value' ); |
| [1594](#L1594) | } |
| [1595](#L1595) | else { |
| [1596](#L1596) | $sum += $rat['value']; |
| [1597](#L1597) | } |
| [1598](#L1598) | $cnt ++; |
| [1599](#L1599) | } |
| [1600](#L1600) | $myavgrat = $sum/$cnt; |
| [1601](#L1601) | $i = wppa\_opt( 'rating\_prec' ); |
| [1602](#L1602) | $j = $i + '1'; |
| [1603](#L1603) | $myavgrat = sprintf( '%'.$j.'.'.$i.'f', $myavgrat ); |
| [1604](#L1604) | } |
| [1605](#L1605) | else { |
| [1606](#L1606) | $myavgrat = '0'; |
| [1607](#L1607) | } |
| [1608](#L1608) |  |
| [1609](#L1609) | // Compute new allavgrat |
| [1610](#L1610) | $query = $wpdb->prepare( "SELECT \* FROM $wpdb->wppa\_rating |
| [1611](#L1611) | WHERE photo = %d |
| [1612](#L1612) | AND status = %s", $photo, 'publish' ); |
| [1613](#L1613) | $ratings = wppa\_get\_results( $query ); |
| [1614](#L1614) | if ( $ratings ) { |
| [1615](#L1615) | $sum = 0; |
| [1616](#L1616) | $cnt = 0; |
| [1617](#L1617) | foreach ( $ratings as $rat ) { |
| [1618](#L1618) | if ( $rat['value'] == '-1' ) { |
| [1619](#L1619) | $sum += wppa\_opt( 'dislike\_value' ); |
| [1620](#L1620) | } |
| [1621](#L1621) | else { |
| [1622](#L1622) | $sum += $rat['value']; |
| [1623](#L1623) | } |
| [1624](#L1624) | $cnt++; |
| [1625](#L1625) | } |
| [1626](#L1626) | $allavgrat = $sum/$cnt; |
| [1627](#L1627) | if ( $allavgrat == '10' ) $allavgrat = '9.99999999';    // For sort order reasons text field |
| [1628](#L1628) | } |
| [1629](#L1629) | else $allavgrat = '0'; |
| [1630](#L1630) |  |
| [1631](#L1631) | // Store it in the photo info |
| [1632](#L1632) | $iret = wppa\_update\_photo( $photo, ['mean\_rating' => $allavgrat] ); |
| [1633](#L1633) | if ( $iret === false ) { |
| [1634](#L1634) | wppa\_echo( wp\_json\_encode( ['txt' => '0||106||'.$wartxt] ) ); |
| [1635](#L1635) | wppa\_exit();                                                                                                                            // Fail on save |
| [1636](#L1636) | } |
| [1637](#L1637) |  |
| [1638](#L1638) | // Compute rating\_count and store in the photo info |
| [1639](#L1639) | $query = $wpdb->prepare( "SELECT COUNT(\*) FROM $wpdb->wppa\_rating |
| [1640](#L1640) | WHERE photo = %d |
| [1641](#L1641) | AND status = 'publish'", $photo ); |
| [1642](#L1642) | $ratcount = wppa\_get\_var( $query ); |
| [1643](#L1643) | if ( $ratcount !== false ) { |
| [1644](#L1644) | $iret = wppa\_update\_photo( $photo, ['rating\_count' => $ratcount] ); |
| [1645](#L1645) | if ( $iret === false ) { |
| [1646](#L1646) | wppa\_echo( wp\_json\_encode( ['txt' => '0||107||'.$wartxt] ) ); |
| [1647](#L1647) | wppa\_exit();                                                                                                                            // Fail on save |
| [1648](#L1648) | } |
| [1649](#L1649) | } |
| [1650](#L1650) |  |
| [1651](#L1651) | // Format $allavgrat for output |
| [1652](#L1652) | $allavgratcombi = $allavgrat.'|'.$ratcount; |
| [1653](#L1653) |  |
| [1654](#L1654) | // Compute dsilike count |
| [1655](#L1655) | $query = $wpdb->prepare( "SELECT COUNT(\*) FROM $wpdb->wppa\_rating |
| [1656](#L1656) | WHERE photo = %d |
| [1657](#L1657) | AND value = -1 |
| [1658](#L1658) | AND status = 'publish'", $photo ); |
| [1659](#L1659) | $discount = wppa\_get\_var( $query ); |
| [1660](#L1660) | if ( $discount === false ) { |
| [1661](#L1661) | wppa\_echo( wp\_json\_encode( ['txt' => '0||108||'.$wartxt] ) ); |
| [1662](#L1662) | wppa\_exit();                                                                                                                            // Fail on save |
| [1663](#L1663) | } |
| [1664](#L1664) | $distext = wppa\_get\_distext( $discount, $rating ); |
| [1665](#L1665) | if ( ! $distext ) { |
| [1666](#L1666) | $distext = '0'; |
| [1667](#L1667) | } |
| [1668](#L1668) |  |
| [1669](#L1669) | // Test for possible medal |
| [1670](#L1670) | wppa\_test\_for\_medal( $photo ); |
| [1671](#L1671) |  |
| [1672](#L1672) | // Success! |
| [1673](#L1673) | wppa\_clear\_cache( ['photo' => $photo] ); |
| [1674](#L1674) |  |
| [1675](#L1675) | if ( wppa\_switch( 'vote\_needs\_comment' ) && ! $hascommented ) { |
| [1676](#L1676) | $message = \_\_( "Please explain your vote in a comment.\nYour vote will be discarded if you don't.\n\nAfter completing your comment,\nyou can refresh the page to see\nyour vote became effective." , 'wp-photo-album-plus' ); |
| [1677](#L1677) | } |
| [1678](#L1678) | else { |
| [1679](#L1679) | $message = ''; |
| [1680](#L1680) | } |
| [1681](#L1681) |  |
| [1682](#L1682) | wppa\_echo( wp\_json\_encode( ['txt' => $occur.'||'.$photo.'||'.$index.'||'.$myavgrat.'||'.$allavgratcombi.'||'.$distext.'||'.$hascommented.'||'.$message] ) ); |
| [1683](#L1683) | break; |
| [1684](#L1684) |  |
| [1685](#L1685) | case 'render': |
| [1686](#L1686) | ob\_start(); |
| [1687](#L1687) | $tim\_1  = microtime( true ); |
| [1688](#L1688) | $nq\_1   = get\_num\_queries(); |
| [1689](#L1689) |  |
| [1690](#L1690) | require\_once 'wppa-non-admin.php'; |
| [1691](#L1691) | wppa\_load\_theme(); |
| [1692](#L1692) |  |
| [1693](#L1693) | // Render |
| [1694](#L1694) | $result = wppa\_albums(); |
| [1695](#L1695) |  |
| [1696](#L1696) | // Make relative urls if configured |
| [1697](#L1697) | $result = wppa\_make\_relative( $result ); |
| [1698](#L1698) |  |
| [1699](#L1699) | // Get the JS |
| [1700](#L1700) | $js = wppa\_print\_psjs( true ); |
| [1701](#L1701) |  |
| [1702](#L1702) | // Split result into HTML and JS (if any, it should not contain js) |
| [1703](#L1703) | $result = wppa\_split\_html\_js( $result ); |
| [1704](#L1704) |  |
| [1705](#L1705) | // Combine standard js and optional js found during split |
| [1706](#L1706) | if ( $result['js'] ) { |
| [1707](#L1707) | $js .= $result['js']; |
| [1708](#L1708) | } |
| [1709](#L1709) |  |
| [1710](#L1710) | // Compress html |
| [1711](#L1711) | $html = wppa\_compress\_html( $result['html'] ); |
| [1712](#L1712) |  |
| [1713](#L1713) | // Compress js |
| [1714](#L1714) | $js = wppa\_compress\_js( $js ); |
| [1715](#L1715) |  |
| [1716](#L1716) | // Get possible premature output |
| [1717](#L1717) | $unexpected = ob\_get\_clean(); |
| [1718](#L1718) | if ( $unexpected ) { |
| [1719](#L1719) | wppa\_log( 'err', strlen( $unexpected ) . ' chars of unexpected output captured while doing ajax render: ' . str\_replace( '&', '8', htmlspecialchars( $unexpected ) ) ); |
| [1720](#L1720) | } |
| [1721](#L1721) |  |
| [1722](#L1722) | // Output |
| [1723](#L1723) | echo wp\_json\_encode( ['html' => $html, 'js' => $js] ); |
| [1724](#L1724) |  |
| [1725](#L1725) | $tim\_2  = microtime( true ); |
| [1726](#L1726) | $nq\_2   = get\_num\_queries(); |
| [1727](#L1727) | $mem    = memory\_get\_peak\_usage( true ) / 1024 / 1024; |
| [1728](#L1728) |  |
| [1729](#L1729) | $msg    = sprintf( 'WPPA Ajax render: db queries: WP:%d, WPPA+: %d in %4.2f seconds, using %4.2f MB memory max', $nq\_1, $nq\_2 - $nq\_1, $tim\_2 - $tim\_1, $mem ); |
| [1730](#L1730) | wppa\_log( 'ajax', $msg ); |
| [1731](#L1731) | break; |
| [1732](#L1732) |  |
| [1733](#L1733) | case 'delete-photo': |
| [1734](#L1734) | $photo = wppa\_get( 'photo-id' ); |
| [1735](#L1735) | $nonce = wppa\_get( 'nonce' ); |
| [1736](#L1736) | $immediate = wppa\_get( 'immediate', false, 'bool' ); |
| [1737](#L1737) |  |
| [1738](#L1738) | // Check validity |
| [1739](#L1739) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce\_'.$photo ) ) { |
| [1740](#L1740) | wppa\_log( 'Misc', 'nonce failed on ' . $wppa\_action ); |
| [1741](#L1741) | wppa\_echo( '||0||'.\_\_( 'You do not have the rights to delete a photo' , 'wp-photo-album-plus' ) ); |
| [1742](#L1742) | wppa\_exit();                                                                                                                            // Nonce check failed |
| [1743](#L1743) | } |
| [1744](#L1744) | if ( ! is\_numeric( $photo ) ) { |
| [1745](#L1745) | wppa\_echo( '||0||'.\_\_( 'Security check failure' , 'wp-photo-album-plus' ) ); |
| [1746](#L1746) | wppa\_exit(); |
| [1747](#L1747) | } |
| [1748](#L1748) |  |
| [1749](#L1749) | // Non admins/superusers can only delete their own photos |
| [1750](#L1750) | if ( ! wppa\_user\_is\_admin() && wppa\_get\_photo\_item( $photo, 'owner' ) != wppa\_get\_user() ) { |
| [1751](#L1751) | wppa\_echo( '||0||'.\_\_( 'You do not have the rights to delete this photo' , 'wp-photo-album-plus' ) ); |
| [1752](#L1752) | wppa\_exit(); |
| [1753](#L1753) | } |
| [1754](#L1754) |  |
| [1755](#L1755) | $album = wppa\_get\_photo\_item( $photo, 'album' ); |
| [1756](#L1756) | wppa\_delete\_photo( $photo, $immediate ); |
| [1757](#L1757) | wppa\_clear\_cache( ['photo' => $photo] ); |
| [1758](#L1758) | wppa\_clear\_cache( ['album' => $album] ); |
| [1759](#L1759) | $edit\_link = wppa\_ea\_url( 'single' ) . '&photo=' . wppa\_encrypt\_photo( $photo ); |
| [1760](#L1760) | $a = wppa\_allow\_uploads( $album ); |
| [1761](#L1761) | if ( $immediate ) { |
| [1762](#L1762) | wppa\_echo( '||1||<span style="color:red" >' . |
| [1763](#L1763) | /\* translators: photo id \*/ |
| [1764](#L1764) | sprintf( \_\_( 'Photo %s has been permanently removed' ,'wp-photo-album-plus' ), '<a href="'.$edit\_link.'" target="\_blank" >' . $photo . '</a>' ) . |
| [1765](#L1765) | '</span>||' . ( $a ? 'notfull||'.$a : 'full' ) ); |
| [1766](#L1766) | } |
| [1767](#L1767) | else { |
| [1768](#L1768) | wppa\_echo( '||1||<span style="color:red" >' . |
| [1769](#L1769) | /\* translators: photo id \*/ |
| [1770](#L1770) | sprintf( \_\_( 'Photo %s has been deleted' ,'wp-photo-album-plus' ), '<a href="'.$edit\_link.'" target="\_blank" >' . $photo . '</a>' ) . |
| [1771](#L1771) | '</span>||' . ( $a ? 'notfull||'.$a : 'full' ) ); |
| [1772](#L1772) | } |
| [1773](#L1773) | break; |
| [1774](#L1774) |  |
| [1775](#L1775) | case 'undelete-photo': |
| [1776](#L1776) | $photo = wppa\_get( 'photo-id' ); |
| [1777](#L1777) | $nonce = wppa\_get( 'nonce' ); |
| [1778](#L1778) |  |
| [1779](#L1779) | // Check validity |
| [1780](#L1780) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce\_'.$photo ) ) { |
| [1781](#L1781) | wppa\_log( 'Misc', 'nonce failed on ' . $wppa\_action ); |
| [1782](#L1782) | wppa\_echo( '||0||'.\_\_( 'You do not have the rights to undelete a photo' , 'wp-photo-album-plus' ) ); |
| [1783](#L1783) | wppa\_exit();                                                                                                                            // Nonce check failed |
| [1784](#L1784) | } |
| [1785](#L1785) | if ( ! is\_numeric( $photo ) ) { |
| [1786](#L1786) | wppa\_echo( '||0||'.\_\_( 'Security check failure' , 'wp-photo-album-plus' ) ); |
| [1787](#L1787) | wppa\_exit();                                                                                                                            // Nonce check failed |
| [1788](#L1788) | } |
| [1789](#L1789) |  |
| [1790](#L1790) | wppa\_undelete\_photo( $photo, true ); |
| [1791](#L1791) |  |
| [1792](#L1792) | break; |
| [1793](#L1793) |  |
| [1794](#L1794) | case 'update-album': |
| [1795](#L1795) | $album = wppa\_get( 'album-id' ); |
| [1796](#L1796) | $nonce = wppa\_get( 'nonce' ); |
| [1797](#L1797) | $item  = wppa\_get( 'item', '', 'text' ); |
| [1798](#L1798) | if ( $item == 'description' ) { |
| [1799](#L1799) | $value = wppa\_get( 'value', '', 'html' ); |
| [1800](#L1800) | } |
| [1801](#L1801) | elseif( $item == 'cover\_link' ) { |
| [1802](#L1802) | $value = wppa\_get( 'value', '', 'url' ); |
| [1803](#L1803) | } |
| [1804](#L1804) | else { |
| [1805](#L1805) | $value = wppa\_get( 'value', '', 'text' ); |
| [1806](#L1806) | } |
| [1807](#L1807) | $value = wppa\_decode( $value ); |
| [1808](#L1808) |  |
| [1809](#L1809) | if ( ! current\_user\_can( 'unfiltered\_html' ) ) { |
| [1810](#L1810) | $value = wp\_strip\_all\_tags( $value ); |
| [1811](#L1811) | } |
| [1812](#L1812) | else { |
| [1813](#L1813) | $value = balanceTags( $value, true ); |
| [1814](#L1814) | } |
| [1815](#L1815) |  |
| [1816](#L1816) | // Check validity |
| [1817](#L1817) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce\_'.$album ) ) { |
| [1818](#L1818) | wppa\_echo( '||0||'.\_\_( 'You do not have the rights to update album information' , 'wp-photo-album-plus' ).$nonce ); |
| [1819](#L1819) | wppa\_exit();                                                                                                                            // Nonce check failed |
| [1820](#L1820) | } |
| [1821](#L1821) |  |
| [1822](#L1822) | switch ( $item ) { |
| [1823](#L1823) | case 'clear\_ratings': |
| [1824](#L1824) | $query = $wpdb->prepare( "SELECT \* FROM $wpdb->wppa\_photos WHERE album = %d", $album ); |
| [1825](#L1825) | $photos = wppa\_get\_results( $query ); |
| [1826](#L1826) | if ( $photos ) foreach ( $photos as $photo ) { |
| [1827](#L1827) | $iret1 = wppa\_del\_row( WPPA\_RATING, 'photo', $photo['id'] ); |
| [1828](#L1828) | $iret2 = wppa\_update\_photo( $photo['id'], ['mean\_rating' => ''] ); |
| [1829](#L1829) | } |
| [1830](#L1830) | if ( $photos && $iret1 !== false && $iret2 !== false ) { |
| [1831](#L1831) | wppa\_echo( '||0||'.\_\_( 'Ratings cleared' , 'wp-photo-album-plus' ).'||'.\_\_( 'No ratings for this photo.' , 'wp-photo-album-plus' ) ); |
| [1832](#L1832) | } |
| [1833](#L1833) | elseif ( $photos ) { |
| [1834](#L1834) | wppa\_echo( '||1||'.\_\_( 'An error occurred while clearing ratings' , 'wp-photo-album-plus' ) ); |
| [1835](#L1835) | } |
| [1836](#L1836) | else { |
| [1837](#L1837) | wppa\_echo( '||0||'.\_\_( 'No photos in this album' , 'wp-photo-album-plus' ).'||'.\_\_( 'No ratings for this photo.' , 'wp-photo-album-plus' ) ); |
| [1838](#L1838) | } |
| [1839](#L1839) | wppa\_exit(); |
| [1840](#L1840) | break; |
| [1841](#L1841) | case 'set\_deftags':     // to be changed for large albums |
| [1842](#L1842) | $query = $wpdb->prepare( "SELECT \* FROM $wpdb->wppa\_photos WHERE album = %d", $album ); |
| [1843](#L1843) | $photos = wppa\_get\_results( $query ); |
| [1844](#L1844) |  |
| [1845](#L1845) | $query = $wpdb->prepare( "SELECT default\_tags FROM $wpdb->wppa\_albums WHERE id = %d", $album ); |
| [1846](#L1846) | $deftag = wppa\_get\_var( $query ); |
| [1847](#L1847) |  |
| [1848](#L1848) | if ( is\_array( $photos ) ) foreach ( $photos as $photo ) { |
| [1849](#L1849) |  |
| [1850](#L1850) | $tags = wppa\_sanitize\_tags( wppa\_filter\_iptc( wppa\_filter\_exif( $deftag, $photo['id'] ), $photo['id'] ) ); |
| [1851](#L1851) | $iret = wppa\_update\_photo( $photo['id'], ['tags' => $tags] ); |
| [1852](#L1852) | } |
| [1853](#L1853) | if ( $photos && $iret !== false ) { |
| [1854](#L1854) | wppa\_echo( '||0||'.\_\_( 'Tags set to defaults' , 'wp-photo-album-plus' ) ); |
| [1855](#L1855) | wppa\_update\_album( $album ); |
| [1856](#L1856) | } |
| [1857](#L1857) | elseif ( $photos ) { |
| [1858](#L1858) | wppa\_echo( '||1||'.\_\_( 'An error occurred while setting tags' , 'wp-photo-album-plus' ) ); |
| [1859](#L1859) | } |
| [1860](#L1860) | else { |
| [1861](#L1861) | wppa\_echo( '||0||'.\_\_( 'No photos in this album' , 'wp-photo-album-plus' ) ); |
| [1862](#L1862) | } |
| [1863](#L1863) | wppa\_exit(); |
| [1864](#L1864) | break; |
| [1865](#L1865) | case 'add\_deftags': |
| [1866](#L1866) | $query = $wpdb->prepare( "SELECT \* FROM $wpdb->wppa\_photos WHERE album = %d", $album ); |
| [1867](#L1867) | $photos = wppa\_get\_results( $query ); |
| [1868](#L1868) |  |
| [1869](#L1869) | $query = $wpdb->prepare( "SELECT default\_tags FROM $wpdb->wppa\_albums WHERE id = %d", $album ); |
| [1870](#L1870) | $deftag = wppa\_get\_var( $query ); |
| [1871](#L1871) |  |
| [1872](#L1872) | if ( is\_array( $photos ) ) foreach ( $photos as $photo ) { |
| [1873](#L1873) |  |
| [1874](#L1874) | $tags = wppa\_sanitize\_tags( wppa\_filter\_iptc( wppa\_filter\_exif( $photo['tags'].','.$deftag, $photo['id'] ), $photo['id'] ) ); |
| [1875](#L1875) | $iret = wppa\_update\_photo( $photo['id'], ['tags' => $tags] ); |
| [1876](#L1876) | } |
| [1877](#L1877) | if ( $photos && $iret !== false ) { |
| [1878](#L1878) | wppa\_update\_album( $album ); |
| [1879](#L1879) | wppa\_echo( '||0||'.\_\_( 'Tags added with defaults' , 'wp-photo-album-plus' ) ); |
| [1880](#L1880) | } |
| [1881](#L1881) | elseif ( $photos ) { |
| [1882](#L1882) | wppa\_echo( '||1||'.\_\_( 'An error occurred while adding tags' , 'wp-photo-album-plus' ) ); |
| [1883](#L1883) | } |
| [1884](#L1884) | else { |
| [1885](#L1885) | wppa\_echo( '||0||'.\_\_( 'No photos in this album' , 'wp-photo-album-plus' ) ); |
| [1886](#L1886) | } |
| [1887](#L1887) | wppa\_clear\_taglist(); |
| [1888](#L1888) | wppa\_exit(); |
| [1889](#L1889) | break; |
| [1890](#L1890) | case 'inherit\_cats'; |
| [1891](#L1891) | case 'inhadd\_cats': |
| [1892](#L1892) | $albids = wppa\_expand\_enum( wppa\_alb\_to\_enum\_children( $album ) ); |
| [1893](#L1893) | $albarr = explode( '.', $albids ); |
| [1894](#L1894) | $cats = wppa\_get\_album\_item( $album, 'cats' ); |
| [1895](#L1895) | if ( $cats || $item == 'inherit\_cats' ) { |
| [1896](#L1896) | if ( count( $albarr ) > 1 ) { |
| [1897](#L1897) | foreach( $albarr as $alb ) if ( $album != $alb ) { |
| [1898](#L1898) | if ( $item == 'inherit\_cats' ) { |
| [1899](#L1899) | wppa\_update\_album( $alb, ['cats' => $cats] ); |
| [1900](#L1900) | } |
| [1901](#L1901) | else { // 'inhadd\_cats' |
| [1902](#L1902) | $mycats = wppa\_get\_album\_item( $alb, 'cats' ); |
| [1903](#L1903) | wppa\_update\_album( $alb, ['cats' => $mycats . $cats] ); |
| [1904](#L1904) | } |
| [1905](#L1905) | } |
| [1906](#L1906) | } |
| [1907](#L1907) | else { |
| [1908](#L1908) | wppa\_echo( '||0||' . \_\_( 'No sub albums found to process', 'wp-photo-album-plus' ) ); |
| [1909](#L1909) | wppa\_exit(); |
| [1910](#L1910) | } |
| [1911](#L1911) | } |
| [1912](#L1912) | else { |
| [1913](#L1913) | wppa\_echo( '||0||' . \_\_( 'No categories found to process', 'wp-photo-album-plus' ) ); |
| [1914](#L1914) | wppa\_exit(); |
| [1915](#L1915) | } |
| [1916](#L1916) | $n = count( $albarr ) - 1; |
| [1917](#L1917) | /\* translators: number of album(s) \*/ |
| [1918](#L1918) | wppa\_echo( '||0||' . sprintf( \_n( '%d album updated', '%d albums updated', $n, 'wp-photo-album-plus' ), $n ) ); |
| [1919](#L1919) | wppa\_exit(); |
| [1920](#L1920) | break; |
| [1921](#L1921) | case 'name': |
| [1922](#L1922) | $itemname = \_\_( 'Name' , 'wp-photo-album-plus' ); |
| [1923](#L1923) | break; |
| [1924](#L1924) | case 'description': |
| [1925](#L1925) | $itemname = \_\_( 'Description' , 'wp-photo-album-plus' ); |
| [1926](#L1926) | break; |
| [1927](#L1927) | case 'a\_order': |
| [1928](#L1928) | $itemname = \_\_( 'Album sequence order #' , 'wp-photo-album-plus' ); |
| [1929](#L1929) | break; |
| [1930](#L1930) | case 'main\_photo': |
| [1931](#L1931) | $itemname = \_\_( 'Cover photo' , 'wp-photo-album-plus' ); |
| [1932](#L1932) | break; |
| [1933](#L1933) | case 'a\_parent': |
| [1934](#L1934) | $itemname = \_\_( 'Parent album' , 'wp-photo-album-plus' ); |
| [1935](#L1935) | if ( ! wppa\_has\_many\_albums() ) { |
| [1936](#L1936) | $value = wppa\_decrypt\_album( $value ); |
| [1937](#L1937) | } |
| [1938](#L1938) | if ( $value < '-1' || $value == $album || ( $value > '0' && ! wppa\_album\_exists( $value ) ) ) { |
| [1939](#L1939) | wppa\_echo( '||3||' . sprintf( \_\_( 'Invalid parent value', 'wp-photo-album-plus' ), $itemname, $album ) ); |
| [1940](#L1940) | wppa\_exit(); |
| [1941](#L1941) | } |
| [1942](#L1942) | break; |
| [1943](#L1943) | case 'p\_order\_by': |
| [1944](#L1944) | $itemname = \_\_( 'Item sequence numbering method' , 'wp-photo-album-plus' ); |
| [1945](#L1945) | break; |
| [1946](#L1946) | case 'alt\_thumbsize': |
| [1947](#L1947) | $itemname = \_\_( 'Use Alt thumbsize' , 'wp-photo-album-plus' ); |
| [1948](#L1948) | break; |
| [1949](#L1949) | case 'cover\_type': |
| [1950](#L1950) | $itemname = \_\_( 'Cover Type' , 'wp-photo-album-plus' ); |
| [1951](#L1951) | break; |
| [1952](#L1952) | case 'cover\_linktype': |
| [1953](#L1953) | $itemname = \_\_( 'Link type' , 'wp-photo-album-plus' ); |
| [1954](#L1954) | break; |
| [1955](#L1955) | case 'cover\_linkpage': |
| [1956](#L1956) | $itemname = \_\_( 'Link to' , 'wp-photo-album-plus' ); |
| [1957](#L1957) | break; |
| [1958](#L1958) | case 'cover\_link': |
| [1959](#L1959) | $itemname = \_\_( 'Link target (url)', 'wp-photo-album-plus' ); |
| [1960](#L1960) | break; |
| [1961](#L1961) | case 'owner': |
| [1962](#L1962) | $itemname = \_\_( 'Owner' , 'wp-photo-album-plus' ); |
| [1963](#L1963) | break; |
| [1964](#L1964) | case 'upload\_limit\_count': |
| [1965](#L1965) | wppa\_ajax\_check\_range( $value, false, '-1', false, \_\_( 'Upload limit count' , 'wp-photo-album-plus' ) ); |
| [1966](#L1966) | if ( wppa( 'error' ) ) { |
| [1967](#L1967) | wppa\_echo( '||7||'.\_\_('Invalid value', 'wp-photo-album-plus' ) ); |
| [1968](#L1968) | wppa\_exit(); |
| [1969](#L1969) | } |
| [1970](#L1970) | $oldval = wppa\_get\_album\_item( $album, 'upload\_limit' ); |
| [1971](#L1971) | $temp = explode( '/', $oldval ); |
| [1972](#L1972) | $value = $value.'/'.$temp[1]; |
| [1973](#L1973) | $item = 'upload\_limit'; |
| [1974](#L1974) | $itemname = \_\_( 'Upload limit count' , 'wp-photo-album-plus' ); |
| [1975](#L1975) | break; |
| [1976](#L1976) | case 'upload\_limit\_time': |
| [1977](#L1977) | $oldval = wppa\_get\_album\_item( $album, 'upload\_limit' ); |
| [1978](#L1978) | $temp = explode( '/', $oldval ); |
| [1979](#L1979) | $value = $temp[0].'/'.$value; |
| [1980](#L1980) | $item = 'upload\_limit'; |
| [1981](#L1981) | $itemname = \_\_( 'Upload limit time' , 'wp-photo-album-plus' ); |
| [1982](#L1982) | break; |
| [1983](#L1983) | case 'default\_tags': |
| [1984](#L1984) | $itemname = \_\_( 'Default tags' , 'wp-photo-album-plus' ); |
| [1985](#L1985) | break; |
| [1986](#L1986) | case 'cats': |
| [1987](#L1987) | $itemname = \_\_( 'Categories' , 'wp-photo-album-plus' ); |
| [1988](#L1988) | break; |
| [1989](#L1989) | case 'suba\_order\_by': |
| [1990](#L1990) | $itemname = \_\_( 'Sub albums sort order' , 'wp-photo-album-plus' ); |
| [1991](#L1991) | break; |
| [1992](#L1992) |  |
| [1993](#L1993) | case 'year': |
| [1994](#L1994) | case 'month': |
| [1995](#L1995) | case 'day': |
| [1996](#L1996) | case 'hour': |
| [1997](#L1997) | case 'min': |
| [1998](#L1998) | $itemname = \_\_( 'Schedule date/time' , 'wp-photo-album-plus' ); |
| [1999](#L1999) | $scheduledtm = wppa\_get\_album\_item( $album, 'scheduledtm' ); |
| [2000](#L2000) | if ( ! $scheduledtm ) { |
| [2001](#L2001) | $scheduledtm = wppa\_get\_default\_scheduledtm(); |
| [2002](#L2002) | } |
| [2003](#L2003) | $temp = explode( ',', $scheduledtm ); |
| [2004](#L2004) | if ( $item == 'year' )  $temp[0] = $value; |
| [2005](#L2005) | if ( $item == 'month' ) $temp[1] = $value; |
| [2006](#L2006) | if ( $item == 'day' )   $temp[2] = $value; |
| [2007](#L2007) | if ( $item == 'hour' )  $temp[3] = $value; |
| [2008](#L2008) | if ( $item == 'min' )   $temp[4] = $value; |
| [2009](#L2009) | $value = implode( ',', $temp ); |
| [2010](#L2010) | $item = 'scheduledtm'; |
| [2011](#L2011) | break; |
| [2012](#L2012) |  |
| [2013](#L2013) | case 'delyear': |
| [2014](#L2014) | case 'delmonth': |
| [2015](#L2015) | case 'delday': |
| [2016](#L2016) | case 'delhour': |
| [2017](#L2017) | case 'delmin': |
| [2018](#L2018) | $itemname = \_\_( 'Delete date/time' , 'wp-photo-album-plus' ); |
| [2019](#L2019) | $scheduledtm = wppa\_get\_album\_item( $album, 'scheduledel' ); |
| [2020](#L2020) | if ( ! $scheduledtm ) { |
| [2021](#L2021) | $scheduledtm = wppa\_get\_default\_scheduledtm(); |
| [2022](#L2022) | } |
| [2023](#L2023) | $temp = explode( ',', $scheduledtm ); |
| [2024](#L2024) | if ( $item == 'delyear' )       $temp[0] = $value; |
| [2025](#L2025) | if ( $item == 'delmonth' )      $temp[1] = $value; |
| [2026](#L2026) | if ( $item == 'delday' )        $temp[2] = $value; |
| [2027](#L2027) | if ( $item == 'delhour' )       $temp[3] = $value; |
| [2028](#L2028) | if ( $item == 'delmin' )        $temp[4] = $value; |
| [2029](#L2029) | $value = implode( ',', $temp ); |
| [2030](#L2030) | $item = 'scheduledel'; |
| [2031](#L2031) | break; |
| [2032](#L2032) |  |
| [2033](#L2033) | case 'setallscheduled': |
| [2034](#L2034) | $scheduledtm = wppa\_get\_album\_item( $album, 'scheduledtm' ); |
| [2035](#L2035) | if ( $scheduledtm ) { |
| [2036](#L2036) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_photos |
| [2037](#L2037) | SET status = 'scheduled', scheduledtm = %s |
| [2038](#L2038) | WHERE album = %d", $scheduledtm, $album ); |
| [2039](#L2039) | $iret = wppa\_query( $query ); |
| [2040](#L2040) | wppa\_echo( '||0||'.\_\_( 'All photos set to scheduled per date', 'wp-photo-album-plus' ) . ' ' . wppa\_format\_scheduledtm( $scheduledtm ) ); |
| [2041](#L2041) | } |
| [2042](#L2042) | wppa\_exit(); |
| [2043](#L2043) | break; |
| [2044](#L2044) |  |
| [2045](#L2045) | case 'displayopt0': |
| [2046](#L2046) | case 'displayopt1': |
| [2047](#L2047) | case 'displayopt2': |
| [2048](#L2048) | case 'displayopt3': |
| [2049](#L2049) | $itemname = \_\_( 'Display options', 'wp-photo-album-plus' ); |
| [2050](#L2050) | $dispopts = wppa\_get\_album\_item( $album, 'displayopts' ); |
| [2051](#L2051) | if ( $dispopts ) { |
| [2052](#L2052) | $opts = explode( ',', $dispopts ); |
| [2053](#L2053) | } |
| [2054](#L2054) | for ( $i = 0; $i < 4; $i++ ) { |
| [2055](#L2055) | if ( ! isset( $opts[$i] ) ) { |
| [2056](#L2056) | $opts[$i] = '0'; |
| [2057](#L2057) | } |
| [2058](#L2058) | } |
| [2059](#L2059) | $i = substr( $item , 10 ); |
| [2060](#L2060) | $opts[$i] = $value; |
| [2061](#L2061) | $value = implode( ',', $opts ); |
| [2062](#L2062) | $item = 'displayopts'; |
| [2063](#L2063) | break; |
| [2064](#L2064) |  |
| [2065](#L2065) | case 'album\_custom\_0': |
| [2066](#L2066) | case 'album\_custom\_1': |
| [2067](#L2067) | case 'album\_custom\_2': |
| [2068](#L2068) | case 'album\_custom\_3': |
| [2069](#L2069) | case 'album\_custom\_4': |
| [2070](#L2070) | case 'album\_custom\_5': |
| [2071](#L2071) | case 'album\_custom\_6': |
| [2072](#L2072) | case 'album\_custom\_7': |
| [2073](#L2073) | case 'album\_custom\_8': |
| [2074](#L2074) | case 'album\_custom\_9': |
| [2075](#L2075) | $index          = substr( $item, -1 ); |
| [2076](#L2076) | /\* translators: custom field number \*/ |
| [2077](#L2077) | $itemname = sprintf( \_\_( 'Custom field %d' , 'wp-photo-album-plus' ), $index ); |
| [2078](#L2078) | $custom         = wppa\_get\_album\_item( $album, 'custom' ); |
| [2079](#L2079) | $custom\_data = array( '', '', '', '', '', '', '', '', '', '' ); |
| [2080](#L2080) | if ( $custom ) { |
| [2081](#L2081) | $custom\_data = wppa\_unserialize( $custom ); |
| [2082](#L2082) | } |
| [2083](#L2083) | $custom\_data[$index] = wppa\_sanitize\_custom\_field( $value ); |
| [2084](#L2084) | $value = serialize( $custom\_data ); |
| [2085](#L2085) | $item = 'custom'; |
| [2086](#L2086) | break; |
| [2087](#L2087) |  |
| [2088](#L2088) | case 'scheduledel': |
| [2089](#L2089) | $value = ''; |
| [2090](#L2090) | $itemname = \_\_( 'Delete date/time' , 'wp-photo-album-plus' ); |
| [2091](#L2091) | break; |
| [2092](#L2092) |  |
| [2093](#L2093) | case 'scheduledtm': |
| [2094](#L2094) | $value = ''; |
| [2095](#L2095) | $itemname = \_\_( 'Schedule date/time' , 'wp-photo-album-plus' ); |
| [2096](#L2096) | break; |
| [2097](#L2097) |  |
| [2098](#L2098) | case 'wmfile': |
| [2099](#L2099) | $itemname = \_\_( 'Watermark file', 'wp-photo-album-plus' ); |
| [2100](#L2100) | break; |
| [2101](#L2101) |  |
| [2102](#L2102) | case 'wmpos': |
| [2103](#L2103) | $itemname = \_\_( 'Watermark position', 'wp-photo-album-plus' ); |
| [2104](#L2104) | break; |
| [2105](#L2105) |  |
| [2106](#L2106) | default: |
| [2107](#L2107) | $itemname = $item; |
| [2108](#L2108) | } |
| [2109](#L2109) |  |
| [2110](#L2110) | // Do the update |
| [2111](#L2111) | $iret = wppa\_update\_album( $album, [$item => $value] ); |
| [2112](#L2112) |  |
| [2113](#L2113) | if ( $iret === 0 ) { |
| [2114](#L2114) | /\* translators: itemname, album id \*/ |
| [2115](#L2115) | wppa\_echo( '||1||' . sprintf( \_\_( '%1$s of album %2$d NOT updated', 'wp-photo-album-plus' ), $itemname, $album ) ); |
| [2116](#L2116) | } |
| [2117](#L2117) | elseif ( $iret === false ) { |
| [2118](#L2118) | /\* translators: itemname, album id \*/ |
| [2119](#L2119) | wppa\_echo( '||2||' . sprintf( \_\_( 'An error occurred while trying to update %1$s of album %2$d' , 'wp-photo-album-plus' ), $itemname, $album ) ); |
| [2120](#L2120) | } |
| [2121](#L2121) | else { |
| [2122](#L2122) | /\* translators: itemname, album id \*/ |
| [2123](#L2123) | wppa\_echo( '||0||'.sprintf( \_\_( '%1$s of album %2$d updated', 'wp-photo-album-plus' ), $itemname, $album ) ); |
| [2124](#L2124) | if ( $item == 'upload\_limit' ) { |
| [2125](#L2125) | $a = wppa\_allow\_uploads( $album ); |
| [2126](#L2126) | if ( $a ) wppa\_echo( '||notfull||' . $a ); |
| [2127](#L2127) | else wppa\_echo( '||full' ); |
| [2128](#L2128) | } |
| [2129](#L2129) | } |
| [2130](#L2130) | wppa\_exit(); |
| [2131](#L2131) | break; |
| [2132](#L2132) |  |
| [2133](#L2133) | case 'update-comment-status': |
| [2134](#L2134) | $photo          = wppa\_get( 'photo-id' ); |
| [2135](#L2135) | $nonce          = wppa\_get( 'nonce' ); |
| [2136](#L2136) | $comid          = wppa\_get( 'comment-id' ); |
| [2137](#L2137) | $comstat        = wppa\_get( 'comment-status' ); |
| [2138](#L2138) |  |
| [2139](#L2139) | // Check validity |
| [2140](#L2140) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce\_'.$photo ) ) { |
| [2141](#L2141) | wppa\_echo( '||0||'.\_\_( 'You do not have the rights to update comment status' , 'wp-photo-album-plus' ).$nonce ); |
| [2142](#L2142) | wppa\_exit();                                                                                                                            // Nonce check failed |
| [2143](#L2143) | } |
| [2144](#L2144) |  |
| [2145](#L2145) | $iret = wppa\_update\_comment( $comid, ['status' => $comstat] ); |
| [2146](#L2146) |  |
| [2147](#L2147) | if ( wppa\_switch( 'search\_comments' ) ) { |
| [2148](#L2148) | wppa\_update\_photo( $photo ); |
| [2149](#L2149) | } |
| [2150](#L2150) |  |
| [2151](#L2151) | if ( $iret !== false ) { |
| [2152](#L2152) | if ( $comstat == 'approved' ) { |
| [2153](#L2153) | wppa\_schedule\_mailinglist( 'commentapproved', 0, 0, $comid ); |
| [2154](#L2154) | wppa\_add\_credit\_points(         wppa\_opt( 'cp\_points\_comment\_appr' ), |
| [2155](#L2155) | \_\_( 'Photo comment approved' , 'wp-photo-album-plus' ), |
| [2156](#L2156) | $photo, |
| [2157](#L2157) | '', |
| [2158](#L2158) | wppa\_get\_photo\_item( $photo, 'owner' ) |
| [2159](#L2159) | ); |
| [2160](#L2160) | } |
| [2161](#L2161) | /\* translators: comment id \*/ |
| [2162](#L2162) | wppa\_echo( '||0||'.sprintf( \_\_( 'Status of comment #%s updated' , 'wp-photo-album-plus' ), $comid ) ); |
| [2163](#L2163) | } |
| [2164](#L2164) | else { |
| [2165](#L2165) | /\* translators: comment id \*/ |
| [2166](#L2166) | wppa\_echo( '||1||'.sprintf( \_\_( 'Error updating status comment #%s' , 'wp-photo-album-plus' ), $comid ) ); |
| [2167](#L2167) | } |
| [2168](#L2168) | wppa\_exit(); |
| [2169](#L2169) | break; |
| [2170](#L2170) |  |
| [2171](#L2171) | case 'watermark-photo': |
| [2172](#L2172) | $photo = wppa\_get( 'photo-id' ); |
| [2173](#L2173) | $nonce = wppa\_get( 'nonce' ); |
| [2174](#L2174) |  |
| [2175](#L2175) | // Check validity |
| [2176](#L2176) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce\_'.$photo ) ) { |
| [2177](#L2177) | wppa\_echo( '||1||'.\_\_( 'You do not have the rights to change photos', 'wp-photo-album-plus' ) ); |
| [2178](#L2178) | wppa\_exit();                                                                                                                            // Nonce check failed |
| [2179](#L2179) | } |
| [2180](#L2180) |  |
| [2181](#L2181) | wppa\_cache\_photo( $photo ); |
| [2182](#L2182) | if ( wppa\_add\_watermark( $photo ) ) { |
| [2183](#L2183) | if ( wppa\_switch( 'watermark\_thumbs' ) ) { |
| [2184](#L2184) | wppa\_create\_thumbnail( $photo );        // create new thumb |
| [2185](#L2185) | } |
| [2186](#L2186) | wppa\_bump\_thumb\_rev(); |
| [2187](#L2187) | wppa\_bump\_photo\_rev(); |
| [2188](#L2188) | wppa\_echo( '||0||'.\_\_( 'Watermark applied. Reloading the page...', 'wp-photo-album-plus' ) ); |
| [2189](#L2189) | wppa\_exit(); |
| [2190](#L2190) | } |
| [2191](#L2191) | else { |
| [2192](#L2192) | wppa\_echo( '||1||'.\_\_( 'An error occurred while trying to apply a watermark', 'wp-photo-album-plus' ) ); |
| [2193](#L2193) | wppa\_exit(); |
| [2194](#L2194) | } |
| [2195](#L2195) |  |
| [2196](#L2196) | case 'update-photo': |
| [2197](#L2197) |  |
| [2198](#L2198) | // Init |
| [2199](#L2199) | $photo          = wppa\_get( 'photo-id' ); |
| [2200](#L2200) | $nonce          = wppa\_get( 'nonce' ); |
| [2201](#L2201) | $item           = wppa\_get( 'item' ); |
| [2202](#L2202) | $err            = '0'; |
| [2203](#L2203) | $txt            = ''; |
| [2204](#L2204) | $dbfields       = array();      // Fields for update |
| [2205](#L2205) | $jsfields       = array();      // Fields for JSON response |
| [2206](#L2206) | $itemname       = ''; |
| [2207](#L2207) |  |
| [2208](#L2208) | // Get and sanitize value |
| [2209](#L2209) | if ( $item == 'description' ) { |
| [2210](#L2210) | $value = wppa\_get( 'value', '', 'html' ); |
| [2211](#L2211) | } |
| [2212](#L2212) | else { |
| [2213](#L2213) | $value = wppa\_get( 'value', '', 'text' ); |
| [2214](#L2214) | } |
| [2215](#L2215) | $value = wppa\_decode( $value ); |
| [2216](#L2216) |  |
| [2217](#L2217) | if ( ! current\_user\_can( 'unfiltered\_html' ) ) { |
| [2218](#L2218) | $value = wp\_strip\_all\_tags( $value ); |
| [2219](#L2219) | } |
| [2220](#L2220) | else { |
| [2221](#L2221) | $value = balanceTags( $value ); |
| [2222](#L2222) | } |
| [2223](#L2223) |  |
| [2224](#L2224) | // Check validity |
| [2225](#L2225) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce\_'.$photo ) ) { |
| [2226](#L2226) | $txt = \_\_( 'Security check failure: wrong noncefield value' , 'wp-photo-album-plus' ); |
| [2227](#L2227) | wppa\_json\_photo\_update( $photo, $txt, '1' );                                                                                                                    // Nonce check failed |
| [2228](#L2228) | wppa\_exit(); |
| [2229](#L2229) | } |
| [2230](#L2230) |  |
| [2231](#L2231) | // Special case: watemark file or position. This is user specific |
| [2232](#L2232) | if ( substr( $item, 0, 20 ) == 'wppa\_watermark\_file\_' || substr( $item, 0, 19 ) == 'wppa\_watermark\_pos\_' ) { |
| [2233](#L2233) | wppa\_update\_option( $item, $value ); |
| [2234](#L2234) | if ( substr( $item, 0, 20 ) == 'wppa\_watermark\_file\_' ) { |
| [2235](#L2235) | $item = \_\_( 'Your personal watermark file', 'wp-photo-album-plus' ); |
| [2236](#L2236) | } |
| [2237](#L2237) | else { |
| [2238](#L2238) | $item = \_\_( 'Your personal watermark position', 'wp-photo-album-plus' ); |
| [2239](#L2239) | } |
| [2240](#L2240) | /\* translators: itemname, new value \*/ |
| [2241](#L2241) | $txt = sprintf( \_\_( '%1$s updated to %2$s.' , 'wp-photo-album-plus' ), $item, $value ); |
| [2242](#L2242) | wppa\_json\_photo\_update( $photo, $txt ); |
| [2243](#L2243) | wppa\_exit(); |
| [2244](#L2244) | } |
| [2245](#L2245) |  |
| [2246](#L2246) | // Dispatch on photo item |
| [2247](#L2247) | switch ( $item ) { |
| [2248](#L2248) | case 'exifdtm': |
| [2249](#L2249) | $itemname       = \_\_( 'Exif date/time', 'wp-photo-album-plus' ); |
| [2250](#L2250) | $format         = '0000:00:00 00:00:00'; |
| [2251](#L2251) |  |
| [2252](#L2252) | // Length ok? |
| [2253](#L2253) | if ( strlen( $value ) != 19 ) { |
| [2254](#L2254) | $err = '1'; |
| [2255](#L2255) | } |
| [2256](#L2256) |  |
| [2257](#L2257) | // Check on digits, colons and space |
| [2258](#L2258) | if ( ! $err ) for ( $i = 0; $i < 19; $i++ ) { |
| [2259](#L2259) | $d = substr( $value, $i, 1 ); |
| [2260](#L2260) | $f = substr( $format, $i, 1 ); |
| [2261](#L2261) | switch ( $f ) { |
| [2262](#L2262) | case '0': |
| [2263](#L2263) | if ( ! in\_array( $d, array( '0', '1', '2', '3', '4', '5', '6', '7', '8', '9' ) ) ) { |
| [2264](#L2264) | $err = '2'; |
| [2265](#L2265) | } |
| [2266](#L2266) | break; |
| [2267](#L2267) | case ':': |
| [2268](#L2268) | case ' ': |
| [2269](#L2269) | if ( $d != $f ) { |
| [2270](#L2270) | $err = '3'; |
| [2271](#L2271) | } |
| [2272](#L2272) | break; |
| [2273](#L2273) | default: |
| [2274](#L2274) | $err = '9'; |
| [2275](#L2275) | break; |
| [2276](#L2276) | } |
| [2277](#L2277) | } |
| [2278](#L2278) |  |
| [2279](#L2279) | // Check on values if format correct, report first error only |
| [2280](#L2280) | if ( ! $err ) { |
| [2281](#L2281) | $temp = explode( ':', str\_replace( ' ', ':', $value ) ); |
| [2282](#L2282) | if ( $temp['0'] < '1970' )                                      $err = '11';    // Before UNIX epoch |
| [2283](#L2283) | if ( ! $err && $temp['0'] > wp\_date( 'Y' ) )    $err = '12';    // Future |
| [2284](#L2284) | if ( ! $err && $temp['1'] < '1' )                       $err = '13';    // Before january |
| [2285](#L2285) | if ( ! $err && $temp['1'] > '12' )                      $err = '14';    // After december |
| [2286](#L2286) | if ( ! $err && $temp['2'] < '1' )                       $err = '15';    // Before first of month |
| [2287](#L2287) | if ( ! $err && $temp['2'] > '31' )                      $err = '17';    // After 31st ( forget about feb and months with 30 days ) |
| [2288](#L2288) | if ( ! $err && $temp['3'] < '0' )                       $err = '18';    // Before first hour |
| [2289](#L2289) | if ( ! $err && $temp['3'] > '23' )                      $err = '19';    // Hour > 23 |
| [2290](#L2290) | if ( ! $err && $temp['4'] < '0' )                       $err = '20';    // Min < 0 |
| [2291](#L2291) | if ( ! $err && $temp['4'] > '59' )                      $err = '21';    // Min > 59 |
| [2292](#L2292) | if ( ! $err && $temp['5'] < '0' )                       $err = '22';    // Sec < 0 |
| [2293](#L2293) | if ( ! $err && $temp['5'] > '59' )                      $err = '23';    // Sec > 59 |
| [2294](#L2294) | } |
| [2295](#L2295) | if ( $err ) { |
| [2296](#L2296) | /\* translators: error code \*/ |
| [2297](#L2297) | $txt = sprintf( \_\_( 'Format error %d. Must be yyyy:mm:dd hh:mm:ss' , 'wp-photo-album-plus' ), $err ); |
| [2298](#L2298) | } |
| [2299](#L2299) | else { |
| [2300](#L2300) | $dbfields[$item] = $value; |
| [2301](#L2301) | } |
| [2302](#L2302) | $jsfields[$item] = true; |
| [2303](#L2303) | break; |
| [2304](#L2304) | case 'lat': |
| [2305](#L2305) | $itemname = \_\_( 'Latitude', 'wp-photo-album-plus' ); |
| [2306](#L2306) | if ( ! is\_numeric( $value ) || $value < '-90.0' || $value > '90.0' ) { |
| [2307](#L2307) | $txt = \_\_( 'Enter a value > -90 and < 90' , 'wp-photo-album-plus' ); |
| [2308](#L2308) | $err = '1'; |
| [2309](#L2309) | } |
| [2310](#L2310) | else { |
| [2311](#L2311) | $geo = wppa\_get\_photo\_item( $photo, 'location' ); |
| [2312](#L2312) | if ( ! $geo ) $geo = '///'; |
| [2313](#L2313) | $geo = explode( '/', $geo ); |
| [2314](#L2314) | $geo = wppa\_format\_geo( $value, $geo['3'] ); |
| [2315](#L2315) | $dbfields['location'] = $geo; |
| [2316](#L2316) | } |
| [2317](#L2317) | $jsfields[$item] = true; |
| [2318](#L2318) | break; |
| [2319](#L2319) | case 'lon': |
| [2320](#L2320) | $itemname = \_\_( 'Longitude', 'wp-photo-album-plus' ); |
| [2321](#L2321) | if ( ! is\_numeric( $value ) || $value < '-180.0' || $value > '180.0' ) { |
| [2322](#L2322) | $txt = \_\_( 'Enter a value > -180 and < 180' , 'wp-photo-album-plus' ); |
| [2323](#L2323) | $err = '1'; |
| [2324](#L2324) | } |
| [2325](#L2325) | else { |
| [2326](#L2326) | $geo = wppa\_get\_photo\_item( $photo, 'location' ); |
| [2327](#L2327) | if ( ! $geo ) $geo = '///'; |
| [2328](#L2328) | $geo = explode( '/', $geo ); |
| [2329](#L2329) | $geo = wppa\_format\_geo( $value, $geo['3'] ); |
| [2330](#L2330) | $dbfields['location'] = $geo; |
| [2331](#L2331) | } |
| [2332](#L2332) | $jsfields[$item] = true; |
| [2333](#L2333) | break; |
| [2334](#L2334) | case 'remake': |
| [2335](#L2335) | //                                      wppa\_unlink( wppa\_get\_photo\_path( $photo ) ); |
| [2336](#L2336) | if ( wppa\_remake\_files( '', $photo, true ) ) { |
| [2337](#L2337) | $txt = \_\_( 'Display file remade' , 'wp-photo-album-plus' ); // . $extra; |
| [2338](#L2338) | } |
| [2339](#L2339) | else { |
| [2340](#L2340) | $txt = \_\_( 'Could not remake display file' , 'wp-photo-album-plus' ); |
| [2341](#L2341) | } |
| [2342](#L2342) | $jsfields['photomod'] = true; |
| [2343](#L2343) | break; |
| [2344](#L2344) | case 'remakethumbfs':   // from source |
| [2345](#L2345) | case 'remakethumbfd';   // from display |
| [2346](#L2346) | if ( wppa\_create\_thumbnail( $photo, $item == 'remakethumbfs' ) ) { |
| [2347](#L2347) | $txt = \_\_( 'Thumbnail remade' , 'wp-photo-album-plus' ); |
| [2348](#L2348) | } |
| [2349](#L2349) | else { |
| [2350](#L2350) | $txt = \_\_( 'Could not remake thumbnail', 'wp-photo-album-plus' ); |
| [2351](#L2351) | $err ='1'; |
| [2352](#L2352) | } |
| [2353](#L2353) | $jsfields['thumbmod'] = true; |
| [2354](#L2354) | break; |
| [2355](#L2355) | case 'rotthumbleft': |
| [2356](#L2356) | case 'rotthumbright': |
| [2357](#L2357) | $deg = ( $item == 'rotthumbleft' ? 8 : 6 ); |
| [2358](#L2358) | $locked = wppa\_get\_photo\_item( $photo, 'thumblock' ); |
| [2359](#L2359) | if ( ! $locked ) { |
| [2360](#L2360) | $bret = wppa\_orientate\_image\_file( wppa\_get\_thumb\_path( $photo ), $deg ); |
| [2361](#L2361) | } |
| [2362](#L2362) | else { |
| [2363](#L2363) | $bret = false; |
| [2364](#L2364) | } |
| [2365](#L2365) | if ( $bret ) { |
| [2366](#L2366) | $txt = \_\_( 'Thumbnail rotated', 'wp-photo-album-plus' ); |
| [2367](#L2367) | $jsfields['thumbmod'] = true; |
| [2368](#L2368) | } |
| [2369](#L2369) | else { |
| [2370](#L2370) | $txt = \_\_( 'Could not rotate thumbnail', 'wp-photo-album-plus' ); |
| [2371](#L2371) | $err ='1'; |
| [2372](#L2372) | } |
| [2373](#L2373) | break; |
| [2374](#L2374) | case 'rotdisplayleft': |
| [2375](#L2375) | case 'rotdisplayright': |
| [2376](#L2376) | $deg = ( $item == 'rotdisplayleft' ? 8 : 6 ); |
| [2377](#L2377) | $bret = wppa\_orientate\_image\_file( wppa\_get\_photo\_path( $photo ), $deg ); |
| [2378](#L2378) | if ( $bret ) { |
| [2379](#L2379) | $txt = \_\_( 'Display rotated', 'wp-photo-album-plus' ); |
| [2380](#L2380) | $jsfields['photomod'] = true; |
| [2381](#L2381) | } |
| [2382](#L2382) | else { |
| [2383](#L2383) | $txt = \_\_( 'Could not rotate display', 'wp-photo-album-plus' ); |
| [2384](#L2384) | $err ='1'; |
| [2385](#L2385) | } |
| [2386](#L2386) | break; |
| [2387](#L2387) | case 'rotright': |
| [2388](#L2388) | case 'rot180': |
| [2389](#L2389) | case 'rotleft': |
| [2390](#L2390) | case 'flip': |
| [2391](#L2391) | case 'flop': |
| [2392](#L2392) | switch ( $item ) { |
| [2393](#L2393) | case 'rotleft': |
| [2394](#L2394) | $dir = \_\_( 'left' , 'wp-photo-album-plus' ); |
| [2395](#L2395) | break; |
| [2396](#L2396) | case 'rot180': |
| [2397](#L2397) | $dir = \_\_( '180&deg;' , 'wp-photo-album-plus' ); |
| [2398](#L2398) | break; |
| [2399](#L2399) | case 'rotright': |
| [2400](#L2400) | $dir = \_\_( 'right' , 'wp-photo-album-plus' ); |
| [2401](#L2401) | break; |
| [2402](#L2402) | case 'flip': |
| [2403](#L2403) | case 'flop': |
| [2404](#L2404) | default: |
| [2405](#L2405) | $dir = ''; |
| [2406](#L2406) | break; |
| [2407](#L2407) | } |
| [2408](#L2408) | $err = wppa\_rotate( $photo, $item ); |
| [2409](#L2409) | wppa( 'error', $err ); |
| [2410](#L2410) | if ( ! $err || $err == '30' ) { |
| [2411](#L2411) | if ( wppa\_get\_photo\_item( $photo, 'thumblock' ) ) { |
| [2412](#L2412) | $extra = '<span style=\"color:red\" > ' . \_\_( 'The thumbnail could not be remade', 'wp-photo-album-plus' ) . '</span>'; |
| [2413](#L2413) | } |
| [2414](#L2414) | else { |
| [2415](#L2415) | $extra = ''; |
| [2416](#L2416) | } |
| [2417](#L2417) | if ( $item == 'flip' ) { |
| [2418](#L2418) | $txt = sprintf( \_\_( 'Photo flipped' , 'wp-photo-album-plus' ), $photo ) . $extra; |
| [2419](#L2419) | } |
| [2420](#L2420) | elseif ( $item == 'flop' ) { |
| [2421](#L2421) | $txt = sprintf( \_\_( 'Photo flipped' , 'wp-photo-album-plus' ), $photo ) . $extra; |
| [2422](#L2422) | } |
| [2423](#L2423) | else { |
| [2424](#L2424) | /\* translators: photo id, direction \*/ |
| [2425](#L2425) | $txt = sprintf( \_\_( 'Photo %1$d rotated %2$s' , 'wp-photo-album-plus' ), $photo, $dir ) . $extra; |
| [2426](#L2426) | } |
| [2427](#L2427) | } |
| [2428](#L2428) | else { |
| [2429](#L2429) | $txt = \_\_( 'An error occurred while trying to rotate or flip photo' , 'wp-photo-album-plus' ); |
| [2430](#L2430) | $err = '1'; |
| [2431](#L2431) | } |
| [2432](#L2432) | $jsfields['thumbmod'] = true; |
| [2433](#L2433) | $jsfields['photomod'] = true; |
| [2434](#L2434) | break; |
| [2435](#L2435) | case 'magickrotleft': |
| [2436](#L2436) | case 'magickrot180': |
| [2437](#L2437) | case 'magickrotright': |
| [2438](#L2438) | case 'magickflip': |
| [2439](#L2439) | case 'magickflop': |
| [2440](#L2440) | case 'enhance': |
| [2441](#L2441) | case 'sharpen': |
| [2442](#L2442) | case 'blur': |
| [2443](#L2443) | case 'auto-gamma': |
| [2444](#L2444) | case 'auto-level': |
| [2445](#L2445) | case 'contrast-p': |
| [2446](#L2446) | case 'contrast-m': |
| [2447](#L2447) | case 'brightness-p': |
| [2448](#L2448) | case 'brightness-m': |
| [2449](#L2449) | case 'despeckle': |
| [2450](#L2450) | case 'lineargray': |
| [2451](#L2451) | case 'nonlineargray': |
| [2452](#L2452) | case 'charcoal': |
| [2453](#L2453) | case 'paint': |
| [2454](#L2454) | case 'sepia': |
| [2455](#L2455) | case 'skyleft': |
| [2456](#L2456) | case 'skyright': |
| [2457](#L2457) | case 'crop': |
| [2458](#L2458) | $id = $photo; |
| [2459](#L2459) | $src\_o1\_path = wppa\_get\_o1\_source\_path( $id ); |
| [2460](#L2460) | $src\_path = wppa\_get\_source\_path( $id ); |
| [2461](#L2461) | if ( ! wppa\_is\_file( $src\_o1\_path ) && ! wppa\_is\_file( $src\_path ) ) { |
| [2462](#L2462) |  |
| [2463](#L2463) | // Make a backup |
| [2464](#L2464) | $src\_alb\_dir = dirname( $src\_path ); |
| [2465](#L2465) | //$src\_alb\_dir = $src\_dir . '/album-' . wppa\_get\_photo\_item( $id, 'album' ); |
| [2466](#L2466) | if ( ! wppa\_is\_dir( $src\_alb\_dir ) ) { |
| [2467](#L2467) |  |
| [2468](#L2468) | // Make source album folder |
| [2469](#L2469) | wppa\_mktree( $src\_alb\_dir ); |
| [2470](#L2470) | } |
| [2471](#L2471) | $filename = wppa\_get\_photo\_item( $id, 'filename' ); |
| [2472](#L2472) | $filename = wppa\_strip\_ext( $filename ) . '.' . wppa\_get\_photo\_item( $id, 'ext' ); |
| [2473](#L2473) | $path = wppa\_get\_photo\_path( $id ); |
| [2474](#L2474) | wppa\_copy( $path, $src\_alb\_dir . '/' . basename( $filename ) ); |
| [2475](#L2475) | wppa\_log( 'fso', 'Backup created for magic: ' . $src\_alb\_dir . '/' . $filename ); |
| [2476](#L2476) | } |
| [2477](#L2477) | switch ( $item ) { |
| [2478](#L2478) | case 'magickrotleft': |
| [2479](#L2479) | $command = '-rotate -90'; |
| [2480](#L2480) | break; |
| [2481](#L2481) | case 'magickrot180': |
| [2482](#L2482) | $command = '-rotate 180'; |
| [2483](#L2483) | break; |
| [2484](#L2484) | case 'magickrotright': |
| [2485](#L2485) | $command = '-rotate 90'; |
| [2486](#L2486) | break; |
| [2487](#L2487) | case 'magickflip': |
| [2488](#L2488) | $command = '-flip'; |
| [2489](#L2489) | break; |
| [2490](#L2490) | case 'magickflop': |
| [2491](#L2491) | $command = '-flop'; |
| [2492](#L2492) | break; |
| [2493](#L2493) | case 'enhance': |
| [2494](#L2494) | $command = '-enhance'; |
| [2495](#L2495) | break; |
| [2496](#L2496) | case 'sharpen': |
| [2497](#L2497) | $command = '-sharpen 0x1'; |
| [2498](#L2498) | break; |
| [2499](#L2499) | case 'blur': |
| [2500](#L2500) | $command = '-blur 0x1'; |
| [2501](#L2501) | break; |
| [2502](#L2502) | case 'auto-gamma': |
| [2503](#L2503) | $command = '-auto-gamma'; |
| [2504](#L2504) | break; |
| [2505](#L2505) | case 'auto-level': |
| [2506](#L2506) | $command = '-auto-level'; |
| [2507](#L2507) | break; |
| [2508](#L2508) | case 'contrast-p': |
| [2509](#L2509) | $command = '-brightness-contrast 0x5'; |
| [2510](#L2510) | break; |
| [2511](#L2511) | case 'contrast-m': |
| [2512](#L2512) | $command = '-brightness-contrast 0x-5'; |
| [2513](#L2513) | break; |
| [2514](#L2514) | case 'brightness-p': |
| [2515](#L2515) | $command = '-brightness-contrast 5'; |
| [2516](#L2516) | break; |
| [2517](#L2517) | case 'brightness-m': |
| [2518](#L2518) | $command = '-brightness-contrast -5'; |
| [2519](#L2519) | break; |
| [2520](#L2520) | case 'despeckle': |
| [2521](#L2521) | $command = '-despeckle'; |
| [2522](#L2522) | break; |
| [2523](#L2523) | case 'lineargray': |
| [2524](#L2524) | $command = '-colorspace gray'; |
| [2525](#L2525) | break; |
| [2526](#L2526) | case 'nonlineargray': |
| [2527](#L2527) | $command = '-grayscale Rec709Luma'; |
| [2528](#L2528) | break; |
| [2529](#L2529) | case 'charcoal': |
| [2530](#L2530) | $command = '-charcoal 1'; |
| [2531](#L2531) | break; |
| [2532](#L2532) | case 'paint': |
| [2533](#L2533) | $command = '-paint 4'; |
| [2534](#L2534) | break; |
| [2535](#L2535) | case 'sepia': |
| [2536](#L2536) | $command = '-sepia-tone 80%'; |
| [2537](#L2537) | break; |
| [2538](#L2538) | case 'skyleft': |
| [2539](#L2539) | $command = '-rotate -0.5 -shave ' . ( ceil( 0.0087 \* wppa\_get\_photoy( $photo ) ) + 1 ) . 'x' . ( ceil( 0.0087 \* wppa\_get\_photox( $photo ) ) + 1 ); |
| [2540](#L2540) | break; |
| [2541](#L2541) | case 'skyright': |
| [2542](#L2542) | $command = '-rotate 0.5 -shave ' . ( ceil( 0.0087 \* wppa\_get\_photoy( $photo ) ) + 1 ) . 'x' . ( ceil( 0.0087 \* wppa\_get\_photox( $photo ) ) + 1 ); |
| [2543](#L2543) | break; |
| [2544](#L2544) | case 'crop': |
| [2545](#L2545) | $command = '-crop ' . str\_replace( ' ', '+', $value ); |
| [2546](#L2546) | break; |
| [2547](#L2547) | default: |
| [2548](#L2548) | break; |
| [2549](#L2549) | } |
| [2550](#L2550) |  |
| [2551](#L2551) | $path = wppa\_get\_photo\_path( $id ); |
| [2552](#L2552) |  |
| [2553](#L2553) | // If jpg, apply jpeg quality |
| [2554](#L2554) | $q = wppa\_opt( 'jpeg\_quality' ); |
| [2555](#L2555) | $quality = ''; |
| [2556](#L2556) | if ( wppa\_get\_ext( $path ) == 'jpg' ) { |
| [2557](#L2557) | $quality = '-quality ' . $q; |
| [2558](#L2558) | } |
| [2559](#L2559) |  |
| [2560](#L2560) | // Do the magick command |
| [2561](#L2561) | $err = wppa\_image\_magick( 'convert ' . $path . ' ' . $quality . ' ' . $command . ' ' . $path ); |
| [2562](#L2562) |  |
| [2563](#L2563) | // Error? |
| [2564](#L2564) | if ( $err ) { |
| [2565](#L2565) | $txt = \_\_( 'An error occurred while trying to process photo', 'wp-photo-album-plus' ); |
| [2566](#L2566) | wppa\_log('err', 'Imagic err on "convert ' . $path . ' ' . $quality . ' ' . $command . ' ' . $path . '"'); |
| [2567](#L2567) | } |
| [2568](#L2568) |  |
| [2569](#L2569) | // Housekeeping |
| [2570](#L2570) | else { |
| [2571](#L2571) |  |
| [2572](#L2572) | // Horizon correction shaves size. |
| [2573](#L2573) | if ( $item == 'skyleft' || $item == 'skyright' ) { |
| [2574](#L2574) | wppa\_get\_photox( $id, true ); |
| [2575](#L2575) | } |
| [2576](#L2576) |  |
| [2577](#L2577) | wppa\_create\_thumbnail( $id, false ); |
| [2578](#L2578) | $stack = wppa\_get\_photo\_item( $id, 'magickstack' ); |
| [2579](#L2579) | if ( ! $stack ) { |
| [2580](#L2580) | $stack = $command; |
| [2581](#L2581) | } |
| [2582](#L2582) | else { |
| [2583](#L2583) | $stack .= ' | ' . $command; |
| [2584](#L2584) | } |
| [2585](#L2585) | $dbfields['magickstack'] = $stack; |
| [2586](#L2586) |  |
| [2587](#L2587) | // Update CDN |
| [2588](#L2588) | $cdn = wppa\_cdn( 'admin' ); |
| [2589](#L2589) | if ( $cdn ) { |
| [2590](#L2590) | switch ( $cdn ) { |
| [2591](#L2591) | case 'cloudinary': |
| [2592](#L2592) | wppa\_upload\_to\_cloudinary( $id ); |
| [2593](#L2593) | break; |
| [2594](#L2594) | case 'local': |
| [2595](#L2595) | break; |
| [2596](#L2596) | default: |
| [2597](#L2597) | } |
| [2598](#L2598) | } |
| [2599](#L2599) | /\* translators: command name, photo id \*/ |
| [2600](#L2600) | $txt = sprintf( \_\_( 'Command %1$s magically executed on photo %2$d', 'wp-photo-album-plus' ), '<span style=\"color:blue;\" ><i>'.$command.'</i></span>', $id ); |
| [2601](#L2601) | } |
| [2602](#L2602) | $jsfields = array\_merge( $jsfields, ['thumbmod' => true, 'photomod' => true, 'magickmod' => true] ); |
| [2603](#L2603) | break; |
| [2604](#L2604) |  |
| [2605](#L2605) | case 'magickundo': |
| [2606](#L2606) | $path = wppa\_get\_photo\_path( $photo ); |
| [2607](#L2607) | wppa\_unlink( $path ); |
| [2608](#L2608) | $stack = wppa\_get\_photo\_item( $photo, 'magickstack' ); |
| [2609](#L2609) |  |
| [2610](#L2610) | // Revert all |
| [2611](#L2611) | wppa\_remake\_files( '', $photo ); |
| [2612](#L2612) |  |
| [2613](#L2613) | // Redo all except last |
| [2614](#L2614) | $commands = explode( '|', $stack ); |
| [2615](#L2615) | $i = 0; |
| [2616](#L2616) | $newstack = ''; |
| [2617](#L2617) | while ( $i < ( count( $commands ) - 1 ) ) { |
| [2618](#L2618) |  |
| [2619](#L2619) | // Do the magick command |
| [2620](#L2620) | $err = wppa\_image\_magick( 'convert ' . $path . ' ' . trim( $commands[$i] ) . ' ' . $path ); |
| [2621](#L2621) | $newstack .= ( $i != '0' ? ' | ' : '' ) . $commands[$i]; |
| [2622](#L2622) | $i++; |
| [2623](#L2623) | } |
| [2624](#L2624) |  |
| [2625](#L2625) | // Housekeeping |
| [2626](#L2626) | wppa\_bump\_photo\_rev(); |
| [2627](#L2627) | wppa\_create\_thumbnail( $photo, false ); |
| [2628](#L2628) | $dbfields['magickstack'] = $newstack; |
| [2629](#L2629) | /\* translators: command name, photo id \*/ |
| [2630](#L2630) | $txt = sprintf( \_\_( 'Command %1$s magically executed on photo %2$d', 'wp-photo-album-plus' ), '<span style=\"color:blue;\" ><i>magickundo</i></span>', $photo ); |
| [2631](#L2631) | $jsfields = array\_merge( $jsfields, ['thumbmod' => true, 'photomod' => true, 'magickmod' => true] ); |
| [2632](#L2632) | break; |
| [2633](#L2633) |  |
| [2634](#L2634) | case 'moveto': |
| [2635](#L2635) | $toalb = wppa\_decrypt\_album( $value ); |
| [2636](#L2636) | $photodata = wppa\_cache\_photo( $photo ); |
| [2637](#L2637) |  |
| [2638](#L2638) | if ( ! wppa\_album\_exists( $toalb ) ) { |
| [2639](#L2639) |  |
| [2640](#L2640) | /\* translators: album id \*/ |
| [2641](#L2641) | $txt = sprintf( \_\_( 'Album %d does not exist', 'wp-photo-album-plus' ), $toalb ); |
| [2642](#L2642) | $err = '1'; |
| [2643](#L2643) | } |
| [2644](#L2644) | else { |
| [2645](#L2645) |  |
| [2646](#L2646) | // Check for already exists |
| [2647](#L2647) | $exists = wppa\_is\_file\_duplicate\_photo( $photodata['filename'], $toalb ); |
| [2648](#L2648) | if ( wppa\_switch( 'void\_dups' ) && $exists ) { |
| [2649](#L2649) |  |
| [2650](#L2650) | /\* translators: file name, album id \*/ |
| [2651](#L2651) | $txt = sprintf ( \_\_( 'A photo with filename %1$s already exists in album %2$d.' , 'wp-photo-album-plus' ), $photodata['filename'], $toalb ); |
| [2652](#L2652) | $err = '1'; |
| [2653](#L2653) | } |
| [2654](#L2654) | else { |
| [2655](#L2655) | wppa\_invalidate\_treecounts( $photodata['album'] );      // Current album |
| [2656](#L2656) | wppa\_invalidate\_treecounts( $toalb );                           // New album |
| [2657](#L2657) | $edit\_link = wppa\_ea\_url( 'single' ) . '&photo=' . wppa\_encrypt\_photo( $photodata['id'] ); |
| [2658](#L2658) | $iret = wppa\_update\_photo( $photo, ['album' => $toalb] ); |
| [2659](#L2659) | if ( $iret !== false ) { |
| [2660](#L2660) | wppa\_move\_source( $photodata['filename'], $photodata['album'], $toalb ); |
| [2661](#L2661) |  |
| [2662](#L2662) | /\* translators: photo id, album name, album id \*/ |
| [2663](#L2663) | wppa\_echo( '||99||'.sprintf( \_\_( 'Photo %1$s has been moved to album %2$s (%3$d)', 'wp-photo-album-plus' ), '<a href="'.$edit\_link.'" target="\_blank" >' . $photodata['id'] . '</a>', wppa\_get\_album\_name( $toalb ), $toalb ) ); |
| [2664](#L2664) | wppa\_exit(); |
| [2665](#L2665) | } |
| [2666](#L2666) | else { |
| [2667](#L2667) |  |
| [2668](#L2668) | /\* translators: photo id \*/ |
| [2669](#L2669) | $txt = sprintf( \_\_( 'An error occurred while trying to move photo %s' , 'wp-photo-album-plus' ), $photo ); |
| [2670](#L2670) | $err = '1'; |
| [2671](#L2671) | } |
| [2672](#L2672) | } |
| [2673](#L2673) | } |
| [2674](#L2674) | break; |
| [2675](#L2675) |  |
| [2676](#L2676) | case 'copyto': |
| [2677](#L2677) | $toalb = wppa\_decrypt\_album( $value ); |
| [2678](#L2678) | $photodata = wppa\_cache\_photo( $photo ); |
| [2679](#L2679) |  |
| [2680](#L2680) | if ( ! wppa\_album\_exists( $toalb ) ) { |
| [2681](#L2681) |  |
| [2682](#L2682) | /\* translators: album id \*/ |
| [2683](#L2683) | $txt = sprintf( \_\_( 'Album %d does not exist', 'wp-photo-album-plus' ), $toalb ); |
| [2684](#L2684) | $err = '1'; |
| [2685](#L2685) | } |
| [2686](#L2686) | else { |
| [2687](#L2687) |  |
| [2688](#L2688) | // Check for already exists |
| [2689](#L2689) | $exists = wppa\_is\_file\_duplicate\_photo( $photodata['filename'], $toalb ); |
| [2690](#L2690) | if ( wppa\_switch( 'void\_dups' ) && $exists ) { |
| [2691](#L2691) |  |
| [2692](#L2692) | /\* translators: photo filename, album id \*/ |
| [2693](#L2693) | $txt = sprintf( \_\_( 'A photo with filename %1$s already exists in album %2$d.' , 'wp-photo-album-plus' ), $photodata['filename'], $toalb ); |
| [2694](#L2694) | $err = '1'; |
| [2695](#L2695) | } |
| [2696](#L2696) | else { |
| [2697](#L2697) | $err = wppa\_copy\_photo( $photo, $toalb ); |
| [2698](#L2698) | wppa\_invalidate\_treecounts( $toalb );                           // New album |
| [2699](#L2699) | if ( ! $err ) { |
| [2700](#L2700) |  |
| [2701](#L2701) | /\* translators: photo id, album name, album id \*/ |
| [2702](#L2702) | $txt = sprintf( \_\_( 'Photo %1$d copied to album %2$s (%3$d)' , 'wp-photo-album-plus' ), $photo, wppa\_get\_album\_name( $toalb ), $toalb ); |
| [2703](#L2703) | } |
| [2704](#L2704) | else { |
| [2705](#L2705) |  |
| [2706](#L2706) | /\* translators: photo id \*/ |
| [2707](#L2707) | $txt = sprintf( \_\_( 'An error occurred while trying to copy photo %s' , 'wp-photo-album-plus' ), $photo ); |
| [2708](#L2708) | $err = '1'; |
| [2709](#L2709) | } |
| [2710](#L2710) | } |
| [2711](#L2711) | } |
| [2712](#L2712) | break; |
| [2713](#L2713) |  |
| [2714](#L2714) | case 'status': |
| [2715](#L2715) | case 'owner': |
| [2716](#L2716) | case 'name': |
| [2717](#L2717) | case 'description': |
| [2718](#L2718) | case 'p\_order': |
| [2719](#L2719) | case 'linkurl': |
| [2720](#L2720) | case 'linktitle': |
| [2721](#L2721) | case 'linktarget': |
| [2722](#L2722) | case 'tags': |
| [2723](#L2723) | case 'alt': |
| [2724](#L2724) | case 'videox': |
| [2725](#L2725) | case 'videoy': |
| [2726](#L2726) | switch ( $item ) { |
| [2727](#L2727) | case 'status': |
| [2728](#L2728) | $itemname = \_\_( 'Status', 'wp-photo-album-plus' ); |
| [2729](#L2729) | if ( ! current\_user\_can( 'wppa\_moderate' ) && ! current\_user\_can( 'wppa\_admin' ) ) { |
| [2730](#L2730) | $txt = \_\_( 'Security check failure', 'wp-photo-album-plus' ) . ' #78'; |
| [2731](#L2731) | $err = '1'; |
| [2732](#L2732) | } |
| [2733](#L2733) | else { |
| [2734](#L2734) | wppa\_invalidate\_treecounts( wppa\_get\_photo\_item( $photo, 'album' ) ); |
| [2735](#L2735) | if ( wppa\_get\_photo\_item( $photo, 'status' ) == 'pending' && $value == 'publish' ) { |
| [2736](#L2736) | wppa\_schedule\_mailinglist( 'photoapproved', 0, $photo ); |
| [2737](#L2737) | } |
| [2738](#L2738) | } |
| [2739](#L2739) | break; |
| [2740](#L2740) | case 'name': |
| [2741](#L2741) | $itemname = \_\_( 'Name', 'wp-photo-album-plus' ); |
| [2742](#L2742) | $jsfields['namemod'] = true; |
| [2743](#L2743) | break; |
| [2744](#L2744) | case 'description': |
| [2745](#L2745) | $itemname = \_\_( 'Description', 'wp-photo-album-plus' ); |
| [2746](#L2746) | break; |
| [2747](#L2747) | case 'p\_order': |
| [2748](#L2748) | $itemname = \_\_( 'Photo order #' , 'wp-photo-album-plus' ); |
| [2749](#L2749) | break; |
| [2750](#L2750) | case 'owner': |
| [2751](#L2751) | $itemname = \_\_( 'Owner' , 'wp-photo-album-plus' ); |
| [2752](#L2752) | $usr = wppa\_get\_user\_by( 'login', $value ); |
| [2753](#L2753) | if ( ! $usr ) { |
| [2754](#L2754) | /\* translators: user login \*/ |
| [2755](#L2755) | $txt = sprintf( \_\_( 'User %s does not exist' , 'wp-photo-album-plus' ), $value ); |
| [2756](#L2756) | $err = '4'; |
| [2757](#L2757) | } |
| [2758](#L2758) | else { |
| [2759](#L2759) | $value = $usr->user\_login;      // Correct possible case mismatch |
| [2760](#L2760) | wppa\_flush\_upldr\_cache( 'photoid', $photo );            // Current owner |
| [2761](#L2761) | wppa\_flush\_upldr\_cache( 'username', $value );           // New owner |
| [2762](#L2762) | } |
| [2763](#L2763) | break; |
| [2764](#L2764) | case 'linkurl': |
| [2765](#L2765) | $itemname = \_\_( 'Link url' , 'wp-photo-album-plus' ); |
| [2766](#L2766) | break; |
| [2767](#L2767) | case 'linktitle': |
| [2768](#L2768) | $itemname = \_\_( 'Link title' , 'wp-photo-album-plus' ); |
| [2769](#L2769) | break; |
| [2770](#L2770) | case 'linktarget': |
| [2771](#L2771) | $itemname = \_\_( 'Link target' , 'wp-photo-album-plus' ); |
| [2772](#L2772) | break; |
| [2773](#L2773) | case 'tags': |
| [2774](#L2774) | $itemname = \_\_( 'Photo Tags' , 'wp-photo-album-plus' ); |
| [2775](#L2775) | break; |
| [2776](#L2776) | case 'status': |
| [2777](#L2777) | $itemname = \_\_( 'Status' , 'wp-photo-album-plus' ); |
| [2778](#L2778) | break; |
| [2779](#L2779) | case 'alt': |
| [2780](#L2780) | $itemname = \_\_( 'HTML Alt' , 'wp-photo-album-plus' ); |
| [2781](#L2781) | break; |
| [2782](#L2782) | case 'videox': |
| [2783](#L2783) | $itemname = \_\_( 'Video width' , 'wp-photo-album-plus' ); |
| [2784](#L2784) | if ( ! wppa\_is\_int( $value ) || $value < '0' ) { |
| [2785](#L2785) | $txt = \_\_( 'Please enter an integer value >= 0', 'wp-photo-album-plus' ); |
| [2786](#L2786) | wppa\_json\_photo\_update( $photo, $txt, '1' ); |
| [2787](#L2787) | } |
| [2788](#L2788) | break; |
| [2789](#L2789) | case 'videoy': |
| [2790](#L2790) | $itemname = \_\_( 'Video height', 'wp-photo-album-plus' ); |
| [2791](#L2791) | if ( ! wppa\_is\_int( $value ) || $value < '0' ) { |
| [2792](#L2792) | $txt = \_\_( 'Please enter an integer value >= 0', 'wp-photo-album-plus' ); |
| [2793](#L2793) | wppa\_json\_photo\_update( $photo, $txt, '1' ); |
| [2794](#L2794) | } |
| [2795](#L2795) | break; |
| [2796](#L2796) |  |
| [2797](#L2797) | default: |
| [2798](#L2798) | $itemname = $item; |
| [2799](#L2799) | } |
| [2800](#L2800) |  |
| [2801](#L2801) | if ( ! $err ) $dbfields[$item] = $value; |
| [2802](#L2802) |  |
| [2803](#L2803) | // If set to featured, try to copy to wp media |
| [2804](#L2804) | if ( $item == 'status' && $value == 'featured' ) { |
| [2805](#L2805) |  |
| [2806](#L2806) | require\_once( ABSPATH . 'wp-admin/includes/media.php' ); |
| [2807](#L2807) | require\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
| [2808](#L2808) | require\_once( ABSPATH . 'wp-admin/includes/image.php' ); |
| [2809](#L2809) |  |
| [2810](#L2810) | $media\_data = wppa\_get\_media\_data( $photo ); |
| [2811](#L2811) | $image\_path = $media\_data['path']; |
| [2812](#L2812) | $ext            = $media\_data['ext']; |
| [2813](#L2813) | $type           = $media\_data['mime']; |
| [2814](#L2814) |  |
| [2815](#L2815) | if ( wppa\_is\_file( $image\_path ) ) { |
| [2816](#L2816) |  |
| [2817](#L2817) | // To avoid media\_handle\_sideload() to delete the from file, make a temp copy |
| [2818](#L2818) | $tempdir        = WPPA\_UPLOAD\_PATH . '/temp'; |
| [2819](#L2819) | $temp\_file      = $tempdir . '/' . basename( $image\_path ); |
| [2820](#L2820) | wppa\_mktree( $tempdir ); |
| [2821](#L2821) | wppa\_copy( $image\_path, $temp\_file ); |
| [2822](#L2822) |  |
| [2823](#L2823) | $image\_size = wppa\_filesize( $image\_path ); |
| [2824](#L2824) | if ( wppa\_is\_file( $temp\_file ) ) { |
| [2825](#L2825) | $file = array( |
| [2826](#L2826) | 'name'               => wppa\_strip\_ext( wppa\_get\_photo\_item( $photo, 'filename' ) ) . '.' . $ext, |
| [2827](#L2827) | 'type'               => $type, |
| [2828](#L2828) | 'tmp\_name'   => $temp\_file, |
| [2829](#L2829) | 'error'              => 0, |
| [2830](#L2830) | 'size'               => $image\_size |
| [2831](#L2831) | ); |
| [2832](#L2832) | $att\_id = media\_handle\_sideload( $file, 0, wppa\_get\_photo\_name( $photo ) ); |
| [2833](#L2833) | if ( is\_wp\_error( $att\_id ) ) { |
| [2834](#L2834) | wppa\_log( 'err', 'Could not export '. $file['name'] . ' to wp media. err = ' . $att\_id->get\_error\_message() ); // . ' Filespec = ' . var\_export( $file, true )  ); |
| [2835](#L2835) | } |
| [2836](#L2836) | else { |
| [2837](#L2837) |  |
| [2838](#L2838) | $post = get\_post( $att\_id ); |
| [2839](#L2839) | $post->post\_title       = wppa\_get\_photo\_name( $photo ); |
| [2840](#L2840) | $post->post\_content = wppa\_get\_photo\_desc( $photo ); |
| [2841](#L2841) | $aret = wp\_update\_post( $post ); |
| [2842](#L2842) | if ( $aret != $att\_id ) { |
| [2843](#L2843) | wppa\_log( 'err', 'Could not set name and desc to attachment ' . $att\_id ); |
| [2844](#L2844) | } |
| [2845](#L2845) | } |
| [2846](#L2846) | } |
| [2847](#L2847) | else { |
| [2848](#L2848) | wppa\_log( 'err', 'Tempfile ' . $temp\_file . ' not found while exporting to wp media'); |
| [2849](#L2849) | } |
| [2850](#L2850) | } |
| [2851](#L2851) | else { |
| [2852](#L2852) | wppa\_log( 'err', 'Image path ' . $image\_path . ' not found while trying to copy to wp media' ); |
| [2853](#L2853) | } |
| [2854](#L2854) | } |
| [2855](#L2855) |  |
| [2856](#L2856) | $jsfields['tagsmod'] = true; |
| [2857](#L2857) | break; |
| [2858](#L2858) |  |
| [2859](#L2859) | case 'year': |
| [2860](#L2860) | case 'month': |
| [2861](#L2861) | case 'day': |
| [2862](#L2862) | case 'hour': |
| [2863](#L2863) | case 'min': |
| [2864](#L2864) | $itemname = \_\_( 'Schedule date/time' , 'wp-photo-album-plus' ); |
| [2865](#L2865) | $scheduledtm = wppa\_get\_photo\_item( $photo, 'scheduledtm' ); |
| [2866](#L2866) | if ( ! $scheduledtm ) { |
| [2867](#L2867) | $scheduledtm = wppa\_get\_default\_scheduledtm(); |
| [2868](#L2868) | } |
| [2869](#L2869) | $temp = explode( ',', $scheduledtm ); |
| [2870](#L2870) | if ( $item == 'year' )  $temp[0] = $value; |
| [2871](#L2871) | if ( $item == 'month' ) $temp[1] = $value; |
| [2872](#L2872) | if ( $item == 'day' )   $temp[2] = $value; |
| [2873](#L2873) | if ( $item == 'hour' )  $temp[3] = $value; |
| [2874](#L2874) | if ( $item == 'min' )   $temp[4] = $value; |
| [2875](#L2875) | $scheduledtm = implode( ',', $temp ); |
| [2876](#L2876) | $dbfields['scheduledtm'] = $scheduledtm; |
| [2877](#L2877) | $dbfields['status'] = 'scheduled'; |
| [2878](#L2878) | wppa\_invalidate\_treecounts( wppa\_get\_photo\_item( $photo, 'album' ) ); |
| [2879](#L2879) | wppa\_flush\_upldr\_cache( 'photoid', $photo ); |
| [2880](#L2880) | break; |
| [2881](#L2881) |  |
| [2882](#L2882) | case 'delyear': |
| [2883](#L2883) | case 'delmonth': |
| [2884](#L2884) | case 'delday': |
| [2885](#L2885) | case 'delhour': |
| [2886](#L2886) | case 'delmin': |
| [2887](#L2887) | $itemname = \_\_( 'Delete date/time' , 'wp-photo-album-plus' ); |
| [2888](#L2888) | $scheduledel = wppa\_get\_photo\_item( $photo, 'scheduledel' ); |
| [2889](#L2889) | if ( ! $scheduledel ) { |
| [2890](#L2890) | $scheduledel = wppa\_get\_default\_scheduledtm(); |
| [2891](#L2891) | } |
| [2892](#L2892) | $temp = explode( ',', $scheduledel ); |
| [2893](#L2893) | if ( $item == 'delyear' )       $temp[0] = $value; |
| [2894](#L2894) | if ( $item == 'delmonth' )      $temp[1] = $value; |
| [2895](#L2895) | if ( $item == 'delday' )        $temp[2] = $value; |
| [2896](#L2896) | if ( $item == 'delhour' )       $temp[3] = $value; |
| [2897](#L2897) | if ( $item == 'delmin' )        $temp[4] = $value; |
| [2898](#L2898) | $scheduledel = implode( ',', $temp ); |
| [2899](#L2899) |  |
| [2900](#L2900) | // Make sure not deleted yet |
| [2901](#L2901) | $alb = wppa\_get\_photo\_item( $photo, 'album' ); |
| [2902](#L2902) | if ( $alb < '-9' ) { |
| [2903](#L2903) | $alb = - ( $alb + '9' ); |
| [2904](#L2904) | $dbfields['album'] = $alb; |
| [2905](#L2905) | } |
| [2906](#L2906) | $dbfields['scheduledel'] = $scheduledel; |
| [2907](#L2907) | wppa\_invalidate\_treecounts( $alb ); |
| [2908](#L2908) | wppa\_flush\_upldr\_cache( 'photoid', $photo ); |
| [2909](#L2909) | break; |
| [2910](#L2910) | case 'removescheduledel': |
| [2911](#L2911) | if ( ( current\_user\_can( 'wppa\_admin' ) || current\_user\_can( 'wppa\_moderate' ) ) ) { |
| [2912](#L2912) | $dbfields['scheduledel'] = ''; |
| [2913](#L2913) | /\* translators: media item type, media item id \*/ |
| [2914](#L2914) | $txt = sprintf( \_\_( 'Scheduled deletion of %1$s %2$d cancelled' , 'wp-photo-album-plus' ), wppa\_get\_type( $photo, true ), $photo ); |
| [2915](#L2915) | } |
| [2916](#L2916) | else { |
| [2917](#L2917) | $txt = \_\_( 'No rights', 'wp-photo-album-plus' ); |
| [2918](#L2918) | $err = '1'; |
| [2919](#L2919) | } |
| [2920](#L2920) | break; |
| [2921](#L2921) |  |
| [2922](#L2922) | case 'custom\_0': |
| [2923](#L2923) | case 'custom\_1': |
| [2924](#L2924) | case 'custom\_2': |
| [2925](#L2925) | case 'custom\_3': |
| [2926](#L2926) | case 'custom\_4': |
| [2927](#L2927) | case 'custom\_5': |
| [2928](#L2928) | case 'custom\_6': |
| [2929](#L2929) | case 'custom\_7': |
| [2930](#L2930) | case 'custom\_8': |
| [2931](#L2931) | case 'custom\_9': |
| [2932](#L2932) | $index          = substr( $item, -1 ); |
| [2933](#L2933) | $custom         = wppa\_get\_photo\_item( $photo, 'custom' ); |
| [2934](#L2934) | if ( $custom ) { |
| [2935](#L2935) | $custom\_data = wppa\_unserialize( $custom ); |
| [2936](#L2936) | } |
| [2937](#L2937) | else { |
| [2938](#L2938) | $custom\_data = array( '', '', '', '', '', '', '', '', '', '' ); |
| [2939](#L2939) | } |
| [2940](#L2940) | $custom\_data[$index] = wppa\_sanitize\_custom\_field( $value ); |
| [2941](#L2941) | $custom = serialize( $custom\_data ); |
| [2942](#L2942) | $dbfields['custom'] = $custom; |
| [2943](#L2943) | /\* translators: field name, photo id \*/ |
| [2944](#L2944) | $txt = sprintf( \_\_( 'Custom field %1$s of photo %2$d updated' , 'wp-photo-album-plus' ), wppa\_opt( 'custom\_caption\_'.$index ), $photo ); |
| [2945](#L2945) | break; |
| [2946](#L2946) |  |
| [2947](#L2947) | case 'file': |
| [2948](#L2948) |  |
| [2949](#L2949) | // Re-upload file, called from the photo admin page |
| [2950](#L2950) | $err = '0'; |
| [2951](#L2951) |  |
| [2952](#L2952) | // Check on valid file |
| [2953](#L2953) | $file = current( $\_FILES ); |
| [2954](#L2954) | $file\_is\_ok = wp\_check\_filetype\_and\_ext( $file['tmp\_name'], $file['name'], wppa\_get\_mime\_types() ); |
| [2955](#L2955) | if ( ! $file\_is\_ok['ext'] || ! $file\_is\_ok['type'] ) { |
| [2956](#L2956) | $txt = \_\_( 'Invalid file, upload failed', 'wp-photo-album-plus' ); |
| [2957](#L2957) | $err = '1'; |
| [2958](#L2958) | } |
| [2959](#L2959) |  |
| [2960](#L2960) | // Check on upload error |
| [2961](#L2961) | if ( $file['error'] ) { |
| [2962](#L2962) | $txt = \_\_( 'Error during upload.', 'wp-photo-album-plus' ); |
| [2963](#L2963) | $err = '1'; |
| [2964](#L2964) | } |
| [2965](#L2965) |  |
| [2966](#L2966) | if ( ! $err ) { |
| [2967](#L2967) | // Make new source filename |
| [2968](#L2968) | $filename = wppa\_fix\_poster\_ext( wppa\_get\_photo\_item( $photo, 'filename' ), $photo ); |
| [2969](#L2969) |  |
| [2970](#L2970) | // If very old, no filename, take new name |
| [2971](#L2971) | if ( ! $filename ) { |
| [2972](#L2972) | $filename = sanitize\_file\_name( $file['name'] ); |
| [2973](#L2973) | $dbfields['filename'] = $filename; |
| [2974](#L2974) | } |
| [2975](#L2975) | wppa\_save\_source( $file['tmp\_name'], $filename, wppa\_get\_photo\_item( $photo, 'album') ); |
| [2976](#L2976) |  |
| [2977](#L2977) | // Make proper oriented source |
| [2978](#L2978) | wppa\_make\_o1\_source( $photo ); |
| [2979](#L2979) |  |
| [2980](#L2980) | // Make the files |
| [2981](#L2981) | wppa( 'unsanitized\_filename', $file['name'] ); |
| [2982](#L2982) | $alb = wppa\_get\_photo\_item( $photo, 'album' ); |
| [2983](#L2983) | $source = wppa\_get\_source\_album\_dir( $alb ).'/'.$filename; |
| [2984](#L2984) | if ( wppa\_is\_file( $source ) ) { |
| [2985](#L2985) | $from = $source; |
| [2986](#L2986) | } |
| [2987](#L2987) | else { |
| [2988](#L2988) | $from = $file['tmp\_name']; |
| [2989](#L2989) | } |
| [2990](#L2990) | $bret = wppa\_make\_the\_photo\_files( $from, $photo, strtolower( wppa\_get\_ext( $file['name'] ) ) ); |
| [2991](#L2991) | if ( $bret ) { |
| [2992](#L2992) |  |
| [2993](#L2993) | // Update timestamps and sizes |
| [2994](#L2994) | $alb = wppa\_get\_photo\_item( $photo, 'album' ); |
| [2995](#L2995) | wppa\_update\_album( $alb ); |
| [2996](#L2996) | $dbfields = array\_merge( $dbfields, ['modified' => time(), 'thumbx' => '0', 'thumby' => '0', 'photox' => '0', 'photoy' => '0'] ); |
| [2997](#L2997) |  |
| [2998](#L2998) | // Report success |
| [2999](#L2999) | $txt = \_\_( 'Photo files updated.', 'wp-photo-album-plus' ); |
| [3000](#L3000) | } |
| [3001](#L3001) | else { |
| [3002](#L3002) |  |
| [3003](#L3003) | // Report fail |
| [3004](#L3004) | $txt = \_\_( 'Could not update files.', 'wp-photo-album-plus' ); |
| [3005](#L3005) | $err = '1'; |
| [3006](#L3006) | } |
| [3007](#L3007) | $jsfields['thumbmod'] = true; |
| [3008](#L3008) | $jsfields['photomod'] = true; |
| [3009](#L3009) | } |
| [3010](#L3010) | break; |
| [3011](#L3011) |  |
| [3012](#L3012) | case 'stereo': |
| [3013](#L3013) | $itemname = \_\_( 'Stereo mode', 'wp-photo-album-plus' ); |
| [3014](#L3014) | wppa\_create\_stereo\_images( $photo ); |
| [3015](#L3015) | wppa\_create\_thumbnail( $photo ); |
| [3016](#L3016) | $dbfields['stereo'] = $value; |
| [3017](#L3017) | $jsfields['thumbmod'] = true; |
| [3018](#L3018) | $jsfields['photomod'] = true; |
| [3019](#L3019) | break; |
| [3020](#L3020) |  |
| [3021](#L3021) | case 'panorama': |
| [3022](#L3022) | $itemname = \_\_( 'Panorama mode', 'wp-photo-album-plus' ); |
| [3023](#L3023) |  |
| [3024](#L3024) | // If it was 360 and now different, delete o1 file and remake files |
| [3025](#L3025) | $cur = wppa\_get\_photo\_item( $photo, 'panorama' ); |
| [3026](#L3026) | if ( $cur == '1' && $value != '1' ) { |
| [3027](#L3027) | $s = wppa\_get\_o1\_source\_path( $photo ); |
| [3028](#L3028) | if ( wppa\_is\_file( $s ) ) { |
| [3029](#L3029) | wppa\_unlink( $s ); |
| [3030](#L3030) | } |
| [3031](#L3031) | wppa\_remake\_files( '', $photo ); |
| [3032](#L3032) | } |
| [3033](#L3033) |  |
| [3034](#L3034) | // Make sure x and y are correct |
| [3035](#L3035) | $x = wppa\_get\_photox( $photo, true ); |
| [3036](#L3036) | $y = wppa\_get\_photoy( $photo, true ); |
| [3037](#L3037) |  |
| [3038](#L3038) | // See if spheric and needs conversion, assume its for 360 |
| [3039](#L3039) | if ( $value == '1' && $x > 2.01 \* $y ) { |
| [3040](#L3040) | $bret = wppa\_make\_360( $photo, 360 ); |
| [3041](#L3041) | if ( $bret ) { |
| [3042](#L3042) | $x = wppa\_get\_photox( $photo, true ); |
| [3043](#L3043) | $y = wppa\_get\_photoy( $photo, true ); |
| [3044](#L3044) | $dbfields = array\_merge( $dbfields, ['panorama' => '1', 'angle' => '360', 'photox' => $x, 'photoy' => $y] ); |
| [3045](#L3045) | wppa\_remake\_files( '', $photo ); |
| [3046](#L3046) | /\* translators: type \*/ |
| [3047](#L3047) | $txt = sprintf( \_\_( 'Panorama set to %s and converted', 'wp-photo-album-plus' ), $value ); |
| [3048](#L3048) | } |
| [3049](#L3049) | else { |
| [3050](#L3050) | /\* translators: type \*/ |
| [3051](#L3051) | $txt = sprintf( \_\_( 'Panorama set to %s but failed to convert', 'wp-photo-album-plus' ), $value ); |
| [3052](#L3052) | } |
| [3053](#L3053) | } |
| [3054](#L3054) |  |
| [3055](#L3055) | // Not spheric or no conversion needed |
| [3056](#L3056) | else { |
| [3057](#L3057) | $dbfields = array\_merge( $dbfields, ['panorama' => $value, 'photox' => $x, 'photoy' => $y, 'angle' => '0'] ); |
| [3058](#L3058) |  |
| [3059](#L3059) | /\* translators: type \*/ |
| [3060](#L3060) | $txt = sprintf( \_\_( 'Panorama set to %s', 'wp-photo-album-plus' ), $value ); |
| [3061](#L3061) | } |
| [3062](#L3062) |  |
| [3063](#L3063) | break; |
| [3064](#L3064) |  |
| [3065](#L3065) | case 'thumblock': |
| [3066](#L3066) | $dbfields['thumblock'] = $value ? '1' : '0'; |
| [3067](#L3067) | $txt = \_\_( 'Thumbfile', 'wp-photo-album-plus' ) . ( $value ? ' ' : ' un' ) . 'locked'; |
| [3068](#L3068) | break; |
| [3069](#L3069) |  |
| [3070](#L3070) | case 'make360': |
| [3071](#L3071) |  |
| [3072](#L3072) | // If degs == 0, remove it |
| [3073](#L3073) | $s = wppa\_get\_o1\_source\_path( $photo ); |
| [3074](#L3074) | if ( wppa\_is\_file( $s ) ) wppa\_unlink( $s ); |
| [3075](#L3075) |  |
| [3076](#L3076) | if ( $value ) { |
| [3077](#L3077) | $bret = wppa\_make\_360( $photo, $value ); |
| [3078](#L3078) | if ( $bret ) { |
| [3079](#L3079) | $x = wppa\_get\_photox( $photo, true ); |
| [3080](#L3080) | $y = wppa\_get\_photoy( $photo, true ); |
| [3081](#L3081) | $dbfields = array\_merge( $dbfields, ['angle' => $value, 'photox' => $x, 'photoy' => $y] ); |
| [3082](#L3082) | wppa\_remake\_files( '', $photo ); |
| [3083](#L3083) | $txt = \_\_( 'Photo converted', 'wp-photo-album-plus' ); |
| [3084](#L3084) | } |
| [3085](#L3085) | else { |
| [3086](#L3086) | $txt = \_\_( 'Photo conversion failed', 'wp-photo-album-plus' ); |
| [3087](#L3087) | } |
| [3088](#L3088) | } |
| [3089](#L3089) | else { |
| [3090](#L3090) | $dbfields['angle'] = '0'; |
| [3091](#L3091) | wppa\_remake\_files( '', $photo ); |
| [3092](#L3092) | $txt = \_\_( 'Converted photo removed', 'wp-photo-album-plus' ); |
| [3093](#L3093) | } |
| [3094](#L3094) | $jsfields['thumbmod'] = true; |
| [3095](#L3095) | $jsfields['photomod'] = true; |
| [3096](#L3096) | break; |
| [3097](#L3097) |  |
| [3098](#L3098) | case 'misc': |
| [3099](#L3099) | $dbfields['misc'] = $value; |
| [3100](#L3100) | $txt = \_\_( 'Page indicator updated', 'wp-photo-album-plus' ); |
| [3101](#L3101) | break; |
| [3102](#L3102) |  |
| [3103](#L3103) | // Pdf to jpg |
| [3104](#L3104) | case 'pdftojpg': |
| [3105](#L3105) | $id     = wppa\_get( 'photo-id' ); |
| [3106](#L3106) | $nonce  = wppa\_get( 'nonce' ); |
| [3107](#L3107) |  |
| [3108](#L3108) | $pat = wppa\_strip\_ext( wppa\_get\_source\_path( $id ) ); |
| [3109](#L3109) | $jpg = $pat . '.jpg'; |
| [3110](#L3110) | $pdf = $pat . '.pdf'; |
| [3111](#L3111) | if ( wppa\_is\_file( $jpg ) && wppa\_is\_file( $pdf ) && ! wppa\_is\_pdf\_multiple( $id ) ) { |
| [3112](#L3112) | wppa\_unlink( $pdf ); |
| [3113](#L3113) | wppa\_update\_photo( $id, ['ext' => 'jpg', 'filename' => basename( $jpg )] ); |
| [3114](#L3114) | $txt = \_\_( 'Conversion complete', 'wp-photo-album-plus' ); |
| [3115](#L3115) | $jsfields['filename'] = true; |
| [3116](#L3116) | $jsfields['ext'] = true; |
| [3117](#L3117) | } |
| [3118](#L3118) | else { |
| [3119](#L3119) | $err = 0; |
| [3120](#L3120) | if ( ! wppa\_is\_file( $jpg ) ) $err += 100; |
| [3121](#L3121) | if ( ! wppa\_is\_file( $pdf ) ) $err += 10; |
| [3122](#L3122) | if ( wppa\_is\_pdf\_multiple( $id ) ) $err += 1; |
| [3123](#L3123) | $txt = \_\_( 'Conversion failed', 'wp-photo-album-plus' ) . ' ' . $err; |
| [3124](#L3124) | $err = '1'; |
| [3125](#L3125) | } |
| [3126](#L3126) | wppa\_json\_photo\_update( $photo, $txt, $err, $jsfields ); |
| [3127](#L3127) | wppa\_exit(); |
| [3128](#L3128) | break; |
| [3129](#L3129) |  |
| [3130](#L3130) | default: |
| [3131](#L3131) | $txt = 'This update action is not implemented yet (' . $item . ')'; |
| [3132](#L3132) | $err = '1'; |
| [3133](#L3133) | break; |
| [3134](#L3134) | } |
| [3135](#L3135) |  |
| [3136](#L3136) | // Update db optionally |
| [3137](#L3137) | if ( ! empty( $dbfields ) ) { |
| [3138](#L3138) | $iret = wppa\_update\_photo( $photo, $dbfields ); |
| [3139](#L3139) | } |
| [3140](#L3140) | else { |
| [3141](#L3141) | $iret = true; |
| [3142](#L3142) | } |
| [3143](#L3143) |  |
| [3144](#L3144) | // Prepare json text |
| [3145](#L3145) | if ( $iret === false ) { |
| [3146](#L3146) | /\* Translators: item name, media type, id \*/ |
| [3147](#L3147) | $txt = sprintf( \_\_( 'An error occurred while trying to update %1$s of %2$s %3$d', 'wp-photo-album-plus' ), $itemname, wppa\_get\_type( $photo, true ), $photo ); |
| [3148](#L3148) | $err = '1'; |
| [3149](#L3149) | } |
| [3150](#L3150) | if ( ! $txt ) { |
| [3151](#L3151) | if ( $err ) { |
| [3152](#L3152) | /\* Translators: item name, media type, id \*/ |
| [3153](#L3153) | $txt = sprintf( \_\_( 'Could not update %1$s of %2$s %3$d', 'wp-photo-album-plus' ), $itemname, wppa\_get\_type( $photo, true ), $photo ); |
| [3154](#L3154) | } |
| [3155](#L3155) | else { |
| [3156](#L3156) | /\* Translators: item name, media type, id \*/ |
| [3157](#L3157) | $txt = sprintf( \_\_( '%1$s of %2$s %3$d updated' , 'wp-photo-album-plus' ), $itemname, wppa\_get\_type( $photo, true ), $photo ); |
| [3158](#L3158) | } |
| [3159](#L3159) | } |
| [3160](#L3160) | wppa\_json\_photo\_update( $photo, $txt, $err, $jsfields ); |
| [3161](#L3161) | wppa\_exit(); |
| [3162](#L3162) | break; |
| [3163](#L3163) |  |
| [3164](#L3164) | // Pdf to album |
| [3165](#L3165) | case 'pdftoalbum': |
| [3166](#L3166) |  |
| [3167](#L3167) | // The item id |
| [3168](#L3168) | $id             = wppa\_get( 'photo-id' ); |
| [3169](#L3169) |  |
| [3170](#L3170) | // Check validity |
| [3171](#L3171) | $nonce          = wppa\_get( 'nonce' ); |
| [3172](#L3172) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce\_'.$id ) ) { |
| [3173](#L3173) | esc\_html\_e( 'You do not have the rights to do this' , 'wp-photo-album-plus' ); |
| [3174](#L3174) | wppa\_exit(); |
| [3175](#L3175) | } |
| [3176](#L3176) |  |
| [3177](#L3177) | // Get possible switches |
| [3178](#L3178) | $contin         = wppa\_get( 'continue', false, 'bool' ); |
| [3179](#L3179) | $stop           = wppa\_get( 'stop', false, 'bool' ); |
| [3180](#L3180) |  |
| [3181](#L3181) | // Stop request? |
| [3182](#L3182) | if ( $stop ) { |
| [3183](#L3183) | update\_option( 'stop-pdfcnv-' . $id, 'yes' ); |
| [3184](#L3184) | esc\_html\_e( 'Conversion stopped', 'wp-photo-album-plus' ); |
| [3185](#L3185) | wppa\_exit(); |
| [3186](#L3186) | } |
| [3187](#L3187) |  |
| [3188](#L3188) | // Start or continue Request |
| [3189](#L3189) | delete\_option( 'stop-pdfcnv-' . $id ); |
| [3190](#L3190) |  |
| [3191](#L3191) | // Start (over): erase ready switch and set start page at first page |
| [3192](#L3192) | if ( ! $contin ) { |
| [3193](#L3193) | wppa\_update\_pdf\_conv\_parms( $id, ['pagesdone' => 0, 'ready' => false] ); |
| [3194](#L3194) | } |
| [3195](#L3195) |  |
| [3196](#L3196) | // Get the required parms |
| [3197](#L3197) | $cnvparms       = wppa\_get\_pdf\_conv\_parms( $id ); |
| [3198](#L3198) | $alb            = $cnvparms['album']; |
| [3199](#L3199) | $page           = $cnvparms['pagesdone']; |
| [3200](#L3200) |  |
| [3201](#L3201) | // Album vanished? start all over |
| [3202](#L3202) | if ( $alb && ! wppa\_album\_exists( $alb ) ) { |
| [3203](#L3203) | wppa\_update\_pdf\_conv\_parms( $id, ['album' => 0, 'pagesdone' => 0, 'ready' => false] ); |
| [3204](#L3204) | $alb = 0; |
| [3205](#L3205) | $page = 0; |
| [3206](#L3206) | } |
| [3207](#L3207) |  |
| [3208](#L3208) | // Invoke process |
| [3209](#L3209) | $result = wppa\_pdf\_to\_album( $id, $alb, $page ); |
| [3210](#L3210) |  |
| [3211](#L3211) | // Output result |
| [3212](#L3212) | wppa\_echo( $result ); |
| [3213](#L3213) | wppa\_exit(); |
| [3214](#L3214) | break; |
| [3215](#L3215) |  |
| [3216](#L3216) | // Update iptc |
| [3217](#L3217) | case 'update-iptc': |
| [3218](#L3218) | $photo  = wppa\_get( 'photo-id' ); |
| [3219](#L3219) | $nonce  = wppa\_get( 'nonce' ); |
| [3220](#L3220) | $item   = wppa\_get( 'item' ); |
| [3221](#L3221) | $value  = wppa\_get( 'value' ); |
| [3222](#L3222) | $value  = wppa\_decode( $value ); |
| [3223](#L3223) | $tag    = wppa\_get( 'tagname' ); |
| [3224](#L3224) |  |
| [3225](#L3225) | // Check validity |
| [3226](#L3226) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce\_'.$photo ) ) { |
| [3227](#L3227) | $txt = \_\_( 'You do not have the rights to update photo information' , 'wp-photo-album-plus' ); |
| [3228](#L3228) | wppa\_json\_photo\_update( $photo, $txt, '1' ); |
| [3229](#L3229) | } |
| [3230](#L3230) |  |
| [3231](#L3231) | // Valid update request |
| [3232](#L3232) | else { |
| [3233](#L3233) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_iptc SET description = %s WHERE id = %d", $value, $item ); |
| [3234](#L3234) | $iret = wppa\_query( $query ); |
| [3235](#L3235) |  |
| [3236](#L3236) | /\* translators: tagname \*/ |
| [3237](#L3237) | $txt = sprintf( \_\_( 'IPTC Tag %s updated', 'wp-photo-album-plus' ), $tag ); |
| [3238](#L3238) | wppa\_json\_photo\_update( $photo, $txt ); |
| [3239](#L3239) | } |
| [3240](#L3240) |  |
| [3241](#L3241) | break; |
| [3242](#L3242) |  |
| [3243](#L3243) | // The wppa-settings page calls ajax with $wppa\_action == 'update-option'; |
| [3244](#L3244) | case 'update-option': |
| [3245](#L3245) |  |
| [3246](#L3246) | $ok = false; |
| [3247](#L3247) |  |
| [3248](#L3248) | // Verify that we are legally here |
| [3249](#L3249) | if ( current\_user\_can( 'wppa\_settings' ) ) { |
| [3250](#L3250) | $ok = true; |
| [3251](#L3251) | } |
| [3252](#L3252) | if ( current\_user\_can( 'wppa\_edit\_tags' ) ) { |
| [3253](#L3253) | if ( in\_array( wppa\_get( 'option' ), ['tag\_to\_edit', 'new\_tag\_value'] ) ) { |
| [3254](#L3254) | $ok = true; |
| [3255](#L3255) | } |
| [3256](#L3256) | } |
| [3257](#L3257) | if ( current\_user\_can( 'wppa\_edit\_email' ) ) { |
| [3258](#L3258) | if ( in\_array( wppa\_get( 'option' ), |
| [3259](#L3259) | ['newalbumnotify', |
| [3260](#L3260) | 'feuploadnotify', |
| [3261](#L3261) | 'commentnotify', |
| [3262](#L3262) | 'commentprevious', |
| [3263](#L3263) | 'moderatephoto', |
| [3264](#L3264) | 'moderatecomment', |
| [3265](#L3265) | 'photoapproved', |
| [3266](#L3266) | 'commentapproved', |
| [3267](#L3267) | 'clear-newalbumnotify', |
| [3268](#L3268) | 'clear-feuploadnotify', |
| [3269](#L3269) | 'clear-commentnotify', |
| [3270](#L3270) | 'clear-commentprevious', |
| [3271](#L3271) | 'clear-moderatephoto', |
| [3272](#L3272) | 'clear-moderatecomment', |
| [3273](#L3273) | 'clear-photoapproved', |
| [3274](#L3274) | 'clear-commentapproved', |
| [3275](#L3275) | ] ) ) { |
| [3276](#L3276) | $ok = true; |
| [3277](#L3277) | } |
| [3278](#L3278) | } |
| [3279](#L3279) |  |
| [3280](#L3280) | if ( ! $ok ) { |
| [3281](#L3281) | wppa\_echo( '||1||'.\_\_( 'Insufficient access rights', 'wp-photo-album-plus' ) ); |
| [3282](#L3282) | wppa\_exit(); |
| [3283](#L3283) | } |
| [3284](#L3284) |  |
| [3285](#L3285) | $nonce  = wppa\_get( 'nonce' ); |
| [3286](#L3286) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce' ) ) { |
| [3287](#L3287) | wppa\_log( 'Misc', 'nonce failed on ' . $wppa\_action ); |
| [3288](#L3288) | wppa\_echo( '||1||'.\_\_( 'Security check failure', 'wp-photo-album-plus' ) ); |
| [3289](#L3289) | wppa\_exit(); |
| [3290](#L3290) | } |
| [3291](#L3291) |  |
| [3292](#L3292) | // Initialize |
| [3293](#L3293) | $old\_minisize = wppa\_get\_minisize();                    // Remember for later, maybe we do something that requires regen |
| [3294](#L3294) | $option = 'wppa\_' . wppa\_get( 'option' );               // The option to be processed |
| [3295](#L3295) | $filter = 'text'; |
| [3296](#L3296) | if ( in\_array( $option, ['wppa\_newphoto\_description', 'wppa\_bc\_txt', 'wppa\_custom\_content', 'wppa\_copyright\_notice'] ) ) { |
| [3297](#L3297) | $filter = 'html'; |
| [3298](#L3298) | } |
| [3299](#L3299) | if ( in\_array( $option, ['wppa\_custom\_content', |
| [3300](#L3300) | 'wppa\_search\_toptext', |
| [3301](#L3301) | 'wppa\_search\_selbox\_0', |
| [3302](#L3302) | 'wppa\_search\_selbox\_1', |
| [3303](#L3303) | 'wppa\_search\_selbox\_2', |
| [3304](#L3304) | 'wppa\_copyright\_notice', |
| [3305](#L3305) | 'wppa\_newphoto\_description', |
| [3306](#L3306) | 'wppa\_admin\_inline\_css', |
| [3307](#L3307) | 'wppa\_custom\_album\_proc', |
| [3308](#L3308) | 'wppa\_custom\_photo\_proc', |
| [3309](#L3309) | 'wppa\_textual\_watermark\_text'] ) ) { |
| [3310](#L3310) | $filter = 'textarea'; |
| [3311](#L3311) | } |
| [3312](#L3312) | $value  = wppa\_decode( wppa\_get( 'value', '', $filter ) );      // The new value, may also contain & # and + |
| [3313](#L3313) |  |
| [3314](#L3314) | if ( $option == 'wppa\_nicescroll\_opts' ) { |
| [3315](#L3315) | $value = wppa\_decode( wppa\_get( 'value', '', 'textarea' ) ); |
| [3316](#L3316) | } |
| [3317](#L3317) |  |
| [3318](#L3318) | $value  = trim( $value );       // Remaove surrounding spaces |
| [3319](#L3319) | $alert  = '';                           // Init the return string data |
| [3320](#L3320) | wppa( 'error', '0' );           // |
| [3321](#L3321) | $title  = '';                           // |
| [3322](#L3322) |  |
| [3323](#L3323) |  |
| [3324](#L3324) | // If it is a font family, change all double quotes into single quotes as this destroys much more than you would like |
| [3325](#L3325) | if ( strpos( $option, 'wppa\_fontfamily\_' ) !== false ) $value = str\_replace( '"', "'", $value ); |
| [3326](#L3326) |  |
| [3327](#L3327) | $option = wppa\_decode( $option ); |
| [3328](#L3328) |  |
| [3329](#L3329) | // Dispatch on option |
| [3330](#L3330) | if ( $option == 'wppa\_getspinnerpreview' ) { |
| [3331](#L3331) | if ( wppa\_get( 'type' ) == 'normal' ) { |
| [3332](#L3332) | wppa\_echo( wppa\_get\_spinner\_svg\_html( array(    'size'          => 60, |
| [3333](#L3333) | 'display'       => 'inline', |
| [3334](#L3334) | 'lightbox'      => false, |
| [3335](#L3335) | 'position'      => 'relative', |
| [3336](#L3336) | 'left'          => '0', |
| [3337](#L3337) | 'top'           => '0', |
| [3338](#L3338) | 'margin'        => '0', |
| [3339](#L3339) | ) ) ); |
| [3340](#L3340) | } |
| [3341](#L3341) | elseif ( wppa\_get( 'type' ) == 'lightbox' ) { |
| [3342](#L3342) | wppa\_echo( wppa\_get\_spinner\_svg\_html( array(    'size'          => 60, |
| [3343](#L3343) | 'display'       => 'inline', |
| [3344](#L3344) | 'lightbox'      => true, |
| [3345](#L3345) | 'position'      => 'relative', |
| [3346](#L3346) | 'left'          => '0', |
| [3347](#L3347) | 'top'           => '0', |
| [3348](#L3348) | 'margin'        => '0', |
| [3349](#L3349) | ) ) ); |
| [3350](#L3350) | } |
| [3351](#L3351) | else { |
| [3352](#L3352) | wppa\_echo( 'Error' ); |
| [3353](#L3353) | } |
| [3354](#L3354) | wppa\_exit(); |
| [3355](#L3355) | } |
| [3356](#L3356) |  |
| [3357](#L3357) | // Clear mailinglist |
| [3358](#L3358) | if ( in\_array( wppa\_get( 'option' ), |
| [3359](#L3359) | ['clear-newalbumnotify', |
| [3360](#L3360) | 'clear-feuploadnotify', |
| [3361](#L3361) | 'clear-commentnotify', |
| [3362](#L3362) | 'clear-commentprevious', |
| [3363](#L3363) | 'clear-moderatephoto', |
| [3364](#L3364) | 'clear-moderatecomment', |
| [3365](#L3365) | 'clear-photoapproved', |
| [3366](#L3366) | 'clear-commentapproved',] ) ) { |
| [3367](#L3367) | $type = substr( wppa\_get( 'option' ), 6 ); |
| [3368](#L3368) |  |
| [3369](#L3369) | // Do it |
| [3370](#L3370) | delete\_option( 'wppa\_mailinglist\_' . $type ); |
| [3371](#L3371) | wppa\_echo("Mailinglist $type successfully cleared"); |
| [3372](#L3372) | wppa\_exit(); |
| [3373](#L3373) | } |
| [3374](#L3374) |  |
| [3375](#L3375) | if ( substr( $option, 0, 16 ) == 'wppa\_iptc\_label\_' ) { |
| [3376](#L3376) | $tag   = substr( $option, 16 ); |
| [3377](#L3377) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_iptc SET description = %s WHERE tag = %s AND photo = '0'", $value, $tag ); |
| [3378](#L3378) | $bret  = wppa\_query( $query ); |
| [3379](#L3379) | // Produce the response text |
| [3380](#L3380) | if ( $bret ) { |
| [3381](#L3381) | $output = '||0||'.$tag.' updated to '.$value.'||'; |
| [3382](#L3382) | } |
| [3383](#L3383) | else { |
| [3384](#L3384) | $output = '||1||Failed to update '.$tag.'||'; |
| [3385](#L3385) | } |
| [3386](#L3386) | wppa\_echo( $output ); |
| [3387](#L3387) | wppa\_exit(); |
| [3388](#L3388) | } |
| [3389](#L3389) | elseif ( substr( $option, 0, 17 ) == 'wppa\_iptc\_status\_' ) { |
| [3390](#L3390) | $tag   = substr( $option, 17 ); |
| [3391](#L3391) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_iptc SET status = %s WHERE tag = %s AND photo = '0'", $value, $tag ); |
| [3392](#L3392) | $bret  = wppa\_query( $query ); |
| [3393](#L3393) | // Produce the response text |
| [3394](#L3394) | if ( $bret ) { |
| [3395](#L3395) | $output = '||0||'.$tag.' updated to '.$value.'||'; |
| [3396](#L3396) | } |
| [3397](#L3397) | else { |
| [3398](#L3398) | $output = '||1||Failed to update '.$tag.'||'; |
| [3399](#L3399) | } |
| [3400](#L3400) | wppa\_echo( $output ); |
| [3401](#L3401) | wppa\_exit(); |
| [3402](#L3402) | } |
| [3403](#L3403) | elseif ( substr( $option, 0, 16 ) == 'wppa\_exif\_label\_' ) { |
| [3404](#L3404) | $tag   = substr( $option, 16 ); |
| [3405](#L3405) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_exif SET description = %s WHERE tag = %s AND photo = '0'", $value, $tag ); |
| [3406](#L3406) | $bret  = wppa\_query( $query ); |
| [3407](#L3407) | // Produce the response text |
| [3408](#L3408) | if ( $bret ) { |
| [3409](#L3409) | $output = '||0||'.$tag.' updated to '.$value.'||'; |
| [3410](#L3410) | } |
| [3411](#L3411) | else { |
| [3412](#L3412) | $output = '||1||Failed to update '.$tag.'||'; |
| [3413](#L3413) | } |
| [3414](#L3414) | wppa\_echo( $output ); |
| [3415](#L3415) | wppa\_exit(); |
| [3416](#L3416) | } |
| [3417](#L3417) | elseif ( substr( $option, 0, 17 ) == 'wppa\_exif\_status\_' ) { |
| [3418](#L3418) | $tag   = substr( $option, 17 ); |
| [3419](#L3419) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_exif SET status = %s WHERE tag = %s AND photo = '0'", $value, $tag ); |
| [3420](#L3420) | $bret  = wppa\_query( $query ); |
| [3421](#L3421) | // Produce the response text |
| [3422](#L3422) | if ( $bret ) { |
| [3423](#L3423) | $output = '||0||'.$tag.' updated to '.$value.'||'; |
| [3424](#L3424) | } |
| [3425](#L3425) | else { |
| [3426](#L3426) | $output = '||1||Failed to update '.$tag.'||'; |
| [3427](#L3427) | } |
| [3428](#L3428) | wppa\_echo( $output ); |
| [3429](#L3429) | wppa\_exit(); |
| [3430](#L3430) | } |
| [3431](#L3431) | elseif ( substr( $option, 0, 10 ) == 'wppa\_caps-' ) {   // Is capability setting |
| [3432](#L3432) | global $wp\_roles; |
| [3433](#L3433) | //$R = new WP\_Roles; |
| [3434](#L3434) | $setting = explode( '-', $option ); |
| [3435](#L3435) | if ( $value == 'yes' ) { |
| [3436](#L3436) | $wp\_roles->add\_cap( $setting[2], $setting[1] ); |
| [3437](#L3437) | wppa\_echo( '||0||'.\_\_( 'Capability granted' , 'wp-photo-album-plus' ).'||' ); |
| [3438](#L3438) | wppa\_exit(); |
| [3439](#L3439) | } |
| [3440](#L3440) | elseif ( $value == 'no' ) { |
| [3441](#L3441) | $wp\_roles->remove\_cap( $setting[2], $setting[1] ); |
| [3442](#L3442) | wppa\_echo( '||0||'.\_\_( 'Capability withdrawn' , 'wp-photo-album-plus' ).'||' ); |
| [3443](#L3443) | wppa\_exit(); |
| [3444](#L3444) | } |
| [3445](#L3445) | else { |
| [3446](#L3446) | wppa\_echo( '||1||Invalid value: '.$value.'||' ); |
| [3447](#L3447) | wppa\_exit(); |
| [3448](#L3448) | } |
| [3449](#L3449) | } |
| [3450](#L3450) | elseif ( substr( $option, 0, 8 ) == 'wppa\_qr\_' ) { // Is qr code setting |
| [3451](#L3451) | if ( wppa\_is\_dir( WPPA\_UPLOAD\_PATH . '/qr' ) ) { |
| [3452](#L3452) | $caches = wppa\_glob( WPPA\_UPLOAD\_PATH . '/qr/\*.svg' ); |
| [3453](#L3453) | if ( $caches ) foreach ( $caches as $cache ) { |
| [3454](#L3454) | wp\_delete\_file( $cache ); |
| [3455](#L3455) | } |
| [3456](#L3456) | } |
| [3457](#L3457) | wppa\_update\_option( 'wppa\_qr\_cache\_hits', '0' ); |
| [3458](#L3458) | wppa\_update\_option( 'wppa\_qr\_cache\_miss', '0' ); |
| [3459](#L3459) | wppa\_update\_option( $option, $value ); |
| [3460](#L3460) | /\* Translators: setting name, setting value \*/ |
| [3461](#L3461) | $title = sprintf( \_\_( 'Setting %1$s updated to %2$s', 'wp-photo-album-plus' ), $option, $value ); |
| [3462](#L3462) |  |
| [3463](#L3463) | // Something to do after changing the setting? |
| [3464](#L3464) | wppa\_initialize\_runtime( true );        // force reload new values |
| [3465](#L3465) |  |
| [3466](#L3466) | // Produce the response text |
| [3467](#L3467) | $output = '||0||'.esc\_attr( $title ).'||'; |
| [3468](#L3468) |  |
| [3469](#L3469) | wppa\_echo( $output ); |
| [3470](#L3470) | wppa\_clear\_cache( ['qr' => true] ); |
| [3471](#L3471) | wppa\_exit(); |
| [3472](#L3472) | break;  // End update qr setting |
| [3473](#L3473) | } |
| [3474](#L3474) |  |
| [3475](#L3475) | else switch ( $option ) { |
| [3476](#L3476) |  |
| [3477](#L3477) | // Custom mainetance procedures |
| [3478](#L3478) | case 'wppa\_custom\_album\_proc': |
| [3479](#L3479) | case 'wppa\_custom\_photo\_proc': |
| [3480](#L3480) | $value = wppa\_get( 'value', '', 'php' ); |
| [3481](#L3481) | $err = false; |
| [3482](#L3482) | $path = WPPA\_UPLOAD\_PATH . '/procs/' . $option . '.php'; |
| [3483](#L3483) | if ( ! wppa\_is\_dir( dirname( $path ) ) ) { |
| [3484](#L3484) | wppa\_mkdir( dirname( $path ) ); |
| [3485](#L3485) | } |
| [3486](#L3486) | $bret = wppa\_put\_contents( $path, '<?php ' . $value ); |
| [3487](#L3487) |  |
| [3488](#L3488) | if ( $bret ) { |
| [3489](#L3489) | $title = \_\_( 'Code successfully saved', 'wp-photo-album-plus' ); |
| [3490](#L3490) | } |
| [3491](#L3491) | else { |
| [3492](#L3492) | $title = \_\_( 'Failed to save code', 'wp-photo-album-plus' ); |
| [3493](#L3493) | $alert = $title; |
| [3494](#L3494) | } |
| [3495](#L3495) | break; |
| [3496](#L3496) |  |
| [3497](#L3497) | // Changing potd\_album\_type ( physical / virtual ) also clears potd\_album |
| [3498](#L3498) | case 'wppa\_potd\_album\_type': |
| [3499](#L3499) | if ( ! in\_array( $value, array( 'physical', 'virtual' ) ) ) { |
| [3500](#L3500) | wppa\_echo( '||1||Invalid value: '.$value.'||' ); |
| [3501](#L3501) | wppa\_exit(); |
| [3502](#L3502) | } |
| [3503](#L3503) | if ( $value == 'physical' ) { |
| [3504](#L3504) | wppa\_update\_option( 'wppa\_potd\_album', '' ); |
| [3505](#L3505) | } |
| [3506](#L3506) | else { |
| [3507](#L3507) | wppa\_update\_option( 'wppa\_potd\_album', 'all' ); |
| [3508](#L3508) | } |
| [3509](#L3509) | wppa\_update\_option( 'wppa\_potd\_id\_cache', false ); |
| [3510](#L3510) | break; |
| [3511](#L3511) | case 'wppa\_potd\_album': |
| [3512](#L3512) | if ( wppa\_opt( 'potd\_album\_type' ) == 'physical' ) { |
| [3513](#L3513) | $value = str\_replace( '.', ',', ( wppa\_expand\_enum( str\_replace( ',', '.', $value ) ) ) ); |
| [3514](#L3514) | } |
| [3515](#L3515) | wppa\_update\_option( 'wppa\_potd\_id\_cache', false ); |
| [3516](#L3516) | break; |
| [3517](#L3517) |  |
| [3518](#L3518) | case 'wppa\_initial\_colwidth'://??  fixed   low    high    title |
| [3519](#L3519) | wppa\_ajax\_check\_range( $value, false, '100', false, \_\_( 'Initial width.' , 'wp-photo-album-plus' ) ); |
| [3520](#L3520) | break; |
| [3521](#L3521) | case 'wppa\_fullsize': |
| [3522](#L3522) | wppa\_ajax\_check\_range( $value, false, '100', false, \_\_( 'Full size.' , 'wp-photo-album-plus' ) ); |
| [3523](#L3523) | break; |
| [3524](#L3524) | case 'wppa\_maxheight': |
| [3525](#L3525) | wppa\_ajax\_check\_range( $value, false, '100', false, \_\_( 'Max height.' , 'wp-photo-album-plus' ) ); |
| [3526](#L3526) | break; |
| [3527](#L3527) | case 'wppa\_film\_thumbsize': |
| [3528](#L3528) | case 'wppa\_thumbsize': |
| [3529](#L3529) | case 'wppa\_thumbsize\_alt': |
| [3530](#L3530) | wppa\_ajax\_check\_range( $value, false, '50', false, \_\_( 'Thumbnail size.' , 'wp-photo-album-plus' ) ); |
| [3531](#L3531) | break; |
| [3532](#L3532) | case 'wppa\_tf\_width': |
| [3533](#L3533) | case 'wppa\_tf\_width\_alt': |
| [3534](#L3534) | wppa\_ajax\_check\_range( $value, false, '50', false, \_\_( 'Thumbnail frame width' , 'wp-photo-album-plus' ) ); |
| [3535](#L3535) | break; |
| [3536](#L3536) | case 'wppa\_tf\_height': |
| [3537](#L3537) | case 'wppa\_tf\_height\_alt': |
| [3538](#L3538) | wppa\_ajax\_check\_range( $value, false, '50',false,  \_\_( 'Thumbnail frame height' , 'wp-photo-album-plus' ) ); |
| [3539](#L3539) | break; |
| [3540](#L3540) | case 'wppa\_tn\_margin': |
| [3541](#L3541) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Thumbnail Spacing' , 'wp-photo-album-plus' ) ); |
| [3542](#L3542) | break; |
| [3543](#L3543) | case 'wppa\_thumb\_page\_size': |
| [3544](#L3544) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Thumb page size.' , 'wp-photo-album-plus' ) ); |
| [3545](#L3545) | break; |
| [3546](#L3546) | case 'wppa\_smallsize': |
| [3547](#L3547) | wppa\_ajax\_check\_range( $value, false, '50', false, \_\_( 'Cover photo size.' , 'wp-photo-album-plus' ) ); |
| [3548](#L3548) | break; |
| [3549](#L3549) | case 'wppa\_smallsize\_percentage': |
| [3550](#L3550) | wppa\_ajax\_check\_range( $value, false, '10', '100', \_\_( 'Cover photo size.' , 'wp-photo-album-plus' ) ); |
| [3551](#L3551) | break; |
| [3552](#L3552) | case 'wppa\_album\_page\_size': |
| [3553](#L3553) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Album page size.' , 'wp-photo-album-plus' ) ); |
| [3554](#L3554) | break; |
| [3555](#L3555) | case 'wppa\_topten\_count': |
| [3556](#L3556) | wppa\_ajax\_check\_range( $value, false, '2', false, \_\_( 'Number of TopTen photos' , 'wp-photo-album-plus' ), '40' ); |
| [3557](#L3557) | break; |
| [3558](#L3558) | case 'wppa\_topten\_size': |
| [3559](#L3559) | wppa\_ajax\_check\_range( $value, false, '32', false, \_\_( 'Widget image thumbnail size' , 'wp-photo-album-plus' ), wppa\_get\_minisize() ); |
| [3560](#L3560) | break; |
| [3561](#L3561) | case 'wppa\_max\_cover\_width': |
| [3562](#L3562) | wppa\_ajax\_check\_range( $value, false, '150', false, \_\_( 'Max Cover width' , 'wp-photo-album-plus' ) ); |
| [3563](#L3563) | break; |
| [3564](#L3564) | case 'wppa\_text\_frame\_height': |
| [3565](#L3565) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Minimal description height' , 'wp-photo-album-plus' ) ); |
| [3566](#L3566) | break; |
| [3567](#L3567) | case 'wppa\_cover\_minheight': |
| [3568](#L3568) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Minimal cover height' , 'wp-photo-album-plus' ) ); |
| [3569](#L3569) | break; |
| [3570](#L3570) | case 'wppa\_head\_and\_text\_frame\_height': |
| [3571](#L3571) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Minimal text frame height' , 'wp-photo-album-plus' ) ); |
| [3572](#L3572) | break; |
| [3573](#L3573) | case 'wppa\_bwidth': |
| [3574](#L3574) | wppa\_ajax\_check\_range( $value, '', '0', false, \_\_( 'Border width' , 'wp-photo-album-plus' ) ); |
| [3575](#L3575) | break; |
| [3576](#L3576) | case 'wppa\_bradius': |
| [3577](#L3577) | wppa\_ajax\_check\_range( $value, '', '0', false, \_\_( 'Border radius' , 'wp-photo-album-plus' ) ); |
| [3578](#L3578) | break; |
| [3579](#L3579) | case 'wppa\_box\_spacing': |
| [3580](#L3580) | wppa\_ajax\_check\_range( $value, '', '-20', '100', \_\_( 'Box spacing' , 'wp-photo-album-plus' ) ); |
| [3581](#L3581) | break; |
| [3582](#L3582) | case 'wppa\_popupsize': |
| [3583](#L3583) | $floor = wppa\_opt( 'thumbsize' ); |
| [3584](#L3584) | $temp  = wppa\_opt( 'smallsize' ); |
| [3585](#L3585) | if ( $temp > $floor ) $floor = $temp; |
| [3586](#L3586) | wppa\_ajax\_check\_range( $value, false, $floor, wppa\_opt( 'fullsize' ), \_\_( 'Popup size' , 'wp-photo-album-plus' ) ); |
| [3587](#L3587) | break; |
| [3588](#L3588) | case 'wppa\_fullimage\_border\_width': |
| [3589](#L3589) | wppa\_ajax\_check\_range( $value, '', '0', false, \_\_( 'Fullsize border width' , 'wp-photo-album-plus' ) ); |
| [3590](#L3590) | break; |
| [3591](#L3591) | case 'wppa\_lightbox\_bordersize': |
| [3592](#L3592) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Lightbox Bordersize' , 'wp-photo-album-plus' ) ); |
| [3593](#L3593) | break; |
| [3594](#L3594) | case 'wppa\_ovl\_border\_width': |
| [3595](#L3595) | wppa\_ajax\_check\_range( $value, false, '0', '16', \_\_( 'Lightbox Borderwidth' , 'wp-photo-album-plus' ) ); |
| [3596](#L3596) | break; |
| [3597](#L3597) | case 'wppa\_ovl\_border\_radius': |
| [3598](#L3598) | wppa\_ajax\_check\_range( $value, false, '0', '16', \_\_( 'Lightbox Borderradius' , 'wp-photo-album-plus' ) ); |
| [3599](#L3599) | break; |
| [3600](#L3600) | case 'wppa\_comment\_count': |
| [3601](#L3601) | wppa\_ajax\_check\_range( $value, false, '2', '40', \_\_( 'Number of Comment widget entries' , 'wp-photo-album-plus' ) ); |
| [3602](#L3602) | break; |
| [3603](#L3603) | case 'wppa\_comment\_size': |
| [3604](#L3604) | wppa\_ajax\_check\_range( $value, false, '32', wppa\_get\_minisize(), \_\_( 'Comment Widget image thumbnail size' , 'wp-photo-album-plus' ), wppa\_get\_minisize() ); |
| [3605](#L3605) | break; |
| [3606](#L3606) | case 'wppa\_thumb\_opacity': |
| [3607](#L3607) | wppa\_ajax\_check\_range( $value, false, '0', '100', \_\_( 'Opacity.' , 'wp-photo-album-plus' ) ); |
| [3608](#L3608) | break; |
| [3609](#L3609) | case 'wppa\_cover\_opacity': |
| [3610](#L3610) | wppa\_ajax\_check\_range( $value, false, '0', '100', \_\_( 'Opacity.' , 'wp-photo-album-plus' ) ); |
| [3611](#L3611) | break; |
| [3612](#L3612) | case 'wppa\_star\_opacity': |
| [3613](#L3613) | wppa\_ajax\_check\_range( $value, false, '0', '50', \_\_( 'Opacity.' , 'wp-photo-album-plus' ) ); |
| [3614](#L3614) | break; |
| [3615](#L3615) | case 'wppa\_gravatar\_size': |
| [3616](#L3616) | wppa\_ajax\_check\_range( $value, false, '10', '256', \_\_( 'Avatar size' , 'wp-photo-album-plus' ) ); |
| [3617](#L3617) | break; |
| [3618](#L3618) | case 'wppa\_watermark\_opacity': |
| [3619](#L3619) | wppa\_ajax\_check\_range( $value, false, '0', '100', \_\_( 'Watermark opacity' , 'wp-photo-album-plus' ) ); |
| [3620](#L3620) | break; |
| [3621](#L3621) | case 'wppa\_watermark\_opacity\_text': |
| [3622](#L3622) | wppa\_ajax\_check\_range( $value, false, '0', '100', \_\_( 'Watermark opacity' , 'wp-photo-album-plus' ) ); |
| [3623](#L3623) | break; |
| [3624](#L3624) | case 'wppa\_ovl\_txt\_lines': |
| [3625](#L3625) | wppa\_ajax\_check\_range( $value, 'auto', '0', '24', \_\_( 'Number of text lines' , 'wp-photo-album-plus' ) ); |
| [3626](#L3626) | break; |
| [3627](#L3627) | case 'wppa\_ovl\_opacity': |
| [3628](#L3628) | wppa\_ajax\_check\_range( $value, false, '0', '100', \_\_( 'Overlay opacity' , 'wp-photo-album-plus' ) ); |
| [3629](#L3629) | break; |
| [3630](#L3630) | case 'wppa\_upload\_limit\_count': |
| [3631](#L3631) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Upload limit' , 'wp-photo-album-plus' ) ); |
| [3632](#L3632) | break; |
| [3633](#L3633) | case 'wppa\_dislike\_mail\_every': |
| [3634](#L3634) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Notify inappropriate' , 'wp-photo-album-plus' ) ); |
| [3635](#L3635) | break; |
| [3636](#L3636) | case 'wppa\_dislike\_set\_pending': |
| [3637](#L3637) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Dislike pending' , 'wp-photo-album-plus' ) ); |
| [3638](#L3638) | break; |
| [3639](#L3639) | case 'wppa\_dislike\_delete': |
| [3640](#L3640) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Dislike delete' , 'wp-photo-album-plus' ) ); |
| [3641](#L3641) | break; |
| [3642](#L3642) | case 'wppa\_cp\_points\_comment': |
| [3643](#L3643) | case 'wppa\_cp\_points\_comment\_appr': |
| [3644](#L3644) | case 'wppa\_cp\_points\_rating': |
| [3645](#L3645) | case 'wppa\_cp\_points\_upload': |
| [3646](#L3646) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'myCRED / Cube Points' , 'wp-photo-album-plus' ) ); |
| [3647](#L3647) | break; |
| [3648](#L3648) | case 'wppa\_jpeg\_quality': |
| [3649](#L3649) | wppa\_ajax\_check\_range( $value, false, '20', '100', \_\_( 'JPG Image quality' , 'wp-photo-album-plus' ) ); |
| [3650](#L3650) | if ( wppa\_cdn( 'admin' ) == 'cloudinary' && ! wppa( 'out' ) ) { |
| [3651](#L3651) | wppa\_delete\_derived\_from\_cloudinary(); |
| [3652](#L3652) | } |
| [3653](#L3653) | break; |
| [3654](#L3654) | case 'wppa\_imgfact\_count': |
| [3655](#L3655) | wppa\_ajax\_check\_range( $value, false, '1', '24', \_\_( 'Number of coverphotos', 'wp-photo-album-plus' ) ); |
| [3656](#L3656) | break; |
| [3657](#L3657) | case 'wppa\_dislike\_value': |
| [3658](#L3658) | wppa\_ajax\_check\_range( $value, false, '-10', '0', \_\_( 'Dislike value', 'wp-photo-album-plus' ) ); |
| [3659](#L3659) | break; |
| [3660](#L3660) | case 'wppa\_slideshow\_pagesize': |
| [3661](#L3661) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Slideshow pagesize', 'wp-photo-album-plus' ) ); |
| [3662](#L3662) | break; |
| [3663](#L3663) | case 'wppa\_slideonly\_max': |
| [3664](#L3664) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Slideonly max', 'wp-photo-album-plus' ) ); |
| [3665](#L3665) | break; |
| [3666](#L3666) | case 'wppa\_pagelinks\_max': |
| [3667](#L3667) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Max Pagelinks', 'wp-photo-album-plus' ) ); |
| [3668](#L3668) | break; |
| [3669](#L3669) | case 'wppa\_area\_size': |
| [3670](#L3670) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Thumbnail area max size', 'wp-photo-album-plus' ) ); |
| [3671](#L3671) | break; |
| [3672](#L3672) | case 'wppa\_area\_size\_slide': |
| [3673](#L3673) | wppa\_ajax\_check\_range( $value, false, '0', false, \_\_( 'Slideshow area max size', 'wp-photo-album-plus' ) ); |
| [3674](#L3674) | break; |
| [3675](#L3675) | case 'wppa\_cover\_spacing': |
| [3676](#L3676) | wppa\_ajax\_check\_range( $value, false, '0', '50', \_\_( 'Cover spacing', 'wp-photo-album-plus' ) ); |
| [3677](#L3677) | break; |
| [3678](#L3678) | case 'wppa\_user\_create\_max\_level': |
| [3679](#L3679) | wppa\_ajax\_check\_range( $value, false, '0', '99', \_\_( 'Max nesting level', 'wp-photo-album-plus' ) ); |
| [3680](#L3680) | break; |
| [3681](#L3681) | case 'wppa\_sticky\_header\_size': |
| [3682](#L3682) | wppa\_ajax\_check\_range( $value, false, '0', '400', \_\_('Sticky header size', 'wp-photo-album-plus' ) ); |
| [3683](#L3683) | break; |
| [3684](#L3684) |  |
| [3685](#L3685) | case 'wppa\_rating\_clear': |
| [3686](#L3686) | $iret = wppa\_clear\_table( WPPA\_RATING ) && |
| [3687](#L3687) | wppa\_clear\_col( WPPA\_PHOTOS, 'mean\_rating', '0' ) && |
| [3688](#L3688) | wppa\_clear\_col( WPPA\_PHOTOS, 'rating\_count', '0' ); |
| [3689](#L3689) |  |
| [3690](#L3690) | if ( $iret !== false ) { |
| [3691](#L3691) | delete\_option( 'wppa\_'.WPPA\_RATING.'\_lastkey' ); |
| [3692](#L3692) | $title = \_\_( 'Ratings cleared' , 'wp-photo-album-plus' ); |
| [3693](#L3693) | } |
| [3694](#L3694) | else { |
| [3695](#L3695) | $title = \_\_( 'Could not clear ratings' , 'wp-photo-album-plus' ); |
| [3696](#L3696) | $alert = $title; |
| [3697](#L3697) | wppa( 'error', '1' ); |
| [3698](#L3698) | } |
| [3699](#L3699) | break; |
| [3700](#L3700) | case 'wppa\_viewcount\_clear': |
| [3701](#L3701) | $iret = wppa\_clear\_col( WPPA\_PHOTOS, 'views', '0' ) && |
| [3702](#L3702) | wppa\_clear\_col( WPPA\_ALBUMS, 'views', '0' ); |
| [3703](#L3703) | if ( $iret !== false ) { |
| [3704](#L3704) | $title = \_\_( 'Viewcounts cleared' , 'wp-photo-album-plus' ); |
| [3705](#L3705) | } |
| [3706](#L3706) | else { |
| [3707](#L3707) | $title = \_\_( 'Could not clear viewcounts' , 'wp-photo-album-plus' ); |
| [3708](#L3708) | $alert = $title; |
| [3709](#L3709) | wppa( 'error', '1' ); |
| [3710](#L3710) | } |
| [3711](#L3711) | break; |
| [3712](#L3712) |  |
| [3713](#L3713) | case 'wppa\_iptc\_clear': |
| [3714](#L3714) | $iret = wppa\_clear\_table( WPPA\_IPTC ); |
| [3715](#L3715) | if ( $iret !== false ) { |
| [3716](#L3716) | delete\_option( 'wppa\_'.WPPA\_IPTC.'\_lastkey' ); |
| [3717](#L3717) | $title = \_\_( 'IPTC data cleared' , 'wp-photo-album-plus' ); |
| [3718](#L3718) | wppa\_update\_option( 'wppa\_index\_need\_remake', 'yes' ); |
| [3719](#L3719) | } |
| [3720](#L3720) | else { |
| [3721](#L3721) | $title = \_\_( 'Could not clear IPTC data' , 'wp-photo-album-plus' ); |
| [3722](#L3722) | $alert = $title; |
| [3723](#L3723) | wppa( 'error', '1' ); |
| [3724](#L3724) | } |
| [3725](#L3725) | break; |
| [3726](#L3726) |  |
| [3727](#L3727) | case 'wppa\_exif\_clear': |
| [3728](#L3728) | $iret = wppa\_clear\_table( WPPA\_EXIF ); |
| [3729](#L3729) | if ( $iret !== false ) { |
| [3730](#L3730) | delete\_option( 'wppa\_'.WPPA\_EXIF.'\_lastkey' ); |
| [3731](#L3731) | $title = \_\_( 'EXIF data cleared' , 'wp-photo-album-plus' ); |
| [3732](#L3732) | wppa\_update\_option( 'wppa\_index\_need\_remake', 'yes' ); |
| [3733](#L3733) | } |
| [3734](#L3734) | else { |
| [3735](#L3735) | $title = \_\_( 'Could not clear EXIF data' , 'wp-photo-album-plus' ); |
| [3736](#L3736) | $alert = $title; |
| [3737](#L3737) | wppa( 'error', '1' ); |
| [3738](#L3738) | } |
| [3739](#L3739) | break; |
| [3740](#L3740) |  |
| [3741](#L3741) | case 'wppa\_recup': |
| [3742](#L3742) | $result = wppa\_recuperate\_iptc\_exif(); |
| [3743](#L3743) | wppa\_echo( '||0||'.\_\_( 'Recuperation performed' , 'wp-photo-album-plus' ).'||'.$result ); |
| [3744](#L3744) | wppa\_exit(); |
| [3745](#L3745) | break; |
| [3746](#L3746) |  |
| [3747](#L3747) | case 'wppa\_bgcolor\_thumbnail': |
| [3748](#L3748) | $value = trim( strtolower( $value ) ); |
| [3749](#L3749) | if ( strlen( $value ) != '7' || substr( $value, 0, 1 ) != '#' ) { |
| [3750](#L3750) | wppa( 'error', '1' ); |
| [3751](#L3751) | } |
| [3752](#L3752) | else for ( $i=1; $i<7; $i++ ) { |
| [3753](#L3753) | if ( ! in\_array( substr( $value, $i, 1 ), array( '0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f' ) ) ) { |
| [3754](#L3754) | wppa( 'error', '1' ); |
| [3755](#L3755) | } |
| [3756](#L3756) | } |
| [3757](#L3757) | if ( ! wppa( 'error' ) ) $old\_minisize--;       // Trigger regen message |
| [3758](#L3758) | else $alert = \_\_( 'Illegal format. Please enter a 6 digit hexadecimal color value. Example: #77bbff' , 'wp-photo-album-plus' ); |
| [3759](#L3759) | break; |
| [3760](#L3760) |  |
| [3761](#L3761) | case 'wppa\_thumb\_aspect': |
| [3762](#L3762) | $old\_minisize--;        // Trigger regen message |
| [3763](#L3763) | break; |
| [3764](#L3764) |  |
| [3765](#L3765) | case 'wppa\_rating\_max': |
| [3766](#L3766) | if ( $value == '5' && wppa\_opt( 'rating\_max' ) == '10' ) { |
| [3767](#L3767) | $query = "SELECT id, value FROM $wpdb->wppa\_rating"; |
| [3768](#L3768) | $rats  = wppa\_get\_results( $query ); |
| [3769](#L3769) | if ( $rats ) { |
| [3770](#L3770) | foreach ( $rats as $rat ) { |
| [3771](#L3771) | wppa\_update\_rating( $rat['id'], ['value' => $rat['value'] / 2] ); |
| [3772](#L3772) | } |
| [3773](#L3773) | } |
| [3774](#L3774) | } |
| [3775](#L3775) | if ( $value == '10' && wppa\_opt( 'rating\_max' ) == '5' ) { |
| [3776](#L3776) | $query = "SELECT id, value FROM $wpdb->wppa\_rating"; |
| [3777](#L3777) | $rats  = wppa\_get\_results( $query ); |
| [3778](#L3778) | if ( $rats ) { |
| [3779](#L3779) | foreach ( $rats as $rat ) { |
| [3780](#L3780) | wppa\_update\_rating( $rat['id'], ['value' => $rat['value'] \* 2] ); |
| [3781](#L3781) | } |
| [3782](#L3782) | } |
| [3783](#L3783) | } |
| [3784](#L3784) |  |
| [3785](#L3785) | wppa\_update\_option ( 'wppa\_rerate\_status', 'Required' ); |
| [3786](#L3786) | $alert .= \_\_( 'You just changed a setting that requires the recalculation of ratings.' , 'wp-photo-album-plus' ); |
| [3787](#L3787) | $alert .= ' '.\_\_( 'Please run the appropriate maintenance procedure.' , 'wp-photo-album-plus' ); |
| [3788](#L3788) |  |
| [3789](#L3789) | wppa\_update\_option( $option, $value ); |
| [3790](#L3790) | wppa( 'error', '0' ); |
| [3791](#L3791) | break; |
| [3792](#L3792) |  |
| [3793](#L3793) | case 'wppa\_newphoto\_description': |
| [3794](#L3794) | $value = wppa\_get( 'value', '', 'html' ); |
| [3795](#L3795) | if ( wppa\_switch( 'wppa\_compress\_newdesc' ) ) { |
| [3796](#L3796) | $value = wppa\_compress\_html( $value ); |
| [3797](#L3797) | } |
| [3798](#L3798) | wppa\_update\_option( $option, $value ); |
| [3799](#L3799) | wppa( 'error', '0' ); |
| [3800](#L3800) | $alert = ''; |
| [3801](#L3801) | wppa\_index\_compute\_skips(); |
| [3802](#L3802) | break; |
| [3803](#L3803) |  |
| [3804](#L3804) | case 'wppa\_keep\_source': |
| [3805](#L3805) | $dir = wppa\_opt( 'source\_dir' ); |
| [3806](#L3806) | if ( ! wppa\_is\_dir( $dir ) ) wppa\_mkdir( $dir ); |
| [3807](#L3807) | if ( ! wppa\_is\_dir( $dir ) || ! wppa\_is\_writable( $dir ) ) { |
| [3808](#L3808) | wppa( 'error', '1' ); |
| [3809](#L3809) | /\* translators: directory \*/ |
| [3810](#L3810) | $alert = sprintf( \_\_( 'Unable to create or write to %s' , 'wp-photo-album-plus' ), $dir ); |
| [3811](#L3811) | } |
| [3812](#L3812) | break; |
| [3813](#L3813) |  |
| [3814](#L3814) | case 'wppa\_source\_dir': |
| [3815](#L3815) | $olddir = wppa\_opt( 'source\_dir' ); |
| [3816](#L3816) | $value = rtrim( $value, '/' ); |
| [3817](#L3817) | if ( strpos( $value.'/', WPPA\_UPLOAD\_PATH.'/' ) !== false ) { |
| [3818](#L3818) | wppa( 'error', '1' ); |
| [3819](#L3819) | $alert = sprintf( \_\_( 'Source can not be inside the wppa folder.' , 'wp-photo-album-plus' ) ); |
| [3820](#L3820) | } |
| [3821](#L3821) | else { |
| [3822](#L3822) | $dir = $value; |
| [3823](#L3823) | if ( ! wppa\_is\_dir( $dir ) ) wppa\_mkdir( $dir ); |
| [3824](#L3824) | if ( ! wppa\_is\_dir( $dir ) || ! wppa\_is\_writable( $dir ) ) { |
| [3825](#L3825) | wppa( 'error', '1' ); |
| [3826](#L3826) | /\* translators: directory \*/ |
| [3827](#L3827) | $alert = sprintf( \_\_( 'Unable to create or write to %s' , 'wp-photo-album-plus' ), $dir ); |
| [3828](#L3828) | } |
| [3829](#L3829) | } |
| [3830](#L3830) | break; |
| [3831](#L3831) |  |
| [3832](#L3832) | case 'wppa\_newpag\_content': |
| [3833](#L3833) | if ( strpos( $value, 'w#album' ) === false ) { |
| [3834](#L3834) | $alert = \_\_( 'The content must contain w#album' , 'wp-photo-album-plus' ); |
| [3835](#L3835) | wppa( 'error', '1' ); |
| [3836](#L3836) | } |
| [3837](#L3837) | break; |
| [3838](#L3838) |  |
| [3839](#L3839) | case 'wppa\_gpx\_shortcode': |
| [3840](#L3840) | if ( strpos( $value, 'w#lat' ) === false || strpos( $value, 'w#lon' ) === false ) { |
| [3841](#L3841) | $alert = \_\_( 'The content must contain w#lat and w#lon' , 'wp-photo-album-plus' ); |
| [3842](#L3842) | wppa( 'error', '1' ); |
| [3843](#L3843) | } |
| [3844](#L3844) | break; |
| [3845](#L3845) |  |
| [3846](#L3846) | case 'wppa\_excl\_sep': |
| [3847](#L3847) | case 'wppa\_search\_desc': |
| [3848](#L3848) | case 'wppa\_search\_tags': |
| [3849](#L3849) | case 'wppa\_search\_cats': |
| [3850](#L3850) | case 'wppa\_search\_comments': |
| [3851](#L3851) | wppa\_clear\_taglist(); |
| [3852](#L3852) | wppa\_schedule\_maintenance\_proc( 'wppa\_remake\_index\_photos', true ); |
| [3853](#L3853) | wppa\_schedule\_maintenance\_proc( 'wppa\_remake\_index\_albums', true ); |
| [3854](#L3854) | break; |
| [3855](#L3855) |  |
| [3856](#L3856) | case 'wppa\_blacklist\_user': |
| [3857](#L3857) | // Does user exist? |
| [3858](#L3858) | $value = trim ( $value ); |
| [3859](#L3859) | $user = wppa\_get\_user\_by ( 'login', $value );   // seems to be case insensitive |
| [3860](#L3860) | if ( $user && $user->user\_login === $value ) { |
| [3861](#L3861) | if ( user\_can( $user->ID, 'administrator' ) ) { |
| [3862](#L3862) | $alert = esc\_js( \_\_( 'An administrator can not be blacklisted', 'wp-photo-album-plus' ) ); |
| [3863](#L3863) | } |
| [3864](#L3864) | else { |
| [3865](#L3865) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_photos SET status = 'pending' WHERE owner = %s", $value ); |
| [3866](#L3866) | wppa\_query( $query ); |
| [3867](#L3867) | $black\_listed\_users = wppa\_get\_option( 'wppa\_black\_listed\_users', array() ); |
| [3868](#L3868) | if ( ! in\_array( $value, $black\_listed\_users ) ) { |
| [3869](#L3869) | $black\_listed\_users[] = $value; |
| [3870](#L3870) | wppa\_update\_option( 'wppa\_black\_listed\_users', $black\_listed\_users ); |
| [3871](#L3871) | } |
| [3872](#L3872) | /\* translators: user login \*/ |
| [3873](#L3873) | $alert = esc\_js( sprintf( \_\_( 'User %s has been blacklisted.' , 'wp-photo-album-plus' ), $value ) ); |
| [3874](#L3874) | } |
| [3875](#L3875) | } |
| [3876](#L3876) | else { |
| [3877](#L3877) | /\* translators: user login \*/ |
| [3878](#L3878) | $alert = esc\_js( sprintf( \_\_( 'User %s does not exist.' , 'wp-photo-album-plus' ), $value ) ); |
| [3879](#L3879) | } |
| [3880](#L3880) | $value = ''; |
| [3881](#L3881) | break; |
| [3882](#L3882) |  |
| [3883](#L3883) | case 'wppa\_un\_blacklist\_user': |
| [3884](#L3884) | $query = $wpdb->prepare( "UPDATE $wpdb->wppa\_photos SET status = 'publish' WHERE owner = %s", $value ); |
| [3885](#L3885) | wppa\_query( $query ); |
| [3886](#L3886) | $black\_listed\_users = wppa\_get\_option( 'wppa\_black\_listed\_users', array() ); |
| [3887](#L3887) | if ( in\_array( $value, $black\_listed\_users ) ) { |
| [3888](#L3888) | foreach ( array\_keys( $black\_listed\_users ) as $usr ) { |
| [3889](#L3889) | if ( $black\_listed\_users[$usr] == $value ) unset ( $black\_listed\_users[$usr] ); |
| [3890](#L3890) | } |
| [3891](#L3891) | wppa\_update\_option( 'wppa\_black\_listed\_users', $black\_listed\_users ); |
| [3892](#L3892) | } |
| [3893](#L3893) | $value = '0'; |
| [3894](#L3894) | break; |
| [3895](#L3895) |  |
| [3896](#L3896) | case 'wppa\_superuser\_user': |
| [3897](#L3897) | // Does user exist? |
| [3898](#L3898) | $value = trim ( $value ); |
| [3899](#L3899) | $user = wppa\_get\_user\_by ( 'login', $value );   // seems to be case insensitive |
| [3900](#L3900) | if ( $user && $user->user\_login === $value ) { |
| [3901](#L3901) | if ( user\_can( $user->ID, 'administrator' ) ) { |
| [3902](#L3902) | $alert = esc\_js( \_\_( 'An administrator can not be a superuser', 'wp-photo-album-plus' ) ); |
| [3903](#L3903) | } |
| [3904](#L3904) | else { |
| [3905](#L3905) | $super\_users = wppa\_get\_option( 'wppa\_super\_users', array() ); |
| [3906](#L3906) | if ( ! in\_array( $value, $super\_users ) ) { |
| [3907](#L3907) | $super\_users[] = $value; |
| [3908](#L3908) | wppa\_update\_option( 'wppa\_super\_users', $super\_users ); |
| [3909](#L3909) | } |
| [3910](#L3910) | /\* translators: user login \*/ |
| [3911](#L3911) | $alert = esc\_js( sprintf( \_\_( 'User %s is now superuser.' , 'wp-photo-album-plus' ), $value ) ); |
| [3912](#L3912) | } |
| [3913](#L3913) | } |
| [3914](#L3914) | else { |
| [3915](#L3915) | /\* translators: user login \*/ |
| [3916](#L3916) | $alert = esc\_js( sprintf( \_\_( 'User %s does not exist.' , 'wp-photo-album-plus' ), $value ) ); |
| [3917](#L3917) | } |
| [3918](#L3918) | $value = ''; |
| [3919](#L3919) | break; |
| [3920](#L3920) |  |
| [3921](#L3921) | case 'wppa\_un\_superuser\_user': |
| [3922](#L3922) | $super\_users = wppa\_get\_option( 'wppa\_super\_users', array() ); |
| [3923](#L3923) | if ( in\_array( $value, $super\_users ) ) { |
| [3924](#L3924) | foreach ( array\_keys( $super\_users ) as $usr ) { |
| [3925](#L3925) | if ( $super\_users[$usr] == $value ) unset ( $super\_users[$usr] ); |
| [3926](#L3926) | } |
| [3927](#L3927) | wppa\_update\_option( 'wppa\_super\_users', $super\_users ); |
| [3928](#L3928) | } |
| [3929](#L3929) | $value = '0'; |
| [3930](#L3930) | break; |
| [3931](#L3931) |  |
| [3932](#L3932) | case 'wppa\_fotomoto\_on': |
| [3933](#L3933) | if ( $value == 'yes' ) { |
| [3934](#L3934) | $custom\_content = wppa\_opt( 'custom\_content' ); |
| [3935](#L3935) | if ( strpos( $custom\_content, 'w#fotomoto' ) === false ) { |
| [3936](#L3936) | $custom\_content = 'w#fotomoto '.$custom\_content; |
| [3937](#L3937) | wppa\_update\_option( 'wppa\_custom\_content', $custom\_content ); |
| [3938](#L3938) | $alert = \_\_( 'The content of the Custom box has been changed to display the Fotomoto toolbar.' , 'wp-photo-album-plus' ).' '; |
| [3939](#L3939) | } |
| [3940](#L3940) | if ( ! wppa\_switch( 'custom\_on' ) ) { |
| [3941](#L3941) | wppa\_update\_option( 'wppa\_custom\_on', 'yes' ); |
| [3942](#L3942) | $alert .= \_\_( 'The display of the custom box has been enabled' , 'wp-photo-album-plus' ); |
| [3943](#L3943) | } |
| [3944](#L3944) | } |
| [3945](#L3945) | break; |
| [3946](#L3946) |  |
| [3947](#L3947) | case 'wppa\_save\_gpx': |
| [3948](#L3948) | if ( $value == 'yes' ) { |
| [3949](#L3949) | $custom\_content = wppa\_opt( 'custom\_content' ); |
| [3950](#L3950) | if ( strpos( $custom\_content, 'w#location' ) === false ) { |
| [3951](#L3951) | $custom\_content = 'w#location '.$custom\_content; |
| [3952](#L3952) | wppa\_update\_option( 'wppa\_custom\_content', $custom\_content ); |
| [3953](#L3953) | $alert = \_\_( 'The content of the Slideshow component Custom box has been changed to display the location map.' , 'wp-photo-album-plus' ).' '; |
| [3954](#L3954) | } |
| [3955](#L3955) | if ( ! wppa\_switch( 'custom\_on' ) ) { |
| [3956](#L3956) | wppa\_update\_option( 'wppa\_custom\_on', 'yes' ); |
| [3957](#L3957) | $alert .= \_\_( 'The display of the custom box has been enabled' , 'wp-photo-album-plus' ); |
| [3958](#L3958) | } |
| [3959](#L3959) | } |
| [3960](#L3960) | break; |
| [3961](#L3961) |  |
| [3962](#L3962) | case 'wppa\_gpx\_implementation': |
| [3963](#L3963) | if ( $value != 'none' ) { |
| [3964](#L3964) | $custom\_content = wppa\_opt( 'custom\_content' ); |
| [3965](#L3965) | if ( strpos( $custom\_content, 'w#location' ) === false ) { |
| [3966](#L3966) | $custom\_content = $custom\_content.' w#location'; |
| [3967](#L3967) | wppa\_update\_option( 'wppa\_custom\_content', $custom\_content ); |
| [3968](#L3968) | $alert = \_\_( 'The content of the Slideshow component Custom box has been changed to display maps.' , 'wp-photo-album-plus' ).' '; |
| [3969](#L3969) | } |
| [3970](#L3970) | if ( ! wppa\_switch( 'custom\_on' ) ) { |
| [3971](#L3971) | wppa\_update\_option( 'wppa\_custom\_on', 'yes' ); |
| [3972](#L3972) | $alert .= \_\_( 'The display of the custom box has been enabled.' , 'wp-photo-album-plus' ); |
| [3973](#L3973) | } |
| [3974](#L3974) | } |
| [3975](#L3975) | break; |
| [3976](#L3976) |  |
| [3977](#L3977) | case 'wppa\_regen\_thumbs\_skip\_one': |
| [3978](#L3978) | $last = wppa\_get\_option( 'wppa\_regen\_thumbs\_last', '0' ); |
| [3979](#L3979) | $skip = $last + '1'; |
| [3980](#L3980) | wppa\_update\_option( 'wppa\_regen\_thumbs\_last',  $skip ); |
| [3981](#L3981) | break; |
| [3982](#L3982) |  |
| [3983](#L3983) | case 'wppa\_remake\_skip\_one': |
| [3984](#L3984) | $last = wppa\_get\_option( 'wppa\_remake\_last', '0' ); |
| [3985](#L3985) | $skip = $last + '1'; |
| [3986](#L3986) | wppa\_update\_option( 'wppa\_remake\_last',  $skip ); |
| [3987](#L3987) | break; |
| [3988](#L3988) |  |
| [3989](#L3989) | case 'wppa\_create\_o1\_files\_skip\_one': |
| [3990](#L3990) | $last = wppa\_get\_option( 'wppa\_create\_o1\_files\_last', '0' ); |
| [3991](#L3991) | $skip = $last + '1'; |
| [3992](#L3992) | wppa\_update\_option( 'wppa\_create\_o1\_files\_last',  $skip ); |
| [3993](#L3993) | break; |
| [3994](#L3994) |  |
| [3995](#L3995) | case 'wppa\_optimize\_ewww\_skip\_one': |
| [3996](#L3996) | $last = wppa\_get\_option( 'wppa\_optimize\_ewww\_last', '0' ); |
| [3997](#L3997) | $skip = $last + '1'; |
| [3998](#L3998) | wppa\_update\_option( 'wppa\_optimize\_ewww\_last',  $skip ); |
| [3999](#L3999) | break; |
| [4000](#L4000) |  |
| [4001](#L4001) | case 'wppa\_errorlog\_purge': |
| [4002](#L4002) | if ( wppa\_is\_file( $wppa\_log\_file ) ) { |
| [4003](#L4003) | wppa\_unlink( $wppa\_log\_file ); |
| [4004](#L4004) | } |
| [4005](#L4005) | delete\_option( 'wppa\_recursive\_log' ); |
| [4006](#L4006) | delete\_option( 'wppa\_last\_error' ); |
| [4007](#L4007) | break; |
| [4008](#L4008) |  |
| [4009](#L4009) | case 'wppa\_debuglog\_purge': |
| [4010](#L4010) | $debug\_log = WP\_CONTENT\_DIR . '/debug.log'; |
| [4011](#L4011) | if ( wppa\_is\_writable( $debug\_log ) ) { |
| [4012](#L4012) | wppa\_unlink( $debug\_log ); |
| [4013](#L4013) | } |
| [4014](#L4014) |  |
| [4015](#L4015) | case 'wppa\_pl\_dirname': |
| [4016](#L4016) | $value = wppa\_sanitize\_file\_name( $value ); |
| [4017](#L4017) | $value = trim( $value, ' /' ); |
| [4018](#L4018) |  |
| [4019](#L4019) | // Remove old file if it exists |
| [4020](#L4020) | $oldfile = WPPA\_CONTENT\_PATH . '/' . wppa\_get\_option( 'wppa\_pl\_dirname' ) . '/.htaccess'; |
| [4021](#L4021) | if ( wppa\_is\_file( $oldfile ) ) { |
| [4022](#L4022) | wppa\_unlink( $oldfile ); |
| [4023](#L4023) | } |
| [4024](#L4024) |  |
| [4025](#L4025) | if ( $value ) { |
| [4026](#L4026) | wppa\_create\_pl\_htaccess( $value ); |
| [4027](#L4027) | } |
| [4028](#L4028) | break; |
| [4029](#L4029) |  |
| [4030](#L4030) | case 'wppa\_new\_tag\_value': |
| [4031](#L4031) | $value = wppa\_sanitize\_tags( $value, false, true ); |
| [4032](#L4032) | break; |
| [4033](#L4033) |  |
| [4034](#L4034) | case 'wppa\_up\_tagselbox\_content\_1': |
| [4035](#L4035) | case 'wppa\_up\_tagselbox\_content\_2': |
| [4036](#L4036) | case 'wppa\_up\_tagselbox\_content\_3': |
| [4037](#L4037) | case 'wppa\_up\_tagbox\_new': |
| [4038](#L4038) | $value = trim( wppa\_sanitize\_tags( $value ), ',' ); |
| [4039](#L4039) | break; |
| [4040](#L4040) |  |
| [4041](#L4041) | case 'wppa\_enable\_video': |
| [4042](#L4042) | // if off: set all statusses of videos to pending |
| [4043](#L4043) | break; |
| [4044](#L4044) |  |
| [4045](#L4045) | case 'wppa\_twitter\_account': |
| [4046](#L4046) | $value = sanitize\_text\_field( $value ); |
| [4047](#L4047) | $value = str\_replace( ' ', '', $value ); |
| [4048](#L4048) | if ( $value != '' && substr( $value, 0, 1 ) != '@' ) { |
| [4049](#L4049) | wppa( 'error', '4712' ); |
| [4050](#L4050) | $alert .= \_\_( 'A Twitter account name must start with an at sign: @', 'wp-photo-album-plus' ); |
| [4051](#L4051) | } |
| [4052](#L4052) | break; |
| [4053](#L4053) |  |
| [4054](#L4054) | case 'wppa\_rating\_display\_type': |
| [4055](#L4055) | if ( $value == 'likes' ) { |
| [4056](#L4056) | wppa\_update\_option( 'wppa\_rating\_multi', 'yes' ); |
| [4057](#L4057) | wppa\_update\_option( 'wppa\_rating\_dayly', '0' ); |
| [4058](#L4058) | wppa\_update\_option( 'wppa\_vote\_needs\_comment', 'no' ); |
| [4059](#L4059) | } |
| [4060](#L4060) | break; |
| [4061](#L4061) |  |
| [4062](#L4062) | case 'wppa\_search\_numbers\_void': |
| [4063](#L4063) | case 'wppa\_index\_ignore\_slash': |
| [4064](#L4064) | if ( $value == 'yes' ) { |
| [4065](#L4065) |  |
| [4066](#L4066) | // Cleanup index |
| [4067](#L4067) | wppa\_schedule\_maintenance\_proc( 'wppa\_cleanup\_index', true ); |
| [4068](#L4068) | } |
| [4069](#L4069) | else { |
| [4070](#L4070) |  |
| [4071](#L4071) | // Remake index |
| [4072](#L4072) | wppa\_schedule\_maintenance\_proc( 'wppa\_remake\_index\_albums', true ); |
| [4073](#L4073) | wppa\_schedule\_maintenance\_proc( 'wppa\_remake\_index\_photos', true ); |
| [4074](#L4074) | } |
| [4075](#L4075) | break; |
| [4076](#L4076) | case 'wppa\_search\_user\_void': |
| [4077](#L4077) | wppa\_schedule\_maintenance\_proc( 'wppa\_remake\_index\_albums', true ); |
| [4078](#L4078) | wppa\_schedule\_maintenance\_proc( 'wppa\_remake\_index\_photos', true ); |
| [4079](#L4079) | wppa\_schedule\_maintenance\_proc( 'wppa\_cleanup\_index', true ); |
| [4080](#L4080) | break; |
| [4081](#L4081) | case 'wppa\_image\_magick': |
| [4082](#L4082) | $value = rtrim( $value, '/' ); |
| [4083](#L4083) | if ( $value && $value != 'none' ) { |
| [4084](#L4084) | $out = array(); |
| [4085](#L4085) | exec( escapeshellcmd( $value . '/convert' ), $out, $err ); |
| [4086](#L4086) | $ok = ( count( $out ) != 0 ); |
| [4087](#L4087) | if ( ! $ok ) { |
| [4088](#L4088) | wppa( 'error', '4713' ); |
| [4089](#L4089) | $alert .= \_\_( 'This path does not contain ImageMagick commands', 'wp-photo-album-plus' ); |
| [4090](#L4090) | } |
| [4091](#L4091) | } |
| [4092](#L4092) | break; |
| [4093](#L4093) | case 'wppa\_grant\_cats': |
| [4094](#L4094) | case 'wppa\_grant\_tags': |
| [4095](#L4095) | $value = wppa\_sanitize\_tags( $value ); |
| [4096](#L4096) | break; |
| [4097](#L4097) | case 'wppa\_maint\_ignore\_cron': |
| [4098](#L4098) | if ( $value == 'no' ) { |
| [4099](#L4099) | wppa\_update\_option( 'wppa\_maint\_ignore\_cron', 'no' ); |
| [4100](#L4100) | wppa\_schedule\_maintenance\_proc( 'wppa\_remake\_index\_albums' ); |
| [4101](#L4101) | wppa\_schedule\_maintenance\_proc( 'wppa\_remake\_index\_photos' ); |
| [4102](#L4102) | wppa\_schedule\_treecount\_update(); |
| [4103](#L4103) | } |
| [4104](#L4104) | break; |
| [4105](#L4105) | case 'wppa\_minimum\_tags': |
| [4106](#L4106) | $value = trim( wppa\_sanitize\_tags( $value ), ',' ); |
| [4107](#L4107) | wppa\_clear\_taglist(); |
| [4108](#L4108) | break; |
| [4109](#L4109) | case 'wppa\_retry\_mails': |
| [4110](#L4110) | $all = array\_merge( wppa\_get\_option( 'wppa\_failed\_mails', array() ), wppa\_get\_option( 'wppa\_perm\_failed\_mails', array() ) ); |
| [4111](#L4111) | $value = max( $value, '1' ); |
| [4112](#L4112) | foreach( array\_keys( $all ) as $key ) { |
| [4113](#L4113) | $all[$key]['retry'] = $value; |
| [4114](#L4114) | } |
| [4115](#L4115) | wppa\_update\_option( 'wppa\_failed\_mails', $all ); |
| [4116](#L4116) | wppa\_update\_option( 'wppa\_perm\_failed\_mails', array() ); |
| [4117](#L4117) | break; |
| [4118](#L4118) | case 'wppa\_main\_photo\_reset': |
| [4119](#L4119) | wppa\_clear\_col( WPPA\_ALBUMS, 'main\_photo', '0' ); |
| [4120](#L4120) | $value = 'no'; |
| [4121](#L4121) | $alert = \_\_('All album cover images set to default', 'wp-photo-album-plus' ); |
| [4122](#L4122) | break; |
| [4123](#L4123) | case 'wppa\_nicescroll\_opts': |
| [4124](#L4124) | $value = wppa\_sanitize\_nso( $value ); |
| [4125](#L4125) | break; |
| [4126](#L4126) | case 'wppa\_admin\_extra\_css': |
| [4127](#L4127) | if ( $value != sanitize\_url( $value, is\_ssl() ? ['https'] : ['http'] ) ) { |
| [4128](#L4128) | $value = ''; |
| [4129](#L4129) | $alert = \_\_('Not a valid url', 'wp-photo-album-plus'); |
| [4130](#L4130) | } |
| [4131](#L4131) | break; |
| [4132](#L4132) |  |
| [4133](#L4133) | default: |
| [4134](#L4134) |  |
| [4135](#L4135) | wppa( 'error', '0' ); |
| [4136](#L4136) | $alert = ''; |
| [4137](#L4137) | } |
| [4138](#L4138) |  |
| [4139](#L4139) | if ( wppa( 'error' ) ) { |
| [4140](#L4140) | /\* Translators: option name, option value \*/ |
| [4141](#L4141) | if ( ! $title ) $title = sprintf( \_\_( 'Failed to set %1$s to %2$s', 'wp-photo-album-plus' ), $option, $value ); |
| [4142](#L4142) | if ( ! $alert ) $alert .= wppa( 'out' ); |
| [4143](#L4143) | } |
| [4144](#L4144) |  |
| [4145](#L4145) | // Do not re-init dynamic files on heartbeat: no wppa\_update\_option() call |
| [4146](#L4146) | elseif ( $option == 'wppa\_heartbeat' ) { |
| [4147](#L4147) | wppa\_update\_option( $option, $value ); |
| [4148](#L4148) | } |
| [4149](#L4149) | else { |
| [4150](#L4150) | wppa\_update\_option( $option, $value ); |
| [4151](#L4151) | /\* Translators: option name, option value \*/ |
| [4152](#L4152) | if ( ! $title ) $title = sprintf( \_\_( 'Setting %1$s updated to %2$s', 'wp-photo-album-plus' ), $option, $value ); |
| [4153](#L4153) | } |
| [4154](#L4154) |  |
| [4155](#L4155) | // Save possible error |
| [4156](#L4156) | $error = wppa( 'error' ); |
| [4157](#L4157) |  |
| [4158](#L4158) | // Something to do after changing the setting? |
| [4159](#L4159) | wppa\_initialize\_runtime( true );        // force reload new values |
| [4160](#L4160) |  |
| [4161](#L4161) | if ( $option == 'wppa\_cre\_uploads\_htaccess' ) { |
| [4162](#L4162) | wppa\_create\_wppa\_htaccess(); |
| [4163](#L4163) | } |
| [4164](#L4164) |  |
| [4165](#L4165) | // Thumbsize |
| [4166](#L4166) | $new\_minisize = wppa\_get\_minisize(); |
| [4167](#L4167) | if ( $old\_minisize != $new\_minisize ) { |
| [4168](#L4168) | wppa\_update\_option ( 'wppa\_regen\_thumbs\_status', 'Required' ); |
| [4169](#L4169) | $alert .= \_\_( 'You just changed a setting that requires the regeneration of thumbnails.' , 'wp-photo-album-plus' ); |
| [4170](#L4170) | $alert .= ' '.\_\_( 'Please run the appropriate maintenance procedure.' , 'wp-photo-album-plus' ); |
| [4171](#L4171) | } |
| [4172](#L4172) |  |
| [4173](#L4173) | // Compose the cron job status and togo fields |
| [4174](#L4174) | $crondata = ''; |
| [4175](#L4175) | global $wppa\_cron\_maintenance\_slugs; |
| [4176](#L4176) | foreach ( $wppa\_cron\_maintenance\_slugs as $slug ) { |
| [4177](#L4177) | $crondata .= $slug . '\_status:' . wppa\_get\_option( $slug . '\_status' ) . ';'; |
| [4178](#L4178) | $crondata .= $slug . '\_togo:' . wppa\_get\_option( $slug . '\_togo' ) . ';'; |
| [4179](#L4179) | } |
| [4180](#L4180) | $crondata = rtrim ( $crondata, ';' ); |
| [4181](#L4181) |  |
| [4182](#L4182) | // Produce the response text |
| [4183](#L4183) | $output = '||'.$error.'||'.esc\_attr( $title ).'||'.esc\_js( $alert ).'||'.$crondata; |
| [4184](#L4184) |  |
| [4185](#L4185) | wppa\_echo( $output ); |
| [4186](#L4186) | if ( $option != 'wppa\_heartbeat' && |
| [4187](#L4187) | $option != 'wppa\_errorlog\_purge' && |
| [4188](#L4188) | substr( $option, 0, 9 ) != 'wppa\_log\_' ) { |
| [4189](#L4189) | wppa\_clear\_cache( ['force' => true] ); |
| [4190](#L4190) | } |
| [4191](#L4191) | wppa\_exit(); |
| [4192](#L4192) | break;  // End update-option |
| [4193](#L4193) |  |
| [4194](#L4194) | case 'maintenance': |
| [4195](#L4195) |  |
| [4196](#L4196) | // Get args |
| [4197](#L4197) | $slug   = wppa\_get( 'slug' ); |
| [4198](#L4198) | $nonce  = wppa\_get( 'nonce' ); |
| [4199](#L4199) | $cron   = wppa\_get( 'cron' ); |
| [4200](#L4200) |  |
| [4201](#L4201) | // Security check |
| [4202](#L4202) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce' ) ) { |
| [4203](#L4203) | wppa\_log( 'Misc', 'nonce failed on ' . $wppa\_action ); |
| [4204](#L4204) | wppa\_echo( 'Security check failure||'.$slug.'||Error||0' ); |
| [4205](#L4205) | wppa\_exit(); |
| [4206](#L4206) | } |
| [4207](#L4207) |  |
| [4208](#L4208) | // If cron request, schedule |
| [4209](#L4209) | if ( $cron ) { |
| [4210](#L4210) | wppa\_schedule\_maintenance\_proc( $slug, true ); |
| [4211](#L4211) |  |
| [4212](#L4212) | // Remove in case this is a re-start of a crashed cron job |
| [4213](#L4213) | delete\_option( $slug . '\_lasttimestamp' ); |
| [4214](#L4214) | } |
| [4215](#L4215) |  |
| [4216](#L4216) | // Not a cron job, run realtime |
| [4217](#L4217) | else { |
| [4218](#L4218) | wppa\_echo( wppa\_do\_maintenance\_proc( $slug ) ); |
| [4219](#L4219) | } |
| [4220](#L4220) |  |
| [4221](#L4221) | wppa\_exit(); |
| [4222](#L4222) | break; |
| [4223](#L4223) |  |
| [4224](#L4224) | case 'maintenancepopup': |
| [4225](#L4225) | $slug   = wppa\_get( 'slug' ); |
| [4226](#L4226) | $nonce  = wppa\_get( 'nonce' ); |
| [4227](#L4227) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-nonce' ) ) { |
| [4228](#L4228) | wppa\_log( 'Misc', 'nonce failed on ' . $wppa\_action ); |
| [4229](#L4229) | wppa\_echo( 'Security check failure||'.$slug.'||Error||0' ); |
| [4230](#L4230) | wppa\_exit(); |
| [4231](#L4231) | } |
| [4232](#L4232) | wppa\_echo( wppa\_do\_maintenance\_popup( $slug ) ); |
| [4233](#L4233) | wppa\_exit(); |
| [4234](#L4234) | break; |
| [4235](#L4235) |  |
| [4236](#L4236) | case 'do-fe-upload': |
| [4237](#L4237) | require\_once 'wppa-non-admin.php'; |
| [4238](#L4238) | wppa\_user\_upload(); |
| [4239](#L4239) | global $wppa\_upload\_succes\_id; |
| [4240](#L4240) | if ( ( wppa\_get( 'fromtinymce' ) || wppa\_get( 'fromgutenberg' ) ) && $wppa\_upload\_succes\_id ) { |
| [4241](#L4241) | wppa\_echo( '||' . $wppa\_upload\_succes\_id . '||' ); |
| [4242](#L4242) | wppa\_echo( wppa\_get\_myphotos\_selection\_body\_for\_tinymce( $wppa\_upload\_succes\_id ) ); |
| [4243](#L4243) | } |
| [4244](#L4244) | else { |
| [4245](#L4245) |  |
| [4246](#L4246) | } |
| [4247](#L4247) | wppa\_exit(); |
| [4248](#L4248) | break; |
| [4249](#L4249) |  |
| [4250](#L4250) | case 'do-import-upload': |
| [4251](#L4251) |  |
| [4252](#L4252) | // Check User capability |
| [4253](#L4253) | if ( ! current\_user\_can( 'wppa\_import' ) ) { |
| [4254](#L4254) | wppa\_secfail( '91' ); |
| [4255](#L4255) | } |
| [4256](#L4256) |  |
| [4257](#L4257) | // Check nonce |
| [4258](#L4258) | $nonce = wppa\_get( 'import-upload-nonce', '', 'text' ); |
| [4259](#L4259) | if ( ! wp\_verify\_nonce( $nonce, 'wppa-import-upload-nonce' ) ) { |
| [4260](#L4260) | wppa\_echo( '0' . \_\_( 'Security check failure', 'wp-photo-album-plus' ) ); |
| [4261](#L4261) | } |
| [4262](#L4262) | else { |
| [4263](#L4263) | require\_once 'wppa-import.php'; |
| [4264](#L4264) | wppa\_do\_import\_upload(); |
| [4265](#L4265) | } |
| [4266](#L4266) | wppa\_exit(); |
| [4267](#L4267) | break; |
| [4268](#L4268) |  |
| [4269](#L4269) | case 'sanitizetags': |
| [4270](#L4270) | $tags           = wppa\_get( 'tags' ); |
| [4271](#L4271) | $album          = wppa\_get( 'album' ); |
| [4272](#L4272) | $deftags        = ( wppa\_is\_int( $album ) && $album > '0' ) ? wppa\_get\_album\_item( $album, 'default\_tags' ) : ''; |
| [4273](#L4273) | $tags           = $deftags ? $tags . ',' . $deftags : $tags; |
| [4274](#L4274) | echo wp\_json\_encode( ['txt' => wppa\_sanitize\_tags( $tags, false, true )] ); |
| [4275](#L4275) | wppa\_exit(); |
| [4276](#L4276) | break; |
| [4277](#L4277) |  |
| [4278](#L4278) | case 'destroyalbum': |
| [4279](#L4279) | $txt = ''; |
| [4280](#L4280) | $album = wppa\_get( 'album' ); |
| [4281](#L4281) | if ( ! $album ) { |
| [4282](#L4282) | $txt = \_\_( 'Missing album id', 'wp-photo-album-plus' ); |
| [4283](#L4283) | } |
| [4284](#L4284) | else { |
| [4285](#L4285) | $nonce = wppa\_get( 'nonce' ); |
| [4286](#L4286) | if ( ! $nonce || ! wp\_verify\_nonce( $nonce, 'wppa-nonce\_'.$album ) ) { |
| [4287](#L4287) | wppa\_log( 'Misc', 'nonce failed on ' . $wppa\_action ); |
| [4288](#L4288) | $txt = 'Security check failure #798'; |
| [4289](#L4289) | } |
| [4290](#L4290) |  |
| [4291](#L4291) | else { |
| [4292](#L4292) |  |
| [4293](#L4293) | // May I? |
| [4294](#L4294) | $may = true; |
| [4295](#L4295) | if ( ! wppa\_switch( 'user\_destroy\_on' ) ) $may = false; |
| [4296](#L4296) | if ( ! is\_user\_logged\_in() ) $may = false;                                      // Must login |
| [4297](#L4297) | if ( ! wppa\_have\_access( $album ) ) { |
| [4298](#L4298) | $may = false;                                           // No album access |
| [4299](#L4299) | } |
| [4300](#L4300) | if ( wppa\_is\_user\_blacklisted() ) $may = false; |
| [4301](#L4301) | if ( ! $may ) { |
| [4302](#L4302) | $txt = \_\_( 'You do not have the rights to delete this album', 'wp-photo-album-plus' ); |
| [4303](#L4303) | } |
| [4304](#L4304) | else { |
| [4305](#L4305) |  |
| [4306](#L4306) | // I may |
| [4307](#L4307) | require\_once 'wppa-album-admin-autosave.php'; |
| [4308](#L4308) | //      ob\_start(); |
| [4309](#L4309) | $txt = wppa\_del\_album( $album, '-9', true ); |
| [4310](#L4310) | //      ob\_end\_clean(); |
| [4311](#L4311) | } |
| [4312](#L4312) | } |
| [4313](#L4313) | } |
| [4314](#L4314) |  |
| [4315](#L4315) | echo wp\_json\_encode( ['txt' => $txt] ); |
| [4316](#L4316) | wppa\_exit(); |
| [4317](#L4317) | break; |
| [4318](#L4318) |  |
| [4319](#L4319) | case 'export-table': |
| [4320](#L4320) | if ( ! wppa\_user\_is\_admin() ) { |
| [4321](#L4321) | wppa\_echo( '||1||'.\_\_( 'Security check failure' , 'wp-photo-album-plus' ) ); |
| [4322](#L4322) | wppa\_exit(); |
| [4323](#L4323) | } |
| [4324](#L4324) | $table = wppa\_get( 'table' ); |
| [4325](#L4325) | $bret = wppa\_export\_table( $table ); |
| [4326](#L4326) | if ( $bret ) { |
| [4327](#L4327) | wppa\_echo( '||0||' . WPPA\_UPLOAD\_URL . '/temp/' . $table . '.csv' ); |
| [4328](#L4328) | } |
| [4329](#L4329) | else { |
| [4330](#L4330) | wppa\_echo( '||2||' . \_\_( 'An error has occurred', 'wp-photo-album-plus' ) ); |
| [4331](#L4331) | } |
| [4332](#L4332) | wppa\_exit(); |
| [4333](#L4333) | break; |
| [4334](#L4334) |  |
| [4335](#L4335) | case 'updatepotddata': |
| [4336](#L4336) |  |
| [4337](#L4337) | require\_once 'wppa-setting-functions.php'; |
| [4338](#L4338) | // Normalize offset and seqno by calling wppa\_get\_potd() |
| [4339](#L4339) | // Resuts are: ['id' => $id, 'potddata' => $photo\_data, 'seqno' => $seqno, 'offset' => $offset]; |
| [4340](#L4340) | $potd\_a         = wppa\_get\_potd( true ); |
| [4341](#L4341) | $seqno          = $potd\_a['seqno']; |
| [4342](#L4342) | $offset         = $potd\_a['offset']; |
| [4343](#L4343) | $photo          = $potd\_a['potddata']; |
| [4344](#L4344) | $preview        = wppa\_get\_potd\_preview\_html( $photo ); |
| [4345](#L4345) | $pool           = wppa\_get\_potd\_pool\_html(); |
| [4346](#L4346) |  |
| [4347](#L4347) | echo wp\_json\_encode( ['offset' => $offset, 'seqno' => $seqno, 'preview' => $preview, 'pool' => $pool] ); |
| [4348](#L4348) | break; |
| [4349](#L4349) |  |
| [4350](#L4350) | case 'updatewatermarkpreview': |
| [4351](#L4351) |  |
| [4352](#L4352) | $tr = floor( 127 \* ( 100 - wppa\_opt( 'watermark\_opacity\_text' ) ) / 100 ); |
| [4353](#L4353) | $args = array( 'id' => '0', 'url' => true, 'width' => '1000', 'height' => '400', 'transp' => $tr ); |
| [4354](#L4354) | $url = wppa\_create\_textual\_watermark\_file( $args ).'?ver='.wp\_rand(0, 4711); |
| [4355](#L4355) |  |
| [4356](#L4356) | wppa\_create\_all\_textual\_watermark\_files(); |
| [4357](#L4357) |  |
| [4358](#L4358) | echo wp\_json\_encode( ['url' => $url] ); |
| [4359](#L4359) | break; |
| [4360](#L4360) |  |
| [4361](#L4361) | default:        // Unimplemented $wppa-action |
| [4362](#L4362) | die( '-1' ); |
| [4363](#L4363) | } |
| [4364](#L4364) | wppa\_exit(); |
| [4365](#L4365) | } |
| [4366](#L4366) |  |
| [4367](#L4367) | function wppa\_decode( $string ) { |
| [4368](#L4368) |  |
| [4369](#L4369) | $result = str\_replace( ['%23', '%26', '%2B'], ['#', '&', '+'], $string ); |
| [4370](#L4370) | return $result; |
| [4371](#L4371) | } |
| [4372](#L4372) |  |
| [4373](#L4373) | function wppa\_ajax\_check\_range( $value, $fixed, $low, $high, $title ) { |
| [4374](#L4374) |  |
| [4375](#L4375) | if ( $fixed !== false && $fixed == $value ) return;                                             // User enetred special value correctly |
| [4376](#L4376) | if ( !is\_numeric( $value ) ) wppa( 'error', true );                                             // Must be numeric if not specaial value |
| [4377](#L4377) | if ( $low !== false && $value < $low ) wppa( 'error', true );                   // Must be >= given min value |
| [4378](#L4378) | if ( $high !== false && $value > $high ) wppa( 'error' , true );                // Must be <= given max value |
| [4379](#L4379) |  |
| [4380](#L4380) | if ( ! wppa( 'error' ) ) return;                // Still no error, ok |
| [4381](#L4381) |  |
| [4382](#L4382) | // Compose error message |
| [4383](#L4383) | if ( $low !== false && $high === false ) {      // Only Minimum given |
| [4384](#L4384) | wppa\_out( \_\_( 'Please supply a numeric value greater than or equal to' , 'wp-photo-album-plus' ) . ' ' . $low . ' ' . \_\_( 'for' , 'wp-photo-album-plus' ) . ' ' . $title ); |
| [4385](#L4385) | if ( $fixed !== false ) { |
| [4386](#L4386) | if ( $fixed ) wppa\_out( '. ' . \_\_( 'You may also enter:' , 'wp-photo-album-plus' ) . ' ' . $fixed ); |
| [4387](#L4387) | else wppa\_out( '. ' . \_\_( 'You may also leave/set this blank' , 'wp-photo-album-plus' ) ); |
| [4388](#L4388) | } |
| [4389](#L4389) | } |
| [4390](#L4390) | else {  // Also Maximum given |
| [4391](#L4391) | wppa\_out( \_\_( 'Please supply a numeric value greater than or equal to' , 'wp-photo-album-plus' ) . ' ' . $low . ' ' . \_\_( 'and less than or equal to' , 'wp-photo-album-plus' ) . ' ' . $high . ' ' . \_\_( 'for' , 'wp-photo-album-plus' ) . ' ' . $title ); |
| [4392](#L4392) | if ( $fixed !== false ) { |
| [4393](#L4393) | if ( $fixed ) wppa\_out( '. ' . \_\_( 'You may also enter:' , 'wp-photo-album-plus' ) . ' ' . $fixed ); |
| [4394](#L4394) | else wppa\_out( '. ' . \_\_( 'You may also leave/set this blank' , 'wp-photo-album-plus' ) ); |
| [4395](#L4395) | } |
| [4396](#L4396) | } |
| [4397](#L4397) | } |
| [4398](#L4398) |  |
| [4399](#L4399) | // Print security check failure message and exit |
| [4400](#L4400) | function wppa\_secfail( $id, $return = false ) { |
| [4401](#L4401) |  |
| [4402](#L4402) | /\* translators: errorcode \*/ |
| [4403](#L4403) | $text = sprintf( \_\_( 'Security check failure %d', 'wp-photo-album-plus' ), $id ); |
| [4404](#L4404) | wppa\_log( 'Misc', $text ); |
| [4405](#L4405) | if ( $return ) { |
| [4406](#L4406) | return $txt; |
| [4407](#L4407) | } |
| [4408](#L4408) | else { |
| [4409](#L4409) | wppa\_echo( $text ); |
| [4410](#L4410) | wppa\_exit(); |
| [4411](#L4411) | } |
| [4412](#L4412) | } |
| [4413](#L4413) |  |
| [4414](#L4414) | // Get the JSON formatted photo update data |
| [4415](#L4415) | function wppa\_json\_photo\_update( $id, $txt, $err = '0', $flags = array() ) { |
| [4416](#L4416) |  |
| [4417](#L4417) | $defaults = array( 'thumbmod'   => false, |
| [4418](#L4418) | 'photomod'   => false, |
| [4419](#L4419) | 'magickmod'  => false, |
| [4420](#L4420) | 'namemod'    => false, |
| [4421](#L4421) | 'descmod'    => false, |
| [4422](#L4422) | 'tagsmod'    => false, ); |
| [4423](#L4423) |  |
| [4424](#L4424) | $mods = $defaults; |
| [4425](#L4425) | foreach( array\_keys( $flags ) as $key ) { |
| [4426](#L4426) | $mods[$key] = true; |
| [4427](#L4427) | } |
| [4428](#L4428) |  |
| [4429](#L4429) | // Re-compute photo and thumbnail pixel sizes |
| [4430](#L4430) | $tx = wppa\_get\_thumbx( $id, true ); |
| [4431](#L4431) | $ty = wppa\_get\_thumby( $id, true ); |
| [4432](#L4432) | $px = wppa\_get\_photox( $id, true ); |
| [4433](#L4433) | $py = wppa\_get\_photoy( $id, true ); |
| [4434](#L4434) | wppa\_cache\_photo( 'invalidate', $id ); |
| [4435](#L4435) | $t = wppa\_cache\_photo( $id ); |
| [4436](#L4436) |  |
| [4437](#L4437) | // Just to be sure increment version numbers |
| [4438](#L4438) | if ( $mods['thumbmod'] || $mods['magickmod'] ) { |
| [4439](#L4439) | wppa\_bump\_thumb\_rev(); |
| [4440](#L4440) | } |
| [4441](#L4441) | if ( $mods['photomod'] || $mods['magickmod'] ) { |
| [4442](#L4442) | wppa\_bump\_photo\_rev(); |
| [4443](#L4443) | } |
| [4444](#L4444) |  |
| [4445](#L4445) | // Find and format filesizes |
| [4446](#L4446) | $tf = wppa\_fix\_poster\_ext( wppa\_get\_thumb\_path( $id ), $id ); |
| [4447](#L4447) | if ( wppa\_is\_file( $tf ) ) { |
| [4448](#L4448) | $tfs = wppa\_get\_filesize( $tf ); |
| [4449](#L4449) | } |
| [4450](#L4450) | else { |
| [4451](#L4451) | $tfs = \_\_( 'Unavailable', 'wp-photo-album-plus' ); |
| [4452](#L4452) | } |
| [4453](#L4453) |  |
| [4454](#L4454) | $pf = wppa\_fix\_poster\_ext( wppa\_get\_photo\_path( $id ), $id ); |
| [4455](#L4455) | if ( wppa\_is\_file( $pf ) ) { |
| [4456](#L4456) | $pfs = wppa\_get\_filesize( $pf ); |
| [4457](#L4457) | } |
| [4458](#L4458) | else { |
| [4459](#L4459) | $pfs = \_\_( 'Unavailable', 'wp-photo-album-plus' ); |
| [4460](#L4460) | } |
| [4461](#L4461) |  |
| [4462](#L4462) | // Update CDN |
| [4463](#L4463) | if ( $mods['thumbmod'] || $mods['photomod'] || $mods['magickmod'] ) { |
| [4464](#L4464) | $cdn = wppa\_cdn( 'admin' ); |
| [4465](#L4465) | if ( $cdn ) { |
| [4466](#L4466) | switch ( $cdn ) { |
| [4467](#L4467) | case 'cloudinary': |
| [4468](#L4468) | wppa\_upload\_to\_cloudinary( $id ); |
| [4469](#L4469) | break; |
| [4470](#L4470) | case 'local': |
| [4471](#L4471) | wppa\_cdn\_delete( $id ); |
| [4472](#L4472) | break; |
| [4473](#L4473) | default: |
| [4474](#L4474) | } |
| [4475](#L4475) | } |
| [4476](#L4476) | } |
| [4477](#L4477) |  |
| [4478](#L4478) | // Clear cache |
| [4479](#L4479) | wppa\_clear\_cache( ['photo' => $id] ); |
| [4480](#L4480) |  |
| [4481](#L4481) | // Build JSON data |
| [4482](#L4482) | $data = array(); |
| [4483](#L4483) | $data['remark'] = htmlentities( str\_replace( '"', "'", $txt ) ); |
| [4484](#L4484) | $data['modified'] = wppa\_local\_date( '', $t['modified'] ); |
| [4485](#L4485) |  |
| [4486](#L4486) | if ( $mods['thumbmod'] || $mods['magickmod'] ) { |
| [4487](#L4487) | $data['thumbx'] = $tx; |
| [4488](#L4488) | $data['thumby'] = $ty; |
| [4489](#L4489) | $data['thumbfilesize'] = $tfs; |
| [4490](#L4490) | $data['thumburl'] = wppa\_get\_thumb\_url( $id ); |
| [4491](#L4491) | } |
| [4492](#L4492) |  |
| [4493](#L4493) | if ( $mods['photomod'] || $mods['magickmod'] ) { |
| [4494](#L4494) | $data['photox'] = $px; |
| [4495](#L4495) | $data['photoy'] = $py; |
| [4496](#L4496) | $data['photofilesize'] = $pfs; |
| [4497](#L4497) | $data['photourl'] = wppa\_get\_photo\_url( $id ); |
| [4498](#L4498) | $data['magickstack'] = $t['magickstack']; |
| [4499](#L4499) | } |
| [4500](#L4500) |  |
| [4501](#L4501) | if ( $mods['thumbmod'] || $mods['photomod'] || $mods['magickmod'] ) { |
| [4502](#L4502) | $data['cdnfiles'] = \_\_( 'none', 'wp-photo-album-plus' ); |
| [4503](#L4503) | } |
| [4504](#L4504) |  |
| [4505](#L4505) | // The next items are for fe update photo new style |
| [4506](#L4506) | if ( $mods['namemod'] ) { |
| [4507](#L4507) | $t                                      = wppa\_get\_slide\_name\_a( $id ); |
| [4508](#L4508) | $data['name']           = $t['name']; |
| [4509](#L4509) | $data['sname']          = wppa\_name\_slug( $data['name'] ); |
| [4510](#L4510) | $data['fullname']       = $t['fullname']; |
| [4511](#L4511) | } |
| [4512](#L4512) |  |
| [4513](#L4513) | if ( $mods['descmod'] ) { |
| [4514](#L4514) | $data['desc'] = str\_replace( '\n', '', wppa\_get\_slide\_desc( $id ) ); |
| [4515](#L4515) | } |
| [4516](#L4516) |  |
| [4517](#L4517) | if ( $mods['tagsmod'] ) { |
| [4518](#L4518) | $data['tags'] = trim( wppa\_get\_photo\_item( $id, 'tags' ), ',' ); |
| [4519](#L4519) | } |
| [4520](#L4520) |  |
| [4521](#L4521) | if ( ! $err ) $err = '0'; |
| [4522](#L4522) | echo esc\_html( '||' . $err . '||' ) . wp\_json\_encode( $data ); |
| [4523](#L4523) | wppa\_exit(); |
| [4524](#L4524) | } |
| [4525](#L4525) |  |
| [4526](#L4526) | // Convert html with script tags to json format like {html:html-text,js:jstext-without-script-tags} |
| [4527](#L4527) | function wppa\_split\_html\_js( $text ) { |
| [4528](#L4528) |  |
| [4529](#L4529) | $text = preg\_replace( '/<script[^>]\*?>/i', '<script>', $text ); |
| [4530](#L4530) | $workarr = explode( '<script>', $text ); |
| [4531](#L4531) |  |
| [4532](#L4532) | // Any js present? |
| [4533](#L4533) | if ( count( $workarr ) == 1 ) { |
| [4534](#L4534) |  |
| [4535](#L4535) | // No |
| [4536](#L4536) | $html = $text; |
| [4537](#L4537) | $js = ''; |
| [4538](#L4538) | } |
| [4539](#L4539) |  |
| [4540](#L4540) | else { |
| [4541](#L4541) |  |
| [4542](#L4542) | // Yes |
| [4543](#L4543) | $html = ''; |
| [4544](#L4544) | $js = ''; |
| [4545](#L4545) | foreach( $workarr as $chunk ) { |
| [4546](#L4546) | $chunk\_parts = explode( '</script>', $chunk ); |
| [4547](#L4547) |  |
| [4548](#L4548) | // No </script> found? html only |
| [4549](#L4549) | if ( count( $chunk\_parts ) == 1 ) { |
| [4550](#L4550) | $html .= $chunk; |
| [4551](#L4551) | } |
| [4552](#L4552) |  |
| [4553](#L4553) | // Split html from js; ignore script tags |
| [4554](#L4554) | else { |
| [4555](#L4555) | $js\_part = rtrim( $chunk\_parts[0], ';' ) . ';'; |
| [4556](#L4556) | $js .= $js\_part; |
| [4557](#L4557) | $html\_part = $chunk\_parts[1]; |
| [4558](#L4558) | $html .= $html\_part; |
| [4559](#L4559) | } |
| [4560](#L4560) | } |
| [4561](#L4561) | } |
| [4562](#L4562) |  |
| [4563](#L4563) | $js = str\_replace( "\n", "", $js ); |
| [4564](#L4564) |  |
| [4565](#L4565) | return array( 'html' => $html, 'js' => $js ); |
| [4566](#L4566) | } |
| [4567](#L4567) |  |
| [4568](#L4568) | function wppa\_email\_quit\_message( $msg, $color = 'blue' ) { |
| [4569](#L4569) | $result = ' |
| [4570](#L4570) | <!DOCTYPE html> |
| [4571](#L4571) | <html xmlns="http://www.w3.org/1999/xhtml" > |
| [4572](#L4572) | <body> |
| [4573](#L4573) | <div style="width:100%;height:100%;text-align:center;margin-top:100px;"> |
| [4574](#L4574) | <h2 style="border:2px solid '.$color.';background-color:light'.$color.';padding:12px;width:fit-content;margin:auto;">' . |
| [4575](#L4575) | $msg . |
| [4576](#L4576) | '</h2> |
| [4577](#L4577) | </div> |
| [4578](#L4578) | </body> |
| [4579](#L4579) | </html>'; |
| [4580](#L4580) |  |
| [4581](#L4581) | wppa\_echo( $result ); |
| [4582](#L4582) | wppa\_exit(); |
| [4583](#L4583) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-photo-album-plus/tags/8.8.08.004/wppa-ajax.php?format=txt)
* [Original Format](/export/3222480/wp-photo-album-plus/tags/8.8.08.004/wppa-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_6a562c94_20250114_212702.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WP Photo Album Plus <= 8.8.08.007 - Unauthenticated Arbitrary Shortcode Execution via getshortcodedrenderedfenodelay

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WP Photo Album Plus <= 8.8.08.007 - Unauthenticated Arbitrary Shortcode Execution via getshortcodedrenderedfenodelay

7.3

**Improper Control of Generation of Code ('Code Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:L)

| CVE | [CVE-2024-10958](https://www.cve.org/CVERecord?id=CVE-2024-10958) |
| --- | --- |
| CVSS | 7.3 (High) |
| Publicly Published | November 10, 2024 |
| Last Updated | November 10, 2024 |
| Researcher | [Arkadiusz Hydzik](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/arkadiusz-hydzik) |

### Description

The The WP Photo Album Plus plugin for WordPress is vulnerable to arbitrary shortcode execution via getshortcodedrenderedfenodelay AJAX action in all versions up to, and including, 8.8.08.007 . This is due to the software allowing users to execute an action that does not properly validate a value before running do\_shortcode. This makes it possible for unauthenticated attackers to execute arbitrary shortcodes.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-photo-album-plus/tags/8.8.08.004/wppa-ajax.php#L1238)
* [wordpress.org](https://wordpress.org/plugins/wp-photo-album-plus/#developers)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3184852/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-photo-album-plus%2Fwp-photo-album-plus-8808007-unauthenticated-arbitrary-shortcode-execution-via-getshortcodedrenderedfenodelay&t=WP%20Photo%20Album%20Plus%20%3C%3D%208.8.08.007%20-%20Unauthenticated%20Arbitrary%20Shortcode%20Execution%20via%20getshortcodedrenderedfenodelay "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-photo-album-plus%2Fwp-photo-album-plus-8808007-unauthenticated-arbitrary-shortcode-execution-via-getshortcodedrenderedfenodelay&text=WP%20Photo%20Album%20Plus%20%3C%3D%208.8.08.007%20-%20Unauthenticated%20Arbitrary%20Shortcode%20Execution%20via%20getshortcodedrenderedfenodelay "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-photo-album-plus%2Fwp-photo-album-plus-8808007-unauthenticated-arbitrary-shortcode-execution-via-getshortcodedrenderedfenodelay "LinkedIn")
Email

## Vulnerability Details for WP Photo Album Plus

#### [WP Photo Album Plus](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-photo-album-plus)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-photo-album-plus [(view on wordpress.org)](https://wordpress.org/plugins/wp-photo-album-plus) |
| Patched? | Yes |
| Remediation | Update to version 8.9.01.001, or a newer patched version |
| Affected Version | * <= 8.8.08.007 |
| Patched Version | * 8.9.01.001 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


