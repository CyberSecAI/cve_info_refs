=== Content from plugins.trac.wordpress.org_d655dee4_20250114_231456.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fce21-suite%2Ftrunk%2Fsingle-sign-on-ce21.php%3Frev%3D3097700)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/ce21-suite/trunk/single-sign-on-ce21.php?rev=3093637 "Revision 3093637")
* [Latest Revision](/browser/ce21-suite/trunk/single-sign-on-ce21.php)
* [Next Revision](/browser/ce21-suite/trunk/single-sign-on-ce21.php?rev=3197928 "Revision 3197928") →
* [Blame](/browser/ce21-suite/trunk/single-sign-on-ce21.php?annotate=blame&rev=3097700 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/ce21-suite/trunk/single-sign-on-ce21.php?rev=3097700)

---

# [source:](/browser?rev=3097700&order=name "Go to repository root") [ce21-suite](/browser/ce21-suite?rev=3097700&order=name "View ce21-suite")/[trunk](/browser/ce21-suite/trunk?rev=3097700&order=name "View trunk")/[single-sign-on-ce21.php](/browser/ce21-suite/trunk/single-sign-on-ce21.php?rev=3097700&order=name "View single-sign-on-ce21.php") @ [3097700](/changeset/3097700/ "View changeset 3097700")

View diff against:

View revision:

| [Last change](/changeset/3097700/ce21-suite/trunk/single-sign-on-ce21.php "View differences") on this file since 3097700 was [3097700](/changeset/3097700/ "View changeset 3097700"), checked in by ce21com, [7 months ago](/timeline?from=2024-06-05T06%3A21%3A13Z&precision=second "See timeline at 06/05/2024 06:21:13 AM") |
| --- |
| sing in issues fixed |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 35.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* The plugin CE21 Suite |
| [5](#L5) | \* |
| [6](#L6) | \* This file is read by WordPress to generate the plugin information in the plugin |
| [7](#L7) | \* admin area. This file also includes all of the dependencies used by the plugin, |
| [8](#L8) | \* registers the activation and deactivation functions, and defines a function |
| [9](#L9) | \* that starts the plugin. |
| [10](#L10) | \* |
| [11](#L11) | \* @link              https://www.ce21.com |
| [12](#L12) | \* @package           Single\_Sign\_On\_Ce21 |
| [13](#L13) | \* |
| [14](#L14) | \* @wordpress-plugin |
| [15](#L15) | \* Plugin Name:       CE21 Suite |
| [16](#L16) | \* Plugin URI:        https://www.ce21.com |
| [17](#L17) | \* Description:       CE21 Suite. |
| [18](#L18) | \* Version:           2.2.0 |
| [19](#L19) | \* Author:            CE21 |
| [20](#L20) | \* Author URI:        https://www.ce21.com |
| [21](#L21) | \* License:           GPL-2.0+ |
| [22](#L22) | \* License URI:       http://www.gnu.org/licenses/gpl-2.0.txt |
| [23](#L23) | \* Text Domain:       single-sign-on-ce21 |
| [24](#L24) | \* Domain Path:       /languages |
| [25](#L25) | \*/ |
| [26](#L26) |  |
| [27](#L27) | // If this file is called directly, abort. |
| [28](#L28) | if ( ! defined( 'WPINC' ) ) { |
| [29](#L29) | die; |
| [30](#L30) | } |
| [31](#L31) |  |
| [32](#L32) | /\*\* |
| [33](#L33) | \* Currently plugin version. |
| [34](#L34) | \* Start at version 1.0.0 and use SemVer - https://semver.org |
| [35](#L35) | \* Rename this for your plugin and update it as you release new versions. |
| [36](#L36) | \*/ |
| [37](#L37) | define( 'SINGLE\_SIGN\_ON\_CE21\_VERSION', '2.1.1' ); |
| [38](#L38) |  |
| [39](#L39) | define( 'SINGLE\_SIGN\_ON\_CE21\_\_PLUGIN\_DIR', plugin\_dir\_path( \_\_FILE\_\_ ) ); |
| [40](#L40) | define( 'SINGLE\_SIGN\_ON\_CE21\_\_PLUGIN\_URL', plugin\_dir\_url( \_\_FILE\_\_ ) ); |
| [41](#L41) |  |
| [42](#L42) | /\*\* |
| [43](#L43) | \* The code that runs before plugin activation. |
| [44](#L44) | \* This function will check weather curl is enable or not |
| [45](#L45) | \*/ |
| [46](#L46) | if ( ! function\_exists( 'curl\_version' ) ) { |
| [47](#L47) | try { |
| [48](#L48) | $curlError = 'no PHP cURL library activated'; |
| [49](#L49) | throw new Exception($curlError); |
| [50](#L50) | } catch (Exception $e) { |
| [51](#L51) | $errorMsg = $e->getMessage(); |
| [52](#L52) | ce21\_error\_log\_api($errorMsg); |
| [53](#L53) | } |
| [54](#L54) |  |
| [55](#L55) | } |
| [56](#L56) | /\*\* |
| [57](#L57) | \* The core plugin class that is used to define internationalization, |
| [58](#L58) | \* admin-specific hooks, and public-facing site hooks. |
| [59](#L59) | \*/ |
| [60](#L60) | require plugin\_dir\_path( \_\_FILE\_\_ ) . 'includes/ce21-functions.php'; |
| [61](#L61) | require plugin\_dir\_path( \_\_FILE\_\_ ) . 'includes/single-sign-on-ce21-api-helper.php'; |
| [62](#L62) | include(plugin\_dir\_path( \_\_FILE\_\_ ) . 'programs/ce21-programs-functions.php'); |
| [63](#L63) | include(plugin\_dir\_path( \_\_FILE\_\_ ) . 'membership/ce21-membership-functions.php'); |
| [64](#L64) | /\*\* |
| [65](#L65) | \* The code that runs during plugin activation. |
| [66](#L66) | \* This action is documented in includes/class-single-sign-on-ce21-activator.php |
| [67](#L67) | \*/ |
| [68](#L68) | function ce21\_activate\_single\_sign\_on($network\_wide) { |
| [69](#L69) | require\_once plugin\_dir\_path( \_\_FILE\_\_ ) . 'includes/class-single-sign-on-ce21-activator.php'; |
| [70](#L70) | Single\_Sign\_On\_Ce21\_Activator::activate($network\_wide); |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | /\*\* |
| [74](#L74) | \* The code that runs during plugin deactivation. |
| [75](#L75) | \* This action is documented in includes/class-single-sign-on-ce21-deactivator.php |
| [76](#L76) | \*/ |
| [77](#L77) | function ce21\_deactivate\_single\_sign\_on() { |
| [78](#L78) | require\_once plugin\_dir\_path( \_\_FILE\_\_ ) . 'includes/class-single-sign-on-ce21-deactivator.php'; |
| [79](#L79) | Single\_Sign\_On\_Ce21\_Deactivator::deactivate(); |
| [80](#L80) | } |
| [81](#L81) |  |
| [82](#L82) | register\_activation\_hook( \_\_FILE\_\_, 'ce21\_activate\_single\_sign\_on' ); |
| [83](#L83) | register\_deactivation\_hook( \_\_FILE\_\_, 'ce21\_deactivate\_single\_sign\_on' ); |
| [84](#L84) |  |
| [85](#L85) | /\*\* |
| [86](#L86) | \* The core plugin class that is used to define internationalization, |
| [87](#L87) | \* admin-specific hooks, and public-facing site hooks. |
| [88](#L88) | \*/ |
| [89](#L89) | require plugin\_dir\_path( \_\_FILE\_\_ ) . 'includes/class-single-sign-on-ce21.php'; |
| [90](#L90) | require plugin\_dir\_path( \_\_FILE\_\_ ) . 'includes/session-helper.php'; |
| [91](#L91) |  |
| [92](#L92) | /\*\* |
| [93](#L93) | \* JWT library included |
| [94](#L94) | \*/ |
| [95](#L95) | require\_once('vendor/autoload.php'); |
| [96](#L96) | use \Firebase\JWT\JWT; |
| [97](#L97) | use \Firebase\JWT\Key; |
| [98](#L98) | session\_start(); |
| [99](#L99) | global $sesionHelper; |
| [100](#L100) | /\*\* |
| [101](#L101) | \* Begins execution of the plugin. |
| [102](#L102) | \* |
| [103](#L103) | \* Since everything within the plugin is registered via hooks, |
| [104](#L104) | \* then kicking off the plugin from this point in the file does |
| [105](#L105) | \* not affect the page life cycle. |
| [106](#L106) | \* |
| [107](#L107) | \* @since    1.0.0 |
| [108](#L108) | \*/ |
| [109](#L109) | function run\_single\_sign\_on\_ce21() { |
| [110](#L110) | $plugin = new Single\_Sign\_On\_Ce21(); |
| [111](#L111) | $plugin->run(); |
| [112](#L112) | } |
| [113](#L113) | run\_single\_sign\_on\_ce21(); |
| [114](#L114) |  |
| [115](#L115) | /\*\* |
| [116](#L116) | \* WP Error Handling function |
| [117](#L117) | \*/ |
| [118](#L118) | function ce21\_wp\_error\_handle(){ |
| [119](#L119) | global $wpdb; |
| [120](#L120) | if($wpdb->last\_error){ |
| [121](#L121) | throw new Exception($wpdb->last\_error); |
| [122](#L122) | } |
| [123](#L123) | } |
| [124](#L124) |  |
| [125](#L125) | /\* |
| [126](#L126) | \* General Function to use for Get API |
| [127](#L127) | \*/ |
| [128](#L128) | function getApiCall($baseUrl, $dataArray, $api\_Access\_token){ |
| [129](#L129) | try{ |
| [130](#L130) | if(!empty($dataArray)) { |
| [131](#L131) | $data = http\_build\_query($dataArray); |
| [132](#L132) | $baseUrl = $baseUrl."?".$data; |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) | $args = array( |
| [136](#L136) | 'headers' => array( |
| [137](#L137) | 'Authorization' => 'Bearer ' . $api\_Access\_token |
| [138](#L138) | ) |
| [139](#L139) | ); |
| [140](#L140) | $response = wp\_remote\_get($baseUrl, $args); |
| [141](#L141) | $err = is\_wp\_error($response); |
| [142](#L142) | $httpcode = wp\_remote\_retrieve\_response\_code($response); |
| [143](#L143) |  |
| [144](#L144) | if ( $httpcode != 200 ){ |
| [145](#L145) | $response\_message = array( |
| [146](#L146) | 'success' => false, |
| [147](#L147) | 'access\_token' => '', |
| [148](#L148) | 'message' => 'Something went wrong! Please check API settings' |
| [149](#L149) | ); |
| [150](#L150) | return $response\_message; |
| [151](#L151) | } |
| [152](#L152) | if ($err) |
| [153](#L153) | { |
| [154](#L154) | $response\_message = array( |
| [155](#L155) | 'success' => false, |
| [156](#L156) | 'access\_token' => '', |
| [157](#L157) | 'message' => 'Something went wrong while generating access token!' |
| [158](#L158) | ); |
| [159](#L159) | return $response\_message; |
| [160](#L160) | } |
| [161](#L161) | else |
| [162](#L162) | { |
| [163](#L163) | return $response\_obj = json\_decode($response['body']); |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | } |
| [167](#L167) | catch (Exception $e) |
| [168](#L168) | { |
| [169](#L169) | $errorMsg = ' Error on line '.$e->getLine().' in '.$e->getFile() . ' : <b>'.$e->getMessage().'</b>'; |
| [170](#L170) | ce21\_error\_log\_api($errorMsg); |
| [171](#L171) | $response\_message = array( |
| [172](#L172) | 'success' => false, |
| [173](#L173) | 'message' => $errorMsg |
| [174](#L174) | ); |
| [175](#L175) | return $response\_message; |
| [176](#L176) | } |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | /\*\* |
| [180](#L180) | \* Create End Point for the login api and membership group update api |
| [181](#L181) | \* The code that handle the user authentication from CE21. |
| [182](#L182) | \* Create a user if does not exist and login. |
| [183](#L183) | \*/ |
| [184](#L184) |  |
| [185](#L185) | add\_action( 'rest\_api\_init', 'ce21\_my\_authentication\_route' ); |
| [186](#L186) |  |
| [187](#L187) | function ce21\_my\_authentication\_route() { |
| [188](#L188) | register\_rest\_route( |
| [189](#L189) | 'ce21', 'authentication', |
| [190](#L190) | array( |
| [191](#L191) | 'methods' => 'GET', |
| [192](#L192) | 'callback' => 'ce21\_authentication\_phrase', |
| [193](#L193) | 'permission\_callback' => '\_\_return\_true', |
| [194](#L194) | ) |
| [195](#L195) | ); |
| [196](#L196) | /\* Update and delete CE21 members plans data \*/ |
| [197](#L197) | register\_rest\_route( |
| [198](#L198) | 'ce21', 'membership/update', |
| [199](#L199) | array( |
| [200](#L200) | 'methods' => 'POST', |
| [201](#L201) | 'callback' => 'ce21\_membership\_update', |
| [202](#L202) | 'permission\_callback' => '\_\_return\_true', |
| [203](#L203) | ) |
| [204](#L204) | ); |
| [205](#L205) | /\* LogOff CE21 member \*/ |
| [206](#L206) | register\_rest\_route( |
| [207](#L207) | 'ce21', 'logoff', |
| [208](#L208) | array( |
| [209](#L209) | 'methods' => 'GET', |
| [210](#L210) | 'callback' => 'ce21\_log\_off', |
| [211](#L211) | 'permission\_callback' => '\_\_return\_true', |
| [212](#L212) | ) |
| [213](#L213) | ); |
| [214](#L214) | } |
| [215](#L215) | /\* LogOff CE21 member \*/ |
| [216](#L216) | function ce21\_log\_off($data){ |
| [217](#L217) | $tid = get\_option('tenantId\_ce21'); |
| [218](#L218) | $returnUrl  = $data->get\_param('returnUrl'); |
| [219](#L219) | $sesionHelper = new session\_helper\_ce21($tid); |
| [220](#L220) | $sesionHelper->unset\_session(); |
| [221](#L221) |  |
| [222](#L222) | $url\_ce21 = filter\_var($returnUrl, FILTER\_SANITIZE\_URL); |
| [223](#L223) |  |
| [224](#L224) | if ( !empty($returnUrl) && ($returnUrl != NULL) && ($returnUrl != null) && filter\_var($url\_ce21, FILTER\_VALIDATE\_URL) !== false) { |
| [225](#L225) | header('Location: '.$returnUrl); |
| [226](#L226) | } else { |
| [227](#L227) | $authorizeURI\_ce21 = get\_option('authorizeURI\_ce21'); |
| [228](#L228) | header('Location: '.$authorizeURI\_ce21); |
| [229](#L229) | } |
| [230](#L230) | exit; |
| [231](#L231) | } |
| [232](#L232) |  |
| [233](#L233) | function ce21\_authentication\_phrase($data) { |
| [234](#L234) | $token\_ce21 = $data->get\_param('x'); |
| [235](#L235) |  |
| [236](#L236) | $log = 'Updated on ' . date("F j, Y, h:i:s a").PHP\_EOL; |
| [237](#L237) | $log .= ' TOKEN: '. $token\_ce21 .PHP\_EOL; |
| [238](#L238) |  |
| [239](#L239) | try { |
| [240](#L240) | $log .= ' try'.PHP\_EOL; |
| [241](#L241) |  |
| [242](#L242) | $key\_ce21   = "ixqv4z0ZOY0bmNCjBK7v3wgijyAv0D3jvyt6bk3lpEDUtVxdR72ZjuGW1hcR6TP"; |
| [243](#L243) | $user\_data = JWT::decode( $token\_ce21, new Key( $key\_ce21 , 'HS256')); |
| [244](#L244) | $tid                = $user\_data->tenantId; |
| [245](#L245) | $customerId = $user\_data->customerId; |
| [246](#L246) | $emailId    = $user\_data->email; |
| [247](#L247) | $firstName  = $user\_data->firstName; |
| [248](#L248) | $lastName   = $user\_data->lastName; |
| [249](#L249) | $type               = $user\_data->type; |
| [250](#L250) | $returnUrl  = $data->get\_param('returnUrl'); |
| [251](#L251) |  |
| [252](#L252) | $user\_id        = email\_exists($emailId); |
| [253](#L253) | $tenantId\_ce21 = get\_option('tenantId\_ce21'); |
| [254](#L254) |  |
| [255](#L255) | $log .= ' tid: '. $tid .PHP\_EOL; |
| [256](#L256) | $log .= ' customerId: '. $customerId . PHP\_EOL; |
| [257](#L257) | $log .= ' emailId: '. $emailId .PHP\_EOL; |
| [258](#L258) | $log .= ' tenantId\_ce21: '. $tenantId\_ce21 .PHP\_EOL; |
| [259](#L259) | $log .= ' email\_exists (wp-user-id): '. $user\_id .PHP\_EOL; |
| [260](#L260) | $log .= ' type: '. $type .PHP\_EOL; |
| [261](#L261) | $log .= ' returnUrl: '. $returnUrl .PHP\_EOL; |
| [262](#L262) | $log .= '--------------------------' .PHP\_EOL; |
| [263](#L263) |  |
| [264](#L264) | if($tenantId\_ce21 != $tid){ |
| [265](#L265) | $url\_ce21 = filter\_var($returnUrl, FILTER\_SANITIZE\_URL); |
| [266](#L266) |  |
| [267](#L267) | if (filter\_var($url\_ce21, FILTER\_VALIDATE\_URL) !== false) { |
| [268](#L268) | $returnUrlQuery = parse\_url($returnUrl, PHP\_URL\_QUERY); |
| [269](#L269) |  |
| [270](#L270) | if ($returnUrlQuery) { |
| [271](#L271) | $returnUrl .= '&msg=You are not authorized.'; |
| [272](#L272) | } else { |
| [273](#L273) | $returnUrl .= '?msg=You are not authorized.'; |
| [274](#L274) | } |
| [275](#L275) | header('Location: '.$returnUrl); |
| [276](#L276) |  |
| [277](#L277) | } else { |
| [278](#L278) | wp\_redirect(get\_option('siteurl')); |
| [279](#L279) | } |
| [280](#L280) | $log .= ' ======================' .PHP\_EOL; |
| [281](#L281) | file\_put\_contents('plugin-log.txt', $log, FILE\_APPEND); |
| [282](#L282) | exit; |
| [283](#L283) | } |
| [284](#L284) | /\* Check Admin or not  \*/ |
| [285](#L285) | if (!empty($type) && $type == 'CE21\_Staff'){ |
| [286](#L286) |  |
| [287](#L287) | $user\_id  =  email\_exists($emailId); |
| [288](#L288) | if( !empty($user\_id) && $user\_id != null && $user\_id != NULL ){ |
| [289](#L289) |  |
| [290](#L290) | $log .= 'USER EXISTS ' .PHP\_EOL; |
| [291](#L291) |  |
| [292](#L292) | /\* Already exiting users  \*/ |
| [293](#L293) | wp\_set\_current\_user( $user\_id, $emailId ); |
| [294](#L294) | wp\_set\_auth\_cookie( $user\_id ); |
| [295](#L295) | $user\_id\_role = new WP\_User($user\_id); |
| [296](#L296) | $user\_id\_role->set\_role('administrator'); |
| [297](#L297) | wp\_update\_user([ |
| [298](#L298) | 'ID' => $user\_id, // this is the ID of the user you want to update. |
| [299](#L299) | 'first\_name' => $firstName, |
| [300](#L300) | 'last\_name' => $lastName, |
| [301](#L301) | ]); |
| [302](#L302) | } else { |
| [303](#L303) | $log .= 'NEW USER ' .PHP\_EOL; |
| [304](#L304) |  |
| [305](#L305) | /\* Create a new user\*/ |
| [306](#L306) | $random\_password = wp\_generate\_password( $length=12, $include\_standard\_special\_chars=false ); |
| [307](#L307) | $new\_user\_id = wp\_create\_user( $emailId, $random\_password, $emailId ); |
| [308](#L308) | add\_user\_meta( $new\_user\_id, '\_CE21\_CustomerId', $customerId); |
| [309](#L309) | wp\_update\_user([ |
| [310](#L310) | 'ID' => $new\_user\_id, // this is the ID of the user you want to update. |
| [311](#L311) | 'first\_name' => $firstName, |
| [312](#L312) | 'last\_name' => $lastName, |
| [313](#L313) | ]); |
| [314](#L314) |  |
| [315](#L315) | $user\_id\_role = new WP\_User($new\_user\_id); |
| [316](#L316) | $user\_id\_role->set\_role('administrator'); |
| [317](#L317) |  |
| [318](#L318) | wp\_set\_current\_user( $new\_user\_id, $emailId ); |
| [319](#L319) | wp\_set\_auth\_cookie( $new\_user\_id ); |
| [320](#L320) | } |
| [321](#L321) |  |
| [322](#L322) | $url\_ce21 = filter\_var($returnUrl, FILTER\_SANITIZE\_URL); |
| [323](#L323) |  |
| [324](#L324) | $log .= 'url\_ce21: '.$url\_ce21 .PHP\_EOL; |
| [325](#L325) | $log .= 'siteurl: '.get\_option('siteurl') .PHP\_EOL; |
| [326](#L326) |  |
| [327](#L327) | if (filter\_var($url\_ce21, FILTER\_VALIDATE\_URL) !== false) { |
| [328](#L328) | $log .= 'HEADER LOCATION' .PHP\_EOL; |
| [329](#L329) | header('Location: '.$returnUrl); |
| [330](#L330) | } else { |
| [331](#L331) | $log .= 'WP REDIRECTION' .PHP\_EOL; |
| [332](#L332) | wp\_redirect(get\_option('siteurl')); |
| [333](#L333) | } |
| [334](#L334) |  |
| [335](#L335) | } |
| [336](#L336) |  |
| [337](#L337) | $sesionHelper = new session\_helper\_ce21($tid); |
| [338](#L338) | $sesionHelper->create\_session( $firstName, $lastName, $emailId, $tid, time() ); |
| [339](#L339) |  |
| [340](#L340) | $url\_ce21 = filter\_var($returnUrl, FILTER\_SANITIZE\_URL); |
| [341](#L341) | if (filter\_var($url\_ce21, FILTER\_VALIDATE\_URL) !== false) { |
| [342](#L342) | $log .= 'HEADER LOCATION (not staff)' .PHP\_EOL; |
| [343](#L343) | header('Location: '.$returnUrl); |
| [344](#L344) | } else { |
| [345](#L345) | $log .= 'WP REDIRECTION (not staff)' .PHP\_EOL; |
| [346](#L346) | wp\_redirect(get\_option('siteurl')); |
| [347](#L347) | } |
| [348](#L348) | $log .= ' ======================' .PHP\_EOL; |
| [349](#L349) | file\_put\_contents('plugin-log.txt', $log, FILE\_APPEND); |
| [350](#L350) | exit; |
| [351](#L351) |  |
| [352](#L352) | } catch (\Exception $e) { |
| [353](#L353) |  |
| [354](#L354) | $log .= 'catch: '.PHP\_EOL; |
| [355](#L355) | $log .= 'Exception: '. $e .PHP\_EOL; |
| [356](#L356) |  |
| [357](#L357) | $returnUrl  = $data->get\_param('returnUrl'); |
| [358](#L358) | $url\_ce21 = filter\_var($returnUrl, FILTER\_SANITIZE\_URL); |
| [359](#L359) |  |
| [360](#L360) | if (filter\_var($url\_ce21, FILTER\_VALIDATE\_URL) !== false) { |
| [361](#L361) | $returnUrlQuery = parse\_url($returnUrl, PHP\_URL\_QUERY); |
| [362](#L362) | if ($returnUrlQuery) { |
| [363](#L363) | $returnUrl .= '&msg=Sorry,Something went wrong, Please try again.'; |
| [364](#L364) | } else { |
| [365](#L365) | $returnUrl .= '?msg=Sorry,Something went wrong, Please try again.'; |
| [366](#L366) | } |
| [367](#L367) | $log .= 'HEADER LOCATION' .PHP\_EOL; |
| [368](#L368) |  |
| [369](#L369) | header('Location: '.$returnUrl); |
| [370](#L370) | } else { |
| [371](#L371) | $log .= 'WP REDIRECTION' .PHP\_EOL; |
| [372](#L372) | wp\_redirect(get\_option('siteurl')); |
| [373](#L373) | } |
| [374](#L374) | $log .= ' ======================' .PHP\_EOL; |
| [375](#L375) | file\_put\_contents('plugin-log.txt', $log, FILE\_APPEND); |
| [376](#L376) | exit; |
| [377](#L377) | } |
| [378](#L378) | $log .= ' ======================' .PHP\_EOL; |
| [379](#L379) | file\_put\_contents('plugin-log.txt', $log, FILE\_APPEND); |
| [380](#L380) |  |
| [381](#L381) | exit; |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) | /\*\* |
| [385](#L385) | \* Update and delete CE21 member plans |
| [386](#L386) | \*/ |
| [387](#L387) |  |
| [388](#L388) | function ce21\_membership\_update($data){ |
| [389](#L389) |  |
| [390](#L390) | $parameters\_ce21 = $data->get\_params(); |
| [391](#L391) |  |
| [392](#L392) | if (!empty($parameters\_ce21) ) { |
| [393](#L393) |  |
| [394](#L394) | global $wpdb; |
| [395](#L395) | $membershipId    = $parameters\_ce21['membershipTypeId']; |
| [396](#L396) | $membershipName  = $parameters\_ce21['name']; |
| [397](#L397) | $tenantId                = $parameters\_ce21['tenantId']; |
| [398](#L398) | $isDelete                = $parameters\_ce21['isDelete']; |
| [399](#L399) | $table\_name\_ce21 = $wpdb->prefix . 'membership\_types\_ce21'; |
| [400](#L400) | $response\_data   = []; |
| [401](#L401) |  |
| [402](#L402) | $get\_data\_ce21   = $wpdb->get\_results($wpdb->prepare("SELECT id,TenantId,membershipTypeId,membershipName FROM ".$table\_name\_ce21." WHERE TenantId = %d AND membershipTypeId = %d", $tenantId, $membershipId)); |
| [403](#L403) |  |
| [404](#L404) | /\*If plan already exists \*/ |
| [405](#L405) | if(! empty($get\_data\_ce21)) { |
| [406](#L406) |  |
| [407](#L407) | if($isDelete == true) { |
| [408](#L408) | /\* If isDelete is equal to true then detele single record \*/ |
| [409](#L409) | $query\_delete = $wpdb->query($wpdb->prepare("DELETE FROM $table\_name\_ce21 WHERE membershipTypeId = %d AND TenantId = %d", $membershipId, $tenantId)); |
| [410](#L410) |  |
| [411](#L411) | if($query\_delete) { |
| [412](#L412) | $response\_data = [ 'success' => true, 'message' => 'Group has been successfully deleted.' ]; |
| [413](#L413) | }else{ |
| [414](#L414) | $response\_data = [ 'success' => false, 'message' => 'Something went wrong.' ]; |
| [415](#L415) | } |
| [416](#L416) | }else { |
| [417](#L417) | /\*if status isDelete is equal to false then update record \*/ |
| [418](#L418) | $query\_update = $wpdb->update( |
| [419](#L419) | $table\_name\_ce21, |
| [420](#L420) | array('TenantId' => $tenantId, 'membershipTypeId' => $membershipId, 'membershipName' => $membershipName), |
| [421](#L421) | array('membershipTypeId' => $membershipId, 'TenantId' => $tenantId), |
| [422](#L422) | array('%d','%d','%s'), |
| [423](#L423) | array('%d', '%d') |
| [424](#L424) | ); |
| [425](#L425) |  |
| [426](#L426) | if($query\_update){ |
| [427](#L427) | $response\_data = [ 'success' => true, 'message' => 'Group has been successfully updated.' ]; |
| [428](#L428) | }else{ |
| [429](#L429) | $response\_data = [ 'success' => false, 'message' => 'Something went wrong.' ]; |
| [430](#L430) | } |
| [431](#L431) | } |
| [432](#L432) | } else { |
| [433](#L433) | /\* If isDelete is equal to false and not found any exting data then insert record\*/ |
| [434](#L434) | if($isDelete == false) { |
| [435](#L435) |  |
| [436](#L436) | $insertdata = $wpdb->insert($table\_name\_ce21, array( |
| [437](#L437) | 'TenantId' => $tenantId, |
| [438](#L438) | 'membershipTypeId' => $membershipId, |
| [439](#L439) | 'membershipName' => $membershipName |
| [440](#L440) | )); |
| [441](#L441) |  |
| [442](#L442) | if ($insertdata) { |
| [443](#L443) | $response\_data = [ 'success' => true, 'message' => 'Group has been successfully added.' ]; |
| [444](#L444) | }else{ |
| [445](#L445) | $response\_data = [ 'success' => false, 'message' => 'Something went wrong.' ]; |
| [446](#L446) | } |
| [447](#L447) | } |
| [448](#L448) | } |
| [449](#L449) | echo json\_encode( $response\_data ); |
| [450](#L450) | exit; |
| [451](#L451) | } |
| [452](#L452) | } |
| [453](#L453) |  |
| [454](#L454) | /\*\* |
| [455](#L455) | \* Added Custom meta box for the default post type |
| [456](#L456) | \* Custom meta box name is Post Membership Plans |
| [457](#L457) | \* List of CE21 Members plans list under add post and edit post |
| [458](#L458) | \*/ |
| [459](#L459) | add\_action('add\_meta\_boxes', 'ce21\_post\_groups\_add\_custom\_metabox',2); |
| [460](#L460) |  |
| [461](#L461) | function ce21\_post\_groups\_add\_custom\_metabox() |
| [462](#L462) | { |
| [463](#L463) | $screens = ['post','page']; |
| [464](#L464) | foreach ($screens as $screen) { |
| [465](#L465) | add\_meta\_box( |
| [466](#L466) | 'post\_authentication\_option\_id\_ce21',   // Unique ID |
| [467](#L467) | 'Groups',  // Box title |
| [468](#L468) | 'ce21\_post\_groups\_metabox\_listing',  // Content callback, must be of type callable |
| [469](#L469) | $screen,                  // Post type |
| [470](#L470) | 'side', |
| [471](#L471) | 'high', |
| [472](#L472) | null |
| [473](#L473) | ); |
| [474](#L474) | } |
| [475](#L475) | } |
| [476](#L476) |  |
| [477](#L477) | function ce21\_post\_groups\_metabox\_listing($post) |
| [478](#L478) | { |
| [479](#L479) | try { |
| [480](#L480) | global $wpdb; |
| [481](#L481) | $table\_name\_ce21                = $wpdb->prefix . 'membership\_types\_ce21'; |
| [482](#L482) | $Memberships\_Data\_ce21  = $wpdb->get\_results("SELECT \* FROM ".$table\_name\_ce21." ORDER BY id ASC"); |
| [483](#L483) | $details                                = get\_post\_meta( $post->ID, '\_post\_authentication\_custom\_metabox\_ce21', true ); |
| [484](#L484) |  |
| [485](#L485) | if(! empty($Memberships\_Data\_ce21)) { |
| [486](#L486) | ?> |
| [487](#L487) | <label><input type="checkbox" id="ckbCheckAll" /> Select All </label><br> |
| [488](#L488) | <?php |
| [489](#L489) | foreach ($Memberships\_Data\_ce21 as $key => $value) { |
| [490](#L490) | ?> |
| [491](#L491) | <label> <input type="checkbox" class="radio customBulkCheckAll" value="<?php echo esc\_attr($value->membershipTypeId); ?>" name="\_post\_authentication\_custom\_metabox\_ce21[]"  <?php if ( ! empty($details) && in\_array($value->membershipTypeId, $details)){ echo "checked"; }  ?> /> <?php echo esc\_html($value->membershipName); ?></label> </br> |
| [492](#L492) | <?php |
| [493](#L493) | } |
| [494](#L494) | } else { |
| [495](#L495) | echo "Groups are not available."; |
| [496](#L496) | } |
| [497](#L497) | ce21\_wp\_error\_handle(); |
| [498](#L498) | } catch (Exception $e) { |
| [499](#L499) | $errorMsg = ' Error on line '.$e->getLine().' in '.$e->getFile() . ' : <b>'.$e->getMessage().'</b>'; |
| [500](#L500) | ce21\_error\_log\_api($errorMsg); |
| [501](#L501) | } |
| [502](#L502) |  |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | /\*\* |
| [506](#L506) | \* Save article's membership plan, Post Detail page save groups |
| [507](#L507) | \*/ |
| [508](#L508) | add\_action('save\_post', 'ce21\_post\_authentication\_save\_post\_data'); |
| [509](#L509) |  |
| [510](#L510) | function ce21\_post\_authentication\_save\_post\_data($post\_id) |
| [511](#L511) | { |
| [512](#L512) | try { |
| [513](#L513) | //&& $\_POST['post\_type'] == "post" |
| [514](#L514) | if (isset( $\_POST['post\_type']) ) { |
| [515](#L515) | $values\_to\_save = array(); |
| [516](#L516) | if(isset($\_POST["\_post\_authentication\_custom\_metabox\_ce21"]) && !empty($\_POST["\_post\_authentication\_custom\_metabox\_ce21"] )){ |
| [517](#L517) | $new\_values     = $\_POST["\_post\_authentication\_custom\_metabox\_ce21"]; |
| [518](#L518) |  |
| [519](#L519) | if (!empty($new\_values)) { |
| [520](#L520) | foreach($new\_values as $new\_value ) { |
| [521](#L521) | $values\_to\_save[] = $new\_value ; |
| [522](#L522) | } |
| [523](#L523) | } |
| [524](#L524) | update\_post\_meta( $post\_id, '\_post\_authentication\_custom\_metabox\_ce21',$values\_to\_save ); |
| [525](#L525) | } |
| [526](#L526) | } |
| [527](#L527) | } catch (Exception $e){ |
| [528](#L528) | $errorMsg = ' Error on line '.$e->getLine().' in '.$e->getFile() . ' : <b>'.$e->getMessage().'</b>'; |
| [529](#L529) | ce21\_error\_log\_api($errorMsg); |
| [530](#L530) | } |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | /\*\* |
| [534](#L534) | \* Post list view page display Membership columns |
| [535](#L535) | \*/ |
| [536](#L536) | add\_filter( 'manage\_posts\_columns', 'ce21\_set\_custom\_membership\_columns' ); |
| [537](#L537) | add\_filter( 'manage\_pages\_columns', 'ce21\_set\_custom\_membership\_columns' ); |
| [538](#L538) | function ce21\_set\_custom\_membership\_columns($columns) { |
| [539](#L539) |  |
| [540](#L540) | $new\_columns = array(); |
| [541](#L541) |  |
| [542](#L542) | foreach($columns as $key=>$value) { |
| [543](#L543) |  |
| [544](#L544) | if($key=='date') { |
| [545](#L545) | $new\_columns['membership\_plan\_ce21'] = \_\_( 'Groups', 'ce21' ); |
| [546](#L546) | } |
| [547](#L547) | $new\_columns[$key]=$value; |
| [548](#L548) | } |
| [549](#L549) | return $new\_columns; |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | /\*\* |
| [553](#L553) | \* Admin post list view page display selected member plans data |
| [554](#L554) | \* Default post listing page |
| [555](#L555) | \* |
| [556](#L556) | \*/ |
| [557](#L557) | add\_action( 'manage\_posts\_custom\_column' , 'ce21\_custom\_membership\_column', 10, 2 ); |
| [558](#L558) | add\_action( 'manage\_pages\_custom\_column' , 'ce21\_custom\_membership\_column', 10, 2 ); |
| [559](#L559) |  |
| [560](#L560) | function ce21\_custom\_membership\_column( $column, $post\_id ) { |
| [561](#L561) |  |
| [562](#L562) | global $post; |
| [563](#L563) | global $wpdb; |
| [564](#L564) | try { |
| [565](#L565) | switch ( $column ) { |
| [566](#L566) | case 'membership\_plan\_ce21': |
| [567](#L567) |  |
| [568](#L568) | $details\_ce21 = get\_post\_meta( $post->ID, '\_post\_authentication\_custom\_metabox\_ce21', true ); |
| [569](#L569) |  |
| [570](#L570) | if (!empty($details\_ce21)) { |
| [571](#L571) | $table\_name\_ce21             = $wpdb->prefix . 'membership\_types\_ce21'; |
| [572](#L572) | $membership\_type\_id\_ce21 = implode(',', $details\_ce21); |
| [573](#L573) | $serchdata\_ce21   = $wpdb->get\_results("SELECT \* FROM $table\_name\_ce21 WHERE membershipTypeId IN ($membership\_type\_id\_ce21)"); |
| [574](#L574) | ce21\_wp\_error\_handle(); |
| [575](#L575) | if ( $serchdata\_ce21 ) { |
| [576](#L576) | $membership\_name\_ce21 = array(); |
| [577](#L577) |  |
| [578](#L578) | foreach ($serchdata\_ce21 as $key => $value) { |
| [579](#L579) | $membership\_name\_ce21[] = $value->membershipName; |
| [580](#L580) | } |
| [581](#L581) | echo esc\_html(implode(', ', $membership\_name\_ce21)); |
| [582](#L582) |  |
| [583](#L583) | } else { |
| [584](#L584) | echo '—'; |
| [585](#L585) | } |
| [586](#L586) | } else { |
| [587](#L587) | echo '—'; |
| [588](#L588) | } |
| [589](#L589) | break; |
| [590](#L590) | } |
| [591](#L591) | } catch (Exception $e) { |
| [592](#L592) | $errorMsg = ' Error on line '.$e->getLine().' in '.$e->getFile() . ' : <b>'.$e->getMessage().'</b>'; |
| [593](#L593) | ce21\_error\_log\_api($errorMsg); |
| [594](#L594) | } |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | /\*\* |
| [598](#L598) | \* Restricted the article details page |
| [599](#L599) | \* This code for single post view page display only staff(Administrator) user only |
| [600](#L600) | \* If User not login then redirect to Authorize URI page |
| [601](#L601) | \* If user login type staff(Administrator) then display post content |
| [602](#L602) | \* If user type CE21\_Customer then check custom are Allowed or not allowed post display |
| [603](#L603) | \* |
| [604](#L604) | \*/ |
| [605](#L605) | function sso\_ce21\_is\_blog () { |
| [606](#L606) | return ( is\_home() || is\_archive() || is\_author() || is\_category() || is\_tag()) && 'post' == get\_post\_type(); |
| [607](#L607) | } |
| [608](#L608) | add\_action( 'wp', 'ce21\_single\_post\_view\_function' ); |
| [609](#L609) | // add\_filter( 'body\_class', 'custom\_class' ); |
| [610](#L610) | // function custom\_class( $classes ) |
| [611](#L611) | // global $wp\_query; |
| [612](#L612) | // $pageid = $wp\_query->post->ID; |
| [613](#L613) | // //if ( is\_page\_template( 'page-example.php' ) ) { |
| [614](#L614) | // $classes[] = $pageid; |
| [615](#L615) | // //} |
| [616](#L616) | // return $classes; |
| [617](#L617) | // } |
| [618](#L618) | /\* |
| [619](#L619) | \*New Post view function session wise |
| [620](#L620) | \*/ |
| [621](#L621) | function ce21\_single\_post\_view\_function(){ |
| [622](#L622) | if(!is\_search()) { |
| [623](#L623) | try{ |
| [624](#L624) | global $wp, $wpdb; |
| [625](#L625) | $post\_type\_ce21 = get\_post\_type(); |
| [626](#L626) | $post\_page\_id = get\_the\_ID(); |
| [627](#L627) |  |
| [628](#L628) |  |
| [629](#L629) | if(!empty($post\_page\_id) && !sso\_ce21\_is\_blog()) { |
| [630](#L630) | //echo '<script>console.log('.$post\_page\_id.')</script>'; |
| [631](#L631) | $tenantId\_ce21 = get\_option('tenantId\_ce21'); |
| [632](#L632) | $sesionHelper = new session\_helper\_ce21($tenantId\_ce21); |
| [633](#L633) | /\*Header Menu Bar Starts\*/ |
| [634](#L634) | $authorizeURI\_ce21 = get\_option( 'authorizeURI\_ce21' ); |
| [635](#L635) | $profile\_url = $authorizeURI\_ce21.'/Account/MyAccount'; |
| [636](#L636) | $name = 'Howdy, '.$sesionHelper->first\_name.' '.$sesionHelper->last\_name; |
| [637](#L637) | if ( !is\_user\_logged\_in() && isset($sesionHelper->email) ) { |
| [638](#L638) | ob\_start(); |
| [639](#L639) | ?> |
| [640](#L640) | <style> |
| [641](#L641) | #ce21\_header\_menu\_bar { |
| [642](#L642) | direction: ltr; |
| [643](#L643) | color: #ccc; |
| [644](#L644) | font-size: 13px; |
| [645](#L645) | font-weight: 400; |
| [646](#L646) | font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif; |
| [647](#L647) | line-height: 32px; |
| [648](#L648) | height: 32px; |
| [649](#L649) | position: fixed; |
| [650](#L650) | top: 0; |
| [651](#L651) | left: 0; |
| [652](#L652) | width: 100%; |
| [653](#L653) | z-index: 999999; |
| [654](#L654) | background: #23282d; |
| [655](#L655) | /\* margin-top: 32px !important; \*/ |
| [656](#L656) | } |
| [657](#L657) | #ce21\_header\_menu\_bar ul.right-list { |
| [658](#L658) | text-align: left; |
| [659](#L659) | float: right; |
| [660](#L660) | margin: 0; |
| [661](#L661) | padding: 0; |
| [662](#L662) | line-height: 32px; |
| [663](#L663) | } |
| [664](#L664) | #ce21\_header\_menu\_bar ul.right-list li { |
| [665](#L665) | background: 0 0; |
| [666](#L666) | clear: none; |
| [667](#L667) | list-style: none; |
| [668](#L668) | margin: 0; |
| [669](#L669) | padding: 0; |
| [670](#L670) | position: relative; |
| [671](#L671) | text-indent: 0; |
| [672](#L672) | z-index: 99999; |
| [673](#L673) | } |
| [674](#L674) | #ce21\_header\_menu\_bar ul.right-list li a { |
| [675](#L675) | padding: 0 15px 0 7px; |
| [676](#L676) | color: #eee; |
| [677](#L677) | text-decoration: none; |
| [678](#L678) | } |
| [679](#L679) | </style> |
| [680](#L680) | <?php |
| [681](#L681) | echo '<div id="ce21\_header\_menu\_bar"><ul class="right-list"><li><a href="' . esc\_url( $profile\_url ). '" target="\_blank">' . $name . '</a></li></ul></div>'; |
| [682](#L682) | //echo esc\_html('<style>html{margin-top:32px !important;}</style>'); |
| [683](#L683) | } |
| [684](#L684) | /\*Header Menu Bar End\*/ |
| [685](#L685) | //if ($post\_type\_ce21 == 'post' && is\_singular('post')) { |
| [686](#L686) |  |
| [687](#L687) | $authentication\_plan\_value = get\_post\_meta(get\_the\_ID(), '\_post\_authentication\_custom\_metabox\_ce21', true); |
| [688](#L688) | $table\_name\_ce21 = $wpdb->prefix . 'membership\_types\_ce21'; |
| [689](#L689) | $membership\_plan\_ce21 = 0; |
| [690](#L690) |  |
| [691](#L691) | if (!empty($authentication\_plan\_value)) { |
| [692](#L692) | $membership\_plan\_ce21 = implode(',', $authentication\_plan\_value); |
| [693](#L693) | } |
| [694](#L694) |  |
| [695](#L695) | $result\_ce21 = $wpdb->get\_results("SELECT membershipTypeId FROM $table\_name\_ce21 WHERE membershipTypeId IN ($membership\_plan\_ce21)"); |
| [696](#L696) |  |
| [697](#L697) | ce21\_wp\_error\_handle(); |
| [698](#L698) |  |
| [699](#L699) | if (!empty($authentication\_plan\_value) && !empty($result\_ce21)) { |
| [700](#L700) |  |
| [701](#L701) | if (!is\_user\_logged\_in()) { |
| [702](#L702) | if( isset( $sesionHelper->email ) ){ |
| [703](#L703) | $authorizeURI\_ce21 = get\_option('authorizeURI\_ce21'); |
| [704](#L704) | $current\_user\_email\_ce21 = $sesionHelper->email; //$user\_meta->user\_email; |
| [705](#L705) | $membership\_TypeId\_ce21 = implode(",", $authentication\_plan\_value); |
| [706](#L706) | $get\_Memberships\_APi\_URL\_ce21 = $authorizeURI\_ce21 . '/WPAuthorize/GroupAccess?email=' . urlencode($current\_user\_email\_ce21) . '&membershipTypeId=' . $membership\_TypeId\_ce21; |
| [707](#L707) |  |
| [708](#L708) | $result = wp\_remote\_get($get\_Memberships\_APi\_URL\_ce21); |
| [709](#L709) | $err = is\_wp\_error($result); |
| [710](#L710) | if ($err) { |
| [711](#L711) | throw new Exception($result['body'], 1); |
| [712](#L712) | } |
| [713](#L713) |  |
| [714](#L714) | $Memberships\_access\_ce21 = json\_decode($result['body'], true); |
| [715](#L715) |  |
| [716](#L716) | // empty is equal to false then redirect to custome error page |
| [717](#L717) | if (empty($Memberships\_access\_ce21['success']) || empty($Memberships\_access\_ce21['data']['groupAccessible'])) { |
| [718](#L718) | $postId\_ce21 = get\_the\_ID(); |
| [719](#L719) | $url = home\_url("article-authentication-ce21") . '/?postid=' . $postId\_ce21 . '&\_=' . round(microtime(true) \* 1000); |
| [720](#L720) | wp\_redirect($url, 301); |
| [721](#L721) | ?> |
| [722](#L722) | <script type="text/javascript">location.href = "<?php echo esc\_url($url); ?>";</script><?php |
| [723](#L723) | exit; |
| [724](#L724) | } |
| [725](#L725) | } else { |
| [726](#L726) | //$current\_url\_ce21 = home\_url(add\_query\_arg(array(), $wp->request)); |
| [727](#L727) | //$return\_url\_ce21 = get\_option('authorizeURI\_ce21') . "/wpauthorize/login?returnURL=" . $current\_url\_ce21; |
| [728](#L728) |  |
| [729](#L729) | $postId\_ce21 = get\_the\_ID(); |
| [730](#L730) | $current\_url\_ce21 = home\_url("article-authentication-ce21") . '/?postid=' . $postId\_ce21 . '&\_=' . round(microtime(true) \* 1000); |
| [731](#L731) | $return\_url\_ce21 = get\_option('authorizeURI\_ce21') . "/WPAuthorize/LoginNew?returnURL=" . $current\_url\_ce21; |
| [732](#L732) |  |
| [733](#L733) | ?> |
| [734](#L734) | <script type="text/javascript">location.href = "<?php echo esc\_url($return\_url\_ce21); ?>";</script><?php |
| [735](#L735) | exit; |
| [736](#L736) | } |
| [737](#L737) | } |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | //} |
| [741](#L741) |  |
| [742](#L742) | /\* |
| [743](#L743) | \* Plugin activation time create article authentication ce21 page |
| [744](#L744) | \* if page is article-authentication-ce21 and this page check url param post id |
| [745](#L745) | \*/ |
| [746](#L746) | if(! empty( $\_GET['postid']) && is\_page( 'article-authentication-ce21' )) { |
| [747](#L747) |  |
| [748](#L748) | $postId\_ce21 = sanitize\_text\_field($\_GET['postid']); |
| [749](#L749) | $authentication\_plan\_value = get\_post\_meta( $postId\_ce21, '\_post\_authentication\_custom\_metabox\_ce21', true ); |
| [750](#L750) | if( isset($sesionHelper->email ) ) { |
| [751](#L751) | if (!empty($authentication\_plan\_value)) { |
| [752](#L752) |  |
| [753](#L753) | //TODO check condition |
| [754](#L754) | if (session\_id()) { |
| [755](#L755) | $authorizeURI\_ce21 = get\_option('authorizeURI\_ce21'); |
| [756](#L756) | $current\_user\_email\_ce21 = $sesionHelper->email; |
| [757](#L757) | $membership\_TypeId\_ce21 = implode(",", $authentication\_plan\_value); |
| [758](#L758) | $get\_Memberships\_APi\_URL\_ce21 = $authorizeURI\_ce21 . '/WPAuthorize/GroupAccess?email=' . urlencode($current\_user\_email\_ce21) . '&membershipTypeId=' . $membership\_TypeId\_ce21; |
| [759](#L759) |  |
| [760](#L760) | $result = wp\_remote\_get($get\_Memberships\_APi\_URL\_ce21); |
| [761](#L761) | $err = is\_wp\_error($result); |
| [762](#L762) | if ($err) { |
| [763](#L763) | throw new Exception($result['body'], 1); |
| [764](#L764) | } |
| [765](#L765) | $Memberships\_access\_ce21 = json\_decode($result['body'], true); |
| [766](#L766) |  |
| [767](#L767) | if ($Memberships\_access\_ce21['success'] == true && $Memberships\_access\_ce21['data']['groupAccessible'] == true) { |
| [768](#L768) | //echo $get\_Memberships\_APi\_URL\_ce21; |
| [769](#L769) | //echo get\_permalink($postId\_ce21); |
| [770](#L770) | wp\_redirect(get\_permalink($postId\_ce21), 301); |
| [771](#L771) | exit; |
| [772](#L772) | } |
| [773](#L773) | } |
| [774](#L774) | } else { |
| [775](#L775) | $articalID\_ce21 = get\_permalink($postId\_ce21); |
| [776](#L776) | if (!empty($articalID\_ce21)) { |
| [777](#L777) | wp\_redirect(get\_permalink($postId\_ce21)); |
| [778](#L778) | exit; |
| [779](#L779) | } |
| [780](#L780) | } |
| [781](#L781) | }else{ |
| [782](#L782) | $postId\_ce21 = sanitize\_text\_field($\_GET['postid']); |
| [783](#L783) | $return\_url\_ce21 = home\_url("sign-in-ce21") . '/?postid=' . $postId\_ce21 . '&\_=' . round(microtime(true) \* 1000); |
| [784](#L784) |  |
| [785](#L785) | //$current\_url\_ce21 = home\_url(add\_query\_arg(array('postid' => $postId\_ce21), $wp->request)); |
| [786](#L786) | //$return\_url\_ce21 = get\_option('authorizeURI\_ce21') . "/wpauthorize/login?returnURL=" . $current\_url\_ce21; ?> |
| [787](#L787) | <script type="text/javascript">location.href = "<?php echo esc\_url($return\_url\_ce21); ?>";</script><?php |
| [788](#L788) | exit; |
| [789](#L789) | } |
| [790](#L790) |  |
| [791](#L791) | } |
| [792](#L792) | } |
| [793](#L793) | } catch (Exception $e) { |
| [794](#L794) | $errorMsg = ' Error on line '.$e->getLine().' in '.$e->getFile() . ' : <b>'.$e->getMessage().'</b>'; |
| [795](#L795) | ce21\_error\_log\_api($errorMsg); |
| [796](#L796) | } |
| [797](#L797) | } |
| [798](#L798) | } |
| [799](#L799) |  |
| [800](#L800) | /\*\* |
| [801](#L801) | \* Articles Authentication(Custom Error) page could not deleted |
| [802](#L802) | \* This condition for apply all user role |
| [803](#L803) | \*/ |
| [804](#L804) | add\_action('wp\_trash\_post', 'ce21\_restrict\_post\_deletion',10, 1); |
| [805](#L805) |  |
| [806](#L806) | function ce21\_restrict\_post\_deletion($post\_id) { |
| [807](#L807) |  |
| [808](#L808) | if (get\_post\_type() == 'page' ) { |
| [809](#L809) | $page = get\_page\_by\_path( 'article-authentication-ce21' ); |
| [810](#L810) | $signInPage = get\_page\_by\_path( 'sign-in-ce21' ); |
| [811](#L811) |  |
| [812](#L812) | if ($post\_id == $page->ID || $post\_id == $signInPage->ID) { |
| [813](#L813) | wp\_die('Sorry, You are not allowed to delete this page.'); |
| [814](#L814) | } |
| [815](#L815) | } |
| [816](#L816) | } |
| [817](#L817) |  |
| [818](#L818) | /\*\* |
| [819](#L819) | \* Remove admin Dashboard page for ce21 customer user view only |
| [820](#L820) | \*/ |
| [821](#L821) | add\_action( 'admin\_menu', 'ce21\_remove\_menus' ); |
| [822](#L822) |  |
| [823](#L823) | function ce21\_remove\_menus() { |
| [824](#L824) |  |
| [825](#L825) | $user = wp\_get\_current\_user(); |
| [826](#L826) | if ( in\_array( 'CE21\_Customer', (array) $user->roles ) ) { |
| [827](#L827) | remove\_menu\_page( 'index.php' );  //Dashboard |
| [828](#L828) | } |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | /\*\* |
| [832](#L832) | \* Error log send through API global function |
| [833](#L833) | \* |
| [834](#L834) | \*/ |
| [835](#L835) |  |
| [836](#L836) | function ce21\_error\_log\_api($data) { |
| [837](#L837) | $authorizeURI\_ce21 = get\_option( 'authorizeURI\_ce21' ); |
| [838](#L838) | $get\_error\_log\_api\_url\_ce21 = $authorizeURI\_ce21.'/WPAuthorize/ErrorLog'; |
| [839](#L839) | $LoginUser = "-"; |
| [840](#L840) | $current\_user\_ce21 = wp\_get\_current\_user(); |
| [841](#L841) | if ($current\_user\_ce21) { |
| [842](#L842) | $LoginUser = $current\_user\_ce21->user\_login; |
| [843](#L843) | } |
| [844](#L844) | unset($\_SERVER['SERVER\_SIGNATURE']); |
| [845](#L845) |  |
| [846](#L846) | $Etitle = $out = strlen($data) > 300 ? substr($data,0,300)."..." : $data; |
| [847](#L847) |  |
| [848](#L848) | $errorArray\_ce21 = array ( |
| [849](#L849) | 'Title' => $Etitle, |
| [850](#L850) | 'Description' => $data, |
| [851](#L851) | 'Time' => current\_time( 'mysql', 1 ), |
| [852](#L852) | 'ServerVariables' => sanitize\_post($\_SERVER), |
| [853](#L853) | 'LoginUser' => $LoginUser, |
| [854](#L854) | 'SiteDetail' => get\_site\_url(), |
| [855](#L855) | 'UserIp' => sanitize\_text\_field($\_SERVER['REMOTE\_ADDR']) |
| [856](#L856) | ); |
| [857](#L857) | $errorArray\_ce21 = json\_encode($errorArray\_ce21); |
| [858](#L858) | $error\_data = array( |
| [859](#L859) | 'error' => $errorArray\_ce21 |
| [860](#L860) | ); |
| [861](#L861) | $encoded\_data = json\_encode($error\_data); |
| [862](#L862) | $args = array( |
| [863](#L863) | 'method' => 'POST', |
| [864](#L864) | 'timeout' => 30, |
| [865](#L865) | 'redirection' => 10, |
| [866](#L866) | 'httpversion' => '1.1', |
| [867](#L867) | 'sslverify' => false, |
| [868](#L868) | 'headers' => array( |
| [869](#L869) | "Content-Type: application/json", |
| [870](#L870) | "Postman-Token: 7f3b6deb-18e7-47cd-b0bc-bd6d071afd78", |
| [871](#L871) | "cache-control: no-cache", |
| [872](#L872) | ), |
| [873](#L873) | 'body' => $encoded\_data, |
| [874](#L874) | 'cookies' => array() |
| [875](#L875) | ); |
| [876](#L876) | $response = wp\_remote\_post($get\_error\_log\_api\_url\_ce21, $args); |
| [877](#L877) | } |
| [878](#L878) |  |
| [879](#L879) | /\*\* |
| [880](#L880) | \* if new site created, create table for new site |
| [881](#L881) | \*/ |
| [882](#L882) | global $wp\_version; |
| [883](#L883) | if ( version\_compare( $wp\_version, '5.1', '<' ) ) { |
| [884](#L884) | add\_action( 'wpmu\_new\_blog', 'ce21\_on\_create\_table\_when\_new\_site\_created' ); |
| [885](#L885) | } |
| [886](#L886) | else { |
| [887](#L887) | add\_action( 'wp\_initialize\_site', 'ce21\_on\_create\_table\_when\_new\_site\_created', 99 ); |
| [888](#L888) | } |
| [889](#L889) |  |
| [890](#L890) | add\_action( 'activate\_blog', 'ce21\_on\_create\_table\_when\_new\_site\_created' ); |
| [891](#L891) |  |
| [892](#L892) | function ce21\_on\_create\_table\_when\_new\_site\_created( $blog\_id ) { |
| [893](#L893) | if ( ! function\_exists( 'is\_plugin\_active\_for\_network' ) ) { |
| [894](#L894) | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [895](#L895) | } |
| [896](#L896) |  |
| [897](#L897) | if ( $blog\_id instanceof WP\_Site ) { |
| [898](#L898) | $blog\_id = (int) $blog\_id->blog\_id; |
| [899](#L899) | } |
| [900](#L900) |  |
| [901](#L901) | if ( is\_plugin\_active\_for\_network( 'single-sign-on-ce21/single-sign-on-ce21.php' ) ) { |
| [902](#L902) | switch\_to\_blog( $blog\_id ); |
| [903](#L903) | ce21\_create\_table(); |
| [904](#L904) | ce21\_create\_api\_settings\_table(); |
| [905](#L905) | ce21\_create\_calendar\_events\_table(); |
| [906](#L906) | ce21\_create\_authentication\_page(); |
| [907](#L907) | ce21\_sign\_in\_form\_page(); |
| [908](#L908) | ce21\_add\_customer\_role(); |
| [909](#L909) | restore\_current\_blog(); |
| [910](#L910) | } |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | /\* |
| [914](#L914) | \* AJAX script register |
| [915](#L915) | \*/ |
| [916](#L916) | function ce21\_ajax\_login\_init(){ |
| [917](#L917) |  |
| [918](#L918) | wp\_register\_script('ajax-login-script', plugin\_dir\_url( \_\_FILE\_\_ ) . 'public/js/single-sign-on-ce21-ajax.js', array('jquery') ); |
| [919](#L919) | wp\_enqueue\_script('ajax-login-script'); |
| [920](#L920) |  |
| [921](#L921) | wp\_localize\_script( 'ajax-login-script', 'ajax\_login\_object', array( |
| [922](#L922) | 'ajaxurl' => admin\_url( 'admin-ajax.php' ), |
| [923](#L923) | 'redirecturl' => home\_url(), |
| [924](#L924) | 'loadingmessage' => \_\_('Sending user info, please wait...') |
| [925](#L925) | )); |
| [926](#L926) |  |
| [927](#L927) | // Enable the user with no privileges to run ajax\_login() in AJAX |
| [928](#L928) | add\_action( 'wp\_ajax\_nopriv\_ce21\_sign\_in\_ajax\_api', 'ce21\_sign\_in\_ajax\_api' ); |
| [929](#L929) | } |
| [930](#L930) |  |
| [931](#L931) | // Execute the action only if the user isn't logged in |
| [932](#L932) |  |
| [933](#L933) | add\_action('init', 'ce21\_ajax\_login\_init'); |
| [934](#L934) |  |
| [935](#L935) |  |
| [936](#L936) | /\* |
| [937](#L937) | \* This function call will check ce21\_api\_settings table exist or not. If not exist then it will create. |
| [938](#L938) | \* \*/ |
| [939](#L939) | ce21\_create\_api\_settings\_table(); |
| [940](#L940) |  |
| [941](#L941) |  |
| [942](#L942) | /\* |
| [943](#L943) | \* This function call will check ce21\_calendar\_events table exist or not. If not exist then it will create. |
| [944](#L944) | \* \*/ |
| [945](#L945) | ce21\_create\_calendar\_events\_table(); |
| [946](#L946) |  |
| [947](#L947) | /\*\* |
| [948](#L948) | \* This function runs when WordPress completes its upgrade process |
| [949](#L949) | \* It iterates through each plugin updated to see if ours is included |
| [950](#L950) | \* @param $upgrader\_object Array |
| [951](#L951) | \* @param $options Array |
| [952](#L952) | \*/ |
| [953](#L953) | function wp\_upe\_upgrade\_completed($upgrader\_object, $options) |
| [954](#L954) | { |
| [955](#L955) | // The path to our plugin's main file |
| [956](#L956) | $our\_plugin = plugin\_basename(\_\_FILE\_\_); |
| [957](#L957) | // If an update has taken place and the updated type is plugins and the plugins element exists |
| [958](#L958) | if ($options['action'] == 'update' && $options['type'] == 'plugin' && isset($options['plugins'])) { |
| [959](#L959) | // Iterate through the plugins being updated and check if ours is there |
| [960](#L960) | foreach ($options['plugins'] as $plugin) { |
| [961](#L961) | if ($plugin == $our\_plugin) { |
| [962](#L962) | // Set a transient to record that our plugin has just been updated |
| [963](#L963) | set\_transient('wp\_upe\_updated', 1); |
| [964](#L964) | } |
| [965](#L965) | } |
| [966](#L966) | } |
| [967](#L967) | } |
| [968](#L968) | add\_action('upgrader\_process\_complete', 'wp\_upe\_upgrade\_completed', 10, 2); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/ce21-suite/trunk/single-sign-on-ce21.php?rev=3097700&format=txt)
* [Original Format](/export/3097700/ce21-suite/trunk/single-sign-on-ce21.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_ae153e85_20250114_231457.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# CE21 Suite <= 2.2.0 - Authentication Bypass

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   CE21 Suite <= 2.2.0 - Authentication Bypass

9.8

**Authentication Bypass Using an Alternate Path or Channel**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-10284](https://www.cve.org/CVERecord?id=CVE-2024-10284) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | November 8, 2024 |
| Last Updated | December 10, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The CE21 Suite plugin for WordPress is vulnerable to authentication bypass in versions up to, and including, 2.2.0. This is due to hardcoded encryption key in the 'ce21\_authentication\_phrase' function. This makes it possible for unauthenticated attackers to log in as any existing user on the site, such as an administrator, if they have access to the email.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/ce21-suite/trunk/single-sign-on-ce21.php?rev=3097700#L242)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3205463/ce21-suite#file3)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fce21-suite%2Fce21-suite-220-authentication-bypass&t=CE21%20Suite%20%3C%3D%202.2.0%20-%20Authentication%20Bypass "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fce21-suite%2Fce21-suite-220-authentication-bypass&text=CE21%20Suite%20%3C%3D%202.2.0%20-%20Authentication%20Bypass "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fce21-suite%2Fce21-suite-220-authentication-bypass "LinkedIn")
Email

## Vulnerability Details for CE21 Suite

#### [CE21 Suite](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/ce21-suite)

| Software Type | Plugin |
| --- | --- |
| Software Slug | ce21-suite [(view on wordpress.org)](https://wordpress.org/plugins/ce21-suite) |
| Patched? | Yes |
| Remediation | Update to version 2.2.1, or a newer patched version |
| Affected Version | * <= 2.2.0 |
| Patched Version | * 2.2.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


