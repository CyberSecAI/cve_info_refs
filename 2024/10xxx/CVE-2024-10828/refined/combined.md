=== Content from www.wordfence.com_226bdf4f_20250115_085959.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Advanced Order Export For WooCommerce <= 3.5.5 - Unauthenticated PHP Object Injection via Order Details

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Advanced Order Export For WooCommerce <= 3.5.5 - Unauthenticated PHP Object Injection via Order Details

8.1

**Deserialization of Untrusted Data**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-10828](https://www.cve.org/CVERecord?id=CVE-2024-10828) |
| --- | --- |
| CVSS | 8.1 (High) |
| Publicly Published | November 12, 2024 |
| Last Updated | November 13, 2024 |
| Researcher | [Webbernaut](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/webbernaut) |

### Description

The Advanced Order Export For WooCommerce plugin for WordPress is vulnerable to PHP Object Injection in all versions up to, and including, 3.5.5 via deserialization of untrusted input during Order export when the "Try to convert serialized values" option is enabled. This makes it possible for unauthenticated attackers to inject a PHP Object. The additional presence of a POP chain allows attackers to delete arbitrary files on the server, which can easily lead to remote code execution when the right file is deleted (such as wp-config.php).

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/woo-order-export-lite/trunk/classes/core/trait-woe-core-extractor.php#L996)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/woo-order-export-lite/trunk/classes/PHPExcel/Shared/XMLWriter.php#L83)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwoo-order-export-lite%2Fadvanced-order-export-for-woocommerce-355-unauthenticated-php-object-injection-via-order-details&t=Advanced%20Order%20Export%20For%20WooCommerce%20%3C%3D%203.5.5%20-%20Unauthenticated%20PHP%20Object%20Injection%20via%20Order%20Details "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwoo-order-export-lite%2Fadvanced-order-export-for-woocommerce-355-unauthenticated-php-object-injection-via-order-details&text=Advanced%20Order%20Export%20For%20WooCommerce%20%3C%3D%203.5.5%20-%20Unauthenticated%20PHP%20Object%20Injection%20via%20Order%20Details "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwoo-order-export-lite%2Fadvanced-order-export-for-woocommerce-355-unauthenticated-php-object-injection-via-order-details "LinkedIn")
Email

## Vulnerability Details for Advanced Order Export For WooCommerce

#### [Advanced Order Export For WooCommerce](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/woo-order-export-lite)

| Software Type | Plugin |
| --- | --- |
| Software Slug | woo-order-export-lite [(view on wordpress.org)](https://wordpress.org/plugins/woo-order-export-lite) |
| Patched? | Yes |
| Remediation | Update to version 3.5.6, or a newer patched version |
| Affected Version | * <= 3.5.5 |
| Patched Version | * 3.5.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_160fbfd5_20250115_085957.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwoo-order-export-lite%2Ftrunk%2Fclasses%2Fcore%2Ftrait-woe-core-extractor.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/woo-order-export-lite/trunk/classes/core/trait-woe-core-extractor.php?rev=3166958 "Revision 3166958")
* Next Revision →
* [Blame](/browser/woo-order-export-lite/trunk/classes/core/trait-woe-core-extractor.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/woo-order-export-lite/trunk/classes/core/trait-woe-core-extractor.php)

---

# [source:](/browser?order=name "Go to repository root") [woo-order-export-lite](/browser/woo-order-export-lite?order=name "View woo-order-export-lite")/[trunk](/browser/woo-order-export-lite/trunk?order=name "View trunk")/[classes](/browser/woo-order-export-lite/trunk/classes?order=name "View classes")/[core](/browser/woo-order-export-lite/trunk/classes/core?order=name "View core")/[trait-woe-core-extractor.php](/browser/woo-order-export-lite/trunk/classes/core/trait-woe-core-extractor.php?order=name "View trait-woe-core-extractor.php")

View diff against:

View revision:

| [Last change](/changeset/3185463/woo-order-export-lite/trunk/classes/core/trait-woe-core-extractor.php "View differences") on this file was [3185463](/changeset/3185463/ "View changeset 3185463"), checked in by algol.plus, [2 months ago](/timeline?from=2024-11-11T07%3A23%3A09Z&precision=second "See timeline at 11/11/2024 07:23:09 AM") |
| --- |
| dev update |
| **File size:** 46.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if ( ! defined( 'ABSPATH' ) ) { |
| [3](#L3) | exit; // Exit if accessed directly |
| [4](#L4) | } |
| [5](#L5) |  |
| [6](#L6) | trait WOE\_Core\_Extractor { |
| [7](#L7) | static $order\_meta\_field\_prefix = ''; |
| [8](#L8) |  |
| [9](#L9) | // to parse "item\_type:meta\_key" strings |
| [10](#L10) | public static function extract\_item\_type\_and\_key( $meta\_key, &$type, &$key ) { |
| [11](#L11) | $t    = explode( ":", $meta\_key ); |
| [12](#L12) | $type = array\_shift( $t ); |
| [13](#L13) | $key  = join( ":", $t ); |
| [14](#L14) | } |
| [15](#L15) |  |
| [16](#L16) | public static function get\_user\_custom\_fields() { |
| [17](#L17) | global $wpdb; |
| [18](#L18) | $transient\_key = 'woe\_get\_user\_custom\_fields\_result'; |
| [19](#L19) |  |
| [20](#L20) | $fields = get\_transient( $transient\_key ); |
| [21](#L21) | if ( $fields === false ) { |
| [22](#L22) | $total\_users = $wpdb->get\_var( "SELECT COUNT(\*) FROM {$wpdb->users}" ); |
| [23](#L23) | if ( $total\_users < self::HUGE\_SHOP\_CUSTOMERS ) { |
| [24](#L24) | $fields = $wpdb->get\_col( "SELECT DISTINCT meta\_key FROM {$wpdb->usermeta}" ); |
| [25](#L25) | } else { // we have a lot of users, so take last users, upto 1000 |
| [26](#L26) | $user\_ids = $wpdb->get\_col( "SELECT ID FROM {$wpdb->users} ORDER BY ID DESC LIMIT 1000" ); |
| [27](#L27) | $user\_ids = join( ",", $user\_ids ); |
| [28](#L28) | $fields   = $wpdb->get\_col( "SELECT DISTINCT meta\_key FROM {$wpdb->usermeta}  WHERE user\_id IN ($user\_ids)" ); |
| [29](#L29) | } |
| [30](#L30) | sort( $fields ); |
| [31](#L31) | set\_transient( $transient\_key, $fields, 60 ); //valid for a minute |
| [32](#L32) | } |
| [33](#L33) |  |
| [34](#L34) | return apply\_filters( 'woe\_get\_user\_custom\_fields', $fields ); |
| [35](#L35) | } |
| [36](#L36) |  |
| [37](#L37) | public static function get\_product\_attributes() { |
| [38](#L38) | global $wpdb; |
| [39](#L39) |  |
| [40](#L40) | $attrs = array(); |
| [41](#L41) |  |
| [42](#L42) | // WC internal table , skip hidden and attributes |
| [43](#L43) | $wc\_fields = $wpdb->get\_results( "SELECT attribute\_name,attribute\_label FROM {$wpdb->prefix}woocommerce\_attribute\_taxonomies" ); |
| [44](#L44) | foreach ( $wc\_fields as $f ) { |
| [45](#L45) | $attrs[ 'pa\_' . $f->attribute\_name ] = $f->attribute\_label; |
| [46](#L46) | } |
| [47](#L47) |  |
| [48](#L48) |  |
| [49](#L49) | // WP internal table, take all attributes |
| [50](#L50) | $wp\_fields = $wpdb->get\_col( "SELECT DISTINCT meta\_key FROM {$wpdb->postmeta} INNER JOIN {$wpdb->posts} ON {$wpdb->postmeta}.post\_id = {$wpdb->posts}.ID |
| [51](#L51) | WHERE meta\_key LIKE 'attribute\\_%' AND post\_type = 'product\_variation'" ); |
| [52](#L52) | foreach ( $wp\_fields as $attr ) { |
| [53](#L53) | $attr = str\_replace( "attribute\_", "", $attr ); |
| [54](#L54) | if ( substr( $attr, 0, 3 ) == 'pa\_' ) // skip attributes from WC table |
| [55](#L55) | { |
| [56](#L56) | continue; |
| [57](#L57) | } |
| [58](#L58) | $name           = str\_replace( "-", " ", $attr ); |
| [59](#L59) | $name           = ucwords( $name ); |
| [60](#L60) | $attrs[ $attr ] = $name; |
| [61](#L61) | } |
| [62](#L62) | asort( $attrs ); |
| [63](#L63) |  |
| [64](#L64) | return apply\_filters( 'woe\_get\_product\_attributes', $attrs ); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | public static function get\_product\_taxonomies() { |
| [68](#L68) | global $wpdb; |
| [69](#L69) |  |
| [70](#L70) | $attrs = array(); |
| [71](#L71) |  |
| [72](#L72) | if ( function\_exists( "wc\_get\_attribute\_taxonomies" ) ) { |
| [73](#L73) | $wc\_attrs = wc\_get\_attribute\_taxonomies(); |
| [74](#L74) | foreach ( $wc\_attrs as $attr ) { |
| [75](#L75) | $attrs[ "pa\_" . $attr->attribute\_name ] = "pa\_" . $attr->attribute\_name; |
| [76](#L76) | } |
| [77](#L77) | } |
| [78](#L78) |  |
| [79](#L79) | // WP internal table, take all taxonomies for products |
| [80](#L80) | $wp\_fields = $wpdb->get\_col( "SELECT DISTINCT taxonomy FROM {$wpdb->term\_relationships} |
| [81](#L81) | JOIN {$wpdb->term\_taxonomy} ON {$wpdb->term\_taxonomy}.term\_taxonomy\_id = {$wpdb->term\_relationships}.term\_taxonomy\_id |
| [82](#L82) | WHERE {$wpdb->term\_relationships}.object\_id IN  (SELECT DISTINCT ID FROM {$wpdb->posts} WHERE post\_type = 'product' OR post\_type='product\_variation')" ); |
| [83](#L83) | foreach ( $wp\_fields as $attr ) { |
| [84](#L84) | $attrs[ $attr ] = $attr; |
| [85](#L85) | } |
| [86](#L86) | asort( $attrs ); |
| [87](#L87) |  |
| [88](#L88) | return apply\_filters( 'woe\_get\_product\_taxonomies', $attrs ); |
| [89](#L89) | } |
| [90](#L90) |  |
| [91](#L91) | public static function get\_product\_custom\_fields() { |
| [92](#L92) | global $wpdb; |
| [93](#L93) | $transient\_key = 'woe\_get\_product\_custom\_fields\_result'; |
| [94](#L94) |  |
| [95](#L95) | $fields = get\_transient( $transient\_key ); |
| [96](#L96) | if ( $fields === false ) { |
| [97](#L97) | //rewrite for huge # of products |
| [98](#L98) | $total\_products = $wpdb->get\_var( "SELECT COUNT(\*) FROM {$wpdb->posts}  WHERE  post\_type = 'product' OR post\_type='product\_variation' " ); |
| [99](#L99) | //small shop , take all orders |
| [100](#L100) | if ( $total\_products < self::HUGE\_SHOP\_PRODUCTS ) { |
| [101](#L101) | $fields = $wpdb->get\_col( "SELECT DISTINCT meta\_key FROM {$wpdb->posts} INNER JOIN {$wpdb->postmeta} ON {$wpdb->posts}.ID = {$wpdb->postmeta}.post\_id WHERE post\_type = 'product' OR post\_type='product\_variation' " ); |
| [102](#L102) | } else { // we have a lot of orders, take last good orders, upto 1000 |
| [103](#L103) | $product\_ids   = $wpdb->get\_col( "SELECT  ID FROM {$wpdb->posts} WHERE post\_type IN('product','product\_variation')  ORDER BY post\_date DESC LIMIT 1000" ); |
| [104](#L104) | $product\_ids[] = 0; // add fake zero |
| [105](#L105) | $product\_ids   = join( ",", $product\_ids ); |
| [106](#L106) | $fields        = $wpdb->get\_col( "SELECT DISTINCT meta\_key FROM {$wpdb->postmeta}  WHERE post\_id IN ($product\_ids)" ); |
| [107](#L107) | } |
| [108](#L108) | sort( $fields ); |
| [109](#L109) | set\_transient( $transient\_key, $fields, 60 ); //valid for a minute |
| [110](#L110) | } |
| [111](#L111) |  |
| [112](#L112) | return apply\_filters( 'woe\_get\_product\_custom\_fields', $fields ); |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | //For ENGINE |
| [116](#L116) | private static function parse\_pairs( $pairs, $valid\_types, $mode = '' ) { |
| [117](#L117) | $pair\_types = array(); |
| [118](#L118) | foreach ( $pairs as $pair ) { |
| [119](#L119) | list( $filter\_type, $filter\_value ) = array\_map( 'trim', explode( "=", trim( $pair ) ) ); |
| [120](#L120) | if ( $mode == 'lower\_filter\_label' ) { |
| [121](#L121) | $filter\_type = strtolower( $filter\_type ); |
| [122](#L122) | } // Country=>country for locations |
| [123](#L123) | if ( ! in\_array( $filter\_type, $valid\_types ) ) { |
| [124](#L124) | continue; |
| [125](#L125) | } |
| [126](#L126) | if ( ! isset( $pair\_types[ $filter\_type ] ) ) { |
| [127](#L127) | $pair\_types[ $filter\_type ] = array(); |
| [128](#L128) | } |
| [129](#L129) | $pair\_types[ $filter\_type ][] = $filter\_value; |
| [130](#L130) | } |
| [131](#L131) |  |
| [132](#L132) | return $pair\_types; |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) | public static function parse\_complex\_pairs( $pairs, $valid\_types = false, $mode = '' ) { |
| [136](#L136) | $pair\_types = array(); |
| [137](#L137) | $delimiters = array( |
| [138](#L138) | 'NOT SET' => 'NOT SET', |
| [139](#L139) | 'IS SET'  => 'IS SET', |
| [140](#L140) | 'NOT LIKE'    => 'NOT LIKE', |
| [141](#L141) | 'LIKE'    => 'LIKE', |
| [142](#L142) | '<>'      => 'NOT IN', |
| [143](#L143) | '>='      => '>=', |
| [144](#L144) | '<='      => '<=', |
| [145](#L145) | '>'       => '>', |
| [146](#L146) | '<'       => '<', |
| [147](#L147) | '='       => 'IN', |
| [148](#L148) | ); |
| [149](#L149) | $single\_ops = array( 'NOT SET', 'IS SET' ); |
| [150](#L150) |  |
| [151](#L151) | foreach ( $pairs as $pair ) { |
| [152](#L152) | $pair      = trim( $pair ); |
| [153](#L153) | $op        = ''; |
| [154](#L154) | $single\_op = false; |
| [155](#L155) | foreach ( $delimiters as $delim => $op\_seek ) { |
| [156](#L156) | $t         = explode( $delim, $pair ); |
| [157](#L157) | $single\_op = in\_array( $delim, $single\_ops ); |
| [158](#L158) | if ( count( $t ) == 2 ) { |
| [159](#L159) | $op = $op\_seek; |
| [160](#L160) | break; |
| [161](#L161) | } |
| [162](#L162) | } |
| [163](#L163) | if ( ! $op ) { |
| [164](#L164) | continue; |
| [165](#L165) | } |
| [166](#L166) | if ( $single\_op ) { |
| [167](#L167) | $t[1] = ''; |
| [168](#L168) | } |
| [169](#L169) |  |
| [170](#L170) | list( $filter\_type, $filter\_value ) = array\_map( "trim", $t ); |
| [171](#L171) | $empty = \_\_( 'empty', 'woo-order-export-lite' ); |
| [172](#L172) | if ( $empty == $filter\_value ) { |
| [173](#L173) | $filter\_value = ''; |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | if ( $mode == 'lower\_filter\_label' ) { |
| [177](#L177) | $filter\_type = strtolower( $filter\_type ); |
| [178](#L178) | } // Country=>country for locations |
| [179](#L179) |  |
| [180](#L180) | if ( $valid\_types AND ! in\_array( $filter\_type, $valid\_types ) ) { |
| [181](#L181) | continue; |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | $filter\_type = addslashes( $filter\_type ); |
| [185](#L185) | if ( ! isset( $pair\_types[ $op ] ) ) { |
| [186](#L186) | $pair\_types[ $op ] = array(); |
| [187](#L187) | } |
| [188](#L188) | if ( ! isset( $pair\_types[ $op ] [ $filter\_type ] ) ) { |
| [189](#L189) | $pair\_types[ $op ] [ $filter\_type ] = array(); |
| [190](#L190) | } |
| [191](#L191) | $pair\_types[ $op ][ $filter\_type ][] = addslashes( $filter\_value ); |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | return $pair\_types; |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | private static function sql\_subset( $arr\_values ) { |
| [198](#L198) | $values = array(); |
| [199](#L199) | foreach ( $arr\_values as $s ) { |
| [200](#L200) | $values[] = "'$s'"; |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) | return join( ",", $values ); |
| [204](#L204) | } |
| [205](#L205) |  |
| [206](#L206) |  |
| [207](#L207) | public static function sql\_get\_order\_ids( $settings ) { |
| [208](#L208) | //$settings['product\_categories'] = array(119); |
| [209](#L209) | //$settings['products'] = array(4554); |
| [210](#L210) | //$settings['shipping\_locations'] = array("city=cityS","city=alex","postcode=12345"); |
| [211](#L211) | //$settings['product\_attributes'] = array("pa\_material=glass"); |
| [212](#L212) | return self::sql\_get\_order\_ids\_Ver1( $settings ); |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) |  |
| [216](#L216) | public static function sql\_get\_filtered\_product\_list( $settings ) { |
| [217](#L217) | global $wpdb; |
| [218](#L218) |  |
| [219](#L219) | // has exact products? |
| [220](#L220) | if ( $settings['products'] ) { |
| [221](#L221) | ;// do nothing |
| [222](#L222) | } elseif ( empty( $settings['product\_vendors'] ) AND empty( $settings['product\_custom\_fields'] ) ) { |
| [223](#L223) | $settings['products'] = array(); |
| [224](#L224) | } else { |
| [225](#L225) | $product\_where = array( "1" ); |
| [226](#L226) |  |
| [227](#L227) | //by owners |
| [228](#L228) | $settings['product\_vendors'] = apply\_filters( 'woe\_sql\_get\_product\_vendor\_ids', |
| [229](#L229) | $settings['product\_vendors'], $settings ); |
| [230](#L230) | if ( $settings['product\_vendors'] ) { |
| [231](#L231) | $values          = self::sql\_subset( $settings['product\_vendors'] ); |
| [232](#L232) | $product\_where[] = " products.post\_author in ($values)"; |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | //by custom fields in Product |
| [236](#L236) | $product\_meta\_where     = ""; |
| [237](#L237) | $left\_join\_product\_meta = ""; |
| [238](#L238) | if ( $settings['product\_custom\_fields'] ) { |
| [239](#L239) | $left\_join\_product\_meta = $product\_meta\_where = array(); |
| [240](#L240) | $filters                = self::parse\_complex\_pairs( $settings['product\_custom\_fields']); |
| [241](#L241) | $pos                    = 1; |
| [242](#L242) | foreach ( $filters as $operator => $fields ) { |
| [243](#L243) | foreach ( $fields as $field => $values ) { |
| [244](#L244) | if ( $values ) { |
| [245](#L245) | $left\_join\_product\_meta[] = "LEFT JOIN {$wpdb->postmeta} AS productmeta\_cf\_{$pos} ON productmeta\_cf\_{$pos}.post\_id = products.ID AND productmeta\_cf\_{$pos}.meta\_key='$field'"; |
| [246](#L246) | if ( $operator == 'IN' OR $operator == 'NOT IN' ) { |
| [247](#L247) | $values               = self::sql\_subset( $values ); |
| [248](#L248) | $product\_meta\_where[] = " productmeta\_cf\_{$pos}.meta\_value $operator ($values) "; |
| [249](#L249) | } elseif ( $operator == 'NOT SET' ) { |
| [250](#L250) | $product\_meta\_where [] = " productmeta\_cf\_{$pos}.meta\_value IS NULL "; |
| [251](#L251) | } elseif ( $operator == 'IS SET' ) { |
| [252](#L252) | $product\_meta\_where [] = " productmeta\_cf\_{$pos}.meta\_value IS NOT NULL "; |
| [253](#L253) | } elseif ( in\_array( $operator, self::$operator\_must\_check\_values ) ) { |
| [254](#L254) | $pairs = array(); |
| [255](#L255) | foreach ( $values as $v ) { |
| [256](#L256) | $pairs[] = self::operator\_compare\_field\_and\_value( "`productmeta\_cf\_{$pos}`.meta\_value", |
| [257](#L257) | $operator, $v, $field ); |
| [258](#L258) | } |
| [259](#L259) | $pairs                = join( apply\_filters("woe\_product\_custom\_fields\_operator", " OR "), $pairs ); |
| [260](#L260) | $product\_meta\_where[] = " ($pairs) "; |
| [261](#L261) | } |
| [262](#L262) | $pos ++; |
| [263](#L263) | }//if values |
| [264](#L264) | } |
| [265](#L265) | } |
| [266](#L266) |  |
| [267](#L267) | if ( $filters ) { |
| [268](#L268) | $product\_where[]        = join( " AND ", $product\_meta\_where ); |
| [269](#L269) | $left\_join\_product\_meta = join( "  ", $left\_join\_product\_meta ); |
| [270](#L270) | } |
| [271](#L271) | } |
| [272](#L272) | //done |
| [273](#L273) | $product\_where        = join( " AND ", $product\_where ); |
| [274](#L274) | $sql                  = "SELECT DISTINCT ID FROM {$wpdb->posts} AS products $left\_join\_product\_meta  WHERE products.post\_type in ('product','product\_variation') AND products.post\_status<>'trash' AND $product\_where "; |
| [275](#L275) | $settings['products'] = $wpdb->get\_col( $sql ); |
| [276](#L276) | if ( empty( $settings['products'] ) ) // failed condition! |
| [277](#L277) | { |
| [278](#L278) | $settings['products'] = array( 0 ); |
| [279](#L279) | } |
| [280](#L280) | } |
| [281](#L281) |  |
| [282](#L282) | //  we have to use variations , if user sets product attributes |
| [283](#L283) | if ( $settings['products'] AND $settings['product\_attributes'] ) { |
| [284](#L284) | $values               = self::sql\_subset( $settings['products'] ); |
| [285](#L285) | $sql                  = "SELECT DISTINCT ID FROM {$wpdb->posts} AS products WHERE products.post\_type in ('product','product\_variation') AND products.post\_status<>'trash' AND post\_parent<>0 AND post\_parent IN ($values)"; |
| [286](#L286) | $settings['products'] = $wpdb->get\_col( $sql ); |
| [287](#L287) | if ( empty( $settings['products'] ) ) // failed condition! |
| [288](#L288) | { |
| [289](#L289) | $settings['products'] = array( 0 ); |
| [290](#L290) | } |
| [291](#L291) | } |
| [292](#L292) | if ( ! empty( $sql ) AND self::$track\_sql\_queries ) { |
| [293](#L293) | self::$sql\_queries[] = $sql; |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | return apply\_filters( 'woe\_sql\_adjust\_products', $settings['products'], $settings ); |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | public static function sql\_build\_product\_filter( $settings ) { |
| [300](#L300) | global $wpdb; |
| [301](#L301) |  |
| [302](#L302) | //custom taxonomies |
| [303](#L303) | $taxonomy\_where = ""; |
| [304](#L304) | if ( $settings['product\_taxonomies'] ) { |
| [305](#L305) | $attrs        = self::get\_product\_taxonomies(); |
| [306](#L306) | $names2fields = array\_flip( $attrs ); |
| [307](#L307) | $filters      = self::parse\_complex\_pairs( $settings['product\_taxonomies']); |
| [308](#L308) | $taxonomy\_where = array(); |
| [309](#L309) | //print\_r($filters );die(); |
| [310](#L310) | foreach ( $filters as $operator => $fields ) { |
| [311](#L311) | foreach ( $fields as $label => $values ) { |
| [312](#L312) | if (isset($names2fields[ $label ])) { |
| [313](#L313) | $field  = $names2fields[ $label ]; |
| [314](#L314) | $values = self::sql\_subset( $values ); |
| [315](#L315) | if ( $values ) { |
| [316](#L316) | $label = esc\_sql( $label ); |
| [317](#L317) |  |
| [318](#L318) | if ($operator == 'NOT SET') { |
| [319](#L319) | $taxonomy\_where[] = "NOT ( orderitemmeta\_product.meta\_key IN('\_product\_id') AND orderitemmeta\_product.meta\_value IN (SELECT  object\_id FROM {$wpdb->term\_relationships} AS `{$field}\_rel` |
| [320](#L320) | INNER JOIN {$wpdb->term\_taxonomy} AS `{$field}\_cat` ON `{$field}\_cat`.term\_taxonomy\_id = `{$field}\_rel`.term\_taxonomy\_id |
| [321](#L321) | WHERE `{$field}\_cat`.taxonomy='$label' AND  `{$field}\_cat`.term\_id IN (SELECT term\_id FROM {$wpdb->terms} ) ))"; |
| [322](#L322) | } elseif ($operator == 'IS SET') { |
| [323](#L323) | $taxonomy\_where[] = "( orderitemmeta\_product.meta\_key IN('\_product\_id') AND orderitemmeta\_product.meta\_value IN (SELECT  object\_id FROM {$wpdb->term\_relationships} AS `{$field}\_rel` |
| [324](#L324) | INNER JOIN {$wpdb->term\_taxonomy} AS `{$field}\_cat` ON `{$field}\_cat`.term\_taxonomy\_id = `{$field}\_rel`.term\_taxonomy\_id |
| [325](#L325) | WHERE `{$field}\_cat`.taxonomy='$label' AND  `{$field}\_cat`.term\_id IN (SELECT term\_id FROM {$wpdb->terms} ) ))"; |
| [326](#L326) | } else { |
| [327](#L327) | $taxonomy\_where[] = "( orderitemmeta\_product.meta\_key IN('\_product\_id') AND orderitemmeta\_product.meta\_value  $operator (SELECT  object\_id FROM {$wpdb->term\_relationships} AS `{$field}\_rel` |
| [328](#L328) | INNER JOIN {$wpdb->term\_taxonomy} AS `{$field}\_cat` ON `{$field}\_cat`.term\_taxonomy\_id = `{$field}\_rel`.term\_taxonomy\_id |
| [329](#L329) | WHERE `{$field}\_cat`.taxonomy='$label' AND  `{$field}\_cat`.term\_id IN (SELECT term\_id FROM {$wpdb->terms} WHERE name IN ($values) ) ))"; |
| [330](#L330) | } |
| [331](#L331) | } |
| [332](#L332) | } |
| [333](#L333) | } |
| [334](#L334) | } |
| [335](#L335) | if( $taxonomy\_where ) |
| [336](#L336) | $taxonomy\_where = "AND ( " . join( apply\_filters( "woe\_sql\_taxonomies\_where\_operator", "AND" ), $taxonomy\_where) ." )"; |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) | $product\_category\_where = ""; |
| [340](#L340) | if ( $settings['product\_categories'] ) { |
| [341](#L341) | $cat\_ids = array( 0 ); |
| [342](#L342) | foreach ( $settings['product\_categories'] as $cat\_id ) { |
| [343](#L343) | $cat\_ids[] = $cat\_id; |
| [344](#L344) | foreach ( get\_term\_children( $cat\_id, 'product\_cat' ) as $child\_id ) { |
| [345](#L345) | $cat\_ids[] = $child\_id; |
| [346](#L346) | } |
| [347](#L347) | } |
| [348](#L348) | $cat\_ids                = join( ',', $cat\_ids ); |
| [349](#L349) | $product\_category\_where = "SELECT  DISTINCT object\_id FROM {$wpdb->term\_relationships} AS product\_in\_cat |
| [350](#L350) | LEFT JOIN {$wpdb->term\_taxonomy} AS product\_category ON product\_category.term\_taxonomy\_id = product\_in\_cat.term\_taxonomy\_id |
| [351](#L351) | WHERE product\_category.term\_id IN ($cat\_ids) |
| [352](#L352) | "; |
| [353](#L353) | // get products and variations! |
| [354](#L354) | $product\_category\_where = "AND orderitemmeta\_product.meta\_value IN |
| [355](#L355) | ( |
| [356](#L356) | SELECT DISTINCT ID FROM {$wpdb->posts} AS product\_category\_variations WHERE post\_parent<>0 AND post\_parent IN ($product\_category\_where) |
| [357](#L357) | UNION |
| [358](#L358) | $product\_category\_where |
| [359](#L359) | ) |
| [360](#L360) | "; |
| [361](#L361) | } |
| [362](#L362) |  |
| [363](#L363) | $settings['products'] = self::sql\_get\_filtered\_product\_list( $settings ); |
| [364](#L364) |  |
| [365](#L365) | // deep level still |
| [366](#L366) | $exact\_product\_where = ''; |
| [367](#L367) | if ( $settings['products'] ) { |
| [368](#L368) | $values = self::sql\_subset( $settings['products'] ); |
| [369](#L369) | if ( $values ) { |
| [370](#L370) | $exact\_product\_where = "AND orderitemmeta\_product.meta\_value IN ($values)"; |
| [371](#L371) | } |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | $exclude\_product\_where = ''; |
| [375](#L375) | if ( $settings['exclude\_products'] ) { |
| [376](#L376) | $values = self::sql\_subset( $settings['exclude\_products'] ); |
| [377](#L377) | if ( $values ) { |
| [378](#L378) | $exclude\_product\_where = "AND (orderitemmeta\_product.meta\_key = '\_product\_id' AND orderitemmeta\_product.meta\_value NOT IN ($values))"; |
| [379](#L379) | } |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | $product\_where = join( " ", |
| [383](#L383) | array\_filter( array( $taxonomy\_where, $product\_category\_where, $exact\_product\_where, $exclude\_product\_where ) ) ); |
| [384](#L384) |  |
| [385](#L385) | //skip empty values |
| [386](#L386) | if ( $product\_where ) { |
| [387](#L387) | $product\_where = "AND orderitemmeta\_product.meta\_value<>'0' " . $product\_where; |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | return $product\_where; |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | static function operator\_compare\_field\_and\_value( $field, $operator, $value, $public\_fieldname='' ) { |
| [394](#L394) | $value = esc\_sql($value); |
| [395](#L395) | if ( $operator == "LIKE" OR $operator == "NOT LIKE") { |
| [396](#L396) | $value = (substr($value,0,1)=="^") ? substr($value,1)."%" : "%$value%"; |
| [397](#L397) | } else { // compare numbers! |
| [398](#L398) | $type = apply\_filters( "woe\_compare\_field\_cast\_to\_type", "signed", $field, $operator, $value, $public\_fieldname); |
| [399](#L399) | $field = "cast($field as $type)"; |
| [400](#L400) | } |
| [401](#L401) | return " $field $operator '$value' "; |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) | private static function get\_date\_meta\_for\_subscription\_filters( $field, $date\_from, $date\_to ) { |
| [405](#L405) | $order\_meta\_where\_parts[] = "ordermeta\_{$field}.meta\_key='\_{$field}'"; |
| [406](#L406) |  |
| [407](#L407) | if ( ! empty( $date\_from ) ) { |
| [408](#L408) | $subsc\_from = WC\_Order\_Export\_Data\_Extractor::format\_date\_to\_day\_start( $date\_from ); |
| [409](#L409) | $order\_meta\_where\_parts[] = " CAST(ordermeta\_{$field}.meta\_value AS DATETIME) >= '{$subsc\_from}'"; |
| [410](#L410) | } |
| [411](#L411) |  |
| [412](#L412) | if ( ! empty( $date\_to ) ) { |
| [413](#L413) | $subsc\_to = WC\_Order\_Export\_Data\_Extractor::format\_date\_to\_day\_end( $date\_to ); |
| [414](#L414) | $order\_meta\_where\_parts[] = " CAST(ordermeta\_{$field}.meta\_value AS DATETIME) <= '{$subsc\_to}'"; |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | $order\_meta\_where\_parts = join( " AND ", $order\_meta\_where\_parts ); |
| [418](#L418) |  |
| [419](#L419) | return " ( $order\_meta\_where\_parts ) "; |
| [420](#L420) | } |
| [421](#L421) |  |
| [422](#L422) | public static function is\_datetime\_timestamp( $ts ) { |
| [423](#L423) | return $ts % ( 24 \* 3600 ) > 0; |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | public static function format\_date\_to\_day\_start( $date ) { |
| [427](#L427) | $ts = strtotime( $date ); |
| [428](#L428) | if ( self::is\_datetime\_timestamp( $ts ) ) { |
| [429](#L429) | $from\_date = date( 'Y-m-d H:i:s', $ts ); |
| [430](#L430) | } else { |
| [431](#L431) | $from\_date = date( 'Y-m-d', $ts ) . " 00:00:00"; |
| [432](#L432) | } |
| [433](#L433) | return $from\_date; |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | public static function format\_date\_to\_day\_end( $date ) { |
| [437](#L437) | $ts = strtotime( $date ); |
| [438](#L438) | if ( self::is\_datetime\_timestamp( $ts ) ) { |
| [439](#L439) | $to\_date = date( 'Y-m-d H:i:s', $ts ); |
| [440](#L440) | } else { |
| [441](#L441) | $to\_date = date( 'Y-m-d', $ts ) . " 23:59:59"; |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | return $to\_date; |
| [445](#L445) | } |
| [446](#L446) |  |
| [447](#L447) | public static function get\_date\_range( $settings, $is\_for\_sql, $use\_timestamps = false , $force\_utc = false ) { |
| [448](#L448) | $result = array(); |
| [449](#L449) | $diff\_utc = current\_time( "timestamp" ) - current\_time( "timestamp", 1 ); |
| [450](#L450) |  |
| [451](#L451) | // fixed date range |
| [452](#L452) | if ( ! empty( $settings['from\_date'] ) OR ! empty( $settings['to\_date'] ) ) { |
| [453](#L453) | if ( $settings['from\_date'] ) { |
| [454](#L454) | $from\_date = self::format\_date\_to\_day\_start( $settings['from\_date'] ); |
| [455](#L455) | if ( $is\_for\_sql ) { |
| [456](#L456) | if ( $use\_timestamps ) { |
| [457](#L457) | $from\_date = mysql2date( 'G', $from\_date ); |
| [458](#L458) | $from\_date -= $diff\_utc; |
| [459](#L459) | } elseif( $force\_utc ) |
| [460](#L460) | $from\_date = self::convert\_date\_to\_utc( $from\_date, $diff\_utc ); |
| [461](#L461) | $from\_date = sprintf( ">='%s'", $from\_date ); |
| [462](#L462) | } |
| [463](#L463) | $result['from\_date'] = $from\_date; |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | if ( $settings['to\_date'] ) { |
| [467](#L467) | $to\_date = self::format\_date\_to\_day\_end( $settings['to\_date'] ); |
| [468](#L468) | if ( $is\_for\_sql ) { |
| [469](#L469) | if ( $use\_timestamps ) { |
| [470](#L470) | $to\_date = mysql2date( 'G', $to\_date ); |
| [471](#L471) | $to\_date -= $diff\_utc; |
| [472](#L472) | } elseif( $force\_utc ) |
| [473](#L473) | $to\_date = self::convert\_date\_to\_utc( $to\_date, $diff\_utc ); |
| [474](#L474) | $to\_date = sprintf( "<='%s'", $to\_date ); |
| [475](#L475) | } |
| [476](#L476) | $result['to\_date'] = $to\_date; |
| [477](#L477) | } |
| [478](#L478) |  |
| [479](#L479) | return $result; |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | $\_time = current\_time( "timestamp", 0 ); |
| [483](#L483) |  |
| [484](#L484) | $export\_rule = isset( $settings['export\_rule'] ) ? $settings['export\_rule'] : ''; |
| [485](#L485) |  |
| [486](#L486) | switch ( $export\_rule ) { |
| [487](#L487) | case "none": |
| [488](#L488) | unset( $from\_date ); |
| [489](#L489) | unset( $to\_date ); |
| [490](#L490) | break; |
| [491](#L491) | case "last\_run": |
| [492](#L492) | $last\_run = isset( $settings['schedule']['last\_run'] ) ? $settings['schedule']['last\_run'] : ''; |
| [493](#L493) | if ( isset( $last\_run ) AND $last\_run ) { |
| [494](#L494) | $from\_date = date( 'Y-m-d H:i:s', $last\_run ); |
| [495](#L495) | } |
| [496](#L496) | break; |
| [497](#L497) | case "today": |
| [498](#L498) | $\_date = date( 'Y-m-d', $\_time ); |
| [499](#L499) |  |
| [500](#L500) | $from\_date = sprintf( '%s %s', $\_date, '00:00:00' ); |
| [501](#L501) | $to\_date   = sprintf( '%s %s', $\_date, '23:59:59' ); |
| [502](#L502) | break; |
| [503](#L503) | case "this\_week": |
| [504](#L504) | $day        = ( date( 'w', $\_time ) + 6 ) % 7;// 0 - Sun , must be Mon = 0 |
| [505](#L505) | $\_date      = date( 'Y-m-d', $\_time ); |
| [506](#L506) | $week\_start = date( 'Y-m-d', strtotime( $\_date . ' -' . $day . ' days' ) ); |
| [507](#L507) | $week\_end   = date( 'Y-m-d', strtotime( $\_date . ' +' . ( 6 - $day ) . ' days' ) ); |
| [508](#L508) |  |
| [509](#L509) | $from\_date = sprintf( '%s %s', $week\_start, '00:00:00' ); |
| [510](#L510) | $to\_date   = sprintf( '%s %s', $week\_end, '23:59:59' ); |
| [511](#L511) | break; |
| [512](#L512) | case "this\_month": |
| [513](#L513) | $month\_start = date( 'Y-m-01', $\_time ); |
| [514](#L514) | $month\_end   = date( 'Y-m-t', $\_time ); |
| [515](#L515) |  |
| [516](#L516) | $from\_date = sprintf( '%s %s', $month\_start, '00:00:00' ); |
| [517](#L517) | $to\_date   = sprintf( '%s %s', $month\_end, '23:59:59' ); |
| [518](#L518) | break; |
| [519](#L519) | case "last\_day": |
| [520](#L520) | $\_date    = date( 'Y-m-d', $\_time ); |
| [521](#L521) | $last\_day = strtotime( $\_date . " -1 day" ); |
| [522](#L522) | $\_date    = date( 'Y-m-d', $last\_day ); |
| [523](#L523) |  |
| [524](#L524) | $from\_date = sprintf( '%s %s', $\_date, '00:00:00' ); |
| [525](#L525) | $to\_date   = sprintf( '%s %s', $\_date, '23:59:59' ); |
| [526](#L526) | break; |
| [527](#L527) | case "last\_week": |
| [528](#L528) | $day        = ( date( 'w', $\_time ) + 6 ) % 7;// 0 - Sun , must be Mon = 0 |
| [529](#L529) | $\_date      = date( 'Y-m-d', $\_time ); |
| [530](#L530) | $last\_week  = strtotime( $\_date . " -1 week" ); |
| [531](#L531) | $week\_start = date( 'Y-m-d', strtotime( date( 'Y-m-d', $last\_week ) . ' -' . $day . ' days' ) ); |
| [532](#L532) | $week\_end   = date( 'Y-m-d', strtotime( date( 'Y-m-d', $last\_week ) . ' +' . ( 6 - $day ) . ' days' ) ); |
| [533](#L533) |  |
| [534](#L534) | $from\_date = sprintf( '%s %s', $week\_start, '00:00:00' ); |
| [535](#L535) | $to\_date   = sprintf( '%s %s', $week\_end, '23:59:59' ); |
| [536](#L536) | break; |
| [537](#L537) | case "last\_month": |
| [538](#L538) | $\_date       = date( 'Y-m-d', $\_time ); |
| [539](#L539) | $last\_month  = strtotime( $\_date . " -1 month" ); |
| [540](#L540) | $month\_start = date( 'Y-m-01', $last\_month ); |
| [541](#L541) | $month\_end   = date( 'Y-m-t', $last\_month ); |
| [542](#L542) |  |
| [543](#L543) | $from\_date = sprintf( '%s %s', $month\_start, '00:00:00' ); |
| [544](#L544) | $to\_date   = sprintf( '%s %s', $month\_end, '23:59:59' ); |
| [545](#L545) | break; |
| [546](#L546) | case "last\_quarter": |
| [547](#L547) | $\_date         = date( 'Y-m-d', $\_time ); |
| [548](#L548) | $last\_month    = strtotime( $\_date . " -3 month" ); |
| [549](#L549) | $quarter\_first\_month = self::get\_quarter\_month( $last\_month ); |
| [550](#L550) | if( $quarter\_first\_month < 10 ) |
| [551](#L551) | $quarter\_first\_month = "0".$quarter\_first\_month; |
| [552](#L552) | $quarter\_last\_month = self::get\_quarter\_month( $last\_month ) + 2; |
| [553](#L553) | if( $quarter\_last\_month < 10 ) |
| [554](#L554) | $quarter\_last\_month = "0".$quarter\_last\_month; |
| [555](#L555) | $quarter\_start = date( 'Y-' . $quarter\_first\_month . '-01', $last\_month ); |
| [556](#L556) | $quarter\_end   = date( 'Y-' . $quarter\_last\_month . '-t', strtotime("$quarter\_start +2 month") ); |
| [557](#L557) |  |
| [558](#L558) | $from\_date = sprintf( '%s %s', $quarter\_start, '00:00:00' ); |
| [559](#L559) | $to\_date   = sprintf( '%s %s', $quarter\_end, '23:59:59' ); |
| [560](#L560) | break; |
| [561](#L561) | case "this\_year": |
| [562](#L562) | $year\_start = date( 'Y-01-01', $\_time ); |
| [563](#L563) |  |
| [564](#L564) | $from\_date = sprintf( '%s %s', $year\_start, '00:00:00' ); |
| [565](#L565) | break; |
| [566](#L566) | // =========== Modified By Hayato ========== |
| [567](#L567) | case "last\_year": |
| [568](#L568) | $\_date = date('Y-m-d',$\_time); |
| [569](#L569) | $last\_year = strtotime($\_date . " -1 year"); |
| [570](#L570) | $last\_year\_start = date('Y-01-01',$last\_year); |
| [571](#L571) | $last\_year\_end = date('Y-12-31',$last\_year); |
| [572](#L572) | $from\_date = sprintf('%s %s',$last\_year\_start, '00:00:00'); |
| [573](#L573) | $to\_date = sprintf('%s %s',$last\_year\_end, '23:59:59'); |
| [574](#L574) | break; |
| [575](#L575) | // ========================================= |
| [576](#L576) | case "custom": |
| [577](#L577) | $export\_rule\_custom = isset( $settings['export\_rule\_custom'] ) ? $settings['export\_rule\_custom'] : ''; |
| [578](#L578) | if ( isset( $export\_rule\_custom ) AND $export\_rule\_custom ) { |
| [579](#L579) | $day\_start = date( 'Y-m-d', |
| [580](#L580) | strtotime( date( 'Y-m-d', $\_time ) . ' -' . intval( $export\_rule\_custom ) . ' days' ) ); |
| [581](#L581) | $day\_end   = date( 'Y-m-d', $\_time ); |
| [582](#L582) |  |
| [583](#L583) | $from\_date = sprintf( '%s %s', $day\_start, '00:00:00' ); |
| [584](#L584) | $to\_date   = sprintf( '%s %s', $day\_end, '23:59:59' ); |
| [585](#L585) | } |
| [586](#L586) | break; |
| [587](#L587) | default: |
| [588](#L588) | break; |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | if ( isset( $from\_date ) AND $from\_date ) { |
| [592](#L592) | if ( $is\_for\_sql ) { |
| [593](#L593) | if ( $use\_timestamps ) { |
| [594](#L594) | $from\_date = mysql2date( 'G', $from\_date ); |
| [595](#L595) | $from\_date -= $diff\_utc; |
| [596](#L596) | } elseif( $force\_utc ) |
| [597](#L597) | $from\_date = self::convert\_date\_to\_utc( $from\_date, $diff\_utc ); |
| [598](#L598) | $from\_date = sprintf( ">='%s'", $from\_date ); |
| [599](#L599) | } |
| [600](#L600) | $result['from\_date'] = $from\_date; |
| [601](#L601) | } |
| [602](#L602) |  |
| [603](#L603) | if ( isset( $to\_date ) AND $to\_date ) { |
| [604](#L604) | if ( $is\_for\_sql ) { |
| [605](#L605) | if ( $use\_timestamps ) { |
| [606](#L606) | $to\_date = mysql2date( 'G', $to\_date ); |
| [607](#L607) | $to\_date -= $diff\_utc; |
| [608](#L608) | } elseif( $force\_utc ) |
| [609](#L609) | $to\_date = self::convert\_date\_to\_utc( $to\_date, $diff\_utc ); |
| [610](#L610) | $to\_date = sprintf( "<='%s'", $to\_date ); |
| [611](#L611) | } |
| [612](#L612) | $result['to\_date'] = $to\_date; |
| [613](#L613) | } |
| [614](#L614) |  |
| [615](#L615) | return $result; |
| [616](#L616) | } |
| [617](#L617) |  |
| [618](#L618) | public static function convert\_date\_to\_utc( $date, $diff\_utc ) { |
| [619](#L619) | return gmdate("Y-m-d H:i:s", strtotime($date) - $diff\_utc); |
| [620](#L620) | } |
| [621](#L621) |  |
| [622](#L622) | public static function get\_quarter\_month( $time ) { |
| [623](#L623) | $month = date( "m", $time ); |
| [624](#L624) | if ( $month <= 3 ) { |
| [625](#L625) | return 1; |
| [626](#L626) | } |
| [627](#L627) | if ( $month <= 6 ) { |
| [628](#L628) | return 4; |
| [629](#L629) | } |
| [630](#L630) | if ( $month <= 9 ) { |
| [631](#L631) | return 7; |
| [632](#L632) | } |
| [633](#L633) |  |
| [634](#L634) | return 10; |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | public static function prepare\_for\_export() { |
| [638](#L638) | self::$statuses                         = wc\_get\_order\_statuses(); |
| [639](#L639) | self::$countries                        = WC()->countries->countries; |
| [640](#L640) | self::$prices\_include\_tax               = get\_option( 'woocommerce\_prices\_include\_tax' ) == 'yes' ? true : false; |
| [641](#L641) | self::$export\_subcategories\_separator   = apply\_filters( 'woe\_export\_subcategories\_separator', ">" ); |
| [642](#L642) | self::$export\_line\_categories\_separator = apply\_filters( 'woe\_export\_line\_categories\_separator', ",\n" ); |
| [643](#L643) | self::$export\_itemmeta\_values\_separator = apply\_filters( 'woe\_export\_itemmeta\_values\_separator', ", " ); |
| [644](#L644) | self::$export\_custom\_fields\_separator   = apply\_filters( 'woe\_export\_custom\_fields\_separator', ", " ); |
| [645](#L645) |  |
| [646](#L646) | //detect if has order stats tables |
| [647](#L647) | global $wpdb; |
| [648](#L648) | $table\_name = $wpdb->prefix.'wc\_order\_stats'; |
| [649](#L649) | $query = $wpdb->prepare( 'SHOW TABLES LIKE %s', $wpdb->esc\_like( $table\_name ) ); |
| [650](#L650) | self::$has\_order\_stats = ($wpdb->get\_var( $query ) == $table\_name); |
| [651](#L651) |  |
| [652](#L652) | //to support Origin, since WC 8.5 |
| [653](#L653) | self::set\_order\_meta\_field\_prefix(); |
| [654](#L654) | } |
| [655](#L655) |  |
| [656](#L656) | //for debug |
| [657](#L657) | public static function start\_track\_queries() { |
| [658](#L658) | self::$track\_sql\_queries = true; |
| [659](#L659) | self::$sql\_queries       = array(); |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | public static function get\_sql\_queries() { |
| [663](#L663) | return self::$sql\_queries; |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | //for csv/excel |
| [667](#L667) | public static function get\_max\_order\_items( $type, $ids ) { |
| [668](#L668) | global $wpdb; |
| [669](#L669) |  |
| [670](#L670) | $ids[] = 0; // for safe |
| [671](#L671) | $ids   = join( ",", $ids ); |
| [672](#L672) | $sql = "SELECT COUNT( \* ) AS t |
| [673](#L673) | FROM  `{$wpdb->prefix}woocommerce\_order\_items` |
| [674](#L674) | WHERE order\_item\_type =  '$type' |
| [675](#L675) | AND order\_id |
| [676](#L676) | IN ( $ids) |
| [677](#L677) | GROUP BY order\_id |
| [678](#L678) | ORDER BY t DESC |
| [679](#L679) | LIMIT 1"; |
| [680](#L680) |  |
| [681](#L681) | $max = $wpdb->get\_var( $sql ); |
| [682](#L682) | if ( ! $max ) { |
| [683](#L683) | $max = 1; |
| [684](#L684) | } |
| [685](#L685) |  |
| [686](#L686) | return apply\_filters( 'woe\_get\_max\_order\_items\_'.$type, $max); |
| [687](#L687) | } |
| [688](#L688) |  |
| [689](#L689) | public static function fetch\_order\_coupons( |
| [690](#L690) | $order, |
| [691](#L691) | $labels, |
| [692](#L692) | $static\_vals, |
| [693](#L693) | $options |
| [694](#L694) | ) { |
| [695](#L695) | global $wpdb; |
| [696](#L696) | $coupons = array(); |
| [697](#L697) | foreach ( $order->get\_items( 'coupon' ) as $item ) { |
| [698](#L698) | $row = array(); |
| [699](#L699) | $coupon = new WC\_Order\_Export\_Order\_Coupon\_Fields( $item, $labels, $static\_vals ); |
| [700](#L700) | foreach ( $labels->unique\_keys() as $field ) { |
| [701](#L701) | $row[ $field ] = $coupon->get($field); |
| [702](#L702) |  |
| [703](#L703) | $row[ $field ] = apply\_filters( "woe\_get\_order\_coupon\_value\_{$field}", $row[ $field ], $order, |
| [704](#L704) | $item ); |
| [705](#L705) | } |
| [706](#L706) | $row = apply\_filters( 'woe\_fetch\_order\_coupon', $row, $item, $coupon->get\_coupon\_meta() ); |
| [707](#L707) | if ( $row ) { |
| [708](#L708) | $coupons[] = $row; |
| [709](#L709) | } |
| [710](#L710) | } |
| [711](#L711) |  |
| [712](#L712) | return apply\_filters( "woe\_fetch\_order\_coupons", $coupons, $order, $labels->get\_legacy\_labels(), $format = "", |
| [713](#L713) | $static\_vals ); |
| [714](#L714) | } |
| [715](#L715) |  |
| [716](#L716) |  |
| [717](#L717) | /\*\* |
| [718](#L718) | \* @param WC\_Order                     $order |
| [719](#L719) | \* @param WC\_Order\_Export\_Labels       $labels |
| [720](#L720) | \* @param array                        $static\_vals |
| [721](#L721) | \* @param array                        $options |
| [722](#L722) | \* @param WC\_Order\_Export\_Order\_Fields $woe\_order |
| [723](#L723) | \* |
| [724](#L724) | \* @return array |
| [725](#L725) | \*/ |
| [726](#L726) | public static function fetch\_order\_products( |
| [727](#L727) | $order, |
| [728](#L728) | $labels, |
| [729](#L729) | $static\_vals, |
| [730](#L730) | $options, |
| [731](#L731) | $woe\_order |
| [732](#L732) | ) { |
| [733](#L733) | $export\_only\_products     = $options['include\_products']; |
| [734](#L734) | $export\_matched\_products  = $options['export\_matched\_items']; |
| [735](#L735) | $products                 = array(); |
| [736](#L736) | $i                        = 0; |
| [737](#L737) |  |
| [738](#L738) | foreach ( $order->get\_items( 'line\_item' ) as $item\_id => $item ) { |
| [739](#L739) | /\*\* @var WC\_Order\_Item\_Product $item \*/ |
| [740](#L740) | do\_action( "woe\_get\_order\_product\_item", $item ); |
| [741](#L741) | if ( $options['export\_refunds'] AND $item['qty'] == 0 AND !apply\_filters("woe\_allow\_export\_zero\_qty", false) ) // skip zero items, when export refunds |
| [742](#L742) | { |
| [743](#L743) | continue; |
| [744](#L744) | } |
| [745](#L745) | // we export only matched products? |
| [746](#L746) | if ( $export\_only\_products AND |
| [747](#L747) | ! in\_array( $item['product\_id'], $export\_only\_products ) AND // not  product |
| [748](#L748) | ( ! $item['variation\_id'] OR ! in\_array( $item['variation\_id'], |
| [749](#L749) | $export\_only\_products ) )  // not variation |
| [750](#L750) | ) { |
| [751](#L751) | continue; |
| [752](#L752) | } |
| [753](#L753) |  |
| [754](#L754) | if( $export\_matched\_products ) { |
| [755](#L755) | foreach ( $export\_matched\_products['item\_metadata'] as $operator => $fields ) { |
| [756](#L756) | foreach ( $fields as $field => $values ) { |
| [757](#L757) | if ( $values ) { |
| [758](#L758) | self::extract\_item\_type\_and\_key( $field, $type, $key ); |
| [759](#L759) | if($type != 'line\_item') { |
| [760](#L760) | continue; |
| [761](#L761) | } |
| [762](#L762) | $meta = wc\_get\_order\_item\_meta( $item\_id, $key ); |
| [763](#L763) | if(($operator == 'IN' AND !in\_array($meta, $values)) OR |
| [764](#L764) | ($operator == 'NOT IN' AND in\_array($meta, $values))) { |
| [765](#L765) | continue 3; |
| [766](#L766) | } |
| [767](#L767) | else if($operator == 'LIKE') { |
| [768](#L768) | $matched\_like = false; |
| [769](#L769) | foreach ($values as $value) { |
| [770](#L770) | if(strpos($meta, $value) !== false) { |
| [771](#L771) | $matched\_like = true; |
| [772](#L772) | continue; |
| [773](#L773) | } |
| [774](#L774) | } |
| [775](#L775) | if(!$matched\_like) { |
| [776](#L776) | continue 3; |
| [777](#L777) | } |
| [778](#L778) | } |
| [779](#L779) | else if($operator == 'IS SET' && $meta === '') { |
| [780](#L780) | continue 3; |
| [781](#L781) | } |
| [782](#L782) | else if($operator == 'NOT SET' && $meta !== '') { |
| [783](#L783) | continue 3; |
| [784](#L784) | } |
| [785](#L785) | else if(in\_array($operator, self::$operator\_must\_check\_values)) { |
| [786](#L786) | if(empty($meta)) { |
| [787](#L787) | continue 3; |
| [788](#L788) | } |
| [789](#L789) | $matched = false; |
| [790](#L790) | foreach ($values as $value) { |
| [791](#L791) | if(version\_compare($meta, $value, $operator)) { |
| [792](#L792) | $matched = true; |
| [793](#L793) | continue; |
| [794](#L794) | } |
| [795](#L795) | } |
| [796](#L796) | if(!$matched) { |
| [797](#L797) | continue 3; |
| [798](#L798) | } |
| [799](#L799) | } |
| [800](#L800) | } |
| [801](#L801) | } |
| [802](#L802) | } |
| [803](#L803) | foreach ( $export\_matched\_products['item\_names'] as $operator => $fields ) { |
| [804](#L804) | foreach ( $fields as $field => $values ) { |
| [805](#L805) | if ( $values ) { |
| [806](#L806) | if($field != 'line\_item') { |
| [807](#L807) | continue; |
| [808](#L808) | } |
| [809](#L809) | $item\_name = $item->get\_name(); |
| [810](#L810) | if(($operator == 'IN' AND !in\_array($item\_name, $values)) OR |
| [811](#L811) | ($operator == 'NOT IN' AND in\_array($item\_name, $values))) { |
| [812](#L812) | continue 3; |
| [813](#L813) | } |
| [814](#L814) | else if($operator == 'LIKE') { |
| [815](#L815) | $matched\_like = false; |
| [816](#L816) | foreach ($values as $value) { |
| [817](#L817) | if(strpos($item\_name, $value) !== false) { |
| [818](#L818) | $matched\_like = true; |
| [819](#L819) | continue; |
| [820](#L820) | } |
| [821](#L821) | } |
| [822](#L822) | if(!$matched\_like) { |
| [823](#L823) | continue 3; |
| [824](#L824) | } |
| [825](#L825) | } |
| [826](#L826) | } |
| [827](#L827) | } |
| [828](#L828) | } |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | $product   = $item->get\_product(); |
| [832](#L832) | $product   = apply\_filters( "woe\_get\_order\_product", $product ); |
| [833](#L833) |  |
| [834](#L834) | $item\_meta = get\_metadata( 'order\_item', $item\_id ); |
| [835](#L835) | foreach ( $item\_meta as $key => $value ) { |
| [836](#L836) | $clear\_key = wc\_sanitize\_taxonomy\_name( $key ); |
| [837](#L837) | if ( taxonomy\_exists( $clear\_key ) ) { |
| [838](#L838) | $term                 = get\_term\_by( 'slug', $value[0], $clear\_key ); |
| [839](#L839) | $item\_meta[ $key ][0] = isset( $term->name ) ? $term->name : $value[0]; |
| [840](#L840) | if ( strpos( $key, 'attribute\_' ) === false ) { |
| [841](#L841) | $item\_meta[ 'attribute\_' . $key ][0] = isset( $term->name ) ? $term->name : $value[0]; |
| [842](#L842) | } |
| [843](#L843) | } |
| [844](#L844) |  |
| [845](#L845) | //some plugins encode meta keys! |
| [846](#L846) | $key2 = html\_entity\_decode ($key,ENT\_QUOTES); |
| [847](#L847) | if( !isset($item\_meta[$key2]) ) |
| [848](#L848) | $item\_meta[$key2] = $item\_meta[$key]; |
| [849](#L849) | } |
| [850](#L850) |  |
| [851](#L851) | $item\_meta = apply\_filters( "woe\_get\_order\_product\_item\_meta", $item\_meta ); |
| [852](#L852) | $product   = apply\_filters( "woe\_get\_order\_product\_and\_item\_meta", $product, $item\_meta ); |
| [853](#L853) | if ( $product ) { |
| [854](#L854) | if ( method\_exists( $product, 'get\_id' ) ) { |
| [855](#L855) | if ( $product->is\_type( 'variation' ) ) { |
| [856](#L856) | $product\_id = method\_exists( $product, |
| [857](#L857) | 'get\_parent\_id' ) ? $product->get\_parent\_id() : $product->parent->id; |
| [858](#L858) | } else { |
| [859](#L859) | $product\_id = $product->get\_id(); |
| [860](#L860) | } |
| [861](#L861) | $post = get\_post( $product\_id ); |
| [862](#L862) | } else {    // legacy |
| [863](#L863) | $product\_id = $product->id; |
| [864](#L864) | $post       = $product->post; |
| [865](#L865) | } |
| [866](#L866) | } else { |
| [867](#L867) | $product\_id = 0; |
| [868](#L868) | $post       = false; |
| [869](#L869) | } |
| [870](#L870) |  |
| [871](#L871) | // skip based on products/items/meta |
| [872](#L872) | if ( apply\_filters( 'woe\_skip\_order\_item', false, $product, $item, $item\_meta, $post ) ) { |
| [873](#L873) | continue; |
| [874](#L874) | } |
| [875](#L875) |  |
| [876](#L876) | if ( $options['skip\_refunded\_items'] ) { |
| [877](#L877) | $qty\_minus\_refund = $item\_meta["\_qty"][0] + $order->get\_qty\_refunded\_for\_item( $item\_id ); // Yes we add negative! qty |
| [878](#L878) | if ( $qty\_minus\_refund <= 0 ) { |
| [879](#L879) | continue; |
| [880](#L880) | } |
| [881](#L881) | } |
| [882](#L882) |  |
| [883](#L883) | $i ++; |
| [884](#L884) | $row = array(); |
| [885](#L885) | $woe\_product = new WC\_Order\_Export\_Order\_Product\_Fields( $item, $item\_meta, $product, $order, $post, $i, $static\_vals, $options, $woe\_order ); |
| [886](#L886) | foreach ( $labels->unique\_keys() as $field ) { |
| [887](#L887) | $row[$field] = $woe\_product->get($field); |
| [888](#L888) | } |
| [889](#L889) | $row = apply\_filters( 'woe\_fetch\_order\_product', $row, $order, $item, $product, $item\_meta ); |
| [890](#L890) | if ( $row ) { |
| [891](#L891) | $products[ $item\_id ] = $row; |
| [892](#L892) | } |
| [893](#L893) | } |
| [894](#L894) |  |
| [895](#L895) | return apply\_filters( "woe\_fetch\_order\_products", $products, $order, $labels->get\_legacy\_labels(), $format = "", |
| [896](#L896) | $static\_vals ); |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | /\*\* |
| [900](#L900) | \* @param $product WC\_Product |
| [901](#L901) | \* |
| [902](#L902) | \* @return string |
| [903](#L903) | \*/ |
| [904](#L904) | /\*\* |
| [905](#L905) | \* @param $order WC\_Order |
| [906](#L906) | \* @param $item\_id |
| [907](#L907) | \* |
| [908](#L908) | \* @return int |
| [909](#L909) | \*/ |
| [910](#L910) | public static function get\_order\_item\_taxes\_refund( $order, $item\_id ) { |
| [911](#L911) | $tax\_refund  = 0; |
| [912](#L912) | $order\_taxes = $order->get\_taxes(); |
| [913](#L913) | foreach ( $order\_taxes as $tax\_item ) { |
| [914](#L914) | $tax\_item\_id = $tax\_item['rate\_id']; |
| [915](#L915) | $tax\_refund  += $order->get\_tax\_refunded\_for\_item( $item\_id, $tax\_item\_id ); |
| [916](#L916) | } |
| [917](#L917) |  |
| [918](#L918) | return $tax\_refund; |
| [919](#L919) | } |
| [920](#L920) |  |
| [921](#L921) | public static function fetch\_order\_data( |
| [922](#L922) | $order\_id, |
| [923](#L923) | $labels, |
| [924](#L924) | $export, |
| [925](#L925) | $static\_vals, |
| [926](#L926) | $options |
| [927](#L927) | ) { |
| [928](#L928) | global $wp\_roles; |
| [929](#L929) | global $wpdb; |
| [930](#L930) |  |
| [931](#L931) | //              $extra\_rows = array(); |
| [932](#L932) | $row = array(); |
| [933](#L933) | // take order |
| [934](#L934) | $class = apply\_filters( 'woe\_get\_class\_name', 'WC\_Order' ); |
| [935](#L935) | $object = new $class( $order\_id ); |
| [936](#L936) | self::$current\_order = $order = apply\_filters( "woe\_get\_order\_by\_object", $object, $order\_id ); |
| [937](#L937) |  |
| [938](#L938) | $woe\_order = new WC\_Order\_Export\_Order\_Fields( $order, $static\_vals, $options, $export ); |
| [939](#L939) |  |
| [940](#L940) | // we know parent! |
| [941](#L941) | if ( ( $export['products'] || $options['include\_products'] ) && $labels['products']->is\_not\_empty() || |
| [942](#L942) | isset( $labels['order']->count\_unique\_products ) || isset( $labels['order']->total\_weight\_items ) ) { |
| [943](#L943) | //   no labels for products?? |
| [944](#L944) | $tmp\_labels = $labels['products']->is\_not\_empty() ? clone $labels['products'] : new WC\_Order\_Export\_Labels(); |
| [945](#L945) | //need qty? |
| [946](#L946) | if ( isset( $labels['order']->total\_weight\_items ) || isset( $labels['order']->count\_unique\_products ) ) { |
| [947](#L947) | if ( ! isset( $tmp\_labels->qty ) ) { |
| [948](#L948) | $tmp\_labels->qty = ""; |
| [949](#L949) | } |
| [950](#L950) | } |
| [951](#L951) | // need weight too? |
| [952](#L952) | if ( isset( $labels['order']->total\_weight\_items ) ) { |
| [953](#L953) | if ( ! isset( $tmp\_labels->weight ) ) { |
| [954](#L954) | $tmp\_labels->weight = ""; |
| [955](#L955) | } |
| [956](#L956) | } |
| [957](#L957) |  |
| [958](#L958) | $data['products'] = self::fetch\_order\_products( |
| [959](#L959) | $order, |
| [960](#L960) | $tmp\_labels, |
| [961](#L961) | isset( $static\_vals['products'] ) ? $static\_vals['products'] : array(), |
| [962](#L962) | $options, |
| [963](#L963) | $woe\_order |
| [964](#L964) | ); |
| [965](#L965) | if ( $options['include\_products'] AND empty( $data['products'] ) AND apply\_filters( "woe\_skip\_order\_without\_products", false ) ) { |
| [966](#L966) | return array(); |
| [967](#L967) | } |
| [968](#L968) | } else { |
| [969](#L969) | $data['products'] = array(); |
| [970](#L970) | } |
| [971](#L971) | if ( ( $export['coupons'] OR isset( $labels['order']->coupons\_used ) ) && $labels['coupons']->is\_not\_empty() ) { |
| [972](#L972) | // get coupons from main order |
| [973](#L973) | $data['coupons'] = self::fetch\_order\_coupons( |
| [974](#L974) | $woe\_order->get\_parent\_order() ? $woe\_order->get\_parent\_order() : $order, |
| [975](#L975) | $labels['coupons'], |
| [976](#L976) | isset( $static\_vals['coupons'] ) ? $static\_vals['coupons'] : array(), |
| [977](#L977) | $options |
| [978](#L978) | ); |
| [979](#L979) | } else { |
| [980](#L980) | $data['coupons'] = array(); |
| [981](#L981) | } |
| [982](#L982) |  |
| [983](#L983) | $woe\_order->set\_data($data); |
| [984](#L984) | // fill as it must |
| [985](#L985) | foreach ( $labels['order']->get\_fetch\_fields() as $field ) { |
| [986](#L986) | $row = $woe\_order->get($row, $field); |
| [987](#L987) | //use empty value for missed field |
| [988](#L988) | if ( $field != 'products' AND $field != 'coupons' ) { |
| [989](#L989) | if ( ! isset( $row[ $field ] ) ) { |
| [990](#L990) | $row[ $field ] = ''; |
| [991](#L991) | } |
| [992](#L992) | if ( is\_array( $row[ $field ] ) ) { |
| [993](#L993) | $row[ $field ] = json\_encode( $row[ $field ] ); |
| [994](#L994) | } |
| [995](#L995) |  |
| [996](#L996) | if ( $options['convert\_serialized\_values'] AND is\_serialized($row[ $field ]) ) { |
| [997](#L997) | $arr = unserialize( trim($row[ $field ]), ['allowed\_classes' => false] ); |
| [998](#L998) | if ( is\_array($arr) ) $row[$field] = join(",", $arr); |
| [999](#L999) | } |
| [1000](#L1000) | } |
| [1001](#L1001) | if ( isset( $row[ $field ] ) ) { |
| [1002](#L1002) | $row[ $field ] = apply\_filters( "woe\_get\_order\_value\_{$field}", $row[ $field ], $order, $field, $object ); |
| [1003](#L1003) | } //if order field set |
| [1004](#L1004) | } |
| [1005](#L1005) |  |
| [1006](#L1006) | //no labels - no data ! |
| [1007](#L1007) | if (  $labels['products']->is\_not\_empty() == false ) { |
| [1008](#L1008) | $row['products'] = array(); |
| [1009](#L1009) | } |
| [1010](#L1010) | if ( $labels['coupons']->is\_not\_empty() == false ) { |
| [1011](#L1011) | $row['coupons'] = array(); |
| [1012](#L1012) | } |
| [1013](#L1013) |  |
| [1014](#L1014) | if ($options['strip\_html\_tags']) { |
| [1015](#L1015) | array\_walk\_recursive($row, function (&$item, $key) { |
| [1016](#L1016) | $item = strip\_tags($item); |
| [1017](#L1017) | }); |
| [1018](#L1018) | } |
| [1019](#L1019) | $row = apply\_filters( "woe\_fetch\_order", $row, $order, $object ); |
| [1020](#L1020) |  |
| [1021](#L1021) | return $row; |
| [1022](#L1022) | } |
| [1023](#L1023) |  |
| [1024](#L1024) | public static function get\_city\_state\_postcode\_field\_value( $order, $type, $us\_format = false ) { |
| [1025](#L1025) | if ( $type != 'shipping' && $type != 'billing' ) { |
| [1026](#L1026) | return null; |
| [1027](#L1027) | } |
| [1028](#L1028) | $citystatepostcode\_fields\_name = array( |
| [1029](#L1029) | $type . '\_city', |
| [1030](#L1030) | $type . '\_state', |
| [1031](#L1031) | $type . '\_postcode', |
| [1032](#L1032) | ); |
| [1033](#L1033) | $citystatepostcode             = array(); |
| [1034](#L1034) | foreach ( $citystatepostcode\_fields\_name as $field\_name ) { |
| [1035](#L1035) | $citystatepostcode[ $field\_name ] = method\_exists( $order, |
| [1036](#L1036) | 'get\_' . $field\_name ) ? $order->{'get\_' . $field\_name}() : $order->{$field\_name}; |
| [1037](#L1037) | } |
| [1038](#L1038) |  |
| [1039](#L1039) | if ( $us\_format ) { |
| [1040](#L1040) | //reformat as "Austin, TX 95076" |
| [1041](#L1041) | $parts[] = $citystatepostcode[ $type . '\_city' ]; |
| [1042](#L1042) | $parts[] = trim( $citystatepostcode[ $type . '\_state' ] . " " . $citystatepostcode[ $type . '\_postcode' ] ); |
| [1043](#L1043) | } else { |
| [1044](#L1044) | $parts = $citystatepostcode; |
| [1045](#L1045) | } |
| [1046](#L1046) |  |
| [1047](#L1047) | return join( ", ", $parts ); |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | public static function get\_order\_subtotal\_refunded( $order ) { |
| [1051](#L1051) | $subtotal\_refund = 0; |
| [1052](#L1052) | foreach ( $order->get\_refunds() as $refund ) { |
| [1053](#L1053) | $subtotal\_refund += $refund->get\_subtotal(); |
| [1054](#L1054) | } |
| [1055](#L1055) |  |
| [1056](#L1056) | return abs( $subtotal\_refund ); |
| [1057](#L1057) | } |
| [1058](#L1058) |  |
| [1059](#L1059) | /\*\* |
| [1060](#L1060) | \* @return string |
| [1061](#L1061) | \*/ |
| [1062](#L1062) | public static function get\_product\_variation( $item, $order, $item\_id, $product ) { |
| [1063](#L1063) | global $wpdb; |
| [1064](#L1064) | $hidden\_order\_itemmeta = apply\_filters( 'woocommerce\_hidden\_order\_itemmeta', array( |
| [1065](#L1065) | '\_qty', |
| [1066](#L1066) | '\_tax\_class', |
| [1067](#L1067) | '\_product\_id', |
| [1068](#L1068) | '\_variation\_id', |
| [1069](#L1069) | '\_line\_subtotal', |
| [1070](#L1070) | '\_line\_subtotal\_tax', |
| [1071](#L1071) | '\_line\_total', |
| [1072](#L1072) | '\_line\_tax', |
| [1073](#L1073) | 'method\_id', |
| [1074](#L1074) | 'cost', |
| [1075](#L1075) | '\_reduced\_stock', |
| [1076](#L1076) | ) ); |
| [1077](#L1077) |  |
| [1078](#L1078) | $formatted\_meta = array(); |
| [1079](#L1079) | // pull meta directly |
| [1080](#L1080) | $meta\_data = $wpdb->get\_results( $wpdb->prepare( "SELECT meta\_key, meta\_value, meta\_id, order\_item\_id |
| [1081](#L1081) | FROM {$wpdb->prefix}woocommerce\_order\_itemmeta WHERE order\_item\_id = %d |
| [1082](#L1082) | ORDER BY meta\_id", $item\_id ), ARRAY\_A ); |
| [1083](#L1083) | foreach ( $meta\_data as $meta ) { |
| [1084](#L1084) | if ( in\_array( $meta['meta\_key'], $hidden\_order\_itemmeta ) ) { |
| [1085](#L1085) | continue; |
| [1086](#L1086) | } |
| [1087](#L1087) | if ( substr( $meta['meta\_key'],0,1) == "\_" AND apply\_filters("woe\_hide\_itemmeta\_starting\_with\_underscore", true) ) { |
| [1088](#L1088) | continue; |
| [1089](#L1089) | } |
| [1090](#L1090) | if ( is\_serialized( $meta['meta\_value'] ) ) { |
| [1091](#L1091) | continue; |
| [1092](#L1092) | } |
| [1093](#L1093) |  |
| [1094](#L1094) | //known attribute? |
| [1095](#L1095) | if ( taxonomy\_exists( wc\_sanitize\_taxonomy\_name( $meta['meta\_key'] ) ) ) { |
| [1096](#L1096) | $term               = get\_term\_by( 'slug', $meta['meta\_value'], |
| [1097](#L1097) | wc\_sanitize\_taxonomy\_name( $meta['meta\_key'] ) ); |
| [1098](#L1098) | $meta['meta\_key']   = wc\_attribute\_label( wc\_sanitize\_taxonomy\_name( $meta['meta\_key'] ), $product ); |
| [1099](#L1099) | $meta['meta\_value'] = isset( $term->name ) ? $term->name : $meta['meta\_value']; |
| [1100](#L1100) | } else { |
| [1101](#L1101) | $meta['meta\_key'] = wc\_attribute\_label( $meta['meta\_key'], $product ); |
| [1102](#L1102) | } |
| [1103](#L1103) |  |
| [1104](#L1104) | $formatted\_meta[ $meta['meta\_id'] ] = (object) array( |
| [1105](#L1105) | 'key'           => $meta['meta\_key'], |
| [1106](#L1106) | 'value'         => $meta['meta\_value'], |
| [1107](#L1107) | 'display\_key'   => wp\_kses\_post( $meta['meta\_key']), |
| [1108](#L1108) | 'display\_value' => wp\_kses\_post( force\_balance\_tags( $meta['meta\_value'] ) ), |
| [1109](#L1109) | ); |
| [1110](#L1110) | } |
| [1111](#L1111) |  |
| [1112](#L1112) | //aplly woocommerce filters from addons plugins |
| [1113](#L1113) | $formatted\_meta = apply\_filters( 'woocommerce\_order\_item\_get\_formatted\_meta\_data', $formatted\_meta, $item); |
| [1114](#L1114) |  |
| [1115](#L1115) | $value\_delimiter = apply\_filters( 'woe\_fetch\_item\_meta\_value\_delimiter', ': ' ); |
| [1116](#L1116) |  |
| [1117](#L1117) | $result = array(); |
| [1118](#L1118) | foreach($formatted\_meta as $meta) { |
| [1119](#L1119) | $meta->display\_key = trim(strip\_tags($meta->display\_key)); |
| [1120](#L1120) | if ( apply\_filters("woe\_remove\_html\_in\_itemmeta", true) ) |
| [1121](#L1121) | $meta->display\_value = trim(strip\_tags($meta->display\_value)); |
| [1122](#L1122) | $result[] = apply\_filters( 'woe\_fetch\_item\_meta', $meta->display\_key . $value\_delimiter . $meta->display\_value, $meta, $item, $product ); |
| [1123](#L1123) | } |
| [1124](#L1124) | //list to string! |
| [1125](#L1125) | return join( apply\_filters( 'woe\_fetch\_item\_meta\_lines\_delimiter', ' | ' ), array\_filter( $result ) ); |
| [1126](#L1126) | } |
| [1127](#L1127) |  |
| [1128](#L1128) | /\*\* |
| [1129](#L1129) | \* @return array |
| [1130](#L1130) | \*/ |
| [1131](#L1131) | public static function get\_shipping\_methods() { |
| [1132](#L1132) | global $wpdb; |
| [1133](#L1133) |  |
| [1134](#L1134) | $shipping\_methods = array(); |
| [1135](#L1135) |  |
| [1136](#L1136) | // get raw names |
| [1137](#L1137) | $raw\_methods = self::get\_order\_shipping\_items(); |
| [1138](#L1138) | foreach ( $raw\_methods as $method ) { |
| [1139](#L1139) | $shipping\_methods[ 'order\_item\_name:' . $method ] = $method; |
| [1140](#L1140) | } |
| [1141](#L1141) |  |
| [1142](#L1142) | // try get  methods for zones |
| [1143](#L1143) | if ( ! class\_exists( "WC\_Shipping\_Zone" ) ) { |
| [1144](#L1144) | return $shipping\_methods; |
| [1145](#L1145) | } |
| [1146](#L1146) |  |
| [1147](#L1147) | if ( ! method\_exists( "WC\_Shipping\_Zone", "get\_shipping\_methods" ) ) { |
| [1148](#L1148) | return $shipping\_methods; |
| [1149](#L1149) | } |
| [1150](#L1150) |  |
| [1151](#L1151) | $shipping\_methods\_zones = array(); |
| [1152](#L1152) | foreach ( WC\_Shipping\_Zones::get\_zones() as $zone ) { |
| [1153](#L1153) | $methods = $zone['shipping\_methods']; |
| [1154](#L1154) | /\*\* @var WC\_Shipping\_Method $method \*/ |
| [1155](#L1155) | foreach ( $methods as $method ) { |
| [1156](#L1156) | $shipping\_methods[ 'order\_item\_name:' . $method->get\_title()] = $method->get\_title(); |
| [1157](#L1157) | $shipping\_methods\_zones[ $method->get\_rate\_id() ] = '[' . $zone['zone\_name'] . '] ' . $method->get\_title(); |
| [1158](#L1158) | } |
| [1159](#L1159) | } |
| [1160](#L1160) |  |
| [1161](#L1161) | $zone    = new WC\_Shipping\_Zone( 0 ); |
| [1162](#L1162) | $methods = $zone->get\_shipping\_methods(); |
| [1163](#L1163) | /\*\* @var WC\_Shipping\_Method $method \*/ |
| [1164](#L1164) | foreach ( $methods as $method ) { |
| [1165](#L1165) | $shipping\_methods[ 'order\_item\_name:' . $method->get\_title()] = $method->get\_title(); |
| [1166](#L1166) | $shipping\_methods\_zones[ $method->get\_rate\_id() ] = \_\_( '[Rest of the World]', |
| [1167](#L1167) | 'woo-order-export-lite' ) . ' ' . $method->get\_title(); |
| [1168](#L1168) | } |
| [1169](#L1169) |  |
| [1170](#L1170) | asort( $shipping\_methods, SORT\_STRING); |
| [1171](#L1171) | return apply\_filters("woe\_get\_shipping\_methods", $shipping\_methods + $shipping\_methods\_zones); |
| [1172](#L1172) | } |
| [1173](#L1173) |  |
| [1174](#L1174) | public static function get\_shipping\_zone( $order ) { |
| [1175](#L1175) | $ship\_methods = self::get\_shipping\_methods(); |
| [1176](#L1176) | $value = \_\_( 'Rest of the World','woo-order-export-lite' ); |
| [1177](#L1177) | $methods = $order->get\_items('shipping'); |
| [1178](#L1178) | $method = reset ($methods ); |
| [1179](#L1179) | if( $method ) { |
| [1180](#L1180) | $key = $method['method\_id'] . ":" . $method['instance\_id']; |
| [1181](#L1181) | // parse text "[Zone] Method name" |
| [1182](#L1182) | if ( isset($ship\_methods[$key]) AND preg\_match('#\[(.+?)\]#',$ship\_methods[$key],$m) ) { |
| [1183](#L1183) | $value = $m[1]; |
| [1184](#L1184) | } |
| [1185](#L1185) | } |
| [1186](#L1186) | return $value; |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | // Following functions copied from \woocommerce\src\Internal\Traits\OrderAttributionMeta.php |
| [1190](#L1190) | /\*\* |
| [1191](#L1191) | \* Output the translated origin label for the Origin column in the orders table. |
| [1192](#L1192) | \* |
| [1193](#L1193) | \* Default to "Unknown" if no origin is set. |
| [1194](#L1194) | \* |
| [1195](#L1195) | \* @param WC\_Order $order The order object. |
| [1196](#L1196) | \* |
| [1197](#L1197) | \* @return string |
| [1198](#L1198) | \*/ |
| [1199](#L1199) | public static function get\_origin\_for\_order( $order ) { |
| [1200](#L1200) | $source\_type = $order->get\_meta( self::get\_meta\_prefixed\_field( 'type' ) ); |
| [1201](#L1201) | $source      = $order->get\_meta( self::get\_meta\_prefixed\_field( 'utm\_source' ) ); |
| [1202](#L1202) | $origin      = self::get\_origin\_label( $source\_type, $source ); |
| [1203](#L1203) | if ( empty( $origin ) ) { |
| [1204](#L1204) | $origin = \_\_( 'Unknown', 'woocommerce' ); |
| [1205](#L1205) | } |
| [1206](#L1206) | return esc\_html( $origin ); |
| [1207](#L1207) | } |
| [1208](#L1208) |  |
| [1209](#L1209) | /\*\* |
| [1210](#L1210) | \* Get the label for the Order origin with placeholder where appropriate. Can be |
| [1211](#L1211) | \* translated (for DB / display) or untranslated (for Tracks). |
| [1212](#L1212) | \* |
| [1213](#L1213) | \* @param string $source\_type The source type. |
| [1214](#L1214) | \* @param string $source      The source. |
| [1215](#L1215) | \* @param bool   $translated  Whether the label should be translated. |
| [1216](#L1216) | \* |
| [1217](#L1217) | \* @return string |
| [1218](#L1218) | \*/ |
| [1219](#L1219) | public static function get\_origin\_label( string $source\_type, string $source, bool $translated = true ): string { |
| [1220](#L1220) | // Set up the label based on the source type. |
| [1221](#L1221) | switch ( $source\_type ) { |
| [1222](#L1222) | case 'utm': |
| [1223](#L1223) | $label = $translated ? |
| [1224](#L1224) | /\* translators: %s is the source value \*/ |
| [1225](#L1225) | \_\_( 'Source: %s', 'woocommerce' ) |
| [1226](#L1226) | : 'Source: %s'; |
| [1227](#L1227) | break; |
| [1228](#L1228) | case 'organic': |
| [1229](#L1229) | $label = $translated ? |
| [1230](#L1230) | /\* translators: %s is the source value \*/ |
| [1231](#L1231) | \_\_( 'Organic: %s', 'woocommerce' ) |
| [1232](#L1232) | : 'Organic: %s'; |
| [1233](#L1233) | break; |
| [1234](#L1234) | case 'referral': |
| [1235](#L1235) | $label = $translated ? |
| [1236](#L1236) | /\* translators: %s is the source value \*/ |
| [1237](#L1237) | \_\_( 'Referral: %s', 'woocommerce' ) |
| [1238](#L1238) | : 'Referral: %s'; |
| [1239](#L1239) | break; |
| [1240](#L1240) | case 'typein': |
| [1241](#L1241) | $label  = ''; |
| [1242](#L1242) | $source = $translated ? |
| [1243](#L1243) | \_\_( 'Direct', 'woocommerce' ) |
| [1244](#L1244) | : 'Direct'; |
| [1245](#L1245) | break; |
| [1246](#L1246) | case 'mobile\_app': |
| [1247](#L1247) | $label  = ''; |
| [1248](#L1248) | $source = $translated ? |
| [1249](#L1249) | \_\_( 'Mobile app', 'woocommerce' ) |
| [1250](#L1250) | : 'Mobile app'; |
| [1251](#L1251) | break; |
| [1252](#L1252) | case 'admin': |
| [1253](#L1253) | $label  = ''; |
| [1254](#L1254) | $source = $translated ? |
| [1255](#L1255) | \_\_( 'Web admin', 'woocommerce' ) |
| [1256](#L1256) | : 'Web admin'; |
| [1257](#L1257) | break; |
| [1258](#L1258) |  |
| [1259](#L1259) | default: |
| [1260](#L1260) | $label  = ''; |
| [1261](#L1261) | $source = $translated ? |
| [1262](#L1262) | \_\_( 'Unknown', 'woocommerce' ) |
| [1263](#L1263) | : 'Unknown'; |
| [1264](#L1264) | break; |
| [1265](#L1265) | } |
| [1266](#L1266) |  |
| [1267](#L1267) | /\*\* |
| [1268](#L1268) | \* Filter the formatted source for the order origin. |
| [1269](#L1269) | \* |
| [1270](#L1270) | \* @since 8.5.0 |
| [1271](#L1271) | \* |
| [1272](#L1272) | \* @param string $formatted\_source The formatted source. |
| [1273](#L1273) | \* @param string $source           The source. |
| [1274](#L1274) | \*/ |
| [1275](#L1275) | $formatted\_source = apply\_filters( |
| [1276](#L1276) | 'wc\_order\_attribution\_origin\_formatted\_source', |
| [1277](#L1277) | ucfirst( trim( $source, '()' ) ), |
| [1278](#L1278) | $source |
| [1279](#L1279) | ); |
| [1280](#L1280) |  |
| [1281](#L1281) | /\*\* |
| [1282](#L1282) | \* Filter the label for the order origin. |
| [1283](#L1283) | \* |
| [1284](#L1284) | \* This label should have a %s placeholder for the formatted source to be inserted |
| [1285](#L1285) | \* via sprintf(). |
| [1286](#L1286) | \* |
| [1287](#L1287) | \* @since 8.5.0 |
| [1288](#L1288) | \* |
| [1289](#L1289) | \* @param string $label            The label for the order origin. |
| [1290](#L1290) | \* @param string $source\_type      The source type. |
| [1291](#L1291) | \* @param string $source           The source. |
| [1292](#L1292) | \* @param string $formatted\_source The formatted source. |
| [1293](#L1293) | \*/ |
| [1294](#L1294) | $label = (string) apply\_filters( |
| [1295](#L1295) | 'wc\_order\_attribution\_origin\_label', |
| [1296](#L1296) | $label, |
| [1297](#L1297) | $source\_type, |
| [1298](#L1298) | $source, |
| [1299](#L1299) | $formatted\_source |
| [1300](#L1300) | ); |
| [1301](#L1301) |  |
| [1302](#L1302) | if ( false === strpos( $label, '%' ) ) { |
| [1303](#L1303) | return $formatted\_source; |
| [1304](#L1304) | } |
| [1305](#L1305) |  |
| [1306](#L1306) | return sprintf( $label, $formatted\_source ); |
| [1307](#L1307) | } |
| [1308](#L1308) |  |
| [1309](#L1309) | /\*\* |
| [1310](#L1310) | \* Get the field name with the meta prefix. |
| [1311](#L1311) | \* |
| [1312](#L1312) | \* @param string $field The field name. |
| [1313](#L1313) | \* |
| [1314](#L1314) | \* @return string The prefixed field name. |
| [1315](#L1315) | \*/ |
| [1316](#L1316) | public static function get\_meta\_prefixed\_field( string $field ): string { |
| [1317](#L1317) | // Map some of the fields to the correct meta name. |
| [1318](#L1318) | if ( 'type' === $field ) { |
| [1319](#L1319) | $field = 'source\_type'; |
| [1320](#L1320) | } elseif ( 'url' === $field ) { |
| [1321](#L1321) | $field = 'referrer'; |
| [1322](#L1322) | } |
| [1323](#L1323) |  |
| [1324](#L1324) | return "\_" . self::get\_prefixed\_field( $field ); |
| [1325](#L1325) | } |
| [1326](#L1326) |  |
| [1327](#L1327) | /\*\* |
| [1328](#L1328) | \* Get the field name with the appropriate prefix. |
| [1329](#L1329) | \* |
| [1330](#L1330) | \* @param string $field Field name. |
| [1331](#L1331) | \* |
| [1332](#L1332) | \* @return string The prefixed field name. |
| [1333](#L1333) | \*/ |
| [1334](#L1334) | public static function get\_prefixed\_field( $field ): string { |
| [1335](#L1335) | return self::$order\_meta\_field\_prefix . $field; |
| [1336](#L1336) | } |
| [1337](#L1337) |  |
| [1338](#L1338) | /\*\* |
| [1339](#L1339) | \* Set the meta prefix for our fields. |
| [1340](#L1340) | \* |
| [1341](#L1341) | \* @return void |
| [1342](#L1342) | \*/ |
| [1343](#L1343) | public static function set\_order\_meta\_field\_prefix(): void { |
| [1344](#L1344) | /\*\* |
| [1345](#L1345) | \* Filter the prefix for the meta fields. |
| [1346](#L1346) | \* |
| [1347](#L1347) | \* @since 8.5.0 |
| [1348](#L1348) | \* |
| [1349](#L1349) | \* @param string $prefix The prefix for the meta fields. |
| [1350](#L1350) | \*/ |
| [1351](#L1351) | $prefix = (string) apply\_filters( |
| [1352](#L1352) | 'wc\_order\_attribution\_tracking\_field\_prefix', |
| [1353](#L1353) | 'wc\_order\_attribution\_' |
| [1354](#L1354) | ); |
| [1355](#L1355) |  |
| [1356](#L1356) | // Remove leading and trailing underscores. |
| [1357](#L1357) | $prefix = trim( $prefix, '\_' ); |
| [1358](#L1358) |  |
| [1359](#L1359) | // Ensure the prefix ends with \_, and set the prefix. |
| [1360](#L1360) | self::$order\_meta\_field\_prefix = "{$prefix}\_"; |
| [1361](#L1361) | } |
| [1362](#L1362) | // Above functions copied from \woocommerce\src\Internal\Traits\OrderAttributionMeta.php |
| [1363](#L1363) |  |
| [1364](#L1364) | /\*\* |
| [1365](#L1365) | \* @return float/int |
| [1366](#L1366) | \*/ |
| [1367](#L1367) | public static function get\_customer\_order\_stats( $order, $statuses, $operation){ |
| [1368](#L1368) | global $wpdb; |
| [1369](#L1369) | $customer\_id = intval ( $wpdb->get\_var( $wpdb->prepare("SELECT customer\_id FROM {$wpdb->prefix}wc\_order\_stats WHERE order\_id = %d", $order->get\_id() ) ) ); |
| [1370](#L1370) | if( !$customer\_id) return 0; |
| [1371](#L1371) | $result = $wpdb->get\_var("SELECT $operation FROM {$wpdb->prefix}wc\_order\_stats WHERE customer\_id = $customer\_id  AND status IN ( $statuses )"); |
| [1372](#L1372) | if(!$result) $result  = 0; // NULL for SUM! |
| [1373](#L1373) | return $result; |
| [1374](#L1374) | } |
| [1375](#L1375) |  |
| [1376](#L1376) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/woo-order-export-lite/trunk/classes/core/trait-woe-core-extractor.php?format=txt)
* [Original Format](/export/3222696/woo-order-export-lite/trunk/classes/core/trait-woe-core-extractor.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


