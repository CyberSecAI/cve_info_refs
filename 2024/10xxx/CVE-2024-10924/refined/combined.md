=== Content from plugins.trac.wordpress.org_09a35379_20250114_204932.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Freally-simple-ssl%2Ftags%2F9.1.1.1%2Fsecurity%2Fwordpress%2Ftwo-fa%2Fclass-rsssl-two-factor-on-board-api.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php)

---

# [source:](/browser?order=name "Go to repository root") [really-simple-ssl](/browser/really-simple-ssl?order=name "View really-simple-ssl")/[tags](/browser/really-simple-ssl/tags?order=name "View tags")/[9.1.1.1](/browser/really-simple-ssl/tags/9.1.1.1?order=name "View 9.1.1.1")/[security](/browser/really-simple-ssl/tags/9.1.1.1/security?order=name "View security")/[wordpress](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress?order=name "View wordpress")/[two-fa](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa?order=name "View two-fa")/[class-rsssl-two-factor-on-board-api.php](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?order=name "View class-rsssl-two-factor-on-board-api.php")

View diff against:

View revision:

| [Last change](/changeset/3182368/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php "View differences") on this file was [3182368](/changeset/3182368/ "View changeset 3182368"), checked in by markwolters, [2 months ago](/timeline?from=2024-11-05T13%3A46%3A27Z&precision=second "See timeline at 11/05/2024 01:46:27 PM") |
| --- |
| prepare for update |
| **File size:** 18.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Handles the API routes for the two-factor authentication onboarding process. |
| [4](#L4) | \* This class is responsible for handling the API routes for the two-factor authentication onboarding process. |
| [5](#L5) | \* It registers the routes and handles the requests. |
| [6](#L6) | \* |
| [7](#L7) | \* @package REALLY\_SIMPLE\_SSL |
| [8](#L8) | \* @subpackage Security\WordPress\Two\_Fa |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) | namespace RSSSL\Security\WordPress\Two\_Fa; |
| [12](#L12) |  |
| [13](#L13) | use WP\_REST\_Request; |
| [14](#L14) | use WP\_REST\_Response; |
| [15](#L15) | use WP\_User; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Registers API routes for the application. |
| [19](#L19) | \* This class is responsible for registering the API routes for the two-factor authentication onboarding process. |
| [20](#L20) | \* It registers the routes and handles the requests. |
| [21](#L21) | \* |
| [22](#L22) | \* @package REALLY\_SIMPLE\_SSL |
| [23](#L23) | \* @subpackage Security\WordPress\Two\_Fa |
| [24](#L24) | \*/ |
| [25](#L25) | class Rsssl\_Two\_Factor\_On\_Board\_Api { |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* The namespace for the API routes. |
| [29](#L29) | \* |
| [30](#L30) | \* @package reallysimplessl/v1/two\_fa |
| [31](#L31) | \*/ |
| [32](#L32) | public const NAMESPACE = 'reallysimplessl/v1/two\_fa'; |
| [33](#L33) |  |
| [34](#L34) | /\*\* |
| [35](#L35) | \* Initializes the object and registers API routes. |
| [36](#L36) | \* |
| [37](#L37) | \* @return void |
| [38](#L38) | \*/ |
| [39](#L39) | public function \_\_construct() { |
| [40](#L40) | add\_action( 'rest\_api\_init', array( $this, 'register\_api\_routes' ) ); |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* Checks if the requested namespace matches our specific namespace and bypasses authentication. |
| [45](#L45) | \* |
| [46](#L46) | \* @param WP\_REST\_Request $request The REST request object. |
| [47](#L47) | \*/ |
| [48](#L48) | private function check\_custom\_validation( WP\_REST\_Request $request ): bool { |
| [49](#L49) | // first check if the $-REQUEST['rest\_route'] is set. |
| [50](#L50) | $params = new Rsssl\_Request\_Parameters( $request ); |
| [51](#L51) | if ( ! isset( $params->login\_nonce ) ) { |
| [52](#L52) | return false; |
| [53](#L53) | } |
| [54](#L54) | return Rsssl\_Two\_Fa\_Authentication::verify\_login\_nonce( $params->user\_id, $params->login\_nonce ); |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | /\*\* |
| [58](#L58) | \* Verifies a login nonce, gets user by the user id, and returns an error response if any steps fail. |
| [59](#L59) | \* |
| [60](#L60) | \* @param int    $user\_id The user ID. |
| [61](#L61) | \* @param string $login\_nonce The login nonce. |
| [62](#L62) | \* |
| [63](#L63) | \* @return WP\_User|WP\_REST\_Response |
| [64](#L64) | \*/ |
| [65](#L65) | private function check\_login\_and\_get\_user( int $user\_id, string $login\_nonce ) { |
| [66](#L66) | if ( ! Rsssl\_Two\_Fa\_Authentication::verify\_login\_nonce( $user\_id, $login\_nonce ) ) { |
| [67](#L67) | return new WP\_REST\_Response( array( 'error' => 'Invalid login nonce' ), 403 ); |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) | /\*\* |
| [71](#L71) | \* Get the user by the user ID. |
| [72](#L72) | \* |
| [73](#L73) | \* @var WP\_User $user |
| [74](#L74) | \*/ |
| [75](#L75) | $user = get\_user\_by( 'id', $user\_id ); |
| [76](#L76) | return $user; |
| [77](#L77) | } |
| [78](#L78) |  |
| [79](#L79) | /\*\* |
| [80](#L80) | \* Sets the authentication cookie and returns a success response. |
| [81](#L81) | \* |
| [82](#L82) | \* @param int    $user\_id The user ID. |
| [83](#L83) | \* @param string $redirect\_to The redirect URL. |
| [84](#L84) | \* |
| [85](#L85) | \* @return WP\_REST\_Response |
| [86](#L86) | \*/ |
| [87](#L87) | private function authenticate\_and\_redirect( int $user\_id, string $redirect\_to = '' ): WP\_REST\_Response { |
| [88](#L88) | // Okay checked the provider now authenticate the user. |
| [89](#L89) | wp\_set\_auth\_cookie( $user\_id, true ); |
| [90](#L90) | // Finally redirect the user to the redirect\_to page or to the home page if the redirect\_to is not set. |
| [91](#L91) | $redirect\_to = $redirect\_to ?: home\_url(); |
| [92](#L92) | return new WP\_REST\_Response( array( 'redirect\_to' => $redirect\_to ), 200 ); |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | /\*\* |
| [96](#L96) | \* Starts the process of email validation for a user. |
| [97](#L97) | \* |
| [98](#L98) | \* @param int $user\_id The ID of the user for whom the email validation process needs to be started. |
| [99](#L99) | \* @param string $redirect\_to The URL to redirect the user after the email validation process. Default is an empty string. |
| [100](#L100) | \* |
| [101](#L101) | \* @return WP\_REST\_Response The REST response object. |
| [102](#L102) | \*/ |
| [103](#L103) | private function start\_email\_validation(int $user\_id, string $redirect\_to = '', $profile = false): WP\_REST\_Response |
| [104](#L104) | { |
| [105](#L105) | $redirect\_to = $redirect\_to ?: home\_url(); |
| [106](#L106) | $user = get\_user\_by('id', $user\_id); |
| [107](#L107) | Rsssl\_Two\_Fa\_Authentication::create\_login\_nonce($user\_id); |
| [108](#L108) | // Sending the email with the code. |
| [109](#L109) | Rsssl\_Two\_Factor\_Email::get\_instance()->generate\_and\_email\_token($user, $profile); |
| [110](#L110) | $token = get\_user\_meta( $user\_id, Rsssl\_Two\_Factor\_Email::RSSSL\_TOKEN\_META\_KEY, true ); |
| [111](#L111) | if ( $redirect\_to === 'profile') { |
| [112](#L112) | return new WP\_REST\_Response( array( 'token' => $token,  'validation\_action' => 'validate\_email\_setup' ), 200 ); |
| [113](#L113) | } |
| [114](#L114) | return new WP\_REST\_Response( array( 'token' => $token, 'redirect\_to' => $redirect\_to, 'validation\_action' => 'validate\_email\_setup' ), 200 ); |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | /\*\* |
| [118](#L118) | \* Sets the user provider as email and redirects the user to the specified page. |
| [119](#L119) | \* |
| [120](#L120) | \* @param WP\_REST\_Request $request The REST request object. |
| [121](#L121) | \* |
| [122](#L122) | \* @return WP\_REST\_Response The REST response object if user is not logged in or provider is invalid. |
| [123](#L123) | \*/ |
| [124](#L124) | public function set\_as\_email( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [125](#L125) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [126](#L126) | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [127](#L127) | // Check if the provider. |
| [128](#L128) | if ( 'email' !== $parameters->provider ) { |
| [129](#L129) | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
| [130](#L130) | } |
| [131](#L131) |  |
| [132](#L132) | // Finally redirect the user to the redirect\_to page with a response. |
| [133](#L133) | return $this->start\_email\_validation( $parameters->user\_id, $parameters->redirect\_to , $parameters->profile ); |
| [134](#L134) | } |
| [135](#L135) |  |
| [136](#L136) | /\*\* |
| [137](#L137) | \* Sets the profile email for a user. |
| [138](#L138) | \* |
| [139](#L139) | \* @param WP\_REST\_Request $request The REST request object. |
| [140](#L140) | \* |
| [141](#L141) | \* @return WP\_REST\_Response The REST response object. |
| [142](#L142) | \*/ |
| [143](#L143) | public function set\_profile\_email(WP\_REST\_Request $request ): WP\_REST\_Response { |
| [144](#L144) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [145](#L145) | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [146](#L146) | // Check if the provider. |
| [147](#L147) | if ( 'email' !== $parameters->provider ) { |
| [148](#L148) | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | // Finally redirect the user to the redirect\_to page with a response. |
| [152](#L152) | return $this->start\_email\_validation( $parameters->user\_id, $parameters->redirect\_to, $parameters->profile ); |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | /\*\* |
| [156](#L156) | \* Validates the email setup for a user. |
| [157](#L157) | \* |
| [158](#L158) | \* @param WP\_REST\_Request $request The REST request object. |
| [159](#L159) | \* |
| [160](#L160) | \* @return WP\_REST\_Response The REST response object. |
| [161](#L161) | \*/ |
| [162](#L162) | public function validate\_email\_setup(WP\_REST\_Request $request ): WP\_REST\_Response { |
| [163](#L163) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [164](#L164) | $user = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [165](#L165) | // Check if the provider. |
| [166](#L166) | if ( 'email' !== $parameters->provider ) { |
| [167](#L167) | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
| [168](#L168) | } |
| [169](#L169) | if ( !Rsssl\_Two\_Factor\_Email::get\_instance()->validate\_token( $parameters->user\_id, self::sanitize\_token($parameters->token) ) ) { |
| [170](#L170) | // we reset all the settings. |
| [171](#L171) | Rsssl\_Two\_Factor\_Email::set\_user\_status( $parameters->user\_id, 'open' ); |
| [172](#L172) | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $parameters->user\_id, 'open' ); |
| [173](#L173) |  |
| [174](#L174) | // we logout the user |
| [175](#L175) | wp\_logout(); |
| [176](#L176) |  |
| [177](#L177) | return new WP\_REST\_Response( array( 'error' =>  \_\_('Code was was invalid, try "Resend Code"', 'really-simple.ssl-pro') ), 401 ); |
| [178](#L178) | } |
| [179](#L179) |  |
| [180](#L180) | Rsssl\_Two\_Factor\_Email::set\_user\_status( $parameters->user\_id, 'active' ); |
| [181](#L181) | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $parameters->user\_id, 'disabled' ); |
| [182](#L182) | // Mark all other statuses as inactive. |
| [183](#L183) | self::set\_other\_providers\_inactive( $parameters->user\_id, 'email' ); |
| [184](#L184) |  |
| [185](#L185) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [186](#L186) | } |
| [187](#L187) |  |
| [188](#L188) | /\*\* |
| [189](#L189) | \* Resends the email code for a user. |
| [190](#L190) | \* |
| [191](#L191) | \* @param WP\_REST\_Request $request The REST request object. |
| [192](#L192) | \* |
| [193](#L193) | \* @return WP\_REST\_Response The REST response object. |
| [194](#L194) | \*/ |
| [195](#L195) | public function resend\_email\_code( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [196](#L196) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [197](#L197) | Rsssl\_Two\_Factor\_Email::get\_instance()->generate\_and\_email\_token($parameters->user, $parameters->profile); |
| [198](#L198) | return new WP\_REST\_Response( array( 'message' => \_\_('A verification code has been sent to the email address associated with your account to verify functionality.', 'really-simple.ssl-pro') ), 200 ); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* Verifies the 2FA code for TOTP. |
| [203](#L203) | \* |
| [204](#L204) | \* @param WP\_REST\_Request $request The REST request object. |
| [205](#L205) | \* |
| [206](#L206) | \* @return WP\_REST\_Response The REST response object. |
| [207](#L207) | \*/ |
| [208](#L208) | public function verify\_2fa\_code\_totp( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [209](#L209) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [210](#L210) | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [211](#L211) | // Check if the provider. |
| [212](#L212) | if ( 'totp' !== $parameters->provider ) { |
| [213](#L213) | $response = new WP\_REST\_Response( array( 'error' => \_\_('Invalid provider', 'really-simple-ssl') ), 400 ); |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | //This is an extra check so someone who thinks to use backup codes can't use them. |
| [217](#L217) | $code\_backup = Rsssl\_Two\_Factor\_Backup\_Codes::sanitize\_code\_from\_request( 'authcode', 8 ); |
| [218](#L218) | if ( $code\_backup && Rsssl\_Two\_Factor\_Backup\_Codes::validate\_code( $user, $code\_backup, false ) ) { |
| [219](#L219) | $error\_message = \_\_('Invalid Two Factor Authentication code.', 'really-simple-ssl'); |
| [220](#L220) | return new WP\_REST\_Response( array( 'error' => $error\_message ), 400 ); |
| [221](#L221) | } |
| [222](#L222) |  |
| [223](#L223) | if ( Rsssl\_Two\_Factor\_Totp::setup\_totp( $user, $parameters->key, $parameters->code ) ) { |
| [224](#L224) | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $user->ID, 'active' ); |
| [225](#L225) | Rsssl\_Two\_Factor\_Email::set\_user\_status( $user->ID, 'disabled' ); |
| [226](#L226) | // Mark all other statuses as inactive. |
| [227](#L227) | self::set\_other\_providers\_inactive( $user->ID, 'totp' ); |
| [228](#L228) | // Finally we redirect the user to the redirect\_to page. |
| [229](#L229) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | // We get the error message from the setup\_totp function. |
| [233](#L233) | $error\_message = get\_transient( 'rsssl\_error\_message\_' . $user->ID ); |
| [234](#L234) | // We delete the transient. |
| [235](#L235) | delete\_transient( 'rsssl\_error\_message\_' . $user->ID ); |
| [236](#L236) | return  new WP\_REST\_Response( array( 'error' => $error\_message ), 400 ); |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | /\*\* |
| [240](#L240) | \* Disables two-factor authentication for the user. |
| [241](#L241) | \* |
| [242](#L242) | \* @param WP\_REST\_Request $request The REST request object. |
| [243](#L243) | \* |
| [244](#L244) | \* @return WP\_REST\_Response The REST response object. |
| [245](#L245) | \*/ |
| [246](#L246) | public function disable\_two\_fa\_for\_user( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [247](#L247) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [248](#L248) | // As a double we check the user\_id with the login nonce. |
| [249](#L249) | $user = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [250](#L250) |  |
| [251](#L251) | // We get all the available providers for the user. |
| [252](#L252) | $user\_available\_providers = Rsssl\_Provider\_Loader::get\_providers(); |
| [253](#L253) |  |
| [254](#L254) | foreach ( $user\_available\_providers as $provider ) { |
| [255](#L255) | /\*\* |
| [256](#L256) | \* Set the user status to disable. |
| [257](#L257) | \* |
| [258](#L258) | \* @var Rsssl\_Two\_Factor\_Provider $provider |
| [259](#L259) | \*/ |
| [260](#L260) | $provider::set\_user\_status( $user->ID, 'disabled' ); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | // Finally we redirect the user to the redirect\_to page. |
| [264](#L264) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [265](#L265) | } |
| [266](#L266) |  |
| [267](#L267) | /\*\* |
| [268](#L268) | \* Skips the onboarding process for the user. |
| [269](#L269) | \* |
| [270](#L270) | \* @param WP\_REST\_Request $request The REST request object. |
| [271](#L271) | \* |
| [272](#L272) | \* @return WP\_REST\_Response The REST response object. |
| [273](#L273) | \*/ |
| [274](#L274) | public function skip\_onboarding( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [275](#L275) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [276](#L276) | // As a double we check the user\_id with the login nonce. |
| [277](#L277) | $user = $this->check\_login\_and\_get\_user( (int)$parameters->user\_id, $parameters->login\_nonce ); |
| [278](#L278) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | /\*\* |
| [282](#L282) | \* Registers API routes for the application. |
| [283](#L283) | \*/ |
| [284](#L284) | public function register\_api\_routes(): void { |
| [285](#L285) | register\_rest\_route( |
| [286](#L286) | self::NAMESPACE, |
| [287](#L287) | '/save\_default\_method\_email', |
| [288](#L288) | array( |
| [289](#L289) | 'methods'             => 'POST', |
| [290](#L290) | 'callback'            => array( $this, 'set\_as\_email' ), |
| [291](#L291) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [292](#L292) | return true;  // Allow all requests; handle auth in the callback. |
| [293](#L293) | }, |
| [294](#L294) | 'args'                => array( |
| [295](#L295) | 'provider'    => array( |
| [296](#L296) | 'required' => true, |
| [297](#L297) | 'type'     => 'string', |
| [298](#L298) | ), |
| [299](#L299) | 'user\_id'     => array( |
| [300](#L300) | 'required' => true, |
| [301](#L301) | 'type'     => 'integer', |
| [302](#L302) | ), |
| [303](#L303) | 'login\_nonce' => array( |
| [304](#L304) | 'required' => true, |
| [305](#L305) | 'type'     => 'string', |
| [306](#L306) | ), |
| [307](#L307) | ), |
| [308](#L308) | ) |
| [309](#L309) | ); |
| [310](#L310) |  |
| [311](#L311) | register\_rest\_route( |
| [312](#L312) | self::NAMESPACE, |
| [313](#L313) | '/save\_default\_method\_email\_profile', |
| [314](#L314) | array( |
| [315](#L315) | 'methods'             => 'POST', |
| [316](#L316) | 'callback'            => array( $this, 'set\_profile\_email' ), |
| [317](#L317) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [318](#L318) | return true;  // Allow all requests; handle auth in the callback. |
| [319](#L319) | }, |
| [320](#L320) | 'args'                => array( |
| [321](#L321) | 'provider'    => array( |
| [322](#L322) | 'required' => true, |
| [323](#L323) | 'type'     => 'string', |
| [324](#L324) | ), |
| [325](#L325) | 'user\_id'     => array( |
| [326](#L326) | 'required' => true, |
| [327](#L327) | 'type'     => 'integer', |
| [328](#L328) | ), |
| [329](#L329) | 'login\_nonce' => array( |
| [330](#L330) | 'required' => true, |
| [331](#L331) | 'type'     => 'string', |
| [332](#L332) | ), |
| [333](#L333) | ), |
| [334](#L334) | ) |
| [335](#L335) | ); |
| [336](#L336) |  |
| [337](#L337) | register\_rest\_route( |
| [338](#L338) | self::NAMESPACE, |
| [339](#L339) | '/validate\_email\_setup', |
| [340](#L340) | array( |
| [341](#L341) | 'methods' => 'POST', |
| [342](#L342) | 'callback' => array( $this, 'validate\_email\_setup' ), |
| [343](#L343) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [344](#L344) | return true;  // Allow all requests; handle auth in the callback. |
| [345](#L345) | }, |
| [346](#L346) | 'args' => array( |
| [347](#L347) | 'provider' => array( |
| [348](#L348) | 'required' => true, |
| [349](#L349) | 'type' => 'string', |
| [350](#L350) | ), |
| [351](#L351) | 'user\_id' => array( |
| [352](#L352) | 'required' => true, |
| [353](#L353) | 'type' => 'integer', |
| [354](#L354) | ), |
| [355](#L355) | 'login\_nonce' => array( |
| [356](#L356) | 'required' => true, |
| [357](#L357) | 'type' => 'string', |
| [358](#L358) | ), |
| [359](#L359) | 'redirect\_to' => array( |
| [360](#L360) | 'required' => false, |
| [361](#L361) | 'type' => 'string', |
| [362](#L362) | ), |
| [363](#L363) | 'token' => array( |
| [364](#L364) | 'required' => true, |
| [365](#L365) | 'type' => 'string', |
| [366](#L366) | ), |
| [367](#L367) | ), |
| [368](#L368) | ) |
| [369](#L369) | ); |
| [370](#L370) |  |
| [371](#L371) | register\_rest\_route( |
| [372](#L372) | self::NAMESPACE, |
| [373](#L373) | '/resend\_email\_code', |
| [374](#L374) | array( |
| [375](#L375) | 'methods' => 'POST', |
| [376](#L376) | 'callback' => array( $this, 'resend\_email\_code' ), |
| [377](#L377) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [378](#L378) | return true;  // Allow all requests; handle auth in the callback. |
| [379](#L379) | }, |
| [380](#L380) | 'args' => array( |
| [381](#L381) | 'provider' => array( |
| [382](#L382) | 'required' => true, |
| [383](#L383) | 'type' => 'string', |
| [384](#L384) | ), |
| [385](#L385) | 'user\_id' => array( |
| [386](#L386) | 'required' => true, |
| [387](#L387) | 'type' => 'integer', |
| [388](#L388) | ), |
| [389](#L389) | 'login\_nonce' => array( |
| [390](#L390) | 'required' => true, |
| [391](#L391) | 'type' => 'string', |
| [392](#L392) | ), |
| [393](#L393) | ), |
| [394](#L394) | ) |
| [395](#L395) | ); |
| [396](#L396) |  |
| [397](#L397) | register\_rest\_route( |
| [398](#L398) | self::NAMESPACE, |
| [399](#L399) | '/save\_default\_method\_totp', |
| [400](#L400) | array( |
| [401](#L401) | 'methods'             => 'POST', |
| [402](#L402) | 'callback'            => array( $this, 'verify\_2fa\_code\_totp' ), |
| [403](#L403) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [404](#L404) | return true;  // Allow all requests; handle auth in the callback. |
| [405](#L405) | }, |
| [406](#L406) | 'args'                => array( |
| [407](#L407) | 'two-factor-totp-authcode' => array( |
| [408](#L408) | 'required' => true, |
| [409](#L409) | 'type'     => 'string', |
| [410](#L410) | ), |
| [411](#L411) | 'provider'                 => array( |
| [412](#L412) | 'required' => true, |
| [413](#L413) | 'type'     => 'string', |
| [414](#L414) | ), |
| [415](#L415) | 'key'                      => array( |
| [416](#L416) | 'required' => true, |
| [417](#L417) | 'type'     => 'string', |
| [418](#L418) | ), |
| [419](#L419) | 'redirect\_to'              => array( |
| [420](#L420) | 'required' => false, |
| [421](#L421) | 'type'     => 'string', |
| [422](#L422) | ), |
| [423](#L423) | ), |
| [424](#L424) | ) |
| [425](#L425) | ); |
| [426](#L426) |  |
| [427](#L427) | register\_rest\_route( |
| [428](#L428) | self::NAMESPACE, |
| [429](#L429) | 'do\_not\_ask\_again', |
| [430](#L430) | array( |
| [431](#L431) | 'methods'             => 'POST', |
| [432](#L432) | 'callback'            => array( $this, 'disable\_two\_fa\_for\_user' ), |
| [433](#L433) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [434](#L434) | return true;  // Allow all requests; handle auth in the callback. |
| [435](#L435) | }, |
| [436](#L436) | 'args'                => array( |
| [437](#L437) | 'redirect\_to' => array( |
| [438](#L438) | 'required' => false, |
| [439](#L439) | 'type'     => 'string', |
| [440](#L440) | ), |
| [441](#L441) | 'user\_id'     => array( |
| [442](#L442) | 'required' => true, |
| [443](#L443) | 'type'     => 'integer', |
| [444](#L444) | ), |
| [445](#L445) | 'login\_nonce' => array( |
| [446](#L446) | 'required' => true, |
| [447](#L447) | 'type'     => 'string', |
| [448](#L448) | ), |
| [449](#L449) | ), |
| [450](#L450) | ) |
| [451](#L451) | ); |
| [452](#L452) |  |
| [453](#L453) | register\_rest\_route( |
| [454](#L454) | self::NAMESPACE, |
| [455](#L455) | 'skip\_onboarding', |
| [456](#L456) | array( |
| [457](#L457) | 'methods'             => 'POST', |
| [458](#L458) | 'callback'            => array( $this, 'skip\_onboarding' ), |
| [459](#L459) | 'permission\_callback' => '\_\_return\_true', |
| [460](#L460) | 'args'                => array( |
| [461](#L461) | 'redirect\_to' => array( |
| [462](#L462) | 'required' => false, |
| [463](#L463) | 'type'     => 'string', |
| [464](#L464) | ), |
| [465](#L465) | 'user\_id'     => array( |
| [466](#L466) | 'required' => true, |
| [467](#L467) | 'type'     => 'integer', |
| [468](#L468) | ), |
| [469](#L469) | 'login\_nonce' => array( |
| [470](#L470) | 'required' => true, |
| [471](#L471) | 'type'     => 'string', |
| [472](#L472) | ), |
| [473](#L473) | ), |
| [474](#L474) | ) |
| [475](#L475) | ); |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | /\*\* |
| [479](#L479) | \* Sets all other providers to inactive. |
| [480](#L480) | \* |
| [481](#L481) | \* @param  int    $id  The user ID. |
| [482](#L482) | \* @param  string $allowed\_method  The allowed method. |
| [483](#L483) | \* |
| [484](#L484) | \* @return void |
| [485](#L485) | \*/ |
| [486](#L486) | public static function set\_other\_providers\_inactive( int $id, string $allowed\_method ): void { |
| [487](#L487) | // First we get all the available providers for the user. |
| [488](#L488) | // We get the user from the id. |
| [489](#L489) | $user\_available\_providers = Rsssl\_Provider\_Loader::get\_enabled\_providers\_for\_user( get\_user\_by( 'id', $id ) ); |
| [490](#L490) | foreach ( $user\_available\_providers as $provider ) { |
| [491](#L491) | $namespace\_parts = explode( '\\', $provider ); |
| [492](#L492) | $last\_key        = end( $namespace\_parts ); |
| [493](#L493) | // we explode the last key to get the provider name. |
| [494](#L494) | $provider\_name = explode( '\_', $last\_key ); |
| [495](#L495) | $provider\_name = end( $provider\_name ); |
| [496](#L496) | if ( ucfirst( $allowed\_method ) !== $provider\_name ) { |
| [497](#L497) | $provider::set\_user\_status( $id, 'disabled' ); |
| [498](#L498) | } |
| [499](#L499) | } |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | /\*\* |
| [503](#L503) | \* Sanitizes a token. |
| [504](#L504) | \* |
| [505](#L505) | \* @param string $token The token to sanitize. |
| [506](#L506) | \* @param int $length The expected length of the token. Default is 0. |
| [507](#L507) | \* |
| [508](#L508) | \* @return string|false The sanitized token, or false if the length is invalid. |
| [509](#L509) | \*/ |
| [510](#L510) | public static function sanitize\_token(string $token, int $length = 0 ) { |
| [511](#L511) | $code = wp\_unslash( $token ); |
| [512](#L512) | $code = preg\_replace( '/\s+/', '', $code ); |
| [513](#L513) |  |
| [514](#L514) | // Maybe validate the length. |
| [515](#L515) | if ( $length && strlen( $code ) !== $length ) { |
| [516](#L516) | return false; |
| [517](#L517) | } |
| [518](#L518) |  |
| [519](#L519) | return (string) $code; |
| [520](#L520) | } |
| [521](#L521) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?format=txt)
* [Original Format](/export/3222472/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_71f62c04_20250114_204934.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Freally-simple-ssl%2Ftags%2F9.1.1.1%2Fsecurity%2Fwordpress%2Ftwo-fa%2Fclass-rsssl-two-factor-on-board-api.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php)

---

# [source:](/browser?order=name "Go to repository root") [really-simple-ssl](/browser/really-simple-ssl?order=name "View really-simple-ssl")/[tags](/browser/really-simple-ssl/tags?order=name "View tags")/[9.1.1.1](/browser/really-simple-ssl/tags/9.1.1.1?order=name "View 9.1.1.1")/[security](/browser/really-simple-ssl/tags/9.1.1.1/security?order=name "View security")/[wordpress](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress?order=name "View wordpress")/[two-fa](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa?order=name "View two-fa")/[class-rsssl-two-factor-on-board-api.php](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?order=name "View class-rsssl-two-factor-on-board-api.php")

View diff against:

View revision:

| [Last change](/changeset/3182368/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php "View differences") on this file was [3182368](/changeset/3182368/ "View changeset 3182368"), checked in by markwolters, [2 months ago](/timeline?from=2024-11-05T13%3A46%3A27Z&precision=second "See timeline at 11/05/2024 01:46:27 PM") |
| --- |
| prepare for update |
| **File size:** 18.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Handles the API routes for the two-factor authentication onboarding process. |
| [4](#L4) | \* This class is responsible for handling the API routes for the two-factor authentication onboarding process. |
| [5](#L5) | \* It registers the routes and handles the requests. |
| [6](#L6) | \* |
| [7](#L7) | \* @package REALLY\_SIMPLE\_SSL |
| [8](#L8) | \* @subpackage Security\WordPress\Two\_Fa |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) | namespace RSSSL\Security\WordPress\Two\_Fa; |
| [12](#L12) |  |
| [13](#L13) | use WP\_REST\_Request; |
| [14](#L14) | use WP\_REST\_Response; |
| [15](#L15) | use WP\_User; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Registers API routes for the application. |
| [19](#L19) | \* This class is responsible for registering the API routes for the two-factor authentication onboarding process. |
| [20](#L20) | \* It registers the routes and handles the requests. |
| [21](#L21) | \* |
| [22](#L22) | \* @package REALLY\_SIMPLE\_SSL |
| [23](#L23) | \* @subpackage Security\WordPress\Two\_Fa |
| [24](#L24) | \*/ |
| [25](#L25) | class Rsssl\_Two\_Factor\_On\_Board\_Api { |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* The namespace for the API routes. |
| [29](#L29) | \* |
| [30](#L30) | \* @package reallysimplessl/v1/two\_fa |
| [31](#L31) | \*/ |
| [32](#L32) | public const NAMESPACE = 'reallysimplessl/v1/two\_fa'; |
| [33](#L33) |  |
| [34](#L34) | /\*\* |
| [35](#L35) | \* Initializes the object and registers API routes. |
| [36](#L36) | \* |
| [37](#L37) | \* @return void |
| [38](#L38) | \*/ |
| [39](#L39) | public function \_\_construct() { |
| [40](#L40) | add\_action( 'rest\_api\_init', array( $this, 'register\_api\_routes' ) ); |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* Checks if the requested namespace matches our specific namespace and bypasses authentication. |
| [45](#L45) | \* |
| [46](#L46) | \* @param WP\_REST\_Request $request The REST request object. |
| [47](#L47) | \*/ |
| [48](#L48) | private function check\_custom\_validation( WP\_REST\_Request $request ): bool { |
| [49](#L49) | // first check if the $-REQUEST['rest\_route'] is set. |
| [50](#L50) | $params = new Rsssl\_Request\_Parameters( $request ); |
| [51](#L51) | if ( ! isset( $params->login\_nonce ) ) { |
| [52](#L52) | return false; |
| [53](#L53) | } |
| [54](#L54) | return Rsssl\_Two\_Fa\_Authentication::verify\_login\_nonce( $params->user\_id, $params->login\_nonce ); |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | /\*\* |
| [58](#L58) | \* Verifies a login nonce, gets user by the user id, and returns an error response if any steps fail. |
| [59](#L59) | \* |
| [60](#L60) | \* @param int    $user\_id The user ID. |
| [61](#L61) | \* @param string $login\_nonce The login nonce. |
| [62](#L62) | \* |
| [63](#L63) | \* @return WP\_User|WP\_REST\_Response |
| [64](#L64) | \*/ |
| [65](#L65) | private function check\_login\_and\_get\_user( int $user\_id, string $login\_nonce ) { |
| [66](#L66) | if ( ! Rsssl\_Two\_Fa\_Authentication::verify\_login\_nonce( $user\_id, $login\_nonce ) ) { |
| [67](#L67) | return new WP\_REST\_Response( array( 'error' => 'Invalid login nonce' ), 403 ); |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) | /\*\* |
| [71](#L71) | \* Get the user by the user ID. |
| [72](#L72) | \* |
| [73](#L73) | \* @var WP\_User $user |
| [74](#L74) | \*/ |
| [75](#L75) | $user = get\_user\_by( 'id', $user\_id ); |
| [76](#L76) | return $user; |
| [77](#L77) | } |
| [78](#L78) |  |
| [79](#L79) | /\*\* |
| [80](#L80) | \* Sets the authentication cookie and returns a success response. |
| [81](#L81) | \* |
| [82](#L82) | \* @param int    $user\_id The user ID. |
| [83](#L83) | \* @param string $redirect\_to The redirect URL. |
| [84](#L84) | \* |
| [85](#L85) | \* @return WP\_REST\_Response |
| [86](#L86) | \*/ |
| [87](#L87) | private function authenticate\_and\_redirect( int $user\_id, string $redirect\_to = '' ): WP\_REST\_Response { |
| [88](#L88) | // Okay checked the provider now authenticate the user. |
| [89](#L89) | wp\_set\_auth\_cookie( $user\_id, true ); |
| [90](#L90) | // Finally redirect the user to the redirect\_to page or to the home page if the redirect\_to is not set. |
| [91](#L91) | $redirect\_to = $redirect\_to ?: home\_url(); |
| [92](#L92) | return new WP\_REST\_Response( array( 'redirect\_to' => $redirect\_to ), 200 ); |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | /\*\* |
| [96](#L96) | \* Starts the process of email validation for a user. |
| [97](#L97) | \* |
| [98](#L98) | \* @param int $user\_id The ID of the user for whom the email validation process needs to be started. |
| [99](#L99) | \* @param string $redirect\_to The URL to redirect the user after the email validation process. Default is an empty string. |
| [100](#L100) | \* |
| [101](#L101) | \* @return WP\_REST\_Response The REST response object. |
| [102](#L102) | \*/ |
| [103](#L103) | private function start\_email\_validation(int $user\_id, string $redirect\_to = '', $profile = false): WP\_REST\_Response |
| [104](#L104) | { |
| [105](#L105) | $redirect\_to = $redirect\_to ?: home\_url(); |
| [106](#L106) | $user = get\_user\_by('id', $user\_id); |
| [107](#L107) | Rsssl\_Two\_Fa\_Authentication::create\_login\_nonce($user\_id); |
| [108](#L108) | // Sending the email with the code. |
| [109](#L109) | Rsssl\_Two\_Factor\_Email::get\_instance()->generate\_and\_email\_token($user, $profile); |
| [110](#L110) | $token = get\_user\_meta( $user\_id, Rsssl\_Two\_Factor\_Email::RSSSL\_TOKEN\_META\_KEY, true ); |
| [111](#L111) | if ( $redirect\_to === 'profile') { |
| [112](#L112) | return new WP\_REST\_Response( array( 'token' => $token,  'validation\_action' => 'validate\_email\_setup' ), 200 ); |
| [113](#L113) | } |
| [114](#L114) | return new WP\_REST\_Response( array( 'token' => $token, 'redirect\_to' => $redirect\_to, 'validation\_action' => 'validate\_email\_setup' ), 200 ); |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | /\*\* |
| [118](#L118) | \* Sets the user provider as email and redirects the user to the specified page. |
| [119](#L119) | \* |
| [120](#L120) | \* @param WP\_REST\_Request $request The REST request object. |
| [121](#L121) | \* |
| [122](#L122) | \* @return WP\_REST\_Response The REST response object if user is not logged in or provider is invalid. |
| [123](#L123) | \*/ |
| [124](#L124) | public function set\_as\_email( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [125](#L125) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [126](#L126) | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [127](#L127) | // Check if the provider. |
| [128](#L128) | if ( 'email' !== $parameters->provider ) { |
| [129](#L129) | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
| [130](#L130) | } |
| [131](#L131) |  |
| [132](#L132) | // Finally redirect the user to the redirect\_to page with a response. |
| [133](#L133) | return $this->start\_email\_validation( $parameters->user\_id, $parameters->redirect\_to , $parameters->profile ); |
| [134](#L134) | } |
| [135](#L135) |  |
| [136](#L136) | /\*\* |
| [137](#L137) | \* Sets the profile email for a user. |
| [138](#L138) | \* |
| [139](#L139) | \* @param WP\_REST\_Request $request The REST request object. |
| [140](#L140) | \* |
| [141](#L141) | \* @return WP\_REST\_Response The REST response object. |
| [142](#L142) | \*/ |
| [143](#L143) | public function set\_profile\_email(WP\_REST\_Request $request ): WP\_REST\_Response { |
| [144](#L144) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [145](#L145) | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [146](#L146) | // Check if the provider. |
| [147](#L147) | if ( 'email' !== $parameters->provider ) { |
| [148](#L148) | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | // Finally redirect the user to the redirect\_to page with a response. |
| [152](#L152) | return $this->start\_email\_validation( $parameters->user\_id, $parameters->redirect\_to, $parameters->profile ); |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | /\*\* |
| [156](#L156) | \* Validates the email setup for a user. |
| [157](#L157) | \* |
| [158](#L158) | \* @param WP\_REST\_Request $request The REST request object. |
| [159](#L159) | \* |
| [160](#L160) | \* @return WP\_REST\_Response The REST response object. |
| [161](#L161) | \*/ |
| [162](#L162) | public function validate\_email\_setup(WP\_REST\_Request $request ): WP\_REST\_Response { |
| [163](#L163) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [164](#L164) | $user = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [165](#L165) | // Check if the provider. |
| [166](#L166) | if ( 'email' !== $parameters->provider ) { |
| [167](#L167) | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
| [168](#L168) | } |
| [169](#L169) | if ( !Rsssl\_Two\_Factor\_Email::get\_instance()->validate\_token( $parameters->user\_id, self::sanitize\_token($parameters->token) ) ) { |
| [170](#L170) | // we reset all the settings. |
| [171](#L171) | Rsssl\_Two\_Factor\_Email::set\_user\_status( $parameters->user\_id, 'open' ); |
| [172](#L172) | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $parameters->user\_id, 'open' ); |
| [173](#L173) |  |
| [174](#L174) | // we logout the user |
| [175](#L175) | wp\_logout(); |
| [176](#L176) |  |
| [177](#L177) | return new WP\_REST\_Response( array( 'error' =>  \_\_('Code was was invalid, try "Resend Code"', 'really-simple.ssl-pro') ), 401 ); |
| [178](#L178) | } |
| [179](#L179) |  |
| [180](#L180) | Rsssl\_Two\_Factor\_Email::set\_user\_status( $parameters->user\_id, 'active' ); |
| [181](#L181) | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $parameters->user\_id, 'disabled' ); |
| [182](#L182) | // Mark all other statuses as inactive. |
| [183](#L183) | self::set\_other\_providers\_inactive( $parameters->user\_id, 'email' ); |
| [184](#L184) |  |
| [185](#L185) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [186](#L186) | } |
| [187](#L187) |  |
| [188](#L188) | /\*\* |
| [189](#L189) | \* Resends the email code for a user. |
| [190](#L190) | \* |
| [191](#L191) | \* @param WP\_REST\_Request $request The REST request object. |
| [192](#L192) | \* |
| [193](#L193) | \* @return WP\_REST\_Response The REST response object. |
| [194](#L194) | \*/ |
| [195](#L195) | public function resend\_email\_code( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [196](#L196) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [197](#L197) | Rsssl\_Two\_Factor\_Email::get\_instance()->generate\_and\_email\_token($parameters->user, $parameters->profile); |
| [198](#L198) | return new WP\_REST\_Response( array( 'message' => \_\_('A verification code has been sent to the email address associated with your account to verify functionality.', 'really-simple.ssl-pro') ), 200 ); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* Verifies the 2FA code for TOTP. |
| [203](#L203) | \* |
| [204](#L204) | \* @param WP\_REST\_Request $request The REST request object. |
| [205](#L205) | \* |
| [206](#L206) | \* @return WP\_REST\_Response The REST response object. |
| [207](#L207) | \*/ |
| [208](#L208) | public function verify\_2fa\_code\_totp( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [209](#L209) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [210](#L210) | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [211](#L211) | // Check if the provider. |
| [212](#L212) | if ( 'totp' !== $parameters->provider ) { |
| [213](#L213) | $response = new WP\_REST\_Response( array( 'error' => \_\_('Invalid provider', 'really-simple-ssl') ), 400 ); |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | //This is an extra check so someone who thinks to use backup codes can't use them. |
| [217](#L217) | $code\_backup = Rsssl\_Two\_Factor\_Backup\_Codes::sanitize\_code\_from\_request( 'authcode', 8 ); |
| [218](#L218) | if ( $code\_backup && Rsssl\_Two\_Factor\_Backup\_Codes::validate\_code( $user, $code\_backup, false ) ) { |
| [219](#L219) | $error\_message = \_\_('Invalid Two Factor Authentication code.', 'really-simple-ssl'); |
| [220](#L220) | return new WP\_REST\_Response( array( 'error' => $error\_message ), 400 ); |
| [221](#L221) | } |
| [222](#L222) |  |
| [223](#L223) | if ( Rsssl\_Two\_Factor\_Totp::setup\_totp( $user, $parameters->key, $parameters->code ) ) { |
| [224](#L224) | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $user->ID, 'active' ); |
| [225](#L225) | Rsssl\_Two\_Factor\_Email::set\_user\_status( $user->ID, 'disabled' ); |
| [226](#L226) | // Mark all other statuses as inactive. |
| [227](#L227) | self::set\_other\_providers\_inactive( $user->ID, 'totp' ); |
| [228](#L228) | // Finally we redirect the user to the redirect\_to page. |
| [229](#L229) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | // We get the error message from the setup\_totp function. |
| [233](#L233) | $error\_message = get\_transient( 'rsssl\_error\_message\_' . $user->ID ); |
| [234](#L234) | // We delete the transient. |
| [235](#L235) | delete\_transient( 'rsssl\_error\_message\_' . $user->ID ); |
| [236](#L236) | return  new WP\_REST\_Response( array( 'error' => $error\_message ), 400 ); |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | /\*\* |
| [240](#L240) | \* Disables two-factor authentication for the user. |
| [241](#L241) | \* |
| [242](#L242) | \* @param WP\_REST\_Request $request The REST request object. |
| [243](#L243) | \* |
| [244](#L244) | \* @return WP\_REST\_Response The REST response object. |
| [245](#L245) | \*/ |
| [246](#L246) | public function disable\_two\_fa\_for\_user( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [247](#L247) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [248](#L248) | // As a double we check the user\_id with the login nonce. |
| [249](#L249) | $user = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [250](#L250) |  |
| [251](#L251) | // We get all the available providers for the user. |
| [252](#L252) | $user\_available\_providers = Rsssl\_Provider\_Loader::get\_providers(); |
| [253](#L253) |  |
| [254](#L254) | foreach ( $user\_available\_providers as $provider ) { |
| [255](#L255) | /\*\* |
| [256](#L256) | \* Set the user status to disable. |
| [257](#L257) | \* |
| [258](#L258) | \* @var Rsssl\_Two\_Factor\_Provider $provider |
| [259](#L259) | \*/ |
| [260](#L260) | $provider::set\_user\_status( $user->ID, 'disabled' ); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | // Finally we redirect the user to the redirect\_to page. |
| [264](#L264) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [265](#L265) | } |
| [266](#L266) |  |
| [267](#L267) | /\*\* |
| [268](#L268) | \* Skips the onboarding process for the user. |
| [269](#L269) | \* |
| [270](#L270) | \* @param WP\_REST\_Request $request The REST request object. |
| [271](#L271) | \* |
| [272](#L272) | \* @return WP\_REST\_Response The REST response object. |
| [273](#L273) | \*/ |
| [274](#L274) | public function skip\_onboarding( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [275](#L275) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [276](#L276) | // As a double we check the user\_id with the login nonce. |
| [277](#L277) | $user = $this->check\_login\_and\_get\_user( (int)$parameters->user\_id, $parameters->login\_nonce ); |
| [278](#L278) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | /\*\* |
| [282](#L282) | \* Registers API routes for the application. |
| [283](#L283) | \*/ |
| [284](#L284) | public function register\_api\_routes(): void { |
| [285](#L285) | register\_rest\_route( |
| [286](#L286) | self::NAMESPACE, |
| [287](#L287) | '/save\_default\_method\_email', |
| [288](#L288) | array( |
| [289](#L289) | 'methods'             => 'POST', |
| [290](#L290) | 'callback'            => array( $this, 'set\_as\_email' ), |
| [291](#L291) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [292](#L292) | return true;  // Allow all requests; handle auth in the callback. |
| [293](#L293) | }, |
| [294](#L294) | 'args'                => array( |
| [295](#L295) | 'provider'    => array( |
| [296](#L296) | 'required' => true, |
| [297](#L297) | 'type'     => 'string', |
| [298](#L298) | ), |
| [299](#L299) | 'user\_id'     => array( |
| [300](#L300) | 'required' => true, |
| [301](#L301) | 'type'     => 'integer', |
| [302](#L302) | ), |
| [303](#L303) | 'login\_nonce' => array( |
| [304](#L304) | 'required' => true, |
| [305](#L305) | 'type'     => 'string', |
| [306](#L306) | ), |
| [307](#L307) | ), |
| [308](#L308) | ) |
| [309](#L309) | ); |
| [310](#L310) |  |
| [311](#L311) | register\_rest\_route( |
| [312](#L312) | self::NAMESPACE, |
| [313](#L313) | '/save\_default\_method\_email\_profile', |
| [314](#L314) | array( |
| [315](#L315) | 'methods'             => 'POST', |
| [316](#L316) | 'callback'            => array( $this, 'set\_profile\_email' ), |
| [317](#L317) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [318](#L318) | return true;  // Allow all requests; handle auth in the callback. |
| [319](#L319) | }, |
| [320](#L320) | 'args'                => array( |
| [321](#L321) | 'provider'    => array( |
| [322](#L322) | 'required' => true, |
| [323](#L323) | 'type'     => 'string', |
| [324](#L324) | ), |
| [325](#L325) | 'user\_id'     => array( |
| [326](#L326) | 'required' => true, |
| [327](#L327) | 'type'     => 'integer', |
| [328](#L328) | ), |
| [329](#L329) | 'login\_nonce' => array( |
| [330](#L330) | 'required' => true, |
| [331](#L331) | 'type'     => 'string', |
| [332](#L332) | ), |
| [333](#L333) | ), |
| [334](#L334) | ) |
| [335](#L335) | ); |
| [336](#L336) |  |
| [337](#L337) | register\_rest\_route( |
| [338](#L338) | self::NAMESPACE, |
| [339](#L339) | '/validate\_email\_setup', |
| [340](#L340) | array( |
| [341](#L341) | 'methods' => 'POST', |
| [342](#L342) | 'callback' => array( $this, 'validate\_email\_setup' ), |
| [343](#L343) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [344](#L344) | return true;  // Allow all requests; handle auth in the callback. |
| [345](#L345) | }, |
| [346](#L346) | 'args' => array( |
| [347](#L347) | 'provider' => array( |
| [348](#L348) | 'required' => true, |
| [349](#L349) | 'type' => 'string', |
| [350](#L350) | ), |
| [351](#L351) | 'user\_id' => array( |
| [352](#L352) | 'required' => true, |
| [353](#L353) | 'type' => 'integer', |
| [354](#L354) | ), |
| [355](#L355) | 'login\_nonce' => array( |
| [356](#L356) | 'required' => true, |
| [357](#L357) | 'type' => 'string', |
| [358](#L358) | ), |
| [359](#L359) | 'redirect\_to' => array( |
| [360](#L360) | 'required' => false, |
| [361](#L361) | 'type' => 'string', |
| [362](#L362) | ), |
| [363](#L363) | 'token' => array( |
| [364](#L364) | 'required' => true, |
| [365](#L365) | 'type' => 'string', |
| [366](#L366) | ), |
| [367](#L367) | ), |
| [368](#L368) | ) |
| [369](#L369) | ); |
| [370](#L370) |  |
| [371](#L371) | register\_rest\_route( |
| [372](#L372) | self::NAMESPACE, |
| [373](#L373) | '/resend\_email\_code', |
| [374](#L374) | array( |
| [375](#L375) | 'methods' => 'POST', |
| [376](#L376) | 'callback' => array( $this, 'resend\_email\_code' ), |
| [377](#L377) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [378](#L378) | return true;  // Allow all requests; handle auth in the callback. |
| [379](#L379) | }, |
| [380](#L380) | 'args' => array( |
| [381](#L381) | 'provider' => array( |
| [382](#L382) | 'required' => true, |
| [383](#L383) | 'type' => 'string', |
| [384](#L384) | ), |
| [385](#L385) | 'user\_id' => array( |
| [386](#L386) | 'required' => true, |
| [387](#L387) | 'type' => 'integer', |
| [388](#L388) | ), |
| [389](#L389) | 'login\_nonce' => array( |
| [390](#L390) | 'required' => true, |
| [391](#L391) | 'type' => 'string', |
| [392](#L392) | ), |
| [393](#L393) | ), |
| [394](#L394) | ) |
| [395](#L395) | ); |
| [396](#L396) |  |
| [397](#L397) | register\_rest\_route( |
| [398](#L398) | self::NAMESPACE, |
| [399](#L399) | '/save\_default\_method\_totp', |
| [400](#L400) | array( |
| [401](#L401) | 'methods'             => 'POST', |
| [402](#L402) | 'callback'            => array( $this, 'verify\_2fa\_code\_totp' ), |
| [403](#L403) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [404](#L404) | return true;  // Allow all requests; handle auth in the callback. |
| [405](#L405) | }, |
| [406](#L406) | 'args'                => array( |
| [407](#L407) | 'two-factor-totp-authcode' => array( |
| [408](#L408) | 'required' => true, |
| [409](#L409) | 'type'     => 'string', |
| [410](#L410) | ), |
| [411](#L411) | 'provider'                 => array( |
| [412](#L412) | 'required' => true, |
| [413](#L413) | 'type'     => 'string', |
| [414](#L414) | ), |
| [415](#L415) | 'key'                      => array( |
| [416](#L416) | 'required' => true, |
| [417](#L417) | 'type'     => 'string', |
| [418](#L418) | ), |
| [419](#L419) | 'redirect\_to'              => array( |
| [420](#L420) | 'required' => false, |
| [421](#L421) | 'type'     => 'string', |
| [422](#L422) | ), |
| [423](#L423) | ), |
| [424](#L424) | ) |
| [425](#L425) | ); |
| [426](#L426) |  |
| [427](#L427) | register\_rest\_route( |
| [428](#L428) | self::NAMESPACE, |
| [429](#L429) | 'do\_not\_ask\_again', |
| [430](#L430) | array( |
| [431](#L431) | 'methods'             => 'POST', |
| [432](#L432) | 'callback'            => array( $this, 'disable\_two\_fa\_for\_user' ), |
| [433](#L433) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [434](#L434) | return true;  // Allow all requests; handle auth in the callback. |
| [435](#L435) | }, |
| [436](#L436) | 'args'                => array( |
| [437](#L437) | 'redirect\_to' => array( |
| [438](#L438) | 'required' => false, |
| [439](#L439) | 'type'     => 'string', |
| [440](#L440) | ), |
| [441](#L441) | 'user\_id'     => array( |
| [442](#L442) | 'required' => true, |
| [443](#L443) | 'type'     => 'integer', |
| [444](#L444) | ), |
| [445](#L445) | 'login\_nonce' => array( |
| [446](#L446) | 'required' => true, |
| [447](#L447) | 'type'     => 'string', |
| [448](#L448) | ), |
| [449](#L449) | ), |
| [450](#L450) | ) |
| [451](#L451) | ); |
| [452](#L452) |  |
| [453](#L453) | register\_rest\_route( |
| [454](#L454) | self::NAMESPACE, |
| [455](#L455) | 'skip\_onboarding', |
| [456](#L456) | array( |
| [457](#L457) | 'methods'             => 'POST', |
| [458](#L458) | 'callback'            => array( $this, 'skip\_onboarding' ), |
| [459](#L459) | 'permission\_callback' => '\_\_return\_true', |
| [460](#L460) | 'args'                => array( |
| [461](#L461) | 'redirect\_to' => array( |
| [462](#L462) | 'required' => false, |
| [463](#L463) | 'type'     => 'string', |
| [464](#L464) | ), |
| [465](#L465) | 'user\_id'     => array( |
| [466](#L466) | 'required' => true, |
| [467](#L467) | 'type'     => 'integer', |
| [468](#L468) | ), |
| [469](#L469) | 'login\_nonce' => array( |
| [470](#L470) | 'required' => true, |
| [471](#L471) | 'type'     => 'string', |
| [472](#L472) | ), |
| [473](#L473) | ), |
| [474](#L474) | ) |
| [475](#L475) | ); |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | /\*\* |
| [479](#L479) | \* Sets all other providers to inactive. |
| [480](#L480) | \* |
| [481](#L481) | \* @param  int    $id  The user ID. |
| [482](#L482) | \* @param  string $allowed\_method  The allowed method. |
| [483](#L483) | \* |
| [484](#L484) | \* @return void |
| [485](#L485) | \*/ |
| [486](#L486) | public static function set\_other\_providers\_inactive( int $id, string $allowed\_method ): void { |
| [487](#L487) | // First we get all the available providers for the user. |
| [488](#L488) | // We get the user from the id. |
| [489](#L489) | $user\_available\_providers = Rsssl\_Provider\_Loader::get\_enabled\_providers\_for\_user( get\_user\_by( 'id', $id ) ); |
| [490](#L490) | foreach ( $user\_available\_providers as $provider ) { |
| [491](#L491) | $namespace\_parts = explode( '\\', $provider ); |
| [492](#L492) | $last\_key        = end( $namespace\_parts ); |
| [493](#L493) | // we explode the last key to get the provider name. |
| [494](#L494) | $provider\_name = explode( '\_', $last\_key ); |
| [495](#L495) | $provider\_name = end( $provider\_name ); |
| [496](#L496) | if ( ucfirst( $allowed\_method ) !== $provider\_name ) { |
| [497](#L497) | $provider::set\_user\_status( $id, 'disabled' ); |
| [498](#L498) | } |
| [499](#L499) | } |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | /\*\* |
| [503](#L503) | \* Sanitizes a token. |
| [504](#L504) | \* |
| [505](#L505) | \* @param string $token The token to sanitize. |
| [506](#L506) | \* @param int $length The expected length of the token. Default is 0. |
| [507](#L507) | \* |
| [508](#L508) | \* @return string|false The sanitized token, or false if the length is invalid. |
| [509](#L509) | \*/ |
| [510](#L510) | public static function sanitize\_token(string $token, int $length = 0 ) { |
| [511](#L511) | $code = wp\_unslash( $token ); |
| [512](#L512) | $code = preg\_replace( '/\s+/', '', $code ); |
| [513](#L513) |  |
| [514](#L514) | // Maybe validate the length. |
| [515](#L515) | if ( $length && strlen( $code ) !== $length ) { |
| [516](#L516) | return false; |
| [517](#L517) | } |
| [518](#L518) |  |
| [519](#L519) | return (string) $code; |
| [520](#L520) | } |
| [521](#L521) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?format=txt)
* [Original Format](/export/3222472/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_89d19189_20250114_204933.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Freally-simple-ssl%2Ftags%2F9.1.1.1%2Fsecurity%2Fwordpress%2Ftwo-fa%2Fclass-rsssl-two-factor-on-board-api.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php)

---

# [source:](/browser?order=name "Go to repository root") [really-simple-ssl](/browser/really-simple-ssl?order=name "View really-simple-ssl")/[tags](/browser/really-simple-ssl/tags?order=name "View tags")/[9.1.1.1](/browser/really-simple-ssl/tags/9.1.1.1?order=name "View 9.1.1.1")/[security](/browser/really-simple-ssl/tags/9.1.1.1/security?order=name "View security")/[wordpress](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress?order=name "View wordpress")/[two-fa](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa?order=name "View two-fa")/[class-rsssl-two-factor-on-board-api.php](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?order=name "View class-rsssl-two-factor-on-board-api.php")

View diff against:

View revision:

| [Last change](/changeset/3182368/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php "View differences") on this file was [3182368](/changeset/3182368/ "View changeset 3182368"), checked in by markwolters, [2 months ago](/timeline?from=2024-11-05T13%3A46%3A27Z&precision=second "See timeline at 11/05/2024 01:46:27 PM") |
| --- |
| prepare for update |
| **File size:** 18.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Handles the API routes for the two-factor authentication onboarding process. |
| [4](#L4) | \* This class is responsible for handling the API routes for the two-factor authentication onboarding process. |
| [5](#L5) | \* It registers the routes and handles the requests. |
| [6](#L6) | \* |
| [7](#L7) | \* @package REALLY\_SIMPLE\_SSL |
| [8](#L8) | \* @subpackage Security\WordPress\Two\_Fa |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) | namespace RSSSL\Security\WordPress\Two\_Fa; |
| [12](#L12) |  |
| [13](#L13) | use WP\_REST\_Request; |
| [14](#L14) | use WP\_REST\_Response; |
| [15](#L15) | use WP\_User; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Registers API routes for the application. |
| [19](#L19) | \* This class is responsible for registering the API routes for the two-factor authentication onboarding process. |
| [20](#L20) | \* It registers the routes and handles the requests. |
| [21](#L21) | \* |
| [22](#L22) | \* @package REALLY\_SIMPLE\_SSL |
| [23](#L23) | \* @subpackage Security\WordPress\Two\_Fa |
| [24](#L24) | \*/ |
| [25](#L25) | class Rsssl\_Two\_Factor\_On\_Board\_Api { |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* The namespace for the API routes. |
| [29](#L29) | \* |
| [30](#L30) | \* @package reallysimplessl/v1/two\_fa |
| [31](#L31) | \*/ |
| [32](#L32) | public const NAMESPACE = 'reallysimplessl/v1/two\_fa'; |
| [33](#L33) |  |
| [34](#L34) | /\*\* |
| [35](#L35) | \* Initializes the object and registers API routes. |
| [36](#L36) | \* |
| [37](#L37) | \* @return void |
| [38](#L38) | \*/ |
| [39](#L39) | public function \_\_construct() { |
| [40](#L40) | add\_action( 'rest\_api\_init', array( $this, 'register\_api\_routes' ) ); |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* Checks if the requested namespace matches our specific namespace and bypasses authentication. |
| [45](#L45) | \* |
| [46](#L46) | \* @param WP\_REST\_Request $request The REST request object. |
| [47](#L47) | \*/ |
| [48](#L48) | private function check\_custom\_validation( WP\_REST\_Request $request ): bool { |
| [49](#L49) | // first check if the $-REQUEST['rest\_route'] is set. |
| [50](#L50) | $params = new Rsssl\_Request\_Parameters( $request ); |
| [51](#L51) | if ( ! isset( $params->login\_nonce ) ) { |
| [52](#L52) | return false; |
| [53](#L53) | } |
| [54](#L54) | return Rsssl\_Two\_Fa\_Authentication::verify\_login\_nonce( $params->user\_id, $params->login\_nonce ); |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | /\*\* |
| [58](#L58) | \* Verifies a login nonce, gets user by the user id, and returns an error response if any steps fail. |
| [59](#L59) | \* |
| [60](#L60) | \* @param int    $user\_id The user ID. |
| [61](#L61) | \* @param string $login\_nonce The login nonce. |
| [62](#L62) | \* |
| [63](#L63) | \* @return WP\_User|WP\_REST\_Response |
| [64](#L64) | \*/ |
| [65](#L65) | private function check\_login\_and\_get\_user( int $user\_id, string $login\_nonce ) { |
| [66](#L66) | if ( ! Rsssl\_Two\_Fa\_Authentication::verify\_login\_nonce( $user\_id, $login\_nonce ) ) { |
| [67](#L67) | return new WP\_REST\_Response( array( 'error' => 'Invalid login nonce' ), 403 ); |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) | /\*\* |
| [71](#L71) | \* Get the user by the user ID. |
| [72](#L72) | \* |
| [73](#L73) | \* @var WP\_User $user |
| [74](#L74) | \*/ |
| [75](#L75) | $user = get\_user\_by( 'id', $user\_id ); |
| [76](#L76) | return $user; |
| [77](#L77) | } |
| [78](#L78) |  |
| [79](#L79) | /\*\* |
| [80](#L80) | \* Sets the authentication cookie and returns a success response. |
| [81](#L81) | \* |
| [82](#L82) | \* @param int    $user\_id The user ID. |
| [83](#L83) | \* @param string $redirect\_to The redirect URL. |
| [84](#L84) | \* |
| [85](#L85) | \* @return WP\_REST\_Response |
| [86](#L86) | \*/ |
| [87](#L87) | private function authenticate\_and\_redirect( int $user\_id, string $redirect\_to = '' ): WP\_REST\_Response { |
| [88](#L88) | // Okay checked the provider now authenticate the user. |
| [89](#L89) | wp\_set\_auth\_cookie( $user\_id, true ); |
| [90](#L90) | // Finally redirect the user to the redirect\_to page or to the home page if the redirect\_to is not set. |
| [91](#L91) | $redirect\_to = $redirect\_to ?: home\_url(); |
| [92](#L92) | return new WP\_REST\_Response( array( 'redirect\_to' => $redirect\_to ), 200 ); |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | /\*\* |
| [96](#L96) | \* Starts the process of email validation for a user. |
| [97](#L97) | \* |
| [98](#L98) | \* @param int $user\_id The ID of the user for whom the email validation process needs to be started. |
| [99](#L99) | \* @param string $redirect\_to The URL to redirect the user after the email validation process. Default is an empty string. |
| [100](#L100) | \* |
| [101](#L101) | \* @return WP\_REST\_Response The REST response object. |
| [102](#L102) | \*/ |
| [103](#L103) | private function start\_email\_validation(int $user\_id, string $redirect\_to = '', $profile = false): WP\_REST\_Response |
| [104](#L104) | { |
| [105](#L105) | $redirect\_to = $redirect\_to ?: home\_url(); |
| [106](#L106) | $user = get\_user\_by('id', $user\_id); |
| [107](#L107) | Rsssl\_Two\_Fa\_Authentication::create\_login\_nonce($user\_id); |
| [108](#L108) | // Sending the email with the code. |
| [109](#L109) | Rsssl\_Two\_Factor\_Email::get\_instance()->generate\_and\_email\_token($user, $profile); |
| [110](#L110) | $token = get\_user\_meta( $user\_id, Rsssl\_Two\_Factor\_Email::RSSSL\_TOKEN\_META\_KEY, true ); |
| [111](#L111) | if ( $redirect\_to === 'profile') { |
| [112](#L112) | return new WP\_REST\_Response( array( 'token' => $token,  'validation\_action' => 'validate\_email\_setup' ), 200 ); |
| [113](#L113) | } |
| [114](#L114) | return new WP\_REST\_Response( array( 'token' => $token, 'redirect\_to' => $redirect\_to, 'validation\_action' => 'validate\_email\_setup' ), 200 ); |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | /\*\* |
| [118](#L118) | \* Sets the user provider as email and redirects the user to the specified page. |
| [119](#L119) | \* |
| [120](#L120) | \* @param WP\_REST\_Request $request The REST request object. |
| [121](#L121) | \* |
| [122](#L122) | \* @return WP\_REST\_Response The REST response object if user is not logged in or provider is invalid. |
| [123](#L123) | \*/ |
| [124](#L124) | public function set\_as\_email( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [125](#L125) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [126](#L126) | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [127](#L127) | // Check if the provider. |
| [128](#L128) | if ( 'email' !== $parameters->provider ) { |
| [129](#L129) | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
| [130](#L130) | } |
| [131](#L131) |  |
| [132](#L132) | // Finally redirect the user to the redirect\_to page with a response. |
| [133](#L133) | return $this->start\_email\_validation( $parameters->user\_id, $parameters->redirect\_to , $parameters->profile ); |
| [134](#L134) | } |
| [135](#L135) |  |
| [136](#L136) | /\*\* |
| [137](#L137) | \* Sets the profile email for a user. |
| [138](#L138) | \* |
| [139](#L139) | \* @param WP\_REST\_Request $request The REST request object. |
| [140](#L140) | \* |
| [141](#L141) | \* @return WP\_REST\_Response The REST response object. |
| [142](#L142) | \*/ |
| [143](#L143) | public function set\_profile\_email(WP\_REST\_Request $request ): WP\_REST\_Response { |
| [144](#L144) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [145](#L145) | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [146](#L146) | // Check if the provider. |
| [147](#L147) | if ( 'email' !== $parameters->provider ) { |
| [148](#L148) | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | // Finally redirect the user to the redirect\_to page with a response. |
| [152](#L152) | return $this->start\_email\_validation( $parameters->user\_id, $parameters->redirect\_to, $parameters->profile ); |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | /\*\* |
| [156](#L156) | \* Validates the email setup for a user. |
| [157](#L157) | \* |
| [158](#L158) | \* @param WP\_REST\_Request $request The REST request object. |
| [159](#L159) | \* |
| [160](#L160) | \* @return WP\_REST\_Response The REST response object. |
| [161](#L161) | \*/ |
| [162](#L162) | public function validate\_email\_setup(WP\_REST\_Request $request ): WP\_REST\_Response { |
| [163](#L163) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [164](#L164) | $user = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [165](#L165) | // Check if the provider. |
| [166](#L166) | if ( 'email' !== $parameters->provider ) { |
| [167](#L167) | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
| [168](#L168) | } |
| [169](#L169) | if ( !Rsssl\_Two\_Factor\_Email::get\_instance()->validate\_token( $parameters->user\_id, self::sanitize\_token($parameters->token) ) ) { |
| [170](#L170) | // we reset all the settings. |
| [171](#L171) | Rsssl\_Two\_Factor\_Email::set\_user\_status( $parameters->user\_id, 'open' ); |
| [172](#L172) | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $parameters->user\_id, 'open' ); |
| [173](#L173) |  |
| [174](#L174) | // we logout the user |
| [175](#L175) | wp\_logout(); |
| [176](#L176) |  |
| [177](#L177) | return new WP\_REST\_Response( array( 'error' =>  \_\_('Code was was invalid, try "Resend Code"', 'really-simple.ssl-pro') ), 401 ); |
| [178](#L178) | } |
| [179](#L179) |  |
| [180](#L180) | Rsssl\_Two\_Factor\_Email::set\_user\_status( $parameters->user\_id, 'active' ); |
| [181](#L181) | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $parameters->user\_id, 'disabled' ); |
| [182](#L182) | // Mark all other statuses as inactive. |
| [183](#L183) | self::set\_other\_providers\_inactive( $parameters->user\_id, 'email' ); |
| [184](#L184) |  |
| [185](#L185) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [186](#L186) | } |
| [187](#L187) |  |
| [188](#L188) | /\*\* |
| [189](#L189) | \* Resends the email code for a user. |
| [190](#L190) | \* |
| [191](#L191) | \* @param WP\_REST\_Request $request The REST request object. |
| [192](#L192) | \* |
| [193](#L193) | \* @return WP\_REST\_Response The REST response object. |
| [194](#L194) | \*/ |
| [195](#L195) | public function resend\_email\_code( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [196](#L196) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [197](#L197) | Rsssl\_Two\_Factor\_Email::get\_instance()->generate\_and\_email\_token($parameters->user, $parameters->profile); |
| [198](#L198) | return new WP\_REST\_Response( array( 'message' => \_\_('A verification code has been sent to the email address associated with your account to verify functionality.', 'really-simple.ssl-pro') ), 200 ); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* Verifies the 2FA code for TOTP. |
| [203](#L203) | \* |
| [204](#L204) | \* @param WP\_REST\_Request $request The REST request object. |
| [205](#L205) | \* |
| [206](#L206) | \* @return WP\_REST\_Response The REST response object. |
| [207](#L207) | \*/ |
| [208](#L208) | public function verify\_2fa\_code\_totp( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [209](#L209) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [210](#L210) | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [211](#L211) | // Check if the provider. |
| [212](#L212) | if ( 'totp' !== $parameters->provider ) { |
| [213](#L213) | $response = new WP\_REST\_Response( array( 'error' => \_\_('Invalid provider', 'really-simple-ssl') ), 400 ); |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | //This is an extra check so someone who thinks to use backup codes can't use them. |
| [217](#L217) | $code\_backup = Rsssl\_Two\_Factor\_Backup\_Codes::sanitize\_code\_from\_request( 'authcode', 8 ); |
| [218](#L218) | if ( $code\_backup && Rsssl\_Two\_Factor\_Backup\_Codes::validate\_code( $user, $code\_backup, false ) ) { |
| [219](#L219) | $error\_message = \_\_('Invalid Two Factor Authentication code.', 'really-simple-ssl'); |
| [220](#L220) | return new WP\_REST\_Response( array( 'error' => $error\_message ), 400 ); |
| [221](#L221) | } |
| [222](#L222) |  |
| [223](#L223) | if ( Rsssl\_Two\_Factor\_Totp::setup\_totp( $user, $parameters->key, $parameters->code ) ) { |
| [224](#L224) | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $user->ID, 'active' ); |
| [225](#L225) | Rsssl\_Two\_Factor\_Email::set\_user\_status( $user->ID, 'disabled' ); |
| [226](#L226) | // Mark all other statuses as inactive. |
| [227](#L227) | self::set\_other\_providers\_inactive( $user->ID, 'totp' ); |
| [228](#L228) | // Finally we redirect the user to the redirect\_to page. |
| [229](#L229) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | // We get the error message from the setup\_totp function. |
| [233](#L233) | $error\_message = get\_transient( 'rsssl\_error\_message\_' . $user->ID ); |
| [234](#L234) | // We delete the transient. |
| [235](#L235) | delete\_transient( 'rsssl\_error\_message\_' . $user->ID ); |
| [236](#L236) | return  new WP\_REST\_Response( array( 'error' => $error\_message ), 400 ); |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | /\*\* |
| [240](#L240) | \* Disables two-factor authentication for the user. |
| [241](#L241) | \* |
| [242](#L242) | \* @param WP\_REST\_Request $request The REST request object. |
| [243](#L243) | \* |
| [244](#L244) | \* @return WP\_REST\_Response The REST response object. |
| [245](#L245) | \*/ |
| [246](#L246) | public function disable\_two\_fa\_for\_user( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [247](#L247) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [248](#L248) | // As a double we check the user\_id with the login nonce. |
| [249](#L249) | $user = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
| [250](#L250) |  |
| [251](#L251) | // We get all the available providers for the user. |
| [252](#L252) | $user\_available\_providers = Rsssl\_Provider\_Loader::get\_providers(); |
| [253](#L253) |  |
| [254](#L254) | foreach ( $user\_available\_providers as $provider ) { |
| [255](#L255) | /\*\* |
| [256](#L256) | \* Set the user status to disable. |
| [257](#L257) | \* |
| [258](#L258) | \* @var Rsssl\_Two\_Factor\_Provider $provider |
| [259](#L259) | \*/ |
| [260](#L260) | $provider::set\_user\_status( $user->ID, 'disabled' ); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | // Finally we redirect the user to the redirect\_to page. |
| [264](#L264) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [265](#L265) | } |
| [266](#L266) |  |
| [267](#L267) | /\*\* |
| [268](#L268) | \* Skips the onboarding process for the user. |
| [269](#L269) | \* |
| [270](#L270) | \* @param WP\_REST\_Request $request The REST request object. |
| [271](#L271) | \* |
| [272](#L272) | \* @return WP\_REST\_Response The REST response object. |
| [273](#L273) | \*/ |
| [274](#L274) | public function skip\_onboarding( WP\_REST\_Request $request ): WP\_REST\_Response { |
| [275](#L275) | $parameters = new Rsssl\_Request\_Parameters( $request ); |
| [276](#L276) | // As a double we check the user\_id with the login nonce. |
| [277](#L277) | $user = $this->check\_login\_and\_get\_user( (int)$parameters->user\_id, $parameters->login\_nonce ); |
| [278](#L278) | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | /\*\* |
| [282](#L282) | \* Registers API routes for the application. |
| [283](#L283) | \*/ |
| [284](#L284) | public function register\_api\_routes(): void { |
| [285](#L285) | register\_rest\_route( |
| [286](#L286) | self::NAMESPACE, |
| [287](#L287) | '/save\_default\_method\_email', |
| [288](#L288) | array( |
| [289](#L289) | 'methods'             => 'POST', |
| [290](#L290) | 'callback'            => array( $this, 'set\_as\_email' ), |
| [291](#L291) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [292](#L292) | return true;  // Allow all requests; handle auth in the callback. |
| [293](#L293) | }, |
| [294](#L294) | 'args'                => array( |
| [295](#L295) | 'provider'    => array( |
| [296](#L296) | 'required' => true, |
| [297](#L297) | 'type'     => 'string', |
| [298](#L298) | ), |
| [299](#L299) | 'user\_id'     => array( |
| [300](#L300) | 'required' => true, |
| [301](#L301) | 'type'     => 'integer', |
| [302](#L302) | ), |
| [303](#L303) | 'login\_nonce' => array( |
| [304](#L304) | 'required' => true, |
| [305](#L305) | 'type'     => 'string', |
| [306](#L306) | ), |
| [307](#L307) | ), |
| [308](#L308) | ) |
| [309](#L309) | ); |
| [310](#L310) |  |
| [311](#L311) | register\_rest\_route( |
| [312](#L312) | self::NAMESPACE, |
| [313](#L313) | '/save\_default\_method\_email\_profile', |
| [314](#L314) | array( |
| [315](#L315) | 'methods'             => 'POST', |
| [316](#L316) | 'callback'            => array( $this, 'set\_profile\_email' ), |
| [317](#L317) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [318](#L318) | return true;  // Allow all requests; handle auth in the callback. |
| [319](#L319) | }, |
| [320](#L320) | 'args'                => array( |
| [321](#L321) | 'provider'    => array( |
| [322](#L322) | 'required' => true, |
| [323](#L323) | 'type'     => 'string', |
| [324](#L324) | ), |
| [325](#L325) | 'user\_id'     => array( |
| [326](#L326) | 'required' => true, |
| [327](#L327) | 'type'     => 'integer', |
| [328](#L328) | ), |
| [329](#L329) | 'login\_nonce' => array( |
| [330](#L330) | 'required' => true, |
| [331](#L331) | 'type'     => 'string', |
| [332](#L332) | ), |
| [333](#L333) | ), |
| [334](#L334) | ) |
| [335](#L335) | ); |
| [336](#L336) |  |
| [337](#L337) | register\_rest\_route( |
| [338](#L338) | self::NAMESPACE, |
| [339](#L339) | '/validate\_email\_setup', |
| [340](#L340) | array( |
| [341](#L341) | 'methods' => 'POST', |
| [342](#L342) | 'callback' => array( $this, 'validate\_email\_setup' ), |
| [343](#L343) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [344](#L344) | return true;  // Allow all requests; handle auth in the callback. |
| [345](#L345) | }, |
| [346](#L346) | 'args' => array( |
| [347](#L347) | 'provider' => array( |
| [348](#L348) | 'required' => true, |
| [349](#L349) | 'type' => 'string', |
| [350](#L350) | ), |
| [351](#L351) | 'user\_id' => array( |
| [352](#L352) | 'required' => true, |
| [353](#L353) | 'type' => 'integer', |
| [354](#L354) | ), |
| [355](#L355) | 'login\_nonce' => array( |
| [356](#L356) | 'required' => true, |
| [357](#L357) | 'type' => 'string', |
| [358](#L358) | ), |
| [359](#L359) | 'redirect\_to' => array( |
| [360](#L360) | 'required' => false, |
| [361](#L361) | 'type' => 'string', |
| [362](#L362) | ), |
| [363](#L363) | 'token' => array( |
| [364](#L364) | 'required' => true, |
| [365](#L365) | 'type' => 'string', |
| [366](#L366) | ), |
| [367](#L367) | ), |
| [368](#L368) | ) |
| [369](#L369) | ); |
| [370](#L370) |  |
| [371](#L371) | register\_rest\_route( |
| [372](#L372) | self::NAMESPACE, |
| [373](#L373) | '/resend\_email\_code', |
| [374](#L374) | array( |
| [375](#L375) | 'methods' => 'POST', |
| [376](#L376) | 'callback' => array( $this, 'resend\_email\_code' ), |
| [377](#L377) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [378](#L378) | return true;  // Allow all requests; handle auth in the callback. |
| [379](#L379) | }, |
| [380](#L380) | 'args' => array( |
| [381](#L381) | 'provider' => array( |
| [382](#L382) | 'required' => true, |
| [383](#L383) | 'type' => 'string', |
| [384](#L384) | ), |
| [385](#L385) | 'user\_id' => array( |
| [386](#L386) | 'required' => true, |
| [387](#L387) | 'type' => 'integer', |
| [388](#L388) | ), |
| [389](#L389) | 'login\_nonce' => array( |
| [390](#L390) | 'required' => true, |
| [391](#L391) | 'type' => 'string', |
| [392](#L392) | ), |
| [393](#L393) | ), |
| [394](#L394) | ) |
| [395](#L395) | ); |
| [396](#L396) |  |
| [397](#L397) | register\_rest\_route( |
| [398](#L398) | self::NAMESPACE, |
| [399](#L399) | '/save\_default\_method\_totp', |
| [400](#L400) | array( |
| [401](#L401) | 'methods'             => 'POST', |
| [402](#L402) | 'callback'            => array( $this, 'verify\_2fa\_code\_totp' ), |
| [403](#L403) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [404](#L404) | return true;  // Allow all requests; handle auth in the callback. |
| [405](#L405) | }, |
| [406](#L406) | 'args'                => array( |
| [407](#L407) | 'two-factor-totp-authcode' => array( |
| [408](#L408) | 'required' => true, |
| [409](#L409) | 'type'     => 'string', |
| [410](#L410) | ), |
| [411](#L411) | 'provider'                 => array( |
| [412](#L412) | 'required' => true, |
| [413](#L413) | 'type'     => 'string', |
| [414](#L414) | ), |
| [415](#L415) | 'key'                      => array( |
| [416](#L416) | 'required' => true, |
| [417](#L417) | 'type'     => 'string', |
| [418](#L418) | ), |
| [419](#L419) | 'redirect\_to'              => array( |
| [420](#L420) | 'required' => false, |
| [421](#L421) | 'type'     => 'string', |
| [422](#L422) | ), |
| [423](#L423) | ), |
| [424](#L424) | ) |
| [425](#L425) | ); |
| [426](#L426) |  |
| [427](#L427) | register\_rest\_route( |
| [428](#L428) | self::NAMESPACE, |
| [429](#L429) | 'do\_not\_ask\_again', |
| [430](#L430) | array( |
| [431](#L431) | 'methods'             => 'POST', |
| [432](#L432) | 'callback'            => array( $this, 'disable\_two\_fa\_for\_user' ), |
| [433](#L433) | 'permission\_callback' => function ( WP\_REST\_Request $request ) { |
| [434](#L434) | return true;  // Allow all requests; handle auth in the callback. |
| [435](#L435) | }, |
| [436](#L436) | 'args'                => array( |
| [437](#L437) | 'redirect\_to' => array( |
| [438](#L438) | 'required' => false, |
| [439](#L439) | 'type'     => 'string', |
| [440](#L440) | ), |
| [441](#L441) | 'user\_id'     => array( |
| [442](#L442) | 'required' => true, |
| [443](#L443) | 'type'     => 'integer', |
| [444](#L444) | ), |
| [445](#L445) | 'login\_nonce' => array( |
| [446](#L446) | 'required' => true, |
| [447](#L447) | 'type'     => 'string', |
| [448](#L448) | ), |
| [449](#L449) | ), |
| [450](#L450) | ) |
| [451](#L451) | ); |
| [452](#L452) |  |
| [453](#L453) | register\_rest\_route( |
| [454](#L454) | self::NAMESPACE, |
| [455](#L455) | 'skip\_onboarding', |
| [456](#L456) | array( |
| [457](#L457) | 'methods'             => 'POST', |
| [458](#L458) | 'callback'            => array( $this, 'skip\_onboarding' ), |
| [459](#L459) | 'permission\_callback' => '\_\_return\_true', |
| [460](#L460) | 'args'                => array( |
| [461](#L461) | 'redirect\_to' => array( |
| [462](#L462) | 'required' => false, |
| [463](#L463) | 'type'     => 'string', |
| [464](#L464) | ), |
| [465](#L465) | 'user\_id'     => array( |
| [466](#L466) | 'required' => true, |
| [467](#L467) | 'type'     => 'integer', |
| [468](#L468) | ), |
| [469](#L469) | 'login\_nonce' => array( |
| [470](#L470) | 'required' => true, |
| [471](#L471) | 'type'     => 'string', |
| [472](#L472) | ), |
| [473](#L473) | ), |
| [474](#L474) | ) |
| [475](#L475) | ); |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | /\*\* |
| [479](#L479) | \* Sets all other providers to inactive. |
| [480](#L480) | \* |
| [481](#L481) | \* @param  int    $id  The user ID. |
| [482](#L482) | \* @param  string $allowed\_method  The allowed method. |
| [483](#L483) | \* |
| [484](#L484) | \* @return void |
| [485](#L485) | \*/ |
| [486](#L486) | public static function set\_other\_providers\_inactive( int $id, string $allowed\_method ): void { |
| [487](#L487) | // First we get all the available providers for the user. |
| [488](#L488) | // We get the user from the id. |
| [489](#L489) | $user\_available\_providers = Rsssl\_Provider\_Loader::get\_enabled\_providers\_for\_user( get\_user\_by( 'id', $id ) ); |
| [490](#L490) | foreach ( $user\_available\_providers as $provider ) { |
| [491](#L491) | $namespace\_parts = explode( '\\', $provider ); |
| [492](#L492) | $last\_key        = end( $namespace\_parts ); |
| [493](#L493) | // we explode the last key to get the provider name. |
| [494](#L494) | $provider\_name = explode( '\_', $last\_key ); |
| [495](#L495) | $provider\_name = end( $provider\_name ); |
| [496](#L496) | if ( ucfirst( $allowed\_method ) !== $provider\_name ) { |
| [497](#L497) | $provider::set\_user\_status( $id, 'disabled' ); |
| [498](#L498) | } |
| [499](#L499) | } |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | /\*\* |
| [503](#L503) | \* Sanitizes a token. |
| [504](#L504) | \* |
| [505](#L505) | \* @param string $token The token to sanitize. |
| [506](#L506) | \* @param int $length The expected length of the token. Default is 0. |
| [507](#L507) | \* |
| [508](#L508) | \* @return string|false The sanitized token, or false if the length is invalid. |
| [509](#L509) | \*/ |
| [510](#L510) | public static function sanitize\_token(string $token, int $length = 0 ) { |
| [511](#L511) | $code = wp\_unslash( $token ); |
| [512](#L512) | $code = preg\_replace( '/\s+/', '', $code ); |
| [513](#L513) |  |
| [514](#L514) | // Maybe validate the length. |
| [515](#L515) | if ( $length && strlen( $code ) !== $length ) { |
| [516](#L516) | return false; |
| [517](#L517) | } |
| [518](#L518) |  |
| [519](#L519) | return (string) $code; |
| [520](#L520) | } |
| [521](#L521) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?format=txt)
* [Original Format](/export/3222472/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_fc8c98bd_20250114_204938.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Really Simple Security (Free, Pro, and Pro Multisite) 9.0.0 - 9.1.1.1 - Authentication Bypass

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Really Simple Security (Free, Pro, and Pro Multisite) 9.0.0 - 9.1.1.1 - Authentication Bypass

9.8

**Authentication Bypass Using an Alternate Path or Channel**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-10924](https://www.cve.org/CVERecord?id=CVE-2024-10924) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | November 14, 2024 |
| Last Updated | November 15, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Really Simple Security (Free, Pro, and Pro Multisite) plugins for WordPress are vulnerable to authentication bypass in versions 9.0.0 to 9.1.1.1. This is due to improper user check error handling in the two-factor REST API actions with the 'check\_login\_and\_get\_user' function. This makes it possible for unauthenticated attackers to log in as any existing user on the site, such as an administrator, when the "Two-Factor Authentication" setting is enabled (disabled by default).

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php#L67)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php#L277)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/really-simple-ssl/tags/9.1.1.1/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php#L278)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3188431/really-simple-ssl)
* [www.wordfence.com](https://www.wordfence.com/blog/2024/11/really-simple-security-vulnerability/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fdetail%2Freally-simple-security-free-pro-and-pro-multisite-900-9111-authentication-bypass&t=Really%20Simple%20Security%20%28Free%2C%20Pro%2C%20and%20Pro%20Multisite%29%209.0.0%20-%209.1.1.1%20-%20Authentication%20Bypass "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fdetail%2Freally-simple-security-free-pro-and-pro-multisite-900-9111-authentication-bypass&text=Really%20Simple%20Security%20%28Free%2C%20Pro%2C%20and%20Pro%20Multisite%29%209.0.0%20-%209.1.1.1%20-%20Authentication%20Bypass "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fdetail%2Freally-simple-security-free-pro-and-pro-multisite-900-9111-authentication-bypass "LinkedIn")
Email

## 3 affected software packages

#### [Really Simple Security – Simple and Performant Security (formerly Really Simple SSL)](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/really-simple-ssl)

| Software Type | Plugin |
| --- | --- |
| Software Slug | really-simple-ssl [(view on wordpress.org)](https://wordpress.org/plugins/really-simple-ssl) |
| Patched? | Yes |
| Remediation | Update to version 9.1.2, or a newer patched version |
| Affected Version | * 9.0.0 - 9.1.1.1 |
| Patched Version | * 9.1.2 |

#### [Really Simple Security Pro](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/really-simple-ssl-pro)

| Software Type | Plugin |
| --- | --- |
| Software Slug | really-simple-ssl-pro |
| Patched? | Yes |
| Remediation | Update to version 9.1.2, or a newer patched version |
| Affected Version | * 9.0.0 - 9.1.1.1 |
| Patched Version | * 9.1.2 |

#### [Really Simple Security Pro multisite](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/really-simple-ssl-pro-multisite)

| Software Type | Plugin |
| --- | --- |
| Software Slug | really-simple-ssl-pro-multisite |
| Patched? | Yes |
| Remediation | Update to version 9.1.2, or a newer patched version |
| Affected Version | * 9.0.0 - 9.1.1.1 |
| Patched Version | * 9.1.2 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_3b2e9329_20250114_204935.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3188431%2Freally-simple-ssl)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3182372/really-simple-ssl "Changeset 3182372 for really-simple-ssl")
* [Next Change](/changeset/3188444/really-simple-ssl "Changeset 3188444 for really-simple-ssl") →

---

# Changeset [3188431](/changeset/3188431 "Show full changeset") for [really-simple-ssl](/browser/really-simple-ssl?rev=3188431 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
11/14/2024 08:22:47 AM
([2 months](/timeline?from=2024-11-14T08%3A22%3A47Z&precision=second "See timeline at 11/14/2024 08:22:47 AM") ago)

Author:
RogierLankhorst
Message:

prepare for update

Location:
[really-simple-ssl](/browser/really-simple-ssl?rev=3188431)
Files:

4 deleted
5 edited

* [tags/8.1.3](/browser/really-simple-ssl/tags/8.1.3?rev=3087854 "Show what was removed (content at revision 3188430)")
  (deleted)
* [tags/8.1.4](/browser/really-simple-ssl/tags/8.1.4?rev=3100996 "Show what was removed (content at revision 3188430)")
  (deleted)
* [tags/8.1.5](/browser/really-simple-ssl/tags/8.1.5?rev=3105679 "Show what was removed (content at revision 3188430)")
  (deleted)
* [tags/8.1.6](/browser/really-simple-ssl/tags/8.1.6?rev=3127380 "Show what was removed (content at revision 3188430)")
  (deleted)
* [trunk/readme.txt](/browser/really-simple-ssl/trunk/readme.txt?rev=3188431 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [trunk/rlrsssl-really-simple-ssl.php](/browser/really-simple-ssl/trunk/rlrsssl-really-simple-ssl.php?rev=3188431 "Show entry in browser")
  (modified)
  ([2 diffs](#file5 "Show differences"))
* [trunk/security/wordpress/two-fa/class-rsssl-request-parameters.php](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-request-parameters.php?rev=3188431 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))
* [trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3188431 "Show entry in browser")
  (modified)
  ([8 diffs](#file7 "Show differences"))
* [trunk/security/wordpress/two-fa/class-rsssl-two-factor.php](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor.php?rev=3188431 "Show entry in browser")
  (modified)
  ([1 diff](#file8 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [really-simple-ssl/trunk/readme.txt](/changeset/3188431/really-simple-ssl/trunk/readme.txt "Show the changeset 3188431 restricted to really-simple-ssl/trunk/readme.txt")

  | [r3182372](/browser/really-simple-ssl/trunk/readme.txt?rev=3182372#L152 "Show revision 3182372 of this file in browser") | [r3188431](/browser/really-simple-ssl/trunk/readme.txt?rev=3188431#L152 "Show revision 3188431 of this file in browser") |  |
  | --- | --- | --- |
  | 152 | 152 |  |
  | 153 | 153 | == Changelog == |
  |  | 154 | = 9.1.2 = |
  |  | 155 | \* security: authentication bypass |
  |  | 156 |  |
  | 154 | 157 | = 9.1.1.1 = |
  | 155 | 158 | \* November 5th, 2024 |
  | 156 |  | \*Improvement: updated black friday dates |
  |  | 159 | \*Improvement: updated black friday dates |
  | 157 | 160 |  |
  | 158 | 161 | = 9.1.1 = |
* ## [really-simple-ssl/trunk/rlrsssl-really-simple-ssl.php](/changeset/3188431/really-simple-ssl/trunk/rlrsssl-really-simple-ssl.php "Show the changeset 3188431 restricted to really-simple-ssl/trunk/rlrsssl-really-simple-ssl.php")

  | [r3182368](/browser/really-simple-ssl/trunk/rlrsssl-really-simple-ssl.php?rev=3182368#L4 "Show revision 3182368 of this file in browser") | [r3188431](/browser/really-simple-ssl/trunk/rlrsssl-really-simple-ssl.php?rev=3188431#L4 "Show revision 3188431 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI: https://really-simple-ssl.com |
  | 5 | 5 | \* Description: Easily improve site security with WordPress Hardening, Two-Factor Authentication (2FA), Login Protection, Vulnerability Detection and SSL certificate generation. |
  | 6 |  | \* Version: 9.1.~~1.1~~ |
  |  | 6 | \* Version: 9.1.2 |
  | 7 | 7 | \* Requires at least: 5.9 |
  | 8 | 8 | \* Requires PHP: 7.4 |
  | […](/browser/really-simple-ssl/trunk/rlrsssl-really-simple-ssl.php?rev=3182368#L104) | […](/browser/really-simple-ssl/trunk/rlrsssl-really-simple-ssl.php?rev=3188431#L104) |  |
  | 104 | 104 | define('rsssl\_file', \_\_FILE\_\_); |
  | 105 | 105 | } |
  | 106 |  | define('rsssl\_version', '9.1.~~1.1~~'); |
  |  | 106 | define('rsssl\_version', '9.1.2'); |
  | 107 | 107 | define('rsssl\_le\_cron\_generation\_renewal\_check', 20); |
  | 108 | 108 | define('rsssl\_le\_manual\_generation\_renewal\_check', 15); |
* ## [really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-request-parameters.php](/changeset/3188431/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-request-parameters.php "Show the changeset 3188431 restricted to really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-request-parameters.php")

  | [r3172795](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-request-parameters.php?rev=3172795#L96 "Show revision 3172795 of this file in browser") | [r3188431](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-request-parameters.php?rev=3188431#L96 "Show revision 3188431 of this file in browser") |  |
  | --- | --- | --- |
  | 96 | 96 | $this->user        = get\_user\_by( 'id', $this->user\_id ); |
  | 97 | 97 | $this->provider    = $request->get\_param( 'provider' ); |
  | 98 |  | $this->redirect\_to = $request->get\_param( 'redirect\_to' ); |
  |  | 98 | $this->redirect\_to = $request->get\_param( 'redirect\_to' )?? admin\_url(); |
  | 99 | 99 | if ( 'totp' === $this->provider ) { |
  | 100 | 100 | $this->code = wp\_unslash( $request->get\_param( 'two-factor-totp-authcode' ) ); |
* ## [really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php](/changeset/3188431/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php "Show the changeset 3188431 restricted to really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php")

  | [r3182178](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3182178#L11 "Show revision 3182178 of this file in browser") | [r3188431](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3188431#L11 "Show revision 3188431 of this file in browser") |  |
  | --- | --- | --- |
  | 11 | 11 | namespace RSSSL\Security\WordPress\Two\_Fa; |
  | 12 | 12 |  |
  |  | 13 | use Exception; |
  | 13 | 14 | use WP\_REST\_Request; |
  | 14 | 15 | use WP\_REST\_Response; |
  | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3182178#L65) | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3188431#L66) |  |
  | 65 | 66 | private function check\_login\_and\_get\_user( int $user\_id, string $login\_nonce ) { |
  | 66 | 67 | if ( ! Rsssl\_Two\_Fa\_Authentication::verify\_login\_nonce( $user\_id, $login\_nonce ) ) { |
  | 67 |  | ~~return new WP\_REST\_Response( array( 'error' => 'Invalid login nonce' ), 403 );~~ |
  | 68 |  | ~~}~~ |
  | 69 |  |  |
  |  | 68 | // We throw an error |
  |  | 69 | wp\_die(); |
  |  | 70 | } |
  | 70 | 71 | /\*\* |
  | 71 | 72 | \* Get the user by the user ID. |
  | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3182178#L73) | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3188431#L74) |  |
  | 73 | 74 | \* @var WP\_User $user |
  | 74 | 75 | \*/ |
  | 75 |  | $user = get\_user\_by( 'id', $user\_id ); |
  |  | 76 | $user = get\_user\_by('id', $user\_id); |
  |  | 77 | if (!$user) { |
  |  | 78 | throw new Exception('User not found'); |
  |  | 79 | } |
  |  | 80 |  |
  | 76 | 81 | return $user; |
  | 77 | 82 | } |
  | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3182178#L123) | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3188431#L128) |  |
  | 123 | 128 | \*/ |
  | 124 | 129 | public function set\_as\_email( WP\_REST\_Request $request ): WP\_REST\_Response { |
  | 125 |  | $parameters = new Rsssl\_Request\_Parameters( $request ); |
  | 126 |  | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
  | 127 |  | // Check if the provider. |
  | 128 |  | if ( 'email' !== $parameters->provider ) { |
  | 129 |  | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
  | 130 |  | } |
  | 131 |  |  |
  | 132 |  | // Finally redirect the user to the redirect\_to page with a response. |
  | 133 |  | return $this->start\_email\_validation( $parameters->user\_id, $parameters->redirect\_to , $parameters->profile ); |
  |  | 130 | $parameters = new Rsssl\_Request\_Parameters($request); |
  |  | 131 | try { |
  |  | 132 | $this->check\_login\_and\_get\_user($parameters->user\_id, $parameters->login\_nonce); |
  |  | 133 | } catch (Exception $e) { |
  |  | 134 | return new WP\_REST\_Response(['error' => $e->getMessage()], 403); |
  |  | 135 | } |
  |  | 136 | if ('email' !== $parameters->provider) { |
  |  | 137 | return new WP\_REST\_Response(['error' => 'Invalid provider'], 401); |
  |  | 138 | } |
  |  | 139 |  |
  |  | 140 | return $this->start\_email\_validation($parameters->user\_id, $parameters->redirect\_to, $parameters->profile); |
  | 134 | 141 | } |
  | 135 | 142 |  |
  | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3182178#L142) | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3188431#L149) |  |
  | 142 | 149 | \*/ |
  | 143 | 150 | public function set\_profile\_email(WP\_REST\_Request $request ): WP\_REST\_Response { |
  | 144 |  | $parameters = new Rsssl\_Request\_Parameters( $request ); |
  | 145 |  | $user       = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
  | 146 |  | // Check if the provider. |
  | 147 |  | if ( 'email' !== $parameters->provider ) { |
  | 148 |  | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
  | 149 |  | } |
  | 150 |  |  |
  | 151 |  | // Finally redirect the user to the redirect\_to page with a response. |
  | 152 |  | return $this->start\_email\_validation( $parameters->user\_id, $parameters->redirect\_to, $parameters->profile ); |
  |  | 151 | $parameters = new Rsssl\_Request\_Parameters($request); |
  |  | 152 | try { |
  |  | 153 | $this->check\_login\_and\_get\_user($parameters->user\_id, $parameters->login\_nonce); |
  |  | 154 | } catch (Exception $e) { |
  |  | 155 | return new WP\_REST\_Response(['error' => $e->getMessage()], 403); |
  |  | 156 | } |
  |  | 157 | if ('email' !== $parameters->provider) { |
  |  | 158 | return new WP\_REST\_Response(['error' => 'Invalid provider'], 401); |
  |  | 159 | } |
  |  | 160 |  |
  |  | 161 | return $this->start\_email\_validation($parameters->user\_id, $parameters->redirect\_to, $parameters->profile); |
  | 153 | 162 | } |
  | 154 | 163 |  |
  | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3182178#L161) | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3188431#L170) |  |
  | 161 | 170 | \*/ |
  | 162 | 171 | public function validate\_email\_setup(WP\_REST\_Request $request ): WP\_REST\_Response { |
  | 163 |  | $parameters = new Rsssl\_Request\_Parameters( $request ); |
  | 164 |  | $user = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
  | 165 |  | // Check if the provider. |
  | 166 |  | if ( 'email' !== $parameters->provider ) { |
  | 167 |  | return new WP\_REST\_Response( array( 'error' => 'Invalid provider' ), 401 ); |
  | 168 |  | } |
  | 169 |  | if ( !Rsssl\_Two\_Factor\_Email::get\_instance()->validate\_token( $parameters->user\_id, self::sanitize\_token($parameters->token) ) ) { |
  | 170 |  | // we reset all the settings. |
  | 171 |  | Rsssl\_Two\_Factor\_Email::set\_user\_status( $parameters->user\_id, 'open' ); |
  | 172 |  | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $parameters->user\_id, 'open' ); |
  | 173 |  |  |
  | 174 |  | // we logout the user |
  | 175 |  | wp\_logout(); |
  | 176 |  |  |
  | 177 |  | return new WP\_REST\_Response( array( 'error' =>  \_\_('Code was was invalid, try "Resend Code"', 'really-simple.ssl-pro') ), 401 ); |
  | 178 |  | } |
  | 179 |  |  |
  | 180 |  | Rsssl\_Two\_Factor\_Email::set\_user\_status( $parameters->user\_id, 'active' ); |
  | 181 |  | Rsssl\_Two\_Factor\_Totp::set\_user\_status( $parameters->user\_id, 'disabled' ); |
  | 182 |  | // Mark all other statuses as inactive. |
  | 183 |  | self::set\_other\_providers\_inactive( $parameters->user\_id, 'email' ); |
  | 184 |  |  |
  | 185 |  | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
  |  | 172 | $parameters = new Rsssl\_Request\_Parameters($request); |
  |  | 173 |  |
  |  | 174 | if ('email' !== $parameters->provider) { |
  |  | 175 | return new WP\_REST\_Response(['error' => 'Invalid provider'], 401); |
  |  | 176 | } |
  |  | 177 |  |
  |  | 178 | if (!Rsssl\_Two\_Factor\_Email::get\_instance()->validate\_token($parameters->user\_id, self::sanitize\_token($parameters->token))) { |
  |  | 179 | Rsssl\_Two\_Factor\_Email::set\_user\_status($parameters->user\_id, 'open'); |
  |  | 180 | Rsssl\_Two\_Factor\_Totp::set\_user\_status($parameters->user\_id, 'open'); |
  |  | 181 | wp\_logout(); |
  |  | 182 | return new WP\_REST\_Response(['error' => \_\_('Code was invalid, try "Resend Code"', 'really-simple.ssl-pro')], 401); |
  |  | 183 | } |
  |  | 184 |  |
  |  | 185 | Rsssl\_Two\_Factor\_Email::set\_user\_status($parameters->user\_id, 'active'); |
  |  | 186 | Rsssl\_Two\_Factor\_Totp::set\_user\_status($parameters->user\_id, 'disabled'); |
  |  | 187 | self::set\_other\_providers\_inactive($parameters->user\_id, 'email'); |
  |  | 188 |  |
  |  | 189 | return $this->authenticate\_and\_redirect($parameters->user\_id, $parameters->redirect\_to); |
  | 186 | 190 | } |
  | 187 | 191 |  |
  | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3182178#L245) | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3188431#L249) |  |
  | 245 | 249 | \*/ |
  | 246 | 250 | public function disable\_two\_fa\_for\_user( WP\_REST\_Request $request ): WP\_REST\_Response { |
  | 247 |  | $parameters = new Rsssl\_Request\_Parameters( $request ); |
  | 248 |  | // As a double we check the user\_id with the login nonce. |
  | 249 |  | $user = $this->check\_login\_and\_get\_user( $parameters->user\_id, $parameters->login\_nonce ); |
  | 250 |  |  |
  | 251 |  | // We get all the available providers for the user. |
  |  | 251 | $parameters = new Rsssl\_Request\_Parameters($request); |
  |  | 252 | try { |
  |  | 253 | $user = $this->check\_login\_and\_get\_user($parameters->user\_id, $parameters->login\_nonce); |
  |  | 254 | } catch (Exception $e) { |
  |  | 255 | return new WP\_REST\_Response(['error' => $e->getMessage()], 403); |
  |  | 256 | } |
  |  | 257 |  |
  | 252 | 258 | $user\_available\_providers = Rsssl\_Provider\_Loader::get\_providers(); |
  | 253 |  |  |
  | 254 |  | foreach ( $user\_available\_providers as $provider ) { |
  | 255 |  | /\*\* |
  | 256 |  | \* Set the user status to disable. |
  | 257 |  | \* |
  | 258 |  | \* @var Rsssl\_Two\_Factor\_Provider $provider |
  | 259 |  | \*/ |
  | 260 |  | $provider::set\_user\_status( $user->ID, 'disabled' ); |
  | 261 |  | } |
  | 262 |  |  |
  | 263 |  | // Finally we redirect the user to the redirect\_to page. |
  | 264 |  | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
  |  | 259 | foreach ($user\_available\_providers as $provider) { |
  |  | 260 | $provider::set\_user\_status($user->ID, 'disabled'); |
  |  | 261 | } |
  |  | 262 |  |
  |  | 263 | return $this->authenticate\_and\_redirect($parameters->user\_id, $parameters->redirect\_to); |
  | 265 | 264 | } |
  | 266 | 265 |  |
  | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3182178#L275) | […](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor-on-board-api.php?rev=3188431#L274) |  |
  | 275 | 274 | $parameters = new Rsssl\_Request\_Parameters( $request ); |
  | 276 | 275 | // As a double we check the user\_id with the login nonce. |
  | 277 |  | $user = $this->check\_login\_and\_get\_user( (int)$parameters->user\_id, $parameters->login\_nonce ); |
  |  | 276 | try { |
  |  | 277 | $this->check\_login\_and\_get\_user($parameters->user\_id, $parameters->login\_nonce); |
  |  | 278 | } catch (Exception $e) { |
  |  | 279 | return new WP\_REST\_Response(['error' => $e->getMessage()], 403); |
  |  | 280 | } |
  | 278 | 281 | return $this->authenticate\_and\_redirect( $parameters->user\_id, $parameters->redirect\_to ); |
  | 279 | 282 | } |
* ## [really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor.php](/changeset/3188431/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor.php "Show the changeset 3188431 restricted to really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor.php")

  | [r3182178](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor.php?rev=3182178#L358 "Show revision 3182178 of this file in browser") | [r3188431](/browser/really-simple-ssl/trunk/security/wordpress/two-fa/class-rsssl-two-factor.php?rev=3188431#L358 "Show revision 3188431 of this file in browser") |  |
  | --- | --- | --- |
  | 358 | 358 | update\_user\_meta($user\_id, 'rsssl\_two\_fa\_status\_email', 'active'); |
  | 359 | 359 | update\_user\_meta($user\_id, 'rsssl\_two\_fa\_status\_totp', 'disabled'); |
  |  | 360 | delete\_user\_meta( $user\_id, '\_rsssl\_factor\_email\_token' ); |
  | 360 | 361 | } |
  | 361 | 362 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3188431)
* [Zip Archive](?format=zip&new=3188431)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_7007fb0b_20250114_204936.html ===


![4,000,000 WordPress Sites Using Really Simple Security Free and Pro Versions Affected by Critical Authentication Bypass Vulnerability](https://www.wordfence.com/wp-content/uploads/2024/11/FeaturedImage_Wordfence_157.02.03.png)

[![](https://secure.gravatar.com/avatar/d6e64b55520015fd6d41f1f8e93ca086?s=80&d=mm&r=g)István Márton](https://www.wordfence.com/blog/author/istvanwf/)

November 14, 2024

# 4,000,000 WordPress Sites Using Really Simple Security Free and Pro Versions Affected by Critical Authentication Bypass Vulnerability

**Introductory Note:** This is one of the more serious vulnerabilities that we have reported on in our 12 year history as a security provider for WordPress. This vulnerability affects **Really Simple Security, formerly known as Really Simple SSL**, installed on over 4 million websites, and allows an attacker to remotely gain full administrative access to a site running the plugin.

The vulnerability is scriptable, meaning that it can be turned into a large scale automated attack, targeting WordPress websites. The vendor worked with the WordPress plugins team to force-update all sites running this plugin before we published this post.

**You Can Help** by creating as much awareness around this issue in the community as possible, ensuring that any laggard and unmaintained sites update to the patched version. We encourage hosting providers to force-update their customers and perform scans on their hosting filesystems to ensure no customer is running an unpatched version of this plugin.

**It’s important to note that the Pro versions of this plugin are also affected by this vulnerability and sites running the premium versions should verify that they have automatically updated, so please do help get the word out. It appears that sites without a valid license may not have auto-updates functioning.**

![](https://www.wordfence.com/wp-content/uploads/2024/11/image-21.png)

## The Details

On November 6th, 2024, our Wordfence Threat Intelligence team identified and began the responsible disclosure process for an Authentication Bypass vulnerability in the [Really Simple Security plugin](https://wordpress.org/plugins/really-simple-ssl/), and in the [Really Simple Security Pro and Pro Multisite plugins](https://really-simple-ssl.com/pro/), which are actively installed on more than 4,000,000 WordPress websites. The vulnerability makes it possible for an attacker to remotely gain access to any account on the site, including the administrator account, when the two-factor authentication feature is enabled.

[Wordfence Premium](https://www.wordfence.com/products/wordfence-premium/), [Wordfence Care](https://www.wordfence.com/products/wordfence-care/), and [Wordfence Response](https://www.wordfence.com/products/wordfence-response/) users received a firewall rule to protect against any exploits targeting this vulnerability on November 6, 2024. Sites using the free version of Wordfence will receive the same protection 30 days later on December 6, 2024.

We contacted the Really Simple Plugins team on November 6, 2024, and received a response on November 7, 2024. After providing full disclosure details, the developer released the patch for the Pro plugins on November 12, 2024, and for the Free plugin on November 14, 2024.

Due to the critical severity of this vulnerability (CVSS score 9.8 Critical), the plugin vendor worked with the WordPress.org plugins team to push a forced security update to the patched version, 9.1.2, for anyone running a vulnerable version of the plugin. This means most sites should already be patched or will be patched soon, however, we urge users to verify that their sites were updated to the latest patched version of Really Simple Security, version 9.1.2 at the time of this writing, as soon as possible if running version 9.0.0 or newer. A [thread in the WordPress.org](https://wordpress.org/support/topic/plugin-updating-automatically-with-auto-updates-disabled-3/) forum for the plugin indicates that the forced updates began this morning and may continue over the next few days.

## Vulnerability Summary from Wordfence Intelligence

**Description:** [Really Simple Security (Free, Pro, and Pro Multisite) 9.0.0 – 9.1.1.1 – Authentication Bypass](https://www.wordfence.com/threat-intel/vulnerabilities/detail/really-simple-security-free-pro-and-pro-multisite-900-9111-authentication-bypass)

**Affected Plugins:** Really Simple Security, Really Simple Security Pro, Really Simple Security Pro Multisite

**Plugin Slugs:** [really-simple-ssl](https://wordpress.org/plugins/really-simple-ssl/), [really-simple-ssl-pro](https://really-simple-ssl.com/pro/), [really-simple-ssl-pro-multisite](https://really-simple-ssl.com/pro/)

**Affected Versions:** 9.0.0 – 9.1.1.1

**CVE ID:** [CVE-2024-10924](https://www.cve.org/CVERecord?id=CVE-2024-10924)

**CVSS Score:** 9.8 (Critical)

**CVSS Vector:** [CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

**Researcher/s:** István Márton (Wordfence)

**Fully Patched Version:** 9.1.2

The Really Simple Security (Free, Pro, and Pro Multisite) plugins for WordPress are vulnerable to authentication bypass in versions 9.0.0 to 9.1.1.1. This is due to improper user check error handling in the two-factor REST API actions with the ‘check\_login\_and\_get\_user’ function. This makes it possible for unauthenticated attackers to log in as any existing user on the site, such as an administrator, when the “Two-Factor Authentication” setting is enabled (disabled by default).

## Technical Analysis

The Really Simple Security plugin, formerly known as Really Simple SSL, was recently renamed with the latest major version update and has been expanded with many security features like login protection, vulnerability detection, and two-factor authentication. Unfortunately, one of the features adding two-factor authentication was insecurely implemented making it possible for unauthenticated attackers to gain access to any user account, including an administrator account, with a simple request when two-factor authentication is enabled.

Examining the code reveals that the plugin uses the `skip_onboarding()` function in the `Rsssl_Two_Factor_On_Board_Api` class to handle authentication via REST API.

```
public function skip_onboarding( WP_REST_Request $request ): WP_REST_Response {
	$parameters = new Rsssl_Request_Parameters( $request );
	// As a double we check the user_id with the login nonce.
	$user = $this->check_login_and_get_user( (int)$parameters->user_id, $parameters->login_nonce );
	return $this->authenticate_and_redirect( $parameters->user_id, $parameters->redirect_to );
}
```

The `check_login_and_get_user()` function verifies the user using the `user_id` and `login_nonce` parameters.

```
private function check_login_and_get_user( int $user_id, string $login_nonce ) {
	if ( ! Rsssl_Two_Fa_Authentication::verify_login_nonce( $user_id, $login_nonce ) ) {
		return new WP_REST_Response( array( 'error' => 'Invalid login nonce' ), 403 );
	}

	/**
	 * Get the user by the user ID.
	 *
	 * @var WP_User $user
	 */
	$user = get_user_by( 'id', $user_id );
	return $user;
}
```

The most significant problem and vulnerability is caused by the fact that the function returns a `WP_REST_Response` error in case of a failure, but this is not handled within the function. This means that even in the case of an invalid nonce, the function processing continues and invokes `authenticate_and_redirect()`, which authenticates the user based on the user id passed in the request, even when that user’s identity hasn’t been verified.

Ultimately, this makes it possible for threat actors to bypass authentication and gain access to arbitrary accounts on sites running a vulnerable version of the plugin. As always, authentication bypass vulnerabilities and resulting access to high privileged user accounts, make it easy for threat actors to completely compromise a vulnerable WordPress site and further infect it.

This vulnerability only critically affects site owners who have enabled “Two-Factor Authentication” in the plugin settings.

## Wordfence Firewall Protection Mechanism

Wordfence has protected our Premium, Care and Response customers against this exploit **since November 6th, 2024**. The following graphic demonstrates how an attacker might exploit this vulnerability, and how the Wordfence firewall intercepts the malicious request and protects a site from exploitation by an attacker.

[![](https://www.wordfence.com/wp-content/uploads/2024/11/really-simple-ssl-auth-bypass-howto-wordfence-firewall.png)](https://www.wordfence.com/wp-content/uploads/2024/11/really-simple-ssl-auth-bypass-howto-wordfence-firewall.png)

The Wordfence firewall rule detects the malicious REST API action and blocks the request.

## Disclosure Timeline

**November 6, 2024** – Wordfence Threat Intelligence team discovered the Authentication Bypass vulnerability in the Really Simple Security plugins.

**November 6, 2024** – [Wordfence Premium](https://www.wordfence.com/products/wordfence-premium/), [Care](https://www.wordfence.com/products/wordfence-care/), and [Response](https://www.wordfence.com/products/wordfence-response/) users received a firewall rule to provide protection against any exploits that may target this vulnerability.

**November 6, 2024** – We initiated contact with the plugin vendor asking them to confirm the inbox for handling the discussion.

**November 7, 2024** – We initiated contact again using the plugin vendor’s alternative email address.

**November 7, 2024** – The vendor confirmed the inbox for handling the discussion.

**November 7, 2024** – We sent over the full disclosure details to the vendor. The vendor acknowledged the report and began working on a fix. During this time, the vendor also co-ordinated with the plugins team to push this out as a security release.

**November 12, 2024** – The fully patched version of the Really Simple Security Pro plugins, 9.1.2, were released.

**November 13, 2024** – We informed the vendor that it is security best practice is to release the patched version as soon as possible along with a signal that a security issue was resolved.

**November 14, 2024** – The fully patched version of the Really Simple Security Free plugin, 9.1.2, was released and forced updates were initiated.

**December 6, 2024** – Wordfence Free users receive the same protection.

## Conclusion

In this blog post, we detailed an Authentication Bypass vulnerability within the Really Simple Security plugin and within the Really Simple Security Pro and Pro Multisite plugins affecting versions 9.0.0 through 9.1.1.1. This vulnerability allows threat actors to bypass authentication and gain access to the accounts of any user, including administrators. The vulnerability has been fully addressed in version 9.1.2 of the plugin.

We encourage WordPress users to verify that their sites are updated to the latest patched version of Really Simple Security as soon as possible, considering the critical nature of this vulnerability.

[Wordfence Premium](https://www.wordfence.com/products/wordfence-premium/), [Wordfence Care](https://www.wordfence.com/products/wordfence-care/), and [Wordfence Response](https://www.wordfence.com/products/wordfence-response/) users received a firewall rule to protect against any exploits targeting this vulnerability on November 6, 2024. Sites using the free version of Wordfence will receive the same protection 30 days later on December 6, 2024.

**If you know someone who uses these plugins on their site, we recommend sharing this advisory with them to ensure their site remains secure, as this vulnerability poses a significant risk.**

Search

### Trust Your Site to the Leader in WordPress Security

Wordfence includes an endpoint firewall, malware scanner, robust login security features, live traffic views, and more. Discover why over 5 million WordPress sites put their trust in Wordfence.

[Protect Your Site](/products/pricing/)

**Did you enjoy this post? Share it!**

[*Facebook*](http://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.wordfence.com%2Fblog%2F2024%2F11%2Freally-simple-security-vulnerability%2F)
[*Twitter*](https://twitter.com/share?url=https%3A%2F%2Fwww.wordfence.com%2Fblog%2F2024%2F11%2Freally-simple-security-vulnerability%2F&text=4%2C000%2C000%20WordPress%20Sites%20Using%20Really%20Simple%20Security%20Free%20and%20Pro%20Versions%20Affected%20by%20Critical%20Authentication%20Bypass%20Vulnerability&via=wordfence)
[*LinkedIn*](https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fwww.wordfence.com%2Fblog%2F2024%2F11%2Freally-simple-security-vulnerability%2F)

## Comments

No Comments

### Breaking WordPress Security Research in your inbox as it happens.

![Example of a news story](/img/footer-news-example.jpg)

This site uses cookies in accordance with our [Privacy Policy](/privacy-policy).

Cookie Settings
Accept All

## Cookie Options

For additional information on how this site uses cookies, please review our [Privacy Policy](/privacy-policy). The cookies used by this site are classified into the following categories and can be configured below.

### Strictly Necessary

These Cookies are necessary for the Sites and Services to work properly. They include any essential authentication and authorization cookies for the Services.

\* Cookies of this category are necessary for the site to function and cannot be disabled.

### Performance/Analytical

These Cookies allow us to collect certain information about how you navigate the Sites or utilize the Services running on your device. They help us understand which areas you use and what we can do to improve them.

### Targeting

These Cookies are used to deliver relevant information related to the Services to an identified machine or other device (not a named or otherwise identifiable person) which has previously been used to visit our Sites. Some of these types of Cookies on our Sites are operated by third parties with our permission and are used to identify advertising sources that are effectively driving customers to our Sites.

Cancel
Save


