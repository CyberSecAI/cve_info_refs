=== Content from www.wordfence.com_058e41b2_20250114_205117.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Hustle – Email Marketing, Lead Generation, Optins, Popups <= 7.8.5 - Missing Authorization to Unauthorized Form Submission

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Hustle – Email Marketing, Lead Generation, Optins, Popups <= 7.8.5 - Missing Authorization to Unauthorized Form Submission

5.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-10580](https://www.cve.org/CVERecord?id=CVE-2024-10580) |
| --- | --- |
| CVSS | 5.3 (Medium) |
| Publicly Published | November 26, 2024 |
| Last Updated | November 27, 2024 |
| Researcher | [Vijaysimha Reddy (vijaysimha)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/vijaysimha-reddy) |

### Description

The Hustle – Email Marketing, Lead Generation, Optins, Popups plugin for WordPress is vulnerable to unauthorized form submissions due to a missing capability check on the submit\_form() function in all versions up to, and including, 7.8.5. This makes it possible for unauthenticated attackers to submit unpublished forms.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wordpress-popup/tags/7.8.5/inc/front/hustle-module-front-ajax.php#L251)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3196639/wordpress-popup/tags/7.8.6/inc/front/hustle-module-front-ajax.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwordpress-popup%2Fhustle-email-marketing-lead-generation-optins-popups-785-missing-authorization-to-unauthorized-form-submission&t=Hustle%20%E2%80%93%20Email%20Marketing%2C%20Lead%20Generation%2C%20Optins%2C%20Popups%20%3C%3D%207.8.5%20-%20Missing%20Authorization%20to%20Unauthorized%20Form%20Submission "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwordpress-popup%2Fhustle-email-marketing-lead-generation-optins-popups-785-missing-authorization-to-unauthorized-form-submission&text=Hustle%20%E2%80%93%20Email%20Marketing%2C%20Lead%20Generation%2C%20Optins%2C%20Popups%20%3C%3D%207.8.5%20-%20Missing%20Authorization%20to%20Unauthorized%20Form%20Submission "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwordpress-popup%2Fhustle-email-marketing-lead-generation-optins-popups-785-missing-authorization-to-unauthorized-form-submission "LinkedIn")
Email

## Vulnerability Details for Hustle – Email Marketing, Lead Generation, Optins, Popups

#### [Hustle – Email Marketing, Lead Generation, Optins, Popups](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wordpress-popup)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wordpress-popup [(view on wordpress.org)](https://wordpress.org/plugins/wordpress-popup) |
| Patched? | Yes |
| Remediation | Update to version 7.8.6, or a newer patched version |
| Affected Version | * <= 7.8.5 |
| Patched Version | * 7.8.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_352e4e99_20250114_205115.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3196639%2Fwordpress-popup%2Ftags%2F7.8.6%2Finc%2Ffront%2Fhustle-module-front-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2933986/wordpress-popup/trunk/inc/front/hustle-module-front-ajax.php "Changeset 2933986 for wordpress-popup/tags/7.8.6/inc/front/hustle-module-front-ajax.php")
* Next Change →

---

# Changeset [3196639](/changeset/3196639 "Show full changeset") for [wordpress-popup/tags/7.8.6/inc/front/hustle-module-front-ajax.php](/browser/wordpress-popup/tags/7.8.6/inc/front/hustle-module-front-ajax.php?rev=3196639 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
11/25/2024 03:26:43 PM
([7 weeks](/timeline?from=2024-11-25T15%3A26%3A43Z&precision=second "See timeline at 11/25/2024 03:26:43 PM") ago)

Author:
panoslyrakis
Message:

Update Version 7.8.6

Location:
[wordpress-popup/tags/7.8.6](/browser/wordpress-popup/tags/7.8.6?rev=3196639)
Files:

1 edited
1 copied

* [.](/browser/wordpress-popup/tags/7.8.6?rev=3196639 "Show entry in browser")
  (copied)
  *(copied from [wordpress-popup/trunk](/browser/wordpress-popup/trunk?rev=3131145 "Show original file (revision 3196624)"))*
* [inc/front/hustle-module-front-ajax.php](/browser/wordpress-popup/tags/7.8.6/inc/front/hustle-module-front-ajax.php?rev=3196639 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wordpress-popup/tags/7.8.6/inc/front/hustle-module-front-ajax.php](/changeset/3196639/wordpress-popup/tags/7.8.6/inc/front/hustle-module-front-ajax.php "Show the changeset 3196639 restricted to wordpress-popup/tags/7.8.6/inc/front/hustle-module-front-ajax.php")

  | [r2933986](/browser/wordpress-popup/trunk/inc/front/hustle-module-front-ajax.php?rev=2933986#L257 "Show revision 2933986 of this file in browser") | [r3196639](/browser/wordpress-popup/tags/7.8.6/inc/front/hustle-module-front-ajax.php?rev=3196639#L257 "Show revision 3196639 of this file in browser") |  |
  | --- | --- | --- |
  | 257 | 257 | } |
  | 258 | 258 | $module\_id = sanitize\_text\_field( wp\_unslash( $\_POST['data']['module\_id'] ) );// phpcs:ignore WordPress.Security.NonceVerification.Missing |
  |  | 259 | $module    = new Hustle\_Module\_Model( $module\_id ); |
  |  | 260 |  |
  |  | 261 | if ( is\_wp\_error( $module ) || ! $module instanceof Hustle\_Module\_Model || ! property\_exists( $module, 'active' ) ) { |
  |  | 262 | wp\_send\_json\_error( \_\_( 'Invalid module', 'hustle' ) ); |
  |  | 263 | } |
  |  | 264 |  |
  |  | 265 | if ( ! $module->active ) { |
  |  | 266 | wp\_send\_json\_error( \_\_( 'Module is not active', 'hustle' ) ); |
  |  | 267 | } |
  | 259 | 268 |  |
  | 260 | 269 | // Action called before full form submit. |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3196639)
* [Zip Archive](?format=zip&new=3196639)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_67db742c_20250114_205111.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwordpress-popup%2Ftags%2F7.8.5%2Finc%2Ffront%2Fhustle-module-front-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wordpress-popup/trunk/inc/front/hustle-module-front-ajax.php?rev=2900135 "Revision 2900135")
* [Next Revision](/browser/wordpress-popup/trunk/inc/front/hustle-module-front-ajax.php?rev=3196639 "Revision 3196639") →
* [Blame](/browser/wordpress-popup/trunk/inc/front/hustle-module-front-ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wordpress-popup/tags/7.8.5/inc/front/hustle-module-front-ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [wordpress-popup](/browser/wordpress-popup?order=name "View wordpress-popup")/[tags](/browser/wordpress-popup/tags?order=name "View tags")/[7.8.5](/browser/wordpress-popup/tags/7.8.5?order=name "View 7.8.5")/[inc](/browser/wordpress-popup/tags/7.8.5/inc?order=name "View inc")/[front](/browser/wordpress-popup/tags/7.8.5/inc/front?order=name "View front")/[hustle-module-front-ajax.php](/browser/wordpress-popup/tags/7.8.5/inc/front/hustle-module-front-ajax.php?order=name "View hustle-module-front-ajax.php")

View diff against:

View revision:

| [Last change](/changeset/2933986/wordpress-popup/trunk/inc/front/hustle-module-front-ajax.php "View differences") on this file was [2933986](/changeset/2933986/ "View changeset 2933986"), checked in by ivansvyrskyi, [19 months ago](/timeline?from=2023-07-04T14%3A08%3A00Z&precision=second "See timeline at 07/04/2023 02:08:00 PM") |
| --- |
| Release 7.8.0 |
| **File size:** 40.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Hustle\_Module\_Front\_Ajax |
| [4](#L4) | \* |
| [5](#L5) | \* @package Hustle |
| [6](#L6) | \*/ |
| [7](#L7) |  |
| [8](#L8) | /\*\* |
| [9](#L9) | \* Class Hustle\_Module\_Front\_Ajax |
| [10](#L10) | \*/ |
| [11](#L11) | class Hustle\_Module\_Front\_Ajax { |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* Constructor |
| [15](#L15) | \*/ |
| [16](#L16) | public function \_\_construct() { |
| [17](#L17) |  |
| [18](#L18) | // When module is viewed. |
| [19](#L19) | add\_action( 'wp\_ajax\_hustle\_module\_viewed', array( $this, 'module\_viewed' ) ); |
| [20](#L20) | add\_action( 'wp\_ajax\_nopriv\_hustle\_module\_viewed', array( $this, 'module\_viewed' ) ); |
| [21](#L21) |  |
| [22](#L22) | // When module form is submitted. |
| [23](#L23) | add\_action( 'wp\_ajax\_hustle\_module\_form\_submit', array( $this, 'submit\_form' ) ); |
| [24](#L24) | add\_action( 'wp\_ajax\_nopriv\_hustle\_module\_form\_submit', array( $this, 'submit\_form' ) ); |
| [25](#L25) |  |
| [26](#L26) | // Update the number of shares of each network. |
| [27](#L27) | add\_action( 'wp\_ajax\_hustle\_update\_network\_shares', array( $this, 'get\_networks\_native\_shares' ) ); |
| [28](#L28) | add\_action( 'wp\_ajax\_nopriv\_hustle\_update\_network\_shares', array( $this, 'get\_networks\_native\_shares' ) ); |
| [29](#L29) |  |
| [30](#L30) | // When a conversion happens. |
| [31](#L31) | add\_action( 'wp\_ajax\_hustle\_module\_converted', array( $this, 'log\_module\_conversion' ) ); |
| [32](#L32) | add\_action( 'wp\_ajax\_nopriv\_hustle\_module\_converted', array( $this, 'log\_module\_conversion' ) ); |
| [33](#L33) |  |
| [34](#L34) | // Update the stored click counter. |
| [35](#L35) | add\_action( 'wp\_ajax\_hustle\_sshare\_click\_counted', array( $this, 'update\_sshare\_click\_counter' ) ); |
| [36](#L36) | add\_action( 'wp\_ajax\_nopriv\_hustle\_sshare\_click\_counted', array( $this, 'update\_sshare\_click\_counter' ) ); |
| [37](#L37) |  |
| [38](#L38) | // Handles unsubscribe form submisisons. |
| [39](#L39) | add\_action( 'wp\_ajax\_hustle\_unsubscribe\_form\_submission', array( $this, 'unsubscribe\_submit\_form' ) ); |
| [40](#L40) | add\_action( 'wp\_ajax\_nopriv\_hustle\_unsubscribe\_form\_submission', array( $this, 'unsubscribe\_submit\_form' ) ); |
| [41](#L41) |  |
| [42](#L42) | // Check the schedule (avoiding pages static cache). |
| [43](#L43) | add\_action( 'wp\_ajax\_hustle\_module\_display\_despite\_static\_cache', array( $this, 'module\_display\_despite\_static\_cache' ) ); |
| [44](#L44) | add\_action( 'wp\_ajax\_nopriv\_hustle\_module\_display\_despite\_static\_cache', array( $this, 'module\_display\_despite\_static\_cache' ) ); |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | /\*\* |
| [48](#L48) | \* Replace value if it's a dinamic one based on submited fields |
| [49](#L49) | \* |
| [50](#L50) | \* @param string $value The current value. |
| [51](#L51) | \* @param array  $form\_data The submitted form data. |
| [52](#L52) | \* @return string final value |
| [53](#L53) | \*/ |
| [54](#L54) | private function maybe\_replace\_to\_field( $value, $form\_data ) { |
| [55](#L55) | if ( ! empty( $value ) && '{' === $value[0] && '}' === substr( $value, -1 ) ) { |
| [56](#L56) | $field = trim( $value, '{}' ); |
| [57](#L57) | $value = ! empty( $form\_data[ $field ] ) ? $form\_data[ $field ] : $value; |
| [58](#L58) | } |
| [59](#L59) |  |
| [60](#L60) | return $value; |
| [61](#L61) | } |
| [62](#L62) |  |
| [63](#L63) | /\*\* |
| [64](#L64) | \* Replace common placeholders and current field placeholders |
| [65](#L65) | \* |
| [66](#L66) | \* @param int    $module\_id Module ID. |
| [67](#L67) | \* @param string $text Text. |
| [68](#L68) | \* @param array  $form\_data Submitted data. |
| [69](#L69) | \* @return string Replaced text |
| [70](#L70) | \*/ |
| [71](#L71) | private function replace\_placeholders( $module\_id, $text, $form\_data ) { |
| [72](#L72) | preg\_match\_all( '/\{[^}]\*\}/', $text, $matches ); |
| [73](#L73) |  |
| [74](#L74) | if ( ! empty( $matches[0] ) && is\_array( $matches[0] ) ) { |
| [75](#L75) | $site\_placeholders   = array( |
| [76](#L76) | '{site\_url}'   => site\_url(), |
| [77](#L77) | '{site\_title}' => get\_bloginfo( 'name' ), |
| [78](#L78) | ); |
| [79](#L79) | $module              = new Hustle\_Module\_Model( $module\_id ); |
| [80](#L80) | $local\_list\_settings = ! is\_wp\_error( $module ) ? $module->get\_provider\_settings( 'local\_list' ) : ''; |
| [81](#L81) | if ( ! empty( $local\_list\_settings['local\_list\_name'] ) ) { |
| [82](#L82) | $site\_placeholders['{local\_list}'] = $local\_list\_settings['local\_list\_name']; |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | foreach ( $matches[0] as $placeholder ) { |
| [86](#L86) | // find common placeholders. |
| [87](#L87) | if ( key\_exists( $placeholder, $site\_placeholders ) ) { |
| [88](#L88) | $value = $site\_placeholders[ $placeholder ]; |
| [89](#L89) | } else { |
| [90](#L90) | // find field placeholders. |
| [91](#L91) | $value = $this->maybe\_replace\_to\_field( $placeholder, $form\_data ); |
| [92](#L92) | } |
| [93](#L93) |  |
| [94](#L94) | if ( $value !== $placeholder ) { |
| [95](#L95) | // replace if we found something. |
| [96](#L96) | $text = str\_replace( $placeholder, $value, $text ); |
| [97](#L97) | } |
| [98](#L98) | } |
| [99](#L99) | } |
| [100](#L100) |  |
| [101](#L101) | return $text; |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | /\*\* |
| [105](#L105) | \* Check the schedule |
| [106](#L106) | \*/ |
| [107](#L107) | public function module\_display\_despite\_static\_cache() { |
| [108](#L108) | $module\_id = filter\_input( INPUT\_POST, 'module\_id', FILTER\_VALIDATE\_INT ); |
| [109](#L109) | if ( ! $module\_id ) { |
| [110](#L110) | wp\_send\_json\_error( \_\_( 'Invalid module ID!', 'hustle' ) ); |
| [111](#L111) | } |
| [112](#L112) | $module = Hustle\_Module\_Collection::instance()->return\_model\_from\_id( $module\_id ); |
| [113](#L113) | if ( is\_wp\_error( $module ) ) { |
| [114](#L114) | wp\_send\_json\_error( \_\_( 'Invalid module!', 'hustle' ) ); |
| [115](#L115) | } |
| [116](#L116) | $is\_scheduled = true; |
| [117](#L117) |  |
| [118](#L118) | // Check the schedule. Ssharing modules don't have schedules. |
| [119](#L119) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE !== $module->module\_type |
| [120](#L120) | && ! $module->get\_settings()->is\_currently\_scheduled() ) { |
| [121](#L121) | $is\_scheduled = false; |
| [122](#L122) | } |
| [123](#L123) |  |
| [124](#L124) | if ( ! $is\_scheduled ) { |
| [125](#L125) | wp\_send\_json\_success( array( 'display' => false ) ); |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | $avoid\_static\_cache = Opt\_In\_Utils::is\_static\_cache\_enabled(); |
| [129](#L129) | $passed\_conditions  = true; |
| [130](#L130) | if ( $avoid\_static\_cache ) { |
| [131](#L131) | $sub\_type         = filter\_input( INPUT\_POST, 'subType', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [132](#L132) | $module->sub\_type = $sub\_type; |
| [133](#L133) | // Check visibility conditions. |
| [134](#L134) | $passed\_conditions = $module->is\_condition\_allow(); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | wp\_send\_json\_success( array( 'display' => $passed\_conditions ) ); |
| [138](#L138) | } |
| [139](#L139) |  |
| [140](#L140) | /\*\* |
| [141](#L141) | \* Send auto email if it sets |
| [142](#L142) | \* |
| [143](#L143) | \* @param Hustle\_Module\_Model $module Module. |
| [144](#L144) | \*/ |
| [145](#L145) | public function send\_automated\_email( Hustle\_Module\_Model $module ) { |
| [146](#L146) | $module\_id       = $module->module\_id; |
| [147](#L147) | $emails\_settings = $module->get\_emails()->to\_array(); |
| [148](#L148) |  |
| [149](#L149) | if ( empty( $emails\_settings['automated\_email'] ) || '1' !== $emails\_settings['automated\_email'] |
| [150](#L150) | || empty( $emails\_settings['email\_time'] ) ) { |
| [151](#L151) | return; |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | $recipient     = ! empty( $emails\_settings['recipient'] ) ? $emails\_settings['recipient'] : ''; |
| [155](#L155) | $email\_subject = ! empty( $emails\_settings['email\_subject'] ) ? $emails\_settings['email\_subject'] : ''; |
| [156](#L156) | $email\_body    = ! empty( $emails\_settings['email\_body'] ) ? $emails\_settings['email\_body'] : ''; |
| [157](#L157) |  |
| [158](#L158) | $data = filter\_input( INPUT\_POST, 'data', FILTER\_DEFAULT, FILTER\_REQUIRE\_ARRAY ); |
| [159](#L159) | parse\_str( $data['form'], $form\_data ); |
| [160](#L160) |  |
| [161](#L161) | $to      = apply\_filters( 'hustle\_automated\_email\_recipient', $recipient, $module\_id, $data, $form\_data ); |
| [162](#L162) | $subject = apply\_filters( 'hustle\_automated\_email\_email\_subject', $email\_subject, $module\_id, $data, $form\_data ); |
| [163](#L163) | $body    = apply\_filters( 'hustle\_automated\_email\_email\_body', $email\_body, $module\_id, $data, $form\_data ); |
| [164](#L164) |  |
| [165](#L165) | $to   = $this->replace\_placeholders( $module\_id, $to, $form\_data ); |
| [166](#L166) | $body = $this->replace\_placeholders( $module\_id, $body, $form\_data ); |
| [167](#L167) |  |
| [168](#L168) | // Replace {hustle\_unsubscribe\_link} placeholder. |
| [169](#L169) | if ( false !== strpos( $body, '{hustle\_unsubscribe\_link}' ) ) { |
| [170](#L170) | if ( ! empty( $form\_data['hustle\_module\_id'] ) ) { |
| [171](#L171) | $modules\_id      = array( $form\_data['hustle\_module\_id'] ); |
| [172](#L172) | $unsubscribe\_url = Hustle\_Mail::get\_unsubscribe\_link( $to, $modules\_id ); |
| [173](#L173) | } else { |
| [174](#L174) | $unsubscribe\_url = ''; |
| [175](#L175) | } |
| [176](#L176) | $body = str\_replace( '{hustle\_unsubscribe\_link}', esc\_url( $unsubscribe\_url ), $body ); |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | $subject = $this->replace\_placeholders( $module\_id, $subject, $form\_data ); |
| [180](#L180) |  |
| [181](#L181) | // Send the email right away if it's set as 'instant'. |
| [182](#L182) | if ( 'instant' === $emails\_settings['email\_time'] ) { |
| [183](#L183) | Hustle\_Mail::send\_email( $to, $subject, $body ); |
| [184](#L184) | return; |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | // Adding the 4th parameter time() to prevent cron jobs from being ignored. |
| [188](#L188) | // According to wp\_schedule\_single\_event docs: |
| [189](#L189) | // "Attempts to schedule an event after an event of the same name and $args will also be ignored". |
| [190](#L190) | $args = array( $to, $subject, $body, time() ); |
| [191](#L191) | if ( 'delay' === $emails\_settings['email\_time'] ) { |
| [192](#L192) | $time = ! empty( $emails\_settings['auto\_email\_time'] ) ? (int) $emails\_settings['auto\_email\_time'] : ''; |
| [193](#L193) | $unit = ! empty( $emails\_settings['auto\_email\_unit'] ) ? $emails\_settings['auto\_email\_unit'] : ''; |
| [194](#L194) | // get delay rate. |
| [195](#L195) | switch ( $unit ) { |
| [196](#L196) | case 'days': |
| [197](#L197) | $rate = DAY\_IN\_SECONDS; |
| [198](#L198) | break; |
| [199](#L199) | case 'hours': |
| [200](#L200) | $rate = HOUR\_IN\_SECONDS; |
| [201](#L201) | break; |
| [202](#L202) | case 'minutes': |
| [203](#L203) | $rate = MINUTE\_IN\_SECONDS; |
| [204](#L204) | break; |
| [205](#L205) | default: |
| [206](#L206) | $rate = 1; |
| [207](#L207) | break; |
| [208](#L208) | } |
| [209](#L209) | $schedule\_time = time() + $time \* $rate; |
| [210](#L210) | } elseif ( 'schedule' === $emails\_settings['email\_time'] ) { |
| [211](#L211) | // time settings. |
| [212](#L212) | $time = ! empty( $emails\_settings['time'] ) ? $emails\_settings['time'] : ''; |
| [213](#L213) | $day  = ! empty( $emails\_settings['day'] ) ? $emails\_settings['day'] : ''; |
| [214](#L214) | $time = $this->maybe\_replace\_to\_field( $time, $form\_data ); |
| [215](#L215) | $day  = $this->maybe\_replace\_to\_field( $day, $form\_data ); |
| [216](#L216) |  |
| [217](#L217) | // delay settings. |
| [218](#L218) | $delay\_time = ! empty( $emails\_settings['schedule\_auto\_email\_time'] ) ? (int) $emails\_settings['schedule\_auto\_email\_time'] : 0; |
| [219](#L219) | $delay\_unit = ! empty( $emails\_settings['schedule\_auto\_email\_unit'] ) ? $emails\_settings['schedule\_auto\_email\_unit'] : ''; |
| [220](#L220) |  |
| [221](#L221) | // get delay rate. |
| [222](#L222) | switch ( $delay\_unit ) { |
| [223](#L223) | case 'days': |
| [224](#L224) | $delay\_rate = DAY\_IN\_SECONDS; |
| [225](#L225) | break; |
| [226](#L226) | case 'hours': |
| [227](#L227) | $delay\_rate = HOUR\_IN\_SECONDS; |
| [228](#L228) | break; |
| [229](#L229) | case 'minutes': |
| [230](#L230) | $delay\_rate = MINUTE\_IN\_SECONDS; |
| [231](#L231) | break; |
| [232](#L232) | default: |
| [233](#L233) | $delay\_rate = 1; |
| [234](#L234) | break; |
| [235](#L235) | } |
| [236](#L236) | // schedule time calculation. |
| [237](#L237) | $delay = $delay\_time \* $delay\_rate; |
| [238](#L238) | // convert from local time to GMT. |
| [239](#L239) | $schedule\_time = get\_gmt\_from\_date( date( 'Y-m-d H:i:s', strtotime( $day . ' ' . $time ) ), 'U' );// phpcs:ignore WordPress.DateTime.RestrictedFunctions.date\_date |
| [240](#L240) | $schedule\_time = $schedule\_time + $delay; |
| [241](#L241) | if ( time() > $schedule\_time ) { |
| [242](#L242) | return; |
| [243](#L243) | } |
| [244](#L244) | } |
| [245](#L245) | wp\_schedule\_single\_event( $schedule\_time, 'hustle\_send\_email', $args ); |
| [246](#L246) | } |
| [247](#L247) |  |
| [248](#L248) | /\*\* |
| [249](#L249) | \* Submit form |
| [250](#L250) | \*/ |
| [251](#L251) | public function submit\_form() { |
| [252](#L252) |  |
| [253](#L253) | Hustle\_Provider\_Autoload::initiate\_providers(); |
| [254](#L254) |  |
| [255](#L255) | if ( ! isset( $\_POST['data']['module\_id'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [256](#L256) | return; |
| [257](#L257) | } |
| [258](#L258) | $module\_id = sanitize\_text\_field( wp\_unslash( $\_POST['data']['module\_id'] ) );// phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [259](#L259) |  |
| [260](#L260) | // Action called before full form submit. |
| [261](#L261) | do\_action( 'hustle\_form\_before\_handle\_submit', $module\_id ); |
| [262](#L262) |  |
| [263](#L263) | $response = $this->handle\_form( $module\_id ); |
| [264](#L264) |  |
| [265](#L265) | // Filter submit form response. |
| [266](#L266) | $response = apply\_filters( 'hustle\_form\_submit\_response', $response, $module\_id ); |
| [267](#L267) |  |
| [268](#L268) | // Action called after full form submit. |
| [269](#L269) | do\_action( 'hustle\_form\_after\_handle\_submit', $module\_id, $response ); |
| [270](#L270) |  |
| [271](#L271) | if ( is\_array( $response ) && ! empty( $response ) ) { |
| [272](#L272) | if ( $response['success'] ) { |
| [273](#L273) | wp\_send\_json\_success( $response ); |
| [274](#L274) | } |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | wp\_send\_json\_error( $response ); |
| [278](#L278) | } |
| [279](#L279) |  |
| [280](#L280) | /\*\* |
| [281](#L281) | \* Handles the module's form submission process. |
| [282](#L282) | \* |
| [283](#L283) | \* @since 4.0 |
| [284](#L284) | \* |
| [285](#L285) | \* @param int $module\_id MOdule ID. |
| [286](#L286) | \* @return array |
| [287](#L287) | \*/ |
| [288](#L288) | private function handle\_form( $module\_id ) { |
| [289](#L289) |  |
| [290](#L290) | $data = filter\_input( INPUT\_POST, 'data', FILTER\_DEFAULT, FILTER\_REQUIRE\_ARRAY ); |
| [291](#L291) | parse\_str( $data['form'], $form\_data ); |
| [292](#L292) |  |
| [293](#L293) | // Default error message response. |
| [294](#L294) | $response = array( |
| [295](#L295) | 'message'  => \_\_( 'Error saving form', 'hustle' ), |
| [296](#L296) | 'errors'   => array(), |
| [297](#L297) | 'success'  => false, |
| [298](#L298) | 'behavior' => array(), |
| [299](#L299) | ); |
| [300](#L300) | $module   = new Hustle\_Module\_Model( $module\_id ); |
| [301](#L301) | if ( is\_wp\_error( $module ) ) { |
| [302](#L302) | return $response; |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | $fields             = $module->get\_form\_fields(); |
| [306](#L306) | $field\_data\_array   = array(); |
| [307](#L307) | $placeholder\_array  = array(); |
| [308](#L308) | $submit\_errors      = array(); |
| [309](#L309) | $required\_fields    = array(); |
| [310](#L310) | $fields\_to\_validate = array(); |
| [311](#L311) | $entry              = new Hustle\_Entry\_Model(); |
| [312](#L312) | $entry->entry\_type  = $module->module\_type; |
| [313](#L313) | $entry->module\_id   = $module\_id; |
| [314](#L314) |  |
| [315](#L315) | if ( ! is\_null( $fields ) ) { |
| [316](#L316) |  |
| [317](#L317) | // Verify recaptcha first. |
| [318](#L318) | if ( isset( $fields['recaptcha'] ) ) { |
| [319](#L319) |  |
| [320](#L320) | $submit\_errors = $this->validate\_recaptcha( $form\_data, $fields['recaptcha'] ); |
| [321](#L321) |  |
| [322](#L322) | if ( ! empty( $submit\_errors ) ) { |
| [323](#L323) | // Recaptcha failed. No need to check the other fields. |
| [324](#L324) | $fields = array(); |
| [325](#L325) | } |
| [326](#L326) | } |
| [327](#L327) |  |
| [328](#L328) | foreach ( $fields as $field\_name => $field\_data ) { |
| [329](#L329) | $ignored\_field\_types = Hustle\_Entry\_Model::ignored\_fields(); |
| [330](#L330) | if ( in\_array( $field\_data['type'], $ignored\_field\_types, true ) ) { |
| [331](#L331) | continue; |
| [332](#L332) | } |
| [333](#L333) |  |
| [334](#L334) | if ( 'true' === $field\_data['required'] ) { |
| [335](#L335) | $required\_fields[] = $field\_name; |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | if ( isset( $field\_data['validate'] ) && 'true' === $field\_data['validate'] ) { |
| [339](#L339) | $fields\_to\_validate[] = $field\_name; |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | if ( 'hidden' === $field\_data['type'] ) { |
| [343](#L343) | $form\_data = self::update\_hidden\_value( $field\_data, $form\_data ); |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | if ( isset( $form\_data[ $field\_name ] ) ) { |
| [347](#L347) | $value                             = sanitize\_text\_field( $form\_data[ $field\_name ] ); |
| [348](#L348) | $field\_data\_array[]                = array( |
| [349](#L349) | 'name'  => $field\_name, |
| [350](#L350) | 'value' => $value, |
| [351](#L351) | ); |
| [352](#L352) | $placeholder                       = '{' . $field\_name . '}'; |
| [353](#L353) | $placeholder\_array[ $placeholder ] = $value; |
| [354](#L354) | } |
| [355](#L355) | } |
| [356](#L356) | if ( empty( $submit\_errors ) ) { |
| [357](#L357) | $submit\_errors      = $this->validate\_fields( $form\_data, $required\_fields, $fields\_to\_validate, $fields ); |
| [358](#L358) | $response['errors'] = $submit\_errors; |
| [359](#L359) | } |
| [360](#L360) | } |
| [361](#L361) |  |
| [362](#L362) | if ( ! empty( $field\_data\_array ) && empty( $submit\_errors ) ) { |
| [363](#L363) |  |
| [364](#L364) | // $\_POST doesn't contain everything we need to pass. So do this merge instead. |
| [365](#L365) | $submitted\_data = array\_merge( $data, $form\_data ); |
| [366](#L366) |  |
| [367](#L367) | // Do a pre-flight validation with the providers before submitting any data. |
| [368](#L368) | // As of 4.0 we're only checking whether the user is already subscribed if enabled. |
| [369](#L369) | $integrations\_settings = $module->get\_integrations\_settings()->to\_array(); |
| [370](#L370) |  |
| [371](#L371) | $allow\_subscribed = '1' === $integrations\_settings['allow\_subscribed\_users']; |
| [372](#L372) |  |
| [373](#L373) | $formatted\_submitted\_data = Hustle\_Provider\_Utils::format\_submitted\_data\_for\_addon( $submitted\_data ); |
| [374](#L374) | // Do provider's validation. |
| [375](#L375) | $provider\_error = $this->attach\_addons\_on\_form\_submit( $module\_id, $formatted\_submitted\_data, $allow\_subscribed ); |
| [376](#L376) | if ( true !== $provider\_error ) { |
| [377](#L377) | $response['errors'][] = $provider\_error; |
| [378](#L378) | return $response; |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | $user\_exists = Hustle\_Entry\_Model::is\_email\_subscribed\_to\_module\_id( $module\_id, $submitted\_data['email'] ); |
| [382](#L382) | if ( $user\_exists ) { |
| [383](#L383) | $entry\_id          = Hustle\_Entry\_Model::get\_email\_subscribed\_to\_module\_id( $module\_id, $submitted\_data['email'] ); |
| [384](#L384) | $entry             = new Hustle\_Entry\_Model( $entry\_id ); |
| [385](#L385) | $entry->entry\_type = $module->module\_type; |
| [386](#L386) | $entry->module\_id  = $module\_id; |
| [387](#L387) | } |
| [388](#L388) |  |
| [389](#L389) | $active\_integrations = array(); |
| [390](#L390) |  |
| [391](#L391) | if ( isset( $integrations\_settings['active\_integrations'] ) && ! empty( $integrations\_settings['active\_integrations'] ) ) { |
| [392](#L392) | $active\_integrations = explode( ',', $integrations\_settings['active\_integrations'] ); |
| [393](#L393) | } |
| [394](#L394) |  |
| [395](#L395) | if ( in\_array( 'local\_list', $active\_integrations, true ) ) { |
| [396](#L396) |  |
| [397](#L397) | if ( $user\_exists || $entry->save() ) { |
| [398](#L398) |  |
| [399](#L399) | /\*\* |
| [400](#L400) | \* Check is tracking allowed |
| [401](#L401) | \*/ |
| [402](#L402) | $settings    = Hustle\_Settings\_Admin::get\_privacy\_settings(); |
| [403](#L403) | $ip\_tracking = ! isset( $settings['ip\_tracking'] ) || 'on' === $settings['ip\_tracking']; |
| [404](#L404) | if ( $ip\_tracking ) { |
| [405](#L405) | $field\_data\_array[] = array( |
| [406](#L406) | 'name'  => 'hustle\_ip', |
| [407](#L407) | 'value' => Opt\_In\_Geo::get\_user\_ip(), |
| [408](#L408) | ); |
| [409](#L409) | } |
| [410](#L410) |  |
| [411](#L411) | $active\_integrations = $this->get\_module\_active\_integrations\_to\_store( $module\_id ); |
| [412](#L412) | $field\_data\_array[]  = array( |
| [413](#L413) | 'name'  => 'active\_integrations', |
| [414](#L414) | 'value' => $active\_integrations, |
| [415](#L415) | ); |
| [416](#L416) |  |
| [417](#L417) | // Filter data before saving to db. |
| [418](#L418) | $field\_data\_array = apply\_filters( 'hustle\_form\_submit\_field\_data', $field\_data\_array, $module\_id ); |
| [419](#L419) |  |
| [420](#L420) | // Action before saving to db. |
| [421](#L421) | do\_action( 'hustle\_form\_submit\_before\_set\_fields', $entry, $module\_id, $field\_data\_array ); |
| [422](#L422) |  |
| [423](#L423) | $added\_data\_array = $this->attach\_addons\_add\_entry\_fields( $module\_id, $module, $formatted\_submitted\_data, $field\_data\_array ); |
| [424](#L424) | $added\_data\_array = array\_merge( $field\_data\_array, $added\_data\_array ); |
| [425](#L425) |  |
| [426](#L426) | $entry->set\_fields( $added\_data\_array ); |
| [427](#L427) |  |
| [428](#L428) | } |
| [429](#L429) | } else { |
| [430](#L430) |  |
| [431](#L431) | $active\_integrations = $this->get\_module\_active\_integrations\_to\_store( $module\_id ); |
| [432](#L432) | $field\_data\_array[]  = array( |
| [433](#L433) | 'name'  => 'active\_integrations', |
| [434](#L434) | 'value' => $active\_integrations, |
| [435](#L435) | ); |
| [436](#L436) |  |
| [437](#L437) | // Filter data before saving to db. |
| [438](#L438) | $field\_data\_array = apply\_filters( 'hustle\_form\_submit\_field\_data', $field\_data\_array, $module\_id ); |
| [439](#L439) |  |
| [440](#L440) | // Action before saving to db. |
| [441](#L441) | do\_action( 'hustle\_form\_submit\_before\_set\_fields', $entry, $module\_id, $field\_data\_array ); |
| [442](#L442) |  |
| [443](#L443) | $this->attach\_addons\_add\_entry\_fields( $module\_id, $module, $formatted\_submitted\_data, $field\_data\_array ); |
| [444](#L444) |  |
| [445](#L445) | } |
| [446](#L446) |  |
| [447](#L447) | $this->send\_automated\_email( $module ); |
| [448](#L448) |  |
| [449](#L449) | $post\_id         = sanitize\_text\_field( $form\_data['post\_id'] ); |
| [450](#L450) | $module\_sub\_type = isset( $form\_data['hustle\_sub\_type'] ) ? $form\_data['hustle\_sub\_type'] : null; |
| [451](#L451) | $this->maybe\_log\_conversion( $module, $post\_id, $module\_sub\_type ); |
| [452](#L452) |  |
| [453](#L453) | $emails\_settings = $module->get\_emails()->to\_array(); |
| [454](#L454) | $fields\_array    = wp\_list\_pluck( $field\_data\_array, 'value', 'name' ); |
| [455](#L455) | $success\_message = $this->parse\_message\_with\_fields\_placeholders( $emails\_settings['success\_message'], $placeholder\_array ); |
| [456](#L456) | $success\_message = apply\_filters( 'hustle\_parsed\_success\_message', $success\_message, $module\_id, $module\_sub\_type, $form\_data ); |
| [457](#L457) |  |
| [458](#L458) | $redirect\_url = $this->parse\_message\_with\_fields\_placeholders( $emails\_settings['redirect\_url'], $placeholder\_array ); |
| [459](#L459) |  |
| [460](#L460) | /\*\* |
| [461](#L461) | \* Filters the URL to redirect to on success. |
| [462](#L462) | \* |
| [463](#L463) | \* @since 4.4.1 |
| [464](#L464) | \* |
| [465](#L465) | \* @param string $redirect\_url    The URL to redirect to. Will be passed trough esc\_url\_raw(). |
| [466](#L466) | \* @param string $module\_id       ID of the current module. |
| [467](#L467) | \* @param string $module\_sub\_type Subtype of the current module. |
| [468](#L468) | \* @param array  $form\_data       The submitted data. |
| [469](#L469) | \*/ |
| [470](#L470) | $redirect\_url = apply\_filters( 'hustle\_success\_redirect\_url', $redirect\_url, $module\_id, $module\_sub\_type, $form\_data ); |
| [471](#L471) |  |
| [472](#L472) | /\*\* |
| [473](#L473) | \* Filters redirect tab on success |
| [474](#L474) | \* |
| [475](#L475) | \* @param string $redirect\_tab    Redirect tab ( sametab | newtab\_thankyou | newtab\_hide ) |
| [476](#L476) | \* @param string $module\_id       ID of the current module. |
| [477](#L477) | \* @param string $module\_sub\_type Subtype of the current module. |
| [478](#L478) | \* @param array  $form\_data       The submitted data. |
| [479](#L479) | \*/ |
| [480](#L480) | $redirect\_tab = apply\_filters( 'hustle\_success\_redirect\_tab', $emails\_settings['redirect\_tab'], $module\_id, $module\_sub\_type, $form\_data ); |
| [481](#L481) |  |
| [482](#L482) | $response = array( |
| [483](#L483) | 'message'  => do\_shortcode( wp\_kses\_post( $success\_message ) ), |
| [484](#L484) | 'success'  => true, |
| [485](#L485) | 'errors'   => array(), |
| [486](#L486) | 'behavior' => array( |
| [487](#L487) | 'after\_submit' => $emails\_settings['after\_successful\_submission'], |
| [488](#L488) | 'url'          => esc\_url\_raw( $redirect\_url ), // Using raw here to honor url params. |
| [489](#L489) | 'redirect\_tab' => $redirect\_tab, |
| [490](#L490) | ), |
| [491](#L491) | ); |
| [492](#L492) |  |
| [493](#L493) | if ( ! empty( $emails\_settings['automated\_file'] ) && ! empty( $emails\_settings['auto\_download\_file'] ) ) { |
| [494](#L494) | $explode   = explode( DIRECTORY\_SEPARATOR, $emails\_settings['auto\_download\_file'] ); |
| [495](#L495) | $file\_name = end( $explode ); |
| [496](#L496) |  |
| [497](#L497) | $response['behavior']['file']      = $emails\_settings['auto\_download\_file']; |
| [498](#L498) | $response['behavior']['file\_name'] = $file\_name; |
| [499](#L499) | } |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | if ( ! empty( $submit\_errors ) ) { |
| [503](#L503) | $response = array( |
| [504](#L504) | 'message'  => $this->get\_invalid\_form\_message( $fields ), |
| [505](#L505) | 'success'  => false, |
| [506](#L506) | 'errors'   => $submit\_errors, |
| [507](#L507) | 'behavior' => array(), |
| [508](#L508) | ); |
| [509](#L509) | } |
| [510](#L510) |  |
| [511](#L511) | return $response; |
| [512](#L512) | } |
| [513](#L513) |  |
| [514](#L514) | /\*\* |
| [515](#L515) | \* Update hidden value because it can be changed by user |
| [516](#L516) | \* |
| [517](#L517) | \* @param array $field\_data Field settings. |
| [518](#L518) | \* @param array $form\_data Form data. |
| [519](#L519) | \* @return array |
| [520](#L520) | \*/ |
| [521](#L521) | private static function update\_hidden\_value( $field\_data, $form\_data ) { |
| [522](#L522) | if ( ! empty( $field\_data['name'] ) && ! empty( $field\_data['default\_value'] ) |
| [523](#L523) | // skip some types because it returns wrong values on this state for them. |
| [524](#L524) | && ! in\_array( $field\_data['default\_value'], array( 'query\_parameter', 'embed\_url', 'refer\_url' ), true ) ) { |
| [525](#L525) | $form\_data[ $field\_data['name'] ] = Hustle\_Module\_Renderer::get\_hidden\_value( $field\_data ); |
| [526](#L526) | } |
| [527](#L527) |  |
| [528](#L528) | return $form\_data; |
| [529](#L529) | } |
| [530](#L530) |  |
| [531](#L531) | /\*\* |
| [532](#L532) | \* Do recaptcha backend validation. |
| [533](#L533) | \* |
| [534](#L534) | \* @since 4.0 |
| [535](#L535) | \* @param array $form\_data Form data. |
| [536](#L536) | \* @param array $recaptcha\_field Recaptcha field. |
| [537](#L537) | \* @return array |
| [538](#L538) | \* @throws Exception When reCAPTCHA validation failed. |
| [539](#L539) | \*/ |
| [540](#L540) | private function validate\_recaptcha( $form\_data, $recaptcha\_field ) { |
| [541](#L541) |  |
| [542](#L542) | $submit\_errors      = array(); |
| [543](#L543) | $recaptcha\_settings = Hustle\_Settings\_Admin::get\_recaptcha\_settings(); |
| [544](#L544) | $recaptcha\_version  = empty( $recaptcha\_field['version'] ) ? 'v2\_checkbox' : $recaptcha\_field['version']; |
| [545](#L545) | $recaptcha\_secret   = ! empty( $recaptcha\_settings[ $recaptcha\_version . '\_secret\_key' ] ) ? $recaptcha\_settings[ $recaptcha\_version . '\_secret\_key' ] : ''; |
| [546](#L546) | $recaptcha\_site     = ! empty( $recaptcha\_settings[ $recaptcha\_version . '\_site\_key' ] ) ? $recaptcha\_settings[ $recaptcha\_version . '\_site\_key' ] : ''; |
| [547](#L547) | $token              = ! empty( $form\_data['recaptcha-response'] ) ? $form\_data['recaptcha-response'] : false; |
| [548](#L548) |  |
| [549](#L549) | if ( ! empty( $recaptcha\_secret ) && ! empty( $recaptcha\_site ) ) { |
| [550](#L550) |  |
| [551](#L551) | try { |
| [552](#L552) | $validation\_message = ! empty( $recaptcha\_field['validation\_message'] ) |
| [553](#L553) | ? esc\_html( $recaptcha\_field['validation\_message'] ) : ''; |
| [554](#L554) |  |
| [555](#L555) | if ( ! $token ) { |
| [556](#L556) | throw new Exception( |
| [557](#L557) | ! empty( $validation\_message ) ? $validation\_message |
| [558](#L558) | : esc\_html\_\_( 'reCAPTCHA must be verified to submit the form.', 'hustle' ) |
| [559](#L559) | ); |
| [560](#L560) | } |
| [561](#L561) |  |
| [562](#L562) | $remote\_ip = filter\_input( INPUT\_SERVER, 'HTTP\_X\_FORWARDED\_FOR', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [563](#L563) | if ( ! $remote\_ip ) { |
| [564](#L564) | $remote\_ip = filter\_input( INPUT\_SERVER, 'REMOTE\_ADDR', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [565](#L565) | } |
| [566](#L566) | $response = wp\_remote\_get( |
| [567](#L567) | add\_query\_arg( |
| [568](#L568) | array( |
| [569](#L569) | 'secret'   => $recaptcha\_secret, |
| [570](#L570) | 'response' => $token, |
| [571](#L571) | 'remoteip' => $remote\_ip, |
| [572](#L572) | ), |
| [573](#L573) | 'https://www.google.com/recaptcha/api/siteverify' |
| [574](#L574) | ) |
| [575](#L575) | ); |
| [576](#L576) |  |
| [577](#L577) | if ( is\_wp\_error( $response ) ) { |
| [578](#L578) | throw new Exception( $response->get\_error\_message() ); |
| [579](#L579) | } |
| [580](#L580) |  |
| [581](#L581) | $response\_body = ! empty( $response['body'] ) ? json\_decode( $response['body'] ) : ''; |
| [582](#L582) |  |
| [583](#L583) | if ( empty( $response\_body ) || ! $response\_body->success ) { |
| [584](#L584) | throw new Exception( |
| [585](#L585) | ! empty( $validation\_message ) ? $validation\_message |
| [586](#L586) | : esc\_html\_\_( 'reCAPTCHA validation failed. Please try again.', 'hustle' ) |
| [587](#L587) | ); |
| [588](#L588) | } |
| [589](#L589) |  |
| [590](#L590) | if ( 'v3\_recaptcha' === $recaptcha\_version ) { |
| [591](#L591) | $selected\_score = $recaptcha\_field['threshold']; |
| [592](#L592) |  |
| [593](#L593) | if ( $selected\_score > $response\_body->score ) { |
| [594](#L594) | throw new Exception( |
| [595](#L595) | ! empty( $validation\_message ) ? $validation\_message |
| [596](#L596) | : esc\_html\_\_( 'reCAPTCHA validation failed. The score is too low.', 'hustle' ) |
| [597](#L597) | ); |
| [598](#L598) | } |
| [599](#L599) | } |
| [600](#L600) | } catch ( Exception $e ) { |
| [601](#L601) | $submit\_errors['recaptcha'] = $e->getMessage(); |
| [602](#L602) | } |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | return $submit\_errors; |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | /\*\* |
| [609](#L609) | \* Validate fields. |
| [610](#L610) | \* |
| [611](#L611) | \* @since 4.0 |
| [612](#L612) | \* @since 4.0.2 $fields\_to\_validate parameter added. |
| [613](#L613) | \* |
| [614](#L614) | \* @param array $form\_data Form data. |
| [615](#L615) | \* @param array $required\_fields Rewuired Fields. |
| [616](#L616) | \* @param array $fields\_to\_validate Fields to validate. |
| [617](#L617) | \* @param array $fields Fields. |
| [618](#L618) | \* @return array |
| [619](#L619) | \*/ |
| [620](#L620) | private function validate\_fields( $form\_data, $required\_fields, $fields\_to\_validate, $fields ) { |
| [621](#L621) |  |
| [622](#L622) | $submit\_errors = array(); |
| [623](#L623) |  |
| [624](#L624) | // Check required fields. |
| [625](#L625) | foreach ( $required\_fields as $slug ) { |
| [626](#L626) |  |
| [627](#L627) | if ( ! isset( $form\_data[ $slug ] ) || empty( trim( sanitize\_text\_field( $form\_data[ $slug ] ) ) ) ) { |
| [628](#L628) | $submit\_errors[ $slug ] = $fields[ $slug ]['required\_error\_message']; |
| [629](#L629) | } |
| [630](#L630) | } |
| [631](#L631) |  |
| [632](#L632) | // Validate url and email fields. |
| [633](#L633) | if ( empty( $submit\_errors ) ) { |
| [634](#L634) |  |
| [635](#L635) | foreach ( $fields\_to\_validate as $slug ) { |
| [636](#L636) |  |
| [637](#L637) | // Don't validate empty fields. These are validated under "required" if needed. |
| [638](#L638) | if ( empty( trim( $form\_data[ $slug ] ) ) ) { |
| [639](#L639) | continue; |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | if ( 'email' === $fields[ $slug ]['type'] && ! is\_email( $form\_data[ $slug ] ) || |
| [643](#L643) | 'url' === $fields[ $slug ]['type'] && false === filter\_var( $form\_data[ $slug ], FILTER\_VALIDATE\_URL ) || |
| [644](#L644) | 'datepicker' === $fields[ $slug ]['type'] && false === $this->validate\_date( $form\_data[ $slug ], $fields[ $slug ]['date\_format'] ) ) { |
| [645](#L645) |  |
| [646](#L646) | $submit\_errors[ $slug ] = $fields[ $slug ]['validation\_message']; |
| [647](#L647) |  |
| [648](#L648) | } elseif ( 'timepicker' === $fields[ $slug ]['type'] ) { |
| [649](#L649) |  |
| [650](#L650) | $time         = str\_replace( array( ' AM', ' PM' ), '', $form\_data[ $slug ] ); |
| [651](#L651) | $format       = '12' === $fields[ $slug ]['time\_format'] ? 'h:i' : 'H:i'; |
| [652](#L652) | $created\_time = DateTime::createFromFormat( $format, $time ); |
| [653](#L653) | if ( ! $created\_time || $created\_time->format( $format ) !== $time ) { |
| [654](#L654) | $submit\_errors[ $slug ] = $fields[ $slug ]['validation\_message']; |
| [655](#L655) | } |
| [656](#L656) | } |
| [657](#L657) | } |
| [658](#L658) | } |
| [659](#L659) |  |
| [660](#L660) | return apply\_filters( 'hustle\_module\_submit\_errors\_validated\_fields', $submit\_errors, $form\_data, $required\_fields, $fields\_to\_validate, $fields ); |
| [661](#L661) | } |
| [662](#L662) |  |
| [663](#L663) | /\*\* |
| [664](#L664) | \* Get the generic error message. |
| [665](#L665) | \* |
| [666](#L666) | \* @since 4.0 |
| [667](#L667) | \* |
| [668](#L668) | \* @param array $fields Fields. |
| [669](#L669) | \* @return string |
| [670](#L670) | \*/ |
| [671](#L671) | private function get\_invalid\_form\_message( $fields ) { |
| [672](#L672) |  |
| [673](#L673) | if ( isset( $fields['submit'] ) && isset( $fields['submit']['error\_message'] ) && ! empty( $fields['submit']['error\_message'] ) ) { |
| [674](#L674) | $message = $fields['submit']['error\_message']; |
| [675](#L675) | } else { |
| [676](#L676) | $message = ''; |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | return esc\_html( $message ); |
| [680](#L680) | } |
| [681](#L681) |  |
| [682](#L682) | /\*\* |
| [683](#L683) | \* Replace placeholders |
| [684](#L684) | \* |
| [685](#L685) | \* @param string $raw\_message Message. |
| [686](#L686) | \* @param array  $submitted\_data Submitted data. |
| [687](#L687) | \* @return string |
| [688](#L688) | \*/ |
| [689](#L689) | private function parse\_message\_with\_fields\_placeholders( $raw\_message, $submitted\_data ) { |
| [690](#L690) |  |
| [691](#L691) | $message = str\_replace( |
| [692](#L692) | array\_keys( $submitted\_data ), |
| [693](#L693) | array\_values( $submitted\_data ), |
| [694](#L694) | stripslashes( $raw\_message ) |
| [695](#L695) | ); |
| [696](#L696) |  |
| [697](#L697) | return $message; |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | /\*\* |
| [701](#L701) | \* Log a conversion if tracking is enabled. |
| [702](#L702) | \* |
| [703](#L703) | \* @since 4.0 |
| [704](#L704) | \* |
| [705](#L705) | \* @param int         $module Module ID. |
| [706](#L706) | \* @param int         $page\_id Page ID. |
| [707](#L707) | \* @param string|null $module\_sub\_type Sub type. |
| [708](#L708) | \* @param string|null $cta CTA. |
| [709](#L709) | \*/ |
| [710](#L710) | private function maybe\_log\_conversion( $module, $page\_id, $module\_sub\_type = null, $cta = null ) { |
| [711](#L711) |  |
| [712](#L712) | $type = is\_null( $module\_sub\_type ) ? $module->module\_type : $module\_sub\_type; |
| [713](#L713) |  |
| [714](#L714) | if ( ! $module->is\_tracking\_enabled( $type ) ) { |
| [715](#L715) | return false; |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | $tracking = Hustle\_Tracking\_Model::get\_instance(); |
| [719](#L719) | if ( 'social\_sharing' === $module->module\_type ) { |
| [720](#L720) | $action = 'conversion'; |
| [721](#L721) | } elseif ( $cta ) { |
| [722](#L722) | $action = $cta . '\_conversion'; |
| [723](#L723) | } else { |
| [724](#L724) | $action = 'optin\_conversion'; |
| [725](#L725) | } |
| [726](#L726) | $tracking->save\_tracking( $module->id, $action, $module->module\_type, $page\_id, $module\_sub\_type ); |
| [727](#L727) |  |
| [728](#L728) | return true; |
| [729](#L729) | } |
| [730](#L730) |  |
| [731](#L731) | /\*\* |
| [732](#L732) | \* Get an array with the connected integrations to show in entries. |
| [733](#L733) | \* |
| [734](#L734) | \* @since 4.0 |
| [735](#L735) | \* |
| [736](#L736) | \* @param int $module\_id Module ID. |
| [737](#L737) | \* @return array |
| [738](#L738) | \*/ |
| [739](#L739) | private function get\_module\_active\_integrations\_to\_store( $module\_id ) { |
| [740](#L740) |  |
| [741](#L741) | $active\_integrations = array(); |
| [742](#L742) | $connected\_addons    = Hustle\_Provider\_Utils::get\_addons\_instance\_connected\_with\_module( $module\_id ); |
| [743](#L743) |  |
| [744](#L744) | foreach ( $connected\_addons as $addon ) { |
| [745](#L745) | // Local list is not really an integration to be shown here. |
| [746](#L746) | if ( 'local\_list' === $addon->get\_slug() ) { |
| [747](#L747) | continue; |
| [748](#L748) | } |
| [749](#L749) | $active\_integrations[ $addon->get\_slug() ] = $addon->get\_title(); |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | return $active\_integrations; |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | /\*\* |
| [756](#L756) | \* Executor on form submit for attached addons. |
| [757](#L757) | \* |
| [758](#L758) | \* @see Hustle\_Provider\_Form\_Hooks\_Abstract::on\_form\_submit() |
| [759](#L759) | \* @since 4.0 |
| [760](#L760) | \* |
| [761](#L761) | \* @param int   $module\_id Module ID. |
| [762](#L762) | \* @param array $submitted\_data Data submitted by the user. |
| [763](#L763) | \* @param bool  $allow\_subscribed Allow already subscribed. |
| [764](#L764) | \* @return bool true on success|string error message from addon otherwise |
| [765](#L765) | \*/ |
| [766](#L766) | private function attach\_addons\_on\_form\_submit( $module\_id, $submitted\_data, $allow\_subscribed ) { |
| [767](#L767) |  |
| [768](#L768) | // Find is\_form\_connected. |
| [769](#L769) | $connected\_addons = Hustle\_Provider\_Utils::get\_addons\_instance\_connected\_with\_module( $module\_id ); |
| [770](#L770) |  |
| [771](#L771) | $submitted\_data = Opt\_In\_Utils::validate\_and\_sanitize\_fields( $submitted\_data ); |
| [772](#L772) |  |
| [773](#L773) | foreach ( $connected\_addons as $connected\_addon ) { |
| [774](#L774) | try { |
| [775](#L775) | $slug                     = $connected\_addon->get\_slug(); |
| [776](#L776) | $formatted\_submitted\_data = apply\_filters( 'hustle\_format\_submitted\_data', $submitted\_data, $slug ); |
| [777](#L777) | $form\_hooks               = $connected\_addon->get\_addon\_form\_hooks( $module\_id ); |
| [778](#L778) | if ( $form\_hooks instanceof Hustle\_Provider\_Form\_Hooks\_Abstract ) { |
| [779](#L779) | $addon\_return = $form\_hooks->on\_form\_submit( $formatted\_submitted\_data, $allow\_subscribed ); |
| [780](#L780) | if ( true !== $addon\_return ) { |
| [781](#L781) | return $form\_hooks->get\_submit\_form\_error\_message(); |
| [782](#L782) | } |
| [783](#L783) | } |
| [784](#L784) | } catch ( Exception $e ) { |
| [785](#L785) | Opt\_In\_Utils::maybe\_log( $connected\_addon->get\_slug(), 'failed to attach\_addons\_on\_form\_submit', $e->getMessage() ); |
| [786](#L786) | } |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | return true; |
| [790](#L790) | } |
| [791](#L791) |  |
| [792](#L792) | /\*\* |
| [793](#L793) | \* Executor to add more entry fields for attached addons. |
| [794](#L794) | \* |
| [795](#L795) | \* @see Hustle\_Provider\_Form\_Hooks\_Abstract::add\_entry\_fields() |
| [796](#L796) | \* |
| [797](#L797) | \* @since 4.0 |
| [798](#L798) | \* |
| [799](#L799) | \* @param int                 $module\_id Module ID. |
| [800](#L800) | \* @param Hustle\_Module\_Model $module Module. |
| [801](#L801) | \* @param array               $submitted\_data Data submitted by the user. |
| [802](#L802) | \* @param array               $current\_entry\_fields Entry fields. |
| [803](#L803) | \* @return array fields to be added to entry |
| [804](#L804) | \*/ |
| [805](#L805) | private function attach\_addons\_add\_entry\_fields( $module\_id, Hustle\_Module\_Model $module, $submitted\_data, $current\_entry\_fields ) { |
| [806](#L806) | $additional\_fields\_data = array(); |
| [807](#L807) | $connected\_addons       = Hustle\_Provider\_Utils::get\_addons\_instance\_connected\_with\_module( $module\_id ); |
| [808](#L808) | foreach ( $connected\_addons as $connected\_addon ) { |
| [809](#L809) | try { |
| [810](#L810) | $slug                     = $connected\_addon->get\_slug(); |
| [811](#L811) | $formatted\_submitted\_data = apply\_filters( 'hustle\_format\_submitted\_data', $submitted\_data, $slug ); |
| [812](#L812) | $form\_hooks               = $connected\_addon->get\_addon\_form\_hooks( $module\_id ); |
| [813](#L813) |  |
| [814](#L814) | if ( $form\_hooks instanceof Hustle\_Provider\_Form\_Hooks\_Abstract ) { |
| [815](#L815) |  |
| [816](#L816) | $addon\_fields = $form\_hooks->add\_entry\_fields( $formatted\_submitted\_data ); |
| [817](#L817) | // log errors. |
| [818](#L818) | if ( |
| [819](#L819) | ! empty( $addon\_fields[0] ) && ! empty( $addon\_fields[0]['value'] ) && |
| [820](#L820) | isset( $addon\_fields[0]['value']['is\_sent'] ) && |
| [821](#L821) | false === $addon\_fields[0]['value']['is\_sent'] |
| [822](#L822) | ) { |
| [823](#L823) | $error = ! empty( $addon\_fields[0]['value']['description'] ) ? |
| [824](#L824) | $addon\_fields[0]['value']['description'] |
| [825](#L825) | : \_\_( 'Something went wrong.', 'hustle' ); |
| [826](#L826) |  |
| [827](#L827) | $error = $connected\_addon->get\_title() . ' ' . $error; |
| [828](#L828) |  |
| [829](#L829) | Opt\_In\_Utils::maybe\_log( $error ); |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | $account\_settings = $connected\_addon->get\_settings\_values(); |
| [833](#L833) | if ( ! empty( $connected\_addon->selected\_global\_multi\_id ) ) { |
| [834](#L834) | $addon\_fields[0]['value']['account\_name'] = isset( $account\_settings[ $connected\_addon->selected\_global\_multi\_id ]['name'] ) |
| [835](#L835) | ? $account\_settings[ $connected\_addon->selected\_global\_multi\_id ]['name'] . ' (' . $connected\_addon->selected\_global\_multi\_id . ')' |
| [836](#L836) | : $connected\_addon->selected\_global\_multi\_id; |
| [837](#L837) | } |
| [838](#L838) |  |
| [839](#L839) | // Reformat additional fields. |
| [840](#L840) | $addon\_fields           = self::format\_addon\_additional\_fields( $connected\_addon, $addon\_fields ); |
| [841](#L841) | $additional\_fields\_data = array\_merge( $additional\_fields\_data, $addon\_fields ); |
| [842](#L842) | } |
| [843](#L843) | } catch ( Exception $e ) { |
| [844](#L844) | Opt\_In\_Utils::maybe\_log( $connected\_addon->get\_slug(), 'failed to add\_entry\_fields', $e->getMessage() ); |
| [845](#L845) | } |
| [846](#L846) | } |
| [847](#L847) |  |
| [848](#L848) | return $additional\_fields\_data; |
| [849](#L849) | } |
| [850](#L850) |  |
| [851](#L851) | /\*\* |
| [852](#L852) | \* Format additional fields from provider. |
| [853](#L853) | \* Format used is `hustle\_provider\_{$slug}\_{$field\_name}` |
| [854](#L854) | \* |
| [855](#L855) | \* @since 4.0 |
| [856](#L856) | \* |
| [857](#L857) | \* @param Hustle\_Provider\_Abstract $addon Addon. |
| [858](#L858) | \* @param array                    $additional\_fields Additional fields. |
| [859](#L859) | \* @return array |
| [860](#L860) | \*/ |
| [861](#L861) | private static function format\_addon\_additional\_fields( Hustle\_Provider\_Abstract $addon, $additional\_fields ) { |
| [862](#L862) | // to `name` and `value` basis. |
| [863](#L863) | $formatted\_additional\_fields = array(); |
| [864](#L864) | if ( ! is\_array( $additional\_fields ) ) { |
| [865](#L865) | return array(); |
| [866](#L866) | } |
| [867](#L867) |  |
| [868](#L868) | foreach ( $additional\_fields as $additional\_field ) { |
| [869](#L869) | if ( ! isset( $additional\_field['name'] ) || ! isset( $additional\_field['value'] ) ) { |
| [870](#L870) | continue; |
| [871](#L871) | } |
| [872](#L872) | $formatted\_additional\_fields[] = array( |
| [873](#L873) | 'name'  => 'hustle\_provider\_' . $addon->get\_slug() . '\_' . $additional\_field['name'], |
| [874](#L874) | 'value' => $additional\_field['value'], |
| [875](#L875) | ); |
| [876](#L876) | } |
| [877](#L877) |  |
| [878](#L878) | return $formatted\_additional\_fields; |
| [879](#L879) | } |
| [880](#L880) |  |
| [881](#L881) | /\*\* |
| [882](#L882) | \* Handles the unsubscribe form submission. |
| [883](#L883) | \* |
| [884](#L884) | \* @since 3.0.5 |
| [885](#L885) | \*/ |
| [886](#L886) | public function unsubscribe\_submit\_form() { |
| [887](#L887) |  |
| [888](#L888) | parse\_str( $\_POST['data'], $submitted\_data ); // phpcs:ignore |
| [889](#L889) | $sanitized\_data = Opt\_In\_Utils::validate\_and\_sanitize\_fields( $submitted\_data ); |
| [890](#L890) | $messages       = Hustle\_Settings\_Admin::get\_unsubscribe\_messages(); |
| [891](#L891) | $email          = isset( $sanitized\_data['email'] ) ? filter\_var( $sanitized\_data['email'], FILTER\_VALIDATE\_EMAIL ) : ''; |
| [892](#L892) | // Check if we got the email address and if it's valid. |
| [893](#L893) | if ( $email ) { |
| [894](#L894) | $modules\_id = self::get\_module\_ids( $email, $sanitized\_data, $messages ); |
| [895](#L895) |  |
| [896](#L896) | // Handle 'choose\_list' form step. |
| [897](#L897) | if ( isset( $sanitized\_data['form\_step'] ) && 'choose\_list' === $sanitized\_data['form\_step'] ) { |
| [898](#L898) |  |
| [899](#L899) | if ( ! empty( $sanitized\_data['skip\_confirmation'] ) ) { |
| [900](#L900) | $sanitized\_data['lists\_id'] = $modules\_id; |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | // If the lists are defined, submit the email with the nonce. |
| [904](#L904) | if ( ! empty( $sanitized\_data['lists\_id'] ) && isset( $sanitized\_data['current\_url'] ) ) { |
| [905](#L905) |  |
| [906](#L906) | // Do the process to send the unsubscription email. |
| [907](#L907) | $email\_processed = Hustle\_Mail::handle\_unsubscription\_user\_email( $email, $sanitized\_data['lists\_id'], $sanitized\_data['current\_url'] ); |
| [908](#L908) |  |
| [909](#L909) | if ( $email\_processed ) { |
| [910](#L910) |  |
| [911](#L911) | $html    = $messages['email\_submitted']; |
| [912](#L912) | $wrapper = '.hustle-form-body'; |
| [913](#L913) |  |
| [914](#L914) | $response = array( |
| [915](#L915) | 'html'    => apply\_filters( 'hustle\_unsubscribe\_email\_processed\_html', $html, $sanitized\_data ), |
| [916](#L916) | 'wrapper' => apply\_filters( 'hustle\_unsubscribe\_email\_processed\_wrapper', $wrapper, $sanitized\_data ), |
| [917](#L917) | ); |
| [918](#L918) | wp\_send\_json\_success( $response ); |
| [919](#L919) |  |
| [920](#L920) | } |
| [921](#L921) | } |
| [922](#L922) |  |
| [923](#L923) | $html = apply\_filters( 'hustle\_unsubscribe\_email\_not\_processed\_html', $messages['email\_not\_processed'], $sanitized\_data ); |
| [924](#L924) | wp\_send\_json\_error( array( 'html' => $html ) ); |
| [925](#L925) |  |
| [926](#L926) | } elseif ( isset( $sanitized\_data['form\_step'] ) && 'enter\_email' === $sanitized\_data['form\_step'] ) { |
| [927](#L927) | $modules\_id = self::get\_module\_ids( $email, $sanitized\_data, $messages ); |
| [928](#L928) |  |
| [929](#L929) | $module   = new Hustle\_Module\_Model(); |
| [930](#L930) | $params   = array( |
| [931](#L931) | 'ajax\_step'   => true, |
| [932](#L932) | 'modules\_id'  => $modules\_id, |
| [933](#L933) | 'module'      => $module, |
| [934](#L934) | 'email'       => $email, |
| [935](#L935) | 'current\_url' => $sanitized\_data['current\_url'], |
| [936](#L936) | 'messages'    => $messages, |
| [937](#L937) | ); |
| [938](#L938) | $renderer = new Hustle\_Layout\_Helper(); |
| [939](#L939) | $html     = $renderer->render( 'general/unsubscribe-form', $params, true ); |
| [940](#L940) | $wrapper  = '.hustle-form-body'; |
| [941](#L941) |  |
| [942](#L942) | $response = array( |
| [943](#L943) | 'html'    => apply\_filters( 'hustle\_render\_unsubscribe\_lists\_html', $html, $modules\_id, $email ), |
| [944](#L944) | 'wrapper' => apply\_filters( 'hustle\_render\_unsubscribe\_list\_wrapper', $wrapper, $modules\_id, $email ), |
| [945](#L945) | ); |
| [946](#L946) | wp\_send\_json\_success( $response ); |
| [947](#L947) | } |
| [948](#L948) | } else { |
| [949](#L949) | // Return an error if the email is missing or is invalid. |
| [950](#L950) | $html = apply\_filters( 'hustle\_unsubscribe\_invalid\_email\_address\_message', $messages['invalid\_email'], $sanitized\_data ); |
| [951](#L951) | wp\_send\_json\_error( array( 'html' => $html ) ); |
| [952](#L952) | } |
| [953](#L953) |  |
| [954](#L954) | wp\_send\_json\_success( $sanitized\_data ); |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | /\*\* |
| [958](#L958) | \* Get module ids |
| [959](#L959) | \* |
| [960](#L960) | \* @param atring $email Email. |
| [961](#L961) | \* @param array  $sanitized\_data Data. |
| [962](#L962) | \* @param array  $messages Message texts. |
| [963](#L963) | \* @return array |
| [964](#L964) | \*/ |
| [965](#L965) | private static function get\_module\_ids( $email, $sanitized\_data, $messages ) { |
| [966](#L966) | $entry      = new Hustle\_Entry\_Model(); |
| [967](#L967) | $modules\_id = $entry->get\_modules\_id\_by\_email\_in\_local\_list( $email ); |
| [968](#L968) | // The lists are not defined yet. Show the list for the user to select them. |
| [969](#L969) | // If not showing all, show only the ones defined in the shortcode. |
| [970](#L970) | if ( ! empty( $sanitized\_data['form\_module\_id'] ) && '-1' !== $sanitized\_data['form\_module\_id'] ) { |
| [971](#L971) | $form\_modules\_id = array\_map( 'trim', explode( ',', $sanitized\_data['form\_module\_id'] ) ); |
| [972](#L972) | $modules\_id      = array\_intersect( $form\_modules\_id, $modules\_id ); |
| [973](#L973) | } |
| [974](#L974) |  |
| [975](#L975) | // If the email is not in any of the selected lists. |
| [976](#L976) | if ( empty( $modules\_id ) ) { |
| [977](#L977) |  |
| [978](#L978) | $html    = $messages['email\_not\_found']; |
| [979](#L979) | $wrapper = '.hustle-form-body'; |
| [980](#L980) |  |
| [981](#L981) | $response = array( |
| [982](#L982) | 'html'    => apply\_filters( 'hustle\_unsubscribe\_email\_not\_found\_html', $html, $modules\_id, $email ), |
| [983](#L983) | 'wrapper' => apply\_filters( 'hustle\_unsubscribe\_email\_not\_found\_wrapper', $wrapper, $modules\_id, $email ), |
| [984](#L984) | ); |
| [985](#L985) | wp\_send\_json\_success( $response ); |
| [986](#L986) | } |
| [987](#L987) |  |
| [988](#L988) | return $modules\_id; |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | /\*\* |
| [992](#L992) | \* Retrieve the number of shares from the network's native APIs. |
| [993](#L993) | \* |
| [994](#L994) | \* @since 3.0.3 |
| [995](#L995) | \* @since 4.0 Get the networks' names from frontend. |
| [996](#L996) | \*/ |
| [997](#L997) | public function get\_networks\_native\_shares() { |
| [998](#L998) |  |
| [999](#L999) | // TODO: check the networks are the ones that have APIs, and sanitize. |
| [1000](#L1000) | $networks = filter\_input( INPUT\_POST, 'networks', FILTER\_SANITIZE\_SPECIAL\_CHARS, FILTER\_REQUIRE\_ARRAY ); |
| [1001](#L1001) |  |
| [1002](#L1002) | $post\_id = filter\_input( INPUT\_POST, 'postId', FILTER\_VALIDATE\_INT ); |
| [1003](#L1003) |  |
| [1004](#L1004) | if ( ! $networks || false === $post\_id || is\_null( $post\_id ) ) { |
| [1005](#L1005) | wp\_send\_json\_error(); |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) | $module\_instance = new Hustle\_SShare\_Model(); |
| [1009](#L1009) | $networks\_shares = $module\_instance->retrieve\_networks\_shares( $networks, $post\_id ); |
| [1010](#L1010) |  |
| [1011](#L1011) | wp\_send\_json\_success( |
| [1012](#L1012) | array( |
| [1013](#L1013) | 'networks' => $networks\_shares, |
| [1014](#L1014) | 'shorten'  => array( |
| [1015](#L1015) | 'thousand' => esc\_html\_\_( 'K', 'hustle' ), |
| [1016](#L1016) | 'million'  => esc\_html\_\_( 'M', 'hustle' ), |
| [1017](#L1017) | ), |
| [1018](#L1018) | ) |
| [1019](#L1019) | ); |
| [1020](#L1020) | } |
| [1021](#L1021) |  |
| [1022](#L1022) | /\*\* |
| [1023](#L1023) | \* Log module conversion |
| [1024](#L1024) | \* |
| [1025](#L1025) | \* @return null |
| [1026](#L1026) | \*/ |
| [1027](#L1027) | public function log\_module\_conversion() { |
| [1028](#L1028) | $data = json\_decode( file\_get\_contents( 'php://input' ) ); |
| [1029](#L1029) | $data = $data ? get\_object\_vars( $data ) : array(); |
| [1030](#L1030) |  |
| [1031](#L1031) | if ( ! is\_array( $data ) || empty( $data ) ) { |
| [1032](#L1032) | return; |
| [1033](#L1033) | } |
| [1034](#L1034) | $module\_id = $data['module\_id']; |
| [1035](#L1035) |  |
| [1036](#L1036) | if ( empty( $module\_id ) ) { |
| [1037](#L1037) | wp\_send\_json\_error( \_\_( 'Invalid Request!', 'hustle' ) . $module\_id ); |
| [1038](#L1038) | } |
| [1039](#L1039) |  |
| [1040](#L1040) | $module = Hustle\_Module\_Collection::instance()->return\_model\_from\_id( $module\_id ); |
| [1041](#L1041) | if ( is\_wp\_error( $module ) ) { |
| [1042](#L1042) | wp\_send\_json\_error( \_\_( 'Invalid module!', 'hustle' ) ); |
| [1043](#L1043) | } |
| [1044](#L1044) |  |
| [1045](#L1045) | if ( $module->id ) { |
| [1046](#L1046) |  |
| [1047](#L1047) | $page\_id         = $data['page\_id']; |
| [1048](#L1048) | $module\_sub\_type = ( isset( $data['module\_sub\_type'] ) && ! empty( $data['module\_sub\_type'] ) ) ? $data['module\_sub\_type'] : null; |
| [1049](#L1049) |  |
| [1050](#L1050) | $cta = ! empty( $data['cta'] ) ? $data['cta'] : null; |
| [1051](#L1051) | $res = $this->maybe\_log\_conversion( $module, $page\_id, $module\_sub\_type, $cta ); |
| [1052](#L1052) |  |
| [1053](#L1053) | } else { |
| [1054](#L1054) | $res = false; |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | if ( ! $res ) { |
| [1058](#L1058) | wp\_send\_json\_error( \_\_( 'Error saving stats', 'hustle' ) ); |
| [1059](#L1059) | } else { |
| [1060](#L1060) | wp\_send\_json\_success( \_\_( 'Stats Successfully saved', 'hustle' ) ); |
| [1061](#L1061) | } |
| [1062](#L1062) | } |
| [1063](#L1063) |  |
| [1064](#L1064) | /\*\* |
| [1065](#L1065) | \* Module view |
| [1066](#L1066) | \* |
| [1067](#L1067) | \* @return null |
| [1068](#L1068) | \*/ |
| [1069](#L1069) | public function module\_viewed() { |
| [1070](#L1070) | $data = json\_decode( file\_get\_contents( 'php://input' ) ); |
| [1071](#L1071) | $data = $data ? get\_object\_vars( $data ) : array(); |
| [1072](#L1072) |  |
| [1073](#L1073) | if ( ! is\_array( $data ) || empty( $data ) ) { |
| [1074](#L1074) | return; |
| [1075](#L1075) | } |
| [1076](#L1076) |  |
| [1077](#L1077) | $module\_id = $data['module\_id']; |
| [1078](#L1078) |  |
| [1079](#L1079) | if ( empty( $module\_id ) ) { |
| [1080](#L1080) | wp\_send\_json\_error( \_\_( 'Invalid Request: Module id invalid', 'hustle' ) ); |
| [1081](#L1081) | } |
| [1082](#L1082) |  |
| [1083](#L1083) | $module = new Hustle\_Module\_Model( $module\_id ); |
| [1084](#L1084) | if ( is\_wp\_error( $module ) ) { |
| [1085](#L1085) | wp\_send\_json\_error( \_\_( 'Invalid module!', 'hustle' ) ); |
| [1086](#L1086) | } |
| [1087](#L1087) |  |
| [1088](#L1088) | if ( $module->id ) { |
| [1089](#L1089) |  |
| [1090](#L1090) | $module\_type     = $data['module\_type']; |
| [1091](#L1091) | $page\_id         = $data['page\_id']; |
| [1092](#L1092) | $module\_sub\_type = isset( $data['module\_sub\_type'] ) ? $data['module\_sub\_type'] : null; |
| [1093](#L1093) |  |
| [1094](#L1094) | $tracking = Hustle\_Tracking\_Model::get\_instance(); |
| [1095](#L1095) | $res      = $tracking->save\_tracking( $module\_id, 'view', $module\_type, $page\_id, $module\_sub\_type ); |
| [1096](#L1096) |  |
| [1097](#L1097) | } else { |
| [1098](#L1098) | $res = false; |
| [1099](#L1099) | } |
| [1100](#L1100) |  |
| [1101](#L1101) | if ( ! $res ) { |
| [1102](#L1102) | wp\_send\_json\_error( \_\_( 'Error saving stats', 'hustle' ) ); |
| [1103](#L1103) | } else { |
| [1104](#L1104) | wp\_send\_json\_success( \_\_( 'Stats Successfully saved', 'hustle' ) ); |
| [1105](#L1105) | } |
| [1106](#L1106) |  |
| [1107](#L1107) | } |
| [1108](#L1108) |  |
| [1109](#L1109) | /\*\* |
| [1110](#L1110) | \* Update the click counter after an icon is clicked. |
| [1111](#L1111) | \* |
| [1112](#L1112) | \* @since 4.0 |
| [1113](#L1113) | \*/ |
| [1114](#L1114) | public function update\_sshare\_click\_counter() { |
| [1115](#L1115) |  |
| [1116](#L1116) | $module\_id = filter\_input( INPUT\_POST, 'moduleId', FILTER\_VALIDATE\_INT ); |
| [1117](#L1117) | $module    = Hustle\_Module\_Collection::instance()->return\_model\_from\_id( $module\_id ); |
| [1118](#L1118) |  |
| [1119](#L1119) | if ( ! is\_wp\_error( $module ) ) { |
| [1120](#L1120) |  |
| [1121](#L1121) | $network = filter\_input( INPUT\_POST, 'network', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [1122](#L1122) |  |
| [1123](#L1123) | $content = $module->get\_content()->to\_array(); |
| [1124](#L1124) |  |
| [1125](#L1125) | if ( isset( $content['social\_icons'][ $network ] ) ) { |
| [1126](#L1126) |  |
| [1127](#L1127) | $content['social\_icons'][ $network ]['counter'] = intval( $content['social\_icons'][ $network ]['counter'] ) + 1; |
| [1128](#L1128) | $module->update\_meta( Hustle\_Module\_Model::KEY\_CONTENT, $content ); |
| [1129](#L1129) |  |
| [1130](#L1130) | wp\_send\_json\_success(); |
| [1131](#L1131) | } |
| [1132](#L1132) | } |
| [1133](#L1133) |  |
| [1134](#L1134) | wp\_send\_json\_error(); |
| [1135](#L1135) | } |
| [1136](#L1136) |  |
| [1137](#L1137) | /\*\* |
| [1138](#L1138) | \* Validate date field. |
| [1139](#L1139) | \* |
| [1140](#L1140) | \* @param string $date date. |
| [1141](#L1141) | \* @param string $format date format. |
| [1142](#L1142) | \* @since 4.0.2 |
| [1143](#L1143) | \*/ |
| [1144](#L1144) | private function validate\_date( $date, $format ) { |
| [1145](#L1145) | $format = $this->validate\_format( $format ); |
| [1146](#L1146) | $d      = DateTime::createFromFormat( $format, $date ); |
| [1147](#L1147) |  |
| [1148](#L1148) | return ( $d && $d->format( $format ) === $date ); |
| [1149](#L1149) | } |
| [1150](#L1150) |  |
| [1151](#L1151) | /\*\* |
| [1152](#L1152) | \* Changes the date format from JS one to PHP version. |
| [1153](#L1153) | \* |
| [1154](#L1154) | \* @param string $format date format. |
| [1155](#L1155) | \* @since 4.0.2 |
| [1156](#L1156) | \*/ |
| [1157](#L1157) | private function validate\_format( $format ) { |
| [1158](#L1158) | // Formats based on https://api.jqueryui.com/datepicker/#utility-formatDate. |
| [1159](#L1159) | $format\_translate = array( |
| [1160](#L1160) | 'dd' => 'd', |
| [1161](#L1161) | 'mm' => 'm', |
| [1162](#L1162) | 'yy' => 'Y', |
| [1163](#L1163) | 'MM' => 'F', |
| [1164](#L1164) | 'oo' => 'z', // PHP doesn't have format like this, using the version without leading zeros. |
| [1165](#L1165) | 'DD' => 'l', |
| [1166](#L1166) | 'd'  => 'j', |
| [1167](#L1167) | 'o'  => 'z', |
| [1168](#L1168) | 'm'  => 'n', |
| [1169](#L1169) | '@'  => 'U', |
| [1170](#L1170) | ); |
| [1171](#L1171) |  |
| [1172](#L1172) | $format = strtr( $format, $format\_translate ); |
| [1173](#L1173) |  |
| [1174](#L1174) | return $format; |
| [1175](#L1175) | } |
| [1176](#L1176) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wordpress-popup/tags/7.8.5/inc/front/hustle-module-front-ajax.php?format=txt)
* [Original Format](/export/3222472/wordpress-popup/tags/7.8.5/inc/front/hustle-module-front-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


