=== Content from ftp.openbsd.org_54e635e5_20250114_191050.html ===
untrusted comment: verify with openbsd-74-base.pub
RWRoyQmAD08ajahR912Ly8Gpc8REyRBZWcYwvXU9BKci7FXaGX5r85kpnRU2mZ3oLBH4cL8gCryHycgA5tW2x560lGma+Cv44AI=
OpenBSD 7.4 errata 022, September 17, 2024:
In readdir name validation exclude any '/' to avoid unexpected
directory traversal on untrusted file systems.
Apply by doing:
signify -Vep /etc/signify/openbsd-74-base.pub -x 022\_readdir.patch.sig \
-m - | (cd /usr/src && patch -p0)
And then rebuild and install a new kernel:
KK=`sysctl -n kern.osversion | cut -d# -f1`
cd /usr/src/sys/arch/`machine`/compile/$KK
make obj
make config
make
make install
Index: sys/isofs/cd9660/cd9660\_vnops.c
===================================================================
RCS file: /cvs/src/sys/isofs/cd9660/cd9660\_vnops.c,v
diff -u -p -r1.95 cd9660\_vnops.c
--- sys/isofs/cd9660/cd9660\_vnops.c 8 Sep 2023 20:00:28 -0000 1.95
+++ sys/isofs/cd9660/cd9660\_vnops.c 14 Sep 2024 22:07:34 -0000
@@ -317,6 +317,11 @@ iso\_uiodir(struct isoreaddir \*idp, struc
dp->d\_name[dp->d\_namlen] = 0;
dp->d\_reclen = DIRENT\_SIZE(dp);
+ if (memchr(dp->d\_name, '/', dp->d\_namlen) != NULL) {
+ /\* illegal file name \*/
+ return (EINVAL);
+ }
+
if (idp->uio->uio\_resid < dp->d\_reclen) {
idp->eofflag = 0;
return (-1);
Index: sys/isofs/udf/udf\_vnops.c
===================================================================
RCS file: /cvs/src/sys/isofs/udf/udf\_vnops.c,v
diff -u -p -r1.70 udf\_vnops.c
--- sys/isofs/udf/udf\_vnops.c 13 Apr 2023 02:19:05 -0000 1.70
+++ sys/isofs/udf/udf\_vnops.c 14 Sep 2024 22:07:35 -0000
@@ -548,6 +548,12 @@ udf\_uiodir(struct udf\_uiodir \*uiodir, st
uiodir->dirent->d\_off = off;
uiodir->dirent->d\_reclen = de\_size;
+ if (memchr(uiodir->dirent->d\_name, '/',
+ uiodir->dirent->d\_namlen) != NULL) {
+ /\* illegal file name \*/
+ return (EINVAL);
+ }
+
return (uiomove(uiodir->dirent, de\_size, uio));
}
Index: sys/miscfs/fuse/fuse\_vnops.c
===================================================================
RCS file: /cvs/src/sys/miscfs/fuse/fuse\_vnops.c,v
diff -u -p -r1.67 fuse\_vnops.c
--- sys/miscfs/fuse/fuse\_vnops.c 8 Sep 2023 20:00:28 -0000 1.67
+++ sys/miscfs/fuse/fuse\_vnops.c 14 Sep 2024 22:07:35 -0000
@@ -762,6 +762,8 @@ fusefs\_readdir(void \*v)
struct fusefs\_node \*ip;
struct fusefs\_mnt \*fmp;
struct fusebuf \*fbuf;
+ struct dirent \*dp;
+ char \*edp;
struct vnode \*vp;
struct proc \*p;
struct uio \*uio;
@@ -812,6 +814,35 @@ fusefs\_readdir(void \*v)
/\* ack end of readdir \*/
if (fbuf->fb\_len == 0) {
eofflag = 1;
+ fb\_delete(fbuf);
+ break;
+ }
+
+ /\* validate the returned dirents \*/
+ dp = (struct dirent \*)fbuf->fb\_dat;
+ edp = fbuf->fb\_dat + fbuf->fb\_len;
+ while ((char \*)dp < edp) {
+ if ((char \*)dp + offsetof(struct dirent, d\_name) >= edp
+ || dp->d\_reclen <= offsetof(struct dirent, d\_name)
+ || (char \*)dp + dp->d\_reclen > edp) {
+ error = EINVAL;
+ break;
+ }
+ if (dp->d\_namlen + offsetof(struct dirent, d\_name) >=
+ dp->d\_reclen) {
+ error = EINVAL;
+ break;
+ }
+ memset(dp->d\_name + dp->d\_namlen, 0, dp->d\_reclen -
+ dp->d\_namlen - offsetof(struct dirent, d\_name));
+
+ if (memchr(dp->d\_name, '/', dp->d\_namlen) != NULL) {
+ error = EINVAL;
+ break;
+ }
+ dp = (struct dirent \*)((char \*)dp + dp->d\_reclen);
+ }
+ if (error) {
fb\_delete(fbuf);
break;
}
Index: sys/msdosfs/msdosfs\_conv.c
===================================================================
RCS file: /cvs/src/sys/msdosfs/msdosfs\_conv.c,v
diff -u -p -r1.20 msdosfs\_conv.c
--- sys/msdosfs/msdosfs\_conv.c 4 Sep 2019 14:40:22 -0000 1.20
+++ sys/msdosfs/msdosfs\_conv.c 14 Sep 2024 22:07:35 -0000
@@ -274,7 +274,7 @@ dos2unix[256] = {
0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, /\* 10-17 \*/
0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, /\* 18-1f \*/
0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, /\* 20-27 \*/
- 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, /\* 28-2f \*/
+ 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x3f, /\* 28-2f \*/
0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, /\* 30-37 \*/
0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f, /\* 38-3f \*/
0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, /\* 40-47 \*/
@@ -310,7 +310,7 @@ u2l[256] = {
0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, /\* 10-17 \*/
0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, /\* 18-1f \*/
0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, /\* 20-27 \*/
- 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, /\* 28-2f \*/
+ 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x3f, /\* 28-2f \*/
0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, /\* 30-37 \*/
0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f, /\* 38-3f \*/
0x40, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, /\* 40-47 \*/
Index: sys/nfs/nfs\_vnops.c
===================================================================
RCS file: /cvs/src/sys/nfs/nfs\_vnops.c,v
diff -u -p -r1.193 nfs\_vnops.c
--- sys/nfs/nfs\_vnops.c 26 Apr 2023 10:00:37 -0000 1.193
+++ sys/nfs/nfs\_vnops.c 14 Sep 2024 22:07:34 -0000
@@ -2116,6 +2116,11 @@ nfs\_readdir(void \*v)
dp->d\_reclen -= NFS\_DIRENT\_OVERHEAD;
dp->d\_off = fxdr\_hyper(&ndp->cookie[0]);
+ if (memchr(dp->d\_name, '/', dp->d\_namlen) != NULL) {
+ error = EBADRPC;
+ break;
+ }
+
if (uio->uio\_resid < dp->d\_reclen) {
eof = 0;
done = 1;
Index: sys/ntfs/ntfs\_vnops.c
===================================================================
RCS file: /cvs/src/sys/ntfs/ntfs\_vnops.c,v
diff -u -p -r1.47 ntfs\_vnops.c
--- sys/ntfs/ntfs\_vnops.c 15 Oct 2021 06:30:06 -0000 1.47
+++ sys/ntfs/ntfs\_vnops.c 14 Sep 2024 22:07:35 -0000
@@ -489,6 +489,10 @@ ntfs\_readdir(void \*v)
"flag: %u, ",
num, cde.d\_name, iep->ie\_fnametype, iep->ie\_flag);
cde.d\_namlen = fname - (char \*) cde.d\_name;
+ if (memchr(cde.d\_name, '/', cde.d\_namlen) != NULL) {
+ error = EINVAL;
+ goto out;
+ }
cde.d\_fileno = iep->ie\_number;
cde.d\_type = (iep->ie\_fflag & NTFS\_FFLAG\_DIR) ? DT\_DIR : DT\_REG;
cde.d\_reclen = sizeof(struct dirent);
Index: sys/tmpfs/tmpfs\_subr.c
===================================================================
RCS file: /cvs/src/sys/tmpfs/tmpfs\_subr.c,v
diff -u -p -r1.26 tmpfs\_subr.c
--- sys/tmpfs/tmpfs\_subr.c 15 Nov 2022 17:16:44 -0000 1.26
+++ sys/tmpfs/tmpfs\_subr.c 14 Sep 2024 22:07:36 -0000
@@ -820,6 +820,11 @@ tmpfs\_dir\_getdents(tmpfs\_node\_t \*node, s
dent.d\_name[de->td\_namelen] = '\0';
dent.d\_reclen = DIRENT\_SIZE(&dent);
+ if (memchr(dent.d\_name, '/', dent.d\_namlen) != NULL) {
+ error = EINVAL;
+ break;
+ }
+
next\_de = TAILQ\_NEXT(de, td\_entries);
if (next\_de == NULL)
dent.d\_off = TMPFS\_DIRSEQ\_EOF;
Index: sys/ufs/ext2fs/ext2fs\_lookup.c
===================================================================
RCS file: /cvs/src/sys/ufs/ext2fs/ext2fs\_lookup.c,v
diff -u -p -r1.46 ext2fs\_lookup.c
--- sys/ufs/ext2fs/ext2fs\_lookup.c 11 Jan 2022 03:13:59 -0000 1.46
+++ sys/ufs/ext2fs/ext2fs\_lookup.c 14 Sep 2024 22:07:36 -0000
@@ -173,7 +173,11 @@ ext2fs\_readdir(void \*v)
break;
}
ext2fs\_dirconv2ffs(dp, &dstd);
- if(dstd.d\_reclen > uio->uio\_resid) {
+ if (memchr(dstd.d\_name, '/', dstd.d\_namlen) != NULL) {
+ error = EINVAL;
+ break;
+ }
+ if (dstd.d\_reclen > uio->uio\_resid) {
break;
}
dstd.d\_off = off + e2d\_reclen;
Index: sys/ufs/ufs/ufs\_vnops.c
===================================================================
RCS file: /cvs/src/sys/ufs/ufs/ufs\_vnops.c,v
diff -u -p -r1.158 ufs\_vnops.c
--- sys/ufs/ufs/ufs\_vnops.c 8 Sep 2023 20:00:28 -0000 1.158
+++ sys/ufs/ufs/ufs\_vnops.c 14 Sep 2024 22:07:36 -0000
@@ -1482,6 +1482,11 @@ ufs\_readdir(void \*v)
memset(u.dn.d\_name + u.dn.d\_namlen, 0, u.dn.d\_reclen
- u.dn.d\_namlen - offsetof(struct dirent, d\_name));
+ if (memchr(u.dn.d\_name, '/', u.dn.d\_namlen) != NULL) {
+ error = EINVAL;
+ break;
+ }
+
error = uiomove(&u.dn, u.dn.d\_reclen, uio);
dp = (struct direct \*)((char \*)dp + dp->d\_reclen);
}


=== Content from ftp.openbsd.org_7090cbec_20250114_191050.html ===
untrusted comment: verify with openbsd-75-base.pub
RWRGj1pRpprAfpd9ovli7/bzDrZB0aIvCbHHcGfRAta9tmqBVIlIq88UiniWW/iAgUVMIJ0evCjmAtWdktuDfkJFyP3lI4HyZQ0=
OpenBSD 7.5 errata 009, September 17, 2024:
In readdir name validation exclude any '/' to avoid unexpected
directory traversal on untrusted file systems.
Apply by doing:
signify -Vep /etc/signify/openbsd-75-base.pub -x 009\_readdir.patch.sig \
-m - | (cd /usr/src && patch -p0)
And then rebuild and install a new kernel:
KK=`sysctl -n kern.osversion | cut -d# -f1`
cd /usr/src/sys/arch/`machine`/compile/$KK
make obj
make config
make
make install
Index: sys/isofs/cd9660/cd9660\_vnops.c
===================================================================
RCS file: /cvs/src/sys/isofs/cd9660/cd9660\_vnops.c,v
diff -u -p -r1.95 cd9660\_vnops.c
--- sys/isofs/cd9660/cd9660\_vnops.c 8 Sep 2023 20:00:28 -0000 1.95
+++ sys/isofs/cd9660/cd9660\_vnops.c 14 Sep 2024 22:06:06 -0000
@@ -317,6 +317,11 @@ iso\_uiodir(struct isoreaddir \*idp, struc
dp->d\_name[dp->d\_namlen] = 0;
dp->d\_reclen = DIRENT\_SIZE(dp);
+ if (memchr(dp->d\_name, '/', dp->d\_namlen) != NULL) {
+ /\* illegal file name \*/
+ return (EINVAL);
+ }
+
if (idp->uio->uio\_resid < dp->d\_reclen) {
idp->eofflag = 0;
return (-1);
Index: sys/isofs/udf/udf\_vnops.c
===================================================================
RCS file: /cvs/src/sys/isofs/udf/udf\_vnops.c,v
diff -u -p -r1.70 udf\_vnops.c
--- sys/isofs/udf/udf\_vnops.c 13 Apr 2023 02:19:05 -0000 1.70
+++ sys/isofs/udf/udf\_vnops.c 14 Sep 2024 22:06:07 -0000
@@ -548,6 +548,12 @@ udf\_uiodir(struct udf\_uiodir \*uiodir, st
uiodir->dirent->d\_off = off;
uiodir->dirent->d\_reclen = de\_size;
+ if (memchr(uiodir->dirent->d\_name, '/',
+ uiodir->dirent->d\_namlen) != NULL) {
+ /\* illegal file name \*/
+ return (EINVAL);
+ }
+
return (uiomove(uiodir->dirent, de\_size, uio));
}
Index: sys/miscfs/fuse/fuse\_vnops.c
===================================================================
RCS file: /cvs/src/sys/miscfs/fuse/fuse\_vnops.c,v
diff -u -p -r1.67 fuse\_vnops.c
--- sys/miscfs/fuse/fuse\_vnops.c 8 Sep 2023 20:00:28 -0000 1.67
+++ sys/miscfs/fuse/fuse\_vnops.c 14 Sep 2024 22:06:07 -0000
@@ -762,6 +762,8 @@ fusefs\_readdir(void \*v)
struct fusefs\_node \*ip;
struct fusefs\_mnt \*fmp;
struct fusebuf \*fbuf;
+ struct dirent \*dp;
+ char \*edp;
struct vnode \*vp;
struct proc \*p;
struct uio \*uio;
@@ -812,6 +814,35 @@ fusefs\_readdir(void \*v)
/\* ack end of readdir \*/
if (fbuf->fb\_len == 0) {
eofflag = 1;
+ fb\_delete(fbuf);
+ break;
+ }
+
+ /\* validate the returned dirents \*/
+ dp = (struct dirent \*)fbuf->fb\_dat;
+ edp = fbuf->fb\_dat + fbuf->fb\_len;
+ while ((char \*)dp < edp) {
+ if ((char \*)dp + offsetof(struct dirent, d\_name) >= edp
+ || dp->d\_reclen <= offsetof(struct dirent, d\_name)
+ || (char \*)dp + dp->d\_reclen > edp) {
+ error = EINVAL;
+ break;
+ }
+ if (dp->d\_namlen + offsetof(struct dirent, d\_name) >=
+ dp->d\_reclen) {
+ error = EINVAL;
+ break;
+ }
+ memset(dp->d\_name + dp->d\_namlen, 0, dp->d\_reclen -
+ dp->d\_namlen - offsetof(struct dirent, d\_name));
+
+ if (memchr(dp->d\_name, '/', dp->d\_namlen) != NULL) {
+ error = EINVAL;
+ break;
+ }
+ dp = (struct dirent \*)((char \*)dp + dp->d\_reclen);
+ }
+ if (error) {
fb\_delete(fbuf);
break;
}
Index: sys/msdosfs/msdosfs\_conv.c
===================================================================
RCS file: /cvs/src/sys/msdosfs/msdosfs\_conv.c,v
diff -u -p -r1.20 msdosfs\_conv.c
--- sys/msdosfs/msdosfs\_conv.c 4 Sep 2019 14:40:22 -0000 1.20
+++ sys/msdosfs/msdosfs\_conv.c 14 Sep 2024 22:06:07 -0000
@@ -274,7 +274,7 @@ dos2unix[256] = {
0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, /\* 10-17 \*/
0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, /\* 18-1f \*/
0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, /\* 20-27 \*/
- 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, /\* 28-2f \*/
+ 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x3f, /\* 28-2f \*/
0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, /\* 30-37 \*/
0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f, /\* 38-3f \*/
0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, /\* 40-47 \*/
@@ -310,7 +310,7 @@ u2l[256] = {
0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, /\* 10-17 \*/
0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, /\* 18-1f \*/
0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, /\* 20-27 \*/
- 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, /\* 28-2f \*/
+ 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x3f, /\* 28-2f \*/
0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, /\* 30-37 \*/
0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f, /\* 38-3f \*/
0x40, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, /\* 40-47 \*/
Index: sys/nfs/nfs\_vnops.c
===================================================================
RCS file: /cvs/src/sys/nfs/nfs\_vnops.c,v
diff -u -p -r1.193 nfs\_vnops.c
--- sys/nfs/nfs\_vnops.c 26 Apr 2023 10:00:37 -0000 1.193
+++ sys/nfs/nfs\_vnops.c 14 Sep 2024 22:06:06 -0000
@@ -2116,6 +2116,11 @@ nfs\_readdir(void \*v)
dp->d\_reclen -= NFS\_DIRENT\_OVERHEAD;
dp->d\_off = fxdr\_hyper(&ndp->cookie[0]);
+ if (memchr(dp->d\_name, '/', dp->d\_namlen) != NULL) {
+ error = EBADRPC;
+ break;
+ }
+
if (uio->uio\_resid < dp->d\_reclen) {
eof = 0;
done = 1;
Index: sys/ntfs/ntfs\_vnops.c
===================================================================
RCS file: /cvs/src/sys/ntfs/ntfs\_vnops.c,v
diff -u -p -r1.47 ntfs\_vnops.c
--- sys/ntfs/ntfs\_vnops.c 15 Oct 2021 06:30:06 -0000 1.47
+++ sys/ntfs/ntfs\_vnops.c 14 Sep 2024 22:06:07 -0000
@@ -489,6 +489,10 @@ ntfs\_readdir(void \*v)
"flag: %u, ",
num, cde.d\_name, iep->ie\_fnametype, iep->ie\_flag);
cde.d\_namlen = fname - (char \*) cde.d\_name;
+ if (memchr(cde.d\_name, '/', cde.d\_namlen) != NULL) {
+ error = EINVAL;
+ goto out;
+ }
cde.d\_fileno = iep->ie\_number;
cde.d\_type = (iep->ie\_fflag & NTFS\_FFLAG\_DIR) ? DT\_DIR : DT\_REG;
cde.d\_reclen = sizeof(struct dirent);
Index: sys/tmpfs/tmpfs\_subr.c
===================================================================
RCS file: /cvs/src/sys/tmpfs/tmpfs\_subr.c,v
diff -u -p -r1.26 tmpfs\_subr.c
--- sys/tmpfs/tmpfs\_subr.c 15 Nov 2022 17:16:44 -0000 1.26
+++ sys/tmpfs/tmpfs\_subr.c 14 Sep 2024 22:06:07 -0000
@@ -820,6 +820,11 @@ tmpfs\_dir\_getdents(tmpfs\_node\_t \*node, s
dent.d\_name[de->td\_namelen] = '\0';
dent.d\_reclen = DIRENT\_SIZE(&dent);
+ if (memchr(dent.d\_name, '/', dent.d\_namlen) != NULL) {
+ error = EINVAL;
+ break;
+ }
+
next\_de = TAILQ\_NEXT(de, td\_entries);
if (next\_de == NULL)
dent.d\_off = TMPFS\_DIRSEQ\_EOF;
Index: sys/ufs/ext2fs/ext2fs\_lookup.c
===================================================================
RCS file: /cvs/src/sys/ufs/ext2fs/ext2fs\_lookup.c,v
diff -u -p -r1.46 ext2fs\_lookup.c
--- sys/ufs/ext2fs/ext2fs\_lookup.c 11 Jan 2022 03:13:59 -0000 1.46
+++ sys/ufs/ext2fs/ext2fs\_lookup.c 14 Sep 2024 22:06:07 -0000
@@ -173,7 +173,11 @@ ext2fs\_readdir(void \*v)
break;
}
ext2fs\_dirconv2ffs(dp, &dstd);
- if(dstd.d\_reclen > uio->uio\_resid) {
+ if (memchr(dstd.d\_name, '/', dstd.d\_namlen) != NULL) {
+ error = EINVAL;
+ break;
+ }
+ if (dstd.d\_reclen > uio->uio\_resid) {
break;
}
dstd.d\_off = off + e2d\_reclen;
Index: sys/ufs/ufs/ufs\_vnops.c
===================================================================
RCS file: /cvs/src/sys/ufs/ufs/ufs\_vnops.c,v
diff -u -p -r1.160 ufs\_vnops.c
--- sys/ufs/ufs/ufs\_vnops.c 3 Feb 2024 18:51:59 -0000 1.160
+++ sys/ufs/ufs/ufs\_vnops.c 14 Sep 2024 22:06:07 -0000
@@ -1410,6 +1410,11 @@ ufs\_readdir(void \*v)
memset(u.dn.d\_name + u.dn.d\_namlen, 0, u.dn.d\_reclen
- u.dn.d\_namlen - offsetof(struct dirent, d\_name));
+ if (memchr(u.dn.d\_name, '/', u.dn.d\_namlen) != NULL) {
+ error = EINVAL;
+ break;
+ }
+
error = uiomove(&u.dn, u.dn.d\_reclen, uio);
dp = (struct direct \*)((char \*)dp + dp->d\_reclen);
}

