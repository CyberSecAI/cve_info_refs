=== Content from www.wordfence.com_e9db199a_20250114_214120.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Booking Calendar WpDevArt <= 3.2.19 - Authenticated (Contributor+) SQL Injection

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Booking Calendar WpDevArt <= 3.2.19 - Authenticated (Contributor+) SQL Injection

6.5

**Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N)

| CVE | [CVE-2024-10856](https://www.cve.org/CVERecord?id=CVE-2024-10856) |
| --- | --- |
| CVSS | 6.5 (Medium) |
| Publicly Published | December 23, 2024 |
| Last Updated | December 24, 2024 |
| Researcher | [Peter Thaleikis](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/spek) |

### Description

The Booking Calendar WpDevArt plugin is vulnerable to time-based, blind SQL injection via the `id` parameter in the “wpdevart\_booking\_calendar” shortcode in versions up to, and including, 3.2.19 due to insufficient escaping on the user-supplied parameter and lack of sufficient preparation on the existing SQL query. The vulnerability requires the “delete\_prev\_date” theme option being enabled. This makes it possible for authenticated attackers, with contributor-level access or above, to append additional SQL queries into already existing query that can be used to extract sensitive information such as passwords from the database.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/booking-calendar/tags/3.2.15/includes/main_class.php#L90)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/booking-calendar/tags/3.2.15/includes/main_class.php#L91)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3209851%40booking-calendar&new=3209851%40booking-calendar&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbooking-calendar%2Fbooking-calendar-wpdevart-3219-authenticated-contributor-sql-injection&t=Booking%20Calendar%20WpDevArt%20%3C%3D%203.2.19%20-%20Authenticated%20%28Contributor%2B%29%20SQL%20Injection "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbooking-calendar%2Fbooking-calendar-wpdevart-3219-authenticated-contributor-sql-injection&text=Booking%20Calendar%20WpDevArt%20%3C%3D%203.2.19%20-%20Authenticated%20%28Contributor%2B%29%20SQL%20Injection "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbooking-calendar%2Fbooking-calendar-wpdevart-3219-authenticated-contributor-sql-injection "LinkedIn")
Email

## Vulnerability Details for Booking calendar, Appointment Booking System

#### [Booking calendar, Appointment Booking System](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/booking-calendar)

| Software Type | Plugin |
| --- | --- |
| Software Slug | booking-calendar [(view on wordpress.org)](https://wordpress.org/plugins/booking-calendar) |
| Patched? | Yes |
| Remediation | Update to version 3.2.20, or a newer patched version |
| Affected Version | * <= 3.2.19 |
| Patched Version | * 3.2.20 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_e893f201_20250114_214039.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbooking-calendar%2Ftags%2F3.2.15%2Fincludes%2Fmain_class.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/booking-calendar/trunk/includes/main_class.php?rev=2848690 "Revision 2848690")
* [Next Revision](/browser/booking-calendar/trunk/includes/main_class.php?rev=3201222 "Revision 3201222") →
* [Blame](/browser/booking-calendar/trunk/includes/main_class.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/booking-calendar/tags/3.2.15/includes/main_class.php)

---

# [source:](/browser?order=name "Go to repository root") [booking-calendar](/browser/booking-calendar?order=name "View booking-calendar")/[tags](/browser/booking-calendar/tags?order=name "View tags")/[3.2.15](/browser/booking-calendar/tags/3.2.15?order=name "View 3.2.15")/[includes](/browser/booking-calendar/tags/3.2.15/includes?order=name "View includes")/[main\_class.php](/browser/booking-calendar/tags/3.2.15/includes/main_class.php?order=name "View main_class.php")

View diff against:

View revision:

| [Last change](/changeset/2864445/booking-calendar/trunk/includes/main_class.php "View differences") on this file was [2864445](/changeset/2864445/ "View changeset 2864445"), checked in by wpdevart, [2 years ago](/timeline?from=2023-02-13T14%3A19%3A38Z&precision=second "See timeline at 02/13/2023 02:19:38 PM") |
| --- |
| new version |
| **File size:** 45.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | class wpdevart\_Main { |
| [3](#L3) |  |
| [4](#L4) | private $reservation\_model; |
| [5](#L5) | private $theme\_model; |
| [6](#L6) | private $calendar\_model; |
| [7](#L7) | private $form\_model; |
| [8](#L8) | private $extra\_model; |
| [9](#L9) | private $theme\_option; |
| [10](#L10) | private $calendar\_data; |
| [11](#L11) | private $extra\_field; |
| [12](#L12) | private $form\_option; |
| [13](#L13) | private $booking\_id; |
| [14](#L14) | private $id; |
| [15](#L15) | private $ids; |
| [16](#L16) | private $widget; |
| [17](#L17) |  |
| [18](#L18) | public function \_\_construct($id = 0, $widget = false){ |
| [19](#L19) | $this->id = $id; |
| [20](#L20) | $this->widget = $widget; |
| [21](#L21) | $this->require\_files(); |
| [22](#L22) | $this->reservation\_model = new wpdevart\_bc\_ModelReservations(); |
| [23](#L23) | $this->theme\_model = new wpdevart\_bc\_ModelThemes(); |
| [24](#L24) | $this->calendar\_model = new wpdevart\_bc\_ModelCalendars(); |
| [25](#L25) | $this->form\_model = new wpdevart\_bc\_ModelForms(); |
| [26](#L26) | $this->extra\_model = new wpdevart\_bc\_ModelExtras(); |
| [27](#L27) | $this->ids = $this->calendar\_model->get\_ids($this->id); |
| [28](#L28) | $this->calendar\_data = $this->calendar\_model->get\_db\_days\_data($this->id); |
| [29](#L29) | if ($this->ids) { |
| [30](#L30) | $this->theme\_option = $this->theme\_model->get\_setting\_rows($this->ids["theme\_id"]); |
| [31](#L31) | $this->extra\_field = $this->extra\_model->get\_extra\_rows($this->ids["extra\_id"]); |
| [32](#L32) | $this->form\_option = $this->form\_model->get\_form\_rows($this->ids["form\_id"]); |
| [33](#L33) | } |
| [34](#L34) | if($this->widget == true) { |
| [35](#L35) | $this->booking\_id = wpdevart\_bc\_calendar::$booking\_count + 1000; |
| [36](#L36) | } else { |
| [37](#L37) | $this->booking\_id = wpdevart\_bc\_calendar::$booking\_count; |
| [38](#L38) | } |
| [39](#L39) | if(isset($this->theme\_option)) { |
| [40](#L40) | $this->theme\_option = json\_decode($this->theme\_option->value, true); |
| [41](#L41) | } else { |
| [42](#L42) | $this->theme\_option = array(); |
| [43](#L43) | } |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) | /\*\* |
| [47](#L47) | \* Require files |
| [48](#L48) | \*\*/ |
| [49](#L49) | private function require\_files() { |
| [50](#L50) | wp\_enqueue\_script( 'wpdevart-script' ); |
| [51](#L51) | wp\_localize\_script( 'wpdevart-script', WPDEVART\_PLUGIN\_PREFIX, array( |
| [52](#L52) | 'ajaxUrl'     => admin\_url( 'admin-ajax.php' ), |
| [53](#L53) | 'ajaxNonce'   => wp\_create\_nonce( 'wpdevart\_ajax\_nonce' ) |
| [54](#L54) | ) ); |
| [55](#L55) | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Reservations.php"); |
| [56](#L56) | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Themes.php"); |
| [57](#L57) | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Calendars.php"); |
| [58](#L58) | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Forms.php"); |
| [59](#L59) | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Extras.php"); |
| [60](#L60) | } |
| [61](#L61) |  |
| [62](#L62) | /\*############  Main booking function ################\*/ |
| [63](#L63) |  |
| [64](#L64) | public function main\_booking\_calendar($id, $res\_id = 0, $date='', $ajax = false, $selected = array(),$data = array(),$submit = "",$hours = array()){ |
| [65](#L65) | global $wpdb; |
| [66](#L66) | $payments = array(); |
| [67](#L67) | $result = array(); |
| [68](#L68) | $mail\_error = array(); |
| [69](#L69) | $request\_message = ""; |
| [70](#L70) | $submit\_message = ""; |
| [71](#L71) | $booking\_calendar = ""; |
| [72](#L72) | if(isset($\_POST["resid\_".$this->booking\_id])) |
| [73](#L73) | $res\_id = $\_POST["resid\_".$this->booking\_id]; |
| [74](#L74) | $res = $this->reservation\_model->get\_reservation\_row($res\_id); |
| [75](#L75) | $cal\_name = $this->calendar\_model->get\_calendar\_rows($id); |
| [76](#L76) | if(isset($\_POST["payment\_type\_".$this->booking\_id])) { |
| [77](#L77) | $this->update\_reservation($\_POST,$this->booking\_id); |
| [78](#L78) | if($\_POST["payment\_type\_".$this->booking\_id] == "pay\_in\_cash"){ |
| [79](#L79) |  |
| [80](#L80) | wpdevart\_bc\_Library::wpdevart\_redirect(esc\_url($this->theme\_option["redirect\_url\_successful"])); |
| [81](#L81) |  |
| [82](#L82) | } elseif($\_POST["payment\_type\_".$this->booking\_id] == "paypal") { |
| [83](#L83) | //require\_once(WPDEVART\_PLUGIN\_DIR.'includes/payments.php'); |
| [84](#L84) | new WpdevartPayments($this->theme\_option,$this->booking\_id,$id,$res,$cal\_name["title"]); |
| [85](#L85) | //wpdevart\_bc\_Library::wpdevart\_redirect($url); |
| [86](#L86) | } |
| [87](#L87) | } |
| [88](#L88) | if(isset($this->theme\_option['delete\_prev\_date']) && $this->theme\_option['delete\_prev\_date'] == "on") { |
| [89](#L89) | $day = date( 'Y-m-d', strtotime("last day")); |
| [90](#L90) | $wpdb->query("DELETE FROM ".$wpdb->prefix . "wpdevart\_dates WHERE calendar\_id=".$id." AND  day BETWEEN '1970-01-01' AND '".$day."'" ); |
| [91](#L91) | $wpdb->query("DELETE FROM ".$wpdb->prefix . "wpdevart\_reservations WHERE calendar\_id=".$id." AND  (single\_day BETWEEN '1970-01-01' AND '".$day."' OR (check\_in BETWEEN '1970-01-01' AND '".$day."' AND  check\_out BETWEEN '1970-01-01' AND '".$day."'))" ); |
| [92](#L92) | } |
| [93](#L93) | $for\_trarray = $this->text\_for\_tr(); |
| [94](#L94) |  |
| [95](#L95) |  |
| [96](#L96) | if ($date == '' && !isset( $\_REQUEST['date'] )) { |
| [97](#L97) | $date = date( 'Y-m-d' ); |
| [98](#L98) | } |
| [99](#L99) | if (isset( $\_REQUEST['date'] ) && $\_REQUEST['date'] != '') { |
| [100](#L100) | $date = $\_REQUEST['date']; |
| [101](#L101) | } |
| [102](#L102) | /\* Default year and month \*/ |
| [103](#L103) | if(isset($this->theme\_option["default\_month"]) && $this->theme\_option["default\_month"] != 0 && ($ajax == false || isset($data["wpdevart-submit".$submit]))) { |
| [104](#L104) | $date\_m = substr\_replace($date,$this->theme\_option["default\_month"],5,2); |
| [105](#L105) | } |
| [106](#L106) | if(isset($this->theme\_option["default\_year"]) && $this->theme\_option["default\_year"] != "" && ($ajax == false || isset($data["wpdevart-submit".$submit]))) { |
| [107](#L107) | if(isset($date\_m )){ |
| [108](#L108) | $date\_y = substr\_replace($date\_m,$this->theme\_option["default\_year"],0,4); |
| [109](#L109) | } else{ |
| [110](#L110) | $date\_y = substr\_replace($date,$this->theme\_option["default\_year"],0,4); |
| [111](#L111) | } |
| [112](#L112) | } |
| [113](#L113) | if(isset($date\_m) && strtotime( $date ) < strtotime( $date\_m )) { |
| [114](#L114) | $date = $date\_m; |
| [115](#L115) | } |
| [116](#L116) | if(isset($date\_y) && strtotime( $date ) < strtotime( $date\_y )) { |
| [117](#L117) | $date = $date\_y; |
| [118](#L118) | } |
| [119](#L119) | if ($date != '') { |
| [120](#L120) | $date = $date; |
| [121](#L121) | } |
| [122](#L122) | $date  = date('Y-m-d', strtotime( $date )); |
| [123](#L123) | $calendar\_start = new wpdevart\_bc\_BookingCalendar($date, $res, $id, $this->theme\_option, $this->calendar\_data, $this->form\_option, $this->extra\_field,array(),false,$this->widget,$for\_trarray); |
| [124](#L124) |  |
| [125](#L125) | if(isset($hours['hours']) && $hours['hours'] == "true") { |
| [126](#L126) | echo $calendar\_start->booking\_calendar\_hours($hours['date']); |
| [127](#L127) | die(); |
| [128](#L128) | } |
| [129](#L129) | if(isset($data["wpdevart-submit".$submit])){ |
| [130](#L130) | $result = $calendar\_start->save\_reserv($data,$submit); |
| [131](#L131) | if ($result !== 'wrong\_data') { |
| [132](#L132) | $save= $result[0]; |
| [133](#L133) | $send\_mails = $result[1]; |
| [134](#L134) | if(isset($result[2])) |
| [135](#L135) | $form\_data = $result[2]; |
| [136](#L136) |  |
| [137](#L137) | if(isset($form\_data) &&  $form\_data['total\_price'] !== false){ |
| [138](#L138) | if(isset($this->theme\_option['paypal']) && $this->theme\_option['paypal'] == "on"){ |
| [139](#L139) | $payments['paypal'] = "on"; |
| [140](#L140) | if(isset($this->theme\_option["go\_paypal"]) && $this->theme\_option["go\_paypal"] == 'on') { |
| [141](#L141) | $save\_in\_db = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', array( |
| [142](#L142) | 'payment\_method' => 'paypal', |
| [143](#L143) | 'payment\_status' => 'pending', |
| [144](#L144) | ), array('id' => $form\_data['id'])); |
| [145](#L145) | new WpdevartPayments($this->theme\_option,$this->booking\_id,$id,$form\_data,$cal\_name["title"]); |
| [146](#L146) | } |
| [147](#L147) | } |
| [148](#L148) | if(isset($this->theme\_option['pay\_in\_cash']) && isset($this->theme\_option['pay\_in\_cash']) == "on") { |
| [149](#L149) | $payments['pay\_in\_cash'] = "on"; |
| [150](#L150) | } |
| [151](#L151) | } |
| [152](#L152) | if(!is\_admin() || count($data)) { |
| [153](#L153) | if($save && isset($this->theme\_option["enable\_instant\_approval"]) && $this->theme\_option["enable\_instant\_approval"] == "on") { |
| [154](#L154) | $request\_message = $for\_trarray["for\_request\_successfully\_received"]; |
| [155](#L155) | } elseif($save) { |
| [156](#L156) | $request\_message = $for\_trarray["for\_request\_successfully\_sent"]; |
| [157](#L157) | } |
| [158](#L158) | foreach($send\_mails as $send\_mail) { |
| [159](#L159) | foreach($send\_mail as $key=>$value) { |
| [160](#L160) | if(isset($this->theme\_option[$key."\_error"]) && $this->theme\_option[$key."\_error"] == "on" && $value === false) { |
| [161](#L161) | $mail\_error[] = (isset($for\_trarray["for\_".$key]) ? $for\_trarray["for\_".$key] : ""); |
| [162](#L162) | } |
| [163](#L163) | } |
| [164](#L164) | } |
| [165](#L165) | if(isset($this->theme\_option["action\_after\_submit"]) && $this->theme\_option["action\_after\_submit"] == "stay\_on\_calendar") { |
| [166](#L166) | $submit\_message = wpdevart\_bc\_Library::translated\_text($this->theme\_option["message\_text"]); |
| [167](#L167) | } |
| [168](#L168) | else { |
| [169](#L169) | if(count($payments) == 0) { |
| [170](#L170) | $redirect\_url = wpdevart\_bc\_Library::translated\_text($this->theme\_option["redirect\_url"]); |
| [171](#L171) | wpdevart\_bc\_Library::wpdevart\_redirect(esc\_url($redirect\_url)); |
| [172](#L172) | } |
| [173](#L173) | } |
| [174](#L174) | } else { |
| [175](#L175) | return; |
| [176](#L176) | } |
| [177](#L177) | } else { |
| [178](#L178) | $wrong\_data = true; |
| [179](#L179) | } |
| [180](#L180) | } |
| [181](#L181) | elseif(isset($data["wpdevart-update".$submit])){ |
| [182](#L182) | $result = $calendar\_start->save\_reserv($data,$submit,"update"); |
| [183](#L183) | if ($result !== 'wrong\_data') { |
| [184](#L184) | $save= $result[0]; |
| [185](#L185) | $send\_mails = $result[1]; |
| [186](#L186) | if(isset($result[2])) |
| [187](#L187) | $form\_data = $result[2]; |
| [188](#L188) | if(!is\_admin() || count($data)) { |
| [189](#L189) | if($save && isset($this->theme\_option["enable\_instant\_approval"]) && $this->theme\_option["enable\_instant\_approval"] == "on") { |
| [190](#L190) | $request\_message = $for\_trarray["for\_request\_successfully\_received"]; |
| [191](#L191) | } elseif($save) { |
| [192](#L192) | $request\_message = $for\_trarray["for\_request\_successfully\_sent"]; |
| [193](#L193) | } |
| [194](#L194) | foreach($send\_mails as $send\_mail) { |
| [195](#L195) | foreach($send\_mail as $key=>$value) { |
| [196](#L196) | if(isset($this->theme\_option[$key."\_error"]) && $this->theme\_option[$key."\_error"] == "on" && $value === false) { |
| [197](#L197) | $mail\_error[] = (isset($for\_trarray["for\_".$key]) ? $for\_trarray["for\_".$key] : ""); |
| [198](#L198) | } |
| [199](#L199) | } |
| [200](#L200) | } |
| [201](#L201) | if(isset($this->theme\_option["action\_after\_submit"]) && $this->theme\_option["action\_after\_submit"] == "stay\_on\_calendar") { |
| [202](#L202) | $submit\_message = wpdevart\_bc\_Library::translated\_text($this->theme\_option["message\_text"]); |
| [203](#L203) | } |
| [204](#L204) | } else { |
| [205](#L205) | return; |
| [206](#L206) | } |
| [207](#L207) | } else { |
| [208](#L208) | $wrong\_data = true; |
| [209](#L209) | } |
| [210](#L210) | } |
| [211](#L211) | $calendar\_data\_after\_save = $this->calendar\_model->get\_db\_days\_data($id); |
| [212](#L212) | $calendar = new wpdevart\_bc\_BookingCalendar($date, $res, $id, $this->theme\_option, $calendar\_data\_after\_save, $this->form\_option,$this->extra\_field, $selected,$ajax,$this->widget,$for\_trarray); |
| [213](#L213) |  |
| [214](#L214) | if(isset($this->theme\_option) && !$ajax) { |
| [215](#L215) | $booking\_calendar .= $calendar->get\_styles(); |
| [216](#L216) | } |
| [217](#L217) | if(isset($form\_data) &&  $form\_data['total\_price'] !== false){ |
| [218](#L218) | if(isset($this->theme\_option['paypal']) && $this->theme\_option['paypal'] == "on"){ |
| [219](#L219) | $payments['paypal'] = "on"; |
| [220](#L220) | } |
| [221](#L221) | if(isset($this->theme\_option['pay\_in\_cash']) && isset($this->theme\_option['pay\_in\_cash']) == "on") { |
| [222](#L222) | $payments['pay\_in\_cash'] = "on"; |
| [223](#L223) | } |
| [224](#L224) | } |
| [225](#L225) | if (!$ajax) { |
| [226](#L226) | $min = (isset($this->theme\_option["min\_days"]) && $this->theme\_option["min\_days"] != '') ? $this->theme\_option["min\_days"] : 1; |
| [227](#L227) | $max = (isset($this->theme\_option["max\_days"]) && $this->theme\_option["max\_days"] != '') ? $this->theme\_option["max\_days"] : 1000; |
| [228](#L228) | $min\_hour = (isset($this->theme\_option["min\_hours"]) && $this->theme\_option["min\_hours"] != '') ? $this->theme\_option["min\_hours"] : 1; |
| [229](#L229) | $max\_hour = (isset($this->theme\_option["max\_hours"]) && $this->theme\_option["max\_hours"] != '') ? $this->theme\_option["max\_hours"] : 1000; |
| [230](#L230) | ?> |
| [231](#L231) | <script> |
| [232](#L232) | var wpdevartBooking<?php echo $this->booking\_id; ?> = { |
| [233](#L233) | booking\_id : <?php echo $this->booking\_id; ?>, |
| [234](#L234) | hours\_enabled : <?php echo ((isset($this->theme\_option['hours\_enabled']) && $this->theme\_option['hours\_enabled'] == "on") ? 1 : 0 ); ?>, |
| [235](#L235) | booking\_widget : <?php echo ((isset($this->widget) && $this->widget == true) ? 1 : 0 ); ?>, |
| [236](#L236) | show\_day\_info\_on\_hover : <?php echo ((isset($this->theme\_option['show\_day\_info\_on\_hover']) && $this->theme\_option['show\_day\_info\_on\_hover'] == 'on') ? 1 : 0 ); ?>, |
| [237](#L237) | cal\_animation\_type : "<?php echo ((isset($this->theme\_option['cal\_animation\_type']) && $this->theme\_option['cal\_animation\_type'] != 'none') ? "animation\_calendar" : "" ); ?>", |
| [238](#L238) | booking\_widget : <?php echo ((isset($this->widget) && $this->widget == true) ? 1 : 0 ); ?>, |
| [239](#L239) | total : "<?php echo $for\_trarray["for\_total"]; ?>", |
| [240](#L240) | price : "<?php echo $for\_trarray["for\_price"]; ?>", |
| [241](#L241) | offset : <?php echo ((isset($this->theme\_option["scroll\_offset"]) && $this->theme\_option["scroll\_offset"] != '') ? $this->theme\_option["scroll\_offset"] : 0); ?>, |
| [242](#L242) | position : "<?php echo ((isset($this->theme\_option["currency\_pos"]) && $this->theme\_option["currency\_pos"] == 'before') ? "before" : "after"); ?>", |
| [243](#L243) | night : <?php echo ((isset($this->theme\_option["price\_for\_night"]) && $this->theme\_option["price\_for\_night"] == 'on') ? 1 : 0); ?>, |
| [244](#L244) | id : <?php echo $id; ?>, |
| [245](#L245) | capcha\_error : "<?php echo $for\_trarray["for\_capcha"]; ?>", |
| [246](#L246) | conditions : '<?php echo ((isset($this->theme\_option["sale\_conditions"]) && $this->theme\_option["sale\_conditions"] != '') ? json\_encode($this->theme\_option["sale\_conditions"]) : ""); ?>', |
| [247](#L247) | hours\_conditions : '<?php echo ((isset($this->theme\_option["hours\_sale\_conditions"]) && $this->theme\_option["hours\_sale\_conditions"] != '') ? json\_encode($this->theme\_option["hours\_sale\_conditions"]) : ""); ?>', |
| [248](#L248) | hide\_price : <?php echo ((isset($this->theme\_option['hide\_price']) && $this->theme\_option['hide\_price'] == "on") ? 1 : 0 ); ?>, |
| [249](#L249) | max\_item : "<?php echo ((isset($this->theme\_option['max\_item'])) ? $this->theme\_option['max\_item'] : "" ); ?>", |
| [250](#L250) | min\_item : "<?php echo ((isset($this->theme\_option['min\_item'])) ? $this->theme\_option['min\_item'] : "" ); ?>", |
| [251](#L251) | error\_days : "<?php echo $for\_trarray["for\_error\_multi"]; ?>", |
| [252](#L252) | error\_night : "<?php echo $for\_trarray["for\_night"]; ?>", |
| [253](#L253) | min : "<?php echo $min; ?>", |
| [254](#L254) | max : "<?php echo $max; ?>", |
| [255](#L255) | min\_hour : "<?php echo $min\_hour; ?>", |
| [256](#L256) | max\_hour : "<?php echo $max\_hour; ?>", |
| [257](#L257) | error\_min\_day : "<?php echo str\_replace("[min]", $min, $for\_trarray["for\_min"]); ?>", |
| [258](#L258) | error\_max\_day : "<?php echo str\_replace("[max]", $max, $for\_trarray["for\_max"]); ?>", |
| [259](#L259) | error\_min\_hour : "<?php echo str\_replace("[min]", $min\_hour, $for\_trarray["for\_min\_hour"]); ?>", |
| [260](#L260) | error\_max\_hour : "<?php echo str\_replace("[max]", $max\_hour, $for\_trarray["for\_max\_hour"]); ?>", |
| [261](#L261) | error\_day : "<?php echo $for\_trarray["for\_error\_single"]; ?>" |
| [262](#L262) | }; |
| [263](#L263) | </script> |
| [264](#L264) | <?php |
| [265](#L265) | $class = "booking\_calendar\_main\_container"; |
| [266](#L266) | $class .= (isset($this->theme\_option['hours\_enabled']) && $this->theme\_option['hours\_enabled'] == "on") ? " hours\_enabled" : ""; |
| [267](#L267) | $class .= (isset($this->widget) && $this->widget == true) ? " booking\_widget" : ""; |
| [268](#L268) | $class .= (isset($this->theme\_option['show\_day\_info\_on\_hover']) && $this->theme\_option['show\_day\_info\_on\_hover'] == 'on') ? " show\_day\_info\_on\_hover" : ""; |
| [269](#L269) | $class .= (isset($this->theme\_option['cal\_animation\_type']) && $this->theme\_option['cal\_animation\_type'] != 'none') ? " animation\_calendar" : ""; |
| [270](#L270) | $class .= (isset($this->theme\_option['layout']) && $this->theme\_option['layout'] == "form\_right") ? " form\_right" : " form\_below"; |
| [271](#L271) |  |
| [272](#L272) | $booking\_calendar .= "<div id='booking\_calendar\_main\_container\_" . $this->booking\_id  . "' class='" . $class . "' data-total='".$for\_trarray["for\_total"]."' data-price='".$for\_trarray["for\_price"]."' data-offset='".((isset($this->theme\_option["scroll\_offset"]) && $this->theme\_option["scroll\_offset"] != '') ? $this->theme\_option["scroll\_offset"] : 0)."' data-position='".((isset($this->theme\_option["currency\_pos"]) && $this->theme\_option["currency\_pos"] == 'before') ? "before" : "after")."' data-night='".((isset($this->theme\_option["price\_for\_night"]) && $this->theme\_option["price\_for\_night"] == 'on') ? "1" : "0")."' data-id='" . $id . "' data-booking\_id='" . $this->booking\_id . "'>"; |
| [273](#L273) | $booking\_calendar .= "<div class='booking\_calendar\_container' id='booking\_calendar\_container\_" . $this->booking\_id  . "'><div class='wpdevart-load-overlay'><div class='wpdevart-load-image'><i class='fa fa-spinner fa-spin'></i></div></div>"; |
| [274](#L274) | } |
| [275](#L275) | if ((isset($this->theme\_option['messages\_pos']) && $this->theme\_option['messages\_pos'] == "top") || !isset($this->theme\_option['messages\_pos'])) { |
| [276](#L276) | if (isset($submit\_message) && $submit\_message != "") { |
| [277](#L277) | $booking\_calendar .= "<div class='booking\_calendar\_message successfully\_text\_container'>".$submit\_message."<span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [278](#L278) | } |
| [279](#L279) | if($request\_message != "") { |
| [280](#L280) | $booking\_calendar .= "<div class='successfully\_text\_container div-for-clear'>".$request\_message."<span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [281](#L281) | } |
| [282](#L282) | if(count($mail\_error)) { |
| [283](#L283) | $booking\_calendar .= '<div class="error\_text\_container div-for-clear email\_error" style="display: block;"><span class="error\_text">'; |
| [284](#L284) | foreach($mail\_error as $error) { |
| [285](#L285) | $booking\_calendar .= $error. "</br>"; |
| [286](#L286) | } |
| [287](#L287) | $booking\_calendar .= '</span><span class="notice\_text\_close"><i class="fa fa-close"></i></span></div>'; |
| [288](#L288) | } |
| [289](#L289) | if(isset($wrong\_data)) { |
| [290](#L290) | $booking\_calendar .= '<div class="error\_text\_container div-for-clear email\_error" style="display: block;"><span class="error\_text">Something went wrong</span><span class="notice\_text\_close"><i class="fa fa-close"></i></span></div>'; |
| [291](#L291) | } |
| [292](#L292) | if (!$ajax) { |
| [293](#L293) | $booking\_calendar .= "<div class='error\_text\_container div-for-clear'><span class='error\_text'></span><span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [294](#L294) | } |
| [295](#L295) | } |
| [296](#L296) | $booking\_calendar .= "<div class='booking\_calendar\_main'>"; |
| [297](#L297) | if( isset($data["wpdevart-submit".$submit]) ){ |
| [298](#L298) | if( isset($this->theme\_option["show\_booking\_info"]) && $this->theme\_option["show\_booking\_info"] == "on") { |
| [299](#L299) | $booking\_calendar .= $this->show\_reservation\_info($form\_data); |
| [300](#L300) | } |
| [301](#L301) | if(count($payments)) { |
| [302](#L302) | $booking\_calendar .= '<div class="wpdevart\_order"><form method="post" id="wpdevart\_order\_'.$submit.'" class="div-for-clear">'; |
| [303](#L303) |  |
| [304](#L304) | $class  = (!isset($this->theme\_option["enable\_billing\_address"]) && !isset($this->theme\_option["enable\_shipping\_address"])) ? "payment\_submit" : ""; |
| [305](#L305) | foreach($payments as $key=>$payment){ |
| [306](#L306) | $button\_cl = ""; |
| [307](#L307) | if($key == "paypal" && isset($this->theme\_option["paypal\_image"]) && $this->theme\_option["paypal\_image"] != ""){ |
| [308](#L308) | $button\_content = "<img src='" . esc\_url($this->theme\_option["paypal\_image"]) . "'>"; |
| [309](#L309) | $button\_cl = "with\_image"; |
| [310](#L310) | } else{ |
| [311](#L311) | $button\_content = $for\_trarray["for\_".$key]; |
| [312](#L312) | } |
| [313](#L313) | $booking\_calendar .= '<button type="button" class="wpdevart-payment-button ' . $button\_cl . ' ' . $class . '" id="'.$key.'" name="wpdevart-payment'.$submit.'" data-id="'.$submit.'" data-resid="'.(isset($form\_data)? $form\_data['id'] : "").'" data-themeid="'.$this->ids["theme\_id"].'">'.$button\_content .'</button>'; |
| [314](#L314) | } |
| [315](#L315) | $booking\_calendar .= '<div class="wpdevart\_order\_wrap"></div>'; |
| [316](#L316) | $booking\_calendar .= '<div class="wpdevart\_order\_content" id="wpdevart\_booking\_form\_'.$submit.'"></div>'; |
| [317](#L317) | $booking\_calendar .= '<input type="hidden" name="resid\_'.$submit.'" value="'.(isset($form\_data)? $form\_data['id'] : "").'"> |
| [318](#L318) | <input type="hidden" name="payment\_type\_'.$submit.'" value=""> |
| [319](#L319) | <input type="hidden" name="view" id="add" value="add">'; |
| [320](#L320) | $booking\_calendar .= '</form></div>'; |
| [321](#L321) | } |
| [322](#L322) | } |
| [323](#L323) | if( (!(isset($data["wpdevart-submit".$submit]) && count($payments))) || isset($data["wpdevart-update".$submit])) { |
| [324](#L324) | $booking\_calendar .= $calendar->booking\_calendar(); |
| [325](#L325) | if (!$ajax) { |
| [326](#L326) | $booking\_calendar .= "</div>"; |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) |  |
| [330](#L330) | if (isset($this->theme\_option['messages\_pos']) && $this->theme\_option['messages\_pos'] == "bottom") { |
| [331](#L331) | if (isset($submit\_message) && $submit\_message != "") { |
| [332](#L332) | $booking\_calendar .= "<div class='booking\_calendar\_message successfully\_text\_container'>".$submit\_message."<span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [333](#L333) | } |
| [334](#L334) | if($request\_message != "") { |
| [335](#L335) | $booking\_calendar .= "<div class='successfully\_text\_container div-for-clear'>".$request\_message."<span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [336](#L336) | } |
| [337](#L337) | if(count($mail\_error)) { |
| [338](#L338) | $booking\_calendar .= '<div class="error\_text\_container div-for-clear email\_error" style="display: block;"><span class="error\_text">'; |
| [339](#L339) | foreach($mail\_error as $error) { |
| [340](#L340) | $booking\_calendar .= $error. "</br>"; |
| [341](#L341) | } |
| [342](#L342) | $booking\_calendar .= '</span><span class="notice\_text\_close"><i class="fa fa-close"></i></span></div>'; |
| [343](#L343) | } |
| [344](#L344) | if (!$ajax) { |
| [345](#L345) | $booking\_calendar .= "<div class='error\_text\_container div-for-clear'><span class='error\_text'></span><span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [346](#L346) | } |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) |  |
| [350](#L350) | $booking\_calendar .= "</div>"; |
| [351](#L351) | if((!is\_admin() || (isset($\_GET["page"]) && $\_GET["page"] == "wpdevart-reservations"))) { |
| [352](#L352) | $class = ""; |
| [353](#L353) | if(!isset($data["wpdevart-update".$submit])){ |
| [354](#L354) | if(!isset($this->theme\_option["show\_form"])) { |
| [355](#L355) | $class = "hide\_form"; |
| [356](#L356) | } |
| [357](#L357) | if(count($payments)) { |
| [358](#L358) | $class .= " cal\_width\_pay"; |
| [359](#L359) | } |
| [360](#L360) | } |
| [361](#L361) | $class .= (isset($this->theme\_option['form\_layout']) && $this->theme\_option['form\_layout'] == "one\_col") ? " one\_col" : ""; |
| [362](#L362) | $booking\_calendar .= $calendar->booking\_form($class); |
| [363](#L363) | } |
| [364](#L364) | if (!$ajax) { |
| [365](#L365) | $booking\_calendar .= "</div>"; |
| [366](#L366) | } |
| [367](#L367) | }else{ |
| [368](#L368) | $booking\_calendar .= "</div>"; |
| [369](#L369) | } |
| [370](#L370) | return $booking\_calendar; |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | public function main\_booking\_calendar\_res($date='', $ajax = false){ |
| [374](#L374) | $calendar = new wpdevart\_bc\_BookingCalendar($date, 0, $this->id, $this->theme\_option, $this->calendar\_data, $this->form\_option, $this->extra\_field, array()); |
| [375](#L375) | $booking\_calendar = ""; |
| [376](#L376) |  |
| [377](#L377) | if (!$ajax) { |
| [378](#L378) | $booking\_calendar .= "<div class='booking\_calendar\_container' id='booking\_calendar\_container\_" . wpdevart\_bc\_calendar::$booking\_count . "'><div class='wpdevart-load-overlay'><div class='wpdevart-load-image'><i class='fa fa-spinner fa-spin'></i></div></div>"; |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | $booking\_calendar .= "<div class='booking\_calendar\_main'>"; |
| [382](#L382) | $booking\_calendar .= $calendar->booking\_calendar("reservation"); |
| [383](#L383) | if (!$ajax) { |
| [384](#L384) | $booking\_calendar .= "</div>"; |
| [385](#L385) | } |
| [386](#L386) | $booking\_calendar .= "</div>"; |
| [387](#L387) | return $booking\_calendar; |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | public function main\_ajax(){ |
| [391](#L391) | $selected = array(); |
| [392](#L392) | $res\_id = 0; |
| [393](#L393) | if(isset($\_POST['wpdevart\_link'])) { |
| [394](#L394) | $link = esc\_html( $\_POST['wpdevart\_link'] ); |
| [395](#L395) | parse\_str( $link, $link\_arr ); |
| [396](#L396) | $date = $link\_arr['?date']; |
| [397](#L397) | } |
| [398](#L398) |  |
| [399](#L399) | if(isset($\_POST['wpdevart\_id'])) { |
| [400](#L400) | $id = esc\_html($\_POST['wpdevart\_id']); |
| [401](#L401) | } |
| [402](#L402) | if(isset($\_POST['wpdevart\_reserv'])) { |
| [403](#L403) | $reserv = esc\_html($\_POST['wpdevart\_reserv']); |
| [404](#L404) | } |
| [405](#L405) | if(isset($\_POST['wpdevart\_selected'])) { |
| [406](#L406) | $selected["index"] = esc\_html($\_POST['wpdevart\_selected']); |
| [407](#L407) | } |
| [408](#L408) | if(isset($\_POST['wpdevart\_selected\_date'])) { |
| [409](#L409) | $selected["date"] = esc\_html($\_POST['wpdevart\_selected\_date']); |
| [410](#L410) | } |
| [411](#L411) | if(isset($\_POST['wpdevart\_hours'])) { |
| [412](#L412) | $selected['hours'] = esc\_html($\_POST['wpdevart\_hours']); |
| [413](#L413) | } |
| [414](#L414) | if(isset($\_POST['wpdevart\_reserv\_id'])) { |
| [415](#L415) | $res\_id = esc\_html($\_POST['wpdevart\_reserv\_id']); |
| [416](#L416) | } |
| [417](#L417) |  |
| [418](#L418) | if(isset($reserv) && $reserv == "true") { |
| [419](#L419) | echo $this->main\_booking\_calendar\_res($date,true); |
| [420](#L420) | } elseif(isset($selected['hours']) && $selected['hours'] == "true") { |
| [421](#L421) | echo $this->main\_booking\_calendar($id, $res\_id,'',false,array(),array(),"",$selected); |
| [422](#L422) | } else { |
| [423](#L423) | echo $this->main\_booking\_calendar($id,0,$date,true,$selected); |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | public function main\_form\_ajax(){ |
| [428](#L428) | $id = 0; |
| [429](#L429) | $data = array(); |
| [430](#L430) | $submit = ""; |
| [431](#L431) | if(isset($\_POST['wpdevart\_id'])) { |
| [432](#L432) | $id = esc\_html($\_POST['wpdevart\_id']); |
| [433](#L433) | } |
| [434](#L434) | if(isset($\_POST['wpdevart\_data'])) { |
| [435](#L435) | $data = json\_decode(stripcslashes($\_POST['wpdevart\_data']),true); |
| [436](#L436) | } |
| [437](#L437) | if(isset($\_POST['wpdevart\_submit'])) { |
| [438](#L438) | $submit = esc\_html($\_POST['wpdevart\_submit']); |
| [439](#L439) | } |
| [440](#L440) | echo $this->main\_booking\_calendar($id,0,"",true,array(),$data,$submit); |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) |  |
| [444](#L444) | public function  wpdevart\_get\_interval\_dates(){ |
| [445](#L445) | global $wpdb; |
| [446](#L446) | $start\_date = "1970-01-01"; |
| [447](#L447) | $end\_date = "1970-01-01"; |
| [448](#L448) | $id = 0; |
| [449](#L449) | $selected\_dates = array(); // main genereted days |
| [450](#L450) | $avaible\_days\_array = array(); |
| [451](#L451) | if(isset($\_GET['wpdevart\_start\_date'])) |
| [452](#L452) | $start\_date = date( 'Y-m-d', strtotime($\_GET['wpdevart\_start\_date'])); |
| [453](#L453) | else |
| [454](#L454) | die('0'); |
| [455](#L455) |  |
| [456](#L456) | if(isset($\_GET['wpdevart\_end\_date'])) |
| [457](#L457) | $end\_date = date( 'Y-m-d', strtotime($\_GET['wpdevart\_end\_date'])); |
| [458](#L458) | else |
| [459](#L459) | die('0'); |
| [460](#L460) |  |
| [461](#L461) | if(isset($\_GET['wpdevart\_id'])) |
| [462](#L462) | $id = $\_GET['wpdevart\_id']; |
| [463](#L463) | else |
| [464](#L464) | die('0'); |
| [465](#L465) |  |
| [466](#L466) | $ids = $this->calendar\_model->get\_ids($id); |
| [467](#L467) | $theme\_option = $this->theme\_model->get\_setting\_rows($ids["theme\_id"]); |
| [468](#L468) | $theme\_option = json\_decode($theme\_option->value,true); |
| [469](#L469) | $date\_diff = abs($this->get\_date\_diff($start\_date,$end\_date)); |
| [470](#L470) | if($date\_diff > 3500){ |
| [471](#L471) | die("0"); |
| [472](#L472) | } |
| [473](#L473) | $get\_cur\_call\_all\_dates = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_dates WHERE calendar\_id="%d"', $id),ARRAY\_A); |
| [474](#L474) |  |
| [475](#L475) | foreach($get\_cur\_call\_all\_dates as $key => $value){ |
| [476](#L476) | $jsoned\_value = json\_decode($value['data'],true); |
| [477](#L477) | if($jsoned\_value['status'] == 'available' || (isset($theme\_option['price\_for\_night']) && $theme\_option['price\_for\_night'] == "on")){ |
| [478](#L478) | $avaible\_days\_array[$key] = $value['day']; |
| [479](#L479) | } |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | for($i=0; $i <= $date\_diff; $i++) { |
| [483](#L483) | $day = date( 'Y-m-d', strtotime($start\_date. " +" . $i . " day" )); |
| [484](#L484) | $week\_day = date('w', strtotime($start\_date. " +" . $i . " day" )); |
| [485](#L485) | if(!(isset($theme\_option['unavailable\_week\_days']) && in\_array($week\_day,$theme\_option['unavailable\_week\_days']))) { |
| [486](#L486) | if(false !== $key = array\_search($day,$avaible\_days\_array)){ |
| [487](#L487) | $selected\_dates[] = $get\_cur\_call\_all\_dates[$key]; |
| [488](#L488) | }else{ |
| [489](#L489) | if(isset($theme\_option['price\_for\_night']) && $theme\_option['price\_for\_night'] == "on" && $date\_diff == $i) { |
| [490](#L490) | continue; |
| [491](#L491) | } |
| [492](#L492) | die('0'); |
| [493](#L493) | } |
| [494](#L494) | } |
| [495](#L495) | } |
| [496](#L496) | echo json\_encode($selected\_dates); |
| [497](#L497) | die(); |
| [498](#L498) |  |
| [499](#L499) | } |
| [500](#L500) |  |
| [501](#L501) | public function main\_payment\_ajax(){ |
| [502](#L502) | $resid = 0; |
| [503](#L503) | $themeid = 0; |
| [504](#L504) | $id = 0; |
| [505](#L505) | $type = ""; |
| [506](#L506) | if(isset($\_POST['wpdevart\_data'])) { |
| [507](#L507) | $type = esc\_html($\_POST['wpdevart\_data']); |
| [508](#L508) | } |
| [509](#L509) | if(isset($\_POST['wpdevart\_id'])) { |
| [510](#L510) | $id = esc\_html($\_POST['wpdevart\_id']); |
| [511](#L511) | } |
| [512](#L512) | if(isset($\_POST['wpdevart\_resid'])) { |
| [513](#L513) | $resid = esc\_html($\_POST['wpdevart\_resid']); |
| [514](#L514) | } |
| [515](#L515) | if(isset($\_POST['wpdevart\_themeid'])) { |
| [516](#L516) | $themeid = esc\_html($\_POST['wpdevart\_themeid']); |
| [517](#L517) | } |
| [518](#L518) | $cal\_name = $this->calendar\_model->get\_calendar\_rows($id); |
| [519](#L519) | $addresses = $this->theme\_model->get\_payment\_info($themeid); |
| [520](#L520) | $for\_trarray = $this->text\_for\_tr(); |
| [521](#L521) | $reserv = self::wpdevart\_payment($id,$type,$addresses,$for\_trarray,$resid,$cal\_name["title"]); |
| [522](#L522) | echo $reserv[0]; |
| [523](#L523) | } |
| [524](#L524) |  |
| [525](#L525) | public function main\_quick\_update(){ |
| [526](#L526) | global $wpdb; |
| [527](#L527) | $id = 0; |
| [528](#L528) | $data = ""; |
| [529](#L529) | if(isset($\_POST['wpdevart\_data'])) { |
| [530](#L530) | $data = esc\_html($\_POST['wpdevart\_data']); |
| [531](#L531) | } |
| [532](#L532) | if(isset($\_POST['wpdevart\_id'])) { |
| [533](#L533) | $id = esc\_html($\_POST['wpdevart\_id']); |
| [534](#L534) | } |
| [535](#L535) | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
| [536](#L536) | array('payment\_status' => $data, |
| [537](#L537) | 'is\_new' => 0), |
| [538](#L538) | array('id' => $id), |
| [539](#L539) | array('%s') |
| [540](#L540) | ); |
| [541](#L541) | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_payments', |
| [542](#L542) | array('pay\_status' => $data), |
| [543](#L543) | array('res\_id' => $id), |
| [544](#L544) | array('%s') |
| [545](#L545) | ); |
| [546](#L546) | } |
| [547](#L547) |  |
| [548](#L548) | private function update\_reservation($data,$submit){ |
| [549](#L549) | global $wpdb; |
| [550](#L550) | $save = false; |
| [551](#L551) | $billing\_form = array(); |
| [552](#L552) | $shipping\_form = array(); |
| [553](#L553) | foreach($data as $key=>$item) { |
| [554](#L554) | if(strrpos($key,"billing\_info\_form\_field") !== false) { |
| [555](#L555) | $billing\_form[$key] = esc\_html($item); |
| [556](#L556) | } |
| [557](#L557) | if(strrpos($key,"shipping\_info\_form\_field") !== false) { |
| [558](#L558) | $shipping\_form[$key] = esc\_html($item); |
| [559](#L559) | } |
| [560](#L560) | } |
| [561](#L561) | $billing\_form = json\_encode($billing\_form); |
| [562](#L562) | $shipping\_form = json\_encode($shipping\_form); |
| [563](#L563) |  |
| [564](#L564) | $payment\_type = wpdevart\_bc\_Library::getData($data, 'payment\_type\_'.$submit, 'text', ''); |
| [565](#L565) | $resid = wpdevart\_bc\_Library::getData($data, 'resid\_'.$submit, 'text', ''); |
| [566](#L566) |  |
| [567](#L567) | $save\_in\_db = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', array( |
| [568](#L568) | 'address\_billing' => $billing\_form, |
| [569](#L569) | 'address\_shipping' => $shipping\_form, |
| [570](#L570) | 'payment\_method' => $payment\_type, |
| [571](#L571) | 'payment\_status' => 'pending', |
| [572](#L572) | ), array('id' => $resid)); |
| [573](#L573) |  |
| [574](#L574) | $result = $save\_in\_db; |
| [575](#L575) | return $result; |
| [576](#L576) | } |
| [577](#L577) | private function show\_reservation\_info($data) { |
| [578](#L578) | $form\_data = $this->reservation\_model->get\_form\_data($data['form'],$this->id); |
| [579](#L579) | $extras\_data = $this->reservation\_model->get\_extra\_data($data,"front",0,$this->id); |
| [580](#L580) | $countries = wpdevart\_bc\_Library::get\_countries(); |
| [581](#L581) | $reserv\_info = '<div class="wpdevart\_reservation\_info">'; |
| [582](#L582) | $cur\_pos = (isset($this->theme\_option['currency\_pos']) && $this->theme\_option['currency\_pos'] == "before") ? "before" : "after"; |
| [583](#L583) | if(count($data)) { |
| [584](#L584) | $hour\_html = ""; |
| [585](#L585) | if(isset($this->theme\_option["date\_format"]) && $this->theme\_option["date\_format"] != "") { |
| [586](#L586) | $date\_format = $this->theme\_option["date\_format"]; |
| [587](#L587) | } else { |
| [588](#L588) | $date\_format = "F d, Y"; |
| [589](#L589) | } |
| [590](#L590) | if($data['check\_in']) { |
| [591](#L591) | $check\_in = date($date\_format, strtotime($data['check\_in'])); |
| [592](#L592) | $check\_out = date($date\_format, strtotime($data['check\_out'])); |
| [593](#L593) | } else { |
| [594](#L594) | $single\_day = date($date\_format, strtotime($data['single\_day'])); |
| [595](#L595) | } |
| [596](#L596) | if(isset($single\_day)) { |
| [597](#L597) | $unique\_id = $data['calendar\_id']."\_".$data['single\_day']; |
| [598](#L598) | $day\_hours = self::get\_date\_data( $unique\_id ); |
| [599](#L599) | $day\_hours = json\_decode($day\_hours, true); |
| [600](#L600) | } |
| [601](#L601) | if(isset($data['start\_hour']) && $data['start\_hour'] != "") { |
| [602](#L602) | $hour\_html = $data['start\_hour']; |
| [603](#L603) | } |
| [604](#L604) | if(isset($data['end\_hour']) && $data['end\_hour'] != "") { |
| [605](#L605) | $hour\_html = $hour\_html." - ".$data['end\_hour']; |
| [606](#L606) | } |
| [607](#L607) | if(isset($check\_in) && isset($check\_out)) { |
| [608](#L608) | $date = $check\_in. " - " .$check\_out; |
| [609](#L609) | } else { |
| [610](#L610) | $date = $single\_day; |
| [611](#L611) | } |
| [612](#L612) | $sale\_percent\_html = ""; |
| [613](#L613) | if(isset($data["sale\_percent"]) && !empty($data["sale\_percent"])){ |
| [614](#L614) | if($data["sale\_type"] == "percent"){ |
| [615](#L615) | $sale\_percent = $data["sale\_percent"] != "100" ? (($data["total\_price"]  \* 100) / (100 - $data["sale\_percent"])) : $data["price"]; |
| [616](#L616) | $sale\_percent\_html = (($cur\_pos == "before" ? $data["currency"] : '') . $sale\_percent . ($cur\_pos == "after" ? $data["currency"] : '')) . " - " . $data["sale\_percent"] . "% = "; |
| [617](#L617) | } else{ |
| [618](#L618) | $sale\_percent = $data["total\_price"] + $data["sale\_percent"]; |
| [619](#L619) | $sale\_percent\_html = (($cur\_pos == "before" ? $data["currency"] : '') . $sale\_percent . ($cur\_pos == "after" ? $data["currency"] : '')) . " - " . ($cur\_pos == "before" ? $data["currency"] : '') . $data["sale\_percent"] . ($cur\_pos == "after" ? $data["currency"] : '') . " = "; |
| [620](#L620) |  |
| [621](#L621) | } |
| [622](#L622) | } |
| [623](#L623) | if($hour\_html != "") { |
| [624](#L624) | $date .= "<div>".\_\_("Hour","booking-calendar")." ".$hour\_html."</div>"; |
| [625](#L625) | } |
| [626](#L626) | $reserv\_info .= self::reservation\_item(\_\_('Reservation ID','booking-calendar'),$data["id"]); |
| [627](#L627) | $reserv\_info .= self::reservation\_item(\_\_('Reservation date','booking-calendar'),$date); |
| [628](#L628) | if($data["count\_item"] != "" && $data["count\_item"] != 0){ |
| [629](#L629) | $reserv\_info .= self::reservation\_item(\_\_('Item Count','booking-calendar'),$data["count\_item"]); |
| [630](#L630) | } |
| [631](#L631) | $reserv\_info .= self::reservation\_item(\_\_('Price','booking-calendar'),($cur\_pos == "before" ? $data["currency"] : '') . $data["price"] . ($cur\_pos == "after" ? $data["currency"] : '')); |
| [632](#L632) | $reserv\_info .= self::reservation\_item(\_\_('Total','booking-calendar'),$sale\_percent\_html . (($cur\_pos == "before" ? $data["currency"] : '') . $data["total\_price"] . ($cur\_pos == "after" ? $data["currency"] : ''))); |
| [633](#L633) | if(count($extras\_data)) { |
| [634](#L634) | foreach($extras\_data as $extra\_data) { |
| [635](#L635) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($extra\_data["group\_label"]),""); |
| [636](#L636) | if($extra\_data["price\_type"] == "percent") { |
| [637](#L637) | $extra\_value = "<span class='price-percent'>".$extra\_data["operation"].$extra\_data["price\_percent"]."% </span>"; |
| [638](#L638) | $extra\_value .= "<span class='price'>".$extra\_data["operation"] . ($cur\_pos == "before" ? $data['currency'] : '') . (isset($extra\_data["price"]) ? $extra\_data["price"] : "") . ($cur\_pos == "after" ? $data['currency'] : '')."</span></span></span>"; |
| [639](#L639) | } else { |
| [640](#L640) | $extra\_value = "<span class='price'>".$extra\_data["operation"] .(($cur\_pos == "before" ? $data['currency'] : '') . $extra\_data["price"] . ($cur\_pos == "after" ? $data['currency'] : ''))."</span></span></span>"; |
| [641](#L641) | } |
| [642](#L642) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($extra\_data["label"]),$extra\_value); |
| [643](#L643) | } |
| [644](#L644) | $reserv\_info .= self::reservation\_item(\_\_("Price change",'booking-calendar'),("<span class='form\_info'><span class='form\_label'></span><span class='form\_value'>".(($data['extras\_price']<0)? "" : "+").(($cur\_pos == "before" ? $data['currency'] : '') . $data['extras\_price'] . ($cur\_pos == "after" ? $data['currency'] : ''))."</span>")); |
| [645](#L645) | } |
| [646](#L646) | if(count($form\_data)) { |
| [647](#L647) | foreach($form\_data as $form\_fild\_data) { |
| [648](#L648) | if($form\_fild\_data['type'] == 'countries' && trim($form\_fild\_data['value']) != "") { |
| [649](#L649) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]),$countries[$form\_fild\_data["value"]]); |
| [650](#L650) | }elseif($form\_fild\_data['type'] == 'checkbox') { |
| [651](#L651) | if($form\_fild\_data['value'] == "on") { |
| [652](#L652) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]),"<i title='Close' class='fa fa-check'></i>"); |
| [653](#L653) | } else { |
| [654](#L654) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]),""); |
| [655](#L655) | } |
| [656](#L656) | }else { |
| [657](#L657) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]),$form\_fild\_data["value"]); |
| [658](#L658) | } |
| [659](#L659) | } |
| [660](#L660) | } |
| [661](#L661) | } |
| [662](#L662) | $reserv\_info .= '</div>'; |
| [663](#L663) | return $reserv\_info; |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | private static function reservation\_item($label,$value) { |
| [667](#L667) | if(strpos($value, "|wpdev|") !== false){ |
| [668](#L668) | $value = explode("|wpdev|",$value); |
| [669](#L669) | $value = implode(", ",$value); |
| [670](#L670) | } |
| [671](#L671) | $reserv\_info = '<div class="div-for-clear res-item-container"> |
| [672](#L672) | <div class="section-title"> |
| [673](#L673) | <span class="wpdevart-title">'.$label.'</span> |
| [674](#L674) | </div> |
| [675](#L675) | <div class="res-item-value"> |
| [676](#L676) | <span class="wpdevart-title">'.$value.'</span> |
| [677](#L677) | </div> |
| [678](#L678) | </div>'; |
| [679](#L679) | return $reserv\_info; |
| [680](#L680) | } |
| [681](#L681) |  |
| [682](#L682) | private static function get\_date\_data( $unique\_id ) { |
| [683](#L683) | global $wpdb; |
| [684](#L684) | $date\_info = ""; |
| [685](#L685) | $row = $wpdb->get\_row($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_dates WHERE unique\_id="%s"', $unique\_id),ARRAY\_A); |
| [686](#L686) | if(is\_array($row) &&  isset($row["data"])) |
| [687](#L687) | $date\_info = $row["data"]; |
| [688](#L688) | return $date\_info; |
| [689](#L689) | } |
| [690](#L690) |  |
| [691](#L691) |  |
| [692](#L692) | public function get\_extra\_data($extras,$cal\_id) { |
| [693](#L693) | global $wpdb; |
| [694](#L694) | $extra = $extras->extras; |
| [695](#L695) | $price = $extras->price; |
| [696](#L696) | if($extra) { |
| [697](#L697) | $extras\_value = json\_decode($extra, true); |
| [698](#L698) | $extra\_id = $wpdb->get\_var($wpdb->prepare('SELECT extra\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
| [699](#L699) | $extra\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"', $extra\_id)); |
| [700](#L700) | $extra\_info = json\_decode($extra\_info, true); |
| [701](#L701) |  |
| [702](#L702) | if(isset($extra\_info['apply']) || isset($extra\_info['save']))   { |
| [703](#L703) | array\_shift($extra\_info); |
| [704](#L704) | } |
| [705](#L705) | foreach($extras\_value as $key=>$extra\_value) { |
| [706](#L706) | if(isset($extra\_info[$key])) { |
| [707](#L707) | $extras\_value[$key]["group\_label"] = $extra\_info[$key]["label"]; |
| [708](#L708) | if($extra\_value['price\_type'] == "percent") { |
| [709](#L709) | $extras\_value[$key]["price"] = ($price\*$extra\_value['price\_percent'])/100; |
| [710](#L710) | } else { |
| [711](#L711) | $extras\_value[$key]["price"] = $extra\_value['price\_percent']; |
| [712](#L712) | } |
| [713](#L713) | } |
| [714](#L714) | else { |
| [715](#L715) | $extras\_value[$key]["group\_label"] = ""; |
| [716](#L716) | } |
| [717](#L717) | } |
| [718](#L718) | } else { |
| [719](#L719) | $extras\_value = array(); |
| [720](#L720) | } |
| [721](#L721) | return $extras\_value; |
| [722](#L722) | } |
| [723](#L723) |  |
| [724](#L724) | public static function wpdevart\_payment($id,$type,$addresses,$for\_trarray,$resid,$cal\_name) { |
| [725](#L725) |  |
| [726](#L726) | $payment\_form = '<div class="wpdevart\_order\_content visible"  id="wpdevart\_booking\_form\_'.$id.'">'; |
| [727](#L727) | $payment\_form .= '<h4 class="form\_title order\_title">'.$for\_trarray['for\_'.$type].'<span class="wpdevart\_close\_popup"><i class="fa fa-close"></i></span></h4>'; |
| [728](#L728) | $payment\_form .= '<div class="wpdevart\_order\_container wpdevart-booking-form">'; |
| [729](#L729) | if(count($addresses)){ |
| [730](#L730) | foreach($addresses as $key => $form\_item) { |
| [731](#L731) | if($key != 'theme\_option'){ |
| [732](#L732) | $payment\_form .= "<div class='address\_item'>"; |
| [733](#L733) | $payment\_form .= "<h4 class='form\_title'>".$form\_item["title"]."</h4>"; |
| [734](#L734) | if($key == "shipping\_info") { |
| [735](#L735) | $payment\_form .= '<div class="wpdevart-fild-item-container"><label for="wpdevart\_form\_field9">'.$for\_trarray['for\_shipping\_info'].'</label><div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_form\_field\_'.$id.'"><input type="checkbox" id="wpdevart\_form\_field\_'.$id.'" name="wpdevart\_form\_field\_'.$id.'" class="wpdevart\_shipping"></div></div>'; |
| [736](#L736) | } |
| [737](#L737) | $form\_array = json\_decode($form\_item["data"],true); |
| [738](#L738) | foreach($form\_array as $key2 => $form\_field) { |
| [739](#L739) | if(isset($form\_field['type'])) { |
| [740](#L740) | $func\_name = "form\_field\_" . $form\_field['type']; |
| [741](#L741) | if(method\_exists("wpdevart\_Main",$func\_name)) { |
| [742](#L742) | $payment\_form .= self::$func\_name($form\_field,$key); |
| [743](#L743) | } |
| [744](#L744) | } |
| [745](#L745) | } |
| [746](#L746) | $payment\_form .= "</div>"; |
| [747](#L747) | } |
| [748](#L748) | } |
| [749](#L749) | } |
| [750](#L750) | $payment\_form .= '<button type="submit" name="payment\_submit\_'.$id.'" id="payment\_submit\_'.$id.'" class="wpdevart-submit order-submit">'.$for\_trarray['for\_submit\_button'].'</button>'; |
| [751](#L751) | $payment\_form .= '</div></div>'; |
| [752](#L752) | return array($payment\_form,$resid); |
| [753](#L753) | } |
| [754](#L754) | private static function form\_field\_checkbox($form\_field,$type){ |
| [755](#L755) | $input\_class = ''; |
| [756](#L756) | $field\_html = ''; |
| [757](#L757) | $field\_html .= '<div class="wpdevart-fild-item-container">'; |
| [758](#L758) | $field\_html .= '<label for="wpdevart\_'.$form\_field['name'].'">'.esc\_html($form\_field['label']); |
| [759](#L759) |  |
| [760](#L760) | if(isset($form\_field['required'])) { |
| [761](#L761) | $field\_html .= '<span class="wpdevart-required">\*</span>'; |
| [762](#L762) | $input\_class = 'class="wpdevart-required"'; |
| [763](#L763) | } |
| [764](#L764) | $field\_html .= '</label>'; |
| [765](#L765) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"> |
| [766](#L766) | <input type="checkbox" id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'" '.$input\_class.'> |
| [767](#L767) | </div> |
| [768](#L768) | </div>'; |
| [769](#L769) | return $field\_html; |
| [770](#L770) | } |
| [771](#L771) | private static function form\_field\_text($form\_field,$type){ |
| [772](#L772) | $input\_class = array(); |
| [773](#L773) | $field\_html = ''; |
| [774](#L774) | $readonly = ''; |
| [775](#L775) | $required = ''; |
| [776](#L776) | if(isset($form\_field['required'])) { |
| [777](#L777) | $required .= '<span class="wpdevart-required">\*</span>'; |
| [778](#L778) | $input\_class[] = 'wpdevart-required'; |
| [779](#L779) | } |
| [780](#L780) | if(isset($form\_field['isemail']) && $form\_field['isemail'] == "on" ) { |
| [781](#L781) | $input\_class[] = 'wpdevart-email'; |
| [782](#L782) | } |
| [783](#L783) | if(isset($form\_field['confirm\_email']) && $form\_field['confirm\_email'] == "on" ) { |
| [784](#L784) | $input\_class[] = 'confirm\_email'; |
| [785](#L785) | } |
| [786](#L786) | if(isset($form\_field['class']) && $form\_field['class'] != "" ) { |
| [787](#L787) | $input\_class[] = $form\_field['class']; |
| [788](#L788) | } |
| [789](#L789) | if(isset($form\_field['readonly']) && $form\_field['readonly'] == "true" ) { |
| [790](#L790) | $readonly = "readonly"; |
| [791](#L791) | } |
| [792](#L792) | if(count($input\_class)) { |
| [793](#L793) | $input\_class = implode(" ",$input\_class); |
| [794](#L794) | $class = "class='".$input\_class."'"; |
| [795](#L795) | } else { |
| [796](#L796) | $class = ""; |
| [797](#L797) | } |
| [798](#L798) | $field\_html .= '<div class="wpdevart-fild-item-container"> |
| [799](#L799) | <label for="wpdevart\_'.$form\_field['name'].'" '.$class.'>'.esc\_html($form\_field['label']).$required. '</label>'; |
| [800](#L800) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"> |
| [801](#L801) | <input type="text" id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'" '.$class.' ' .$readonly. '> |
| [802](#L802) | </div> |
| [803](#L803) | </div>'; |
| [804](#L804) | return $field\_html; |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) | private static function form\_field\_textarea($form\_field,$type){ |
| [808](#L808) | $input\_class = ''; |
| [809](#L809) | $field\_html = ''; |
| [810](#L810) | $field\_html .= '<div class="wpdevart-fild-item-container"> |
| [811](#L811) | <label for="wpdevart\_'.$form\_field['name'].'">'.esc\_html($form\_field['label']).'</label>'; |
| [812](#L812) | if(isset($form\_field['required'])) { |
| [813](#L813) | $field\_html .= '<span class="wpdevart-required">\*</span>'; |
| [814](#L814) | $input\_class = 'class="wpdevart-required"'; |
| [815](#L815) | } |
| [816](#L816) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"> |
| [817](#L817) | <textarea id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'" '.$input\_class.'></textarea> |
| [818](#L818) | </div> |
| [819](#L819) | </div>'; |
| [820](#L820) | return $field\_html; |
| [821](#L821) | } |
| [822](#L822) |  |
| [823](#L823) | private static function form\_field\_select($form\_field,$type){ |
| [824](#L824) | $select\_options = explode(PHP\_EOL, $form\_field['options']); |
| [825](#L825) | $input\_class = ''; |
| [826](#L826) | $field\_html = ''; |
| [827](#L827) | if(count($select\_options)){ |
| [828](#L828) | $field\_html .= '<div class="wpdevart-fild-item-container"> |
| [829](#L829) | <label for="wpdevart\_'.$form\_field['name'].'">'.esc\_html($form\_field['label']).'</label>'; |
| [830](#L830) | if(isset($form\_field['required'])) { |
| [831](#L831) | $field\_html .= '<span class="wpdevart-required">\*</span>'; |
| [832](#L832) | $input\_class = 'wpdevart-required '; |
| [833](#L833) | } |
| [834](#L834) | if(isset($form\_field['class']) && $form\_field['class'] != "" ) { |
| [835](#L835) | $input\_class .= $form\_field['class']; |
| [836](#L836) | } |
| [837](#L837) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"><select id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'"'; |
| [838](#L838) | if(isset($form\_field['multi'])) { |
| [839](#L839) | $field\_html .= 'multiple="multiple"'; |
| [840](#L840) | } |
| [841](#L841) | if(isset($form\_field['onchange'])) { |
| [842](#L842) | $field\_html .= 'onchange="'.$form\_field['onchange'].'"'; |
| [843](#L843) | } |
| [844](#L844) | $field\_html .= ' class="'.$input\_class.'">'; |
| [845](#L845) | foreach($select\_options as $select\_option) { |
| [846](#L846) | if(trim($select\_option) != '') { |
| [847](#L847) | $field\_html .= '<option value="'.esc\_html($select\_option).'">'.esc\_html($select\_option).'</option>'; |
| [848](#L848) | } |
| [849](#L849) | } |
| [850](#L850) | $field\_html .= '</select> |
| [851](#L851) | </div> |
| [852](#L852) | </div>'; |
| [853](#L853) | } |
| [854](#L854) | else { |
| [855](#L855) | $field\_html .= 'No options'; |
| [856](#L856) | } |
| [857](#L857) | return $field\_html; |
| [858](#L858) | } |
| [859](#L859) |  |
| [860](#L860) | private static function form\_field\_countries($form\_field,$type){ |
| [861](#L861) | $select\_options = wpdevart\_bc\_Library::get\_countries(); |
| [862](#L862) | $input\_class = ''; |
| [863](#L863) | $field\_html = ''; |
| [864](#L864) | $field\_html .= '<div class="wpdevart-fild-item-container"> |
| [865](#L865) | <label for="wpdevart\_'.$form\_field['name'].'">'.esc\_html($form\_field['label']).'</label>'; |
| [866](#L866) | if(isset($form\_field['required'])) { |
| [867](#L867) | $field\_html .= '<span class="wpdevart-required">\*</span>'; |
| [868](#L868) | $input\_class = 'wpdevart-required '; |
| [869](#L869) | } |
| [870](#L870) | if(isset($form\_field['class']) && $form\_field['class'] != "" ) { |
| [871](#L871) | $input\_class .= $form\_field['class']; |
| [872](#L872) | } |
| [873](#L873) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"><select id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'"'; |
| [874](#L874) | $field\_html .= ' class="'.$input\_class.'">'; |
| [875](#L875) | foreach($select\_options as $code => $select\_option) { |
| [876](#L876) | $field\_html .= '<option value="'.esc\_html($code).'">'.esc\_html($select\_option).'</option>'; |
| [877](#L877) | } |
| [878](#L878) | $field\_html .= '</select> |
| [879](#L879) | </div> |
| [880](#L880) | </div>'; |
| [881](#L881) | return $field\_html; |
| [882](#L882) | } |
| [883](#L883) |  |
| [884](#L884) | private static function form\_field\_recapthcha($form\_field,$type){ |
| [885](#L885) | $select\_options = wpdevart\_bc\_Library::get\_countries(); |
| [886](#L886) | $input\_class = ''; |
| [887](#L887) | $field\_html = ''; |
| [888](#L888) | $field\_html .= '<div class="wpdevart-fild-item-container"> |
| [889](#L889) | <label for="wpdevart\_'.$form\_field['name'].'">'.esc\_html($form\_field['label']).'</label>'; |
| [890](#L890) | if(isset($form\_field['required'])) { |
| [891](#L891) | $field\_html .= '<span class="wpdevart-required">\*</span>'; |
| [892](#L892) | $input\_class = 'wpdevart-required '; |
| [893](#L893) | } |
| [894](#L894) | if(isset($form\_field['class']) && $form\_field['class'] != "" ) { |
| [895](#L895) | $input\_class .= $form\_field['class']; |
| [896](#L896) | } |
| [897](#L897) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"><select id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'"'; |
| [898](#L898) | $field\_html .= ' class="'.$input\_class.'">'; |
| [899](#L899) | foreach($select\_options as $code => $select\_option) { |
| [900](#L900) | $field\_html .= '<option value="'.esc\_html($code).'">'.esc\_html($select\_option).'</option>'; |
| [901](#L901) | } |
| [902](#L902) | $field\_html .= '</select> |
| [903](#L903) | </div> |
| [904](#L904) | </div>'; |
| [905](#L905) | return $field\_html; |
| [906](#L906) | } |
| [907](#L907) |  |
| [908](#L908) | private function get\_date\_diff($date1, $date2) { |
| [909](#L909) | $start = strtotime($date1); |
| [910](#L910) | $end = strtotime($date2); |
| [911](#L911) | $datediff = $end - $start; |
| [912](#L912) | return round($datediff/(60\*60\*24)); |
| [913](#L913) | } |
| [914](#L914) |  |
| [915](#L915) | private function text\_for\_tr() { |
| [916](#L916) | $for\_tr = array( |
| [917](#L917) | "for\_available" => "available", |
| [918](#L918) | "for\_booked" => "Booked", |
| [919](#L919) | "for\_unavailable" => "Unavailable", |
| [920](#L920) | "for\_check\_in" => "Check in", |
| [921](#L921) | "for\_check\_out" => "Check out", |
| [922](#L922) | "for\_night\_count" => "Number of nights", |
| [923](#L923) | "for\_date" => "Date", |
| [924](#L924) | "for\_no\_hour" => "No hour available.", |
| [925](#L925) | "for\_start\_hour" => "Start hour", |
| [926](#L926) | "for\_end\_hour" => "End hour", |
| [927](#L927) | "for\_hour" => "Hour", |
| [928](#L928) | "for\_item\_count" => "Item count", |
| [929](#L929) | "for\_termscond" => "I accept to agree to the Terms & Conditions.", |
| [930](#L930) | "for\_reservation" => "Reservation", |
| [931](#L931) | "for\_select\_days" => "Please select the days from calendar.", |
| [932](#L932) | "for\_price" => "Price", |
| [933](#L933) | "for\_total" => "Total", |
| [934](#L934) | "for\_submit\_button" => "Book Now", |
| [935](#L935) | "for\_request\_successfully\_sent" => "Your request has been successfully sent. Please wait for approval.", |
| [936](#L936) | "for\_request\_successfully\_received" => "Your request has been successfully received. We are waiting you!", |
| [937](#L937) | "for\_error\_single" => "There are no services available for this day.", |
| [938](#L938) | "for\_night" => "You must select at least two days", |
| [939](#L939) | "for\_min" => "You must select at least [min] days", |
| [940](#L940) | "for\_max" => "You must select  more than [max] days", |
| [941](#L941) | "for\_min\_hour" => "You must select at least [min] hour", |
| [942](#L942) | "for\_max\_hour" => "You must select  more than [max] hour", |
| [943](#L943) | "for\_capcha" => "Was not verified by recaptcha", |
| [944](#L944) | "for\_error\_multi" => "There are no services available for the period you selected.", |
| [945](#L945) | "for\_notify\_admin\_on\_book" => "Email on book to administrator doesn't send", |
| [946](#L946) | "for\_notify\_admin\_on\_approved" => "Email on approved to administrator doesn't send", |
| [947](#L947) | "for\_notify\_user\_on\_book" => "Email on book to user doesn't send", |
| [948](#L948) | "for\_notify\_user\_on\_approved" => "Email on approved to user doesn't send", |
| [949](#L949) | "for\_notify\_user\_canceled" => "Email on canceled to user doesn't send", |
| [950](#L950) | "for\_notify\_user\_deleted" => "Email on delete to user doesn't send", |
| [951](#L951) | "for\_pay\_in\_cash" => "Pay in cash", |
| [952](#L952) | "for\_paypal" => "Pay with PayPal", |
| [953](#L953) | "for\_shipping\_info" => "Same as billing info" |
| [954](#L954) | ); |
| [955](#L955) |  |
| [956](#L956) | foreach($for\_tr as $key => $for) { |
| [957](#L957) | if(isset($this->theme\_option['use\_mo']) && $this->theme\_option['use\_mo'] == "on") { |
| [958](#L958) | $for\_trarray[$key] = \_\_($for,'booking-calendar'); |
| [959](#L959) | } elseif(isset($this->theme\_option[$key])){ |
| [960](#L960) | $for\_trarray[$key] = wpdevart\_bc\_Library::translated\_text($this->theme\_option[$key]); |
| [961](#L961) | } else { |
| [962](#L962) | $for\_trarray[$key] = \_\_($for,'booking-calendar'); |
| [963](#L963) | } |
| [964](#L964) | } |
| [965](#L965) |  |
| [966](#L966) | return $for\_trarray; |
| [967](#L967) | } |
| [968](#L968) |  |
| [969](#L969) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/booking-calendar/tags/3.2.15/includes/main_class.php?format=txt)
* [Original Format](/export/3222482/booking-calendar/tags/3.2.15/includes/main_class.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_4a76771b_20250114_214042.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbooking-calendar%2Ftags%2F3.2.15%2Fincludes%2Fmain_class.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/booking-calendar/trunk/includes/main_class.php?rev=2848690 "Revision 2848690")
* [Next Revision](/browser/booking-calendar/trunk/includes/main_class.php?rev=3201222 "Revision 3201222") →
* [Blame](/browser/booking-calendar/trunk/includes/main_class.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/booking-calendar/tags/3.2.15/includes/main_class.php)

---

# [source:](/browser?order=name "Go to repository root") [booking-calendar](/browser/booking-calendar?order=name "View booking-calendar")/[tags](/browser/booking-calendar/tags?order=name "View tags")/[3.2.15](/browser/booking-calendar/tags/3.2.15?order=name "View 3.2.15")/[includes](/browser/booking-calendar/tags/3.2.15/includes?order=name "View includes")/[main\_class.php](/browser/booking-calendar/tags/3.2.15/includes/main_class.php?order=name "View main_class.php")

View diff against:

View revision:

| [Last change](/changeset/2864445/booking-calendar/trunk/includes/main_class.php "View differences") on this file was [2864445](/changeset/2864445/ "View changeset 2864445"), checked in by wpdevart, [2 years ago](/timeline?from=2023-02-13T14%3A19%3A38Z&precision=second "See timeline at 02/13/2023 02:19:38 PM") |
| --- |
| new version |
| **File size:** 45.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | class wpdevart\_Main { |
| [3](#L3) |  |
| [4](#L4) | private $reservation\_model; |
| [5](#L5) | private $theme\_model; |
| [6](#L6) | private $calendar\_model; |
| [7](#L7) | private $form\_model; |
| [8](#L8) | private $extra\_model; |
| [9](#L9) | private $theme\_option; |
| [10](#L10) | private $calendar\_data; |
| [11](#L11) | private $extra\_field; |
| [12](#L12) | private $form\_option; |
| [13](#L13) | private $booking\_id; |
| [14](#L14) | private $id; |
| [15](#L15) | private $ids; |
| [16](#L16) | private $widget; |
| [17](#L17) |  |
| [18](#L18) | public function \_\_construct($id = 0, $widget = false){ |
| [19](#L19) | $this->id = $id; |
| [20](#L20) | $this->widget = $widget; |
| [21](#L21) | $this->require\_files(); |
| [22](#L22) | $this->reservation\_model = new wpdevart\_bc\_ModelReservations(); |
| [23](#L23) | $this->theme\_model = new wpdevart\_bc\_ModelThemes(); |
| [24](#L24) | $this->calendar\_model = new wpdevart\_bc\_ModelCalendars(); |
| [25](#L25) | $this->form\_model = new wpdevart\_bc\_ModelForms(); |
| [26](#L26) | $this->extra\_model = new wpdevart\_bc\_ModelExtras(); |
| [27](#L27) | $this->ids = $this->calendar\_model->get\_ids($this->id); |
| [28](#L28) | $this->calendar\_data = $this->calendar\_model->get\_db\_days\_data($this->id); |
| [29](#L29) | if ($this->ids) { |
| [30](#L30) | $this->theme\_option = $this->theme\_model->get\_setting\_rows($this->ids["theme\_id"]); |
| [31](#L31) | $this->extra\_field = $this->extra\_model->get\_extra\_rows($this->ids["extra\_id"]); |
| [32](#L32) | $this->form\_option = $this->form\_model->get\_form\_rows($this->ids["form\_id"]); |
| [33](#L33) | } |
| [34](#L34) | if($this->widget == true) { |
| [35](#L35) | $this->booking\_id = wpdevart\_bc\_calendar::$booking\_count + 1000; |
| [36](#L36) | } else { |
| [37](#L37) | $this->booking\_id = wpdevart\_bc\_calendar::$booking\_count; |
| [38](#L38) | } |
| [39](#L39) | if(isset($this->theme\_option)) { |
| [40](#L40) | $this->theme\_option = json\_decode($this->theme\_option->value, true); |
| [41](#L41) | } else { |
| [42](#L42) | $this->theme\_option = array(); |
| [43](#L43) | } |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) | /\*\* |
| [47](#L47) | \* Require files |
| [48](#L48) | \*\*/ |
| [49](#L49) | private function require\_files() { |
| [50](#L50) | wp\_enqueue\_script( 'wpdevart-script' ); |
| [51](#L51) | wp\_localize\_script( 'wpdevart-script', WPDEVART\_PLUGIN\_PREFIX, array( |
| [52](#L52) | 'ajaxUrl'     => admin\_url( 'admin-ajax.php' ), |
| [53](#L53) | 'ajaxNonce'   => wp\_create\_nonce( 'wpdevart\_ajax\_nonce' ) |
| [54](#L54) | ) ); |
| [55](#L55) | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Reservations.php"); |
| [56](#L56) | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Themes.php"); |
| [57](#L57) | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Calendars.php"); |
| [58](#L58) | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Forms.php"); |
| [59](#L59) | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Extras.php"); |
| [60](#L60) | } |
| [61](#L61) |  |
| [62](#L62) | /\*############  Main booking function ################\*/ |
| [63](#L63) |  |
| [64](#L64) | public function main\_booking\_calendar($id, $res\_id = 0, $date='', $ajax = false, $selected = array(),$data = array(),$submit = "",$hours = array()){ |
| [65](#L65) | global $wpdb; |
| [66](#L66) | $payments = array(); |
| [67](#L67) | $result = array(); |
| [68](#L68) | $mail\_error = array(); |
| [69](#L69) | $request\_message = ""; |
| [70](#L70) | $submit\_message = ""; |
| [71](#L71) | $booking\_calendar = ""; |
| [72](#L72) | if(isset($\_POST["resid\_".$this->booking\_id])) |
| [73](#L73) | $res\_id = $\_POST["resid\_".$this->booking\_id]; |
| [74](#L74) | $res = $this->reservation\_model->get\_reservation\_row($res\_id); |
| [75](#L75) | $cal\_name = $this->calendar\_model->get\_calendar\_rows($id); |
| [76](#L76) | if(isset($\_POST["payment\_type\_".$this->booking\_id])) { |
| [77](#L77) | $this->update\_reservation($\_POST,$this->booking\_id); |
| [78](#L78) | if($\_POST["payment\_type\_".$this->booking\_id] == "pay\_in\_cash"){ |
| [79](#L79) |  |
| [80](#L80) | wpdevart\_bc\_Library::wpdevart\_redirect(esc\_url($this->theme\_option["redirect\_url\_successful"])); |
| [81](#L81) |  |
| [82](#L82) | } elseif($\_POST["payment\_type\_".$this->booking\_id] == "paypal") { |
| [83](#L83) | //require\_once(WPDEVART\_PLUGIN\_DIR.'includes/payments.php'); |
| [84](#L84) | new WpdevartPayments($this->theme\_option,$this->booking\_id,$id,$res,$cal\_name["title"]); |
| [85](#L85) | //wpdevart\_bc\_Library::wpdevart\_redirect($url); |
| [86](#L86) | } |
| [87](#L87) | } |
| [88](#L88) | if(isset($this->theme\_option['delete\_prev\_date']) && $this->theme\_option['delete\_prev\_date'] == "on") { |
| [89](#L89) | $day = date( 'Y-m-d', strtotime("last day")); |
| [90](#L90) | $wpdb->query("DELETE FROM ".$wpdb->prefix . "wpdevart\_dates WHERE calendar\_id=".$id." AND  day BETWEEN '1970-01-01' AND '".$day."'" ); |
| [91](#L91) | $wpdb->query("DELETE FROM ".$wpdb->prefix . "wpdevart\_reservations WHERE calendar\_id=".$id." AND  (single\_day BETWEEN '1970-01-01' AND '".$day."' OR (check\_in BETWEEN '1970-01-01' AND '".$day."' AND  check\_out BETWEEN '1970-01-01' AND '".$day."'))" ); |
| [92](#L92) | } |
| [93](#L93) | $for\_trarray = $this->text\_for\_tr(); |
| [94](#L94) |  |
| [95](#L95) |  |
| [96](#L96) | if ($date == '' && !isset( $\_REQUEST['date'] )) { |
| [97](#L97) | $date = date( 'Y-m-d' ); |
| [98](#L98) | } |
| [99](#L99) | if (isset( $\_REQUEST['date'] ) && $\_REQUEST['date'] != '') { |
| [100](#L100) | $date = $\_REQUEST['date']; |
| [101](#L101) | } |
| [102](#L102) | /\* Default year and month \*/ |
| [103](#L103) | if(isset($this->theme\_option["default\_month"]) && $this->theme\_option["default\_month"] != 0 && ($ajax == false || isset($data["wpdevart-submit".$submit]))) { |
| [104](#L104) | $date\_m = substr\_replace($date,$this->theme\_option["default\_month"],5,2); |
| [105](#L105) | } |
| [106](#L106) | if(isset($this->theme\_option["default\_year"]) && $this->theme\_option["default\_year"] != "" && ($ajax == false || isset($data["wpdevart-submit".$submit]))) { |
| [107](#L107) | if(isset($date\_m )){ |
| [108](#L108) | $date\_y = substr\_replace($date\_m,$this->theme\_option["default\_year"],0,4); |
| [109](#L109) | } else{ |
| [110](#L110) | $date\_y = substr\_replace($date,$this->theme\_option["default\_year"],0,4); |
| [111](#L111) | } |
| [112](#L112) | } |
| [113](#L113) | if(isset($date\_m) && strtotime( $date ) < strtotime( $date\_m )) { |
| [114](#L114) | $date = $date\_m; |
| [115](#L115) | } |
| [116](#L116) | if(isset($date\_y) && strtotime( $date ) < strtotime( $date\_y )) { |
| [117](#L117) | $date = $date\_y; |
| [118](#L118) | } |
| [119](#L119) | if ($date != '') { |
| [120](#L120) | $date = $date; |
| [121](#L121) | } |
| [122](#L122) | $date  = date('Y-m-d', strtotime( $date )); |
| [123](#L123) | $calendar\_start = new wpdevart\_bc\_BookingCalendar($date, $res, $id, $this->theme\_option, $this->calendar\_data, $this->form\_option, $this->extra\_field,array(),false,$this->widget,$for\_trarray); |
| [124](#L124) |  |
| [125](#L125) | if(isset($hours['hours']) && $hours['hours'] == "true") { |
| [126](#L126) | echo $calendar\_start->booking\_calendar\_hours($hours['date']); |
| [127](#L127) | die(); |
| [128](#L128) | } |
| [129](#L129) | if(isset($data["wpdevart-submit".$submit])){ |
| [130](#L130) | $result = $calendar\_start->save\_reserv($data,$submit); |
| [131](#L131) | if ($result !== 'wrong\_data') { |
| [132](#L132) | $save= $result[0]; |
| [133](#L133) | $send\_mails = $result[1]; |
| [134](#L134) | if(isset($result[2])) |
| [135](#L135) | $form\_data = $result[2]; |
| [136](#L136) |  |
| [137](#L137) | if(isset($form\_data) &&  $form\_data['total\_price'] !== false){ |
| [138](#L138) | if(isset($this->theme\_option['paypal']) && $this->theme\_option['paypal'] == "on"){ |
| [139](#L139) | $payments['paypal'] = "on"; |
| [140](#L140) | if(isset($this->theme\_option["go\_paypal"]) && $this->theme\_option["go\_paypal"] == 'on') { |
| [141](#L141) | $save\_in\_db = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', array( |
| [142](#L142) | 'payment\_method' => 'paypal', |
| [143](#L143) | 'payment\_status' => 'pending', |
| [144](#L144) | ), array('id' => $form\_data['id'])); |
| [145](#L145) | new WpdevartPayments($this->theme\_option,$this->booking\_id,$id,$form\_data,$cal\_name["title"]); |
| [146](#L146) | } |
| [147](#L147) | } |
| [148](#L148) | if(isset($this->theme\_option['pay\_in\_cash']) && isset($this->theme\_option['pay\_in\_cash']) == "on") { |
| [149](#L149) | $payments['pay\_in\_cash'] = "on"; |
| [150](#L150) | } |
| [151](#L151) | } |
| [152](#L152) | if(!is\_admin() || count($data)) { |
| [153](#L153) | if($save && isset($this->theme\_option["enable\_instant\_approval"]) && $this->theme\_option["enable\_instant\_approval"] == "on") { |
| [154](#L154) | $request\_message = $for\_trarray["for\_request\_successfully\_received"]; |
| [155](#L155) | } elseif($save) { |
| [156](#L156) | $request\_message = $for\_trarray["for\_request\_successfully\_sent"]; |
| [157](#L157) | } |
| [158](#L158) | foreach($send\_mails as $send\_mail) { |
| [159](#L159) | foreach($send\_mail as $key=>$value) { |
| [160](#L160) | if(isset($this->theme\_option[$key."\_error"]) && $this->theme\_option[$key."\_error"] == "on" && $value === false) { |
| [161](#L161) | $mail\_error[] = (isset($for\_trarray["for\_".$key]) ? $for\_trarray["for\_".$key] : ""); |
| [162](#L162) | } |
| [163](#L163) | } |
| [164](#L164) | } |
| [165](#L165) | if(isset($this->theme\_option["action\_after\_submit"]) && $this->theme\_option["action\_after\_submit"] == "stay\_on\_calendar") { |
| [166](#L166) | $submit\_message = wpdevart\_bc\_Library::translated\_text($this->theme\_option["message\_text"]); |
| [167](#L167) | } |
| [168](#L168) | else { |
| [169](#L169) | if(count($payments) == 0) { |
| [170](#L170) | $redirect\_url = wpdevart\_bc\_Library::translated\_text($this->theme\_option["redirect\_url"]); |
| [171](#L171) | wpdevart\_bc\_Library::wpdevart\_redirect(esc\_url($redirect\_url)); |
| [172](#L172) | } |
| [173](#L173) | } |
| [174](#L174) | } else { |
| [175](#L175) | return; |
| [176](#L176) | } |
| [177](#L177) | } else { |
| [178](#L178) | $wrong\_data = true; |
| [179](#L179) | } |
| [180](#L180) | } |
| [181](#L181) | elseif(isset($data["wpdevart-update".$submit])){ |
| [182](#L182) | $result = $calendar\_start->save\_reserv($data,$submit,"update"); |
| [183](#L183) | if ($result !== 'wrong\_data') { |
| [184](#L184) | $save= $result[0]; |
| [185](#L185) | $send\_mails = $result[1]; |
| [186](#L186) | if(isset($result[2])) |
| [187](#L187) | $form\_data = $result[2]; |
| [188](#L188) | if(!is\_admin() || count($data)) { |
| [189](#L189) | if($save && isset($this->theme\_option["enable\_instant\_approval"]) && $this->theme\_option["enable\_instant\_approval"] == "on") { |
| [190](#L190) | $request\_message = $for\_trarray["for\_request\_successfully\_received"]; |
| [191](#L191) | } elseif($save) { |
| [192](#L192) | $request\_message = $for\_trarray["for\_request\_successfully\_sent"]; |
| [193](#L193) | } |
| [194](#L194) | foreach($send\_mails as $send\_mail) { |
| [195](#L195) | foreach($send\_mail as $key=>$value) { |
| [196](#L196) | if(isset($this->theme\_option[$key."\_error"]) && $this->theme\_option[$key."\_error"] == "on" && $value === false) { |
| [197](#L197) | $mail\_error[] = (isset($for\_trarray["for\_".$key]) ? $for\_trarray["for\_".$key] : ""); |
| [198](#L198) | } |
| [199](#L199) | } |
| [200](#L200) | } |
| [201](#L201) | if(isset($this->theme\_option["action\_after\_submit"]) && $this->theme\_option["action\_after\_submit"] == "stay\_on\_calendar") { |
| [202](#L202) | $submit\_message = wpdevart\_bc\_Library::translated\_text($this->theme\_option["message\_text"]); |
| [203](#L203) | } |
| [204](#L204) | } else { |
| [205](#L205) | return; |
| [206](#L206) | } |
| [207](#L207) | } else { |
| [208](#L208) | $wrong\_data = true; |
| [209](#L209) | } |
| [210](#L210) | } |
| [211](#L211) | $calendar\_data\_after\_save = $this->calendar\_model->get\_db\_days\_data($id); |
| [212](#L212) | $calendar = new wpdevart\_bc\_BookingCalendar($date, $res, $id, $this->theme\_option, $calendar\_data\_after\_save, $this->form\_option,$this->extra\_field, $selected,$ajax,$this->widget,$for\_trarray); |
| [213](#L213) |  |
| [214](#L214) | if(isset($this->theme\_option) && !$ajax) { |
| [215](#L215) | $booking\_calendar .= $calendar->get\_styles(); |
| [216](#L216) | } |
| [217](#L217) | if(isset($form\_data) &&  $form\_data['total\_price'] !== false){ |
| [218](#L218) | if(isset($this->theme\_option['paypal']) && $this->theme\_option['paypal'] == "on"){ |
| [219](#L219) | $payments['paypal'] = "on"; |
| [220](#L220) | } |
| [221](#L221) | if(isset($this->theme\_option['pay\_in\_cash']) && isset($this->theme\_option['pay\_in\_cash']) == "on") { |
| [222](#L222) | $payments['pay\_in\_cash'] = "on"; |
| [223](#L223) | } |
| [224](#L224) | } |
| [225](#L225) | if (!$ajax) { |
| [226](#L226) | $min = (isset($this->theme\_option["min\_days"]) && $this->theme\_option["min\_days"] != '') ? $this->theme\_option["min\_days"] : 1; |
| [227](#L227) | $max = (isset($this->theme\_option["max\_days"]) && $this->theme\_option["max\_days"] != '') ? $this->theme\_option["max\_days"] : 1000; |
| [228](#L228) | $min\_hour = (isset($this->theme\_option["min\_hours"]) && $this->theme\_option["min\_hours"] != '') ? $this->theme\_option["min\_hours"] : 1; |
| [229](#L229) | $max\_hour = (isset($this->theme\_option["max\_hours"]) && $this->theme\_option["max\_hours"] != '') ? $this->theme\_option["max\_hours"] : 1000; |
| [230](#L230) | ?> |
| [231](#L231) | <script> |
| [232](#L232) | var wpdevartBooking<?php echo $this->booking\_id; ?> = { |
| [233](#L233) | booking\_id : <?php echo $this->booking\_id; ?>, |
| [234](#L234) | hours\_enabled : <?php echo ((isset($this->theme\_option['hours\_enabled']) && $this->theme\_option['hours\_enabled'] == "on") ? 1 : 0 ); ?>, |
| [235](#L235) | booking\_widget : <?php echo ((isset($this->widget) && $this->widget == true) ? 1 : 0 ); ?>, |
| [236](#L236) | show\_day\_info\_on\_hover : <?php echo ((isset($this->theme\_option['show\_day\_info\_on\_hover']) && $this->theme\_option['show\_day\_info\_on\_hover'] == 'on') ? 1 : 0 ); ?>, |
| [237](#L237) | cal\_animation\_type : "<?php echo ((isset($this->theme\_option['cal\_animation\_type']) && $this->theme\_option['cal\_animation\_type'] != 'none') ? "animation\_calendar" : "" ); ?>", |
| [238](#L238) | booking\_widget : <?php echo ((isset($this->widget) && $this->widget == true) ? 1 : 0 ); ?>, |
| [239](#L239) | total : "<?php echo $for\_trarray["for\_total"]; ?>", |
| [240](#L240) | price : "<?php echo $for\_trarray["for\_price"]; ?>", |
| [241](#L241) | offset : <?php echo ((isset($this->theme\_option["scroll\_offset"]) && $this->theme\_option["scroll\_offset"] != '') ? $this->theme\_option["scroll\_offset"] : 0); ?>, |
| [242](#L242) | position : "<?php echo ((isset($this->theme\_option["currency\_pos"]) && $this->theme\_option["currency\_pos"] == 'before') ? "before" : "after"); ?>", |
| [243](#L243) | night : <?php echo ((isset($this->theme\_option["price\_for\_night"]) && $this->theme\_option["price\_for\_night"] == 'on') ? 1 : 0); ?>, |
| [244](#L244) | id : <?php echo $id; ?>, |
| [245](#L245) | capcha\_error : "<?php echo $for\_trarray["for\_capcha"]; ?>", |
| [246](#L246) | conditions : '<?php echo ((isset($this->theme\_option["sale\_conditions"]) && $this->theme\_option["sale\_conditions"] != '') ? json\_encode($this->theme\_option["sale\_conditions"]) : ""); ?>', |
| [247](#L247) | hours\_conditions : '<?php echo ((isset($this->theme\_option["hours\_sale\_conditions"]) && $this->theme\_option["hours\_sale\_conditions"] != '') ? json\_encode($this->theme\_option["hours\_sale\_conditions"]) : ""); ?>', |
| [248](#L248) | hide\_price : <?php echo ((isset($this->theme\_option['hide\_price']) && $this->theme\_option['hide\_price'] == "on") ? 1 : 0 ); ?>, |
| [249](#L249) | max\_item : "<?php echo ((isset($this->theme\_option['max\_item'])) ? $this->theme\_option['max\_item'] : "" ); ?>", |
| [250](#L250) | min\_item : "<?php echo ((isset($this->theme\_option['min\_item'])) ? $this->theme\_option['min\_item'] : "" ); ?>", |
| [251](#L251) | error\_days : "<?php echo $for\_trarray["for\_error\_multi"]; ?>", |
| [252](#L252) | error\_night : "<?php echo $for\_trarray["for\_night"]; ?>", |
| [253](#L253) | min : "<?php echo $min; ?>", |
| [254](#L254) | max : "<?php echo $max; ?>", |
| [255](#L255) | min\_hour : "<?php echo $min\_hour; ?>", |
| [256](#L256) | max\_hour : "<?php echo $max\_hour; ?>", |
| [257](#L257) | error\_min\_day : "<?php echo str\_replace("[min]", $min, $for\_trarray["for\_min"]); ?>", |
| [258](#L258) | error\_max\_day : "<?php echo str\_replace("[max]", $max, $for\_trarray["for\_max"]); ?>", |
| [259](#L259) | error\_min\_hour : "<?php echo str\_replace("[min]", $min\_hour, $for\_trarray["for\_min\_hour"]); ?>", |
| [260](#L260) | error\_max\_hour : "<?php echo str\_replace("[max]", $max\_hour, $for\_trarray["for\_max\_hour"]); ?>", |
| [261](#L261) | error\_day : "<?php echo $for\_trarray["for\_error\_single"]; ?>" |
| [262](#L262) | }; |
| [263](#L263) | </script> |
| [264](#L264) | <?php |
| [265](#L265) | $class = "booking\_calendar\_main\_container"; |
| [266](#L266) | $class .= (isset($this->theme\_option['hours\_enabled']) && $this->theme\_option['hours\_enabled'] == "on") ? " hours\_enabled" : ""; |
| [267](#L267) | $class .= (isset($this->widget) && $this->widget == true) ? " booking\_widget" : ""; |
| [268](#L268) | $class .= (isset($this->theme\_option['show\_day\_info\_on\_hover']) && $this->theme\_option['show\_day\_info\_on\_hover'] == 'on') ? " show\_day\_info\_on\_hover" : ""; |
| [269](#L269) | $class .= (isset($this->theme\_option['cal\_animation\_type']) && $this->theme\_option['cal\_animation\_type'] != 'none') ? " animation\_calendar" : ""; |
| [270](#L270) | $class .= (isset($this->theme\_option['layout']) && $this->theme\_option['layout'] == "form\_right") ? " form\_right" : " form\_below"; |
| [271](#L271) |  |
| [272](#L272) | $booking\_calendar .= "<div id='booking\_calendar\_main\_container\_" . $this->booking\_id  . "' class='" . $class . "' data-total='".$for\_trarray["for\_total"]."' data-price='".$for\_trarray["for\_price"]."' data-offset='".((isset($this->theme\_option["scroll\_offset"]) && $this->theme\_option["scroll\_offset"] != '') ? $this->theme\_option["scroll\_offset"] : 0)."' data-position='".((isset($this->theme\_option["currency\_pos"]) && $this->theme\_option["currency\_pos"] == 'before') ? "before" : "after")."' data-night='".((isset($this->theme\_option["price\_for\_night"]) && $this->theme\_option["price\_for\_night"] == 'on') ? "1" : "0")."' data-id='" . $id . "' data-booking\_id='" . $this->booking\_id . "'>"; |
| [273](#L273) | $booking\_calendar .= "<div class='booking\_calendar\_container' id='booking\_calendar\_container\_" . $this->booking\_id  . "'><div class='wpdevart-load-overlay'><div class='wpdevart-load-image'><i class='fa fa-spinner fa-spin'></i></div></div>"; |
| [274](#L274) | } |
| [275](#L275) | if ((isset($this->theme\_option['messages\_pos']) && $this->theme\_option['messages\_pos'] == "top") || !isset($this->theme\_option['messages\_pos'])) { |
| [276](#L276) | if (isset($submit\_message) && $submit\_message != "") { |
| [277](#L277) | $booking\_calendar .= "<div class='booking\_calendar\_message successfully\_text\_container'>".$submit\_message."<span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [278](#L278) | } |
| [279](#L279) | if($request\_message != "") { |
| [280](#L280) | $booking\_calendar .= "<div class='successfully\_text\_container div-for-clear'>".$request\_message."<span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [281](#L281) | } |
| [282](#L282) | if(count($mail\_error)) { |
| [283](#L283) | $booking\_calendar .= '<div class="error\_text\_container div-for-clear email\_error" style="display: block;"><span class="error\_text">'; |
| [284](#L284) | foreach($mail\_error as $error) { |
| [285](#L285) | $booking\_calendar .= $error. "</br>"; |
| [286](#L286) | } |
| [287](#L287) | $booking\_calendar .= '</span><span class="notice\_text\_close"><i class="fa fa-close"></i></span></div>'; |
| [288](#L288) | } |
| [289](#L289) | if(isset($wrong\_data)) { |
| [290](#L290) | $booking\_calendar .= '<div class="error\_text\_container div-for-clear email\_error" style="display: block;"><span class="error\_text">Something went wrong</span><span class="notice\_text\_close"><i class="fa fa-close"></i></span></div>'; |
| [291](#L291) | } |
| [292](#L292) | if (!$ajax) { |
| [293](#L293) | $booking\_calendar .= "<div class='error\_text\_container div-for-clear'><span class='error\_text'></span><span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [294](#L294) | } |
| [295](#L295) | } |
| [296](#L296) | $booking\_calendar .= "<div class='booking\_calendar\_main'>"; |
| [297](#L297) | if( isset($data["wpdevart-submit".$submit]) ){ |
| [298](#L298) | if( isset($this->theme\_option["show\_booking\_info"]) && $this->theme\_option["show\_booking\_info"] == "on") { |
| [299](#L299) | $booking\_calendar .= $this->show\_reservation\_info($form\_data); |
| [300](#L300) | } |
| [301](#L301) | if(count($payments)) { |
| [302](#L302) | $booking\_calendar .= '<div class="wpdevart\_order"><form method="post" id="wpdevart\_order\_'.$submit.'" class="div-for-clear">'; |
| [303](#L303) |  |
| [304](#L304) | $class  = (!isset($this->theme\_option["enable\_billing\_address"]) && !isset($this->theme\_option["enable\_shipping\_address"])) ? "payment\_submit" : ""; |
| [305](#L305) | foreach($payments as $key=>$payment){ |
| [306](#L306) | $button\_cl = ""; |
| [307](#L307) | if($key == "paypal" && isset($this->theme\_option["paypal\_image"]) && $this->theme\_option["paypal\_image"] != ""){ |
| [308](#L308) | $button\_content = "<img src='" . esc\_url($this->theme\_option["paypal\_image"]) . "'>"; |
| [309](#L309) | $button\_cl = "with\_image"; |
| [310](#L310) | } else{ |
| [311](#L311) | $button\_content = $for\_trarray["for\_".$key]; |
| [312](#L312) | } |
| [313](#L313) | $booking\_calendar .= '<button type="button" class="wpdevart-payment-button ' . $button\_cl . ' ' . $class . '" id="'.$key.'" name="wpdevart-payment'.$submit.'" data-id="'.$submit.'" data-resid="'.(isset($form\_data)? $form\_data['id'] : "").'" data-themeid="'.$this->ids["theme\_id"].'">'.$button\_content .'</button>'; |
| [314](#L314) | } |
| [315](#L315) | $booking\_calendar .= '<div class="wpdevart\_order\_wrap"></div>'; |
| [316](#L316) | $booking\_calendar .= '<div class="wpdevart\_order\_content" id="wpdevart\_booking\_form\_'.$submit.'"></div>'; |
| [317](#L317) | $booking\_calendar .= '<input type="hidden" name="resid\_'.$submit.'" value="'.(isset($form\_data)? $form\_data['id'] : "").'"> |
| [318](#L318) | <input type="hidden" name="payment\_type\_'.$submit.'" value=""> |
| [319](#L319) | <input type="hidden" name="view" id="add" value="add">'; |
| [320](#L320) | $booking\_calendar .= '</form></div>'; |
| [321](#L321) | } |
| [322](#L322) | } |
| [323](#L323) | if( (!(isset($data["wpdevart-submit".$submit]) && count($payments))) || isset($data["wpdevart-update".$submit])) { |
| [324](#L324) | $booking\_calendar .= $calendar->booking\_calendar(); |
| [325](#L325) | if (!$ajax) { |
| [326](#L326) | $booking\_calendar .= "</div>"; |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) |  |
| [330](#L330) | if (isset($this->theme\_option['messages\_pos']) && $this->theme\_option['messages\_pos'] == "bottom") { |
| [331](#L331) | if (isset($submit\_message) && $submit\_message != "") { |
| [332](#L332) | $booking\_calendar .= "<div class='booking\_calendar\_message successfully\_text\_container'>".$submit\_message."<span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [333](#L333) | } |
| [334](#L334) | if($request\_message != "") { |
| [335](#L335) | $booking\_calendar .= "<div class='successfully\_text\_container div-for-clear'>".$request\_message."<span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [336](#L336) | } |
| [337](#L337) | if(count($mail\_error)) { |
| [338](#L338) | $booking\_calendar .= '<div class="error\_text\_container div-for-clear email\_error" style="display: block;"><span class="error\_text">'; |
| [339](#L339) | foreach($mail\_error as $error) { |
| [340](#L340) | $booking\_calendar .= $error. "</br>"; |
| [341](#L341) | } |
| [342](#L342) | $booking\_calendar .= '</span><span class="notice\_text\_close"><i class="fa fa-close"></i></span></div>'; |
| [343](#L343) | } |
| [344](#L344) | if (!$ajax) { |
| [345](#L345) | $booking\_calendar .= "<div class='error\_text\_container div-for-clear'><span class='error\_text'></span><span class='notice\_text\_close'><i class='fa fa-close'></i></span></div>"; |
| [346](#L346) | } |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) |  |
| [350](#L350) | $booking\_calendar .= "</div>"; |
| [351](#L351) | if((!is\_admin() || (isset($\_GET["page"]) && $\_GET["page"] == "wpdevart-reservations"))) { |
| [352](#L352) | $class = ""; |
| [353](#L353) | if(!isset($data["wpdevart-update".$submit])){ |
| [354](#L354) | if(!isset($this->theme\_option["show\_form"])) { |
| [355](#L355) | $class = "hide\_form"; |
| [356](#L356) | } |
| [357](#L357) | if(count($payments)) { |
| [358](#L358) | $class .= " cal\_width\_pay"; |
| [359](#L359) | } |
| [360](#L360) | } |
| [361](#L361) | $class .= (isset($this->theme\_option['form\_layout']) && $this->theme\_option['form\_layout'] == "one\_col") ? " one\_col" : ""; |
| [362](#L362) | $booking\_calendar .= $calendar->booking\_form($class); |
| [363](#L363) | } |
| [364](#L364) | if (!$ajax) { |
| [365](#L365) | $booking\_calendar .= "</div>"; |
| [366](#L366) | } |
| [367](#L367) | }else{ |
| [368](#L368) | $booking\_calendar .= "</div>"; |
| [369](#L369) | } |
| [370](#L370) | return $booking\_calendar; |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | public function main\_booking\_calendar\_res($date='', $ajax = false){ |
| [374](#L374) | $calendar = new wpdevart\_bc\_BookingCalendar($date, 0, $this->id, $this->theme\_option, $this->calendar\_data, $this->form\_option, $this->extra\_field, array()); |
| [375](#L375) | $booking\_calendar = ""; |
| [376](#L376) |  |
| [377](#L377) | if (!$ajax) { |
| [378](#L378) | $booking\_calendar .= "<div class='booking\_calendar\_container' id='booking\_calendar\_container\_" . wpdevart\_bc\_calendar::$booking\_count . "'><div class='wpdevart-load-overlay'><div class='wpdevart-load-image'><i class='fa fa-spinner fa-spin'></i></div></div>"; |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | $booking\_calendar .= "<div class='booking\_calendar\_main'>"; |
| [382](#L382) | $booking\_calendar .= $calendar->booking\_calendar("reservation"); |
| [383](#L383) | if (!$ajax) { |
| [384](#L384) | $booking\_calendar .= "</div>"; |
| [385](#L385) | } |
| [386](#L386) | $booking\_calendar .= "</div>"; |
| [387](#L387) | return $booking\_calendar; |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | public function main\_ajax(){ |
| [391](#L391) | $selected = array(); |
| [392](#L392) | $res\_id = 0; |
| [393](#L393) | if(isset($\_POST['wpdevart\_link'])) { |
| [394](#L394) | $link = esc\_html( $\_POST['wpdevart\_link'] ); |
| [395](#L395) | parse\_str( $link, $link\_arr ); |
| [396](#L396) | $date = $link\_arr['?date']; |
| [397](#L397) | } |
| [398](#L398) |  |
| [399](#L399) | if(isset($\_POST['wpdevart\_id'])) { |
| [400](#L400) | $id = esc\_html($\_POST['wpdevart\_id']); |
| [401](#L401) | } |
| [402](#L402) | if(isset($\_POST['wpdevart\_reserv'])) { |
| [403](#L403) | $reserv = esc\_html($\_POST['wpdevart\_reserv']); |
| [404](#L404) | } |
| [405](#L405) | if(isset($\_POST['wpdevart\_selected'])) { |
| [406](#L406) | $selected["index"] = esc\_html($\_POST['wpdevart\_selected']); |
| [407](#L407) | } |
| [408](#L408) | if(isset($\_POST['wpdevart\_selected\_date'])) { |
| [409](#L409) | $selected["date"] = esc\_html($\_POST['wpdevart\_selected\_date']); |
| [410](#L410) | } |
| [411](#L411) | if(isset($\_POST['wpdevart\_hours'])) { |
| [412](#L412) | $selected['hours'] = esc\_html($\_POST['wpdevart\_hours']); |
| [413](#L413) | } |
| [414](#L414) | if(isset($\_POST['wpdevart\_reserv\_id'])) { |
| [415](#L415) | $res\_id = esc\_html($\_POST['wpdevart\_reserv\_id']); |
| [416](#L416) | } |
| [417](#L417) |  |
| [418](#L418) | if(isset($reserv) && $reserv == "true") { |
| [419](#L419) | echo $this->main\_booking\_calendar\_res($date,true); |
| [420](#L420) | } elseif(isset($selected['hours']) && $selected['hours'] == "true") { |
| [421](#L421) | echo $this->main\_booking\_calendar($id, $res\_id,'',false,array(),array(),"",$selected); |
| [422](#L422) | } else { |
| [423](#L423) | echo $this->main\_booking\_calendar($id,0,$date,true,$selected); |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | public function main\_form\_ajax(){ |
| [428](#L428) | $id = 0; |
| [429](#L429) | $data = array(); |
| [430](#L430) | $submit = ""; |
| [431](#L431) | if(isset($\_POST['wpdevart\_id'])) { |
| [432](#L432) | $id = esc\_html($\_POST['wpdevart\_id']); |
| [433](#L433) | } |
| [434](#L434) | if(isset($\_POST['wpdevart\_data'])) { |
| [435](#L435) | $data = json\_decode(stripcslashes($\_POST['wpdevart\_data']),true); |
| [436](#L436) | } |
| [437](#L437) | if(isset($\_POST['wpdevart\_submit'])) { |
| [438](#L438) | $submit = esc\_html($\_POST['wpdevart\_submit']); |
| [439](#L439) | } |
| [440](#L440) | echo $this->main\_booking\_calendar($id,0,"",true,array(),$data,$submit); |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) |  |
| [444](#L444) | public function  wpdevart\_get\_interval\_dates(){ |
| [445](#L445) | global $wpdb; |
| [446](#L446) | $start\_date = "1970-01-01"; |
| [447](#L447) | $end\_date = "1970-01-01"; |
| [448](#L448) | $id = 0; |
| [449](#L449) | $selected\_dates = array(); // main genereted days |
| [450](#L450) | $avaible\_days\_array = array(); |
| [451](#L451) | if(isset($\_GET['wpdevart\_start\_date'])) |
| [452](#L452) | $start\_date = date( 'Y-m-d', strtotime($\_GET['wpdevart\_start\_date'])); |
| [453](#L453) | else |
| [454](#L454) | die('0'); |
| [455](#L455) |  |
| [456](#L456) | if(isset($\_GET['wpdevart\_end\_date'])) |
| [457](#L457) | $end\_date = date( 'Y-m-d', strtotime($\_GET['wpdevart\_end\_date'])); |
| [458](#L458) | else |
| [459](#L459) | die('0'); |
| [460](#L460) |  |
| [461](#L461) | if(isset($\_GET['wpdevart\_id'])) |
| [462](#L462) | $id = $\_GET['wpdevart\_id']; |
| [463](#L463) | else |
| [464](#L464) | die('0'); |
| [465](#L465) |  |
| [466](#L466) | $ids = $this->calendar\_model->get\_ids($id); |
| [467](#L467) | $theme\_option = $this->theme\_model->get\_setting\_rows($ids["theme\_id"]); |
| [468](#L468) | $theme\_option = json\_decode($theme\_option->value,true); |
| [469](#L469) | $date\_diff = abs($this->get\_date\_diff($start\_date,$end\_date)); |
| [470](#L470) | if($date\_diff > 3500){ |
| [471](#L471) | die("0"); |
| [472](#L472) | } |
| [473](#L473) | $get\_cur\_call\_all\_dates = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_dates WHERE calendar\_id="%d"', $id),ARRAY\_A); |
| [474](#L474) |  |
| [475](#L475) | foreach($get\_cur\_call\_all\_dates as $key => $value){ |
| [476](#L476) | $jsoned\_value = json\_decode($value['data'],true); |
| [477](#L477) | if($jsoned\_value['status'] == 'available' || (isset($theme\_option['price\_for\_night']) && $theme\_option['price\_for\_night'] == "on")){ |
| [478](#L478) | $avaible\_days\_array[$key] = $value['day']; |
| [479](#L479) | } |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | for($i=0; $i <= $date\_diff; $i++) { |
| [483](#L483) | $day = date( 'Y-m-d', strtotime($start\_date. " +" . $i . " day" )); |
| [484](#L484) | $week\_day = date('w', strtotime($start\_date. " +" . $i . " day" )); |
| [485](#L485) | if(!(isset($theme\_option['unavailable\_week\_days']) && in\_array($week\_day,$theme\_option['unavailable\_week\_days']))) { |
| [486](#L486) | if(false !== $key = array\_search($day,$avaible\_days\_array)){ |
| [487](#L487) | $selected\_dates[] = $get\_cur\_call\_all\_dates[$key]; |
| [488](#L488) | }else{ |
| [489](#L489) | if(isset($theme\_option['price\_for\_night']) && $theme\_option['price\_for\_night'] == "on" && $date\_diff == $i) { |
| [490](#L490) | continue; |
| [491](#L491) | } |
| [492](#L492) | die('0'); |
| [493](#L493) | } |
| [494](#L494) | } |
| [495](#L495) | } |
| [496](#L496) | echo json\_encode($selected\_dates); |
| [497](#L497) | die(); |
| [498](#L498) |  |
| [499](#L499) | } |
| [500](#L500) |  |
| [501](#L501) | public function main\_payment\_ajax(){ |
| [502](#L502) | $resid = 0; |
| [503](#L503) | $themeid = 0; |
| [504](#L504) | $id = 0; |
| [505](#L505) | $type = ""; |
| [506](#L506) | if(isset($\_POST['wpdevart\_data'])) { |
| [507](#L507) | $type = esc\_html($\_POST['wpdevart\_data']); |
| [508](#L508) | } |
| [509](#L509) | if(isset($\_POST['wpdevart\_id'])) { |
| [510](#L510) | $id = esc\_html($\_POST['wpdevart\_id']); |
| [511](#L511) | } |
| [512](#L512) | if(isset($\_POST['wpdevart\_resid'])) { |
| [513](#L513) | $resid = esc\_html($\_POST['wpdevart\_resid']); |
| [514](#L514) | } |
| [515](#L515) | if(isset($\_POST['wpdevart\_themeid'])) { |
| [516](#L516) | $themeid = esc\_html($\_POST['wpdevart\_themeid']); |
| [517](#L517) | } |
| [518](#L518) | $cal\_name = $this->calendar\_model->get\_calendar\_rows($id); |
| [519](#L519) | $addresses = $this->theme\_model->get\_payment\_info($themeid); |
| [520](#L520) | $for\_trarray = $this->text\_for\_tr(); |
| [521](#L521) | $reserv = self::wpdevart\_payment($id,$type,$addresses,$for\_trarray,$resid,$cal\_name["title"]); |
| [522](#L522) | echo $reserv[0]; |
| [523](#L523) | } |
| [524](#L524) |  |
| [525](#L525) | public function main\_quick\_update(){ |
| [526](#L526) | global $wpdb; |
| [527](#L527) | $id = 0; |
| [528](#L528) | $data = ""; |
| [529](#L529) | if(isset($\_POST['wpdevart\_data'])) { |
| [530](#L530) | $data = esc\_html($\_POST['wpdevart\_data']); |
| [531](#L531) | } |
| [532](#L532) | if(isset($\_POST['wpdevart\_id'])) { |
| [533](#L533) | $id = esc\_html($\_POST['wpdevart\_id']); |
| [534](#L534) | } |
| [535](#L535) | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
| [536](#L536) | array('payment\_status' => $data, |
| [537](#L537) | 'is\_new' => 0), |
| [538](#L538) | array('id' => $id), |
| [539](#L539) | array('%s') |
| [540](#L540) | ); |
| [541](#L541) | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_payments', |
| [542](#L542) | array('pay\_status' => $data), |
| [543](#L543) | array('res\_id' => $id), |
| [544](#L544) | array('%s') |
| [545](#L545) | ); |
| [546](#L546) | } |
| [547](#L547) |  |
| [548](#L548) | private function update\_reservation($data,$submit){ |
| [549](#L549) | global $wpdb; |
| [550](#L550) | $save = false; |
| [551](#L551) | $billing\_form = array(); |
| [552](#L552) | $shipping\_form = array(); |
| [553](#L553) | foreach($data as $key=>$item) { |
| [554](#L554) | if(strrpos($key,"billing\_info\_form\_field") !== false) { |
| [555](#L555) | $billing\_form[$key] = esc\_html($item); |
| [556](#L556) | } |
| [557](#L557) | if(strrpos($key,"shipping\_info\_form\_field") !== false) { |
| [558](#L558) | $shipping\_form[$key] = esc\_html($item); |
| [559](#L559) | } |
| [560](#L560) | } |
| [561](#L561) | $billing\_form = json\_encode($billing\_form); |
| [562](#L562) | $shipping\_form = json\_encode($shipping\_form); |
| [563](#L563) |  |
| [564](#L564) | $payment\_type = wpdevart\_bc\_Library::getData($data, 'payment\_type\_'.$submit, 'text', ''); |
| [565](#L565) | $resid = wpdevart\_bc\_Library::getData($data, 'resid\_'.$submit, 'text', ''); |
| [566](#L566) |  |
| [567](#L567) | $save\_in\_db = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', array( |
| [568](#L568) | 'address\_billing' => $billing\_form, |
| [569](#L569) | 'address\_shipping' => $shipping\_form, |
| [570](#L570) | 'payment\_method' => $payment\_type, |
| [571](#L571) | 'payment\_status' => 'pending', |
| [572](#L572) | ), array('id' => $resid)); |
| [573](#L573) |  |
| [574](#L574) | $result = $save\_in\_db; |
| [575](#L575) | return $result; |
| [576](#L576) | } |
| [577](#L577) | private function show\_reservation\_info($data) { |
| [578](#L578) | $form\_data = $this->reservation\_model->get\_form\_data($data['form'],$this->id); |
| [579](#L579) | $extras\_data = $this->reservation\_model->get\_extra\_data($data,"front",0,$this->id); |
| [580](#L580) | $countries = wpdevart\_bc\_Library::get\_countries(); |
| [581](#L581) | $reserv\_info = '<div class="wpdevart\_reservation\_info">'; |
| [582](#L582) | $cur\_pos = (isset($this->theme\_option['currency\_pos']) && $this->theme\_option['currency\_pos'] == "before") ? "before" : "after"; |
| [583](#L583) | if(count($data)) { |
| [584](#L584) | $hour\_html = ""; |
| [585](#L585) | if(isset($this->theme\_option["date\_format"]) && $this->theme\_option["date\_format"] != "") { |
| [586](#L586) | $date\_format = $this->theme\_option["date\_format"]; |
| [587](#L587) | } else { |
| [588](#L588) | $date\_format = "F d, Y"; |
| [589](#L589) | } |
| [590](#L590) | if($data['check\_in']) { |
| [591](#L591) | $check\_in = date($date\_format, strtotime($data['check\_in'])); |
| [592](#L592) | $check\_out = date($date\_format, strtotime($data['check\_out'])); |
| [593](#L593) | } else { |
| [594](#L594) | $single\_day = date($date\_format, strtotime($data['single\_day'])); |
| [595](#L595) | } |
| [596](#L596) | if(isset($single\_day)) { |
| [597](#L597) | $unique\_id = $data['calendar\_id']."\_".$data['single\_day']; |
| [598](#L598) | $day\_hours = self::get\_date\_data( $unique\_id ); |
| [599](#L599) | $day\_hours = json\_decode($day\_hours, true); |
| [600](#L600) | } |
| [601](#L601) | if(isset($data['start\_hour']) && $data['start\_hour'] != "") { |
| [602](#L602) | $hour\_html = $data['start\_hour']; |
| [603](#L603) | } |
| [604](#L604) | if(isset($data['end\_hour']) && $data['end\_hour'] != "") { |
| [605](#L605) | $hour\_html = $hour\_html." - ".$data['end\_hour']; |
| [606](#L606) | } |
| [607](#L607) | if(isset($check\_in) && isset($check\_out)) { |
| [608](#L608) | $date = $check\_in. " - " .$check\_out; |
| [609](#L609) | } else { |
| [610](#L610) | $date = $single\_day; |
| [611](#L611) | } |
| [612](#L612) | $sale\_percent\_html = ""; |
| [613](#L613) | if(isset($data["sale\_percent"]) && !empty($data["sale\_percent"])){ |
| [614](#L614) | if($data["sale\_type"] == "percent"){ |
| [615](#L615) | $sale\_percent = $data["sale\_percent"] != "100" ? (($data["total\_price"]  \* 100) / (100 - $data["sale\_percent"])) : $data["price"]; |
| [616](#L616) | $sale\_percent\_html = (($cur\_pos == "before" ? $data["currency"] : '') . $sale\_percent . ($cur\_pos == "after" ? $data["currency"] : '')) . " - " . $data["sale\_percent"] . "% = "; |
| [617](#L617) | } else{ |
| [618](#L618) | $sale\_percent = $data["total\_price"] + $data["sale\_percent"]; |
| [619](#L619) | $sale\_percent\_html = (($cur\_pos == "before" ? $data["currency"] : '') . $sale\_percent . ($cur\_pos == "after" ? $data["currency"] : '')) . " - " . ($cur\_pos == "before" ? $data["currency"] : '') . $data["sale\_percent"] . ($cur\_pos == "after" ? $data["currency"] : '') . " = "; |
| [620](#L620) |  |
| [621](#L621) | } |
| [622](#L622) | } |
| [623](#L623) | if($hour\_html != "") { |
| [624](#L624) | $date .= "<div>".\_\_("Hour","booking-calendar")." ".$hour\_html."</div>"; |
| [625](#L625) | } |
| [626](#L626) | $reserv\_info .= self::reservation\_item(\_\_('Reservation ID','booking-calendar'),$data["id"]); |
| [627](#L627) | $reserv\_info .= self::reservation\_item(\_\_('Reservation date','booking-calendar'),$date); |
| [628](#L628) | if($data["count\_item"] != "" && $data["count\_item"] != 0){ |
| [629](#L629) | $reserv\_info .= self::reservation\_item(\_\_('Item Count','booking-calendar'),$data["count\_item"]); |
| [630](#L630) | } |
| [631](#L631) | $reserv\_info .= self::reservation\_item(\_\_('Price','booking-calendar'),($cur\_pos == "before" ? $data["currency"] : '') . $data["price"] . ($cur\_pos == "after" ? $data["currency"] : '')); |
| [632](#L632) | $reserv\_info .= self::reservation\_item(\_\_('Total','booking-calendar'),$sale\_percent\_html . (($cur\_pos == "before" ? $data["currency"] : '') . $data["total\_price"] . ($cur\_pos == "after" ? $data["currency"] : ''))); |
| [633](#L633) | if(count($extras\_data)) { |
| [634](#L634) | foreach($extras\_data as $extra\_data) { |
| [635](#L635) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($extra\_data["group\_label"]),""); |
| [636](#L636) | if($extra\_data["price\_type"] == "percent") { |
| [637](#L637) | $extra\_value = "<span class='price-percent'>".$extra\_data["operation"].$extra\_data["price\_percent"]."% </span>"; |
| [638](#L638) | $extra\_value .= "<span class='price'>".$extra\_data["operation"] . ($cur\_pos == "before" ? $data['currency'] : '') . (isset($extra\_data["price"]) ? $extra\_data["price"] : "") . ($cur\_pos == "after" ? $data['currency'] : '')."</span></span></span>"; |
| [639](#L639) | } else { |
| [640](#L640) | $extra\_value = "<span class='price'>".$extra\_data["operation"] .(($cur\_pos == "before" ? $data['currency'] : '') . $extra\_data["price"] . ($cur\_pos == "after" ? $data['currency'] : ''))."</span></span></span>"; |
| [641](#L641) | } |
| [642](#L642) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($extra\_data["label"]),$extra\_value); |
| [643](#L643) | } |
| [644](#L644) | $reserv\_info .= self::reservation\_item(\_\_("Price change",'booking-calendar'),("<span class='form\_info'><span class='form\_label'></span><span class='form\_value'>".(($data['extras\_price']<0)? "" : "+").(($cur\_pos == "before" ? $data['currency'] : '') . $data['extras\_price'] . ($cur\_pos == "after" ? $data['currency'] : ''))."</span>")); |
| [645](#L645) | } |
| [646](#L646) | if(count($form\_data)) { |
| [647](#L647) | foreach($form\_data as $form\_fild\_data) { |
| [648](#L648) | if($form\_fild\_data['type'] == 'countries' && trim($form\_fild\_data['value']) != "") { |
| [649](#L649) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]),$countries[$form\_fild\_data["value"]]); |
| [650](#L650) | }elseif($form\_fild\_data['type'] == 'checkbox') { |
| [651](#L651) | if($form\_fild\_data['value'] == "on") { |
| [652](#L652) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]),"<i title='Close' class='fa fa-check'></i>"); |
| [653](#L653) | } else { |
| [654](#L654) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]),""); |
| [655](#L655) | } |
| [656](#L656) | }else { |
| [657](#L657) | $reserv\_info .= self::reservation\_item(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]),$form\_fild\_data["value"]); |
| [658](#L658) | } |
| [659](#L659) | } |
| [660](#L660) | } |
| [661](#L661) | } |
| [662](#L662) | $reserv\_info .= '</div>'; |
| [663](#L663) | return $reserv\_info; |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | private static function reservation\_item($label,$value) { |
| [667](#L667) | if(strpos($value, "|wpdev|") !== false){ |
| [668](#L668) | $value = explode("|wpdev|",$value); |
| [669](#L669) | $value = implode(", ",$value); |
| [670](#L670) | } |
| [671](#L671) | $reserv\_info = '<div class="div-for-clear res-item-container"> |
| [672](#L672) | <div class="section-title"> |
| [673](#L673) | <span class="wpdevart-title">'.$label.'</span> |
| [674](#L674) | </div> |
| [675](#L675) | <div class="res-item-value"> |
| [676](#L676) | <span class="wpdevart-title">'.$value.'</span> |
| [677](#L677) | </div> |
| [678](#L678) | </div>'; |
| [679](#L679) | return $reserv\_info; |
| [680](#L680) | } |
| [681](#L681) |  |
| [682](#L682) | private static function get\_date\_data( $unique\_id ) { |
| [683](#L683) | global $wpdb; |
| [684](#L684) | $date\_info = ""; |
| [685](#L685) | $row = $wpdb->get\_row($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_dates WHERE unique\_id="%s"', $unique\_id),ARRAY\_A); |
| [686](#L686) | if(is\_array($row) &&  isset($row["data"])) |
| [687](#L687) | $date\_info = $row["data"]; |
| [688](#L688) | return $date\_info; |
| [689](#L689) | } |
| [690](#L690) |  |
| [691](#L691) |  |
| [692](#L692) | public function get\_extra\_data($extras,$cal\_id) { |
| [693](#L693) | global $wpdb; |
| [694](#L694) | $extra = $extras->extras; |
| [695](#L695) | $price = $extras->price; |
| [696](#L696) | if($extra) { |
| [697](#L697) | $extras\_value = json\_decode($extra, true); |
| [698](#L698) | $extra\_id = $wpdb->get\_var($wpdb->prepare('SELECT extra\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
| [699](#L699) | $extra\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"', $extra\_id)); |
| [700](#L700) | $extra\_info = json\_decode($extra\_info, true); |
| [701](#L701) |  |
| [702](#L702) | if(isset($extra\_info['apply']) || isset($extra\_info['save']))   { |
| [703](#L703) | array\_shift($extra\_info); |
| [704](#L704) | } |
| [705](#L705) | foreach($extras\_value as $key=>$extra\_value) { |
| [706](#L706) | if(isset($extra\_info[$key])) { |
| [707](#L707) | $extras\_value[$key]["group\_label"] = $extra\_info[$key]["label"]; |
| [708](#L708) | if($extra\_value['price\_type'] == "percent") { |
| [709](#L709) | $extras\_value[$key]["price"] = ($price\*$extra\_value['price\_percent'])/100; |
| [710](#L710) | } else { |
| [711](#L711) | $extras\_value[$key]["price"] = $extra\_value['price\_percent']; |
| [712](#L712) | } |
| [713](#L713) | } |
| [714](#L714) | else { |
| [715](#L715) | $extras\_value[$key]["group\_label"] = ""; |
| [716](#L716) | } |
| [717](#L717) | } |
| [718](#L718) | } else { |
| [719](#L719) | $extras\_value = array(); |
| [720](#L720) | } |
| [721](#L721) | return $extras\_value; |
| [722](#L722) | } |
| [723](#L723) |  |
| [724](#L724) | public static function wpdevart\_payment($id,$type,$addresses,$for\_trarray,$resid,$cal\_name) { |
| [725](#L725) |  |
| [726](#L726) | $payment\_form = '<div class="wpdevart\_order\_content visible"  id="wpdevart\_booking\_form\_'.$id.'">'; |
| [727](#L727) | $payment\_form .= '<h4 class="form\_title order\_title">'.$for\_trarray['for\_'.$type].'<span class="wpdevart\_close\_popup"><i class="fa fa-close"></i></span></h4>'; |
| [728](#L728) | $payment\_form .= '<div class="wpdevart\_order\_container wpdevart-booking-form">'; |
| [729](#L729) | if(count($addresses)){ |
| [730](#L730) | foreach($addresses as $key => $form\_item) { |
| [731](#L731) | if($key != 'theme\_option'){ |
| [732](#L732) | $payment\_form .= "<div class='address\_item'>"; |
| [733](#L733) | $payment\_form .= "<h4 class='form\_title'>".$form\_item["title"]."</h4>"; |
| [734](#L734) | if($key == "shipping\_info") { |
| [735](#L735) | $payment\_form .= '<div class="wpdevart-fild-item-container"><label for="wpdevart\_form\_field9">'.$for\_trarray['for\_shipping\_info'].'</label><div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_form\_field\_'.$id.'"><input type="checkbox" id="wpdevart\_form\_field\_'.$id.'" name="wpdevart\_form\_field\_'.$id.'" class="wpdevart\_shipping"></div></div>'; |
| [736](#L736) | } |
| [737](#L737) | $form\_array = json\_decode($form\_item["data"],true); |
| [738](#L738) | foreach($form\_array as $key2 => $form\_field) { |
| [739](#L739) | if(isset($form\_field['type'])) { |
| [740](#L740) | $func\_name = "form\_field\_" . $form\_field['type']; |
| [741](#L741) | if(method\_exists("wpdevart\_Main",$func\_name)) { |
| [742](#L742) | $payment\_form .= self::$func\_name($form\_field,$key); |
| [743](#L743) | } |
| [744](#L744) | } |
| [745](#L745) | } |
| [746](#L746) | $payment\_form .= "</div>"; |
| [747](#L747) | } |
| [748](#L748) | } |
| [749](#L749) | } |
| [750](#L750) | $payment\_form .= '<button type="submit" name="payment\_submit\_'.$id.'" id="payment\_submit\_'.$id.'" class="wpdevart-submit order-submit">'.$for\_trarray['for\_submit\_button'].'</button>'; |
| [751](#L751) | $payment\_form .= '</div></div>'; |
| [752](#L752) | return array($payment\_form,$resid); |
| [753](#L753) | } |
| [754](#L754) | private static function form\_field\_checkbox($form\_field,$type){ |
| [755](#L755) | $input\_class = ''; |
| [756](#L756) | $field\_html = ''; |
| [757](#L757) | $field\_html .= '<div class="wpdevart-fild-item-container">'; |
| [758](#L758) | $field\_html .= '<label for="wpdevart\_'.$form\_field['name'].'">'.esc\_html($form\_field['label']); |
| [759](#L759) |  |
| [760](#L760) | if(isset($form\_field['required'])) { |
| [761](#L761) | $field\_html .= '<span class="wpdevart-required">\*</span>'; |
| [762](#L762) | $input\_class = 'class="wpdevart-required"'; |
| [763](#L763) | } |
| [764](#L764) | $field\_html .= '</label>'; |
| [765](#L765) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"> |
| [766](#L766) | <input type="checkbox" id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'" '.$input\_class.'> |
| [767](#L767) | </div> |
| [768](#L768) | </div>'; |
| [769](#L769) | return $field\_html; |
| [770](#L770) | } |
| [771](#L771) | private static function form\_field\_text($form\_field,$type){ |
| [772](#L772) | $input\_class = array(); |
| [773](#L773) | $field\_html = ''; |
| [774](#L774) | $readonly = ''; |
| [775](#L775) | $required = ''; |
| [776](#L776) | if(isset($form\_field['required'])) { |
| [777](#L777) | $required .= '<span class="wpdevart-required">\*</span>'; |
| [778](#L778) | $input\_class[] = 'wpdevart-required'; |
| [779](#L779) | } |
| [780](#L780) | if(isset($form\_field['isemail']) && $form\_field['isemail'] == "on" ) { |
| [781](#L781) | $input\_class[] = 'wpdevart-email'; |
| [782](#L782) | } |
| [783](#L783) | if(isset($form\_field['confirm\_email']) && $form\_field['confirm\_email'] == "on" ) { |
| [784](#L784) | $input\_class[] = 'confirm\_email'; |
| [785](#L785) | } |
| [786](#L786) | if(isset($form\_field['class']) && $form\_field['class'] != "" ) { |
| [787](#L787) | $input\_class[] = $form\_field['class']; |
| [788](#L788) | } |
| [789](#L789) | if(isset($form\_field['readonly']) && $form\_field['readonly'] == "true" ) { |
| [790](#L790) | $readonly = "readonly"; |
| [791](#L791) | } |
| [792](#L792) | if(count($input\_class)) { |
| [793](#L793) | $input\_class = implode(" ",$input\_class); |
| [794](#L794) | $class = "class='".$input\_class."'"; |
| [795](#L795) | } else { |
| [796](#L796) | $class = ""; |
| [797](#L797) | } |
| [798](#L798) | $field\_html .= '<div class="wpdevart-fild-item-container"> |
| [799](#L799) | <label for="wpdevart\_'.$form\_field['name'].'" '.$class.'>'.esc\_html($form\_field['label']).$required. '</label>'; |
| [800](#L800) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"> |
| [801](#L801) | <input type="text" id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'" '.$class.' ' .$readonly. '> |
| [802](#L802) | </div> |
| [803](#L803) | </div>'; |
| [804](#L804) | return $field\_html; |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) | private static function form\_field\_textarea($form\_field,$type){ |
| [808](#L808) | $input\_class = ''; |
| [809](#L809) | $field\_html = ''; |
| [810](#L810) | $field\_html .= '<div class="wpdevart-fild-item-container"> |
| [811](#L811) | <label for="wpdevart\_'.$form\_field['name'].'">'.esc\_html($form\_field['label']).'</label>'; |
| [812](#L812) | if(isset($form\_field['required'])) { |
| [813](#L813) | $field\_html .= '<span class="wpdevart-required">\*</span>'; |
| [814](#L814) | $input\_class = 'class="wpdevart-required"'; |
| [815](#L815) | } |
| [816](#L816) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"> |
| [817](#L817) | <textarea id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'" '.$input\_class.'></textarea> |
| [818](#L818) | </div> |
| [819](#L819) | </div>'; |
| [820](#L820) | return $field\_html; |
| [821](#L821) | } |
| [822](#L822) |  |
| [823](#L823) | private static function form\_field\_select($form\_field,$type){ |
| [824](#L824) | $select\_options = explode(PHP\_EOL, $form\_field['options']); |
| [825](#L825) | $input\_class = ''; |
| [826](#L826) | $field\_html = ''; |
| [827](#L827) | if(count($select\_options)){ |
| [828](#L828) | $field\_html .= '<div class="wpdevart-fild-item-container"> |
| [829](#L829) | <label for="wpdevart\_'.$form\_field['name'].'">'.esc\_html($form\_field['label']).'</label>'; |
| [830](#L830) | if(isset($form\_field['required'])) { |
| [831](#L831) | $field\_html .= '<span class="wpdevart-required">\*</span>'; |
| [832](#L832) | $input\_class = 'wpdevart-required '; |
| [833](#L833) | } |
| [834](#L834) | if(isset($form\_field['class']) && $form\_field['class'] != "" ) { |
| [835](#L835) | $input\_class .= $form\_field['class']; |
| [836](#L836) | } |
| [837](#L837) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"><select id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'"'; |
| [838](#L838) | if(isset($form\_field['multi'])) { |
| [839](#L839) | $field\_html .= 'multiple="multiple"'; |
| [840](#L840) | } |
| [841](#L841) | if(isset($form\_field['onchange'])) { |
| [842](#L842) | $field\_html .= 'onchange="'.$form\_field['onchange'].'"'; |
| [843](#L843) | } |
| [844](#L844) | $field\_html .= ' class="'.$input\_class.'">'; |
| [845](#L845) | foreach($select\_options as $select\_option) { |
| [846](#L846) | if(trim($select\_option) != '') { |
| [847](#L847) | $field\_html .= '<option value="'.esc\_html($select\_option).'">'.esc\_html($select\_option).'</option>'; |
| [848](#L848) | } |
| [849](#L849) | } |
| [850](#L850) | $field\_html .= '</select> |
| [851](#L851) | </div> |
| [852](#L852) | </div>'; |
| [853](#L853) | } |
| [854](#L854) | else { |
| [855](#L855) | $field\_html .= 'No options'; |
| [856](#L856) | } |
| [857](#L857) | return $field\_html; |
| [858](#L858) | } |
| [859](#L859) |  |
| [860](#L860) | private static function form\_field\_countries($form\_field,$type){ |
| [861](#L861) | $select\_options = wpdevart\_bc\_Library::get\_countries(); |
| [862](#L862) | $input\_class = ''; |
| [863](#L863) | $field\_html = ''; |
| [864](#L864) | $field\_html .= '<div class="wpdevart-fild-item-container"> |
| [865](#L865) | <label for="wpdevart\_'.$form\_field['name'].'">'.esc\_html($form\_field['label']).'</label>'; |
| [866](#L866) | if(isset($form\_field['required'])) { |
| [867](#L867) | $field\_html .= '<span class="wpdevart-required">\*</span>'; |
| [868](#L868) | $input\_class = 'wpdevart-required '; |
| [869](#L869) | } |
| [870](#L870) | if(isset($form\_field['class']) && $form\_field['class'] != "" ) { |
| [871](#L871) | $input\_class .= $form\_field['class']; |
| [872](#L872) | } |
| [873](#L873) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"><select id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'"'; |
| [874](#L874) | $field\_html .= ' class="'.$input\_class.'">'; |
| [875](#L875) | foreach($select\_options as $code => $select\_option) { |
| [876](#L876) | $field\_html .= '<option value="'.esc\_html($code).'">'.esc\_html($select\_option).'</option>'; |
| [877](#L877) | } |
| [878](#L878) | $field\_html .= '</select> |
| [879](#L879) | </div> |
| [880](#L880) | </div>'; |
| [881](#L881) | return $field\_html; |
| [882](#L882) | } |
| [883](#L883) |  |
| [884](#L884) | private static function form\_field\_recapthcha($form\_field,$type){ |
| [885](#L885) | $select\_options = wpdevart\_bc\_Library::get\_countries(); |
| [886](#L886) | $input\_class = ''; |
| [887](#L887) | $field\_html = ''; |
| [888](#L888) | $field\_html .= '<div class="wpdevart-fild-item-container"> |
| [889](#L889) | <label for="wpdevart\_'.$form\_field['name'].'">'.esc\_html($form\_field['label']).'</label>'; |
| [890](#L890) | if(isset($form\_field['required'])) { |
| [891](#L891) | $field\_html .= '<span class="wpdevart-required">\*</span>'; |
| [892](#L892) | $input\_class = 'wpdevart-required '; |
| [893](#L893) | } |
| [894](#L894) | if(isset($form\_field['class']) && $form\_field['class'] != "" ) { |
| [895](#L895) | $input\_class .= $form\_field['class']; |
| [896](#L896) | } |
| [897](#L897) | $field\_html .= '<div class="wpdevart-elem-container div-for-clear" id="wpdevart\_wrap\_'.$form\_field['name'].'"><select id="wpdevart\_'.$form\_field['name'].'" name="wpdevart\_'.$type."\_".$form\_field['name'].'"'; |
| [898](#L898) | $field\_html .= ' class="'.$input\_class.'">'; |
| [899](#L899) | foreach($select\_options as $code => $select\_option) { |
| [900](#L900) | $field\_html .= '<option value="'.esc\_html($code).'">'.esc\_html($select\_option).'</option>'; |
| [901](#L901) | } |
| [902](#L902) | $field\_html .= '</select> |
| [903](#L903) | </div> |
| [904](#L904) | </div>'; |
| [905](#L905) | return $field\_html; |
| [906](#L906) | } |
| [907](#L907) |  |
| [908](#L908) | private function get\_date\_diff($date1, $date2) { |
| [909](#L909) | $start = strtotime($date1); |
| [910](#L910) | $end = strtotime($date2); |
| [911](#L911) | $datediff = $end - $start; |
| [912](#L912) | return round($datediff/(60\*60\*24)); |
| [913](#L913) | } |
| [914](#L914) |  |
| [915](#L915) | private function text\_for\_tr() { |
| [916](#L916) | $for\_tr = array( |
| [917](#L917) | "for\_available" => "available", |
| [918](#L918) | "for\_booked" => "Booked", |
| [919](#L919) | "for\_unavailable" => "Unavailable", |
| [920](#L920) | "for\_check\_in" => "Check in", |
| [921](#L921) | "for\_check\_out" => "Check out", |
| [922](#L922) | "for\_night\_count" => "Number of nights", |
| [923](#L923) | "for\_date" => "Date", |
| [924](#L924) | "for\_no\_hour" => "No hour available.", |
| [925](#L925) | "for\_start\_hour" => "Start hour", |
| [926](#L926) | "for\_end\_hour" => "End hour", |
| [927](#L927) | "for\_hour" => "Hour", |
| [928](#L928) | "for\_item\_count" => "Item count", |
| [929](#L929) | "for\_termscond" => "I accept to agree to the Terms & Conditions.", |
| [930](#L930) | "for\_reservation" => "Reservation", |
| [931](#L931) | "for\_select\_days" => "Please select the days from calendar.", |
| [932](#L932) | "for\_price" => "Price", |
| [933](#L933) | "for\_total" => "Total", |
| [934](#L934) | "for\_submit\_button" => "Book Now", |
| [935](#L935) | "for\_request\_successfully\_sent" => "Your request has been successfully sent. Please wait for approval.", |
| [936](#L936) | "for\_request\_successfully\_received" => "Your request has been successfully received. We are waiting you!", |
| [937](#L937) | "for\_error\_single" => "There are no services available for this day.", |
| [938](#L938) | "for\_night" => "You must select at least two days", |
| [939](#L939) | "for\_min" => "You must select at least [min] days", |
| [940](#L940) | "for\_max" => "You must select  more than [max] days", |
| [941](#L941) | "for\_min\_hour" => "You must select at least [min] hour", |
| [942](#L942) | "for\_max\_hour" => "You must select  more than [max] hour", |
| [943](#L943) | "for\_capcha" => "Was not verified by recaptcha", |
| [944](#L944) | "for\_error\_multi" => "There are no services available for the period you selected.", |
| [945](#L945) | "for\_notify\_admin\_on\_book" => "Email on book to administrator doesn't send", |
| [946](#L946) | "for\_notify\_admin\_on\_approved" => "Email on approved to administrator doesn't send", |
| [947](#L947) | "for\_notify\_user\_on\_book" => "Email on book to user doesn't send", |
| [948](#L948) | "for\_notify\_user\_on\_approved" => "Email on approved to user doesn't send", |
| [949](#L949) | "for\_notify\_user\_canceled" => "Email on canceled to user doesn't send", |
| [950](#L950) | "for\_notify\_user\_deleted" => "Email on delete to user doesn't send", |
| [951](#L951) | "for\_pay\_in\_cash" => "Pay in cash", |
| [952](#L952) | "for\_paypal" => "Pay with PayPal", |
| [953](#L953) | "for\_shipping\_info" => "Same as billing info" |
| [954](#L954) | ); |
| [955](#L955) |  |
| [956](#L956) | foreach($for\_tr as $key => $for) { |
| [957](#L957) | if(isset($this->theme\_option['use\_mo']) && $this->theme\_option['use\_mo'] == "on") { |
| [958](#L958) | $for\_trarray[$key] = \_\_($for,'booking-calendar'); |
| [959](#L959) | } elseif(isset($this->theme\_option[$key])){ |
| [960](#L960) | $for\_trarray[$key] = wpdevart\_bc\_Library::translated\_text($this->theme\_option[$key]); |
| [961](#L961) | } else { |
| [962](#L962) | $for\_trarray[$key] = \_\_($for,'booking-calendar'); |
| [963](#L963) | } |
| [964](#L964) | } |
| [965](#L965) |  |
| [966](#L966) | return $for\_trarray; |
| [967](#L967) | } |
| [968](#L968) |  |
| [969](#L969) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/booking-calendar/tags/3.2.15/includes/main_class.php?format=txt)
* [Original Format](/export/3222482/booking-calendar/tags/3.2.15/includes/main_class.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_fa7e141e_20250114_214118.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3209851%2540booking-calendar%26old%3D3209851%2540booking-calendar)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3201239/booking-calendar "Changeset 3201239 for booking-calendar")
* [Next Change](/changeset/3209854/booking-calendar "Changeset 3209854 for booking-calendar") →

---

# Changeset [3209851](/changeset/3209851 "Show full changeset") for [booking-calendar](/browser/booking-calendar?rev=3209851 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
12/18/2024 12:07:28 PM
([4 weeks](/timeline?from=2024-12-18T12%3A07%3A28Z&precision=second "See timeline at 12/18/2024 12:07:28 PM") ago)

Author:
wpdevart
Message:

Security issue fixed

Location:
[booking-calendar/trunk](/browser/booking-calendar/trunk?rev=3209851)
Files:

24 edited

* [admin/controllers/Calendars.php](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851 "Show entry in browser")
  (modified)
  ([11 diffs](#file0 "Show differences"))
* [admin/controllers/Extras.php](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=3209851 "Show entry in browser")
  (modified)
  ([6 diffs](#file1 "Show differences"))
* [admin/controllers/Forms.php](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=3209851 "Show entry in browser")
  (modified)
  ([5 diffs](#file2 "Show differences"))
* [admin/controllers/GlobalSettings.php](/browser/booking-calendar/trunk/admin/controllers/GlobalSettings.php?rev=3209851 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [admin/controllers/Payment.php](/browser/booking-calendar/trunk/admin/controllers/Payment.php?rev=3209851 "Show entry in browser")
  (modified)
  ([3 diffs](#file4 "Show differences"))
* [admin/controllers/Reservations.php](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851 "Show entry in browser")
  (modified)
  ([11 diffs](#file5 "Show differences"))
* [admin/models/Calendars.php](/browser/booking-calendar/trunk/admin/models/Calendars.php?rev=3209851 "Show entry in browser")
  (modified)
  ([4 diffs](#file6 "Show differences"))
* [admin/models/Extras.php](/browser/booking-calendar/trunk/admin/models/Extras.php?rev=3209851 "Show entry in browser")
  (modified)
  ([3 diffs](#file7 "Show differences"))
* [admin/models/Forms.php](/browser/booking-calendar/trunk/admin/models/Forms.php?rev=3209851 "Show entry in browser")
  (modified)
  ([2 diffs](#file8 "Show differences"))
* [admin/models/GlobalSettings.php](/browser/booking-calendar/trunk/admin/models/GlobalSettings.php?rev=3209851 "Show entry in browser")
  (modified)
  ([1 diff](#file9 "Show differences"))
* [admin/models/Payment.php](/browser/booking-calendar/trunk/admin/models/Payment.php?rev=3209851 "Show entry in browser")
  (modified)
  ([3 diffs](#file10 "Show differences"))
* [admin/models/Reservations.php](/browser/booking-calendar/trunk/admin/models/Reservations.php?rev=3209851 "Show entry in browser")
  (modified)
  ([2 diffs](#file11 "Show differences"))
* [admin/models/Themes.php](/browser/booking-calendar/trunk/admin/models/Themes.php?rev=3209851 "Show entry in browser")
  (modified)
  ([2 diffs](#file12 "Show differences"))
* [admin/models/UserPermissions.php](/browser/booking-calendar/trunk/admin/models/UserPermissions.php?rev=3209851 "Show entry in browser")
  (modified)
  ([1 diff](#file13 "Show differences"))
* [admin/views/Calendars.php](/browser/booking-calendar/trunk/admin/views/Calendars.php?rev=3209851 "Show entry in browser")
  (modified)
  ([3 diffs](#file14 "Show differences"))
* [admin/views/Extras.php](/browser/booking-calendar/trunk/admin/views/Extras.php?rev=3209851 "Show entry in browser")
  (modified)
  ([4 diffs](#file15 "Show differences"))
* [admin/views/Forms.php](/browser/booking-calendar/trunk/admin/views/Forms.php?rev=3209851 "Show entry in browser")
  (modified)
  ([2 diffs](#file16 "Show differences"))
* [admin/views/GlobalSettings.php](/browser/booking-calendar/trunk/admin/views/GlobalSettings.php?rev=3209851 "Show entry in browser")
  (modified)
  ([2 diffs](#file17 "Show differences"))
* [admin/views/Reservations.php](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851 "Show entry in browser")
  (modified)
  ([26 diffs](#file18 "Show differences"))
* [admin/views/Themes.php](/browser/booking-calendar/trunk/admin/views/Themes.php?rev=3209851 "Show entry in browser")
  (modified)
  ([4 diffs](#file19 "Show differences"))
* [booking\_calendar.php](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851 "Show entry in browser")
  (modified)
  ([18 diffs](#file20 "Show differences"))
* [includes/booking\_class.php](/browser/booking-calendar/trunk/includes/booking_class.php?rev=3209851 "Show entry in browser")
  (modified)
  ([1 diff](#file21 "Show differences"))
* [includes/main\_class.php](/browser/booking-calendar/trunk/includes/main_class.php?rev=3209851 "Show entry in browser")
  (modified)
  ([2 diffs](#file22 "Show differences"))
* [readme.txt](/browser/booking-calendar/trunk/readme.txt?rev=3209851 "Show entry in browser")
  (modified)
  ([2 diffs](#file23 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [booking-calendar/trunk/admin/controllers/Calendars.php](/changeset/3209851/booking-calendar/trunk/admin/controllers/Calendars.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/controllers/Calendars.php")

  | [r2969905](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L3 "Show revision 2969905 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L3 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | private $model; |
  | 4 | 4 | private $view; |
  | 5 |  |  |
  |  | 5 |  |
  | 6 | 6 | public function \_\_construct() { |
  | 7 | 7 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Calendars.php"); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L9) | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L9) |  |
  | 9 | 9 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/views/Calendars.php"); |
  | 10 | 10 | $this->view = new wpdevart\_bc\_ViewCalendars($this->model); |
  | 11 |  | } |
  | 12 |  |  |
  |  | 11 | } |
  |  | 12 |  |
  | 13 | 13 | public function perform() { |
  | 14 | 14 | $task = wpdevart\_bc\_Library::get\_value('task'); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L16) | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L16) |  |
  | 16 | 16 | $action = wpdevart\_bc\_Library::get\_value('action'); |
  | 17 | 17 | if (method\_exists($this, $task)) { |
  | 18 |  | $this->$task($id); |
  | 19 |  | } |
  | 20 |  | else { |
  | 21 |  | $this->display\_calendars(); |
  | 22 |  | } |
  | 23 |  | } |
  | 24 |  |  |
  | 25 |  |  |
  | 26 |  | private function display\_calendars(){ |
  |  | 18 | $this->$task($id); |
  |  | 19 | } else { |
  |  | 20 | $this->display\_calendars(); |
  |  | 21 | } |
  |  | 22 | } |
  |  | 23 |  |
  |  | 24 |  |
  |  | 25 | private function display\_calendars() { |
  | 27 | 26 | $this->view->display\_calendars(); |
  | 28 | 27 | } |
  | 29 |  |  |
  | 30 |  | private function add(){ |
  |  | 28 |  |
  |  | 29 | private function add() { |
  | 31 | 30 | $this->view->edit\_calendars(); |
  | 32 | 31 | } |
  | 33 |  |  |
  | 34 |  | private function edit(~~$id, $current\_date = "" )~~{ |
  |  | 32 |  |
  |  | 33 | private function edit($id, $current\_date = "") { |
  | 35 | 34 | $current\_date = wpdevart\_bc\_Library::get\_value('current\_date'); |
  | 36 |  | $this->view->edit\_calendars(~~$id, $current\_date~~ ); |
  | 37 |  | } |
  | 38 |  |  |
  | 39 |  | private function save(~~$id )~~{ |
  | 40 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'save\_item' )~~ ) { |
  | 41 |  | die('Sorry, your nonce did not verify.'); |
  |  | 35 | $this->view->edit\_calendars($id, $current\_date); |
  |  | 36 | } |
  |  | 37 |  |
  |  | 38 | private function save($id) { |
  |  | 39 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'save\_item')) { |
  |  | 40 | die('Sorry, your nonce did not verify.'); |
  | 42 | 41 | } |
  | 43 | 42 | global $wpdb; |
  | 44 |  | $theme\_options = array(); |
  | 45 |  | $calendar\_days = $this->model->get\_db\_days(~~$id~~ ); |
  |  | 43 | $theme\_options = array(); |
  |  | 44 | $calendar\_days = $this->model->get\_db\_days($id); |
  | 46 | 45 | if ($id) { |
  | 47 |  | $ids = $this->model->get\_ids($id); |
  | 48 |  | $theme\_options = $this->model->get\_setting\_row($ids["theme\_id"]); |
  | 49 |  | } |
  |  | 46 | $ids = $this->model->get\_ids($id); |
  |  | 47 | $theme\_options = $this->model->get\_setting\_row($ids["theme\_id"]); |
  |  | 48 | } |
  | 50 | 49 | $start\_date = wpdevart\_bc\_Library::getData($\_POST, 'start\_date', 'text', ''); |
  | 51 | 50 | $end\_date = wpdevart\_bc\_Library::getData($\_POST, 'end\_date', 'text', ''); |
  | 52 | 51 | $current\_date = wpdevart\_bc\_Library::getData($\_POST, 'current\_date', 'text', ''); |
  | 53 |  |  |
  |  | 52 |  |
  | 54 | 53 | $hours\_enabled = ((isset($theme\_options['hours\_enabled']) && $theme\_options['hours\_enabled'] == 'on') ? 'on' : ''); |
  | 55 | 54 | $hours\_interval\_enabled = ((isset($theme\_options['hours\_interval\_enabled']) && $theme\_options['hours\_interval\_enabled'] == 'on') ? 'on' : ''); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L60) | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L59) |  |
  | 60 | 59 | $extra\_id = wpdevart\_bc\_Library::getData($\_POST, 'extra\_id', 'text', ''); |
  | 61 | 60 | $user = get\_current\_user\_id(); |
  | 62 |  |  |
  |  | 61 |  |
  | 63 | 62 | if ($id != 0) { |
  | 64 |  | $save = $wpdb->update($wpdb->prefix . 'wpdevart\_calendars', array( |
  |  | 63 | $save = $wpdb->update($wpdb->prefix . 'wpdevart\_calendars', array( |
  | 65 | 64 | 'title' => $title, |
  | 66 | 65 | 'hours\_enabled' => $hours\_enabled, |
  | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L69) | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L68) |  |
  | 69 | 68 | 'form\_id' => $form\_id, |
  | 70 | 69 | 'extra\_id' => $extra\_id |
  | 71 |  | ), array('id' => $id), array('%s', '%s', '%s', '%d', '%d', '%d')); |
  | 72 |  |  |
  | 73 |  | } |
  | 74 |  | else { |
  |  | 70 | ), array('id' => intval($id)), array('%s', '%s', '%s', '%d', '%d', '%d')); |
  |  | 71 | } else { |
  | 75 | 72 | $save = $wpdb->insert($wpdb->prefix . 'wpdevart\_calendars', array( |
  | 76 |  | 'user\_id' => $user, |
  | 77 |  | 'title' => $title, |
  | 78 |  | 'hours\_enabled' => $hours\_enabled, |
  | 79 |  | 'hours\_interval\_enabled' => $hours\_interval\_enabled, |
  | 80 |  | 'theme\_id' => $theme\_id, |
  | 81 |  | 'form\_id' => $form\_id, |
  | 82 |  | 'extra\_id' => $extra\_id |
  |  | 73 | 'user\_id' => $user, |
  |  | 74 | 'title' => $title, |
  |  | 75 | 'hours\_enabled' => $hours\_enabled, |
  |  | 76 | 'hours\_interval\_enabled' => $hours\_interval\_enabled, |
  |  | 77 | 'theme\_id' => $theme\_id, |
  |  | 78 | 'form\_id' => $form\_id, |
  |  | 79 | 'extra\_id' => $extra\_id |
  | 83 | 80 | ), array( |
  | 84 | 81 | '%d', |
  | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L92) | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L89) |  |
  | 92 | 89 | $id = $wpdb->get\_var('SELECT MAX(id) FROM ' . $wpdb->prefix . 'wpdevart\_calendars'); |
  | 93 | 90 | } |
  | 94 |  |  |
  | 95 |  | $date\_diff = abs($this->get\_date\_diff($start\_date,$end\_date)); |
  | 96 |  | if($date\_diff > 0) { |
  | 97 |  | for~~($i=~~0; $i <= $date\_diff; $i++) { |
  | 98 |  | $day = date(~~'Y-m-d', strtotime($start\_date. " +" . $i . " day"~~ )); |
  | 99 |  | $week\_name = strtolower(date(~~'l', strtotime($start\_date. " +" . $i . " day"~~ ))); |
  | 100 |  | $week\_day = date('w', strtotime($start\_date~~. " +" . $i . " day"~~ )); |
  |  | 91 |  |
  |  | 92 | $date\_diff = abs($this->get\_date\_diff($start\_date, $end\_date)); |
  |  | 93 | if ($date\_diff > 0) { |
  |  | 94 | for ($i = 0; $i <= $date\_diff; $i++) { |
  |  | 95 | $day = date('Y-m-d', strtotime($start\_date . " +" . $i . " day")); |
  |  | 96 | $week\_name = strtolower(date('l', strtotime($start\_date . " +" . $i . " day"))); |
  |  | 97 | $week\_day = date('w', strtotime($start\_date . " +" . $i . " day")); |
  | 101 | 98 |  |
  | 102 | 99 | /\*day info\*/ |
  | 103 |  | $day\_info = self::get\_info($\_POST, $hours\_enabled,$hours\_interval\_enabled, $week\_name); |
  |  | 100 | $day\_info = self::get\_info($\_POST, $hours\_enabled, $hours\_interval\_enabled, $week\_name); |
  | 104 | 101 | $day\_info\_jsone = $day\_info["day\_info\_jsone"]; |
  | 105 | 102 | $day\_av = $day\_info["day\_av"]; |
  | 106 | 103 | $number\_availability = $day\_info["number\_availability"]; |
  | 107 |  |  |
  |  | 104 |  |
  | 108 | 105 | /\*\*/ |
  | 109 |  |  |
  |  | 106 |  |
  | 110 | 107 | $exists = 0; |
  | 111 |  | foreach($calendar\_days as $calendar\_day) { |
  | 112 |  | if~~(in\_array($id . "\_" . $day,~~$calendar\_day)) { |
  |  | 108 | foreach ($calendar\_days as $calendar\_day) { |
  |  | 109 | if (in\_array($id . "\_" . $day, $calendar\_day)) { |
  | 113 | 110 | $exists = 1; |
  | 114 | 111 | break; |
  | 115 | 112 | } |
  | 116 | 113 | } |
  | 117 |  | if~~(!(isset($theme\_options['unavailable\_week\_days']) && in\_array($week\_day,~~$theme\_options['unavailable\_week\_days']))) { |
  | 118 |  | if($exists) { |
  | 119 |  | if(isset($\_POST['dalete\_data'])) { |
  | 120 |  | $wpdb->query( |
  | 121 |  | $wpdb->prepare(~~"DELETE FROM ".$wpdb->prefix . "wpdevart\_dates WHERE unique\_id = %s", $id . "\_" . $day~~ ) |
  |  | 114 | if (!(isset($theme\_options['unavailable\_week\_days']) && in\_array($week\_day, $theme\_options['unavailable\_week\_days']))) { |
  |  | 115 | if ($exists) { |
  |  | 116 | if (isset($\_POST['dalete\_data'])) { |
  |  | 117 | $wpdb->query( |
  |  | 118 | $wpdb->prepare("DELETE FROM " . $wpdb->prefix . "wpdevart\_dates WHERE unique\_id = %s", $id . "\_" . $day) |
  | 122 | 119 | ); |
  | 123 | 120 | } else { |
  | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L126) | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L123) |  |
  | 126 | 123 | 'day' => $day, |
  | 127 | 124 | 'data' => $day\_info\_jsone, |
  | 128 |  | ~~), array('unique\_id' => $id . "\_" . $day), array('%d', '%s', '%s'));~~ |
  |  | 125 | ), array('unique\_id' => $id . "\_" . $day), array('%d', '%s', '%s'), array('%s')); |
  | 129 | 126 | } |
  | 130 |  | } |
  | 131 |  | else { |
  | 132 |  | if(!($number\_availability == 0 || ($hours\_enabled == "on" && $day\_av == 0))) { |
  |  | 127 | } else { |
  |  | 128 | if (!($number\_availability == 0 || ($hours\_enabled == "on" && $day\_av == 0))) { |
  | 133 | 129 | $save\_in\_db = $wpdb->insert($wpdb->prefix . 'wpdevart\_dates', array( |
  | 134 |  | 'unique\_id' => $id . "\_" . $day, |
  | 135 |  | 'calendar\_id' => $id, |
  | 136 |  | 'day' => $day, |
  | 137 |  | 'data' => $day\_info\_jsone, |
  | 138 |  | ), array( |
  |  | 130 | 'unique\_id' => $id . "\_" . $day, |
  |  | 131 | 'calendar\_id' => $id, |
  |  | 132 | 'day' => $day, |
  |  | 133 | 'data' => $day\_info\_jsone, |
  |  | 134 | ), array( |
  | 139 | 135 | '%s', |
  | 140 | 136 | '%d', |
  | 141 | 137 | '%s', |
  | 142 | 138 | '%s', |
  | 143 |  | )); |
  |  | 139 | )); |
  | 144 | 140 | } |
  | 145 | 141 | } |
  | 146 | 142 | } |
  | 147 | 143 | } |
  | 148 |  | } elseif~~($date\_diff == 0 && $start\_date)~~{ |
  | 149 |  | $day = date('Y-m-d', strtotime($start\_date)); |
  | 150 |  | $week\_name = strtolower(date('l', strtotime($start\_date))); |
  |  | 144 | } elseif ($date\_diff == 0 && $start\_date) { |
  |  | 145 | $day = date('Y-m-d', strtotime($start\_date)); |
  |  | 146 | $week\_name = strtolower(date('l', strtotime($start\_date))); |
  | 151 | 147 | $week\_day = date('w', strtotime($start\_date)); |
  | 152 |  |  |
  | 153 |  |  |
  |  | 148 |  |
  |  | 149 |  |
  | 154 | 150 | /\*day info\*/ |
  | 155 |  | $day\_info = self::get\_info($\_POST, $hours\_enabled,$hours\_interval\_enabled, $week\_day); |
  |  | 151 | $day\_info = self::get\_info($\_POST, $hours\_enabled, $hours\_interval\_enabled, $week\_day); |
  | 156 | 152 | $day\_info\_jsone = $day\_info["day\_info\_jsone"]; |
  | 157 | 153 | $day\_av = $day\_info["day\_av"]; |
  | 158 | 154 | $number\_availability = $day\_info["number\_availability"]; |
  | 159 | 155 | /\*\*/ |
  | 160 |  |  |
  |  | 156 |  |
  | 161 | 157 | $exists = 0; |
  | 162 |  | foreach($calendar\_days as $calendar\_day) { |
  | 163 |  | if~~(in\_array($id . "\_" . $day,~~$calendar\_day)) { |
  |  | 158 | foreach ($calendar\_days as $calendar\_day) { |
  |  | 159 | if (in\_array($id . "\_" . $day, $calendar\_day)) { |
  | 164 | 160 | $exists = 1; |
  | 165 | 161 | break; |
  | 166 | 162 | } |
  | 167 | 163 | } |
  | 168 |  | if~~(!(isset($theme\_options['unavailable\_week\_days']) && in\_array($week\_day,~~$theme\_options['unavailable\_week\_days']))) { |
  | 169 |  | if($exists) { |
  | 170 |  | if~~(isset($\_POST['dalete\_data'])) {~~ |
  | 171 |  | $wpdb->query( |
  | 172 |  | $wpdb->prepare(~~"DELETE FROM ".$wpdb->prefix . "wpdevart\_dates WHERE unique\_id = %s", $id . "\_" . $day~~ ) |
  |  | 164 | if (!(isset($theme\_options['unavailable\_week\_days']) && in\_array($week\_day, $theme\_options['unavailable\_week\_days']))) { |
  |  | 165 | if ($exists) { |
  |  | 166 | if (isset($\_POST['dalete\_data'])) { |
  |  | 167 | $wpdb->query( |
  |  | 168 | $wpdb->prepare("DELETE FROM " . $wpdb->prefix . "wpdevart\_dates WHERE unique\_id = %s", $id . "\_" . $day) |
  | 173 | 169 | ); |
  | 174 | 170 | } else { |
  | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L177) | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L173) |  |
  | 177 | 173 | 'day' => $day, |
  | 178 | 174 | 'data' => $day\_info\_jsone, |
  | 179 |  | ), array('unique\_id' => $id . "\_" . $day), array('%d', '%s', '%s')); |
  | 180 |  | } |
  | 181 |  | } |
  | 182 |  | else { |
  | 183 |  | if(!($number\_availability == 0 || ($hours\_enabled == "on" && $day\_av == 0))) { |
  |  | 175 | ), array('unique\_id' => $id . "\_" . $day), array('%d', '%s', '%s')); |
  |  | 176 | } |
  |  | 177 | } else { |
  |  | 178 | if (!($number\_availability == 0 || ($hours\_enabled == "on" && $day\_av == 0))) { |
  | 184 | 179 | $save\_in\_db = $wpdb->insert($wpdb->prefix . 'wpdevart\_dates', array( |
  | 185 |  | 'unique\_id' => $id . "\_" . $day, |
  | 186 |  | 'calendar\_id' => $id, |
  | 187 |  | 'day' => $day, |
  | 188 |  | 'data' => $day\_info\_jsone, |
  | 189 |  | ), array( |
  |  | 180 | 'unique\_id' => $id . "\_" . $day, |
  |  | 181 | 'calendar\_id' => $id, |
  |  | 182 | 'day' => $day, |
  |  | 183 | 'data' => $day\_info\_jsone, |
  |  | 184 | ), array( |
  | 190 | 185 | '%s', |
  | 191 | 186 | '%d', |
  | 192 | 187 | '%s', |
  | 193 | 188 | '%s', |
  | 194 |  | )); |
  | 195 |  | } |
  | 196 |  | } |
  | 197 |  | } |
  | 198 |  | } |
  | 199 |  | if(isset($\_POST["save"])) { |
  |  | 189 | )); |
  |  | 190 | } |
  |  | 191 | } |
  |  | 192 | } |
  |  | 193 | } |
  |  | 194 | if (isset($\_POST["save"])) { |
  | 200 | 195 | $this->display\_calendars(); |
  | 201 |  | } |
  | 202 |  | else { |
  | 203 |  | wpdevart\_bc\_Library::redirect( add\_query\_arg(array( |
  | 204 |  | 'page' => 'wpdevart-calendars', |
  | 205 |  | 'task' => 'edit', |
  | 206 |  | 'current\_date' => $current\_date, |
  | 207 |  | 'id' => $id |
  | 208 |  | ), admin\_url('admin.php')) ); |
  | 209 |  | } |
  | 210 |  | } |
  | 211 |  |  |
  | 212 |  | private static function get\_info($data, $hours\_enabled,$hours\_interval\_enabled, $week\_day){ |
  |  | 196 | } else { |
  |  | 197 | wpdevart\_bc\_Library::redirect(add\_query\_arg(array( |
  |  | 198 | 'page' => 'wpdevart-calendars', |
  |  | 199 | 'task' => 'edit', |
  |  | 200 | 'current\_date' => $current\_date, |
  |  | 201 | 'id' => $id |
  |  | 202 | ), admin\_url('admin.php'))); |
  |  | 203 | } |
  |  | 204 | } |
  |  | 205 |  |
  |  | 206 | private static function get\_info($data, $hours\_enabled, $hours\_interval\_enabled, $week\_day) { |
  | 213 | 207 | $type = wpdevart\_bc\_Library::getData($data, 'selection\_type', 'text', 'overall'); |
  | 214 | 208 | $day = ($type == 'overall' ? "" : "\_" . $week\_day); |
  | 215 |  |  |
  |  | 209 |  |
  | 216 | 210 | $days\_availability = wpdevart\_bc\_Library::getData($data, 'days\_availability' . $day, 'text', 'overall'); |
  | 217 | 211 | $number\_availability = isset($data['number\_availability' . $day]) ? wpdevart\_bc\_Library::getData($data, 'number\_availability' . $day, 'text', 1, ($data['number\_availability' . $day] != "")) : 1; |
  | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L222) | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L216) |  |
  | 222 | 216 | $hours = ((isset($data['day\_hours' . $day])) ? $data['day\_hours' . $day] : array()); |
  | 223 | 217 | $hours\_info = array(); |
  | 224 |  | $day\_av = 0; |
  | 225 |  | if(isset($hours['hour\_value']) && count($hours['hour\_value'])) { |
  | 226 |  | for~~($i=0; $i<~~count($hours['hour\_value']); $i++) { |
  | 227 |  | if($hours['hours\_number\_availability'][$i] == "") { |
  |  | 218 | $day\_av = 0; |
  |  | 219 | if (isset($hours['hour\_value']) && count($hours['hour\_value'])) { |
  |  | 220 | for ($i = 0; $i < count($hours['hour\_value']); $i++) { |
  |  | 221 | if ($hours['hours\_number\_availability'][$i] == "") { |
  | 228 | 222 | $hours['hours\_number\_availability'][$i] = 1; |
  | 229 | 223 | } |
  | 230 | 224 | $hours\_info[$hours['hour\_value'][$i]] = array("status" => $hours['hours\_availability'][$i], "available" => $hours['hours\_number\_availability'][$i], "info\_users" => $hours['hour\_info'][$i], "price" => $hours['hour\_price'][$i], "marked\_price" => $hours['hours\_marked\_price'][$i]); |
  | 231 |  | if($hours['hours\_availability'][$i] == "available") { |
  |  | 225 | if ($hours['hours\_availability'][$i] == "available") { |
  | 232 | 226 | $day\_av += $hours['hours\_number\_availability'][$i]; |
  | 233 | 227 | } |
  | 234 | 228 | } |
  | 235 |  | } |
  | 236 |  |  |
  | 237 |  | if($hours\_enabled == "on") { |
  | 238 |  | $day\_info = array("status" => $days\_availability, "available" => $day\_av, "info\_users" => $info\_users, "info\_admin" => $info\_admin, "price" => "hours\_price", "marked\_price" => "hours\_marked\_price", "hours\_enabled" => "on",  "hours\_interval\_enabled" => $hours\_interval\_enabled, "hours" => $hours\_info); |
  | 239 |  | } else { |
  | 240 |  | $day\_info = array(~~"status" => $days\_availability, "available" => $number\_availability, "info\_users" => $info\_users, "info\_admin" => $info\_admin, "price" => $price, "marked\_price" => $marked\_price~~ ); |
  |  | 229 | } |
  |  | 230 |  |
  |  | 231 | if ($hours\_enabled == "on") { |
  |  | 232 | $day\_info = array("status" => $days\_availability, "available" => $day\_av, "info\_users" => $info\_users, "info\_admin" => $info\_admin, "price" => "hours\_price", "marked\_price" => "hours\_marked\_price", "hours\_enabled" => "on",  "hours\_interval\_enabled" => $hours\_interval\_enabled, "hours" => $hours\_info); |
  |  | 233 | } else { |
  |  | 234 | $day\_info = array("status" => $days\_availability, "available" => $number\_availability, "info\_users" => $info\_users, "info\_admin" => $info\_admin, "price" => $price, "marked\_price" => $marked\_price); |
  | 241 | 235 | } |
  | 242 | 236 | $day\_info\_jsone = json\_encode($day\_info); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L248) | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L242) |  |
  | 248 | 242 | ); |
  | 249 | 243 | } |
  | 250 |  |  |
  | 251 |  | private function get\_date\_diff($date1, $date2) { |
  |  | 244 |  |
  |  | 245 | private function get\_date\_diff($date1, $date2) { |
  | 252 | 246 | $start = strtotime($date1); |
  | 253 | 247 | $end = strtotime($date2); |
  | 254 | 248 | $datediff = $start - $end; |
  | 255 |  | return floor($datediff~~/(60\*60\*~~24)); |
  | 256 |  | } |
  | 257 |  |  |
  | 258 |  | private function delete(~~$id )~~{ |
  | 259 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item' )~~ ) { |
  | 260 |  | die('Sorry, your nonce did not verify.'); |
  | 261 |  | } |
  | 262 |  | global $wpdb; |
  | 263 |  | $query = $wpdb->prepare(~~'DELETE FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"',$id~~ ); |
  |  | 249 | return floor($datediff / (60 \* 60 \* 24)); |
  |  | 250 | } |
  |  | 251 |  |
  |  | 252 | private function delete($id) { |
  |  | 253 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item')) { |
  |  | 254 | die('Sorry, your nonce did not verify.'); |
  |  | 255 | } |
  |  | 256 | global $wpdb; |
  |  | 257 | $query = $wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $id); |
  | 264 | 258 | $wpdb->query($query); |
  | 265 | 259 | $this->display\_calendars(); |
  | 266 | 260 | } |
  | 267 |  |  |
  | 268 |  | private function delete\_selected(){ |
  | 269 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item' )~~ ) { |
  | 270 |  | die('Sorry, your nonce did not verify.'); |
  | 271 |  | } |
  | 272 |  | global $wpdb; |
  | 273 |  | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  | 274 |  | foreach~~($check\_for\_action as $check)~~{ |
  | 275 |  | $query = $wpdb->prepare(~~'DELETE FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"',$check~~ ); |
  |  | 261 |  |
  |  | 262 | private function delete\_selected() { |
  |  | 263 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item')) { |
  |  | 264 | die('Sorry, your nonce did not verify.'); |
  |  | 265 | } |
  |  | 266 | global $wpdb; |
  |  | 267 | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  |  | 268 | foreach ($check\_for\_action as $check) { |
  |  | 269 | $query = $wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $check); |
  | 276 | 270 | $wpdb->query($query); |
  | 277 | 271 | } |
  | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=2969905#L279) | […](/browser/booking-calendar/trunk/admin/controllers/Calendars.php?rev=3209851#L273) |  |
  | 279 | 273 | } |
  | 280 | 274 | } |
  | 281 |  |  |
  | 282 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/controllers/Extras.php](/changeset/3209851/booking-calendar/trunk/admin/controllers/Extras.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/controllers/Extras.php")

  | [r2948454](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=2948454#L1 "Show revision 2948454 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ControllerExtras { |
  | 3 |  | private $model; |
  | 4 |  | private $view; |
  | 5 |  |  |
  |  | 3 | private $model; |
  |  | 4 | private $view; |
  |  | 5 |  |
  | 6 | 6 | public function \_\_construct() { |
  | 7 | 7 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Extras.php"); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=2948454#L9) | […](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=3209851#L9) |  |
  | 9 | 9 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/views/Extras.php"); |
  | 10 | 10 | $this->view = new wpdevart\_bc\_ViewExtras($this->model); |
  | 11 |  | } |
  | 12 |  |  |
  |  | 11 | } |
  |  | 12 |  |
  | 13 | 13 | public function perform() { |
  | 14 | 14 | $task = wpdevart\_bc\_Library::get\_value('task'); |
  | 15 | 15 | $id = wpdevart\_bc\_Library::get\_value('id', 0); |
  | 16 | 16 | if (method\_exists($this, $task)) { |
  | 17 |  | $this->$task($id); |
  | 18 |  | } |
  | 19 |  | else { |
  | 20 |  | $this->display\_extras(); |
  |  | 17 | $this->$task($id); |
  |  | 18 | } else { |
  |  | 19 | $this->display\_extras(); |
  | 21 | 20 | } |
  | 22 | 21 | } |
  | 23 |  |  |
  | 24 |  | private function display\_extras($error\_msg~~="",$delete=true)~~{ |
  | 25 |  | $this->view->display\_extras($error\_msg,$delete); |
  | 26 |  | } |
  | 27 |  |  |
  | 28 |  | private function add(){ |
  |  | 22 |  |
  |  | 23 | private function display\_extras($error\_msg = "", $delete = true) { |
  |  | 24 | $this->view->display\_extras($error\_msg, $delete); |
  |  | 25 | } |
  |  | 26 |  |
  |  | 27 | private function add() { |
  | 29 | 28 | $this->view->edit\_extra(); |
  | 30 | 29 | } |
  | 31 |  |  |
  | 32 |  | private function edit(~~$id )~~{ |
  | 33 |  | $this->view->edit\_extra(~~$id~~ ); |
  |  | 30 |  |
  |  | 31 | private function edit($id) { |
  |  | 32 | $this->view->edit\_extra($id); |
  | 34 | 33 | } |
  | 35 |  |  |
  | 36 |  | private function save(~~$id )~~{ |
  | 37 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'save\_item' )~~ ) { |
  | 38 |  | die('Sorry, your nonce did not verify.'); |
  |  | 34 |  |
  |  | 35 | private function save($id) { |
  |  | 36 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'save\_item')) { |
  |  | 37 | die('Sorry, your nonce did not verify.'); |
  | 39 | 38 | } |
  | 40 | 39 | global $wpdb; |
  | […](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=2948454#L44) | […](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=3209851#L43) |  |
  | 44 | 43 | $title = wpdevart\_bc\_Library::getData($\_POST, 'title', 'text', ''); |
  | 45 | 44 | if ($id != 0) { |
  | 46 |  | $save = $wpdb->update($wpdb->prefix . 'wpdevart\_extras', array( |
  | 47 |  | 'title' => $title, |
  | 48 |  | 'data' => $data\_json, |
  | 49 |  | ), array('id' => $id), array('%s', '%s')); |
  |  | 45 | $save = $wpdb->update($wpdb->prefix . 'wpdevart\_extras', array( |
  |  | 46 | 'title' => $title, |
  |  | 47 | 'data' => $data\_json, |
  |  | 48 | ), array('id' => $id), array('%s', '%s')); |
  |  | 49 | } else { |
  |  | 50 | $save = $wpdb->insert($wpdb->prefix . 'wpdevart\_extras', array( |
  |  | 51 | 'title' => $title, |
  |  | 52 | 'data' => $data\_json, |
  |  | 53 | 'user\_id' => $user, |
  |  | 54 | ), array( |
  |  | 55 | '%s', |
  |  | 56 | '%s', |
  |  | 57 | '%d', |
  |  | 58 | )); |
  |  | 59 | $id = $wpdb->get\_var('SELECT MAX(id) FROM ' . $wpdb->prefix . 'wpdevart\_extras'); |
  | 50 | 60 | } |
  | 51 |  | else { |
  | 52 |  | $save = $wpdb->insert($wpdb->prefix . 'wpdevart\_extras', array( |
  | 53 |  | 'title' => $title, |
  | 54 |  | 'data' => $data\_json, |
  | 55 |  | 'user\_id' => $user, |
  | 56 |  | ), array( |
  | 57 |  | '%s', |
  | 58 |  | '%s', |
  | 59 |  | '%d', |
  | 60 |  | )); |
  | 61 |  | $id = $wpdb->get\_var('SELECT MAX(id) FROM ' . $wpdb->prefix . 'wpdevart\_extras'); |
  | 62 |  | } |
  | 63 |  | if(isset($\_POST["save"])) { |
  |  | 61 | if (isset($\_POST["save"])) { |
  | 64 | 62 | $this->display\_extras(); |
  | 65 |  | } |
  | 66 |  | else { |
  | 67 |  | wpdevart\_bc\_Library::redirect( add\_query\_arg(array( |
  | 68 |  | 'page' => 'wpdevart-extras', |
  | 69 |  | 'task' => 'edit', |
  | 70 |  | 'id' => $id |
  | 71 |  | ), admin\_url('admin.php')) ); |
  |  | 63 | } else { |
  |  | 64 | wpdevart\_bc\_Library::redirect(add\_query\_arg(array( |
  |  | 65 | 'page' => 'wpdevart-extras', |
  |  | 66 | 'task' => 'edit', |
  |  | 67 | 'id' => intval($id) |
  |  | 68 | ), admin\_url('admin.php'))); |
  | 72 | 69 | } |
  | 73 | 70 | } |
  | 74 |  |  |
  | 75 |  | private function duplicate(~~$id )~~{ |
  | 76 |  | if (~~! isset( $\_GET['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_GET['\_wpdevart\_bc\_nonce'], 'duplicate\_item' )~~ ) { |
  | 77 |  | die('Sorry, your nonce did not verify.'); |
  |  | 71 |  |
  |  | 72 | private function duplicate($id) { |
  |  | 73 | if (! isset($\_GET['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_GET['\_wpdevart\_bc\_nonce'], 'duplicate\_item')) { |
  |  | 74 | die('Sorry, your nonce did not verify.'); |
  | 78 | 75 | } |
  | 79 |  | global $wpdb; |
  | 80 |  | $theme = $this->model->get\_extra\_rows(~~$id~~ ); |
  | 81 |  | if~~($theme)~~{ |
  |  | 76 | global $wpdb; |
  |  | 77 | $theme = $this->model->get\_extra\_rows($id); |
  |  | 78 | if ($theme) { |
  | 82 | 79 | $title = $theme->title . ' - Copy'; |
  | 83 | 80 | $data\_json = $theme->data; |
  | 84 | 81 | $user = $theme->user\_id; |
  | 85 | 82 | $save = $wpdb->insert($wpdb->prefix . 'wpdevart\_extras', array( |
  | 86 |  | 'title' => $title, |
  | 87 |  | 'data' => $data\_json, |
  | 88 |  | 'user\_id' => $user, |
  |  | 83 | 'title' => $title, |
  |  | 84 | 'data' => $data\_json, |
  |  | 85 | 'user\_id' => $user, |
  | 89 | 86 | ), array( |
  | 90 | 87 | '%s', |
  | […](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=2948454#L95) | […](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=3209851#L92) |  |
  | 95 | 92 | $this->display\_extras(); |
  | 96 | 93 | } |
  | 97 |  |  |
  | 98 |  | private function delete(~~$id )~~{ |
  | 99 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item' )~~ ) { |
  | 100 |  | die('Sorry, your nonce did not verify.'); |
  |  | 94 |  |
  |  | 95 | private function delete($id) { |
  |  | 96 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item')) { |
  |  | 97 | die('Sorry, your nonce did not verify.'); |
  | 101 | 98 | } |
  | 102 |  | global $wpdb; |
  |  | 99 | global $wpdb; |
  | 103 | 100 | $error\_msg = ""; |
  | 104 | 101 | $delete = true; |
  | 105 |  | $exists = $this->model->check\_exists(~~$id~~ ); |
  | 106 |  | if($exists === false) { |
  | 107 |  | $del\_query = $wpdb->query($wpdb->prepare(~~'DELETE FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"',$id~~ )); |
  | 108 |  | if($del\_query) { |
  |  | 102 | $exists = $this->model->check\_exists($id); |
  |  | 103 | if ($exists === false) { |
  |  | 104 | $del\_query = $wpdb->query($wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"', $id)); |
  |  | 105 | if ($del\_query) { |
  | 109 | 106 | $error\_msg = "Item succesfully deleted."; |
  | 110 | 107 | } |
  | […](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=2948454#L113) | […](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=3209851#L110) |  |
  | 113 | 110 | $delete = false; |
  | 114 | 111 | } |
  | 115 |  | $this->display\_extras($error\_msg,$delete); |
  |  | 112 | $this->display\_extras($error\_msg, $delete); |
  | 116 | 113 | } |
  | 117 |  |  |
  | 118 |  | private function delete\_selected(){ |
  | 119 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item' )~~ ) { |
  | 120 |  | die('Sorry, your nonce did not verify.'); |
  |  | 114 |  |
  |  | 115 | private function delete\_selected() { |
  |  | 116 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item')) { |
  |  | 117 | die('Sorry, your nonce did not verify.'); |
  | 121 | 118 | } |
  | 122 |  | global $wpdb; |
  |  | 119 | global $wpdb; |
  | 123 | 120 | $error\_msg = ""; |
  | 124 | 121 | $delete = true; |
  | 125 |  | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  | 126 |  | foreach~~($check\_for\_action as $check)~~{ |
  | 127 |  | $exists = $this->model->check\_exists(~~$check~~ ); |
  | 128 |  | if($exists === false) { |
  | 129 |  | $del\_query = $wpdb->query($wpdb->prepare(~~'DELETE FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"',$check~~ )); |
  | 130 |  | if($del\_query) { |
  |  | 122 | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  |  | 123 | foreach ($check\_for\_action as $check) { |
  |  | 124 | $exists = $this->model->check\_exists($check); |
  |  | 125 | if ($exists === false) { |
  |  | 126 | $del\_query = $wpdb->query($wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"', $check)); |
  |  | 127 | if ($del\_query) { |
  | 131 | 128 | $error\_msg = "Items succesfully deleted."; |
  | 132 | 129 | } |
  | […](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=2948454#L136) | […](/browser/booking-calendar/trunk/admin/controllers/Extras.php?rev=3209851#L133) |  |
  | 136 | 133 | } |
  | 137 | 134 | } |
  | 138 |  | $this->display\_extras($error\_msg,$delete); |
  |  | 135 | $this->display\_extras($error\_msg, $delete); |
  | 139 | 136 | } |
  | 140 |  |  |
  | 141 |  |  |
  | 142 |  |  |
  | 143 | 137 | } |
  | 144 |  |  |
  | 145 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/controllers/Forms.php](/changeset/3209851/booking-calendar/trunk/admin/controllers/Forms.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/controllers/Forms.php")

  | [r2948454](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=2948454#L1 "Show revision 2948454 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ControllerForms { |
  | 3 |  | private $model; |
  | 4 |  | private $view; |
  | 5 |  |  |
  |  | 3 | private $model; |
  |  | 4 | private $view; |
  |  | 5 |  |
  | 6 | 6 | public function \_\_construct() { |
  | 7 | 7 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Forms.php"); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=2948454#L9) | […](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=3209851#L9) |  |
  | 9 | 9 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/views/Forms.php"); |
  | 10 | 10 | $this->view = new wpdevart\_bc\_ViewForms($this->model); |
  | 11 |  | } |
  | 12 |  |  |
  |  | 11 | } |
  |  | 12 |  |
  | 13 | 13 | public function perform() { |
  | 14 | 14 | $task = wpdevart\_bc\_Library::get\_value('task'); |
  | 15 | 15 | $id = wpdevart\_bc\_Library::get\_value('id', 0); |
  | 16 | 16 | if (method\_exists($this, $task)) { |
  | 17 |  | $this->$task($id); |
  | 18 |  | } |
  | 19 |  | else { |
  | 20 |  | $this->display\_forms(); |
  |  | 17 | $this->$task($id); |
  |  | 18 | } else { |
  |  | 19 | $this->display\_forms(); |
  | 21 | 20 | } |
  | 22 | 21 | } |
  | 23 |  |  |
  | 24 |  | private function display\_forms($error\_msg~~="",$delete=true)~~{ |
  | 25 |  | $this->view->display\_forms($error\_msg,$delete); |
  | 26 |  | } |
  | 27 |  |  |
  | 28 |  | private function add(){ |
  |  | 22 |  |
  |  | 23 | private function display\_forms($error\_msg = "", $delete = true) { |
  |  | 24 | $this->view->display\_forms($error\_msg, $delete); |
  |  | 25 | } |
  |  | 26 |  |
  |  | 27 | private function add() { |
  | 29 | 28 | $this->view->edit\_form(); |
  | 30 | 29 | } |
  | 31 |  |  |
  | 32 |  | private function edit(~~$id )~~{ |
  | 33 |  | $this->view->edit\_form(~~$id~~ ); |
  |  | 30 |  |
  |  | 31 | private function edit($id) { |
  |  | 32 | $this->view->edit\_form($id); |
  | 34 | 33 | } |
  | 35 |  |  |
  | 36 |  | private function save(~~$id )~~{ |
  | 37 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'save\_item' )~~ ) { |
  | 38 |  | die('Sorry, your nonce did not verify.'); |
  |  | 34 |  |
  |  | 35 | private function save($id) { |
  |  | 36 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'save\_item')) { |
  |  | 37 | die('Sorry, your nonce did not verify.'); |
  | 39 | 38 | } |
  | 40 | 39 | global $wpdb; |
  | 41 | 40 | $textareas = array(); |
  | 42 |  | foreach~~(array\_slice($\_POST, 1, -4) as $key => $value)~~{ |
  | 43 |  | if~~(isset($value["type"]) && $value["type"] == "select")~~{ |
  |  | 41 | foreach (array\_slice($\_POST, 1, -4) as $key => $value) { |
  |  | 42 | if (isset($value["type"]) && $value["type"] == "select") { |
  | 44 | 43 | $textareas[] = $key; |
  | 45 | 44 | } |
  | 46 | 45 | } |
  | 47 |  | $saved\_parametrs = wpdevart\_bc\_Library::sanitizeAllPost(array\_slice($\_POST, 1, -4),$textareas); |
  |  | 46 | $saved\_parametrs = wpdevart\_bc\_Library::sanitizeAllPost(array\_slice($\_POST, 1, -4), $textareas); |
  | 48 | 47 | $data\_json = json\_encode($saved\_parametrs); |
  | 49 | 48 | $title = wpdevart\_bc\_Library::getData($\_POST, 'title', 'text', ''); |
  | 50 | 49 | $user = get\_current\_user\_id(); |
  | 51 | 50 | if ($id != 0) { |
  | 52 |  | $save = $wpdb->update($wpdb->prefix . 'wpdevart\_forms', array( |
  | 53 |  | 'title' => $title, |
  | 54 |  | 'data' => $data\_json, |
  | 55 |  | ), array('id' => $id), array('%s', '%s')); |
  |  | 51 | $save = $wpdb->update($wpdb->prefix . 'wpdevart\_forms', array( |
  |  | 52 | 'title' => $title, |
  |  | 53 | 'data' => $data\_json, |
  |  | 54 | ), array('id' => $id), array('%s', '%s')); |
  |  | 55 | } else { |
  |  | 56 | $save = $wpdb->insert($wpdb->prefix . 'wpdevart\_forms', array( |
  |  | 57 | 'title' => $title, |
  |  | 58 | 'data' => $data\_json, |
  |  | 59 | 'user\_id' => $user, |
  |  | 60 | ), array( |
  |  | 61 | '%s', |
  |  | 62 | '%s', |
  |  | 63 | '%d', |
  |  | 64 | )); |
  |  | 65 | $id = $wpdb->get\_var('SELECT MAX(id) FROM ' . $wpdb->prefix . 'wpdevart\_forms'); |
  | 56 | 66 | } |
  | 57 |  | else { |
  | 58 |  | $save = $wpdb->insert($wpdb->prefix . 'wpdevart\_forms', array( |
  | 59 |  | 'title' => $title, |
  | 60 |  | 'data' => $data\_json, |
  | 61 |  | 'user\_id' => $user, |
  | 62 |  | ), array( |
  | 63 |  | '%s', |
  | 64 |  | '%s', |
  | 65 |  | '%d', |
  | 66 |  | )); |
  | 67 |  | $id = $wpdb->get\_var('SELECT MAX(id) FROM ' . $wpdb->prefix . 'wpdevart\_forms'); |
  | 68 |  | } |
  | 69 |  | if(isset($\_POST["save"])) { |
  |  | 67 | if (isset($\_POST["save"])) { |
  | 70 | 68 | $this->display\_forms(); |
  | 71 |  | } |
  | 72 |  | else { |
  | 73 |  | wpdevart\_bc\_Library::redirect( add\_query\_arg(array( |
  | 74 |  | 'page' => 'wpdevart-forms', |
  | 75 |  | 'task' => 'edit', |
  | 76 |  | 'id' => $id |
  | 77 |  | ), admin\_url('admin.php')) ); |
  |  | 69 | } else { |
  |  | 70 | wpdevart\_bc\_Library::redirect(add\_query\_arg(array( |
  |  | 71 | 'page' => 'wpdevart-forms', |
  |  | 72 | 'task' => 'edit', |
  |  | 73 | 'id' => intval($id) |
  |  | 74 | ), admin\_url('admin.php'))); |
  | 78 | 75 | } |
  | 79 | 76 | } |
  | 80 |  |  |
  | 81 |  | private function duplicate(~~$id )~~{ |
  | 82 |  | if (~~! isset( $\_GET['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_GET['\_wpdevart\_bc\_nonce'], 'duplicate\_item' )~~ ) { |
  | 83 |  | die('Sorry, your nonce did not verify.'); |
  |  | 77 |  |
  |  | 78 | private function duplicate($id) { |
  |  | 79 | if (! isset($\_GET['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_GET['\_wpdevart\_bc\_nonce'], 'duplicate\_item')) { |
  |  | 80 | die('Sorry, your nonce did not verify.'); |
  | 84 | 81 | } |
  | 85 |  | global $wpdb; |
  | 86 |  | $theme = $this->model->get\_form\_rows(~~$id~~ ); |
  | 87 |  | if~~($theme)~~{ |
  |  | 82 | global $wpdb; |
  |  | 83 | $theme = $this->model->get\_form\_rows($id); |
  |  | 84 | if ($theme) { |
  | 88 | 85 | $title = $theme->title . ' - Copy'; |
  | 89 | 86 | $data\_json = $theme->data; |
  | 90 | 87 | $user = $theme->user\_id; |
  | 91 | 88 | $save = $wpdb->insert($wpdb->prefix . 'wpdevart\_forms', array( |
  | 92 |  | 'title' => $title, |
  | 93 |  | 'data' => $data\_json, |
  | 94 |  | 'user\_id' => $user, |
  |  | 89 | 'title' => $title, |
  |  | 90 | 'data' => $data\_json, |
  |  | 91 | 'user\_id' => $user, |
  | 95 | 92 | ), array( |
  | 96 | 93 | '%s', |
  | […](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=2948454#L101) | […](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=3209851#L98) |  |
  | 101 | 98 | $this->display\_forms(); |
  | 102 | 99 | } |
  | 103 |  |  |
  | 104 |  | private function delete(~~$id )~~{ |
  | 105 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item' )~~ ) { |
  | 106 |  | die('Sorry, your nonce did not verify.'); |
  |  | 100 |  |
  |  | 101 | private function delete($id) { |
  |  | 102 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item')) { |
  |  | 103 | die('Sorry, your nonce did not verify.'); |
  | 107 | 104 | } |
  | 108 |  | global $wpdb; |
  |  | 105 | global $wpdb; |
  | 109 | 106 | $error\_msg = ""; |
  | 110 | 107 | $delete = true; |
  | 111 |  | $exists = $this->model->check\_exists(~~$id~~ ); |
  | 112 |  | if($exists === false) { |
  | 113 |  | $del\_query = $wpdb->query($wpdb->prepare(~~'DELETE FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"',$id~~ )); |
  | 114 |  | if($del\_query) { |
  |  | 108 | $exists = $this->model->check\_exists($id); |
  |  | 109 | if ($exists === false) { |
  |  | 110 | $del\_query = $wpdb->query($wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $id)); |
  |  | 111 | if ($del\_query) { |
  | 115 | 112 | $error\_msg = "Item succesfully deleted."; |
  | 116 | 113 | } |
  | […](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=2948454#L119) | […](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=3209851#L116) |  |
  | 119 | 116 | $delete = false; |
  | 120 | 117 | } |
  | 121 |  | $this->display\_forms($error\_msg,$delete); |
  |  | 118 | $this->display\_forms($error\_msg, $delete); |
  | 122 | 119 | } |
  | 123 |  |  |
  | 124 |  | private function delete\_selected(){ |
  | 125 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item' )~~ ) { |
  | 126 |  | die('Sorry, your nonce did not verify.'); |
  |  | 120 |  |
  |  | 121 | private function delete\_selected() { |
  |  | 122 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'delete\_item')) { |
  |  | 123 | die('Sorry, your nonce did not verify.'); |
  | 127 | 124 | } |
  | 128 |  | global $wpdb; |
  |  | 125 | global $wpdb; |
  | 129 | 126 | $error\_msg = ""; |
  | 130 | 127 | $delete = true; |
  | 131 |  | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  | 132 |  | foreach~~($check\_for\_action as $check)~~{ |
  | 133 |  | $exists = $this->model->check\_exists(~~$check~~ ); |
  | 134 |  | if($exists === false) { |
  | 135 |  | $del\_query = $wpdb->query($wpdb->prepare(~~'DELETE FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"',$check~~ )); |
  | 136 |  | if($del\_query) { |
  |  | 128 | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  |  | 129 | foreach ($check\_for\_action as $check) { |
  |  | 130 | $exists = $this->model->check\_exists($check); |
  |  | 131 | if ($exists === false) { |
  |  | 132 | $del\_query = $wpdb->query($wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $check)); |
  |  | 133 | if ($del\_query) { |
  | 137 | 134 | $error\_msg = "Items succesfully deleted."; |
  | 138 | 135 | } |
  | […](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=2948454#L142) | […](/browser/booking-calendar/trunk/admin/controllers/Forms.php?rev=3209851#L139) |  |
  | 142 | 139 | } |
  | 143 | 140 | } |
  | 144 |  | $this->display\_forms($error\_msg,$delete); |
  |  | 141 | $this->display\_forms($error\_msg, $delete); |
  | 145 | 142 | } |
  | 146 |  |  |
  | 147 |  |  |
  | 148 |  |  |
  | 149 | 143 | } |
  | 150 |  |  |
  | 151 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/controllers/GlobalSettings.php](/changeset/3209851/booking-calendar/trunk/admin/controllers/GlobalSettings.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/controllers/GlobalSettings.php")

  | [r2848690](/browser/booking-calendar/trunk/admin/controllers/GlobalSettings.php?rev=2848690#L1 "Show revision 2848690 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/controllers/GlobalSettings.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ControllerGlobalsettings { |
  | 3 |  | private $model; |
  | 4 |  | private $view; |
  | 5 |  |  |
  |  | 3 | private $model; |
  |  | 4 | private $view; |
  |  | 5 |  |
  | 6 | 6 | public function \_\_construct() { |
  | 7 | 7 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/GlobalSettings.php"); |
  | […](/browser/booking-calendar/trunk/admin/controllers/GlobalSettings.php?rev=2848690#L9) | […](/browser/booking-calendar/trunk/admin/controllers/GlobalSettings.php?rev=3209851#L9) |  |
  | 9 | 9 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/views/GlobalSettings.php"); |
  | 10 | 10 | $this->view = new wpdevart\_bc\_ViewGlobalsettings($this->model); |
  | 11 |  | } |
  | 12 |  |  |
  |  | 11 | } |
  |  | 12 |  |
  | 13 | 13 | public function perform() { |
  | 14 | 14 | $task = wpdevart\_bc\_Library::get\_value('task'); |
  | 15 | 15 | if (method\_exists($this, $task)) { |
  | 16 |  | $this->$task(); |
  | 17 |  | } |
  | 18 |  | else { |
  | 19 |  | $this->display\_setting(); |
  |  | 16 | $this->$task(); |
  |  | 17 | } else { |
  |  | 18 | $this->display\_setting(); |
  | 20 | 19 | } |
  | 21 | 20 | } |
  | 22 |  |  |
  | 23 |  |  |
  | 24 |  | private function display\_setting($error\_msg~~="",$delete=true)~~{ |
  | 25 |  | $this->view->display\_setting($error\_msg,$delete); |
  | 26 |  | } |
  | 27 |  |  |
  | 28 |  | private function save()~~{~~ |
  | 29 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'save\_item' )~~ ) { |
  | 30 |  | die('Sorry, your nonce did not verify.'); |
  | 31 |  | } |
  |  | 21 |  |
  |  | 22 |  |
  |  | 23 | private function display\_setting($error\_msg = "", $delete = true) { |
  |  | 24 | $this->view->display\_setting($error\_msg, $delete); |
  |  | 25 | } |
  |  | 26 |  |
  |  | 27 | private function save() { |
  |  | 28 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'save\_item')) { |
  |  | 29 | die('Sorry, your nonce did not verify.'); |
  |  | 30 | } |
  | 32 | 31 | $saved\_parametrs = wpdevart\_bc\_Library::sanitizeAllPost($\_POST); |
  | 33 | 32 | $data\_json = json\_encode($saved\_parametrs); |
  | 34 |  | if~~(get\_option("wpdevartec\_settings") === false)~~{ |
  |  | 33 | if (get\_option("wpdevartec\_settings") === false) { |
  | 35 | 34 | add\_option("wpdevartec\_settings", $data\_json); |
  | 36 | 35 | } else { |
  | 37 | 36 | update\_option("wpdevartec\_settings", $data\_json); |
  | 38 | 37 | } |
  | 39 |  | $this->display\_setting(); |
  |  | 38 | $this->display\_setting(); |
  | 40 | 39 | } |
  | 41 |  |  |
  | 42 |  |  |
  | 43 | 40 | } |
  | 44 |  |  |
  | 45 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/controllers/Payment.php](/changeset/3209851/booking-calendar/trunk/admin/controllers/Payment.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/controllers/Payment.php")

  | [r2965848](/browser/booking-calendar/trunk/admin/controllers/Payment.php?rev=2965848#L1 "Show revision 2965848 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/controllers/Payment.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ControllerPayments { |
  | 3 |  | private $model; |
  | 4 |  | private $theme\_option; |
  |  | 3 | private $model; |
  |  | 4 | private $theme\_option; |
  | 5 | 5 | private $res\_edit; |
  | 6 |  |  |
  |  | 6 |  |
  | 7 | 7 | public function \_\_construct() { |
  | 8 | 8 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Payment.php"); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Payment.php?rev=2965848#L12) | […](/browser/booking-calendar/trunk/admin/controllers/Payment.php?rev=3209851#L12) |  |
  | 12 | 12 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/controllers/Reservations.php"); |
  | 13 | 13 | $this->res\_edit = new wpdevart\_bc\_ControllerReservations(); |
  | 14 |  | } |
  | 15 |  |  |
  |  | 14 | } |
  |  | 15 |  |
  | 16 | 16 | public function perform() { |
  | 17 | 17 | $task = wpdevart\_bc\_Library::get\_value('task'); |
  | 18 | 18 | $id = wpdevart\_bc\_Library::get\_value('id', 0); |
  | 19 | 19 | if (method\_exists($this, $task)) { |
  | 20 |  | $this->$task(); |
  | 21 |  | } |
  | 22 |  | else { |
  | 23 |  | $this->paypal\_notify(); |
  |  | 20 | $this->$task(); |
  |  | 21 | } else { |
  |  | 22 | $this->paypal\_notify(); |
  | 24 | 23 | } |
  | 25 | 24 | } |
  | 26 |  |  |
  | 27 |  | private function paypal\_notify(){ |
  |  | 25 |  |
  |  | 26 | private function paypal\_notify() { |
  | 28 | 27 | global $wpdb; |
  | 29 | 28 | $sandbox = (isset($this->theme\_option["payment\_mode"]) && $this->theme\_option["payment\_mode"] == 'live') ? "live" : "sandbox"; |
  | 30 | 29 | $res\_id = isset($\_GET['res\_id']) ? (int)stripslashes($\_GET['res\_id']) : 0; |
  | 31 | 30 | $cal\_id = isset($\_GET['cal\_id']) ? (int)stripslashes($\_GET['cal\_id']) : 0; |
  | 32 |  |  |
  |  | 31 |  |
  | 33 | 32 | $url\_paypal = ($sandbox == "sandbox") ? 'https://www.sandbox.paypal.com/webscr?' : 'https://www.paypal.com/cgi-bin/webscr?'; |
  | 34 |  |  |
  |  | 33 |  |
  | 35 | 34 | $ipnData = array(); |
  | 36 |  | foreach ($\_POST as $key => $value) { |
  | 37 |  | $ipnData[$key] = $value; |
  | 38 |  | } |
  | 39 |  | $requestData = array('cmd' => '\_notify-validate') + $ipnData; |
  | 40 |  | $request = http\_build\_query($requestData); |
  |  | 35 | foreach ($\_POST as $key => $value) { |
  |  | 36 | $ipnData[$key] = $value; |
  |  | 37 | } |
  |  | 38 | $requestData = array('cmd' => '\_notify-validate') + $ipnData; |
  |  | 39 | $request = http\_build\_query($requestData); |
  | 41 | 40 |  |
  | 42 |  | $curl = curl\_init(); |
  | 43 |  | curl\_setopt\_array($curl, array( |
  | 44 |  | CURLOPT\_URL => $url\_paypal, |
  | 45 |  | CURLOPT\_HEADER => 0, |
  | 46 |  | CURLOPT\_POST => 1, |
  | 47 |  | CURLOPT\_POSTFIELDS => $request, |
  | 48 |  | CURLOPT\_SSL\_VERIFYPEER => true, |
  | 49 |  | CURLOPT\_SSLVERSION => 1, |
  | 50 |  | ~~CURLOPT\_RETURNTRANSFER => 1));~~ |
  | 51 |  |  |
  | 52 |  | $response = curl\_exec($curl); |
  | 53 |  | if~~(!$response)~~{ |
  |  | 41 | $curl = curl\_init(); |
  |  | 42 | curl\_setopt\_array($curl, array( |
  |  | 43 | CURLOPT\_URL => $url\_paypal, |
  |  | 44 | CURLOPT\_HEADER => 0, |
  |  | 45 | CURLOPT\_POST => 1, |
  |  | 46 | CURLOPT\_POSTFIELDS => $request, |
  |  | 47 | CURLOPT\_SSL\_VERIFYPEER => true, |
  |  | 48 | CURLOPT\_SSLVERSION => 1, |
  |  | 49 | CURLOPT\_RETURNTRANSFER => 1 |
  |  | 50 | )); |
  |  | 51 | $response = curl\_exec($curl); |
  |  | 52 | if (!$response) { |
  | 54 | 53 | $response = ""; |
  | 55 | 54 | } |
  | 56 |  | curl\_close($curl); |
  | 57 |  | $date = self::get\_now(); |
  |  | 55 | curl\_close($curl); |
  |  | 56 | $date = self::get\_now(); |
  | 58 | 57 | $ip = $\_SERVER['REMOTE\_ADDR']; |
  | 59 |  | $total = isset($\_POST['mc\_gross']) ? esc\_~~html~~($\_POST['mc\_gross']) : ""; |
  | 60 |  | $tax\_value = isset($\_POST['tax']) ? esc\_~~html~~($\_POST['tax']) : ""; |
  |  | 58 | $total = isset($\_POST['mc\_gross']) ? esc\_attr($\_POST['mc\_gross']) : ""; |
  |  | 59 | $tax\_value = isset($\_POST['tax']) ? esc\_attr($\_POST['tax']) : ""; |
  | 61 | 60 | $payment\_status = isset($\_POST['payment\_status']) ? esc\_html($\_POST['payment\_status']) : ""; |
  | 62 | 61 |  |
  | 63 |  | $payment\_address = isset($\_POST['address\_country']) ? "Country: " . esc\_~~html~~($\_POST['address\_country']) . "<br>" : ""; |
  | 64 |  | $payment\_address .= isset($\_POST['address\_state']) ? "State: " . esc\_~~html~~($\_POST['address\_state']) . "<br>" : ''; |
  | 65 |  | $payment\_address .= isset($\_POST['address\_city']) ? "City: " . esc\_~~html~~($\_POST['address\_city']) . "<br>" : ''; |
  | 66 |  | $payment\_address .= isset($\_POST['address\_street']) ? "Street: " . esc\_~~html~~($\_POST['address\_street']) . "<br>" : ''; |
  | 67 |  | $payment\_address .= isset($\_POST['address\_zip']) ? "Zip Code: " . esc\_~~html~~($\_POST['address\_zip']) . "<br>" : ''; |
  | 68 |  | $payment\_address .= isset($\_POST['address\_status']) ? "Address Status: " . esc\_~~html~~($\_POST['address\_status']) . "<br>" : ''; |
  | 69 |  | $payment\_address .= isset($\_POST['address\_name']) ? "Name: " . esc\_~~html~~($\_POST['address\_name']) . "<br>" : ''; |
  |  | 62 | $payment\_address = isset($\_POST['address\_country']) ? "Country: " . esc\_attr($\_POST['address\_country']) . "<br>" : ""; |
  |  | 63 | $payment\_address .= isset($\_POST['address\_state']) ? "State: " . esc\_attr($\_POST['address\_state']) . "<br>" : ''; |
  |  | 64 | $payment\_address .= isset($\_POST['address\_city']) ? "City: " . esc\_attr($\_POST['address\_city']) . "<br>" : ''; |
  |  | 65 | $payment\_address .= isset($\_POST['address\_street']) ? "Street: " . esc\_attr($\_POST['address\_street']) . "<br>" : ''; |
  |  | 66 | $payment\_address .= isset($\_POST['address\_zip']) ? "Zip Code: " . esc\_attr($\_POST['address\_zip']) . "<br>" : ''; |
  |  | 67 | $payment\_address .= isset($\_POST['address\_status']) ? "Address Status: " . esc\_attr($\_POST['address\_status']) . "<br>" : ''; |
  |  | 68 | $payment\_address .= isset($\_POST['address\_name']) ? "Name: " . esc\_attr($\_POST['address\_name']) . "<br>" : ''; |
  | 70 | 69 | $paypal\_info = ""; |
  | 71 |  | $paypal\_info .= isset($\_POST['payer\_status']) ? "Payer Status - " . esc\_~~html~~($\_POST['payer\_status']) . "<br>" : ''; |
  | 72 |  | $paypal\_info .= isset($\_POST['payer\_email']) ? "Payer Email - " . esc\_~~html~~($\_POST['payer\_email']) . "<br>" : ''; |
  | 73 |  | $paypal\_info .= isset($\_POST['first\_name']) ? "Payer Name - " . esc\_~~html~~($\_POST['first\_name']) : ''; |
  | 74 |  | $paypal\_info .= isset($\_POST['last\_name']) ? " " . esc\_~~html~~($\_POST['last\_name']) . "<br>" : ''; |
  | 75 |  | $paypal\_info .= isset($\_POST['txn\_id']) ? "Transaction - " . esc\_~~html~~($\_POST['txn\_id']) . "<br>" : ''; |
  | 76 |  | $paypal\_info .= isset($\_POST['payment\_type']) ? "Payment Type - " . esc\_~~html~~($\_POST['payment\_type']) . "<br>" : ''; |
  |  | 70 | $paypal\_info .= isset($\_POST['payer\_status']) ? "Payer Status - " . esc\_attr($\_POST['payer\_status']) . "<br>" : ''; |
  |  | 71 | $paypal\_info .= isset($\_POST['payer\_email']) ? "Payer Email - " . esc\_attr($\_POST['payer\_email']) . "<br>" : ''; |
  |  | 72 | $paypal\_info .= isset($\_POST['first\_name']) ? "Payer Name - " . esc\_attr($\_POST['first\_name']) : ''; |
  |  | 73 | $paypal\_info .= isset($\_POST['last\_name']) ? " " . esc\_attr($\_POST['last\_name']) . "<br>" : ''; |
  |  | 74 | $paypal\_info .= isset($\_POST['txn\_id']) ? "Transaction - " . esc\_attr($\_POST['txn\_id']) . "<br>" : ''; |
  |  | 75 | $paypal\_info .= isset($\_POST['payment\_type']) ? "Payment Type - " . esc\_attr($\_POST['payment\_type']) . "<br>" : ''; |
  | 77 | 76 | $id = $wpdb->get\_var($wpdb->prepare('SELECT pay\_id FROM ' . $wpdb->prefix . 'wpdevart\_payments WHERE res\_id="%d"', $res\_id)); |
  | 78 |  |  |
  | 79 |  | if~~(!is\_null($id) && $id)~~{ |
  | 80 |  | $save\_db = $wpdb->update($wpdb->prefix . 'wpdevart\_payments', array( |
  | 81 |  | 'payment\_price' => $total, |
  | 82 |  | 'tax' => $tax\_value, |
  | 83 |  | 'pay\_status' => $payment\_status, |
  | 84 |  | 'ip' => $ip, |
  | 85 |  | 'ipn' => $response, |
  | 86 |  | 'payment\_address' => $payment\_address, |
  | 87 |  | 'payment\_info' => $paypal\_info, |
  | 88 |  | ~~'modified\_date' => $date~~ |
  | 89 |  | ), array('res\_id' => $res\_id), array('%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s')); |
  |  | 77 |  |
  |  | 78 | if (!is\_null($id) && $id) { |
  |  | 79 | $save\_db = $wpdb->update($wpdb->prefix . 'wpdevart\_payments', array( |
  |  | 80 | 'payment\_price' => $total, |
  |  | 81 | 'tax' => $tax\_value, |
  |  | 82 | 'pay\_status' => $payment\_status, |
  |  | 83 | 'ip' => $ip, |
  |  | 84 | 'ipn' => $response, |
  |  | 85 | 'payment\_address' => $payment\_address, |
  |  | 86 | 'payment\_info' => $paypal\_info, |
  |  | 87 | 'modified\_date' => $date |
  |  | 88 | ), array('res\_id' => $res\_id), array('%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s')); |
  | 90 | 89 | } else { |
  | 91 |  | $save\_db = $wpdb->insert($wpdb->prefix . 'wpdevart\_payments', array( |
  | 92 |  | 'res\_id' => $res\_id, |
  | 93 |  | 'payment\_price' => $total, |
  | 94 |  | 'tax' => $tax\_value, |
  | 95 |  | 'pay\_status' => $payment\_status, |
  | 96 |  | 'ip' => $ip, |
  | 97 |  | 'ipn' => $response, |
  | 98 |  | 'payment\_address' => $payment\_address, |
  | 99 |  | 'payment\_info' => $paypal\_info, |
  | 100 |  | 'modified\_date' => $date |
  | 101 |  | ), array( |
  | 102 |  | '%d', |
  | 103 |  | '%s', |
  | 104 |  | '%s', |
  | 105 |  | '%s', |
  | 106 |  | '%s', |
  | 107 |  | '%s', |
  | 108 |  | '%s', |
  | 109 |  | '%s', |
  | 110 |  | '%s' |
  | 111 |  | )); |
  | 112 |  | } |
  | 113 |  |  |
  | 114 |  | if($save\_db)  { |
  | 115 |  | if($payment\_status == "Completed" || $payment\_status == 'Pending'){ |
  | 116 |  | $this->send\_mail($res\_id,'payment',  "completed"); |
  | 117 |  | if(isset($this->theme\_option['enable\_psuccess\_approval']) && $this->theme\_option['enable\_psuccess\_approval'] == "on") { |
  | 118 |  | $change\_status = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
  | 119 |  | array('status' => "approved"), |
  | 120 |  | array('id' => $res\_id), |
  | 121 |  | array('%s'), |
  | 122 |  | array('%d') |
  | 123 |  | ); |
  | 124 |  | $this->res\_edit->change\_date\_avail\_count( $res\_id,true); |
  |  | 90 | $save\_db = $wpdb->insert($wpdb->prefix . 'wpdevart\_payments', array( |
  |  | 91 | 'res\_id' => $res\_id, |
  |  | 92 | 'payment\_price' => $total, |
  |  | 93 | 'tax' => $tax\_value, |
  |  | 94 | 'pay\_status' => $payment\_status, |
  |  | 95 | 'ip' => $ip, |
  |  | 96 | 'ipn' => $response, |
  |  | 97 | 'payment\_address' => $payment\_address, |
  |  | 98 | 'payment\_info' => $paypal\_info, |
  |  | 99 | 'modified\_date' => $date |
  |  | 100 | ), array( |
  |  | 101 | '%d', |
  |  | 102 | '%s', |
  |  | 103 | '%s', |
  |  | 104 | '%s', |
  |  | 105 | '%s', |
  |  | 106 | '%s', |
  |  | 107 | '%s', |
  |  | 108 | '%s', |
  |  | 109 | '%s' |
  |  | 110 | )); |
  |  | 111 | } |
  |  | 112 |  |
  |  | 113 | if ($save\_db) { |
  |  | 114 | if ($payment\_status == "Completed" || $payment\_status == 'Pending') { |
  |  | 115 | $this->send\_mail($res\_id, 'payment',  "completed"); |
  |  | 116 | if (isset($this->theme\_option['enable\_psuccess\_approval']) && $this->theme\_option['enable\_psuccess\_approval'] == "on") { |
  |  | 117 | $change\_status = $wpdb->update( |
  |  | 118 | $wpdb->prefix . 'wpdevart\_reservations', |
  |  | 119 | array('status' => "approved"), |
  |  | 120 | array('id' => $res\_id), |
  |  | 121 | array('%s'), |
  |  | 122 | array('%d') |
  |  | 123 | ); |
  |  | 124 | $this->res\_edit->change\_date\_avail\_count($res\_id, true); |
  | 125 | 125 | $this->send\_mail($res\_id, 'reservation', "approved"); |
  | 126 |  |  |
  | 127 | 126 | } |
  | 128 |  | } |
  | 129 |  | else if($payment\_status == 'Failed' || $payment\_status == 'Denied' || $payment\_status == 'Expired' || $payment\_status == 'Voided' || $payment\_status == 'Refunded' || $payment\_status == 'Processed'){ |
  | 130 |  | $this->send\_mail($res\_id,'payment',  "failed"); |
  |  | 127 | } else if ($payment\_status == 'Failed' || $payment\_status == 'Denied' || $payment\_status == 'Expired' || $payment\_status == 'Voided' || $payment\_status == 'Refunded' || $payment\_status == 'Processed') { |
  |  | 128 | $this->send\_mail($res\_id, 'payment',  "failed"); |
  | 131 | 129 | } |
  | 132 | 130 | } |
  | 133 | 131 | } |
  | 134 |  | private function paypal\_cancel(){ |
  | 135 |  | global $wpdb; |
  |  | 132 | private function paypal\_cancel() { |
  |  | 133 | global $wpdb; |
  | 136 | 134 | $res\_id = isset($\_GET['res\_id']) ? (int)stripslashes($\_GET['res\_id']) : 0; |
  | 137 |  | $save\_db = $wpdb->insert($wpdb->prefix . 'wpdevart\_payments', array( |
  | 138 |  | 'res\_id' => $res\_id, |
  | 139 |  | 'pay\_status' => "cancelled" |
  | 140 |  | ), array( |
  |  | 135 | $save\_db = $wpdb->insert($wpdb->prefix . 'wpdevart\_payments', array( |
  |  | 136 | 'res\_id' => $res\_id, |
  |  | 137 | 'pay\_status' => "cancelled" |
  |  | 138 | ), array( |
  | 141 | 139 | '%d', |
  | 142 | 140 | '%s' |
  | 143 |  | )); |
  |  | 141 | )); |
  | 144 | 142 | } |
  | 145 |  |  |
  | 146 |  | private function send\_mail($res\_id, $from, $type){ |
  |  | 143 |  |
  |  | 144 | private function send\_mail($res\_id, $from, $type) { |
  | 147 | 145 | $data = $this->model->get\_reservation\_row($res\_id); |
  | 148 | 146 | $lib = new wpdevart\_bc\_Library(); |
  | 149 |  | return $lib->send\_mail( $data, $from, $this->theme\_option, $type ); |
  | 150 |  |  |
  | 151 |  | } |
  | 152 |  | private static function get\_now(){ |
  | 153 |  | $now = date( 'Y-m-d H:i:s' ); |
  | 154 |  | $tz\_string     = get\_option( 'timezone\_string' ); |
  | 155 |  | if ( $tz\_string ) { |
  |  | 147 | return $lib->send\_mail($data, $from, $this->theme\_option, $type); |
  |  | 148 | } |
  |  | 149 | private static function get\_now() { |
  |  | 150 | $now = date('Y-m-d H:i:s'); |
  |  | 151 | $tz\_string     = get\_option('timezone\_string'); |
  |  | 152 | if ($tz\_string) { |
  | 156 | 153 | try { |
  | 157 |  | $tz = new DateTimeZone(~~$tz\_string~~ ); |
  | 158 |  | } catch (~~Exception $e~~ ) { |
  |  | 154 | $tz = new DateTimeZone($tz\_string); |
  |  | 155 | } catch (Exception $e) { |
  | 159 | 156 | $tz = ''; |
  | 160 | 157 | } |
  | 161 | 158 |  |
  | 162 |  | if (~~$tz~~ ) { |
  | 163 |  | $now = new DateTime(~~'now', $tz~~ ); |
  |  | 159 | if ($tz) { |
  |  | 160 | $now = new DateTime('now', $tz); |
  | 164 | 161 | $now = $now->format('Y-m-d H:i:s'); |
  | 165 | 162 | } |
  | […](/browser/booking-calendar/trunk/admin/controllers/Payment.php?rev=2965848#L168) | […](/browser/booking-calendar/trunk/admin/controllers/Payment.php?rev=3209851#L165) |  |
  | 168 | 165 | } |
  | 169 | 166 | } |
  | 170 |  |  |
  | 171 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/controllers/Reservations.php](/changeset/3209851/booking-calendar/trunk/admin/controllers/Reservations.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/controllers/Reservations.php")

  | [r2965848](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L1 "Show revision 2965848 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ControllerReservations { |
  | 3 |  | private $model; |
  | 4 |  | private $view; |
  | 5 |  |  |
  |  | 3 | private $model; |
  |  | 4 | private $view; |
  |  | 5 |  |
  | 6 | 6 | public function \_\_construct() { |
  | 7 | 7 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/models/Reservations.php"); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L9) | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L9) |  |
  | 9 | 9 | require\_once(WPDEVART\_PLUGIN\_DIR . "/admin/views/Reservations.php"); |
  | 10 | 10 | $this->view = new wpdevart\_bc\_ViewReservations($this->model); |
  | 11 |  | } |
  | 12 |  |  |
  |  | 11 | } |
  |  | 12 |  |
  | 13 | 13 | public function perform() { |
  | 14 | 14 | $task = wpdevart\_bc\_Library::get\_value('task'); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L16) | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L16) |  |
  | 16 | 16 | $action = wpdevart\_bc\_Library::get\_value('action'); |
  | 17 | 17 | if (method\_exists($this, $task)) { |
  | 18 |  | $this->$task($id); |
  | 19 |  | } |
  | 20 |  | else { |
  | 21 |  | $this->display\_reservations(); |
  | 22 |  | } |
  | 23 |  | } |
  | 24 |  |  |
  | 25 |  | private function display\_reservations($id=0,$send\_mail = array()){ |
  | 26 |  | $this->view->display\_reservations($id,$send\_mail); |
  | 27 |  | } |
  | 28 |  |  |
  | 29 |  | private function display\_month\_reservations(){ |
  |  | 18 | $this->$task($id); |
  |  | 19 | } else { |
  |  | 20 | $this->display\_reservations(); |
  |  | 21 | } |
  |  | 22 | } |
  |  | 23 |  |
  |  | 24 | private function display\_reservations($id = 0, $send\_mail = array()) { |
  |  | 25 | $this->view->display\_reservations($id, $send\_mail); |
  |  | 26 | } |
  |  | 27 |  |
  |  | 28 | private function display\_month\_reservations() { |
  | 30 | 29 | $this->view->display\_month\_reservations(); |
  | 31 | 30 | } |
  | 32 |  |  |
  | 33 |  | private function edit(~~$id )~~{ |
  | 34 |  | $this->view->edit(~~$id~~ ); |
  | 35 |  | } |
  | 36 |  |  |
  | 37 |  | private function delete(~~$id )~~{ |
  | 38 |  | if (~~! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' )~~ ) { |
  | 39 |  | die('Sorry, your nonce did not verify.'); |
  | 40 |  | } |
  | 41 |  | global $wpdb; |
  | 42 |  | $send\_mail = array(); |
  | 43 |  | $res\_status = $this->model->get\_reservation\_row(~~$id~~ ); |
  | 44 |  | $delete\_res = $wpdb->query($wpdb->prepare(~~'DELETE FROM ' . $wpdb->prefix . 'wpdevart\_reservations WHERE id="%d"',$id~~ )); |
  | 45 |  | if($delete\_res) { |
  | 46 |  | if($res\_status["status"] == "approved") { |
  | 47 |  | $this->change\_date\_avail\_count(~~$id, false, $res\_status~~ ); |
  | 48 |  | } |
  | 49 |  | if~~($res\_status["status"] != 'rejected')~~{ |
  | 50 |  | $send\_mail = $this->send\_mail($id,"deleted", $res\_status); |
  | 51 |  | } |
  | 52 |  | } |
  | 53 |  | $this->display\_reservations(0,$send\_mail); |
  | 54 |  | } |
  | 55 |  |  |
  |  | 31 |  |
  |  | 32 | private function edit($id) { |
  |  | 33 | $this->view->edit($id); |
  |  | 34 | } |
  |  | 35 |  |
  |  | 36 | private function delete($id) { |
  |  | 37 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item')) { |
  |  | 38 | die('Sorry, your nonce did not verify.'); |
  |  | 39 | } |
  |  | 40 | global $wpdb; |
  |  | 41 | $send\_mail = array(); |
  |  | 42 | $res\_status = $this->model->get\_reservation\_row($id); |
  |  | 43 | $delete\_res = $wpdb->query($wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_reservations WHERE id="%d"', $id)); |
  |  | 44 | if ($delete\_res) { |
  |  | 45 | if ($res\_status["status"] == "approved") { |
  |  | 46 | $this->change\_date\_avail\_count($id, false, $res\_status); |
  |  | 47 | } |
  |  | 48 | if ($res\_status["status"] != 'rejected') { |
  |  | 49 | $send\_mail = $this->send\_mail($id, "deleted", $res\_status); |
  |  | 50 | } |
  |  | 51 | } |
  |  | 52 | $this->display\_reservations(0, $send\_mail); |
  |  | 53 | } |
  |  | 54 |  |
  | 56 | 55 | private function add() { |
  | 57 | 56 | $this->view->add(); |
  | 58 | 57 | } |
  | 59 |  |  |
  | 60 |  | private function save($id){ |
  |  | 58 |  |
  |  | 59 | private function save($id) { |
  | 61 | 60 | $calendar\_id = wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  | 62 |  | if~~(isset($\_POST["wpdevart-submit".$id]))~~{ |
  |  | 61 | if (isset($\_POST["wpdevart-submit" . $id])) { |
  | 63 | 62 | $booking\_obg = new wpdevart\_bc\_calendar(); |
  | 64 | 63 | $result = $booking\_obg->wpdevart\_booking\_calendar($calendar\_id); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L68) | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L67) |  |
  | 68 | 67 | } |
  | 69 | 68 |  |
  | 70 |  | private function delete\_selected(){ |
  | 71 |  | if ( ! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' ) ) { |
  | 72 |  | die('Sorry, your nonce did not verify.'); |
  | 73 |  | } |
  | 74 |  | global $wpdb; |
  | 75 |  | $send\_mail = array(); |
  | 76 |  | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ( $\_POST['check\_for\_action']) : ''); |
  | 77 |  | foreach($check\_for\_action as $check){ |
  | 78 |  | $res\_status = $this->model->get\_reservation\_row( $check ); |
  | 79 |  | $delete\_res = $wpdb->query($wpdb->prepare( 'DELETE FROM ' . $wpdb->prefix . 'wpdevart\_reservations WHERE id="%d"',$check )); |
  | 80 |  | if($delete\_res) { |
  | 81 |  | if($res\_status["status"] == "approved") { |
  | 82 |  | $this->change\_date\_avail\_count( $check, false, $res\_status ); |
  | 83 |  | } |
  | 84 |  | if($res\_status["status"] != 'rejected'){ |
  | 85 |  | $send\_mail = $this->send\_mail($check,"deleted", $res\_status); |
  | 86 |  | } |
  | 87 |  | } |
  | 88 |  | } |
  | 89 |  | $this->display\_reservations(0,$send\_mail); |
  | 90 |  | } |
  | 91 |  |  |
  | 92 |  | private function approve\_selected(){ |
  | 93 |  | if ( ! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' ) ) { |
  | 94 |  | die('Sorry, your nonce did not verify.'); |
  | 95 |  | } |
  | 96 |  | global $wpdb; |
  | 97 |  | $send\_mail = array(); |
  | 98 |  | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ( $\_POST['check\_for\_action']) : ''); |
  | 99 |  | foreach($check\_for\_action as $check){ |
  | 100 |  | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
  | 101 |  | array('status' => "approved", |
  | 102 |  | 'is\_new' => 0 ), |
  |  | 69 | private function delete\_selected() { |
  |  | 70 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item')) { |
  |  | 71 | die('Sorry, your nonce did not verify.'); |
  |  | 72 | } |
  |  | 73 | global $wpdb; |
  |  | 74 | $send\_mail = array(); |
  |  | 75 | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  |  | 76 | foreach ($check\_for\_action as $check) { |
  |  | 77 | $res\_status = $this->model->get\_reservation\_row($check); |
  |  | 78 | $delete\_res = $wpdb->query($wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_reservations WHERE id="%d"', $check)); |
  |  | 79 | if ($delete\_res) { |
  |  | 80 | if ($res\_status["status"] == "approved") { |
  |  | 81 | $this->change\_date\_avail\_count($check, false, $res\_status); |
  |  | 82 | } |
  |  | 83 | if ($res\_status["status"] != 'rejected') { |
  |  | 84 | $send\_mail = $this->send\_mail($check, "deleted", $res\_status); |
  |  | 85 | } |
  |  | 86 | } |
  |  | 87 | } |
  |  | 88 | $this->display\_reservations(0, $send\_mail); |
  |  | 89 | } |
  |  | 90 |  |
  |  | 91 | private function approve\_selected() { |
  |  | 92 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item')) { |
  |  | 93 | die('Sorry, your nonce did not verify.'); |
  |  | 94 | } |
  |  | 95 | global $wpdb; |
  |  | 96 | $send\_mail = array(); |
  |  | 97 | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  |  | 98 | foreach ($check\_for\_action as $check) { |
  |  | 99 | $update\_res = $wpdb->update( |
  |  | 100 | $wpdb->prefix . 'wpdevart\_reservations', |
  |  | 101 | array( |
  |  | 102 | 'status' => "approved", |
  |  | 103 | 'is\_new' => 0 |
  |  | 104 | ), |
  | 103 | 105 | array('id' => $check), |
  | 104 | 106 | array('%s', '%d'), |
  | 105 | 107 | array('%d') |
  | 106 | 108 | ); |
  | 107 |  | if($update\_res) { |
  | 108 |  | $this->change\_date\_avail\_count( $check, true ); |
  | 109 |  | $send\_mail = $this->send\_mail($check,"approved"); |
  | 110 |  | } |
  | 111 |  | } |
  | 112 |  |  |
  | 113 |  | $this->display\_reservations(0,$send\_mail); |
  | 114 |  | } |
  | 115 |  |  |
  | 116 |  | private function canceled\_selected(){ |
  | 117 |  | if ( ! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' ) ) { |
  | 118 |  | die('Sorry, your nonce did not verify.'); |
  | 119 |  | } |
  | 120 |  | global $wpdb; |
  | 121 |  | $send\_mail = array(); |
  | 122 |  | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ( $\_POST['check\_for\_action']) : ''); |
  | 123 |  | foreach($check\_for\_action as $check){ |
  | 124 |  | $res\_status = $this->model->get\_reservation\_row( $check ); |
  | 125 |  | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
  | 126 |  | array('status' => "canceled", |
  | 127 |  | 'is\_new' => 0), |
  |  | 109 | if ($update\_res) { |
  |  | 110 | $this->change\_date\_avail\_count($check, true); |
  |  | 111 | $send\_mail = $this->send\_mail($check, "approved"); |
  |  | 112 | } |
  |  | 113 | } |
  |  | 114 |  |
  |  | 115 | $this->display\_reservations(0, $send\_mail); |
  |  | 116 | } |
  |  | 117 |  |
  |  | 118 | private function canceled\_selected() { |
  |  | 119 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item')) { |
  |  | 120 | die('Sorry, your nonce did not verify.'); |
  |  | 121 | } |
  |  | 122 | global $wpdb; |
  |  | 123 | $send\_mail = array(); |
  |  | 124 | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  |  | 125 | foreach ($check\_for\_action as $check) { |
  |  | 126 | $res\_status = $this->model->get\_reservation\_row($check); |
  |  | 127 | $update\_res = $wpdb->update( |
  |  | 128 | $wpdb->prefix . 'wpdevart\_reservations', |
  |  | 129 | array( |
  |  | 130 | 'status' => "canceled", |
  |  | 131 | 'is\_new' => 0 |
  |  | 132 | ), |
  | 128 | 133 | array('id' => $check), |
  | 129 |  | array('%s', '%d'), |
  | 130 |  | array('%d') |
  |  | 134 | array('%s', '%d'), |
  |  | 135 | array('%d') |
  | 131 | 136 | ); |
  | 132 |  | if($update\_res) { |
  | 133 |  | if($res\_status["status"] == "approved") { |
  | 134 |  | $this->change\_date\_avail\_count( $check, false ); |
  | 135 |  | } |
  | 136 |  | $send\_mail = $this->send\_mail($check,"canceled"); |
  | 137 |  | } |
  | 138 |  | } |
  | 139 |  | $this->display\_reservations(0,$send\_mail); |
  | 140 |  | } |
  | 141 |  |  |
  | 142 |  | private function reject\_selected(){ |
  | 143 |  | if ( ! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' ) ) { |
  | 144 |  | die('Sorry, your nonce did not verify.'); |
  | 145 |  | } |
  | 146 |  | global $wpdb; |
  | 147 |  | $send\_mail = array(); |
  | 148 |  | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ( $\_POST['check\_for\_action']) : ''); |
  | 149 |  | foreach($check\_for\_action as $check){ |
  | 150 |  | $res\_status = $this->model->get\_reservation\_row( $check ); |
  | 151 |  | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
  | 152 |  | array('status' => "rejected", |
  | 153 |  | 'is\_new' => 0), |
  |  | 137 | if ($update\_res) { |
  |  | 138 | if ($res\_status["status"] == "approved") { |
  |  | 139 | $this->change\_date\_avail\_count($check, false); |
  |  | 140 | } |
  |  | 141 | $send\_mail = $this->send\_mail($check, "canceled"); |
  |  | 142 | } |
  |  | 143 | } |
  |  | 144 | $this->display\_reservations(0, $send\_mail); |
  |  | 145 | } |
  |  | 146 |  |
  |  | 147 | private function reject\_selected() { |
  |  | 148 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item')) { |
  |  | 149 | die('Sorry, your nonce did not verify.'); |
  |  | 150 | } |
  |  | 151 | global $wpdb; |
  |  | 152 | $send\_mail = array(); |
  |  | 153 | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  |  | 154 | foreach ($check\_for\_action as $check) { |
  |  | 155 | $res\_status = $this->model->get\_reservation\_row($check); |
  |  | 156 | $update\_res = $wpdb->update( |
  |  | 157 | $wpdb->prefix . 'wpdevart\_reservations', |
  |  | 158 | array( |
  |  | 159 | 'status' => "rejected", |
  |  | 160 | 'is\_new' => 0 |
  |  | 161 | ), |
  | 154 | 162 | array('id' => $check), |
  | 155 |  | array('%s', '%d'), |
  | 156 |  | array('%d') |
  |  | 163 | array('%s', '%d'), |
  |  | 164 | array('%d') |
  | 157 | 165 | ); |
  | 158 |  | if($update\_res) { |
  | 159 |  | if($res\_status["status"] == "approved") { |
  | 160 |  | $this->change\_date\_avail\_count( $check, false ); |
  | 161 |  | } |
  | 162 |  | $send\_mail = $this->send\_mail($check,"rejected"); |
  | 163 |  | } |
  | 164 |  | } |
  | 165 |  | $this->display\_reservations(0,$send\_mail); |
  | 166 |  | } |
  | 167 |  |  |
  | 168 |  |  |
  | 169 |  | private function approve( $id ){ |
  | 170 |  | if ( ! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' ) ) { |
  | 171 |  | die('Sorry, your nonce did not verify.'); |
  | 172 |  | } |
  | 173 |  | global $wpdb; |
  | 174 |  | $send\_mail = array(); |
  | 175 |  | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
  | 176 |  | array('status' => "approved", |
  | 177 |  | 'is\_new' => 0), |
  | 178 |  | array('id' => (int) $id), |
  | 179 |  | array('%s', '%d'), |
  | 180 |  | array('%d') |
  | 181 |  | ); |
  | 182 |  | if($update\_res) { |
  | 183 |  | $this->change\_date\_avail\_count( $id, true ); |
  | 184 |  | $send\_mail = $this->send\_mail($id,"approved"); |
  | 185 |  | } |
  | 186 |  |  |
  | 187 |  | $this->display\_reservations(0,$send\_mail); |
  | 188 |  | } |
  | 189 |  |  |
  | 190 |  | private function canceled( $id ){ |
  | 191 |  | if ( ! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' ) ) { |
  | 192 |  | die('Sorry, your nonce did not verify.'); |
  | 193 |  | } |
  | 194 |  | global $wpdb; |
  | 195 |  | $send\_mail = array(); |
  | 196 |  | $res\_status = $this->model->get\_reservation\_row( $id ); |
  | 197 |  | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
  | 198 |  | array('status' => "canceled", |
  | 199 |  | 'is\_new' => 0), |
  | 200 |  | array('id' => (int) $id), |
  | 201 |  | array('%s', '%d'), |
  | 202 |  | array('%d') |
  | 203 |  | ); |
  | 204 |  | if($update\_res) { |
  | 205 |  | if($res\_status["status"] == "approved") { |
  | 206 |  | $this->change\_date\_avail\_count( $id, false ); |
  | 207 |  | } |
  | 208 |  | $send\_mail = $this->send\_mail($id,"canceled"); |
  | 209 |  | } |
  | 210 |  | $this->display\_reservations(0,$send\_mail); |
  | 211 |  | } |
  | 212 |  | private function reject( $id ){ |
  | 213 |  | if ( ! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' ) ) { |
  | 214 |  | die('Sorry, your nonce did not verify.'); |
  | 215 |  | } |
  | 216 |  | global $wpdb; |
  | 217 |  | $send\_mail =  array(); |
  | 218 |  | $res\_status = $this->model->get\_reservation\_row( $id ); |
  | 219 |  | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
  | 220 |  | array('status' => "rejected", |
  | 221 |  | 'is\_new' => 0), |
  | 222 |  | array('id' => (int) $id), |
  | 223 |  | array('%s', '%d'), |
  | 224 |  | array('%d') |
  | 225 |  | ); |
  | 226 |  | if($update\_res) { |
  | 227 |  | if($res\_status["status"] == "approved") { |
  | 228 |  | $this->change\_date\_avail\_count( $id, false ); |
  | 229 |  | } |
  | 230 |  | $send\_mail = $this->send\_mail($id,"rejected"); |
  | 231 |  | } |
  | 232 |  | $this->display\_reservations(0,$send\_mail); |
  | 233 |  | } |
  | 234 |  | private function mark\_read( $id ){ |
  | 235 |  | if ( ! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' ) ) { |
  | 236 |  | die('Sorry, your nonce did not verify.'); |
  | 237 |  | } |
  | 238 |  | global $wpdb; |
  | 239 |  | $update\_res = $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
  | 240 |  | array('is\_new' => 0), |
  | 241 |  | array('id' => (int) $id), |
  | 242 |  | array('%d'), |
  | 243 |  | array('%d') |
  | 244 |  | ); |
  | 245 |  | $this->display\_reservations(0,array()); |
  | 246 |  | } |
  | 247 |  | private function mark\_read\_selected( $id ){ |
  | 248 |  | if ( ! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' ) ) { |
  | 249 |  | die('Sorry, your nonce did not verify.'); |
  | 250 |  | } |
  | 251 |  | global $wpdb; |
  | 252 |  | if(isset($\_POST['check\_for\_action'])){ |
  | 253 |  | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ( $\_POST['check\_for\_action']) : ''); |
  | 254 |  | $check\_ids = implode(",",$check\_for\_action); |
  | 255 |  | $update\_res = $wpdb->query($wpdb->prepare('UPDATE '.$wpdb->prefix . 'wpdevart\_reservations SET is\_new=0 WHERE id IN (%s)', $check\_ids)); |
  | 256 |  | } |
  | 257 |  | $this->display\_reservations(0,array()); |
  | 258 |  | } |
  | 259 |  | public function export\_as\_csv(){ |
  |  | 166 | if ($update\_res) { |
  |  | 167 | if ($res\_status["status"] == "approved") { |
  |  | 168 | $this->change\_date\_avail\_count($check, false); |
  |  | 169 | } |
  |  | 170 | $send\_mail = $this->send\_mail($check, "rejected"); |
  |  | 171 | } |
  |  | 172 | } |
  |  | 173 | $this->display\_reservations(0, $send\_mail); |
  |  | 174 | } |
  |  | 175 |  |
  |  | 176 |  |
  |  | 177 | private function approve($id) { |
  |  | 178 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item')) { |
  |  | 179 | die('Sorry, your nonce did not verify.'); |
  |  | 180 | } |
  |  | 181 | global $wpdb; |
  |  | 182 | $send\_mail = array(); |
  |  | 183 | $update\_res = $wpdb->update( |
  |  | 184 | $wpdb->prefix . 'wpdevart\_reservations', |
  |  | 185 | array( |
  |  | 186 | 'status' => "approved", |
  |  | 187 | 'is\_new' => 0 |
  |  | 188 | ), |
  |  | 189 | array('id' => (int) $id), |
  |  | 190 | array('%s', '%d'), |
  |  | 191 | array('%d') |
  |  | 192 | ); |
  |  | 193 | if ($update\_res) { |
  |  | 194 | $this->change\_date\_avail\_count($id, true); |
  |  | 195 | $send\_mail = $this->send\_mail($id, "approved"); |
  |  | 196 | } |
  |  | 197 |  |
  |  | 198 | $this->display\_reservations(0, $send\_mail); |
  |  | 199 | } |
  |  | 200 |  |
  |  | 201 | private function canceled($id) { |
  |  | 202 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item')) { |
  |  | 203 | die('Sorry, your nonce did not verify.'); |
  |  | 204 | } |
  |  | 205 | global $wpdb; |
  |  | 206 | $send\_mail = array(); |
  |  | 207 | $res\_status = $this->model->get\_reservation\_row($id); |
  |  | 208 | $update\_res = $wpdb->update( |
  |  | 209 | $wpdb->prefix . 'wpdevart\_reservations', |
  |  | 210 | array( |
  |  | 211 | 'status' => "canceled", |
  |  | 212 | 'is\_new' => 0 |
  |  | 213 | ), |
  |  | 214 | array('id' => (int) $id), |
  |  | 215 | array('%s', '%d'), |
  |  | 216 | array('%d') |
  |  | 217 | ); |
  |  | 218 | if ($update\_res) { |
  |  | 219 | if ($res\_status["status"] == "approved") { |
  |  | 220 | $this->change\_date\_avail\_count($id, false); |
  |  | 221 | } |
  |  | 222 | $send\_mail = $this->send\_mail($id, "canceled"); |
  |  | 223 | } |
  |  | 224 | $this->display\_reservations(0, $send\_mail); |
  |  | 225 | } |
  |  | 226 | private function reject($id) { |
  |  | 227 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item')) { |
  |  | 228 | die('Sorry, your nonce did not verify.'); |
  |  | 229 | } |
  |  | 230 | global $wpdb; |
  |  | 231 | $send\_mail =  array(); |
  |  | 232 | $res\_status = $this->model->get\_reservation\_row($id); |
  |  | 233 | $update\_res = $wpdb->update( |
  |  | 234 | $wpdb->prefix . 'wpdevart\_reservations', |
  |  | 235 | array( |
  |  | 236 | 'status' => "rejected", |
  |  | 237 | 'is\_new' => 0 |
  |  | 238 | ), |
  |  | 239 | array('id' => (int) $id), |
  |  | 240 | array('%s', '%d'), |
  |  | 241 | array('%d') |
  |  | 242 | ); |
  |  | 243 | if ($update\_res) { |
  |  | 244 | if ($res\_status["status"] == "approved") { |
  |  | 245 | $this->change\_date\_avail\_count($id, false); |
  |  | 246 | } |
  |  | 247 | $send\_mail = $this->send\_mail($id, "rejected"); |
  |  | 248 | } |
  |  | 249 | $this->display\_reservations(0, $send\_mail); |
  |  | 250 | } |
  |  | 251 | private function mark\_read($id) { |
  |  | 252 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item')) { |
  |  | 253 | die('Sorry, your nonce did not verify.'); |
  |  | 254 | } |
  |  | 255 | global $wpdb; |
  |  | 256 | $update\_res = $wpdb->update( |
  |  | 257 | $wpdb->prefix . 'wpdevart\_reservations', |
  |  | 258 | array('is\_new' => 0), |
  |  | 259 | array('id' => (int) $id), |
  |  | 260 | array('%d'), |
  |  | 261 | array('%d') |
  |  | 262 | ); |
  |  | 263 | $this->display\_reservations(0, array()); |
  |  | 264 | } |
  |  | 265 | private function mark\_read\_selected($id) { |
  |  | 266 | if (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item')) { |
  |  | 267 | die('Sorry, your nonce did not verify.'); |
  |  | 268 | } |
  |  | 269 | global $wpdb; |
  |  | 270 | if (isset($\_POST['check\_for\_action'])) { |
  |  | 271 | $check\_for\_action = (isset($\_POST['check\_for\_action']) ? ($\_POST['check\_for\_action']) : ''); |
  |  | 272 | $check\_ids = implode(",", $check\_for\_action); |
  |  | 273 | $update\_res = $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'wpdevart\_reservations SET is\_new=0 WHERE id IN (%s)', $check\_ids)); |
  |  | 274 | } |
  |  | 275 | $this->display\_reservations(0, array()); |
  |  | 276 | } |
  |  | 277 | public function export\_as\_csv() { |
  | 260 | 278 | global $wpdb; |
  | 261 | 279 | $calendar\_id = wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  | 262 | 280 | $reservations = $this->model->get\_reservations\_for\_export(); |
  | 263 |  |  |
  |  | 281 |  |
  | 264 | 282 | $form\_id = $wpdb->get\_var($wpdb->prepare('SELECT form\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $calendar\_id)); |
  | 265 | 283 | $form\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $form\_id)); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L267) | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L285) |  |
  | 267 | 285 | $extra\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"', $extra\_id)); |
  | 268 | 286 | $theme\_value = $this->model->get\_theme\_rows(); |
  | 269 |  | $currency = (is\_array($theme\_value) && isset($theme\_value['currency'])) ? $theme\_value['currency'] : 'USD'; |
  |  | 287 | $currency = (is\_array($theme\_value) && isset($theme\_value['currency'])) ? $theme\_value['currency'] : 'USD'; |
  | 270 | 288 | $currency = wpdevart\_bc\_get\_currency($currency); |
  | 271 | 289 |  |
  | 272 |  | if (!empty($reservations)) { |
  |  | 290 | if (!empty($reservations)) { |
  | 273 | 291 | $title = $this->model->get\_calendar\_title(); |
  | 274 |  | $reservations = $this->model->get\_form\_data\_new($reservations,$form\_info); |
  | 275 |  | $reservations = $this->model->get\_extra\_data\_new($reservations,~~$extra\_info,~~$currency); |
  | 276 |  |  |
  |  | 292 | $reservations = $this->model->get\_form\_data\_new($reservations, $form\_info); |
  |  | 293 | $reservations = $this->model->get\_extra\_data\_new($reservations, $extra\_info, $currency); |
  |  | 294 |  |
  | 277 | 295 | $form\_lables = $this->model->get\_labels($form\_info); |
  | 278 | 296 | $extra\_lables = $this->model->get\_labels($extra\_info); |
  | 279 | 297 | $col\_names = array\_merge(array( |
  | 280 |  | "id" => "ID", |
  | 281 |  | "calendar\_id" => "Calendar ID", |
  | 282 |  | "single\_day" => "Single Day", |
  | 283 |  | "check\_in" => "Check In", |
  | 284 |  | "check\_out" => "Check Out", |
  | 285 |  | "start\_hour" => "Start Hour", |
  | 286 |  | "end\_hour" => "End Hour", |
  | 287 |  | "count\_item" => "Count Item", |
  | 288 |  | "price" => "Price", |
  | 289 |  | "total\_price" => "Total Price", |
  | 290 |  | "extras\_price" =>  "Extras Price", |
  | 291 |  | "status" => "Status", |
  | 292 |  | "payment\_method" => "Payment Method", |
  | 293 |  | "payment\_status" => "Payment Status", |
  | 294 |  | "date\_created" => "Created Date" |
  | 295 |  | ~~),$form\_lables,~~$extra\_lables); |
  |  | 298 | "id" => "ID", |
  |  | 299 | "calendar\_id" => "Calendar ID", |
  |  | 300 | "single\_day" => "Single Day", |
  |  | 301 | "check\_in" => "Check In", |
  |  | 302 | "check\_out" => "Check Out", |
  |  | 303 | "start\_hour" => "Start Hour", |
  |  | 304 | "end\_hour" => "End Hour", |
  |  | 305 | "count\_item" => "Count Item", |
  |  | 306 | "price" => "Price", |
  |  | 307 | "total\_price" => "Total Price", |
  |  | 308 | "extras\_price" =>  "Extras Price", |
  |  | 309 | "status" => "Status", |
  |  | 310 | "payment\_method" => "Payment Method", |
  |  | 311 | "payment\_status" => "Payment Status", |
  |  | 312 | "date\_created" => "Created Date" |
  |  | 313 | ), $form\_lables, $extra\_lables); |
  | 296 | 314 |  |
  | 297 | 315 | $upload\_direct = wp\_upload\_dir(); |
  | 298 | 316 | $booking\_path = $upload\_direct['basedir'] . '/booking\_calendar'; |
  | 299 |  | if (~~!is\_dir($booking\_path)~~ ) { |
  |  | 317 | if (!is\_dir($booking\_path)) { |
  | 300 | 318 | mkdir($booking\_path, 0777); |
  | 301 | 319 | } |
  | 302 | 320 | $temp = $booking\_path . '/' . $title . '.txt'; |
  | 303 |  | if (~~file\_exists($temp)~~ ) { |
  |  | 321 | if (file\_exists($temp)) { |
  | 304 | 322 | unlink($temp); |
  | 305 | 323 | } |
  | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L311) | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L329) |  |
  | 311 | 329 | fputcsv($output, $col\_names, ","); |
  | 312 | 330 |  |
  | 313 |  | foreach (~~$reservations as $index => $record~~ ) { |
  | 314 |  | foreach (~~$record as $i => $rec~~ ) { |
  |  | 331 | foreach ($reservations as $index => $record) { |
  |  | 332 | foreach ($record as $i => $rec) { |
  | 315 | 333 | $record[$i] = ltrim($rec, '=+-@'); |
  | 316 | 334 | } |
  | 317 | 335 | fputcsv($output, $record, ","); |
  | 318 | 336 | } |
  | 319 |  |  |
  | 320 |  | fclose($output); |
  |  | 337 |  |
  |  | 338 | fclose($output); |
  | 321 | 339 | $txtfile = fopen($temp, "r"); |
  | 322 | 340 | $txtfilecontent = fread($txtfile, filesize($temp)); |
  | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L329) | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L347) |  |
  | 329 | 347 | echo $txtfilecontent; |
  | 330 | 348 | unlink($temp); |
  | 331 |  |  |
  | 332 |  | } |
  | 333 |  | } |
  | 334 |  |  |
  | 335 |  | public function change\_date\_avail\_count( $id,$approve,$reserv\_info\_del="" ){ |
  |  | 349 | } |
  |  | 350 | } |
  |  | 351 |  |
  |  | 352 | public function change\_date\_avail\_count($id, $approve, $reserv\_info\_del = "") { |
  | 336 | 353 | global $wpdb; |
  | 337 | 354 | $theme\_rows = $this->model->get\_theme\_rows(); |
  | 338 |  | if($reserv\_info\_del == "") { |
  |  | 355 | if ($reserv\_info\_del == "") { |
  | 339 | 356 | $reserv\_info = $this->model->get\_reservation\_row($id); |
  | 340 | 357 | } else { |
  | 341 | 358 | $reserv\_info = $reserv\_info\_del; |
  | 342 |  | } |
  | 343 |  | $cal\_id = $reserv\_info["calendar\_id"]; |
  | 344 |  | if(isset($reserv\_info["count\_item"])) { |
  |  | 359 | } |
  |  | 360 | $cal\_id = $reserv\_info["calendar\_id"]; |
  |  | 361 | if (isset($reserv\_info["count\_item"])) { |
  | 345 | 362 | $count\_item = $reserv\_info["count\_item"]; |
  | 346 | 363 | } else { |
  | 347 | 364 | $count\_item = 1; |
  | 348 | 365 | } |
  | 349 |  | if($reserv\_info["single\_day"] == "") { |
  |  | 366 | if ($reserv\_info["single\_day"] == "") { |
  | 350 | 367 | $start\_date = $reserv\_info["check\_in"]; |
  | 351 |  | $date\_diff = abs($this->get\_date\_diff($reserv\_info["check\_in"],$reserv\_info["check\_out"])); |
  | 352 |  | for~~($i=~~0; $i <= $date\_diff; $i++) { |
  | 353 |  | if~~(isset($theme\_rows["price\_for\_night"]) && $theme\_rows["price\_for\_night"] == "on"  && $i == $date\_diff)~~{ |
  |  | 368 | $date\_diff = abs($this->get\_date\_diff($reserv\_info["check\_in"], $reserv\_info["check\_out"])); |
  |  | 369 | for ($i = 0; $i <= $date\_diff; $i++) { |
  |  | 370 | if (isset($theme\_rows["price\_for\_night"]) && $theme\_rows["price\_for\_night"] == "on"  && $i == $date\_diff) { |
  | 354 | 371 | continue; |
  | 355 | 372 | } |
  | 356 |  | $day = date(~~'Y-m-d', strtotime($start\_date. " +" . $i . " day"~~ )); |
  | 357 |  | $unique\_id = $cal\_id~~."\_".~~$day; |
  | 358 |  | $day\_data = json\_decode($this->model->get\_date\_data(~~$unique\_id ),~~true); |
  | 359 |  | if($approve === true) { |
  |  | 373 | $day = date('Y-m-d', strtotime($start\_date . " +" . $i . " day")); |
  |  | 374 | $unique\_id = $cal\_id . "\_" . $day; |
  |  | 375 | $day\_data = json\_decode($this->model->get\_date\_data($unique\_id), true); |
  |  | 376 | if ($approve === true) { |
  | 360 | 377 | $day\_data["available"] = $day\_data["available"] - $count\_item; |
  | 361 |  | if($day\_data["available"] == 0) { |
  |  | 378 | if ($day\_data["available"] == 0) { |
  | 362 | 379 | $day\_data["status"] = "booked"; |
  | 363 | 380 | } |
  | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L367) | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L384) |  |
  | 367 | 384 | } |
  | 368 | 385 | $day\_info\_jsone = json\_encode($day\_data); |
  | 369 |  | $update\_in\_db = $wpdb->update($wpdb->prefix . 'wpdevart\_dates', array( |
  | 370 |  | 'calendar\_id' => $cal\_id, |
  | 371 |  | 'day' => $day, |
  | 372 |  | 'data' => $day\_info\_jsone, |
  | 373 |  | ), |
  | 374 |  | array('unique\_id' => $unique\_id), |
  | 375 |  | array('%d', '%s', '%s'), |
  | 376 |  | array('%s')); |
  | 377 |  |  |
  |  | 386 | $update\_in\_db = $wpdb->update( |
  |  | 387 | $wpdb->prefix . 'wpdevart\_dates', |
  |  | 388 | array( |
  |  | 389 | 'calendar\_id' => $cal\_id, |
  |  | 390 | 'day' => $day, |
  |  | 391 | 'data' => $day\_info\_jsone, |
  |  | 392 | ), |
  |  | 393 | array('unique\_id' => $unique\_id), |
  |  | 394 | array('%d', '%s', '%s'), |
  |  | 395 | array('%s') |
  |  | 396 | ); |
  | 378 | 397 | } |
  | 379 | 398 | } else { |
  | 380 |  | $unique\_id = $cal\_id~~."\_".~~$reserv\_info["single\_day"]; |
  | 381 |  | $day\_data = json\_decode($this->model->get\_date\_data(~~$unique\_id ),~~true); |
  | 382 |  | if($approve === true) { |
  | 383 |  | if($reserv\_info["end\_hour"] == "" && $reserv\_info["start\_hour"] == "") { |
  |  | 399 | $unique\_id = $cal\_id . "\_" . $reserv\_info["single\_day"]; |
  |  | 400 | $day\_data = json\_decode($this->model->get\_date\_data($unique\_id), true); |
  |  | 401 | if ($approve === true) { |
  |  | 402 | if ($reserv\_info["end\_hour"] == "" && $reserv\_info["start\_hour"] == "") { |
  | 384 | 403 | $day\_data["available"] = $day\_data["available"] - $count\_item; |
  | 385 | 404 | } else { |
  | 386 |  | if~~(isset($day\_data["hours"]))~~{ |
  | 387 |  | if($reserv\_info["end\_hour"] == "") { |
  |  | 405 | if (isset($day\_data["hours"])) { |
  |  | 406 | if ($reserv\_info["end\_hour"] == "") { |
  | 388 | 407 | $day\_data["hours"][$reserv\_info["start\_hour"]]["available"] =  $day\_data["hours"][$reserv\_info["start\_hour"]]["available"] - $count\_item; |
  | 389 |  | if($day\_data["hours"][$reserv\_info["start\_hour"]]["available"] == 0) { |
  |  | 408 | if ($day\_data["hours"][$reserv\_info["start\_hour"]]["available"] == 0) { |
  | 390 | 409 | $day\_data["hours"][$reserv\_info["start\_hour"]]["status"] = "booked"; |
  | 391 | 410 | } |
  | 392 |  | $count = 1; |
  |  | 411 | $count = 1; |
  | 393 | 412 | } else { |
  | 394 | 413 | /\*multihour here\*/ |
  | 395 |  | if(count($day\_data["hours"])) { |
  |  | 414 | if (count($day\_data["hours"])) { |
  | 396 | 415 | $start = 0; |
  | 397 |  | $count = 0; |
  | 398 |  | foreach($day\_data["hours"] as $key => $hour) { |
  | 399 |  | if($key == $reserv\_info["start\_hour"]) { |
  |  | 416 | $count = 0; |
  |  | 417 | foreach ($day\_data["hours"] as $key => $hour) { |
  |  | 418 | if ($key == $reserv\_info["start\_hour"]) { |
  | 400 | 419 | $start = 1; |
  | 401 |  | } |
  | 402 |  | if($start == 1) { |
  |  | 420 | } |
  |  | 421 | if ($start == 1) { |
  | 403 | 422 | $day\_data["hours"][$key]["available"] =  $day\_data["hours"][$key]["available"] - $count\_item; |
  | 404 | 423 | $count += 1; |
  | 405 | 424 | } |
  | 406 |  | if($key == $reserv\_info["end\_hour"]) { |
  |  | 425 | if ($key == $reserv\_info["end\_hour"]) { |
  | 407 | 426 | $start = 0; |
  | 408 | 427 | } |
  | 409 |  | if($day\_data["hours"][$key]["available"] == 0) { |
  |  | 428 | if ($day\_data["hours"][$key]["available"] == 0) { |
  | 410 | 429 | $day\_data["hours"][$key]["status"] = "booked"; |
  | 411 | 430 | } |
  | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L413) | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L432) |  |
  | 413 | 432 | } |
  | 414 | 433 | } |
  | 415 |  | $day\_data["available"] = $day\_data["available"] - ($count\_item~~\*~~$count); |
  |  | 434 | $day\_data["available"] = $day\_data["available"] - ($count\_item \* $count); |
  | 416 | 435 | } |
  | 417 |  |  |
  | 418 |  | } |
  | 419 |  | if($day\_data["available"] == 0) { |
  |  | 436 | } |
  |  | 437 | if ($day\_data["available"] == 0) { |
  | 420 | 438 | $day\_data["status"] = "booked"; |
  | 421 | 439 | } |
  | 422 | 440 | } else { |
  | 423 |  | if($reserv\_info["end\_hour"] == "" && $reserv\_info["start\_hour"] == "") { |
  |  | 441 | if ($reserv\_info["end\_hour"] == "" && $reserv\_info["start\_hour"] == "") { |
  | 424 | 442 | $day\_data["available"] = $day\_data["available"] + $count\_item; |
  | 425 | 443 | } else { |
  | 426 |  | if($reserv\_info["end\_hour"] == "") { |
  |  | 444 | if ($reserv\_info["end\_hour"] == "") { |
  | 427 | 445 | $day\_data["hours"][$reserv\_info["start\_hour"]]["available"] =  $day\_data["hours"][$reserv\_info["start\_hour"]]["available"] + $count\_item; |
  | 428 | 446 | $day\_data["hours"][$reserv\_info["start\_hour"]]["status"] = "available"; |
  | 429 |  | $count = 1; |
  |  | 447 | $count = 1; |
  | 430 | 448 | } else { |
  | 431 | 449 | /\*multihour here\*/ |
  | 432 |  | if(count($day\_data["hours"])) { |
  | 433 |  | $start = 0; |
  | 434 |  | $count = 0; |
  | 435 |  | foreach($day\_data["hours"] as $key => $hour) { |
  | 436 |  | if($key == $reserv\_info["start\_hour"]) { |
  |  | 450 | if (count($day\_data["hours"])) { |
  |  | 451 | $start = 0; |
  |  | 452 | $count = 0; |
  |  | 453 | foreach ($day\_data["hours"] as $key => $hour) { |
  |  | 454 | if ($key == $reserv\_info["start\_hour"]) { |
  | 437 | 455 | $start = 1; |
  | 438 | 456 | } |
  | 439 |  | if($start == 1) { |
  |  | 457 | if ($start == 1) { |
  | 440 | 458 | $day\_data["hours"][$key]["available"] =  $day\_data["hours"][$key]["available"] + $count\_item; |
  | 441 |  | $count += 1;if($day\_data["hours"][$key]["available"] != 0) { |
  |  | 459 | $count += 1; |
  |  | 460 | if ($day\_data["hours"][$key]["available"] != 0) { |
  | 442 | 461 | $day\_data["hours"][$key]["status"] = "available"; |
  | 443 | 462 | } |
  | 444 | 463 | } |
  | 445 |  | if($key == $reserv\_info["end\_hour"]) { |
  |  | 464 | if ($key == $reserv\_info["end\_hour"]) { |
  | 446 | 465 | $start = 0; |
  | 447 | 466 | } |
  | 448 |  |  |
  | 449 | 467 | } |
  | 450 | 468 | } |
  | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L455) | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L473) |  |
  | 455 | 473 | } |
  | 456 | 474 | $day\_info\_jsone = json\_encode($day\_data); |
  | 457 |  | $update\_in\_db = $wpdb->update($wpdb->prefix . 'wpdevart\_dates', array( |
  | 458 |  | 'calendar\_id' => $cal\_id, |
  | 459 |  | 'day' => $reserv\_info["single\_day"], |
  | 460 |  | 'data' => $day\_info\_jsone, |
  | 461 |  | ), |
  |  | 475 | $update\_in\_db = $wpdb->update( |
  |  | 476 | $wpdb->prefix . 'wpdevart\_dates', |
  |  | 477 | array( |
  |  | 478 | 'calendar\_id' => $cal\_id, |
  |  | 479 | 'day' => $reserv\_info["single\_day"], |
  |  | 480 | 'data' => $day\_info\_jsone, |
  |  | 481 | ), |
  | 462 | 482 | array('unique\_id' => $unique\_id), |
  | 463 | 483 | array('%d', '%s', '%s'), |
  | 464 |  | array('%s')); |
  | 465 |  | } |
  | 466 |  | } |
  | 467 |  |  |
  | 468 |  | private function send\_mail($res\_id, $type, $reserv\_info\_del=""){ |
  | 469 |  | if($reserv\_info\_del == "") { |
  | 470 |  | $data = $this->model->get\_reservation\_row( $res\_id ); |
  |  | 484 | array('%s') |
  |  | 485 | ); |
  |  | 486 | } |
  |  | 487 | } |
  |  | 488 |  |
  |  | 489 | private function send\_mail($res\_id, $type, $reserv\_info\_del = "") { |
  |  | 490 | if ($reserv\_info\_del == "") { |
  |  | 491 | $data = $this->model->get\_reservation\_row($res\_id); |
  | 471 | 492 | } else { |
  | 472 | 493 | $data = $reserv\_info\_del; |
  | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=2965848#L474) | […](/browser/booking-calendar/trunk/admin/controllers/Reservations.php?rev=3209851#L495) |  |
  | 474 | 495 | $theme\_rows = $this->model->get\_theme\_rows($data["calendar\_id"]); |
  | 475 | 496 | $lib = new wpdevart\_bc\_Library(); |
  | 476 |  | return $lib->send\_mail(~~$data, 'reservation', $theme\_rows, $type~~ ); |
  | 477 |  | } |
  | 478 |  |  |
  | 479 |  |  |
  | 480 |  | private function get\_date\_diff($date1, $date2) { |
  |  | 497 | return $lib->send\_mail($data, 'reservation', $theme\_rows, $type); |
  |  | 498 | } |
  |  | 499 |  |
  |  | 500 |  |
  |  | 501 | private function get\_date\_diff($date1, $date2) { |
  | 481 | 502 | $start = strtotime($date1); |
  | 482 | 503 | $end = strtotime($date2); |
  | 483 | 504 | $datediff = $start - $end; |
  | 484 |  | return floor($datediff/(60\*60\*24)); |
  | 485 |  | } |
  | 486 |  |  |
  |  | 505 | return floor($datediff / (60 \* 60 \* 24)); |
  |  | 506 | } |
  | 487 | 507 | } |
  | 488 |  |  |
  | 489 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/models/Calendars.php](/changeset/3209851/booking-calendar/trunk/admin/models/Calendars.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/models/Calendars.php")

  | [r2975927](/browser/booking-calendar/trunk/admin/models/Calendars.php?rev=2975927#L1 "Show revision 2975927 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/models/Calendars.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ModelCalendars { |
  | 3 |  | private $user\_id = 1; |
  | 4 |  | private $user\_role = ""; |
  | 5 |  | private $permission = false; |
  | 6 |  | private $no\_access = false; |
  | 7 |  |  |
  |  | 3 | private $user\_id = 1; |
  |  | 4 | private $user\_role = ""; |
  |  | 5 | private $permission = false; |
  |  | 6 | private $no\_access = false; |
  |  | 7 |  |
  | 8 | 8 | public function \_\_construct() { |
  | 9 |  | $current\_user = get\_current\_user\_id(); |
  | 10 |  | $current\_user\_info = get\_userdata( $current\_user ); |
  | 11 |  | ~~if($current\_user\_info)~~{ |
  | 12 |  | $current\_user\_info = $current\_user\_info->roles; |
  | 13 |  | } |
  | 14 |  | $role = isset($current\_user\_info[0]) ? $current\_user\_info[0] : ""; |
  | 15 |  | $this->user\_id = $current\_user; |
  | 16 |  | $this->user\_role = $role; |
  | 17 |  | $this->permission = wpdevart\_bc\_Library::page\_access('calendar\_page'); |
  | 18 |  | $pages = array( |
  | 19 |  | 'booking\_page\_wpdevart-calendars', |
  | 20 |  | 'booking\_page\_wpdevart-reservations', |
  | 21 |  | 'booking\_page\_wpdevart-forms', |
  | 22 |  | 'booking\_page\_wpdevart-extras', |
  | 23 |  | 'booking\_page\_wpdevart-themes' |
  | 24 |  | ); |
  | 25 |  | if (function\_exists('get\_current\_screen')) { |
  | 26 |  | $current\_page = get\_current\_screen(); |
  | 27 |  | $this->no\_access = $this->user\_role != "administrator" && !$this->permission && $this->user\_id !== 0 |
  | 28 |  | && is\_admin() && isset($current\_page->id) && in\_array($current\_page->id, $pages); |
  | 29 |  | } |
  | 30 |  | } |
  | 31 |  |  |
  |  | 9 | $current\_user = get\_current\_user\_id(); |
  |  | 10 | $current\_user\_info = get\_userdata($current\_user); |
  |  | 11 | if ($current\_user\_info) { |
  |  | 12 | $current\_user\_info = $current\_user\_info->roles; |
  |  | 13 | } |
  |  | 14 | $role = isset($current\_user\_info[0]) ? $current\_user\_info[0] : ""; |
  |  | 15 | $this->user\_id = $current\_user; |
  |  | 16 | $this->user\_role = $role; |
  |  | 17 | $this->permission = wpdevart\_bc\_Library::page\_access('calendar\_page'); |
  |  | 18 | $pages = array( |
  |  | 19 | 'booking\_page\_wpdevart-calendars', |
  |  | 20 | 'booking\_page\_wpdevart-reservations', |
  |  | 21 | 'booking\_page\_wpdevart-forms', |
  |  | 22 | 'booking\_page\_wpdevart-extras', |
  |  | 23 | 'booking\_page\_wpdevart-themes' |
  |  | 24 | ); |
  |  | 25 | if (function\_exists('get\_current\_screen')) { |
  |  | 26 | $current\_page = get\_current\_screen(); |
  |  | 27 | $this->no\_access = $this->user\_role != "administrator" && !$this->permission && $this->user\_id !== 0 |
  |  | 28 | && is\_admin() && isset($current\_page->id) && in\_array($current\_page->id, $pages); |
  |  | 29 | } |
  |  | 30 | } |
  |  | 31 |  |
  | 32 | 32 | public function get\_calendars\_rows() { |
  | 33 | 33 | global $wpdb; |
  | 34 |  |  |
  | 35 |  | $limit = (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page'])? (((int) $\_POST['wpdevart\_page'] - 1) \* 20) : 0; |
  |  | 34 |  |
  |  | 35 | $limit = (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) ? (((int) $\_POST['wpdevart\_page'] - 1) \* 20) : 0; |
  | 36 | 36 | $order\_by = ((isset($\_POST['order\_by']) && $\_POST['order\_by'] != "") ? sanitize\_sql\_orderby($\_POST['order\_by']) :  'id'); |
  | 37 |  | $order = ((isset($\_POST['asc\_desc']) && $\_POST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  |  | 37 | $order = ((isset($\_POST['asc\_desc']) && $\_POST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  | 38 | 38 | $order\_by = ' ORDER BY `' . $order\_by . '` ' . $order; |
  | 39 |  | if~~(isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != ''))~~{ |
  | 40 |  | ~~$like = '%' . $wpdb->esc\_like( $\_POST['search\_value']~~ ) . '%'; |
  | 41 |  | ~~if($this->no\_access)~~{ |
  | 42 |  | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE title LIKE %s AND user\_id="%d" ' . $order\_by . ' LIMIT ' . $limit . ',20', $like, $this->user\_id); |
  | 43 |  | } else { |
  | 44 |  | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE title LIKE %s ' . $order\_by . ' LIMIT ' . $limit . ',20', $like); |
  | 45 |  | } |
  |  | 39 | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  |  | 40 | $like = '%' . $wpdb->esc\_like($\_POST['search\_value']) . '%'; |
  |  | 41 | if ($this->no\_access) { |
  |  | 42 | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE title LIKE %s AND user\_id="%d" ' . $order\_by . ' LIMIT ' . $limit . ',20', $like, $this->user\_id); |
  |  | 43 | } else { |
  |  | 44 | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE title LIKE %s ' . $order\_by . ' LIMIT ' . $limit . ',20', $like); |
  |  | 45 | } |
  | 46 | 46 | } else { |
  | 47 |  | ~~if($this->no\_access)~~{ |
  | 48 |  | ~~$query = $wpdb->prepare("SELECT \* FROM " . $wpdb->prefix . "wpdevart\_calendars WHERE user\_id='%d' ".$order\_by.~~" LIMIT " . $limit . ",20", $this->user\_id); |
  | 49 |  | } else { |
  | 50 |  | ~~$query = "SELECT \* FROM " . $wpdb->prefix . "wpdevart\_calendars ".$order\_by.~~" LIMIT " . $limit . ",20"; |
  | 51 |  | } |
  |  | 47 | if ($this->no\_access) { |
  |  | 48 | $query = $wpdb->prepare("SELECT \* FROM " . $wpdb->prefix . "wpdevart\_calendars WHERE user\_id='%d' " . $order\_by . " LIMIT " . $limit . ",20", $this->user\_id); |
  |  | 49 | } else { |
  |  | 50 | $query = "SELECT \* FROM " . $wpdb->prefix . "wpdevart\_calendars " . $order\_by . " LIMIT " . $limit . ",20"; |
  |  | 51 | } |
  | 52 | 52 | } |
  | 53 | 53 | $rows = $wpdb->get\_results($query); |
  | 54 |  |  |
  |  | 54 |  |
  | 55 | 55 | return $rows; |
  | 56 |  | } |
  | 57 |  |  |
  | 58 |  | public function get\_calendar\_rows(~~$id~~ ) { |
  |  | 56 | } |
  |  | 57 |  |
  |  | 58 | public function get\_calendar\_rows($id) { |
  | 59 | 59 | global $wpdb; |
  | 60 |  | ~~if($this->no\_access)~~{ |
  | 61 |  | ~~$row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d" AND user\_id="%d"', $id, $this->user\_id),~~ARRAY\_A); |
  | 62 |  | } else { |
  | 63 |  | ~~$row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $id),~~ARRAY\_A); |
  |  | 60 | if ($this->no\_access) { |
  |  | 61 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d" AND user\_id="%d"', $id, $this->user\_id), ARRAY\_A); |
  |  | 62 | } else { |
  |  | 63 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $id), ARRAY\_A); |
  | 64 | 64 | } |
  | 65 | 65 |  |
  | […](/browser/booking-calendar/trunk/admin/models/Calendars.php?rev=2975927#L69) | […](/browser/booking-calendar/trunk/admin/models/Calendars.php?rev=3209851#L69) |  |
  | 69 | 69 | global $wpdb; |
  | 70 | 70 | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  | 71 |  | ~~$like = '%' . $wpdb->esc\_like( $\_POST['search\_value']~~ ) . '%'; |
  | 72 |  | ~~if~~($this->no\_access) { |
  | 73 |  | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ".$wpdb->prefix."wpdevart\_calendars WHERE title LIKE %s AND user\_id="%d"', $like, $this->user\_id)); |
  | 74 |  | } else { |
  | 75 |  | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ".$wpdb->prefix."wpdevart\_calendars WHERE title LIKE %s', $like)); |
  | 76 |  | } |
  |  | 71 | $like = '%' . $wpdb->esc\_like($\_POST['search\_value']) . '%'; |
  |  | 72 | if ($this->no\_access) { |
  |  | 73 | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ".$wpdb->prefix."wpdevart\_calendars WHERE title LIKE %s AND user\_id="%d"', $like, $this->user\_id)); |
  |  | 74 | } else { |
  |  | 75 | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ".$wpdb->prefix."wpdevart\_calendars WHERE title LIKE %s', $like)); |
  |  | 76 | } |
  | 77 | 77 | } else { |
  | 78 |  | ~~if~~($this->no\_access) { |
  | 79 |  | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE user\_id="%d"', $this->user\_id)); |
  | 80 |  | } else { |
  | 81 |  | $total = $wpdb->get\_var('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_calendars'); |
  | 82 |  | } |
  |  | 78 | if ($this->no\_access) { |
  |  | 79 | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE user\_id="%d"', $this->user\_id)); |
  |  | 80 | } else { |
  |  | 81 | $total = $wpdb->get\_var('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_calendars'); |
  |  | 82 | } |
  | 83 | 83 | } |
  | 84 | 84 |  |
  | […](/browser/booking-calendar/trunk/admin/models/Calendars.php?rev=2975927#L86) | […](/browser/booking-calendar/trunk/admin/models/Calendars.php?rev=3209851#L86) |  |
  | 86 | 86 | if (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) { |
  | 87 | 87 | $limit = ((int)$\_POST['wpdevart\_page'] - 1) \* 20; |
  | 88 |  | } |
  | 89 |  | else { |
  |  | 88 | } else { |
  | 90 | 89 | $limit = 0; |
  | 91 | 90 | } |
  | […](/browser/booking-calendar/trunk/admin/models/Calendars.php?rev=2975927#L94) | […](/browser/booking-calendar/trunk/admin/models/Calendars.php?rev=3209851#L93) |  |
  | 94 | 93 | } |
  | 95 | 94 |  |
  | 96 |  |  |
  | 97 |  | public function get\_ids(~~$id~~ ) { |
  |  | 95 |  |
  |  | 96 | public function get\_ids($id) { |
  | 98 | 97 | global $wpdb; |
  | 99 |  |  |
  |  | 98 |  |
  | 100 | 99 | $result = $wpdb->get\_row($wpdb->prepare('SELECT theme\_id,form\_id,extra\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $id), ARRAY\_A); |
  | 101 |  |  |
  |  | 100 |  |
  | 102 | 101 | return $result; |
  | 103 | 102 | } |
  | 104 |  |  |
  | 105 |  |  |
  | 106 |  | public function get\_db\_days(~~$id~~ ) { |
  |  | 103 |  |
  |  | 104 |  |
  |  | 105 | public function get\_db\_days($id) { |
  | 107 | 106 | global $wpdb; |
  | 108 |  | $row = $wpdb->get\_results($wpdb->prepare('SELECT unique\_id FROM ' . $wpdb->prefix . 'wpdevart\_dates WHERE calendar\_id="%d"', $id),ARRAY\_A); |
  |  | 107 | $row = $wpdb->get\_results($wpdb->prepare('SELECT unique\_id FROM ' . $wpdb->prefix . 'wpdevart\_dates WHERE calendar\_id="%d"', $id), ARRAY\_A); |
  | 109 | 108 |  |
  | 110 | 109 | return $row; |
  | 111 | 110 | } |
  | 112 |  |  |
  | 113 |  | public function get\_db\_days\_data(~~$id~~ ) { |
  |  | 111 |  |
  |  | 112 | public function get\_db\_days\_data($id) { |
  | 114 | 113 | global $wpdb; |
  | 115 |  | $row = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_dates WHERE calendar\_id="%d"', $id),ARRAY\_A); |
  |  | 114 | $row = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_dates WHERE calendar\_id="%d"', $id), ARRAY\_A); |
  | 116 | 115 |  |
  | 117 | 116 | return $row; |
  | 118 | 117 | } |
  | 119 |  |  |
  |  | 118 |  |
  | 120 | 119 | public function get\_setting\_rows() { |
  | 121 | 120 | global $wpdb; |
  | 122 | 121 |  |
  | 123 |  | ~~if($this->no\_access)~~{ |
  | 124 |  | $row = $wpdb->get\_results($wpdb->prepare('SELECT id, title FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE user\_id="%d"', $this->user\_id), ARRAY\_A); |
  | 125 |  | } else { |
  | 126 |  | $row = $wpdb->get\_results('SELECT id, title FROM ' . $wpdb->prefix . 'wpdevart\_themes', ARRAY\_A); |
  |  | 122 | if ($this->no\_access) { |
  |  | 123 | $row = $wpdb->get\_results($wpdb->prepare('SELECT id, title FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE user\_id="%d"', $this->user\_id), ARRAY\_A); |
  |  | 124 | } else { |
  |  | 125 | $row = $wpdb->get\_results('SELECT id, title FROM ' . $wpdb->prefix . 'wpdevart\_themes', ARRAY\_A); |
  | 127 | 126 | } |
  | 128 | 127 |  |
  | 129 | 128 | return $row; |
  | 130 | 129 | } |
  | 131 |  |  |
  |  | 130 |  |
  | 132 | 131 | public function get\_setting\_row($id) { |
  | 133 | 132 | global $wpdb; |
  | 134 |  | $row = $wpdb->get\_var($wpdb->prepare('SELECT value FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"',$id)); |
  |  | 133 | $row = $wpdb->get\_var($wpdb->prepare('SELECT value FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"', $id)); |
  | 135 | 134 | $theme\_info = json\_decode($row, true); |
  | 136 |  |  |
  |  | 135 |  |
  | 137 | 136 | return $theme\_info; |
  | 138 | 137 | } |
  | 139 |  |  |
  | 140 |  | public function get\_form\_rows() { |
  |  | 138 |  |
  |  | 139 | public function get\_form\_rows() { |
  | 141 | 140 | global $wpdb; |
  | 142 |  |  |
  | 143 |  | ~~if($this->no\_access)~~{ |
  | 144 |  | $row = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms  WHERE user\_id="%d"', $this->user\_id), ARRAY\_A); |
  | 145 |  | } else { |
  | 146 |  | $row = $wpdb->get\_results('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms', ARRAY\_A); |
  |  | 141 |  |
  |  | 142 | if ($this->no\_access) { |
  |  | 143 | $row = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms  WHERE user\_id="%d"', $this->user\_id), ARRAY\_A); |
  |  | 144 | } else { |
  |  | 145 | $row = $wpdb->get\_results('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms', ARRAY\_A); |
  | 147 | 146 | } |
  | 148 |  |  |
  |  | 147 |  |
  | 149 | 148 | return $row; |
  | 150 |  | } |
  | 151 |  |  |
  |  | 149 | } |
  |  | 150 |  |
  | 152 | 151 | public function get\_extra\_rows() { |
  | 153 | 152 | global $wpdb; |
  | 154 | 153 |  |
  | 155 |  | ~~if($this->no\_access)~~{ |
  | 156 |  | ~~$row = $wpdb->get\_results($wpdb->prepare('SELECT id, title FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE user\_id="%d"',~~$this->user\_id), ARRAY\_A); |
  |  | 154 | if ($this->no\_access) { |
  |  | 155 | $row = $wpdb->get\_results($wpdb->prepare('SELECT id, title FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE user\_id="%d"', $this->user\_id), ARRAY\_A); |
  | 157 | 156 | } else { |
  | 158 |  | $row = $wpdb->get\_results('SELECT id, title FROM ' . $wpdb->prefix . 'wpdevart\_extras', ARRAY\_A); |
  |  | 157 | $row = $wpdb->get\_results('SELECT id, title FROM ' . $wpdb->prefix . 'wpdevart\_extras', ARRAY\_A); |
  | 159 | 158 | } |
  | 160 | 159 | return $row; |
  | 161 | 160 | } |
  | 162 |  |  |
  | 163 |  |  |
  | 164 | 161 | } |
  | 165 |  |  |
  | 166 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/models/Extras.php](/changeset/3209851/booking-calendar/trunk/admin/models/Extras.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/models/Extras.php")

  | [r2975927](/browser/booking-calendar/trunk/admin/models/Extras.php?rev=2975927#L1 "Show revision 2975927 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/models/Extras.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ModelExtras { |
  | 3 |  | private $user\_id = 1; |
  | 4 |  | private $user\_role = ""; |
  | 5 |  | private $permission = false; |
  | 6 |  | private $no\_access = false; |
  | 7 |  |  |
  |  | 3 | private $user\_id = 1; |
  |  | 4 | private $user\_role = ""; |
  |  | 5 | private $permission = false; |
  |  | 6 | private $no\_access = false; |
  |  | 7 |  |
  | 8 | 8 | public function \_\_construct() { |
  | 9 |  | $current\_user = get\_current\_user\_id(); |
  | 10 |  | $current\_user\_info = get\_userdata( $current\_user ); |
  | 11 |  | ~~if($current\_user\_info)~~{ |
  | 12 |  | $current\_user\_info = $current\_user\_info->roles; |
  | 13 |  | } |
  | 14 |  | $role = isset($current\_user\_info[0]) ? $current\_user\_info[0] : ""; |
  | 15 |  | $this->user\_id = $current\_user; |
  | 16 |  | $this->user\_role = $role; |
  | 17 |  | $this->permission = wpdevart\_bc\_Library::page\_access('extra\_page'); |
  | 18 |  | $pages = array( |
  | 19 |  | 'booking\_page\_wpdevart-calendars', |
  | 20 |  | 'booking\_page\_wpdevart-reservations', |
  | 21 |  | 'booking\_page\_wpdevart-forms', |
  | 22 |  | 'booking\_page\_wpdevart-extras', |
  | 23 |  | 'booking\_page\_wpdevart-themes' |
  | 24 |  | ); |
  | 25 |  | if (function\_exists('get\_current\_screen')) { |
  | 26 |  | $current\_page = get\_current\_screen(); |
  | 27 |  | $this->no\_access = $this->user\_role != "administrator" && !$this->permission && $this->user\_id !== 0 |
  | 28 |  | && is\_admin() && isset($current\_page->id) && in\_array($current\_page->id, $pages); |
  | 29 |  | } |
  | 30 |  | } |
  | 31 |  |  |
  |  | 9 | $current\_user = get\_current\_user\_id(); |
  |  | 10 | $current\_user\_info = get\_userdata($current\_user); |
  |  | 11 | if ($current\_user\_info) { |
  |  | 12 | $current\_user\_info = $current\_user\_info->roles; |
  |  | 13 | } |
  |  | 14 | $role = isset($current\_user\_info[0]) ? $current\_user\_info[0] : ""; |
  |  | 15 | $this->user\_id = $current\_user; |
  |  | 16 | $this->user\_role = $role; |
  |  | 17 | $this->permission = wpdevart\_bc\_Library::page\_access('extra\_page'); |
  |  | 18 | $pages = array( |
  |  | 19 | 'booking\_page\_wpdevart-calendars', |
  |  | 20 | 'booking\_page\_wpdevart-reservations', |
  |  | 21 | 'booking\_page\_wpdevart-forms', |
  |  | 22 | 'booking\_page\_wpdevart-extras', |
  |  | 23 | 'booking\_page\_wpdevart-themes' |
  |  | 24 | ); |
  |  | 25 | if (function\_exists('get\_current\_screen')) { |
  |  | 26 | $current\_page = get\_current\_screen(); |
  |  | 27 | $this->no\_access = $this->user\_role != "administrator" && !$this->permission && $this->user\_id !== 0 |
  |  | 28 | && is\_admin() && isset($current\_page->id) && in\_array($current\_page->id, $pages); |
  |  | 29 | } |
  |  | 30 | } |
  |  | 31 |  |
  | 32 | 32 | public function get\_extras\_rows() { |
  | 33 | 33 | global $wpdb; |
  | 34 |  |  |
  | 35 |  | $limit = (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page'])? (((int) $\_POST['wpdevart\_page'] - 1) \* 20) : 0; |
  |  | 34 |  |
  |  | 35 | $limit = (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) ? (((int) $\_POST['wpdevart\_page'] - 1) \* 20) : 0; |
  | 36 | 36 | $order\_by = ((isset($\_POST['order\_by']) && $\_POST['order\_by'] != "") ? sanitize\_sql\_orderby($\_POST['order\_by']) :  'id'); |
  | 37 |  | $order = ((isset($\_POST['asc\_desc']) && $\_POST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  |  | 37 | $order = ((isset($\_POST['asc\_desc']) && $\_POST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  | 38 | 38 | $order\_by = ' ORDER BY `' . $order\_by . '` ' . $order; |
  | 39 | 39 | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  | 40 |  | ~~$like = '%' . $wpdb->esc\_like( $\_POST['search\_value']~~ ) . '%'; |
  | 41 |  | ~~if~~($this->no\_access) { |
  | 42 |  | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE title LIKE %s AND user\_id="%d" ' . $order\_by . ' LIMIT ' . $limit . ',20', $like, $this->user\_id); |
  | 43 |  | ~~} else~~{ |
  | 44 |  | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE title LIKE %s ' . $order\_by . ' LIMIT ' . $limit . ',20', $like); |
  | 45 |  | } |
  |  | 40 | $like = '%' . $wpdb->esc\_like($\_POST['search\_value']) . '%'; |
  |  | 41 | if ($this->no\_access) { |
  |  | 42 | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE title LIKE %s AND user\_id="%d" ' . $order\_by . ' LIMIT ' . $limit . ',20', $like, $this->user\_id); |
  |  | 43 | } else { |
  |  | 44 | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE title LIKE %s ' . $order\_by . ' LIMIT ' . $limit . ',20', $like); |
  |  | 45 | } |
  | 46 | 46 | } else { |
  | 47 |  | ~~if~~($this->no\_access) { |
  | 48 |  | $query = $wpdb->prepare("SELECT \* FROM " . $wpdb->prefix . "wpdevart\_extras WHERE user\_id='%d' " . $order\_by . " LIMIT " . $limit . ",20", $this->user\_id); |
  | 49 |  | } else { |
  | 50 |  | $query = "SELECT \* FROM " . $wpdb->prefix . "wpdevart\_extras  " . $order\_by . " LIMIT " . $limit . ",20"; |
  | 51 |  | } |
  |  | 47 | if ($this->no\_access) { |
  |  | 48 | $query = $wpdb->prepare("SELECT \* FROM " . $wpdb->prefix . "wpdevart\_extras WHERE user\_id='%d' " . $order\_by . " LIMIT " . $limit . ",20", $this->user\_id); |
  |  | 49 | } else { |
  |  | 50 | $query = "SELECT \* FROM " . $wpdb->prefix . "wpdevart\_extras  " . $order\_by . " LIMIT " . $limit . ",20"; |
  |  | 51 | } |
  | 52 | 52 | } |
  | 53 | 53 |  |
  | 54 | 54 | $rows = $wpdb->get\_results($query); |
  | 55 |  |  |
  |  | 55 |  |
  | 56 | 56 | return $rows; |
  | 57 |  | } |
  | 58 |  |  |
  | 59 |  | public function get\_extra\_rows(~~$id~~ ) { |
  |  | 57 | } |
  |  | 58 |  |
  |  | 59 | public function get\_extra\_rows($id) { |
  | 60 | 60 | global $wpdb; |
  | 61 |  | ~~if($this->no\_access)~~{ |
  | 62 |  | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d" AND user\_id="%d"', $id, $this->user\_id)); |
  | 63 |  | }else { |
  | 64 |  | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"', $id)); |
  |  | 61 | if ($this->no\_access) { |
  |  | 62 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d" AND user\_id="%d"', $id, $this->user\_id)); |
  |  | 63 | } else { |
  |  | 64 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"', $id)); |
  | 65 | 65 | } |
  | 66 | 66 |  |
  | 67 | 67 | return $row; |
  | 68 |  | } |
  |  | 68 | } |
  | 69 | 69 | public function items\_nav() { |
  | 70 | 70 | global $wpdb; |
  | 71 | 71 | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  | 72 |  | ~~$like = '%' . $wpdb->esc\_like( $\_POST['search\_value']~~ ) . '%'; |
  | 73 |  | ~~if~~($this->no\_access) { |
  | 74 |  | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE title LIKE %s AND user\_id="%d"', $like, $this->user\_id)); |
  | 75 |  | } else { |
  | 76 |  | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE title LIKE %s', $like)); |
  | 77 |  | } |
  |  | 72 | $like = '%' . $wpdb->esc\_like($\_POST['search\_value']) . '%'; |
  |  | 73 | if ($this->no\_access) { |
  |  | 74 | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE title LIKE %s AND user\_id="%d"', $like, $this->user\_id)); |
  |  | 75 | } else { |
  |  | 76 | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE title LIKE %s', $like)); |
  |  | 77 | } |
  | 78 | 78 | } else { |
  | 79 |  | ~~if~~($this->no\_access) { |
  | 80 |  | $total = $wpdb->get\_var($wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_extras WHERE user\_id='%d'", $this->user\_id)); |
  | 81 |  | } else { |
  | 82 |  | ~~$total = $wpdb->get\_var("SELECT COUNT(\*) FROM ".$wpdb->prefix.~~"wpdevart\_extras "); |
  | 83 |  | } |
  |  | 79 | if ($this->no\_access) { |
  |  | 80 | $total = $wpdb->get\_var($wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_extras WHERE user\_id='%d'", $this->user\_id)); |
  |  | 81 | } else { |
  |  | 82 | $total = $wpdb->get\_var("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_extras "); |
  |  | 83 | } |
  | 84 | 84 | } |
  | 85 | 85 |  |
  | […](/browser/booking-calendar/trunk/admin/models/Extras.php?rev=2975927#L87) | […](/browser/booking-calendar/trunk/admin/models/Extras.php?rev=3209851#L87) |  |
  | 87 | 87 | if (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) { |
  | 88 | 88 | $limit = ((int)$\_POST['wpdevart\_page'] - 1) \* 20; |
  | 89 |  | } |
  | 90 |  | else { |
  |  | 89 | } else { |
  | 91 | 90 | $limit = 0; |
  | 92 | 91 | } |
  | […](/browser/booking-calendar/trunk/admin/models/Extras.php?rev=2975927#L94) | […](/browser/booking-calendar/trunk/admin/models/Extras.php?rev=3209851#L93) |  |
  | 94 | 93 | return $items\_nav; |
  | 95 | 94 | } |
  | 96 |  |  |
  | 97 |  | public function check\_exists(~~$form\_id~~ ) { |
  |  | 95 |  |
  |  | 96 | public function check\_exists($form\_id) { |
  | 98 | 97 | global $wpdb; |
  | 99 |  | $exists = false; |
  | 100 |  | $rows = $wpdb->get\_results('SELECT extra\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars',ARRAY\_A); |
  | 101 |  | foreach($rows as $row) { |
  | 102 |  | if(in\_array($form\_id,$row)){ |
  | 103 |  | $exists = true; |
  | 104 |  | break; |
  | 105 |  | } |
  | 106 |  | } |
  | 107 |  |  |
  |  | 98 | $exists = false; |
  |  | 99 | $rows = $wpdb->get\_results('SELECT extra\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars', ARRAY\_A); |
  |  | 100 | foreach ($rows as $row) { |
  |  | 101 | if (in\_array($form\_id, $row)) { |
  |  | 102 | $exists = true; |
  |  | 103 | break; |
  |  | 104 | } |
  |  | 105 | } |
  | 108 | 106 | return $exists; |
  | 109 | 107 | } |
  | 110 |  |  |
  | 111 | 108 | } |
  | 112 |  |  |
  | 113 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/models/Forms.php](/changeset/3209851/booking-calendar/trunk/admin/models/Forms.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/models/Forms.php")

  | [r2975927](/browser/booking-calendar/trunk/admin/models/Forms.php?rev=2975927#L1 "Show revision 2975927 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/models/Forms.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ModelForms { |
  | 3 |  | private $user\_id = 1; |
  | 4 |  | private $user\_role = ""; |
  | 5 |  | private $permission = false; |
  | 6 |  | private $no\_access = false; |
  | 7 |  |  |
  |  | 3 | private $user\_id = 1; |
  |  | 4 | private $user\_role = ""; |
  |  | 5 | private $permission = false; |
  |  | 6 | private $no\_access = false; |
  |  | 7 |  |
  | 8 | 8 | public function \_\_construct() { |
  | 9 |  | $current\_user = get\_current\_user\_id(); |
  | 10 |  | $current\_user\_info = get\_userdata( $current\_user ); |
  | 11 |  | if($current\_user\_info){ |
  | 12 |  | $current\_user\_info = $current\_user\_info->roles; |
  | 13 |  | } |
  | 14 |  | $role = isset($current\_user\_info[0]) ? $current\_user\_info[0] : ""; |
  | 15 |  | $this->user\_id = $current\_user; |
  | 16 |  | $this->user\_role = $role; |
  | 17 |  | $this->permission = wpdevart\_bc\_Library::page\_access('form\_page'); |
  | 18 |  | $pages = array( |
  | 19 |  | 'booking\_page\_wpdevart-calendars', |
  | 20 |  | 'booking\_page\_wpdevart-reservations', |
  | 21 |  | 'booking\_page\_wpdevart-forms', |
  | 22 |  | 'booking\_page\_wpdevart-extras', |
  | 23 |  | 'booking\_page\_wpdevart-themes' |
  | 24 |  | ); |
  | 25 |  | if (function\_exists('get\_current\_screen')) { |
  | 26 |  | $current\_page = get\_current\_screen(); |
  | 27 |  | $this->no\_access = $this->user\_role != "administrator" && !$this->permission && $this->user\_id !== 0 |
  | 28 |  | && is\_admin() && isset($current\_page->id) && in\_array($current\_page->id, $pages); |
  | 29 |  | } |
  |  | 9 | $current\_user = get\_current\_user\_id(); |
  |  | 10 | $current\_user\_info = get\_userdata($current\_user); |
  |  | 11 | if ($current\_user\_info) { |
  |  | 12 | $current\_user\_info = $current\_user\_info->roles; |
  |  | 13 | } |
  |  | 14 | $role = isset($current\_user\_info[0]) ? $current\_user\_info[0] : ""; |
  |  | 15 | $this->user\_id = $current\_user; |
  |  | 16 | $this->user\_role = $role; |
  |  | 17 | $this->permission = wpdevart\_bc\_Library::page\_access('form\_page'); |
  |  | 18 | $pages = array( |
  |  | 19 | 'booking\_page\_wpdevart-calendars', |
  |  | 20 | 'booking\_page\_wpdevart-reservations', |
  |  | 21 | 'booking\_page\_wpdevart-forms', |
  |  | 22 | 'booking\_page\_wpdevart-extras', |
  |  | 23 | 'booking\_page\_wpdevart-themes' |
  |  | 24 | ); |
  |  | 25 | if (function\_exists('get\_current\_screen')) { |
  |  | 26 | $current\_page = get\_current\_screen(); |
  |  | 27 | $this->no\_access = $this->user\_role != "administrator" && !$this->permission && $this->user\_id !== 0 |
  |  | 28 | && is\_admin() && isset($current\_page->id) && in\_array($current\_page->id, $pages); |
  |  | 29 | } |
  |  | 30 | } |
  | 30 | 31 |  |
  | 31 |  | ~~}~~ |
  | 32 |  |  |
  | 33 | 32 | public function get\_forms\_rows() { |
  | 34 | 33 | global $wpdb; |
  | 35 |  |  |
  | 36 |  | $limit = (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page'])? (((int) $\_POST['wpdevart\_page'] - 1) \* 20) : 0; |
  |  | 34 |  |
  |  | 35 | $limit = (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) ? (((int) $\_POST['wpdevart\_page'] - 1) \* 20) : 0; |
  | 37 | 36 | $order\_by = ((isset($\_POST['order\_by']) && $\_POST['order\_by'] != "") ? sanitize\_sql\_orderby($\_POST['order\_by']) :  'id'); |
  | 38 |  | $order = ((isset($\_POST['asc\_desc']) && $\_POST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  |  | 37 | $order = ((isset($\_POST['asc\_desc']) && $\_POST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  | 39 | 38 | $order\_by = ' ORDER BY `' . $order\_by . '` ' . $order; |
  | 40 |  | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  | 41 |  | $like = '%' . $wpdb->esc\_like( $\_POST['search\_value'] ) . '%'; |
  | 42 |  | if($this->no\_access) { |
  | 43 |  | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE title LIKE %s AND user\_id="%d" ' . $order\_by . ' LIMIT ' . $limit . ',20', $like, $this->user\_id); |
  | 44 |  | } else{ |
  | 45 |  | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE title LIKE %s ' . $order\_by . ' LIMIT ' . $limit . ',20', $like); |
  | 46 |  | } |
  |  | 39 | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  |  | 40 | $like = '%' . $wpdb->esc\_like($\_POST['search\_value']) . '%'; |
  |  | 41 | if ($this->no\_access) { |
  |  | 42 | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE title LIKE %s AND user\_id="%d" ' . $order\_by . ' LIMIT ' . $limit . ',20', $like, $this->user\_id); |
  | 47 | 43 | } else { |
  | 48 |  | if($this->no\_access) { |
  | 49 |  | $query = $wpdb->prepare("SELECT \* FROM " . $wpdb->prefix . "wpdevart\_forms WHERE user\_id='%d' " . $order\_by . " LIMIT " . $limit . ",20", $this->user\_id); |
  | 50 |  | } else { |
  | 51 |  | $query = "SELECT \* FROM " . $wpdb->prefix . "wpdevart\_forms  " . $order\_by . " LIMIT " . $limit . ",20"; |
  | 52 |  | } |
  |  | 44 | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE title LIKE %s ' . $order\_by . ' LIMIT ' . $limit . ',20', $like); |
  | 53 | 45 | } |
  |  | 46 | } else { |
  |  | 47 | if ($this->no\_access) { |
  |  | 48 | $query = $wpdb->prepare("SELECT \* FROM " . $wpdb->prefix . "wpdevart\_forms WHERE user\_id='%d' " . $order\_by . " LIMIT " . $limit . ",20", $this->user\_id); |
  |  | 49 | } else { |
  |  | 50 | $query = "SELECT \* FROM " . $wpdb->prefix . "wpdevart\_forms  " . $order\_by . " LIMIT " . $limit . ",20"; |
  |  | 51 | } |
  |  | 52 | } |
  | 54 | 53 | $rows = $wpdb->get\_results($query); |
  | 55 |  |  |
  |  | 54 |  |
  | 56 | 55 | return $rows; |
  | 57 |  | } |
  | 58 |  |  |
  | 59 |  | public function get\_form\_rows(~~$id~~ ) { |
  |  | 56 | } |
  |  | 57 |  |
  |  | 58 | public function get\_form\_rows($id) { |
  | 60 | 59 | global $wpdb; |
  | 61 |  | ~~if($this->no\_access)~~{ |
  | 62 |  | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d" AND user\_id="%d"', $id, $this->user\_id)); |
  | 63 |  | ~~}~~ else { |
  | 64 |  | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $id)); |
  | 65 |  | } |
  |  | 60 | if ($this->no\_access) { |
  |  | 61 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d" AND user\_id="%d"', $id, $this->user\_id)); |
  |  | 62 | } else { |
  |  | 63 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $id)); |
  |  | 64 | } |
  | 66 | 65 |  |
  | 67 | 66 | return $row; |
  | 68 |  | } |
  |  | 67 | } |
  | 69 | 68 |  |
  | 70 |  | /\*############  Item navigation function ################\*/ |
  | 71 |  |  |
  |  | 69 | /\*############  Item navigation function ################\*/ |
  |  | 70 |  |
  | 72 | 71 | public function items\_nav() { |
  | 73 | 72 | global $wpdb; |
  | 74 |  | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  | 75 |  | $like = '%' . $wpdb->esc\_like( $\_POST['search\_value'] ) . '%'; |
  | 76 |  | if($this->no\_access) { |
  | 77 |  | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE title LIKE %s AND user\_id="%d"', $like, $this->user\_id)); |
  | 78 |  | } else { |
  | 79 |  | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE title LIKE %s', $like)); |
  | 80 |  | } |
  |  | 73 | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  |  | 74 | $like = '%' . $wpdb->esc\_like($\_POST['search\_value']) . '%'; |
  |  | 75 | if ($this->no\_access) { |
  |  | 76 | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE title LIKE %s AND user\_id="%d"', $like, $this->user\_id)); |
  | 81 | 77 | } else { |
  | 82 |  | if($this->no\_access) { |
  | 83 |  | $total = $wpdb->get\_var($wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_forms WHERE user\_id='%d'", $this->user\_id)); |
  | 84 |  | } else { |
  | 85 |  | $total = $wpdb->get\_var("SELECT COUNT(\*) FROM ".$wpdb->prefix."wpdevart\_forms "); |
  | 86 |  | } |
  |  | 78 | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE title LIKE %s', $like)); |
  | 87 | 79 | } |
  |  | 80 | } else { |
  |  | 81 | if ($this->no\_access) { |
  |  | 82 | $total = $wpdb->get\_var($wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_forms WHERE user\_id='%d'", $this->user\_id)); |
  |  | 83 | } else { |
  |  | 84 | $total = $wpdb->get\_var("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_forms "); |
  |  | 85 | } |
  |  | 86 | } |
  | 88 | 87 |  |
  | 89 | 88 | $items\_nav['total'] = $total; |
  | 90 | 89 | if (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) { |
  | 91 | 90 | $limit = ((int)$\_POST['wpdevart\_page'] - 1) \* 20; |
  | 92 |  | } |
  | 93 |  | else { |
  |  | 91 | } else { |
  | 94 | 92 | $limit = 0; |
  | 95 | 93 | } |
  | […](/browser/booking-calendar/trunk/admin/models/Forms.php?rev=2975927#L97) | […](/browser/booking-calendar/trunk/admin/models/Forms.php?rev=3209851#L95) |  |
  | 97 | 95 | return $items\_nav; |
  | 98 | 96 | } |
  | 99 |  |  |
  | 100 |  | public function check\_exists(~~$form\_id~~ ) { |
  |  | 97 |  |
  |  | 98 | public function check\_exists($form\_id) { |
  | 101 | 99 | global $wpdb; |
  | 102 |  | $exists = false; |
  | 103 |  | $rows = $wpdb->get\_results('SELECT form\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars',ARRAY\_A); |
  | 104 |  | foreach($rows as $row) { |
  | 105 |  | if(in\_array($form\_id,$row)){ |
  | 106 |  | $exists = true; |
  | 107 |  | break; |
  | 108 |  | } |
  | 109 |  | } |
  | 110 |  |  |
  |  | 100 | $exists = false; |
  |  | 101 | $rows = $wpdb->get\_results('SELECT form\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars', ARRAY\_A); |
  |  | 102 | foreach ($rows as $row) { |
  |  | 103 | if (in\_array($form\_id, $row)) { |
  |  | 104 | $exists = true; |
  |  | 105 | break; |
  |  | 106 | } |
  |  | 107 | } |
  | 111 | 108 | return $exists; |
  | 112 | 109 | } |
  | 113 |  |  |
  | 114 | 110 | } |
  | 115 |  |  |
  | 116 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/models/GlobalSettings.php](/changeset/3209851/booking-calendar/trunk/admin/models/GlobalSettings.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/models/GlobalSettings.php")

  | [r2965848](/browser/booking-calendar/trunk/admin/models/GlobalSettings.php?rev=2965848#L5 "Show revision 2965848 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/models/GlobalSettings.php?rev=3209851#L5 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | return $settings; |
  | 6 | 6 | } |
  | 7 |  |  |
  | 8 | 7 | } |
  | 9 |  |  |
  | 10 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/models/Payment.php](/changeset/3209851/booking-calendar/trunk/admin/models/Payment.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/models/Payment.php")

  | [r1970407](/browser/booking-calendar/trunk/admin/models/Payment.php?rev=1970407#L1 "Show revision 1970407 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/models/Payment.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ModelPayments { |
  | 3 |  |  |
  | 4 |  | public function get\_payment( $res\_id ) { |
  | 5 |  | global $wpdb; |
  | 6 |  | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_payments WHERE    res\_id="%d"', $res\_id),ARRAY\_A); |
  | 7 |  |  |
  | 8 |  | return $row; |
  | 9 |  | } |
  | 10 |  | public function get\_reservation\_row( $id ) { |
  | 11 |  | global $wpdb; |
  | 12 |  | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_reservations WHERE id="%d"', $id),ARRAY\_A); |
  | 13 |  |  |
  | 14 |  | return $row; |
  | 15 |  | } |
  | 16 |  |  |
  | 17 |  | /\*############  Settings row function ################\*/ |
  | 18 |  |  |
  | 19 |  | public function get\_setting\_rows( $id ) { |
  | 20 |  | global $wpdb; |
  | 21 |  | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"', $id)); |
  | 22 |  | if($row) { |
  | 23 |  | $theme\_option = json\_decode($row->value, true); |
  | 24 |  | } else { |
  | 25 |  | $theme\_option = array(); |
  |  | 3 |  |
  |  | 4 | public function get\_payment($res\_id) { |
  |  | 5 | global $wpdb; |
  |  | 6 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_payments WHERE    res\_id="%d"', $res\_id), ARRAY\_A); |
  |  | 7 | return $row; |
  | 26 | 8 | } |
  | 27 |  | return $theme\_option; |
  | 28 |  | } |
  | 29 |  |  |
  | 30 |  | /\*############  Form data function ################\*/ |
  | 31 |  |  |
  | 32 |  | public function get\_form\_data($form,$cal\_id) { |
  |  | 9 | public function get\_reservation\_row($id) { |
  | 33 | 10 | global $wpdb; |
  | 34 |  | if($form) { |
  |  | 11 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_reservations WHERE id="%d"', $id), ARRAY\_A); |
  |  | 12 | return $row; |
  |  | 13 | } |
  |  | 14 |  |
  |  | 15 | /\*############  Settings row function ################\*/ |
  |  | 16 |  |
  |  | 17 | public function get\_setting\_rows($id) { |
  |  | 18 | global $wpdb; |
  |  | 19 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"', $id)); |
  |  | 20 | if ($row) { |
  |  | 21 | $theme\_option = json\_decode($row->value, true); |
  |  | 22 | } else { |
  |  | 23 | $theme\_option = array(); |
  |  | 24 | } |
  |  | 25 | return $theme\_option; |
  |  | 26 | } |
  |  | 27 |  |
  |  | 28 | /\*############  Form data function ################\*/ |
  |  | 29 |  |
  |  | 30 | public function get\_form\_data($form, $cal\_id) { |
  |  | 31 | global $wpdb; |
  |  | 32 | if ($form) { |
  | 35 | 33 | $form\_value = json\_decode($form, true); |
  | 36 | 34 | $form\_id = $wpdb->get\_var($wpdb->prepare('SELECT form\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  | 37 | 35 | $form\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $form\_id)); |
  | 38 | 36 | $form\_info = json\_decode($form\_info, true); |
  | 39 |  | if~~(isset($form\_info['apply']) || isset($form\_info['save']))~~ { |
  |  | 37 | if (isset($form\_info['apply']) || isset($form\_info['save'])) { |
  | 40 | 38 | array\_shift($form\_info); |
  | 41 | 39 | } |
  | 42 |  | foreach($form\_info as $key=>$form\_fild\_info) { |
  | 43 |  | if(isset($form\_value["wpdevart\_".$key])) { |
  | 44 |  | $form\_info[$key]["value"] = $form\_value["wpdevart\_".$key]; |
  | 45 |  | } |
  | 46 |  | else { |
  |  | 40 | foreach ($form\_info as $key => $form\_fild\_info) { |
  |  | 41 | if (isset($form\_value["wpdevart\_" . $key])) { |
  |  | 42 | $form\_info[$key]["value"] = $form\_value["wpdevart\_" . $key]; |
  |  | 43 | } else { |
  | 47 | 44 | $form\_info[$key]["value"] = ""; |
  | 48 | 45 | } |
  | […](/browser/booking-calendar/trunk/admin/models/Payment.php?rev=1970407#L52) | […](/browser/booking-calendar/trunk/admin/models/Payment.php?rev=3209851#L49) |  |
  | 52 | 49 | } |
  | 53 | 50 | return $form\_info; |
  | 54 |  | } |
  | 55 |  |  |
  | 56 |  | public function get\_extra\_data($extra,~~$price,~~$cal\_id) { |
  |  | 51 | } |
  |  | 52 |  |
  |  | 53 | public function get\_extra\_data($extra, $price, $cal\_id) { |
  | 57 | 54 | global $wpdb; |
  | 58 |  | if($price !== false) { |
  |  | 55 | if ($price !== false) { |
  | 59 | 56 | $price = $price; |
  | 60 | 57 | $extra = $extra; |
  | 61 |  | } else { |
  |  | 58 | } else { |
  | 62 | 59 | $price = $extra["price"]; |
  | 63 | 60 | $extra = $extra["extras"]; |
  | 64 | 61 | } |
  | 65 |  | if($extra) { |
  |  | 62 | if ($extra) { |
  | 66 | 63 | $extras\_value = json\_decode($extra, true); |
  | 67 | 64 | $extra\_id = $wpdb->get\_var($wpdb->prepare('SELECT extra\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  | 68 | 65 | $extra\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"', $extra\_id)); |
  | 69 | 66 | $extra\_info = json\_decode($extra\_info, true); |
  | 70 |  |  |
  | 71 |  | if(isset($extra\_info['apply']) || isset($extra\_info['save']))   { |
  |  | 67 | if (isset($extra\_info['apply']) || isset($extra\_info['save'])) { |
  | 72 | 68 | array\_shift($extra\_info); |
  | 73 | 69 | } |
  | 74 |  | foreach~~($extras\_value as $key=>$extra\_value) {~~ |
  | 75 |  | if(isset($extra\_info[$key])) { |
  |  | 70 | foreach ($extras\_value as $key => $extra\_value) { |
  |  | 71 | if (isset($extra\_info[$key])) { |
  | 76 | 72 | $extras\_value[$key]["group\_label"] = $extra\_info[$key]["label"]; |
  | 77 |  | if($extra\_value['price\_type'] == "percent") { |
  | 78 |  | $extras\_value[$key]["price"] = ($price~~\*$extra\_value['price\_percent'])/~~100; |
  |  | 73 | if ($extra\_value['price\_type'] == "percent") { |
  |  | 74 | $extras\_value[$key]["price"] = ($price \* $extra\_value['price\_percent']) / 100; |
  | 79 | 75 | } else { |
  | 80 | 76 | $extras\_value[$key]["price"] = $extra\_value['price\_percent']; |
  | 81 | 77 | } |
  | 82 |  | } |
  | 83 |  | else { |
  |  | 78 | } else { |
  | 84 | 79 | $extras\_value[$key]["group\_label"] = ""; |
  | 85 | 80 | } |
  | […](/browser/booking-calendar/trunk/admin/models/Payment.php?rev=1970407#L89) | […](/browser/booking-calendar/trunk/admin/models/Payment.php?rev=3209851#L84) |  |
  | 89 | 84 | } |
  | 90 | 85 | return $extras\_value; |
  | 91 |  | } |
  | 92 |  |  |
  |  | 86 | } |
  |  | 87 |  |
  | 93 | 88 | public function get\_calendar\_title($cal\_id) { |
  | 94 | 89 | global $wpdb; |
  | 95 | 90 | $row = $wpdb->get\_var($wpdb->prepare('SELECT title FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  | 96 |  |  |
  | 97 | 91 | return $row; |
  | 98 |  | } |
  | 99 |  |  |
  |  | 92 | } |
  | 100 | 93 | } |
  | 101 |  |  |
  | 102 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/models/Reservations.php](/changeset/3209851/booking-calendar/trunk/admin/models/Reservations.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/models/Reservations.php")

  | [r2969905](/browser/booking-calendar/trunk/admin/models/Reservations.php?rev=2969905#L1 "Show revision 2969905 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/models/Reservations.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ModelReservations { |
  | 3 |  | private $user\_id = 1; |
  | 4 |  | private $user\_role = ""; |
  | 5 |  | private $permission = false; |
  | 6 |  |  |
  | 7 |  | public function \_\_construct() { |
  | 8 |  | $current\_user = get\_current\_user\_id(); |
  | 9 |  | $current\_user\_info = get\_userdata( $current\_user ); |
  | 10 |  | if($current\_user\_info){ |
  | 11 |  | $current\_user\_info = $current\_user\_info->roles; |
  | 12 |  | } |
  | 13 |  | $role = isset($current\_user\_info[0]) ? $current\_user\_info[0] : ""; |
  | 14 |  | $this->user\_id = $current\_user; |
  | 15 |  | $this->user\_role = $role; |
  | 16 |  | $this->permission = wpdevart\_bc\_Library::page\_access('calendar\_page'); |
  | 17 |  | } |
  | 18 |  | /\*############  Reservations rows function ################\*/ |
  | 19 |  |  |
  | 20 |  | public function get\_reservations\_rows($id,$type = "OBJECT") { |
  | 21 |  | if ( isset($\_POST['apply\_filter']) && (! isset( $\_POST['\_wpdevart\_bc\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpdevart\_bc\_nonce'], 'action\_item' ) )) { |
  | 22 |  | die('Sorry, your nonce did not verify.'); |
  | 23 |  | } |
  | 24 |  | global $wpdb; |
  | 25 |  | $id = (int) $id; |
  | 26 |  | $calendar\_id = (int) wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  | 27 |  | $where = array(); |
  | 28 |  | $limit = (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page'])? (((int) $\_POST['wpdevart\_page'] - 1) \* 20) : 0; |
  | 29 |  | $reserv\_order\_by = ((isset($\_POST['order\_by']) && $\_POST['order\_by'] != "") ? sanitize\_sql\_orderby($\_POST['order\_by']) :  'id'); |
  | 30 |  | $reserv\_order = ((isset($\_POST['asc\_desc']) && $\_POST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  | 31 |  | $reserv\_order\_by = ' ORDER BY `' . $reserv\_order\_by . '` ' . $reserv\_order; |
  | 32 |  | if($calendar\_id !== 0) |
  | 33 |  | $where[] = ' calendar\_id=' . $calendar\_id; |
  | 34 |  | if($id != 0) { |
  | 35 |  | $where[] = ' id= '.$id.''; |
  | 36 |  | } |
  | 37 |  | $where = implode(" AND ",$where); |
  | 38 |  | if($where != '') { |
  | 39 |  | $\_where = "WHERE ". $where; |
  | 40 |  | $where = $\_where . " AND "; |
  | 41 |  | } else { |
  | 42 |  | $\_where = ""; |
  | 43 |  | $where = "WHERE "; |
  | 44 |  | } |
  | 45 |  |  |
  | 46 |  | if(isset($\_POST['reserv\_status']) && count($\_POST['reserv\_status']) != ''){ |
  | 47 |  | $reserv\_status = implode("','",$\_POST['reserv\_status']); |
  | 48 |  | if((isset($\_POST["reserv\_period\_start"]) && $\_POST["reserv\_period\_start"] != '') && (isset($\_POST["reserv\_period\_end"]) && $\_POST["reserv\_period\_end"] != '')) { |
  | 49 |  | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  | 50 |  | $like = '%' . $wpdb->esc\_like( $\_POST['wpdevart\_serch'] ) . '%'; |
  | 51 |  | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s " . $reserv\_order\_by . " LIMIT " . $limit . ",20", $reserv\_status, $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $like); |
  | 52 |  | } else { |
  | 53 |  | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') " . $reserv\_order\_by . " LIMIT " . $limit . ",20", $reserv\_status, $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"]); |
  | 54 |  | } |
  | 55 |  | } else { |
  | 56 |  | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  | 57 |  | $like = '%' . $wpdb->esc\_like( $\_POST['wpdevart\_serch'] ) . '%'; |
  | 58 |  | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " status IN ('%s') AND form LIKE %s " . $reserv\_order\_by . " LIMIT " . $limit . ",20", $reserv\_status, $like); |
  | 59 |  | } else { |
  | 60 |  | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " status IN ('%s') " . $reserv\_order\_by . " LIMIT " . $limit . ",20", $reserv\_status); |
  | 61 |  | } |
  | 62 |  | } |
  | 63 |  | } else { |
  | 64 |  | if((isset($\_POST["reserv\_period\_start"]) && $\_POST["reserv\_period\_start"] != '') && (isset($\_POST["reserv\_period\_end"]) && $\_POST["reserv\_period\_end"] != '')) { |
  | 65 |  | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  | 66 |  | $like = '%' . $wpdb->esc\_like( $\_POST['wpdevart\_serch'] ) . '%'; |
  | 67 |  | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s " . $reserv\_order\_by . " LIMIT " . $limit . ",20",  $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $like); |
  | 68 |  | } else { |
  | 69 |  | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') " . $reserv\_order\_by . " LIMIT " . $limit . ",20",  $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"]); |
  | 70 |  | } |
  | 71 |  | } else { |
  | 72 |  | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  | 73 |  | $like = '%' . $wpdb->esc\_like( $\_POST['wpdevart\_serch'] ) . '%'; |
  | 74 |  | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " form LIKE %s " . $reserv\_order\_by . " LIMIT " . $limit . ",20", $like); |
  | 75 |  | } else { |
  | 76 |  | $query = "SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $\_where . " " . $reserv\_order\_by . " LIMIT " . $limit . ",20"; |
  | 77 |  | } |
  | 78 |  | } |
  | 79 |  | } |
  | 80 |  |  |
  | 81 |  | $rows = $wpdb->get\_results($query, $type); |
  | 82 |  |  |
  | 83 |  | return $rows; |
  | 84 |  | } |
  | 85 |  |  |
  | 86 |  | public function get\_reservations\_for\_export() { |
  | 87 |  | global $wpdb; |
  | 88 |  | $select\_columns = 'id, calendar\_id, single\_day, check\_in, check\_out, start\_hour, end\_hour, count\_item, price, total\_price, extras\_price, status, payment\_method, payment\_status, date\_created,form, extras'; |
  | 89 |  | $reserv\_order\_by = ((isset($\_REQUEST['order\_by']) && $\_REQUEST['order\_by'] != "") ? sanitize\_sql\_orderby($\_REQUEST['order\_by']) :  'id'); |
  | 90 |  | $reserv\_order = ((isset($\_REQUEST['asc\_desc']) && $\_REQUEST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  | 91 |  | $reserv\_order\_by = ' ORDER BY `' . $reserv\_order\_by . '` ' . $reserv\_order; |
  | 92 |  | $limit = (isset($\_REQUEST['wpdevart\_page']) && $\_REQUEST['wpdevart\_page'] && $\_REQUEST['all\_pages'] == 0)? " LIMIT " . (((int) $\_REQUEST['wpdevart\_page'] - 1) \* 20) . ',20' : ''; |
  | 93 |  | $calendar\_id = (int) wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  | 94 |  | if($calendar\_id !== 0) { |
  | 95 |  | $\_where = 'WHERE calendar\_id=' . $calendar\_id; |
  | 96 |  | $where = $\_where . ' AND '; |
  | 97 |  | } else { |
  | 98 |  | $\_where = ''; |
  | 99 |  | $where = ''; |
  | 100 |  | } |
  | 101 |  | if(isset($\_REQUEST['reserv\_status']) && $\_REQUEST['reserv\_status'] != ""){ |
  | 102 |  | $reserv\_status = json\_decode(stripslashes($\_REQUEST['reserv\_status']),true); |
  | 103 |  | if(count($reserv\_status)) { |
  | 104 |  | $reserv\_status = implode("','",$reserv\_status); |
  | 105 |  | if((isset($\_REQUEST["reserv\_period\_start"]) && ($\_REQUEST["reserv\_period\_start"] != '')) && (isset($\_REQUEST["reserv\_period\_end"]) && ($\_REQUEST["reserv\_period\_end"] != ''))) { |
  | 106 |  | if (isset($\_REQUEST['wpdevart\_serch']) && ($\_REQUEST['wpdevart\_serch'] != '')) { |
  | 107 |  | $like = '%' . $wpdb->esc\_like( $\_REQUEST['wpdevart\_serch'] ) . '%'; |
  | 108 |  | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s " . $reserv\_order\_by . $limit, $reserv\_status, $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $like); |
  | 109 |  | } else { |
  | 110 |  | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') " . $reserv\_order\_by . $limit, $reserv\_status, $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"]); |
  | 111 |  | } |
  | 112 |  | } else { |
  | 113 |  | if (isset($\_REQUEST['wpdevart\_serch']) && ($\_REQUEST['wpdevart\_serch'] != '')) { |
  | 114 |  | $like = '%' . $wpdb->esc\_like( $\_REQUEST['wpdevart\_serch'] ) . '%'; |
  | 115 |  | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " status IN ('%s') AND form LIKE %s " . $reserv\_order\_by . $limit, $reserv\_status, $like); |
  | 116 |  | } else { |
  | 117 |  | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " status IN ('%s') " . $reserv\_order\_by . $limit, $reserv\_status); |
  | 118 |  | } |
  | 119 |  | } |
  | 120 |  | } else { |
  | 121 |  | if((isset($\_REQUEST["reserv\_period\_start"]) && ($\_REQUEST["reserv\_period\_start"] != '')) && (isset($\_REQUEST["reserv\_period\_end"]) && ($\_REQUEST["reserv\_period\_end"] != ''))) { |
  | 122 |  | if (isset($\_REQUEST['wpdevart\_serch']) && ($\_REQUEST['wpdevart\_serch'] != '')) { |
  | 123 |  | $like = '%' . $wpdb->esc\_like( $\_REQUEST['wpdevart\_serch'] ) . '%'; |
  | 124 |  | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s " . $reserv\_order\_by . $limit, $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $like); |
  | 125 |  | } else { |
  | 126 |  | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') " . $reserv\_order\_by . $limit,  $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"]); |
  | 127 |  | } |
  | 128 |  | } else { |
  | 129 |  | if (isset($\_REQUEST['wpdevart\_serch']) && ($\_REQUEST['wpdevart\_serch'] != '')) { |
  | 130 |  | $like = '%' . $wpdb->esc\_like( $\_POST['wpdevart\_serch'] ) . '%'; |
  | 131 |  | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " form LIKE %s " . $reserv\_order\_by . $limit,  $like); |
  | 132 |  | } else { |
  | 133 |  | $query = "SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $\_where . " " . $reserv\_order\_by . $limit; |
  | 134 |  | } |
  | 135 |  | } |
  | 136 |  | } |
  | 137 |  | } |
  | 138 |  |  |
  | 139 |  | $rows = $wpdb->get\_results($query, ARRAY\_A); |
  | 140 |  | return $rows; |
  | 141 |  | } |
  | 142 |  |  |
  | 143 |  | /\*############  Items navigation function ################\*/ |
  | 144 |  | public function items\_nav($id = 0) { |
  | 145 |  | global $wpdb; |
  | 146 |  | $id = (int) $id; |
  | 147 |  | $calendar\_id = (int) wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  | 148 |  | $where = array(); |
  | 149 |  | if($calendar\_id != 0) |
  | 150 |  | $where[] = ' calendar\_id=' . $calendar\_id; |
  | 151 |  | if($id != 0) |
  | 152 |  | $where[] = ' id= '.$id.''; |
  | 153 |  |  |
  | 154 |  | $where = implode(" AND ",$where); |
  | 155 |  | if($where != '') { |
  | 156 |  | $\_where = "WHERE ". $where; |
  | 157 |  | $where = $\_where . " AND "; |
  | 158 |  | } else { |
  | 159 |  | $\_where = ""; |
  | 160 |  | $where = "WHERE "; |
  | 161 |  | } |
  | 162 |  |  |
  | 163 |  | if(isset($\_POST['reserv\_status']) && count($\_POST['reserv\_status']) != 0){ |
  | 164 |  | $reserv\_status = implode("','",$\_POST['reserv\_status']); |
  | 165 |  | if((isset($\_POST["reserv\_period\_start"]) && $\_POST["reserv\_period\_start"] != '') && (isset($\_POST["reserv\_period\_end"]) && $\_POST["reserv\_period\_end"] != '')) { |
  | 166 |  | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  | 167 |  | $like = '%' . $wpdb->esc\_like( $\_POST['wpdevart\_serch'] ) . '%'; |
  | 168 |  | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . "  status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s", $reserv\_status, $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $like); |
  | 169 |  | } else { |
  | 170 |  | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . "  status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s')", $reserv\_status, $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"]); |
  | 171 |  | } |
  | 172 |  | } else { |
  | 173 |  | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  | 174 |  | $like = '%' . $wpdb->esc\_like( $\_POST['wpdevart\_serch'] ) . '%'; |
  | 175 |  | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . "  status IN ('%s') AND form LIKE %s", $reserv\_status, $like); |
  | 176 |  | } else { |
  | 177 |  | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . "  status IN ('%s')", $reserv\_status); |
  | 178 |  | } |
  | 179 |  | } |
  | 180 |  | } else { |
  | 181 |  | if((isset($\_POST["reserv\_period\_start"]) && $\_POST["reserv\_period\_start"] != '') && (isset($\_POST["reserv\_period\_end"]) && $\_POST["reserv\_period\_end"] != '')) { |
  | 182 |  | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  | 183 |  | $like = '%' . $wpdb->esc\_like( $\_POST['wpdevart\_serch'] ) . '%'; |
  | 184 |  | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s", $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $like); |
  | 185 |  | } else { |
  | 186 |  | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s')", $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"]); |
  | 187 |  | } |
  | 188 |  | } else { |
  | 189 |  | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  | 190 |  | $like = '%' . $wpdb->esc\_like( $\_POST['wpdevart\_serch'] ) . '%'; |
  | 191 |  | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " form LIKE %s", $like); |
  | 192 |  | } else { |
  | 193 |  | $query = "SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $\_where; |
  | 194 |  | } |
  | 195 |  | } |
  | 196 |  | } |
  | 197 |  |  |
  | 198 |  | $total = $wpdb->get\_var($query); |
  | 199 |  | $items\_nav['total'] = $total; |
  | 200 |  |  |
  | 201 |  | if (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) { |
  | 202 |  | $limit = ((int)$\_POST['wpdevart\_page'] - 1) \* 20; |
  | 203 |  | } |
  | 204 |  | else { |
  | 205 |  | $limit = 0; |
  | 206 |  | } |
  | 207 |  | $items\_nav['limit'] = (int)($limit / 20 + 1); |
  | 208 |  | return $items\_nav; |
  | 209 |  | } |
  | 210 |  |  |
  | 211 |  | public function get\_form\_data($form,$id = 0,$extra\_form\_id = 0,$type = "") { |
  | 212 |  | global $wpdb; |
  | 213 |  | $calendar\_id = wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  | 214 |  | if($form) { |
  | 215 |  | $form\_value = json\_decode($form, true); |
  | 216 |  | $cal\_id = 0; |
  | 217 |  | if($id == 0){ |
  | 218 |  | if(sanitize\_text\_field($calendar\_id) != 0) |
  | 219 |  | $cal\_id = $calendar\_id; |
  | 220 |  | } else { |
  | 221 |  | $cal\_id = $id; |
  | 222 |  | } |
  | 223 |  | if($extra\_form\_id == 0){ |
  | 224 |  | $form\_id = $wpdb->get\_var($wpdb->prepare('SELECT form\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  | 225 |  | } else { |
  | 226 |  | $form\_id = $extra\_form\_id; |
  | 227 |  | } |
  | 228 |  | $form\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $form\_id)); |
  | 229 |  | if($form\_info) { |
  |  | 3 | private $user\_id = 1; |
  |  | 4 | private $user\_role = ""; |
  |  | 5 | private $permission = false; |
  |  | 6 |  |
  |  | 7 | public function \_\_construct() { |
  |  | 8 | $current\_user = get\_current\_user\_id(); |
  |  | 9 | $current\_user\_info = get\_userdata($current\_user); |
  |  | 10 | if ($current\_user\_info) { |
  |  | 11 | $current\_user\_info = $current\_user\_info->roles; |
  |  | 12 | } |
  |  | 13 | $role = isset($current\_user\_info[0]) ? $current\_user\_info[0] : ""; |
  |  | 14 | $this->user\_id = $current\_user; |
  |  | 15 | $this->user\_role = $role; |
  |  | 16 | $this->permission = wpdevart\_bc\_Library::page\_access('calendar\_page'); |
  |  | 17 | } |
  |  | 18 | /\*############  Reservations rows function ################\*/ |
  |  | 19 |  |
  |  | 20 | public function get\_reservations\_rows($id, $type = "OBJECT") { |
  |  | 21 | if (isset($\_POST['apply\_filter']) && (! isset($\_POST['\_wpdevart\_bc\_nonce']) || ! wp\_verify\_nonce($\_POST['\_wpdevart\_bc\_nonce'], 'action\_item'))) { |
  |  | 22 | die('Sorry, your nonce did not verify.'); |
  |  | 23 | } |
  |  | 24 | global $wpdb; |
  |  | 25 | $id = (int) $id; |
  |  | 26 | $calendar\_id = (int) wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  |  | 27 | $where = array(); |
  |  | 28 | $limit = (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) ? (((int) $\_POST['wpdevart\_page'] - 1) \* 20) : 0; |
  |  | 29 | $reserv\_order\_by = ((isset($\_POST['order\_by']) && $\_POST['order\_by'] != "") ? sanitize\_sql\_orderby($\_POST['order\_by']) :  'id'); |
  |  | 30 | $reserv\_order = ((isset($\_POST['asc\_desc']) && $\_POST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  |  | 31 | $reserv\_order\_by = ' ORDER BY `' . $reserv\_order\_by . '` ' . $reserv\_order; |
  |  | 32 | if ($calendar\_id !== 0) |
  |  | 33 | $where[] = ' calendar\_id=' . $calendar\_id; |
  |  | 34 | if ($id != 0) { |
  |  | 35 | $where[] = ' id= ' . $id . ''; |
  |  | 36 | } |
  |  | 37 | $where = implode(" AND ", $where); |
  |  | 38 | if ($where != '') { |
  |  | 39 | $\_where = "WHERE " . $where; |
  |  | 40 | $where = $\_where . " AND "; |
  |  | 41 | } else { |
  |  | 42 | $\_where = ""; |
  |  | 43 | $where = "WHERE "; |
  |  | 44 | } |
  |  | 45 |  |
  |  | 46 | if (isset($\_POST['reserv\_status']) && count($\_POST['reserv\_status']) != '') { |
  |  | 47 | $reserv\_status = implode("','", $\_POST['reserv\_status']); |
  |  | 48 | if ((isset($\_POST["reserv\_period\_start"]) && $\_POST["reserv\_period\_start"] != '') && (isset($\_POST["reserv\_period\_end"]) && $\_POST["reserv\_period\_end"] != '')) { |
  |  | 49 | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  |  | 50 | $like = '%' . $wpdb->esc\_like($\_POST['wpdevart\_serch']) . '%'; |
  |  | 51 | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s " . $reserv\_order\_by . " LIMIT " . $limit . ",20", $reserv\_status, $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $like); |
  |  | 52 | } else { |
  |  | 53 | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') " . $reserv\_order\_by . " LIMIT " . $limit . ",20", $reserv\_status, $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"]); |
  |  | 54 | } |
  |  | 55 | } else { |
  |  | 56 | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  |  | 57 | $like = '%' . $wpdb->esc\_like($\_POST['wpdevart\_serch']) . '%'; |
  |  | 58 | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " status IN ('%s') AND form LIKE %s " . $reserv\_order\_by . " LIMIT " . $limit . ",20", $reserv\_status, $like); |
  |  | 59 | } else { |
  |  | 60 | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " status IN ('%s') " . $reserv\_order\_by . " LIMIT " . $limit . ",20", $reserv\_status); |
  |  | 61 | } |
  |  | 62 | } |
  |  | 63 | } else { |
  |  | 64 | if ((isset($\_POST["reserv\_period\_start"]) && $\_POST["reserv\_period\_start"] != '') && (isset($\_POST["reserv\_period\_end"]) && $\_POST["reserv\_period\_end"] != '')) { |
  |  | 65 | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  |  | 66 | $like = '%' . $wpdb->esc\_like($\_POST['wpdevart\_serch']) . '%'; |
  |  | 67 | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s " . $reserv\_order\_by . " LIMIT " . $limit . ",20",  $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $like); |
  |  | 68 | } else { |
  |  | 69 | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') " . $reserv\_order\_by . " LIMIT " . $limit . ",20",  $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"]); |
  |  | 70 | } |
  |  | 71 | } else { |
  |  | 72 | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  |  | 73 | $like = '%' . $wpdb->esc\_like($\_POST['wpdevart\_serch']) . '%'; |
  |  | 74 | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $where . " form LIKE %s " . $reserv\_order\_by . " LIMIT " . $limit . ",20", $like); |
  |  | 75 | } else { |
  |  | 76 | $query = "SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id " . $\_where . " " . $reserv\_order\_by . " LIMIT " . $limit . ",20"; |
  |  | 77 | } |
  |  | 78 | } |
  |  | 79 | } |
  |  | 80 | $rows = $wpdb->get\_results($query, $type); |
  |  | 81 | return $rows; |
  |  | 82 | } |
  |  | 83 |  |
  |  | 84 | public function get\_reservations\_for\_export() { |
  |  | 85 | global $wpdb; |
  |  | 86 | $select\_columns = 'id, calendar\_id, single\_day, check\_in, check\_out, start\_hour, end\_hour, count\_item, price, total\_price, extras\_price, status, payment\_method, payment\_status, date\_created,form, extras'; |
  |  | 87 | $reserv\_order\_by = ((isset($\_REQUEST['order\_by']) && $\_REQUEST['order\_by'] != "") ? sanitize\_sql\_orderby($\_REQUEST['order\_by']) :  'id'); |
  |  | 88 | $reserv\_order = ((isset($\_REQUEST['asc\_desc']) && $\_REQUEST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  |  | 89 | $reserv\_order\_by = ' ORDER BY `' . $reserv\_order\_by . '` ' . $reserv\_order; |
  |  | 90 | $limit = (isset($\_REQUEST['wpdevart\_page']) && $\_REQUEST['wpdevart\_page'] && $\_REQUEST['all\_pages'] == 0) ? " LIMIT " . (((int) $\_REQUEST['wpdevart\_page'] - 1) \* 20) . ',20' : ''; |
  |  | 91 | $calendar\_id = (int) wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  |  | 92 | if ($calendar\_id !== 0) { |
  |  | 93 | $\_where = 'WHERE calendar\_id=' . $calendar\_id; |
  |  | 94 | $where = $\_where . ' AND '; |
  |  | 95 | } else { |
  |  | 96 | $\_where = ''; |
  |  | 97 | $where = ''; |
  |  | 98 | } |
  |  | 99 | if (isset($\_REQUEST['reserv\_status']) && $\_REQUEST['reserv\_status'] != "") { |
  |  | 100 | $reserv\_status = json\_decode(stripslashes($\_REQUEST['reserv\_status']), true); |
  |  | 101 | if (count($reserv\_status)) { |
  |  | 102 | $reserv\_status = implode("','", $reserv\_status); |
  |  | 103 | if ((isset($\_REQUEST["reserv\_period\_start"]) && ($\_REQUEST["reserv\_period\_start"] != '')) && (isset($\_REQUEST["reserv\_period\_end"]) && ($\_REQUEST["reserv\_period\_end"] != ''))) { |
  |  | 104 | if (isset($\_REQUEST['wpdevart\_serch']) && ($\_REQUEST['wpdevart\_serch'] != '')) { |
  |  | 105 | $like = '%' . $wpdb->esc\_like($\_REQUEST['wpdevart\_serch']) . '%'; |
  |  | 106 | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s " . $reserv\_order\_by . $limit, $reserv\_status, $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $like); |
  |  | 107 | } else { |
  |  | 108 | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') " . $reserv\_order\_by . $limit, $reserv\_status, $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"]); |
  |  | 109 | } |
  |  | 110 | } else { |
  |  | 111 | if (isset($\_REQUEST['wpdevart\_serch']) && ($\_REQUEST['wpdevart\_serch'] != '')) { |
  |  | 112 | $like = '%' . $wpdb->esc\_like($\_REQUEST['wpdevart\_serch']) . '%'; |
  |  | 113 | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " status IN ('%s') AND form LIKE %s " . $reserv\_order\_by . $limit, $reserv\_status, $like); |
  |  | 114 | } else { |
  |  | 115 | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " status IN ('%s') " . $reserv\_order\_by . $limit, $reserv\_status); |
  |  | 116 | } |
  |  | 117 | } |
  |  | 118 | } else { |
  |  | 119 | if ((isset($\_REQUEST["reserv\_period\_start"]) && ($\_REQUEST["reserv\_period\_start"] != '')) && (isset($\_REQUEST["reserv\_period\_end"]) && ($\_REQUEST["reserv\_period\_end"] != ''))) { |
  |  | 120 | if (isset($\_REQUEST['wpdevart\_serch']) && ($\_REQUEST['wpdevart\_serch'] != '')) { |
  |  | 121 | $like = '%' . $wpdb->esc\_like($\_REQUEST['wpdevart\_serch']) . '%'; |
  |  | 122 | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s " . $reserv\_order\_by . $limit, $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $like); |
  |  | 123 | } else { |
  |  | 124 | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') " . $reserv\_order\_by . $limit,  $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"], $\_REQUEST["reserv\_period\_start"], $\_REQUEST["reserv\_period\_end"]); |
  |  | 125 | } |
  |  | 126 | } else { |
  |  | 127 | if (isset($\_REQUEST['wpdevart\_serch']) && ($\_REQUEST['wpdevart\_serch'] != '')) { |
  |  | 128 | $like = '%' . $wpdb->esc\_like($\_POST['wpdevart\_serch']) . '%'; |
  |  | 129 | $query = $wpdb->prepare("SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " form LIKE %s " . $reserv\_order\_by . $limit,  $like); |
  |  | 130 | } else { |
  |  | 131 | $query = "SELECT " . $select\_columns . "  FROM " . $wpdb->prefix . "wpdevart\_reservations " . $\_where . " " . $reserv\_order\_by . $limit; |
  |  | 132 | } |
  |  | 133 | } |
  |  | 134 | } |
  |  | 135 | } |
  |  | 136 |  |
  |  | 137 | $rows = $wpdb->get\_results($query, ARRAY\_A); |
  |  | 138 | return $rows; |
  |  | 139 | } |
  |  | 140 |  |
  |  | 141 | /\*############  Items navigation function ################\*/ |
  |  | 142 | public function items\_nav($id = 0) { |
  |  | 143 | global $wpdb; |
  |  | 144 | $id = (int) $id; |
  |  | 145 | $calendar\_id = (int) wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  |  | 146 | $where = array(); |
  |  | 147 | if ($calendar\_id != 0) |
  |  | 148 | $where[] = ' calendar\_id=' . $calendar\_id; |
  |  | 149 | if ($id != 0) |
  |  | 150 | $where[] = ' id= ' . $id . ''; |
  |  | 151 |  |
  |  | 152 | $where = implode(" AND ", $where); |
  |  | 153 | if ($where != '') { |
  |  | 154 | $\_where = "WHERE " . $where; |
  |  | 155 | $where = $\_where . " AND "; |
  |  | 156 | } else { |
  |  | 157 | $\_where = ""; |
  |  | 158 | $where = "WHERE "; |
  |  | 159 | } |
  |  | 160 |  |
  |  | 161 | if (isset($\_POST['reserv\_status']) && count($\_POST['reserv\_status']) != 0) { |
  |  | 162 | $reserv\_status = implode("','", $\_POST['reserv\_status']); |
  |  | 163 | if ((isset($\_POST["reserv\_period\_start"]) && $\_POST["reserv\_period\_start"] != '') && (isset($\_POST["reserv\_period\_end"]) && $\_POST["reserv\_period\_end"] != '')) { |
  |  | 164 | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  |  | 165 | $like = '%' . $wpdb->esc\_like($\_POST['wpdevart\_serch']) . '%'; |
  |  | 166 | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . "  status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s", $reserv\_status, $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $like); |
  |  | 167 | } else { |
  |  | 168 | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . "  status IN ('%s') AND  (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s')", $reserv\_status, $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"]); |
  |  | 169 | } |
  |  | 170 | } else { |
  |  | 171 | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  |  | 172 | $like = '%' . $wpdb->esc\_like($\_POST['wpdevart\_serch']) . '%'; |
  |  | 173 | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . "  status IN ('%s') AND form LIKE %s", $reserv\_status, $like); |
  |  | 174 | } else { |
  |  | 175 | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . "  status IN ('%s')", $reserv\_status); |
  |  | 176 | } |
  |  | 177 | } |
  |  | 178 | } else { |
  |  | 179 | if ((isset($\_POST["reserv\_period\_start"]) && $\_POST["reserv\_period\_start"] != '') && (isset($\_POST["reserv\_period\_end"]) && $\_POST["reserv\_period\_end"] != '')) { |
  |  | 180 | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  |  | 181 | $like = '%' . $wpdb->esc\_like($\_POST['wpdevart\_serch']) . '%'; |
  |  | 182 | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s') AND form LIKE %s", $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $like); |
  |  | 183 | } else { |
  |  | 184 | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " (single\_day BETWEEN '%s' AND '%s' OR check\_in BETWEEN '%s' AND '%s')", $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"], $\_POST["reserv\_period\_start"], $\_POST["reserv\_period\_end"]); |
  |  | 185 | } |
  |  | 186 | } else { |
  |  | 187 | if (isset($\_POST['wpdevart\_serch']) && $\_POST['wpdevart\_serch'] != '') { |
  |  | 188 | $like = '%' . $wpdb->esc\_like($\_POST['wpdevart\_serch']) . '%'; |
  |  | 189 | $query = $wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $where . " form LIKE %s", $like); |
  |  | 190 | } else { |
  |  | 191 | $query = "SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_reservations " . $\_where; |
  |  | 192 | } |
  |  | 193 | } |
  |  | 194 | } |
  |  | 195 |  |
  |  | 196 | $total = $wpdb->get\_var($query); |
  |  | 197 | $items\_nav['total'] = $total; |
  |  | 198 | if (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) { |
  |  | 199 | $limit = ((int)$\_POST['wpdevart\_page'] - 1) \* 20; |
  |  | 200 | } else { |
  |  | 201 | $limit = 0; |
  |  | 202 | } |
  |  | 203 | $items\_nav['limit'] = (int)($limit / 20 + 1); |
  |  | 204 | return $items\_nav; |
  |  | 205 | } |
  |  | 206 |  |
  |  | 207 | public function get\_form\_data($form, $id = 0, $extra\_form\_id = 0, $type = "") { |
  |  | 208 | global $wpdb; |
  |  | 209 | $calendar\_id = wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  |  | 210 | if ($form) { |
  |  | 211 | $form\_value = json\_decode($form, true); |
  |  | 212 | $cal\_id = 0; |
  |  | 213 | if ($id == 0) { |
  |  | 214 | if (sanitize\_text\_field($calendar\_id) != 0) |
  |  | 215 | $cal\_id = $calendar\_id; |
  |  | 216 | } else { |
  |  | 217 | $cal\_id = $id; |
  |  | 218 | } |
  |  | 219 | if ($extra\_form\_id == 0) { |
  |  | 220 | $form\_id = $wpdb->get\_var($wpdb->prepare('SELECT form\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  |  | 221 | } else { |
  |  | 222 | $form\_id = $extra\_form\_id; |
  |  | 223 | } |
  |  | 224 | $form\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $form\_id)); |
  |  | 225 | if ($form\_info) { |
  |  | 226 | $form\_info = json\_decode($form\_info, true); |
  |  | 227 | if (isset($form\_info['apply']) || isset($form\_info['save'])) { |
  |  | 228 | array\_shift($form\_info); |
  |  | 229 | } |
  |  | 230 | foreach ($form\_info as $key => $form\_fild\_info) { |
  |  | 231 | if (isset($form\_value["wpdevart\_" . $type . $key])) { |
  |  | 232 | $form\_info[$key]["value"] = $form\_value["wpdevart\_" . $type . $key]; |
  |  | 233 | } else { |
  |  | 234 | $form\_info[$key]["value"] = ""; |
  |  | 235 | } |
  |  | 236 | } |
  |  | 237 | } else { |
  |  | 238 | $form\_info = array(); |
  |  | 239 | } |
  |  | 240 | } else { |
  |  | 241 | $form\_info = array(); |
  |  | 242 | } |
  |  | 243 | return $form\_info; |
  |  | 244 | } |
  |  | 245 |  |
  |  | 246 | public function get\_form\_data\_new($reservations, $form\_info, $type = "") { |
  |  | 247 | if ($form\_info) { |
  | 230 | 248 | $form\_info = json\_decode($form\_info, true); |
  | 231 |  | if~~(isset($form\_info['apply']) || isset($form\_info['save']))~~ { |
  |  | 249 | if (isset($form\_info['apply']) || isset($form\_info['save'])) { |
  | 232 | 250 | array\_shift($form\_info); |
  | 233 | 251 | } |
  | 234 |  | foreach($form\_info as $key=>$form\_fild\_info) { |
  | 235 |  | if(isset($form\_value["wpdevart\_".$type.$key])) { |
  | 236 |  | $form\_info[$key]["value"] = $form\_value["wpdevart\_".$type.$key]; |
  | 237 |  | } |
  | 238 |  | else { |
  | 239 |  | $form\_info[$key]["value"] = ""; |
  | 240 |  | } |
  | 241 |  | } |
  | 242 |  | } else { |
  | 243 |  | $form\_info = array(); |
  | 244 |  | } |
  | 245 |  | } else { |
  | 246 |  | $form\_info = array(); |
  | 247 |  | } |
  | 248 |  | return $form\_info; |
  | 249 |  | } |
  | 250 |  |  |
  | 251 |  | public function get\_form\_data\_new($reservations,$form\_info,$type = "") { |
  | 252 |  |  |
  | 253 |  | if($form\_info) { |
  | 254 |  | $form\_info = json\_decode($form\_info, true); |
  | 255 |  | if(isset($form\_info['apply']) || isset($form\_info['save'])) { |
  | 256 |  | array\_shift($form\_info); |
  | 257 |  | } |
  | 258 |  | foreach($reservations as $key=>$reservation){ |
  | 259 |  | if(trim($reservations[$key]["extras"]) == "[]"){ |
  | 260 |  | unset($reservations[$key]["extras"]); |
  | 261 |  | } |
  | 262 |  | if($reservation["form"]) { |
  | 263 |  | $form\_value = json\_decode($reservation["form"], true); |
  | 264 |  | foreach($form\_info as $k=>$form\_fild\_info) { |
  | 265 |  | if(isset($form\_value["wpdevart\_".$type.$k])) { |
  | 266 |  | $reservations[$key][$k] = $form\_value["wpdevart\_".$type.$k]; |
  | 267 |  | } |
  | 268 |  | else { |
  | 269 |  | $reservations[$key][$k] = ""; |
  | 270 |  | } |
  | 271 |  | } |
  | 272 |  | } else { |
  | 273 |  | $reservations[$key] = ""; |
  | 274 |  | } |
  | 275 |  | unset($reservations[$key]["form"]); |
  | 276 |  | } |
  | 277 |  | } |
  | 278 |  | return $reservations; |
  | 279 |  | } |
  | 280 |  |  |
  | 281 |  | public function get\_extra\_data\_new($reservations,$extra\_info,$currency) { |
  | 282 |  | if($extra\_info){ |
  | 283 |  | $extra\_info = json\_decode($extra\_info, true); |
  | 284 |  | if(isset($extra\_info['apply']) || isset($extra\_info['save']))   { |
  | 285 |  | array\_shift($extra\_info); |
  | 286 |  | } |
  | 287 |  | foreach($reservations as $key=>$reservation) { |
  | 288 |  | if(isset($reservation["extras"])) { |
  | 289 |  | if ($reservation["extras"]) { |
  | 290 |  | $extras\_value = json\_decode($reservation["extras"], true); |
  | 291 |  | foreach ($extras\_value as $k => $extra\_value) { |
  | 292 |  | if (isset($extra\_info[$k])) { |
  | 293 |  | if ($extra\_value['price\_type'] == "percent") { |
  | 294 |  | $reservations[$key][$k] = $extra\_value["label"] . " " . $extra\_value['operation'] . (($reservation["price"] \* $extra\_value['price\_percent']) / 100) . html\_entity\_decode($currency); |
  | 295 |  | } else { |
  | 296 |  | $reservations[$key][$k] = $extra\_value["label"] . " " . $extra\_value['operation'] . $extra\_value['price\_percent'] . html\_entity\_decode($currency); |
  |  | 252 | foreach ($reservations as $key => $reservation) { |
  |  | 253 | if (trim($reservations[$key]["extras"]) == "[]") { |
  |  | 254 | unset($reservations[$key]["extras"]); |
  |  | 255 | } |
  |  | 256 | if ($reservation["form"]) { |
  |  | 257 | $form\_value = json\_decode($reservation["form"], true); |
  |  | 258 | foreach ($form\_info as $k => $form\_fild\_info) { |
  |  | 259 | if (isset($form\_value["wpdevart\_" . $type . $k])) { |
  |  | 260 | $reservations[$key][$k] = $form\_value["wpdevart\_" . $type . $k]; |
  |  | 261 | } else { |
  |  | 262 | $reservations[$key][$k] = ""; |
  |  | 263 | } |
  |  | 264 | } |
  |  | 265 | } else { |
  |  | 266 | $reservations[$key] = ""; |
  |  | 267 | } |
  |  | 268 | unset($reservations[$key]["form"]); |
  |  | 269 | } |
  |  | 270 | } |
  |  | 271 | return $reservations; |
  |  | 272 | } |
  |  | 273 |  |
  |  | 274 | public function get\_extra\_data\_new($reservations, $extra\_info, $currency) { |
  |  | 275 | if ($extra\_info) { |
  |  | 276 | $extra\_info = json\_decode($extra\_info, true); |
  |  | 277 | if (isset($extra\_info['apply']) || isset($extra\_info['save'])) { |
  |  | 278 | array\_shift($extra\_info); |
  |  | 279 | } |
  |  | 280 | foreach ($reservations as $key => $reservation) { |
  |  | 281 | if (isset($reservation["extras"])) { |
  |  | 282 | if ($reservation["extras"]) { |
  |  | 283 | $extras\_value = json\_decode($reservation["extras"], true); |
  |  | 284 | foreach ($extras\_value as $k => $extra\_value) { |
  |  | 285 | if (isset($extra\_info[$k])) { |
  |  | 286 | if ($extra\_value['price\_type'] == "percent") { |
  |  | 287 | $reservations[$key][$k] = $extra\_value["label"] . " " . $extra\_value['operation'] . (($reservation["price"] \* $extra\_value['price\_percent']) / 100) . html\_entity\_decode($currency); |
  |  | 288 | } else { |
  |  | 289 | $reservations[$key][$k] = $extra\_value["label"] . " " . $extra\_value['operation'] . $extra\_value['price\_percent'] . html\_entity\_decode($currency); |
  |  | 290 | } |
  | 297 | 291 | } |
  | 298 | 292 | } |
  | 299 |  | } |
  | 300 |  | } else { |
  | 301 |  | $reservations[$key] = ""; |
  | 302 |  | } |
  | 303 |  | unset($reservations[$key]["extras"]); |
  | 304 |  | } |
  | 305 |  | } |
  | 306 |  | } |
  | 307 |  | return $reservations; |
  | 308 |  | } |
  | 309 |  |  |
  | 310 |  | public function get\_labels($info) { |
  | 311 |  | $lables = array(); |
  | 312 |  | if($info) { |
  | 313 |  | $info = json\_decode($info, true); |
  | 314 |  | if(isset($info['apply']) || isset($info['save']))   { |
  | 315 |  | array\_shift($info); |
  | 316 |  | } |
  | 317 |  | foreach($info as $key=>$fild\_info) { |
  | 318 |  | $lables[$key] = $fild\_info["label"]; |
  | 319 |  | } |
  | 320 |  | } |
  | 321 |  | return $lables; |
  | 322 |  | } |
  | 323 |  |  |
  | 324 |  |  |
  | 325 |  | public function get\_extra\_data($extras,$mail="",$price=0,$id=0) { |
  | 326 |  | global $wpdb; |
  | 327 |  | $calendar\_id = wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  | 328 |  | if($mail == "mail") { |
  | 329 |  | $extra = $extras; |
  | 330 |  | $price = $price; |
  | 331 |  | } elseif($mail == "front") { |
  | 332 |  | $extra = $extras["extras"]; |
  | 333 |  | $price = $extras["price"]; |
  | 334 |  | } else { |
  | 335 |  | $extra = $extras->extras; |
  | 336 |  | $price = $extras->price; |
  | 337 |  | } |
  | 338 |  | if($extra) { |
  | 339 |  | $extras\_value = json\_decode($extra, true); |
  |  | 293 | } else { |
  |  | 294 | $reservations[$key] = ""; |
  |  | 295 | } |
  |  | 296 | unset($reservations[$key]["extras"]); |
  |  | 297 | } |
  |  | 298 | } |
  |  | 299 | } |
  |  | 300 | return $reservations; |
  |  | 301 | } |
  |  | 302 |  |
  |  | 303 | public function get\_labels($info) { |
  |  | 304 | $lables = array(); |
  |  | 305 | if ($info) { |
  |  | 306 | $info = json\_decode($info, true); |
  |  | 307 | if (isset($info['apply']) || isset($info['save'])) { |
  |  | 308 | array\_shift($info); |
  |  | 309 | } |
  |  | 310 | foreach ($info as $key => $fild\_info) { |
  |  | 311 | $lables[$key] = $fild\_info["label"]; |
  |  | 312 | } |
  |  | 313 | } |
  |  | 314 | return $lables; |
  |  | 315 | } |
  |  | 316 |  |
  |  | 317 |  |
  |  | 318 | public function get\_extra\_data($extras, $mail = "", $price = 0, $id = 0) { |
  |  | 319 | global $wpdb; |
  |  | 320 | $calendar\_id = wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  |  | 321 | if ($mail == "mail") { |
  |  | 322 | $extra = $extras; |
  |  | 323 | $price = $price; |
  |  | 324 | } elseif ($mail == "front") { |
  |  | 325 | $extra = $extras["extras"]; |
  |  | 326 | $price = $extras["price"]; |
  |  | 327 | } else { |
  |  | 328 | $extra = $extras->extras; |
  |  | 329 | $price = $extras->price; |
  |  | 330 | } |
  |  | 331 | if ($extra) { |
  |  | 332 | $extras\_value = json\_decode($extra, true); |
  |  | 333 | $cal\_id = 0; |
  |  | 334 | if ($id == 0) { |
  |  | 335 | if (sanitize\_text\_field($calendar\_id) != 0) |
  |  | 336 | $cal\_id = $calendar\_id; |
  |  | 337 | } else { |
  |  | 338 | $cal\_id = $id; |
  |  | 339 | } |
  |  | 340 | $extra\_id = $wpdb->get\_var($wpdb->prepare('SELECT extra\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  |  | 341 | $extra\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"', $extra\_id)); |
  |  | 342 | $extra\_info = json\_decode($extra\_info, true); |
  |  | 343 | if (isset($extra\_info['apply']) || isset($extra\_info['save'])) { |
  |  | 344 | array\_shift($extra\_info); |
  |  | 345 | } |
  |  | 346 | foreach ($extras\_value as $key => $extra\_value) { |
  |  | 347 | if (isset($extra\_info[$key])) { |
  |  | 348 | $extras\_value[$key]["group\_label"] = $extra\_info[$key]["label"]; |
  |  | 349 | if ($extra\_value['price\_type'] == "percent") { |
  |  | 350 | $extras\_value[$key]["price"] = ($price \* $extra\_value['price\_percent']) / 100; |
  |  | 351 | } else { |
  |  | 352 | $extras\_value[$key]["price"] = $extra\_value['price\_percent']; |
  |  | 353 | } |
  |  | 354 | } else { |
  |  | 355 | $extras\_value[$key]["group\_label"] = ""; |
  |  | 356 | } |
  |  | 357 | } |
  |  | 358 | } else { |
  |  | 359 | $extras\_value = array(); |
  |  | 360 | } |
  |  | 361 | return $extras\_value; |
  |  | 362 | } |
  |  | 363 |  |
  |  | 364 | public function get\_calendar\_rows() { |
  |  | 365 | global $wpdb; |
  |  | 366 | if ($this->user\_role != "administrator" && !$this->permission) { |
  |  | 367 | $row = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE user\_id="%d"', $this->user\_id), ARRAY\_A); |
  |  | 368 | } else { |
  |  | 369 | $row = $wpdb->get\_results('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars', ARRAY\_A); |
  |  | 370 | } |
  |  | 371 | return $row; |
  |  | 372 | } |
  |  | 373 |  |
  |  | 374 | public function get\_reservation\_row($id) { |
  |  | 375 | global $wpdb; |
  |  | 376 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_reservations WHERE id="%d"', $id), ARRAY\_A); |
  |  | 377 |  |
  |  | 378 | return $row; |
  |  | 379 | } |
  |  | 380 |  |
  |  | 381 | public function get\_new\_res($id, $days\_for\_new) { |
  |  | 382 | global $wpdb; |
  |  | 383 | $today = self::get\_now(); |
  |  | 384 | if ($id != 0) { |
  |  | 385 | $ress = $wpdb->get\_results($wpdb->prepare('SELECT id,date\_created FROM ' . $wpdb->prefix . 'wpdevart\_reservations  WHERE calendar\_id="%d" AND is\_new=1', $id), ARRAY\_A); |
  |  | 386 | foreach ($ress as $res) { |
  |  | 387 | $date\_diff = abs($this->get\_date\_diff($res["date\_created"], $today)); |
  |  | 388 | if ($date\_diff > $days\_for\_new) { |
  |  | 389 | $wpdb->update( |
  |  | 390 | $wpdb->prefix . 'wpdevart\_reservations', |
  |  | 391 | array('is\_new' => 0), |
  |  | 392 | array('id' => $res["id"]), |
  |  | 393 | array('%d'), |
  |  | 394 | array('%d') |
  |  | 395 | ); |
  |  | 396 | } |
  |  | 397 | } |
  |  | 398 | } else { |
  |  | 399 | $ress = $wpdb->get\_results('SELECT id,calendar\_id,date\_created FROM ' . $wpdb->prefix . 'wpdevart\_reservations  WHERE is\_new=1', ARRAY\_A); |
  |  | 400 | foreach ($ress as $res) { |
  |  | 401 | $date\_diff = abs($this->get\_date\_diff($res["date\_created"], $today)); |
  |  | 402 | if ($date\_diff > $days\_for\_new[$res['calendar\_id']]) { |
  |  | 403 | $wpdb->update( |
  |  | 404 | $wpdb->prefix . 'wpdevart\_reservations', |
  |  | 405 | array('is\_new' => 0), |
  |  | 406 | array('id' => $res["id"]), |
  |  | 407 | array('%d'), |
  |  | 408 | array('%d') |
  |  | 409 | ); |
  |  | 410 | } |
  |  | 411 | } |
  |  | 412 | } |
  |  | 413 |  |
  |  | 414 | if ($id != 0) { |
  |  | 415 | $count = $wpdb->get\_row($wpdb->prepare('SELECT ' . $wpdb->prefix . 'wpdevart\_calendars.title,COUNT(' . $wpdb->prefix . 'wpdevart\_reservations.id) AS countRes FROM ' . $wpdb->prefix . 'wpdevart\_reservations LEFT JOIN ' . $wpdb->prefix . 'wpdevart\_calendars ON ' . $wpdb->prefix . 'wpdevart\_reservations.calendar\_id=' . $wpdb->prefix . 'wpdevart\_calendars.id WHERE ' . $wpdb->prefix . 'wpdevart\_reservations.is\_new=1 AND calendar\_id="%d" GROUP BY title', $id), ARRAY\_A); |
  |  | 416 | $count = array($count); |
  |  | 417 | } else { |
  |  | 418 | $count = $wpdb->get\_results('SELECT ' . $wpdb->prefix . 'wpdevart\_calendars.title,COUNT(' . $wpdb->prefix . 'wpdevart\_reservations.id) AS countRes FROM ' . $wpdb->prefix . 'wpdevart\_reservations LEFT JOIN ' . $wpdb->prefix . 'wpdevart\_calendars ON ' . $wpdb->prefix . 'wpdevart\_reservations.calendar\_id=' . $wpdb->prefix . 'wpdevart\_calendars.id WHERE ' . $wpdb->prefix . 'wpdevart\_reservations.is\_new=1 GROUP BY title', ARRAY\_A); |
  |  | 419 | } |
  |  | 420 |  |
  |  | 421 | return $count; |
  |  | 422 | } |
  |  | 423 |  |
  |  | 424 | public function get\_date\_data($unique\_id) { |
  |  | 425 | global $wpdb; |
  |  | 426 | $date\_info = ""; |
  |  | 427 | $row = $wpdb->get\_row($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_dates WHERE unique\_id="%s"', $unique\_id), ARRAY\_A); |
  |  | 428 | if (is\_array($row) &&  isset($row["data"])) |
  |  | 429 | $date\_info = $row["data"]; |
  |  | 430 | return $date\_info; |
  |  | 431 | } |
  |  | 432 |  |
  |  | 433 | public function get\_theme\_rows($id = 0) { |
  |  | 434 | global $wpdb; |
  |  | 435 | $calendar\_id = wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  | 340 | 436 | $cal\_id = 0; |
  | 341 |  | if~~($id == 0)~~{ |
  | 342 |  | if(sanitize\_text\_field($calendar\_id) != 0) |
  |  | 437 | if ($id == 0) { |
  |  | 438 | if (sanitize\_text\_field($calendar\_id) != 0) |
  | 343 | 439 | $cal\_id = $calendar\_id; |
  | 344 | 440 | } else { |
  | 345 | 441 | $cal\_id = $id; |
  | 346 | 442 | } |
  | 347 |  | $extra\_id = $wpdb->get\_var($wpdb->prepare('SELECT extra\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  | 348 |  | $extra\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_extras WHERE id="%d"', $extra\_id)); |
  | 349 |  | $extra\_info = json\_decode($extra\_info, true); |
  | 350 |  | if(isset($extra\_info['apply']) || isset($extra\_info['save']))   { |
  | 351 |  | array\_shift($extra\_info); |
  | 352 |  | } |
  | 353 |  | foreach($extras\_value as $key=>$extra\_value) { |
  | 354 |  | if(isset($extra\_info[$key])) { |
  | 355 |  | $extras\_value[$key]["group\_label"] = $extra\_info[$key]["label"]; |
  | 356 |  | if($extra\_value['price\_type'] == "percent") { |
  | 357 |  | $extras\_value[$key]["price"] = ($price\*$extra\_value['price\_percent'])/100; |
  | 358 |  | } else { |
  | 359 |  | $extras\_value[$key]["price"] = $extra\_value['price\_percent']; |
  | 360 |  | } |
  | 361 |  | } |
  | 362 |  | else { |
  | 363 |  | $extras\_value[$key]["group\_label"] = ""; |
  | 364 |  | } |
  | 365 |  | } |
  | 366 |  | } else { |
  | 367 |  | $extras\_value = array(); |
  | 368 |  | } |
  | 369 |  | return $extras\_value; |
  | 370 |  | } |
  | 371 |  |  |
  | 372 |  | public function get\_calendar\_rows() { |
  | 373 |  | global $wpdb; |
  | 374 |  | if($this->user\_role != "administrator" && !$this->permission){ |
  | 375 |  | $row = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE user\_id="%d"', $this->user\_id), ARRAY\_A); |
  | 376 |  | } else { |
  | 377 |  | $row = $wpdb->get\_results('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_calendars', ARRAY\_A); |
  | 378 |  | } |
  | 379 |  | return $row; |
  | 380 |  | } |
  | 381 |  |  |
  | 382 |  | public function get\_reservation\_row( $id ) { |
  | 383 |  | global $wpdb; |
  | 384 |  | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_reservations WHERE id="%d"', $id),ARRAY\_A); |
  | 385 |  |  |
  | 386 |  | return $row; |
  | 387 |  | } |
  | 388 |  |  |
  | 389 |  | public function get\_new\_res( $id, $days\_for\_new ) { |
  | 390 |  | global $wpdb; |
  | 391 |  | $today = self::get\_now(); |
  | 392 |  | if($id != 0){ |
  | 393 |  | $ress = $wpdb->get\_results($wpdb->prepare('SELECT id,date\_created FROM ' . $wpdb->prefix . 'wpdevart\_reservations  WHERE calendar\_id="%d" AND is\_new=1', $id),ARRAY\_A); |
  | 394 |  | foreach($ress as $res) { |
  | 395 |  | $date\_diff = abs($this->get\_date\_diff($res["date\_created"],$today)); |
  | 396 |  | if($date\_diff > $days\_for\_new){ |
  | 397 |  | $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
  | 398 |  | array('is\_new' => 0 ), |
  | 399 |  | array('id' => $res["id"]), |
  | 400 |  | array('%d'), |
  | 401 |  | array('%d') |
  | 402 |  | ); |
  | 403 |  | } |
  | 404 |  | } |
  | 405 |  | }else{ |
  | 406 |  | $ress = $wpdb->get\_results('SELECT id,calendar\_id,date\_created FROM ' . $wpdb->prefix . 'wpdevart\_reservations  WHERE is\_new=1',ARRAY\_A); |
  | 407 |  | foreach($ress as $res) { |
  | 408 |  | $date\_diff = abs($this->get\_date\_diff($res["date\_created"],$today)); |
  | 409 |  | if($date\_diff > $days\_for\_new[$res['calendar\_id']]){ |
  | 410 |  | $wpdb->update($wpdb->prefix . 'wpdevart\_reservations', |
  | 411 |  | array('is\_new' => 0 ), |
  | 412 |  | array('id' => $res["id"]), |
  | 413 |  | array('%d'), |
  | 414 |  | array('%d') |
  | 415 |  | ); |
  | 416 |  | } |
  | 417 |  | } |
  | 418 |  | } |
  | 419 |  |  |
  | 420 |  | if($id != 0){ |
  | 421 |  | $count = $wpdb->get\_row($wpdb->prepare('SELECT ' . $wpdb->prefix . 'wpdevart\_calendars.title,COUNT(' . $wpdb->prefix . 'wpdevart\_reservations.id) AS countRes FROM ' . $wpdb->prefix . 'wpdevart\_reservations LEFT JOIN ' . $wpdb->prefix . 'wpdevart\_calendars ON ' . $wpdb->prefix . 'wpdevart\_reservations.calendar\_id=' . $wpdb->prefix . 'wpdevart\_calendars.id WHERE ' . $wpdb->prefix . 'wpdevart\_reservations.is\_new=1 AND calendar\_id="%d" GROUP BY title', $id),ARRAY\_A); |
  | 422 |  | $count = array($count); |
  | 423 |  | } else{ |
  | 424 |  | $count = $wpdb->get\_results('SELECT ' . $wpdb->prefix . 'wpdevart\_calendars.title,COUNT(' . $wpdb->prefix . 'wpdevart\_reservations.id) AS countRes FROM ' . $wpdb->prefix . 'wpdevart\_reservations LEFT JOIN ' . $wpdb->prefix . 'wpdevart\_calendars ON ' . $wpdb->prefix . 'wpdevart\_reservations.calendar\_id=' . $wpdb->prefix . 'wpdevart\_calendars.id WHERE ' . $wpdb->prefix . 'wpdevart\_reservations.is\_new=1 GROUP BY title',ARRAY\_A); |
  | 425 |  | } |
  | 426 |  |  |
  | 427 |  | return $count; |
  | 428 |  | } |
  | 429 |  |  |
  | 430 |  | public function get\_date\_data( $unique\_id ) { |
  | 431 |  | global $wpdb; |
  | 432 |  | $date\_info = ""; |
  | 433 |  | $row = $wpdb->get\_row($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_dates WHERE unique\_id="%s"', $unique\_id),ARRAY\_A); |
  | 434 |  | if(is\_array($row) &&  isset($row["data"])) |
  | 435 |  | $date\_info = $row["data"]; |
  | 436 |  | return $date\_info; |
  | 437 |  | } |
  | 438 |  |  |
  | 439 |  | public function get\_theme\_rows($id = 0) { |
  | 440 |  | global $wpdb; |
  | 441 |  | $calendar\_id = wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  | 442 |  | $cal\_id = 0; |
  | 443 |  | if($id == 0){ |
  | 444 |  | if(sanitize\_text\_field($calendar\_id) != 0) |
  |  | 443 | $theme\_id = $wpdb->get\_var($wpdb->prepare('SELECT theme\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  |  | 444 | $theme\_rows = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"', $theme\_id), ARRAY\_A); |
  |  | 445 | if (isset($theme\_rows[0])) { |
  |  | 446 | $them\_options = json\_decode($theme\_rows[0]["value"], true); |
  |  | 447 | } else { |
  |  | 448 | $them\_options = array(); |
  |  | 449 | } |
  |  | 450 | return $them\_options; |
  |  | 451 | } |
  |  | 452 |  |
  |  | 453 | public function get\_themes\_rows() { |
  |  | 454 | global $wpdb; |
  |  | 455 | $theme\_id = $wpdb->get\_results('SELECT id,theme\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars', ARRAY\_A); |
  |  | 456 | $a = array(); |
  |  | 457 | $themes = array(); |
  |  | 458 | $results = array(); |
  |  | 459 | foreach ($theme\_id as $theme) { |
  |  | 460 | $a[$theme["id"]] = $theme["theme\_id"]; |
  |  | 461 | } |
  |  | 462 | $str = implode(",", $a); |
  |  | 463 | $theme\_rows = $wpdb->get\_results('SELECT id,value FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id IN (' . $str . ')'); |
  |  | 464 | foreach ($theme\_rows as $theme\_row) { |
  |  | 465 | if (isset($theme\_row)) { |
  |  | 466 | $result = json\_decode($theme\_row->value, true); |
  |  | 467 | if (isset($result["days\_for\_new"])) |
  |  | 468 | $themes[$theme\_row->id] = $result["days\_for\_new"]; |
  |  | 469 | else |
  |  | 470 | $themes[$theme\_row->id] = 30; |
  |  | 471 | } |
  |  | 472 | } |
  |  | 473 | foreach ($a as $key => $value) { |
  |  | 474 | $results[$key] = $themes[$value]; |
  |  | 475 | } |
  |  | 476 | return $results; |
  |  | 477 | } |
  |  | 478 |  |
  |  | 479 | public function get\_calendar\_title() { |
  |  | 480 | global $wpdb; |
  |  | 481 | $calendar\_id = wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  |  | 482 | $cal\_id = 0; |
  |  | 483 | if (sanitize\_text\_field($calendar\_id) != 0) |
  | 445 | 484 | $cal\_id = $calendar\_id; |
  | 446 |  | } else { |
  | 447 |  | $cal\_id = $id; |
  | 448 |  | } |
  | 449 |  | $theme\_id = $wpdb->get\_var($wpdb->prepare('SELECT theme\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  | 450 |  | $theme\_rows = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"', $theme\_id),ARRAY\_A); |
  | 451 |  | if(isset($theme\_rows[0])) { |
  | 452 |  | $them\_options = json\_decode($theme\_rows[0]["value"],true); |
  | 453 |  | } else { |
  | 454 |  | $them\_options = array(); |
  | 455 |  | } |
  | 456 |  |  |
  | 457 |  | return $them\_options; |
  | 458 |  | } |
  | 459 |  |  |
  | 460 |  | public function get\_themes\_rows() { |
  | 461 |  | global $wpdb; |
  | 462 |  | $theme\_id = $wpdb->get\_results('SELECT id,theme\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars',ARRAY\_A); |
  | 463 |  | $a = array(); |
  | 464 |  | $themes = array(); |
  | 465 |  | $results = array(); |
  | 466 |  | foreach($theme\_id as $theme){ |
  | 467 |  | $a[$theme["id"]] = $theme["theme\_id"]; |
  | 468 |  | } |
  | 469 |  | $str = implode(",", $a); |
  | 470 |  | $theme\_rows = $wpdb->get\_results('SELECT id,value FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id IN (' . $str . ')'); |
  | 471 |  |  |
  | 472 |  | foreach($theme\_rows as $theme\_row){ |
  | 473 |  | if(isset($theme\_row)) { |
  | 474 |  | $result = json\_decode($theme\_row->value,true); |
  | 475 |  | if(isset($result["days\_for\_new"])) |
  | 476 |  | $themes[$theme\_row->id] = $result["days\_for\_new"]; |
  | 477 |  | else |
  | 478 |  | $themes[$theme\_row->id] = 30; |
  | 479 |  | } |
  | 480 |  | } |
  | 481 |  | foreach($a as $key=>$value){ |
  | 482 |  | $results[$key] = $themes[$value]; |
  | 483 |  | } |
  | 484 |  |  |
  | 485 |  | return $results; |
  | 486 |  | } |
  | 487 |  |  |
  | 488 |  | public function get\_calendar\_title() { |
  | 489 |  | global $wpdb; |
  | 490 |  | $calendar\_id = wpdevart\_bc\_Library::get\_value("calendar\_id", 0); |
  | 491 |  | $cal\_id = 0; |
  | 492 |  | if(sanitize\_text\_field($calendar\_id) != 0) |
  | 493 |  | $cal\_id = $calendar\_id; |
  | 494 |  | $row = $wpdb->get\_var($wpdb->prepare('SELECT title FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  | 495 |  |  |
  | 496 |  | return $row; |
  | 497 |  | } |
  | 498 |  |  |
  |  | 485 | $row = $wpdb->get\_var($wpdb->prepare('SELECT title FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $cal\_id)); |
  |  | 486 | return $row; |
  |  | 487 | } |
  |  | 488 |  |
  | 499 | 489 | private function get\_date\_diff($date1, $date2) { |
  | 500 | 490 | $start = strtotime($date1); |
  | 501 | 491 | $end = strtotime($date2); |
  | 502 | 492 | $datediff = $start - $end; |
  | 503 |  | return floor($datediff~~/(60\*60\*~~24)); |
  | 504 |  | } |
  | 505 |  |  |
  | 506 |  | private static function get\_now(){ |
  | 507 |  | $now = date(~~'Y-m-d H:i:s'~~ ); |
  | 508 |  | $tz\_string     = get\_option(~~'timezone\_string'~~ ); |
  | 509 |  | if (~~$tz\_string~~ ) { |
  |  | 493 | return floor($datediff / (60 \* 60 \* 24)); |
  |  | 494 | } |
  |  | 495 |  |
  |  | 496 | private static function get\_now() { |
  |  | 497 | $now = date('Y-m-d H:i:s'); |
  |  | 498 | $tz\_string     = get\_option('timezone\_string'); |
  |  | 499 | if ($tz\_string) { |
  | 510 | 500 | try { |
  | 511 |  | $tz = new DateTimeZone(~~$tz\_string~~ ); |
  | 512 |  | } catch (~~Exception $e~~ ) { |
  |  | 501 | $tz = new DateTimeZone($tz\_string); |
  |  | 502 | } catch (Exception $e) { |
  | 513 | 503 | $tz = ''; |
  | 514 | 504 | } |
  | 515 | 505 |  |
  | 516 |  | if (~~$tz~~ ) { |
  | 517 |  | $now = new DateTime(~~'now', $tz~~ ); |
  |  | 506 | if ($tz) { |
  |  | 507 | $now = new DateTime('now', $tz); |
  | 518 | 508 | $now = $now->format('Y-m-d H:i:s'); |
  | 519 | 509 | } |
  | […](/browser/booking-calendar/trunk/admin/models/Reservations.php?rev=2969905#L521) | […](/browser/booking-calendar/trunk/admin/models/Reservations.php?rev=3209851#L511) |  |
  | 521 | 511 | return $now; |
  | 522 | 512 | } |
  | 523 |  |  |
  | 524 | 513 | } |
  | 525 |  |  |
  | 526 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/models/Themes.php](/changeset/3209851/booking-calendar/trunk/admin/models/Themes.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/models/Themes.php")

  | [r2975927](/browser/booking-calendar/trunk/admin/models/Themes.php?rev=2975927#L1 "Show revision 2975927 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/models/Themes.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ModelThemes { |
  | 3 |  | private $user\_id = 1; |
  | 4 |  | private $user\_role = ""; |
  | 5 |  | private $permission = false; |
  |  | 3 | private $user\_id = 1; |
  |  | 4 | private $user\_role = ""; |
  |  | 5 | private $permission = false; |
  | 6 | 6 | private $no\_access = false; |
  | 7 |  |  |
  |  | 7 |  |
  | 8 | 8 | public function \_\_construct() { |
  | 9 |  | $current\_user = get\_current\_user\_id(); |
  | 10 |  | $current\_user\_info = get\_userdata( $current\_user ); |
  | 11 |  | ~~if($current\_user\_info)~~{ |
  | 12 |  | $current\_user\_info = $current\_user\_info->roles; |
  | 13 |  | } |
  | 14 |  | $role = isset($current\_user\_info[0]) ? $current\_user\_info[0] : ""; |
  | 15 |  | $this->user\_id = $current\_user; |
  | 16 |  | $this->user\_role = $role; |
  | 17 |  | $this->permission = wpdevart\_bc\_Library::page\_access('theme\_page'); |
  | 18 |  | $pages = array( |
  | 19 |  | 'booking\_page\_wpdevart-calendars', |
  | 20 |  | 'booking\_page\_wpdevart-reservations', |
  | 21 |  | 'booking\_page\_wpdevart-forms', |
  | 22 |  | 'booking\_page\_wpdevart-extras', |
  | 23 |  | 'booking\_page\_wpdevart-themes' |
  | 24 |  | ); |
  | 25 |  | if (function\_exists('get\_current\_screen')) { |
  | 26 |  | $current\_page = get\_current\_screen(); |
  | 27 |  | $this->no\_access = $this->user\_role != "administrator" && !$this->permission && $this->user\_id !== 0 |
  | 28 |  | && is\_admin() && isset($current\_page->id) && in\_array($current\_page->id, $pages); |
  | 29 |  | } |
  |  | 9 | $current\_user = get\_current\_user\_id(); |
  |  | 10 | $current\_user\_info = get\_userdata($current\_user); |
  |  | 11 | if ($current\_user\_info) { |
  |  | 12 | $current\_user\_info = $current\_user\_info->roles; |
  |  | 13 | } |
  |  | 14 | $role = isset($current\_user\_info[0]) ? $current\_user\_info[0] : ""; |
  |  | 15 | $this->user\_id = $current\_user; |
  |  | 16 | $this->user\_role = $role; |
  |  | 17 | $this->permission = wpdevart\_bc\_Library::page\_access('theme\_page'); |
  |  | 18 | $pages = array( |
  |  | 19 | 'booking\_page\_wpdevart-calendars', |
  |  | 20 | 'booking\_page\_wpdevart-reservations', |
  |  | 21 | 'booking\_page\_wpdevart-forms', |
  |  | 22 | 'booking\_page\_wpdevart-extras', |
  |  | 23 | 'booking\_page\_wpdevart-themes' |
  |  | 24 | ); |
  |  | 25 | if (function\_exists('get\_current\_screen')) { |
  |  | 26 | $current\_page = get\_current\_screen(); |
  |  | 27 | $this->no\_access = $this->user\_role != "administrator" && !$this->permission && $this->user\_id !== 0 && is\_admin() && isset($current\_page->id) && in\_array($current\_page->id, $pages); |
  |  | 28 | } |
  |  | 29 | } |
  | 30 | 30 |  |
  | 31 |  | ~~}~~ |
  | 32 |  |  |
  | 33 | 31 | public function get\_themes\_rows() { |
  | 34 | 32 | global $wpdb; |
  | 35 |  |  |
  | 36 |  | $limit = (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page'])? (((int) $\_POST['wpdevart\_page'] - 1) \* 20) : 0; |
  |  | 33 |  |
  |  | 34 | $limit = (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) ? (((int) $\_POST['wpdevart\_page'] - 1) \* 20) : 0; |
  | 37 | 35 | $order\_by = ((isset($\_POST['order\_by']) && $\_POST['order\_by'] != "") ? sanitize\_sql\_orderby($\_POST['order\_by']) :  'id'); |
  | 38 |  | $order = ((isset($\_POST['asc\_desc']) && $\_POST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  |  | 36 | $order = ((isset($\_POST['asc\_desc']) && $\_POST['asc\_desc'] == 'asc') ? 'asc' : 'desc'); |
  | 39 | 37 | $order\_by = ' ORDER BY `' . $order\_by . '` ' . $order; |
  | 40 | 38 |  |
  | 41 |  | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  | 42 |  | $like = '%' . $wpdb->esc\_like( $\_POST['search\_value'] ) . '%'; |
  | 43 |  | if($this->no\_access) { |
  | 44 |  | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE title LIKE %s AND user\_id="%d" ' . $order\_by . ' LIMIT ' . $limit . ',20', $like, $this->user\_id); |
  | 45 |  | } else{ |
  | 46 |  | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE title LIKE %s ' . $order\_by . ' LIMIT ' . $limit . ',20', $like); |
  | 47 |  | } |
  |  | 39 | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  |  | 40 | $like = '%' . $wpdb->esc\_like($\_POST['search\_value']) . '%'; |
  |  | 41 | if ($this->no\_access) { |
  |  | 42 | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE title LIKE %s AND user\_id="%d" ' . $order\_by . ' LIMIT ' . $limit . ',20', $like, $this->user\_id); |
  | 48 | 43 | } else { |
  | 49 |  | if($this->no\_access) { |
  | 50 |  | $query = $wpdb->prepare("SELECT \* FROM " . $wpdb->prefix . "wpdevart\_themes WHERE user\_id='%d' " . $order\_by . " LIMIT " . $limit . ",20", $this->user\_id); |
  | 51 |  | } else { |
  | 52 |  | $query = "SELECT \* FROM " . $wpdb->prefix . "wpdevart\_themes  " . $order\_by . " LIMIT " . $limit . ",20"; |
  | 53 |  | } |
  |  | 44 | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE title LIKE %s ' . $order\_by . ' LIMIT ' . $limit . ',20', $like); |
  | 54 | 45 | } |
  |  | 46 | } else { |
  |  | 47 | if ($this->no\_access) { |
  |  | 48 | $query = $wpdb->prepare("SELECT \* FROM " . $wpdb->prefix . "wpdevart\_themes WHERE user\_id='%d' " . $order\_by . " LIMIT " . $limit . ",20", $this->user\_id); |
  |  | 49 | } else { |
  |  | 50 | $query = "SELECT \* FROM " . $wpdb->prefix . "wpdevart\_themes  " . $order\_by . " LIMIT " . $limit . ",20"; |
  |  | 51 | } |
  |  | 52 | } |
  | 55 | 53 | $rows = $wpdb->get\_results($query); |
  | 56 |  |  |
  |  | 54 |  |
  | 57 | 55 | return $rows; |
  | 58 |  | } |
  | 59 |  |  |
  | 60 |  | public function get\_setting\_rows(~~$id = 1~~ ) { |
  |  | 56 | } |
  |  | 57 |  |
  |  | 58 | public function get\_setting\_rows($id = 1) { |
  | 61 | 59 | global $wpdb; |
  | 62 |  | $id = is\_null($id) ? 1 : $id; |
  |  | 60 | $id = is\_null($id) ? 1 : $id; |
  |  | 61 | if ($this->no\_access) { |
  |  | 62 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d" AND user\_id="%d"', $id, $this->user\_id)); |
  |  | 63 | } else { |
  |  | 64 | $row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"', $id)); |
  |  | 65 | } |
  |  | 66 | return $row; |
  |  | 67 | } |
  | 63 | 68 |  |
  | 64 |  | ~~if($this->no\_access){~~ |
  | 65 |  | ~~$row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d" AND user\_id="%d"', $id, $this->user\_id));~~ |
  | 66 |  | ~~} else {~~ |
  | 67 |  | ~~$row = $wpdb->get\_row($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"', $id));~~ |
  | 68 |  | ~~}~~ |
  | 69 |  | ~~return $row;~~ |
  | 70 |  | ~~}~~ |
  | 71 |  |  |
  | 72 | 69 | public function get\_form\_rows() { |
  | 73 | 70 | global $wpdb; |
  | 74 |  |  |
  | 75 |  | $where = ''; |
  | 76 |  | if($this->no\_access){ |
  | 77 |  | $where = ' WHERE user\_id=' . $this->user\_id; |
  | 78 |  | } |
  | 79 |  | $form\_array = array(); |
  | 80 |  | $rows = $wpdb->get\_results('SELECT id,title FROM ' . $wpdb->prefix . 'wpdevart\_forms ' . $where,ARRAY\_A); |
  | 81 |  | foreach($rows as $row) { |
  | 82 |  | $form\_array[$row['id']] = $row['title']; |
  | 83 |  | } |
  |  | 71 | $where = ''; |
  |  | 72 | if ($this->no\_access) { |
  |  | 73 | $where = ' WHERE user\_id=' . $this->user\_id; |
  |  | 74 | } |
  |  | 75 | $form\_array = array(); |
  |  | 76 | $rows = $wpdb->get\_results('SELECT id,title FROM ' . $wpdb->prefix . 'wpdevart\_forms ' . $where, ARRAY\_A); |
  |  | 77 | foreach ($rows as $row) { |
  |  | 78 | $form\_array[$row['id']] = $row['title']; |
  |  | 79 | } |
  | 84 | 80 | return $form\_array; |
  | 85 |  | } |
  | 86 |  |  |
  |  | 81 | } |
  |  | 82 |  |
  | 87 | 83 | public function get\_payment\_info($id) { |
  | 88 | 84 | global $wpdb; |
  | 89 |  | $address = array(); |
  |  | 85 | $address = array(); |
  | 90 | 86 | $rows = $wpdb->get\_var($wpdb->prepare('SELECT value FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"', $id)); |
  | 91 |  | $rows = json\_decode($rows,true); |
  | 92 |  | ~~if(isset($rows['enable\_billing\_address']) && $rows['enable\_billing\_address'] == "on" && isset($rows['billing\_address\_form']) && $rows['billing\_address\_form'])~~{ |
  | 93 |  | ~~$address['billing\_info'] = $wpdb->get\_row($wpdb->prepare('SELECT title,data FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $rows['billing\_address\_form']),~~ARRAY\_A); |
  | 94 |  | } |
  | 95 |  | ~~if(isset($rows['enable\_shipping\_address']) && $rows['enable\_shipping\_address'] == "on" && isset($rows['shipping\_address\_form']) && $rows['shipping\_address\_form'])~~{ |
  | 96 |  | ~~$address['shipping\_info'] = $wpdb->get\_row($wpdb->prepare('SELECT title,data FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $rows['shipping\_address\_form']),~~ARRAY\_A); |
  | 97 |  | } |
  |  | 87 | $rows = json\_decode($rows, true); |
  |  | 88 | if (isset($rows['enable\_billing\_address']) && $rows['enable\_billing\_address'] == "on" && isset($rows['billing\_address\_form']) && $rows['billing\_address\_form']) { |
  |  | 89 | $address['billing\_info'] = $wpdb->get\_row($wpdb->prepare('SELECT title,data FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $rows['billing\_address\_form']), ARRAY\_A); |
  |  | 90 | } |
  |  | 91 | if (isset($rows['enable\_shipping\_address']) && $rows['enable\_shipping\_address'] == "on" && isset($rows['shipping\_address\_form']) && $rows['shipping\_address\_form']) { |
  |  | 92 | $address['shipping\_info'] = $wpdb->get\_row($wpdb->prepare('SELECT title,data FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $rows['shipping\_address\_form']), ARRAY\_A); |
  |  | 93 | } |
  | 98 | 94 | $address['theme\_option'] = $rows; |
  | 99 | 95 | return $address; |
  | 100 |  | } |
  | 101 |  |  |
  |  | 96 | } |
  |  | 97 |  |
  | 102 | 98 | public function items\_nav() { |
  | 103 | 99 | global $wpdb; |
  | 104 |  |  |
  | 105 |  | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  | 106 |  | $like = '%' . $wpdb->esc\_like( $\_POST['search\_value'] ) . '%'; |
  | 107 |  | if($this->no\_access) { |
  | 108 |  | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE title LIKE %s AND user\_id="%d"', $like, $this->user\_id)); |
  | 109 |  | } else { |
  | 110 |  | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE title LIKE %s', $like)); |
  | 111 |  | } |
  |  | 100 | if (isset($\_POST['search\_value']) && (sanitize\_text\_field($\_POST['search\_value']) != '')) { |
  |  | 101 | $like = '%' . $wpdb->esc\_like($\_POST['search\_value']) . '%'; |
  |  | 102 | if ($this->no\_access) { |
  |  | 103 | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE title LIKE %s AND user\_id="%d"', $like, $this->user\_id)); |
  | 112 | 104 | } else { |
  | 113 |  | if($this->no\_access) { |
  | 114 |  | $total = $wpdb->get\_var($wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_themes WHERE user\_id='%d'", $this->user\_id)); |
  | 115 |  | } else { |
  | 116 |  | $total = $wpdb->get\_var("SELECT COUNT(\*) FROM ".$wpdb->prefix."wpdevart\_themes "); |
  | 117 |  | } |
  |  | 105 | $total = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE title LIKE %s', $like)); |
  | 118 | 106 | } |
  |  | 107 | } else { |
  |  | 108 | if ($this->no\_access) { |
  |  | 109 | $total = $wpdb->get\_var($wpdb->prepare("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_themes WHERE user\_id='%d'", $this->user\_id)); |
  |  | 110 | } else { |
  |  | 111 | $total = $wpdb->get\_var("SELECT COUNT(\*) FROM " . $wpdb->prefix . "wpdevart\_themes "); |
  |  | 112 | } |
  |  | 113 | } |
  | 119 | 114 | $items\_nav['total'] = $total; |
  | 120 | 115 | if (isset($\_POST['wpdevart\_page']) && $\_POST['wpdevart\_page']) { |
  | 121 | 116 | $limit = ((int)$\_POST['wpdevart\_page'] - 1) \* 20; |
  | 122 |  | } |
  | 123 |  | else { |
  |  | 117 | } else { |
  | 124 | 118 | $limit = 0; |
  | 125 | 119 | } |
  | […](/browser/booking-calendar/trunk/admin/models/Themes.php?rev=2975927#L127) | […](/browser/booking-calendar/trunk/admin/models/Themes.php?rev=3209851#L121) |  |
  | 127 | 121 | return $items\_nav; |
  | 128 | 122 | } |
  | 129 |  |  |
  | 130 |  | public function check\_exists(~~$theme\_id~~ ) { |
  |  | 123 |  |
  |  | 124 | public function check\_exists($theme\_id) { |
  | 131 | 125 | global $wpdb; |
  | 132 |  | $exists = false; |
  | 133 |  | $rows = $wpdb->get\_results('SELECT theme\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars',ARRAY\_A); |
  | 134 |  | foreach($rows as $row) { |
  | 135 |  | if(in\_array($theme\_id,$row)){ |
  | 136 |  | $exists = true; |
  | 137 |  | break; |
  | 138 |  | } |
  | 139 |  | } |
  | 140 |  |  |
  |  | 126 | $exists = false; |
  |  | 127 | $rows = $wpdb->get\_results('SELECT theme\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars', ARRAY\_A); |
  |  | 128 | foreach ($rows as $row) { |
  |  | 129 | if (in\_array($theme\_id, $row)) { |
  |  | 130 | $exists = true; |
  |  | 131 | break; |
  |  | 132 | } |
  |  | 133 | } |
  | 141 | 134 | return $exists; |
  | 142 |  | } |
  | 143 |  |  |
  | 144 |  |  |
  |  | 135 | } |
  | 145 | 136 | } |
  | 146 |  |  |
  | 147 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/models/UserPermissions.php](/changeset/3209851/booking-calendar/trunk/admin/models/UserPermissions.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/models/UserPermissions.php")

  | [r2965848](/browser/booking-calendar/trunk/admin/models/UserPermissions.php?rev=2965848#L1 "Show revision 2965848 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/models/UserPermissions.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class wpdevart\_bc\_ModelUserpermissions { |
  | 3 |  |  |
  | 4 | 3 | public function get\_pages\_permissions() { |
  | 5 |  | ~~$option\_name = 'wpdevart\_permissions'~~ ; |
  | 6 |  | $default = 'publish\_pages'; |
  | 7 |  | $permissions = get\_option(~~$option\_name, $default );~~ |
  |  | 4 | $option\_name = 'wpdevart\_permissions'; |
  |  | 5 | $default = 'publish\_pages'; |
  |  | 6 | $permissions = get\_option($option\_name, $default); |
  | 8 | 7 | return $permissions; |
  | 9 |  | } |
  | 10 |  |  |
  |  | 8 | } |
  | 11 | 9 | } |
  | 12 |  |  |
  | 13 |  | ~~?>~~ |
* ## [booking-calendar/trunk/admin/views/Calendars.php](/changeset/3209851/booking-calendar/trunk/admin/views/Calendars.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/views/Calendars.php")

  | [r2848690](/browser/booking-calendar/trunk/admin/views/Calendars.php?rev=2848690#L47 "Show revision 2848690 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/views/Calendars.php?rev=3209851#L47 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 47 | 47 | foreach ( $rows as $row ) { |
  | 48 | 48 | $user = $row->user\_id; |
  | 49 |  | $user\_info = get\_userdata( $user );?> |
  |  | 49 | $user\_info = get\_userdata( $user );?> |
  | 50 | 50 | <tr> |
  | 51 |  | <td><input type="checkbox" name="check\_for\_action[]" class="check\_for\_action" value="<?php echo ~~$row->id~~; ?>"></td> |
  |  | 51 | <td><input type="checkbox" name="check\_for\_action[]" class="check\_for\_action" value="<?php echo esc\_attr($row->id); ?>"></td> |
  | 52 | 52 | <td><?php echo $row->id; ?></td> |
  | 53 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-calendars', 'task' => 'edit', 'id' => $row->id ), admin\_url('admin.php')); ?>"><?php echo $row->title~~; ?></a></td> |
  | 54 |  | <td><input type="text" value="[wpdevart\_booking\_calendar id=&quot;<?php echo ~~$row->id~~; ?>&quot;]" onclick="this.focus();this.select();" readonly="readonly" size="32"></td> |
  |  | 53 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-calendars', 'task' => 'edit', 'id' => esc\_attr($row->id) ), admin\_url('admin.php'))); ?>"><?php echo esc\_html($row->title); ?></a></td> |
  |  | 54 | <td><input type="text" value="[wpdevart\_booking\_calendar id=&quot;<?php echo esc\_attr($row->id); ?>&quot;]" onclick="this.focus();this.select();" readonly="readonly" size="32"></td> |
  | 55 | 55 | <?php if($role == "administrator"){ |
  | 56 | 56 | ?> |
  | 57 |  | <td><a href="<?php echo get\_edit\_user\_link( $user ) ?>"><?php echo ($user\_info)? ~~$user\_info->user\_login~~ : ""; ?></a></td> |
  |  | 57 | <td><a href="<?php echo get\_edit\_user\_link( $user ) ?>"><?php echo ($user\_info)? esc\_html($user\_info->user\_login) : ""; ?></a></td> |
  | 58 | 58 | <?php } ?> |
  | 59 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-calendars', 'task' => 'edit', 'id' => $row->id ), admin\_url('admin.php'~~)); ?>"><?php \_e('Edit','booking-calendar'); ?></a></td> |
  | 60 |  | <td><a href="" onclick="wpdevart\_set\_value('task','delete'); wpdevart\_set\_value('cur\_id','<?php echo ~~$row->id~~; ?>'); wpdevart\_form\_submit(event, 'calendars\_form')" ><?php \_e('Delete','booking-calendar'); ?></a></td> |
  |  | 59 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-calendars', 'task' => 'edit', 'id' => esc\_attr($row->id) ), admin\_url('admin.php'))); ?>"><?php \_e('Edit','booking-calendar'); ?></a></td> |
  |  | 60 | <td><a href="" onclick="wpdevart\_set\_value('task','delete'); wpdevart\_set\_value('cur\_id','<?php echo esc\_attr($row->id); ?>'); wpdevart\_form\_submit(event, 'calendars\_form')" ><?php \_e('Delete','booking-calendar'); ?></a></td> |
  | 61 | 61 | <tr> |
  | 62 | 62 | <?php   } |
  | […](/browser/booking-calendar/trunk/admin/views/Calendars.php?rev=2848690#L1045) | […](/browser/booking-calendar/trunk/admin/views/Calendars.php?rev=3209851#L1045) |  |
  | 1045 | 1045 | <input type="submit" value="<?php \_e('Apply','booking-calendar'); ?>" class="action-link wpda-input" name="apply" id="apply"  onclick="if(!jQuery('#theme\_id option').length){alert('Add Theme'); return false;}"> |
  | 1046 | 1046 | <input type="hidden" name="task" value="save"> |
  | 1047 |  | <input type="hidden" name="id" value="<?php echo ~~$id~~; ?>"> |
  | 1048 |  | <input type="hidden" name="current\_date" value="<?php echo ~~$current\_date~~; ?>"> |
  |  | 1047 | <input type="hidden" name="id" value="<?php echo esc\_attr($id); ?>"> |
  |  | 1048 | <input type="hidden" name="current\_date" value="<?php echo esc\_attr($current\_date); ?>"> |
  | 1049 | 1049 | <?php wp\_nonce\_field( 'save\_item', '\_wpdevart\_bc\_nonce' ); ?> |
  | 1050 | 1050 | <?php |
  | 1051 | 1051 | foreach( $wpdevart\_calendars as $wpdevart\_calendar ) { ?> |
  | 1052 | 1052 | <div class="wpdevart-item-section"> |
  | 1053 |  | <h3><?php echo ~~$wpdevart\_calendar['title']~~; ?></h3> |
  |  | 1053 | <h3><?php echo esc\_html($wpdevart\_calendar['title']); ?></h3> |
  | 1054 | 1054 | <div class="wpdevart-item-section-cont"> |
  | 1055 | 1055 | <?php foreach( $wpdevart\_calendar['value'] as $key => $wpdevart\_calendars\_value ) { |
  | […](/browser/booking-calendar/trunk/admin/views/Calendars.php?rev=2848690#L1075) | […](/browser/booking-calendar/trunk/admin/views/Calendars.php?rev=3209851#L1075) |  |
  | 1075 | 1075 | $sett\_value\_cal = 0;            ?> |
  | 1076 | 1076 | <div class="wpdevart-item-section form-section"> |
  | 1077 |  | <h3><?php echo ~~$form\_item['title']~~; ?></h3> |
  |  | 1077 | <h3><?php echo esc\_html($form\_item['title']); ?></h3> |
  | 1078 | 1078 | <div class="wpdevart-item-section-cont"> |
  | 1079 | 1079 | <?php foreach( $form\_item['value'] as $key => $value ) { |
* ## [booking-calendar/trunk/admin/views/Extras.php](/changeset/3209851/booking-calendar/trunk/admin/views/Extras.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/views/Extras.php")

  | [r2848690](/browser/booking-calendar/trunk/admin/views/Extras.php?rev=2848690#L30 "Show revision 2848690 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/views/Extras.php?rev=3209851#L30 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 30 | 30 | $class = "updated"; |
  | 31 | 31 | } ?> |
  | 32 |  | <div id="message" class="<?php echo ~~$class; ?> notice is-dismissible"><p><?php echo $error\_msg~~; ?></p></div> |
  |  | 32 | <div id="message" class="<?php echo esc\_attr($class); ?> notice is-dismissible"><p><?php echo esc\_html($error\_msg); ?></p></div> |
  | 33 | 33 | <?php } ?> |
  | 34 | 34 | <form action="admin.php?page=wpdevart-extras" method="post" id="extras\_form"> |
  | […](/browser/booking-calendar/trunk/admin/views/Extras.php?rev=2848690#L51) | […](/browser/booking-calendar/trunk/admin/views/Extras.php?rev=3209851#L51) |  |
  | 51 | 51 | foreach ( $rows as $row ) { ?> |
  | 52 | 52 | <tr> |
  | 53 |  | <td><input type="checkbox" name="check\_for\_action[]" class="check\_for\_action" value="<?php echo ~~$row->id~~; ?>"></td> |
  | 54 |  | <td><?php echo ~~$row->id~~; ?></td> |
  | 55 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-extras', 'task' => 'edit', 'id' => $row->id ), admin\_url('admin.php')); ?>"><?php echo $row->title~~; ?></a></td> |
  |  | 53 | <td><input type="checkbox" name="check\_for\_action[]" class="check\_for\_action" value="<?php echo esc\_attr($row->id); ?>"></td> |
  |  | 54 | <td><?php echo esc\_html($row->id); ?></td> |
  |  | 55 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-extras', 'task' => 'edit', 'id' => esc\_attr($row->id) ), admin\_url('admin.php'))); ?>"><?php echo esc\_html($row->title); ?></a></td> |
  | 56 | 56 | <?php if($role == "administrator"){ |
  | 57 | 57 | $user = $row->user\_id; |
  | 58 | 58 | $user\_info = get\_userdata( $user ); ?> |
  | 59 |  | <td><a href="<?php echo ~~get\_edit\_user\_link( $user ) ?>"><?php echo ($user\_info)? $user\_info->user\_login~~ : ""; ?></a></td> |
  |  | 59 | <td><a href="<?php echo esc\_url(get\_edit\_user\_link( $user )); ?>"><?php echo ($user\_info)? esc\_html($user\_info->user\_login) : ""; ?></a></td> |
  | 60 | 60 | <?php } ?> |
  | 61 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-extras', 'task' => 'duplicate', 'id' => $row->id,'\_wpdevart\_bc\_nonce' => wp\_create\_nonce( 'duplicate\_item' ) ), admin\_url('admin.php'~~)); ?>"><?php \_e('Duplicate','booking-calendar'); ?></a></td> |
  | 62 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-extras', 'task' => 'edit', 'id' => $row->id ), admin\_url('admin.php'~~)); ?>"><?php \_e('Edit','booking-calendar'); ?></a></td> |
  | 63 |  | <td><a href="" onclick="wpdevart\_set\_value('task','delete'); wpdevart\_set\_value('cur\_id','<?php echo ~~$row->id~~; ?>'); wpdevart\_form\_submit(event, 'extras\_form')" ><?php \_e('Delete','booking-calendar'); ?></a></td> |
  |  | 61 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-extras', 'task' => 'duplicate', 'id' => esc\_attr($row->id),'\_wpdevart\_bc\_nonce' => wp\_create\_nonce( 'duplicate\_item' ) ), admin\_url('admin.php'))); ?>"><?php \_e('Duplicate','booking-calendar'); ?></a></td> |
  |  | 62 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-extras', 'task' => 'edit', 'id' => esc\_attr($row->id) ), admin\_url('admin.php'))); ?>"><?php \_e('Edit','booking-calendar'); ?></a></td> |
  |  | 63 | <td><a href="" onclick="wpdevart\_set\_value('task','delete'); wpdevart\_set\_value('cur\_id','<?php echo esc\_attr($row->id); ?>'); wpdevart\_form\_submit(event, 'extras\_form')" ><?php \_e('Delete','booking-calendar'); ?></a></td> |
  | 64 | 64 | <tr> |
  | 65 | 65 | <?php   } |
  | […](/browser/booking-calendar/trunk/admin/views/Extras.php?rev=2848690#L185) | […](/browser/booking-calendar/trunk/admin/views/Extras.php?rev=3209851#L185) |  |
  | 185 | 185 | <input type="submit" value="<?php \_e('Apply','booking-calendar'); ?>" class="action-link wpda-input" name="apply"> |
  | 186 | 186 | <div id="add\_field\_container"> |
  | 187 |  | <div id="add\_extra\_field" class="action-link" data-max="<?php echo ~~$max\_id~~; ?>"><?php \_e('Add extra field','booking-calendar'); ?></div> |
  |  | 187 | <div id="add\_extra\_field" class="action-link" data-max="<?php echo esc\_attr($max\_id); ?>"><?php \_e('Add extra field','booking-calendar'); ?></div> |
  | 188 | 188 | </div> |
  | 189 | 189 | </div> |
  | […](/browser/booking-calendar/trunk/admin/views/Extras.php?rev=2848690#L203) | […](/browser/booking-calendar/trunk/admin/views/Extras.php?rev=3209851#L203) |  |
  | 203 | 203 | </div> |
  | 204 | 204 | <input type="hidden" name="task" value="save"> |
  | 205 |  | <input type="hidden" name="id" value="<?php echo ~~$id~~; ?>"> |
  |  | 205 | <input type="hidden" name="id" value="<?php echo esc\_attr($id); ?>"> |
  | 206 | 206 | <?php wp\_nonce\_field( 'save\_item', '\_wpdevart\_bc\_nonce' ); ?> |
  | 207 | 207 | </form> |
* ## [booking-calendar/trunk/admin/views/Forms.php](/changeset/3209851/booking-calendar/trunk/admin/views/Forms.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/views/Forms.php")

  | [r2848690](/browser/booking-calendar/trunk/admin/views/Forms.php?rev=2848690#L33 "Show revision 2848690 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/views/Forms.php?rev=3209851#L33 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 33 | 33 | $class = "updated"; |
  | 34 | 34 | } ?> |
  | 35 |  | <div id="message" class="<?php echo ~~$class; ?> notice is-dismissible"><p><?php echo $error\_msg~~; ?></p></div> |
  |  | 35 | <div id="message" class="<?php echo esc\_attr($class); ?> notice is-dismissible"><p><?php echo esc\_html($error\_msg); ?></p></div> |
  | 36 | 36 | <?php } ?> |
  | 37 | 37 | <form action="admin.php?page=wpdevart-forms" method="post" id="forms\_form"> |
  | […](/browser/booking-calendar/trunk/admin/views/Forms.php?rev=2848690#L55) | […](/browser/booking-calendar/trunk/admin/views/Forms.php?rev=3209851#L55) |  |
  | 55 | 55 | <tr> |
  | 56 | 56 | <td><input type="checkbox" name="check\_for\_action[]" class="check\_for\_action" value="<?php echo $row->id; ?>"></td> |
  | 57 |  | <td><?php echo ~~$row->id~~; ?></td> |
  | 58 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-forms', 'task' => 'edit', 'id' => $row->id ), admin\_url('admin.php')); ?>"><?php echo $row->title~~; ?></a></td> |
  |  | 57 | <td><?php echo esc\_html($row->id); ?></td> |
  |  | 58 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-forms', 'task' => 'edit', 'id' => esc\_attr($row->id) ), admin\_url('admin.php'))); ?>"><?php echo esc\_html($row->title); ?></a></td> |
  | 59 | 59 | <?php if($role == "administrator"){ |
  | 60 | 60 | $user = $row->user\_id; |
  | 61 | 61 | $user\_info = get\_userdata( $user ); ?> |
  | 62 |  | <td><a href="<?php echo ~~get\_edit\_user\_link( $user ) ?>"><?php echo ($user\_info)? $user\_info->user\_login~~ : ""; ?></a></td> |
  |  | 62 | <td><a href="<?php echo esc\_url(get\_edit\_user\_link( $user )) ?>"><?php echo ($user\_info)? esc\_html($user\_info->user\_login) : ""; ?></a></td> |
  | 63 | 63 | <?php } ?> |
  | 64 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-forms', 'task' => 'duplicate', 'id' => $row->id, '\_wpdevart\_bc\_nonce' => wp\_create\_nonce( 'duplicate\_item' ) ), admin\_url('admin.php'~~)); ?>"><?php \_e('Duplicate','booking-calendar'); ?></a></td> |
  | 65 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-forms', 'task' => 'edit', 'id' => $row->id ), admin\_url('admin.php'~~)); ?>"><?php \_e('Edit','booking-calendar'); ?></a></td> |
  | 66 |  | <td><a href="" onclick="wpdevart\_set\_value('task','delete'); wpdevart\_set\_value('cur\_id','<?php echo ~~$row->id~~; ?>'); wpdevart\_form\_submit(event, 'forms\_form')" ><?php \_e('Delete','booking-calendar'); ?></a></td> |
  |  | 64 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-forms', 'task' => 'duplicate', 'id' => esc\_attr($row->id), '\_wpdevart\_bc\_nonce' => wp\_create\_nonce( 'duplicate\_item' ) ), admin\_url('admin.php'))); ?>"><?php \_e('Duplicate','booking-calendar'); ?></a></td> |
  |  | 65 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-forms', 'task' => 'edit', 'id' => esc\_attr($row->id) ), admin\_url('admin.php'))); ?>"><?php \_e('Edit','booking-calendar'); ?></a></td> |
  |  | 66 | <td><a href="" onclick="wpdevart\_set\_value('task','delete'); wpdevart\_set\_value('cur\_id','<?php echo esc\_attr($row->id); ?>'); wpdevart\_form\_submit(event, 'forms\_form')" ><?php \_e('Delete','booking-calendar'); ?></a></td> |
  | 67 | 67 | <tr> |
  | 68 | 68 | <?php   } |
* ## [booking-calendar/trunk/admin/views/GlobalSettings.php](/changeset/3209851/booking-calendar/trunk/admin/views/GlobalSettings.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/views/GlobalSettings.php")

  | [r2848690](/browser/booking-calendar/trunk/admin/views/GlobalSettings.php?rev=2848690#L64 "Show revision 2848690 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/views/GlobalSettings.php?rev=3209851#L64 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 64 | 64 | <div id="wpdevart-tabs-item-container" class="div-for-clear"> |
  | 65 | 65 | <?php foreach( $wpdevart\_themes as $key=>$wpdevart\_setting ) { ?> |
  | 66 |  | <div id="wpdevart\_theme-tab-<?php echo $key; ?>\_container" class="wpdevart\_container wpdevart-item-section <?php echo ($key == "general")? "show" : ""; ?>"> |
  | 67 |  | <?php foreach( $wpdevart\_setting['sections'] as $value\_key=>$value\_setting ) { ?> |
  | 68 |  |  |
  |  | 66 | <div id="wpdevart\_theme-tab-<?php echo esc\_attr($key); ?>\_container" class="wpdevart\_container wpdevart-item-section <?php echo ($key == "general")? "show" : ""; ?>"> |
  |  | 67 | <?php foreach( $wpdevart\_setting['sections'] as $value\_key=>$value\_setting ) { ?> |
  | 69 | 68 | <div> |
  | 70 | 69 | <?php |
  | […](/browser/booking-calendar/trunk/admin/views/GlobalSettings.php?rev=2848690#L72) | […](/browser/booking-calendar/trunk/admin/views/GlobalSettings.php?rev=3209851#L71) |  |
  | 72 | 71 | if(isset($wpdevart\_setting\_value["extra\_div"]) && $wpdevart\_setting\_value["extra\_div"]){ |
  | 73 | 72 | echo "<div class='items\_open'>"; |
  | 74 |  | } |
  | 75 |  |  |
  |  | 73 | } |
  | 76 | 74 | if( isset($settings[$key]) ) { |
  | 77 | 75 | $sett\_value = $settings[$key]; |
* ## [booking-calendar/trunk/admin/views/Reservations.php](/changeset/3209851/booking-calendar/trunk/admin/views/Reservations.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/views/Reservations.php")

  | [r2848690](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L42 "Show revision 2848690 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L42 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 42 | 42 | } |
  | 43 | 43 | ?> |
  | 44 |  | <div id="wpdevart\_reservations\_container" class="wpdevart-list-container list-view <?php echo ~~$class~~; ?>"> |
  |  | 44 | <div id="wpdevart\_reservations\_container" class="wpdevart-list-container list-view <?php echo esc\_attr($class); ?>"> |
  | 45 | 45 | <form action="admin.php?page=wpdevart-reservations" method="get" id="reservations\_form\_cal"> |
  | 46 | 46 | <input type="hidden" name="page" value="wpdevart-reservations"> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L53) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L53) |  |
  | 53 | 53 | <option value='0'><?php \_e('Select Calendar','booking-calendar'); ?></option> |
  | 54 | 54 | <?php foreach($calendar\_rows as $calendar\_row) { |
  | 55 |  | echo "<option value='".~~$calendar\_row["id"]."' ".selected($calendar\_id, $calendar\_row["id"], false).">".$calendar\_row["title"]~~."</option>"; |
  |  | 55 | echo "<option value='".esc\_attr($calendar\_row["id"])."' ".selected($calendar\_id, $calendar\_row["id"], false).">".esc\_html($calendar\_row["title"])."</option>"; |
  | 56 | 56 | } ?> |
  | 57 | 57 | </select> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L60) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L60) |  |
  | 60 | 60 | <span id="view\_calendar" class="pro-field"><span class="reservation-item-info"><?php \_e('Reservation Month View','booking-calendar'); ?><span class="pro\_feature">(Pro Feature!)</span></span></span> |
  | 61 | 61 | <?php else : ?> |
  | 62 |  | <a id="view\_calendar" href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => $calendar\_id, 'task' => 'display\_month\_reservations' ), admin\_url('admin.php'~~)); ?>"><span class="reservation-item-info"><?php \_e('Reservation Month View','booking-calendar'); ?></span></a> |
  |  | 62 | <a id="view\_calendar" href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => esc\_attr($calendar\_id), 'task' => 'display\_month\_reservations' ), admin\_url('admin.php'))); ?>"><span class="reservation-item-info"><?php \_e('Reservation Month View','booking-calendar'); ?></span></a> |
  | 63 | 63 | <?php endif; ?> |
  | 64 |  | <a id="add\_reservation" href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => $calendar\_id,'task' => 'add' ), admin\_url('admin.php'~~)); ?>" class="add-reservation"><span class="plus">+</span><span class="reservation-item-info"><?php \_e('Add Reservation','booking-calendar'); ?></span></a> |
  |  | 64 | <a id="add\_reservation" href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => esc\_attr($calendar\_id),'task' => 'add' ), admin\_url('admin.php'))); ?>" class="add-reservation"><span class="plus">+</span><span class="reservation-item-info"><?php \_e('Add Reservation','booking-calendar'); ?></span></a> |
  | 65 | 65 | </div> |
  | 66 | 66 | </form> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L86) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L86) |  |
  | 86 | 86 | foreach($new\_res as $res){ |
  | 87 | 87 | if(is\_array($res)) |
  | 88 |  | echo '<span class="form\_info"><span class="form\_label">'.~~$res["title"].'</span> <span class="form\_value"><span>'.$res["countRes"]~~.'</span></span></span>'; |
  |  | 88 | echo '<span class="form\_info"><span class="form\_label">'.esc\_html($res["title"]).'</span> <span class="form\_value"><span>'.esc\_html($res["countRes"]).'</span></span></span>'; |
  | 89 | 89 | } |
  | 90 | 90 | echo '</div>'; |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L93) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L93) |  |
  | 93 | 93 | foreach($new\_res as $res){ |
  | 94 | 94 | if(is\_array($res)) |
  | 95 |  | echo '<span class="form\_info"><span class="form\_label">'.\_\_("New reservations",'booking-calendar').'</span> <span class="form\_value"><span>'.~~$res["countRes"]~~.'</span></span></span>'; |
  |  | 95 | echo '<span class="form\_info"><span class="form\_label">'.\_\_("New reservations",'booking-calendar').'</span> <span class="form\_value"><span>'.esc\_html($res["countRes"]).'</span></span></span>'; |
  | 96 | 96 | } |
  | 97 | 97 | echo '</div>'; |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L164) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L164) |  |
  | 164 | 164 | <thead> |
  | 165 | 165 | <th class="check-column"><input type="checkbox" name="check\_all" onclick="check\_all\_checkboxes(this,'check\_for\_action');"></th> |
  | 166 |  | <th class="small-column <?php echo (($res\_order\_by == 'id')? ~~$res\_order\_class~~ : ""); ?>"><a onclick="wpdevart\_set\_value('order\_by', 'id'); wpdevart\_set\_value('asc\_desc', '<?php echo (($res\_order\_by == 'id' && $asc\_desc == 'asc') ? 'desc' : 'asc'); ?>');wpdevart\_form\_submit(event, 'reservations\_form')" href=""><span><?php \_e('ID','booking-calendar'); ?></span><span class="sorting-indicator"></span></a></th> |
  | 167 |  | <th class="average-column <?php echo (($res\_order\_by == 'status')? ~~$res\_order\_class~~ : ""); ?>"><a onclick="wpdevart\_set\_value('order\_by', 'status'); wpdevart\_set\_value('asc\_desc', '<?php echo (($res\_order\_by == 'status' && $asc\_desc == 'asc') ? 'desc' : 'asc'); ?>');wpdevart\_form\_submit(event, 'reservations\_form')" href=""><span><?php \_e('Status','booking-calendar'); ?></span><span class="sorting-indicator"></span></a></th> |
  |  | 166 | <th class="small-column <?php echo (($res\_order\_by == 'id')? esc\_attr($res\_order\_class) : ""); ?>"><a onclick="wpdevart\_set\_value('order\_by', 'id'); wpdevart\_set\_value('asc\_desc', '<?php echo (($res\_order\_by == 'id' && $asc\_desc == 'asc') ? 'desc' : 'asc'); ?>');wpdevart\_form\_submit(event, 'reservations\_form')" href=""><span><?php \_e('ID','booking-calendar'); ?></span><span class="sorting-indicator"></span></a></th> |
  |  | 167 | <th class="average-column <?php echo (($res\_order\_by == 'status')? esc\_attr($res\_order\_class) : ""); ?>"><a onclick="wpdevart\_set\_value('order\_by', 'status'); wpdevart\_set\_value('asc\_desc', '<?php echo (($res\_order\_by == 'status' && $asc\_desc == 'asc') ? 'desc' : 'asc'); ?>');wpdevart\_form\_submit(event, 'reservations\_form')" href=""><span><?php \_e('Status','booking-calendar'); ?></span><span class="sorting-indicator"></span></a></th> |
  | 168 | 168 | <th class="res\_info"><?php \_e('Reservation information','booking-calendar'); ?></th> |
  | 169 | 169 | <?php if(WPDEVART\_PRO == "extended" && $class != "") : ?> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L243) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L243) |  |
  | 243 | 243 |  |
  | 244 | 244 | <tr id="id\_<?php echo $row->id; ?>"> |
  | 245 |  | <td><input type="checkbox" name="check\_for\_action[]" class="check\_for\_action" value="<?php echo ~~$row->id~~; ?>"></td> |
  |  | 245 | <td><input type="checkbox" name="check\_for\_action[]" class="check\_for\_action" value="<?php echo esc\_attr($row->id); ?>"></td> |
  | 246 | 246 | <td><?php echo $row->id; ?></td> |
  | 247 |  | <td><span class="reserv\_status reserv\_status\_<?php echo ~~$row->status; ?>"><?php echo $status~~; ?><span></td> |
  |  | 247 | <td><span class="reserv\_status reserv\_status\_<?php echo esc\_attr($row->status); ?>"><?php echo esc\_html($status); ?><span></td> |
  | 248 | 248 | <td> |
  | 249 | 249 | <div class="reserv-info div-for-clear"> |
  | 250 | 250 | <div class='reserv-info-container'> |
  | 251 | 251 | <h5  class="reserv-info-open-title"><?php \_e('Details','booking-calendar'); ?><span class="reserv-info-open"><i class="fa fa-chevron-down" aria-hidden="true"></i></span></h5> |
  | 252 |  | <span class='form\_info'><span class='form\_label'><?php \_e('Item Count','booking-calendar'); ?></span> <span class='form\_value'><?php echo ~~$row->count\_item~~; ?></span></span> |
  |  | 252 | <span class='form\_info'><span class='form\_label'><?php \_e('Item Count','booking-calendar'); ?></span> <span class='form\_value'><?php echo esc\_html($row->count\_item); ?></span></span> |
  | 253 | 253 | <?php if(!isset($theme\_options['hide\_price'])) { ?> |
  | 254 |  | <span class='form\_info'><span class='form\_label'><?php \_e('Price','booking-calendar'); ?></span> <span class='form\_value'><?php echo ($cur\_pos == "before" ? ~~$row->currency : '') . $row->price . (($cur\_pos == "after") ? $row->currency~~ : ''); ?></span></span> |
  | 255 |  | <span class='form\_info'><span class='form\_label'><?php \_e('Total Price','booking-calendar'); ?></span> <span class='form\_value'><?php echo ~~$sale\_percent\_html . ($cur\_pos == "before" ? $row->currency : '') . $row->total\_price . ($cur\_pos == "after" ? $row->currency~~ : ''); ?></span></span> |
  |  | 254 | <span class='form\_info'><span class='form\_label'><?php \_e('Price','booking-calendar'); ?></span> <span class='form\_value'><?php echo ($cur\_pos == "before" ? esc\_html($row->currency) : '') . esc\_html($row->price) . (($cur\_pos == "after") ? esc\_html($row->currency) : ''); ?></span></span> |
  |  | 255 | <span class='form\_info'><span class='form\_label'><?php \_e('Total Price','booking-calendar'); ?></span> <span class='form\_value'><?php echo esc\_html($sale\_percent\_html) . ($cur\_pos == "before" ? esc\_html($row->currency) : '') . esc\_html($row->total\_price) . ($cur\_pos == "after" ? esc\_html($row->currency) : ''); ?></span></span> |
  | 256 | 256 | <?php } ?> |
  | 257 | 257 | </div> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L272) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L272) |  |
  | 272 | 272 | } |
  | 273 | 273 | if($start == 1 && (!($row->end\_hour == "" && $count == 1))) { ?> |
  | 274 |  | <span class='form\_info'><span class='form\_label'><?php echo ~~$key; ?></span> <span class='form\_value'><?php echo ($cur\_pos == "before" ? $row->currency : '').(isset($hour["price"]) ? $hour["price"] : "").($cur\_pos == "after" ? $row->currency : ''); ?><span class="hour-info"><?php echo (isset($hour["info\_users"])) ? $hour["info\_users"]~~ : ""; ?></span></span></span> |
  |  | 274 | <span class='form\_info'><span class='form\_label'><?php echo esc\_html($key); ?></span> <span class='form\_value'><?php echo ($cur\_pos == "before" ? esc\_html($row->currency) : '').(isset($hour["price"]) ? esc\_html($hour["price"]) : "").($cur\_pos == "after" ? esc\_html($row->currency) : ''); ?><span class="hour-info"><?php echo (isset($hour["info\_users"])) ? esc\_html($hour["info\_users"]) : ""; ?></span></span></span> |
  | 275 | 275 | <?php $count += 1; |
  | 276 | 276 | } |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L289) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L289) |  |
  | 289 | 289 | foreach($form\_data as $form\_fild\_data) { |
  | 290 | 290 | if($form\_fild\_data['type'] == 'countries' && trim($form\_fild\_data['value']) != "") { |
  | 291 |  | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". ~~wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]) ."</span> <span class='form\_value'>". $countries[$form\_fild\_data["value"]]~~ ."</span></span>"; |
  |  | 291 | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". esc\_html(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"])) ."</span> <span class='form\_value'>". esc\_html($countries[$form\_fild\_data["value"]]) ."</span></span>"; |
  | 292 | 292 | }else { |
  | 293 | 293 | $value = $form\_fild\_data["value"]; |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L298) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L298) |  |
  | 298 | 298 | if($form\_fild\_data["type"] == "upload" && trim($value) != "") |
  | 299 | 299 | $value = "<a href='" . $value . "' target='\_blank'>" . \_\_("File", 'booking-calendar') . "</a>"; |
  | 300 |  | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". ~~wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]) ."</span> <span class='form\_value'>". $value~~ ."</span></span>"; |
  |  | 300 | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". esc\_html(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"])) ."</span> <span class='form\_value'>". esc\_html($value) ."</span></span>"; |
  | 301 | 301 | } |
  | 302 | 302 | } |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L308) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L308) |  |
  | 308 | 308 | $reserv\_info .= "<h5>" .\_\_("Extra Information",'booking-calendar')."</h5>"; |
  | 309 | 309 | foreach($extras\_data as $extra\_data) { |
  | 310 |  | $reserv\_info .= "<h6>".~~wpdevart\_bc\_Library::translated\_text($extra\_data["group\_label"]~~)."</h6>"; |
  | 311 |  | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". ~~wpdevart\_bc\_Library::translated\_text($extra\_data["label"]~~) ."</span>"; |
  |  | 310 | $reserv\_info .= "<h6>".esc\_html(wpdevart\_bc\_Library::translated\_text($extra\_data["group\_label"]))."</h6>"; |
  |  | 311 | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". esc\_html(wpdevart\_bc\_Library::translated\_text($extra\_data["label"])) ."</span>"; |
  | 312 | 312 | $reserv\_info .= "<span class='form\_value'>"; |
  | 313 | 313 | if($extra\_data["price\_type"] == "percent") { |
  | 314 |  | $reserv\_info .= "<span class='price-percent'>".~~$extra\_data["operation"].$extra\_data["price\_percent"]~~."%</span>"; |
  | 315 |  | $reserv\_info .= "<span class='price'>".~~$extra\_data["operation"] . (($cur\_pos == "before" ? $row->currency : '') . (isset($extra\_data["price"]) ? $extra\_data["price"] : "") . (($cur\_pos == "after") ? $row->currency~~ : ''))."</span></span></span>"; |
  |  | 314 | $reserv\_info .= "<span class='price-percent'>".esc\_html($extra\_data["operation"]).esc\_html($extra\_data["price\_percent"])."%</span>"; |
  |  | 315 | $reserv\_info .= "<span class='price'>".esc\_html($extra\_data["operation"]) . (($cur\_pos == "before" ? esc\_html($row->currency) : '') . (isset($extra\_data["price"]) ? esc\_html($extra\_data["price"]) : "") . (($cur\_pos == "after") ? esc\_html($row->currency) : ''))."</span></span></span>"; |
  | 316 | 316 | } else { |
  | 317 |  | $reserv\_info .= "<span class='price'>".~~$extra\_data["operation"] .(($cur\_pos == "before" ? $row->currency : '') . $extra\_data["price"] . ($cur\_pos == "after" ? $row->currency~~ : ''))."</span></span></span>"; |
  |  | 317 | $reserv\_info .= "<span class='price'>".esc\_html($extra\_data["operation"]) .(($cur\_pos == "before" ? esc\_html($row->currency) : '') . esc\_html($extra\_data["price"]) . ($cur\_pos == "after" ? esc\_html($row->currency) : ''))."</span></span></span>"; |
  | 318 | 318 | } |
  | 319 | 319 |  |
  | 320 | 320 | } |
  | 321 | 321 | $reserv\_info .= "<h6>" .\_\_("Price change",'booking-calendar')."</h6>"; |
  | 322 |  | $reserv\_info .= "<span class='form\_info'><span class='form\_label'></span><span class='form\_value'>".(($row->extras\_price<0)? "" : "+").($cur\_pos == "before" ? ~~$row->currency : '') . $row->extras\_price . ($cur\_pos == "after" ? $row->currency~~ : '')."</span>"; |
  |  | 322 | $reserv\_info .= "<span class='form\_info'><span class='form\_label'></span><span class='form\_value'>".(($row->extras\_price<0)? "" : "+").($cur\_pos == "before" ? esc\_html($row->currency) : '') . esc\_html($row->extras\_price) . ($cur\_pos == "after" ? esc\_html($row->currency) : '')."</span>"; |
  | 323 | 323 | $reserv\_info .= "</div></div>"; |
  | 324 | 324 | } |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L329) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L329) |  |
  | 329 | 329 | foreach($billing\_data as $form\_fild\_data) { |
  | 330 | 330 | if($form\_fild\_data['type'] == 'countries' && trim($form\_fild\_data['value']) != "") { |
  | 331 |  | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". ~~wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]) ."</span> <span class='form\_value'>". $countries[$form\_fild\_data["value"]]~~ ."</span></span>"; |
  |  | 331 | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". esc\_html(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"])) ."</span> <span class='form\_value'>". esc\_html($countries[$form\_fild\_data["value"]]) ."</span></span>"; |
  | 332 | 332 | }else { |
  | 333 | 333 | $value = $form\_fild\_data["value"]; |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L336) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L336) |  |
  | 336 | 336 | $value = implode(", ",$value); |
  | 337 | 337 | } |
  | 338 |  | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". ~~wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]) ."</span> <span class='form\_value'>". $value~~ ."</span></span>"; |
  |  | 338 | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". esc\_html(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"])) ."</span> <span class='form\_value'>". esc\_html($value) ."</span></span>"; |
  | 339 | 339 | } |
  | 340 | 340 | } |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L347) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L347) |  |
  | 347 | 347 | foreach($shipping\_data as $form\_fild\_data) { |
  | 348 | 348 | if($form\_fild\_data['type'] == 'countries' && trim($form\_fild\_data['value']) != "") { |
  | 349 |  | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". ~~wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]) ."</span> <span class='form\_value'>". $countries[$form\_fild\_data["value"]]~~ ."</span></span>"; |
  |  | 349 | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". esc\_html(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"])) ."</span> <span class='form\_value'>". esc\_html($countries[$form\_fild\_data["value"]]) ."</span></span>"; |
  | 350 | 350 | }else { |
  | 351 | 351 | $value = $form\_fild\_data["value"]; |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L354) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L354) |  |
  | 354 | 354 | $value = implode(", ",$value); |
  | 355 | 355 | } |
  | 356 |  | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". ~~wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"]) ."</span> <span class='form\_value'>". $value~~ ."</span></span>"; |
  |  | 356 | $reserv\_info .= "<span class='form\_info'><span class='form\_label'>". esc\_html(wpdevart\_bc\_Library::translated\_text($form\_fild\_data["label"])) ."</span> <span class='form\_value'>". esc\_html($value) ."</span></span>"; |
  | 357 | 357 | } |
  | 358 | 358 | } |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L372) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L372) |  |
  | 372 | 372 | <?php } ?> |
  | 373 | 373 | </h5> |
  | 374 |  | <span class='form\_info'><span class='form\_label'><?php \_e('Payment Status','booking-calendar'); ?></span> <span class='form\_value'><span class="payment\_status paypal"><?php echo ~~$row->pay\_status~~; ?></span></span></span> |
  |  | 374 | <span class='form\_info'><span class='form\_label'><?php \_e('Payment Status','booking-calendar'); ?></span> <span class='form\_value'><span class="payment\_status paypal"><?php echo esc\_html($row->pay\_status); ?></span></span></span> |
  | 375 | 375 | </div> |
  | 376 | 376 | </div> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L386) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L386) |  |
  | 386 | 386 | if($key == "payment\_price") |
  | 387 | 387 | $cur = $row->currency; |
  | 388 |  | $pay .= "<span class='form\_info'><span class='form\_label'>".~~str\_replace("\_"," ", ucfirst($key)) ."</span> <span class='form\_value'>".((isset($theme\_options['currency\_pos']) && $theme\_options['currency\_pos'] == "before" && $cur != "") ? $cur : ""). $value .(((isset($theme\_options['currency\_pos']) && $theme\_options['currency\_pos'] == "after") || !isset($theme\_options['currency\_pos'])) ? $cur~~ : '').($key == "tax" ? "%" : "")."</span></span>"; |
  |  | 388 | $pay .= "<span class='form\_info'><span class='form\_label'>".esc\_html(str\_replace("\_"," ", ucfirst($key))) ."</span> <span class='form\_value'>".((isset($theme\_options['currency\_pos']) && $theme\_options['currency\_pos'] == "before" && $cur != "") ? esc\_html($cur) : ""). esc\_html($value) .(((isset($theme\_options['currency\_pos']) && $theme\_options['currency\_pos'] == "after") || !isset($theme\_options['currency\_pos'])) ? esc\_html($cur) : '').($key == "tax" ? "%" : "")."</span></span>"; |
  | 389 | 389 | } |
  | 390 | 390 | $pay .= "</div>"; |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L398) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L398) |  |
  | 398 | 398 | <div class='reserv-info-container'> |
  | 399 | 399 | <h5  class="reserv-info-open-title"><?php \_e('Payment method - Pay in cash','booking-calendar'); ?></h5> |
  | 400 |  | <span class='form\_info'><span class='form\_label'><?php \_e('Payment Status','booking-calendar'); ?></span> <span class='form\_value'><span class="payment\_status pay\_in\_cash"><?php echo ~~$row->payment\_status~~; ?></span></span></span> |
  |  | 400 | <span class='form\_info'><span class='form\_label'><?php \_e('Payment Status','booking-calendar'); ?></span> <span class='form\_value'><span class="payment\_status pay\_in\_cash"><?php echo esc\_html($row->payment\_status); ?></span></span></span> |
  | 401 | 401 | </div> |
  | 402 | 402 | </div> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L416) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L416) |  |
  | 416 | 416 |  |
  | 417 | 417 | if(isset($row->is\_new) && $row->is\_new == 1){ ?> |
  | 418 |  | <a href=''  onclick="wpdevart\_set\_value('task','mark\_read'); wpdevart\_set\_value('cur\_id','<?php echo ~~$row->id~~; ?>'); wpdevart\_form\_submit(event, 'reservations\_form')" title="<?php \_e("Mark as read","booking-calendar"); ?>"><span class='new\_res'><?php \_e("New","booking-calendar"); ?></span> |
  |  | 418 | <a href=''  onclick="wpdevart\_set\_value('task','mark\_read'); wpdevart\_set\_value('cur\_id','<?php echo esc\_attr($row->id); ?>'); wpdevart\_form\_submit(event, 'reservations\_form')" title="<?php \_e("Mark as read","booking-calendar"); ?>"><span class='new\_res'><?php \_e("New","booking-calendar"); ?></span> |
  | 419 | 419 | <?php } ?> |
  | 420 | 420 | </td> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L424) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L424) |  |
  | 424 | 424 | <span class="buttons"> |
  | 425 | 425 | <?php if($row->status == "pending" || $row->status == "canceled" || $row->status == "rejected") { ?> |
  | 426 |  | <a href="" onclick="wpdevart\_set\_value('task','approve'); wpdevart\_set\_value('cur\_id','<?php echo ~~$row->id~~; ?>'); wpdevart\_form\_submit(event, 'reservations\_form')"  class="action-button approve-button" ><?php \_e('Approve','booking-calendar'); ?></a> |
  |  | 426 | <a href="" onclick="wpdevart\_set\_value('task','approve'); wpdevart\_set\_value('cur\_id','<?php echo esc\_attr($row->id); ?>'); wpdevart\_form\_submit(event, 'reservations\_form')"  class="action-button approve-button" ><?php \_e('Approve','booking-calendar'); ?></a> |
  | 427 | 427 | <?php if($row->status == "pending") { ?> |
  | 428 |  | <a href="" onclick="wpdevart\_set\_value('task','reject'); wpdevart\_set\_value('cur\_id','<?php echo ~~$row->id~~; ?>'); wpdevart\_form\_submit(event, 'reservations\_form')" class="action-button reject-button" ><?php \_e('Reject','booking-calendar'); ?></a> |
  |  | 428 | <a href="" onclick="wpdevart\_set\_value('task','reject'); wpdevart\_set\_value('cur\_id','<?php echo esc\_attr($row->id); ?>'); wpdevart\_form\_submit(event, 'reservations\_form')" class="action-button reject-button" ><?php \_e('Reject','booking-calendar'); ?></a> |
  | 429 | 429 | <?php  } ?> |
  | 430 | 430 | <?php } elseif($row->status == "approved") { ?> |
  | 431 |  | <a href="" onclick="wpdevart\_set\_value('task','canceled'); wpdevart\_set\_value('cur\_id','<?php echo ~~$row->id~~; ?>'); wpdevart\_form\_submit(event, 'reservations\_form')" class="action-button cancel-button" ><?php \_e('Cancel','booking-calendar'); ?></a> |
  |  | 431 | <a href="" onclick="wpdevart\_set\_value('task','canceled'); wpdevart\_set\_value('cur\_id','<?php echo esc\_attr($row->id); ?>'); wpdevart\_form\_submit(event, 'reservations\_form')" class="action-button cancel-button" ><?php \_e('Cancel','booking-calendar'); ?></a> |
  | 432 | 432 | <?php  } ?> |
  | 433 |  | <a href="" onclick="wpdevart\_set\_value('task','delete'); wpdevart\_set\_value('cur\_id','<?php echo ~~$row->id~~; ?>'); wpdevart\_form\_submit(event, 'reservations\_form')"  class="action-button delete-button"><?php \_e('Delete','booking-calendar'); ?></a> |
  |  | 433 | <a href="" onclick="wpdevart\_set\_value('task','delete'); wpdevart\_set\_value('cur\_id','<?php echo esc\_attr($row->id); ?>'); wpdevart\_form\_submit(event, 'reservations\_form')"  class="action-button delete-button"><?php \_e('Delete','booking-calendar'); ?></a> |
  | 434 | 434 | </span> |
  | 435 | 435 |  |
  | 436 | 436 | <span class="buttons"> |
  | 437 |  | <a  <?php echo (WPDEVART\_PRO == "extended" ) ? 'onclick="wpdevart\_set\_value(\'task\',\'edit\'); wpdevart\_set\_value(\'cur\_id\',' . ~~$row->id~~ .'); wpdevart\_form\_submit(event, \'reservations\_form\')"' : ""; ?>  class="action-button cal-edit-button wpdevart-button"><?php \_e('Edit','booking-calendar'); ?> |
  |  | 437 | <a  <?php echo (WPDEVART\_PRO == "extended" ) ? 'onclick="wpdevart\_set\_value(\'task\',\'edit\'); wpdevart\_set\_value(\'cur\_id\',' . esc\_attr($row->id) .'); wpdevart\_form\_submit(event, \'reservations\_form\')"' : ""; ?>  class="action-button cal-edit-button wpdevart-button"><?php \_e('Edit','booking-calendar'); ?> |
  | 438 | 438 | <?php if(WPDEVART\_PRO != "extended" ) : ?> |
  | 439 | 439 | <span>(Extended)</span> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L441) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L441) |  |
  | 441 | 441 | </a> |
  | 442 | 442 | <?php if(isset($row->payment\_status) && $row->payment\_status != "") :?> |
  | 443 |  | <a  onclick="quick\_edit(this,'<?php echo ~~$row->id~~; ?>');"  class="action-button quick-edit-button wpdevart-button"><?php \_e('Payment Status Edit','booking-calendar'); ?></a> |
  |  | 443 | <a  onclick="quick\_edit(this,'<?php echo esc\_attr($row->id); ?>');"  class="action-button quick-edit-button wpdevart-button"><?php \_e('Payment Status Edit','booking-calendar'); ?></a> |
  | 444 | 444 | <?php endif; ?> |
  | 445 |  | <a  onclick="cancel\_edit(this,'<?php echo ~~$row->id; ?>');"  class="action-button cancel-edit-button wpdevart-button cancel\_<?php echo $row->id~~; ?>"><?php \_e('Cancel','booking-calendar'); ?></a> |
  | 446 |  | <a  onclick="quick\_update(this,'<?php echo ~~$row->id~~; ?>');"  class="action-button update-edit-button wpdevart-button"><?php \_e('Update','booking-calendar'); ?></a> |
  |  | 445 | <a  onclick="cancel\_edit(this,'<?php echo esc\_attr($row->id); ?>');"  class="action-button cancel-edit-button wpdevart-button cancel\_<?php echo esc\_attr($row->id); ?>"><?php \_e('Cancel','booking-calendar'); ?></a> |
  |  | 446 | <a  onclick="quick\_update(this,'<?php echo esc\_attr($row->id); ?>');"  class="action-button update-edit-button wpdevart-button"><?php \_e('Update','booking-calendar'); ?></a> |
  | 447 | 447 | <span class="spinner"></span> |
  | 448 | 448 | </span> |
  | 449 | 449 | </td> |
  | 450 | 450 | <td colspan="1"> |
  | 451 |  | <div class="created\_date"><?php \_e('Created:','booking-calendar'); ?> <?php echo ~~date($date\_format. " H:i", strtotime($row->date\_created~~)); ?></div> |
  |  | 451 | <div class="created\_date"><?php \_e('Created:','booking-calendar'); ?> <?php echo esc\_html(date($date\_format. " H:i", strtotime($row->date\_created))); ?></div> |
  | 452 | 452 | </td> |
  | 453 | 453 | </tr> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L484) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L484) |  |
  | 484 | 484 | <option value='0'><?php \_e('Select Calendar','booking-calendar'); ?></option> |
  | 485 | 485 | <?php foreach($calendar\_rows as $calendar\_row) { |
  | 486 |  | echo "<option value='".~~$calendar\_row["id"]."' ".selected($calendar\_id, $calendar\_row["id"],false).">".$calendar\_row["title"]~~."</option>"; |
  |  | 486 | echo "<option value='".esc\_attr($calendar\_row["id"])."' ".selected($calendar\_id, $calendar\_row["id"],false).">".esc\_html($calendar\_row["title"])."</option>"; |
  | 487 | 487 | } ?> |
  | 488 | 488 | </select> |
  | 489 |  | <a id="view\_list" href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => $calendar\_id,'task' => 'display\_reservations' ), admin\_url('admin.php'~~)); ?>"><span class="reservation-item-info"><?php \_e('Reservation List View','booking-calendar'); ?></span></a> |
  |  | 489 | <a id="view\_list" href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => esc\_attr($calendar\_id),'task' => 'display\_reservations' ), admin\_url('admin.php'))); ?>"><span class="reservation-item-info"><?php \_e('Reservation List View','booking-calendar'); ?></span></a> |
  | 490 | 490 | <span id="view\_calendar"><span class="reservation-item-info"><?php \_e('Reservation Month View','booking-calendar'); ?></span></span> |
  | 491 |  | <a id="add\_reservation" href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => $calendar\_id,'task' => 'add' ), admin\_url('admin.php'~~)); ?>" class="add-reservation"><span class="plus">+</span><span class="reservation-item-info"><?php \_e('Add Reservation','booking-calendar'); ?></span></a> |
  |  | 491 | <a id="add\_reservation" href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => esc\_attr($calendar\_id),'task' => 'add' ), admin\_url('admin.php'))); ?>" class="add-reservation"><span class="plus">+</span><span class="reservation-item-info"><?php \_e('Add Reservation','booking-calendar'); ?></span></a> |
  | 492 | 492 | </div> |
  | 493 | 493 |  |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L498) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L498) |  |
  | 498 | 498 | $booking\_obg = new wpdevart\_bc\_calendar(); |
  | 499 | 499 | $result = $booking\_obg->wpdevart\_booking\_calendar\_res($calendar\_id); |
  | 500 |  | echo $result; |
  |  | 500 | echo $result; // result isn't needed to escape because this function is generating a calendar that is already escaped. |
  | 501 | 501 | } ?> |
  | 502 | 502 | </div> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L523) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L523) |  |
  | 523 | 523 | <option value='0'><?php \_e('Select Calendar','booking-calendar'); ?></option> |
  | 524 | 524 | <?php foreach($calendar\_rows as $calendar\_row) { |
  | 525 |  | echo "<option value='".~~$calendar\_row["id"]."' ".selected($calendar\_id, $calendar\_row["id"],false).">".$calendar\_row["title"]~~."</option>"; |
  |  | 525 | echo "<option value='".esc\_attr($calendar\_row["id"])."' ".selected($calendar\_id, $calendar\_row["id"],false).">".esc\_html($calendar\_row["title"])."</option>"; |
  | 526 | 526 | } ?> |
  | 527 | 527 | </select> |
  | 528 |  | <a id="view\_list" href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => $calendar\_id,'task' => 'display\_reservations' ), admin\_url('admin.php'~~)); ?>"><span class="reservation-item-info"><?php \_e('Reservation List View','booking-calendar'); ?></span></a> |
  |  | 528 | <a id="view\_list" href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => esc\_attr($calendar\_id),'task' => 'display\_reservations' ), admin\_url('admin.php'))); ?>"><span class="reservation-item-info"><?php \_e('Reservation List View','booking-calendar'); ?></span></a> |
  | 529 | 529 | <?php if (WPDEVART\_PRO == "free") : ?> |
  | 530 | 530 | <span id="view\_calendar" class="pro-field"><span class="reservation-item-info"><?php \_e('Reservation Month View','booking-calendar'); ?><span class="pro\_feature">(Pro Feature!)</span></span></span> |
  | 531 | 531 | <?php else : ?> |
  | 532 |  | <a id="view\_calendar" href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => $calendar\_id,'task' => 'display\_month\_reservations' ), admin\_url('admin.php'~~)); ?>"><span class="reservation-item-info"><?php \_e('Reservation Month View','booking-calendar'); ?></span></a> |
  |  | 532 | <a id="view\_calendar" href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-reservations', 'calendar\_id' => esc\_attr($calendar\_id),'task' => 'display\_month\_reservations' ), admin\_url('admin.php'))); ?>"><span class="reservation-item-info"><?php \_e('Reservation Month View','booking-calendar'); ?></span></a> |
  | 533 | 533 | <?php endif; ?> |
  | 534 | 534 | <span id="add\_reservation" class="add-reservation"><span class="plus">+</span><span class="reservation-item-info"><?php \_e('Add Reservation','booking-calendar'); ?></span></span> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L543) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L543) |  |
  | 543 | 543 | $booking\_obg = new wpdevart\_bc\_calendar(); |
  | 544 | 544 | $result = $booking\_obg->wpdevart\_booking\_calendar($calendar\_id); |
  | 545 |  | echo $result; |
  |  | 545 | echo $result; // result isn't needed to escape because this function is generating a calendar that is already escaped. |
  | 546 | 546 | } ?> |
  | 547 | 547 | </div> |
  | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=2848690#L563) | […](/browser/booking-calendar/trunk/admin/views/Reservations.php?rev=3209851#L563) |  |
  | 563 | 563 | $booking\_obg = new wpdevart\_bc\_calendar(); |
  | 564 | 564 | $result = $booking\_obg->wpdevart\_booking\_calendar($calendar\_id, $id); |
  | 565 |  | echo $result; |
  |  | 565 | echo $result; // result isn't needed to escape because this function is generating a calendar that is already escaped. |
  | 566 | 566 | } ?> |
  | 567 | 567 | </div> |
* ## [booking-calendar/trunk/admin/views/Themes.php](/changeset/3209851/booking-calendar/trunk/admin/views/Themes.php "Show the changeset 3209851 restricted to booking-calendar/trunk/admin/views/Themes.php")

  | [r2848690](/browser/booking-calendar/trunk/admin/views/Themes.php?rev=2848690#L30 "Show revision 2848690 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/admin/views/Themes.php?rev=3209851#L30 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 30 | 30 | $class = "updated"; |
  | 31 | 31 | } ?> |
  | 32 |  | <div id="message" class="<?php echo ~~$class; ?> notice is-dismissible"><p><?php echo $error\_msg~~; ?></p></div> |
  |  | 32 | <div id="message" class="<?php echo esc\_attr($class); ?> notice is-dismissible"><p><?php echo esc\_html($error\_msg); ?></p></div> |
  | 33 | 33 | <?php } ?> |
  | 34 | 34 | <form action="admin.php?page=wpdevart-themes" method="post" id="themes\_form"> |
  | […](/browser/booking-calendar/trunk/admin/views/Themes.php?rev=2848690#L51) | […](/browser/booking-calendar/trunk/admin/views/Themes.php?rev=3209851#L51) |  |
  | 51 | 51 | foreach ( $rows as $row ) { ?> |
  | 52 | 52 | <tr> |
  | 53 |  | <td><input type="checkbox" name="check\_for\_action[]" class="check\_for\_action" value="<?php echo ~~$row->id~~; ?>"></td> |
  | 54 |  | <td><?php echo ~~$row->id~~; ?></td> |
  | 55 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-themes', 'task' => 'edit', 'id' => $row->id ), admin\_url('admin.php')); ?>"><?php echo $row->title~~; ?></a></td> |
  |  | 53 | <td><input type="checkbox" name="check\_for\_action[]" class="check\_for\_action" value="<?php echo intval($row->id); ?>"></td> |
  |  | 54 | <td><?php echo intval($row->id); ?></td> |
  |  | 55 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-themes', 'task' => 'edit', 'id' => intval($row->id) ), admin\_url('admin.php'))); ?>"><?php echo esc\_html($row->title); ?></a></td> |
  | 56 | 56 | <?php if($role == "administrator"){ |
  | 57 | 57 | $user = $row->user\_id; |
  | 58 | 58 | $user\_info = get\_userdata( $user ); ?> |
  | 59 |  | <td><a href="<?php echo ~~get\_edit\_user\_link( $user ) ?>"><?php echo ($user\_info)? $user\_info->user\_login~~ : ""; ?></a></td> |
  |  | 59 | <td><a href="<?php echo esc\_url(get\_edit\_user\_link( $user )); ?>"><?php echo ($user\_info)? esc\_html($user\_info->user\_login) : ""; ?></a></td> |
  | 60 | 60 | <?php } ?> |
  | 61 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-themes', 'task' => 'duplicate', 'id' => $row->id, '\_wpdevart\_bc\_nonce' => wp\_create\_nonce( 'duplicate\_item' ) ), admin\_url('admin.php'~~)); ?>"><?php \_e('Duplicate','booking-calendar'); ?></a></td> |
  | 62 |  | <td><a href="<?php echo ~~add\_query\_arg(array( 'page' => 'wpdevart-themes', 'task' => 'edit', 'id' => $row->id ), admin\_url('admin.php'~~)); ?>"><?php \_e('Edit','booking-calendar'); ?></a></td> |
  | 63 |  | <td><a href="" onclick="wpdevart\_set\_value('task','delete'); wpdevart\_set\_value('cur\_id','<?php echo ~~$row->id~~; ?>'); wpdevart\_form\_submit(event, 'themes\_form')" ><?php \_e('Delete','booking-calendar'); ?></a></td> |
  |  | 61 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-themes', 'task' => 'duplicate', 'id' => intval($row->id), '\_wpdevart\_bc\_nonce' => wp\_create\_nonce( 'duplicate\_item' ) ), admin\_url('admin.php'))); ?>"><?php \_e('Duplicate','booking-calendar'); ?></a></td> |
  |  | 62 | <td><a href="<?php echo esc\_url(add\_query\_arg(array( 'page' => 'wpdevart-themes', 'task' => 'edit', 'id' => intval($row->id) ), admin\_url('admin.php'))); ?>"><?php \_e('Edit','booking-calendar'); ?></a></td> |
  |  | 63 | <td><a href="" onclick="wpdevart\_set\_value('task','delete'); wpdevart\_set\_value('cur\_id','<?php echo intval($row->id); ?>'); wpdevart\_form\_submit(event, 'themes\_form')" ><?php \_e('Delete','booking-calendar'); ?></a></td> |
  | 64 | 64 | </tr> |
  | 65 | 65 | <?php   } |
  | […](/browser/booking-calendar/trunk/admin/views/Themes.php?rev=2848690#L2426) | […](/browser/booking-calendar/trunk/admin/views/Themes.php?rev=3209851#L2426) |  |
  | 2426 | 2426 | <div id="wpdevart\_theme-tabs" class="div-for-clear"> |
  | 2427 | 2427 | <?php foreach($wpdevart\_themes as $key=>$wpdevart\_theme) { ?> |
  | 2428 |  | <div id="wpdevart\_theme-tab-<?php echo ~~$key; ?>" class="wpdevart\_tab <?php echo ($key == "general")? "show" : ""; ?>"><?php echo $wpdevart\_theme["title"]~~; |
  |  | 2428 | <div id="wpdevart\_theme-tab-<?php echo esc\_attr($key); ?>" class="wpdevart\_tab <?php echo ($key == "general")? "show" : ""; ?>"><?php echo esc\_html($wpdevart\_theme["title"]); |
  | 2429 | 2429 | if(isset($wpdevart\_theme["pro"]) &&  WPDEVART\_PRO != "extended") { |
  | 2430 | 2430 | if (WPDEVART\_PRO == "free") { |
  | 2431 |  | echo "<span class='pro\_feature'> (" . ~~ucfirst($wpdevart\_theme["pro"]~~) . " Feature!)</span>"; |
  |  | 2431 | echo "<span class='pro\_feature'> (" . esc\_html(ucfirst($wpdevart\_theme["pro"])) . " Feature!)</span>"; |
  | 2432 | 2432 | } |
  | 2433 | 2433 | elseif (WPDEVART\_PRO == "pro" && $wpdevart\_theme["pro"] == "extended") { |
  | 2434 |  | echo "<span class='pro\_feature'> (" . ~~ucfirst($wpdevart\_theme["pro"]~~) . " Feature!)</span>"; |
  |  | 2434 | echo "<span class='pro\_feature'> (" . esc\_html(ucfirst($wpdevart\_theme["pro"])) . " Feature!)</span>"; |
  | 2435 | 2435 | } |
  | 2436 | 2436 | } |
  | […](/browser/booking-calendar/trunk/admin/views/Themes.php?rev=2848690#L2441) | […](/browser/booking-calendar/trunk/admin/views/Themes.php?rev=3209851#L2441) |  |
  | 2441 | 2441 | <div id="wpdevart-tabs-item-container" class="div-for-clear"> |
  | 2442 | 2442 | <?php foreach( $wpdevart\_themes as $key=>$wpdevart\_setting ) { ?> |
  | 2443 |  | <div id="wpdevart\_theme-tab-<?php echo ~~$key~~; ?>\_container" class="wpdevart\_container wpdevart-item-section <?php echo ($key == "general")? "show" : ""; ?>"> |
  |  | 2443 | <div id="wpdevart\_theme-tab-<?php echo esc\_attr($key); ?>\_container" class="wpdevart\_container wpdevart-item-section <?php echo ($key == "general")? "show" : ""; ?>"> |
  | 2444 | 2444 | <?php foreach( $wpdevart\_setting['sections'] as $value\_key=>$value\_setting ) { ?> |
  | 2445 | 2445 | <div class="wpdevart-item-section-cont"> |
  | 2446 |  | <h3><?php echo ~~str\_replace("\_"," ",$value\_key~~); ?></h3> |
  |  | 2446 | <h3><?php echo esc\_html(str\_replace("\_"," ",$value\_key)); ?></h3> |
  | 2447 | 2447 | <div> |
  | 2448 | 2448 | <?php |
* ## [booking-calendar/trunk/booking\_calendar.php](/changeset/3209851/booking-calendar/trunk/booking_calendar.php "Show the changeset 3209851 restricted to booking-calendar/trunk/booking_calendar.php")

  | [r3201231](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L1 "Show revision 3201231 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L1 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  |  | 2 |  |
  | 2 | 3 | /\*\* |
  | 3 | 4 | \* Plugin Name: Booking Calendar WpDevArt |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L5) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L6) |  |
  | 5 | 6 | \* Author URI: https://wpdevart.com |
  | 6 | 7 | \* Description: WordPress Booking Calendar plugin is an awesome tool to create a booking system for your website. Create booking calendars in a few minutes. |
  | 7 |  | \* Version: 3.2.~~19~~ |
  |  | 8 | \* Version: 3.2.20 |
  | 8 | 9 | \* Author: WpDevArt |
  | 9 | 10 | \* License: GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html |
  | 10 | 11 | \* Text Domain: booking-calendar |
  | 11 | 12 | \*/ |
  | 12 |  |  |
  | 13 |  |  |
  |  | 13 |  |
  | 14 | 14 | defined('ABSPATH') || die('Access Denied'); |
  | 15 |  | class wpdevart\_bc\_calendar{ |
  | 16 |  |  |
  |  | 15 | class wpdevart\_bc\_calendar { |
  |  | 16 |  |
  | 17 | 17 | protected $version = "10.12"; |
  | 18 | 18 | protected $prefix = 'wpdevart'; |
  | 19 | 19 | public $options; |
  | 20 | 20 | public static $booking\_count = 1; |
  | 21 |  |  |
  | 22 |  |  |
  | 23 |  | function \_\_construct(){ |
  |  | 21 |  |
  |  | 22 |  |
  |  | 23 | function \_\_construct() { |
  | 24 | 24 | $this->setup\_constants();       //Setup constants |
  | 25 | 25 | $this->require\_files(); |
  | 26 | 26 | $this->call\_base\_filters();     //Function for the main filters (hooks) |
  | 27 | 27 | $this->create\_admin\_menu();     //Function for creating admin menu |
  | 28 |  | add\_shortcode(WPDEVART\_PLUGIN\_PREFIX~~."\_booking\_calendar", array($this,~~'shortcodes')); |
  | 29 |  | } |
  | 30 |  |  |
  |  | 28 | add\_shortcode(WPDEVART\_PLUGIN\_PREFIX . "\_booking\_calendar", array($this, 'shortcodes')); |
  |  | 29 | } |
  |  | 30 |  |
  | 31 | 31 | /\*\* |
  | 32 |  | \* Setup constants |
  | 33 |  | \*\*/ |
  |  | 32 | \* Setup constants |
  |  | 33 | \*\*/ |
  | 34 | 34 | private function setup\_constants() { |
  | 35 | 35 | $upload\_dir = wp\_upload\_dir(); |
  | 36 |  | if (~~! defined( 'WPDEVART\_PLUGIN\_DIR' )~~ ) { |
  | 37 |  | define(~~'WPDEVART\_PLUGIN\_DIR', trailingslashit( plugin\_dir\_path( \_\_FILE\_\_ ) )~~ ); |
  | 38 |  | } |
  | 39 |  | if (~~! defined( 'WPDEVART\_PLUGIN\_PREFIX' )~~ ) { |
  | 40 |  | define(~~'WPDEVART\_PLUGIN\_PREFIX', $this->prefix~~ ); |
  | 41 |  | } |
  | 42 |  | if~~(! defined( 'WPDEVART\_URL' ) )~~{ |
  | 43 |  | define~~('WPDEVART\_URL', trailingslashit( plugins\_url('', \_\_FILE\_\_ ) )~~ ); |
  | 44 |  | } |
  | 45 |  | if~~(! defined( 'WPDEVART\_VERSION' ) )~~{ |
  | 46 |  | define('WPDEVART\_VERSION', $this->version); |
  | 47 |  | } |
  | 48 |  | if~~(!defined('WPDEVART\_PRO'))~~{ |
  |  | 36 | if (! defined('WPDEVART\_PLUGIN\_DIR')) { |
  |  | 37 | define('WPDEVART\_PLUGIN\_DIR', trailingslashit(plugin\_dir\_path(\_\_FILE\_\_))); |
  |  | 38 | } |
  |  | 39 | if (! defined('WPDEVART\_PLUGIN\_PREFIX')) { |
  |  | 40 | define('WPDEVART\_PLUGIN\_PREFIX', $this->prefix); |
  |  | 41 | } |
  |  | 42 | if (! defined('WPDEVART\_URL')) { |
  |  | 43 | define('WPDEVART\_URL', trailingslashit(plugins\_url('', \_\_FILE\_\_))); |
  |  | 44 | } |
  |  | 45 | if (! defined('WPDEVART\_VERSION')) { |
  |  | 46 | define('WPDEVART\_VERSION', $this->version); |
  |  | 47 | } |
  |  | 48 | if (!defined('WPDEVART\_PRO')) { |
  | 49 | 49 | define('WPDEVART\_PRO', "free"); |
  | 50 | 50 | } |
  | 51 |  | if~~(!defined('wpdevart\_booking\_support\_url'))~~{ |
  |  | 51 | if (!defined('wpdevart\_booking\_support\_url')) { |
  | 52 | 52 | define('wpdevart\_booking\_support\_url', "https://wordpress.org/support/plugin/booking-calendar/#new-post"); |
  | 53 | 53 | } |
  | 54 |  | if~~(!defined('WPDEVART\_UPLOADS'))~~{ |
  | 55 |  | define(~~'WPDEVART\_UPLOADS', $upload\_dir['basedir'] . '/booking\_calendar/'~~ ); |
  | 56 |  | } |
  | 57 |  | if~~(!defined('WPDEVART\_UPLOADS\_URL'))~~{ |
  | 58 |  | define(~~'WPDEVART\_UPLOADS\_URL', $upload\_dir['baseurl'] . '/booking\_calendar/'~~ ); |
  | 59 |  | } |
  | 60 |  | if~~(!defined('WPDEVART\_PLUGIN\_URL'))~~{ |
  | 61 |  | define(~~'WPDEVART\_PLUGIN\_URL', "http://wpdevart.com/wordpress-booking-calendar-plugin"~~ ); |
  |  | 54 | if (!defined('WPDEVART\_UPLOADS')) { |
  |  | 55 | define('WPDEVART\_UPLOADS', $upload\_dir['basedir'] . '/booking\_calendar/'); |
  |  | 56 | } |
  |  | 57 | if (!defined('WPDEVART\_UPLOADS\_URL')) { |
  |  | 58 | define('WPDEVART\_UPLOADS\_URL', $upload\_dir['baseurl'] . '/booking\_calendar/'); |
  |  | 59 | } |
  |  | 60 | if (!defined('WPDEVART\_PLUGIN\_URL')) { |
  |  | 61 | define('WPDEVART\_PLUGIN\_URL', "http://wpdevart.com/wordpress-booking-calendar-plugin"); |
  | 62 | 62 | } |
  | 63 | 63 | } |
  | 64 | 64 |  |
  | 65 | 65 | /\*\* |
  | 66 |  | \* Require files |
  | 67 |  | \*\*/ |
  |  | 66 | \* Require files |
  |  | 67 | \*\*/ |
  | 68 | 68 | private function require\_files() { |
  | 69 |  | require\_once(WPDEVART\_PLUGIN\_DIR~~.~~'includes/currency\_list.php'); |
  | 70 |  | require\_once(WPDEVART\_PLUGIN\_DIR~~.~~'includes/wpdevart\_lib.php'); |
  | 71 |  | require\_once(WPDEVART\_PLUGIN\_DIR~~.~~'includes/wpdevart\_check.php'); |
  | 72 |  | require\_once(WPDEVART\_PLUGIN\_DIR~~.~~'includes/booking\_class.php'); |
  | 73 |  | require\_once(WPDEVART\_PLUGIN\_DIR~~.~~'includes/widgets/widget-booking\_calendar.php'); |
  | 74 |  | require\_once(WPDEVART\_PLUGIN\_DIR~~.~~'includes/payments.php'); |
  | 75 |  | require\_once(WPDEVART\_PLUGIN\_DIR~~.~~'includes/main\_class.php'); |
  | 76 |  | } |
  | 77 |  |  |
  | 78 |  | private function create\_admin\_menu(){ |
  |  | 69 | require\_once(WPDEVART\_PLUGIN\_DIR . 'includes/currency\_list.php'); |
  |  | 70 | require\_once(WPDEVART\_PLUGIN\_DIR . 'includes/wpdevart\_lib.php'); |
  |  | 71 | require\_once(WPDEVART\_PLUGIN\_DIR . 'includes/wpdevart\_check.php'); |
  |  | 72 | require\_once(WPDEVART\_PLUGIN\_DIR . 'includes/booking\_class.php'); |
  |  | 73 | require\_once(WPDEVART\_PLUGIN\_DIR . 'includes/widgets/widget-booking\_calendar.php'); |
  |  | 74 | require\_once(WPDEVART\_PLUGIN\_DIR . 'includes/payments.php'); |
  |  | 75 | require\_once(WPDEVART\_PLUGIN\_DIR . 'includes/main\_class.php'); |
  |  | 76 | } |
  |  | 77 |  |
  |  | 78 | private function create\_admin\_menu() { |
  | 79 | 79 | // Registration of file that is responsible for admin menu |
  | 80 |  | require\_once(WPDEVART\_PLUGIN\_DIR~~.~~'includes/admin\_menu.php'); |
  |  | 80 | require\_once(WPDEVART\_PLUGIN\_DIR . 'includes/admin\_menu.php'); |
  | 81 | 81 | // Creation of admin menu object type |
  | 82 | 82 | $wpdevart\_admin\_menu = new wpdevart\_bc\_admin\_menu(array('menu\_name' => 'Booking')); |
  | 83 | 83 | //Hook that will connect admin menu with class |
  | 84 |  | add\_action('admin\_menu', array($wpdevart\_admin\_menu,'create\_menu')); |
  | 85 |  |  |
  | 86 |  | } |
  | 87 |  |  |
  | 88 |  | /\*############  Shortcodes function ################\*/ |
  | 89 |  |  |
  |  | 84 | add\_action('admin\_menu', array($wpdevart\_admin\_menu, 'create\_menu')); |
  |  | 85 | } |
  |  | 86 |  |
  |  | 87 | /\*############  Shortcodes function ################\*/ |
  |  | 88 |  |
  | 90 | 89 | public function shortcodes($attr) { |
  | 91 | 90 | extract(shortcode\_atts(array( |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L100) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L99) |  |
  | 100 | 99 | return  $result; |
  | 101 | 100 | } |
  | 102 |  |  |
  | 103 |  |  |
  | 104 |  | public function install\_databese(){ |
  | 105 |  | require\_once(WPDEVART\_PLUGIN\_DIR~~.~~'includes/install\_database.php'); |
  |  | 101 |  |
  |  | 102 |  |
  |  | 103 | public function install\_databese() { |
  |  | 104 | require\_once(WPDEVART\_PLUGIN\_DIR . 'includes/install\_database.php'); |
  | 106 | 105 | $wpdevart\_bc\_install\_database = new wpdevart\_bc\_install\_database(); |
  | 107 | 106 | $version = get\_option("wpdevart\_booking\_version\_new"); |
  | 108 |  | $new\_version = $this->version; |
  |  | 107 | $new\_version = $this->version; |
  | 109 | 108 | $recreate\_db = (isset($\_GET['task']) && $\_GET['task'] == 'recreate\_db') ? true : false; |
  | 110 | 109 | if (!$version && !get\_option("wpdevart\_booking\_version")) { |
  | 111 | 110 | $wpdevart\_bc\_install\_database->install\_databese(); |
  | 112 | 111 | add\_option("wpdevart\_booking\_version\_new", $new\_version, '', 'no'); |
  | 113 |  | } |
  | 114 |  | elseif (($version && version\_compare($version, $new\_version, '<')) || get\_option("wpdevart\_booking\_version") != "0" || $recreate\_db ) { |
  |  | 112 | } elseif (($version && version\_compare($version, $new\_version, '<')) || get\_option("wpdevart\_booking\_version") != "0" || $recreate\_db) { |
  | 115 | 113 | $version = !$version ? "10.10" : get\_option("wpdevart\_booking\_version\_new"); |
  | 116 |  | $wpdevart\_bc\_install\_database->update\_databese($version,$recreate\_db); |
  |  | 114 | $wpdevart\_bc\_install\_database->update\_databese($version, $recreate\_db); |
  | 117 | 115 | update\_option("wpdevart\_booking\_version\_new", $new\_version, "", "no"); |
  | 118 | 116 | update\_option("wpdevart\_booking\_version", "0"); |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L121) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L119) |  |
  | 121 | 119 | mkdir(WPDEVART\_UPLOADS, 0777); |
  | 122 | 120 | } |
  | 123 |  |  |
  | 124 |  | } |
  | 125 |  |  |
  | 126 |  | /\*############  Required scripts function ################\*/ |
  | 127 |  |  |
  | 128 |  | public function registr\_requeried\_scripts(){ |
  | 129 |  | load\_plugin\_textdomain( 'booking-calendar', FALSE, basename(dirname(\_\_FILE\_\_)).'/languages' ); |
  | 130 |  | wp\_enqueue\_script( 'jquery-ui-datepicker', array('jquery') ); |
  | 131 |  | if(!is\_admin()){ |
  | 132 |  | $scheme = is\_ssl()? "https" : "http"; |
  | 133 |  | wp\_register\_script( 'wpdevart-booking-script', WPDEVART\_URL.'js/booking.js', array("jquery"),WPDEVART\_VERSION); |
  | 134 |  | wp\_localize\_script( 'wpdevart-booking-script', WPDEVART\_PLUGIN\_PREFIX, array( |
  | 135 |  | 'ajaxUrl'         => admin\_url( 'admin-ajax.php', $scheme ), |
  | 136 |  | 'ajaxNonce'       => wp\_create\_nonce( 'wpdevart\_ajax\_nonce' ), |
  | 137 |  | 'required' => \_\_("is required.",'booking-calendar'), |
  | 138 |  | 'confirm\_email' => \_\_("do not match.",'booking-calendar'), |
  | 139 |  | 'file\_size' => \_\_(" The file size is too large!",'booking-calendar'), |
  | 140 |  | 'file\_type' => \_\_(" The file type not allowed!",'booking-calendar'), |
  | 141 |  | 'emailValid' => \_\_("Enter the valid email address.",'booking-calendar'), |
  | 142 |  | 'date' => \_\_("Date",'booking-calendar'), |
  | 143 |  | 'hour' => \_\_("Hour",'booking-calendar') |
  | 144 |  | ) ); |
  | 145 |  | wp\_enqueue\_script( 'wpdevart-booking-script' ); |
  | 146 |  | wp\_enqueue\_script( 'wpdevart-script', WPDEVART\_URL.'js/script.js', array("jquery"),WPDEVART\_VERSION ); |
  | 147 |  | wp\_enqueue\_script("wpdevart-recaptcha", "https://www.google.com/recaptcha/api.js?onload=wpdevartRecaptchaInit&render=explicit", array("jquery"), WPDEVART\_VERSION ); |
  | 148 |  | } |
  | 149 |  | wp\_enqueue\_script( 'scrollto', WPDEVART\_URL.'js/jquery.scrollTo-min.js', array("jquery"),WPDEVART\_VERSION ); |
  | 150 |  | wp\_enqueue\_style( 'jquery-ui',  WPDEVART\_URL.'css/jquery-ui.css',array(),WPDEVART\_VERSION); |
  | 151 |  | wp\_enqueue\_style( 'wpdevart-font-awesome', WPDEVART\_URL . 'css/font-awesome/font-awesome.css',array(),WPDEVART\_VERSION); |
  | 152 |  | wp\_enqueue\_style( 'wpdevart-style', WPDEVART\_URL.'css/style.css',array(),WPDEVART\_VERSION); |
  | 153 |  | wp\_enqueue\_style( 'wpdevart-effects', WPDEVART\_URL.'css/effects.css',array(),WPDEVART\_VERSION); |
  | 154 |  | wp\_enqueue\_style( 'wpdevartcalendar-style', WPDEVART\_URL.'css/booking.css',array(),WPDEVART\_VERSION); |
  | 155 |  | } |
  | 156 |  |  |
  | 157 |  | /\*############  Call filters function ################\*/ |
  | 158 |  |  |
  | 159 |  | public function call\_base\_filters(){ |
  | 160 |  |  |
  | 161 |  | add\_action( 'init',  array($this,'registr\_requeried\_scripts') ); |
  |  | 121 | } |
  |  | 122 |  |
  |  | 123 | /\*############  Required scripts function ################\*/ |
  |  | 124 |  |
  |  | 125 | public function registr\_requeried\_scripts() { |
  |  | 126 | load\_plugin\_textdomain('booking-calendar', FALSE, basename(dirname(\_\_FILE\_\_)) . '/languages'); |
  |  | 127 | wp\_enqueue\_script('jquery-ui-datepicker', array('jquery')); |
  |  | 128 | if (!is\_admin()) { |
  |  | 129 | $scheme = is\_ssl() ? "https" : "http"; |
  |  | 130 | wp\_register\_script('wpdevart-booking-script', WPDEVART\_URL . 'js/booking.js', array("jquery"), WPDEVART\_VERSION); |
  |  | 131 | wp\_localize\_script('wpdevart-booking-script', WPDEVART\_PLUGIN\_PREFIX, array( |
  |  | 132 | 'ajaxUrl'         => admin\_url('admin-ajax.php', $scheme), |
  |  | 133 | 'ajaxNonce'       => wp\_create\_nonce('wpdevart\_ajax\_nonce'), |
  |  | 134 | 'required' => \_\_("is required.", 'booking-calendar'), |
  |  | 135 | 'confirm\_email' => \_\_("do not match.", 'booking-calendar'), |
  |  | 136 | 'file\_size' => \_\_(" The file size is too large!", 'booking-calendar'), |
  |  | 137 | 'file\_type' => \_\_(" The file type not allowed!", 'booking-calendar'), |
  |  | 138 | 'emailValid' => \_\_("Enter the valid email address.", 'booking-calendar'), |
  |  | 139 | 'date' => \_\_("Date", 'booking-calendar'), |
  |  | 140 | 'hour' => \_\_("Hour", 'booking-calendar') |
  |  | 141 | )); |
  |  | 142 | wp\_enqueue\_script('wpdevart-booking-script'); |
  |  | 143 | wp\_enqueue\_script('wpdevart-script', WPDEVART\_URL . 'js/script.js', array("jquery"), WPDEVART\_VERSION); |
  |  | 144 | wp\_enqueue\_script("wpdevart-recaptcha", "https://www.google.com/recaptcha/api.js?onload=wpdevartRecaptchaInit&render=explicit", array("jquery"), WPDEVART\_VERSION); |
  |  | 145 | } |
  |  | 146 | wp\_enqueue\_script('scrollto', WPDEVART\_URL . 'js/jquery.scrollTo-min.js', array("jquery"), WPDEVART\_VERSION); |
  |  | 147 | wp\_enqueue\_style('jquery-ui',  WPDEVART\_URL . 'css/jquery-ui.css', array(), WPDEVART\_VERSION); |
  |  | 148 | wp\_enqueue\_style('wpdevart-font-awesome', WPDEVART\_URL . 'css/font-awesome/font-awesome.css', array(), WPDEVART\_VERSION); |
  |  | 149 | wp\_enqueue\_style('wpdevart-style', WPDEVART\_URL . 'css/style.css', array(), WPDEVART\_VERSION); |
  |  | 150 | wp\_enqueue\_style('wpdevart-effects', WPDEVART\_URL . 'css/effects.css', array(), WPDEVART\_VERSION); |
  |  | 151 | wp\_enqueue\_style('wpdevartcalendar-style', WPDEVART\_URL . 'css/booking.css', array(), WPDEVART\_VERSION); |
  |  | 152 | } |
  |  | 153 |  |
  |  | 154 | /\*############  Call filters function ################\*/ |
  |  | 155 |  |
  |  | 156 | public function call\_base\_filters() { |
  |  | 157 |  |
  |  | 158 | add\_action('init',  array($this, 'registr\_requeried\_scripts')); |
  | 162 | 159 | //if (!isset($\_GET['action']) || $\_GET['action'] != 'deactivate') { |
  | 163 |  | ~~add\_action('admin\_init', array($this,~~'install\_databese')); |
  |  | 160 | add\_action('admin\_init', array($this, 'install\_databese')); |
  | 164 | 161 | //} |
  | 165 | 162 | /\*GDPR\*/ |
  | 166 |  | add\_filter('admin\_init', array($this,'wpdevart\_privacy\_policy')); |
  | 167 |  | add\_filter('wp\_privacy\_personal\_data\_exporters', array($this,'wpdevart\_plugin\_exporter'), 10); |
  | 168 |  | add\_filter('wp\_privacy\_personal\_data\_erasers', array($this,'wpdevart\_plugin\_eraser'), 10); |
  | 169 |  |  |
  | 170 |  | add\_action(~~'wp\_ajax\_wpdevart\_add\_field', array($this,'wpdevart\_add\_field')~~ ); |
  | 171 |  |  |
  | 172 |  | add\_action(~~'wp\_ajax\_wpdevart\_add\_extra\_field', array($this,'wpdevart\_add\_extra\_field')~~ ); |
  | 173 |  |  |
  | 174 |  | add\_action(~~'wp\_ajax\_wpdevart\_add\_extra\_field\_item', array($this,'wpdevart\_add\_extra\_field\_item')~~ ); |
  | 175 |  |  |
  | 176 |  | add\_action(~~'wp\_ajax\_nopriv\_wpdevart\_ajax', array($this,'wpdevart\_ajax')~~ ); |
  | 177 |  | add\_action(~~'wp\_ajax\_wpdevart\_ajax', array($this,'wpdevart\_ajax')~~ ); |
  | 178 |  |  |
  | 179 |  | add\_action(~~'wp\_ajax\_nopriv\_wpdevart\_get\_interval\_dates', array($this,'wpdevart\_get\_interval\_dates')~~ ); |
  | 180 |  | add\_action(~~'wp\_ajax\_wpdevart\_get\_interval\_dates', array($this,'wpdevart\_get\_interval\_dates')~~ ); |
  | 181 |  |  |
  | 182 |  | add\_action(~~'wp\_ajax\_nopriv\_wpdevart\_form\_ajax', array($this,'wpdevart\_form\_ajax')~~ ); |
  | 183 |  | add\_action(~~'wp\_ajax\_wpdevart\_form\_ajax', array($this,'wpdevart\_form\_ajax')~~ ); |
  | 184 |  |  |
  | 185 |  | add\_action(~~'wp\_ajax\_nopriv\_wpdevart\_payment\_ajax', array($this,'wpdevart\_payment\_ajax')~~ ); |
  | 186 |  | add\_action(~~'wp\_ajax\_wpdevart\_payment\_ajax', array($this,'wpdevart\_payment\_ajax')~~ ); |
  | 187 |  | /\*\*/ |
  | 188 |  | add\_action(~~'wp\_ajax\_nopriv\_wpdevart\_payment', array($this,'wpdevart\_payment')~~ ); |
  | 189 |  | add\_action(~~'wp\_ajax\_wpdevart\_payment', array($this,'wpdevart\_payment')~~ ); |
  | 190 |  | /\*\*/ |
  | 191 |  | add\_action(~~'wp\_ajax\_wpdevart\_quick\_update', array($this,'wpdevart\_quick\_update')~~ ); |
  | 192 |  |  |
  | 193 |  | add\_action(~~'wp\_ajax\_nopriv\_wpdevart\_captcha', array($this,'wpdevart\_captcha')~~ ); |
  | 194 |  | add\_action(~~'wp\_ajax\_wpdevart\_captcha', array($this,'wpdevart\_captcha')~~ ); |
  | 195 |  |  |
  | 196 |  | add\_action(~~'wp\_ajax\_wpdevart\_export', array($this,'wpdevart\_export')~~ ); |
  | 197 |  | } |
  | 198 |  |  |
  | 199 |  |  |
  | 200 |  | private static function get\_now(){ |
  | 201 |  | $now = date(~~'Y-m-d H:i:s'~~ ); |
  | 202 |  | $tz\_string     = get\_option(~~'timezone\_string'~~ ); |
  | 203 |  | if (~~$tz\_string~~ ) { |
  |  | 163 | add\_filter('admin\_init', array($this, 'wpdevart\_privacy\_policy')); |
  |  | 164 | add\_filter('wp\_privacy\_personal\_data\_exporters', array($this, 'wpdevart\_plugin\_exporter'), 10); |
  |  | 165 | add\_filter('wp\_privacy\_personal\_data\_erasers', array($this, 'wpdevart\_plugin\_eraser'), 10); |
  |  | 166 |  |
  |  | 167 | add\_action('wp\_ajax\_wpdevart\_add\_field', array($this, 'wpdevart\_add\_field')); |
  |  | 168 |  |
  |  | 169 | add\_action('wp\_ajax\_wpdevart\_add\_extra\_field', array($this, 'wpdevart\_add\_extra\_field')); |
  |  | 170 |  |
  |  | 171 | add\_action('wp\_ajax\_wpdevart\_add\_extra\_field\_item', array($this, 'wpdevart\_add\_extra\_field\_item')); |
  |  | 172 |  |
  |  | 173 | add\_action('wp\_ajax\_nopriv\_wpdevart\_ajax', array($this, 'wpdevart\_ajax')); |
  |  | 174 | add\_action('wp\_ajax\_wpdevart\_ajax', array($this, 'wpdevart\_ajax')); |
  |  | 175 |  |
  |  | 176 | add\_action('wp\_ajax\_nopriv\_wpdevart\_get\_interval\_dates', array($this, 'wpdevart\_get\_interval\_dates')); |
  |  | 177 | add\_action('wp\_ajax\_wpdevart\_get\_interval\_dates', array($this, 'wpdevart\_get\_interval\_dates')); |
  |  | 178 |  |
  |  | 179 | add\_action('wp\_ajax\_nopriv\_wpdevart\_form\_ajax', array($this, 'wpdevart\_form\_ajax')); |
  |  | 180 | add\_action('wp\_ajax\_wpdevart\_form\_ajax', array($this, 'wpdevart\_form\_ajax')); |
  |  | 181 |  |
  |  | 182 | add\_action('wp\_ajax\_nopriv\_wpdevart\_payment\_ajax', array($this, 'wpdevart\_payment\_ajax')); |
  |  | 183 | add\_action('wp\_ajax\_wpdevart\_payment\_ajax', array($this, 'wpdevart\_payment\_ajax')); |
  |  | 184 | /\*\*/ |
  |  | 185 | add\_action('wp\_ajax\_nopriv\_wpdevart\_payment', array($this, 'wpdevart\_payment')); |
  |  | 186 | add\_action('wp\_ajax\_wpdevart\_payment', array($this, 'wpdevart\_payment')); |
  |  | 187 | /\*\*/ |
  |  | 188 | add\_action('wp\_ajax\_wpdevart\_quick\_update', array($this, 'wpdevart\_quick\_update')); |
  |  | 189 |  |
  |  | 190 | add\_action('wp\_ajax\_nopriv\_wpdevart\_captcha', array($this, 'wpdevart\_captcha')); |
  |  | 191 | add\_action('wp\_ajax\_wpdevart\_captcha', array($this, 'wpdevart\_captcha')); |
  |  | 192 |  |
  |  | 193 | add\_action('wp\_ajax\_wpdevart\_export', array($this, 'wpdevart\_export')); |
  |  | 194 | } |
  |  | 195 |  |
  |  | 196 |  |
  |  | 197 | private static function get\_now() { |
  |  | 198 | $now = date('Y-m-d H:i:s'); |
  |  | 199 | $tz\_string     = get\_option('timezone\_string'); |
  |  | 200 | if ($tz\_string) { |
  | 204 | 201 | try { |
  | 205 |  | $tz = new DateTimeZone(~~$tz\_string~~ ); |
  | 206 |  | } catch (~~Exception $e~~ ) { |
  |  | 202 | $tz = new DateTimeZone($tz\_string); |
  |  | 203 | } catch (Exception $e) { |
  | 207 | 204 | $tz = ''; |
  | 208 | 205 | } |
  | 209 | 206 |  |
  | 210 |  | if (~~$tz~~ ) { |
  | 211 |  | $now = new DateTime(~~'now', $tz~~ ); |
  |  | 207 | if ($tz) { |
  |  | 208 | $now = new DateTime('now', $tz); |
  | 212 | 209 | $now = $now->format('Y-m-d H:i:s'); |
  | 213 | 210 | } |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L215) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L212) |  |
  | 215 | 212 | return $now; |
  | 216 | 213 | } |
  | 217 |  |  |
  |  | 214 |  |
  | 218 | 215 | /\*GDPR\*/ |
  | 219 |  | public function wpdevart\_plugin\_exporter(~~$exporters~~ ) { |
  |  | 216 | public function wpdevart\_plugin\_exporter($exporters) { |
  | 220 | 217 | $exporters['wpdevart-booking-calendar'] = array( |
  | 221 |  | ~~'exporter\_friendly\_name' => \_\_( 'Booking Calendar WpDevArt', 'booking-calendar'~~ ), |
  | 222 |  | ~~'callback' => array($this,~~'wpdevart\_exporter'), |
  |  | 218 | 'exporter\_friendly\_name' => \_\_('Booking Calendar WpDevArt', 'booking-calendar'), |
  |  | 219 | 'callback' => array($this, 'wpdevart\_exporter'), |
  | 223 | 220 | ); |
  | 224 | 221 | return $exporters; |
  | 225 | 222 | } |
  | 226 |  |  |
  | 227 |  | public function wpdevart\_exporter(~~$email\_address, $page = 1~~ ) { |
  |  | 223 |  |
  |  | 224 | public function wpdevart\_exporter($email\_address, $page = 1) { |
  | 228 | 225 | global $wpdb; |
  | 229 | 226 | $done = false; |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L231) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L228) |  |
  | 231 | 228 | $limit = 500; |
  | 232 | 229 | $prop\_to\_export = array( |
  | 233 |  | 'single\_day'       => \_\_(~~'Reservation Day', 'booking-calendar'~~ ), |
  | 234 |  | 'check\_in' => \_\_(~~'Reservation Check In', 'booking-calendar'~~ ), |
  | 235 |  | 'check\_out'   => \_\_(~~'Reservation Check Out', 'booking-calendar'~~ ), |
  | 236 |  | 'start\_hour'    => \_\_(~~'Start Hour', 'booking-calendar'~~ ), |
  | 237 |  | 'end\_hour'        => \_\_(~~'End Hour', 'booking-calendar'~~ ), |
  | 238 |  | 'total\_price'         => \_\_(~~'Total Price', 'booking-calendar'~~ ), |
  | 239 |  | 'form'      => \_\_(~~'Reservation Form Information', 'booking-calendar'~~ ), |
  | 240 |  | 'address\_billing'      => \_\_(~~'Billing Form Information', 'booking-calendar'~~ ), |
  | 241 |  | 'address\_shipping'      => \_\_(~~'Shipping Form Information', 'booking-calendar'~~ ), |
  | 242 |  | 'payment\_price'      => \_\_(~~'Payment Price', 'booking-calendar'~~ ), |
  | 243 |  | 'ip'      => \_\_(~~'Ip', 'booking-calendar'~~ ), |
  | 244 |  | 'payment\_address'      => \_\_(~~'Payment Address', 'booking-calendar'~~ ), |
  | 245 |  | 'payment\_info'      => \_\_(~~'Payment Info', 'booking-calendar'~~ ), |
  | 246 |  | 'modified\_date'      => \_\_(~~'Payment Date', 'booking-calendar'~~ ), |
  | 247 |  | 'date\_created'      => \_\_(~~'Reservation Created Date', 'booking-calendar'~~ ) |
  | 248 |  | ); |
  | 249 |  | $like = '%' . $wpdb->esc\_like(~~$email\_address~~ ) . '%'; |
  | 250 |  | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id WHERE  " . $wpdb->prefix . "wpdevart\_reservations.email LIKE %s LIMIT 0,"~~.~~$limit, $like); |
  |  | 230 | 'single\_day'       => \_\_('Reservation Day', 'booking-calendar'), |
  |  | 231 | 'check\_in' => \_\_('Reservation Check In', 'booking-calendar'), |
  |  | 232 | 'check\_out'   => \_\_('Reservation Check Out', 'booking-calendar'), |
  |  | 233 | 'start\_hour'    => \_\_('Start Hour', 'booking-calendar'), |
  |  | 234 | 'end\_hour'        => \_\_('End Hour', 'booking-calendar'), |
  |  | 235 | 'total\_price'         => \_\_('Total Price', 'booking-calendar'), |
  |  | 236 | 'form'      => \_\_('Reservation Form Information', 'booking-calendar'), |
  |  | 237 | 'address\_billing'      => \_\_('Billing Form Information', 'booking-calendar'), |
  |  | 238 | 'address\_shipping'      => \_\_('Shipping Form Information', 'booking-calendar'), |
  |  | 239 | 'payment\_price'      => \_\_('Payment Price', 'booking-calendar'), |
  |  | 240 | 'ip'      => \_\_('Ip', 'booking-calendar'), |
  |  | 241 | 'payment\_address'      => \_\_('Payment Address', 'booking-calendar'), |
  |  | 242 | 'payment\_info'      => \_\_('Payment Info', 'booking-calendar'), |
  |  | 243 | 'modified\_date'      => \_\_('Payment Date', 'booking-calendar'), |
  |  | 244 | 'date\_created'      => \_\_('Reservation Created Date', 'booking-calendar') |
  |  | 245 | ); |
  |  | 246 | $like = '%' . $wpdb->esc\_like($email\_address) . '%'; |
  |  | 247 | $query = $wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_reservations.\*, " . $wpdb->prefix . "wpdevart\_payments.\* FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id WHERE  " . $wpdb->prefix . "wpdevart\_reservations.email LIKE %s LIMIT 0," . $limit, $like); |
  | 251 | 248 | $rows = $wpdb->get\_results($query); |
  | 252 | 249 |  |
  | 253 | 250 |  |
  | 254 |  | $cals = array(); |
  | 255 |  | foreach ($rows as $row){ |
  | 256 |  | $data\_to\_export = array(); |
  | 257 |  | $group\_id = 'reservation'; |
  | 258 |  | $item\_id = $row->id; |
  | 259 |  |  |
  | 260 |  | if(!isset($cals[$row->calendar\_id])){ |
  | 261 |  | $cals[$row->calendar\_id] = array(); |
  | 262 |  | $cals[$row->calendar\_id]["ids"] = $wpdb->get\_row($wpdb->prepare('SELECT theme\_id,form\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $row->calendar\_id)); |
  | 263 |  | $theme\_id = $wpdb->get\_var($wpdb->prepare('SELECT theme\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $row->calendar\_id)); |
  | 264 |  | $theme\_rows = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"', $theme\_id),ARRAY\_A); |
  | 265 |  | if(isset($theme\_rows[0])) { |
  | 266 |  | $cals[$row->calendar\_id]["theme\_options"] = json\_decode($theme\_rows[0]["value"],true); |
  | 267 |  | } else { |
  | 268 |  | $cals[$row->calendar\_id]["theme\_options"] = array(); |
  | 269 |  | } |
  | 270 |  | } |
  | 271 |  |  |
  | 272 |  | foreach ( $prop\_to\_export as $key => $name ) { |
  | 273 |  | $value = ''; |
  | 274 |  |  |
  | 275 |  | switch ( $key ) { |
  | 276 |  | case 'single\_day': |
  | 277 |  | case 'check\_in': |
  | 278 |  | case 'check\_out': |
  | 279 |  | case 'start\_hour': |
  | 280 |  | case 'end\_hour': |
  | 281 |  | case 'total\_price': |
  | 282 |  | case 'payment\_price': |
  | 283 |  | case 'ip': |
  | 284 |  | case 'payment\_address': |
  | 285 |  | case 'payment\_info': |
  | 286 |  | case 'modified\_date': |
  | 287 |  | case 'date\_created': |
  | 288 |  | $value = $row->{$key}; |
  | 289 |  | break; |
  | 290 |  | case 'form': |
  | 291 |  | $value = $this->get\_form\_data($row->form, $row->calendar\_id,$cals[$row->calendar\_id]["ids"]->form\_id); |
  | 292 |  | break; |
  | 293 |  | case 'address\_billing': |
  | 294 |  | $value = $this->get\_form\_data($row->address\_billing, $row->calendar\_id,$cals[$row->calendar\_id]["theme\_options"]["billing\_address\_form"], "billing\_info\_"); |
  | 295 |  | break; |
  | 296 |  | case 'address\_shipping': |
  | 297 |  | $value = $this->get\_form\_data($row->address\_shipping, $row->calendar\_id,$cals[$row->calendar\_id]["theme\_options"]["shipping\_address\_form"], "shipping\_info\_"); |
  | 298 |  | break; |
  | 299 |  | } |
  | 300 |  |  |
  | 301 |  | if ( ! empty( $value ) ) { |
  | 302 |  | $data\_to\_export[] = array( |
  | 303 |  | 'name'  => $name, |
  | 304 |  | 'value' => $value, |
  |  | 251 | $cals = array(); |
  |  | 252 | foreach ($rows as $row) { |
  |  | 253 | $data\_to\_export = array(); |
  |  | 254 | $group\_id = 'reservation'; |
  |  | 255 | $item\_id = $row->id; |
  |  | 256 |  |
  |  | 257 | if (!isset($cals[$row->calendar\_id])) { |
  |  | 258 | $cals[$row->calendar\_id] = array(); |
  |  | 259 | $cals[$row->calendar\_id]["ids"] = $wpdb->get\_row($wpdb->prepare('SELECT theme\_id,form\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $row->calendar\_id)); |
  |  | 260 | $theme\_id = $wpdb->get\_var($wpdb->prepare('SELECT theme\_id FROM ' . $wpdb->prefix . 'wpdevart\_calendars WHERE id="%d"', $row->calendar\_id)); |
  |  | 261 | $theme\_rows = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE id="%d"', $theme\_id), ARRAY\_A); |
  |  | 262 | if (isset($theme\_rows[0])) { |
  |  | 263 | $cals[$row->calendar\_id]["theme\_options"] = json\_decode($theme\_rows[0]["value"], true); |
  |  | 264 | } else { |
  |  | 265 | $cals[$row->calendar\_id]["theme\_options"] = array(); |
  |  | 266 | } |
  |  | 267 | } |
  |  | 268 |  |
  |  | 269 | foreach ($prop\_to\_export as $key => $name) { |
  |  | 270 | $value = ''; |
  |  | 271 |  |
  |  | 272 | switch ($key) { |
  |  | 273 | case 'single\_day': |
  |  | 274 | case 'check\_in': |
  |  | 275 | case 'check\_out': |
  |  | 276 | case 'start\_hour': |
  |  | 277 | case 'end\_hour': |
  |  | 278 | case 'total\_price': |
  |  | 279 | case 'payment\_price': |
  |  | 280 | case 'ip': |
  |  | 281 | case 'payment\_address': |
  |  | 282 | case 'payment\_info': |
  |  | 283 | case 'modified\_date': |
  |  | 284 | case 'date\_created': |
  |  | 285 | $value = $row->{$key}; |
  |  | 286 | break; |
  |  | 287 | case 'form': |
  |  | 288 | $value = $this->get\_form\_data($row->form, $row->calendar\_id, $cals[$row->calendar\_id]["ids"]->form\_id); |
  |  | 289 | break; |
  |  | 290 | case 'address\_billing': |
  |  | 291 | $value = $this->get\_form\_data($row->address\_billing, $row->calendar\_id, $cals[$row->calendar\_id]["theme\_options"]["billing\_address\_form"], "billing\_info\_"); |
  |  | 292 | break; |
  |  | 293 | case 'address\_shipping': |
  |  | 294 | $value = $this->get\_form\_data($row->address\_shipping, $row->calendar\_id, $cals[$row->calendar\_id]["theme\_options"]["shipping\_address\_form"], "shipping\_info\_"); |
  |  | 295 | break; |
  |  | 296 | } |
  |  | 297 |  |
  |  | 298 | if (! empty($value)) { |
  |  | 299 | $data\_to\_export[] = array( |
  |  | 300 | 'name'  => $name, |
  |  | 301 | 'value' => $value, |
  |  | 302 | ); |
  |  | 303 | } |
  |  | 304 | } |
  |  | 305 |  |
  |  | 306 | if (!empty($data\_to\_export)) { |
  |  | 307 | $done = true; |
  |  | 308 | $export\_items[] = array( |
  |  | 309 | 'group\_id' => $group\_id, |
  |  | 310 | 'group\_label' => \_\_('Booking Calendar Reservation Data', 'booking-calendar'), |
  |  | 311 | 'item\_id' => $item\_id, |
  |  | 312 | 'data' => $data\_to\_export, |
  | 305 | 313 | ); |
  | 306 | 314 | } |
  | 307 |  | ~~}~~ |
  | 308 |  |  |
  | 309 |  | ~~if(!empty($data\_to\_export)){~~ |
  | 310 |  | ~~$done = true;~~ |
  | 311 |  | ~~$export\_items[] = array(~~ |
  | 312 |  | ~~'group\_id' => $group\_id,~~ |
  | 313 |  | ~~'group\_label' => \_\_('Booking Calendar Reservation Data', 'booking-calendar'),~~ |
  | 314 |  | ~~'item\_id' => $item\_id,~~ |
  | 315 |  | ~~'data' => $data\_to\_export,~~ |
  | 316 |  | ~~);~~ |
  | 317 |  | ~~}~~ |
  | 318 | 315 | } |
  | 319 | 316 |  |
  | 320 | 317 |  |
  | 321 | 318 | $prop\_to\_export = array( |
  | 322 |  | 'notify\_admin\_on\_book\_to'       => \_\_(~~'Notify on book request to', 'booking-calendar'~~ ), |
  | 323 |  | 'notify\_admin\_on\_book\_from' => \_\_(~~'Notify on book request from', 'booking-calendar'~~ ), |
  | 324 |  | 'notify\_admin\_on\_book\_fromname'   => \_\_(~~'Notify on book request fromname', 'booking-calendar'~~ ), |
  | 325 |  | 'notify\_admin\_on\_book\_subject'    => \_\_(~~'Notify on book request subject', 'booking-calendar'~~ ), |
  | 326 |  | 'notify\_admin\_on\_book\_content'        => \_\_(~~'Notify on book request content', 'booking-calendar'~~ ), |
  | 327 |  | 'notify\_admin\_on\_approved\_to'       => \_\_(~~'Notify on approved request to', 'booking-calendar'~~ ), |
  | 328 |  | 'notify\_admin\_on\_approved\_from' => \_\_(~~'Notify on approved request from', 'booking-calendar'~~ ), |
  | 329 |  | 'notify\_admin\_on\_approved\_fromname'   => \_\_(~~'Notify on approved request fromname', 'booking-calendar'~~ ), |
  | 330 |  | 'notify\_admin\_on\_approved\_subject'    => \_\_(~~'Notify on approved request subject', 'booking-calendar'~~ ), |
  | 331 |  | 'notify\_admin\_on\_approved\_content'        => \_\_(~~'Notify on approved request content', 'booking-calendar'~~ ), |
  | 332 |  | 'notify\_admin\_paypal\_to'       => \_\_(~~'Notify on paypal request to', 'booking-calendar'~~ ), |
  | 333 |  | 'notify\_admin\_paypal\_from' => \_\_(~~'Notify on paypal request from', 'booking-calendar'~~ ), |
  | 334 |  | 'notify\_admin\_paypal\_fromname'   => \_\_(~~'Notify on paypal request fromname', 'booking-calendar'~~ ), |
  | 335 |  | 'notify\_admin\_paypal\_subject'    => \_\_(~~'Notify on paypal request subject', 'booking-calendar'~~ ), |
  | 336 |  | 'notify\_admin\_paypal\_content'        => \_\_(~~'Notify on paypal request content', 'booking-calendar'~~ ), |
  | 337 |  | 'notify\_user\_on\_book\_from' => \_\_(~~'Notify user on book request from', 'booking-calendar'~~ ), |
  | 338 |  | 'notify\_user\_on\_book\_fromname'   => \_\_(~~'Notify user on book request fromname', 'booking-calendar'~~ ), |
  | 339 |  | 'notify\_user\_on\_book\_subject'    => \_\_(~~'Notify user on book request subject', 'booking-calendar'~~ ), |
  | 340 |  | 'notify\_user\_on\_book\_content'        => \_\_(~~'Notify user on book request content', 'booking-calendar'~~ ), |
  | 341 |  | 'notify\_user\_on\_approved\_from' => \_\_(~~'Notify user on approved request from', 'booking-calendar'~~ ), |
  | 342 |  | 'notify\_user\_on\_approved\_fromname'   => \_\_(~~'Notify user on approved request fromname', 'booking-calendar'~~ ), |
  | 343 |  | 'notify\_user\_on\_approved\_subject'    => \_\_(~~'Notify user on approved request subject', 'booking-calendar'~~ ), |
  | 344 |  | 'notify\_user\_on\_approved\_content'        => \_\_(~~'Notify user on approved request content', 'booking-calendar'~~ ), |
  | 345 |  | 'notify\_user\_canceled\_from' => \_\_(~~'Notify user on canceled request from', 'booking-calendar'~~ ), |
  | 346 |  | 'notify\_user\_canceled\_fromname'   => \_\_(~~'Notify user on canceled request fromname', 'booking-calendar'~~ ), |
  | 347 |  | 'notify\_user\_canceled\_subject'    => \_\_(~~'Notify user on canceled request subject', 'booking-calendar'~~ ), |
  | 348 |  | 'notify\_user\_canceled\_content'        => \_\_(~~'Notify user on canceled request content', 'booking-calendar'~~ ), |
  | 349 |  | 'notify\_user\_deleted\_from' => \_\_(~~'Notify user on deleted request from', 'booking-calendar'~~ ), |
  | 350 |  | 'notify\_user\_deleted\_fromname'   => \_\_(~~'Notify user on deleted request fromname', 'booking-calendar'~~ ), |
  | 351 |  | 'notify\_user\_deleted\_subject'    => \_\_(~~'Notify user on deleted request subject', 'booking-calendar'~~ ), |
  | 352 |  | 'notify\_user\_deleted\_content'        => \_\_(~~'Notify user on deleted request content', 'booking-calendar'~~ ), |
  | 353 |  | 'notify\_user\_paypal\_from' => \_\_(~~'Notify user on paypal request from', 'booking-calendar'~~ ), |
  | 354 |  | 'notify\_user\_paypal\_fromname'   => \_\_(~~'Notify user on paypal request fromname', 'booking-calendar'~~ ), |
  | 355 |  | 'notify\_user\_paypal\_subject'    => \_\_(~~'Notify user on paypal request subject', 'booking-calendar'~~ ), |
  | 356 |  | 'notify\_user\_paypal\_content'        => \_\_(~~'Notify user on paypal request content', 'booking-calendar'~~ ), |
  | 357 |  | 'notify\_user\_paypal\_failed\_from' => \_\_(~~'Notify user on paypal failed request from', 'booking-calendar'~~ ), |
  | 358 |  | 'notify\_user\_paypal\_failed\_fromname'   => \_\_(~~'Notify user on paypal failed request fromname', 'booking-calendar'~~ ), |
  | 359 |  | 'notify\_user\_paypal\_failed\_subject'    => \_\_(~~'Notify user on paypal failed request subject', 'booking-calendar'~~ ), |
  | 360 |  | 'notify\_user\_paypal\_failed\_content'        => \_\_(~~'Notify user on paypal failed request content', 'booking-calendar'~~ ), |
  | 361 |  | ); |
  | 362 |  | $like = '%' . $wpdb->esc\_like(~~$email\_address~~ ) . '%'; |
  | 363 |  | ~~$query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE  value LIKE %s LIMIT 0,'.~~$limit, $like); |
  |  | 319 | 'notify\_admin\_on\_book\_to'       => \_\_('Notify on book request to', 'booking-calendar'), |
  |  | 320 | 'notify\_admin\_on\_book\_from' => \_\_('Notify on book request from', 'booking-calendar'), |
  |  | 321 | 'notify\_admin\_on\_book\_fromname'   => \_\_('Notify on book request fromname', 'booking-calendar'), |
  |  | 322 | 'notify\_admin\_on\_book\_subject'    => \_\_('Notify on book request subject', 'booking-calendar'), |
  |  | 323 | 'notify\_admin\_on\_book\_content'        => \_\_('Notify on book request content', 'booking-calendar'), |
  |  | 324 | 'notify\_admin\_on\_approved\_to'       => \_\_('Notify on approved request to', 'booking-calendar'), |
  |  | 325 | 'notify\_admin\_on\_approved\_from' => \_\_('Notify on approved request from', 'booking-calendar'), |
  |  | 326 | 'notify\_admin\_on\_approved\_fromname'   => \_\_('Notify on approved request fromname', 'booking-calendar'), |
  |  | 327 | 'notify\_admin\_on\_approved\_subject'    => \_\_('Notify on approved request subject', 'booking-calendar'), |
  |  | 328 | 'notify\_admin\_on\_approved\_content'        => \_\_('Notify on approved request content', 'booking-calendar'), |
  |  | 329 | 'notify\_admin\_paypal\_to'       => \_\_('Notify on paypal request to', 'booking-calendar'), |
  |  | 330 | 'notify\_admin\_paypal\_from' => \_\_('Notify on paypal request from', 'booking-calendar'), |
  |  | 331 | 'notify\_admin\_paypal\_fromname'   => \_\_('Notify on paypal request fromname', 'booking-calendar'), |
  |  | 332 | 'notify\_admin\_paypal\_subject'    => \_\_('Notify on paypal request subject', 'booking-calendar'), |
  |  | 333 | 'notify\_admin\_paypal\_content'        => \_\_('Notify on paypal request content', 'booking-calendar'), |
  |  | 334 | 'notify\_user\_on\_book\_from' => \_\_('Notify user on book request from', 'booking-calendar'), |
  |  | 335 | 'notify\_user\_on\_book\_fromname'   => \_\_('Notify user on book request fromname', 'booking-calendar'), |
  |  | 336 | 'notify\_user\_on\_book\_subject'    => \_\_('Notify user on book request subject', 'booking-calendar'), |
  |  | 337 | 'notify\_user\_on\_book\_content'        => \_\_('Notify user on book request content', 'booking-calendar'), |
  |  | 338 | 'notify\_user\_on\_approved\_from' => \_\_('Notify user on approved request from', 'booking-calendar'), |
  |  | 339 | 'notify\_user\_on\_approved\_fromname'   => \_\_('Notify user on approved request fromname', 'booking-calendar'), |
  |  | 340 | 'notify\_user\_on\_approved\_subject'    => \_\_('Notify user on approved request subject', 'booking-calendar'), |
  |  | 341 | 'notify\_user\_on\_approved\_content'        => \_\_('Notify user on approved request content', 'booking-calendar'), |
  |  | 342 | 'notify\_user\_canceled\_from' => \_\_('Notify user on canceled request from', 'booking-calendar'), |
  |  | 343 | 'notify\_user\_canceled\_fromname'   => \_\_('Notify user on canceled request fromname', 'booking-calendar'), |
  |  | 344 | 'notify\_user\_canceled\_subject'    => \_\_('Notify user on canceled request subject', 'booking-calendar'), |
  |  | 345 | 'notify\_user\_canceled\_content'        => \_\_('Notify user on canceled request content', 'booking-calendar'), |
  |  | 346 | 'notify\_user\_deleted\_from' => \_\_('Notify user on deleted request from', 'booking-calendar'), |
  |  | 347 | 'notify\_user\_deleted\_fromname'   => \_\_('Notify user on deleted request fromname', 'booking-calendar'), |
  |  | 348 | 'notify\_user\_deleted\_subject'    => \_\_('Notify user on deleted request subject', 'booking-calendar'), |
  |  | 349 | 'notify\_user\_deleted\_content'        => \_\_('Notify user on deleted request content', 'booking-calendar'), |
  |  | 350 | 'notify\_user\_paypal\_from' => \_\_('Notify user on paypal request from', 'booking-calendar'), |
  |  | 351 | 'notify\_user\_paypal\_fromname'   => \_\_('Notify user on paypal request fromname', 'booking-calendar'), |
  |  | 352 | 'notify\_user\_paypal\_subject'    => \_\_('Notify user on paypal request subject', 'booking-calendar'), |
  |  | 353 | 'notify\_user\_paypal\_content'        => \_\_('Notify user on paypal request content', 'booking-calendar'), |
  |  | 354 | 'notify\_user\_paypal\_failed\_from' => \_\_('Notify user on paypal failed request from', 'booking-calendar'), |
  |  | 355 | 'notify\_user\_paypal\_failed\_fromname'   => \_\_('Notify user on paypal failed request fromname', 'booking-calendar'), |
  |  | 356 | 'notify\_user\_paypal\_failed\_subject'    => \_\_('Notify user on paypal failed request subject', 'booking-calendar'), |
  |  | 357 | 'notify\_user\_paypal\_failed\_content'        => \_\_('Notify user on paypal failed request content', 'booking-calendar'), |
  |  | 358 | ); |
  |  | 359 | $like = '%' . $wpdb->esc\_like($email\_address) . '%'; |
  |  | 360 | $query = $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE  value LIKE %s LIMIT 0,' . $limit, $like); |
  | 364 | 361 | $rows = $wpdb->get\_results($query); |
  | 365 | 362 |  |
  | 366 |  | foreach ($rows as $row){ |
  | 367 |  | $data\_to\_export = array(); |
  | 368 |  | $group\_id = 'theme'; |
  | 369 |  | $item\_id = $row->id; |
  | 370 |  | $options = json\_decode($row->value); |
  | 371 |  |  |
  | 372 |  | ~~foreach ( $prop\_to\_export as $key => $name~~ ) { |
  |  | 363 | foreach ($rows as $row) { |
  |  | 364 | $data\_to\_export = array(); |
  |  | 365 | $group\_id = 'theme'; |
  |  | 366 | $item\_id = $row->id; |
  |  | 367 | $options = json\_decode($row->value); |
  |  | 368 |  |
  |  | 369 | foreach ($prop\_to\_export as $key => $name) { |
  | 373 | 370 | $value = $options->{$key}; |
  | 374 |  |  |
  | 375 |  | if ( ! empty( $value ) ) { |
  | 376 |  | $data\_to\_export[] = array( |
  | 377 |  | 'name'  => $name, |
  | 378 |  | 'value' => $value, |
  |  | 371 |  |
  |  | 372 | if (! empty($value)) { |
  |  | 373 | $data\_to\_export[] = array( |
  |  | 374 | 'name'  => $name, |
  |  | 375 | 'value' => $value, |
  |  | 376 | ); |
  |  | 377 | } |
  |  | 378 | } |
  |  | 379 |  |
  |  | 380 | if (!empty($data\_to\_export)) { |
  |  | 381 | $done = true; |
  |  | 382 | $export\_items[] = array( |
  |  | 383 | 'group\_id' => $group\_id, |
  |  | 384 | 'group\_label' => \_\_('Booking Calendar Themes Data', 'booking-calendar'), |
  |  | 385 | 'item\_id' => $item\_id, |
  |  | 386 | 'data' => $data\_to\_export, |
  | 379 | 387 | ); |
  | 380 | 388 | } |
  | 381 |  | ~~}~~ |
  | 382 |  |  |
  | 383 |  | ~~if(!empty($data\_to\_export)){~~ |
  | 384 |  | ~~$done = true;~~ |
  | 385 |  | ~~$export\_items[] = array(~~ |
  | 386 |  | ~~'group\_id' => $group\_id,~~ |
  | 387 |  | ~~'group\_label' => \_\_('Booking Calendar Themes Data', 'booking-calendar'),~~ |
  | 388 |  | ~~'item\_id' => $item\_id,~~ |
  | 389 |  | ~~'data' => $data\_to\_export,~~ |
  | 390 |  | ~~);~~ |
  | 391 |  | ~~}~~ |
  | 392 | 389 | } |
  | 393 | 390 |  |
  | 394 | 391 | return array( |
  | 395 |  | 'data' => $export\_items, |
  | 396 |  | 'done' => $done, |
  | 397 |  | ); |
  | 398 |  | } |
  | 399 |  |  |
  | 400 |  | public function wpdevart\_plugin\_eraser(~~$erasers~~ ) { |
  |  | 392 | 'data' => $export\_items, |
  |  | 393 | 'done' => $done, |
  |  | 394 | ); |
  |  | 395 | } |
  |  | 396 |  |
  |  | 397 | public function wpdevart\_plugin\_eraser($erasers) { |
  | 401 | 398 | $erasers['wpdevart-booking-calendar'] = array( |
  | 402 |  | ~~'eraser\_friendly\_name' => \_\_( 'Booking Calendar WpDevArt', 'booking-calendar'~~ ), |
  | 403 |  | ~~'callback'             => array($this,~~'wpdevart\_eraser'), |
  |  | 399 | 'eraser\_friendly\_name' => \_\_('Booking Calendar WpDevArt', 'booking-calendar'), |
  |  | 400 | 'callback'             => array($this, 'wpdevart\_eraser'), |
  | 404 | 401 | ); |
  | 405 | 402 | return $erasers; |
  | 406 | 403 | } |
  | 407 |  |  |
  | 408 |  | public function wpdevart\_eraser(~~$email\_address, $page = 1~~ ) { |
  |  | 404 |  |
  |  | 405 | public function wpdevart\_eraser($email\_address, $page = 1) { |
  | 409 | 406 | global $wpdb; |
  | 410 |  | if (~~empty( $email\_address )~~ ) { |
  |  | 407 | if (empty($email\_address)) { |
  | 411 | 408 | return array( |
  | 412 | 409 | 'items\_removed'  => false, |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L417) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L414) |  |
  | 417 | 414 | } |
  | 418 | 415 | $count = 0; |
  | 419 |  | $like = '%' . $wpdb->esc\_like(~~$email\_address~~ ) . '%'; |
  |  | 416 | $like = '%' . $wpdb->esc\_like($email\_address) . '%'; |
  | 420 | 417 | $pay\_id = $wpdb->get\_var($wpdb->prepare("SELECT " . $wpdb->prefix . "wpdevart\_payments.pay\_id FROM " . $wpdb->prefix . "wpdevart\_reservations LEFT JOIN " . $wpdb->prefix . "wpdevart\_payments ON " . $wpdb->prefix . "wpdevart\_reservations.id=" . $wpdb->prefix . "wpdevart\_payments.res\_id WHERE  " . $wpdb->prefix . "wpdevart\_reservations.email LIKE %s", $like)); |
  | 421 |  | if~~($pay\_id)~~{ |
  | 422 |  | $query = $wpdb->query($wpdb->prepare(~~'DELETE FROM ' . $wpdb->prefix . 'wpdevart\_payments WHERE pay\_id="%d"',$pay\_id~~ )); |
  |  | 418 | if ($pay\_id) { |
  |  | 419 | $query = $wpdb->query($wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_payments WHERE pay\_id="%d"', $pay\_id)); |
  | 423 | 420 | $count += $query ? 1 : 0; |
  | 424 | 421 | } |
  | 425 | 422 |  |
  | 426 |  | $query = $wpdb->query($wpdb->prepare(~~'DELETE FROM ' . $wpdb->prefix . 'wpdevart\_reservations WHERE email LIKE %s', $like~~ )); |
  |  | 423 | $query = $wpdb->query($wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_reservations WHERE email LIKE %s', $like)); |
  | 427 | 424 | $count += $query ? 1 : 0; |
  | 428 |  |  |
  |  | 425 |  |
  | 429 | 426 | $query = $wpdb->query($wpdb->prepare('DELETE FROM ' . $wpdb->prefix . 'wpdevart\_themes WHERE value LIKE %s', $like)); |
  | 430 | 427 | $count += $query ? 1 : 0; |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L432) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L429) |  |
  | 432 | 429 |  |
  | 433 | 430 | return array( |
  | 434 |  | 'items\_removed' => $items\_removed, |
  | 435 |  | 'items\_retained' => false, |
  | 436 |  | 'messages' => array(), |
  | 437 |  | 'done' => true, |
  | 438 |  | ); |
  | 439 |  | } |
  | 440 |  |  |
  |  | 431 | 'items\_removed' => $items\_removed, |
  |  | 432 | 'items\_retained' => false, |
  |  | 433 | 'messages' => array(), |
  |  | 434 | 'done' => true, |
  |  | 435 | ); |
  |  | 436 | } |
  |  | 437 |  |
  | 441 | 438 | public function wpdevart\_privacy\_policy() { |
  | 442 | 439 | $title = \_\_('Booking Calendar WpDevArt', "booking-calendar"); |
  | 443 | 440 |  |
  | 444 |  | $text = \_\_('Booking Calendar WpDevArt(free and premium versions) has the opportunity for submitting forms and extras. When users submit forms or extras, they can also provide personal information, such as name, email, addresses, phone number and so on. All this data will be saved in WordPress database, so you need to receive user agreement when they submit booking forms(or extras). Also, you need to get the user agreement when you delete or export their data upon their request. In accordance with GDPR, you need to be sure that all information is protected and the other services that you are using also observe data protection. In this case, you have liability, so check other services privacy policy as well and tell them to follow to the GDPR.', "booking-calendar"); |
  | 445 |  |  |
  | 446 |  | ~~if ( ! function\_exists( 'wp\_add\_privacy\_policy\_content' )~~ ) { |
  |  | 441 | $text = \_\_('Booking Calendar WpDevArt(free and premium versions) has the opportunity for submitting forms and extras. When users submit forms or extras, they can also provide personal information, such as name, email, addresses, phone number and so on. All this data will be saved in WordPress database, so you need to receive user agreement when they submit booking forms(or extras). Also, you need to get the user agreement when you delete or export their data upon their request. In accordance with GDPR, you need to be sure that all information is protected and the other services that you are using also observe data protection. In this case, you have liability, so check other services privacy policy as well and tell them to follow to the GDPR.', "booking-calendar"); |
  |  | 442 |  |
  |  | 443 | if (! function\_exists('wp\_add\_privacy\_policy\_content')) { |
  | 447 | 444 | return; |
  | 448 | 445 | } |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L451) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L448) |  |
  | 451 | 448 | '<h3>' . $title . '</h3>' . '<p class="wp-policy-help">' . $text . '</p>' // content |
  | 452 | 449 | ); |
  | 453 |  |  |
  | 454 |  | } |
  | 455 |  |  |
  |  | 450 | } |
  |  | 451 |  |
  | 456 | 452 | public function get\_form\_data($form, $cal\_id, $form\_id, $type = "") { |
  | 457 | 453 | global $wpdb; |
  | 458 |  | if($form) { |
  |  | 454 | if ($form) { |
  | 459 | 455 | $form\_value = json\_decode($form, true); |
  | 460 | 456 | $form\_info = $wpdb->get\_var($wpdb->prepare('SELECT data FROM ' . $wpdb->prefix . 'wpdevart\_forms WHERE id="%d"', $form\_id)); |
  | 461 |  | if($form\_info) { |
  |  | 457 | if ($form\_info) { |
  | 462 | 458 | $form\_info = json\_decode($form\_info, true); |
  | 463 |  | if~~(isset($form\_info['apply']) || isset($form\_info['save']))~~ { |
  |  | 459 | if (isset($form\_info['apply']) || isset($form\_info['save'])) { |
  | 464 | 460 | array\_shift($form\_info); |
  | 465 | 461 | } |
  | 466 |  | foreach($form\_info as $key=>$form\_fild\_info) { |
  | 467 |  | if(isset($form\_value["wpdevart\_".$type.$key])) { |
  | 468 |  | $form\_info[$key]["value"] = $form\_value["wpdevart\_".$type.$key]; |
  | 469 |  | } |
  | 470 |  | else { |
  |  | 462 | foreach ($form\_info as $key => $form\_fild\_info) { |
  |  | 463 | if (isset($form\_value["wpdevart\_" . $type . $key])) { |
  |  | 464 | $form\_info[$key]["value"] = $form\_value["wpdevart\_" . $type . $key]; |
  |  | 465 | } else { |
  | 471 | 466 | $form\_info[$key]["value"] = ""; |
  | 472 | 467 | } |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L479) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L474) |  |
  | 479 | 474 | } |
  | 480 | 475 | $value = ""; |
  | 481 |  | if~~(count($form\_info))~~{ |
  | 482 |  | foreach($form\_info as $form\_fild\_data) { |
  |  | 476 | if (count($form\_info)) { |
  |  | 477 | foreach ($form\_info as $form\_fild\_data) { |
  | 483 | 478 | $field\_val = $form\_fild\_data["value"]; |
  | 484 |  | if~~(strpos($form\_fild\_data["value"], "|wpdev|") !== false)~~{ |
  | 485 |  | $field\_val = explode("|wpdev|",$form\_fild\_data["value"]); |
  | 486 |  | $field\_val = implode(", ",$field\_val); |
  |  | 479 | if (strpos($form\_fild\_data["value"], "|wpdev|") !== false) { |
  |  | 480 | $field\_val = explode("|wpdev|", $form\_fild\_data["value"]); |
  |  | 481 | $field\_val = implode(", ", $field\_val); |
  | 487 | 482 | } |
  | 488 |  | if($form\_fild\_data["type"] == "upload" && trim($field\_val) != "") |
  |  | 483 | if ($form\_fild\_data["type"] == "upload" && trim($field\_val) != "") |
  | 489 | 484 | $field\_val = "<a href='" . $field\_val . "' target='\_blank'>" . \_\_("File", 'booking-calendar') . "</a>"; |
  | 490 |  | $value .= "<strong>"~~. $form\_fild\_data["label"] .":</strong> ". $field\_val .~~"<br />"; |
  | 491 |  | } |
  | 492 |  | } |
  | 493 |  |  |
  |  | 485 | $value .= "<strong>" . $form\_fild\_data["label"] . ":</strong> " . $field\_val . "<br />"; |
  |  | 486 | } |
  |  | 487 | } |
  |  | 488 |  |
  | 494 | 489 | return $value; |
  | 495 |  | ~~}~~ |
  |  | 490 | } |
  | 496 | 491 | /\*GDPR\*/ |
  | 497 |  |  |
  |  | 492 |  |
  | 498 | 493 | public function wpdevart\_captcha() { |
  | 499 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  |  | 494 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  | 500 | 495 | die('Request has failed.'); |
  | 501 | 496 | } |
  | 502 | 497 | $response = isset($\_POST['wpdevart\_captcha']) ? esc\_html($\_POST['wpdevart\_captcha']) : ""; |
  | 503 |  | $global\_settings = get\_option("wpdevartec\_settings") === false ? array() :  json\_decode(get\_option("wpdevartec\_settings"), true); |
  |  | 498 | $global\_settings = get\_option("wpdevartec\_settings") === false ? array() :  json\_decode(get\_option("wpdevartec\_settings"), true); |
  | 504 | 499 | $secret = isset($global\_settings["recaptcha\_private\_key"]) ? $global\_settings["recaptcha\_private\_key"] : ""; |
  | 505 | 500 | $verify = wp\_remote\_get("https://www.google.com/recaptcha/api/siteverify?secret={$secret}&response={$response}"); |
  | 506 |  | if (~~is\_array( $verify ) && ! is\_wp\_error( $verify )~~ ) { |
  | 507 |  | $body    = $verify['body']; |
  |  | 501 | if (is\_array($verify) && ! is\_wp\_error($verify)) { |
  |  | 502 | $body    = $verify['body']; |
  | 508 | 503 | $captcha\_success = json\_decode($body); |
  | 509 | 504 | if ($captcha\_success->success == false) { |
  | 510 |  | echo 0; |
  | 511 |  | } |
  | 512 |  | else if ($captcha\_success->success==true) { |
  | 513 |  | echo 1; |
  | 514 |  | } |
  | 515 |  |  |
  |  | 505 | echo 0; |
  |  | 506 | } else if ($captcha\_success->success == true) { |
  |  | 507 | echo 1; |
  |  | 508 | } |
  | 516 | 509 | } else { |
  | 517 | 510 | echo 0; |
  | 518 | 511 | } |
  | 519 |  |  |
  | 520 |  | wp\_die(); |
  | 521 |  | } |
  | 522 |  |  |
  |  | 512 |  |
  |  | 513 | wp\_die(); |
  |  | 514 | } |
  |  | 515 |  |
  | 523 | 516 | /\*Export\*/ |
  | 524 |  | public function wpdevart\_export() { |
  | 525 |  | $capability = wpdevart\_bc\_Library::get\_capability('reservation\_page'); |
  | 526 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce') || !current\_user\_can($capability)) { |
  |  | 517 | public function wpdevart\_export() { |
  |  | 518 | $capability = wpdevart\_bc\_Library::get\_capability('reservation\_page'); |
  |  | 519 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce') || !current\_user\_can($capability)) { |
  | 527 | 520 | die('Request has failed.'); |
  | 528 | 521 | } |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L532) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L525) |  |
  | 532 | 525 | wp\_die(); |
  | 533 | 526 | } |
  | 534 |  |  |
  | 535 |  | public function wpdevart\_booking\_calendar($id~~=0, $res\_id=0, $date='', $ajax = false, $selected = array(),$data = array(),$submit = "",$widget = false,~~$hours = array()) { |
  |  | 527 |  |
  |  | 528 | public function wpdevart\_booking\_calendar($id = 0, $res\_id = 0, $date = '', $ajax = false, $selected = array(), $data = array(), $submit = "", $widget = false, $hours = array()) { |
  | 536 | 529 | $main\_class = new wpdevart\_Main($id, $widget); |
  |  | 530 | if(intval($id) == 0){ |
  |  | 531 | return 'invalid id'; |
  |  | 532 | } |
  | 537 | 533 | ob\_start(); |
  | 538 |  | echo $main\_class->main\_booking\_calendar($id,~~$res\_id, $date, $ajax, $selected,$data,$submit,~~$hours); |
  |  | 534 | echo $main\_class->main\_booking\_calendar($id, $res\_id, $date, $ajax, $selected, $data, $submit, $hours); |
  | 539 | 535 | return ob\_get\_clean(); |
  | 540 | 536 | } |
  | 541 |  |  |
  | 542 |  | public function wpdevart\_booking\_calendar\_res($id~~=0, $date=~~'', $ajax = false) { |
  |  | 537 |  |
  |  | 538 | public function wpdevart\_booking\_calendar\_res($id = 0, $date = '', $ajax = false) { |
  | 543 | 539 | $main\_class = new wpdevart\_Main($id); |
  | 544 | 540 | echo $main\_class->main\_booking\_calendar\_res($date, $ajax); |
  | 545 | 541 | } |
  | 546 |  |  |
  | 547 |  | public function  wpdevart\_get\_interval\_dates(){ |
  | 548 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  |  | 542 |  |
  |  | 543 | public function  wpdevart\_get\_interval\_dates() { |
  |  | 544 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  | 549 | 545 | die('Request has failed.'); |
  | 550 | 546 | } |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L552) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L548) |  |
  | 552 | 548 | $main\_class->wpdevart\_get\_interval\_dates(); |
  | 553 | 549 | } |
  | 554 |  |  |
  |  | 550 |  |
  | 555 | 551 | public function wpdevart\_ajax() { |
  | 556 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  |  | 552 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  | 557 | 553 | die('Request has failed.'); |
  | 558 | 554 | } |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L562) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L558) |  |
  | 562 | 558 | wp\_die(); |
  | 563 | 559 | } |
  | 564 |  |  |
  |  | 560 |  |
  | 565 | 561 | public function wpdevart\_form\_ajax() { |
  | 566 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  |  | 562 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  | 567 | 563 | die('Request has failed.'); |
  | 568 | 564 | } |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L572) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L568) |  |
  | 572 | 568 | wp\_die(); |
  | 573 | 569 | } |
  | 574 |  |  |
  |  | 570 |  |
  | 575 | 571 | public function wpdevart\_payment\_ajax() { |
  | 576 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  |  | 572 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  | 577 | 573 | die('Request has failed.'); |
  | 578 | 574 | } |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L581) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L577) |  |
  | 581 | 577 | wp\_die(); |
  | 582 | 578 | } |
  | 583 |  |  |
  |  | 579 |  |
  | 584 | 580 | public function wpdevart\_payment() { |
  | 585 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  |  | 581 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce')) { |
  | 586 | 582 | die('Request has failed.'); |
  | 587 | 583 | } |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L590) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L586) |  |
  | 590 | 586 | $controller->perform(); |
  | 591 | 587 | } |
  | 592 |  |  |
  |  | 588 |  |
  | 593 | 589 | public function wpdevart\_quick\_update() { |
  | 594 | 590 | $capability = wpdevart\_bc\_Library::get\_capability('reservation\_page'); |
  | 595 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce') || !current\_user\_can($capability)) { |
  |  | 591 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_nonce') || !current\_user\_can($capability)) { |
  | 596 | 592 | die('Request has failed.'); |
  | 597 | 593 | } |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L600) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L596) |  |
  | 600 | 596 | wp\_die(); |
  | 601 | 597 | } |
  | 602 |  |  |
  |  | 598 |  |
  | 603 | 599 | public function wpdevart\_add\_field() { |
  | 604 | 600 | $capability = wpdevart\_bc\_Library::get\_capability('form\_page'); |
  | 605 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_form\_nonce') || !current\_user\_can($capability)) { |
  | 606 |  | die('Request has failed.'); |
  | 607 |  | } |
  | 608 |  | if (~~isset( $\_POST['wpdevart\_field\_type'] )~~ ) { |
  | 609 |  | $type = str\_replace('\_field', '', sanitize\_text\_field($\_POST['wpdevart\_field\_type'])); |
  | 610 |  | } |
  | 611 |  | $max\_id = isset(~~$\_POST['wpdevart\_field\_max'] ) ? sanitize\_text\_field(~~ $\_POST['wpdevart\_field\_max']) : 0; |
  | 612 |  | $count =  isset(~~$\_POST['wpdevart\_field\_count'] )  ? sanitize\_text\_field(~~ $\_POST['wpdevart\_field\_count']) : 0; |
  |  | 601 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_form\_nonce') || !current\_user\_can($capability)) { |
  |  | 602 | die('Request has failed.'); |
  |  | 603 | } |
  |  | 604 | if (isset($\_POST['wpdevart\_field\_type'])) { |
  |  | 605 | $type = str\_replace('\_field', '', sanitize\_text\_field($\_POST['wpdevart\_field\_type'])); |
  |  | 606 | } |
  |  | 607 | $max\_id = isset($\_POST['wpdevart\_field\_max']) ? sanitize\_text\_field($\_POST['wpdevart\_field\_max']) : 0; |
  |  | 608 | $count =  isset($\_POST['wpdevart\_field\_count'])  ? sanitize\_text\_field($\_POST['wpdevart\_field\_count']) : 0; |
  | 613 | 609 | $args =  array( |
  | 614 | 610 | 'name'   => 'form\_field' . ($max\_id + 1 + $count), |
  | 615 |  | 'label' => \_\_(~~'New ' . $type . ' Field', 'booking-calendar'~~ ), |
  |  | 611 | 'label' => \_\_('New ' . $type . ' Field', 'booking-calendar'), |
  | 616 | 612 | 'type' => $type, |
  | 617 | 613 | 'default' => '' |
  | 618 | 614 | ); |
  | 619 | 615 | $function\_name = "wpdevart\_form\_" . $type; |
  | 620 |  | wpdevart\_bc\_Library::$function\_name($args, array('label' => \_\_(~~'New ' . $type . ' Field', 'booking-calendar'~~ ))); |
  | 621 |  | wp\_die(); |
  | 622 |  | } |
  | 623 |  |  |
  |  | 616 | wpdevart\_bc\_Library::$function\_name($args, array('label' => \_\_('New ' . $type . ' Field', 'booking-calendar'))); |
  |  | 617 | wp\_die(); |
  |  | 618 | } |
  |  | 619 |  |
  | 624 | 620 | public function wpdevart\_add\_extra\_field() { |
  | 625 | 621 | $capability = wpdevart\_bc\_Library::get\_capability('extra\_page'); |
  | 626 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_form\_nonce') || !current\_user\_can($capability)) { |
  | 627 |  | die('Request has failed.'); |
  | 628 |  | } |
  | 629 |  | $max\_id =  isset(~~$\_POST['wpdevart\_extra\_field\_max'] )  ? sanitize\_text\_field(~~ $\_POST['wpdevart\_extra\_field\_max']) : 0; |
  | 630 |  | $count = isset(~~$\_POST['wpdevart\_extra\_field\_count'] )  ? sanitize\_text\_field(~~ $\_POST['wpdevart\_extra\_field\_count']) : 0; |
  |  | 622 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_form\_nonce') || !current\_user\_can($capability)) { |
  |  | 623 | die('Request has failed.'); |
  |  | 624 | } |
  |  | 625 | $max\_id =  isset($\_POST['wpdevart\_extra\_field\_max'])  ? sanitize\_text\_field($\_POST['wpdevart\_extra\_field\_max']) : 0; |
  |  | 626 | $count = isset($\_POST['wpdevart\_extra\_field\_count'])  ? sanitize\_text\_field($\_POST['wpdevart\_extra\_field\_count']) : 0; |
  | 631 | 627 | $args =  array( |
  | 632 | 628 | 'name'   => 'extra\_field' . ($max\_id + 1 + $count), |
  | 633 |  | 'label' => \_\_(~~'New Extra', 'booking-calendar'~~ ), |
  |  | 629 | 'label' => \_\_('New Extra', 'booking-calendar'), |
  | 634 | 630 | 'type' => 'extras\_field', |
  | 635 | 631 | 'items' => array( |
  | 636 |  | 'field\_item1' => array('name'=>'field\_item1', |
  | 637 |  | 'label' => '1', |
  | 638 |  | 'operation' => '+', |
  | 639 |  | 'price\_type' => 'price', |
  | 640 |  | 'price\_percent' => '0', |
  | 641 |  | 'order' => '1' |
  | 642 |  | ), |
  | 643 |  | 'field\_item2' => array('name'=>'field\_item2', |
  | 644 |  | 'label' => '2', |
  | 645 |  | 'operation' => '+', |
  | 646 |  | 'price\_type' => 'price', |
  | 647 |  | 'price\_percent' => '0', |
  | 648 |  | 'order' => '2' |
  | 649 |  | ), |
  | 650 |  | 'field\_item3' => array('name'=>'field\_item3', |
  | 651 |  | 'label' => '3', |
  | 652 |  | 'operation' => '+', |
  | 653 |  | 'price\_type' => 'price', |
  | 654 |  | 'price\_percent' => '0', |
  | 655 |  | 'order' => '3' |
  | 656 |  | ) |
  |  | 632 | 'field\_item1' => array( |
  |  | 633 | 'name' => 'field\_item1', |
  |  | 634 | 'label' => '1', |
  |  | 635 | 'operation' => '+', |
  |  | 636 | 'price\_type' => 'price', |
  |  | 637 | 'price\_percent' => '0', |
  |  | 638 | 'order' => '1' |
  |  | 639 | ), |
  |  | 640 | 'field\_item2' => array( |
  |  | 641 | 'name' => 'field\_item2', |
  |  | 642 | 'label' => '2', |
  |  | 643 | 'operation' => '+', |
  |  | 644 | 'price\_type' => 'price', |
  |  | 645 | 'price\_percent' => '0', |
  |  | 646 | 'order' => '2' |
  |  | 647 | ), |
  |  | 648 | 'field\_item3' => array( |
  |  | 649 | 'name' => 'field\_item3', |
  |  | 650 | 'label' => '3', |
  |  | 651 | 'operation' => '+', |
  |  | 652 | 'price\_type' => 'price', |
  |  | 653 | 'price\_percent' => '0', |
  |  | 654 | 'order' => '3' |
  |  | 655 | ) |
  | 657 | 656 | ), |
  | 658 | 657 | 'default' => '' |
  | 659 | 658 | ); |
  | 660 |  | wpdevart\_bc\_Library::wpdevart\_extras\_field($args,$args); |
  | 661 |  | wp\_die(); |
  | 662 |  | } |
  | 663 |  |  |
  |  | 659 | wpdevart\_bc\_Library::wpdevart\_extras\_field($args, $args); |
  |  | 660 | wp\_die(); |
  |  | 661 | } |
  |  | 662 |  |
  | 664 | 663 | public function wpdevart\_add\_extra\_field\_item() { |
  | 665 | 664 | $capability = wpdevart\_bc\_Library::get\_capability('extra\_page'); |
  | 666 |  | if(!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_form\_nonce') || !current\_user\_can($capability)) { |
  | 667 |  | die('Request has failed.'); |
  | 668 |  | } |
  | 669 |  | $max\_id = isset( $\_POST['wpdevart\_extra\_field\_item\_max'] ) ? sanitize\_text\_field( $\_POST['wpdevart\_extra\_field\_item\_max']) : 0; |
  | 670 |  | if ( isset( $\_POST['wpdevart\_extra\_field'] ) ) { |
  | 671 |  | $extra\_field = sanitize\_text\_field( $\_POST['wpdevart\_extra\_field']); |
  | 672 |  | } |
  | 673 |  | $count = isset( $\_POST['wpdevart\_extra\_field\_item\_count'] ) ? sanitize\_text\_field( $\_POST['wpdevart\_extra\_field\_item\_count']) : 0; |
  | 674 |  | $args =  array('name'=>'field\_item'. ($max\_id + 1 + $count), |
  |  | 665 | if (!check\_ajax\_referer('wpdevart\_ajax\_nonce', 'wpdevart\_form\_nonce') || !current\_user\_can($capability)) { |
  |  | 666 | die('Request has failed.'); |
  |  | 667 | } |
  |  | 668 | $max\_id = isset($\_POST['wpdevart\_extra\_field\_item\_max']) ? sanitize\_text\_field($\_POST['wpdevart\_extra\_field\_item\_max']) : 0; |
  |  | 669 | if (isset($\_POST['wpdevart\_extra\_field'])) { |
  |  | 670 | $extra\_field = sanitize\_text\_field($\_POST['wpdevart\_extra\_field']); |
  |  | 671 | } |
  |  | 672 | $count = isset($\_POST['wpdevart\_extra\_field\_item\_count']) ? sanitize\_text\_field($\_POST['wpdevart\_extra\_field\_item\_count']) : 0; |
  |  | 673 | $args =  array( |
  |  | 674 | 'name' => 'field\_item' . ($max\_id + 1 + $count), |
  | 675 | 675 | 'label' => ($max\_id + 1), |
  | 676 | 676 | 'operation' => '+', |
  | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3201231#L679) | […](/browser/booking-calendar/trunk/booking_calendar.php?rev=3209851#L679) |  |
  | 679 | 679 | 'order' => ($max\_id + 1) |
  | 680 | 680 | ); |
  | 681 |  | wpdevart\_bc\_Library::wpdevart\_extras\_field\_item($extra\_field,$args); |
  | 682 |  | wp\_die(); |
  | 683 |  | } |
  | 684 |  |  |
  |  | 681 | wpdevart\_bc\_Library::wpdevart\_extras\_field\_item($extra\_field, $args); |
  |  | 682 | wp\_die(); |
  |  | 683 | } |
  | 685 | 684 | } |
  | 686 | 685 | $wpdevart\_booking = new wpdevart\_bc\_calendar(); // Creation of the main object |
  | 687 |  |  |
  | 688 |  | ~~?>~~ |
* ## [booking-calendar/trunk/includes/booking\_class.php](/changeset/3209851/booking-calendar/trunk/includes/booking_class.php "Show the changeset 3209851 restricted to booking-calendar/trunk/includes/booking_class.php")

  | [r3201222](/browser/booking-calendar/trunk/includes/booking_class.php?rev=3201222#L1285 "Show revision 3201222 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/includes/booking_class.php?rev=3209851#L1285 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 1285 | 1285 | return $name ; |
  | 1286 | 1286 | } |
  | 1287 |  |  |
  | 1288 | 1287 | private function cleanContentSvg($content) { |
  | 1289 | 1288 | $content = preg\_replace('/<script\b[^>]\*>.\*?<\/script>/is', '', $content); |
* ## [booking-calendar/trunk/includes/main\_class.php](/changeset/3209851/booking-calendar/trunk/includes/main_class.php "Show the changeset 3209851 restricted to booking-calendar/trunk/includes/main_class.php")

  | [r3201222](/browser/booking-calendar/trunk/includes/main_class.php?rev=3201222#L85 "Show revision 3201222 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/includes/main_class.php?rev=3209851#L85 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 85 | 85 | //wpdevart\_bc\_Library::wpdevart\_redirect($url); |
  | 86 | 86 | } |
  | 87 |  | } |
  | 88 |  |  |
  |  | 87 | } |
  | 89 | 88 | if(isset($this->theme\_option['delete\_prev\_date']) && $this->theme\_option['delete\_prev\_date'] == "on") { |
  | 90 | 89 | $day = date( 'Y-m-d', strtotime("last day")); |
  | […](/browser/booking-calendar/trunk/includes/main_class.php?rev=3201222#L92) | […](/browser/booking-calendar/trunk/includes/main_class.php?rev=3209851#L91) |  |
  | 92 | 91 | $wpdb->query($wpdb->prepare("DELETE FROM ".$wpdb->prefix . "wpdevart\_reservations WHERE calendar\_id = %d AND  (single\_day BETWEEN '1970-01-01' AND '%s' OR (check\_in BETWEEN '1970-01-01' AND '%s' AND  check\_out BETWEEN '1970-01-01' AND '%s'))" ,array( $id, $day, $day, $day) ) ); |
  | 93 | 92 | } |
  | 94 |  | $for\_trarray = $this->text\_for\_tr(); |
  |  | 93 | $for\_trarray = $this->text\_for\_tr(); |
  |  | 94 |  |
  | 95 | 95 |  |
  | 96 | 96 | if ($date == '' && !isset( $\_REQUEST['date'] )) { |
* ## [booking-calendar/trunk/readme.txt](/changeset/3209851/booking-calendar/trunk/readme.txt "Show the changeset 3209851 restricted to booking-calendar/trunk/readme.txt")

  | [r3201236](/browser/booking-calendar/trunk/readme.txt?rev=3201236#L5 "Show revision 3201236 of this file in browser") | [r3209851](/browser/booking-calendar/trunk/readme.txt?rev=3209851#L5 "Show revision 3209851 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 3.4.0 |
  | 6 | 6 | Tested up to: 6.7 |
  | 7 |  | Stable tag: 3.2.~~19~~ |
  |  | 7 | Stable tag: 3.2.20 |
  | 8 | 8 | License: GPLv3 |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-3.0.html |
  | […](/browser/booking-calendar/trunk/readme.txt?rev=3201236#L1158) | […](/browser/booking-calendar/trunk/readme.txt?rev=3209851#L1158) |  |
  | 1158 | 1158 | \* Stable tag changed |
  | 1159 | 1159 |  |
  |  | 1160 | = 3.2.20 = |
  |  | 1161 |  |
  |  | 1162 | \* Fixed: Security issue |
  |  | 1163 |  |
  | 1160 | 1164 | == Step by step guide == |
  | 1161 | 1165 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3209851)
* [Zip Archive](?format=zip&new=3209851)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


