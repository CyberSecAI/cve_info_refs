=== Content from plugins.trac.wordpress.org_62c4906c_20250114_225819.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwordpress-popup%2Ftags%2F7.8.5%2Finc%2Fhustle-modules-common-admin-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php?rev=2900135 "Revision 2900135")
* [Next Revision](/browser/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php?rev=3196639 "Revision 3196639") →
* [Blame](/browser/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wordpress-popup/tags/7.8.5/inc/hustle-modules-common-admin-ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [wordpress-popup](/browser/wordpress-popup?order=name "View wordpress-popup")/[tags](/browser/wordpress-popup/tags?order=name "View tags")/[7.8.5](/browser/wordpress-popup/tags/7.8.5?order=name "View 7.8.5")/[inc](/browser/wordpress-popup/tags/7.8.5/inc?order=name "View inc")/[hustle-modules-common-admin-ajax.php](/browser/wordpress-popup/tags/7.8.5/inc/hustle-modules-common-admin-ajax.php?order=name "View hustle-modules-common-admin-ajax.php")

View diff against:

View revision:

| [Last change](/changeset/2933986/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php "View differences") on this file was [2933986](/changeset/2933986/ "View changeset 2933986"), checked in by ivansvyrskyi, [19 months ago](/timeline?from=2023-07-04T14%3A08%3A00Z&precision=second "See timeline at 07/04/2023 02:08:00 PM") |
| --- |
| Release 7.8.0 |
| **File size:** 32.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Hustle\_Modules\_Common\_Admin\_Ajax |
| [4](#L4) | \* |
| [5](#L5) | \* @package Hustle |
| [6](#L6) | \*/ |
| [7](#L7) |  |
| [8](#L8) | if ( ! class\_exists( 'Hustle\_Modules\_Common\_Admin\_Ajax' ) ) : |
| [9](#L9) | /\*\* |
| [10](#L10) | \* Class Hustle\_Modules\_Common\_Admin\_Ajax. |
| [11](#L11) | \* Intended for Pop-up, Slide-in, Embeds, and Social sharing modules common ajax actions on admin side. |
| [12](#L12) | \* |
| [13](#L13) | \* @since 4.0 |
| [14](#L14) | \*/ |
| [15](#L15) | class Hustle\_Modules\_Common\_Admin\_Ajax { |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Constructor |
| [19](#L19) | \*/ |
| [20](#L20) | public function \_\_construct() { |
| [21](#L21) | add\_action( 'wp\_ajax\_hustle\_save\_module', array( $this, 'save\_module' ) ); |
| [22](#L22) |  |
| [23](#L23) | add\_action( 'wp\_ajax\_hustle\_fetch\_font\_families', array( $this, 'fetch\_font\_families' ) ); |
| [24](#L24) |  |
| [25](#L25) | add\_action( 'wp\_ajax\_hustle\_create\_new\_module', array( $this, 'create\_new\_module' ) ); |
| [26](#L26) | add\_action( 'wp\_ajax\_hustle\_preview\_module', array( $this, 'preview\_module' ) ); |
| [27](#L27) | add\_action( 'wp\_ajax\_hustle\_tracking\_data', array( $this, 'get\_tracking\_data' ) ); |
| [28](#L28) |  |
| [29](#L29) | // Handle bulk actions. |
| [30](#L30) | add\_action( 'wp\_ajax\_hustle\_listing\_bulk', array( $this, 'handle\_bulk\_action' ) ); |
| [31](#L31) |  |
| [32](#L32) | // Handle the actions for a single module. |
| [33](#L33) | add\_action( 'wp\_ajax\_hustle\_module\_handle\_single\_action', array( $this, 'handle\_single\_action' ) ); |
| [34](#L34) |  |
| [35](#L35) | // Used for Gutenberg. |
| [36](#L36) | add\_action( 'wp\_ajax\_hustle\_render\_module', array( $this, 'render\_module' ) ); |
| [37](#L37) | add\_action( 'wp\_ajax\_hustle\_get\_module\_id\_by\_shortcode', array( $this, 'get\_module\_id\_by\_shortcode' ) ); |
| [38](#L38) |  |
| [39](#L39) | // Ajax search for posts/pages/categories/tags visibility conditions. |
| [40](#L40) | add\_action( 'wp\_ajax\_get\_new\_condition\_ids', array( $this, 'get\_new\_condition\_ids' ) ); |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* Saves new optin to db |
| [45](#L45) | \* |
| [46](#L46) | \* @since 1.0 |
| [47](#L47) | \* @throws Exception Something went wrong. |
| [48](#L48) | \*/ |
| [49](#L49) | public function save\_module() { |
| [50](#L50) |  |
| [51](#L51) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_save\_module\_wizard' ); |
| [52](#L52) |  |
| [53](#L53) | $module\_id = filter\_input( INPUT\_POST, 'id', FILTER\_VALIDATE\_INT ); |
| [54](#L54) | Opt\_In\_Utils::is\_user\_allowed\_ajax( 'hustle\_edit\_module', $module\_id ); |
| [55](#L55) |  |
| [56](#L56) | $\_post = stripslashes\_deep( $\_POST ); // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [57](#L57) |  |
| [58](#L58) | $error\_array = array(); |
| [59](#L59) |  |
| [60](#L60) | try { |
| [61](#L61) | if ( empty( $module\_id ) ) { |
| [62](#L62) | throw new Exception(); |
| [63](#L63) | } |
| [64](#L64) |  |
| [65](#L65) | $module = Hustle\_Module\_Collection::instance()->return\_model\_from\_id( $module\_id ); |
| [66](#L66) | if ( is\_wp\_error( $module ) ) { |
| [67](#L67) | throw new Exception(); |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) | $\_post      = $module->sanitize\_module( $\_post ); |
| [71](#L71) | $validation = $module->validate\_module( $\_post ); |
| [72](#L72) | if ( true !== $validation ) { |
| [73](#L73) | $error\_array = array( 'data' => $validation['error'] ); |
| [74](#L74) | throw new Exception(); |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | $updated = $module->update\_module( $\_post ); |
| [78](#L78) |  |
| [79](#L79) | if ( isset( $updated['success'] ) && false === $updated['success'] ) { |
| [80](#L80) | $error\_array = array( 'data' => $updated['error'] ); |
| [81](#L81) | throw new Exception(); |
| [82](#L82) | } |
| [83](#L83) |  |
| [84](#L84) | if ( false === $updated ) { |
| [85](#L85) | $error\_array = array( 'data' => $updated ); |
| [86](#L86) | throw new Exception(); |
| [87](#L87) | } |
| [88](#L88) | } catch ( Exception $e ) { |
| [89](#L89) | wp\_send\_json\_error( $error\_array ); |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | wp\_send\_json\_success(); |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | /\*\* |
| [96](#L96) | \* Gets custom font families for the Appearance settings in wizard. |
| [97](#L97) | \* |
| [98](#L98) | \* @since 4.3.0 |
| [99](#L99) | \* @return void |
| [100](#L100) | \*/ |
| [101](#L101) | public function fetch\_font\_families() { |
| [102](#L102) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_fetch\_font\_families' ); |
| [103](#L103) |  |
| [104](#L104) | $families = Hustle\_Meta\_Base\_Design::get\_font\_families\_names(); |
| [105](#L105) |  |
| [106](#L106) | wp\_send\_json\_success( $families ); |
| [107](#L107) | } |
| [108](#L108) |  |
| [109](#L109) | /\*\* |
| [110](#L110) | \* Create a new module of any type |
| [111](#L111) | \* |
| [112](#L112) | \* @since 4.0.0 |
| [113](#L113) | \* @throws Exception When the module could not be created. |
| [114](#L114) | \*/ |
| [115](#L115) | public function create\_new\_module() { |
| [116](#L116) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_create\_new\_module' ); |
| [117](#L117) | Opt\_In\_Utils::is\_user\_allowed\_ajax( 'hustle\_create' ); |
| [118](#L118) |  |
| [119](#L119) | $error\_array = array( 'message' => \_\_( 'Something went wrong while creating your pop-up. Please try again.', 'hustle' ) ); |
| [120](#L120) |  |
| [121](#L121) | try { |
| [122](#L122) | $module\_type = filter\_input( INPUT\_POST, 'module\_type', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [123](#L123) | $module\_name = filter\_input( INPUT\_POST, 'module\_name', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [124](#L124) |  |
| [125](#L125) | if ( empty( $module\_type ) || empty( $module\_name ) ) { |
| [126](#L126) | $error\_array['message'] = \_\_( 'The module name or module type is missing. Please make sure you added a name for the module.' ); |
| [127](#L127) | throw new Exception(); |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | // Check we're not passing the free limits. |
| [131](#L131) | if ( Hustle\_Data::was\_free\_limit\_reached( $module\_type ) ) { |
| [132](#L132) | $url\_args = array( |
| [133](#L133) | Hustle\_Module\_Admin::UPGRADE\_MODAL\_PARAM => 'true', |
| [134](#L134) | 'page' => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module\_type ), |
| [135](#L135) | ); |
| [136](#L136) |  |
| [137](#L137) | $error\_url   = add\_query\_arg( $url\_args, 'admin.php' ); |
| [138](#L138) | $error\_array = array( 'redirect\_url' => $error\_url ); |
| [139](#L139) | throw new Exception(); |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | // All good so far, let's create the module. |
| [143](#L143) | $module\_data = array( |
| [144](#L144) | 'module\_name' => $module\_name, |
| [145](#L145) | 'module\_type' => $module\_type, |
| [146](#L146) | ); |
| [147](#L147) |  |
| [148](#L148) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE !== $module\_type ) { |
| [149](#L149) | $module\_mode = filter\_input( INPUT\_POST, 'module\_mode', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [150](#L150) | $module\_mode = Hustle\_Module\_Model::OPTIN\_MODE === $module\_mode ? Hustle\_Module\_Model::OPTIN\_MODE : Hustle\_Module\_Model::INFORMATIONAL\_MODE; |
| [151](#L151) |  |
| [152](#L152) | $module\_data['module\_mode'] = $module\_mode; |
| [153](#L153) |  |
| [154](#L154) | $template = filter\_input( INPUT\_POST, 'module\_template', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [155](#L155) |  |
| [156](#L156) | $module\_data['base\_template'] = $template; |
| [157](#L157) |  |
| [158](#L158) | $templates\_helper = new Hustle\_Templates\_Helper(); |
| [159](#L159) | $module\_data     += $templates\_helper->get\_template( $template, $module\_mode ); |
| [160](#L160) |  |
| [161](#L161) | $module\_model = new Hustle\_Module\_Model(); |
| [162](#L162) | } else { |
| [163](#L163) | $module\_model = new Hustle\_SShare\_Model(); |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | $module\_id = $module\_model->create\_new( $module\_data ); |
| [167](#L167) | if ( ! $module\_id ) { |
| [168](#L168) | throw new Exception(); |
| [169](#L169) | } |
| [170](#L170) | } catch ( Exception $e ) { |
| [171](#L171) | wp\_send\_json\_error( $error\_array ); |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | $success\_url\_args = array( |
| [175](#L175) | 'page' => Hustle\_Data::get\_wizard\_page\_by\_module\_type( $module\_type ), |
| [176](#L176) | 'id'   => $module\_id, |
| [177](#L177) | 'new'  => 'true', |
| [178](#L178) | ); |
| [179](#L179) | $success\_url      = add\_query\_arg( $success\_url\_args, 'admin.php' ); |
| [180](#L180) |  |
| [181](#L181) | wp\_send\_json\_success( array( 'redirect\_url' => $success\_url ) ); |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | /\*\* |
| [185](#L185) | \* Loads the requested module via AJAX. |
| [186](#L186) | \* |
| [187](#L187) | \* @since 4.0.0 |
| [188](#L188) | \*/ |
| [189](#L189) | public function preview\_module() { |
| [190](#L190) |  |
| [191](#L191) | // TODO: check nonce. |
| [192](#L192) | Hustle\_Renderer\_Abstract::ajax\_load\_module(); |
| [193](#L193) | wp\_send\_json\_error( \_\_( 'Invalid module type', 'hustle' ) ); |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | /\*\* |
| [197](#L197) | \* Handle getting tracking data from listing |
| [198](#L198) | \*/ |
| [199](#L199) | public function get\_tracking\_data() { |
| [200](#L200) | $id = filter\_input( INPUT\_POST, 'id', FILTER\_SANITIZE\_NUMBER\_INT ); |
| [201](#L201) | Opt\_In\_Utils::validate\_ajax\_call( 'module\_get\_tracking\_data' . $id ); |
| [202](#L202) |  |
| [203](#L203) | $data = Hustle\_Module\_Page\_Abstract::get\_tracking\_charts\_markup( $id ); |
| [204](#L204) |  |
| [205](#L205) | wp\_send\_json\_success( $data ); |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) | /\*\* |
| [209](#L209) | \* Handle all ajax requests related to single module's actions. |
| [210](#L210) | \* -Toggle status ( publish|draft ) |
| [211](#L211) | \* -Duplicate |
| [212](#L212) | \* -Import ( both into a new or an existing module ) |
| [213](#L213) | \* -Delete |
| [214](#L214) | \* -Toggle tracking ( enabled|disabled ) |
| [215](#L215) | \* -Reset tracking |
| [216](#L216) | \* |
| [217](#L217) | \* @since 4.0.3 |
| [218](#L218) | \* @throws Exception Invalid module. |
| [219](#L219) | \*/ |
| [220](#L220) | public function handle\_single\_action() { |
| [221](#L221) |  |
| [222](#L222) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_single\_action' ); |
| [223](#L223) |  |
| [224](#L224) | $module\_id = filter\_input( INPUT\_POST, 'moduleId', FILTER\_VALIDATE\_INT ); |
| [225](#L225) | $module    = Hustle\_Model::get\_module( $module\_id ); |
| [226](#L226) | $action    = filter\_input( INPUT\_POST, 'hustleAction', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [227](#L227) |  |
| [228](#L228) | try { |
| [229](#L229) |  |
| [230](#L230) | // Only move forward with an invalid $module when we're importing a new one. |
| [231](#L231) | if ( is\_wp\_error( $module ) && 'import' !== $action ) { |
| [232](#L232) | throw new Exception( \_\_( 'Invalid module.', 'hustle' ) ); |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | $context = filter\_input( INPUT\_POST, 'context', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [236](#L236) |  |
| [237](#L237) | switch ( $action ) { |
| [238](#L238) | case 'toggle-status': |
| [239](#L239) | $this->action\_toggle\_module\_status( $module ); |
| [240](#L240) | break; |
| [241](#L241) |  |
| [242](#L242) | case 'clone': |
| [243](#L243) | $this->action\_duplicate\_module( $module, $context ); |
| [244](#L244) | break; |
| [245](#L245) |  |
| [246](#L246) | case 'import': |
| [247](#L247) | $this->action\_import\_module( $module ); |
| [248](#L248) | break; |
| [249](#L249) |  |
| [250](#L250) | case 'delete': |
| [251](#L251) | $this->action\_delete\_module( $module, $context ); |
| [252](#L252) | break; |
| [253](#L253) |  |
| [254](#L254) | case 'toggle-tracking': |
| [255](#L255) | $this->action\_toggle\_tracking( $module ); |
| [256](#L256) | break; |
| [257](#L257) |  |
| [258](#L258) | case 'reset-tracking': |
| [259](#L259) | $this->action\_reset\_tracking( $module, $context ); |
| [260](#L260) | break; |
| [261](#L261) |  |
| [262](#L262) | case 'purge-email-list': |
| [263](#L263) | $this->action\_purge\_email\_list( $module, $context ); |
| [264](#L264) | break; |
| [265](#L265) |  |
| [266](#L266) | default: |
| [267](#L267) | throw new Exception( \_\_( 'Invalid action.', 'hustle' ) ); |
| [268](#L268) | } |
| [269](#L269) | } catch ( Exception $e ) { |
| [270](#L270) |  |
| [271](#L271) | $message = 'invalid\_permissions' !== $e->getMessage() ? $e->getMessage() : \_\_( "You don't have enough permission to do this.", 'hustle' ); |
| [272](#L272) |  |
| [273](#L273) | wp\_send\_json\_error( |
| [274](#L274) | array( |
| [275](#L275) | 'notification' => array( |
| [276](#L276) | 'status'  => 'error', |
| [277](#L277) | 'message' => $message, |
| [278](#L278) | ), |
| [279](#L279) | ) |
| [280](#L280) | ); |
| [281](#L281) | } |
| [282](#L282) | } |
| [283](#L283) |  |
| [284](#L284) | /\*\* |
| [285](#L285) | \* Handle the "Publish/Draft" module action. |
| [286](#L286) | \* |
| [287](#L287) | \* @since 4.0.3 |
| [288](#L288) | \* |
| [289](#L289) | \* @param Hustle\_Model $module Hustle\_Module\_Model or Hustle\_SShare\_Model. |
| [290](#L290) | \* @throws Exception When invalid permissions. |
| [291](#L291) | \*/ |
| [292](#L292) | private function action\_toggle\_module\_status( Hustle\_Model $module ) { |
| [293](#L293) |  |
| [294](#L294) | if ( ! Opt\_In\_Utils::is\_user\_allowed( 'hustle\_edit\_module', $module->module\_id ) ) { |
| [295](#L295) | throw new Exception( 'invalid\_permissions' ); |
| [296](#L296) | } |
| [297](#L297) |  |
| [298](#L298) | $was\_published = '1' === $module->active; |
| [299](#L299) |  |
| [300](#L300) | if ( $was\_published ) { |
| [301](#L301) | $module->deactivate(); |
| [302](#L302) | $message = esc\_html\_\_( 'Module unpublished', 'hustle' ); |
| [303](#L303) | } else { |
| [304](#L304) | $module->activate(); |
| [305](#L305) | $message = esc\_html\_\_( 'Module published successfully', 'hustle' ); |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | wp\_send\_json\_success( |
| [309](#L309) | array( |
| [310](#L310) | 'callback'            => 'actionToggleStatus', |
| [311](#L311) | 'is\_active'           => ! $was\_published, |
| [312](#L312) | 'is\_tracking\_enabled' => ! empty( $module->get\_tracking\_types() ), |
| [313](#L313) | 'message'             => $message, |
| [314](#L314) | ) |
| [315](#L315) | ); |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | /\*\* |
| [319](#L319) | \* Handle the "duplicate" module action. |
| [320](#L320) | \* |
| [321](#L321) | \* @since 4.0.3 |
| [322](#L322) | \* |
| [323](#L323) | \* @param Hustle\_Model $module Hustle\_Module\_Model or Hustle\_SShare\_Model. |
| [324](#L324) | \* @param string       $context dashboard|listing|edit\_page. |
| [325](#L325) | \* @throws Exception When invalid permissions. |
| [326](#L326) | \*/ |
| [327](#L327) | private function action\_duplicate\_module( Hustle\_Model $module, $context ) { |
| [328](#L328) |  |
| [329](#L329) | if ( ! current\_user\_can( 'hustle\_create' ) ) { |
| [330](#L330) | throw new Exception( 'invalid\_permissions' ); |
| [331](#L331) | } |
| [332](#L332) |  |
| [333](#L333) | $module->duplicate\_module(); |
| [334](#L334) |  |
| [335](#L335) | if ( 'edit\_page' !== $context ) { |
| [336](#L336) | $url\_params = array( |
| [337](#L337) | 'page'        => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module->module\_type ), |
| [338](#L338) | 'show-notice' => 'success', |
| [339](#L339) | 'notice'      => 'module\_duplicated', |
| [340](#L340) | ); |
| [341](#L341) |  |
| [342](#L342) | $args = array( 'url' => add\_query\_arg( $url\_params, 'admin.php' ) ); |
| [343](#L343) | } else { |
| [344](#L344) | $args = array( |
| [345](#L345) | 'notification' => array( |
| [346](#L346) | 'status'  => 'success', |
| [347](#L347) | 'message' => esc\_html\_\_( 'Module successfully duplicated.', 'hustle' ), |
| [348](#L348) | ), |
| [349](#L349) | ); |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | wp\_send\_json\_success( $args ); |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | /\*\* |
| [356](#L356) | \* Handle the "import" module action. |
| [357](#L357) | \* This is used for importing both into a new and an existing module. |
| [358](#L358) | \* |
| [359](#L359) | \* @since 4.0.0 |
| [360](#L360) | \* @since 4.0.3 $module param added. Callback for handle\_single\_action() instead of the ajax request. |
| [361](#L361) | \* |
| [362](#L362) | \* @param Hustle\_Module\_Model|WP\_Error $module WP\_Error in case the import is creating a new module. Hustle\_Module\_Model otherwise. |
| [363](#L363) | \* @throws Exception This is caught by the parent function. |
| [364](#L364) | \*/ |
| [365](#L365) | private function action\_import\_module( $module ) { |
| [366](#L366) |  |
| [367](#L367) | $is\_new\_module = is\_wp\_error( $module ); |
| [368](#L368) |  |
| [369](#L369) | if ( ! $is\_new\_module && ! current\_user\_can( 'hustle\_create' ) ) { |
| [370](#L370) | throw new Exception( 'invalid\_permissions' ); |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | $module\_type = filter\_input( INPUT\_POST, 'type', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [374](#L374) |  |
| [375](#L375) | if ( ! $module\_type || ! in\_array( $module\_type, Hustle\_Data::get\_module\_types(), true ) ) { |
| [376](#L376) | throw new Exception( \_\_( "The module's type is not valid.", 'hustle' ) ); |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | // Send error if the user can't create new modules but is importing a new one. |
| [380](#L380) | if ( $is\_new\_module && Hustle\_Data::was\_free\_limit\_reached( $module\_type ) ) { |
| [381](#L381) |  |
| [382](#L382) | $url = add\_query\_arg( |
| [383](#L383) | array( |
| [384](#L384) | 'page' => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module\_type ), |
| [385](#L385) | Hustle\_Module\_Admin::UPGRADE\_MODAL\_PARAM => 'true', |
| [386](#L386) | ), |
| [387](#L387) | 'admin.php' |
| [388](#L388) | ); |
| [389](#L389) |  |
| [390](#L390) | wp\_send\_json\_error( array( 'redirect\_url' => $url ) ); |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | try { |
| [394](#L394) | // Get the file containing the module data. |
| [395](#L395) | $file = isset( $\_FILES['import\_file'] ) ? $\_FILES['import\_file'] : false;// phpcs:ignore |
| [396](#L396) |  |
| [397](#L397) | if ( ! $file ) { |
| [398](#L398) | throw new Exception( \_\_( 'The file is required', 'hustle' ) ); |
| [399](#L399) |  |
| [400](#L400) | } elseif ( ! empty( $file['error'] ) ) { |
| [401](#L401) | /\* translators: error message \*/ |
| [402](#L402) | throw new Exception( sprintf( \_\_( 'Error: %s', 'hustle' ), esc\_html( $file['error'] ) ) ); |
| [403](#L403) | } |
| [404](#L404) |  |
| [405](#L405) | // Get the file's content. |
| [406](#L406) | $overrides = array( |
| [407](#L407) | 'test\_form' => false, |
| [408](#L408) | 'test\_type' => false, |
| [409](#L409) | ); |
| [410](#L410) |  |
| [411](#L411) | $wp\_file = wp\_handle\_upload( $file, $overrides ); |
| [412](#L412) | if ( isset( $wp\_file['error'] ) ) { |
| [413](#L413) | throw new Exception( \_\_( 'The file could not be uploaded.check your upload folder permissions.', 'hustle' ) ); |
| [414](#L414) | } |
| [415](#L415) | if ( empty( $wp\_file['file'] ) ) { |
| [416](#L416) | throw new Exception( \_\_( "The file can't be empty", 'hustle' ) ); |
| [417](#L417) | } |
| [418](#L418) |  |
| [419](#L419) | $filename     = $wp\_file['file']; |
| [420](#L420) | $file\_content = file\_get\_contents( $filename ); // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [421](#L421) |  |
| [422](#L422) | // Import file if it's json format. |
| [423](#L423) | $data = array(); |
| [424](#L424) | if ( strpos( $filename, '.json' ) || strpos( $filename, '.JSON' ) ) { |
| [425](#L425) | $data = json\_decode( $file\_content, true ); |
| [426](#L426) |  |
| [427](#L427) | } else { |
| [428](#L428) | throw new Exception( \_\_( 'The file must be a JSON string.', 'hustle' ) ); |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | // Make sure the file to import comes from 4.0 or greater. |
| [432](#L432) | if ( ! isset( $data['plugin'] ) || ! isset( $data['plugin']['version'] ) ) { |
| [433](#L433) | throw new Exception( \_\_( 'The file is either invalid or doesn\'t have any configurations. Please check your file or upload another file.', 'hustle' ) ); |
| [434](#L434) |  |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | // Prevent importing ssharing into other module types, and vice versa. |
| [438](#L438) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE === $module\_type ) { |
| [439](#L439) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE !== $data['data']['module\_type'] ) { |
| [440](#L440) | throw new Exception( \_\_( "You can't import modules of other than \"Social Sharing\" type into Social Sharing modules.", 'hustle' ) ); |
| [441](#L441) | } |
| [442](#L442) | } else { |
| [443](#L443) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE === $data['data']['module\_type'] ) { |
| [444](#L444) | throw new Exception( \_\_( "You can't import Social Sharing modules into other module types.", 'hustle' ) ); |
| [445](#L445) | } |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | $source\_mode = $data['data']['module\_mode']; |
| [449](#L449) | $target\_mode = $is\_new\_module ? filter\_input( INPUT\_POST, 'module\_mode', FILTER\_SANITIZE\_SPECIAL\_CHARS ) : $module->module\_mode; |
| [450](#L450) |  |
| [451](#L451) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE !== $module\_type ) { |
| [452](#L452) |  |
| [453](#L453) | // If the mode is changing, adjust the title and subtitle colors to remain the same in front. |
| [454](#L454) | if ( 'default' === $target\_mode ) { |
| [455](#L455) | $target\_mode = $source\_mode; |
| [456](#L456) |  |
| [457](#L457) | } elseif ( $target\_mode !== $source\_mode ) { |
| [458](#L458) |  |
| [459](#L459) | $is\_optin = Hustle\_Module\_Model::OPTIN\_MODE === $target\_mode; |
| [460](#L460) |  |
| [461](#L461) | if ( $is\_optin ) { |
| [462](#L462) | $data['meta']['design']['title\_color']    = $data['meta']['design']['title\_color\_alt']; |
| [463](#L463) | $data['meta']['design']['subtitle\_color'] = $data['meta']['design']['subtitle\_color\_alt']; |
| [464](#L464) | } else { |
| [465](#L465) | $data['meta']['design']['title\_color\_alt']    = $data['meta']['design']['title\_color']; |
| [466](#L466) | $data['meta']['design']['subtitle\_color\_alt'] = $data['meta']['design']['subtitle\_color']; |
| [467](#L467) | } |
| [468](#L468) | } |
| [469](#L469) | } else { |
| [470](#L470) | if ( version\_compare( $data['plugin']['version'], '4.4.9', '<' ) && |
| [471](#L471) | ! empty( $data['meta']['design']['icon\_style'] ) && |
| [472](#L472) | 'outline' === $data['meta']['design']['icon\_style'] ) { |
| [473](#L473) | if ( isset( $data['meta']['design']['widget\_icon\_bg\_color'] ) ) { |
| [474](#L474) | $data['meta']['design']['widget\_counter\_border'] = $data['meta']['design']['widget\_icon\_bg\_color']; |
| [475](#L475) | } |
| [476](#L476) | if ( isset( $data['meta']['design']['floating\_icon\_bg\_color'] ) ) { |
| [477](#L477) | $data['meta']['design']['floating\_counter\_border'] = $data['meta']['design']['floating\_icon\_bg\_color']; |
| [478](#L478) | } |
| [479](#L479) | } |
| [480](#L480) | } |
| [481](#L481) | $target\_mode = sanitize\_key( $target\_mode ); |
| [482](#L482) |  |
| [483](#L483) | // validate Schedule start/end date and replace it with empty if is invalid. |
| [484](#L484) | // ======================================================================. |
| [485](#L485) | $schedule\_start\_date = $data['meta']['settings']['schedule']['start\_date']; |
| [486](#L486) | $schedule\_end\_date   = $data['meta']['settings']['schedule']['end\_date']; |
| [487](#L487) | // Unset start\_date & Set start immediately if start\_date is invalid. |
| [488](#L488) | if ( date( 'n/j/Y', strtotime( $schedule\_start\_date ) ) !== $schedule\_start\_date ) : // phpcs:ignore WordPress.DateTime.RestrictedFunctions.date\_date |
| [489](#L489) | unset( $data['meta']['settings']['schedule']['start\_date'] ); |
| [490](#L490) | $data['meta']['settings']['schedule']['not\_schedule\_start'] = 1; |
| [491](#L491) | endif; |
| [492](#L492) | // Unset end\_date & Set never end if end\_date is invalid. |
| [493](#L493) | if ( date( 'n/j/Y', strtotime( $schedule\_end\_date ) ) !== $schedule\_end\_date ) : // phpcs:ignore WordPress.DateTime.RestrictedFunctions.date\_date |
| [494](#L494) | unset( $data['meta']['settings']['schedule']['end\_date'] ); |
| [495](#L495) | $data['meta']['settings']['schedule']['not\_schedule\_end'] = 1; |
| [496](#L496) | endif; |
| [497](#L497) | // ==================================================================. |
| [498](#L498) |  |
| [499](#L499) | // Import a new module. |
| [500](#L500) | if ( $is\_new\_module ) { |
| [501](#L501) | $this->import\_new\_module( $module\_type, $target\_mode, $data ); |
| [502](#L502) |  |
| [503](#L503) | } else { |
| [504](#L504) | // Import the settings into an existing module. |
| [505](#L505) | $this->import\_into\_existing\_module( $module, $module\_type, $data ); |
| [506](#L506) | } |
| [507](#L507) | } catch ( Exception $e ) { |
| [508](#L508) | wp\_send\_json\_error( |
| [509](#L509) | array( |
| [510](#L510) | 'callback' => 'actionImportDisplayError', |
| [511](#L511) | 'message'  => esc\_html( $e->getMessage() ), |
| [512](#L512) | ) |
| [513](#L513) | ); |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | } |
| [517](#L517) |  |
| [518](#L518) | /\*\* |
| [519](#L519) | \* Handle the "delete" module action. |
| [520](#L520) | \* |
| [521](#L521) | \* @since 4.0.3 |
| [522](#L522) | \* |
| [523](#L523) | \* @param Hustle\_Module\_Model $module Module. |
| [524](#L524) | \* @param string              $context 'dashboard'|'listing'. |
| [525](#L525) | \* @throws Exception When invalid permissions. |
| [526](#L526) | \*/ |
| [527](#L527) | private function action\_delete\_module( $module, $context ) { |
| [528](#L528) |  |
| [529](#L529) | if ( ! current\_user\_can( 'hustle\_create' ) ) { |
| [530](#L530) | throw new Exception( 'invalid\_permissions' ); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | $module->delete(); |
| [534](#L534) |  |
| [535](#L535) | $page = 'dashboard' !== $context ? Hustle\_Data::get\_listing\_page\_by\_module\_type( $module->module\_type ) : Hustle\_Data::ADMIN\_PAGE; |
| [536](#L536) |  |
| [537](#L537) | $url\_params = array( |
| [538](#L538) | 'page'        => $page, |
| [539](#L539) | 'show-notice' => 'success', |
| [540](#L540) | 'notice'      => 'module\_deleted', |
| [541](#L541) | ); |
| [542](#L542) |  |
| [543](#L543) | wp\_send\_json\_success( array( 'url' => add\_query\_arg( $url\_params, 'admin.php' ) ) ); |
| [544](#L544) | } |
| [545](#L545) |  |
| [546](#L546) | /\*\* |
| [547](#L547) | \* Handle the "toggle tracking" module action. |
| [548](#L548) | \* |
| [549](#L549) | \* @since 4.0.3 |
| [550](#L550) | \* |
| [551](#L551) | \* @param Hustle\_Model $module Hustle\_Module\_Model or Hustle\_SShare\_Model. |
| [552](#L552) | \* @throws Exception When invalid permissions. |
| [553](#L553) | \*/ |
| [554](#L554) | private function action\_toggle\_tracking( Hustle\_Model $module ) { |
| [555](#L555) |  |
| [556](#L556) | if ( ! Opt\_In\_Utils::is\_user\_allowed( 'hustle\_edit\_module', $module->module\_id ) ) { |
| [557](#L557) | throw new Exception( 'invalid\_permissions' ); |
| [558](#L558) | } |
| [559](#L559) |  |
| [560](#L560) | $was\_tracking\_enabled = false; |
| [561](#L561) | $message              = ''; |
| [562](#L562) | $is\_embed\_or\_sshare   = Hustle\_Module\_Model::EMBEDDED\_MODULE === $module->module\_type || Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE === $module->module\_type; |
| [563](#L563) |  |
| [564](#L564) | $response = array( |
| [565](#L565) | 'is\_embed\_or\_sshare' => $is\_embed\_or\_sshare, |
| [566](#L566) | 'is\_active'          => '1' === $module->active, |
| [567](#L567) | 'callback'           => 'actionToggleTracking', |
| [568](#L568) | ); |
| [569](#L569) |  |
| [570](#L570) | if ( ! $is\_embed\_or\_sshare ) { |
| [571](#L571) | // Popups and slideins. |
| [572](#L572) |  |
| [573](#L573) | $was\_tracking\_enabled = $module->is\_track\_type\_active( $module->module\_type ); |
| [574](#L574) |  |
| [575](#L575) | if ( $was\_tracking\_enabled ) { |
| [576](#L576) | $module->disable\_type\_track\_mode( $module->module\_type ); |
| [577](#L577) |  |
| [578](#L578) | } else { |
| [579](#L579) | $module->enable\_type\_track\_mode( $module->module\_type ); |
| [580](#L580) | } |
| [581](#L581) |  |
| [582](#L582) | $message = $was\_tracking\_enabled ? |
| [583](#L583) | sprintf( /\* translators: module name \*/ esc\_html\_\_( 'Tracking is disabled on %s', 'hustle' ), '<strong>' . esc\_html( $module->module\_name ) . '</strong>' ) : |
| [584](#L584) | sprintf( /\* translators: module name \*/ esc\_html\_\_( 'Tracking is enabled on %s', 'hustle' ), '<strong>' . esc\_html( $module->module\_name ) . '</strong>' ); |
| [585](#L585) |  |
| [586](#L586) | $response['was\_enabled'] = $was\_tracking\_enabled; |
| [587](#L587) |  |
| [588](#L588) | } else { |
| [589](#L589) | // Embeds and social sharing. |
| [590](#L590) | $enabled\_track\_types = filter\_input( INPUT\_POST, 'tracking\_sub\_types', FILTER\_SANITIZE\_SPECIAL\_CHARS, FILTER\_REQUIRE\_ARRAY ); |
| [591](#L591) | if ( is\_null( $enabled\_track\_types ) ) { |
| [592](#L592) | $enabled\_track\_types = array(); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | $module->update\_submitted\_tracking\_types( $enabled\_track\_types ); |
| [596](#L596) |  |
| [597](#L597) | /\* translators: module name \*/ |
| [598](#L598) | $message = sprintf( esc\_html\_\_( 'Tracking updated on %s', 'hustle' ), '<strong>' . esc\_html( $module->module\_name ) . '</strong>' ); |
| [599](#L599) |  |
| [600](#L600) | $response['enabled\_types'] = implode( ',', $enabled\_track\_types ); |
| [601](#L601) | } |
| [602](#L602) |  |
| [603](#L603) | $response['message'] = $message; |
| [604](#L604) |  |
| [605](#L605) | wp\_send\_json\_success( $response ); |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | /\*\* |
| [609](#L609) | \* Handle the "Reset tracking" module action. |
| [610](#L610) | \* |
| [611](#L611) | \* @since 4.0.3 |
| [612](#L612) | \* |
| [613](#L613) | \* @param Hustle\_Model $module Hustle\_Module\_Model or Hustle\_SShare\_Model. |
| [614](#L614) | \* @param string       $context dashboard|listing|edit\_page. |
| [615](#L615) | \* @throws Exception When invalid permissions. |
| [616](#L616) | \*/ |
| [617](#L617) | private function action\_reset\_tracking( Hustle\_Model $module, $context ) { |
| [618](#L618) |  |
| [619](#L619) | if ( ! Opt\_In\_Utils::is\_user\_allowed( 'hustle\_edit\_module', $module->module\_id ) ) { |
| [620](#L620) | throw new Exception( 'invalid\_permissions' ); |
| [621](#L621) | } |
| [622](#L622) |  |
| [623](#L623) | $tracking = Hustle\_Tracking\_Model::get\_instance(); |
| [624](#L624) | $tracking->delete\_data( $module->module\_id ); |
| [625](#L625) |  |
| [626](#L626) | if ( 'edit\_page' !== $context ) { |
| [627](#L627) | $url\_params = array( |
| [628](#L628) | 'page'        => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module->module\_type ), |
| [629](#L629) | 'show-notice' => 'success', |
| [630](#L630) | 'notice'      => 'module\_tracking\_reset', |
| [631](#L631) | ); |
| [632](#L632) |  |
| [633](#L633) | $args = array( 'url' => add\_query\_arg( $url\_params, 'admin.php' ) ); |
| [634](#L634) | } else { |
| [635](#L635) | $args = array( |
| [636](#L636) | 'notification' => array( |
| [637](#L637) | 'status'  => 'success', |
| [638](#L638) | 'message' => esc\_html\_\_( "Module's tracking data successfully reset.", 'hustle' ), |
| [639](#L639) | ), |
| [640](#L640) | ); |
| [641](#L641) | } |
| [642](#L642) |  |
| [643](#L643) | wp\_send\_json\_success( $args ); |
| [644](#L644) | } |
| [645](#L645) |  |
| [646](#L646) | /\*\* |
| [647](#L647) | \* Handle the "Purge Email List" module action. |
| [648](#L648) | \* |
| [649](#L649) | \* @param Hustle\_Model $module Hustle\_Module\_Model or Hustle\_SShare\_Model. |
| [650](#L650) | \* @param string       $context dashboard|listing|edit\_page. |
| [651](#L651) | \* @throws Exception When invalid permissions. |
| [652](#L652) | \*/ |
| [653](#L653) | private function action\_purge\_email\_list( Hustle\_Model $module, $context ) { |
| [654](#L654) |  |
| [655](#L655) | if ( ! Opt\_In\_Utils::is\_user\_allowed( 'hustle\_access\_emails' ) ) { |
| [656](#L656) | throw new Exception( 'invalid\_permissions' ); |
| [657](#L657) | } |
| [658](#L658) |  |
| [659](#L659) | Hustle\_Entry\_Model::delete\_entries( $module->module\_id ); |
| [660](#L660) |  |
| [661](#L661) | if ( 'edit\_page' !== $context ) { |
| [662](#L662) | $url\_params = array( |
| [663](#L663) | 'page'        => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module->module\_type ), |
| [664](#L664) | 'show-notice' => 'success', |
| [665](#L665) | 'notice'      => 'module\_purge\_emails', |
| [666](#L666) | ); |
| [667](#L667) |  |
| [668](#L668) | $args = array( 'url' => add\_query\_arg( $url\_params, 'admin.php' ) ); |
| [669](#L669) | } else { |
| [670](#L670) | $args = array( |
| [671](#L671) | 'notification' => array( |
| [672](#L672) | 'status'  => 'success', |
| [673](#L673) | 'message' => esc\_html\_\_( "Module's Email List successfully purged.", 'hustle' ), |
| [674](#L674) | ), |
| [675](#L675) | ); |
| [676](#L676) | } |
| [677](#L677) |  |
| [678](#L678) | wp\_send\_json\_success( $args ); |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) |  |
| [682](#L682) | /\*\* |
| [683](#L683) | \* Parse the imported data before saving. |
| [684](#L684) | \* |
| [685](#L685) | \* @since 4.0.3 |
| [686](#L686) | \* |
| [687](#L687) | \* @param array  $data Incoming module's data. |
| [688](#L688) | \* @param string $module\_mode Target module's mode. |
| [689](#L689) | \* @return array |
| [690](#L690) | \* |
| [691](#L691) | \* @throws Exception Settings to import isn't selected. |
| [692](#L692) | \*/ |
| [693](#L693) | private function apply\_import\_filters( $data, $module\_mode ) { |
| [694](#L694) |  |
| [695](#L695) | // Ssharing modules don't have mode. |
| [696](#L696) | if ( ! empty( $module\_mode ) ) { |
| [697](#L697) | $module\_mode = Hustle\_Module\_Model::INFORMATIONAL\_MODE === $module\_mode ? 'info' : Hustle\_Module\_Model::OPTIN\_MODE; |
| [698](#L698) |  |
| [699](#L699) | } else { |
| [700](#L700) | $module\_mode = 'ssharing'; |
| [701](#L701) | } |
| [702](#L702) |  |
| [703](#L703) | $metas = filter\_input( INPUT\_POST, $module\_mode . '\_metas', FILTER\_SANITIZE\_SPECIAL\_CHARS, FILTER\_REQUIRE\_ARRAY ); |
| [704](#L704) |  |
| [705](#L705) | if ( empty( $metas ) ) { |
| [706](#L706) | throw new Exception( \_\_( 'Please select the settings to import.', 'hustle' ) ); |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | // No filter was applied. Import everything. |
| [710](#L710) | if ( in\_array( 'all', $metas, true ) ) { |
| [711](#L711) | return $data; |
| [712](#L712) | } |
| [713](#L713) |  |
| [714](#L714) | // Remove the metas that the user chose not to import. |
| [715](#L715) | foreach ( $data['meta'] as $name => $value ) { |
| [716](#L716) | if ( ! in\_array( $name, $metas, true ) ) { |
| [717](#L717) | unset( $data['meta'][ $name ] ); |
| [718](#L718) | } |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | return $data; |
| [722](#L722) | } |
| [723](#L723) |  |
| [724](#L724) | /\*\* |
| [725](#L725) | \* Import the settings into an existing module. |
| [726](#L726) | \* |
| [727](#L727) | \* @since 4.0.0 |
| [728](#L728) | \* |
| [729](#L729) | \* @param Hustle\_Module\_Model $module Module. |
| [730](#L730) | \* @param string              $module\_type Module type. |
| [731](#L731) | \* @param array               $data Data. |
| [732](#L732) | \* |
| [733](#L733) | \* @throws Exception Access denied. |
| [734](#L734) | \*/ |
| [735](#L735) | private function import\_into\_existing\_module( $module, $module\_type, $data ) { |
| [736](#L736) |  |
| [737](#L737) | // Check if the current user can do this. |
| [738](#L738) | $is\_allowed = Opt\_In\_Utils::is\_user\_allowed( 'hustle\_edit\_module', $module->id ); |
| [739](#L739) | if ( ! $is\_allowed ) { |
| [740](#L740) | throw new Exception( sprintf( \_\_( 'Access denied. You do not have permission to perform this action.', 'hustle' ) ) ); |
| [741](#L741) | } |
| [742](#L742) |  |
| [743](#L743) | $data = $this->apply\_import\_filters( $data, $module->module\_mode ); |
| [744](#L744) |  |
| [745](#L745) | // Import the module's metas. |
| [746](#L746) | $current\_data = $module->get\_module\_metas\_as\_array(); |
| [747](#L747) | foreach ( $current\_data as $meta\_key => $current\_value ) { |
| [748](#L748) |  |
| [749](#L749) | if ( isset( $data['meta'][ $meta\_key ] ) ) { |
| [750](#L750) |  |
| [751](#L751) | if ( 'visibility' === $meta\_key ) { |
| [752](#L752) | $incoming\_value = $data['meta'][ $meta\_key ]; |
| [753](#L753) | } else { |
| [754](#L754) | // Filter the incoming array to get rid of what doesn't belong to this module type. |
| [755](#L755) | $incoming\_value = array\_intersect\_key( $data['meta'][ $meta\_key ], $current\_value ); |
| [756](#L756) | } |
| [757](#L757) |  |
| [758](#L758) | $meta\_to\_update = array\_merge( $current\_value, $incoming\_value ); |
| [759](#L759) | $module->update\_meta( $meta\_key, $meta\_to\_update ); |
| [760](#L760) | } |
| [761](#L761) | } |
| [762](#L762) |  |
| [763](#L763) | $module->save(); |
| [764](#L764) | $module->clean\_module\_cache(); |
| [765](#L765) |  |
| [766](#L766) | $url = add\_query\_arg( |
| [767](#L767) | array( |
| [768](#L768) | 'page'        => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module\_type ), |
| [769](#L769) | 'show-notice' => 'success', |
| [770](#L770) | 'notice'      => 'module\_imported', |
| [771](#L771) | ), |
| [772](#L772) | 'admin.php' |
| [773](#L773) | ); |
| [774](#L774) |  |
| [775](#L775) | wp\_send\_json\_success( array( 'url' => $url ) ); |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | /\*\* |
| [779](#L779) | \* Import the settings into a new module. |
| [780](#L780) | \* |
| [781](#L781) | \* @since 4.0 |
| [782](#L782) | \* |
| [783](#L783) | \* @param string $module\_type Module type. |
| [784](#L784) | \* @param string $target\_mode Target mode. |
| [785](#L785) | \* @param array  $data Data. |
| [786](#L786) | \* |
| [787](#L787) | \* @throws Exception Creation process was failed. |
| [788](#L788) | \*/ |
| [789](#L789) | private function import\_new\_module( $module\_type, $target\_mode, $data ) { |
| [790](#L790) | Opt\_In\_Utils::is\_user\_allowed\_ajax( 'hustle\_create' ); |
| [791](#L791) |  |
| [792](#L792) | if ( 'default' !== $target\_mode ) { |
| [793](#L793) | $data = $this->apply\_import\_filters( $data, $target\_mode ); |
| [794](#L794) | } |
| [795](#L795) |  |
| [796](#L796) | $data['data']['module\_type'] = $module\_type; |
| [797](#L797) |  |
| [798](#L798) | // Set the module mode according to the selected settings. |
| [799](#L799) | $data['data']['module\_mode'] = Hustle\_Module\_Model::INFORMATIONAL\_MODE === $target\_mode ? $target\_mode : Hustle\_Module\_Model::OPTIN\_MODE; |
| [800](#L800) |  |
| [801](#L801) | $module\_data = array\_merge( $data['data'], $data['meta'] ); |
| [802](#L802) |  |
| [803](#L803) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE !== $module\_type ) { |
| [804](#L804) | $module\_model = new Hustle\_Module\_Model(); |
| [805](#L805) | } else { |
| [806](#L806) | $module\_model = new Hustle\_SShare\_Model(); |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | $module\_id = $module\_model->create\_new( $module\_data ); |
| [810](#L810) |  |
| [811](#L811) | if ( ! empty( $module\_id ) ) { |
| [812](#L812) | $module = new Hustle\_Module\_Model( $module\_id ); |
| [813](#L813) | $module->clean\_module\_cache(); |
| [814](#L814) |  |
| [815](#L815) | $url = add\_query\_arg( |
| [816](#L816) | array( |
| [817](#L817) | 'page'        => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module\_type ), |
| [818](#L818) | 'show-notice' => 'success', |
| [819](#L819) | 'notice'      => 'module\_imported', |
| [820](#L820) | ), |
| [821](#L821) | 'admin.php' |
| [822](#L822) | ); |
| [823](#L823) |  |
| [824](#L824) | wp\_send\_json\_success( array( 'url' => $url ) ); |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | throw new Exception( \_\_( 'Creating a new module went wrong', 'hustle' ) ); |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | /\*\* |
| [831](#L831) | \* Handle bulk action from listings |
| [832](#L832) | \*/ |
| [833](#L833) | public function handle\_bulk\_action() { |
| [834](#L834) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle-bulk-action' ); |
| [835](#L835) | $type   = filter\_input( INPUT\_POST, 'type', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [836](#L836) | $hustle = filter\_input( INPUT\_POST, 'hustle', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [837](#L837) | $ids    = filter\_input( INPUT\_POST, 'ids', FILTER\_SANITIZE\_SPECIAL\_CHARS, FILTER\_REQUIRE\_ARRAY ); |
| [838](#L838) | if ( ! is\_array( $ids ) || empty( $ids ) ) { |
| [839](#L839) | wp\_send\_json\_error( \_\_( 'Failed', 'hustle' ) ); |
| [840](#L840) | } |
| [841](#L841) |  |
| [842](#L842) | foreach ( $ids as $id ) { |
| [843](#L843) | $id     = intval( $id ); |
| [844](#L844) | $module = Hustle\_Module\_Collection::instance()->return\_model\_from\_id( $id ); |
| [845](#L845) | if ( is\_wp\_error( $module ) ) { |
| [846](#L846) | continue; |
| [847](#L847) | } |
| [848](#L848) | if ( $module->module\_type !== $type && in\_array( $type, array( 'popup', 'embedded', 'slidein' ), true ) ) { |
| [849](#L849) | continue; |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | $can\_edit   = Opt\_In\_Utils::is\_user\_allowed( 'hustle\_edit\_module', $id ); |
| [853](#L853) | $can\_emails = Opt\_In\_Utils::is\_user\_allowed( 'hustle\_access\_emails' ); |
| [854](#L854) | $can\_create = current\_user\_can( 'hustle\_create' ); |
| [855](#L855) |  |
| [856](#L856) | switch ( $hustle ) { |
| [857](#L857) | case 'publish': |
| [858](#L858) | if ( $can\_edit ) { |
| [859](#L859) | $module->activate(); |
| [860](#L860) | } |
| [861](#L861) | break; |
| [862](#L862) |  |
| [863](#L863) | case 'unpublish': |
| [864](#L864) | if ( $can\_edit ) { |
| [865](#L865) | $module->deactivate(); |
| [866](#L866) | } |
| [867](#L867) | break; |
| [868](#L868) |  |
| [869](#L869) | case 'clone': |
| [870](#L870) | if ( $can\_create && ! Hustle\_Data::was\_free\_limit\_reached( $module->module\_type ) ) { |
| [871](#L871) | $module->duplicate\_module(); |
| [872](#L872) | } |
| [873](#L873) | break; |
| [874](#L874) |  |
| [875](#L875) | case 'delete': |
| [876](#L876) | if ( $can\_create ) { |
| [877](#L877) | $module->delete(); |
| [878](#L878) | } |
| [879](#L879) | break; |
| [880](#L880) |  |
| [881](#L881) | case 'disable-tracking': |
| [882](#L882) | if ( $can\_edit ) { |
| [883](#L883) | $module->disable\_type\_track\_mode( $type, true ); |
| [884](#L884) | } |
| [885](#L885) | break; |
| [886](#L886) |  |
| [887](#L887) | case 'enable-tracking': |
| [888](#L888) | if ( $can\_edit ) { |
| [889](#L889) | $module->enable\_type\_track\_mode( $type, true ); |
| [890](#L890) | } |
| [891](#L891) | break; |
| [892](#L892) |  |
| [893](#L893) | case 'reset-tracking': |
| [894](#L894) | if ( $can\_edit ) { |
| [895](#L895) | $tracking = Hustle\_Tracking\_Model::get\_instance(); |
| [896](#L896) | $tracking->delete\_data( $id ); |
| [897](#L897) | } |
| [898](#L898) | break; |
| [899](#L899) |  |
| [900](#L900) | case 'purge-email-list': |
| [901](#L901) | if ( $can\_emails ) { |
| [902](#L902) | Hustle\_Entry\_Model::delete\_entries( $id ); |
| [903](#L903) | } |
| [904](#L904) | break; |
| [905](#L905) |  |
| [906](#L906) | default: |
| [907](#L907) | wp\_send\_json\_error( \_\_( 'Failed', 'hustle' ) ); |
| [908](#L908) | } |
| [909](#L909) | } |
| [910](#L910) | wp\_send\_json\_success(); |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | /\*\* |
| [914](#L914) | \* Render module |
| [915](#L915) | \*/ |
| [916](#L916) | public function render\_module() { |
| [917](#L917) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_gutenberg\_get\_module' ); |
| [918](#L918) |  |
| [919](#L919) | $shortcode\_id = filter\_input( INPUT\_GET, 'shortcode\_id', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [920](#L920) |  |
| [921](#L921) | if ( ! $shortcode\_id ) { |
| [922](#L922) | wp\_send\_json\_error(); |
| [923](#L923) | } |
| [924](#L924) |  |
| [925](#L925) | $module\_id = Hustle\_Model::get\_module\_id\_by\_shortcode\_id( $shortcode\_id ); |
| [926](#L926) | $module    = Hustle\_Model::get\_module( $module\_id ); |
| [927](#L927) |  |
| [928](#L928) | if ( is\_wp\_error( $module ) ) { |
| [929](#L929) | wp\_send\_json\_error(); |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | if ( Hustle\_Module\_Model::EMBEDDED\_MODULE === $module->module\_type || Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE === $module->module\_type ) { |
| [933](#L933) | $sub\_type = Hustle\_Module\_Model::SHORTCODE\_MODULE; |
| [934](#L934) | } else { |
| [935](#L935) | $sub\_type = ''; |
| [936](#L936) | } |
| [937](#L937) |  |
| [938](#L938) | $html  = $module->display( $sub\_type, '', true ); |
| [939](#L939) | $style = '<style type="text/css" class="hustle-module-styles-' . esc\_attr( $module->id ) . '">' . $module->get\_decorated()->get\_module\_styles( $module->module\_type ) . '</style>'; |
| [940](#L940) |  |
| [941](#L941) | $response = array( |
| [942](#L942) | 'data'  => array( |
| [943](#L943) | 'module\_id'    => $module->module\_id, |
| [944](#L944) | 'shortcode\_id' => $shortcode\_id, |
| [945](#L945) | ), |
| [946](#L946) | 'html'  => $html, |
| [947](#L947) | 'style' => $style, |
| [948](#L948) | ); |
| [949](#L949) |  |
| [950](#L950) | wp\_send\_json\_success( $response ); |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) | /\*\* |
| [954](#L954) | \* Get the module\_id by the shortcode\_id provided. |
| [955](#L955) | \* Used by Gutenberg to create blocks. |
| [956](#L956) | \* |
| [957](#L957) | \* @since 3.0.7 |
| [958](#L958) | \* |
| [959](#L959) | \* @return void |
| [960](#L960) | \*/ |
| [961](#L961) | public function get\_module\_id\_by\_shortcode() { |
| [962](#L962) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_gutenberg\_get\_module' ); |
| [963](#L963) |  |
| [964](#L964) | $shortcode\_id = filter\_input( INPUT\_GET, 'shortcode\_id', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [965](#L965) |  |
| [966](#L966) | $module\_id = Hustle\_Model::get\_module\_id\_by\_shortcode\_id( $shortcode\_id ); |
| [967](#L967) | $module    = Hustle\_Model::get\_module( $module\_id ); |
| [968](#L968) | if ( is\_wp\_error( $module ) ) { |
| [969](#L969) | wp\_send\_json\_error(); |
| [970](#L970) | } |
| [971](#L971) | wp\_send\_json\_success( array( 'module\_id' => $module->id ) ); |
| [972](#L972) | } |
| [973](#L973) |  |
| [974](#L974) |  |
| [975](#L975) | /\*\* |
| [976](#L976) | \* Get posts/pages/tags/categories for visibility options via ajax. |
| [977](#L977) | \* Finds and repares select2 options. |
| [978](#L978) | \* |
| [979](#L979) | \* @global type $wpdb |
| [980](#L980) | \* @since 3.0.7 |
| [981](#L981) | \*/ |
| [982](#L982) | public function get\_new\_condition\_ids() { |
| [983](#L983) | global $wpdb; |
| [984](#L984) |  |
| [985](#L985) | $post\_type = filter\_input( INPUT\_POST, 'postType', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [986](#L986) | $search    = filter\_input( INPUT\_POST, 'search' ); |
| [987](#L987) | $result    = array(); |
| [988](#L988) | $limit     = 30; |
| [989](#L989) |  |
| [990](#L990) | if ( ! empty( $post\_type ) ) { |
| [991](#L991) | if ( in\_array( $post\_type, array( 'tag', 'category', 'wc\_category', 'wc\_tag' ), true ) ) { |
| [992](#L992) | $args = array( |
| [993](#L993) | 'hide\_empty' => false, |
| [994](#L994) | 'number'     => $limit, |
| [995](#L995) | ); |
| [996](#L996) | if ( $search ) { |
| [997](#L997) | $args['search'] = $search; |
| [998](#L998) | } |
| [999](#L999) | if ( 'tag' === $post\_type ) { |
| [1000](#L1000) | $args['taxonomy'] = 'post\_tag'; |
| [1001](#L1001) | } elseif ( 'wc\_category' === $post\_type ) { |
| [1002](#L1002) | $args['taxonomy'] = 'product\_cat'; |
| [1003](#L1003) | } elseif ( 'wc\_tag' === $post\_type ) { |
| [1004](#L1004) | $args['taxonomy'] = 'product\_tag'; |
| [1005](#L1005) | } |
| [1006](#L1006) | $result = array\_map( array( 'Hustle\_Module\_Page\_Abstract', 'terms\_to\_select2\_data' ), get\_categories( $args ) ); |
| [1007](#L1007) | } else { |
| [1008](#L1008) | global $wpdb; |
| [1009](#L1009) | $result = $wpdb->get\_results( // phpcs:ignore |
| [1010](#L1010) | $wpdb->prepare( |
| [1011](#L1011) | "SELECT ID as id, post\_title as text FROM {$wpdb->posts} " |
| [1012](#L1012) | . "WHERE post\_type = %s AND post\_status = 'publish' AND post\_title LIKE %s LIMIT " . intval( $limit ), |
| [1013](#L1013) | $post\_type, |
| [1014](#L1014) | '%' . $search . '%' |
| [1015](#L1015) | ) |
| [1016](#L1016) | ); |
| [1017](#L1017) | } |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | wp\_send\_json\_success( $result ); |
| [1021](#L1021) | } |
| [1022](#L1022) |  |
| [1023](#L1023) | } |
| [1024](#L1024) |  |
| [1025](#L1025) | endif; |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wordpress-popup/tags/7.8.5/inc/hustle-modules-common-admin-ajax.php?format=txt)
* [Original Format](/export/3222506/wordpress-popup/tags/7.8.5/inc/hustle-modules-common-admin-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_712fa4c7_20250114_225827.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Hustle – Email Marketing, Lead Generation, Optins, Popups <= 7.8.5 - Missing Authorization to Unpublished Form Exposure

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Hustle – Email Marketing, Lead Generation, Optins, Popups <= 7.8.5 - Missing Authorization to Unpublished Form Exposure

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

| CVE | [CVE-2024-10579](https://www.cve.org/CVERecord?id=CVE-2024-10579) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | November 25, 2024 |
| Last Updated | November 26, 2024 |
| Researcher | [Vijaysimha Reddy (vijaysimha)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/vijaysimha-reddy) |

### Description

The Hustle – Email Marketing, Lead Generation, Optins, Popups plugin for WordPress is vulnerable to unauthorized access of data due to a missing capability check on the preview\_module() function in all versions up to, and including, 7.8.5. This makes it possible for authenticated attackers, with Subscriber-level access and above, to view unpublished forms.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wordpress-popup/tags/7.8.5/inc/hustle-modules-common-admin-ajax.php#L189)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php#L189)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwordpress-popup%2Fhustle-email-marketing-lead-generation-optins-popups-785-missing-authorization-to-unpublished-form-exposure&t=Hustle%20%E2%80%93%20Email%20Marketing%2C%20Lead%20Generation%2C%20Optins%2C%20Popups%20%3C%3D%207.8.5%20-%20Missing%20Authorization%20to%20Unpublished%20Form%20Exposure "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwordpress-popup%2Fhustle-email-marketing-lead-generation-optins-popups-785-missing-authorization-to-unpublished-form-exposure&text=Hustle%20%E2%80%93%20Email%20Marketing%2C%20Lead%20Generation%2C%20Optins%2C%20Popups%20%3C%3D%207.8.5%20-%20Missing%20Authorization%20to%20Unpublished%20Form%20Exposure "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwordpress-popup%2Fhustle-email-marketing-lead-generation-optins-popups-785-missing-authorization-to-unpublished-form-exposure "LinkedIn")
Email

## Vulnerability Details for Hustle – Email Marketing, Lead Generation, Optins, Popups

#### [Hustle – Email Marketing, Lead Generation, Optins, Popups](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wordpress-popup)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wordpress-popup [(view on wordpress.org)](https://wordpress.org/plugins/wordpress-popup) |
| Patched? | Yes |
| Remediation | Update to version 7.8.6, or a newer patched version |
| Affected Version | * <= 7.8.5 |
| Patched Version | * 7.8.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_56571a05_20250114_225825.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwordpress-popup%2Ftrunk%2Finc%2Fhustle-modules-common-admin-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php?rev=2933986 "Revision 2933986")
* Next Revision →
* [Blame](/browser/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [wordpress-popup](/browser/wordpress-popup?order=name "View wordpress-popup")/[trunk](/browser/wordpress-popup/trunk?order=name "View trunk")/[inc](/browser/wordpress-popup/trunk/inc?order=name "View inc")/[hustle-modules-common-admin-ajax.php](/browser/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php?order=name "View hustle-modules-common-admin-ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3196639/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php "View differences") on this file was [3196639](/changeset/3196639/ "View changeset 3196639"), checked in by panoslyrakis, [7 weeks ago](/timeline?from=2024-11-25T15%3A26%3A43Z&precision=second "See timeline at 11/25/2024 03:26:43 PM") |
| --- |
| Update Version 7.8.6 |
| **File size:** 32.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Hustle\_Modules\_Common\_Admin\_Ajax |
| [4](#L4) | \* |
| [5](#L5) | \* @package Hustle |
| [6](#L6) | \*/ |
| [7](#L7) |  |
| [8](#L8) | if ( ! class\_exists( 'Hustle\_Modules\_Common\_Admin\_Ajax' ) ) : |
| [9](#L9) | /\*\* |
| [10](#L10) | \* Class Hustle\_Modules\_Common\_Admin\_Ajax. |
| [11](#L11) | \* Intended for Pop-up, Slide-in, Embeds, and Social sharing modules common ajax actions on admin side. |
| [12](#L12) | \* |
| [13](#L13) | \* @since 4.0 |
| [14](#L14) | \*/ |
| [15](#L15) | class Hustle\_Modules\_Common\_Admin\_Ajax { |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Constructor |
| [19](#L19) | \*/ |
| [20](#L20) | public function \_\_construct() { |
| [21](#L21) | add\_action( 'wp\_ajax\_hustle\_save\_module', array( $this, 'save\_module' ) ); |
| [22](#L22) |  |
| [23](#L23) | add\_action( 'wp\_ajax\_hustle\_fetch\_font\_families', array( $this, 'fetch\_font\_families' ) ); |
| [24](#L24) |  |
| [25](#L25) | add\_action( 'wp\_ajax\_hustle\_create\_new\_module', array( $this, 'create\_new\_module' ) ); |
| [26](#L26) | add\_action( 'wp\_ajax\_hustle\_preview\_module', array( $this, 'preview\_module' ) ); |
| [27](#L27) | add\_action( 'wp\_ajax\_hustle\_tracking\_data', array( $this, 'get\_tracking\_data' ) ); |
| [28](#L28) |  |
| [29](#L29) | // Handle bulk actions. |
| [30](#L30) | add\_action( 'wp\_ajax\_hustle\_listing\_bulk', array( $this, 'handle\_bulk\_action' ) ); |
| [31](#L31) |  |
| [32](#L32) | // Handle the actions for a single module. |
| [33](#L33) | add\_action( 'wp\_ajax\_hustle\_module\_handle\_single\_action', array( $this, 'handle\_single\_action' ) ); |
| [34](#L34) |  |
| [35](#L35) | // Used for Gutenberg. |
| [36](#L36) | add\_action( 'wp\_ajax\_hustle\_render\_module', array( $this, 'render\_module' ) ); |
| [37](#L37) | add\_action( 'wp\_ajax\_hustle\_get\_module\_id\_by\_shortcode', array( $this, 'get\_module\_id\_by\_shortcode' ) ); |
| [38](#L38) |  |
| [39](#L39) | // Ajax search for posts/pages/categories/tags visibility conditions. |
| [40](#L40) | add\_action( 'wp\_ajax\_get\_new\_condition\_ids', array( $this, 'get\_new\_condition\_ids' ) ); |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* Saves new optin to db |
| [45](#L45) | \* |
| [46](#L46) | \* @since 1.0 |
| [47](#L47) | \* @throws Exception Something went wrong. |
| [48](#L48) | \*/ |
| [49](#L49) | public function save\_module() { |
| [50](#L50) |  |
| [51](#L51) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_save\_module\_wizard' ); |
| [52](#L52) |  |
| [53](#L53) | $module\_id = filter\_input( INPUT\_POST, 'id', FILTER\_VALIDATE\_INT ); |
| [54](#L54) | Opt\_In\_Utils::is\_user\_allowed\_ajax( 'hustle\_edit\_module', $module\_id ); |
| [55](#L55) |  |
| [56](#L56) | $\_post = stripslashes\_deep( $\_POST ); // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [57](#L57) |  |
| [58](#L58) | $error\_array = array(); |
| [59](#L59) |  |
| [60](#L60) | try { |
| [61](#L61) | if ( empty( $module\_id ) ) { |
| [62](#L62) | throw new Exception(); |
| [63](#L63) | } |
| [64](#L64) |  |
| [65](#L65) | $module = Hustle\_Module\_Collection::instance()->return\_model\_from\_id( $module\_id ); |
| [66](#L66) | if ( is\_wp\_error( $module ) ) { |
| [67](#L67) | throw new Exception(); |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) | $\_post      = $module->sanitize\_module( $\_post ); |
| [71](#L71) | $validation = $module->validate\_module( $\_post ); |
| [72](#L72) | if ( true !== $validation ) { |
| [73](#L73) | $error\_array = array( 'data' => $validation['error'] ); |
| [74](#L74) | throw new Exception(); |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | $updated = $module->update\_module( $\_post ); |
| [78](#L78) |  |
| [79](#L79) | if ( isset( $updated['success'] ) && false === $updated['success'] ) { |
| [80](#L80) | $error\_array = array( 'data' => $updated['error'] ); |
| [81](#L81) | throw new Exception(); |
| [82](#L82) | } |
| [83](#L83) |  |
| [84](#L84) | if ( false === $updated ) { |
| [85](#L85) | $error\_array = array( 'data' => $updated ); |
| [86](#L86) | throw new Exception(); |
| [87](#L87) | } |
| [88](#L88) | } catch ( Exception $e ) { |
| [89](#L89) | wp\_send\_json\_error( $error\_array ); |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | wp\_send\_json\_success(); |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | /\*\* |
| [96](#L96) | \* Gets custom font families for the Appearance settings in wizard. |
| [97](#L97) | \* |
| [98](#L98) | \* @since 4.3.0 |
| [99](#L99) | \* @return void |
| [100](#L100) | \*/ |
| [101](#L101) | public function fetch\_font\_families() { |
| [102](#L102) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_fetch\_font\_families' ); |
| [103](#L103) |  |
| [104](#L104) | $families = Hustle\_Meta\_Base\_Design::get\_font\_families\_names(); |
| [105](#L105) |  |
| [106](#L106) | wp\_send\_json\_success( $families ); |
| [107](#L107) | } |
| [108](#L108) |  |
| [109](#L109) | /\*\* |
| [110](#L110) | \* Create a new module of any type |
| [111](#L111) | \* |
| [112](#L112) | \* @since 4.0.0 |
| [113](#L113) | \* @throws Exception When the module could not be created. |
| [114](#L114) | \*/ |
| [115](#L115) | public function create\_new\_module() { |
| [116](#L116) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_create\_new\_module' ); |
| [117](#L117) | Opt\_In\_Utils::is\_user\_allowed\_ajax( 'hustle\_create' ); |
| [118](#L118) |  |
| [119](#L119) | $error\_array = array( 'message' => \_\_( 'Something went wrong while creating your pop-up. Please try again.', 'hustle' ) ); |
| [120](#L120) |  |
| [121](#L121) | try { |
| [122](#L122) | $module\_type = filter\_input( INPUT\_POST, 'module\_type', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [123](#L123) | $module\_name = filter\_input( INPUT\_POST, 'module\_name', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [124](#L124) |  |
| [125](#L125) | if ( empty( $module\_type ) || empty( $module\_name ) ) { |
| [126](#L126) | $error\_array['message'] = \_\_( 'The module name or module type is missing. Please make sure you added a name for the module.' ); |
| [127](#L127) | throw new Exception(); |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | // Check we're not passing the free limits. |
| [131](#L131) | if ( Hustle\_Data::was\_free\_limit\_reached( $module\_type ) ) { |
| [132](#L132) | $url\_args = array( |
| [133](#L133) | Hustle\_Module\_Admin::UPGRADE\_MODAL\_PARAM => 'true', |
| [134](#L134) | 'page' => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module\_type ), |
| [135](#L135) | ); |
| [136](#L136) |  |
| [137](#L137) | $error\_url   = add\_query\_arg( $url\_args, 'admin.php' ); |
| [138](#L138) | $error\_array = array( 'redirect\_url' => $error\_url ); |
| [139](#L139) | throw new Exception(); |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | // All good so far, let's create the module. |
| [143](#L143) | $module\_data = array( |
| [144](#L144) | 'module\_name' => $module\_name, |
| [145](#L145) | 'module\_type' => $module\_type, |
| [146](#L146) | ); |
| [147](#L147) |  |
| [148](#L148) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE !== $module\_type ) { |
| [149](#L149) | $module\_mode = filter\_input( INPUT\_POST, 'module\_mode', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [150](#L150) | $module\_mode = Hustle\_Module\_Model::OPTIN\_MODE === $module\_mode ? Hustle\_Module\_Model::OPTIN\_MODE : Hustle\_Module\_Model::INFORMATIONAL\_MODE; |
| [151](#L151) |  |
| [152](#L152) | $module\_data['module\_mode'] = $module\_mode; |
| [153](#L153) |  |
| [154](#L154) | $template = filter\_input( INPUT\_POST, 'module\_template', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [155](#L155) |  |
| [156](#L156) | $module\_data['base\_template'] = $template; |
| [157](#L157) |  |
| [158](#L158) | $templates\_helper = new Hustle\_Templates\_Helper(); |
| [159](#L159) | $module\_data     += $templates\_helper->get\_template( $template, $module\_mode ); |
| [160](#L160) |  |
| [161](#L161) | $module\_model = new Hustle\_Module\_Model(); |
| [162](#L162) | } else { |
| [163](#L163) | $module\_model = new Hustle\_SShare\_Model(); |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | $module\_id = $module\_model->create\_new( $module\_data ); |
| [167](#L167) | if ( ! $module\_id ) { |
| [168](#L168) | throw new Exception(); |
| [169](#L169) | } |
| [170](#L170) | } catch ( Exception $e ) { |
| [171](#L171) | wp\_send\_json\_error( $error\_array ); |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | $success\_url\_args = array( |
| [175](#L175) | 'page' => Hustle\_Data::get\_wizard\_page\_by\_module\_type( $module\_type ), |
| [176](#L176) | 'id'   => $module\_id, |
| [177](#L177) | 'new'  => 'true', |
| [178](#L178) | ); |
| [179](#L179) | $success\_url      = add\_query\_arg( $success\_url\_args, 'admin.php' ); |
| [180](#L180) |  |
| [181](#L181) | wp\_send\_json\_success( array( 'redirect\_url' => $success\_url ) ); |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | /\*\* |
| [185](#L185) | \* Loads the requested module via AJAX. |
| [186](#L186) | \* |
| [187](#L187) | \* @since 4.0.0 |
| [188](#L188) | \*/ |
| [189](#L189) | public function preview\_module() { |
| [190](#L190) | check\_ajax\_referer( 'hustle-preview', 'nonce' ); |
| [191](#L191) |  |
| [192](#L192) | if ( ! current\_user\_can( 'hustle\_create' ) ) { |
| [193](#L193) | wp\_send\_json\_error( \_\_( 'You do not have permission to preview this module.', 'hustle' ) ); |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | // TODO: check nonce. |
| [197](#L197) | Hustle\_Renderer\_Abstract::ajax\_load\_module(); |
| [198](#L198) | wp\_send\_json\_error( \_\_( 'Invalid module type', 'hustle' ) ); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* Handle getting tracking data from listing |
| [203](#L203) | \*/ |
| [204](#L204) | public function get\_tracking\_data() { |
| [205](#L205) | $id = filter\_input( INPUT\_POST, 'id', FILTER\_SANITIZE\_NUMBER\_INT ); |
| [206](#L206) | Opt\_In\_Utils::validate\_ajax\_call( 'module\_get\_tracking\_data' . $id ); |
| [207](#L207) |  |
| [208](#L208) | $data = Hustle\_Module\_Page\_Abstract::get\_tracking\_charts\_markup( $id ); |
| [209](#L209) |  |
| [210](#L210) | wp\_send\_json\_success( $data ); |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) | /\*\* |
| [214](#L214) | \* Handle all ajax requests related to single module's actions. |
| [215](#L215) | \* -Toggle status ( publish|draft ) |
| [216](#L216) | \* -Duplicate |
| [217](#L217) | \* -Import ( both into a new or an existing module ) |
| [218](#L218) | \* -Delete |
| [219](#L219) | \* -Toggle tracking ( enabled|disabled ) |
| [220](#L220) | \* -Reset tracking |
| [221](#L221) | \* |
| [222](#L222) | \* @since 4.0.3 |
| [223](#L223) | \* @throws Exception Invalid module. |
| [224](#L224) | \*/ |
| [225](#L225) | public function handle\_single\_action() { |
| [226](#L226) |  |
| [227](#L227) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_single\_action' ); |
| [228](#L228) |  |
| [229](#L229) | $module\_id = filter\_input( INPUT\_POST, 'moduleId', FILTER\_VALIDATE\_INT ); |
| [230](#L230) | $module    = Hustle\_Model::get\_module( $module\_id ); |
| [231](#L231) | $action    = filter\_input( INPUT\_POST, 'hustleAction', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [232](#L232) |  |
| [233](#L233) | try { |
| [234](#L234) |  |
| [235](#L235) | // Only move forward with an invalid $module when we're importing a new one. |
| [236](#L236) | if ( is\_wp\_error( $module ) && 'import' !== $action ) { |
| [237](#L237) | throw new Exception( \_\_( 'Invalid module.', 'hustle' ) ); |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | $context = filter\_input( INPUT\_POST, 'context', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [241](#L241) |  |
| [242](#L242) | switch ( $action ) { |
| [243](#L243) | case 'toggle-status': |
| [244](#L244) | $this->action\_toggle\_module\_status( $module ); |
| [245](#L245) | break; |
| [246](#L246) |  |
| [247](#L247) | case 'clone': |
| [248](#L248) | $this->action\_duplicate\_module( $module, $context ); |
| [249](#L249) | break; |
| [250](#L250) |  |
| [251](#L251) | case 'import': |
| [252](#L252) | $this->action\_import\_module( $module ); |
| [253](#L253) | break; |
| [254](#L254) |  |
| [255](#L255) | case 'delete': |
| [256](#L256) | $this->action\_delete\_module( $module, $context ); |
| [257](#L257) | break; |
| [258](#L258) |  |
| [259](#L259) | case 'toggle-tracking': |
| [260](#L260) | $this->action\_toggle\_tracking( $module ); |
| [261](#L261) | break; |
| [262](#L262) |  |
| [263](#L263) | case 'reset-tracking': |
| [264](#L264) | $this->action\_reset\_tracking( $module, $context ); |
| [265](#L265) | break; |
| [266](#L266) |  |
| [267](#L267) | case 'purge-email-list': |
| [268](#L268) | $this->action\_purge\_email\_list( $module, $context ); |
| [269](#L269) | break; |
| [270](#L270) |  |
| [271](#L271) | default: |
| [272](#L272) | throw new Exception( \_\_( 'Invalid action.', 'hustle' ) ); |
| [273](#L273) | } |
| [274](#L274) | } catch ( Exception $e ) { |
| [275](#L275) |  |
| [276](#L276) | $message = 'invalid\_permissions' !== $e->getMessage() ? $e->getMessage() : \_\_( "You don't have enough permission to do this.", 'hustle' ); |
| [277](#L277) |  |
| [278](#L278) | wp\_send\_json\_error( |
| [279](#L279) | array( |
| [280](#L280) | 'notification' => array( |
| [281](#L281) | 'status'  => 'error', |
| [282](#L282) | 'message' => $message, |
| [283](#L283) | ), |
| [284](#L284) | ) |
| [285](#L285) | ); |
| [286](#L286) | } |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | /\*\* |
| [290](#L290) | \* Handle the "Publish/Draft" module action. |
| [291](#L291) | \* |
| [292](#L292) | \* @since 4.0.3 |
| [293](#L293) | \* |
| [294](#L294) | \* @param Hustle\_Model $module Hustle\_Module\_Model or Hustle\_SShare\_Model. |
| [295](#L295) | \* @throws Exception When invalid permissions. |
| [296](#L296) | \*/ |
| [297](#L297) | private function action\_toggle\_module\_status( Hustle\_Model $module ) { |
| [298](#L298) |  |
| [299](#L299) | if ( ! Opt\_In\_Utils::is\_user\_allowed( 'hustle\_edit\_module', $module->module\_id ) ) { |
| [300](#L300) | throw new Exception( 'invalid\_permissions' ); |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | $was\_published = '1' === $module->active; |
| [304](#L304) |  |
| [305](#L305) | if ( $was\_published ) { |
| [306](#L306) | $module->deactivate(); |
| [307](#L307) | $message = esc\_html\_\_( 'Module unpublished', 'hustle' ); |
| [308](#L308) | } else { |
| [309](#L309) | $module->activate(); |
| [310](#L310) | $message = esc\_html\_\_( 'Module published successfully', 'hustle' ); |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | wp\_send\_json\_success( |
| [314](#L314) | array( |
| [315](#L315) | 'callback'            => 'actionToggleStatus', |
| [316](#L316) | 'is\_active'           => ! $was\_published, |
| [317](#L317) | 'is\_tracking\_enabled' => ! empty( $module->get\_tracking\_types() ), |
| [318](#L318) | 'message'             => $message, |
| [319](#L319) | ) |
| [320](#L320) | ); |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | /\*\* |
| [324](#L324) | \* Handle the "duplicate" module action. |
| [325](#L325) | \* |
| [326](#L326) | \* @since 4.0.3 |
| [327](#L327) | \* |
| [328](#L328) | \* @param Hustle\_Model $module Hustle\_Module\_Model or Hustle\_SShare\_Model. |
| [329](#L329) | \* @param string       $context dashboard|listing|edit\_page. |
| [330](#L330) | \* @throws Exception When invalid permissions. |
| [331](#L331) | \*/ |
| [332](#L332) | private function action\_duplicate\_module( Hustle\_Model $module, $context ) { |
| [333](#L333) |  |
| [334](#L334) | if ( ! current\_user\_can( 'hustle\_create' ) ) { |
| [335](#L335) | throw new Exception( 'invalid\_permissions' ); |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | $module->duplicate\_module(); |
| [339](#L339) |  |
| [340](#L340) | if ( 'edit\_page' !== $context ) { |
| [341](#L341) | $url\_params = array( |
| [342](#L342) | 'page'        => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module->module\_type ), |
| [343](#L343) | 'show-notice' => 'success', |
| [344](#L344) | 'notice'      => 'module\_duplicated', |
| [345](#L345) | ); |
| [346](#L346) |  |
| [347](#L347) | $args = array( 'url' => add\_query\_arg( $url\_params, 'admin.php' ) ); |
| [348](#L348) | } else { |
| [349](#L349) | $args = array( |
| [350](#L350) | 'notification' => array( |
| [351](#L351) | 'status'  => 'success', |
| [352](#L352) | 'message' => esc\_html\_\_( 'Module successfully duplicated.', 'hustle' ), |
| [353](#L353) | ), |
| [354](#L354) | ); |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | wp\_send\_json\_success( $args ); |
| [358](#L358) | } |
| [359](#L359) |  |
| [360](#L360) | /\*\* |
| [361](#L361) | \* Handle the "import" module action. |
| [362](#L362) | \* This is used for importing both into a new and an existing module. |
| [363](#L363) | \* |
| [364](#L364) | \* @since 4.0.0 |
| [365](#L365) | \* @since 4.0.3 $module param added. Callback for handle\_single\_action() instead of the ajax request. |
| [366](#L366) | \* |
| [367](#L367) | \* @param Hustle\_Module\_Model|WP\_Error $module WP\_Error in case the import is creating a new module. Hustle\_Module\_Model otherwise. |
| [368](#L368) | \* @throws Exception This is caught by the parent function. |
| [369](#L369) | \*/ |
| [370](#L370) | private function action\_import\_module( $module ) { |
| [371](#L371) |  |
| [372](#L372) | $is\_new\_module = is\_wp\_error( $module ); |
| [373](#L373) |  |
| [374](#L374) | if ( ! $is\_new\_module && ! current\_user\_can( 'hustle\_create' ) ) { |
| [375](#L375) | throw new Exception( 'invalid\_permissions' ); |
| [376](#L376) | } |
| [377](#L377) |  |
| [378](#L378) | $module\_type = filter\_input( INPUT\_POST, 'type', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [379](#L379) |  |
| [380](#L380) | if ( ! $module\_type || ! in\_array( $module\_type, Hustle\_Data::get\_module\_types(), true ) ) { |
| [381](#L381) | throw new Exception( \_\_( "The module's type is not valid.", 'hustle' ) ); |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) | // Send error if the user can't create new modules but is importing a new one. |
| [385](#L385) | if ( $is\_new\_module && Hustle\_Data::was\_free\_limit\_reached( $module\_type ) ) { |
| [386](#L386) |  |
| [387](#L387) | $url = add\_query\_arg( |
| [388](#L388) | array( |
| [389](#L389) | 'page' => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module\_type ), |
| [390](#L390) | Hustle\_Module\_Admin::UPGRADE\_MODAL\_PARAM => 'true', |
| [391](#L391) | ), |
| [392](#L392) | 'admin.php' |
| [393](#L393) | ); |
| [394](#L394) |  |
| [395](#L395) | wp\_send\_json\_error( array( 'redirect\_url' => $url ) ); |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | try { |
| [399](#L399) | // Get the file containing the module data. |
| [400](#L400) | $file = isset( $\_FILES['import\_file'] ) ? $\_FILES['import\_file'] : false;// phpcs:ignore |
| [401](#L401) |  |
| [402](#L402) | if ( ! $file ) { |
| [403](#L403) | throw new Exception( \_\_( 'The file is required', 'hustle' ) ); |
| [404](#L404) |  |
| [405](#L405) | } elseif ( ! empty( $file['error'] ) ) { |
| [406](#L406) | /\* translators: error message \*/ |
| [407](#L407) | throw new Exception( sprintf( \_\_( 'Error: %s', 'hustle' ), esc\_html( $file['error'] ) ) ); |
| [408](#L408) | } |
| [409](#L409) |  |
| [410](#L410) | // Get the file's content. |
| [411](#L411) | $overrides = array( |
| [412](#L412) | 'test\_form' => false, |
| [413](#L413) | 'test\_type' => false, |
| [414](#L414) | ); |
| [415](#L415) |  |
| [416](#L416) | $wp\_file = wp\_handle\_upload( $file, $overrides ); |
| [417](#L417) | if ( isset( $wp\_file['error'] ) ) { |
| [418](#L418) | throw new Exception( \_\_( 'The file could not be uploaded.check your upload folder permissions.', 'hustle' ) ); |
| [419](#L419) | } |
| [420](#L420) | if ( empty( $wp\_file['file'] ) ) { |
| [421](#L421) | throw new Exception( \_\_( "The file can't be empty", 'hustle' ) ); |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | $filename     = $wp\_file['file']; |
| [425](#L425) | $file\_content = file\_get\_contents( $filename ); // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [426](#L426) |  |
| [427](#L427) | // Import file if it's json format. |
| [428](#L428) | $data = array(); |
| [429](#L429) | if ( strpos( $filename, '.json' ) || strpos( $filename, '.JSON' ) ) { |
| [430](#L430) | $data = json\_decode( $file\_content, true ); |
| [431](#L431) |  |
| [432](#L432) | } else { |
| [433](#L433) | throw new Exception( \_\_( 'The file must be a JSON string.', 'hustle' ) ); |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | // Make sure the file to import comes from 4.0 or greater. |
| [437](#L437) | if ( ! isset( $data['plugin'] ) || ! isset( $data['plugin']['version'] ) ) { |
| [438](#L438) | throw new Exception( \_\_( 'The file is either invalid or doesn\'t have any configurations. Please check your file or upload another file.', 'hustle' ) ); |
| [439](#L439) |  |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | // Prevent importing ssharing into other module types, and vice versa. |
| [443](#L443) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE === $module\_type ) { |
| [444](#L444) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE !== $data['data']['module\_type'] ) { |
| [445](#L445) | throw new Exception( \_\_( "You can't import modules of other than \"Social Sharing\" type into Social Sharing modules.", 'hustle' ) ); |
| [446](#L446) | } |
| [447](#L447) | } else { |
| [448](#L448) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE === $data['data']['module\_type'] ) { |
| [449](#L449) | throw new Exception( \_\_( "You can't import Social Sharing modules into other module types.", 'hustle' ) ); |
| [450](#L450) | } |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) | $source\_mode = $data['data']['module\_mode']; |
| [454](#L454) | $target\_mode = $is\_new\_module ? filter\_input( INPUT\_POST, 'module\_mode', FILTER\_SANITIZE\_SPECIAL\_CHARS ) : $module->module\_mode; |
| [455](#L455) |  |
| [456](#L456) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE !== $module\_type ) { |
| [457](#L457) |  |
| [458](#L458) | // If the mode is changing, adjust the title and subtitle colors to remain the same in front. |
| [459](#L459) | if ( 'default' === $target\_mode ) { |
| [460](#L460) | $target\_mode = $source\_mode; |
| [461](#L461) |  |
| [462](#L462) | } elseif ( $target\_mode !== $source\_mode ) { |
| [463](#L463) |  |
| [464](#L464) | $is\_optin = Hustle\_Module\_Model::OPTIN\_MODE === $target\_mode; |
| [465](#L465) |  |
| [466](#L466) | if ( $is\_optin ) { |
| [467](#L467) | $data['meta']['design']['title\_color']    = $data['meta']['design']['title\_color\_alt']; |
| [468](#L468) | $data['meta']['design']['subtitle\_color'] = $data['meta']['design']['subtitle\_color\_alt']; |
| [469](#L469) | } else { |
| [470](#L470) | $data['meta']['design']['title\_color\_alt']    = $data['meta']['design']['title\_color']; |
| [471](#L471) | $data['meta']['design']['subtitle\_color\_alt'] = $data['meta']['design']['subtitle\_color']; |
| [472](#L472) | } |
| [473](#L473) | } |
| [474](#L474) | } else { |
| [475](#L475) | if ( version\_compare( $data['plugin']['version'], '4.4.9', '<' ) && |
| [476](#L476) | ! empty( $data['meta']['design']['icon\_style'] ) && |
| [477](#L477) | 'outline' === $data['meta']['design']['icon\_style'] ) { |
| [478](#L478) | if ( isset( $data['meta']['design']['widget\_icon\_bg\_color'] ) ) { |
| [479](#L479) | $data['meta']['design']['widget\_counter\_border'] = $data['meta']['design']['widget\_icon\_bg\_color']; |
| [480](#L480) | } |
| [481](#L481) | if ( isset( $data['meta']['design']['floating\_icon\_bg\_color'] ) ) { |
| [482](#L482) | $data['meta']['design']['floating\_counter\_border'] = $data['meta']['design']['floating\_icon\_bg\_color']; |
| [483](#L483) | } |
| [484](#L484) | } |
| [485](#L485) | } |
| [486](#L486) | $target\_mode = sanitize\_key( $target\_mode ); |
| [487](#L487) |  |
| [488](#L488) | // validate Schedule start/end date and replace it with empty if is invalid. |
| [489](#L489) | // ======================================================================. |
| [490](#L490) | $schedule\_start\_date = $data['meta']['settings']['schedule']['start\_date']; |
| [491](#L491) | $schedule\_end\_date   = $data['meta']['settings']['schedule']['end\_date']; |
| [492](#L492) | // Unset start\_date & Set start immediately if start\_date is invalid. |
| [493](#L493) | if ( date( 'n/j/Y', strtotime( $schedule\_start\_date ) ) !== $schedule\_start\_date ) : // phpcs:ignore WordPress.DateTime.RestrictedFunctions.date\_date |
| [494](#L494) | unset( $data['meta']['settings']['schedule']['start\_date'] ); |
| [495](#L495) | $data['meta']['settings']['schedule']['not\_schedule\_start'] = 1; |
| [496](#L496) | endif; |
| [497](#L497) | // Unset end\_date & Set never end if end\_date is invalid. |
| [498](#L498) | if ( date( 'n/j/Y', strtotime( $schedule\_end\_date ) ) !== $schedule\_end\_date ) : // phpcs:ignore WordPress.DateTime.RestrictedFunctions.date\_date |
| [499](#L499) | unset( $data['meta']['settings']['schedule']['end\_date'] ); |
| [500](#L500) | $data['meta']['settings']['schedule']['not\_schedule\_end'] = 1; |
| [501](#L501) | endif; |
| [502](#L502) | // ==================================================================. |
| [503](#L503) |  |
| [504](#L504) | // Import a new module. |
| [505](#L505) | if ( $is\_new\_module ) { |
| [506](#L506) | $this->import\_new\_module( $module\_type, $target\_mode, $data ); |
| [507](#L507) |  |
| [508](#L508) | } else { |
| [509](#L509) | // Import the settings into an existing module. |
| [510](#L510) | $this->import\_into\_existing\_module( $module, $module\_type, $data ); |
| [511](#L511) | } |
| [512](#L512) | } catch ( Exception $e ) { |
| [513](#L513) | wp\_send\_json\_error( |
| [514](#L514) | array( |
| [515](#L515) | 'callback' => 'actionImportDisplayError', |
| [516](#L516) | 'message'  => esc\_html( $e->getMessage() ), |
| [517](#L517) | ) |
| [518](#L518) | ); |
| [519](#L519) | } |
| [520](#L520) |  |
| [521](#L521) | } |
| [522](#L522) |  |
| [523](#L523) | /\*\* |
| [524](#L524) | \* Handle the "delete" module action. |
| [525](#L525) | \* |
| [526](#L526) | \* @since 4.0.3 |
| [527](#L527) | \* |
| [528](#L528) | \* @param Hustle\_Module\_Model $module Module. |
| [529](#L529) | \* @param string              $context 'dashboard'|'listing'. |
| [530](#L530) | \* @throws Exception When invalid permissions. |
| [531](#L531) | \*/ |
| [532](#L532) | private function action\_delete\_module( $module, $context ) { |
| [533](#L533) |  |
| [534](#L534) | if ( ! current\_user\_can( 'hustle\_create' ) ) { |
| [535](#L535) | throw new Exception( 'invalid\_permissions' ); |
| [536](#L536) | } |
| [537](#L537) |  |
| [538](#L538) | $module->delete(); |
| [539](#L539) |  |
| [540](#L540) | $page = 'dashboard' !== $context ? Hustle\_Data::get\_listing\_page\_by\_module\_type( $module->module\_type ) : Hustle\_Data::ADMIN\_PAGE; |
| [541](#L541) |  |
| [542](#L542) | $url\_params = array( |
| [543](#L543) | 'page'        => $page, |
| [544](#L544) | 'show-notice' => 'success', |
| [545](#L545) | 'notice'      => 'module\_deleted', |
| [546](#L546) | ); |
| [547](#L547) |  |
| [548](#L548) | wp\_send\_json\_success( array( 'url' => add\_query\_arg( $url\_params, 'admin.php' ) ) ); |
| [549](#L549) | } |
| [550](#L550) |  |
| [551](#L551) | /\*\* |
| [552](#L552) | \* Handle the "toggle tracking" module action. |
| [553](#L553) | \* |
| [554](#L554) | \* @since 4.0.3 |
| [555](#L555) | \* |
| [556](#L556) | \* @param Hustle\_Model $module Hustle\_Module\_Model or Hustle\_SShare\_Model. |
| [557](#L557) | \* @throws Exception When invalid permissions. |
| [558](#L558) | \*/ |
| [559](#L559) | private function action\_toggle\_tracking( Hustle\_Model $module ) { |
| [560](#L560) |  |
| [561](#L561) | if ( ! Opt\_In\_Utils::is\_user\_allowed( 'hustle\_edit\_module', $module->module\_id ) ) { |
| [562](#L562) | throw new Exception( 'invalid\_permissions' ); |
| [563](#L563) | } |
| [564](#L564) |  |
| [565](#L565) | $was\_tracking\_enabled = false; |
| [566](#L566) | $message              = ''; |
| [567](#L567) | $is\_embed\_or\_sshare   = Hustle\_Module\_Model::EMBEDDED\_MODULE === $module->module\_type || Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE === $module->module\_type; |
| [568](#L568) |  |
| [569](#L569) | $response = array( |
| [570](#L570) | 'is\_embed\_or\_sshare' => $is\_embed\_or\_sshare, |
| [571](#L571) | 'is\_active'          => '1' === $module->active, |
| [572](#L572) | 'callback'           => 'actionToggleTracking', |
| [573](#L573) | ); |
| [574](#L574) |  |
| [575](#L575) | if ( ! $is\_embed\_or\_sshare ) { |
| [576](#L576) | // Popups and slideins. |
| [577](#L577) |  |
| [578](#L578) | $was\_tracking\_enabled = $module->is\_track\_type\_active( $module->module\_type ); |
| [579](#L579) |  |
| [580](#L580) | if ( $was\_tracking\_enabled ) { |
| [581](#L581) | $module->disable\_type\_track\_mode( $module->module\_type ); |
| [582](#L582) |  |
| [583](#L583) | } else { |
| [584](#L584) | $module->enable\_type\_track\_mode( $module->module\_type ); |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | $message = $was\_tracking\_enabled ? |
| [588](#L588) | sprintf( /\* translators: module name \*/ esc\_html\_\_( 'Tracking is disabled on %s', 'hustle' ), '<strong>' . esc\_html( $module->module\_name ) . '</strong>' ) : |
| [589](#L589) | sprintf( /\* translators: module name \*/ esc\_html\_\_( 'Tracking is enabled on %s', 'hustle' ), '<strong>' . esc\_html( $module->module\_name ) . '</strong>' ); |
| [590](#L590) |  |
| [591](#L591) | $response['was\_enabled'] = $was\_tracking\_enabled; |
| [592](#L592) |  |
| [593](#L593) | } else { |
| [594](#L594) | // Embeds and social sharing. |
| [595](#L595) | $enabled\_track\_types = filter\_input( INPUT\_POST, 'tracking\_sub\_types', FILTER\_SANITIZE\_SPECIAL\_CHARS, FILTER\_REQUIRE\_ARRAY ); |
| [596](#L596) | if ( is\_null( $enabled\_track\_types ) ) { |
| [597](#L597) | $enabled\_track\_types = array(); |
| [598](#L598) | } |
| [599](#L599) |  |
| [600](#L600) | $module->update\_submitted\_tracking\_types( $enabled\_track\_types ); |
| [601](#L601) |  |
| [602](#L602) | /\* translators: module name \*/ |
| [603](#L603) | $message = sprintf( esc\_html\_\_( 'Tracking updated on %s', 'hustle' ), '<strong>' . esc\_html( $module->module\_name ) . '</strong>' ); |
| [604](#L604) |  |
| [605](#L605) | $response['enabled\_types'] = implode( ',', $enabled\_track\_types ); |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | $response['message'] = $message; |
| [609](#L609) |  |
| [610](#L610) | wp\_send\_json\_success( $response ); |
| [611](#L611) | } |
| [612](#L612) |  |
| [613](#L613) | /\*\* |
| [614](#L614) | \* Handle the "Reset tracking" module action. |
| [615](#L615) | \* |
| [616](#L616) | \* @since 4.0.3 |
| [617](#L617) | \* |
| [618](#L618) | \* @param Hustle\_Model $module Hustle\_Module\_Model or Hustle\_SShare\_Model. |
| [619](#L619) | \* @param string       $context dashboard|listing|edit\_page. |
| [620](#L620) | \* @throws Exception When invalid permissions. |
| [621](#L621) | \*/ |
| [622](#L622) | private function action\_reset\_tracking( Hustle\_Model $module, $context ) { |
| [623](#L623) |  |
| [624](#L624) | if ( ! Opt\_In\_Utils::is\_user\_allowed( 'hustle\_edit\_module', $module->module\_id ) ) { |
| [625](#L625) | throw new Exception( 'invalid\_permissions' ); |
| [626](#L626) | } |
| [627](#L627) |  |
| [628](#L628) | $tracking = Hustle\_Tracking\_Model::get\_instance(); |
| [629](#L629) | $tracking->delete\_data( $module->module\_id ); |
| [630](#L630) |  |
| [631](#L631) | if ( 'edit\_page' !== $context ) { |
| [632](#L632) | $url\_params = array( |
| [633](#L633) | 'page'        => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module->module\_type ), |
| [634](#L634) | 'show-notice' => 'success', |
| [635](#L635) | 'notice'      => 'module\_tracking\_reset', |
| [636](#L636) | ); |
| [637](#L637) |  |
| [638](#L638) | $args = array( 'url' => add\_query\_arg( $url\_params, 'admin.php' ) ); |
| [639](#L639) | } else { |
| [640](#L640) | $args = array( |
| [641](#L641) | 'notification' => array( |
| [642](#L642) | 'status'  => 'success', |
| [643](#L643) | 'message' => esc\_html\_\_( "Module's tracking data successfully reset.", 'hustle' ), |
| [644](#L644) | ), |
| [645](#L645) | ); |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) | wp\_send\_json\_success( $args ); |
| [649](#L649) | } |
| [650](#L650) |  |
| [651](#L651) | /\*\* |
| [652](#L652) | \* Handle the "Purge Email List" module action. |
| [653](#L653) | \* |
| [654](#L654) | \* @param Hustle\_Model $module Hustle\_Module\_Model or Hustle\_SShare\_Model. |
| [655](#L655) | \* @param string       $context dashboard|listing|edit\_page. |
| [656](#L656) | \* @throws Exception When invalid permissions. |
| [657](#L657) | \*/ |
| [658](#L658) | private function action\_purge\_email\_list( Hustle\_Model $module, $context ) { |
| [659](#L659) |  |
| [660](#L660) | if ( ! Opt\_In\_Utils::is\_user\_allowed( 'hustle\_access\_emails' ) ) { |
| [661](#L661) | throw new Exception( 'invalid\_permissions' ); |
| [662](#L662) | } |
| [663](#L663) |  |
| [664](#L664) | Hustle\_Entry\_Model::delete\_entries( $module->module\_id ); |
| [665](#L665) |  |
| [666](#L666) | if ( 'edit\_page' !== $context ) { |
| [667](#L667) | $url\_params = array( |
| [668](#L668) | 'page'        => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module->module\_type ), |
| [669](#L669) | 'show-notice' => 'success', |
| [670](#L670) | 'notice'      => 'module\_purge\_emails', |
| [671](#L671) | ); |
| [672](#L672) |  |
| [673](#L673) | $args = array( 'url' => add\_query\_arg( $url\_params, 'admin.php' ) ); |
| [674](#L674) | } else { |
| [675](#L675) | $args = array( |
| [676](#L676) | 'notification' => array( |
| [677](#L677) | 'status'  => 'success', |
| [678](#L678) | 'message' => esc\_html\_\_( "Module's Email List successfully purged.", 'hustle' ), |
| [679](#L679) | ), |
| [680](#L680) | ); |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) | wp\_send\_json\_success( $args ); |
| [684](#L684) | } |
| [685](#L685) |  |
| [686](#L686) |  |
| [687](#L687) | /\*\* |
| [688](#L688) | \* Parse the imported data before saving. |
| [689](#L689) | \* |
| [690](#L690) | \* @since 4.0.3 |
| [691](#L691) | \* |
| [692](#L692) | \* @param array  $data Incoming module's data. |
| [693](#L693) | \* @param string $module\_mode Target module's mode. |
| [694](#L694) | \* @return array |
| [695](#L695) | \* |
| [696](#L696) | \* @throws Exception Settings to import isn't selected. |
| [697](#L697) | \*/ |
| [698](#L698) | private function apply\_import\_filters( $data, $module\_mode ) { |
| [699](#L699) |  |
| [700](#L700) | // Ssharing modules don't have mode. |
| [701](#L701) | if ( ! empty( $module\_mode ) ) { |
| [702](#L702) | $module\_mode = Hustle\_Module\_Model::INFORMATIONAL\_MODE === $module\_mode ? 'info' : Hustle\_Module\_Model::OPTIN\_MODE; |
| [703](#L703) |  |
| [704](#L704) | } else { |
| [705](#L705) | $module\_mode = 'ssharing'; |
| [706](#L706) | } |
| [707](#L707) |  |
| [708](#L708) | $metas = filter\_input( INPUT\_POST, $module\_mode . '\_metas', FILTER\_SANITIZE\_SPECIAL\_CHARS, FILTER\_REQUIRE\_ARRAY ); |
| [709](#L709) |  |
| [710](#L710) | if ( empty( $metas ) ) { |
| [711](#L711) | throw new Exception( \_\_( 'Please select the settings to import.', 'hustle' ) ); |
| [712](#L712) | } |
| [713](#L713) |  |
| [714](#L714) | // No filter was applied. Import everything. |
| [715](#L715) | if ( in\_array( 'all', $metas, true ) ) { |
| [716](#L716) | return $data; |
| [717](#L717) | } |
| [718](#L718) |  |
| [719](#L719) | // Remove the metas that the user chose not to import. |
| [720](#L720) | foreach ( $data['meta'] as $name => $value ) { |
| [721](#L721) | if ( ! in\_array( $name, $metas, true ) ) { |
| [722](#L722) | unset( $data['meta'][ $name ] ); |
| [723](#L723) | } |
| [724](#L724) | } |
| [725](#L725) |  |
| [726](#L726) | return $data; |
| [727](#L727) | } |
| [728](#L728) |  |
| [729](#L729) | /\*\* |
| [730](#L730) | \* Import the settings into an existing module. |
| [731](#L731) | \* |
| [732](#L732) | \* @since 4.0.0 |
| [733](#L733) | \* |
| [734](#L734) | \* @param Hustle\_Module\_Model $module Module. |
| [735](#L735) | \* @param string              $module\_type Module type. |
| [736](#L736) | \* @param array               $data Data. |
| [737](#L737) | \* |
| [738](#L738) | \* @throws Exception Access denied. |
| [739](#L739) | \*/ |
| [740](#L740) | private function import\_into\_existing\_module( $module, $module\_type, $data ) { |
| [741](#L741) |  |
| [742](#L742) | // Check if the current user can do this. |
| [743](#L743) | $is\_allowed = Opt\_In\_Utils::is\_user\_allowed( 'hustle\_edit\_module', $module->id ); |
| [744](#L744) | if ( ! $is\_allowed ) { |
| [745](#L745) | throw new Exception( sprintf( \_\_( 'Access denied. You do not have permission to perform this action.', 'hustle' ) ) ); |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | $data = $this->apply\_import\_filters( $data, $module->module\_mode ); |
| [749](#L749) |  |
| [750](#L750) | // Import the module's metas. |
| [751](#L751) | $current\_data = $module->get\_module\_metas\_as\_array(); |
| [752](#L752) | foreach ( $current\_data as $meta\_key => $current\_value ) { |
| [753](#L753) |  |
| [754](#L754) | if ( isset( $data['meta'][ $meta\_key ] ) ) { |
| [755](#L755) |  |
| [756](#L756) | if ( 'visibility' === $meta\_key ) { |
| [757](#L757) | $incoming\_value = $data['meta'][ $meta\_key ]; |
| [758](#L758) | } else { |
| [759](#L759) | // Filter the incoming array to get rid of what doesn't belong to this module type. |
| [760](#L760) | $incoming\_value = array\_intersect\_key( $data['meta'][ $meta\_key ], $current\_value ); |
| [761](#L761) | } |
| [762](#L762) |  |
| [763](#L763) | $meta\_to\_update = array\_merge( $current\_value, $incoming\_value ); |
| [764](#L764) | $module->update\_meta( $meta\_key, $meta\_to\_update ); |
| [765](#L765) | } |
| [766](#L766) | } |
| [767](#L767) |  |
| [768](#L768) | $module->save(); |
| [769](#L769) | $module->clean\_module\_cache(); |
| [770](#L770) |  |
| [771](#L771) | $url = add\_query\_arg( |
| [772](#L772) | array( |
| [773](#L773) | 'page'        => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module\_type ), |
| [774](#L774) | 'show-notice' => 'success', |
| [775](#L775) | 'notice'      => 'module\_imported', |
| [776](#L776) | ), |
| [777](#L777) | 'admin.php' |
| [778](#L778) | ); |
| [779](#L779) |  |
| [780](#L780) | wp\_send\_json\_success( array( 'url' => $url ) ); |
| [781](#L781) | } |
| [782](#L782) |  |
| [783](#L783) | /\*\* |
| [784](#L784) | \* Import the settings into a new module. |
| [785](#L785) | \* |
| [786](#L786) | \* @since 4.0 |
| [787](#L787) | \* |
| [788](#L788) | \* @param string $module\_type Module type. |
| [789](#L789) | \* @param string $target\_mode Target mode. |
| [790](#L790) | \* @param array  $data Data. |
| [791](#L791) | \* |
| [792](#L792) | \* @throws Exception Creation process was failed. |
| [793](#L793) | \*/ |
| [794](#L794) | private function import\_new\_module( $module\_type, $target\_mode, $data ) { |
| [795](#L795) | Opt\_In\_Utils::is\_user\_allowed\_ajax( 'hustle\_create' ); |
| [796](#L796) |  |
| [797](#L797) | if ( 'default' !== $target\_mode ) { |
| [798](#L798) | $data = $this->apply\_import\_filters( $data, $target\_mode ); |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | $data['data']['module\_type'] = $module\_type; |
| [802](#L802) |  |
| [803](#L803) | // Set the module mode according to the selected settings. |
| [804](#L804) | $data['data']['module\_mode'] = Hustle\_Module\_Model::INFORMATIONAL\_MODE === $target\_mode ? $target\_mode : Hustle\_Module\_Model::OPTIN\_MODE; |
| [805](#L805) |  |
| [806](#L806) | $module\_data = array\_merge( $data['data'], $data['meta'] ); |
| [807](#L807) |  |
| [808](#L808) | if ( Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE !== $module\_type ) { |
| [809](#L809) | $module\_model = new Hustle\_Module\_Model(); |
| [810](#L810) | } else { |
| [811](#L811) | $module\_model = new Hustle\_SShare\_Model(); |
| [812](#L812) | } |
| [813](#L813) |  |
| [814](#L814) | $module\_id = $module\_model->create\_new( $module\_data ); |
| [815](#L815) |  |
| [816](#L816) | if ( ! empty( $module\_id ) ) { |
| [817](#L817) | $module = new Hustle\_Module\_Model( $module\_id ); |
| [818](#L818) | $module->clean\_module\_cache(); |
| [819](#L819) |  |
| [820](#L820) | $url = add\_query\_arg( |
| [821](#L821) | array( |
| [822](#L822) | 'page'        => Hustle\_Data::get\_listing\_page\_by\_module\_type( $module\_type ), |
| [823](#L823) | 'show-notice' => 'success', |
| [824](#L824) | 'notice'      => 'module\_imported', |
| [825](#L825) | ), |
| [826](#L826) | 'admin.php' |
| [827](#L827) | ); |
| [828](#L828) |  |
| [829](#L829) | wp\_send\_json\_success( array( 'url' => $url ) ); |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | throw new Exception( \_\_( 'Creating a new module went wrong', 'hustle' ) ); |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | /\*\* |
| [836](#L836) | \* Handle bulk action from listings |
| [837](#L837) | \*/ |
| [838](#L838) | public function handle\_bulk\_action() { |
| [839](#L839) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle-bulk-action' ); |
| [840](#L840) | $type   = filter\_input( INPUT\_POST, 'type', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [841](#L841) | $hustle = filter\_input( INPUT\_POST, 'hustle', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [842](#L842) | $ids    = filter\_input( INPUT\_POST, 'ids', FILTER\_SANITIZE\_SPECIAL\_CHARS, FILTER\_REQUIRE\_ARRAY ); |
| [843](#L843) | if ( ! is\_array( $ids ) || empty( $ids ) ) { |
| [844](#L844) | wp\_send\_json\_error( \_\_( 'Failed', 'hustle' ) ); |
| [845](#L845) | } |
| [846](#L846) |  |
| [847](#L847) | foreach ( $ids as $id ) { |
| [848](#L848) | $id     = intval( $id ); |
| [849](#L849) | $module = Hustle\_Module\_Collection::instance()->return\_model\_from\_id( $id ); |
| [850](#L850) | if ( is\_wp\_error( $module ) ) { |
| [851](#L851) | continue; |
| [852](#L852) | } |
| [853](#L853) | if ( $module->module\_type !== $type && in\_array( $type, array( 'popup', 'embedded', 'slidein' ), true ) ) { |
| [854](#L854) | continue; |
| [855](#L855) | } |
| [856](#L856) |  |
| [857](#L857) | $can\_edit   = Opt\_In\_Utils::is\_user\_allowed( 'hustle\_edit\_module', $id ); |
| [858](#L858) | $can\_emails = Opt\_In\_Utils::is\_user\_allowed( 'hustle\_access\_emails' ); |
| [859](#L859) | $can\_create = current\_user\_can( 'hustle\_create' ); |
| [860](#L860) |  |
| [861](#L861) | switch ( $hustle ) { |
| [862](#L862) | case 'publish': |
| [863](#L863) | if ( $can\_edit ) { |
| [864](#L864) | $module->activate(); |
| [865](#L865) | } |
| [866](#L866) | break; |
| [867](#L867) |  |
| [868](#L868) | case 'unpublish': |
| [869](#L869) | if ( $can\_edit ) { |
| [870](#L870) | $module->deactivate(); |
| [871](#L871) | } |
| [872](#L872) | break; |
| [873](#L873) |  |
| [874](#L874) | case 'clone': |
| [875](#L875) | if ( $can\_create && ! Hustle\_Data::was\_free\_limit\_reached( $module->module\_type ) ) { |
| [876](#L876) | $module->duplicate\_module(); |
| [877](#L877) | } |
| [878](#L878) | break; |
| [879](#L879) |  |
| [880](#L880) | case 'delete': |
| [881](#L881) | if ( $can\_create ) { |
| [882](#L882) | $module->delete(); |
| [883](#L883) | } |
| [884](#L884) | break; |
| [885](#L885) |  |
| [886](#L886) | case 'disable-tracking': |
| [887](#L887) | if ( $can\_edit ) { |
| [888](#L888) | $module->disable\_type\_track\_mode( $type, true ); |
| [889](#L889) | } |
| [890](#L890) | break; |
| [891](#L891) |  |
| [892](#L892) | case 'enable-tracking': |
| [893](#L893) | if ( $can\_edit ) { |
| [894](#L894) | $module->enable\_type\_track\_mode( $type, true ); |
| [895](#L895) | } |
| [896](#L896) | break; |
| [897](#L897) |  |
| [898](#L898) | case 'reset-tracking': |
| [899](#L899) | if ( $can\_edit ) { |
| [900](#L900) | $tracking = Hustle\_Tracking\_Model::get\_instance(); |
| [901](#L901) | $tracking->delete\_data( $id ); |
| [902](#L902) | } |
| [903](#L903) | break; |
| [904](#L904) |  |
| [905](#L905) | case 'purge-email-list': |
| [906](#L906) | if ( $can\_emails ) { |
| [907](#L907) | Hustle\_Entry\_Model::delete\_entries( $id ); |
| [908](#L908) | } |
| [909](#L909) | break; |
| [910](#L910) |  |
| [911](#L911) | default: |
| [912](#L912) | wp\_send\_json\_error( \_\_( 'Failed', 'hustle' ) ); |
| [913](#L913) | } |
| [914](#L914) | } |
| [915](#L915) | wp\_send\_json\_success(); |
| [916](#L916) | } |
| [917](#L917) |  |
| [918](#L918) | /\*\* |
| [919](#L919) | \* Render module |
| [920](#L920) | \*/ |
| [921](#L921) | public function render\_module() { |
| [922](#L922) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_gutenberg\_get\_module' ); |
| [923](#L923) |  |
| [924](#L924) | $shortcode\_id = filter\_input( INPUT\_GET, 'shortcode\_id', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [925](#L925) |  |
| [926](#L926) | if ( ! $shortcode\_id ) { |
| [927](#L927) | wp\_send\_json\_error(); |
| [928](#L928) | } |
| [929](#L929) |  |
| [930](#L930) | $module\_id = Hustle\_Model::get\_module\_id\_by\_shortcode\_id( $shortcode\_id ); |
| [931](#L931) | $module    = Hustle\_Model::get\_module( $module\_id ); |
| [932](#L932) |  |
| [933](#L933) | if ( is\_wp\_error( $module ) ) { |
| [934](#L934) | wp\_send\_json\_error(); |
| [935](#L935) | } |
| [936](#L936) |  |
| [937](#L937) | if ( Hustle\_Module\_Model::EMBEDDED\_MODULE === $module->module\_type || Hustle\_Module\_Model::SOCIAL\_SHARING\_MODULE === $module->module\_type ) { |
| [938](#L938) | $sub\_type = Hustle\_Module\_Model::SHORTCODE\_MODULE; |
| [939](#L939) | } else { |
| [940](#L940) | $sub\_type = ''; |
| [941](#L941) | } |
| [942](#L942) |  |
| [943](#L943) | $html  = $module->display( $sub\_type, '', true ); |
| [944](#L944) | $style = '<style type="text/css" class="hustle-module-styles-' . esc\_attr( $module->id ) . '">' . $module->get\_decorated()->get\_module\_styles( $module->module\_type ) . '</style>'; |
| [945](#L945) |  |
| [946](#L946) | $response = array( |
| [947](#L947) | 'data'  => array( |
| [948](#L948) | 'module\_id'    => $module->module\_id, |
| [949](#L949) | 'shortcode\_id' => $shortcode\_id, |
| [950](#L950) | ), |
| [951](#L951) | 'html'  => $html, |
| [952](#L952) | 'style' => $style, |
| [953](#L953) | ); |
| [954](#L954) |  |
| [955](#L955) | wp\_send\_json\_success( $response ); |
| [956](#L956) | } |
| [957](#L957) |  |
| [958](#L958) | /\*\* |
| [959](#L959) | \* Get the module\_id by the shortcode\_id provided. |
| [960](#L960) | \* Used by Gutenberg to create blocks. |
| [961](#L961) | \* |
| [962](#L962) | \* @since 3.0.7 |
| [963](#L963) | \* |
| [964](#L964) | \* @return void |
| [965](#L965) | \*/ |
| [966](#L966) | public function get\_module\_id\_by\_shortcode() { |
| [967](#L967) | Opt\_In\_Utils::validate\_ajax\_call( 'hustle\_gutenberg\_get\_module' ); |
| [968](#L968) |  |
| [969](#L969) | $shortcode\_id = filter\_input( INPUT\_GET, 'shortcode\_id', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [970](#L970) |  |
| [971](#L971) | $module\_id = Hustle\_Model::get\_module\_id\_by\_shortcode\_id( $shortcode\_id ); |
| [972](#L972) | $module    = Hustle\_Model::get\_module( $module\_id ); |
| [973](#L973) | if ( is\_wp\_error( $module ) ) { |
| [974](#L974) | wp\_send\_json\_error(); |
| [975](#L975) | } |
| [976](#L976) | wp\_send\_json\_success( array( 'module\_id' => $module->id ) ); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) |  |
| [980](#L980) | /\*\* |
| [981](#L981) | \* Get posts/pages/tags/categories for visibility options via ajax. |
| [982](#L982) | \* Finds and repares select2 options. |
| [983](#L983) | \* |
| [984](#L984) | \* @global type $wpdb |
| [985](#L985) | \* @since 3.0.7 |
| [986](#L986) | \*/ |
| [987](#L987) | public function get\_new\_condition\_ids() { |
| [988](#L988) | global $wpdb; |
| [989](#L989) |  |
| [990](#L990) | $post\_type = filter\_input( INPUT\_POST, 'postType', FILTER\_SANITIZE\_SPECIAL\_CHARS ); |
| [991](#L991) | $search    = filter\_input( INPUT\_POST, 'search' ); |
| [992](#L992) | $result    = array(); |
| [993](#L993) | $limit     = 30; |
| [994](#L994) |  |
| [995](#L995) | if ( ! empty( $post\_type ) ) { |
| [996](#L996) | if ( in\_array( $post\_type, array( 'tag', 'category', 'wc\_category', 'wc\_tag' ), true ) ) { |
| [997](#L997) | $args = array( |
| [998](#L998) | 'hide\_empty' => false, |
| [999](#L999) | 'number'     => $limit, |
| [1000](#L1000) | ); |
| [1001](#L1001) | if ( $search ) { |
| [1002](#L1002) | $args['search'] = $search; |
| [1003](#L1003) | } |
| [1004](#L1004) | if ( 'tag' === $post\_type ) { |
| [1005](#L1005) | $args['taxonomy'] = 'post\_tag'; |
| [1006](#L1006) | } elseif ( 'wc\_category' === $post\_type ) { |
| [1007](#L1007) | $args['taxonomy'] = 'product\_cat'; |
| [1008](#L1008) | } elseif ( 'wc\_tag' === $post\_type ) { |
| [1009](#L1009) | $args['taxonomy'] = 'product\_tag'; |
| [1010](#L1010) | } |
| [1011](#L1011) | $result = array\_map( array( 'Hustle\_Module\_Page\_Abstract', 'terms\_to\_select2\_data' ), get\_categories( $args ) ); |
| [1012](#L1012) | } else { |
| [1013](#L1013) | global $wpdb; |
| [1014](#L1014) | $result = $wpdb->get\_results( // phpcs:ignore |
| [1015](#L1015) | $wpdb->prepare( |
| [1016](#L1016) | "SELECT ID as id, post\_title as text FROM {$wpdb->posts} " |
| [1017](#L1017) | . "WHERE post\_type = %s AND post\_status = 'publish' AND post\_title LIKE %s LIMIT " . intval( $limit ), |
| [1018](#L1018) | $post\_type, |
| [1019](#L1019) | '%' . $search . '%' |
| [1020](#L1020) | ) |
| [1021](#L1021) | ); |
| [1022](#L1022) | } |
| [1023](#L1023) | } |
| [1024](#L1024) |  |
| [1025](#L1025) | wp\_send\_json\_success( $result ); |
| [1026](#L1026) | } |
| [1027](#L1027) |  |
| [1028](#L1028) | } |
| [1029](#L1029) |  |
| [1030](#L1030) | endif; |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php?format=txt)
* [Original Format](/export/3222506/wordpress-popup/trunk/inc/hustle-modules-common-admin-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


