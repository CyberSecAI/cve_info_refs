=== Content from plugins.trac.wordpress.org_d928b219_20250114_203015.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fhide-my-wp%2Ftags%2F5.3.01%2Fclasses%2FTools.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/hide-my-wp/tags/5.3.01/classes/Tools.php?rev=3169238 "Revision 3169238")
* Next Revision →
* [Blame](/browser/hide-my-wp/tags/5.3.01/classes/Tools.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/hide-my-wp/tags/5.3.01/classes/Tools.php)

---

# [source:](/browser?order=name "Go to repository root") [hide-my-wp](/browser/hide-my-wp?order=name "View hide-my-wp")/[tags](/browser/hide-my-wp/tags?order=name "View tags")/[5.3.01](/browser/hide-my-wp/tags/5.3.01?order=name "View 5.3.01")/[classes](/browser/hide-my-wp/tags/5.3.01/classes?order=name "View classes")/[Tools.php](/browser/hide-my-wp/tags/5.3.01/classes/Tools.php?order=name "View Tools.php")

View diff against:

View revision:

| [Last change](/changeset/3186493/hide-my-wp/tags/5.3.01/classes/Tools.php "View differences") on this file was [3186493](/changeset/3186493/ "View changeset 3186493"), checked in by johndarrel, [2 months ago](/timeline?from=2024-11-12T12%3A23%3A55Z&precision=second "See timeline at 11/12/2024 12:23:55 PM") |
| --- |
| Update plugin security |
| **File size:** 71.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Handles the parameters and URLs |
| [4](#L4) | \* |
| [5](#L5) | \* @file The Tools file |
| [6](#L6) | \* @package HMWP/Tools |
| [7](#L7) | \* @since 4.0.0 |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | defined( 'ABSPATH' ) || die( 'Cheatin\' uh?' ); |
| [11](#L11) |  |
| [12](#L12) | class HMWP\_Classes\_Tools { |
| [13](#L13) |  |
| [14](#L14) | /\*\* |
| [15](#L15) | \* Saved options in database. |
| [16](#L16) | \* |
| [17](#L17) | \* @var array |
| [18](#L18) | \*/ |
| [19](#L19) | public static $init = array(), $default = array(), $lite = array(); |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Configuration settings for the application. |
| [22](#L22) | \* |
| [23](#L23) | \* @var array |
| [24](#L24) | \*/ |
| [25](#L25) | public static $options = array(); |
| [26](#L26) | /\*\* |
| [27](#L27) | \* Stores debugging information and configurations. |
| [28](#L28) | \* |
| [29](#L29) | \* @var array |
| [30](#L30) | \*/ |
| [31](#L31) | public static $debug = array(); |
| [32](#L32) | /\*\* |
| [33](#L33) | \* List of active plugins in the system. |
| [34](#L34) | \* |
| [35](#L35) | \* @var array |
| [36](#L36) | \*/ |
| [37](#L37) | public static $active\_plugins; |
| [38](#L38) |  |
| [39](#L39) | /\*\* |
| [40](#L40) | \* Represents the role of the current user. |
| [41](#L41) | \* |
| [42](#L42) | \* @var string |
| [43](#L43) | \*/ |
| [44](#L44) | static $current\_user\_role = 'default'; |
| [45](#L45) |  |
| [46](#L46) | /\*\* |
| [47](#L47) | \* Plugin constructor to initialize options, load multilanguage support, and handle admin-specific tasks. |
| [48](#L48) | \* |
| [49](#L49) | \* @return void |
| [50](#L50) | \*/ |
| [51](#L51) | public function \_\_construct() { |
| [52](#L52) |  |
| [53](#L53) | // Get the plugin options from database |
| [54](#L54) | self::$options = self::getOptions(); |
| [55](#L55) |  |
| [56](#L56) | // Load multilanguage |
| [57](#L57) | add\_action( "init", array( $this, 'loadMultilanguage' ) ); |
| [58](#L58) |  |
| [59](#L59) | // If it's admin panel |
| [60](#L60) | if ( is\_admin() || is\_network\_admin() ) { |
| [61](#L61) | // Check the Plugin database update |
| [62](#L62) | self::updateDatabase(); |
| [63](#L63) |  |
| [64](#L64) | // Add setting link in plugin |
| [65](#L65) | add\_filter( 'plugin\_action\_links\_' . HMWP\_BASENAME, array( $this, 'hookActionlink' ) ); |
| [66](#L66) | add\_filter( 'network\_admin\_plugin\_action\_links\_' . HMWP\_BASENAME, array( $this, 'hookActionlink' ) ); |
| [67](#L67) |  |
| [68](#L68) | // Check plugin license |
| [69](#L69) | add\_action( 'request\_metadata\_http\_result', array( $this, 'checkLicenseOnUpdate' ) ); |
| [70](#L70) |  |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | } |
| [74](#L74) |  |
| [75](#L75) | /\*\* |
| [76](#L76) | \* Load the Options from user option table in DB |
| [77](#L77) | \* |
| [78](#L78) | \* @param  bool  $safe |
| [79](#L79) | \* |
| [80](#L80) | \* @return array |
| [81](#L81) | \*/ |
| [82](#L82) | public static function getOptions( $safe = false ) { |
| [83](#L83) | // Set key metadata based on safe parameter. |
| [84](#L84) | $keymeta = $safe ? HMWP\_OPTION\_SAFE : HMWP\_OPTION; |
| [85](#L85) |  |
| [86](#L86) | // Parse the site URL and plugin/content paths. |
| [87](#L87) | $homepath   = wp\_parse\_url( site\_url(), PHP\_URL\_PATH ) ? ltrim( wp\_parse\_url( site\_url(), PHP\_URL\_PATH ), '/' ) : ''; |
| [88](#L88) | $pluginurl  = ltrim( wp\_parse\_url( plugins\_url(), PHP\_URL\_PATH ), '/' ); |
| [89](#L89) | $contenturl = ltrim( wp\_parse\_url( content\_url(), PHP\_URL\_PATH ), '/' ); |
| [90](#L90) |  |
| [91](#L91) | // Get relative paths for plugin and content URLs. |
| [92](#L92) | $plugin\_relative\_url  = trim( preg\_replace( '/' . str\_replace( '/', '\/', $homepath ) . '/', '', $pluginurl, 1 ), '/' ); |
| [93](#L93) | $content\_relative\_url = trim( preg\_replace( '/' . str\_replace( '/', '\/', $homepath ) . '/', '', $contenturl, 1 ), '/' ); |
| [94](#L94) |  |
| [95](#L95) | // Set default options. |
| [96](#L96) | self::$init = array( |
| [97](#L97) | 'hmwp\_ver'                       => 0, |
| [98](#L98) | //-- |
| [99](#L99) | 'api\_token'                      => false, |
| [100](#L100) | 'hmwp\_token'                     => false, |
| [101](#L101) | //-- |
| [102](#L102) | 'hmwp\_valid'                     => 1, |
| [103](#L103) | 'hmwp\_expires'                   => 0, |
| [104](#L104) | 'hmwp\_disable'                   => HMWP\_Classes\_Tools::generateRandomString( 16 ), |
| [105](#L105) | 'hmwp\_disable\_name'              => HMWP\_Classes\_Tools::generateRandomString( 16 ), |
| [106](#L106) | //-- |
| [107](#L107) | 'hmwp\_plugin\_name'               => \_HMWP\_PLUGIN\_FULL\_NAME\_, |
| [108](#L108) | 'hmwp\_plugin\_menu'               => str\_replace( ' Ghost', '', \_HMWP\_PLUGIN\_FULL\_NAME\_ ), |
| [109](#L109) | 'hmwp\_plugin\_logo'               => false, |
| [110](#L110) | 'hmwp\_plugin\_icon'               => 'dashicons-shield-alt', |
| [111](#L111) | 'hmwp\_plugin\_website'            => 'https://hidemywpghost.com', |
| [112](#L112) | 'hmwp\_plugin\_account\_show'       => 1, |
| [113](#L113) | //-- |
| [114](#L114) | 'logout'                         => 0, |
| [115](#L115) | 'error'                          => 0, |
| [116](#L116) | 'file\_mappings'                  => array(), |
| [117](#L117) | 'test\_frontend'                  => 0, |
| [118](#L118) | 'changes'                        => 0, |
| [119](#L119) | 'admin\_notice'                   => array(), |
| [120](#L120) | 'prevent\_slow\_loading'           => 1, |
| [121](#L121) | 'hmwp\_rewrites\_in\_wp\_rules'      => 0, |
| [122](#L122) | 'hmwp\_server\_type'               => 'auto', |
| [123](#L123) | //-- |
| [124](#L124) | 'hmwp\_loading\_hook'              => array( 'normal' ), //load when the other plugins are initialized |
| [125](#L125) | 'hmwp\_firstload'                 => 0, //load the plugin as Must Use Plugin |
| [126](#L126) | 'hmwp\_priorityload'              => 0, //load the plugin on plugin start |
| [127](#L127) | 'hmwp\_laterload'                 => 0, //load the plugin on template redirect |
| [128](#L128) | //-- |
| [129](#L129) | 'hmwp\_fix\_relative'              => 0, |
| [130](#L130) | 'hmwp\_remove\_third\_hooks'        => 0, |
| [131](#L131) | 'hmwp\_send\_email'                => 0, |
| [132](#L132) | 'hmwp\_activity\_log'              => 0, |
| [133](#L133) | 'hmwp\_activity\_log\_roles'        => array(), |
| [134](#L134) | 'hmwp\_email\_address'             => '', |
| [135](#L135) |  |
| [136](#L136) | //-- Firewall |
| [137](#L137) | 'whitelist\_ip'                   => array(), |
| [138](#L138) | 'whitelist\_paths'                => 0, |
| [139](#L139) | 'whitelist\_urls'                 => array(), |
| [140](#L140) | 'banlist\_ip'                     => array(), |
| [141](#L141) | 'banlist\_hostname'               => array(), |
| [142](#L142) | 'banlist\_user\_agent'             => array(), |
| [143](#L143) | 'banlist\_referrer'               => array(), |
| [144](#L144) |  |
| [145](#L145) | //Temporary Login |
| [146](#L146) | 'hmwp\_templogin'                 => 0, |
| [147](#L147) | 'hmwp\_templogin\_role'            => 'administrator', |
| [148](#L148) | 'hmwp\_templogin\_redirect'        => false, |
| [149](#L149) | 'hmwp\_templogin\_delete\_uninstal' => false, |
| [150](#L150) |  |
| [151](#L151) | //Geoblock Login |
| [152](#L152) | 'hmwp\_geoblock'                  => 0, |
| [153](#L153) | 'hmwp\_geoblock\_countries'        => array(), |
| [154](#L154) | 'hmwp\_geoblock\_urls'             => array(), |
| [155](#L155) |  |
| [156](#L156) | //2FA Login |
| [157](#L157) | 'hmwp\_2falogin'                  => 0, |
| [158](#L158) | 'hmwp\_2falogin\_status'           => 1, |
| [159](#L159) | 'hmwp\_2fa\_totp'                  => 1, |
| [160](#L160) | 'hmwp\_2fa\_email'                 => 0, |
| [161](#L161) | 'hmwp\_2falogin\_max\_attempts'     => 5, |
| [162](#L162) | 'hmwp\_2falogin\_max\_timeout'      => 900, |
| [163](#L163) | 'hmwp\_2falogin\_message'          => '', |
| [164](#L164) | 'hmwp\_2falogin\_fail\_message'     => '', |
| [165](#L165) |  |
| [166](#L166) | //-- Brute Force |
| [167](#L167) | 'hmwp\_bruteforce'                => 0, |
| [168](#L168) | 'hmwp\_bruteforce\_register'       => 0, |
| [169](#L169) | 'hmwp\_bruteforce\_lostpassword'   => 0, |
| [170](#L170) | 'hmwp\_bruteforce\_comments'       => 0, |
| [171](#L171) | 'hmwp\_bruteforce\_woocommerce'    => 0, |
| [172](#L172) | 'hmwp\_bruteforce\_username'       => 0, |
| [173](#L173) | 'hmwp\_brute\_message'             => esc\_html\_\_( 'Your IP has been flagged for potential security violations. Please try again in a little while...', 'hide-my-wp' ), |
| [174](#L174) | 'hmwp\_hide\_classes'              => json\_encode( array() ), |
| [175](#L175) | 'trusted\_ip\_header'              => '', |
| [176](#L176) |  |
| [177](#L177) | //Unique Login |
| [178](#L178) | 'hmwp\_uniquelogin'               => 0, |
| [179](#L179) | 'hmwp\_uniquelogin\_woocommerce'   => 0, |
| [180](#L180) |  |
| [181](#L181) | //Math reCaptcha |
| [182](#L182) | 'brute\_use\_math'                 => 1, |
| [183](#L183) | 'brute\_max\_attempts'             => 5, |
| [184](#L184) | 'brute\_max\_timeout'              => 3600, |
| [185](#L185) | //reCaptcha V2 |
| [186](#L186) | 'brute\_use\_captcha'              => 0, |
| [187](#L187) | 'brute\_captcha\_site\_key'         => '', |
| [188](#L188) | 'brute\_captcha\_secret\_key'       => '', |
| [189](#L189) | 'brute\_captcha\_theme'            => 'light', |
| [190](#L190) | 'brute\_captcha\_language'         => '', |
| [191](#L191) | //reCaptcha V2 |
| [192](#L192) | 'brute\_use\_captcha\_v3'           => 0, |
| [193](#L193) | 'brute\_captcha\_site\_key\_v3'      => '', |
| [194](#L194) | 'brute\_captcha\_secret\_key\_v3'    => '', |
| [195](#L195) |  |
| [196](#L196) | //tweaks |
| [197](#L197) | 'hmwp\_hide\_admin\_toolbar'        => 0, |
| [198](#L198) | 'hmwp\_hide\_admin\_toolbar\_roles'  => array( 'customer', 'subscriber' ), |
| [199](#L199) | //-- |
| [200](#L200) | 'hmwp\_change\_in\_cache'           => ( ( defined( 'WP\_CACHE' ) && WP\_CACHE ) ? 1 : 0 ), |
| [201](#L201) | 'hmwp\_change\_in\_cache\_directory' => '', |
| [202](#L202) | 'hmwp\_hide\_loggedusers'          => 1, |
| [203](#L203) | 'hmwp\_hide\_version'              => 1, |
| [204](#L204) | 'hmwp\_hide\_version\_random'       => 1, |
| [205](#L205) | 'hmwp\_hide\_generator'            => 1, |
| [206](#L206) | 'hmwp\_hide\_prefetch'             => 1, |
| [207](#L207) | 'hmwp\_hide\_comments'             => 1, |
| [208](#L208) | 'hmwp\_hide\_wp\_text'              => 0, |
| [209](#L209) |  |
| [210](#L210) | 'hmwp\_hide\_feed'              => 0, |
| [211](#L211) | 'hmwp\_hide\_in\_feed'           => 0, |
| [212](#L212) | 'hmwp\_hide\_in\_sitemap'        => 0, |
| [213](#L213) | 'hmwp\_hide\_author\_in\_sitemap' => 1, |
| [214](#L214) | 'hmwp\_robots'                 => 0, |
| [215](#L215) |  |
| [216](#L216) | 'hmwp\_disable\_emojicons'         => 0, |
| [217](#L217) | 'hmwp\_disable\_manifest'          => 1, |
| [218](#L218) | 'hmwp\_disable\_embeds'            => 0, |
| [219](#L219) | 'hmwp\_disable\_debug'             => 1, |
| [220](#L220) | //-- |
| [221](#L221) | 'hmwp\_disable\_click'             => 0, |
| [222](#L222) | 'hmwp\_disable\_click\_loggedusers' => 0, |
| [223](#L223) | 'hmwp\_disable\_click\_roles'       => array( 'subscriber' ), |
| [224](#L224) | 'hmwp\_disable\_click\_message'     => "Right click is disabled!", |
| [225](#L225) |  |
| [226](#L226) | 'hmwp\_disable\_inspect'             => 0, |
| [227](#L227) | 'hmwp\_disable\_inspect\_blank'       => 0, |
| [228](#L228) | 'hmwp\_disable\_inspect\_loggedusers' => 0, |
| [229](#L229) | 'hmwp\_disable\_inspect\_roles'       => array( 'subscriber' ), |
| [230](#L230) | 'hmwp\_disable\_inspect\_message'     => "Inspect Element is disabled!", |
| [231](#L231) |  |
| [232](#L232) | 'hmwp\_disable\_source'             => 0, |
| [233](#L233) | 'hmwp\_disable\_source\_loggedusers' => 0, |
| [234](#L234) | 'hmwp\_disable\_source\_roles'       => array( 'subscriber' ), |
| [235](#L235) | 'hmwp\_disable\_source\_message'     => "View Source is disabled!", |
| [236](#L236) |  |
| [237](#L237) | 'hmwp\_disable\_copy\_paste'             => 0, |
| [238](#L238) | 'hmwp\_disable\_paste'                  => 1, |
| [239](#L239) | 'hmwp\_disable\_copy\_paste\_loggedusers' => 0, |
| [240](#L240) | 'hmwp\_disable\_copy\_paste\_roles'       => array( 'subscriber' ), |
| [241](#L241) | 'hmwp\_disable\_copy\_paste\_message'     => "Copy/Paste is disabled!", |
| [242](#L242) |  |
| [243](#L243) | 'hmwp\_disable\_drag\_drop'             => 0, |
| [244](#L244) | 'hmwp\_disable\_drag\_drop\_loggedusers' => 0, |
| [245](#L245) | 'hmwp\_disable\_drag\_drop\_roles'       => array( 'subscriber' ), |
| [246](#L246) | 'hmwp\_disable\_drag\_drop\_message'     => "Drag-n-Drop is disabled!", |
| [247](#L247) |  |
| [248](#L248) | 'hmwp\_disable\_recording'             => 0, |
| [249](#L249) | 'hmwp\_disable\_recording\_loggedusers' => 0, |
| [250](#L250) | 'hmwp\_disable\_recording\_roles'       => array( 'subscriber' ), |
| [251](#L251) | 'hmwp\_disable\_recording\_message'     => "Screen Recording is disabled!", |
| [252](#L252) | //-- |
| [253](#L253) | 'hmwp\_disable\_screen\_capture'        => 0, |
| [254](#L254) | 'hmwp\_file\_cache'                    => 0, |
| [255](#L255) | 'hmwp\_url\_mapping'                   => json\_encode( array() ), |
| [256](#L256) | 'hmwp\_mapping\_classes'               => 1, |
| [257](#L257) | 'hmwp\_mapping\_file'                  => 0, |
| [258](#L258) | 'hmwp\_text\_mapping'                  => json\_encode( array( |
| [259](#L259) | 'from' => array(), |
| [260](#L260) | 'to'   => array(), |
| [261](#L261) | ) ), |
| [262](#L262) | 'hmwp\_cdn\_urls'                      => json\_encode( array() ), |
| [263](#L263) | 'hmwp\_security\_alert'                => 1, |
| [264](#L264) | //-- |
| [265](#L265) | 'hmwp\_hide\_plugins\_advanced'         => 0, |
| [266](#L266) | 'hmwp\_hide\_themes\_advanced'          => 0, |
| [267](#L267) | //-- |
| [268](#L268) |  |
| [269](#L269) | //redirects |
| [270](#L270) | 'hmwp\_url\_redirect'                  => 'NFError', |
| [271](#L271) | 'hmwp\_do\_redirects'                  => 0, |
| [272](#L272) | 'hmwp\_logged\_users\_redirect'         => 0, |
| [273](#L273) | 'hmwp\_url\_redirects'                 => array( 'default' => array( 'login' => '', 'logout' => '' ) ), |
| [274](#L274) | 'hmwp\_signup\_template'               => 0, |
| [275](#L275) |  |
| [276](#L276) | 'hmwp\_mapping\_text\_show' => 1, |
| [277](#L277) | 'hmwp\_mapping\_url\_show'  => 1, |
| [278](#L278) | 'hmwp\_mapping\_cdn\_show'  => 1, |
| [279](#L279) |  |
| [280](#L280) | ); |
| [281](#L281) |  |
| [282](#L282) | // Set WordPress options when security is disables. |
| [283](#L283) | self::$default = array( |
| [284](#L284) | 'hmwp\_mode'             => 'default', |
| [285](#L285) | 'hmwp\_admin\_url'        => 'wp-admin', |
| [286](#L286) | 'hmwp\_login\_url'        => 'wp-login.php', |
| [287](#L287) | 'hmwp\_activate\_url'     => 'wp-activate.php', |
| [288](#L288) | 'hmwp\_lostpassword\_url' => '', |
| [289](#L289) | 'hmwp\_register\_url'     => '', |
| [290](#L290) | 'hmwp\_logout\_url'       => '', |
| [291](#L291) |  |
| [292](#L292) | 'hmwp\_plugin\_url'                => $plugin\_relative\_url, |
| [293](#L293) | 'hmwp\_plugins'                   => array(), |
| [294](#L294) | 'hmwp\_themes\_url'                => 'themes', |
| [295](#L295) | 'hmwp\_themes'                    => array(), |
| [296](#L296) | 'hmwp\_upload\_url'                => 'uploads', |
| [297](#L297) | 'hmwp\_admin-ajax\_url'            => 'admin-ajax.php', |
| [298](#L298) | 'hmwp\_wp-signup\_url'             => 'wp-signup.php', |
| [299](#L299) | 'hmwp\_hideajax\_paths'            => 0, |
| [300](#L300) | 'hmwp\_hideajax\_admin'            => 0, |
| [301](#L301) | 'hmwp\_tags\_url'                  => 'tag', |
| [302](#L302) | 'hmwp\_wp-content\_url'            => $content\_relative\_url, |
| [303](#L303) | 'hmwp\_wp-includes\_url'           => 'wp-includes', |
| [304](#L304) | 'hmwp\_author\_url'                => 'author', |
| [305](#L305) | 'hmwp\_hide\_authors'              => 0, |
| [306](#L306) | 'hmwp\_wp-comments-post'          => 'wp-comments-post.php', |
| [307](#L307) | 'hmwp\_themes\_style'              => 'style.css', |
| [308](#L308) | 'hmwp\_hide\_img\_classes'          => 0, |
| [309](#L309) | 'hmwp\_hide\_styleids'             => 0, |
| [310](#L310) | 'hmwp\_noncekey'                  => '\_wpnonce', |
| [311](#L311) | 'hmwp\_wp-json'                   => 'wp-json', |
| [312](#L312) | 'hmwp\_hide\_rest\_api'             => 0, |
| [313](#L313) | 'hmwp\_disable\_rest\_api'          => 0, |
| [314](#L314) | 'hmwp\_disable\_rest\_api\_param'    => 0, |
| [315](#L315) | 'hmwp\_disable\_xmlrpc'            => 0, |
| [316](#L316) | 'hmwp\_hide\_rsd'                  => 0, |
| [317](#L317) | 'hmwp\_hide\_admin'                => 0, |
| [318](#L318) | 'hmwp\_hide\_newadmin'             => 0, |
| [319](#L319) | 'hmwp\_hide\_admin\_loggedusers'    => 0, |
| [320](#L320) | 'hmwp\_hide\_login'                => 0, |
| [321](#L321) | 'hmwp\_hide\_wplogin'              => 0, |
| [322](#L322) | 'hmwp\_hide\_newlogin'             => 0, |
| [323](#L323) | 'hmwp\_disable\_language\_switcher' => 0, |
| [324](#L324) | 'hmwp\_hide\_plugins'              => 0, |
| [325](#L325) | 'hmwp\_hide\_all\_plugins'          => 0, |
| [326](#L326) | 'hmwp\_hide\_themes'               => 0, |
| [327](#L327) | 'hmwp\_emulate\_cms'               => '', |
| [328](#L328) |  |
| [329](#L329) | //--secure headers |
| [330](#L330) | 'hmwp\_sqlinjection'              => 0, |
| [331](#L331) | 'hmwp\_sqlinjection\_location'     => 'onload', |
| [332](#L332) | 'hmwp\_sqlinjection\_level'        => 2, |
| [333](#L333) | 'hmwp\_security\_header'           => 0, |
| [334](#L334) | 'hmwp\_hide\_unsafe\_headers'       => 0, |
| [335](#L335) | 'hmwp\_security\_headers'          => array( |
| [336](#L336) | "Strict-Transport-Security" => "max-age=15768000;includeSubdomains", |
| [337](#L337) | "Content-Security-Policy"   => "object-src 'none'", |
| [338](#L338) | "X-XSS-Protection"          => "1; mode=block", |
| [339](#L339) | ), |
| [340](#L340) | //-- |
| [341](#L341) | 'hmwp\_detectors\_block'           => 0, |
| [342](#L342) | 'hmwp\_hide\_commonfiles'          => 0, |
| [343](#L343) | 'hmwp\_disable\_browsing'          => 0, |
| [344](#L344) | 'hmwp\_hide\_oldpaths'             => 0, |
| [345](#L345) | 'hmwp\_hide\_oldpaths\_plugins'     => 0, |
| [346](#L346) | 'hmwp\_hide\_oldpaths\_themes'      => 0, |
| [347](#L347) | 'hmwp\_hide\_oldpaths\_types'       => array( 'css', 'js', 'php', 'txt', 'html' ), |
| [348](#L348) | 'hmwp\_hide\_commonfiles\_files'    => array( |
| [349](#L349) | 'wp-config-sample.php', |
| [350](#L350) | 'readme.html', |
| [351](#L351) | 'readme.txt', |
| [352](#L352) | 'install.php', |
| [353](#L353) | 'license.txt', |
| [354](#L354) | 'php.ini', |
| [355](#L355) | 'upgrade.php', |
| [356](#L356) | 'bb-config.php', |
| [357](#L357) | 'error\_log' |
| [358](#L358) | ), |
| [359](#L359) | // |
| [360](#L360) | 'hmwp\_category\_base'             => '', |
| [361](#L361) | 'hmwp\_tag\_base'                  => '', |
| [362](#L362) | // |
| [363](#L363) | ); |
| [364](#L364) |  |
| [365](#L365) | // Set options for "Lite Mode". |
| [366](#L366) | self::$lite = array( |
| [367](#L367) | 'hmwp\_mode'                      => 'lite', |
| [368](#L368) | 'hmwp\_login\_url'                 => 'newlogin', |
| [369](#L369) | 'hmwp\_activate\_url'              => 'activate', |
| [370](#L370) | 'hmwp\_lostpassword\_url'          => 'lostpass', |
| [371](#L371) | 'hmwp\_register\_url'              => 'register', |
| [372](#L372) | 'hmwp\_logout\_url'                => '', |
| [373](#L373) | 'hmwp\_admin-ajax\_url'            => 'admin-ajax.php', |
| [374](#L374) | 'hmwp\_hideajax\_admin'            => 0, |
| [375](#L375) | 'hmwp\_hideajax\_paths'            => 0, |
| [376](#L376) | 'hmwp\_plugin\_url'                => 'core/modules', |
| [377](#L377) | 'hmwp\_themes\_url'                => 'core/views', |
| [378](#L378) | 'hmwp\_upload\_url'                => 'storage', |
| [379](#L379) | 'hmwp\_wp-content\_url'            => 'core', |
| [380](#L380) | 'hmwp\_wp-includes\_url'           => 'lib', |
| [381](#L381) | 'hmwp\_author\_url'                => 'writer', |
| [382](#L382) | 'hmwp\_hide\_authors'              => 1, |
| [383](#L383) | 'hmwp\_wp-comments-post'          => 'comments', |
| [384](#L384) | 'hmwp\_themes\_style'              => 'design.css', |
| [385](#L385) | 'hmwp\_wp-json'                   => 'wp-json', |
| [386](#L386) | 'hmwp\_hide\_admin'                => 1, |
| [387](#L387) | 'hmwp\_hide\_newadmin'             => 0, |
| [388](#L388) | 'hmwp\_hide\_admin\_loggedusers'    => 0, |
| [389](#L389) | 'hmwp\_hide\_login'                => 1, |
| [390](#L390) | 'hmwp\_hide\_wplogin'              => 1, |
| [391](#L391) | 'hmwp\_hide\_newlogin'             => 1, |
| [392](#L392) | 'hmwp\_disable\_language\_switcher' => 0, |
| [393](#L393) | 'hmwp\_hide\_plugins'              => 1, |
| [394](#L394) | 'hmwp\_hide\_all\_plugins'          => 0, |
| [395](#L395) | 'hmwp\_hide\_themes'               => 1, |
| [396](#L396) | 'hmwp\_emulate\_cms'               => 'drupal11', |
| [397](#L397) | // |
| [398](#L398) | 'hmwp\_hide\_img\_classes'          => 1, |
| [399](#L399) | 'hmwp\_hide\_rest\_api'             => 1, |
| [400](#L400) | 'hmwp\_disable\_rest\_api'          => 0, |
| [401](#L401) | 'hmwp\_disable\_rest\_api\_param'    => 1, |
| [402](#L402) | 'hmwp\_disable\_xmlrpc'            => 1, |
| [403](#L403) | 'hmwp\_hide\_rsd'                  => 1, |
| [404](#L404) | // |
| [405](#L405) | 'hmwp\_sqlinjection'              => 1, |
| [406](#L406) | 'hmwp\_security\_header'           => 1, |
| [407](#L407) | 'hmwp\_hide\_unsafe\_headers'       => 1, |
| [408](#L408) | 'hmwp\_detectors\_block'           => 1, |
| [409](#L409) |  |
| [410](#L410) | //PRO |
| [411](#L411) | 'hmwp\_hide\_styleids'             => 0, |
| [412](#L412) | 'hmwp\_disable\_browsing'          => 0, |
| [413](#L413) | 'hmwp\_hide\_commonfiles'          => 0, |
| [414](#L414) | 'hmwp\_hide\_oldpaths'             => 0, |
| [415](#L415) | 'hmwp\_hide\_oldpaths\_plugins'     => 0, |
| [416](#L416) | 'hmwp\_hide\_oldpaths\_themes'      => 0, |
| [417](#L417) | ); |
| [418](#L418) |  |
| [419](#L419) | // Fetch the options based on whether it's a multisite and merge with defaults. |
| [420](#L420) | if ( self::isMultisites() && defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) { |
| [421](#L421) | $options = json\_decode( get\_blog\_option( BLOG\_ID\_CURRENT\_SITE, $keymeta ), true ); |
| [422](#L422) | } else { |
| [423](#L423) | $options = json\_decode( get\_option( $keymeta ), true ); |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | // Ensure compatibility with WP Client plugin. |
| [427](#L427) | if ( self::isPluginActive( 'wp-client/wp-client.php' ) ) { |
| [428](#L428) | self::$lite['hmwp\_wp-content\_url'] = 'include'; |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | // Merge the options with initial and default values. |
| [432](#L432) | if ( is\_array( $options ) ) { |
| [433](#L433) | $options = @array\_merge( self::$init, self::$default, $options ); |
| [434](#L434) | } else { |
| [435](#L435) | $options = @array\_merge( self::$init, self::$default ); |
| [436](#L436) | } |
| [437](#L437) |  |
| [438](#L438) | // Validate the custom cache directory and reset if it contains 'wp-content'. |
| [439](#L439) | if ( isset( $options['hmwp\_change\_in\_cache\_directory'] ) && $options['hmwp\_change\_in\_cache\_directory'] <> '' ) { |
| [440](#L440) | if ( strpos( $options['hmwp\_change\_in\_cache\_directory'], 'wp-content' ) !== false ) { |
| [441](#L441) | $options['hmwp\_change\_in\_cache\_directory'] = ''; |
| [442](#L442) | } |
| [443](#L443) | } |
| [444](#L444) |  |
| [445](#L445) | // Update the whitelist level based on whitelist paths setting. |
| [446](#L446) | if ( isset( $options['whitelist\_paths'] ) && ! isset( $options['whitelist\_level'] ) ) { |
| [447](#L447) | $options['whitelist\_level'] = ( $options['whitelist\_paths'] == 1 ? 2 : 1 ); |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | // Set the category and tag bases considering multisite setup. |
| [451](#L451) | $category\_base = get\_option( 'category\_base' ); |
| [452](#L452) | $tag\_base      = get\_option( 'tag\_base' ); |
| [453](#L453) |  |
| [454](#L454) | if ( self::isMultisites() && ! is\_subdomain\_install() && is\_main\_site() && 0 === strpos( get\_option( 'permalink\_structure' ), '/blog/' ) ) { |
| [455](#L455) | $category\_base = preg\_replace( '|^/?blog|', '', $category\_base ); |
| [456](#L456) | $tag\_base      = preg\_replace( '|^/?blog|', '', $tag\_base ); |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) | $options['hmwp\_category\_base'] = $category\_base; |
| [460](#L460) | $options['hmwp\_tag\_base']      = $tag\_base; |
| [461](#L461) |  |
| [462](#L462) | // Set priority and rewrite rules settings if defined constants are set. |
| [463](#L463) | if ( HMW\_PRIORITY ) { |
| [464](#L464) | $options['hmwp\_priorityload'] = 1; |
| [465](#L465) | } |
| [466](#L466) | if ( HMW\_RULES\_IN\_WP\_RULES ) { |
| [467](#L467) | $options['hmwp\_rewrites\_in\_wp\_rules'] = 1; |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | // Return the final options array. |
| [471](#L471) | return $options; |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | /\*\* |
| [475](#L475) | \* Update the database configuration and options for the plugin. |
| [476](#L476) | \* |
| [477](#L477) | \* This method is called during a plugin update to migrate existing settings and set new defaults. |
| [478](#L478) | \* It handles various tasks such as upgrading from a lite version, migrating specific options, |
| [479](#L479) | \* and initializing default values where necessary. |
| [480](#L480) | \* |
| [481](#L481) | \* @return void |
| [482](#L482) | \*/ |
| [483](#L483) | private static function updateDatabase() { |
| [484](#L484) | // Check if the plugin version is updated |
| [485](#L485) | if ( self::$options['hmwp\_ver'] < HMWP\_VERSION\_ID ) { |
| [486](#L486) |  |
| [487](#L487) | // Upgrade from Old Version if hmwp\_options exist in the database |
| [488](#L488) | if ( get\_option( 'hmw\_options' ) ) { |
| [489](#L489) | $options = json\_decode( get\_option( 'hmw\_options' ), true ); |
| [490](#L490) | // If options are not empty, migrate them to the new format |
| [491](#L491) | if ( ! empty( $options ) ) { |
| [492](#L492) | foreach ( $options as $key => $value ) { |
| [493](#L493) | self::$options[ str\_replace( 'hmw\_', 'hmwp\_', $key ) ] = $value; |
| [494](#L494) | } |
| [495](#L495) | } |
| [496](#L496) | // Delete old options to prevent conflicts |
| [497](#L497) | delete\_option( 'hmw\_options' ); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | // Set default value for hmwp\_hide\_wplogin if it's not set and hmwp\_hide\_login is set |
| [501](#L501) | if ( ! isset( self::$options['hmwp\_hide\_wplogin'] ) && isset( self::$options['hmwp\_hide\_login'] ) && self::$options['hmwp\_hide\_login'] ) { |
| [502](#L502) | self::$options['hmwp\_hide\_wplogin'] = self::$options['hmwp\_hide\_login']; |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | // Initialize the account show option if not set |
| [506](#L506) | if ( ! isset( self::$options['hmwp\_plugin\_account\_show'] ) ) { |
| [507](#L507) | self::$options['hmwp\_plugin\_account\_show'] = 1; |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | // Upgrade logout redirect options to the new format |
| [511](#L511) | if ( isset( self::$options['hmwp\_logout\_redirect'] ) && self::$options['hmwp\_logout\_redirect'] ) { |
| [512](#L512) | self::$options['hmwp\_url\_redirects']['default']['logout'] = self::$options['hmwp\_logout\_redirect']; |
| [513](#L513) | unset( self::$options['hmwp\_logout\_redirect'] ); |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | // Upgrade admin toolbar visibility option to the new format |
| [517](#L517) | if ( isset( self::$options['hmwp\_in\_dashboard'] ) && self::$options['hmwp\_in\_dashboard'] ) { |
| [518](#L518) | self::$options['hmwp\_hide\_admin\_toolbar'] = self::$options['hmwp\_in\_dashboard']; |
| [519](#L519) | unset( self::$options['hmwp\_in\_dashboard'] ); |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | // Upgrade sitemap visibility option to the new format |
| [523](#L523) | if ( isset( self::$options['hmwp\_shutdownload'] ) && self::$options['hmwp\_shutdownload'] ) { |
| [524](#L524) | self::$options['hmwp\_hide\_in\_sitemap'] = self::$options['hmwp\_shutdownload']; |
| [525](#L525) | unset( self::$options['hmwp\_shutdownload'] ); |
| [526](#L526) | } |
| [527](#L527) |  |
| [528](#L528) | // Remove old whitelist\_paths option |
| [529](#L529) | if ( isset( self::$options['whitelist\_paths'] ) ) { |
| [530](#L530) | unset( self::$options['whitelist\_paths'] ); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | // Update the login paths on Cloud when the plugin is updated |
| [534](#L534) | self::sendLoginPathsApi(); |
| [535](#L535) |  |
| [536](#L536) | // Set the current version ID |
| [537](#L537) | self::$options['hmwp\_ver'] = HMWP\_VERSION\_ID; |
| [538](#L538) | // Save updated options |
| [539](#L539) | self::saveOptions(); |
| [540](#L540) | } |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | /\*\* |
| [544](#L544) | \* Get the default value for a given key |
| [545](#L545) | \* |
| [546](#L546) | \* @param  string  $key  The key for which default value is to be retrieved |
| [547](#L547) | \* |
| [548](#L548) | \* @return mixed The default value associated with the key, or false if the key does not exist |
| [549](#L549) | \* @since 5.0.19 |
| [550](#L550) | \*/ |
| [551](#L551) | public static function getDefault( $key ) { |
| [552](#L552) | if ( isset( self::$default[ $key ] ) ) { |
| [553](#L553) | return self::$default[ $key ]; |
| [554](#L554) | } |
| [555](#L555) |  |
| [556](#L556) | return false; |
| [557](#L557) |  |
| [558](#L558) | } |
| [559](#L559) |  |
| [560](#L560) | /\*\* |
| [561](#L561) | \* Retrieve an option value by key. |
| [562](#L562) | \* |
| [563](#L563) | \* @param  string  $key  The key for the option to retrieve. |
| [564](#L564) | \* |
| [565](#L565) | \* @return mixed The value of the option, possibly filtered. |
| [566](#L566) | \*/ |
| [567](#L567) | public static function getOption( $key ) { |
| [568](#L568) | if ( ! isset( self::$options[ $key ] ) ) { |
| [569](#L569) | self::$options = self::getOptions(); |
| [570](#L570) |  |
| [571](#L571) | if ( ! isset( self::$options[ $key ] ) ) { |
| [572](#L572) | self::$options[ $key ] = 0; |
| [573](#L573) | } |
| [574](#L574) | } |
| [575](#L575) |  |
| [576](#L576) | return apply\_filters( 'hmwp\_option\_' . $key, self::$options[ $key ] ); |
| [577](#L577) | } |
| [578](#L578) |  |
| [579](#L579) | /\*\* |
| [580](#L580) | \* Save the specified options in the WordPress options table |
| [581](#L581) | \* |
| [582](#L582) | \* @param  string|null  $key  The key of the option to save. If null, no key will be set. |
| [583](#L583) | \* @param  mixed  $value  The value of the option to save. |
| [584](#L584) | \* @param  bool  $safe  Whether to save the option safely or not. |
| [585](#L585) | \* |
| [586](#L586) | \* @return void |
| [587](#L587) | \*/ |
| [588](#L588) | public static function saveOptions( $key = null, $value = '', $safe = false ) { |
| [589](#L589) | // Default option key |
| [590](#L590) | $keymeta = HMWP\_OPTION; |
| [591](#L591) |  |
| [592](#L592) | // Use a different option key if the $safe parameter is true |
| [593](#L593) | if ( $safe ) { |
| [594](#L594) | $keymeta = HMWP\_OPTION\_SAFE; |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | // If a specific key is provided, update the value in the options array |
| [598](#L598) | if ( isset( $key ) ) { |
| [599](#L599) | self::$options[ $key ] = $value; |
| [600](#L600) | } |
| [601](#L601) |  |
| [602](#L602) | // If the site is a multisite and BLOG\_ID\_CURRENT\_SITE is defined |
| [603](#L603) | if ( self::isMultisites() && defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) { |
| [604](#L604) | // Update the option for the current blog in the network |
| [605](#L605) | update\_blog\_option( BLOG\_ID\_CURRENT\_SITE, $keymeta, json\_encode( self::$options ) ); |
| [606](#L606) | } else { |
| [607](#L607) | // Otherwise, update the option normally |
| [608](#L608) | update\_option( $keymeta, json\_encode( self::$options ) ); |
| [609](#L609) | } |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | /\*\* |
| [613](#L613) | \* Save the current working options into a backup storage. |
| [614](#L614) | \* |
| [615](#L615) | \* @return void |
| [616](#L616) | \*/ |
| [617](#L617) | public static function saveOptionsBackup() { |
| [618](#L618) | // Save the working options into backup |
| [619](#L619) | foreach ( self::$options as $key => $value ) { |
| [620](#L620) | HMWP\_Classes\_Tools::saveOptions( $key, $value, true ); |
| [621](#L621) | } |
| [622](#L622) | } |
| [623](#L623) |  |
| [624](#L624) | /\*\* |
| [625](#L625) | \* Add a link to settings in the plugin list |
| [626](#L626) | \* |
| [627](#L627) | \* @param  array  $links |
| [628](#L628) | \* |
| [629](#L629) | \* @return array |
| [630](#L630) | \*/ |
| [631](#L631) | public function hookActionlink( $links ) { |
| [632](#L632) | if ( get\_transient( 'hmwp\_disable' ) ) { |
| [633](#L633) | $links[] = '<a href="' . esc\_url( add\_query\_arg( array( 'hmwp\_nonce' => wp\_create\_nonce( 'hmwp\_pause\_disable' ), 'action' => 'hmwp\_pause\_disable' ) ) ) . '" class="btn btn-default btn-sm mt-3" />' . esc\_html\_\_( "Resume Security", 'hide-my-wp' ) . '</a>'; |
| [634](#L634) | } else { |
| [635](#L635) | $links[] = '<a href="' . esc\_url( add\_query\_arg( array( 'hmwp\_nonce' => wp\_create\_nonce( 'hmwp\_pause\_enable' ), 'action' => 'hmwp\_pause\_enable' ) ) ) . '" class="btn btn-default btn-sm mt-3" />' . esc\_html\_\_( "Pause for 5 minutes", 'hide-my-wp' ) . '</a>'; |
| [636](#L636) | } |
| [637](#L637) | $links[] = '<a href="' . esc\_url( self::getSettingsUrl() ) . '">' . esc\_html\_\_( 'Settings', 'hide-my-wp' ) . '</a>'; |
| [638](#L638) | $links[] = '<a href="https://hidemywpghost.com/hide-my-wp-pricing/" target="\_blank" style="font-weight: bold;color: #007cba">' . esc\_html\_\_( 'Go PRO', 'hide-my-wp' ) . '</a>'; |
| [639](#L639) |  |
| [640](#L640) | return array\_reverse( $links ); |
| [641](#L641) | } |
| [642](#L642) |  |
| [643](#L643) |  |
| [644](#L644) | /\*\* |
| [645](#L645) | \* Load the plugin text domain for multilanguage support. |
| [646](#L646) | \* |
| [647](#L647) | \* @return void |
| [648](#L648) | \*/ |
| [649](#L649) | public static function loadMultilanguage() { |
| [650](#L650) | load\_plugin\_textdomain( dirname( HMWP\_BASENAME ), false, dirname( HMWP\_BASENAME ) . '/languages/' ); |
| [651](#L651) | } |
| [652](#L652) |  |
| [653](#L653) | /\*\* |
| [654](#L654) | \* Check if it's Rest Api call |
| [655](#L655) | \* |
| [656](#L656) | \* @return bool |
| [657](#L657) | \*/ |
| [658](#L658) | public static function isApi() { |
| [659](#L659) | if ( isset( $\_SERVER['REQUEST\_URI'] ) && strpos( $\_SERVER['REQUEST\_URI'], '/' . HMWP\_Classes\_Tools::getOption( 'hmwp\_wp-json' ) . '/' ) !== false ) { |
| [660](#L660) | return true; |
| [661](#L661) | } |
| [662](#L662) |  |
| [663](#L663) | return false; |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | /\*\* |
| [667](#L667) | \* Check if it's Ajax call |
| [668](#L668) | \* |
| [669](#L669) | \* @return bool |
| [670](#L670) | \*/ |
| [671](#L671) | public static function isAjax() { |
| [672](#L672) | if ( defined( 'DOING\_AJAX' ) && DOING\_AJAX ) { |
| [673](#L673) | return true; |
| [674](#L674) | } |
| [675](#L675) |  |
| [676](#L676) | return false; |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | /\*\* |
| [680](#L680) | \* Check if it's Cron call |
| [681](#L681) | \* |
| [682](#L682) | \* @return bool |
| [683](#L683) | \*/ |
| [684](#L684) | public static function isCron() { |
| [685](#L685) | if ( defined( 'DOING\_CRON' ) && DOING\_CRON ) { |
| [686](#L686) | return true; |
| [687](#L687) | } |
| [688](#L688) |  |
| [689](#L689) | return false; |
| [690](#L690) | } |
| [691](#L691) |  |
| [692](#L692) | /\*\* |
| [693](#L693) | \* Check if it's valid to load firewall on the page |
| [694](#L694) | \* |
| [695](#L695) | \* @return bool |
| [696](#L696) | \*/ |
| [697](#L697) | public static function doFirewall() { |
| [698](#L698) |  |
| [699](#L699) | //If allways change paths admin & frontend |
| [700](#L700) | if ( defined( 'HMW\_ALWAYS\_RUN\_FIREWALL' ) && HMW\_ALWAYS\_RUN\_FIREWALL ) { |
| [701](#L701) | return true; |
| [702](#L702) | } |
| [703](#L703) |  |
| [704](#L704) | //If firewall process is activated |
| [705](#L705) | if ( ! apply\_filters( 'hmwp\_process\_firewall', true ) ) { |
| [706](#L706) | return false; |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | if ( HMWP\_Classes\_Tools::isApi() ) { |
| [710](#L710) | return false; |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | //If not admin |
| [714](#L714) | if ( ! is\_admin() && ! is\_network\_admin() ) { |
| [715](#L715) | //if user is not logged in |
| [716](#L716) | if ( function\_exists( 'is\_user\_logged\_in' ) && ! is\_user\_logged\_in() ) { |
| [717](#L717) | return true; |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | } |
| [721](#L721) |  |
| [722](#L722) | return false; |
| [723](#L723) | } |
| [724](#L724) |  |
| [725](#L725) | /\*\* |
| [726](#L726) | \* Check if it's valid for changing the paths |
| [727](#L727) | \* Change the paths in admin, logged users or visitors |
| [728](#L728) | \* |
| [729](#L729) | \* @return bool |
| [730](#L730) | \*/ |
| [731](#L731) | public static function doChangePaths() { |
| [732](#L732) |  |
| [733](#L733) | //If allways change paths admin & frontend |
| [734](#L734) | if ( HMW\_ALWAYS\_CHANGE\_PATHS ) { |
| [735](#L735) | return true; |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | if ( HMWP\_Classes\_Tools::isApi() ) { |
| [739](#L739) | return false; |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) | //If not admin |
| [743](#L743) | if ( ( ! is\_admin() && ! is\_network\_admin() ) || HMWP\_Classes\_Tools::isAjax() ) { |
| [744](#L744) |  |
| [745](#L745) | //if process the change paths |
| [746](#L746) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_hide\_loggedusers' ) || ( function\_exists( 'is\_user\_logged\_in' ) && ! is\_user\_logged\_in() ) ) { |
| [747](#L747) | return true; |
| [748](#L748) | } |
| [749](#L749) |  |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | return false; |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | /\*\* |
| [756](#L756) | \* Check if it's valid for hiding and disable things in site |
| [757](#L757) | \* |
| [758](#L758) | \* @return bool |
| [759](#L759) | \*/ |
| [760](#L760) | public static function doHideDisable() { |
| [761](#L761) |  |
| [762](#L762) | //Check if is valid for moving on |
| [763](#L763) | if ( ! apply\_filters( 'hmwp\_process\_hide\_disable', true ) ) { |
| [764](#L764) | return false; |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | if ( defined( 'DOING\_CRON' ) && DOING\_CRON ) { |
| [768](#L768) | return false; |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | if ( HMWP\_Classes\_Tools::isAjax() || HMWP\_Classes\_Tools::isApi() ) { |
| [772](#L772) | return false; |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | //If not admin |
| [776](#L776) | if ( ! is\_admin() && ! is\_network\_admin() ) { |
| [777](#L777) | //if process the change paths |
| [778](#L778) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_hide\_loggedusers' ) || ( function\_exists( 'is\_user\_logged\_in' ) && ! is\_user\_logged\_in() ) ) { |
| [779](#L779) | return true; |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | } |
| [783](#L783) |  |
| [784](#L784) | return false; |
| [785](#L785) | } |
| [786](#L786) |  |
| [787](#L787) | /\*\* |
| [788](#L788) | \* Check if it's valid for click disabl, source code and inspect element |
| [789](#L789) | \* |
| [790](#L790) | \* @return bool |
| [791](#L791) | \*/ |
| [792](#L792) | public static function doDisableClick() { |
| [793](#L793) |  |
| [794](#L794) | //Check if is valid for moving on |
| [795](#L795) | if ( ! apply\_filters( 'hmwp\_process\_hide\_disable', true ) ) { |
| [796](#L796) | return false; |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | if ( defined( 'DOING\_CRON' ) && DOING\_CRON ) { |
| [800](#L800) | return false; |
| [801](#L801) | } |
| [802](#L802) |  |
| [803](#L803) | //If not admin |
| [804](#L804) | if ( ! is\_admin() && ! is\_network\_admin() ) { |
| [805](#L805) |  |
| [806](#L806) | if ( function\_exists( 'is\_user\_logged\_in' ) && ( HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_click' ) || HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_inspect' ) || HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_source' ) || HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_copy\_paste' ) || HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_drag\_drop' ) ) ) { |
| [807](#L807) |  |
| [808](#L808) | return true; |
| [809](#L809) | } |
| [810](#L810) |  |
| [811](#L811) | } |
| [812](#L812) |  |
| [813](#L813) | return false; |
| [814](#L814) | } |
| [815](#L815) |  |
| [816](#L816) | /\*\* |
| [817](#L817) | \* Check if the option to hide the URLs is active |
| [818](#L818) | \* |
| [819](#L819) | \* @return bool |
| [820](#L820) | \*/ |
| [821](#L821) | public static function doHideURLs() { |
| [822](#L822) |  |
| [823](#L823) | //Check if is valid for moving on |
| [824](#L824) | if ( ! apply\_filters( 'hmwp\_process\_hide\_urls', true ) ) { |
| [825](#L825) | return false; |
| [826](#L826) | } |
| [827](#L827) |  |
| [828](#L828) | //make sure the function is loaded |
| [829](#L829) | if ( ! function\_exists( 'is\_user\_logged\_in' ) ) { |
| [830](#L830) | include\_once ABSPATH . WPINC . '/pluggable.php'; |
| [831](#L831) | } |
| [832](#L832) |  |
| [833](#L833) | if ( ! isset( $\_SERVER['REQUEST\_URI'] ) ) { |
| [834](#L834) | return false; |
| [835](#L835) | } |
| [836](#L836) |  |
| [837](#L837) | if ( defined( 'DOING\_CRON' ) && DOING\_CRON ) { |
| [838](#L838) | return false; |
| [839](#L839) | } |
| [840](#L840) |  |
| [841](#L841) | return true; |
| [842](#L842) | } |
| [843](#L843) |  |
| [844](#L844) |  |
| [845](#L845) | /\*\* |
| [846](#L846) | \* Get the plugin settings URL |
| [847](#L847) | \* |
| [848](#L848) | \* @param  string  $page |
| [849](#L849) | \* @param  string  $relative |
| [850](#L850) | \* |
| [851](#L851) | \* @return string |
| [852](#L852) | \*/ |
| [853](#L853) | public static function getSettingsUrl( $page = 'hmwp\_settings', $relative = false ) { |
| [854](#L854) | if ( $relative ) { |
| [855](#L855) | return 'admin.php?page=' . $page; |
| [856](#L856) | } else { |
| [857](#L857) | if ( ! self::isMultisites() ) { |
| [858](#L858) | return admin\_url( 'admin.php?page=' . $page ); |
| [859](#L859) | } else { |
| [860](#L860) | return network\_admin\_url( 'admin.php?page=' . $page ); |
| [861](#L861) | } |
| [862](#L862) | } |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | public static function getCloudUrl( $page = 'login' ) { |
| [866](#L866) | return \_HMWP\_ACCOUNT\_SITE\_ . '/user/auth/' . $page; |
| [867](#L867) | } |
| [868](#L868) |  |
| [869](#L869) | /\*\* |
| [870](#L870) | \* Get the config file for WordPress |
| [871](#L871) | \* |
| [872](#L872) | \* @return string |
| [873](#L873) | \*/ |
| [874](#L874) | public static function getConfigFile() { |
| [875](#L875) |  |
| [876](#L876) | //Initialize WordPress Filesystem |
| [877](#L877) | $wp\_filesystem = HMWP\_Classes\_ObjController::initFilesystem(); |
| [878](#L878) |  |
| [879](#L879) | if ( $wp\_filesystem->exists( self::getRootPath() . 'wp-config.php' ) ) { |
| [880](#L880) | return self::getRootPath() . 'wp-config.php'; |
| [881](#L881) | } |
| [882](#L882) |  |
| [883](#L883) | if ( $wp\_filesystem->exists( dirname( ABSPATH ) . '/wp-config.php' ) ) { |
| [884](#L884) | return dirname( ABSPATH ) . '/wp-config.php'; |
| [885](#L885) | } |
| [886](#L886) |  |
| [887](#L887) | return false; |
| [888](#L888) | } |
| [889](#L889) |  |
| [890](#L890) | /\*\* |
| [891](#L891) | \* Set the header type |
| [892](#L892) | \* |
| [893](#L893) | \* @param  string  $type |
| [894](#L894) | \*/ |
| [895](#L895) | public static function setHeader( $type ) { |
| [896](#L896) | switch ( $type ) { |
| [897](#L897) | case 'json': |
| [898](#L898) | header( 'Content-Type: application/json' ); |
| [899](#L899) | break; |
| [900](#L900) | case 'html': |
| [901](#L901) | header( "Content-type: text/html" ); |
| [902](#L902) | break; |
| [903](#L903) | case 'text': |
| [904](#L904) | header( "Content-type: text/plain" ); |
| [905](#L905) | break; |
| [906](#L906) | } |
| [907](#L907) | } |
| [908](#L908) |  |
| [909](#L909) | /\*\* |
| [910](#L910) | \* Get a value from $\_POST / $\_GET |
| [911](#L911) | \* if unavailable, take a default value |
| [912](#L912) | \* |
| [913](#L913) | \* @param  string  $key  Value key |
| [914](#L914) | \* @param  boolean  $keep\_newlines  Keep the new lines in variable in case of texareas |
| [915](#L915) | \* @param  mixed  $defaultValue  (optional) |
| [916](#L916) | \* |
| [917](#L917) | \* @return array|false|string Value |
| [918](#L918) | \*/ |
| [919](#L919) | public static function getValue( $key = null, $defaultValue = false, $keep\_newlines = false ) { |
| [920](#L920) | if ( ! isset( $key ) || $key == '' ) { |
| [921](#L921) | return false; |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | //Get the parameters based on the form method |
| [925](#L925) | //Sanitize each parameter based on the parameter type |
| [926](#L926) | $ret = ( isset( $\_POST[ $key ] ) ? $\_POST[ $key ] : ( isset( $\_GET[ $key ] ) ? $\_GET[ $key ] : $defaultValue ) ); |
| [927](#L927) |  |
| [928](#L928) | if ( is\_string( $ret ) === true ) { |
| [929](#L929) | if ( $keep\_newlines === false ) { |
| [930](#L930) | //Validate the param based on its type |
| [931](#L931) | if ( in\_array( $key, array( |
| [932](#L932) | 'hmwp\_email\_address', |
| [933](#L933) | 'hmwp\_email', |
| [934](#L934) | 'whitelist\_ip', |
| [935](#L935) | 'banlist\_ip' |
| [936](#L936) | ) ) ) { //validate email address |
| [937](#L937) | $ret = preg\_replace( '/[^A-Za-z0-9-\_.#\*@\/]/', '', $ret ); |
| [938](#L938) | } elseif ( in\_array( $key, array( 'hmwp\_disable\_name' ) ) ) { //validate url parameter |
| [939](#L939) | $ret = preg\_replace( '/[^A-Za-z0-9-\_]/', '', $ret ); |
| [940](#L940) | } elseif ( in\_array( $key, array( 'hmwp\_admin\_url', 'hmwp\_login\_url' ) ) ) { //validate url parameter |
| [941](#L941) | $ret = preg\_replace( '/[^A-Za-z0-9-\_.]/', '', $ret ); |
| [942](#L942) | } else { |
| [943](#L943) | $ret = preg\_replace( '/[^A-Za-z0-9-\_.\/]/', '', $ret ); //validate fields |
| [944](#L944) | } |
| [945](#L945) | //Sanitize the text field |
| [946](#L946) | $ret = sanitize\_text\_field( $ret ); |
| [947](#L947) |  |
| [948](#L948) | } else { |
| [949](#L949) |  |
| [950](#L950) | //Validate the textareas |
| [951](#L951) | $ret = preg\_replace( '/[^A-Za-z0-9-\_.\*#\n\r\s\/]@/', '', $ret ); |
| [952](#L952) |  |
| [953](#L953) | //Sanitize the textarea |
| [954](#L954) | if ( function\_exists( 'sanitize\_textarea\_field' ) ) { |
| [955](#L955) | $ret = sanitize\_textarea\_field( $ret ); |
| [956](#L956) | } |
| [957](#L957) | } |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | //Return the unsplas validated and sanitized value |
| [961](#L961) | return wp\_unslash( $ret ); |
| [962](#L962) | } |
| [963](#L963) |  |
| [964](#L964) | /\*\* |
| [965](#L965) | \* Check if the parameter is set |
| [966](#L966) | \* |
| [967](#L967) | \* @param  string  $key |
| [968](#L968) | \* |
| [969](#L969) | \* @return boolean |
| [970](#L970) | \*/ |
| [971](#L971) | public static function getIsset( $key = null ) { |
| [972](#L972) | if ( ! isset( $key ) || $key == '' ) { |
| [973](#L973) | return false; |
| [974](#L974) | } |
| [975](#L975) |  |
| [976](#L976) | return isset( $\_POST[ $key ] ) || isset( $\_GET[ $key ] ); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | /\*\* |
| [980](#L980) | \* Show the notices to WP |
| [981](#L981) | \* |
| [982](#L982) | \* @param  string  $message |
| [983](#L983) | \* @param  string  $type |
| [984](#L984) | \* |
| [985](#L985) | \* @return string |
| [986](#L986) | \*/ |
| [987](#L987) | public static function showNotices( $message, $type = '' ) { |
| [988](#L988) |  |
| [989](#L989) | //Initialize WordPress Filesystem |
| [990](#L990) | $wp\_filesystem = HMWP\_Classes\_ObjController::initFilesystem(); |
| [991](#L991) |  |
| [992](#L992) | if ( $wp\_filesystem->exists( \_HMWP\_THEME\_DIR\_ . 'Notices.php' ) ) { |
| [993](#L993) | ob\_start(); |
| [994](#L994) | include \_HMWP\_THEME\_DIR\_ . 'Notices.php'; |
| [995](#L995) | $message = ob\_get\_contents(); |
| [996](#L996) | ob\_end\_clean(); |
| [997](#L997) | } |
| [998](#L998) |  |
| [999](#L999) | return $message; |
| [1000](#L1000) | } |
| [1001](#L1001) |  |
| [1002](#L1002) | /\*\* |
| [1003](#L1003) | \* Connect remote with wp\_remote\_get |
| [1004](#L1004) | \* |
| [1005](#L1005) | \* @param $url |
| [1006](#L1006) | \* @param  array  $params |
| [1007](#L1007) | \* @param  array  $options |
| [1008](#L1008) | \* |
| [1009](#L1009) | \* @return bool|string |
| [1010](#L1010) | \*/ |
| [1011](#L1011) | public static function hmwp\_remote\_get( $url, $params = array(), $options = array() ) { |
| [1012](#L1012) |  |
| [1013](#L1013) | $parameters = ''; |
| [1014](#L1014) | if ( ! empty( $params ) ) { |
| [1015](#L1015) | foreach ( $params as $key => $value ) { |
| [1016](#L1016) | if ( $key <> '' ) { |
| [1017](#L1017) | $parameters .= ( $parameters == "" ? "" : "&" ) . $key . "=" . $value; |
| [1018](#L1018) | } |
| [1019](#L1019) | } |
| [1020](#L1020) |  |
| [1021](#L1021) | if ( $parameters <> '' ) { |
| [1022](#L1022) | $url .= ( ( strpos( $url, "?" ) === false ) ? "?" : "&" ) . $parameters; |
| [1023](#L1023) | } |
| [1024](#L1024) | } |
| [1025](#L1025) |  |
| [1026](#L1026) | $response = self::hmwp\_wpcall( $url, $params, $options ); |
| [1027](#L1027) |  |
| [1028](#L1028) | if ( is\_wp\_error( $response ) ) { |
| [1029](#L1029) | return false; |
| [1030](#L1030) | } |
| [1031](#L1031) |  |
| [1032](#L1032) | return self::cleanResponce( wp\_remote\_retrieve\_body( $response ) ); //clear and get the body |
| [1033](#L1033) |  |
| [1034](#L1034) | } |
| [1035](#L1035) |  |
| [1036](#L1036) |  |
| [1037](#L1037) | /\*\* |
| [1038](#L1038) | \* Connect remote with wp\_remote\_get |
| [1039](#L1039) | \* |
| [1040](#L1040) | \* @param $url |
| [1041](#L1041) | \* @param  array  $params |
| [1042](#L1042) | \* @param  array  $options |
| [1043](#L1043) | \* |
| [1044](#L1044) | \* @return bool|string |
| [1045](#L1045) | \*/ |
| [1046](#L1046) | public static function hmwp\_remote\_post( $url, $params = array(), $options = array() ) { |
| [1047](#L1047) | $options['method'] = 'POST'; |
| [1048](#L1048) |  |
| [1049](#L1049) | $response = self::hmwp\_wpcall( $url, $params, $options ); |
| [1050](#L1050) |  |
| [1051](#L1051) | if ( is\_wp\_error( $response ) ) { |
| [1052](#L1052) | return false; |
| [1053](#L1053) | } |
| [1054](#L1054) |  |
| [1055](#L1055) | return self::cleanResponce( wp\_remote\_retrieve\_body( $response ) ); //clear and get the body |
| [1056](#L1056) |  |
| [1057](#L1057) | } |
| [1058](#L1058) |  |
| [1059](#L1059) | /\*\* |
| [1060](#L1060) | \* Use the WP remote call |
| [1061](#L1061) | \* |
| [1062](#L1062) | \* @param  string  $url |
| [1063](#L1063) | \* @param  array  $params |
| [1064](#L1064) | \* @param  array  $options |
| [1065](#L1065) | \* |
| [1066](#L1066) | \* @return array|WP\_Error The response or WP\_Error on failure. |
| [1067](#L1067) | \*/ |
| [1068](#L1068) | public static function hmwp\_wpcall( $url, $params, $options ) { |
| [1069](#L1069) | //predefined options |
| [1070](#L1070) | $options = array\_replace\_recursive( array( |
| [1071](#L1071) | 'sslverify' => \_HMWP\_CHECK\_SSL\_, |
| [1072](#L1072) | 'method'    => 'GET', |
| [1073](#L1073) | 'timeout'   => 30, |
| [1074](#L1074) | 'headers'   => array( |
| [1075](#L1075) | 'TOKEN'     => HMWP\_Classes\_Tools::getOption( 'hmwp\_token' ), |
| [1076](#L1076) | 'API-TOKEN' => HMWP\_Classes\_Tools::getOption( 'api\_token' ), |
| [1077](#L1077) | 'USER-URL'  => home\_url(), |
| [1078](#L1078) | 'LANG'      => get\_bloginfo( 'language' ), |
| [1079](#L1079) | 'VER'       => HMWP\_VERSION |
| [1080](#L1080) | ) |
| [1081](#L1081) | ), $options ); |
| [1082](#L1082) |  |
| [1083](#L1083) | if ( $options['method'] == 'POST' ) { |
| [1084](#L1084) |  |
| [1085](#L1085) | $options['body'] = $params; |
| [1086](#L1086) | unset( $options['method'] ); |
| [1087](#L1087) | $response = wp\_remote\_post( $url, $options ); |
| [1088](#L1088) | } else { |
| [1089](#L1089) |  |
| [1090](#L1090) | unset( $options['method'] ); |
| [1091](#L1091) | $response = wp\_remote\_get( $url, $options ); |
| [1092](#L1092) |  |
| [1093](#L1093) | } |
| [1094](#L1094) |  |
| [1095](#L1095) | if ( is\_wp\_error( $response ) ) { |
| [1096](#L1096) | //For debugging |
| [1097](#L1097) | do\_action( 'hmwp\_debug\_request', $url, $options, $response ); |
| [1098](#L1098) | } |
| [1099](#L1099) |  |
| [1100](#L1100) | return $response; |
| [1101](#L1101) | } |
| [1102](#L1102) |  |
| [1103](#L1103) | /\*\* |
| [1104](#L1104) | \* Call the local URLs for Security Check |
| [1105](#L1105) | \* |
| [1106](#L1106) | \* @param $url |
| [1107](#L1107) | \* @param $options |
| [1108](#L1108) | \* |
| [1109](#L1109) | \* @return array|WP\_Error |
| [1110](#L1110) | \*/ |
| [1111](#L1111) | public static function hmwp\_localcall( $url, $options = array() ) { |
| [1112](#L1112) | //predefined options |
| [1113](#L1113) | $options = array\_merge( array( |
| [1114](#L1114) | 'sslverify' => false, |
| [1115](#L1115) | 'timeout'   => 10, |
| [1116](#L1116) | ), $options ); |
| [1117](#L1117) |  |
| [1118](#L1118) | $response = wp\_remote\_get( $url, $options ); |
| [1119](#L1119) |  |
| [1120](#L1120) | if ( is\_wp\_error( $response ) ) { |
| [1121](#L1121) | //For debugging |
| [1122](#L1122) | do\_action( 'hmwp\_debug\_local\_request', $url, $options, $response ); |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | return $response; |
| [1126](#L1126) | } |
| [1127](#L1127) |  |
| [1128](#L1128) | /\*\* |
| [1129](#L1129) | \* Get the Json from responce if any |
| [1130](#L1130) | \* |
| [1131](#L1131) | \* @param  string  $response |
| [1132](#L1132) | \* |
| [1133](#L1133) | \* @return string |
| [1134](#L1134) | \*/ |
| [1135](#L1135) | private static function cleanResponce( $response ) { |
| [1136](#L1136) | return trim( $response, '()' ); |
| [1137](#L1137) | } |
| [1138](#L1138) |  |
| [1139](#L1139) | /\*\* |
| [1140](#L1140) | \* Check if HTML Headers to prevent chenging the code for other file extension |
| [1141](#L1141) | \* |
| [1142](#L1142) | \* @param  array  $types |
| [1143](#L1143) | \* |
| [1144](#L1144) | \* @return bool |
| [1145](#L1145) | \* @throws Exception |
| [1146](#L1146) | \*/ |
| [1147](#L1147) | public static function isContentHeader( $types = array( 'text/html', 'text/xml' ) ) { |
| [1148](#L1148) | $headers = headers\_list(); |
| [1149](#L1149) |  |
| [1150](#L1150) | //check the Content Type |
| [1151](#L1151) | if ( ! empty( $headers ) && ! empty( $types ) ) { |
| [1152](#L1152) | foreach ( $headers as $value ) { |
| [1153](#L1153) | if ( strpos( $value, ':' ) !== false ) { |
| [1154](#L1154) | if ( stripos( $value, 'Content-Type' ) !== false ) { |
| [1155](#L1155) |  |
| [1156](#L1156) | foreach ( $types as $type ) { |
| [1157](#L1157) | if ( stripos( $value, $type ) !== false ) { |
| [1158](#L1158) | return true; |
| [1159](#L1159) | } |
| [1160](#L1160) | } |
| [1161](#L1161) |  |
| [1162](#L1162) | return false; |
| [1163](#L1163) |  |
| [1164](#L1164) | } |
| [1165](#L1165) | } |
| [1166](#L1166) | } |
| [1167](#L1167) | } |
| [1168](#L1168) |  |
| [1169](#L1169) | return false; |
| [1170](#L1170) | } |
| [1171](#L1171) |  |
| [1172](#L1172) |  |
| [1173](#L1173) | /\*\* |
| [1174](#L1174) | \* Returns true if server is Apache |
| [1175](#L1175) | \* |
| [1176](#L1176) | \* @return boolean |
| [1177](#L1177) | \*/ |
| [1178](#L1178) | public static function isApache() { |
| [1179](#L1179) | global $is\_apache; |
| [1180](#L1180) |  |
| [1181](#L1181) | //If custom defined |
| [1182](#L1182) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1183](#L1183) | return in\_array( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ), array( |
| [1184](#L1184) | 'apache', |
| [1185](#L1185) | 'litespeed', |
| [1186](#L1186) | 'siteground' |
| [1187](#L1187) | ) ); |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | //If custom defined |
| [1191](#L1191) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'apache' ) { |
| [1192](#L1192) | return true; |
| [1193](#L1193) | } |
| [1194](#L1194) |  |
| [1195](#L1195) | if ( self::isFlywheel() ) { //force Nginx on Flywheel server |
| [1196](#L1196) | return false; |
| [1197](#L1197) | } |
| [1198](#L1198) |  |
| [1199](#L1199) | return $is\_apache; |
| [1200](#L1200) | } |
| [1201](#L1201) |  |
| [1202](#L1202) | /\*\* |
| [1203](#L1203) | \* Check if mode rewrite is on |
| [1204](#L1204) | \* |
| [1205](#L1205) | \* @return bool |
| [1206](#L1206) | \*/ |
| [1207](#L1207) | public static function isModeRewrite() { |
| [1208](#L1208) | if ( function\_exists( 'apache\_get\_modules' ) ) { |
| [1209](#L1209) | $modules = apache\_get\_modules(); |
| [1210](#L1210) | if ( ! empty( $modules ) ) { |
| [1211](#L1211) | return in\_array( 'mod\_rewrite', $modules ); |
| [1212](#L1212) | } |
| [1213](#L1213) | } |
| [1214](#L1214) |  |
| [1215](#L1215) | return true; |
| [1216](#L1216) | } |
| [1217](#L1217) |  |
| [1218](#L1218) | /\*\* |
| [1219](#L1219) | \* Check whether server is LiteSpeed |
| [1220](#L1220) | \* |
| [1221](#L1221) | \* @return bool |
| [1222](#L1222) | \*/ |
| [1223](#L1223) | public static function isLitespeed() { |
| [1224](#L1224) | $litespeed = false; |
| [1225](#L1225) |  |
| [1226](#L1226) | //If custom defined |
| [1227](#L1227) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1228](#L1228) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'litespeed' ); |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | //If custom defined |
| [1232](#L1232) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'litespeed' ) { |
| [1233](#L1233) | return true; |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | if ( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && stripos( $\_SERVER['SERVER\_SOFTWARE'], 'LiteSpeed' ) !== false ) { |
| [1237](#L1237) | $litespeed = true; |
| [1238](#L1238) | } elseif ( isset( $\_SERVER['SERVER\_NAME'] ) && stripos( $\_SERVER['SERVER\_NAME'], 'LiteSpeed' ) !== false ) { |
| [1239](#L1239) | $litespeed = true; |
| [1240](#L1240) | } elseif ( isset( $\_SERVER['X-Litespeed-Cache-Control'] ) ) { |
| [1241](#L1241) | $litespeed = true; |
| [1242](#L1242) | } |
| [1243](#L1243) |  |
| [1244](#L1244) | if ( self::isFlywheel() ) { |
| [1245](#L1245) | return false; |
| [1246](#L1246) | } |
| [1247](#L1247) |  |
| [1248](#L1248) | return $litespeed; |
| [1249](#L1249) | } |
| [1250](#L1250) |  |
| [1251](#L1251) | /\*\* |
| [1252](#L1252) | \* Check whether server is Lighthttp |
| [1253](#L1253) | \* |
| [1254](#L1254) | \* @return bool |
| [1255](#L1255) | \*/ |
| [1256](#L1256) | public static function isLighthttp() { |
| [1257](#L1257) | return ( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && stripos( $\_SERVER['SERVER\_SOFTWARE'], 'lighttpd' ) !== false ); |
| [1258](#L1258) | } |
| [1259](#L1259) |  |
| [1260](#L1260) | /\*\* |
| [1261](#L1261) | \* Check whether server is AWS StoreFront Bitnami |
| [1262](#L1262) | \* |
| [1263](#L1263) | \* @return bool |
| [1264](#L1264) | \*/ |
| [1265](#L1265) | public static function isAWS() { |
| [1266](#L1266) | //If custom defined |
| [1267](#L1267) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1268](#L1268) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'bitnami' ); |
| [1269](#L1269) | } |
| [1270](#L1270) |  |
| [1271](#L1271) | if ( isset( $\_SERVER["DOCUMENT\_ROOT"] ) && strpos( $\_SERVER["DOCUMENT\_ROOT"], "/bitnami/" ) ) { |
| [1272](#L1272) | return true; |
| [1273](#L1273) | } |
| [1274](#L1274) |  |
| [1275](#L1275) | $headers = headers\_list(); |
| [1276](#L1276) |  |
| [1277](#L1277) | foreach ( $headers as $header ) { |
| [1278](#L1278) | if ( strpos( $header, 'x-amz-cf-id' ) !== false ) { |
| [1279](#L1279) | return true; |
| [1280](#L1280) | } |
| [1281](#L1281) | } |
| [1282](#L1282) |  |
| [1283](#L1283) | return false; |
| [1284](#L1284) | } |
| [1285](#L1285) |  |
| [1286](#L1286) | /\*\* |
| [1287](#L1287) | \* Check if multisites |
| [1288](#L1288) | \* |
| [1289](#L1289) | \* @return bool |
| [1290](#L1290) | \*/ |
| [1291](#L1291) | public static function isMultisites() { |
| [1292](#L1292) | return is\_multisite(); |
| [1293](#L1293) | } |
| [1294](#L1294) |  |
| [1295](#L1295) | /\*\* |
| [1296](#L1296) | \* Check if multisites with path |
| [1297](#L1297) | \* |
| [1298](#L1298) | \* @return bool |
| [1299](#L1299) | \*/ |
| [1300](#L1300) | public static function isMultisiteWithPath() { |
| [1301](#L1301) | return ( is\_multisite() && ( ( defined( 'SUBDOMAIN\_INSTALL' ) && ! SUBDOMAIN\_INSTALL ) || ( defined( 'VHOST' ) && VHOST == 'no' ) ) ); |
| [1302](#L1302) | } |
| [1303](#L1303) |  |
| [1304](#L1304) | /\*\* |
| [1305](#L1305) | \* Returns true if server is nginx |
| [1306](#L1306) | \* |
| [1307](#L1307) | \* @return boolean |
| [1308](#L1308) | \*/ |
| [1309](#L1309) | public static function isNginx() { |
| [1310](#L1310) | global $is\_nginx; |
| [1311](#L1311) |  |
| [1312](#L1312) | //If custom defined |
| [1313](#L1313) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1314](#L1314) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'nginx' ) { |
| [1315](#L1315) | return true; |
| [1316](#L1316) | } |
| [1317](#L1317) | } |
| [1318](#L1318) |  |
| [1319](#L1319) | //If custom defined |
| [1320](#L1320) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'nginx' ) { |
| [1321](#L1321) | return true; |
| [1322](#L1322) | } |
| [1323](#L1323) |  |
| [1324](#L1324) | return ( $is\_nginx || ( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && ( stripos( $\_SERVER['SERVER\_SOFTWARE'], 'nginx' ) !== false || stripos( $\_SERVER['SERVER\_SOFTWARE'], 'TasteWP' ) !== false ) ) ); |
| [1325](#L1325) | } |
| [1326](#L1326) |  |
| [1327](#L1327) | /\*\* |
| [1328](#L1328) | \* Returns true if server is Wpengine |
| [1329](#L1329) | \* |
| [1330](#L1330) | \* @return boolean |
| [1331](#L1331) | \*/ |
| [1332](#L1332) | public static function isWpengine() { |
| [1333](#L1333) | //If custom defined |
| [1334](#L1334) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1335](#L1335) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'wpengine' ); |
| [1336](#L1336) | } |
| [1337](#L1337) |  |
| [1338](#L1338) | //If custom defined |
| [1339](#L1339) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'wpengine' ) { |
| [1340](#L1340) | return true; |
| [1341](#L1341) | } |
| [1342](#L1342) |  |
| [1343](#L1343) | return ( isset( $\_SERVER['WPENGINE\_PHPSESSIONS'] ) ); |
| [1344](#L1344) | } |
| [1345](#L1345) |  |
| [1346](#L1346) | /\*\* |
| [1347](#L1347) | \* Returns true if server is Local by Flywheel |
| [1348](#L1348) | \* |
| [1349](#L1349) | \* @return boolean |
| [1350](#L1350) | \*/ |
| [1351](#L1351) | public static function isLocalFlywheel() { |
| [1352](#L1352) |  |
| [1353](#L1353) | //If custom defined |
| [1354](#L1354) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1355](#L1355) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'local' ); |
| [1356](#L1356) | } |
| [1357](#L1357) |  |
| [1358](#L1358) | return false; |
| [1359](#L1359) | } |
| [1360](#L1360) |  |
| [1361](#L1361) | /\*\* |
| [1362](#L1362) | \* Returns true if server is Wpengine |
| [1363](#L1363) | \* |
| [1364](#L1364) | \* @return boolean |
| [1365](#L1365) | \*/ |
| [1366](#L1366) | public static function isFlywheel() { |
| [1367](#L1367) |  |
| [1368](#L1368) | //If custom defined |
| [1369](#L1369) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1370](#L1370) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'flywheel' ); |
| [1371](#L1371) | } |
| [1372](#L1372) |  |
| [1373](#L1373) | //If custom defined |
| [1374](#L1374) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'flywheel' ) { |
| [1375](#L1375) | return true; |
| [1376](#L1376) | } |
| [1377](#L1377) |  |
| [1378](#L1378) | if ( isset( $\_SERVER['SERVER'] ) && stripos( $\_SERVER['SERVER'], 'Flywheel' ) !== false ) { |
| [1379](#L1379) | return true; |
| [1380](#L1380) | } |
| [1381](#L1381) |  |
| [1382](#L1382) | return ( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && stripos( $\_SERVER['SERVER\_SOFTWARE'], 'Flywheel' ) !== false ); |
| [1383](#L1383) | } |
| [1384](#L1384) |  |
| [1385](#L1385) | /\*\* |
| [1386](#L1386) | \* Returns true if server is Inmotion |
| [1387](#L1387) | \* |
| [1388](#L1388) | \* @return boolean |
| [1389](#L1389) | \*/ |
| [1390](#L1390) | public static function isInmotion() { |
| [1391](#L1391) |  |
| [1392](#L1392) | //If custom defined |
| [1393](#L1393) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1394](#L1394) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'inmotion' ); |
| [1395](#L1395) | } |
| [1396](#L1396) |  |
| [1397](#L1397) | //If custom defined |
| [1398](#L1398) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'inmotion' ) { |
| [1399](#L1399) | return true; |
| [1400](#L1400) | } |
| [1401](#L1401) |  |
| [1402](#L1402) | return ( isset( $\_SERVER['SERVER\_ADDR'] ) && stripos( @gethostbyaddr( $\_SERVER['SERVER\_ADDR'] ), 'inmotionhosting.com' ) !== false ); |
| [1403](#L1403) | } |
| [1404](#L1404) |  |
| [1405](#L1405) | /\*\* |
| [1406](#L1406) | \* Returns true if server is Godaddy |
| [1407](#L1407) | \* |
| [1408](#L1408) | \* @return boolean |
| [1409](#L1409) | \*/ |
| [1410](#L1410) | public static function isGodaddy() { |
| [1411](#L1411) |  |
| [1412](#L1412) | //If custom defined |
| [1413](#L1413) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1414](#L1414) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'godaddy' ); |
| [1415](#L1415) | } |
| [1416](#L1416) |  |
| [1417](#L1417) | //If custom defined |
| [1418](#L1418) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'godaddy' ) { |
| [1419](#L1419) | return true; |
| [1420](#L1420) | } |
| [1421](#L1421) |  |
| [1422](#L1422) | return ( file\_exists( ABSPATH . 'gd-config.php' ) ); |
| [1423](#L1423) | } |
| [1424](#L1424) |  |
| [1425](#L1425) | /\*\* |
| [1426](#L1426) | \* Returns true if server is IIS |
| [1427](#L1427) | \* |
| [1428](#L1428) | \* @return boolean |
| [1429](#L1429) | \*/ |
| [1430](#L1430) | public static function isIIS() { |
| [1431](#L1431) | global $is\_IIS, $is\_iis7; |
| [1432](#L1432) |  |
| [1433](#L1433) | //If custom defined |
| [1434](#L1434) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1435](#L1435) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'iis' ); |
| [1436](#L1436) | } |
| [1437](#L1437) |  |
| [1438](#L1438) | //If custom defined |
| [1439](#L1439) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'iis' ) { |
| [1440](#L1440) | return true; |
| [1441](#L1441) | } |
| [1442](#L1442) |  |
| [1443](#L1443) | return ( $is\_iis7 || $is\_IIS || ( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && stripos( $\_SERVER['SERVER\_SOFTWARE'], 'microsoft-iis' ) !== false ) ); |
| [1444](#L1444) | } |
| [1445](#L1445) |  |
| [1446](#L1446) | /\*\* |
| [1447](#L1447) | \* Returns true if windows |
| [1448](#L1448) | \* |
| [1449](#L1449) | \* @return bool |
| [1450](#L1450) | \*/ |
| [1451](#L1451) | public static function isWindows() { |
| [1452](#L1452) | return ( strtoupper( substr( PHP\_OS, 0, 3 ) ) === 'WIN' ); |
| [1453](#L1453) | } |
| [1454](#L1454) |  |
| [1455](#L1455) | /\*\* |
| [1456](#L1456) | \* Check if IIS has rewritten 2 structure enabled |
| [1457](#L1457) | \* |
| [1458](#L1458) | \* @return bool |
| [1459](#L1459) | \*/ |
| [1460](#L1460) | public static function isPHPPermalink() { |
| [1461](#L1461) | if ( get\_option( 'permalink\_structure' ) ) { |
| [1462](#L1462) | if ( strpos( get\_option( 'permalink\_structure' ), 'index.php' ) !== false || stripos( get\_option( 'permalink\_structure' ), 'index.html' ) !== false || strpos( get\_option( 'permalink\_structure' ), 'index.htm' ) !== false ) { |
| [1463](#L1463) | return true; |
| [1464](#L1464) | } |
| [1465](#L1465) | } |
| [1466](#L1466) |  |
| [1467](#L1467) | return false; |
| [1468](#L1468) | } |
| [1469](#L1469) |  |
| [1470](#L1470) | /\*\* |
| [1471](#L1471) | \* Returns true if server is Godaddy |
| [1472](#L1472) | \* |
| [1473](#L1473) | \* @return boolean |
| [1474](#L1474) | \*/ |
| [1475](#L1475) | public static function isCloudPanel() { |
| [1476](#L1476) |  |
| [1477](#L1477) | global $is\_nginx; |
| [1478](#L1478) |  |
| [1479](#L1479) | //If custom defined |
| [1480](#L1480) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1481](#L1481) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'cloudpanel' ) { |
| [1482](#L1482) | $is\_nginx = true; |
| [1483](#L1483) |  |
| [1484](#L1484) | return true; |
| [1485](#L1485) | } |
| [1486](#L1486) | } |
| [1487](#L1487) |  |
| [1488](#L1488) | return false; |
| [1489](#L1489) | } |
| [1490](#L1490) |  |
| [1491](#L1491) | /\*\* |
| [1492](#L1492) | \* Is a cache plugin installed in WordPress? |
| [1493](#L1493) | \* |
| [1494](#L1494) | \* @return bool |
| [1495](#L1495) | \*/ |
| [1496](#L1496) | public static function isCachePlugin() { |
| [1497](#L1497) | return ( HMWP\_Classes\_Tools::isPluginActive( 'autoptimize/autoptimize.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'beaver-builder-lite-version/fl-builder.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'beaver-builder/fl-builder.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'breeze/breeze.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'cache-enabler/cache-enabler.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'comet-cache/comet-cache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'hummingbird-performance/wp-hummingbird.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'hyper-cache/plugin.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'jch-optimize/jch-optimize.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'litespeed-cache/litespeed-cache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'powered-cache/powered-cache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'sg-cachepress/sg-cachepress.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'w3-total-cache/w3-total-cache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'wp-asset-clean-up/wpacu.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'wp-fastest-cache/wpFastestCache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'wp-rocket/wp-rocket.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'wp-super-cache/wp-cache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'swift-performance/performance.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'swift-performance-lite/performance.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'nitropack/main.php' ) || WP\_CACHE ); |
| [1498](#L1498) | } |
| [1499](#L1499) |  |
| [1500](#L1500) | /\*\* |
| [1501](#L1501) | \* Check whether the plugin is active by checking the active\_plugins list. |
| [1502](#L1502) | \* |
| [1503](#L1503) | \* @source wp-admin/includes/plugin.php |
| [1504](#L1504) | \* |
| [1505](#L1505) | \* @param  string  $plugin  Plugin folder/main file. |
| [1506](#L1506) | \* |
| [1507](#L1507) | \* @return boolean |
| [1508](#L1508) | \*/ |
| [1509](#L1509) | public static function isPluginActive( $plugin ) { |
| [1510](#L1510) |  |
| [1511](#L1511) | if ( empty( self::$active\_plugins ) ) { |
| [1512](#L1512) |  |
| [1513](#L1513) | if ( self::isMultisites() ) { |
| [1514](#L1514) |  |
| [1515](#L1515) | if ( ! $sitewide\_plugins = get\_site\_option( 'active\_sitewide\_plugins' ) ) { |
| [1516](#L1516) | $sitewide\_plugins = array(); |
| [1517](#L1517) | } |
| [1518](#L1518) |  |
| [1519](#L1519) | self::$active\_plugins = array\_keys( $sitewide\_plugins ); |
| [1520](#L1520) |  |
| [1521](#L1521) | $sites = get\_sites( array( 'number' => 10000, 'public' => 1, 'deleted' => 0, ) ); |
| [1522](#L1522) | foreach ( $sites as $site ) { |
| [1523](#L1523) | switch\_to\_blog( $site->blog\_id ); |
| [1524](#L1524) |  |
| [1525](#L1525) | $active\_plugins = (array) get\_option( 'active\_plugins', array() ); |
| [1526](#L1526) |  |
| [1527](#L1527) | self::$active\_plugins = array\_merge( self::$active\_plugins, $active\_plugins ); |
| [1528](#L1528) |  |
| [1529](#L1529) | restore\_current\_blog(); |
| [1530](#L1530) | } |
| [1531](#L1531) |  |
| [1532](#L1532) | if ( ! empty( self::$active\_plugins ) ) { |
| [1533](#L1533) | self::$active\_plugins = array\_unique( self::$active\_plugins ); |
| [1534](#L1534) | } |
| [1535](#L1535) |  |
| [1536](#L1536) | } else { |
| [1537](#L1537) | self::$active\_plugins = (array) get\_option( 'active\_plugins', array() ); |
| [1538](#L1538) | } |
| [1539](#L1539) |  |
| [1540](#L1540) | } |
| [1541](#L1541) |  |
| [1542](#L1542) | return in\_array( $plugin, self::$active\_plugins, true ); |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | /\*\* |
| [1546](#L1546) | \* Check whether the theme is active. |
| [1547](#L1547) | \* |
| [1548](#L1548) | \* @param  string  $name  Theme folder/main file. |
| [1549](#L1549) | \* |
| [1550](#L1550) | \* @return boolean |
| [1551](#L1551) | \*/ |
| [1552](#L1552) | public static function isThemeActive( $name ) { |
| [1553](#L1553) | $theme = get\_option( 'template' ); |
| [1554](#L1554) |  |
| [1555](#L1555) | if ( $theme ) { |
| [1556](#L1556) | if ( strtolower( $theme ) == strtolower( $name ) || strtolower( $theme ) == strtolower( $name ) . ' child' || strtolower( $theme ) == strtolower( $name ) . ' child theme' ) { |
| [1557](#L1557) | return true; |
| [1558](#L1558) | } |
| [1559](#L1559) | } |
| [1560](#L1560) |  |
| [1561](#L1561) | return false; |
| [1562](#L1562) | } |
| [1563](#L1563) |  |
| [1564](#L1564) | /\*\* |
| [1565](#L1565) | \* Get all the plugin names |
| [1566](#L1566) | \* |
| [1567](#L1567) | \* @return array |
| [1568](#L1568) | \*/ |
| [1569](#L1569) | public static function getAllPlugins() { |
| [1570](#L1570) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_hide\_all\_plugins' ) ) { |
| [1571](#L1571) | if ( ! function\_exists( 'get\_plugins' ) ) { |
| [1572](#L1572) | include\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [1573](#L1573) | } |
| [1574](#L1574) |  |
| [1575](#L1575) | $all\_plugins = array\_keys( get\_plugins() ); |
| [1576](#L1576) | } else { |
| [1577](#L1577) | $all\_plugins = (array) get\_option( 'active\_plugins', array() ); |
| [1578](#L1578) | } |
| [1579](#L1579) |  |
| [1580](#L1580) | if ( self::isMultisites() ) { |
| [1581](#L1581) | $all\_plugins = array\_merge( array\_values( $all\_plugins ), array\_keys( get\_site\_option( 'active\_sitewide\_plugins' ) ) ); |
| [1582](#L1582) | } |
| [1583](#L1583) |  |
| [1584](#L1584) | return $all\_plugins; |
| [1585](#L1585) | } |
| [1586](#L1586) |  |
| [1587](#L1587) | /\*\* |
| [1588](#L1588) | \* Get all the themes names |
| [1589](#L1589) | \* |
| [1590](#L1590) | \* @return array |
| [1591](#L1591) | \*/ |
| [1592](#L1592) | public static function getAllThemes() { |
| [1593](#L1593) | return search\_theme\_directories(); |
| [1594](#L1594) | } |
| [1595](#L1595) |  |
| [1596](#L1596) | /\*\* |
| [1597](#L1597) | \* Get the absolute filesystem path to the root of the WordPress installation |
| [1598](#L1598) | \* |
| [1599](#L1599) | \* @return string Full filesystem path to the root of the WordPress installation |
| [1600](#L1600) | \*/ |
| [1601](#L1601) | public static function getRootPath() { |
| [1602](#L1602) | $root\_path = ABSPATH; |
| [1603](#L1603) |  |
| [1604](#L1604) | if ( defined( '\_HMWP\_CONFIGPATH' ) ) { |
| [1605](#L1605) | $root\_path = \_HMWP\_CONFIGPATH; |
| [1606](#L1606) | } elseif ( self::isFlywheel() && defined( 'WP\_CONTENT\_DIR' ) && dirname( WP\_CONTENT\_DIR ) ) { |
| [1607](#L1607) | $root\_path = str\_replace( '\\', '/', dirname( WP\_CONTENT\_DIR ) ) . '/'; |
| [1608](#L1608) | } |
| [1609](#L1609) |  |
| [1610](#L1610) | return apply\_filters( 'hmwp\_root\_path', $root\_path ); |
| [1611](#L1611) |  |
| [1612](#L1612) | } |
| [1613](#L1613) |  |
| [1614](#L1614) | /\*\* |
| [1615](#L1615) | \* Get the absolute filesystem path to the root of the WordPress installation |
| [1616](#L1616) | \* |
| [1617](#L1617) | \* @return string Full filesystem path to the root of the WordPress installation |
| [1618](#L1618) | \*/ |
| [1619](#L1619) | public static function getHomeRootPath() { |
| [1620](#L1620) | $home\_root = '/'; |
| [1621](#L1621) | if ( HMWP\_Classes\_Tools::isMultisites() && defined( 'PATH\_CURRENT\_SITE' ) ) { |
| [1622](#L1622) | $path = PATH\_CURRENT\_SITE; |
| [1623](#L1623) | } else { |
| [1624](#L1624) | $path = wp\_parse\_url( site\_url(), PHP\_URL\_PATH ); |
| [1625](#L1625) | } |
| [1626](#L1626) |  |
| [1627](#L1627) | if ( $path ) { |
| [1628](#L1628) | $home\_root = trailingslashit( $path ); |
| [1629](#L1629) | } |
| [1630](#L1630) |  |
| [1631](#L1631) | return apply\_filters( 'hmwp\_home\_root', $home\_root ); |
| [1632](#L1632) | } |
| [1633](#L1633) |  |
| [1634](#L1634) | /\*\* |
| [1635](#L1635) | \* Get Relative path for the current blog in case of WP Multisite |
| [1636](#L1636) | \* |
| [1637](#L1637) | \* @param $url |
| [1638](#L1638) | \* |
| [1639](#L1639) | \* @return string |
| [1640](#L1640) | \*/ |
| [1641](#L1641) | public static function getRelativePath( $url ) { |
| [1642](#L1642) |  |
| [1643](#L1643) | if ( $url <> '' ) { |
| [1644](#L1644) | // Get the relative url path |
| [1645](#L1645) | $url = wp\_make\_link\_relative( $url ); |
| [1646](#L1646) |  |
| [1647](#L1647) | // Get the relative domain |
| [1648](#L1648) | $domain = site\_url(); |
| [1649](#L1649) |  |
| [1650](#L1650) | // f WP Multisite, get the root domain |
| [1651](#L1651) | if ( self::isMultisiteWithPath() ) { |
| [1652](#L1652) | $domain = network\_site\_url(); |
| [1653](#L1653) | } |
| [1654](#L1654) |  |
| [1655](#L1655) | // Get relative path and exclude any root domain from URL |
| [1656](#L1656) | if($domain = wp\_make\_link\_relative( trim($domain , '/') )){ |
| [1657](#L1657) | $url = str\_replace( $domain, '', $url ); |
| [1658](#L1658) | } |
| [1659](#L1659) |  |
| [1660](#L1660) | //remove the domain path if exists |
| [1661](#L1661) | if ( self::isMultisiteWithPath() && defined( 'PATH\_CURRENT\_SITE' ) && PATH\_CURRENT\_SITE <> '/' ) { |
| [1662](#L1662) | $url = str\_replace( rtrim( PATH\_CURRENT\_SITE, '/' ), '', $url ); |
| [1663](#L1663) | } |
| [1664](#L1664) | } |
| [1665](#L1665) |  |
| [1666](#L1666) | return trailingslashit( $url ); |
| [1667](#L1667) | } |
| [1668](#L1668) |  |
| [1669](#L1669) | /\*\* |
| [1670](#L1670) | \* Check if wp-content is changed and set in a different location |
| [1671](#L1671) | \* |
| [1672](#L1672) | \* @ver 7.0.12 |
| [1673](#L1673) | \* |
| [1674](#L1674) | \* @return bool |
| [1675](#L1675) | \*/ |
| [1676](#L1676) | public static function isDifferentWPContentPath() { |
| [1677](#L1677) | $homepath = ''; |
| [1678](#L1678) | if ( wp\_parse\_url( site\_url(), PHP\_URL\_PATH ) ) { |
| [1679](#L1679) | $homepath = ltrim( wp\_parse\_url( site\_url(), PHP\_URL\_PATH ), '/' ); |
| [1680](#L1680) | } |
| [1681](#L1681) |  |
| [1682](#L1682) | if ( $homepath <> '/' ) { |
| [1683](#L1683) | $contenturl = ltrim( wp\_parse\_url( content\_url(), PHP\_URL\_PATH ), '/' ); |
| [1684](#L1684) |  |
| [1685](#L1685) | return ( strpos( $contenturl, $homepath . '/' ) === false ); |
| [1686](#L1686) | } |
| [1687](#L1687) |  |
| [1688](#L1688) | return false; |
| [1689](#L1689) | } |
| [1690](#L1690) |  |
| [1691](#L1691) | /\*\* |
| [1692](#L1692) | \* Empty the cache from other cache plugins when save the settings |
| [1693](#L1693) | \*/ |
| [1694](#L1694) | public static function emptyCache() { |
| [1695](#L1695) |  |
| [1696](#L1696) | try { |
| [1697](#L1697) | //Empty WordPress rewrites count for 404 error. |
| [1698](#L1698) | //This happens when the rules are not saved through config file |
| [1699](#L1699) | HMWP\_Classes\_Tools::saveOptions( 'file\_mappings', array() ); |
| [1700](#L1700) |  |
| [1701](#L1701) | //For debugging |
| [1702](#L1702) | do\_action( 'hmwp\_debug\_cache', '' ); |
| [1703](#L1703) |  |
| [1704](#L1704) | if ( class\_exists( '\FlyingPress\Purge' ) && method\_exists( '\FlyingPress\Purge', 'purge\_everything' ) ) { |
| [1705](#L1705) | \FlyingPress\Purge::purge\_everything(); |
| [1706](#L1706) | } |
| [1707](#L1707) |  |
| [1708](#L1708) | if ( class\_exists( '\JchOptimize\Platform\Cache' ) && method\_exists( '\JchOptimize\Platform\Cache', 'deleteCache' ) ) { |
| [1709](#L1709) | \JchOptimize\Platform\Cache::deleteCache(); |
| [1710](#L1710) | } |
| [1711](#L1711) |  |
| [1712](#L1712) | if ( class\_exists( 'LiteSpeed\_Cache\_API' ) && method\_exists( 'LiteSpeed\_Cache\_API', 'purge\_all' ) ) { |
| [1713](#L1713) | \LiteSpeed\_Cache\_API::purge\_all(); |
| [1714](#L1714) | } |
| [1715](#L1715) | ////////////////////////////////////////////////////////////////////////////// |
| [1716](#L1716) | if ( function\_exists( 'w3tc\_pgcache\_flush' ) ) { |
| [1717](#L1717) | w3tc\_pgcache\_flush(); |
| [1718](#L1718) | } |
| [1719](#L1719) |  |
| [1720](#L1720) | if ( function\_exists( 'w3tc\_minify\_flush' ) ) { |
| [1721](#L1721) | w3tc\_minify\_flush(); |
| [1722](#L1722) | } |
| [1723](#L1723) | if ( function\_exists( 'w3tc\_dbcache\_flush' ) ) { |
| [1724](#L1724) | w3tc\_dbcache\_flush(); |
| [1725](#L1725) | } |
| [1726](#L1726) | if ( function\_exists( 'w3tc\_objectcache\_flush' ) ) { |
| [1727](#L1727) | w3tc\_objectcache\_flush(); |
| [1728](#L1728) | } |
| [1729](#L1729) | ////////////////////////////////////////////////////////////////////////////// |
| [1730](#L1730) |  |
| [1731](#L1731) | if ( function\_exists( 'wp\_cache\_clear\_cache' ) ) { |
| [1732](#L1732) | wp\_cache\_clear\_cache(); |
| [1733](#L1733) | } |
| [1734](#L1734) |  |
| [1735](#L1735) | if ( function\_exists( 'rocket\_clean\_domain' ) && function\_exists( 'rocket\_clean\_minify' ) && function\_exists( 'rocket\_clean\_cache\_busting' ) ) { |
| [1736](#L1736) | // Remove all cache files |
| [1737](#L1737) | rocket\_clean\_domain(); |
| [1738](#L1738) | rocket\_clean\_minify(); |
| [1739](#L1739) | rocket\_clean\_cache\_busting(); |
| [1740](#L1740) | } |
| [1741](#L1741) | ////////////////////////////////////////////////////////////////////////////// |
| [1742](#L1742) |  |
| [1743](#L1743) | if ( function\_exists( 'apc\_clear\_cache' ) ) { |
| [1744](#L1744) | // Remove all apc if enabled |
| [1745](#L1745) | apc\_clear\_cache(); |
| [1746](#L1746) | } |
| [1747](#L1747) | ////////////////////////////////////////////////////////////////////////////// |
| [1748](#L1748) |  |
| [1749](#L1749) | if ( class\_exists( 'Cache\_Enabler\_Disk' ) && method\_exists( 'Cache\_Enabler\_Disk', 'clear\_cache' ) ) { |
| [1750](#L1750) | // clear disk cache |
| [1751](#L1751) | Cache\_Enabler\_Disk::clear\_cache(); |
| [1752](#L1752) | } |
| [1753](#L1753) | ////////////////////////////////////////////////////////////////////////////// |
| [1754](#L1754) |  |
| [1755](#L1755) | if ( class\_exists( 'LiteSpeed\_Cache' ) ) { |
| [1756](#L1756) | LiteSpeed\_Cache::get\_instance()->purge\_all(); |
| [1757](#L1757) | } |
| [1758](#L1758) |  |
| [1759](#L1759) | if ( self::isPluginActive( 'litespeed-cache/litespeed-cache.php' ) ) { |
| [1760](#L1760) | header( "X-LiteSpeed-Purge: \*" ); |
| [1761](#L1761) | } |
| [1762](#L1762) | ////////////////////////////////////////////////////////////////////////////// |
| [1763](#L1763) |  |
| [1764](#L1764) | if ( self::isPluginActive( 'hummingbird-performance/wp-hummingbird.php' ) ) { |
| [1765](#L1765) | do\_action( 'wphb\_clear\_page\_cache' ); |
| [1766](#L1766) | } |
| [1767](#L1767) | ////////////////////////////////////////////////////////////////////////////// |
| [1768](#L1768) |  |
| [1769](#L1769) | if ( class\_exists( 'WpeCommon' ) ) { |
| [1770](#L1770) | if ( method\_exists( 'WpeCommon', 'purge\_memcached' ) ) { |
| [1771](#L1771) | WpeCommon::purge\_memcached(); |
| [1772](#L1772) | } |
| [1773](#L1773) | if ( method\_exists( 'WpeCommon', 'clear\_maxcdn\_cache' ) ) { |
| [1774](#L1774) | WpeCommon::clear\_maxcdn\_cache(); |
| [1775](#L1775) | } |
| [1776](#L1776) | if ( method\_exists( 'WpeCommon', 'purge\_varnish\_cache' ) ) { |
| [1777](#L1777) | WpeCommon::purge\_varnish\_cache(); |
| [1778](#L1778) | } |
| [1779](#L1779) | } |
| [1780](#L1780) | ////////////////////////////////////////////////////////////////////////////// |
| [1781](#L1781) |  |
| [1782](#L1782) | if ( self::isPluginActive( 'sg-cachepress/sg-cachepress.php' ) && class\_exists( 'Supercacher' ) ) { |
| [1783](#L1783) | if ( method\_exists( 'Supercacher', 'purge\_cache' ) && method\_exists( 'Supercacher', 'delete\_assets' ) ) { |
| [1784](#L1784) | Supercacher::purge\_cache(); |
| [1785](#L1785) | Supercacher::delete\_assets(); |
| [1786](#L1786) | } |
| [1787](#L1787) | } |
| [1788](#L1788) |  |
| [1789](#L1789) | //Clear the fastest cache |
| [1790](#L1790) | global $wp\_fastest\_cache; |
| [1791](#L1791) | if ( isset( $wp\_fastest\_cache ) && method\_exists( $wp\_fastest\_cache, 'deleteCache' ) ) { |
| [1792](#L1792) | $wp\_fastest\_cache->deleteCache(); |
| [1793](#L1793) | } |
| [1794](#L1794) | ////////////////////////////////////////////////////////////////////////////// |
| [1795](#L1795) | } catch ( Exception $e ) { |
| [1796](#L1796) | // handle exception |
| [1797](#L1797) | } |
| [1798](#L1798) |  |
| [1799](#L1799) | } |
| [1800](#L1800) |  |
| [1801](#L1801) | /\*\* |
| [1802](#L1802) | \* Flush the WordPress rewrites |
| [1803](#L1803) | \*/ |
| [1804](#L1804) | public static function flushWPRewrites() { |
| [1805](#L1805) | if ( HMWP\_Classes\_Tools::isPluginActive( 'woocommerce/woocommerce.php' ) ) { |
| [1806](#L1806) | update\_option( 'woocommerce\_queue\_flush\_rewrite\_rules', 'yes' ); |
| [1807](#L1807) | } |
| [1808](#L1808) |  |
| [1809](#L1809) | } |
| [1810](#L1810) |  |
| [1811](#L1811) | /\*\* |
| [1812](#L1812) | \* Called on plugin activation |
| [1813](#L1813) | \* |
| [1814](#L1814) | \* @throws Exception |
| [1815](#L1815) | \*/ |
| [1816](#L1816) | public function hmwp\_activate() { |
| [1817](#L1817) | set\_transient( 'hmwp\_activate', true ); |
| [1818](#L1818) |  |
| [1819](#L1819) | //set restore settings option on plugin activate |
| [1820](#L1820) | $lastsafeoptions = self::getOptions( true ); |
| [1821](#L1821) | if ( isset( $lastsafeoptions['hmwp\_mode'] ) && ( $lastsafeoptions['hmwp\_mode'] == 'ninja' || $lastsafeoptions['hmwp\_mode'] == 'lite' ) ) { |
| [1822](#L1822) | set\_transient( 'hmwp\_restore', true ); |
| [1823](#L1823) | } |
| [1824](#L1824) |  |
| [1825](#L1825) | //Initialize the compatibility with other plugins |
| [1826](#L1826) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Compatibility' )->install(); |
| [1827](#L1827) | } |
| [1828](#L1828) |  |
| [1829](#L1829) | /\*\* |
| [1830](#L1830) | \* Called on plugin deactivation |
| [1831](#L1831) | \* Remove all the rewrite rules on deactivation |
| [1832](#L1832) | \* |
| [1833](#L1833) | \* @throws Exception |
| [1834](#L1834) | \*/ |
| [1835](#L1835) | public function hmwp\_deactivate() { |
| [1836](#L1836) | $options = self::$default; |
| [1837](#L1837) | //Prevent duplicates |
| [1838](#L1838) | foreach ( $options as $key => $value ) { |
| [1839](#L1839) | //set the default params from tools |
| [1840](#L1840) | self::saveOptions( $key, $value ); |
| [1841](#L1841) | } |
| [1842](#L1842) |  |
| [1843](#L1843) | //remove user capability |
| [1844](#L1844) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_RoleManager' )->removeHMWPCaps(); |
| [1845](#L1845) |  |
| [1846](#L1846) | //remove the custom rules |
| [1847](#L1847) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rules' )->writeToFile( '', 'HMWP\_VULNERABILITY' ); |
| [1848](#L1848) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rules' )->writeToFile( '', 'HMWP\_RULES' ); |
| [1849](#L1849) |  |
| [1850](#L1850) | //clear the locked ips |
| [1851](#L1851) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Controllers\_Brute' )->clearBlockedIPs(); |
| [1852](#L1852) |  |
| [1853](#L1853) | //Build the redirect table |
| [1854](#L1854) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rewrite' )->flushChanges(); |
| [1855](#L1855) |  |
| [1856](#L1856) | //Delete the compatibility with other plugins |
| [1857](#L1857) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Compatibility' )->uninstall(); |
| [1858](#L1858) | } |
| [1859](#L1859) |  |
| [1860](#L1860) | /\*\* |
| [1861](#L1861) | \* Call this function on rewrite update from other plugins |
| [1862](#L1862) | \* |
| [1863](#L1863) | \* @param  array  $wp\_rules |
| [1864](#L1864) | \* |
| [1865](#L1865) | \* @return array |
| [1866](#L1866) | \* @throws Exception |
| [1867](#L1867) | \*/ |
| [1868](#L1868) | public function checkRewriteUpdate( $wp\_rules = array() ) { |
| [1869](#L1869) | try { |
| [1870](#L1870) | if ( ! HMWP\_Classes\_Tools::getOption( 'error' ) && ! HMWP\_Classes\_Tools::getOption( 'logout' ) ) { |
| [1871](#L1871) |  |
| [1872](#L1872) | //Build the redirect table |
| [1873](#L1873) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rewrite' )->clearRedirect()->setRewriteRules()->flushRewrites(); |
| [1874](#L1874) |  |
| [1875](#L1875) | //INSERT SEURITY RULES |
| [1876](#L1876) | if ( ! HMWP\_Classes\_Tools::isIIS() ) { |
| [1877](#L1877) | //For Nginx and Apache the rules can be inserted separately |
| [1878](#L1878) | $rules = HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rules' )->getInjectionRewrite(); |
| [1879](#L1879) |  |
| [1880](#L1880) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rules' )->writeToFile( $rules, 'HMWP\_VULNERABILITY' ); |
| [1881](#L1881) |  |
| [1882](#L1882) | } |
| [1883](#L1883) | } |
| [1884](#L1884) |  |
| [1885](#L1885) | } catch ( Exception $e ) { |
| [1886](#L1886) |  |
| [1887](#L1887) | } |
| [1888](#L1888) |  |
| [1889](#L1889) | return $wp\_rules; |
| [1890](#L1890) | } |
| [1891](#L1891) |  |
| [1892](#L1892) | /\*\* |
| [1893](#L1893) | \* Check if new themes or plugins are added in WordPress |
| [1894](#L1894) | \*/ |
| [1895](#L1895) | public function checkPluginsThemesUpdates() { |
| [1896](#L1896) |  |
| [1897](#L1897) | try { |
| [1898](#L1898) | //Check if tere are plugins added to website |
| [1899](#L1899) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_hide\_plugins' ) ) { |
| [1900](#L1900) | $all\_plugins = HMWP\_Classes\_Tools::getAllPlugins(); |
| [1901](#L1901) | $dbplugins   = HMWP\_Classes\_Tools::getOption( 'hmwp\_plugins' ); |
| [1902](#L1902) | foreach ( $all\_plugins as $plugin ) { |
| [1903](#L1903) | if ( function\_exists( 'is\_plugin\_active' ) && is\_plugin\_active( $plugin ) && isset( $dbplugins['from'] ) && ! empty( $dbplugins['from'] ) ) { |
| [1904](#L1904) | if ( ! in\_array( plugin\_dir\_path( $plugin ), $dbplugins['from'] ) ) { |
| [1905](#L1905) | HMWP\_Classes\_Tools::saveOptions( 'changes', true ); |
| [1906](#L1906) | } |
| [1907](#L1907) | } |
| [1908](#L1908) | } |
| [1909](#L1909) | } |
| [1910](#L1910) |  |
| [1911](#L1911) | //Check if there are themes added to website |
| [1912](#L1912) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_hide\_themes' ) ) { |
| [1913](#L1913) |  |
| [1914](#L1914) | //Initialize WordPress Filesystem |
| [1915](#L1915) | $wp\_filesystem = HMWP\_Classes\_ObjController::initFilesystem(); |
| [1916](#L1916) |  |
| [1917](#L1917) | $all\_themes = HMWP\_Classes\_Tools::getAllThemes(); |
| [1918](#L1918) | $dbthemes   = HMWP\_Classes\_Tools::getOption( 'hmwp\_themes' ); |
| [1919](#L1919) | foreach ( $all\_themes as $theme => $value ) { |
| [1920](#L1920) | if ( $wp\_filesystem->is\_dir( $value['theme\_root'] ) && isset( $dbthemes['from'] ) && ! empty( $dbthemes['from'] ) ) { |
| [1921](#L1921) | if ( ! in\_array( $theme . '/', $dbthemes['from'] ) ) { |
| [1922](#L1922) | HMWP\_Classes\_Tools::saveOptions( 'changes', true ); |
| [1923](#L1923) | } |
| [1924](#L1924) | } |
| [1925](#L1925) | } |
| [1926](#L1926) | } |
| [1927](#L1927) |  |
| [1928](#L1928) | //If there are changed (new plugins, new themes) |
| [1929](#L1929) | if ( self::getOption( 'changes' ) ) { |
| [1930](#L1930) | //Initialize the compatibility with other plugins |
| [1931](#L1931) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Compatibility' )->install(); |
| [1932](#L1932) | } |
| [1933](#L1933) | } catch ( Exception $e ) { |
| [1934](#L1934) |  |
| [1935](#L1935) | } |
| [1936](#L1936) | } |
| [1937](#L1937) |  |
| [1938](#L1938) | /\*\* |
| [1939](#L1939) | \* Send the login URL to Cloud for this URL |
| [1940](#L1940) | \* |
| [1941](#L1941) | \* @return void |
| [1942](#L1942) | \*/ |
| [1943](#L1943) | public static function sendLoginPathsApi() { |
| [1944](#L1944) |  |
| [1945](#L1945) | if ( HMWP\_Classes\_Tools::getOption( 'api\_token' ) ) { |
| [1946](#L1946) |  |
| [1947](#L1947) | $domain  = ( self::isMultisites() && defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) ? get\_home\_url( BLOG\_ID\_CURRENT\_SITE ) : home\_url(); |
| [1948](#L1948) | $options = array( 'timeout' => 10, 'headers' => array( 'USER-URL' => $domain ) ); |
| [1949](#L1949) |  |
| [1950](#L1950) | $login = array( |
| [1951](#L1951) | 'path'      => HMWP\_Classes\_Tools::getOption( 'hmwp\_login\_url' ), |
| [1952](#L1952) | 'parameter' => HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_name' ), |
| [1953](#L1953) | 'value'     => HMWP\_Classes\_Tools::getOption( 'hmwp\_disable' ), |
| [1954](#L1954) | ); |
| [1955](#L1955) |  |
| [1956](#L1956) | self::hmwp\_remote\_post( \_HMWP\_API\_SITE\_ . '/api/settings', array( |
| [1957](#L1957) | 'login' => wp\_json\_encode( $login ), |
| [1958](#L1958) | 'url'   => $domain |
| [1959](#L1959) | ), $options ); |
| [1960](#L1960) | } |
| [1961](#L1961) | } |
| [1962](#L1962) |  |
| [1963](#L1963) | /\*\* |
| [1964](#L1964) | \* Call Account API Server |
| [1965](#L1965) | \* |
| [1966](#L1966) | \* @param  string  $email |
| [1967](#L1967) | \* @param  string  $redirect\_to |
| [1968](#L1968) | \* |
| [1969](#L1969) | \* @return array|mixed|void |
| [1970](#L1970) | \*/ |
| [1971](#L1971) | public static function checkAccountApi( $email = null, $redirect\_to = '' ) { |
| [1972](#L1972) |  |
| [1973](#L1973) | $check   = array(); |
| [1974](#L1974) | $monitor = HMWP\_Classes\_Tools::getValue( 'hmwp\_monitor', 0 ); |
| [1975](#L1975) | $domain  = ( self::isMultisites() && defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) ? get\_home\_url( BLOG\_ID\_CURRENT\_SITE ) : home\_url(); |
| [1976](#L1976) |  |
| [1977](#L1977) | if ( isset( $email ) && $email <> '' ) { |
| [1978](#L1978) | $args     = array( |
| [1979](#L1979) | 'email'        => $email, |
| [1980](#L1980) | 'url'          => $domain, |
| [1981](#L1981) | 'howtolessons' => 1, |
| [1982](#L1982) | 'monitor'      => (int) $monitor, |
| [1983](#L1983) | 'source'       => 'hide-my-wp' |
| [1984](#L1984) | ); |
| [1985](#L1985) | $response = HMWP\_Classes\_Tools::hmwp\_remote\_get( \_HMWP\_API\_SITE\_ . '/api/free/token', $args, array( 'timeout' => 10 ) ); |
| [1986](#L1986) | } elseif ( HMWP\_Classes\_Tools::getOption( 'hmwp\_token' ) ) { |
| [1987](#L1987) | $args     = array( |
| [1988](#L1988) | 'token'        => self::getOption( 'hmwp\_token' ), |
| [1989](#L1989) | 'url'          => $domain, |
| [1990](#L1990) | 'howtolessons' => 1, |
| [1991](#L1991) | 'monitor'      => (int) $monitor, |
| [1992](#L1992) | 'source'       => 'hide-my-wp' |
| [1993](#L1993) | ); |
| [1994](#L1994) | $response = HMWP\_Classes\_Tools::hmwp\_remote\_get( \_HMWP\_API\_SITE\_ . '/api/free/token', $args, array( 'timeout' => 10 ) ); |
| [1995](#L1995) | } else { |
| [1996](#L1996) | return $check; |
| [1997](#L1997) | } |
| [1998](#L1998) |  |
| [1999](#L1999) | if ( $response && $response = json\_decode( $response, true ) ) { |
| [2000](#L2000) |  |
| [2001](#L2001) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_token', ( isset( $response['token'] ) ? $response['token'] : 0 ) ); |
| [2002](#L2002) | HMWP\_Classes\_Tools::saveOptions( 'api\_token', ( isset( $response['api\_token'] ) ? $response['api\_token'] : false ) ); |
| [2003](#L2003) | HMWP\_Classes\_Tools::saveOptions( 'error', isset( $response['error'] ) ); |
| [2004](#L2004) |  |
| [2005](#L2005) | if ( ! isset( $response['error'] ) ) { |
| [2006](#L2006) | if ( $redirect\_to <> '' ) { |
| [2007](#L2007) | wp\_redirect( $redirect\_to ); |
| [2008](#L2008) | exit(); |
| [2009](#L2009) | } |
| [2010](#L2010) | } elseif ( isset( $response['message'] ) ) { |
| [2011](#L2011) | HMWP\_Classes\_Error::setNotification( $response['message'], 'notice', false ); |
| [2012](#L2012) | } |
| [2013](#L2013) | } else { |
| [2014](#L2014) | HMWP\_Classes\_Error::setNotification( sprintf( \_\_( 'CONNECTION ERROR! Make sure your website can access: %s', 'hide-my-wp' ), '<a href="' . \_HMWP\_ACCOUNT\_SITE\_ . '" target="\_blank">' . \_HMWP\_ACCOUNT\_SITE\_ . '</a>' ), 'notice', false ); |
| [2015](#L2015) | } |
| [2016](#L2016) |  |
| [2017](#L2017) | return $response; |
| [2018](#L2018) |  |
| [2019](#L2019) | } |
| [2020](#L2020) |  |
| [2021](#L2021) | /\*\* |
| [2022](#L2022) | \* Verify the API response on update |
| [2023](#L2023) | \* |
| [2024](#L2024) | \* @param  $result |
| [2025](#L2025) | \*/ |
| [2026](#L2026) | public function checkLicenseOnUpdate( $result ) { |
| [2027](#L2027) |  |
| [2028](#L2028) | // check the token |
| [2029](#L2029) | if ( ! self::getOption( 'hmwp\_token' ) ) { |
| [2030](#L2030) | return; |
| [2031](#L2031) | } |
| [2032](#L2032) |  |
| [2033](#L2033) | if ( $body = json\_decode( wp\_remote\_retrieve\_body( $result ) ) ) { |
| [2034](#L2034) |  |
| [2035](#L2035) | //if data received is valid |
| [2036](#L2036) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_valid', 1 ); |
| [2037](#L2037) |  |
| [2038](#L2038) | if ( isset( $body->expires ) && (int) $body->expires > 0 && (int) $body->expires < time() ) { |
| [2039](#L2039) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_valid', 0 ); |
| [2040](#L2040) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_expires', $body->expires ); |
| [2041](#L2041) | } elseif ( isset( $body->download\_url ) && ! $body->download\_url ) { |
| [2042](#L2042) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_valid', 0 ); |
| [2043](#L2043) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_expires', 0 ); |
| [2044](#L2044) | } |
| [2045](#L2045) |  |
| [2046](#L2046) | } else { |
| [2047](#L2047) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_valid', 0 ); |
| [2048](#L2048) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_expires', 0 ); |
| [2049](#L2049) | } |
| [2050](#L2050) |  |
| [2051](#L2051) | } |
| [2052](#L2052) |  |
| [2053](#L2053) | /\*\* |
| [2054](#L2054) | \* Send the email is case there are major changes |
| [2055](#L2055) | \* |
| [2056](#L2056) | \* @return bool |
| [2057](#L2057) | \*/ |
| [2058](#L2058) | public static function sendEmail() { |
| [2059](#L2059) | $email = self::getOption( 'hmwp\_email\_address' ); |
| [2060](#L2060) | if ( $email == '' ) { |
| [2061](#L2061) | global $current\_user; |
| [2062](#L2062) | $email = $current\_user->user\_email; |
| [2063](#L2063) | } |
| [2064](#L2064) |  |
| [2065](#L2065) | $line    = "\n" . "\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_" . "\n"; |
| [2066](#L2066) | $to      = $email; |
| [2067](#L2067) | $subject = self::getOption( 'hmwp\_plugin\_name' ) . ' - ' . esc\_html\_\_( 'New Login Data', 'hide-my-wp' ); |
| [2068](#L2068) | $message = sprintf( esc\_html\_\_( "Thank you for using %s!", 'hide-my-wp' ), self::getOption( 'hmwp\_plugin\_name' ) ) . "\n"; |
| [2069](#L2069) | $message .= $line; |
| [2070](#L2070) | $message .= esc\_html\_\_( "Your new site URLs are", 'hide-my-wp' ) . ':' . "\n"; |
| [2071](#L2071) | $message .= esc\_html\_\_( "Admin URL", 'hide-my-wp' ) . ': ' . admin\_url() . "\n"; |
| [2072](#L2072) | $message .= esc\_html\_\_( "Login URL", 'hide-my-wp' ) . ': ' . site\_url( self::$options['hmwp\_login\_url'] ) . "\n"; |
| [2073](#L2073) | $message .= $line; |
| [2074](#L2074) | $message .= esc\_html\_\_( "Note: If you can`t login to your site, just access this URL", 'hide-my-wp' ) . ':' . "\n"; |
| [2075](#L2075) | $message .= site\_url() . "/wp-login.php?" . self::getOption( 'hmwp\_disable\_name' ) . "=" . self::$options['hmwp\_disable'] . "\n\n"; |
| [2076](#L2076) | $message .= $line; |
| [2077](#L2077) | $message .= esc\_html\_\_( "Best regards", 'hide-my-wp' ) . ',' . "\n"; |
| [2078](#L2078) | $message .= self::getOption( 'hmwp\_plugin\_name' ) . "\n"; |
| [2079](#L2079) |  |
| [2080](#L2080) | $headers   = array(); |
| [2081](#L2081) | $headers[] = sprintf( esc\_html\_\_( "From: %s <%s>", 'hide-my-wp' ), self::getOption( 'hmwp\_plugin\_name' ), $email ); |
| [2082](#L2082) | $headers[] = 'Content-type: text/plain'; |
| [2083](#L2083) |  |
| [2084](#L2084) | add\_filter( 'wp\_mail\_content\_type', array( 'HMWP\_Classes\_Tools', 'setContentType' ) ); |
| [2085](#L2085) |  |
| [2086](#L2086) | if ( @wp\_mail( $to, $subject, $message, $headers ) ) { |
| [2087](#L2087) | return true; |
| [2088](#L2088) | } |
| [2089](#L2089) |  |
| [2090](#L2090) | return false; |
| [2091](#L2091) | } |
| [2092](#L2092) |  |
| [2093](#L2093) | /\*\* |
| [2094](#L2094) | \* Set the content type to text/plain |
| [2095](#L2095) | \* |
| [2096](#L2096) | \* @return string |
| [2097](#L2097) | \*/ |
| [2098](#L2098) | public static function setContentType() { |
| [2099](#L2099) | return "text/plain"; |
| [2100](#L2100) | } |
| [2101](#L2101) |  |
| [2102](#L2102) | /\*\* |
| [2103](#L2103) | \* Set the current user role for later use |
| [2104](#L2104) | \* |
| [2105](#L2105) | \* @param  WP\_User  $user |
| [2106](#L2106) | \* |
| [2107](#L2107) | \* @return string |
| [2108](#L2108) | \*/ |
| [2109](#L2109) | public static function setCurrentUserRole( $user = null ) { |
| [2110](#L2110) | $roles = array(); |
| [2111](#L2111) |  |
| [2112](#L2112) | if ( isset( $user ) && isset( $user->roles ) && is\_array( $user->roles ) ) { |
| [2113](#L2113) | $roles = $user->roles; |
| [2114](#L2114) | } elseif ( function\_exists( 'wp\_get\_current\_user' ) ) { |
| [2115](#L2115) | $user = wp\_get\_current\_user(); |
| [2116](#L2116) |  |
| [2117](#L2117) | if ( isset( $user->roles ) && is\_array( $user->roles ) ) { |
| [2118](#L2118) | $roles = $user->roles; |
| [2119](#L2119) | } |
| [2120](#L2120) | } |
| [2121](#L2121) |  |
| [2122](#L2122) | if ( ! empty( $roles ) ) { |
| [2123](#L2123) | self::$current\_user\_role = current( $roles ); |
| [2124](#L2124) | } |
| [2125](#L2125) |  |
| [2126](#L2126) | return self::$current\_user\_role; |
| [2127](#L2127) | } |
| [2128](#L2128) |  |
| [2129](#L2129) | /\*\* |
| [2130](#L2130) | \* Get the user main Role or default |
| [2131](#L2131) | \* |
| [2132](#L2132) | \* @return string |
| [2133](#L2133) | \*/ |
| [2134](#L2134) | public static function getUserRole() { |
| [2135](#L2135) | return self::$current\_user\_role; |
| [2136](#L2136) | } |
| [2137](#L2137) |  |
| [2138](#L2138) | /\*\* |
| [2139](#L2139) | \* Check the user capability for the roles attached |
| [2140](#L2140) | \* |
| [2141](#L2141) | \* @param  $cap |
| [2142](#L2142) | \* |
| [2143](#L2143) | \* @return bool |
| [2144](#L2144) | \*/ |
| [2145](#L2145) | public static function userCan( $cap ) { |
| [2146](#L2146) |  |
| [2147](#L2147) | if ( function\_exists( 'current\_user\_can' ) ) { |
| [2148](#L2148) |  |
| [2149](#L2149) | if ( current\_user\_can( $cap ) ) { |
| [2150](#L2150) | return true; |
| [2151](#L2151) | } |
| [2152](#L2152) |  |
| [2153](#L2153) | //Get the current user roles |
| [2154](#L2154) | $user = wp\_get\_current\_user(); |
| [2155](#L2155) |  |
| [2156](#L2156) | //If the user has multiple roles |
| [2157](#L2157) | if ( isset( $user->roles ) && is\_array( $user->roles ) && count( $user->roles ) > 1 ) { |
| [2158](#L2158) | foreach ( $user->roles as $role ) { |
| [2159](#L2159) |  |
| [2160](#L2160) | //Get the role |
| [2161](#L2161) | $role\_object = get\_role( $role ); |
| [2162](#L2162) |  |
| [2163](#L2163) | //Check if it has capability |
| [2164](#L2164) | if ( $role\_object->has\_cap( $cap ) ) { |
| [2165](#L2165) | return true; |
| [2166](#L2166) | } |
| [2167](#L2167) | } |
| [2168](#L2168) | } |
| [2169](#L2169) |  |
| [2170](#L2170) | } |
| [2171](#L2171) |  |
| [2172](#L2172) | return false; |
| [2173](#L2173) | } |
| [2174](#L2174) |  |
| [2175](#L2175) | /\*\* |
| [2176](#L2176) | \* Search for a substring within an array of strings. |
| [2177](#L2177) | \* |
| [2178](#L2178) | \* @param  string  $needle  The substring to search for. |
| [2179](#L2179) | \* @param  array  $haystack  The array of strings to search within. |
| [2180](#L2180) | \* |
| [2181](#L2181) | \* @return bool  True if the substring is found in any of the strings in the array, false otherwise. |
| [2182](#L2182) | \*/ |
| [2183](#L2183) | public static function searchInString( $needle, $haystack ) { |
| [2184](#L2184) | foreach ( $haystack as $value ) { |
| [2185](#L2185) | if ( $needle && $value && $needle <> '' && $value <> '' ) { |
| [2186](#L2186) |  |
| [2187](#L2187) | //add trail slash to make sure the path matches entirely |
| [2188](#L2188) | $needle = trailingslashit( $needle ); |
| [2189](#L2189) | $value  = trailingslashit( $value ); |
| [2190](#L2190) |  |
| [2191](#L2191) | //use mb\_stripos is possible |
| [2192](#L2192) | if ( function\_exists( 'mb\_stripos' ) ) { |
| [2193](#L2193) | if ( mb\_stripos( $needle, $value ) !== false ) { |
| [2194](#L2194) | return true; |
| [2195](#L2195) | } |
| [2196](#L2196) | } elseif ( stripos( $needle, $value ) !== false ) { |
| [2197](#L2197) | return true; |
| [2198](#L2198) | } |
| [2199](#L2199) | } |
| [2200](#L2200) | } |
| [2201](#L2201) |  |
| [2202](#L2202) | return false; |
| [2203](#L2203) | } |
| [2204](#L2204) |  |
| [2205](#L2205) | /\*\* |
| [2206](#L2206) | \* Customize the redirect for the logout process |
| [2207](#L2207) | \* |
| [2208](#L2208) | \* @param  $redirect |
| [2209](#L2209) | \* |
| [2210](#L2210) | \* @return mixed |
| [2211](#L2211) | \*/ |
| [2212](#L2212) | public static function getCustomLogoutURL( $redirect ) { |
| [2213](#L2213) | //Get Logout based on user Role |
| [2214](#L2214) | $role         = HMWP\_Classes\_Tools::getUserRole(); |
| [2215](#L2215) | $urlRedirects = HMWP\_Classes\_Tools::getOption( 'hmwp\_url\_redirects' ); |
| [2216](#L2216) | if ( isset( $urlRedirects[ $role ]['logout'] ) && $urlRedirects[ $role ]['logout'] <> '' ) { |
| [2217](#L2217) | $redirect = $urlRedirects[ $role ]['logout']; |
| [2218](#L2218) | } elseif ( isset( $urlRedirects['default']['logout'] ) && $urlRedirects['default']['logout'] <> '' ) { |
| [2219](#L2219) | $redirect = $urlRedirects['default']['logout']; |
| [2220](#L2220) | } |
| [2221](#L2221) |  |
| [2222](#L2222) | return $redirect; |
| [2223](#L2223) | } |
| [2224](#L2224) |  |
| [2225](#L2225) | /\*\* |
| [2226](#L2226) | \* Customize the redirect for the login process |
| [2227](#L2227) | \* |
| [2228](#L2228) | \* @param  string  $redirect |
| [2229](#L2229) | \* |
| [2230](#L2230) | \* @return string |
| [2231](#L2231) | \*/ |
| [2232](#L2232) | public static function getCustomLoginURL( $redirect ) { |
| [2233](#L2233) |  |
| [2234](#L2234) | //Get Logout based on user Role |
| [2235](#L2235) | $role         = HMWP\_Classes\_Tools::getUserRole(); |
| [2236](#L2236) | $urlRedirects = HMWP\_Classes\_Tools::getOption( 'hmwp\_url\_redirects' ); |
| [2237](#L2237) | if ( isset( $urlRedirects[ $role ]['login'] ) && $urlRedirects[ $role ]['login'] <> '' ) { |
| [2238](#L2238) | $redirect = $urlRedirects[ $role ]['login']; |
| [2239](#L2239) | } elseif ( isset( $urlRedirects['default']['login'] ) && $urlRedirects['default']['login'] <> '' ) { |
| [2240](#L2240) | $redirect = $urlRedirects['default']['login']; |
| [2241](#L2241) | } |
| [2242](#L2242) |  |
| [2243](#L2243) | return $redirect; |
| [2244](#L2244) | } |
| [2245](#L2245) |  |
| [2246](#L2246) | /\*\* |
| [2247](#L2247) | \* Generate a string |
| [2248](#L2248) | \* |
| [2249](#L2249) | \* @param  int  $length |
| [2250](#L2250) | \* |
| [2251](#L2251) | \* @return bool|string |
| [2252](#L2252) | \*/ |
| [2253](#L2253) | public static function generateRandomString( $length = 10 ) { |
| [2254](#L2254) | return substr( str\_shuffle( str\_repeat( $x = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', ceil( $length / strlen( $x ) ) ) ), 1, $length ); |
| [2255](#L2255) | } |
| [2256](#L2256) |  |
| [2257](#L2257) | /\*\* |
| [2258](#L2258) | \* make hidemywp the first plugin that loads |
| [2259](#L2259) | \*/ |
| [2260](#L2260) | public static function movePluginFirst() { |
| [2261](#L2261) | //Make sure the plugin is loaded first |
| [2262](#L2262) | $plugin         = dirname( HMWP\_BASENAME ) . '/index.php'; |
| [2263](#L2263) | $active\_plugins = get\_option( 'active\_plugins' ); |
| [2264](#L2264) |  |
| [2265](#L2265) | if ( ! empty( $active\_plugins ) ) { |
| [2266](#L2266) |  |
| [2267](#L2267) | $this\_plugin\_key = array\_search( $plugin, $active\_plugins ); |
| [2268](#L2268) |  |
| [2269](#L2269) | if ( $this\_plugin\_key > 0 ) { |
| [2270](#L2270) | array\_splice( $active\_plugins, $this\_plugin\_key, 1 ); |
| [2271](#L2271) | array\_unshift( $active\_plugins, $plugin ); |
| [2272](#L2272) | update\_option( 'active\_plugins', $active\_plugins ); |
| [2273](#L2273) |  |
| [2274](#L2274) |  |
| [2275](#L2275) | } |
| [2276](#L2276) |  |
| [2277](#L2277) | } |
| [2278](#L2278) | } |
| [2279](#L2279) |  |
| [2280](#L2280) | /\*\* |
| [2281](#L2281) | \* Instantiates the WordPress filesystem |
| [2282](#L2282) | \* |
| [2283](#L2283) | \* @static |
| [2284](#L2284) | \* @access public |
| [2285](#L2285) | \* @return WP\_Filesystem\_Base|WP\_Filesystem\_Direct |
| [2286](#L2286) | \*/ |
| [2287](#L2287) | public static function initFilesystem() { |
| [2288](#L2288) | return HMWP\_Classes\_ObjController::initFilesystem(); |
| [2289](#L2289) | } |
| [2290](#L2290) |  |
| [2291](#L2291) | public static function isWhitelistedIP( $ip ) { |
| [2292](#L2292) | $wl\_items = array(); |
| [2293](#L2293) |  |
| [2294](#L2294) | if ( ! filter\_var( $ip, FILTER\_VALIDATE\_IP ) ) { |
| [2295](#L2295) | return true; |
| [2296](#L2296) | } |
| [2297](#L2297) |  |
| [2298](#L2298) | //jetpack whitelist |
| [2299](#L2299) | $wl\_jetpack = array( |
| [2300](#L2300) | '122.248.245.244/32', |
| [2301](#L2301) | '54.217.201.243/32', |
| [2302](#L2302) | '54.232.116.4/32', |
| [2303](#L2303) | '185.64.140.0/22', |
| [2304](#L2304) | '76.74.255.0/22', |
| [2305](#L2305) | '192.0.64.0/18', |
| [2306](#L2306) | '192.0.65.0/22', |
| [2307](#L2307) | '192.0.80.0/22', |
| [2308](#L2308) | '192.0.96.0/22', |
| [2309](#L2309) | '192.0.112.0/20', |
| [2310](#L2310) | '192.0.123.0/22', |
| [2311](#L2311) | '195.234.108.0/22', |
| [2312](#L2312) | '54.148.171.133',//wordfence |
| [2313](#L2313) | '35.83.41.128', //wordfence |
| [2314](#L2314) | '52.25.185.95', //wordfence |
| [2315](#L2315) | ); |
| [2316](#L2316) |  |
| [2317](#L2317) | $domain = ( self::isMultisites() && defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) ? get\_home\_url( BLOG\_ID\_CURRENT\_SITE ) : site\_url(); |
| [2318](#L2318) |  |
| [2319](#L2319) | if ( filter\_var( $domain, FILTER\_VALIDATE\_URL ) !== false && strpos( $domain, '.' ) !== false ) { |
| [2320](#L2320) | if ( ! self::isLocalFlywheel() ) { |
| [2321](#L2321) | $wl\_jetpack[] = '127.0.0.1'; |
| [2322](#L2322) | } |
| [2323](#L2323) | } |
| [2324](#L2324) |  |
| [2325](#L2325) | if ( HMWP\_Classes\_Tools::getOption( 'whitelist\_ip' ) ) { |
| [2326](#L2326) | $wl\_items = (array) json\_decode( HMWP\_Classes\_Tools::getOption( 'whitelist\_ip' ), true ); |
| [2327](#L2327) | } |
| [2328](#L2328) |  |
| [2329](#L2329) | //merge all the whitelisted ips and also add the hook for users |
| [2330](#L2330) | $wl\_items = apply\_filters( 'hmwp\_whitelisted\_ips', array\_merge( $wl\_jetpack, $wl\_items ) ); |
| [2331](#L2331) |  |
| [2332](#L2332) | try { |
| [2333](#L2333) | foreach ( $wl\_items as $item ) { |
| [2334](#L2334) | $item = trim( $item ); |
| [2335](#L2335) |  |
| [2336](#L2336) | if ( filter\_var( $item, FILTER\_VALIDATE\_IP ) && $ip == $item ) { |
| [2337](#L2337) | return true; |
| [2338](#L2338) | } |
| [2339](#L2339) |  |
| [2340](#L2340) | if ( strpos( $item, '\*' ) === false && strpos( $item, '/' ) === false ) { //no match, no wildcard |
| [2341](#L2341) | continue; |
| [2342](#L2342) | } |
| [2343](#L2343) |  |
| [2344](#L2344) | if ( strpos( $ip, '.' ) !== false ) { |
| [2345](#L2345) |  |
| [2346](#L2346) | if ( strpos( $item, '/' ) !== false ) { |
| [2347](#L2347) | list( $range, $bits ) = explode( '/', $item, 2 ); |
| [2348](#L2348) |  |
| [2349](#L2349) | if ( 0 == (int) $bits ) { |
| [2350](#L2350) | continue; |
| [2351](#L2351) | } |
| [2352](#L2352) |  |
| [2353](#L2353) | if ( (int) $bits < 0 || (int) $bits > 32 ) { |
| [2354](#L2354) | continue; |
| [2355](#L2355) | } |
| [2356](#L2356) |  |
| [2357](#L2357) | $subnet = ip2long( $range ); |
| [2358](#L2358) | $iplong = ip2long( $ip ); |
| [2359](#L2359) | $mask   = - 1 << ( 32 - $bits ); |
| [2360](#L2360) | $subnet &= $mask; |
| [2361](#L2361) |  |
| [2362](#L2362) | if ( ( $iplong & $mask ) == $subnet ) { |
| [2363](#L2363) | return true; |
| [2364](#L2364) | } |
| [2365](#L2365) | } |
| [2366](#L2366) |  |
| [2367](#L2367) | $iplong  = ip2long( $ip ); |
| [2368](#L2368) | $ip\_low  = ip2long( str\_replace( '\*', '0', $item ) ); |
| [2369](#L2369) | $ip\_high = ip2long( str\_replace( '\*', '255', $item ) ); |
| [2370](#L2370) |  |
| [2371](#L2371) | if ( $iplong >= $ip\_low && $iplong <= $ip\_high ) {//IP is within wildcard range |
| [2372](#L2372) | return true; |
| [2373](#L2373) | } |
| [2374](#L2374) | } |
| [2375](#L2375) |  |
| [2376](#L2376) | } |
| [2377](#L2377) | } catch ( Exception $e ) { |
| [2378](#L2378) | } |
| [2379](#L2379) |  |
| [2380](#L2380) | return false; |
| [2381](#L2381) | } |
| [2382](#L2382) |  |
| [2383](#L2383) | /\*\* |
| [2384](#L2384) | \* Check if there are banned IPs for accessing the hidden paths |
| [2385](#L2385) | \* |
| [2386](#L2386) | \* @return bool |
| [2387](#L2387) | \*/ |
| [2388](#L2388) | public static function isBlacklistedIP( $ip ) { |
| [2389](#L2389) | $bl\_items = array(); |
| [2390](#L2390) |  |
| [2391](#L2391) | $bl\_blacklisted = array( |
| [2392](#L2392) | '35.214.130.0/22', // detector |
| [2393](#L2393) | '54.86.50.0/22', // detector |
| [2394](#L2394) | '172.105.48.0/22', // detector |
| [2395](#L2395) | '15.235.50.223', // detector |
| [2396](#L2396) | '192.185.4.40', // detector |
| [2397](#L2397) | '172.105.48.130', // detector |
| [2398](#L2398) | '167.99.233.123', // detector |
| [2399](#L2399) | ); |
| [2400](#L2400) |  |
| [2401](#L2401) | if ( HMWP\_Classes\_Tools::getOption( 'banlist\_ip' ) ) { |
| [2402](#L2402) | $bl\_items = (array) json\_decode( HMWP\_Classes\_Tools::getOption( 'banlist\_ip' ), true ); |
| [2403](#L2403) | } |
| [2404](#L2404) |  |
| [2405](#L2405) | //merge all the whitelisted ips and also add the hook for users |
| [2406](#L2406) | $bl\_items = apply\_filters( 'hmwp\_banlist\_ips', array\_merge( $bl\_blacklisted, $bl\_items ) ); |
| [2407](#L2407) |  |
| [2408](#L2408) | try { |
| [2409](#L2409) | foreach ( $bl\_items as $item ) { |
| [2410](#L2410) | $item = trim( $item ); |
| [2411](#L2411) |  |
| [2412](#L2412) | if ( filter\_var( $item, FILTER\_VALIDATE\_IP ) && $ip == $item ) { |
| [2413](#L2413) | return true; |
| [2414](#L2414) | } |
| [2415](#L2415) |  |
| [2416](#L2416) | if ( strpos( $item, '\*' ) === false && strpos( $item, '/' ) === false ) { //no match, no wildcard |
| [2417](#L2417) | continue; |
| [2418](#L2418) | } |
| [2419](#L2419) |  |
| [2420](#L2420) | if ( strpos( $ip, '.' ) !== false ) { |
| [2421](#L2421) |  |
| [2422](#L2422) | if ( strpos( $item, '/' ) !== false ) { |
| [2423](#L2423) | list( $range, $bits ) = explode( '/', $item, 2 ); |
| [2424](#L2424) |  |
| [2425](#L2425) | if ( 0 == (int) $bits ) { |
| [2426](#L2426) | continue; |
| [2427](#L2427) | } |
| [2428](#L2428) |  |
| [2429](#L2429) | if ( (int) $bits < 0 || (int) $bits > 32 ) { |
| [2430](#L2430) | continue; |
| [2431](#L2431) | } |
| [2432](#L2432) |  |
| [2433](#L2433) | $subnet = ip2long( $range ); |
| [2434](#L2434) | $iplong = ip2long( $ip ); |
| [2435](#L2435) | $mask   = - 1 << ( 32 - $bits ); |
| [2436](#L2436) | $subnet &= $mask; |
| [2437](#L2437) |  |
| [2438](#L2438) | if ( ( $iplong & $mask ) == $subnet ) { |
| [2439](#L2439) | return true; |
| [2440](#L2440) | } |
| [2441](#L2441) | } |
| [2442](#L2442) |  |
| [2443](#L2443) | $iplong  = ip2long( $ip ); |
| [2444](#L2444) | $ip\_low  = ip2long( str\_replace( '\*', '0', $item ) ); |
| [2445](#L2445) | $ip\_high = ip2long( str\_replace( '\*', '255', $item ) ); |
| [2446](#L2446) |  |
| [2447](#L2447) | if ( $iplong >= $ip\_low && $iplong <= $ip\_high ) {//IP is within wildcard range |
| [2448](#L2448) | return true; |
| [2449](#L2449) | } |
| [2450](#L2450) | } |
| [2451](#L2451) |  |
| [2452](#L2452) | } |
| [2453](#L2453) | } catch ( Exception $e ) { |
| [2454](#L2454) | } |
| [2455](#L2455) |  |
| [2456](#L2456) | return false; |
| [2457](#L2457) | } |
| [2458](#L2458) |  |
| [2459](#L2459) | /\*\* |
| [2460](#L2460) | \* Check if the Advanced Pack is installed by verifying the definition of a constant. |
| [2461](#L2461) | \* |
| [2462](#L2462) | \* @return bool |
| [2463](#L2463) | \*/ |
| [2464](#L2464) | public static function isAdvancedpackInstalled() { |
| [2465](#L2465) | return ( defined( 'HMWPP\_VERSION' ) ); |
| [2466](#L2466) | } |
| [2467](#L2467) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/hide-my-wp/tags/5.3.01/classes/Tools.php?format=txt)
* [Original Format](/export/3222468/hide-my-wp/tags/5.3.01/classes/Tools.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_6460194d_20250114_203022.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3186489%2Fhide-my-wp%2Ftrunk%2Fclasses%2FTools.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3184244/hide-my-wp/trunk/classes/Tools.php "Changeset 3184244 for hide-my-wp/trunk/classes/Tools.php")
* [Next Change](/changeset/3217720/hide-my-wp/trunk/classes/Tools.php "Changeset 3217720 for hide-my-wp/trunk/classes/Tools.php") →

---

# Changeset [3186489](/changeset/3186489 "Show full changeset") for [hide-my-wp/trunk/classes/Tools.php](/browser/hide-my-wp/trunk/classes/Tools.php?rev=3186489 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
11/12/2024 12:16:41 PM
([2 months](/timeline?from=2024-11-12T12%3A16%3A41Z&precision=second "See timeline at 11/12/2024 12:16:41 PM") ago)

Author:
johndarrel
Message:

Update plugin security

File:

1 edited

* [hide-my-wp/trunk/classes/Tools.php](/browser/hide-my-wp/trunk/classes/Tools.php?rev=3186489 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [hide-my-wp/trunk/classes/Tools.php](/changeset/3186489/hide-my-wp/trunk/classes/Tools.php "Show the changeset 3186489 restricted to hide-my-wp/trunk/classes/Tools.php")

  | [r3184244](/browser/hide-my-wp/trunk/classes/Tools.php?rev=3184244#L631 "Show revision 3184244 of this file in browser") | [r3186489](/browser/hide-my-wp/trunk/classes/Tools.php?rev=3186489#L631 "Show revision 3186489 of this file in browser") |  |
  | --- | --- | --- |
  | 631 | 631 | public function hookActionlink( $links ) { |
  | 632 | 632 | if ( get\_transient( 'hmwp\_disable' ) ) { |
  | 633 |  | $links[] = '<a href="' . add\_query\_arg( array( |
  | 634 |  | 'hmwp\_nonce' => wp\_create\_nonce( 'hmwp\_pause\_disable' ), |
  | 635 |  | 'action'     => 'hmwp\_pause\_disable' |
  | 636 |  | ) ) . '" class="btn btn-default btn-sm mt-3" />' . esc\_html\_\_( "Resume Security", 'hide-my-wp' ) . '</a>'; |
  |  | 633 | $links[] = '<a href="' . esc\_url( add\_query\_arg( array( 'hmwp\_nonce' => wp\_create\_nonce( 'hmwp\_pause\_disable' ), 'action' => 'hmwp\_pause\_disable' ) ) ) . '" class="btn btn-default btn-sm mt-3" />' . esc\_html\_\_( "Resume Security", 'hide-my-wp' ) . '</a>'; |
  | 637 | 634 | } else { |
  | 638 |  | $links[] = '<a href="' . add\_query\_arg( array( |
  | 639 |  | 'hmwp\_nonce' => wp\_create\_nonce( 'hmwp\_pause\_enable' ), |
  | 640 |  | 'action'     => 'hmwp\_pause\_enable' |
  | 641 |  | ) ) . '" class="btn btn-default btn-sm mt-3" />' . esc\_html\_\_( "Pause for 5 minutes", 'hide-my-wp' ) . '</a>'; |
  | 642 |  | } |
  | 643 |  | $links[] = '<a href="' . self::getSettingsUrl() . '">' . esc\_html\_\_( 'Settings', 'hide-my-wp' ) . '</a>'; |
  |  | 635 | $links[] = '<a href="' . esc\_url( add\_query\_arg( array( 'hmwp\_nonce' => wp\_create\_nonce( 'hmwp\_pause\_enable' ), 'action' => 'hmwp\_pause\_enable' ) ) ) . '" class="btn btn-default btn-sm mt-3" />' . esc\_html\_\_( "Pause for 5 minutes", 'hide-my-wp' ) . '</a>'; |
  |  | 636 | } |
  |  | 637 | $links[] = '<a href="' . esc\_url( self::getSettingsUrl() ) . '">' . esc\_html\_\_( 'Settings', 'hide-my-wp' ) . '</a>'; |
  | 644 | 638 | $links[] = '<a href="https://hidemywpghost.com/hide-my-wp-pricing/" target="\_blank" style="font-weight: bold;color: #007cba">' . esc\_html\_\_( 'Go PRO', 'hide-my-wp' ) . '</a>'; |
  | 645 | 639 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3186489)
* [Zip Archive](?format=zip&new=3186489)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_01629913_20250114_203019.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fhide-my-wp%2Ftags%2F5.3.01%2Fclasses%2FTools.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/hide-my-wp/tags/5.3.01/classes/Tools.php?rev=3169238 "Revision 3169238")
* Next Revision →
* [Blame](/browser/hide-my-wp/tags/5.3.01/classes/Tools.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/hide-my-wp/tags/5.3.01/classes/Tools.php)

---

# [source:](/browser?order=name "Go to repository root") [hide-my-wp](/browser/hide-my-wp?order=name "View hide-my-wp")/[tags](/browser/hide-my-wp/tags?order=name "View tags")/[5.3.01](/browser/hide-my-wp/tags/5.3.01?order=name "View 5.3.01")/[classes](/browser/hide-my-wp/tags/5.3.01/classes?order=name "View classes")/[Tools.php](/browser/hide-my-wp/tags/5.3.01/classes/Tools.php?order=name "View Tools.php")

View diff against:

View revision:

| [Last change](/changeset/3186493/hide-my-wp/tags/5.3.01/classes/Tools.php "View differences") on this file was [3186493](/changeset/3186493/ "View changeset 3186493"), checked in by johndarrel, [2 months ago](/timeline?from=2024-11-12T12%3A23%3A55Z&precision=second "See timeline at 11/12/2024 12:23:55 PM") |
| --- |
| Update plugin security |
| **File size:** 71.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Handles the parameters and URLs |
| [4](#L4) | \* |
| [5](#L5) | \* @file The Tools file |
| [6](#L6) | \* @package HMWP/Tools |
| [7](#L7) | \* @since 4.0.0 |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | defined( 'ABSPATH' ) || die( 'Cheatin\' uh?' ); |
| [11](#L11) |  |
| [12](#L12) | class HMWP\_Classes\_Tools { |
| [13](#L13) |  |
| [14](#L14) | /\*\* |
| [15](#L15) | \* Saved options in database. |
| [16](#L16) | \* |
| [17](#L17) | \* @var array |
| [18](#L18) | \*/ |
| [19](#L19) | public static $init = array(), $default = array(), $lite = array(); |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Configuration settings for the application. |
| [22](#L22) | \* |
| [23](#L23) | \* @var array |
| [24](#L24) | \*/ |
| [25](#L25) | public static $options = array(); |
| [26](#L26) | /\*\* |
| [27](#L27) | \* Stores debugging information and configurations. |
| [28](#L28) | \* |
| [29](#L29) | \* @var array |
| [30](#L30) | \*/ |
| [31](#L31) | public static $debug = array(); |
| [32](#L32) | /\*\* |
| [33](#L33) | \* List of active plugins in the system. |
| [34](#L34) | \* |
| [35](#L35) | \* @var array |
| [36](#L36) | \*/ |
| [37](#L37) | public static $active\_plugins; |
| [38](#L38) |  |
| [39](#L39) | /\*\* |
| [40](#L40) | \* Represents the role of the current user. |
| [41](#L41) | \* |
| [42](#L42) | \* @var string |
| [43](#L43) | \*/ |
| [44](#L44) | static $current\_user\_role = 'default'; |
| [45](#L45) |  |
| [46](#L46) | /\*\* |
| [47](#L47) | \* Plugin constructor to initialize options, load multilanguage support, and handle admin-specific tasks. |
| [48](#L48) | \* |
| [49](#L49) | \* @return void |
| [50](#L50) | \*/ |
| [51](#L51) | public function \_\_construct() { |
| [52](#L52) |  |
| [53](#L53) | // Get the plugin options from database |
| [54](#L54) | self::$options = self::getOptions(); |
| [55](#L55) |  |
| [56](#L56) | // Load multilanguage |
| [57](#L57) | add\_action( "init", array( $this, 'loadMultilanguage' ) ); |
| [58](#L58) |  |
| [59](#L59) | // If it's admin panel |
| [60](#L60) | if ( is\_admin() || is\_network\_admin() ) { |
| [61](#L61) | // Check the Plugin database update |
| [62](#L62) | self::updateDatabase(); |
| [63](#L63) |  |
| [64](#L64) | // Add setting link in plugin |
| [65](#L65) | add\_filter( 'plugin\_action\_links\_' . HMWP\_BASENAME, array( $this, 'hookActionlink' ) ); |
| [66](#L66) | add\_filter( 'network\_admin\_plugin\_action\_links\_' . HMWP\_BASENAME, array( $this, 'hookActionlink' ) ); |
| [67](#L67) |  |
| [68](#L68) | // Check plugin license |
| [69](#L69) | add\_action( 'request\_metadata\_http\_result', array( $this, 'checkLicenseOnUpdate' ) ); |
| [70](#L70) |  |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | } |
| [74](#L74) |  |
| [75](#L75) | /\*\* |
| [76](#L76) | \* Load the Options from user option table in DB |
| [77](#L77) | \* |
| [78](#L78) | \* @param  bool  $safe |
| [79](#L79) | \* |
| [80](#L80) | \* @return array |
| [81](#L81) | \*/ |
| [82](#L82) | public static function getOptions( $safe = false ) { |
| [83](#L83) | // Set key metadata based on safe parameter. |
| [84](#L84) | $keymeta = $safe ? HMWP\_OPTION\_SAFE : HMWP\_OPTION; |
| [85](#L85) |  |
| [86](#L86) | // Parse the site URL and plugin/content paths. |
| [87](#L87) | $homepath   = wp\_parse\_url( site\_url(), PHP\_URL\_PATH ) ? ltrim( wp\_parse\_url( site\_url(), PHP\_URL\_PATH ), '/' ) : ''; |
| [88](#L88) | $pluginurl  = ltrim( wp\_parse\_url( plugins\_url(), PHP\_URL\_PATH ), '/' ); |
| [89](#L89) | $contenturl = ltrim( wp\_parse\_url( content\_url(), PHP\_URL\_PATH ), '/' ); |
| [90](#L90) |  |
| [91](#L91) | // Get relative paths for plugin and content URLs. |
| [92](#L92) | $plugin\_relative\_url  = trim( preg\_replace( '/' . str\_replace( '/', '\/', $homepath ) . '/', '', $pluginurl, 1 ), '/' ); |
| [93](#L93) | $content\_relative\_url = trim( preg\_replace( '/' . str\_replace( '/', '\/', $homepath ) . '/', '', $contenturl, 1 ), '/' ); |
| [94](#L94) |  |
| [95](#L95) | // Set default options. |
| [96](#L96) | self::$init = array( |
| [97](#L97) | 'hmwp\_ver'                       => 0, |
| [98](#L98) | //-- |
| [99](#L99) | 'api\_token'                      => false, |
| [100](#L100) | 'hmwp\_token'                     => false, |
| [101](#L101) | //-- |
| [102](#L102) | 'hmwp\_valid'                     => 1, |
| [103](#L103) | 'hmwp\_expires'                   => 0, |
| [104](#L104) | 'hmwp\_disable'                   => HMWP\_Classes\_Tools::generateRandomString( 16 ), |
| [105](#L105) | 'hmwp\_disable\_name'              => HMWP\_Classes\_Tools::generateRandomString( 16 ), |
| [106](#L106) | //-- |
| [107](#L107) | 'hmwp\_plugin\_name'               => \_HMWP\_PLUGIN\_FULL\_NAME\_, |
| [108](#L108) | 'hmwp\_plugin\_menu'               => str\_replace( ' Ghost', '', \_HMWP\_PLUGIN\_FULL\_NAME\_ ), |
| [109](#L109) | 'hmwp\_plugin\_logo'               => false, |
| [110](#L110) | 'hmwp\_plugin\_icon'               => 'dashicons-shield-alt', |
| [111](#L111) | 'hmwp\_plugin\_website'            => 'https://hidemywpghost.com', |
| [112](#L112) | 'hmwp\_plugin\_account\_show'       => 1, |
| [113](#L113) | //-- |
| [114](#L114) | 'logout'                         => 0, |
| [115](#L115) | 'error'                          => 0, |
| [116](#L116) | 'file\_mappings'                  => array(), |
| [117](#L117) | 'test\_frontend'                  => 0, |
| [118](#L118) | 'changes'                        => 0, |
| [119](#L119) | 'admin\_notice'                   => array(), |
| [120](#L120) | 'prevent\_slow\_loading'           => 1, |
| [121](#L121) | 'hmwp\_rewrites\_in\_wp\_rules'      => 0, |
| [122](#L122) | 'hmwp\_server\_type'               => 'auto', |
| [123](#L123) | //-- |
| [124](#L124) | 'hmwp\_loading\_hook'              => array( 'normal' ), //load when the other plugins are initialized |
| [125](#L125) | 'hmwp\_firstload'                 => 0, //load the plugin as Must Use Plugin |
| [126](#L126) | 'hmwp\_priorityload'              => 0, //load the plugin on plugin start |
| [127](#L127) | 'hmwp\_laterload'                 => 0, //load the plugin on template redirect |
| [128](#L128) | //-- |
| [129](#L129) | 'hmwp\_fix\_relative'              => 0, |
| [130](#L130) | 'hmwp\_remove\_third\_hooks'        => 0, |
| [131](#L131) | 'hmwp\_send\_email'                => 0, |
| [132](#L132) | 'hmwp\_activity\_log'              => 0, |
| [133](#L133) | 'hmwp\_activity\_log\_roles'        => array(), |
| [134](#L134) | 'hmwp\_email\_address'             => '', |
| [135](#L135) |  |
| [136](#L136) | //-- Firewall |
| [137](#L137) | 'whitelist\_ip'                   => array(), |
| [138](#L138) | 'whitelist\_paths'                => 0, |
| [139](#L139) | 'whitelist\_urls'                 => array(), |
| [140](#L140) | 'banlist\_ip'                     => array(), |
| [141](#L141) | 'banlist\_hostname'               => array(), |
| [142](#L142) | 'banlist\_user\_agent'             => array(), |
| [143](#L143) | 'banlist\_referrer'               => array(), |
| [144](#L144) |  |
| [145](#L145) | //Temporary Login |
| [146](#L146) | 'hmwp\_templogin'                 => 0, |
| [147](#L147) | 'hmwp\_templogin\_role'            => 'administrator', |
| [148](#L148) | 'hmwp\_templogin\_redirect'        => false, |
| [149](#L149) | 'hmwp\_templogin\_delete\_uninstal' => false, |
| [150](#L150) |  |
| [151](#L151) | //Geoblock Login |
| [152](#L152) | 'hmwp\_geoblock'                  => 0, |
| [153](#L153) | 'hmwp\_geoblock\_countries'        => array(), |
| [154](#L154) | 'hmwp\_geoblock\_urls'             => array(), |
| [155](#L155) |  |
| [156](#L156) | //2FA Login |
| [157](#L157) | 'hmwp\_2falogin'                  => 0, |
| [158](#L158) | 'hmwp\_2falogin\_status'           => 1, |
| [159](#L159) | 'hmwp\_2fa\_totp'                  => 1, |
| [160](#L160) | 'hmwp\_2fa\_email'                 => 0, |
| [161](#L161) | 'hmwp\_2falogin\_max\_attempts'     => 5, |
| [162](#L162) | 'hmwp\_2falogin\_max\_timeout'      => 900, |
| [163](#L163) | 'hmwp\_2falogin\_message'          => '', |
| [164](#L164) | 'hmwp\_2falogin\_fail\_message'     => '', |
| [165](#L165) |  |
| [166](#L166) | //-- Brute Force |
| [167](#L167) | 'hmwp\_bruteforce'                => 0, |
| [168](#L168) | 'hmwp\_bruteforce\_register'       => 0, |
| [169](#L169) | 'hmwp\_bruteforce\_lostpassword'   => 0, |
| [170](#L170) | 'hmwp\_bruteforce\_comments'       => 0, |
| [171](#L171) | 'hmwp\_bruteforce\_woocommerce'    => 0, |
| [172](#L172) | 'hmwp\_bruteforce\_username'       => 0, |
| [173](#L173) | 'hmwp\_brute\_message'             => esc\_html\_\_( 'Your IP has been flagged for potential security violations. Please try again in a little while...', 'hide-my-wp' ), |
| [174](#L174) | 'hmwp\_hide\_classes'              => json\_encode( array() ), |
| [175](#L175) | 'trusted\_ip\_header'              => '', |
| [176](#L176) |  |
| [177](#L177) | //Unique Login |
| [178](#L178) | 'hmwp\_uniquelogin'               => 0, |
| [179](#L179) | 'hmwp\_uniquelogin\_woocommerce'   => 0, |
| [180](#L180) |  |
| [181](#L181) | //Math reCaptcha |
| [182](#L182) | 'brute\_use\_math'                 => 1, |
| [183](#L183) | 'brute\_max\_attempts'             => 5, |
| [184](#L184) | 'brute\_max\_timeout'              => 3600, |
| [185](#L185) | //reCaptcha V2 |
| [186](#L186) | 'brute\_use\_captcha'              => 0, |
| [187](#L187) | 'brute\_captcha\_site\_key'         => '', |
| [188](#L188) | 'brute\_captcha\_secret\_key'       => '', |
| [189](#L189) | 'brute\_captcha\_theme'            => 'light', |
| [190](#L190) | 'brute\_captcha\_language'         => '', |
| [191](#L191) | //reCaptcha V2 |
| [192](#L192) | 'brute\_use\_captcha\_v3'           => 0, |
| [193](#L193) | 'brute\_captcha\_site\_key\_v3'      => '', |
| [194](#L194) | 'brute\_captcha\_secret\_key\_v3'    => '', |
| [195](#L195) |  |
| [196](#L196) | //tweaks |
| [197](#L197) | 'hmwp\_hide\_admin\_toolbar'        => 0, |
| [198](#L198) | 'hmwp\_hide\_admin\_toolbar\_roles'  => array( 'customer', 'subscriber' ), |
| [199](#L199) | //-- |
| [200](#L200) | 'hmwp\_change\_in\_cache'           => ( ( defined( 'WP\_CACHE' ) && WP\_CACHE ) ? 1 : 0 ), |
| [201](#L201) | 'hmwp\_change\_in\_cache\_directory' => '', |
| [202](#L202) | 'hmwp\_hide\_loggedusers'          => 1, |
| [203](#L203) | 'hmwp\_hide\_version'              => 1, |
| [204](#L204) | 'hmwp\_hide\_version\_random'       => 1, |
| [205](#L205) | 'hmwp\_hide\_generator'            => 1, |
| [206](#L206) | 'hmwp\_hide\_prefetch'             => 1, |
| [207](#L207) | 'hmwp\_hide\_comments'             => 1, |
| [208](#L208) | 'hmwp\_hide\_wp\_text'              => 0, |
| [209](#L209) |  |
| [210](#L210) | 'hmwp\_hide\_feed'              => 0, |
| [211](#L211) | 'hmwp\_hide\_in\_feed'           => 0, |
| [212](#L212) | 'hmwp\_hide\_in\_sitemap'        => 0, |
| [213](#L213) | 'hmwp\_hide\_author\_in\_sitemap' => 1, |
| [214](#L214) | 'hmwp\_robots'                 => 0, |
| [215](#L215) |  |
| [216](#L216) | 'hmwp\_disable\_emojicons'         => 0, |
| [217](#L217) | 'hmwp\_disable\_manifest'          => 1, |
| [218](#L218) | 'hmwp\_disable\_embeds'            => 0, |
| [219](#L219) | 'hmwp\_disable\_debug'             => 1, |
| [220](#L220) | //-- |
| [221](#L221) | 'hmwp\_disable\_click'             => 0, |
| [222](#L222) | 'hmwp\_disable\_click\_loggedusers' => 0, |
| [223](#L223) | 'hmwp\_disable\_click\_roles'       => array( 'subscriber' ), |
| [224](#L224) | 'hmwp\_disable\_click\_message'     => "Right click is disabled!", |
| [225](#L225) |  |
| [226](#L226) | 'hmwp\_disable\_inspect'             => 0, |
| [227](#L227) | 'hmwp\_disable\_inspect\_blank'       => 0, |
| [228](#L228) | 'hmwp\_disable\_inspect\_loggedusers' => 0, |
| [229](#L229) | 'hmwp\_disable\_inspect\_roles'       => array( 'subscriber' ), |
| [230](#L230) | 'hmwp\_disable\_inspect\_message'     => "Inspect Element is disabled!", |
| [231](#L231) |  |
| [232](#L232) | 'hmwp\_disable\_source'             => 0, |
| [233](#L233) | 'hmwp\_disable\_source\_loggedusers' => 0, |
| [234](#L234) | 'hmwp\_disable\_source\_roles'       => array( 'subscriber' ), |
| [235](#L235) | 'hmwp\_disable\_source\_message'     => "View Source is disabled!", |
| [236](#L236) |  |
| [237](#L237) | 'hmwp\_disable\_copy\_paste'             => 0, |
| [238](#L238) | 'hmwp\_disable\_paste'                  => 1, |
| [239](#L239) | 'hmwp\_disable\_copy\_paste\_loggedusers' => 0, |
| [240](#L240) | 'hmwp\_disable\_copy\_paste\_roles'       => array( 'subscriber' ), |
| [241](#L241) | 'hmwp\_disable\_copy\_paste\_message'     => "Copy/Paste is disabled!", |
| [242](#L242) |  |
| [243](#L243) | 'hmwp\_disable\_drag\_drop'             => 0, |
| [244](#L244) | 'hmwp\_disable\_drag\_drop\_loggedusers' => 0, |
| [245](#L245) | 'hmwp\_disable\_drag\_drop\_roles'       => array( 'subscriber' ), |
| [246](#L246) | 'hmwp\_disable\_drag\_drop\_message'     => "Drag-n-Drop is disabled!", |
| [247](#L247) |  |
| [248](#L248) | 'hmwp\_disable\_recording'             => 0, |
| [249](#L249) | 'hmwp\_disable\_recording\_loggedusers' => 0, |
| [250](#L250) | 'hmwp\_disable\_recording\_roles'       => array( 'subscriber' ), |
| [251](#L251) | 'hmwp\_disable\_recording\_message'     => "Screen Recording is disabled!", |
| [252](#L252) | //-- |
| [253](#L253) | 'hmwp\_disable\_screen\_capture'        => 0, |
| [254](#L254) | 'hmwp\_file\_cache'                    => 0, |
| [255](#L255) | 'hmwp\_url\_mapping'                   => json\_encode( array() ), |
| [256](#L256) | 'hmwp\_mapping\_classes'               => 1, |
| [257](#L257) | 'hmwp\_mapping\_file'                  => 0, |
| [258](#L258) | 'hmwp\_text\_mapping'                  => json\_encode( array( |
| [259](#L259) | 'from' => array(), |
| [260](#L260) | 'to'   => array(), |
| [261](#L261) | ) ), |
| [262](#L262) | 'hmwp\_cdn\_urls'                      => json\_encode( array() ), |
| [263](#L263) | 'hmwp\_security\_alert'                => 1, |
| [264](#L264) | //-- |
| [265](#L265) | 'hmwp\_hide\_plugins\_advanced'         => 0, |
| [266](#L266) | 'hmwp\_hide\_themes\_advanced'          => 0, |
| [267](#L267) | //-- |
| [268](#L268) |  |
| [269](#L269) | //redirects |
| [270](#L270) | 'hmwp\_url\_redirect'                  => 'NFError', |
| [271](#L271) | 'hmwp\_do\_redirects'                  => 0, |
| [272](#L272) | 'hmwp\_logged\_users\_redirect'         => 0, |
| [273](#L273) | 'hmwp\_url\_redirects'                 => array( 'default' => array( 'login' => '', 'logout' => '' ) ), |
| [274](#L274) | 'hmwp\_signup\_template'               => 0, |
| [275](#L275) |  |
| [276](#L276) | 'hmwp\_mapping\_text\_show' => 1, |
| [277](#L277) | 'hmwp\_mapping\_url\_show'  => 1, |
| [278](#L278) | 'hmwp\_mapping\_cdn\_show'  => 1, |
| [279](#L279) |  |
| [280](#L280) | ); |
| [281](#L281) |  |
| [282](#L282) | // Set WordPress options when security is disables. |
| [283](#L283) | self::$default = array( |
| [284](#L284) | 'hmwp\_mode'             => 'default', |
| [285](#L285) | 'hmwp\_admin\_url'        => 'wp-admin', |
| [286](#L286) | 'hmwp\_login\_url'        => 'wp-login.php', |
| [287](#L287) | 'hmwp\_activate\_url'     => 'wp-activate.php', |
| [288](#L288) | 'hmwp\_lostpassword\_url' => '', |
| [289](#L289) | 'hmwp\_register\_url'     => '', |
| [290](#L290) | 'hmwp\_logout\_url'       => '', |
| [291](#L291) |  |
| [292](#L292) | 'hmwp\_plugin\_url'                => $plugin\_relative\_url, |
| [293](#L293) | 'hmwp\_plugins'                   => array(), |
| [294](#L294) | 'hmwp\_themes\_url'                => 'themes', |
| [295](#L295) | 'hmwp\_themes'                    => array(), |
| [296](#L296) | 'hmwp\_upload\_url'                => 'uploads', |
| [297](#L297) | 'hmwp\_admin-ajax\_url'            => 'admin-ajax.php', |
| [298](#L298) | 'hmwp\_wp-signup\_url'             => 'wp-signup.php', |
| [299](#L299) | 'hmwp\_hideajax\_paths'            => 0, |
| [300](#L300) | 'hmwp\_hideajax\_admin'            => 0, |
| [301](#L301) | 'hmwp\_tags\_url'                  => 'tag', |
| [302](#L302) | 'hmwp\_wp-content\_url'            => $content\_relative\_url, |
| [303](#L303) | 'hmwp\_wp-includes\_url'           => 'wp-includes', |
| [304](#L304) | 'hmwp\_author\_url'                => 'author', |
| [305](#L305) | 'hmwp\_hide\_authors'              => 0, |
| [306](#L306) | 'hmwp\_wp-comments-post'          => 'wp-comments-post.php', |
| [307](#L307) | 'hmwp\_themes\_style'              => 'style.css', |
| [308](#L308) | 'hmwp\_hide\_img\_classes'          => 0, |
| [309](#L309) | 'hmwp\_hide\_styleids'             => 0, |
| [310](#L310) | 'hmwp\_noncekey'                  => '\_wpnonce', |
| [311](#L311) | 'hmwp\_wp-json'                   => 'wp-json', |
| [312](#L312) | 'hmwp\_hide\_rest\_api'             => 0, |
| [313](#L313) | 'hmwp\_disable\_rest\_api'          => 0, |
| [314](#L314) | 'hmwp\_disable\_rest\_api\_param'    => 0, |
| [315](#L315) | 'hmwp\_disable\_xmlrpc'            => 0, |
| [316](#L316) | 'hmwp\_hide\_rsd'                  => 0, |
| [317](#L317) | 'hmwp\_hide\_admin'                => 0, |
| [318](#L318) | 'hmwp\_hide\_newadmin'             => 0, |
| [319](#L319) | 'hmwp\_hide\_admin\_loggedusers'    => 0, |
| [320](#L320) | 'hmwp\_hide\_login'                => 0, |
| [321](#L321) | 'hmwp\_hide\_wplogin'              => 0, |
| [322](#L322) | 'hmwp\_hide\_newlogin'             => 0, |
| [323](#L323) | 'hmwp\_disable\_language\_switcher' => 0, |
| [324](#L324) | 'hmwp\_hide\_plugins'              => 0, |
| [325](#L325) | 'hmwp\_hide\_all\_plugins'          => 0, |
| [326](#L326) | 'hmwp\_hide\_themes'               => 0, |
| [327](#L327) | 'hmwp\_emulate\_cms'               => '', |
| [328](#L328) |  |
| [329](#L329) | //--secure headers |
| [330](#L330) | 'hmwp\_sqlinjection'              => 0, |
| [331](#L331) | 'hmwp\_sqlinjection\_location'     => 'onload', |
| [332](#L332) | 'hmwp\_sqlinjection\_level'        => 2, |
| [333](#L333) | 'hmwp\_security\_header'           => 0, |
| [334](#L334) | 'hmwp\_hide\_unsafe\_headers'       => 0, |
| [335](#L335) | 'hmwp\_security\_headers'          => array( |
| [336](#L336) | "Strict-Transport-Security" => "max-age=15768000;includeSubdomains", |
| [337](#L337) | "Content-Security-Policy"   => "object-src 'none'", |
| [338](#L338) | "X-XSS-Protection"          => "1; mode=block", |
| [339](#L339) | ), |
| [340](#L340) | //-- |
| [341](#L341) | 'hmwp\_detectors\_block'           => 0, |
| [342](#L342) | 'hmwp\_hide\_commonfiles'          => 0, |
| [343](#L343) | 'hmwp\_disable\_browsing'          => 0, |
| [344](#L344) | 'hmwp\_hide\_oldpaths'             => 0, |
| [345](#L345) | 'hmwp\_hide\_oldpaths\_plugins'     => 0, |
| [346](#L346) | 'hmwp\_hide\_oldpaths\_themes'      => 0, |
| [347](#L347) | 'hmwp\_hide\_oldpaths\_types'       => array( 'css', 'js', 'php', 'txt', 'html' ), |
| [348](#L348) | 'hmwp\_hide\_commonfiles\_files'    => array( |
| [349](#L349) | 'wp-config-sample.php', |
| [350](#L350) | 'readme.html', |
| [351](#L351) | 'readme.txt', |
| [352](#L352) | 'install.php', |
| [353](#L353) | 'license.txt', |
| [354](#L354) | 'php.ini', |
| [355](#L355) | 'upgrade.php', |
| [356](#L356) | 'bb-config.php', |
| [357](#L357) | 'error\_log' |
| [358](#L358) | ), |
| [359](#L359) | // |
| [360](#L360) | 'hmwp\_category\_base'             => '', |
| [361](#L361) | 'hmwp\_tag\_base'                  => '', |
| [362](#L362) | // |
| [363](#L363) | ); |
| [364](#L364) |  |
| [365](#L365) | // Set options for "Lite Mode". |
| [366](#L366) | self::$lite = array( |
| [367](#L367) | 'hmwp\_mode'                      => 'lite', |
| [368](#L368) | 'hmwp\_login\_url'                 => 'newlogin', |
| [369](#L369) | 'hmwp\_activate\_url'              => 'activate', |
| [370](#L370) | 'hmwp\_lostpassword\_url'          => 'lostpass', |
| [371](#L371) | 'hmwp\_register\_url'              => 'register', |
| [372](#L372) | 'hmwp\_logout\_url'                => '', |
| [373](#L373) | 'hmwp\_admin-ajax\_url'            => 'admin-ajax.php', |
| [374](#L374) | 'hmwp\_hideajax\_admin'            => 0, |
| [375](#L375) | 'hmwp\_hideajax\_paths'            => 0, |
| [376](#L376) | 'hmwp\_plugin\_url'                => 'core/modules', |
| [377](#L377) | 'hmwp\_themes\_url'                => 'core/views', |
| [378](#L378) | 'hmwp\_upload\_url'                => 'storage', |
| [379](#L379) | 'hmwp\_wp-content\_url'            => 'core', |
| [380](#L380) | 'hmwp\_wp-includes\_url'           => 'lib', |
| [381](#L381) | 'hmwp\_author\_url'                => 'writer', |
| [382](#L382) | 'hmwp\_hide\_authors'              => 1, |
| [383](#L383) | 'hmwp\_wp-comments-post'          => 'comments', |
| [384](#L384) | 'hmwp\_themes\_style'              => 'design.css', |
| [385](#L385) | 'hmwp\_wp-json'                   => 'wp-json', |
| [386](#L386) | 'hmwp\_hide\_admin'                => 1, |
| [387](#L387) | 'hmwp\_hide\_newadmin'             => 0, |
| [388](#L388) | 'hmwp\_hide\_admin\_loggedusers'    => 0, |
| [389](#L389) | 'hmwp\_hide\_login'                => 1, |
| [390](#L390) | 'hmwp\_hide\_wplogin'              => 1, |
| [391](#L391) | 'hmwp\_hide\_newlogin'             => 1, |
| [392](#L392) | 'hmwp\_disable\_language\_switcher' => 0, |
| [393](#L393) | 'hmwp\_hide\_plugins'              => 1, |
| [394](#L394) | 'hmwp\_hide\_all\_plugins'          => 0, |
| [395](#L395) | 'hmwp\_hide\_themes'               => 1, |
| [396](#L396) | 'hmwp\_emulate\_cms'               => 'drupal11', |
| [397](#L397) | // |
| [398](#L398) | 'hmwp\_hide\_img\_classes'          => 1, |
| [399](#L399) | 'hmwp\_hide\_rest\_api'             => 1, |
| [400](#L400) | 'hmwp\_disable\_rest\_api'          => 0, |
| [401](#L401) | 'hmwp\_disable\_rest\_api\_param'    => 1, |
| [402](#L402) | 'hmwp\_disable\_xmlrpc'            => 1, |
| [403](#L403) | 'hmwp\_hide\_rsd'                  => 1, |
| [404](#L404) | // |
| [405](#L405) | 'hmwp\_sqlinjection'              => 1, |
| [406](#L406) | 'hmwp\_security\_header'           => 1, |
| [407](#L407) | 'hmwp\_hide\_unsafe\_headers'       => 1, |
| [408](#L408) | 'hmwp\_detectors\_block'           => 1, |
| [409](#L409) |  |
| [410](#L410) | //PRO |
| [411](#L411) | 'hmwp\_hide\_styleids'             => 0, |
| [412](#L412) | 'hmwp\_disable\_browsing'          => 0, |
| [413](#L413) | 'hmwp\_hide\_commonfiles'          => 0, |
| [414](#L414) | 'hmwp\_hide\_oldpaths'             => 0, |
| [415](#L415) | 'hmwp\_hide\_oldpaths\_plugins'     => 0, |
| [416](#L416) | 'hmwp\_hide\_oldpaths\_themes'      => 0, |
| [417](#L417) | ); |
| [418](#L418) |  |
| [419](#L419) | // Fetch the options based on whether it's a multisite and merge with defaults. |
| [420](#L420) | if ( self::isMultisites() && defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) { |
| [421](#L421) | $options = json\_decode( get\_blog\_option( BLOG\_ID\_CURRENT\_SITE, $keymeta ), true ); |
| [422](#L422) | } else { |
| [423](#L423) | $options = json\_decode( get\_option( $keymeta ), true ); |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | // Ensure compatibility with WP Client plugin. |
| [427](#L427) | if ( self::isPluginActive( 'wp-client/wp-client.php' ) ) { |
| [428](#L428) | self::$lite['hmwp\_wp-content\_url'] = 'include'; |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | // Merge the options with initial and default values. |
| [432](#L432) | if ( is\_array( $options ) ) { |
| [433](#L433) | $options = @array\_merge( self::$init, self::$default, $options ); |
| [434](#L434) | } else { |
| [435](#L435) | $options = @array\_merge( self::$init, self::$default ); |
| [436](#L436) | } |
| [437](#L437) |  |
| [438](#L438) | // Validate the custom cache directory and reset if it contains 'wp-content'. |
| [439](#L439) | if ( isset( $options['hmwp\_change\_in\_cache\_directory'] ) && $options['hmwp\_change\_in\_cache\_directory'] <> '' ) { |
| [440](#L440) | if ( strpos( $options['hmwp\_change\_in\_cache\_directory'], 'wp-content' ) !== false ) { |
| [441](#L441) | $options['hmwp\_change\_in\_cache\_directory'] = ''; |
| [442](#L442) | } |
| [443](#L443) | } |
| [444](#L444) |  |
| [445](#L445) | // Update the whitelist level based on whitelist paths setting. |
| [446](#L446) | if ( isset( $options['whitelist\_paths'] ) && ! isset( $options['whitelist\_level'] ) ) { |
| [447](#L447) | $options['whitelist\_level'] = ( $options['whitelist\_paths'] == 1 ? 2 : 1 ); |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | // Set the category and tag bases considering multisite setup. |
| [451](#L451) | $category\_base = get\_option( 'category\_base' ); |
| [452](#L452) | $tag\_base      = get\_option( 'tag\_base' ); |
| [453](#L453) |  |
| [454](#L454) | if ( self::isMultisites() && ! is\_subdomain\_install() && is\_main\_site() && 0 === strpos( get\_option( 'permalink\_structure' ), '/blog/' ) ) { |
| [455](#L455) | $category\_base = preg\_replace( '|^/?blog|', '', $category\_base ); |
| [456](#L456) | $tag\_base      = preg\_replace( '|^/?blog|', '', $tag\_base ); |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) | $options['hmwp\_category\_base'] = $category\_base; |
| [460](#L460) | $options['hmwp\_tag\_base']      = $tag\_base; |
| [461](#L461) |  |
| [462](#L462) | // Set priority and rewrite rules settings if defined constants are set. |
| [463](#L463) | if ( HMW\_PRIORITY ) { |
| [464](#L464) | $options['hmwp\_priorityload'] = 1; |
| [465](#L465) | } |
| [466](#L466) | if ( HMW\_RULES\_IN\_WP\_RULES ) { |
| [467](#L467) | $options['hmwp\_rewrites\_in\_wp\_rules'] = 1; |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | // Return the final options array. |
| [471](#L471) | return $options; |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | /\*\* |
| [475](#L475) | \* Update the database configuration and options for the plugin. |
| [476](#L476) | \* |
| [477](#L477) | \* This method is called during a plugin update to migrate existing settings and set new defaults. |
| [478](#L478) | \* It handles various tasks such as upgrading from a lite version, migrating specific options, |
| [479](#L479) | \* and initializing default values where necessary. |
| [480](#L480) | \* |
| [481](#L481) | \* @return void |
| [482](#L482) | \*/ |
| [483](#L483) | private static function updateDatabase() { |
| [484](#L484) | // Check if the plugin version is updated |
| [485](#L485) | if ( self::$options['hmwp\_ver'] < HMWP\_VERSION\_ID ) { |
| [486](#L486) |  |
| [487](#L487) | // Upgrade from Old Version if hmwp\_options exist in the database |
| [488](#L488) | if ( get\_option( 'hmw\_options' ) ) { |
| [489](#L489) | $options = json\_decode( get\_option( 'hmw\_options' ), true ); |
| [490](#L490) | // If options are not empty, migrate them to the new format |
| [491](#L491) | if ( ! empty( $options ) ) { |
| [492](#L492) | foreach ( $options as $key => $value ) { |
| [493](#L493) | self::$options[ str\_replace( 'hmw\_', 'hmwp\_', $key ) ] = $value; |
| [494](#L494) | } |
| [495](#L495) | } |
| [496](#L496) | // Delete old options to prevent conflicts |
| [497](#L497) | delete\_option( 'hmw\_options' ); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | // Set default value for hmwp\_hide\_wplogin if it's not set and hmwp\_hide\_login is set |
| [501](#L501) | if ( ! isset( self::$options['hmwp\_hide\_wplogin'] ) && isset( self::$options['hmwp\_hide\_login'] ) && self::$options['hmwp\_hide\_login'] ) { |
| [502](#L502) | self::$options['hmwp\_hide\_wplogin'] = self::$options['hmwp\_hide\_login']; |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | // Initialize the account show option if not set |
| [506](#L506) | if ( ! isset( self::$options['hmwp\_plugin\_account\_show'] ) ) { |
| [507](#L507) | self::$options['hmwp\_plugin\_account\_show'] = 1; |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | // Upgrade logout redirect options to the new format |
| [511](#L511) | if ( isset( self::$options['hmwp\_logout\_redirect'] ) && self::$options['hmwp\_logout\_redirect'] ) { |
| [512](#L512) | self::$options['hmwp\_url\_redirects']['default']['logout'] = self::$options['hmwp\_logout\_redirect']; |
| [513](#L513) | unset( self::$options['hmwp\_logout\_redirect'] ); |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | // Upgrade admin toolbar visibility option to the new format |
| [517](#L517) | if ( isset( self::$options['hmwp\_in\_dashboard'] ) && self::$options['hmwp\_in\_dashboard'] ) { |
| [518](#L518) | self::$options['hmwp\_hide\_admin\_toolbar'] = self::$options['hmwp\_in\_dashboard']; |
| [519](#L519) | unset( self::$options['hmwp\_in\_dashboard'] ); |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | // Upgrade sitemap visibility option to the new format |
| [523](#L523) | if ( isset( self::$options['hmwp\_shutdownload'] ) && self::$options['hmwp\_shutdownload'] ) { |
| [524](#L524) | self::$options['hmwp\_hide\_in\_sitemap'] = self::$options['hmwp\_shutdownload']; |
| [525](#L525) | unset( self::$options['hmwp\_shutdownload'] ); |
| [526](#L526) | } |
| [527](#L527) |  |
| [528](#L528) | // Remove old whitelist\_paths option |
| [529](#L529) | if ( isset( self::$options['whitelist\_paths'] ) ) { |
| [530](#L530) | unset( self::$options['whitelist\_paths'] ); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | // Update the login paths on Cloud when the plugin is updated |
| [534](#L534) | self::sendLoginPathsApi(); |
| [535](#L535) |  |
| [536](#L536) | // Set the current version ID |
| [537](#L537) | self::$options['hmwp\_ver'] = HMWP\_VERSION\_ID; |
| [538](#L538) | // Save updated options |
| [539](#L539) | self::saveOptions(); |
| [540](#L540) | } |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | /\*\* |
| [544](#L544) | \* Get the default value for a given key |
| [545](#L545) | \* |
| [546](#L546) | \* @param  string  $key  The key for which default value is to be retrieved |
| [547](#L547) | \* |
| [548](#L548) | \* @return mixed The default value associated with the key, or false if the key does not exist |
| [549](#L549) | \* @since 5.0.19 |
| [550](#L550) | \*/ |
| [551](#L551) | public static function getDefault( $key ) { |
| [552](#L552) | if ( isset( self::$default[ $key ] ) ) { |
| [553](#L553) | return self::$default[ $key ]; |
| [554](#L554) | } |
| [555](#L555) |  |
| [556](#L556) | return false; |
| [557](#L557) |  |
| [558](#L558) | } |
| [559](#L559) |  |
| [560](#L560) | /\*\* |
| [561](#L561) | \* Retrieve an option value by key. |
| [562](#L562) | \* |
| [563](#L563) | \* @param  string  $key  The key for the option to retrieve. |
| [564](#L564) | \* |
| [565](#L565) | \* @return mixed The value of the option, possibly filtered. |
| [566](#L566) | \*/ |
| [567](#L567) | public static function getOption( $key ) { |
| [568](#L568) | if ( ! isset( self::$options[ $key ] ) ) { |
| [569](#L569) | self::$options = self::getOptions(); |
| [570](#L570) |  |
| [571](#L571) | if ( ! isset( self::$options[ $key ] ) ) { |
| [572](#L572) | self::$options[ $key ] = 0; |
| [573](#L573) | } |
| [574](#L574) | } |
| [575](#L575) |  |
| [576](#L576) | return apply\_filters( 'hmwp\_option\_' . $key, self::$options[ $key ] ); |
| [577](#L577) | } |
| [578](#L578) |  |
| [579](#L579) | /\*\* |
| [580](#L580) | \* Save the specified options in the WordPress options table |
| [581](#L581) | \* |
| [582](#L582) | \* @param  string|null  $key  The key of the option to save. If null, no key will be set. |
| [583](#L583) | \* @param  mixed  $value  The value of the option to save. |
| [584](#L584) | \* @param  bool  $safe  Whether to save the option safely or not. |
| [585](#L585) | \* |
| [586](#L586) | \* @return void |
| [587](#L587) | \*/ |
| [588](#L588) | public static function saveOptions( $key = null, $value = '', $safe = false ) { |
| [589](#L589) | // Default option key |
| [590](#L590) | $keymeta = HMWP\_OPTION; |
| [591](#L591) |  |
| [592](#L592) | // Use a different option key if the $safe parameter is true |
| [593](#L593) | if ( $safe ) { |
| [594](#L594) | $keymeta = HMWP\_OPTION\_SAFE; |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | // If a specific key is provided, update the value in the options array |
| [598](#L598) | if ( isset( $key ) ) { |
| [599](#L599) | self::$options[ $key ] = $value; |
| [600](#L600) | } |
| [601](#L601) |  |
| [602](#L602) | // If the site is a multisite and BLOG\_ID\_CURRENT\_SITE is defined |
| [603](#L603) | if ( self::isMultisites() && defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) { |
| [604](#L604) | // Update the option for the current blog in the network |
| [605](#L605) | update\_blog\_option( BLOG\_ID\_CURRENT\_SITE, $keymeta, json\_encode( self::$options ) ); |
| [606](#L606) | } else { |
| [607](#L607) | // Otherwise, update the option normally |
| [608](#L608) | update\_option( $keymeta, json\_encode( self::$options ) ); |
| [609](#L609) | } |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | /\*\* |
| [613](#L613) | \* Save the current working options into a backup storage. |
| [614](#L614) | \* |
| [615](#L615) | \* @return void |
| [616](#L616) | \*/ |
| [617](#L617) | public static function saveOptionsBackup() { |
| [618](#L618) | // Save the working options into backup |
| [619](#L619) | foreach ( self::$options as $key => $value ) { |
| [620](#L620) | HMWP\_Classes\_Tools::saveOptions( $key, $value, true ); |
| [621](#L621) | } |
| [622](#L622) | } |
| [623](#L623) |  |
| [624](#L624) | /\*\* |
| [625](#L625) | \* Add a link to settings in the plugin list |
| [626](#L626) | \* |
| [627](#L627) | \* @param  array  $links |
| [628](#L628) | \* |
| [629](#L629) | \* @return array |
| [630](#L630) | \*/ |
| [631](#L631) | public function hookActionlink( $links ) { |
| [632](#L632) | if ( get\_transient( 'hmwp\_disable' ) ) { |
| [633](#L633) | $links[] = '<a href="' . esc\_url( add\_query\_arg( array( 'hmwp\_nonce' => wp\_create\_nonce( 'hmwp\_pause\_disable' ), 'action' => 'hmwp\_pause\_disable' ) ) ) . '" class="btn btn-default btn-sm mt-3" />' . esc\_html\_\_( "Resume Security", 'hide-my-wp' ) . '</a>'; |
| [634](#L634) | } else { |
| [635](#L635) | $links[] = '<a href="' . esc\_url( add\_query\_arg( array( 'hmwp\_nonce' => wp\_create\_nonce( 'hmwp\_pause\_enable' ), 'action' => 'hmwp\_pause\_enable' ) ) ) . '" class="btn btn-default btn-sm mt-3" />' . esc\_html\_\_( "Pause for 5 minutes", 'hide-my-wp' ) . '</a>'; |
| [636](#L636) | } |
| [637](#L637) | $links[] = '<a href="' . esc\_url( self::getSettingsUrl() ) . '">' . esc\_html\_\_( 'Settings', 'hide-my-wp' ) . '</a>'; |
| [638](#L638) | $links[] = '<a href="https://hidemywpghost.com/hide-my-wp-pricing/" target="\_blank" style="font-weight: bold;color: #007cba">' . esc\_html\_\_( 'Go PRO', 'hide-my-wp' ) . '</a>'; |
| [639](#L639) |  |
| [640](#L640) | return array\_reverse( $links ); |
| [641](#L641) | } |
| [642](#L642) |  |
| [643](#L643) |  |
| [644](#L644) | /\*\* |
| [645](#L645) | \* Load the plugin text domain for multilanguage support. |
| [646](#L646) | \* |
| [647](#L647) | \* @return void |
| [648](#L648) | \*/ |
| [649](#L649) | public static function loadMultilanguage() { |
| [650](#L650) | load\_plugin\_textdomain( dirname( HMWP\_BASENAME ), false, dirname( HMWP\_BASENAME ) . '/languages/' ); |
| [651](#L651) | } |
| [652](#L652) |  |
| [653](#L653) | /\*\* |
| [654](#L654) | \* Check if it's Rest Api call |
| [655](#L655) | \* |
| [656](#L656) | \* @return bool |
| [657](#L657) | \*/ |
| [658](#L658) | public static function isApi() { |
| [659](#L659) | if ( isset( $\_SERVER['REQUEST\_URI'] ) && strpos( $\_SERVER['REQUEST\_URI'], '/' . HMWP\_Classes\_Tools::getOption( 'hmwp\_wp-json' ) . '/' ) !== false ) { |
| [660](#L660) | return true; |
| [661](#L661) | } |
| [662](#L662) |  |
| [663](#L663) | return false; |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | /\*\* |
| [667](#L667) | \* Check if it's Ajax call |
| [668](#L668) | \* |
| [669](#L669) | \* @return bool |
| [670](#L670) | \*/ |
| [671](#L671) | public static function isAjax() { |
| [672](#L672) | if ( defined( 'DOING\_AJAX' ) && DOING\_AJAX ) { |
| [673](#L673) | return true; |
| [674](#L674) | } |
| [675](#L675) |  |
| [676](#L676) | return false; |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | /\*\* |
| [680](#L680) | \* Check if it's Cron call |
| [681](#L681) | \* |
| [682](#L682) | \* @return bool |
| [683](#L683) | \*/ |
| [684](#L684) | public static function isCron() { |
| [685](#L685) | if ( defined( 'DOING\_CRON' ) && DOING\_CRON ) { |
| [686](#L686) | return true; |
| [687](#L687) | } |
| [688](#L688) |  |
| [689](#L689) | return false; |
| [690](#L690) | } |
| [691](#L691) |  |
| [692](#L692) | /\*\* |
| [693](#L693) | \* Check if it's valid to load firewall on the page |
| [694](#L694) | \* |
| [695](#L695) | \* @return bool |
| [696](#L696) | \*/ |
| [697](#L697) | public static function doFirewall() { |
| [698](#L698) |  |
| [699](#L699) | //If allways change paths admin & frontend |
| [700](#L700) | if ( defined( 'HMW\_ALWAYS\_RUN\_FIREWALL' ) && HMW\_ALWAYS\_RUN\_FIREWALL ) { |
| [701](#L701) | return true; |
| [702](#L702) | } |
| [703](#L703) |  |
| [704](#L704) | //If firewall process is activated |
| [705](#L705) | if ( ! apply\_filters( 'hmwp\_process\_firewall', true ) ) { |
| [706](#L706) | return false; |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | if ( HMWP\_Classes\_Tools::isApi() ) { |
| [710](#L710) | return false; |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | //If not admin |
| [714](#L714) | if ( ! is\_admin() && ! is\_network\_admin() ) { |
| [715](#L715) | //if user is not logged in |
| [716](#L716) | if ( function\_exists( 'is\_user\_logged\_in' ) && ! is\_user\_logged\_in() ) { |
| [717](#L717) | return true; |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | } |
| [721](#L721) |  |
| [722](#L722) | return false; |
| [723](#L723) | } |
| [724](#L724) |  |
| [725](#L725) | /\*\* |
| [726](#L726) | \* Check if it's valid for changing the paths |
| [727](#L727) | \* Change the paths in admin, logged users or visitors |
| [728](#L728) | \* |
| [729](#L729) | \* @return bool |
| [730](#L730) | \*/ |
| [731](#L731) | public static function doChangePaths() { |
| [732](#L732) |  |
| [733](#L733) | //If allways change paths admin & frontend |
| [734](#L734) | if ( HMW\_ALWAYS\_CHANGE\_PATHS ) { |
| [735](#L735) | return true; |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | if ( HMWP\_Classes\_Tools::isApi() ) { |
| [739](#L739) | return false; |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) | //If not admin |
| [743](#L743) | if ( ( ! is\_admin() && ! is\_network\_admin() ) || HMWP\_Classes\_Tools::isAjax() ) { |
| [744](#L744) |  |
| [745](#L745) | //if process the change paths |
| [746](#L746) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_hide\_loggedusers' ) || ( function\_exists( 'is\_user\_logged\_in' ) && ! is\_user\_logged\_in() ) ) { |
| [747](#L747) | return true; |
| [748](#L748) | } |
| [749](#L749) |  |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | return false; |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | /\*\* |
| [756](#L756) | \* Check if it's valid for hiding and disable things in site |
| [757](#L757) | \* |
| [758](#L758) | \* @return bool |
| [759](#L759) | \*/ |
| [760](#L760) | public static function doHideDisable() { |
| [761](#L761) |  |
| [762](#L762) | //Check if is valid for moving on |
| [763](#L763) | if ( ! apply\_filters( 'hmwp\_process\_hide\_disable', true ) ) { |
| [764](#L764) | return false; |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | if ( defined( 'DOING\_CRON' ) && DOING\_CRON ) { |
| [768](#L768) | return false; |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | if ( HMWP\_Classes\_Tools::isAjax() || HMWP\_Classes\_Tools::isApi() ) { |
| [772](#L772) | return false; |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | //If not admin |
| [776](#L776) | if ( ! is\_admin() && ! is\_network\_admin() ) { |
| [777](#L777) | //if process the change paths |
| [778](#L778) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_hide\_loggedusers' ) || ( function\_exists( 'is\_user\_logged\_in' ) && ! is\_user\_logged\_in() ) ) { |
| [779](#L779) | return true; |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | } |
| [783](#L783) |  |
| [784](#L784) | return false; |
| [785](#L785) | } |
| [786](#L786) |  |
| [787](#L787) | /\*\* |
| [788](#L788) | \* Check if it's valid for click disabl, source code and inspect element |
| [789](#L789) | \* |
| [790](#L790) | \* @return bool |
| [791](#L791) | \*/ |
| [792](#L792) | public static function doDisableClick() { |
| [793](#L793) |  |
| [794](#L794) | //Check if is valid for moving on |
| [795](#L795) | if ( ! apply\_filters( 'hmwp\_process\_hide\_disable', true ) ) { |
| [796](#L796) | return false; |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | if ( defined( 'DOING\_CRON' ) && DOING\_CRON ) { |
| [800](#L800) | return false; |
| [801](#L801) | } |
| [802](#L802) |  |
| [803](#L803) | //If not admin |
| [804](#L804) | if ( ! is\_admin() && ! is\_network\_admin() ) { |
| [805](#L805) |  |
| [806](#L806) | if ( function\_exists( 'is\_user\_logged\_in' ) && ( HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_click' ) || HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_inspect' ) || HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_source' ) || HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_copy\_paste' ) || HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_drag\_drop' ) ) ) { |
| [807](#L807) |  |
| [808](#L808) | return true; |
| [809](#L809) | } |
| [810](#L810) |  |
| [811](#L811) | } |
| [812](#L812) |  |
| [813](#L813) | return false; |
| [814](#L814) | } |
| [815](#L815) |  |
| [816](#L816) | /\*\* |
| [817](#L817) | \* Check if the option to hide the URLs is active |
| [818](#L818) | \* |
| [819](#L819) | \* @return bool |
| [820](#L820) | \*/ |
| [821](#L821) | public static function doHideURLs() { |
| [822](#L822) |  |
| [823](#L823) | //Check if is valid for moving on |
| [824](#L824) | if ( ! apply\_filters( 'hmwp\_process\_hide\_urls', true ) ) { |
| [825](#L825) | return false; |
| [826](#L826) | } |
| [827](#L827) |  |
| [828](#L828) | //make sure the function is loaded |
| [829](#L829) | if ( ! function\_exists( 'is\_user\_logged\_in' ) ) { |
| [830](#L830) | include\_once ABSPATH . WPINC . '/pluggable.php'; |
| [831](#L831) | } |
| [832](#L832) |  |
| [833](#L833) | if ( ! isset( $\_SERVER['REQUEST\_URI'] ) ) { |
| [834](#L834) | return false; |
| [835](#L835) | } |
| [836](#L836) |  |
| [837](#L837) | if ( defined( 'DOING\_CRON' ) && DOING\_CRON ) { |
| [838](#L838) | return false; |
| [839](#L839) | } |
| [840](#L840) |  |
| [841](#L841) | return true; |
| [842](#L842) | } |
| [843](#L843) |  |
| [844](#L844) |  |
| [845](#L845) | /\*\* |
| [846](#L846) | \* Get the plugin settings URL |
| [847](#L847) | \* |
| [848](#L848) | \* @param  string  $page |
| [849](#L849) | \* @param  string  $relative |
| [850](#L850) | \* |
| [851](#L851) | \* @return string |
| [852](#L852) | \*/ |
| [853](#L853) | public static function getSettingsUrl( $page = 'hmwp\_settings', $relative = false ) { |
| [854](#L854) | if ( $relative ) { |
| [855](#L855) | return 'admin.php?page=' . $page; |
| [856](#L856) | } else { |
| [857](#L857) | if ( ! self::isMultisites() ) { |
| [858](#L858) | return admin\_url( 'admin.php?page=' . $page ); |
| [859](#L859) | } else { |
| [860](#L860) | return network\_admin\_url( 'admin.php?page=' . $page ); |
| [861](#L861) | } |
| [862](#L862) | } |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | public static function getCloudUrl( $page = 'login' ) { |
| [866](#L866) | return \_HMWP\_ACCOUNT\_SITE\_ . '/user/auth/' . $page; |
| [867](#L867) | } |
| [868](#L868) |  |
| [869](#L869) | /\*\* |
| [870](#L870) | \* Get the config file for WordPress |
| [871](#L871) | \* |
| [872](#L872) | \* @return string |
| [873](#L873) | \*/ |
| [874](#L874) | public static function getConfigFile() { |
| [875](#L875) |  |
| [876](#L876) | //Initialize WordPress Filesystem |
| [877](#L877) | $wp\_filesystem = HMWP\_Classes\_ObjController::initFilesystem(); |
| [878](#L878) |  |
| [879](#L879) | if ( $wp\_filesystem->exists( self::getRootPath() . 'wp-config.php' ) ) { |
| [880](#L880) | return self::getRootPath() . 'wp-config.php'; |
| [881](#L881) | } |
| [882](#L882) |  |
| [883](#L883) | if ( $wp\_filesystem->exists( dirname( ABSPATH ) . '/wp-config.php' ) ) { |
| [884](#L884) | return dirname( ABSPATH ) . '/wp-config.php'; |
| [885](#L885) | } |
| [886](#L886) |  |
| [887](#L887) | return false; |
| [888](#L888) | } |
| [889](#L889) |  |
| [890](#L890) | /\*\* |
| [891](#L891) | \* Set the header type |
| [892](#L892) | \* |
| [893](#L893) | \* @param  string  $type |
| [894](#L894) | \*/ |
| [895](#L895) | public static function setHeader( $type ) { |
| [896](#L896) | switch ( $type ) { |
| [897](#L897) | case 'json': |
| [898](#L898) | header( 'Content-Type: application/json' ); |
| [899](#L899) | break; |
| [900](#L900) | case 'html': |
| [901](#L901) | header( "Content-type: text/html" ); |
| [902](#L902) | break; |
| [903](#L903) | case 'text': |
| [904](#L904) | header( "Content-type: text/plain" ); |
| [905](#L905) | break; |
| [906](#L906) | } |
| [907](#L907) | } |
| [908](#L908) |  |
| [909](#L909) | /\*\* |
| [910](#L910) | \* Get a value from $\_POST / $\_GET |
| [911](#L911) | \* if unavailable, take a default value |
| [912](#L912) | \* |
| [913](#L913) | \* @param  string  $key  Value key |
| [914](#L914) | \* @param  boolean  $keep\_newlines  Keep the new lines in variable in case of texareas |
| [915](#L915) | \* @param  mixed  $defaultValue  (optional) |
| [916](#L916) | \* |
| [917](#L917) | \* @return array|false|string Value |
| [918](#L918) | \*/ |
| [919](#L919) | public static function getValue( $key = null, $defaultValue = false, $keep\_newlines = false ) { |
| [920](#L920) | if ( ! isset( $key ) || $key == '' ) { |
| [921](#L921) | return false; |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | //Get the parameters based on the form method |
| [925](#L925) | //Sanitize each parameter based on the parameter type |
| [926](#L926) | $ret = ( isset( $\_POST[ $key ] ) ? $\_POST[ $key ] : ( isset( $\_GET[ $key ] ) ? $\_GET[ $key ] : $defaultValue ) ); |
| [927](#L927) |  |
| [928](#L928) | if ( is\_string( $ret ) === true ) { |
| [929](#L929) | if ( $keep\_newlines === false ) { |
| [930](#L930) | //Validate the param based on its type |
| [931](#L931) | if ( in\_array( $key, array( |
| [932](#L932) | 'hmwp\_email\_address', |
| [933](#L933) | 'hmwp\_email', |
| [934](#L934) | 'whitelist\_ip', |
| [935](#L935) | 'banlist\_ip' |
| [936](#L936) | ) ) ) { //validate email address |
| [937](#L937) | $ret = preg\_replace( '/[^A-Za-z0-9-\_.#\*@\/]/', '', $ret ); |
| [938](#L938) | } elseif ( in\_array( $key, array( 'hmwp\_disable\_name' ) ) ) { //validate url parameter |
| [939](#L939) | $ret = preg\_replace( '/[^A-Za-z0-9-\_]/', '', $ret ); |
| [940](#L940) | } elseif ( in\_array( $key, array( 'hmwp\_admin\_url', 'hmwp\_login\_url' ) ) ) { //validate url parameter |
| [941](#L941) | $ret = preg\_replace( '/[^A-Za-z0-9-\_.]/', '', $ret ); |
| [942](#L942) | } else { |
| [943](#L943) | $ret = preg\_replace( '/[^A-Za-z0-9-\_.\/]/', '', $ret ); //validate fields |
| [944](#L944) | } |
| [945](#L945) | //Sanitize the text field |
| [946](#L946) | $ret = sanitize\_text\_field( $ret ); |
| [947](#L947) |  |
| [948](#L948) | } else { |
| [949](#L949) |  |
| [950](#L950) | //Validate the textareas |
| [951](#L951) | $ret = preg\_replace( '/[^A-Za-z0-9-\_.\*#\n\r\s\/]@/', '', $ret ); |
| [952](#L952) |  |
| [953](#L953) | //Sanitize the textarea |
| [954](#L954) | if ( function\_exists( 'sanitize\_textarea\_field' ) ) { |
| [955](#L955) | $ret = sanitize\_textarea\_field( $ret ); |
| [956](#L956) | } |
| [957](#L957) | } |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | //Return the unsplas validated and sanitized value |
| [961](#L961) | return wp\_unslash( $ret ); |
| [962](#L962) | } |
| [963](#L963) |  |
| [964](#L964) | /\*\* |
| [965](#L965) | \* Check if the parameter is set |
| [966](#L966) | \* |
| [967](#L967) | \* @param  string  $key |
| [968](#L968) | \* |
| [969](#L969) | \* @return boolean |
| [970](#L970) | \*/ |
| [971](#L971) | public static function getIsset( $key = null ) { |
| [972](#L972) | if ( ! isset( $key ) || $key == '' ) { |
| [973](#L973) | return false; |
| [974](#L974) | } |
| [975](#L975) |  |
| [976](#L976) | return isset( $\_POST[ $key ] ) || isset( $\_GET[ $key ] ); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | /\*\* |
| [980](#L980) | \* Show the notices to WP |
| [981](#L981) | \* |
| [982](#L982) | \* @param  string  $message |
| [983](#L983) | \* @param  string  $type |
| [984](#L984) | \* |
| [985](#L985) | \* @return string |
| [986](#L986) | \*/ |
| [987](#L987) | public static function showNotices( $message, $type = '' ) { |
| [988](#L988) |  |
| [989](#L989) | //Initialize WordPress Filesystem |
| [990](#L990) | $wp\_filesystem = HMWP\_Classes\_ObjController::initFilesystem(); |
| [991](#L991) |  |
| [992](#L992) | if ( $wp\_filesystem->exists( \_HMWP\_THEME\_DIR\_ . 'Notices.php' ) ) { |
| [993](#L993) | ob\_start(); |
| [994](#L994) | include \_HMWP\_THEME\_DIR\_ . 'Notices.php'; |
| [995](#L995) | $message = ob\_get\_contents(); |
| [996](#L996) | ob\_end\_clean(); |
| [997](#L997) | } |
| [998](#L998) |  |
| [999](#L999) | return $message; |
| [1000](#L1000) | } |
| [1001](#L1001) |  |
| [1002](#L1002) | /\*\* |
| [1003](#L1003) | \* Connect remote with wp\_remote\_get |
| [1004](#L1004) | \* |
| [1005](#L1005) | \* @param $url |
| [1006](#L1006) | \* @param  array  $params |
| [1007](#L1007) | \* @param  array  $options |
| [1008](#L1008) | \* |
| [1009](#L1009) | \* @return bool|string |
| [1010](#L1010) | \*/ |
| [1011](#L1011) | public static function hmwp\_remote\_get( $url, $params = array(), $options = array() ) { |
| [1012](#L1012) |  |
| [1013](#L1013) | $parameters = ''; |
| [1014](#L1014) | if ( ! empty( $params ) ) { |
| [1015](#L1015) | foreach ( $params as $key => $value ) { |
| [1016](#L1016) | if ( $key <> '' ) { |
| [1017](#L1017) | $parameters .= ( $parameters == "" ? "" : "&" ) . $key . "=" . $value; |
| [1018](#L1018) | } |
| [1019](#L1019) | } |
| [1020](#L1020) |  |
| [1021](#L1021) | if ( $parameters <> '' ) { |
| [1022](#L1022) | $url .= ( ( strpos( $url, "?" ) === false ) ? "?" : "&" ) . $parameters; |
| [1023](#L1023) | } |
| [1024](#L1024) | } |
| [1025](#L1025) |  |
| [1026](#L1026) | $response = self::hmwp\_wpcall( $url, $params, $options ); |
| [1027](#L1027) |  |
| [1028](#L1028) | if ( is\_wp\_error( $response ) ) { |
| [1029](#L1029) | return false; |
| [1030](#L1030) | } |
| [1031](#L1031) |  |
| [1032](#L1032) | return self::cleanResponce( wp\_remote\_retrieve\_body( $response ) ); //clear and get the body |
| [1033](#L1033) |  |
| [1034](#L1034) | } |
| [1035](#L1035) |  |
| [1036](#L1036) |  |
| [1037](#L1037) | /\*\* |
| [1038](#L1038) | \* Connect remote with wp\_remote\_get |
| [1039](#L1039) | \* |
| [1040](#L1040) | \* @param $url |
| [1041](#L1041) | \* @param  array  $params |
| [1042](#L1042) | \* @param  array  $options |
| [1043](#L1043) | \* |
| [1044](#L1044) | \* @return bool|string |
| [1045](#L1045) | \*/ |
| [1046](#L1046) | public static function hmwp\_remote\_post( $url, $params = array(), $options = array() ) { |
| [1047](#L1047) | $options['method'] = 'POST'; |
| [1048](#L1048) |  |
| [1049](#L1049) | $response = self::hmwp\_wpcall( $url, $params, $options ); |
| [1050](#L1050) |  |
| [1051](#L1051) | if ( is\_wp\_error( $response ) ) { |
| [1052](#L1052) | return false; |
| [1053](#L1053) | } |
| [1054](#L1054) |  |
| [1055](#L1055) | return self::cleanResponce( wp\_remote\_retrieve\_body( $response ) ); //clear and get the body |
| [1056](#L1056) |  |
| [1057](#L1057) | } |
| [1058](#L1058) |  |
| [1059](#L1059) | /\*\* |
| [1060](#L1060) | \* Use the WP remote call |
| [1061](#L1061) | \* |
| [1062](#L1062) | \* @param  string  $url |
| [1063](#L1063) | \* @param  array  $params |
| [1064](#L1064) | \* @param  array  $options |
| [1065](#L1065) | \* |
| [1066](#L1066) | \* @return array|WP\_Error The response or WP\_Error on failure. |
| [1067](#L1067) | \*/ |
| [1068](#L1068) | public static function hmwp\_wpcall( $url, $params, $options ) { |
| [1069](#L1069) | //predefined options |
| [1070](#L1070) | $options = array\_replace\_recursive( array( |
| [1071](#L1071) | 'sslverify' => \_HMWP\_CHECK\_SSL\_, |
| [1072](#L1072) | 'method'    => 'GET', |
| [1073](#L1073) | 'timeout'   => 30, |
| [1074](#L1074) | 'headers'   => array( |
| [1075](#L1075) | 'TOKEN'     => HMWP\_Classes\_Tools::getOption( 'hmwp\_token' ), |
| [1076](#L1076) | 'API-TOKEN' => HMWP\_Classes\_Tools::getOption( 'api\_token' ), |
| [1077](#L1077) | 'USER-URL'  => home\_url(), |
| [1078](#L1078) | 'LANG'      => get\_bloginfo( 'language' ), |
| [1079](#L1079) | 'VER'       => HMWP\_VERSION |
| [1080](#L1080) | ) |
| [1081](#L1081) | ), $options ); |
| [1082](#L1082) |  |
| [1083](#L1083) | if ( $options['method'] == 'POST' ) { |
| [1084](#L1084) |  |
| [1085](#L1085) | $options['body'] = $params; |
| [1086](#L1086) | unset( $options['method'] ); |
| [1087](#L1087) | $response = wp\_remote\_post( $url, $options ); |
| [1088](#L1088) | } else { |
| [1089](#L1089) |  |
| [1090](#L1090) | unset( $options['method'] ); |
| [1091](#L1091) | $response = wp\_remote\_get( $url, $options ); |
| [1092](#L1092) |  |
| [1093](#L1093) | } |
| [1094](#L1094) |  |
| [1095](#L1095) | if ( is\_wp\_error( $response ) ) { |
| [1096](#L1096) | //For debugging |
| [1097](#L1097) | do\_action( 'hmwp\_debug\_request', $url, $options, $response ); |
| [1098](#L1098) | } |
| [1099](#L1099) |  |
| [1100](#L1100) | return $response; |
| [1101](#L1101) | } |
| [1102](#L1102) |  |
| [1103](#L1103) | /\*\* |
| [1104](#L1104) | \* Call the local URLs for Security Check |
| [1105](#L1105) | \* |
| [1106](#L1106) | \* @param $url |
| [1107](#L1107) | \* @param $options |
| [1108](#L1108) | \* |
| [1109](#L1109) | \* @return array|WP\_Error |
| [1110](#L1110) | \*/ |
| [1111](#L1111) | public static function hmwp\_localcall( $url, $options = array() ) { |
| [1112](#L1112) | //predefined options |
| [1113](#L1113) | $options = array\_merge( array( |
| [1114](#L1114) | 'sslverify' => false, |
| [1115](#L1115) | 'timeout'   => 10, |
| [1116](#L1116) | ), $options ); |
| [1117](#L1117) |  |
| [1118](#L1118) | $response = wp\_remote\_get( $url, $options ); |
| [1119](#L1119) |  |
| [1120](#L1120) | if ( is\_wp\_error( $response ) ) { |
| [1121](#L1121) | //For debugging |
| [1122](#L1122) | do\_action( 'hmwp\_debug\_local\_request', $url, $options, $response ); |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | return $response; |
| [1126](#L1126) | } |
| [1127](#L1127) |  |
| [1128](#L1128) | /\*\* |
| [1129](#L1129) | \* Get the Json from responce if any |
| [1130](#L1130) | \* |
| [1131](#L1131) | \* @param  string  $response |
| [1132](#L1132) | \* |
| [1133](#L1133) | \* @return string |
| [1134](#L1134) | \*/ |
| [1135](#L1135) | private static function cleanResponce( $response ) { |
| [1136](#L1136) | return trim( $response, '()' ); |
| [1137](#L1137) | } |
| [1138](#L1138) |  |
| [1139](#L1139) | /\*\* |
| [1140](#L1140) | \* Check if HTML Headers to prevent chenging the code for other file extension |
| [1141](#L1141) | \* |
| [1142](#L1142) | \* @param  array  $types |
| [1143](#L1143) | \* |
| [1144](#L1144) | \* @return bool |
| [1145](#L1145) | \* @throws Exception |
| [1146](#L1146) | \*/ |
| [1147](#L1147) | public static function isContentHeader( $types = array( 'text/html', 'text/xml' ) ) { |
| [1148](#L1148) | $headers = headers\_list(); |
| [1149](#L1149) |  |
| [1150](#L1150) | //check the Content Type |
| [1151](#L1151) | if ( ! empty( $headers ) && ! empty( $types ) ) { |
| [1152](#L1152) | foreach ( $headers as $value ) { |
| [1153](#L1153) | if ( strpos( $value, ':' ) !== false ) { |
| [1154](#L1154) | if ( stripos( $value, 'Content-Type' ) !== false ) { |
| [1155](#L1155) |  |
| [1156](#L1156) | foreach ( $types as $type ) { |
| [1157](#L1157) | if ( stripos( $value, $type ) !== false ) { |
| [1158](#L1158) | return true; |
| [1159](#L1159) | } |
| [1160](#L1160) | } |
| [1161](#L1161) |  |
| [1162](#L1162) | return false; |
| [1163](#L1163) |  |
| [1164](#L1164) | } |
| [1165](#L1165) | } |
| [1166](#L1166) | } |
| [1167](#L1167) | } |
| [1168](#L1168) |  |
| [1169](#L1169) | return false; |
| [1170](#L1170) | } |
| [1171](#L1171) |  |
| [1172](#L1172) |  |
| [1173](#L1173) | /\*\* |
| [1174](#L1174) | \* Returns true if server is Apache |
| [1175](#L1175) | \* |
| [1176](#L1176) | \* @return boolean |
| [1177](#L1177) | \*/ |
| [1178](#L1178) | public static function isApache() { |
| [1179](#L1179) | global $is\_apache; |
| [1180](#L1180) |  |
| [1181](#L1181) | //If custom defined |
| [1182](#L1182) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1183](#L1183) | return in\_array( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ), array( |
| [1184](#L1184) | 'apache', |
| [1185](#L1185) | 'litespeed', |
| [1186](#L1186) | 'siteground' |
| [1187](#L1187) | ) ); |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | //If custom defined |
| [1191](#L1191) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'apache' ) { |
| [1192](#L1192) | return true; |
| [1193](#L1193) | } |
| [1194](#L1194) |  |
| [1195](#L1195) | if ( self::isFlywheel() ) { //force Nginx on Flywheel server |
| [1196](#L1196) | return false; |
| [1197](#L1197) | } |
| [1198](#L1198) |  |
| [1199](#L1199) | return $is\_apache; |
| [1200](#L1200) | } |
| [1201](#L1201) |  |
| [1202](#L1202) | /\*\* |
| [1203](#L1203) | \* Check if mode rewrite is on |
| [1204](#L1204) | \* |
| [1205](#L1205) | \* @return bool |
| [1206](#L1206) | \*/ |
| [1207](#L1207) | public static function isModeRewrite() { |
| [1208](#L1208) | if ( function\_exists( 'apache\_get\_modules' ) ) { |
| [1209](#L1209) | $modules = apache\_get\_modules(); |
| [1210](#L1210) | if ( ! empty( $modules ) ) { |
| [1211](#L1211) | return in\_array( 'mod\_rewrite', $modules ); |
| [1212](#L1212) | } |
| [1213](#L1213) | } |
| [1214](#L1214) |  |
| [1215](#L1215) | return true; |
| [1216](#L1216) | } |
| [1217](#L1217) |  |
| [1218](#L1218) | /\*\* |
| [1219](#L1219) | \* Check whether server is LiteSpeed |
| [1220](#L1220) | \* |
| [1221](#L1221) | \* @return bool |
| [1222](#L1222) | \*/ |
| [1223](#L1223) | public static function isLitespeed() { |
| [1224](#L1224) | $litespeed = false; |
| [1225](#L1225) |  |
| [1226](#L1226) | //If custom defined |
| [1227](#L1227) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1228](#L1228) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'litespeed' ); |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | //If custom defined |
| [1232](#L1232) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'litespeed' ) { |
| [1233](#L1233) | return true; |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | if ( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && stripos( $\_SERVER['SERVER\_SOFTWARE'], 'LiteSpeed' ) !== false ) { |
| [1237](#L1237) | $litespeed = true; |
| [1238](#L1238) | } elseif ( isset( $\_SERVER['SERVER\_NAME'] ) && stripos( $\_SERVER['SERVER\_NAME'], 'LiteSpeed' ) !== false ) { |
| [1239](#L1239) | $litespeed = true; |
| [1240](#L1240) | } elseif ( isset( $\_SERVER['X-Litespeed-Cache-Control'] ) ) { |
| [1241](#L1241) | $litespeed = true; |
| [1242](#L1242) | } |
| [1243](#L1243) |  |
| [1244](#L1244) | if ( self::isFlywheel() ) { |
| [1245](#L1245) | return false; |
| [1246](#L1246) | } |
| [1247](#L1247) |  |
| [1248](#L1248) | return $litespeed; |
| [1249](#L1249) | } |
| [1250](#L1250) |  |
| [1251](#L1251) | /\*\* |
| [1252](#L1252) | \* Check whether server is Lighthttp |
| [1253](#L1253) | \* |
| [1254](#L1254) | \* @return bool |
| [1255](#L1255) | \*/ |
| [1256](#L1256) | public static function isLighthttp() { |
| [1257](#L1257) | return ( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && stripos( $\_SERVER['SERVER\_SOFTWARE'], 'lighttpd' ) !== false ); |
| [1258](#L1258) | } |
| [1259](#L1259) |  |
| [1260](#L1260) | /\*\* |
| [1261](#L1261) | \* Check whether server is AWS StoreFront Bitnami |
| [1262](#L1262) | \* |
| [1263](#L1263) | \* @return bool |
| [1264](#L1264) | \*/ |
| [1265](#L1265) | public static function isAWS() { |
| [1266](#L1266) | //If custom defined |
| [1267](#L1267) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1268](#L1268) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'bitnami' ); |
| [1269](#L1269) | } |
| [1270](#L1270) |  |
| [1271](#L1271) | if ( isset( $\_SERVER["DOCUMENT\_ROOT"] ) && strpos( $\_SERVER["DOCUMENT\_ROOT"], "/bitnami/" ) ) { |
| [1272](#L1272) | return true; |
| [1273](#L1273) | } |
| [1274](#L1274) |  |
| [1275](#L1275) | $headers = headers\_list(); |
| [1276](#L1276) |  |
| [1277](#L1277) | foreach ( $headers as $header ) { |
| [1278](#L1278) | if ( strpos( $header, 'x-amz-cf-id' ) !== false ) { |
| [1279](#L1279) | return true; |
| [1280](#L1280) | } |
| [1281](#L1281) | } |
| [1282](#L1282) |  |
| [1283](#L1283) | return false; |
| [1284](#L1284) | } |
| [1285](#L1285) |  |
| [1286](#L1286) | /\*\* |
| [1287](#L1287) | \* Check if multisites |
| [1288](#L1288) | \* |
| [1289](#L1289) | \* @return bool |
| [1290](#L1290) | \*/ |
| [1291](#L1291) | public static function isMultisites() { |
| [1292](#L1292) | return is\_multisite(); |
| [1293](#L1293) | } |
| [1294](#L1294) |  |
| [1295](#L1295) | /\*\* |
| [1296](#L1296) | \* Check if multisites with path |
| [1297](#L1297) | \* |
| [1298](#L1298) | \* @return bool |
| [1299](#L1299) | \*/ |
| [1300](#L1300) | public static function isMultisiteWithPath() { |
| [1301](#L1301) | return ( is\_multisite() && ( ( defined( 'SUBDOMAIN\_INSTALL' ) && ! SUBDOMAIN\_INSTALL ) || ( defined( 'VHOST' ) && VHOST == 'no' ) ) ); |
| [1302](#L1302) | } |
| [1303](#L1303) |  |
| [1304](#L1304) | /\*\* |
| [1305](#L1305) | \* Returns true if server is nginx |
| [1306](#L1306) | \* |
| [1307](#L1307) | \* @return boolean |
| [1308](#L1308) | \*/ |
| [1309](#L1309) | public static function isNginx() { |
| [1310](#L1310) | global $is\_nginx; |
| [1311](#L1311) |  |
| [1312](#L1312) | //If custom defined |
| [1313](#L1313) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1314](#L1314) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'nginx' ) { |
| [1315](#L1315) | return true; |
| [1316](#L1316) | } |
| [1317](#L1317) | } |
| [1318](#L1318) |  |
| [1319](#L1319) | //If custom defined |
| [1320](#L1320) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'nginx' ) { |
| [1321](#L1321) | return true; |
| [1322](#L1322) | } |
| [1323](#L1323) |  |
| [1324](#L1324) | return ( $is\_nginx || ( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && ( stripos( $\_SERVER['SERVER\_SOFTWARE'], 'nginx' ) !== false || stripos( $\_SERVER['SERVER\_SOFTWARE'], 'TasteWP' ) !== false ) ) ); |
| [1325](#L1325) | } |
| [1326](#L1326) |  |
| [1327](#L1327) | /\*\* |
| [1328](#L1328) | \* Returns true if server is Wpengine |
| [1329](#L1329) | \* |
| [1330](#L1330) | \* @return boolean |
| [1331](#L1331) | \*/ |
| [1332](#L1332) | public static function isWpengine() { |
| [1333](#L1333) | //If custom defined |
| [1334](#L1334) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1335](#L1335) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'wpengine' ); |
| [1336](#L1336) | } |
| [1337](#L1337) |  |
| [1338](#L1338) | //If custom defined |
| [1339](#L1339) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'wpengine' ) { |
| [1340](#L1340) | return true; |
| [1341](#L1341) | } |
| [1342](#L1342) |  |
| [1343](#L1343) | return ( isset( $\_SERVER['WPENGINE\_PHPSESSIONS'] ) ); |
| [1344](#L1344) | } |
| [1345](#L1345) |  |
| [1346](#L1346) | /\*\* |
| [1347](#L1347) | \* Returns true if server is Local by Flywheel |
| [1348](#L1348) | \* |
| [1349](#L1349) | \* @return boolean |
| [1350](#L1350) | \*/ |
| [1351](#L1351) | public static function isLocalFlywheel() { |
| [1352](#L1352) |  |
| [1353](#L1353) | //If custom defined |
| [1354](#L1354) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1355](#L1355) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'local' ); |
| [1356](#L1356) | } |
| [1357](#L1357) |  |
| [1358](#L1358) | return false; |
| [1359](#L1359) | } |
| [1360](#L1360) |  |
| [1361](#L1361) | /\*\* |
| [1362](#L1362) | \* Returns true if server is Wpengine |
| [1363](#L1363) | \* |
| [1364](#L1364) | \* @return boolean |
| [1365](#L1365) | \*/ |
| [1366](#L1366) | public static function isFlywheel() { |
| [1367](#L1367) |  |
| [1368](#L1368) | //If custom defined |
| [1369](#L1369) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1370](#L1370) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'flywheel' ); |
| [1371](#L1371) | } |
| [1372](#L1372) |  |
| [1373](#L1373) | //If custom defined |
| [1374](#L1374) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'flywheel' ) { |
| [1375](#L1375) | return true; |
| [1376](#L1376) | } |
| [1377](#L1377) |  |
| [1378](#L1378) | if ( isset( $\_SERVER['SERVER'] ) && stripos( $\_SERVER['SERVER'], 'Flywheel' ) !== false ) { |
| [1379](#L1379) | return true; |
| [1380](#L1380) | } |
| [1381](#L1381) |  |
| [1382](#L1382) | return ( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && stripos( $\_SERVER['SERVER\_SOFTWARE'], 'Flywheel' ) !== false ); |
| [1383](#L1383) | } |
| [1384](#L1384) |  |
| [1385](#L1385) | /\*\* |
| [1386](#L1386) | \* Returns true if server is Inmotion |
| [1387](#L1387) | \* |
| [1388](#L1388) | \* @return boolean |
| [1389](#L1389) | \*/ |
| [1390](#L1390) | public static function isInmotion() { |
| [1391](#L1391) |  |
| [1392](#L1392) | //If custom defined |
| [1393](#L1393) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1394](#L1394) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'inmotion' ); |
| [1395](#L1395) | } |
| [1396](#L1396) |  |
| [1397](#L1397) | //If custom defined |
| [1398](#L1398) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'inmotion' ) { |
| [1399](#L1399) | return true; |
| [1400](#L1400) | } |
| [1401](#L1401) |  |
| [1402](#L1402) | return ( isset( $\_SERVER['SERVER\_ADDR'] ) && stripos( @gethostbyaddr( $\_SERVER['SERVER\_ADDR'] ), 'inmotionhosting.com' ) !== false ); |
| [1403](#L1403) | } |
| [1404](#L1404) |  |
| [1405](#L1405) | /\*\* |
| [1406](#L1406) | \* Returns true if server is Godaddy |
| [1407](#L1407) | \* |
| [1408](#L1408) | \* @return boolean |
| [1409](#L1409) | \*/ |
| [1410](#L1410) | public static function isGodaddy() { |
| [1411](#L1411) |  |
| [1412](#L1412) | //If custom defined |
| [1413](#L1413) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1414](#L1414) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'godaddy' ); |
| [1415](#L1415) | } |
| [1416](#L1416) |  |
| [1417](#L1417) | //If custom defined |
| [1418](#L1418) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'godaddy' ) { |
| [1419](#L1419) | return true; |
| [1420](#L1420) | } |
| [1421](#L1421) |  |
| [1422](#L1422) | return ( file\_exists( ABSPATH . 'gd-config.php' ) ); |
| [1423](#L1423) | } |
| [1424](#L1424) |  |
| [1425](#L1425) | /\*\* |
| [1426](#L1426) | \* Returns true if server is IIS |
| [1427](#L1427) | \* |
| [1428](#L1428) | \* @return boolean |
| [1429](#L1429) | \*/ |
| [1430](#L1430) | public static function isIIS() { |
| [1431](#L1431) | global $is\_IIS, $is\_iis7; |
| [1432](#L1432) |  |
| [1433](#L1433) | //If custom defined |
| [1434](#L1434) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1435](#L1435) | return ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'iis' ); |
| [1436](#L1436) | } |
| [1437](#L1437) |  |
| [1438](#L1438) | //If custom defined |
| [1439](#L1439) | if ( defined( 'HMWP\_SERVER\_TYPE' ) && strtolower( HMWP\_SERVER\_TYPE ) == 'iis' ) { |
| [1440](#L1440) | return true; |
| [1441](#L1441) | } |
| [1442](#L1442) |  |
| [1443](#L1443) | return ( $is\_iis7 || $is\_IIS || ( isset( $\_SERVER['SERVER\_SOFTWARE'] ) && stripos( $\_SERVER['SERVER\_SOFTWARE'], 'microsoft-iis' ) !== false ) ); |
| [1444](#L1444) | } |
| [1445](#L1445) |  |
| [1446](#L1446) | /\*\* |
| [1447](#L1447) | \* Returns true if windows |
| [1448](#L1448) | \* |
| [1449](#L1449) | \* @return bool |
| [1450](#L1450) | \*/ |
| [1451](#L1451) | public static function isWindows() { |
| [1452](#L1452) | return ( strtoupper( substr( PHP\_OS, 0, 3 ) ) === 'WIN' ); |
| [1453](#L1453) | } |
| [1454](#L1454) |  |
| [1455](#L1455) | /\*\* |
| [1456](#L1456) | \* Check if IIS has rewritten 2 structure enabled |
| [1457](#L1457) | \* |
| [1458](#L1458) | \* @return bool |
| [1459](#L1459) | \*/ |
| [1460](#L1460) | public static function isPHPPermalink() { |
| [1461](#L1461) | if ( get\_option( 'permalink\_structure' ) ) { |
| [1462](#L1462) | if ( strpos( get\_option( 'permalink\_structure' ), 'index.php' ) !== false || stripos( get\_option( 'permalink\_structure' ), 'index.html' ) !== false || strpos( get\_option( 'permalink\_structure' ), 'index.htm' ) !== false ) { |
| [1463](#L1463) | return true; |
| [1464](#L1464) | } |
| [1465](#L1465) | } |
| [1466](#L1466) |  |
| [1467](#L1467) | return false; |
| [1468](#L1468) | } |
| [1469](#L1469) |  |
| [1470](#L1470) | /\*\* |
| [1471](#L1471) | \* Returns true if server is Godaddy |
| [1472](#L1472) | \* |
| [1473](#L1473) | \* @return boolean |
| [1474](#L1474) | \*/ |
| [1475](#L1475) | public static function isCloudPanel() { |
| [1476](#L1476) |  |
| [1477](#L1477) | global $is\_nginx; |
| [1478](#L1478) |  |
| [1479](#L1479) | //If custom defined |
| [1480](#L1480) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) <> 'auto' ) { |
| [1481](#L1481) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_server\_type' ) == 'cloudpanel' ) { |
| [1482](#L1482) | $is\_nginx = true; |
| [1483](#L1483) |  |
| [1484](#L1484) | return true; |
| [1485](#L1485) | } |
| [1486](#L1486) | } |
| [1487](#L1487) |  |
| [1488](#L1488) | return false; |
| [1489](#L1489) | } |
| [1490](#L1490) |  |
| [1491](#L1491) | /\*\* |
| [1492](#L1492) | \* Is a cache plugin installed in WordPress? |
| [1493](#L1493) | \* |
| [1494](#L1494) | \* @return bool |
| [1495](#L1495) | \*/ |
| [1496](#L1496) | public static function isCachePlugin() { |
| [1497](#L1497) | return ( HMWP\_Classes\_Tools::isPluginActive( 'autoptimize/autoptimize.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'beaver-builder-lite-version/fl-builder.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'beaver-builder/fl-builder.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'breeze/breeze.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'cache-enabler/cache-enabler.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'comet-cache/comet-cache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'hummingbird-performance/wp-hummingbird.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'hyper-cache/plugin.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'jch-optimize/jch-optimize.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'litespeed-cache/litespeed-cache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'powered-cache/powered-cache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'sg-cachepress/sg-cachepress.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'w3-total-cache/w3-total-cache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'wp-asset-clean-up/wpacu.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'wp-fastest-cache/wpFastestCache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'wp-rocket/wp-rocket.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'wp-super-cache/wp-cache.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'swift-performance/performance.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'swift-performance-lite/performance.php' ) || HMWP\_Classes\_Tools::isPluginActive( 'nitropack/main.php' ) || WP\_CACHE ); |
| [1498](#L1498) | } |
| [1499](#L1499) |  |
| [1500](#L1500) | /\*\* |
| [1501](#L1501) | \* Check whether the plugin is active by checking the active\_plugins list. |
| [1502](#L1502) | \* |
| [1503](#L1503) | \* @source wp-admin/includes/plugin.php |
| [1504](#L1504) | \* |
| [1505](#L1505) | \* @param  string  $plugin  Plugin folder/main file. |
| [1506](#L1506) | \* |
| [1507](#L1507) | \* @return boolean |
| [1508](#L1508) | \*/ |
| [1509](#L1509) | public static function isPluginActive( $plugin ) { |
| [1510](#L1510) |  |
| [1511](#L1511) | if ( empty( self::$active\_plugins ) ) { |
| [1512](#L1512) |  |
| [1513](#L1513) | if ( self::isMultisites() ) { |
| [1514](#L1514) |  |
| [1515](#L1515) | if ( ! $sitewide\_plugins = get\_site\_option( 'active\_sitewide\_plugins' ) ) { |
| [1516](#L1516) | $sitewide\_plugins = array(); |
| [1517](#L1517) | } |
| [1518](#L1518) |  |
| [1519](#L1519) | self::$active\_plugins = array\_keys( $sitewide\_plugins ); |
| [1520](#L1520) |  |
| [1521](#L1521) | $sites = get\_sites( array( 'number' => 10000, 'public' => 1, 'deleted' => 0, ) ); |
| [1522](#L1522) | foreach ( $sites as $site ) { |
| [1523](#L1523) | switch\_to\_blog( $site->blog\_id ); |
| [1524](#L1524) |  |
| [1525](#L1525) | $active\_plugins = (array) get\_option( 'active\_plugins', array() ); |
| [1526](#L1526) |  |
| [1527](#L1527) | self::$active\_plugins = array\_merge( self::$active\_plugins, $active\_plugins ); |
| [1528](#L1528) |  |
| [1529](#L1529) | restore\_current\_blog(); |
| [1530](#L1530) | } |
| [1531](#L1531) |  |
| [1532](#L1532) | if ( ! empty( self::$active\_plugins ) ) { |
| [1533](#L1533) | self::$active\_plugins = array\_unique( self::$active\_plugins ); |
| [1534](#L1534) | } |
| [1535](#L1535) |  |
| [1536](#L1536) | } else { |
| [1537](#L1537) | self::$active\_plugins = (array) get\_option( 'active\_plugins', array() ); |
| [1538](#L1538) | } |
| [1539](#L1539) |  |
| [1540](#L1540) | } |
| [1541](#L1541) |  |
| [1542](#L1542) | return in\_array( $plugin, self::$active\_plugins, true ); |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | /\*\* |
| [1546](#L1546) | \* Check whether the theme is active. |
| [1547](#L1547) | \* |
| [1548](#L1548) | \* @param  string  $name  Theme folder/main file. |
| [1549](#L1549) | \* |
| [1550](#L1550) | \* @return boolean |
| [1551](#L1551) | \*/ |
| [1552](#L1552) | public static function isThemeActive( $name ) { |
| [1553](#L1553) | $theme = get\_option( 'template' ); |
| [1554](#L1554) |  |
| [1555](#L1555) | if ( $theme ) { |
| [1556](#L1556) | if ( strtolower( $theme ) == strtolower( $name ) || strtolower( $theme ) == strtolower( $name ) . ' child' || strtolower( $theme ) == strtolower( $name ) . ' child theme' ) { |
| [1557](#L1557) | return true; |
| [1558](#L1558) | } |
| [1559](#L1559) | } |
| [1560](#L1560) |  |
| [1561](#L1561) | return false; |
| [1562](#L1562) | } |
| [1563](#L1563) |  |
| [1564](#L1564) | /\*\* |
| [1565](#L1565) | \* Get all the plugin names |
| [1566](#L1566) | \* |
| [1567](#L1567) | \* @return array |
| [1568](#L1568) | \*/ |
| [1569](#L1569) | public static function getAllPlugins() { |
| [1570](#L1570) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_hide\_all\_plugins' ) ) { |
| [1571](#L1571) | if ( ! function\_exists( 'get\_plugins' ) ) { |
| [1572](#L1572) | include\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [1573](#L1573) | } |
| [1574](#L1574) |  |
| [1575](#L1575) | $all\_plugins = array\_keys( get\_plugins() ); |
| [1576](#L1576) | } else { |
| [1577](#L1577) | $all\_plugins = (array) get\_option( 'active\_plugins', array() ); |
| [1578](#L1578) | } |
| [1579](#L1579) |  |
| [1580](#L1580) | if ( self::isMultisites() ) { |
| [1581](#L1581) | $all\_plugins = array\_merge( array\_values( $all\_plugins ), array\_keys( get\_site\_option( 'active\_sitewide\_plugins' ) ) ); |
| [1582](#L1582) | } |
| [1583](#L1583) |  |
| [1584](#L1584) | return $all\_plugins; |
| [1585](#L1585) | } |
| [1586](#L1586) |  |
| [1587](#L1587) | /\*\* |
| [1588](#L1588) | \* Get all the themes names |
| [1589](#L1589) | \* |
| [1590](#L1590) | \* @return array |
| [1591](#L1591) | \*/ |
| [1592](#L1592) | public static function getAllThemes() { |
| [1593](#L1593) | return search\_theme\_directories(); |
| [1594](#L1594) | } |
| [1595](#L1595) |  |
| [1596](#L1596) | /\*\* |
| [1597](#L1597) | \* Get the absolute filesystem path to the root of the WordPress installation |
| [1598](#L1598) | \* |
| [1599](#L1599) | \* @return string Full filesystem path to the root of the WordPress installation |
| [1600](#L1600) | \*/ |
| [1601](#L1601) | public static function getRootPath() { |
| [1602](#L1602) | $root\_path = ABSPATH; |
| [1603](#L1603) |  |
| [1604](#L1604) | if ( defined( '\_HMWP\_CONFIGPATH' ) ) { |
| [1605](#L1605) | $root\_path = \_HMWP\_CONFIGPATH; |
| [1606](#L1606) | } elseif ( self::isFlywheel() && defined( 'WP\_CONTENT\_DIR' ) && dirname( WP\_CONTENT\_DIR ) ) { |
| [1607](#L1607) | $root\_path = str\_replace( '\\', '/', dirname( WP\_CONTENT\_DIR ) ) . '/'; |
| [1608](#L1608) | } |
| [1609](#L1609) |  |
| [1610](#L1610) | return apply\_filters( 'hmwp\_root\_path', $root\_path ); |
| [1611](#L1611) |  |
| [1612](#L1612) | } |
| [1613](#L1613) |  |
| [1614](#L1614) | /\*\* |
| [1615](#L1615) | \* Get the absolute filesystem path to the root of the WordPress installation |
| [1616](#L1616) | \* |
| [1617](#L1617) | \* @return string Full filesystem path to the root of the WordPress installation |
| [1618](#L1618) | \*/ |
| [1619](#L1619) | public static function getHomeRootPath() { |
| [1620](#L1620) | $home\_root = '/'; |
| [1621](#L1621) | if ( HMWP\_Classes\_Tools::isMultisites() && defined( 'PATH\_CURRENT\_SITE' ) ) { |
| [1622](#L1622) | $path = PATH\_CURRENT\_SITE; |
| [1623](#L1623) | } else { |
| [1624](#L1624) | $path = wp\_parse\_url( site\_url(), PHP\_URL\_PATH ); |
| [1625](#L1625) | } |
| [1626](#L1626) |  |
| [1627](#L1627) | if ( $path ) { |
| [1628](#L1628) | $home\_root = trailingslashit( $path ); |
| [1629](#L1629) | } |
| [1630](#L1630) |  |
| [1631](#L1631) | return apply\_filters( 'hmwp\_home\_root', $home\_root ); |
| [1632](#L1632) | } |
| [1633](#L1633) |  |
| [1634](#L1634) | /\*\* |
| [1635](#L1635) | \* Get Relative path for the current blog in case of WP Multisite |
| [1636](#L1636) | \* |
| [1637](#L1637) | \* @param $url |
| [1638](#L1638) | \* |
| [1639](#L1639) | \* @return string |
| [1640](#L1640) | \*/ |
| [1641](#L1641) | public static function getRelativePath( $url ) { |
| [1642](#L1642) |  |
| [1643](#L1643) | if ( $url <> '' ) { |
| [1644](#L1644) | // Get the relative url path |
| [1645](#L1645) | $url = wp\_make\_link\_relative( $url ); |
| [1646](#L1646) |  |
| [1647](#L1647) | // Get the relative domain |
| [1648](#L1648) | $domain = site\_url(); |
| [1649](#L1649) |  |
| [1650](#L1650) | // f WP Multisite, get the root domain |
| [1651](#L1651) | if ( self::isMultisiteWithPath() ) { |
| [1652](#L1652) | $domain = network\_site\_url(); |
| [1653](#L1653) | } |
| [1654](#L1654) |  |
| [1655](#L1655) | // Get relative path and exclude any root domain from URL |
| [1656](#L1656) | if($domain = wp\_make\_link\_relative( trim($domain , '/') )){ |
| [1657](#L1657) | $url = str\_replace( $domain, '', $url ); |
| [1658](#L1658) | } |
| [1659](#L1659) |  |
| [1660](#L1660) | //remove the domain path if exists |
| [1661](#L1661) | if ( self::isMultisiteWithPath() && defined( 'PATH\_CURRENT\_SITE' ) && PATH\_CURRENT\_SITE <> '/' ) { |
| [1662](#L1662) | $url = str\_replace( rtrim( PATH\_CURRENT\_SITE, '/' ), '', $url ); |
| [1663](#L1663) | } |
| [1664](#L1664) | } |
| [1665](#L1665) |  |
| [1666](#L1666) | return trailingslashit( $url ); |
| [1667](#L1667) | } |
| [1668](#L1668) |  |
| [1669](#L1669) | /\*\* |
| [1670](#L1670) | \* Check if wp-content is changed and set in a different location |
| [1671](#L1671) | \* |
| [1672](#L1672) | \* @ver 7.0.12 |
| [1673](#L1673) | \* |
| [1674](#L1674) | \* @return bool |
| [1675](#L1675) | \*/ |
| [1676](#L1676) | public static function isDifferentWPContentPath() { |
| [1677](#L1677) | $homepath = ''; |
| [1678](#L1678) | if ( wp\_parse\_url( site\_url(), PHP\_URL\_PATH ) ) { |
| [1679](#L1679) | $homepath = ltrim( wp\_parse\_url( site\_url(), PHP\_URL\_PATH ), '/' ); |
| [1680](#L1680) | } |
| [1681](#L1681) |  |
| [1682](#L1682) | if ( $homepath <> '/' ) { |
| [1683](#L1683) | $contenturl = ltrim( wp\_parse\_url( content\_url(), PHP\_URL\_PATH ), '/' ); |
| [1684](#L1684) |  |
| [1685](#L1685) | return ( strpos( $contenturl, $homepath . '/' ) === false ); |
| [1686](#L1686) | } |
| [1687](#L1687) |  |
| [1688](#L1688) | return false; |
| [1689](#L1689) | } |
| [1690](#L1690) |  |
| [1691](#L1691) | /\*\* |
| [1692](#L1692) | \* Empty the cache from other cache plugins when save the settings |
| [1693](#L1693) | \*/ |
| [1694](#L1694) | public static function emptyCache() { |
| [1695](#L1695) |  |
| [1696](#L1696) | try { |
| [1697](#L1697) | //Empty WordPress rewrites count for 404 error. |
| [1698](#L1698) | //This happens when the rules are not saved through config file |
| [1699](#L1699) | HMWP\_Classes\_Tools::saveOptions( 'file\_mappings', array() ); |
| [1700](#L1700) |  |
| [1701](#L1701) | //For debugging |
| [1702](#L1702) | do\_action( 'hmwp\_debug\_cache', '' ); |
| [1703](#L1703) |  |
| [1704](#L1704) | if ( class\_exists( '\FlyingPress\Purge' ) && method\_exists( '\FlyingPress\Purge', 'purge\_everything' ) ) { |
| [1705](#L1705) | \FlyingPress\Purge::purge\_everything(); |
| [1706](#L1706) | } |
| [1707](#L1707) |  |
| [1708](#L1708) | if ( class\_exists( '\JchOptimize\Platform\Cache' ) && method\_exists( '\JchOptimize\Platform\Cache', 'deleteCache' ) ) { |
| [1709](#L1709) | \JchOptimize\Platform\Cache::deleteCache(); |
| [1710](#L1710) | } |
| [1711](#L1711) |  |
| [1712](#L1712) | if ( class\_exists( 'LiteSpeed\_Cache\_API' ) && method\_exists( 'LiteSpeed\_Cache\_API', 'purge\_all' ) ) { |
| [1713](#L1713) | \LiteSpeed\_Cache\_API::purge\_all(); |
| [1714](#L1714) | } |
| [1715](#L1715) | ////////////////////////////////////////////////////////////////////////////// |
| [1716](#L1716) | if ( function\_exists( 'w3tc\_pgcache\_flush' ) ) { |
| [1717](#L1717) | w3tc\_pgcache\_flush(); |
| [1718](#L1718) | } |
| [1719](#L1719) |  |
| [1720](#L1720) | if ( function\_exists( 'w3tc\_minify\_flush' ) ) { |
| [1721](#L1721) | w3tc\_minify\_flush(); |
| [1722](#L1722) | } |
| [1723](#L1723) | if ( function\_exists( 'w3tc\_dbcache\_flush' ) ) { |
| [1724](#L1724) | w3tc\_dbcache\_flush(); |
| [1725](#L1725) | } |
| [1726](#L1726) | if ( function\_exists( 'w3tc\_objectcache\_flush' ) ) { |
| [1727](#L1727) | w3tc\_objectcache\_flush(); |
| [1728](#L1728) | } |
| [1729](#L1729) | ////////////////////////////////////////////////////////////////////////////// |
| [1730](#L1730) |  |
| [1731](#L1731) | if ( function\_exists( 'wp\_cache\_clear\_cache' ) ) { |
| [1732](#L1732) | wp\_cache\_clear\_cache(); |
| [1733](#L1733) | } |
| [1734](#L1734) |  |
| [1735](#L1735) | if ( function\_exists( 'rocket\_clean\_domain' ) && function\_exists( 'rocket\_clean\_minify' ) && function\_exists( 'rocket\_clean\_cache\_busting' ) ) { |
| [1736](#L1736) | // Remove all cache files |
| [1737](#L1737) | rocket\_clean\_domain(); |
| [1738](#L1738) | rocket\_clean\_minify(); |
| [1739](#L1739) | rocket\_clean\_cache\_busting(); |
| [1740](#L1740) | } |
| [1741](#L1741) | ////////////////////////////////////////////////////////////////////////////// |
| [1742](#L1742) |  |
| [1743](#L1743) | if ( function\_exists( 'apc\_clear\_cache' ) ) { |
| [1744](#L1744) | // Remove all apc if enabled |
| [1745](#L1745) | apc\_clear\_cache(); |
| [1746](#L1746) | } |
| [1747](#L1747) | ////////////////////////////////////////////////////////////////////////////// |
| [1748](#L1748) |  |
| [1749](#L1749) | if ( class\_exists( 'Cache\_Enabler\_Disk' ) && method\_exists( 'Cache\_Enabler\_Disk', 'clear\_cache' ) ) { |
| [1750](#L1750) | // clear disk cache |
| [1751](#L1751) | Cache\_Enabler\_Disk::clear\_cache(); |
| [1752](#L1752) | } |
| [1753](#L1753) | ////////////////////////////////////////////////////////////////////////////// |
| [1754](#L1754) |  |
| [1755](#L1755) | if ( class\_exists( 'LiteSpeed\_Cache' ) ) { |
| [1756](#L1756) | LiteSpeed\_Cache::get\_instance()->purge\_all(); |
| [1757](#L1757) | } |
| [1758](#L1758) |  |
| [1759](#L1759) | if ( self::isPluginActive( 'litespeed-cache/litespeed-cache.php' ) ) { |
| [1760](#L1760) | header( "X-LiteSpeed-Purge: \*" ); |
| [1761](#L1761) | } |
| [1762](#L1762) | ////////////////////////////////////////////////////////////////////////////// |
| [1763](#L1763) |  |
| [1764](#L1764) | if ( self::isPluginActive( 'hummingbird-performance/wp-hummingbird.php' ) ) { |
| [1765](#L1765) | do\_action( 'wphb\_clear\_page\_cache' ); |
| [1766](#L1766) | } |
| [1767](#L1767) | ////////////////////////////////////////////////////////////////////////////// |
| [1768](#L1768) |  |
| [1769](#L1769) | if ( class\_exists( 'WpeCommon' ) ) { |
| [1770](#L1770) | if ( method\_exists( 'WpeCommon', 'purge\_memcached' ) ) { |
| [1771](#L1771) | WpeCommon::purge\_memcached(); |
| [1772](#L1772) | } |
| [1773](#L1773) | if ( method\_exists( 'WpeCommon', 'clear\_maxcdn\_cache' ) ) { |
| [1774](#L1774) | WpeCommon::clear\_maxcdn\_cache(); |
| [1775](#L1775) | } |
| [1776](#L1776) | if ( method\_exists( 'WpeCommon', 'purge\_varnish\_cache' ) ) { |
| [1777](#L1777) | WpeCommon::purge\_varnish\_cache(); |
| [1778](#L1778) | } |
| [1779](#L1779) | } |
| [1780](#L1780) | ////////////////////////////////////////////////////////////////////////////// |
| [1781](#L1781) |  |
| [1782](#L1782) | if ( self::isPluginActive( 'sg-cachepress/sg-cachepress.php' ) && class\_exists( 'Supercacher' ) ) { |
| [1783](#L1783) | if ( method\_exists( 'Supercacher', 'purge\_cache' ) && method\_exists( 'Supercacher', 'delete\_assets' ) ) { |
| [1784](#L1784) | Supercacher::purge\_cache(); |
| [1785](#L1785) | Supercacher::delete\_assets(); |
| [1786](#L1786) | } |
| [1787](#L1787) | } |
| [1788](#L1788) |  |
| [1789](#L1789) | //Clear the fastest cache |
| [1790](#L1790) | global $wp\_fastest\_cache; |
| [1791](#L1791) | if ( isset( $wp\_fastest\_cache ) && method\_exists( $wp\_fastest\_cache, 'deleteCache' ) ) { |
| [1792](#L1792) | $wp\_fastest\_cache->deleteCache(); |
| [1793](#L1793) | } |
| [1794](#L1794) | ////////////////////////////////////////////////////////////////////////////// |
| [1795](#L1795) | } catch ( Exception $e ) { |
| [1796](#L1796) | // handle exception |
| [1797](#L1797) | } |
| [1798](#L1798) |  |
| [1799](#L1799) | } |
| [1800](#L1800) |  |
| [1801](#L1801) | /\*\* |
| [1802](#L1802) | \* Flush the WordPress rewrites |
| [1803](#L1803) | \*/ |
| [1804](#L1804) | public static function flushWPRewrites() { |
| [1805](#L1805) | if ( HMWP\_Classes\_Tools::isPluginActive( 'woocommerce/woocommerce.php' ) ) { |
| [1806](#L1806) | update\_option( 'woocommerce\_queue\_flush\_rewrite\_rules', 'yes' ); |
| [1807](#L1807) | } |
| [1808](#L1808) |  |
| [1809](#L1809) | } |
| [1810](#L1810) |  |
| [1811](#L1811) | /\*\* |
| [1812](#L1812) | \* Called on plugin activation |
| [1813](#L1813) | \* |
| [1814](#L1814) | \* @throws Exception |
| [1815](#L1815) | \*/ |
| [1816](#L1816) | public function hmwp\_activate() { |
| [1817](#L1817) | set\_transient( 'hmwp\_activate', true ); |
| [1818](#L1818) |  |
| [1819](#L1819) | //set restore settings option on plugin activate |
| [1820](#L1820) | $lastsafeoptions = self::getOptions( true ); |
| [1821](#L1821) | if ( isset( $lastsafeoptions['hmwp\_mode'] ) && ( $lastsafeoptions['hmwp\_mode'] == 'ninja' || $lastsafeoptions['hmwp\_mode'] == 'lite' ) ) { |
| [1822](#L1822) | set\_transient( 'hmwp\_restore', true ); |
| [1823](#L1823) | } |
| [1824](#L1824) |  |
| [1825](#L1825) | //Initialize the compatibility with other plugins |
| [1826](#L1826) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Compatibility' )->install(); |
| [1827](#L1827) | } |
| [1828](#L1828) |  |
| [1829](#L1829) | /\*\* |
| [1830](#L1830) | \* Called on plugin deactivation |
| [1831](#L1831) | \* Remove all the rewrite rules on deactivation |
| [1832](#L1832) | \* |
| [1833](#L1833) | \* @throws Exception |
| [1834](#L1834) | \*/ |
| [1835](#L1835) | public function hmwp\_deactivate() { |
| [1836](#L1836) | $options = self::$default; |
| [1837](#L1837) | //Prevent duplicates |
| [1838](#L1838) | foreach ( $options as $key => $value ) { |
| [1839](#L1839) | //set the default params from tools |
| [1840](#L1840) | self::saveOptions( $key, $value ); |
| [1841](#L1841) | } |
| [1842](#L1842) |  |
| [1843](#L1843) | //remove user capability |
| [1844](#L1844) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_RoleManager' )->removeHMWPCaps(); |
| [1845](#L1845) |  |
| [1846](#L1846) | //remove the custom rules |
| [1847](#L1847) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rules' )->writeToFile( '', 'HMWP\_VULNERABILITY' ); |
| [1848](#L1848) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rules' )->writeToFile( '', 'HMWP\_RULES' ); |
| [1849](#L1849) |  |
| [1850](#L1850) | //clear the locked ips |
| [1851](#L1851) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Controllers\_Brute' )->clearBlockedIPs(); |
| [1852](#L1852) |  |
| [1853](#L1853) | //Build the redirect table |
| [1854](#L1854) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rewrite' )->flushChanges(); |
| [1855](#L1855) |  |
| [1856](#L1856) | //Delete the compatibility with other plugins |
| [1857](#L1857) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Compatibility' )->uninstall(); |
| [1858](#L1858) | } |
| [1859](#L1859) |  |
| [1860](#L1860) | /\*\* |
| [1861](#L1861) | \* Call this function on rewrite update from other plugins |
| [1862](#L1862) | \* |
| [1863](#L1863) | \* @param  array  $wp\_rules |
| [1864](#L1864) | \* |
| [1865](#L1865) | \* @return array |
| [1866](#L1866) | \* @throws Exception |
| [1867](#L1867) | \*/ |
| [1868](#L1868) | public function checkRewriteUpdate( $wp\_rules = array() ) { |
| [1869](#L1869) | try { |
| [1870](#L1870) | if ( ! HMWP\_Classes\_Tools::getOption( 'error' ) && ! HMWP\_Classes\_Tools::getOption( 'logout' ) ) { |
| [1871](#L1871) |  |
| [1872](#L1872) | //Build the redirect table |
| [1873](#L1873) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rewrite' )->clearRedirect()->setRewriteRules()->flushRewrites(); |
| [1874](#L1874) |  |
| [1875](#L1875) | //INSERT SEURITY RULES |
| [1876](#L1876) | if ( ! HMWP\_Classes\_Tools::isIIS() ) { |
| [1877](#L1877) | //For Nginx and Apache the rules can be inserted separately |
| [1878](#L1878) | $rules = HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rules' )->getInjectionRewrite(); |
| [1879](#L1879) |  |
| [1880](#L1880) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Rules' )->writeToFile( $rules, 'HMWP\_VULNERABILITY' ); |
| [1881](#L1881) |  |
| [1882](#L1882) | } |
| [1883](#L1883) | } |
| [1884](#L1884) |  |
| [1885](#L1885) | } catch ( Exception $e ) { |
| [1886](#L1886) |  |
| [1887](#L1887) | } |
| [1888](#L1888) |  |
| [1889](#L1889) | return $wp\_rules; |
| [1890](#L1890) | } |
| [1891](#L1891) |  |
| [1892](#L1892) | /\*\* |
| [1893](#L1893) | \* Check if new themes or plugins are added in WordPress |
| [1894](#L1894) | \*/ |
| [1895](#L1895) | public function checkPluginsThemesUpdates() { |
| [1896](#L1896) |  |
| [1897](#L1897) | try { |
| [1898](#L1898) | //Check if tere are plugins added to website |
| [1899](#L1899) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_hide\_plugins' ) ) { |
| [1900](#L1900) | $all\_plugins = HMWP\_Classes\_Tools::getAllPlugins(); |
| [1901](#L1901) | $dbplugins   = HMWP\_Classes\_Tools::getOption( 'hmwp\_plugins' ); |
| [1902](#L1902) | foreach ( $all\_plugins as $plugin ) { |
| [1903](#L1903) | if ( function\_exists( 'is\_plugin\_active' ) && is\_plugin\_active( $plugin ) && isset( $dbplugins['from'] ) && ! empty( $dbplugins['from'] ) ) { |
| [1904](#L1904) | if ( ! in\_array( plugin\_dir\_path( $plugin ), $dbplugins['from'] ) ) { |
| [1905](#L1905) | HMWP\_Classes\_Tools::saveOptions( 'changes', true ); |
| [1906](#L1906) | } |
| [1907](#L1907) | } |
| [1908](#L1908) | } |
| [1909](#L1909) | } |
| [1910](#L1910) |  |
| [1911](#L1911) | //Check if there are themes added to website |
| [1912](#L1912) | if ( HMWP\_Classes\_Tools::getOption( 'hmwp\_hide\_themes' ) ) { |
| [1913](#L1913) |  |
| [1914](#L1914) | //Initialize WordPress Filesystem |
| [1915](#L1915) | $wp\_filesystem = HMWP\_Classes\_ObjController::initFilesystem(); |
| [1916](#L1916) |  |
| [1917](#L1917) | $all\_themes = HMWP\_Classes\_Tools::getAllThemes(); |
| [1918](#L1918) | $dbthemes   = HMWP\_Classes\_Tools::getOption( 'hmwp\_themes' ); |
| [1919](#L1919) | foreach ( $all\_themes as $theme => $value ) { |
| [1920](#L1920) | if ( $wp\_filesystem->is\_dir( $value['theme\_root'] ) && isset( $dbthemes['from'] ) && ! empty( $dbthemes['from'] ) ) { |
| [1921](#L1921) | if ( ! in\_array( $theme . '/', $dbthemes['from'] ) ) { |
| [1922](#L1922) | HMWP\_Classes\_Tools::saveOptions( 'changes', true ); |
| [1923](#L1923) | } |
| [1924](#L1924) | } |
| [1925](#L1925) | } |
| [1926](#L1926) | } |
| [1927](#L1927) |  |
| [1928](#L1928) | //If there are changed (new plugins, new themes) |
| [1929](#L1929) | if ( self::getOption( 'changes' ) ) { |
| [1930](#L1930) | //Initialize the compatibility with other plugins |
| [1931](#L1931) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Compatibility' )->install(); |
| [1932](#L1932) | } |
| [1933](#L1933) | } catch ( Exception $e ) { |
| [1934](#L1934) |  |
| [1935](#L1935) | } |
| [1936](#L1936) | } |
| [1937](#L1937) |  |
| [1938](#L1938) | /\*\* |
| [1939](#L1939) | \* Send the login URL to Cloud for this URL |
| [1940](#L1940) | \* |
| [1941](#L1941) | \* @return void |
| [1942](#L1942) | \*/ |
| [1943](#L1943) | public static function sendLoginPathsApi() { |
| [1944](#L1944) |  |
| [1945](#L1945) | if ( HMWP\_Classes\_Tools::getOption( 'api\_token' ) ) { |
| [1946](#L1946) |  |
| [1947](#L1947) | $domain  = ( self::isMultisites() && defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) ? get\_home\_url( BLOG\_ID\_CURRENT\_SITE ) : home\_url(); |
| [1948](#L1948) | $options = array( 'timeout' => 10, 'headers' => array( 'USER-URL' => $domain ) ); |
| [1949](#L1949) |  |
| [1950](#L1950) | $login = array( |
| [1951](#L1951) | 'path'      => HMWP\_Classes\_Tools::getOption( 'hmwp\_login\_url' ), |
| [1952](#L1952) | 'parameter' => HMWP\_Classes\_Tools::getOption( 'hmwp\_disable\_name' ), |
| [1953](#L1953) | 'value'     => HMWP\_Classes\_Tools::getOption( 'hmwp\_disable' ), |
| [1954](#L1954) | ); |
| [1955](#L1955) |  |
| [1956](#L1956) | self::hmwp\_remote\_post( \_HMWP\_API\_SITE\_ . '/api/settings', array( |
| [1957](#L1957) | 'login' => wp\_json\_encode( $login ), |
| [1958](#L1958) | 'url'   => $domain |
| [1959](#L1959) | ), $options ); |
| [1960](#L1960) | } |
| [1961](#L1961) | } |
| [1962](#L1962) |  |
| [1963](#L1963) | /\*\* |
| [1964](#L1964) | \* Call Account API Server |
| [1965](#L1965) | \* |
| [1966](#L1966) | \* @param  string  $email |
| [1967](#L1967) | \* @param  string  $redirect\_to |
| [1968](#L1968) | \* |
| [1969](#L1969) | \* @return array|mixed|void |
| [1970](#L1970) | \*/ |
| [1971](#L1971) | public static function checkAccountApi( $email = null, $redirect\_to = '' ) { |
| [1972](#L1972) |  |
| [1973](#L1973) | $check   = array(); |
| [1974](#L1974) | $monitor = HMWP\_Classes\_Tools::getValue( 'hmwp\_monitor', 0 ); |
| [1975](#L1975) | $domain  = ( self::isMultisites() && defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) ? get\_home\_url( BLOG\_ID\_CURRENT\_SITE ) : home\_url(); |
| [1976](#L1976) |  |
| [1977](#L1977) | if ( isset( $email ) && $email <> '' ) { |
| [1978](#L1978) | $args     = array( |
| [1979](#L1979) | 'email'        => $email, |
| [1980](#L1980) | 'url'          => $domain, |
| [1981](#L1981) | 'howtolessons' => 1, |
| [1982](#L1982) | 'monitor'      => (int) $monitor, |
| [1983](#L1983) | 'source'       => 'hide-my-wp' |
| [1984](#L1984) | ); |
| [1985](#L1985) | $response = HMWP\_Classes\_Tools::hmwp\_remote\_get( \_HMWP\_API\_SITE\_ . '/api/free/token', $args, array( 'timeout' => 10 ) ); |
| [1986](#L1986) | } elseif ( HMWP\_Classes\_Tools::getOption( 'hmwp\_token' ) ) { |
| [1987](#L1987) | $args     = array( |
| [1988](#L1988) | 'token'        => self::getOption( 'hmwp\_token' ), |
| [1989](#L1989) | 'url'          => $domain, |
| [1990](#L1990) | 'howtolessons' => 1, |
| [1991](#L1991) | 'monitor'      => (int) $monitor, |
| [1992](#L1992) | 'source'       => 'hide-my-wp' |
| [1993](#L1993) | ); |
| [1994](#L1994) | $response = HMWP\_Classes\_Tools::hmwp\_remote\_get( \_HMWP\_API\_SITE\_ . '/api/free/token', $args, array( 'timeout' => 10 ) ); |
| [1995](#L1995) | } else { |
| [1996](#L1996) | return $check; |
| [1997](#L1997) | } |
| [1998](#L1998) |  |
| [1999](#L1999) | if ( $response && $response = json\_decode( $response, true ) ) { |
| [2000](#L2000) |  |
| [2001](#L2001) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_token', ( isset( $response['token'] ) ? $response['token'] : 0 ) ); |
| [2002](#L2002) | HMWP\_Classes\_Tools::saveOptions( 'api\_token', ( isset( $response['api\_token'] ) ? $response['api\_token'] : false ) ); |
| [2003](#L2003) | HMWP\_Classes\_Tools::saveOptions( 'error', isset( $response['error'] ) ); |
| [2004](#L2004) |  |
| [2005](#L2005) | if ( ! isset( $response['error'] ) ) { |
| [2006](#L2006) | if ( $redirect\_to <> '' ) { |
| [2007](#L2007) | wp\_redirect( $redirect\_to ); |
| [2008](#L2008) | exit(); |
| [2009](#L2009) | } |
| [2010](#L2010) | } elseif ( isset( $response['message'] ) ) { |
| [2011](#L2011) | HMWP\_Classes\_Error::setNotification( $response['message'], 'notice', false ); |
| [2012](#L2012) | } |
| [2013](#L2013) | } else { |
| [2014](#L2014) | HMWP\_Classes\_Error::setNotification( sprintf( \_\_( 'CONNECTION ERROR! Make sure your website can access: %s', 'hide-my-wp' ), '<a href="' . \_HMWP\_ACCOUNT\_SITE\_ . '" target="\_blank">' . \_HMWP\_ACCOUNT\_SITE\_ . '</a>' ), 'notice', false ); |
| [2015](#L2015) | } |
| [2016](#L2016) |  |
| [2017](#L2017) | return $response; |
| [2018](#L2018) |  |
| [2019](#L2019) | } |
| [2020](#L2020) |  |
| [2021](#L2021) | /\*\* |
| [2022](#L2022) | \* Verify the API response on update |
| [2023](#L2023) | \* |
| [2024](#L2024) | \* @param  $result |
| [2025](#L2025) | \*/ |
| [2026](#L2026) | public function checkLicenseOnUpdate( $result ) { |
| [2027](#L2027) |  |
| [2028](#L2028) | // check the token |
| [2029](#L2029) | if ( ! self::getOption( 'hmwp\_token' ) ) { |
| [2030](#L2030) | return; |
| [2031](#L2031) | } |
| [2032](#L2032) |  |
| [2033](#L2033) | if ( $body = json\_decode( wp\_remote\_retrieve\_body( $result ) ) ) { |
| [2034](#L2034) |  |
| [2035](#L2035) | //if data received is valid |
| [2036](#L2036) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_valid', 1 ); |
| [2037](#L2037) |  |
| [2038](#L2038) | if ( isset( $body->expires ) && (int) $body->expires > 0 && (int) $body->expires < time() ) { |
| [2039](#L2039) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_valid', 0 ); |
| [2040](#L2040) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_expires', $body->expires ); |
| [2041](#L2041) | } elseif ( isset( $body->download\_url ) && ! $body->download\_url ) { |
| [2042](#L2042) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_valid', 0 ); |
| [2043](#L2043) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_expires', 0 ); |
| [2044](#L2044) | } |
| [2045](#L2045) |  |
| [2046](#L2046) | } else { |
| [2047](#L2047) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_valid', 0 ); |
| [2048](#L2048) | HMWP\_Classes\_Tools::saveOptions( 'hmwp\_expires', 0 ); |
| [2049](#L2049) | } |
| [2050](#L2050) |  |
| [2051](#L2051) | } |
| [2052](#L2052) |  |
| [2053](#L2053) | /\*\* |
| [2054](#L2054) | \* Send the email is case there are major changes |
| [2055](#L2055) | \* |
| [2056](#L2056) | \* @return bool |
| [2057](#L2057) | \*/ |
| [2058](#L2058) | public static function sendEmail() { |
| [2059](#L2059) | $email = self::getOption( 'hmwp\_email\_address' ); |
| [2060](#L2060) | if ( $email == '' ) { |
| [2061](#L2061) | global $current\_user; |
| [2062](#L2062) | $email = $current\_user->user\_email; |
| [2063](#L2063) | } |
| [2064](#L2064) |  |
| [2065](#L2065) | $line    = "\n" . "\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_" . "\n"; |
| [2066](#L2066) | $to      = $email; |
| [2067](#L2067) | $subject = self::getOption( 'hmwp\_plugin\_name' ) . ' - ' . esc\_html\_\_( 'New Login Data', 'hide-my-wp' ); |
| [2068](#L2068) | $message = sprintf( esc\_html\_\_( "Thank you for using %s!", 'hide-my-wp' ), self::getOption( 'hmwp\_plugin\_name' ) ) . "\n"; |
| [2069](#L2069) | $message .= $line; |
| [2070](#L2070) | $message .= esc\_html\_\_( "Your new site URLs are", 'hide-my-wp' ) . ':' . "\n"; |
| [2071](#L2071) | $message .= esc\_html\_\_( "Admin URL", 'hide-my-wp' ) . ': ' . admin\_url() . "\n"; |
| [2072](#L2072) | $message .= esc\_html\_\_( "Login URL", 'hide-my-wp' ) . ': ' . site\_url( self::$options['hmwp\_login\_url'] ) . "\n"; |
| [2073](#L2073) | $message .= $line; |
| [2074](#L2074) | $message .= esc\_html\_\_( "Note: If you can`t login to your site, just access this URL", 'hide-my-wp' ) . ':' . "\n"; |
| [2075](#L2075) | $message .= site\_url() . "/wp-login.php?" . self::getOption( 'hmwp\_disable\_name' ) . "=" . self::$options['hmwp\_disable'] . "\n\n"; |
| [2076](#L2076) | $message .= $line; |
| [2077](#L2077) | $message .= esc\_html\_\_( "Best regards", 'hide-my-wp' ) . ',' . "\n"; |
| [2078](#L2078) | $message .= self::getOption( 'hmwp\_plugin\_name' ) . "\n"; |
| [2079](#L2079) |  |
| [2080](#L2080) | $headers   = array(); |
| [2081](#L2081) | $headers[] = sprintf( esc\_html\_\_( "From: %s <%s>", 'hide-my-wp' ), self::getOption( 'hmwp\_plugin\_name' ), $email ); |
| [2082](#L2082) | $headers[] = 'Content-type: text/plain'; |
| [2083](#L2083) |  |
| [2084](#L2084) | add\_filter( 'wp\_mail\_content\_type', array( 'HMWP\_Classes\_Tools', 'setContentType' ) ); |
| [2085](#L2085) |  |
| [2086](#L2086) | if ( @wp\_mail( $to, $subject, $message, $headers ) ) { |
| [2087](#L2087) | return true; |
| [2088](#L2088) | } |
| [2089](#L2089) |  |
| [2090](#L2090) | return false; |
| [2091](#L2091) | } |
| [2092](#L2092) |  |
| [2093](#L2093) | /\*\* |
| [2094](#L2094) | \* Set the content type to text/plain |
| [2095](#L2095) | \* |
| [2096](#L2096) | \* @return string |
| [2097](#L2097) | \*/ |
| [2098](#L2098) | public static function setContentType() { |
| [2099](#L2099) | return "text/plain"; |
| [2100](#L2100) | } |
| [2101](#L2101) |  |
| [2102](#L2102) | /\*\* |
| [2103](#L2103) | \* Set the current user role for later use |
| [2104](#L2104) | \* |
| [2105](#L2105) | \* @param  WP\_User  $user |
| [2106](#L2106) | \* |
| [2107](#L2107) | \* @return string |
| [2108](#L2108) | \*/ |
| [2109](#L2109) | public static function setCurrentUserRole( $user = null ) { |
| [2110](#L2110) | $roles = array(); |
| [2111](#L2111) |  |
| [2112](#L2112) | if ( isset( $user ) && isset( $user->roles ) && is\_array( $user->roles ) ) { |
| [2113](#L2113) | $roles = $user->roles; |
| [2114](#L2114) | } elseif ( function\_exists( 'wp\_get\_current\_user' ) ) { |
| [2115](#L2115) | $user = wp\_get\_current\_user(); |
| [2116](#L2116) |  |
| [2117](#L2117) | if ( isset( $user->roles ) && is\_array( $user->roles ) ) { |
| [2118](#L2118) | $roles = $user->roles; |
| [2119](#L2119) | } |
| [2120](#L2120) | } |
| [2121](#L2121) |  |
| [2122](#L2122) | if ( ! empty( $roles ) ) { |
| [2123](#L2123) | self::$current\_user\_role = current( $roles ); |
| [2124](#L2124) | } |
| [2125](#L2125) |  |
| [2126](#L2126) | return self::$current\_user\_role; |
| [2127](#L2127) | } |
| [2128](#L2128) |  |
| [2129](#L2129) | /\*\* |
| [2130](#L2130) | \* Get the user main Role or default |
| [2131](#L2131) | \* |
| [2132](#L2132) | \* @return string |
| [2133](#L2133) | \*/ |
| [2134](#L2134) | public static function getUserRole() { |
| [2135](#L2135) | return self::$current\_user\_role; |
| [2136](#L2136) | } |
| [2137](#L2137) |  |
| [2138](#L2138) | /\*\* |
| [2139](#L2139) | \* Check the user capability for the roles attached |
| [2140](#L2140) | \* |
| [2141](#L2141) | \* @param  $cap |
| [2142](#L2142) | \* |
| [2143](#L2143) | \* @return bool |
| [2144](#L2144) | \*/ |
| [2145](#L2145) | public static function userCan( $cap ) { |
| [2146](#L2146) |  |
| [2147](#L2147) | if ( function\_exists( 'current\_user\_can' ) ) { |
| [2148](#L2148) |  |
| [2149](#L2149) | if ( current\_user\_can( $cap ) ) { |
| [2150](#L2150) | return true; |
| [2151](#L2151) | } |
| [2152](#L2152) |  |
| [2153](#L2153) | //Get the current user roles |
| [2154](#L2154) | $user = wp\_get\_current\_user(); |
| [2155](#L2155) |  |
| [2156](#L2156) | //If the user has multiple roles |
| [2157](#L2157) | if ( isset( $user->roles ) && is\_array( $user->roles ) && count( $user->roles ) > 1 ) { |
| [2158](#L2158) | foreach ( $user->roles as $role ) { |
| [2159](#L2159) |  |
| [2160](#L2160) | //Get the role |
| [2161](#L2161) | $role\_object = get\_role( $role ); |
| [2162](#L2162) |  |
| [2163](#L2163) | //Check if it has capability |
| [2164](#L2164) | if ( $role\_object->has\_cap( $cap ) ) { |
| [2165](#L2165) | return true; |
| [2166](#L2166) | } |
| [2167](#L2167) | } |
| [2168](#L2168) | } |
| [2169](#L2169) |  |
| [2170](#L2170) | } |
| [2171](#L2171) |  |
| [2172](#L2172) | return false; |
| [2173](#L2173) | } |
| [2174](#L2174) |  |
| [2175](#L2175) | /\*\* |
| [2176](#L2176) | \* Search for a substring within an array of strings. |
| [2177](#L2177) | \* |
| [2178](#L2178) | \* @param  string  $needle  The substring to search for. |
| [2179](#L2179) | \* @param  array  $haystack  The array of strings to search within. |
| [2180](#L2180) | \* |
| [2181](#L2181) | \* @return bool  True if the substring is found in any of the strings in the array, false otherwise. |
| [2182](#L2182) | \*/ |
| [2183](#L2183) | public static function searchInString( $needle, $haystack ) { |
| [2184](#L2184) | foreach ( $haystack as $value ) { |
| [2185](#L2185) | if ( $needle && $value && $needle <> '' && $value <> '' ) { |
| [2186](#L2186) |  |
| [2187](#L2187) | //add trail slash to make sure the path matches entirely |
| [2188](#L2188) | $needle = trailingslashit( $needle ); |
| [2189](#L2189) | $value  = trailingslashit( $value ); |
| [2190](#L2190) |  |
| [2191](#L2191) | //use mb\_stripos is possible |
| [2192](#L2192) | if ( function\_exists( 'mb\_stripos' ) ) { |
| [2193](#L2193) | if ( mb\_stripos( $needle, $value ) !== false ) { |
| [2194](#L2194) | return true; |
| [2195](#L2195) | } |
| [2196](#L2196) | } elseif ( stripos( $needle, $value ) !== false ) { |
| [2197](#L2197) | return true; |
| [2198](#L2198) | } |
| [2199](#L2199) | } |
| [2200](#L2200) | } |
| [2201](#L2201) |  |
| [2202](#L2202) | return false; |
| [2203](#L2203) | } |
| [2204](#L2204) |  |
| [2205](#L2205) | /\*\* |
| [2206](#L2206) | \* Customize the redirect for the logout process |
| [2207](#L2207) | \* |
| [2208](#L2208) | \* @param  $redirect |
| [2209](#L2209) | \* |
| [2210](#L2210) | \* @return mixed |
| [2211](#L2211) | \*/ |
| [2212](#L2212) | public static function getCustomLogoutURL( $redirect ) { |
| [2213](#L2213) | //Get Logout based on user Role |
| [2214](#L2214) | $role         = HMWP\_Classes\_Tools::getUserRole(); |
| [2215](#L2215) | $urlRedirects = HMWP\_Classes\_Tools::getOption( 'hmwp\_url\_redirects' ); |
| [2216](#L2216) | if ( isset( $urlRedirects[ $role ]['logout'] ) && $urlRedirects[ $role ]['logout'] <> '' ) { |
| [2217](#L2217) | $redirect = $urlRedirects[ $role ]['logout']; |
| [2218](#L2218) | } elseif ( isset( $urlRedirects['default']['logout'] ) && $urlRedirects['default']['logout'] <> '' ) { |
| [2219](#L2219) | $redirect = $urlRedirects['default']['logout']; |
| [2220](#L2220) | } |
| [2221](#L2221) |  |
| [2222](#L2222) | return $redirect; |
| [2223](#L2223) | } |
| [2224](#L2224) |  |
| [2225](#L2225) | /\*\* |
| [2226](#L2226) | \* Customize the redirect for the login process |
| [2227](#L2227) | \* |
| [2228](#L2228) | \* @param  string  $redirect |
| [2229](#L2229) | \* |
| [2230](#L2230) | \* @return string |
| [2231](#L2231) | \*/ |
| [2232](#L2232) | public static function getCustomLoginURL( $redirect ) { |
| [2233](#L2233) |  |
| [2234](#L2234) | //Get Logout based on user Role |
| [2235](#L2235) | $role         = HMWP\_Classes\_Tools::getUserRole(); |
| [2236](#L2236) | $urlRedirects = HMWP\_Classes\_Tools::getOption( 'hmwp\_url\_redirects' ); |
| [2237](#L2237) | if ( isset( $urlRedirects[ $role ]['login'] ) && $urlRedirects[ $role ]['login'] <> '' ) { |
| [2238](#L2238) | $redirect = $urlRedirects[ $role ]['login']; |
| [2239](#L2239) | } elseif ( isset( $urlRedirects['default']['login'] ) && $urlRedirects['default']['login'] <> '' ) { |
| [2240](#L2240) | $redirect = $urlRedirects['default']['login']; |
| [2241](#L2241) | } |
| [2242](#L2242) |  |
| [2243](#L2243) | return $redirect; |
| [2244](#L2244) | } |
| [2245](#L2245) |  |
| [2246](#L2246) | /\*\* |
| [2247](#L2247) | \* Generate a string |
| [2248](#L2248) | \* |
| [2249](#L2249) | \* @param  int  $length |
| [2250](#L2250) | \* |
| [2251](#L2251) | \* @return bool|string |
| [2252](#L2252) | \*/ |
| [2253](#L2253) | public static function generateRandomString( $length = 10 ) { |
| [2254](#L2254) | return substr( str\_shuffle( str\_repeat( $x = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', ceil( $length / strlen( $x ) ) ) ), 1, $length ); |
| [2255](#L2255) | } |
| [2256](#L2256) |  |
| [2257](#L2257) | /\*\* |
| [2258](#L2258) | \* make hidemywp the first plugin that loads |
| [2259](#L2259) | \*/ |
| [2260](#L2260) | public static function movePluginFirst() { |
| [2261](#L2261) | //Make sure the plugin is loaded first |
| [2262](#L2262) | $plugin         = dirname( HMWP\_BASENAME ) . '/index.php'; |
| [2263](#L2263) | $active\_plugins = get\_option( 'active\_plugins' ); |
| [2264](#L2264) |  |
| [2265](#L2265) | if ( ! empty( $active\_plugins ) ) { |
| [2266](#L2266) |  |
| [2267](#L2267) | $this\_plugin\_key = array\_search( $plugin, $active\_plugins ); |
| [2268](#L2268) |  |
| [2269](#L2269) | if ( $this\_plugin\_key > 0 ) { |
| [2270](#L2270) | array\_splice( $active\_plugins, $this\_plugin\_key, 1 ); |
| [2271](#L2271) | array\_unshift( $active\_plugins, $plugin ); |
| [2272](#L2272) | update\_option( 'active\_plugins', $active\_plugins ); |
| [2273](#L2273) |  |
| [2274](#L2274) |  |
| [2275](#L2275) | } |
| [2276](#L2276) |  |
| [2277](#L2277) | } |
| [2278](#L2278) | } |
| [2279](#L2279) |  |
| [2280](#L2280) | /\*\* |
| [2281](#L2281) | \* Instantiates the WordPress filesystem |
| [2282](#L2282) | \* |
| [2283](#L2283) | \* @static |
| [2284](#L2284) | \* @access public |
| [2285](#L2285) | \* @return WP\_Filesystem\_Base|WP\_Filesystem\_Direct |
| [2286](#L2286) | \*/ |
| [2287](#L2287) | public static function initFilesystem() { |
| [2288](#L2288) | return HMWP\_Classes\_ObjController::initFilesystem(); |
| [2289](#L2289) | } |
| [2290](#L2290) |  |
| [2291](#L2291) | public static function isWhitelistedIP( $ip ) { |
| [2292](#L2292) | $wl\_items = array(); |
| [2293](#L2293) |  |
| [2294](#L2294) | if ( ! filter\_var( $ip, FILTER\_VALIDATE\_IP ) ) { |
| [2295](#L2295) | return true; |
| [2296](#L2296) | } |
| [2297](#L2297) |  |
| [2298](#L2298) | //jetpack whitelist |
| [2299](#L2299) | $wl\_jetpack = array( |
| [2300](#L2300) | '122.248.245.244/32', |
| [2301](#L2301) | '54.217.201.243/32', |
| [2302](#L2302) | '54.232.116.4/32', |
| [2303](#L2303) | '185.64.140.0/22', |
| [2304](#L2304) | '76.74.255.0/22', |
| [2305](#L2305) | '192.0.64.0/18', |
| [2306](#L2306) | '192.0.65.0/22', |
| [2307](#L2307) | '192.0.80.0/22', |
| [2308](#L2308) | '192.0.96.0/22', |
| [2309](#L2309) | '192.0.112.0/20', |
| [2310](#L2310) | '192.0.123.0/22', |
| [2311](#L2311) | '195.234.108.0/22', |
| [2312](#L2312) | '54.148.171.133',//wordfence |
| [2313](#L2313) | '35.83.41.128', //wordfence |
| [2314](#L2314) | '52.25.185.95', //wordfence |
| [2315](#L2315) | ); |
| [2316](#L2316) |  |
| [2317](#L2317) | $domain = ( self::isMultisites() && defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) ? get\_home\_url( BLOG\_ID\_CURRENT\_SITE ) : site\_url(); |
| [2318](#L2318) |  |
| [2319](#L2319) | if ( filter\_var( $domain, FILTER\_VALIDATE\_URL ) !== false && strpos( $domain, '.' ) !== false ) { |
| [2320](#L2320) | if ( ! self::isLocalFlywheel() ) { |
| [2321](#L2321) | $wl\_jetpack[] = '127.0.0.1'; |
| [2322](#L2322) | } |
| [2323](#L2323) | } |
| [2324](#L2324) |  |
| [2325](#L2325) | if ( HMWP\_Classes\_Tools::getOption( 'whitelist\_ip' ) ) { |
| [2326](#L2326) | $wl\_items = (array) json\_decode( HMWP\_Classes\_Tools::getOption( 'whitelist\_ip' ), true ); |
| [2327](#L2327) | } |
| [2328](#L2328) |  |
| [2329](#L2329) | //merge all the whitelisted ips and also add the hook for users |
| [2330](#L2330) | $wl\_items = apply\_filters( 'hmwp\_whitelisted\_ips', array\_merge( $wl\_jetpack, $wl\_items ) ); |
| [2331](#L2331) |  |
| [2332](#L2332) | try { |
| [2333](#L2333) | foreach ( $wl\_items as $item ) { |
| [2334](#L2334) | $item = trim( $item ); |
| [2335](#L2335) |  |
| [2336](#L2336) | if ( filter\_var( $item, FILTER\_VALIDATE\_IP ) && $ip == $item ) { |
| [2337](#L2337) | return true; |
| [2338](#L2338) | } |
| [2339](#L2339) |  |
| [2340](#L2340) | if ( strpos( $item, '\*' ) === false && strpos( $item, '/' ) === false ) { //no match, no wildcard |
| [2341](#L2341) | continue; |
| [2342](#L2342) | } |
| [2343](#L2343) |  |
| [2344](#L2344) | if ( strpos( $ip, '.' ) !== false ) { |
| [2345](#L2345) |  |
| [2346](#L2346) | if ( strpos( $item, '/' ) !== false ) { |
| [2347](#L2347) | list( $range, $bits ) = explode( '/', $item, 2 ); |
| [2348](#L2348) |  |
| [2349](#L2349) | if ( 0 == (int) $bits ) { |
| [2350](#L2350) | continue; |
| [2351](#L2351) | } |
| [2352](#L2352) |  |
| [2353](#L2353) | if ( (int) $bits < 0 || (int) $bits > 32 ) { |
| [2354](#L2354) | continue; |
| [2355](#L2355) | } |
| [2356](#L2356) |  |
| [2357](#L2357) | $subnet = ip2long( $range ); |
| [2358](#L2358) | $iplong = ip2long( $ip ); |
| [2359](#L2359) | $mask   = - 1 << ( 32 - $bits ); |
| [2360](#L2360) | $subnet &= $mask; |
| [2361](#L2361) |  |
| [2362](#L2362) | if ( ( $iplong & $mask ) == $subnet ) { |
| [2363](#L2363) | return true; |
| [2364](#L2364) | } |
| [2365](#L2365) | } |
| [2366](#L2366) |  |
| [2367](#L2367) | $iplong  = ip2long( $ip ); |
| [2368](#L2368) | $ip\_low  = ip2long( str\_replace( '\*', '0', $item ) ); |
| [2369](#L2369) | $ip\_high = ip2long( str\_replace( '\*', '255', $item ) ); |
| [2370](#L2370) |  |
| [2371](#L2371) | if ( $iplong >= $ip\_low && $iplong <= $ip\_high ) {//IP is within wildcard range |
| [2372](#L2372) | return true; |
| [2373](#L2373) | } |
| [2374](#L2374) | } |
| [2375](#L2375) |  |
| [2376](#L2376) | } |
| [2377](#L2377) | } catch ( Exception $e ) { |
| [2378](#L2378) | } |
| [2379](#L2379) |  |
| [2380](#L2380) | return false; |
| [2381](#L2381) | } |
| [2382](#L2382) |  |
| [2383](#L2383) | /\*\* |
| [2384](#L2384) | \* Check if there are banned IPs for accessing the hidden paths |
| [2385](#L2385) | \* |
| [2386](#L2386) | \* @return bool |
| [2387](#L2387) | \*/ |
| [2388](#L2388) | public static function isBlacklistedIP( $ip ) { |
| [2389](#L2389) | $bl\_items = array(); |
| [2390](#L2390) |  |
| [2391](#L2391) | $bl\_blacklisted = array( |
| [2392](#L2392) | '35.214.130.0/22', // detector |
| [2393](#L2393) | '54.86.50.0/22', // detector |
| [2394](#L2394) | '172.105.48.0/22', // detector |
| [2395](#L2395) | '15.235.50.223', // detector |
| [2396](#L2396) | '192.185.4.40', // detector |
| [2397](#L2397) | '172.105.48.130', // detector |
| [2398](#L2398) | '167.99.233.123', // detector |
| [2399](#L2399) | ); |
| [2400](#L2400) |  |
| [2401](#L2401) | if ( HMWP\_Classes\_Tools::getOption( 'banlist\_ip' ) ) { |
| [2402](#L2402) | $bl\_items = (array) json\_decode( HMWP\_Classes\_Tools::getOption( 'banlist\_ip' ), true ); |
| [2403](#L2403) | } |
| [2404](#L2404) |  |
| [2405](#L2405) | //merge all the whitelisted ips and also add the hook for users |
| [2406](#L2406) | $bl\_items = apply\_filters( 'hmwp\_banlist\_ips', array\_merge( $bl\_blacklisted, $bl\_items ) ); |
| [2407](#L2407) |  |
| [2408](#L2408) | try { |
| [2409](#L2409) | foreach ( $bl\_items as $item ) { |
| [2410](#L2410) | $item = trim( $item ); |
| [2411](#L2411) |  |
| [2412](#L2412) | if ( filter\_var( $item, FILTER\_VALIDATE\_IP ) && $ip == $item ) { |
| [2413](#L2413) | return true; |
| [2414](#L2414) | } |
| [2415](#L2415) |  |
| [2416](#L2416) | if ( strpos( $item, '\*' ) === false && strpos( $item, '/' ) === false ) { //no match, no wildcard |
| [2417](#L2417) | continue; |
| [2418](#L2418) | } |
| [2419](#L2419) |  |
| [2420](#L2420) | if ( strpos( $ip, '.' ) !== false ) { |
| [2421](#L2421) |  |
| [2422](#L2422) | if ( strpos( $item, '/' ) !== false ) { |
| [2423](#L2423) | list( $range, $bits ) = explode( '/', $item, 2 ); |
| [2424](#L2424) |  |
| [2425](#L2425) | if ( 0 == (int) $bits ) { |
| [2426](#L2426) | continue; |
| [2427](#L2427) | } |
| [2428](#L2428) |  |
| [2429](#L2429) | if ( (int) $bits < 0 || (int) $bits > 32 ) { |
| [2430](#L2430) | continue; |
| [2431](#L2431) | } |
| [2432](#L2432) |  |
| [2433](#L2433) | $subnet = ip2long( $range ); |
| [2434](#L2434) | $iplong = ip2long( $ip ); |
| [2435](#L2435) | $mask   = - 1 << ( 32 - $bits ); |
| [2436](#L2436) | $subnet &= $mask; |
| [2437](#L2437) |  |
| [2438](#L2438) | if ( ( $iplong & $mask ) == $subnet ) { |
| [2439](#L2439) | return true; |
| [2440](#L2440) | } |
| [2441](#L2441) | } |
| [2442](#L2442) |  |
| [2443](#L2443) | $iplong  = ip2long( $ip ); |
| [2444](#L2444) | $ip\_low  = ip2long( str\_replace( '\*', '0', $item ) ); |
| [2445](#L2445) | $ip\_high = ip2long( str\_replace( '\*', '255', $item ) ); |
| [2446](#L2446) |  |
| [2447](#L2447) | if ( $iplong >= $ip\_low && $iplong <= $ip\_high ) {//IP is within wildcard range |
| [2448](#L2448) | return true; |
| [2449](#L2449) | } |
| [2450](#L2450) | } |
| [2451](#L2451) |  |
| [2452](#L2452) | } |
| [2453](#L2453) | } catch ( Exception $e ) { |
| [2454](#L2454) | } |
| [2455](#L2455) |  |
| [2456](#L2456) | return false; |
| [2457](#L2457) | } |
| [2458](#L2458) |  |
| [2459](#L2459) | /\*\* |
| [2460](#L2460) | \* Check if the Advanced Pack is installed by verifying the definition of a constant. |
| [2461](#L2461) | \* |
| [2462](#L2462) | \* @return bool |
| [2463](#L2463) | \*/ |
| [2464](#L2464) | public static function isAdvancedpackInstalled() { |
| [2465](#L2465) | return ( defined( 'HMWPP\_VERSION' ) ); |
| [2466](#L2466) | } |
| [2467](#L2467) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/hide-my-wp/tags/5.3.01/classes/Tools.php?format=txt)
* [Original Format](/export/3222468/hide-my-wp/tags/5.3.01/classes/Tools.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_1a7a0574_20250114_203024.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Hide My WP Ghost – Security & Firewall <= 5.3.01 - Reflected Cross-Site Scripting via URL

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Hide My WP Ghost – Security & Firewall <= 5.3.01 - Reflected Cross-Site Scripting via URL

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-10825](https://www.cve.org/CVERecord?id=CVE-2024-10825) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | November 14, 2024 |
| Last Updated | November 15, 2024 |
| Researcher | [Peter Thaleikis](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/spek) |

### Description

The Hide My WP Ghost – Security & Firewall plugin for WordPress is vulnerable to Reflected Cross-Site Scripting via the URL in all versions up to, and including, 5.3.01 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick an administrative user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/hide-my-wp/tags/5.3.01/classes/Tools.php#L633)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/hide-my-wp/tags/5.3.01/classes/Tools.php#L638)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3186489/hide-my-wp/trunk/classes/Tools.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhide-my-wp%2Fhide-my-wp-ghost-security-firewall-5301-reflected-cross-site-scripting-via-url&t=Hide%20My%20WP%20Ghost%20%E2%80%93%20Security%20%26%20Firewall%20%3C%3D%205.3.01%20-%20Reflected%20Cross-Site%20Scripting%20via%20URL "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhide-my-wp%2Fhide-my-wp-ghost-security-firewall-5301-reflected-cross-site-scripting-via-url&text=Hide%20My%20WP%20Ghost%20%E2%80%93%20Security%20%26%20Firewall%20%3C%3D%205.3.01%20-%20Reflected%20Cross-Site%20Scripting%20via%20URL "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhide-my-wp%2Fhide-my-wp-ghost-security-firewall-5301-reflected-cross-site-scripting-via-url "LinkedIn")
Email

## Vulnerability Details for WP Ghost (Hide My WP Ghost) – Security & Firewall

#### [WP Ghost (Hide My WP Ghost) – Security & Firewall](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/hide-my-wp)

| Software Type | Plugin |
| --- | --- |
| Software Slug | hide-my-wp [(view on wordpress.org)](https://wordpress.org/plugins/hide-my-wp) |
| Patched? | Yes |
| Remediation | Update to version 5.3.02, or a newer patched version |
| Affected Version | * <= 5.3.01 |
| Patched Version | * 5.3.02 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


