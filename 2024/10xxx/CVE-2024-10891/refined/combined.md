=== Content from plugins.trac.wordpress.org_657cfaf3_20250115_092654.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fsave-as-pdf-by-pdfcrowd%2Ftrunk%2Fpublic%2Fclass-save-as-pdf-pdfcrowd-public.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/save-as-pdf-by-pdfcrowd/trunk/public/class-save-as-pdf-pdfcrowd-public.php?rev=3216428 "Revision 3216428")
* Next Revision →
* [Blame](/browser/save-as-pdf-by-pdfcrowd/trunk/public/class-save-as-pdf-pdfcrowd-public.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/save-as-pdf-by-pdfcrowd/trunk/public/class-save-as-pdf-pdfcrowd-public.php)

---

# [source:](/browser?order=name "Go to repository root") [save-as-pdf-by-pdfcrowd](/browser/save-as-pdf-by-pdfcrowd?order=name "View save-as-pdf-by-pdfcrowd")/[trunk](/browser/save-as-pdf-by-pdfcrowd/trunk?order=name "View trunk")/[public](/browser/save-as-pdf-by-pdfcrowd/trunk/public?order=name "View public")/[class-save-as-pdf-pdfcrowd-public.php](/browser/save-as-pdf-by-pdfcrowd/trunk/public/class-save-as-pdf-pdfcrowd-public.php?order=name "View class-save-as-pdf-pdfcrowd-public.php")

View diff against:

View revision:

| [Last change](/changeset/3220042/save-as-pdf-by-pdfcrowd/trunk/public/class-save-as-pdf-pdfcrowd-public.php "View differences") on this file was [3220042](/changeset/3220042/ "View changeset 3220042"), checked in by pdfcrowd, [5 days ago](/timeline?from=2025-01-10T08%3A22%3A46Z&precision=second "See timeline at 01/10/2025 08:22:46 AM") |
| --- |
| version 4.4.1 |
| **File size:** 75.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* The public-facing functionality of the plugin. |
| [5](#L5) | \* |
| [6](#L6) | \* @link       https://pdfcrowd.com/save-as-pdf-wordpress-plugin/ |
| [7](#L7) | \* @since      1.0.0 |
| [8](#L8) | \* |
| [9](#L9) | \* @package    Save\_As\_Pdf\_Pdfcrowd |
| [10](#L10) | \* @subpackage Save\_As\_Pdf\_Pdfcrowd/public |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* The public-facing functionality of the plugin. |
| [15](#L15) | \* |
| [16](#L16) | \* Defines the plugin name, version, and two examples hooks for how to |
| [17](#L17) | \* enqueue the public-facing stylesheet and JavaScript. |
| [18](#L18) | \* |
| [19](#L19) | \* @package    Save\_As\_Pdf\_Pdfcrowd |
| [20](#L20) | \* @subpackage Save\_As\_Pdf\_Pdfcrowd/public |
| [21](#L21) | \* @author     Pdfcrowd <support@pdfcrowd.com> |
| [22](#L22) | \*/ |
| [23](#L23) | class Save\_As\_Pdf\_Pdfcrowd\_Public { |
| [24](#L24) |  |
| [25](#L25) | /\*\* |
| [26](#L26) | \* The ID of this plugin. |
| [27](#L27) | \* |
| [28](#L28) | \* @since    1.0.0 |
| [29](#L29) | \* @access   private |
| [30](#L30) | \* @var      string    $plugin\_name    The ID of this plugin. |
| [31](#L31) | \*/ |
| [32](#L32) | private $plugin\_name; |
| [33](#L33) |  |
| [34](#L34) | /\*\* |
| [35](#L35) | \* The version of this plugin. |
| [36](#L36) | \* |
| [37](#L37) | \* @since    1.0.0 |
| [38](#L38) | \* @access   private |
| [39](#L39) | \* @var      string    $version    The current version of this plugin. |
| [40](#L40) | \*/ |
| [41](#L41) | private $version; |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* The table name for plugin settings. |
| [45](#L45) | \* |
| [46](#L46) | \* @since    1.0.0 |
| [47](#L47) | \* @access   private |
| [48](#L48) | \* @var      string    $table\_name    The table name for plugin settings. |
| [49](#L49) | \*/ |
| [50](#L50) | private $table\_name; |
| [51](#L51) |  |
| [52](#L52) | /\*\* |
| [53](#L53) | \* Initialize the class and set its properties. |
| [54](#L54) | \* |
| [55](#L55) | \* @since    1.0.0 |
| [56](#L56) | \* @param      string    $plugin\_name       The name of the plugin. |
| [57](#L57) | \* @param      string    $version    The version of this plugin. |
| [58](#L58) | \*/ |
| [59](#L59) | public function \_\_construct($plugin\_name, $version, $add\_filters = true) { |
| [60](#L60) | global $wpdb; |
| [61](#L61) |  |
| [62](#L62) | $this->plugin\_name = $plugin\_name; |
| [63](#L63) | $this->version = $version; |
| [64](#L64) | $this->table\_name = $wpdb->prefix . "save-as-pdf-pdfcrowd"; |
| [65](#L65) |  |
| [66](#L66) | if($add\_filters) { |
| [67](#L67) | add\_filter('the\_content', array(&$this, 'show\_button')); |
| [68](#L68) | add\_filter('the\_excerpt', array(&$this, 'show\_button')); |
| [69](#L69) | } |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | /\*\* |
| [73](#L73) | \* Register the stylesheets for the public-facing side of the site. |
| [74](#L74) | \* |
| [75](#L75) | \* @since    1.0.0 |
| [76](#L76) | \*/ |
| [77](#L77) | public function enqueue\_styles() { |
| [78](#L78) | wp\_enqueue\_style($this->plugin\_name, |
| [79](#L79) | plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/save-as-pdf-pdfcrowd-public.css', |
| [80](#L80) | array(), |
| [81](#L81) | $this->version, |
| [82](#L82) | 'all'); |
| [83](#L83) |  |
| [84](#L84) | wp\_enqueue\_style($this->plugin\_name . 'indicators', |
| [85](#L85) | plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/save-as-pdf-pdfcrowd-indicators.css', |
| [86](#L86) | array(), |
| [87](#L87) | $this->version, |
| [88](#L88) | 'all'); |
| [89](#L89) |  |
| [90](#L90) | wp\_enqueue\_style($this->plugin\_name . 'components', |
| [91](#L91) | plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/save-as-pdf-pdfcrowd-components.css', |
| [92](#L92) | array(), |
| [93](#L93) | $this->version, |
| [94](#L94) | 'all'); |
| [95](#L95) | } |
| [96](#L96) |  |
| [97](#L97) | /\*\* |
| [98](#L98) | \* Register the JavaScript for the public-facing side of the site. |
| [99](#L99) | \* |
| [100](#L100) | \* @since    1.0.0 |
| [101](#L101) | \*/ |
| [102](#L102) | public function enqueue\_scripts() { |
| [103](#L103) | wp\_enqueue\_script($this->plugin\_name, |
| [104](#L104) | plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/save-as-pdf-pdfcrowd-public.js', |
| [105](#L105) | array( 'jquery', 'underscore' ), |
| [106](#L106) | $this->version, |
| [107](#L107) | false); |
| [108](#L108) |  |
| [109](#L109) | wp\_enqueue\_script($this->plugin\_name . 'indicators', |
| [110](#L110) | plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/save-as-pdf-pdfcrowd-indicators.js', |
| [111](#L111) | array('jquery'), |
| [112](#L112) | $this->version, |
| [113](#L113) | false); |
| [114](#L114) |  |
| [115](#L115) | $components = $this->plugin\_name . 'components'; |
| [116](#L116) | wp\_enqueue\_script($components, |
| [117](#L117) | plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/save-as-pdf-pdfcrowd-components.js', |
| [118](#L118) | array('jquery'), |
| [119](#L119) | $this->version, |
| [120](#L120) | false); |
| [121](#L121) | $components\_translations = array( |
| [122](#L122) | 'email\_success' => \_\_('Email with PDF has been sent.', |
| [123](#L123) | $this->plugin\_name), |
| [124](#L124) | 'email\_fail' => \_\_('Error occurred.', |
| [125](#L125) | $this->plugin\_name), |
| [126](#L126) | 'email\_prompt' => \_\_('Enter your email:', |
| [127](#L127) | $this->plugin\_name), |
| [128](#L128) | 'ok' => \_\_('Ok', |
| [129](#L129) | $this->plugin\_name), |
| [130](#L130) | 'cancel' => \_\_('Cancel', |
| [131](#L131) | $this->plugin\_name) |
| [132](#L132) | ); |
| [133](#L133) | wp\_localize\_script($components, |
| [134](#L134) | 'save\_as\_pdf\_pdfcrowd\_i18n', |
| [135](#L135) | $components\_translations); |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | public function setup\_shortcodes() { |
| [139](#L139) | add\_shortcode('save\_as\_pdf\_pdfcrowd', |
| [140](#L140) | array($this, 'save\_as\_pdf\_pdfcrowd\_shortcode')); |
| [141](#L141) | add\_shortcode('block\_save\_as\_pdf\_pdfcrowd', |
| [142](#L142) | array($this, 'block\_save\_as\_pdf\_pdfcrowd\_shortcode')); |
| [143](#L143) | add\_action('wp\_ajax\_save\_as\_pdf\_pdfcrowd', array($this, 'save\_as\_pdf\_pdfcrowd')); |
| [144](#L144) | add\_action('wp\_ajax\_nopriv\_save\_as\_pdf\_pdfcrowd', array($this, 'save\_as\_pdf\_pdfcrowd')); |
| [145](#L145) | add\_action('wp\_head', array($this, 'add\_ajaxurl'), 1); |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | function add\_ajaxurl() { ?> |
| [149](#L149) | <script type="text/javascript"> |
| [150](#L150) | //<![CDATA[ |
| [151](#L151) | var ajaxurl = '<?php echo esc\_url( admin\_url( 'admin-ajax.php' )); ?>'; |
| [152](#L152) | //]]> |
| [153](#L153) | </script> |
| [154](#L154) | <?php |
| [155](#L155) | } |
| [156](#L156) |  |
| [157](#L157) | public static $DEFAULTS = array( |
| [158](#L158) | 'api\_key' => '', |
| [159](#L159) | 'auto\_use\_cookies' => '0', |
| [160](#L160) | 'button\_alignment' => 'center', |
| [161](#L161) | 'button\_background\_color' => '#007bff', |
| [162](#L162) | 'button\_border\_color' => '#007bff', |
| [163](#L163) | 'button\_border\_style' => 'solid', |
| [164](#L164) | 'button\_border\_width' => '1', |
| [165](#L165) | 'button\_custom\_html' => '', |
| [166](#L166) | 'button\_custom\_indicator' => '', |
| [167](#L167) | 'button\_disposition' => 'attachment', |
| [168](#L168) | 'button\_format' => 'image-text', |
| [169](#L169) | 'button\_hidden' => '1', |
| [170](#L170) | 'button\_hover' => '1', |
| [171](#L171) | 'button\_html\_hidden' => '0', |
| [172](#L172) | 'button\_id' => '', |
| [173](#L173) | 'button\_image' => 'pdf1.svg', |
| [174](#L174) | 'button\_image\_height' => '24', |
| [175](#L175) | 'button\_image\_url' => '', |
| [176](#L176) | 'button\_image\_width' => '24', |
| [177](#L177) | 'button\_indicator' => 'ellipsis', |
| [178](#L178) | 'button\_indicator\_html' => '<img src="https://storage.googleapis.com/pdfcrowd-cdn/images/spinner.gif" |
| [179](#L179) | style="position: absolute; top: calc(50% - 12px); left: calc(50% - 12px);">', |
| [180](#L180) | 'button\_indicator\_timeout' => '60', |
| [181](#L181) | 'button\_margin\_bottom' => '6', |
| [182](#L182) | 'button\_margin\_left' => '6', |
| [183](#L183) | 'button\_margin\_right' => '6', |
| [184](#L184) | 'button\_margin\_top' => '6', |
| [185](#L185) | 'button\_on\_categories' => '1', |
| [186](#L186) | 'button\_on\_front' => '1', |
| [187](#L187) | 'button\_on\_home' => '1', |
| [188](#L188) | 'button\_on\_pages' => '1', |
| [189](#L189) | 'button\_on\_posts' => '1', |
| [190](#L190) | 'button\_on\_taxonomies' => '1', |
| [191](#L191) | 'button\_padding\_bottom' => '6', |
| [192](#L192) | 'button\_padding\_left' => '6', |
| [193](#L193) | 'button\_padding\_right' => '6', |
| [194](#L194) | 'button\_padding\_top' => '6', |
| [195](#L195) | 'button\_position' => 'below', |
| [196](#L196) | 'button\_radius' => '3', |
| [197](#L197) | 'button\_styling' => 'custom', |
| [198](#L198) | 'button\_text' => 'Save as PDF', |
| [199](#L199) | 'button\_text\_color' => '#ffffff', |
| [200](#L200) | 'button\_text\_size' => '14', |
| [201](#L201) | 'button\_text\_weight' => 'bold', |
| [202](#L202) | 'button\_translation' => '', |
| [203](#L203) | 'button\_translation\_domain' => '', |
| [204](#L204) | 'button\_user\_drawings' => '0', |
| [205](#L205) | 'content\_viewport\_height' => 'large', |
| [206](#L206) | 'conversion\_mode' => 'url', |
| [207](#L207) | 'converter\_user\_agent' => 'chrome-desktop', |
| [208](#L208) | 'converter\_version' => '24.04', |
| [209](#L209) | 'custom\_data' => '', |
| [210](#L210) | 'dev\_mode' => '0', |
| [211](#L211) | 'diagnostics' => '0', |
| [212](#L212) | 'email\_bcc' => '', |
| [213](#L213) | 'email\_cc' => '', |
| [214](#L214) | 'email\_custom\_dialogs' => '', |
| [215](#L215) | 'email\_dialogs' => 'modal', |
| [216](#L216) | 'email\_from' => '', |
| [217](#L217) | 'email\_message' => '<p>Dear {{user\_first\_name}} {{user\_last\_name}},</p> |
| [218](#L218) | <p>Please, find {{title}} attached.</p> |
| [219](#L219) | <p>Best Regards,<br> |
| [220](#L220) | <a href="{{site\_url}}">{{site}}</a></p>', |
| [221](#L221) | 'email\_recipient' => 'user', |
| [222](#L222) | 'email\_recipient\_address' => '', |
| [223](#L223) | 'email\_subject' => '{{site}} - {{title}} PDF', |
| [224](#L224) | 'enable\_cookies\_opt' => '0', |
| [225](#L225) | 'error\_page' => '', |
| [226](#L226) | 'license\_type' => 'demo', |
| [227](#L227) | 'no\_margins' => '0', |
| [228](#L228) | 'output\_format' => 'pdf', |
| [229](#L229) | 'output\_name' => '', |
| [230](#L230) | 'pdf\_created\_callback' => '', |
| [231](#L231) | 'rendering\_mode' => '', |
| [232](#L232) | 'smart\_scaling\_mode' => '', |
| [233](#L233) | 'url\_lookup' => 'auto', |
| [234](#L234) | 'username' => '', |
| [235](#L235) | 'version' => '4410', |
| [236](#L236) | ); |
| [237](#L237) |  |
| [238](#L238) | private static $API\_OPTIONS = array( |
| [239](#L239) | 'page\_size', |
| [240](#L240) | 'page\_width', |
| [241](#L241) | 'page\_height', |
| [242](#L242) | 'orientation', |
| [243](#L243) | 'margin\_top', |
| [244](#L244) | 'margin\_right', |
| [245](#L245) | 'margin\_bottom', |
| [246](#L246) | 'margin\_left', |
| [247](#L247) | 'no\_margins', |
| [248](#L248) | 'print\_page\_range', |
| [249](#L249) | 'content\_viewport\_width', |
| [250](#L250) | 'content\_viewport\_height', |
| [251](#L251) | 'content\_fit\_mode', |
| [252](#L252) | 'remove\_blank\_pages', |
| [253](#L253) | 'header\_url', |
| [254](#L254) | 'header\_html', |
| [255](#L255) | 'header\_height', |
| [256](#L256) | 'footer\_url', |
| [257](#L257) | 'footer\_html', |
| [258](#L258) | 'footer\_height', |
| [259](#L259) | 'no\_header\_footer\_horizontal\_margins', |
| [260](#L260) | 'exclude\_header\_on\_pages', |
| [261](#L261) | 'exclude\_footer\_on\_pages', |
| [262](#L262) | 'header\_footer\_scale\_factor', |
| [263](#L263) | 'page\_numbering\_offset', |
| [264](#L264) | 'page\_watermark', |
| [265](#L265) | 'page\_watermark\_url', |
| [266](#L266) | 'multipage\_watermark', |
| [267](#L267) | 'multipage\_watermark\_url', |
| [268](#L268) | 'page\_background', |
| [269](#L269) | 'page\_background\_url', |
| [270](#L270) | 'multipage\_background', |
| [271](#L271) | 'multipage\_background\_url', |
| [272](#L272) | 'page\_background\_color', |
| [273](#L273) | 'use\_print\_media', |
| [274](#L274) | 'no\_background', |
| [275](#L275) | 'disable\_javascript', |
| [276](#L276) | 'disable\_image\_loading', |
| [277](#L277) | 'disable\_remote\_fonts', |
| [278](#L278) | 'use\_mobile\_user\_agent', |
| [279](#L279) | 'load\_iframes', |
| [280](#L280) | 'block\_ads', |
| [281](#L281) | 'default\_encoding', |
| [282](#L282) | 'locale', |
| [283](#L283) | 'http\_auth\_user\_name', |
| [284](#L284) | 'http\_auth\_password', |
| [285](#L285) | 'cookies', |
| [286](#L286) | 'verify\_ssl\_certificates', |
| [287](#L287) | 'fail\_on\_main\_url\_error', |
| [288](#L288) | 'fail\_on\_any\_url\_error', |
| [289](#L289) | 'no\_xpdfcrowd\_header', |
| [290](#L290) | 'css\_page\_rule\_mode', |
| [291](#L291) | 'custom\_css', |
| [292](#L292) | 'custom\_javascript', |
| [293](#L293) | 'on\_load\_javascript', |
| [294](#L294) | 'custom\_http\_header', |
| [295](#L295) | 'javascript\_delay', |
| [296](#L296) | 'element\_to\_convert', |
| [297](#L297) | 'element\_to\_convert\_mode', |
| [298](#L298) | 'wait\_for\_element', |
| [299](#L299) | 'auto\_detect\_element\_to\_convert', |
| [300](#L300) | 'readability\_enhancements', |
| [301](#L301) | 'viewport\_width', |
| [302](#L302) | 'viewport\_height', |
| [303](#L303) | 'rendering\_mode', |
| [304](#L304) | 'smart\_scaling\_mode', |
| [305](#L305) | 'scale\_factor', |
| [306](#L306) | 'jpeg\_quality', |
| [307](#L307) | 'convert\_images\_to\_jpeg', |
| [308](#L308) | 'image\_dpi', |
| [309](#L309) | 'enable\_pdf\_forms', |
| [310](#L310) | 'linearize', |
| [311](#L311) | 'encrypt', |
| [312](#L312) | 'user\_password', |
| [313](#L313) | 'owner\_password', |
| [314](#L314) | 'no\_print', |
| [315](#L315) | 'no\_modify', |
| [316](#L316) | 'no\_copy', |
| [317](#L317) | 'title', |
| [318](#L318) | 'subject', |
| [319](#L319) | 'author', |
| [320](#L320) | 'keywords', |
| [321](#L321) | 'extract\_meta\_tags', |
| [322](#L322) | 'page\_layout', |
| [323](#L323) | 'page\_mode', |
| [324](#L324) | 'initial\_zoom\_type', |
| [325](#L325) | 'initial\_page', |
| [326](#L326) | 'initial\_zoom', |
| [327](#L327) | 'hide\_toolbar', |
| [328](#L328) | 'hide\_menubar', |
| [329](#L329) | 'hide\_window\_ui', |
| [330](#L330) | 'fit\_window', |
| [331](#L331) | 'center\_window', |
| [332](#L332) | 'display\_title', |
| [333](#L333) | 'right\_to\_left', |
| [334](#L334) | 'data\_string', |
| [335](#L335) | 'data\_file', |
| [336](#L336) | 'data\_format', |
| [337](#L337) | 'data\_encoding', |
| [338](#L338) | 'data\_ignore\_undefined', |
| [339](#L339) | 'data\_auto\_escape', |
| [340](#L340) | 'data\_trim\_blocks', |
| [341](#L341) | 'data\_options', |
| [342](#L342) | 'debug\_log', |
| [343](#L343) | 'tag', |
| [344](#L344) | 'http\_proxy', |
| [345](#L345) | 'https\_proxy', |
| [346](#L346) | 'client\_certificate', |
| [347](#L347) | 'client\_certificate\_password', |
| [348](#L348) | 'layout\_dpi', |
| [349](#L349) | 'content\_area\_x', |
| [350](#L350) | 'content\_area\_y', |
| [351](#L351) | 'content\_area\_width', |
| [352](#L352) | 'content\_area\_height', |
| [353](#L353) | 'contents\_matrix', |
| [354](#L354) | 'header\_matrix', |
| [355](#L355) | 'footer\_matrix', |
| [356](#L356) | 'disable\_page\_height\_optimization', |
| [357](#L357) | 'main\_document\_css\_annotation', |
| [358](#L358) | 'header\_footer\_css\_annotation', |
| [359](#L359) | 'max\_loading\_time', |
| [360](#L360) | 'conversion\_config', |
| [361](#L361) | 'conversion\_config\_file', |
| [362](#L362) | 'subprocess\_referrer', |
| [363](#L363) | 'converter\_user\_agent', |
| [364](#L364) | 'url', |
| [365](#L365) | 'text', |
| [366](#L366) | 'file' |
| [367](#L367) | ); |
| [368](#L368) |  |
| [369](#L369) | private static $IGNORED\_OPTIONS = array( |
| [370](#L370) | '24.04' => array( |
| [371](#L371) | ), |
| [372](#L372) | '20.10' => array( |
| [373](#L373) | 'content\_viewport\_width', |
| [374](#L374) | 'content\_viewport\_height', |
| [375](#L375) | 'content\_fit\_mode', |
| [376](#L376) | ), |
| [377](#L377) | '18.10' => array( |
| [378](#L378) | 'content\_viewport\_width', |
| [379](#L379) | 'content\_viewport\_height', |
| [380](#L380) | 'content\_fit\_mode', |
| [381](#L381) | 'remove\_blank\_pages', |
| [382](#L382) | 'no\_header\_footer\_horizontal\_margins', |
| [383](#L383) | 'use\_mobile\_user\_agent', |
| [384](#L384) | 'load\_iframes', |
| [385](#L385) | 'locale', |
| [386](#L386) | 'css\_page\_rule\_mode', |
| [387](#L387) | 'custom\_css', |
| [388](#L388) | 'auto\_detect\_element\_to\_convert', |
| [389](#L389) | 'readability\_enhancements', |
| [390](#L390) | 'layout\_dpi', |
| [391](#L391) | 'contents\_matrix', |
| [392](#L392) | 'header\_matrix', |
| [393](#L393) | 'footer\_matrix', |
| [394](#L394) | 'disable\_page\_height\_optimization', |
| [395](#L395) | 'main\_document\_css\_annotation', |
| [396](#L396) | 'header\_footer\_css\_annotation', |
| [397](#L397) | 'max\_loading\_time', |
| [398](#L398) | 'subprocess\_referrer', |
| [399](#L399) | ), |
| [400](#L400) | 'latest' => array( |
| [401](#L401) | 'content\_viewport\_width', |
| [402](#L402) | 'content\_viewport\_height', |
| [403](#L403) | 'content\_fit\_mode', |
| [404](#L404) | ), |
| [405](#L405) | ); |
| [406](#L406) |  |
| [407](#L407) | private static $DEFAULT\_IMAGES = array( |
| [408](#L408) | 'pdf1.svg' => 'data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjMwcHgiIGlkPSJMYXllcl8xIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIzMHB4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48cG9seWxpbmUgY2xpcC1ydWxlPSJldmVub2RkIiBmaWxsPSIjRUE0QzNBIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHBvaW50cz0iMzAsMzAgMCwzMCAwLDAgMzAsMCAzMCwzMCAiLz48cGF0aCBkPSJNMTUuMzcyLDQuMzc3ICBjMC40NTIsMC4yMTMsMC4zNTgsMC40ODksMC4yMTksMS43OTNjLTAuMTQyLDEuMzQ1LTAuNjE4LDMuODAyLTEuNTM1LDYuMjE5Yy0wLjkxOCwyLjQxMy0yLjI4LDQuNzg0LTMuNDY3LDYuNTM5ICBjLTEuMTg2LDEuNzU2LTIuMjAxLDIuODk3LTIuOTc1LDMuNTU2Yy0wLjc3NywwLjY1OS0xLjMxNCwwLjgzNS0xLjY2NSwwLjg5M2MtMC4zNDgsMC4wNTgtMC41MDYsMC0wLjYtMC4xNzcgIGMtMC4wOTQtMC4xNzYtMC4xMjctMC40NjYtMC4wNDYtMC44MmMwLjA3OS0wLjM1LDAuMjY4LTAuNzYsMC44MDQtMS4yODVjMC41NDEtMC41MjcsMS40MjYtMS4xNzIsMi42NjEtMS43NzEgIGMxLjIzNS0wLjYsMi44MTctMS4xNTYsNC4xMTYtMS41MzdjMS4yOTktMC4zNzksMi4zMTEtMC41ODUsMy4xOTctMC43NDZjMC44ODgtMC4xNjIsMS42NDctMC4yNzcsMi4zOTEtMC4zMzcgIGMwLjc0NC0wLjA1NiwxLjQ3NC0wLjA1NiwyLjE4NiwwYzAuNzEyLDAuMDYsMS40MDgsMC4xNzUsMi4wMTEsMC4zMjNjMC42LDAuMTQ2LDEuMTA4LDAuMzIxLDEuNTUxLDAuNjAxICBjMC40NDIsMC4yNzYsMC44MjMsMC42NTcsMS4wMTIsMS4wODNjMC4xOTIsMC40MjMsMC4xOTIsMC44OTMsMC4wMzMsMS4yMjhjLTAuMTU4LDAuMzM3LTAuNDc2LDAuNTQxLTAuODM5LDAuNjYgIGMtMC4zNjQsMC4xMTUtMC43NzUsMC4xNDQtMS4yNjcsMGMtMC40OS0wLjE0OC0xLjA2Mi0wLjQ3LTEuNjYyLTAuODk0Yy0wLjYwMS0wLjQyNS0xLjIzNS0wLjk1Mi0yLjA1Ny0xLjc3MSAgYy0wLjgyNC0wLjgxOS0xLjgzOC0xLjkzLTIuNjkyLTMuMDEzYy0wLjg1NC0xLjA4My0xLjU1My0yLjEzNi0yLjAyOC0zLjAyOWMtMC40NzMtMC44OTMtMC43MjctMS42MjQtMC45MzMtMi4zNTUgIGMtMC4yMDYtMC43MzMtMC4zNjQtMS40NjQtMC40MjctMi4xMjJTMTMuMzI2LDYuMTcsMTMuMzksNS43MDFjMC4wNjMtMC40NjYsMC4xNi0wLjgyLDAuMzE3LTEuMDU1ICBjMC4xNTgtMC4yMywwLjM4MS0wLjM1LDAuNTM5LTAuNDA4czAuMjU0LTAuMDU4LDAuMzQ4LTAuMDczYzAuMDk0LTAuMDE1LDAuMTg4LTAuMDQ0LDAuMzMzLDBjMC4xMzgsMC4wNDIsMC4zMjEsMC4xNTQsMC41MDQsMC4yNjgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0ZGRkZGRiIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2Utd2lkdGg9IjEuNCIvPjwvc3ZnPgo=', |
| [409](#L409) | 'pdf2.svg' => 'data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjMwcHgiIGlkPSJMYXllcl8xIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIzMHB4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48cG9seWxpbmUgY2xpcC1ydWxlPSJldmVub2RkIiBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHBvaW50cz0iMjgsMjggMSwyOCAxLDEgMjgsMSAyOCwyOCAiLz48Zz48cGF0aCBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0zMC4wMTUsMjguNjY3SDBWMGgzMC4wMTVWMjguNjY3IE0yLjg4NCwyNS43ODNoMjQuMjQ0VjIuODg2ICAgSDIuODg0IiBmaWxsPSIjRUE0QzNBIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48cGF0aCBkPSJNMTUuNDAxLDQuNDA4ICAgYzAuNDIxLDAuMTgzLDAuMzI3LDAuNDYsMC4xODgsMS43NjJjLTAuMTQzLDEuMzQ5LTAuNjE4LDMuODA2LTEuNTM1LDYuMjE4Yy0wLjkxOCwyLjQxNS0yLjI4LDQuNzg1LTMuNDY3LDYuNTQyICAgYy0xLjE4NSwxLjc1NS0yLjIwMSwyLjg5Ni0yLjk3NCwzLjU1NGMtMC43NzcsMC42NTgtMS4zMTQsMC44MzMtMS42NjUsMC44OTNjLTAuMzQ4LDAuMDYtMC41MDYsMC0wLjYtMC4xNzUgICBzLTAuMTI3LTAuNDctMC4wNDYtMC44MTljMC4wNzktMC4zNTMsMC4yNjgtMC43NjMsMC44MDQtMS4yODdjMC41NDEtMC41MjcsMS40MjYtMS4xNywyLjY2MS0xLjc3MiAgIGMxLjIzNS0wLjU5OSwyLjgxNi0xLjE1Niw0LjExNS0xLjUzNWMxLjI5OS0wLjM4MSwyLjMxMS0wLjU4NSwzLjE5Ny0wLjc0NWMwLjg4OC0wLjE2MSwxLjY0Ny0wLjI3OCwyLjM5LTAuMzM2ICAgYzAuNzQ1LTAuMDYsMS40NzQtMC4wNiwyLjE4NiwwYzAuNzEyLDAuMDU4LDEuNDA5LDAuMTc1LDIuMDExLDAuMzE5YzAuNjAxLDAuMTQ3LDEuMTA4LDAuMzIzLDEuNTUxLDAuNjAyICAgYzAuNDQyLDAuMjc3LDAuODIzLDAuNjU4LDEuMDEyLDEuMDgyYzAuMTkyLDAuNDI1LDAuMTkyLDAuODkzLDAuMDMzLDEuMjI5Yy0wLjE1OCwwLjMzNi0wLjQ3NiwwLjU0Mi0wLjgzOSwwLjY1NyAgIGMtMC4zNjMsMC4xMTctMC43NzUsMC4xNDYtMS4yNjYsMGMtMC40OTEtMC4xNDYtMS4wNjMtMC40NjctMS42NjMtMC44OTNjLTAuNi0wLjQyMy0xLjIzNC0wLjk0OC0yLjA1Ny0xLjc2OCAgIGMtMC44MjMtMC44Mi0xLjgzNy0xLjkzNC0yLjY5MS0zLjAxNWMtMC44NTQtMS4wODMtMS41NTMtMi4xMzYtMi4wMjgtMy4wMjhjLTAuNDczLTAuODkzLTAuNzI3LTEuNjI0LTAuOTMzLTIuMzU3ICAgYy0wLjIwNi0wLjczMS0wLjM2NC0xLjQ2Mi0wLjQyNy0yLjEyYy0wLjA2My0wLjY2LTAuMDMzLTEuMjQ1LDAuMDMxLTEuNzFjMC4wNjMtMC40NywwLjE2LTAuODIsMC4zMTctMS4wNTQgICBjMC4xNTgtMC4yMzUsMC4zODEtMC4zNTIsMC41MzktMC40MWMwLjE1OC0wLjA2LDAuMjU0LTAuMDYsMC4zNDgtMC4wNzNjMC4wOTQtMC4wMTQsMC4xODgtMC4wNDQsMC4zMzMsMCAgIEMxNS4wNjQsNC4yMDksMTUuMjQ4LDQuMzIxLDE1LjQwMSw0LjQwOHoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0VBNEMzQSIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2Utd2lkdGg9IjEuNTciLz48L2c+PC9zdmc+Cg==', |
| [410](#L410) | 'pdf3.svg' => 'data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjMwcHgiIGlkPSJMYXllcl8xIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIzMHB4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48cG9seWxpbmUgY2xpcC1ydWxlPSJldmVub2RkIiBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHBvaW50cz0iMjgsMjggNywyOCA3LDI1IDEsMjUgMSw3IDcsNyA3LDEgMjIsMSAyOCwxMCAyOCwyOCAiLz48Zz48cGF0aCBkPSJNMjguNTk1LDcuNTYybC01LjQzOC02LjMwOWwtMS4wNzgtMS4yNUg5LjIyOGMtMS43MjcsMC0zLjEyNCwxLjM5Ny0zLjEyNCwzLjEyNHYzLjk3MUg4LjA0bC0wLjAwMS0zLjIxICAgYzAuMDA0LTAuOTcxLDAuNzg0LTEuNzU2LDEuNzUyLTEuNzU2bDEwLjk5NC0wLjAxdjUuMjA4YzAuMDAxLDEuOTM5LDEuNTY3LDMuNTEsMy41MDcsMy41MWgzLjgwN0wyNy45MSwyNS44NiAgIGMtMC4wMDQsMC45NjctMC43ODQsMS43NDctMS43NTIsMS43NTRMOS42NTIsMjcuNjA2Yy0wLjg4MywwLTEuNTk0LTAuODY2LTEuNi0xLjkzNVYyNC40SDYuMTE0djEuODk2ICAgYzAsMS45MDcsMS4yNzcsMy40NTUsMi44NDUsMy40NTVsMTcuNzYzLTAuMDA1YzEuNzI2LDAsMy4xMjQtMS40MDQsMy4xMjQtMy4xMjZWOS4wMTZMMjguNTk1LDcuNTYyIiBmaWxsPSIjNDM0NDQwIi8+PHBhdGggZD0iTTIwLjE0NSwyNS4zNjhIMFY2LjEyOWgyMC4xNDVWMjUuMzY4IE0xLjkzNCwyMy40MzJoMTYuMjc0VjguMDY1SDEuOTM0IiBmaWxsPSIjRUE0QzNBIi8+PHBhdGggZD0iTTEwLjMxNCw5LjA2OSAgIGMwLjMwNSwwLjE0MSwwLjI0MiwwLjMyOCwwLjE0OCwxLjIwMWMtMC4wOTcsMC45MDUtMC40MTQsMi41NTQtMS4wMzIsNC4xNzNjLTAuNjE2LDEuNjIyLTEuNTI5LDMuMjEtMi4zMjUsNC4zOSAgIGMtMC43OTcsMS4xNzgtMS40NzgsMS45NDMtMS45OTgsMi4zODZjLTAuNTE5LDAuNDQxLTAuODgyLDAuNTU5LTEuMTE1LDAuNTk5Yy0wLjIzMywwLjA0LTAuMzM5LDAtMC40MDUtMC4xMTcgICBjLTAuMDYzLTAuMTE4LTAuMDg0LTAuMzE1LTAuMDMxLTAuNTUxYzAuMDUzLTAuMjM0LDAuMTgxLTAuNTEsMC41NDItMC44NjNjMC4zNi0wLjM1NCwwLjk1Ni0wLjc4NSwxLjc4NS0xLjE4OCAgIGMwLjgyOS0wLjQwMiwxLjg5MS0wLjc3NSwyLjc2Mi0xLjAzMXMxLjU1MS0wLjM5MywyLjE0Ni0wLjVjMC41OTUtMC4xMDgsMS4xMDQtMC4xODcsMS42MDQtMC4yMjZjMC41LTAuMDQsMC45ODgtMC4wNCwxLjQ2NywwICAgYzAuNDc4LDAuMDM5LDAuOTQ1LDAuMTE3LDEuMzQ4LDAuMjE2YzAuNDA2LDAuMDk3LDAuNzQ1LDAuMjE3LDEuMDQyLDAuNDAyYzAuMjk5LDAuMTg3LDAuNTUyLDAuNDQxLDAuNjgxLDAuNzI2ICAgYzAuMTI3LDAuMjg2LDAuMTI3LDAuNiwwLjAyMSwwLjgyNWMtMC4xMDUsMC4yMjctMC4zMTgsMC4zNjQtMC41NjMsMC40NDFjLTAuMjQ2LDAuMDgtMC41MjIsMC4wOTktMC44NTEsMCAgIGMtMC4zMy0wLjA5OC0wLjcxMi0wLjMxNC0xLjExNS0wLjU5OWMtMC40MDQtMC4yODQtMC44MjktMC42MzgtMS4zODEtMS4xODdjLTAuNTUzLTAuNTUxLTEuMjMyLTEuMjk4LTEuODA3LTIuMDIzICAgYy0wLjU3My0wLjcyNy0xLjA0MS0xLjQzNC0xLjM1OC0yLjAzM2MtMC4zMTktMC41OTktMC40ODktMS4wOS0wLjYyNy0xLjU4MmMtMC4xMzgtMC40OTEtMC4yNDQtMC45OC0wLjI4Ny0xLjQyMiAgIGMtMC4wNDMtMC40NDMtMC4wMjEtMC44MzcsMC4wMjEtMS4xNDljMC4wNDItMC4zMTUsMC4xMDYtMC41NSwwLjIxMy0wLjcwOGMwLjEwNi0wLjE1NywwLjI1Ni0wLjIzNSwwLjM2Mi0wLjI3NSAgIHMwLjE2OS0wLjA0LDAuMjM0LTAuMDQ5YzAuMDYzLTAuMDA5LDAuMTI2LTAuMDI5LDAuMjIyLDBjMC4wOTQsMC4wMywwLjIxNiwwLjEwNCwwLjM0LDAuMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0VBNEMzQSIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2Utd2lkdGg9IjAuNzUiLz48L2c+PC9zdmc+Cg==', |
| [411](#L411) | 'pdf4.svg' => 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMjciIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJtMTIuNTA5IDAuODR2Ni4yNjU3bDUuNzU0MSAwLjEwNDE0eiIgZmlsbD0iIzY5Njk2OSIgc3Ryb2tlLXdpZHRoPSIwIi8+PGcgdHJhbnNmb3JtPSJtYXRyaXgoMS4wMTE4IDAgMCAxLjAxMDYgLTIuMTYyMSAtMy4yMDI0KSIgZmlsbC1ydWxlPSJldmVub2RkIj48cG9seWxpbmUgcG9pbnRzPSIyMC41IDI5IDMgMjkgMyA0IDE0LjUgNCAxNC41IDEwLjIgMjAuNSAxMC4yIDIwLjUgMjkiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZmlsbD0iI2ZmZiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PHBvbHlsaW5lIHBvaW50cz0iMjAgMTQgMzEgMTQgMzEgMjUgMjAgMjUiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZmlsbD0iI2ZmZiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PGcgaWQ9Imljb24tNzAtZG9jdW1lbnQtZmlsZS1wZGYiIGZpbGw9IiM5MjkyOTIiPjxwYXRoIGlkPSJkb2N1bWVudC1maWxlLXBkZiIgZD0ibTI1IDE5di0yaDR2LTFoLTV2N2gxdi0zaDN2LTF6bS0xMy0xdjVoMXYtM2gxLjk5NTFjMS4xMDczIDAgMi4wMDQ5LTAuODg3NzMgMi4wMDQ5LTIgMC0xLjEwNDYtMC44OTM5LTItMi4wMDQ5LTJoLTIuOTk1MXptMS0xdjJoMi4wMDFjMC41NTE3MSAwIDAuOTk4OTYtMC40NDM4NiAwLjk5ODk2LTEgMC0wLjU1MjI4LTAuNDQyNjYtMS0wLjk5ODk2LTF6bTUtMXY3aDIuOTk1MWMxLjEwNzMgMCAyLjAwNDktMC44ODY1NiAyLjAwNDktMi4wMDU5di0yLjk4ODJjMC0xLjEwNzgtMC44OTM5LTIuMDA1OS0yLjAwNDktMi4wMDU5em0xIDF2NWgyLjAwMWMwLjU1MTcxIDAgMC45OTg5Ni0wLjQ0MzcyIDAuOTk4OTYtMC45OTk4MXYtMy4wMDA0YzAtMC41NTIxOC0wLjQ0MjY2LTAuOTk5ODEtMC45OTg5Ni0wLjk5OTgxeiIgZmlsbD0iI2VhNGMzYSIvPjwvZz48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjkuNjc1IC0uMSkiIGZpbGwtcnVsZT0iZXZlbm9kZCI+PGcgZmlsbD0iIzkyOTI5MiI+PHBhdGggZD0ibS0xMC42NzUgMTAuMXYtM2wtNi03aC0xMC45OTdjLTEuMTA2MSAwLTIuMDAyOCAwLjg5ODM0LTIuMDAyOCAyLjAwNzN2MjIuOTg1YzAgMS4xMDg2IDAuODkwOTIgMi4wMDczIDEuOTk3NCAyLjAwNzNoMTUuMDA1YzEuMTAzMSAwIDEuOTk3NC0wLjg5ODIxIDEuOTk3NC0xLjk5MDh2LTIuMDA5Mmg3Ljk5MzJjMS42NjA2IDAgMy4wMDY4LTEuMzQyMyAzLjAwNjgtMi45OTg4di03LjAwMjRjMC0xLjY1NjItMS4zMzYtMi45OTg4LTMuMDA2OC0yLjk5ODh6bS0xIDEzdjIuMDA2NmMwIDAuNTQ4NDUtMC40NDc3IDAuOTkzNC0wLjk5OTk2IDAuOTkzNGgtMTVjLTAuNTQ1MjUgMC0wLjk5OTk2LTAuNDQ1NjgtMC45OTk5Ni0wLjk5NTQ2di0yMy4wMDljMC0wLjU0MDE5IDAuNDQ1NzQtMC45OTU0NiAwLjk5NTU4LTAuOTk1NDZoMTAuMDA0djQuOTk0MWMwIDEuMTE5NCAwLjg5NDUgMi4wMDU5IDEuOTk3OSAyLjAwNTloNC4wMDIxdjJoLTcuOTkzMmMtMS42NjA2IDAtMy4wMDY4IDEuMzQyMy0zLjAwNjggMi45OTg4djcuMDAyNGMwIDEuNjU2MiAxLjMzNiAyLjk5ODggMy4wMDY4IDIuOTk4OHptLTUtMjEuNXY0LjQ5MTJjMCAwLjU1NzE0IDAuNDUwNjUgMS4wMDg4IDAuOTk2NzQgMS4wMDg4aDMuNzAzMnptLTMuMDA1NCA5LjVjLTEuMTAxNiAwLTEuOTk0NiAwLjkwMDE4LTEuOTk0NiAxLjk5MnY3LjAxNmMwIDEuMTAwMiAwLjkwMjM0IDEuOTkyIDEuOTk0NiAxLjk5MmgxNy4wMTFjMS4xMDE2IDAgMS45OTQ2LTAuOTAwMTggMS45OTQ2LTEuOTkydi03LjAxNmMwLTEuMTAwMi0wLjkwMjM0LTEuOTkyLTEuOTk0Ni0xLjk5MnoiLz48L2c+PC9nPjxwYXRoIGQ9Im0zLjE1OTggNC4xMzY3aDciIGZpbGw9IiM2OTY5NjkiIHN0cm9rZT0iIzY5Njk2OSIgc3Ryb2tlLXdpZHRoPSIxcHgiLz48cGF0aCBkPSJtNC4xNTk4IDcuMTM2N2g2IiBmaWxsPSIjNjk2OTY5IiBzdHJva2U9IiM2OTY5NjkiIHN0cm9rZS13aWR0aD0iMXB4Ii8+PC9zdmc+Cg==', |
| [412](#L412) | 'pdfcrowd.svg' => 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTkuMjI3IiBoZWlnaHQ9IjQzLjI1NiIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03My44MDIgLTM4Ni4wNikiPjxnIHRyYW5zZm9ybT0ibWF0cml4KDEuNzk0OCAwIDAgMS43OTQ4IC0yNjI2LjUgLTIxMi4wNikiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2ZmOTUwMCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0ibTE1MTQuNSAzMzUuODZjMC40NDI2IDAuMDU0IDEuMjM2Ni0wLjI0MzM2IDEuMDAwMiAwLjQ4OTY1djE4LjUxMWMtMC40NDI2LTAuMDU0LTEuMjM2NiAwLjI0MzM3LTEuMDAwMi0wLjQ4OTY1di0xOC41MTF6IiBvcGFjaXR5PSIuOTkiIHN0cm9rZS13aWR0aD0iNC45OTk4Ii8+PHBhdGggZD0ibTE1MDYuMyAzNDQuNTRoMS40NzQ4djEwLjU1NWgtMS40NzQ4di0xMC41NTV6IiBvcGFjaXR5PSIuOTkiIHN0cm9rZS13aWR0aD0iNC41MjUxIi8+PHBhdGggZD0ibTE1MjIuNCAzMzkuNzhjMC4zNzU1IDAuMTIzMSAxLjI5ODYtMC4zMDEzMyAxLjE2OTQgMC4zMjY0M3YxNC44NDNjLTAuMzc1NS0wLjEyMzExLTEuMjk4NiAwLjMwMTMzLTEuMTY5NC0wLjMyNjQzdi0xNC44NDN6IiBvcGFjaXR5PSIuOTkiIHN0cm9rZS13aWR0aD0iNC44MzA2Ii8+PHBhdGggZD0ibTE1MzUuMSAzNTMuMjh2Mi4xNjQ5aC01LjE2NDl2LTIuMTY0OWg1LjE2NDl6IiBvcGFjaXR5PSIuOTkiIHN0cm9rZS13aWR0aD0iMy44MzUxIi8+PC9nPjwvZz48L3N2Zz4K', |
| [413](#L413) | ); |
| [414](#L414) |  |
| [415](#L415) | private static $ERROR\_MESSAGES = array( |
| [416](#L416) | 400 => "The client sent an invalid request.", |
| [417](#L417) | 401 => "Authentication credentials were not provided or the API license is not active.", |
| [418](#L418) | 403 => "The API service is suspended or there are no credits left.", |
| [419](#L419) | 405 => "The method specified in the request is not allowed. The request method must be POST.", |
| [420](#L420) | 413 => "<p>The upload size limit is 300MB.</p> <p>You can zip uploaded HTML to avoid this error.</p>", |
| [421](#L421) | 429 => "<p>The client has sent too many requests within a certain timeframe (rate limiting).</p> <p>Upgrade to a higher Pdfcrowd API plan to avoid this error.</p>", |
| [422](#L422) | 430 => "<p>The client has sent too many concurrent requests at a time.</p> <p>Upgrade to a higher Pdfcrowd API plan to avoid this error.</p>", |
| [423](#L423) | 432 => "<p>The limit for the demo license has been exceeded.</p> <p>Use your personal Pdfcrowd API credentials.</p>", |
| [424](#L424) | 452 => "There is no input specified to be converted.", |
| [425](#L425) | 453 => "Unknown conversion option. See details in the HTTP response body.", |
| [426](#L426) | 454 => "The input is too complex or large. It can not be converted. Try to simplify the input data.", |
| [427](#L427) | 455 => "The conversion can not be completed due to a system error.", |
| [428](#L428) | 456 => "The input file is not specified correctly. Multipart/form-data is required for file upload.", |
| [429](#L429) | 457 => "The type of the input file is unknown. The file has no extension.", |
| [430](#L430) | 458 => "<p>The request was aborted because it took a long time.</p> <p>The typical cause of this error is too many images in an HTML page that take too long to download. Another cause might be a long running JavaScript.</p> <p>Try to simplify your input data or speed up the page load time.</p>", |
| [431](#L431) | 459 => "The uploaded archive can not be processed. It is too large, corrupted or contains symbolic links.", |
| [432](#L432) | 470 => "A conversion option is set to an invalid value.", |
| [433](#L433) | 471 => "The input URL can not be loaded.", |
| [434](#L434) | 472 => "Exceeded the maximum number of subrequests during the conversion.", |
| [435](#L435) | 473 => "The main frame failed with HTTP code >= 400.", |
| [436](#L436) | 474 => "One or more subrequests failed with HTTP code >= 400 or some subrequests are still pending. See details in the debug log.", |
| [437](#L437) | 475 => "The request was aborted because the custom JavaScript took a long time.", |
| [438](#L438) | 476 => "The element specified for printing or waiting for was not found in the input document.", |
| [439](#L439) | 477 => "The input document type is unknown or not supported. For example, the HTML content type should be text/html.", |
| [440](#L440) | 478 => "The URL hostname could not be resolved.", |
| [441](#L441) | 479 => "The URL is invalid.", |
| [442](#L442) | 480 => "The converter could not establish an HTTPS connection because of an invalid SSL certificate.", |
| [443](#L443) | 481 => "<p>There was a problem connecting to Pdfcrowd servers over HTTPS. This could be caused by several reasons, one of them is that your local CA certificate store is out of date or not configured correctly.</p> <p>An alternative is to use the API over HTTP. The HTTP mode can be enabled by the <a href='/api/method-index/#html\_to\_pdf\_set\_use\_http'>setUseHttp</a> method.<p>", |
| [444](#L444) | 482 => "The input template or data is invalid.", |
| [445](#L445) | 483 => "The input is password protected. Provide a valid password.", |
| [446](#L446) | 484 => "The input contains an unsupported feature, typically a font type.", |
| [447](#L447) | 485 => "An error occurred while executing the OnLoad JavaScript. See details in the debug log.", |
| [448](#L448) | 503 => "The 503 status code indicates a temporary network issue. Try the request again.", |
| [449](#L449) | ); |
| [450](#L450) |  |
| [451](#L451) | public static function get\_options() { |
| [452](#L452) | $options = get\_option('save-as-pdf-pdfcrowd', self::$DEFAULTS); |
| [453](#L453) |  |
| [454](#L454) | if(!isset($options['version'])) { |
| [455](#L455) | if(isset($options['dev\_mode']) && $options['dev\_mode']) { |
| [456](#L456) | $options['conversion\_mode'] = 'development'; |
| [457](#L457) | } else { |
| [458](#L458) | $options['conversion\_mode'] = 'auto'; |
| [459](#L459) | } |
| [460](#L460) | $options['version'] = 1000; |
| [461](#L461) | } |
| [462](#L462) |  |
| [463](#L463) | if($options['version'] == 4410) { |
| [464](#L464) | return $options; |
| [465](#L465) | } |
| [466](#L466) |  |
| [467](#L467) | if($options['version'] < 2000) { |
| [468](#L468) | $options['converter\_version'] = '18.10'; |
| [469](#L469) | } |
| [470](#L470) |  |
| [471](#L471) | $options['enable\_cookies\_opt'] = ( |
| [472](#L472) | $options['version'] < 2140 && |
| [473](#L473) | (!empty($options['auto\_use\_cookies']) || |
| [474](#L474) | !empty($options['use\_http']))) ? 1 : 0; |
| [475](#L475) |  |
| [476](#L476) | if($options['version'] < 2110) { |
| [477](#L477) | if(empty($options['username']) || $options['username'] === 'demo') { |
| [478](#L478) | $options['license\_type'] = 'demo'; |
| [479](#L479) | } else { |
| [480](#L480) | $options['license\_type'] = 'regular'; |
| [481](#L481) | } |
| [482](#L482) | } |
| [483](#L483) |  |
| [484](#L484) | if($options['version'] < 2600) { |
| [485](#L485) | $options['url\_lookup'] = 'location'; |
| [486](#L486) | } |
| [487](#L487) |  |
| [488](#L488) | if($options['version'] < 4000) { |
| [489](#L489) | $options['content\_viewport\_width'] = ''; |
| [490](#L490) | $options['content\_window\_height'] = ''; |
| [491](#L491) | $options['content\_fit\_mode'] = ''; |
| [492](#L492) |  |
| [493](#L493) | if($options['converter\_version'] === 'latest') { |
| [494](#L494) | $options['converter\_version'] = '20.10'; |
| [495](#L495) | } |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | $options['version'] = 4410; |
| [499](#L499) | if(!isset($options['button\_indicator\_html'])) { |
| [500](#L500) | $options['button\_indicator\_html'] = '<img src="https://storage.googleapis.com/pdfcrowd-cdn/images/spinner.gif" |
| [501](#L501) | style="position: absolute; top: calc(50% - 12px); left: calc(50% - 12px);">'; |
| [502](#L502) | } |
| [503](#L503) | update\_option('save-as-pdf-pdfcrowd', $options); |
| [504](#L504) |  |
| [505](#L505) | return $options; |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | private static function rect\_to\_style($prefix, $options) { |
| [509](#L509) | $result = ''; |
| [510](#L510) | foreach(array('top', 'right', 'bottom', 'left') as $d) { |
| [511](#L511) | $value = $options["button\_{$prefix}\_{$d}"]; |
| [512](#L512) | if(strlen($value)) { |
| [513](#L513) | $result .= "{$prefix}-{$d}: {$value}px; "; |
| [514](#L514) | } |
| [515](#L515) | } |
| [516](#L516) | return $result; |
| [517](#L517) | } |
| [518](#L518) |  |
| [519](#L519) | public static function get\_button\_text($options) { |
| [520](#L520) | if(!isset($options['button\_translation']) || |
| [521](#L521) | !$options['button\_translation']) { |
| [522](#L522) | return isset($options['button\_text']) ? |
| [523](#L523) | $options['button\_text'] : ''; |
| [524](#L524) | } |
| [525](#L525) | $text = $options['button\_text']; |
| [526](#L526) | if($options['button\_translation'] == 'domain') { |
| [527](#L527) | return translate($text, |
| [528](#L528) | isset($options['button\_translation\_domain']) |
| [529](#L529) | ? $options['button\_translation\_domain'] |
| [530](#L530) | : ''); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | // try to find the translation |
| [534](#L534) | global $l10n; |
| [535](#L535) | $domains = $l10n ? array\_keys( $l10n ) : array(); |
| [536](#L536) | foreach($domains as $domain) { |
| [537](#L537) | $result = translate($text, $domain); |
| [538](#L538) | if($result != $text) { |
| [539](#L539) | return $result; |
| [540](#L540) | } |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | return $text; |
| [544](#L544) | } |
| [545](#L545) |  |
| [546](#L546) | private static function string\_subst($format, $args) { |
| [547](#L547) | $names = preg\_match\_all('/\{\{\s\*(.\*?)\s\*\}\}/', |
| [548](#L548) | $format, |
| [549](#L549) | $matches, PREG\_SET\_ORDER); |
| [550](#L550) | $values = array(); |
| [551](#L551) | foreach($matches as $match) { |
| [552](#L552) | $values[] = $args[$match[1]]; |
| [553](#L553) | } |
| [554](#L554) | $format = preg\_replace('/\{\{(.\*?)\}\}/', '%s', $format); |
| [555](#L555) | return vsprintf($format, $values); |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | private static function get\_email\_config($options) { |
| [559](#L559) | $dialogs = 'SaveAsPDFPdfcrowdComponents.email.system'; |
| [560](#L560) | if(isset($options['email\_dialogs'])) { |
| [561](#L561) | if($options['email\_dialogs'] == 'custom') { |
| [562](#L562) | $dialogs = isset($options['email\_custom\_dialogs']) |
| [563](#L563) | ? $options['email\_custom\_dialogs'] |
| [564](#L564) | : ''; |
| [565](#L565) | } else { |
| [566](#L566) | $dialogs = 'SaveAsPDFPdfcrowdComponents.email.' . $options['email\_dialogs']; |
| [567](#L567) | } |
| [568](#L568) | } |
| [569](#L569) | $recipient = ''; |
| [570](#L570) | if(isset($options['email\_recipient']) && |
| [571](#L571) | $options['email\_recipient'] != 'address') { |
| [572](#L572) | $recipient = is\_user\_logged\_in() |
| [573](#L573) | ? $options['email\_recipient'] |
| [574](#L574) | : 'prompt'; |
| [575](#L575) | } |
| [576](#L576) | return array('dialogs' => $dialogs, 'recipient' => $recipient); |
| [577](#L577) | } |
| [578](#L578) |  |
| [579](#L579) | public static function create\_button\_from\_style( |
| [580](#L580) | $options, $custom\_options='', $content='', $pflags='', $enc\_data='""') { |
| [581](#L581) | $image = ''; |
| [582](#L582) | if(strpos($options['button\_format'], 'image') !== false) { |
| [583](#L583) | if($options['button\_image'] == 'custom\_html') { |
| [584](#L584) | $image = $options['button\_custom\_html']; |
| [585](#L585) | } |
| [586](#L586) | else if($options['button\_image'] != 'custom\_image' || $options['button\_image\_url']) { |
| [587](#L587) | $image\_style = "width: {$options['button\_image\_width']}px; height: {$options['button\_image\_height']}px;"; |
| [588](#L588) | $image\_url = $options['button\_image'] == 'custom\_image' |
| [589](#L589) | ? esc\_attr($options['button\_image\_url']) |
| [590](#L590) | : self::$DEFAULT\_IMAGES[$options['button\_image']]; |
| [591](#L591) | $image\_style = esc\_attr($image\_style); |
| [592](#L592) | $image = "<img style='$image\_style' src=\"$image\_url\"/>"; |
| [593](#L593) | } |
| [594](#L594) | } |
| [595](#L595) |  |
| [596](#L596) | $config = array(); |
| [597](#L597) | $custom\_indicator = false; |
| [598](#L598) | $config['indicator'] = isset($options['button\_indicator']) |
| [599](#L599) | ? $options['button\_indicator'] |
| [600](#L600) | : ''; |
| [601](#L601) | $config['indicator\_timeout'] = !empty($options['button\_indicator\_timeout']) |
| [602](#L602) | ? $options['button\_indicator\_timeout'] |
| [603](#L603) | : '60'; |
| [604](#L604) | if($config['indicator'] == 'custom') { |
| [605](#L605) | $custom\_indicator = true; |
| [606](#L606) | $config['indicator'] = isset($options['button\_custom\_indicator']) |
| [607](#L607) | ? $options['button\_custom\_indicator'] |
| [608](#L608) | : ''; |
| [609](#L609) | } else if($config['indicator']) { |
| [610](#L610) | $config['indicator'] = 'SaveAsPDFPdfcrowdIndicators.' . $config['indicator']; |
| [611](#L611) | } |
| [612](#L612) |  |
| [613](#L613) | $btn\_style = self::rect\_to\_style('margin', $options); |
| [614](#L614) |  |
| [615](#L615) | $classes = 'save-as-pdf-pdfcrowd-button-wrap'; |
| [616](#L616) | $btn\_classes = 'save-as-pdf-pdfcrowd-button'; |
| [617](#L617) | if(isset($options['button\_hidden']) && $options['button\_hidden'] == 1) { |
| [618](#L618) | $classes .= ' pdfcrowd-remove'; |
| [619](#L619) | } |
| [620](#L620) | if($options['button\_styling'] == 'custom') { |
| [621](#L621) | $btn\_style .= self::rect\_to\_style('padding', $options); |
| [622](#L622) | if(strlen($options['button\_text\_size'])) { |
| [623](#L623) | $btn\_style .= "font-size: {$options['button\_text\_size']}px; "; |
| [624](#L624) | } |
| [625](#L625) | if(strlen($options['button\_text\_weight'])) { |
| [626](#L626) | $btn\_style .= "font-weight: {$options['button\_text\_weight']}; "; |
| [627](#L627) | } |
| [628](#L628) | if(strlen($options['button\_text\_color'])) { |
| [629](#L629) | $btn\_style .= "color: {$options['button\_text\_color']}; "; |
| [630](#L630) | } |
| [631](#L631) | if(strlen($options['button\_background\_color'])) { |
| [632](#L632) | $btn\_style .= "background-color: {$options['button\_background\_color']}; "; |
| [633](#L633) | } |
| [634](#L634) | if(strlen($options['button\_border\_color'])) { |
| [635](#L635) | $btn\_style .= "border-color: {$options['button\_border\_color']}; "; |
| [636](#L636) | } |
| [637](#L637) | if(strlen($options['button\_border\_style'])) { |
| [638](#L638) | $btn\_style .= "border-style: {$options['button\_border\_style']}; "; |
| [639](#L639) | } |
| [640](#L640) | if(strlen($options['button\_border\_width'])) { |
| [641](#L641) | $btn\_style .= "border-width: {$options['button\_border\_width']}px; "; |
| [642](#L642) | } |
| [643](#L643) | if(strlen($options['button\_radius'])) { |
| [644](#L644) | $btn\_style .= "border-radius: {$options['button\_radius']}px; "; |
| [645](#L645) | } |
| [646](#L646) | if(isset($options['button\_hover']) && $options['button\_hover'] == 1) { |
| [647](#L647) | $btn\_classes .= $custom\_indicator |
| [648](#L648) | ? ' save-as-pdf-pdfcrowd-has-indicator-func' |
| [649](#L649) | : ' save-as-pdf-pdfcrowd-button-hoverable'; |
| [650](#L650) | } |
| [651](#L651) | $classes .= ' save-as-pdf-pdfcrowd-reset'; |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | $div\_style = ''; |
| [655](#L655) | if(isset($options['button\_html\_hidden']) && |
| [656](#L656) | $options['button\_html\_hidden'] == 1) { |
| [657](#L657) | $div\_style = 'display: none !important;'; |
| [658](#L658) | } |
| [659](#L659) | $button\_tag = 'div'; |
| [660](#L660) | if($options['button\_alignment']) { |
| [661](#L661) | $div\_style .= "text-align: {$options['button\_alignment']}; "; |
| [662](#L662) | } |
| [663](#L663) | if($options['button\_position'] == 'left') { |
| [664](#L664) | $div\_style .= "float: left; "; |
| [665](#L665) | } elseif($options['button\_position'] == 'right') { |
| [666](#L666) | $div\_style .= "float: right; "; |
| [667](#L667) | } elseif($options['button\_position'] == 'inline') { |
| [668](#L668) | $button\_tag = 'span'; |
| [669](#L669) | } |
| [670](#L670) |  |
| [671](#L671) | if(!empty($btn\_style)) { |
| [672](#L672) | $btn\_style = esc\_attr($btn\_style); |
| [673](#L673) | $btn\_style = " style='{$btn\_style}'"; |
| [674](#L674) | } |
| [675](#L675) | if(!empty($div\_style)) { |
| [676](#L676) | $div\_style = esc\_html($div\_style); |
| [677](#L677) | $div\_style = " style='{$div\_style}'"; |
| [678](#L678) | } |
| [679](#L679) |  |
| [680](#L680) | if(isset($options['button\_disposition'])) { |
| [681](#L681) | if($options['button\_disposition'] == 'inline\_new\_tab') { |
| [682](#L682) | $config['target'] = '\_blank'; |
| [683](#L683) | } else if($options['button\_disposition'] == 'email') { |
| [684](#L684) | $config['email'] = self::get\_email\_config($options); |
| [685](#L685) | } |
| [686](#L686) | } |
| [687](#L687) |  |
| [688](#L688) | if(isset($options['button\_user\_drawings']) && |
| [689](#L689) | $options['button\_user\_drawings']) { |
| [690](#L690) | $config['persistent\_canvases'] = '1'; |
| [691](#L691) | } |
| [692](#L692) |  |
| [693](#L693) | $config = json\_encode($config); |
| [694](#L694) |  |
| [695](#L695) | $button\_id = !empty($options['button\_id']) ? |
| [696](#L696) | "id='" . esc\_attr($options['button\_id']) . "'" : ''; |
| [697](#L697) |  |
| [698](#L698) | $button = "<{$button\_tag} class='$classes'{$div\_style}><{$button\_tag} {$button\_id} class='{$btn\_classes}'{$btn\_style} onclick='window.SaveAsPDFPdfcrowd(\"$custom\_options\", $enc\_data, $config, this);' data-pdfcrowd-flags='{$pflags}'>"; |
| [699](#L699) |  |
| [700](#L700) | $button\_content = ''; |
| [701](#L701) | switch($options['button\_format']) { |
| [702](#L702) | case 'image-text': |
| [703](#L703) | $button\_content = $image . '&nbsp;' . |
| [704](#L704) | self::get\_button\_text($options); |
| [705](#L705) | break; |
| [706](#L706) | case 'text-image': |
| [707](#L707) | $button\_content = self::get\_button\_text($options) |
| [708](#L708) | . '&nbsp;' . $image; |
| [709](#L709) | break; |
| [710](#L710) | case 'text': |
| [711](#L711) | $button\_content = self::get\_button\_text($options); |
| [712](#L712) | break; |
| [713](#L713) | case 'image': |
| [714](#L714) | $button\_content = $image; |
| [715](#L715) | break; |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | if(!empty($options['button\_indicator']) && |
| [719](#L719) | $options['button\_indicator'] == 'html' && |
| [720](#L720) | isset($options['button\_indicator\_html'])) { |
| [721](#L721) | $button\_content .= "<{$button\_tag} class='save-as-pdf-pdfcrowd-ind save-as-pdf-pdfcrowd-ind-in' style='display: none !important;'>" . |
| [722](#L722) | $options['button\_indicator\_html'] . "</{$button\_tag}>"; |
| [723](#L723) | } |
| [724](#L724) |  |
| [725](#L725) | $button .= $button\_content . "</{$button\_tag}></{$button\_tag}>"; |
| [726](#L726) |  |
| [727](#L727) | if(!empty($options['\_diag'])) { |
| [728](#L728) | $button = $options['\_diag'] . $button; |
| [729](#L729) | } |
| [730](#L730) |  |
| [731](#L731) | if($options['button\_position'] == 'below') { |
| [732](#L732) | return $content . $button; |
| [733](#L733) | } |
| [734](#L734) | return $button . $content; |
| [735](#L735) | } |
| [736](#L736) |  |
| [737](#L737) | private static function diagnostics\_options($options, $title) { |
| [738](#L738) | if(empty($options)) return ''; |
| [739](#L739) |  |
| [740](#L740) | $data = '<table class="save-as-pdf-pdfcrowd-diag-tab">'; |
| [741](#L741) | foreach($options as $key => $value) { |
| [742](#L742) | $data .= "<tr><th>{$key}</th><td>" . esc\_html($value) . '</td></tr>'; |
| [743](#L743) | } |
| [744](#L744) | $data .= "</table>"; |
| [745](#L745) | return "<h4>{$title}</h4>" . $data; |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | private function get\_diagnostics($options, $custom\_options, $pflags, $mode) { |
| [749](#L749) | if(!isset($options['diagnostics']) || $options['diagnostics'] != 1) { |
| [750](#L750) | return ''; |
| [751](#L751) | } |
| [752](#L752) |  |
| [753](#L753) | $diag = '<div class="save-as-pdf-pdfcrowd-diag"><h3>Pdfcrowd Diagnostics</h3>'; |
| [754](#L754) |  |
| [755](#L755) | if(!empty($custom\_options['api\_key'])) { |
| [756](#L756) | $custom\_options['api\_key'] = '- secret -'; |
| [757](#L757) | } |
| [758](#L758) | $diag .= self::diagnostics\_options( |
| [759](#L759) | $custom\_options, 'Custom options'); |
| [760](#L760) |  |
| [761](#L761) | $d\_config = self::prepare\_conv( |
| [762](#L762) | wp\_parse\_args($custom\_options, $options)); |
| [763](#L763) | $diag .= self::diagnostics\_options( |
| [764](#L764) | $d\_config['fields'], 'API options'); |
| [765](#L765) | $diag .= self::diagnostics\_options( |
| [766](#L766) | $d\_config['files'], 'API files'); |
| [767](#L767) |  |
| [768](#L768) | $created\_by = ''; |
| [769](#L769) | switch($pflags) { |
| [770](#L770) | case 'sc': $created\_by = 'shortcode'; break; |
| [771](#L771) | case 'bsc': $created\_by = 'block shortcode'; break; |
| [772](#L772) | case 'fn': $created\_by = 'function'; break; |
| [773](#L773) | case 'auto': $created\_by = 'show button on'; break; |
| [774](#L774) | } |
| [775](#L775) |  |
| [776](#L776) | global $wp\_version; |
| [777](#L777) | $diag .= self::diagnostics\_options( |
| [778](#L778) | array( |
| [779](#L779) | 'created by' => $created\_by, |
| [780](#L780) | 'conversion mode' => $mode, |
| [781](#L781) | 'url lookup' => $options['url\_lookup'], |
| [782](#L782) | 'url home' => home\_url(), |
| [783](#L783) | 'url args' => add\_query\_arg(NULL, NULL), |
| [784](#L784) | 'url check' => empty($custom\_options['permalink']) || ( |
| [785](#L785) | parse\_url(home\_url(), PHP\_URL\_HOST) == |
| [786](#L786) | parse\_url($custom\_options['permalink'], PHP\_URL\_HOST)), |
| [787](#L787) | 'converter version' => $d\_config['converter\_version'], |
| [788](#L788) | 'plugin version' => $this->version, |
| [789](#L789) | 'wp version' => $wp\_version, |
| [790](#L790) | 'settings version' => $options['version'], |
| [791](#L791) | 'pdfcrowd license' => $options['license\_type'], |
| [792](#L792) | 'pdfcrowd username' => isset($options['username']) |
| [793](#L793) | ? $options['username'] : '', |
| [794](#L794) | 'home page' => is\_home(), |
| [795](#L795) | 'front page' => is\_front\_page(), |
| [796](#L796) | 'page' => is\_page(), |
| [797](#L797) | 'single' => is\_single(), |
| [798](#L798) | 'category' => is\_category(), |
| [799](#L799) | 'taxonomy' => is\_tax(), |
| [800](#L800) | ), 'Extra'); |
| [801](#L801) |  |
| [802](#L802) | return $diag . '</div>'; |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | private function create\_button($options, $custom\_options, $content='', |
| [806](#L806) | $pflags='') { |
| [807](#L807) |  |
| [808](#L808) | $mode = ''; |
| [809](#L809) | if(isset($custom\_options['conversion\_mode'])) { |
| [810](#L810) | $mode = $custom\_options['conversion\_mode']; |
| [811](#L811) | } else if(isset($options['conversion\_mode'])) { |
| [812](#L812) | $mode = $options['conversion\_mode']; |
| [813](#L813) | } |
| [814](#L814) |  |
| [815](#L815) | $options['\_diag'] = $this->get\_diagnostics( |
| [816](#L816) | $options, $custom\_options, $pflags, $mode); |
| [817](#L817) |  |
| [818](#L818) | $enc\_data = '""'; |
| [819](#L819) | if($mode == 'content') { |
| [820](#L820) | // uncommment if you wish to disable page cache |
| [821](#L821) | // for content conversion mode |
| [822](#L822) | // if(!defined('DONOTCACHEPAGE')) { |
| [823](#L823) | //     define('DONOTCACHEPAGE', true); |
| [824](#L824) | // } |
| [825](#L825) |  |
| [826](#L826) | if(!$custom\_options) { |
| [827](#L827) | $custom\_options = array(); |
| [828](#L828) | } |
| [829](#L829) | // add some features to detect valid content |
| [830](#L830) | // token is valid for 2 days |
| [831](#L831) | $custom\_options['\_time'] = time() + 60 \* 60 \* 24 \* 2; |
| [832](#L832) | $custom\_options['\_token'] = rand(); |
| [833](#L833) | $date\_index = (date('z', $custom\_options['\_time']) + 22) % 30; |
| [834](#L834) | $enc\_data = '[' . $custom\_options['\_token'] . ', ' . |
| [835](#L835) | $date\_index . ']'; |
| [836](#L836) | } |
| [837](#L837) |  |
| [838](#L838) | // prepare strings for emails |
| [839](#L839) | if(isset($options['email\_subject']) || |
| [840](#L840) | isset($custom\_options['email\_message'])) { |
| [841](#L841) | if(!$custom\_options) { |
| [842](#L842) | $custom\_options = array(); |
| [843](#L843) | } |
| [844](#L844) | $custom\_options['email\_data'] = json\_encode(array( |
| [845](#L845) | 'title' => get\_the\_title() |
| [846](#L846) | )); |
| [847](#L847) | } |
| [848](#L848) |  |
| [849](#L849) | // serialize custom attributes to string |
| [850](#L850) | if($custom\_options) { |
| [851](#L851) | $custom\_options['pflags'] = $pflags; |
| [852](#L852) | $custom\_options = $this->encrypt( |
| [853](#L853) | json\_encode($custom\_options), $options['api\_key']); |
| [854](#L854) | } else { |
| [855](#L855) | $custom\_options = ''; |
| [856](#L856) | } |
| [857](#L857) |  |
| [858](#L858) | return $this->create\_button\_from\_style( |
| [859](#L859) | $options, |
| [860](#L860) | urlencode($custom\_options), |
| [861](#L861) | $content, $pflags, $enc\_data); |
| [862](#L862) | } |
| [863](#L863) |  |
| [864](#L864) | private function get\_permalink\_with\_params() { |
| [865](#L865) | return isset($\_GET) ? |
| [866](#L866) | add\_query\_arg($\_GET, get\_permalink()) : get\_permalink(); |
| [867](#L867) | } |
| [868](#L868) |  |
| [869](#L869) | function show\_button($content) { |
| [870](#L870) | $options = $this->get\_options(); |
| [871](#L871) |  |
| [872](#L872) | if(!( |
| [873](#L873) | (is\_home() && isset($options['button\_on\_home']) && $options['button\_on\_home']) || |
| [874](#L874) | (is\_front\_page() && isset($options['button\_on\_front']) && $options['button\_on\_front']) || |
| [875](#L875) | (!is\_home() && !is\_front\_page() && is\_page() && isset($options['button\_on\_pages']) && $options['button\_on\_pages']) || |
| [876](#L876) | (is\_single() && isset($options['button\_on\_posts']) && $options['button\_on\_posts']) || |
| [877](#L877) | (is\_category() && isset($options['button\_on\_categories']) && $options['button\_on\_categories']) || |
| [878](#L878) | (is\_tax() && isset($options['button\_on\_taxonomies']) && $options['button\_on\_taxonomies']) |
| [879](#L879) | )) return $content; |
| [880](#L880) |  |
| [881](#L881) | $custom\_options = array( |
| [882](#L882) | 'permalink' => $this->get\_permalink\_with\_params()); |
| [883](#L883) | if(!empty($options['url\_lookup'])) { |
| [884](#L884) | if($options['url\_lookup'] === 'auto') { |
| [885](#L885) | // use permalinks for posts on the post lists |
| [886](#L886) | if(is\_front\_page() && is\_home()) { |
| [887](#L887) | $custom\_options['url\_lookup'] = 'permalink'; |
| [888](#L888) | } |
| [889](#L889) | } |
| [890](#L890) | } |
| [891](#L891) | return $this->create\_button($options, $custom\_options, $content, 'auto'); |
| [892](#L892) | } |
| [893](#L893) |  |
| [894](#L894) | private function eval\_shortcode($attrs, $content, $custom\_options, |
| [895](#L895) | $pflags = '') { |
| [896](#L896) | // merge attrs with the default options defined on the settings page |
| [897](#L897) | $options = $this->get\_options(); |
| [898](#L898) |  |
| [899](#L899) | if($attrs) { |
| [900](#L900) | foreach($attrs as $key => $value) { |
| [901](#L901) | if(is\_string($key)) { |
| [902](#L902) | // accept only string keys |
| [903](#L903) | if(self::starts\_with($key, 'button\_')) { |
| [904](#L904) | if($key == 'button\_disposition') { |
| [905](#L905) | // button disposition is required in |
| [906](#L906) | // coversion too |
| [907](#L907) | $custom\_options[$key] = $value; |
| [908](#L908) | } |
| [909](#L909) | $options[$key] = $value; |
| [910](#L910) | } else { |
| [911](#L911) | if(self::starts\_with($key, 'email\_')) { |
| [912](#L912) | // email settings are used for GUI too |
| [913](#L913) | // so store them in both dicts |
| [914](#L914) | $options[$key] = $value; |
| [915](#L915) | } |
| [916](#L916) | $custom\_options[$key] = $value; |
| [917](#L917) | } |
| [918](#L918) | } |
| [919](#L919) | } |
| [920](#L920) | } |
| [921](#L921) |  |
| [922](#L922) | return $this->create\_button($options, $custom\_options, $content, |
| [923](#L923) | $pflags); |
| [924](#L924) | } |
| [925](#L925) |  |
| [926](#L926) | function save\_as\_pdf\_pdfcrowd\_shortcode($attrs = array(), $content = null) { |
| [927](#L927) | return $this->save\_as\_pdf\_pdfcrowd\_shortcode\_fn($attrs, $content, 'sc'); |
| [928](#L928) | } |
| [929](#L929) |  |
| [930](#L930) | function save\_as\_pdf\_pdfcrowd\_shortcode\_fn($attrs, $content, $pflags) { |
| [931](#L931) | $custom\_options = array(); |
| [932](#L932) | if(!$attrs || !isset($attrs['url'])) { |
| [933](#L933) | // remember permalink for url conversion |
| [934](#L934) | $custom\_options['permalink'] = $this->get\_permalink\_with\_params(); |
| [935](#L935) | } |
| [936](#L936) | return $this->eval\_shortcode($attrs, $content, $custom\_options, $pflags); |
| [937](#L937) | } |
| [938](#L938) |  |
| [939](#L939) | function block\_save\_as\_pdf\_pdfcrowd\_shortcode($attrs = array(), $content = null) { |
| [940](#L940) | // run shortcode parser recursively |
| [941](#L941) | $content = do\_shortcode($content); |
| [942](#L942) |  |
| [943](#L943) | $custom\_options = array('text' => $content); |
| [944](#L944) | if(!$attrs || !isset($attrs['url'])) { |
| [945](#L945) | // add url so default name can be created |
| [946](#L946) | $custom\_options['permalink'] = $this->get\_permalink\_with\_params(); |
| [947](#L947) | } |
| [948](#L948) | return $this->eval\_shortcode($attrs, $content, $custom\_options, 'bsc'); |
| [949](#L949) | } |
| [950](#L950) |  |
| [951](#L951) | private static function get\_url( |
| [952](#L952) | $options, $url, $args, $throw\_error = false, $throw\_on\_400 = false) { |
| [953](#L953) | $response = wp\_remote\_get($url, $args); |
| [954](#L954) | $msg = ''; |
| [955](#L955) | if(is\_wp\_error($response)) { |
| [956](#L956) | $msg = $response->get\_error\_message() . ' ' . $url; |
| [957](#L957) | error\_log("Pdfcrowd: failed to get URL {$url}. " . $msg); |
| [958](#L958) | if($throw\_error) { |
| [959](#L959) | if(empty($options['error\_page'])) { |
| [960](#L960) | $msg = self::prepare\_error\_message( |
| [961](#L961) | 471, |
| [962](#L962) | esc\_html($msg), |
| [963](#L963) | '<b>"URL" or "Content"</b>') . |
| [964](#L964) | '<p>Or check your network and PHP configuration.</p>'; |
| [965](#L965) | } else { |
| [966](#L966) | $msg .= ' Please, check your network.'; |
| [967](#L967) | } |
| [968](#L968) | return new WP\_Error(471, $msg); |
| [969](#L969) | } |
| [970](#L970) | return ''; |
| [971](#L971) | } |
| [972](#L972) |  |
| [973](#L973) | if($throw\_on\_400) { |
| [974](#L974) | $status\_code = wp\_remote\_retrieve\_response\_code($response); |
| [975](#L975) | if($status\_code && $status\_code >= 400) { |
| [976](#L976) | if(empty($options['error\_page'])) { |
| [977](#L977) | $msg = self::prepare\_error\_message(473, 'URL Load Error') . |
| [978](#L978) | "<p>Failed url is <a href='$url'>$url</a> with status $status\_code.</p>" . |
| [979](#L979) | '<h3>Response</h3><div style="background-color: #eee">' . wp\_remote\_retrieve\_body($response) . |
| [980](#L980) | '</div>'; |
| [981](#L981) | } else { |
| [982](#L982) | $msg = "URL Load Error $status\_code: $url"; |
| [983](#L983) | } |
| [984](#L984) | return new WP\_Error(473, $msg); |
| [985](#L985) | } |
| [986](#L986) | } |
| [987](#L987) | return wp\_remote\_retrieve\_body($response); |
| [988](#L988) | } |
| [989](#L989) |  |
| [990](#L990) | private static function embed\_styles($options, $html, $site, $args) { |
| [991](#L991) | $protocol = !empty($\_SERVER['HTTPS']) ? 'https' : 'http'; |
| [992](#L992) |  |
| [993](#L993) | $output = preg\_replace\_callback( |
| [994](#L994) | "`(?i)\<link rel=[\'\"]stylesheet[\'\"](?<pre>.\*?)href=[\'\"](?<url>(?:http:|https:)?\/\/{$site}.\*?)[\'\"](?<post>.\*?)\s\*\/\s\*\>`", |
| [995](#L995) | function ($match) use($options, $args) { |
| [996](#L996) | $url = $match['url']; |
| [997](#L997) | if(!self::starts\_with($url, 'http')) { |
| [998](#L998) | $url = $protocol . ':' . $url; |
| [999](#L999) | } |
| [1000](#L1000) | $content = self::get\_url($options, $url, $args); |
| [1001](#L1001) | if(is\_wp\_error($content)) { |
| [1002](#L1002) | return $content; |
| [1003](#L1003) | } |
| [1004](#L1004) | return '<style ' . $match['pre'] . $match['post'] . ">\r\n" . $content . '</style>'; |
| [1005](#L1005) | }, |
| [1006](#L1006) | $html); |
| [1007](#L1007) | return $output ? $output : $html; |
| [1008](#L1008) | } |
| [1009](#L1009) |  |
| [1010](#L1010) | private static function add\_missing\_protocol($html) { |
| [1011](#L1011) | $protocol = !empty($\_SERVER['HTTPS']) ? 'https' : 'http'; |
| [1012](#L1012) |  |
| [1013](#L1013) | $output = preg\_replace( |
| [1014](#L1014) | "`(?im)(\<(?:a|img|link|iframe|input|body|base|script|embed)\s+[^\>]\*(?:src|href|background)\s\*=\s\*[\'\"])(?:\/\/)`", |
| [1015](#L1015) | '$1' . $protocol . '://', |
| [1016](#L1016) | $html); |
| [1017](#L1017) | return $output ? $output : $html; |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) |  |
| [1021](#L1021) | private function get\_output\_name($options) { |
| [1022](#L1022) | if(isset($options['output\_name']) && |
| [1023](#L1023) | $options['output\_name']) return $options['output\_name']; |
| [1024](#L1024) |  |
| [1025](#L1025) | // create the default file name |
| [1026](#L1026) | $i = -1; |
| [1027](#L1027) | if(isset($options['url'])) { |
| [1028](#L1028) | $page\_name = explode('/', $options['url']); |
| [1029](#L1029) | $i = count($page\_name) - 1; |
| [1030](#L1030) | while($i >= 0) { |
| [1031](#L1031) | $part = explode('#', explode('?', $page\_name[$i])[0])[0]; |
| [1032](#L1032) | if($part != '') { |
| [1033](#L1033) | $page\_name = $part; |
| [1034](#L1034) | break; |
| [1035](#L1035) | } |
| [1036](#L1036) | --$i; |
| [1037](#L1037) | } |
| [1038](#L1038) | } |
| [1039](#L1039) | if($i < 0) { |
| [1040](#L1040) | $page\_name = 'generated'; |
| [1041](#L1041) | } else { |
| [1042](#L1042) | $page\_name = rawurldecode($page\_name); |
| [1043](#L1043) | } |
| [1044](#L1044) | $format = isset($options['output\_format']) ? $options['output\_format'] : 'pdf'; |
| [1045](#L1045) | return $page\_name . ".{$format}"; |
| [1046](#L1046) | } |
| [1047](#L1047) |  |
| [1048](#L1048) | private static function add\_file\_field($name, $file\_name, $data, $boundary, &$body) { |
| [1049](#L1049) | $body .= "--" . $boundary . "\r\n"; |
| [1050](#L1050) | $body .= 'Content-Disposition: form-data; name="' . $name . '";' . ' filename="' . $file\_name . '"' . "\r\n"; |
| [1051](#L1051) | $body .= 'Content-Type: application/octet-stream' . "\r\n"; |
| [1052](#L1052) | $body .= "\r\n"; |
| [1053](#L1053) | $body .= $data . "\r\n"; |
| [1054](#L1054) | } |
| [1055](#L1055) |  |
| [1056](#L1056) | private static function build\_body($fields, $files, $boundary) { |
| [1057](#L1057) | $body = ''; |
| [1058](#L1058) |  |
| [1059](#L1059) | foreach ($fields as $name => $content) { |
| [1060](#L1060) | $body .= "--" . $boundary . "\r\n"; |
| [1061](#L1061) | $body .= 'Content-Disposition: form-data; name="' . $name . '"' . "\r\n\r\n"; |
| [1062](#L1062) | $body .= $content . "\r\n"; |
| [1063](#L1063) | } |
| [1064](#L1064) |  |
| [1065](#L1065) | foreach ($files as $name => $file\_name) { |
| [1066](#L1066) | self::add\_file\_field($name, $file\_name, |
| [1067](#L1067) | file\_get\_contents($file\_name), |
| [1068](#L1068) | $boundary, |
| [1069](#L1069) | $body); |
| [1070](#L1070) | } |
| [1071](#L1071) |  |
| [1072](#L1072) | return $body . "--" . $boundary . "--\r\n"; |
| [1073](#L1073) | } |
| [1074](#L1074) |  |
| [1075](#L1075) | private static function starts\_with($string, $startString) |
| [1076](#L1076) | { |
| [1077](#L1077) | $len = strlen($startString); |
| [1078](#L1078) | return (substr($string, 0, $len) === $startString); |
| [1079](#L1079) | } |
| [1080](#L1080) |  |
| [1081](#L1081) | private static function strip\_https($url) { |
| [1082](#L1082) | $https = array('http://', 'https://'); |
| [1083](#L1083) | foreach($https as $schema) { |
| [1084](#L1084) | if(strpos($url, $schema) === 0) { |
| [1085](#L1085) | return str\_replace($schema, '', $url); |
| [1086](#L1086) | } |
| [1087](#L1087) | } |
| [1088](#L1088) | return $url; |
| [1089](#L1089) | } |
| [1090](#L1090) |  |
| [1091](#L1091) | private static function collect\_cookies() { |
| [1092](#L1092) | $cookies = array(); |
| [1093](#L1093) | foreach($\_COOKIE as $name => $value) { |
| [1094](#L1094) | $cookies[] = new WP\_Http\_Cookie( |
| [1095](#L1095) | array('name' => $name, 'value' => $value)); |
| [1096](#L1096) | } |
| [1097](#L1097) | return $cookies; |
| [1098](#L1098) | } |
| [1099](#L1099) |  |
| [1100](#L1100) | private static function use\_connection\_args($options, &$args) { |
| [1101](#L1101) | $headers = array(); |
| [1102](#L1102) | if(isset($options['http\_auth\_user\_name']) and |
| [1103](#L1103) | $options['http\_auth\_user\_name'] and |
| [1104](#L1104) | isset($options['http\_auth\_password']) and |
| [1105](#L1105) | $options['http\_auth\_password']) { |
| [1106](#L1106) | $headers['Authorization'] = 'Basic ' . base64\_encode( |
| [1107](#L1107) | $options['http\_auth\_user\_name'] . ':' . |
| [1108](#L1108) | $options['http\_auth\_password']); |
| [1109](#L1109) | } |
| [1110](#L1110) |  |
| [1111](#L1111) | if(isset($options['cookies']) and $options['cookies']) { |
| [1112](#L1112) | if(!isset($args['cookies'])) { |
| [1113](#L1113) | $args['cookies'] = array(); |
| [1114](#L1114) | } |
| [1115](#L1115) |  |
| [1116](#L1116) | foreach(explode(';', $options['cookies']) as $cookie) { |
| [1117](#L1117) | $vals = explode('=', $cookie, 2); |
| [1118](#L1118) | if(count($vals) == 2) { |
| [1119](#L1119) | $args['cookies'][$vals[0]] = $vals[1]; |
| [1120](#L1120) | } |
| [1121](#L1121) | } |
| [1122](#L1122) | } |
| [1123](#L1123) |  |
| [1124](#L1124) | if(isset($options['use\_mobile\_user\_agent']) && |
| [1125](#L1125) | $options['use\_mobile\_user\_agent'] == 1) { |
| [1126](#L1126) | $headers['User-Agent'] = 'Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Mobile Safari/537.36'; |
| [1127](#L1127) | } |
| [1128](#L1128) | $args['headers'] = $headers; |
| [1129](#L1129) | } |
| [1130](#L1130) |  |
| [1131](#L1131) | public static function do\_post\_request($options) { |
| [1132](#L1132) | if($options['conversion\_mode'] != 'url' && !isset($options['file'])) { |
| [1133](#L1133) | $html = null; |
| [1134](#L1134) | $args = array('sslverify' => false); |
| [1135](#L1135) | $site = self::strip\_https(get\_site\_url()); |
| [1136](#L1136) |  |
| [1137](#L1137) | if(isset($options['text'])) { |
| [1138](#L1138) | $html = $options['text']; |
| [1139](#L1139) | $args['cookies'] = self::collect\_cookies(); |
| [1140](#L1140) | } else { |
| [1141](#L1141) | if($site) { |
| [1142](#L1142) | $url\_site = self::strip\_https($options['url']); |
| [1143](#L1143) |  |
| [1144](#L1144) | if(self::starts\_with($url\_site, $site)) { |
| [1145](#L1145) | $args['cookies'] = self::collect\_cookies(); |
| [1146](#L1146) | } |
| [1147](#L1147) | } |
| [1148](#L1148) |  |
| [1149](#L1149) | self::use\_connection\_args($options, $args); |
| [1150](#L1150) |  |
| [1151](#L1151) | $html = self::get\_url( |
| [1152](#L1152) | $options, |
| [1153](#L1153) | $options['url'], |
| [1154](#L1154) | $args, |
| [1155](#L1155) | true, |
| [1156](#L1156) | (isset($options['fail\_on\_main\_url\_error']) && |
| [1157](#L1157) | $options['fail\_on\_main\_url\_error'] == 1) || |
| [1158](#L1158) | (isset($options['fail\_on\_any\_url\_error']) && |
| [1159](#L1159) | $options['fail\_on\_any\_url\_error'] == 1)); |
| [1160](#L1160) | if(is\_wp\_error($html)) { |
| [1161](#L1161) | return self::check\_error($options, $html); |
| [1162](#L1162) | } |
| [1163](#L1163) | } |
| [1164](#L1164) |  |
| [1165](#L1165) | // add http:// or https:// to links without it |
| [1166](#L1166) | $html = self::add\_missing\_protocol($html); |
| [1167](#L1167) |  |
| [1168](#L1168) | if($site && $options['conversion\_mode'] == 'development') { |
| [1169](#L1169) | $html = self::embed\_styles($options, $html, $site, $args); |
| [1170](#L1170) | if(is\_wp\_error($html)) { |
| [1171](#L1171) | return self::check\_error($options, $html); |
| [1172](#L1172) | } |
| [1173](#L1173) | } |
| [1174](#L1174) | $options['text'] = $html; |
| [1175](#L1175) | } |
| [1176](#L1176) |  |
| [1177](#L1177) | if(isset($options['auto\_use\_cookies']) && |
| [1178](#L1178) | $options['auto\_use\_cookies'] == 1) { |
| [1179](#L1179) | if(isset($options['cookies']) && $options['cookies']) { |
| [1180](#L1180) | $options['cookies'] .= ';'; |
| [1181](#L1181) | } else { |
| [1182](#L1182) | $options['cookies'] = ''; |
| [1183](#L1183) | } |
| [1184](#L1184) | $cookies = implode(';', array\_map(function($name, $value) { |
| [1185](#L1185) | return $name . '=' . rawurlencode($value); |
| [1186](#L1186) | }, array\_keys($\_COOKIE), array\_values($\_COOKIE))); |
| [1187](#L1187) | $options['cookies'] .= $cookies; |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | return self::convert($options); |
| [1191](#L1191) | } |
| [1192](#L1192) |  |
| [1193](#L1193) | private static function prepare\_conv($options) { |
| [1194](#L1194) | $fields = array(); |
| [1195](#L1195) | $files = array(); |
| [1196](#L1196) |  |
| [1197](#L1197) | $converter\_version = '24.04'; |
| [1198](#L1198) | if(!empty($options['converter\_version'])) { |
| [1199](#L1199) | $converter\_version = $options['converter\_version']; |
| [1200](#L1200) | } |
| [1201](#L1201) |  |
| [1202](#L1202) | $ignored\_options = self::$IGNORED\_OPTIONS[$converter\_version]; |
| [1203](#L1203) |  |
| [1204](#L1204) | // configure the conversion |
| [1205](#L1205) | foreach($options as $key => $value) { |
| [1206](#L1206) | if(!in\_array($key, self::$API\_OPTIONS) || $value == '' || |
| [1207](#L1207) | in\_array($key, $ignored\_options)) { |
| [1208](#L1208) | // ignore empty values, no API options and |
| [1209](#L1209) | // options not supported by a specific converter version |
| [1210](#L1210) | continue; |
| [1211](#L1211) | } |
| [1212](#L1212) |  |
| [1213](#L1213) | if($key == 'url') { |
| [1214](#L1214) | // use url only if text is not set |
| [1215](#L1215) | if(!isset($options['text']) && !isset($options['file'])) { |
| [1216](#L1216) | $fields[$key] = $value; |
| [1217](#L1217) | } |
| [1218](#L1218) | } elseif( |
| [1219](#L1219) | $key == 'page\_watermark' || |
| [1220](#L1220) | $key == 'multipage\_watermark' || |
| [1221](#L1221) | $key == 'page\_background' || |
| [1222](#L1222) | $key == 'multipage\_background' || |
| [1223](#L1223) | $key == 'data\_file' || |
| [1224](#L1224) | $key == 'client\_certificate' || |
| [1225](#L1225) | $key == 'conversion\_config\_file' || |
| [1226](#L1226) | $key == 'file' |
| [1227](#L1227) | ) { |
| [1228](#L1228) | $files[$key] = $value; |
| [1229](#L1229) | } else { |
| [1230](#L1230) | // use only valid Pdfcrowd options |
| [1231](#L1231) | $fields[$key] = $value; |
| [1232](#L1232) | } |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | return array('fields' => $fields, |
| [1236](#L1236) | 'files' => $files, |
| [1237](#L1237) | 'converter\_version' => $converter\_version); |
| [1238](#L1238) | } |
| [1239](#L1239) |  |
| [1240](#L1240) | public static function convert($options) { |
| [1241](#L1241) | $config = self::prepare\_conv($options); |
| [1242](#L1242) |  |
| [1243](#L1243) | $auth = 'Basic ' . base64\_encode( |
| [1244](#L1244) | $options['username'] . ':' . $options['api\_key']); |
| [1245](#L1245) |  |
| [1246](#L1246) | $boundary = wp\_generate\_password(24); |
| [1247](#L1247) |  |
| [1248](#L1248) | $pflags = isset($options['pflags']) ? $options['pflags'] : '-'; |
| [1249](#L1249) |  |
| [1250](#L1250) | global $wp\_version; |
| [1251](#L1251) | $headers = array( |
| [1252](#L1252) | 'Authorization' => $auth, |
| [1253](#L1253) | 'Content-Type' => 'multipart/form-data; boundary=' . $boundary, |
| [1254](#L1254) | 'User-Agent' => 'pdfcrowd\_wordpress\_plugin/4.4.1 (' |
| [1255](#L1255) | . $pflags . '/' . $wp\_version . '/' . phpversion() . ')' |
| [1256](#L1256) | ); |
| [1257](#L1257) |  |
| [1258](#L1258) | $args = array( |
| [1259](#L1259) | 'method' => 'POST', |
| [1260](#L1260) | 'timeout' => 300, |
| [1261](#L1261) | 'headers' => $headers, |
| [1262](#L1262) | 'body' => self::build\_body( |
| [1263](#L1263) | $config['fields'], $config['files'], $boundary) |
| [1264](#L1264) | ); |
| [1265](#L1265) |  |
| [1266](#L1266) | $protocol = (isset($options['use\_http']) && $options['use\_http'] == 1) |
| [1267](#L1267) | ? 'http' : 'https'; |
| [1268](#L1268) |  |
| [1269](#L1269) | $retry\_count = (!empty($options['retry\_count']) && |
| [1270](#L1270) | $options['retry\_count'] > 0) |
| [1271](#L1271) | ? $options['retry\_count'] : 0; |
| [1272](#L1272) | $retry\_attempt = 1; |
| [1273](#L1273) |  |
| [1274](#L1274) | $error = null; |
| [1275](#L1275) | while($retry\_count >= 0) { |
| [1276](#L1276) | $response = wp\_remote\_post( |
| [1277](#L1277) | $protocol . '://api.pdfcrowd.com/convert/' . |
| [1278](#L1278) | $config['converter\_version'] . '/', |
| [1279](#L1279) | $args); |
| [1280](#L1280) | if(is\_wp\_error($response)) { |
| [1281](#L1281) | $error = $response; |
| [1282](#L1282) | if($response->get\_error\_code() != 502 && |
| [1283](#L1283) | $response->get\_error\_code() != 503) { |
| [1284](#L1284) | break; |
| [1285](#L1285) | } |
| [1286](#L1286) | } else { |
| [1287](#L1287) | $code = wp\_remote\_retrieve\_response\_code($response); |
| [1288](#L1288) | if($code == 200) { |
| [1289](#L1289) | // conversion was ok |
| [1290](#L1290) | delete\_option('save\_as\_pdf\_pdfcrowd\_error\_code'); |
| [1291](#L1291) | return wp\_remote\_retrieve\_body($response); |
| [1292](#L1292) | } |
| [1293](#L1293) |  |
| [1294](#L1294) | // wait in case of the concurrency limit for 30 seconds |
| [1295](#L1295) | if($retry\_attempt <= 15 && ($code == 430 || $code == 429)) { |
| [1296](#L1296) | // give time to finish the previous conversion |
| [1297](#L1297) | error\_log("concurrency limit reached, attempt {$retry\_attempt}/15, waiting, a higher Pdfcrowd API plan is recommended"); |
| [1298](#L1298) | sleep(2); |
| [1299](#L1299) | $retry\_attempt++; |
| [1300](#L1300) | continue; |
| [1301](#L1301) | } |
| [1302](#L1302) |  |
| [1303](#L1303) | $msg = wp\_remote\_retrieve\_body($response); |
| [1304](#L1304) | if(empty($options['error\_page'])) { |
| [1305](#L1305) | $msg = self::prepare\_error\_message( |
| [1306](#L1306) | $code, |
| [1307](#L1307) | esc\_html($msg), |
| [1308](#L1308) | '<b>"upload"</b> or <b>"development"</b>'); |
| [1309](#L1309) | if($code == 401 || $code == 403 || $code == 432) { |
| [1310](#L1310) | update\_option('save\_as\_pdf\_pdfcrowd\_error\_code', |
| [1311](#L1311) | "License error {$code}: " . |
| [1312](#L1312) | self::$ERROR\_MESSAGES[$code]); |
| [1313](#L1313) | } |
| [1314](#L1314) | } |
| [1315](#L1315) | $error = new WP\_Error($code, $msg); |
| [1316](#L1316) | if($code != 502 && $code != 503) { |
| [1317](#L1317) | break; |
| [1318](#L1318) | } |
| [1319](#L1319) | } |
| [1320](#L1320) | // only 502 and 503 error is used for retry |
| [1321](#L1321) | $retry\_count--; |
| [1322](#L1322) | }; |
| [1323](#L1323) |  |
| [1324](#L1324) | return self::check\_error($options, $error); |
| [1325](#L1325) | } |
| [1326](#L1326) |  |
| [1327](#L1327) | private static function check\_error($options, $error) { |
| [1328](#L1328) | if(!$error || empty($options['error\_page'])) { |
| [1329](#L1329) | return $error; |
| [1330](#L1330) | } |
| [1331](#L1331) |  |
| [1332](#L1332) | // redirect to error page |
| [1333](#L1333) | $code = $error->get\_error\_code(); |
| [1334](#L1334) | $message = urlencode($error->get\_error\_message()); |
| [1335](#L1335) | $details = ''; |
| [1336](#L1336) | if(isset(self::$ERROR\_MESSAGES[$code])) { |
| [1337](#L1337) | $details = $message; |
| [1338](#L1338) | $message = urlencode(self::$ERROR\_MESSAGES[$code]); |
| [1339](#L1339) | } |
| [1340](#L1340) | $url = $options['error\_page']; |
| [1341](#L1341) | if(!filter\_var($url, FILTER\_VALIDATE\_URL)) { |
| [1342](#L1342) | $url = get\_permalink(get\_page\_by\_path($url)); |
| [1343](#L1343) | } |
| [1344](#L1344) | wp\_redirect($url . |
| [1345](#L1345) | "?error-code={$code}&error-message={$message}&error-details={$details}"); |
| [1346](#L1346) | exit; |
| [1347](#L1347) | } |
| [1348](#L1348) |  |
| [1349](#L1349) | private static function prepare\_error\_message($code, $text, $cmode = null) { |
| [1350](#L1350) | $details = isset(self::$ERROR\_MESSAGES[$code]) ? |
| [1351](#L1351) | '<p>' . self::$ERROR\_MESSAGES[$code] . '</p>' : ''; |
| [1352](#L1352) | $text = $details . '<p>' . $text . '</p>'; |
| [1353](#L1353) | switch($code) { |
| [1354](#L1354) | case 471: |
| [1355](#L1355) | case 478: |
| [1356](#L1356) | $text = $text . '<p>Set <b>"Conversion Mode"</b> to ' . |
| [1357](#L1357) | $cmode . ' on the <b>Mode</b> settings page of the "Save as PDF by Pdfcrowd" plugin.</p>'; |
| [1358](#L1358) | break; |
| [1359](#L1359) | default: |
| [1360](#L1360) | $text = preg\_replace( |
| [1361](#L1361) | '/Details:\s(https:\/\/www.pdfcrowd.com\/[^\s<]\*)/s', |
| [1362](#L1362) | '<br>More: <a href="$1">$1</a>', $text); |
| [1363](#L1363) | } |
| [1364](#L1364) | return $text; |
| [1365](#L1365) | } |
| [1366](#L1366) |  |
| [1367](#L1367) | private static function validate\_data($options, $data) { |
| [1368](#L1368) | if(!isset($options['\_time']) || $options['\_time'] < time()) { |
| [1369](#L1369) | return null; |
| [1370](#L1370) | } |
| [1371](#L1371) |  |
| [1372](#L1372) | $data = base64\_decode($data); |
| [1373](#L1373) | $token = $options['\_token']; |
| [1374](#L1374) | $shift = $token & 15; |
| [1375](#L1375) | $base = $token & ~((1|2|4|8|16) << $shift); |
| [1376](#L1376) | $base = $base ^ 0xffffffff; |
| [1377](#L1377) | $code = (date('z', $options['\_time']) + 22) % 30; |
| [1378](#L1378) |  |
| [1379](#L1379) | $data = unpack('c\*', $data); |
| [1380](#L1380) | $result = ''; |
| [1381](#L1381) | foreach($data as $char) { |
| [1382](#L1382) | $result .= chr($char ^ $code ^ (($base >> ($base&15)) & 0xff)); |
| [1383](#L1383) | } |
| [1384](#L1384) |  |
| [1385](#L1385) | $result = mb\_convert\_encoding($result, 'UTF-8'); |
| [1386](#L1386) | if(!strpos($result, strval($token))) { |
| [1387](#L1387) | return null; |
| [1388](#L1388) | } |
| [1389](#L1389) | return $result; |
| [1390](#L1390) | } |
| [1391](#L1391) |  |
| [1392](#L1392) | private function get\_location($options) { |
| [1393](#L1393) | $location = null; |
| [1394](#L1394) | $permalink = null; |
| [1395](#L1395) |  |
| [1396](#L1396) | if(isset($\_POST['location'])) { |
| [1397](#L1397) | $location = $\_POST['location']; |
| [1398](#L1398) | } |
| [1399](#L1399) | if(isset($options['permalink'])) { |
| [1400](#L1400) | $permalink = $options['permalink']; |
| [1401](#L1401) | } |
| [1402](#L1402) |  |
| [1403](#L1403) | if(!$location) { |
| [1404](#L1404) | return $permalink; |
| [1405](#L1405) | } |
| [1406](#L1406) |  |
| [1407](#L1407) | if(!$permalink) { |
| [1408](#L1408) | return null; |
| [1409](#L1409) | } |
| [1410](#L1410) |  |
| [1411](#L1411) | // check if the location is from my domain |
| [1412](#L1412) | if(parse\_url($location, PHP\_URL\_HOST) != |
| [1413](#L1413) | parse\_url($permalink, PHP\_URL\_HOST)) { |
| [1414](#L1414) | error\_log('Pdfcrowd: conflict in location URL ' . $location . ' vs ' . $permalink); |
| [1415](#L1415) | return $permalink; |
| [1416](#L1416) | } |
| [1417](#L1417) |  |
| [1418](#L1418) | return isset($options['url\_lookup']) && |
| [1419](#L1419) | $options['url\_lookup'] === 'permalink' ? $permalink : $location; |
| [1420](#L1420) | } |
| [1421](#L1421) |  |
| [1422](#L1422) | private static function delete\_file($file\_path) { |
| [1423](#L1423) | global $wp\_filesystem; |
| [1424](#L1424) | if(!$wp\_filesystem->delete($file\_path)) { |
| [1425](#L1425) | error\_log('Pdfcrowd: can not delete file ' . $file\_path); |
| [1426](#L1426) | } |
| [1427](#L1427) | } |
| [1428](#L1428) |  |
| [1429](#L1429) | private static function make\_temporary\_file( |
| [1430](#L1430) | $file\_name, $content, $prefix='') { |
| [1431](#L1431) | global $wp\_filesystem; |
| [1432](#L1432) | if(empty($wp\_filesystem)) { |
| [1433](#L1433) | // init filesystem |
| [1434](#L1434) | WP\_Filesystem(); |
| [1435](#L1435) | } |
| [1436](#L1436) |  |
| [1437](#L1437) | $upload\_dir = wp\_upload\_dir(); |
| [1438](#L1438) | if(empty($upload\_dir['basedir'])) { |
| [1439](#L1439) | error\_log('Pdfcrowd: no upload dir specified'); |
| [1440](#L1440) | return false; |
| [1441](#L1441) | } |
| [1442](#L1442) |  |
| [1443](#L1443) | $tmp\_dir = null; |
| [1444](#L1444) | $tmp\_dir = $upload\_dir['basedir'] . '/\_pdfcrowd\_mail\_tmp'; |
| [1445](#L1445) | if(!$wp\_filesystem->exists($tmp\_dir)) { |
| [1446](#L1446) | // make temporary folder |
| [1447](#L1447) | if(!$wp\_filesystem->mkdir($tmp\_dir)) { |
| [1448](#L1448) | error\_log('Pdfcrowd: can not create folder ' . $tmp\_dir); |
| [1449](#L1449) | } |
| [1450](#L1450) | } |
| [1451](#L1451) |  |
| [1452](#L1452) | // test if file exists and can be created |
| [1453](#L1453) | $file\_path = $tmp\_dir . '/' . $prefix . $file\_name; |
| [1454](#L1454) | $fp = @fopen($file\_path, 'x'); |
| [1455](#L1455) | if(!$fp) { |
| [1456](#L1456) | if($wp\_filesystem->exists($file\_path) && empty($prefix)) { |
| [1457](#L1457) | // file already exists, retry once with random suffix |
| [1458](#L1458) | return self::make\_temporary\_file( |
| [1459](#L1459) | $file\_name, $content, wp\_generate\_password(6, false) . '\_'); |
| [1460](#L1460) | } |
| [1461](#L1461) | error\_log('Pdfcrowd: can not save file ' . $file\_path); |
| [1462](#L1462) | return false; |
| [1463](#L1463) | } |
| [1464](#L1464) | fclose($fp); |
| [1465](#L1465) |  |
| [1466](#L1466) | if(!$wp\_filesystem->put\_contents($file\_path, $content)) { |
| [1467](#L1467) | error\_log('Pdfcrowd: can not write to file ' . $file\_path); |
| [1468](#L1468) | self::delete\_file($file\_path); |
| [1469](#L1469) | return false; |
| [1470](#L1470) | } |
| [1471](#L1471) | return $file\_path; |
| [1472](#L1472) | } |
| [1473](#L1473) |  |
| [1474](#L1474) | private static function send\_json\_error($code, $message, $is\_html=false) { |
| [1475](#L1475) | wp\_send\_json\_error(array('code' => $code, |
| [1476](#L1476) | 'message' => $message, |
| [1477](#L1477) | 'isHtml' => $is\_html)); |
| [1478](#L1478) | } |
| [1479](#L1479) |  |
| [1480](#L1480) | private static function send\_email($options, $file\_name, $output, |
| [1481](#L1481) | $plugin\_name) { |
| [1482](#L1482) | // check empty filename |
| [1483](#L1483) | if(empty($file\_name)) { |
| [1484](#L1484) | $format = isset($options['output\_format']) |
| [1485](#L1485) | ? $options['output\_format'] |
| [1486](#L1486) | : 'pdf'; |
| [1487](#L1487) | $file\_name = 'generated.' . $format; |
| [1488](#L1488) | } |
| [1489](#L1489) |  |
| [1490](#L1490) | $tmp\_file\_name = self::make\_temporary\_file($file\_name, $output); |
| [1491](#L1491) | if(!$tmp\_file\_name) { |
| [1492](#L1492) | return self::send\_json\_error( |
| [1493](#L1493) | 455, \_\_('Output file can not be prepared.', $plugin\_name)); |
| [1494](#L1494) | } |
| [1495](#L1495) |  |
| [1496](#L1496) | $email\_to = $options['email\_to']; |
| [1497](#L1497) | $email\_data = json\_decode($options['email\_data'], true); |
| [1498](#L1498) | $email\_data['user\_name'] = ''; |
| [1499](#L1499) | $email\_data['user\_first\_name'] = ''; |
| [1500](#L1500) | $email\_data['user\_last\_name'] = ''; |
| [1501](#L1501) | $email\_data['user\_display\_name'] = ''; |
| [1502](#L1502) |  |
| [1503](#L1503) | if($options['email\_recipient'] == 'user') { |
| [1504](#L1504) | $curr\_user = wp\_get\_current\_user(); |
| [1505](#L1505) | $email\_data['user\_name'] = $curr\_user->user\_nicename; |
| [1506](#L1506) | $email\_data['user\_first\_name'] = $curr\_user->user\_firstname; |
| [1507](#L1507) | $email\_data['user\_last\_name'] = $curr\_user->user\_lastname; |
| [1508](#L1508) | $email\_data['user\_display\_name'] = $curr\_user->display\_name; |
| [1509](#L1509) | } |
| [1510](#L1510) | $subject = $options['email\_subject']; |
| [1511](#L1511) | $message = $options['email\_message']; |
| [1512](#L1512) |  |
| [1513](#L1513) | $email\_data['site'] = get\_bloginfo('name'); |
| [1514](#L1514) | $email\_data['site\_url'] = get\_bloginfo('url'); |
| [1515](#L1515) | $subject = self::string\_subst($subject, $email\_data); |
| [1516](#L1516) | $message = self::string\_subst($message, $email\_data); |
| [1517](#L1517) |  |
| [1518](#L1518) | $headers = array('Content-Type: text/html; charset=UTF-8'); |
| [1519](#L1519) | if(!empty($options['email\_cc'])) { |
| [1520](#L1520) | $headers[] = 'Cc: ' . $options['email\_cc']; |
| [1521](#L1521) | } |
| [1522](#L1522) | if(!empty($options['email\_bcc'])) { |
| [1523](#L1523) | $headers[] = 'Bcc: ' . $options['email\_bcc']; |
| [1524](#L1524) | } |
| [1525](#L1525) | if(!empty($options['email\_from'])) { |
| [1526](#L1526) | $headers[] = 'From: ' . $options['email\_from']; |
| [1527](#L1527) | } |
| [1528](#L1528) | if(!wp\_mail($email\_to, |
| [1529](#L1529) | $subject, |
| [1530](#L1530) | $message, |
| [1531](#L1531) | $headers, |
| [1532](#L1532) | array($tmp\_file\_name))) { |
| [1533](#L1533) | error\_log('Pdfcrowd: send failed to ' . $email\_to); |
| [1534](#L1534) | self::delete\_file($tmp\_file\_name); |
| [1535](#L1535) | self::send\_json\_error(455, \_\_('Mail system error.', $plugin\_name)); |
| [1536](#L1536) | } else { |
| [1537](#L1537) | self::delete\_file($tmp\_file\_name); |
| [1538](#L1538) | wp\_send\_json\_success(); |
| [1539](#L1539) | } |
| [1540](#L1540) | } |
| [1541](#L1541) |  |
| [1542](#L1542) | private static function get\_email\_recipient($options) { |
| [1543](#L1543) | if($options['email\_recipient'] == 'prompt') { |
| [1544](#L1544) | return $\_POST['recipient']; |
| [1545](#L1545) | } |
| [1546](#L1546) |  |
| [1547](#L1547) | if($options['email\_recipient'] == 'address') { |
| [1548](#L1548) | return $options['email\_recipient\_address']; |
| [1549](#L1549) | } |
| [1550](#L1550) |  |
| [1551](#L1551) | return wp\_get\_current\_user()->user\_email; |
| [1552](#L1552) | } |
| [1553](#L1553) |  |
| [1554](#L1554) | private static function create\_referrer($url) { |
| [1555](#L1555) | $referrer = preg\_replace( |
| [1556](#L1556) | ['/^(https?:\/\/)[^@]+@/i', '/#.\*$/'], |
| [1557](#L1557) | ['$1', ''], |
| [1558](#L1558) | $url |
| [1559](#L1559) | ); |
| [1560](#L1560) | return $referrer; |
| [1561](#L1561) | } |
| [1562](#L1562) |  |
| [1563](#L1563) | function save\_as\_pdf\_pdfcrowd() { |
| [1564](#L1564) | // set download cookie at first, so the conversion button |
| [1565](#L1565) | // can be re-enabled |
| [1566](#L1566) | if(isset($\_POST['download-id'])) { |
| [1567](#L1567) | setcookie('pdfcrowdDownloadId', $\_POST['download-id'], 0, "/"); |
| [1568](#L1568) | } |
| [1569](#L1569) |  |
| [1570](#L1570) | $options = $this->get\_options(); |
| [1571](#L1571) |  |
| [1572](#L1572) | if(!empty($\_POST['options'])) { |
| [1573](#L1573) | $decrypted = $this->decrypt(urldecode($\_POST['options']), |
| [1574](#L1574) | $options['api\_key']); |
| [1575](#L1575) | if($decrypted === false) { |
| [1576](#L1576) | esc\_html\_e( |
| [1577](#L1577) | 'Configuration error. Refresh page and retry.', |
| [1578](#L1578) | $this->plugin\_name); |
| [1579](#L1579) | wp\_die(); |
| [1580](#L1580) | } |
| [1581](#L1581) | $custom\_options = json\_decode($decrypted); |
| [1582](#L1582) | $options = wp\_parse\_args($custom\_options, $options); |
| [1583](#L1583) | } |
| [1584](#L1584) |  |
| [1585](#L1585) | // error\_log('decrypted options:'); |
| [1586](#L1586) | // error\_log(print\_r($options, true)); |
| [1587](#L1587) |  |
| [1588](#L1588) | $default\_conv\_mode = 'url'; |
| [1589](#L1589) | if(!isset($options['url'])) { |
| [1590](#L1590) | $location = $this->get\_location($options); |
| [1591](#L1591) | if($location) { |
| [1592](#L1592) | // use the location as url |
| [1593](#L1593) | $options['url'] = $location; |
| [1594](#L1594) | $default\_conv\_mode = 'upload'; |
| [1595](#L1595) | } |
| [1596](#L1596) | } else { |
| [1597](#L1597) | $location = $options['url']; |
| [1598](#L1598) | } |
| [1599](#L1599) |  |
| [1600](#L1600) | // decide conversion mode |
| [1601](#L1601) | if(!isset($options['conversion\_mode']) || |
| [1602](#L1602) | $options['conversion\_mode'] == 'auto') { |
| [1603](#L1603) | $options['conversion\_mode'] = isset($options['url']) |
| [1604](#L1604) | ? $default\_conv\_mode : 'upload'; |
| [1605](#L1605) | } else if($options['conversion\_mode'] == 'content') { |
| [1606](#L1606) | if(!isset($options['text']) && !isset($options['file'])) { |
| [1607](#L1607) | // take data from the page if they are not set explicitelly |
| [1608](#L1608) | // text is set e.g. when block shortcode is used |
| [1609](#L1609) | $options['text'] = self::validate\_data($options, $\_POST['cdata']); |
| [1610](#L1610) | if(!$options['text']) { |
| [1611](#L1611) | esc\_html\_e( |
| [1612](#L1612) | 'Invalid token. Use Conversion Mode Url or disable cache for this page.', |
| [1613](#L1613) | $this->plugin\_name); |
| [1614](#L1614) | wp\_die(); |
| [1615](#L1615) | } |
| [1616](#L1616) | } |
| [1617](#L1617) | } |
| [1618](#L1618) |  |
| [1619](#L1619) | if($options['conversion\_mode'] != 'url' && $location) { |
| [1620](#L1620) | $options['subprocess\_referrer'] = self::create\_referrer($location); |
| [1621](#L1621) | } |
| [1622](#L1622) |  |
| [1623](#L1623) | if($options['license\_type'] === 'demo') { |
| [1624](#L1624) | // use demo credentials |
| [1625](#L1625) | if(empty($options['username'])) { |
| [1626](#L1626) | $options['username'] = 'wp-demo'; |
| [1627](#L1627) | } |
| [1628](#L1628) | if(empty($options['api\_key'])) { |
| [1629](#L1629) | $options['api\_key'] = 'a182eb08c32a11e992c42c4d5455307a'; |
| [1630](#L1630) | } |
| [1631](#L1631) | } |
| [1632](#L1632) |  |
| [1633](#L1633) | $output = self::do\_post\_request($options); |
| [1634](#L1634) |  |
| [1635](#L1635) |  |
| [1636](#L1636) | // take options by reference so email\_to can be read in callback too |
| [1637](#L1637) | // and even callback can update options, e.g. change output name by |
| [1638](#L1638) | // some logic or fix email address et |
| [1639](#L1639) | $hook\_data = array( |
| [1640](#L1640) | 'output' => $output, |
| [1641](#L1641) | 'options' => &$options, |
| [1642](#L1642) | 'file\_name' => $this->get\_output\_name($options), |
| [1643](#L1643) | 'error' => is\_wp\_error($output) ? $output : null |
| [1644](#L1644) | ); |
| [1645](#L1645) |  |
| [1646](#L1646) | if(isset($options['diagnostics']) && $options['diagnostics'] == 1) { |
| [1647](#L1647) | error\_log('output\_file\_name: ' . $hook\_data['file\_name']); |
| [1648](#L1648) | if($hook\_data['error']) { |
| [1649](#L1649) | error\_log('error: ' . print\_r($hook\_data['error'], true)); |
| [1650](#L1650) | } |
| [1651](#L1651) | } |
| [1652](#L1652) |  |
| [1653](#L1653) | if($options['button\_disposition'] == 'email') { |
| [1654](#L1654) | $options['email\_to'] = self::get\_email\_recipient($options); |
| [1655](#L1655) | } |
| [1656](#L1656) |  |
| [1657](#L1657) | if(!empty($options['pdf\_created\_callback'])) { |
| [1658](#L1658) | if($options['pdf\_created\_callback']($hook\_data)) { |
| [1659](#L1659) | return; |
| [1660](#L1660) | } |
| [1661](#L1661) | } |
| [1662](#L1662) |  |
| [1663](#L1663) | if(is\_wp\_error($output)) { |
| [1664](#L1664) | $code = $output->get\_error\_code(); |
| [1665](#L1665) | $message = $output->get\_error\_message(); |
| [1666](#L1666) | if($options['button\_disposition'] == 'email') { |
| [1667](#L1667) | self::send\_json\_error($code, $message, true); |
| [1668](#L1668) | } else { |
| [1669](#L1669) | // use just the main error status for a status\_header |
| [1670](#L1670) | $status\_text = $message; |
| [1671](#L1671) | if(preg\_match('/<p>(.\*?)<\/p>/', $message, $matches)) { |
| [1672](#L1672) | $status\_text = $matches[1]; |
| [1673](#L1673) | } |
| [1674](#L1674) | status\_header((int) $code, $status\_text); |
| [1675](#L1675) |  |
| [1676](#L1676) | // error page is our HTML code and dynamic part of the message |
| [1677](#L1677) | // is escaped prior |
| [1678](#L1678) | echo $this->get\_error\_page($options, $code, $message); |
| [1679](#L1679) | } |
| [1680](#L1680) | } else { |
| [1681](#L1681) | if($options['button\_disposition'] == 'email') { |
| [1682](#L1682) | self::send\_email($options, $hook\_data['file\_name'], |
| [1683](#L1683) | $output, $this->plugin\_name); |
| [1684](#L1684) | } else { |
| [1685](#L1685) | // send the generated file to the browser |
| [1686](#L1686) | header('Content-Type: application/pdf'); |
| [1687](#L1687) | $disposition = $options['button\_disposition'] == 'inline\_new\_tab' ? 'inline' : $options['button\_disposition']; |
| [1688](#L1688) | header("Content-Disposition: {$disposition}; filename\*=UTF-8''" . rawurlencode($hook\_data['file\_name'])); |
| [1689](#L1689) | header('Cache-Control: no-cache'); |
| [1690](#L1690) | header('Accept-Ranges: none'); |
| [1691](#L1691) |  |
| [1692](#L1692) | // variable $output contains binary form of pdf |
| [1693](#L1693) | // file so it can not be escaped |
| [1694](#L1694) | echo $output; |
| [1695](#L1695) | } |
| [1696](#L1696) | } |
| [1697](#L1697) |  |
| [1698](#L1698) | wp\_die(); |
| [1699](#L1699) | } |
| [1700](#L1700) |  |
| [1701](#L1701) | private function get\_error\_page($options, $code, $message) { |
| [1702](#L1702) | $back = (empty($options['button\_disposition']) || |
| [1703](#L1703) | $options['button\_disposition'] === 'attachment' || |
| [1704](#L1704) | $options['button\_disposition'] === 'inline') |
| [1705](#L1705) | ? '<a href="javascript:history.go(-1)">Go Back</a>' |
| [1706](#L1706) | : ''; |
| [1707](#L1707) | return <<<HTML |
| [1708](#L1708) | <!DOCTYPE html> |
| [1709](#L1709) | <html> |
| [1710](#L1710) | <head> |
| [1711](#L1711) | <title>PDF Download Failed</title> |
| [1712](#L1712) | </head> |
| [1713](#L1713) | <body class="save-as-pdf-pdfcrowd-err"> |
| [1714](#L1714) | <h1>PDF Download Failed</h1> |
| [1715](#L1715) | <p>Please try again later.</p> |
| [1716](#L1716) | {$back} |
| [1717](#L1717) | <div class="save-as-pdf-pdfcrowd-err-admin" style="margin-top: 2em"> |
| [1718](#L1718) | <h2>Details for Administrator</h2> |
| [1719](#L1719) | <p>Code: {$code}</p> |
| [1720](#L1720) | <p>{$message}</p> |
| [1721](#L1721) | </div> |
| [1722](#L1722) | </body> |
| [1723](#L1723) | </html> |
| [1724](#L1724) | HTML; |
| [1725](#L1725) | } |
| [1726](#L1726) |  |
| [1727](#L1727) | private function get\_function\_name($key) { |
| [1728](#L1728) | return str\_replace(' ', '', ucwords(str\_replace('\_', ' ', $key))); |
| [1729](#L1729) | } |
| [1730](#L1730) |  |
| [1731](#L1731) | private function encrypt($string, $key) { |
| [1732](#L1732) | $ivlen = openssl\_cipher\_iv\_length($cipher="AES-128-CBC"); |
| [1733](#L1733) | $iv = openssl\_random\_pseudo\_bytes($ivlen); |
| [1734](#L1734) | $ciphertext\_raw = openssl\_encrypt($string, $cipher, $key, $options=OPENSSL\_RAW\_DATA, $iv); |
| [1735](#L1735) | $hmac = hash\_hmac('sha256', $ciphertext\_raw, $key, $as\_binary=true); |
| [1736](#L1736) | return base64\_encode( $iv.$hmac.$ciphertext\_raw ); |
| [1737](#L1737) | } |
| [1738](#L1738) |  |
| [1739](#L1739) | private function decrypt($ciphertext, $key) { |
| [1740](#L1740) | $c = base64\_decode($ciphertext); |
| [1741](#L1741) | $ivlen = openssl\_cipher\_iv\_length($cipher="AES-128-CBC"); |
| [1742](#L1742) | $iv = substr($c, 0, $ivlen); |
| [1743](#L1743) | $hmac = substr($c, $ivlen, $sha2len=32); |
| [1744](#L1744) | $ciphertext\_raw = substr($c, $ivlen+$sha2len); |
| [1745](#L1745) | $original\_plaintext = openssl\_decrypt($ciphertext\_raw, $cipher, $key, $options=OPENSSL\_RAW\_DATA, $iv); |
| [1746](#L1746) | $calcmac = hash\_hmac('sha256', $ciphertext\_raw, $key, $as\_binary=true); |
| [1747](#L1747) | if (hash\_equals($hmac, $calcmac))//PHP 5.6+ timing attack safe comparison |
| [1748](#L1748) | { |
| [1749](#L1749) | return $original\_plaintext; |
| [1750](#L1750) | } |
| [1751](#L1751) | return false; |
| [1752](#L1752) | } |
| [1753](#L1753) | } |
| [1754](#L1754) |  |
| [1755](#L1755) | /\*\* |
| [1756](#L1756) | \*  function for triggering conversion from the server code |
| [1757](#L1757) | \* |
| [1758](#L1758) | \* @since    1.6.0 |
| [1759](#L1759) | \*/ |
| [1760](#L1760) | if(!function\_exists('pdfcrowd\_save\_as\_pdf')) { |
| [1761](#L1761) | function pdfcrowd\_save\_as\_pdf($options) { |
| [1762](#L1762) | return Save\_As\_Pdf\_Pdfcrowd\_Public::convert($options); |
| [1763](#L1763) | } |
| [1764](#L1764) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/save-as-pdf-by-pdfcrowd/trunk/public/class-save-as-pdf-pdfcrowd-public.php?format=txt)
* [Original Format](/export/3222718/save-as-pdf-by-pdfcrowd/trunk/public/class-save-as-pdf-pdfcrowd-public.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_dfa077b7_20250115_092658.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Save as PDF Plugin by Pdfcrowd <= 4.2.1 - Authenticated (Contributor+) Stored Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Save as PDF Plugin by Pdfcrowd <= 4.2.1 - Authenticated (Contributor+) Stored Cross-Site Scripting

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-10891](https://www.cve.org/CVERecord?id=CVE-2024-10891) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | November 19, 2024 |
| Last Updated | November 20, 2024 |
| Researcher | [Peter Thaleikis](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/spek) |

### Description

The Save as PDF Plugin by Pdfcrowd plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the plugin's 'save\_as\_pdf\_pdfcrowd' shortcode in all versions up to, and including, 4.2.1 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers, with contributor-level access and above, to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/save-as-pdf-by-pdfcrowd/trunk/public/class-save-as-pdf-pdfcrowd-public.php#L586)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsave-as-pdf-by-pdfcrowd%2Fsave-as-pdf-plugin-by-pdfcrowd-421-authenticated-contributor-stored-cross-site-scripting&t=Save%20as%20PDF%20Plugin%20by%20Pdfcrowd%20%3C%3D%204.2.1%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsave-as-pdf-by-pdfcrowd%2Fsave-as-pdf-plugin-by-pdfcrowd-421-authenticated-contributor-stored-cross-site-scripting&text=Save%20as%20PDF%20Plugin%20by%20Pdfcrowd%20%3C%3D%204.2.1%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsave-as-pdf-by-pdfcrowd%2Fsave-as-pdf-plugin-by-pdfcrowd-421-authenticated-contributor-stored-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for Save as PDF Plugin by Pdfcrowd

#### [Save as PDF Plugin by Pdfcrowd](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/save-as-pdf-by-pdfcrowd)

| Software Type | Plugin |
| --- | --- |
| Software Slug | save-as-pdf-by-pdfcrowd [(view on wordpress.org)](https://wordpress.org/plugins/save-as-pdf-by-pdfcrowd) |
| Patched? | Yes |
| Remediation | Update to version 4.2.2, or a newer patched version |
| Affected Version | * <= 4.2.1 |
| Patched Version | * 4.2.2 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


