=== Content from plugins.trac.wordpress.org_760b63a8_20250114_220602.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fsimple-local-avatars%2Ftags%2F2.7.11%2Fincludes%2Fclass-simple-local-avatars.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/simple-local-avatars/tags/2.7.11/includes/class-simple-local-avatars.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/simple-local-avatars/tags/2.7.11/includes/class-simple-local-avatars.php)

---

# [source:](/browser?order=name "Go to repository root") [simple-local-avatars](/browser/simple-local-avatars?order=name "View simple-local-avatars")/[tags](/browser/simple-local-avatars/tags?order=name "View tags")/[2.7.11](/browser/simple-local-avatars/tags/2.7.11?order=name "View 2.7.11")/[includes](/browser/simple-local-avatars/tags/2.7.11/includes?order=name "View includes")/[class-simple-local-avatars.php](/browser/simple-local-avatars/tags/2.7.11/includes/class-simple-local-avatars.php?order=name "View class-simple-local-avatars.php")

View diff against:

View revision:

| [Last change](/changeset/3121647/simple-local-avatars/tags/2.7.11/includes/class-simple-local-avatars.php "View differences") on this file was [3121647](/changeset/3121647/ "View changeset 3121647"), checked in by 10up, [6 months ago](/timeline?from=2024-07-18T17%3A24%3A49Z&precision=second "See timeline at 07/18/2024 05:24:49 PM") |
| --- |
| Update to version 2.7.11 from GitHub |
| **File size:** 53.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Main Class file: Simple\_Local\_Avatars |
| [4](#L4) | \* Adds an avatar upload field to user profiles. |
| [5](#L5) | \* |
| [6](#L6) | \* @package SimpleLocalAvatars |
| [7](#L7) | \*/ |
| [8](#L8) |  |
| [9](#L9) | /\*\* |
| [10](#L10) | \* Main SLA Class. |
| [11](#L11) | \*/ |
| [12](#L12) | class Simple\_Local\_Avatars { |
| [13](#L13) | /\*\* |
| [14](#L14) | \* The user ID. |
| [15](#L15) | \* |
| [16](#L16) | \* @var int. |
| [17](#L17) | \*/ |
| [18](#L18) | private $user\_id\_being\_edited; |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* The upload error comment. |
| [22](#L22) | \* |
| [23](#L23) | \* @var string. |
| [24](#L24) | \*/ |
| [25](#L25) | private $avatar\_upload\_error; |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* The nonce token. |
| [29](#L29) | \* |
| [30](#L30) | \* @var string |
| [31](#L31) | \*/ |
| [32](#L32) | private $remove\_nonce; |
| [33](#L33) |  |
| [34](#L34) | /\*\* |
| [35](#L35) | \* The ratings. |
| [36](#L36) | \* |
| [37](#L37) | \* @var array |
| [38](#L38) | \*/ |
| [39](#L39) | private $avatar\_ratings; |
| [40](#L40) |  |
| [41](#L41) | /\*\* |
| [42](#L42) | \* The meta key a user. |
| [43](#L43) | \* |
| [44](#L44) | \* @var string |
| [45](#L45) | \*/ |
| [46](#L46) | private $user\_key; |
| [47](#L47) |  |
| [48](#L48) | /\*\* |
| [49](#L49) | \* The meta key a user. |
| [50](#L50) | \* |
| [51](#L51) | \* @var string he meta key for ratings. |
| [52](#L52) | \*/ |
| [53](#L53) | private $rating\_key; |
| [54](#L54) |  |
| [55](#L55) | /\*\* |
| [56](#L56) | \* Configured setting values. |
| [57](#L57) | \* |
| [58](#L58) | \* @var array |
| [59](#L59) | \*/ |
| [60](#L60) | public $options; |
| [61](#L61) |  |
| [62](#L62) | /\*\* |
| [63](#L63) | \* Set up the hooks and default values |
| [64](#L64) | \*/ |
| [65](#L65) | public function \_\_construct() { |
| [66](#L66) | $this->add\_hooks(); |
| [67](#L67) |  |
| [68](#L68) | $this->options        = (array) get\_option( 'simple\_local\_avatars' ); |
| [69](#L69) | $this->user\_key       = 'simple\_local\_avatar'; |
| [70](#L70) | $this->rating\_key     = 'simple\_local\_avatar\_rating'; |
| [71](#L71) |  |
| [72](#L72) | if ( |
| [73](#L73) | ! $this->is\_avatar\_shared() // Are we sharing avatars? |
| [74](#L74) | && ( |
| [75](#L75) | ( // And either an ajax request not in the network admin. |
| [76](#L76) | defined( 'DOING\_AJAX' ) && DOING\_AJAX |
| [77](#L77) | && isset( $\_SERVER['HTTP\_REFERER'] ) && ! preg\_match( '#^' . network\_admin\_url() . '#i', $\_SERVER['HTTP\_REFERER'] ) |
| [78](#L78) | ) |
| [79](#L79) | || |
| [80](#L80) | ( // Or normal request not in the network admin. |
| [81](#L81) | ( ! defined( 'DOING\_AJAX' ) || ! DOING\_AJAX ) |
| [82](#L82) | && ! is\_network\_admin() |
| [83](#L83) | ) |
| [84](#L84) | ) |
| [85](#L85) | && is\_multisite() |
| [86](#L86) | ) { |
| [87](#L87) | $this->user\_key   = sprintf( $this->user\_key . '\_%d', get\_current\_blog\_id() ); |
| [88](#L88) | $this->rating\_key = sprintf( $this->rating\_key . '\_%d', get\_current\_blog\_id() ); |
| [89](#L89) | } |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | /\*\* |
| [93](#L93) | \* Register actions and filters. |
| [94](#L94) | \*/ |
| [95](#L95) | public function add\_hooks() { |
| [96](#L96) | global $pagenow; |
| [97](#L97) | global $wp\_version; |
| [98](#L98) |  |
| [99](#L99) | add\_filter( 'plugin\_action\_links\_' . SLA\_PLUGIN\_BASENAME, array( $this, 'plugin\_filter\_action\_links' ) ); |
| [100](#L100) |  |
| [101](#L101) | add\_filter( 'pre\_get\_avatar\_data', array( $this, 'get\_avatar\_data' ), 10, 2 ); |
| [102](#L102) | add\_filter( 'pre\_option\_simple\_local\_avatars', array( $this, 'pre\_option\_simple\_local\_avatars' ), 10, 1 ); |
| [103](#L103) |  |
| [104](#L104) | add\_action( 'admin\_init', array( $this, 'admin\_init' ) ); |
| [105](#L105) | add\_action( 'init', array( $this, 'define\_avatar\_ratings' ) ); |
| [106](#L106) |  |
| [107](#L107) | // Load the JS on BE & FE both, in order to support third party plugins like bbPress. |
| [108](#L108) | add\_action( 'wp\_enqueue\_scripts', array( $this, 'enqueue\_scripts' ) ); |
| [109](#L109) | add\_action( 'admin\_enqueue\_scripts', array( $this, 'enqueue\_scripts' ) ); |
| [110](#L110) |  |
| [111](#L111) | add\_action( 'show\_user\_profile', array( $this, 'edit\_user\_profile' ) ); |
| [112](#L112) | add\_action( 'edit\_user\_profile', array( $this, 'edit\_user\_profile' ) ); |
| [113](#L113) |  |
| [114](#L114) | add\_action( 'personal\_options\_update', array( $this, 'edit\_user\_profile\_update' ) ); |
| [115](#L115) | add\_action( 'edit\_user\_profile\_update', array( $this, 'edit\_user\_profile\_update' ) ); |
| [116](#L116) | add\_action( 'admin\_action\_remove-simple-local-avatar', array( $this, 'action\_remove\_simple\_local\_avatar' ) ); |
| [117](#L117) | add\_action( 'wp\_ajax\_assign\_simple\_local\_avatar\_media', array( $this, 'ajax\_assign\_simple\_local\_avatar\_media' ) ); |
| [118](#L118) | add\_action( 'wp\_ajax\_remove\_simple\_local\_avatar', array( $this, 'action\_remove\_simple\_local\_avatar' ) ); |
| [119](#L119) | add\_action( 'user\_edit\_form\_tag', array( $this, 'user\_edit\_form\_tag' ) ); |
| [120](#L120) |  |
| [121](#L121) | add\_action( 'rest\_api\_init', array( $this, 'register\_rest\_fields' ) ); |
| [122](#L122) |  |
| [123](#L123) | add\_action( 'wp\_ajax\_migrate\_from\_wp\_user\_avatar', array( $this, 'ajax\_migrate\_from\_wp\_user\_avatar' ) ); |
| [124](#L124) |  |
| [125](#L125) | if ( defined( 'WP\_CLI' ) && WP\_CLI ) { |
| [126](#L126) | WP\_CLI::add\_command( 'simple-local-avatars migrate wp-user-avatar', array( $this, 'wp\_cli\_migrate\_from\_wp\_user\_avatar' ) ); |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | add\_action( 'wp\_ajax\_sla\_clear\_user\_cache', array( $this, 'sla\_clear\_user\_cache' ) ); |
| [130](#L130) |  |
| [131](#L131) | add\_filter( 'avatar\_defaults', array( $this, 'add\_avatar\_default\_field' ) ); |
| [132](#L132) | if ( version\_compare( $wp\_version, '5.1', '<' ) ) { |
| [133](#L133) | add\_action( 'wpmu\_new\_blog', array( $this, 'set\_defaults' ) ); |
| [134](#L134) | } else { |
| [135](#L135) | add\_action( 'wp\_initialize\_site', array( $this, 'set\_defaults' ) ); |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | if ( 'profile.php' === $pagenow ) { |
| [139](#L139) | add\_filter( 'media\_view\_strings', function ( $strings ) { |
| [140](#L140) | $strings['skipCropping'] = esc\_html\_\_( 'Default Crop', 'simple-local-avatars' ); |
| [141](#L141) |  |
| [142](#L142) | return $strings; |
| [143](#L143) | }, 10, 1 ); |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | // Fix: An error occurred cropping the image (https://github.com/10up/simple-local-avatars/issues/141). |
| [147](#L147) | if ( isset( $\_POST['action'] ) && 'crop-image' === $\_POST['action'] && is\_admin() && wp\_doing\_ajax() ) { |
| [148](#L148) | add\_action( 'plugins\_loaded', function () { |
| [149](#L149) | remove\_all\_actions( 'setup\_theme' ); |
| [150](#L150) | } ); |
| [151](#L151) | } |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | /\*\* |
| [155](#L155) | \* Determine if plugin is network activated. |
| [156](#L156) | \* |
| [157](#L157) | \* @param string $plugin The plugin slug to check. |
| [158](#L158) | \* |
| [159](#L159) | \* @return boolean |
| [160](#L160) | \*/ |
| [161](#L161) | public static function is\_network( $plugin ) { |
| [162](#L162) | $plugins = get\_site\_option( 'active\_sitewide\_plugins', array() ); |
| [163](#L163) |  |
| [164](#L164) | if ( is\_multisite() && isset( $plugins[ $plugin ] ) ) { |
| [165](#L165) | return true; |
| [166](#L166) | } |
| [167](#L167) |  |
| [168](#L168) | return false; |
| [169](#L169) | } |
| [170](#L170) |  |
| [171](#L171) | /\*\* |
| [172](#L172) | \* Get current plugin network mode |
| [173](#L173) | \*/ |
| [174](#L174) | public function get\_network\_mode() { |
| [175](#L175) | if ( SLA\_IS\_NETWORK ) { |
| [176](#L176) | return get\_site\_option( 'simple\_local\_avatars\_mode', 'default' ); |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | return 'default'; |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | /\*\* |
| [183](#L183) | \* Determines if settings handling is enforced on a network level |
| [184](#L184) | \* |
| [185](#L185) | \* Important: this is only meant for admin UI purposes. |
| [186](#L186) | \* |
| [187](#L187) | \* @return boolean |
| [188](#L188) | \*/ |
| [189](#L189) | public function is\_enforced() { |
| [190](#L190) | if ( |
| [191](#L191) | ( ! is\_network\_admin() && ( SLA\_IS\_NETWORK && 'enforce' === $this->get\_network\_mode() ) ) |
| [192](#L192) | ) { |
| [193](#L193) | return true; |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | return false; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | /\*\* |
| [200](#L200) | \* Determine if avatars should be shared |
| [201](#L201) | \* |
| [202](#L202) | \* @return boolean |
| [203](#L203) | \*/ |
| [204](#L204) | public function is\_avatar\_shared() { |
| [205](#L205) | if ( ! is\_multisite() ) { |
| [206](#L206) | return false; |
| [207](#L207) | } |
| [208](#L208) |  |
| [209](#L209) | if ( |
| [210](#L210) | ! isset( $this->options['shared'] ) // Our shared option doesn't exist. |
| [211](#L211) | || 1 === $this->options['shared']  // Or our shared option is set. |
| [212](#L212) | ) { |
| [213](#L213) | return true; |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | return false; |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | /\*\* |
| [220](#L220) | \* Add the settings action link to the plugin page. |
| [221](#L221) | \* |
| [222](#L222) | \* @param array $links The Action links for the plugin. |
| [223](#L223) | \* |
| [224](#L224) | \* @return array |
| [225](#L225) | \*/ |
| [226](#L226) | public function plugin\_filter\_action\_links( $links ) { |
| [227](#L227) |  |
| [228](#L228) | if ( ! is\_array( $links ) ) { |
| [229](#L229) | return $links; |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | $links['settings'] = sprintf( |
| [233](#L233) | '<a href="%s"> %s </a>', |
| [234](#L234) | esc\_url( admin\_url( 'options-discussion.php' ) ), |
| [235](#L235) | \_\_( 'Settings', 'simple-local-avatars' ) |
| [236](#L236) | ); |
| [237](#L237) |  |
| [238](#L238) | return $links; |
| [239](#L239) | } |
| [240](#L240) |  |
| [241](#L241) | /\*\* |
| [242](#L242) | \* Retrieve the local avatar for a user who provided a user ID, email address or post/comment object. |
| [243](#L243) | \* |
| [244](#L244) | \* @param string            $avatar      Avatar return by original function |
| [245](#L245) | \* @param int|string|object $id\_or\_email A user ID, email address, or post/comment object |
| [246](#L246) | \* @param int               $size        Size of the avatar image |
| [247](#L247) | \* @param string            $default     URL to a default image to use if no avatar is available |
| [248](#L248) | \* @param string            $alt         Alternative text to use in image tag. Defaults to blank |
| [249](#L249) | \* @param array             $args        Optional. Extra arguments to retrieve the avatar. |
| [250](#L250) | \* |
| [251](#L251) | \* @return string <img> tag for the user's avatar |
| [252](#L252) | \*/ |
| [253](#L253) | public function get\_avatar( $avatar = '', $id\_or\_email = '', $size = 96, $default = '', $alt = '', $args = array() ) { |
| [254](#L254) | return apply\_filters( 'simple\_local\_avatar', get\_avatar( $id\_or\_email, $size, $default, $alt, $args ) ); |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) | /\*\* |
| [258](#L258) | \* Filter avatar data early to add avatar url if needed. This filter hooks |
| [259](#L259) | \* before Gravatar setup to prevent wasted requests. |
| [260](#L260) | \* |
| [261](#L261) | \* @since 2.2.0 |
| [262](#L262) | \* |
| [263](#L263) | \* @param array $args        Arguments passed to get\_avatar\_data(), after processing. |
| [264](#L264) | \* @param mixed $id\_or\_email The Gravatar to retrieve. Accepts a user ID, Gravatar MD5 hash, |
| [265](#L265) | \*                           user email, WP\_User object, WP\_Post object, or WP\_Comment object. |
| [266](#L266) | \*/ |
| [267](#L267) | public function get\_avatar\_data( $args, $id\_or\_email ) { |
| [268](#L268) | if ( ! empty( $args['force\_default'] ) ) { |
| [269](#L269) | return $args; |
| [270](#L270) | } |
| [271](#L271) |  |
| [272](#L272) | $simple\_local\_avatar\_url = $this->get\_simple\_local\_avatar\_url( $id\_or\_email, $args['size'] ); |
| [273](#L273) | if ( $simple\_local\_avatar\_url ) { |
| [274](#L274) | $args['url'] = $simple\_local\_avatar\_url; |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | // Local only mode |
| [278](#L278) | if ( ! $simple\_local\_avatar\_url ) { |
| [279](#L279) | $default\_url    = $this->get\_default\_avatar\_url( $args['size'] ); |
| [280](#L280) | $avatar\_default = get\_option( 'avatar\_default' ); |
| [281](#L281) |  |
| [282](#L282) | if ( ! empty( $this->options['only'] ) ) { |
| [283](#L283) | $args['url'] = $default\_url; |
| [284](#L284) | } elseif ( 'simple\_local\_avatar' === $avatar\_default ) { |
| [285](#L285) | $args['default'] = $default\_url; |
| [286](#L286) | } |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | if ( ! empty( $args['url'] ) ) { |
| [290](#L290) | $args['found\_avatar'] = true; |
| [291](#L291) |  |
| [292](#L292) | // If custom alt text isn't passed, pull alt text from the local image. |
| [293](#L293) | if ( empty( $args['alt'] ) ) { |
| [294](#L294) | $args['alt'] = $this->get\_simple\_local\_avatar\_alt( $id\_or\_email ); |
| [295](#L295) | } |
| [296](#L296) | } |
| [297](#L297) |  |
| [298](#L298) | return $args; |
| [299](#L299) | } |
| [300](#L300) |  |
| [301](#L301) | /\*\* |
| [302](#L302) | \* Get a user ID from certain possible values. |
| [303](#L303) | \* |
| [304](#L304) | \* @since 2.5.0 |
| [305](#L305) | \* |
| [306](#L306) | \* @param mixed $id\_or\_email The Gravatar to retrieve. Accepts a user ID, Gravatar MD5 hash, |
| [307](#L307) | \*                           user email, WP\_User object, WP\_Post object, or WP\_Comment object. |
| [308](#L308) | \* @return int|false |
| [309](#L309) | \*/ |
| [310](#L310) | public function get\_user\_id( $id\_or\_email ) { |
| [311](#L311) | $user\_id = false; |
| [312](#L312) |  |
| [313](#L313) | if ( is\_numeric( $id\_or\_email ) ) { |
| [314](#L314) | $user\_id = (int) $id\_or\_email; |
| [315](#L315) | } elseif ( is\_object( $id\_or\_email ) && ! empty( $id\_or\_email->user\_id ) ) { |
| [316](#L316) | $user\_id = (int) $id\_or\_email->user\_id; |
| [317](#L317) | } elseif ( $id\_or\_email instanceof WP\_User ) { |
| [318](#L318) | $user\_id = $id\_or\_email->ID; |
| [319](#L319) | } elseif ( $id\_or\_email instanceof WP\_Post && ! empty( $id\_or\_email->post\_author ) ) { |
| [320](#L320) | $user\_id = (int) $id\_or\_email->post\_author; |
| [321](#L321) | } elseif ( is\_string( $id\_or\_email ) ) { |
| [322](#L322) | $user    = get\_user\_by( 'email', $id\_or\_email ); |
| [323](#L323) | $user\_id = $user ? $user->ID : ''; |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | return $user\_id; |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | /\*\* |
| [330](#L330) | \* Get local avatar url. |
| [331](#L331) | \* |
| [332](#L332) | \* @since 2.2.0 |
| [333](#L333) | \* |
| [334](#L334) | \* @param mixed $id\_or\_email The Gravatar to retrieve. Accepts a user ID, Gravatar MD5 hash, |
| [335](#L335) | \*                           user email, WP\_User object, WP\_Post object, or WP\_Comment object. |
| [336](#L336) | \* @param int   $size        Requested avatar size. |
| [337](#L337) | \*/ |
| [338](#L338) | public function get\_simple\_local\_avatar\_url( $id\_or\_email, $size ) { |
| [339](#L339) | $user\_id = $this->get\_user\_id( $id\_or\_email ); |
| [340](#L340) |  |
| [341](#L341) | if ( empty( $user\_id ) ) { |
| [342](#L342) | return ''; |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | // Fetch local avatar from meta and make sure it's properly set. |
| [346](#L346) | $local\_avatars = get\_user\_meta( $user\_id, $this->user\_key, true ); |
| [347](#L347) | if ( empty( $local\_avatars['full'] ) ) { |
| [348](#L348) | return ''; |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | // check rating |
| [352](#L352) | $avatar\_rating      = get\_user\_meta( $user\_id, $this->rating\_key, true ); |
| [353](#L353) | $site\_rating        = get\_option( 'avatar\_rating' ); |
| [354](#L354) | $all\_avatar\_ratings = ! empty( $this->avatar\_ratings ) && is\_array( $this->avatar\_ratings ) |
| [355](#L355) | ? $this->avatar\_ratings |
| [356](#L356) | : array(); |
| [357](#L357) | if ( ! empty( $avatar\_rating ) && 'G' !== $avatar\_rating && $site\_rating ) { |
| [358](#L358) | $ratings              = array\_keys( $all\_avatar\_ratings ); |
| [359](#L359) | $site\_rating\_weight   = array\_search( $site\_rating, $ratings, true ); |
| [360](#L360) | $avatar\_rating\_weight = array\_search( $avatar\_rating, $ratings, true ); |
| [361](#L361) | if ( false !== $avatar\_rating\_weight && $avatar\_rating\_weight > $site\_rating\_weight ) { |
| [362](#L362) | return ''; |
| [363](#L363) | } |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | /\*\* |
| [367](#L367) | \* Filter the URL of an avatar for the given user and size. |
| [368](#L368) | \* |
| [369](#L369) | \* This filters is applied before Simple Local Avatars validates the value of the |
| [370](#L370) | \* `$local\_avatars` array which comes from the user meta field. This allows the URL |
| [371](#L371) | \* to be short-circuited, for example by a dynamic image resizing service. |
| [372](#L372) | \* |
| [373](#L373) | \* @param string|null $url           The URL of the avatar. If null, the URL will be |
| [374](#L374) | \*                                   generated by Simple Local Avatars. |
| [375](#L375) | \* @param int         $user\_id       The user ID. |
| [376](#L376) | \* @param int         $size          Requested avatar size. |
| [377](#L377) | \* @param array       $local\_avatars The local avatars for the user. |
| [378](#L378) | \* @return string|null The URL of the avatar, or null to allow Simple Local Avatars to |
| [379](#L379) | \*                     generate the URL. |
| [380](#L380) | \*/ |
| [381](#L381) | $url = apply\_filters( 'pre\_simple\_local\_avatar\_url', null, $user\_id, $size, $local\_avatars ); |
| [382](#L382) |  |
| [383](#L383) | if ( is\_string( $url ) ) { |
| [384](#L384) | return esc\_url( $url ); |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | // handle "real" media |
| [388](#L388) | if ( ! empty( $local\_avatars['media\_id'] ) ) { |
| [389](#L389) | // If using shared avatars, make sure we validate the URL on the main site. |
| [390](#L390) | if ( $this->is\_avatar\_shared() ) { |
| [391](#L391) | $origin\_blog\_id = isset( $local\_avatars['blog\_id'] ) && ! empty( $local\_avatars['blog\_id'] ) ? $local\_avatars['blog\_id'] : get\_main\_site\_id(); |
| [392](#L392) | switch\_to\_blog( $origin\_blog\_id ); |
| [393](#L393) | } |
| [394](#L394) |  |
| [395](#L395) | $avatar\_full\_path = get\_attached\_file( $local\_avatars['media\_id'] ); |
| [396](#L396) |  |
| [397](#L397) | if ( $this->is\_avatar\_shared() ) { |
| [398](#L398) | restore\_current\_blog(); |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | // has the media been deleted? |
| [402](#L402) | if ( ! $avatar\_full\_path ) { |
| [403](#L403) | return ''; |
| [404](#L404) | } |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | $size = (int) $size; |
| [408](#L408) |  |
| [409](#L409) | // Generate a new size. |
| [410](#L410) | if ( ! array\_key\_exists( $size, $local\_avatars ) ) { |
| [411](#L411) | $local\_avatars[ $size ] = $local\_avatars['full']; // just in case of failure elsewhere |
| [412](#L412) |  |
| [413](#L413) | // allow automatic rescaling to be turned off |
| [414](#L414) | if ( apply\_filters( 'simple\_local\_avatars\_dynamic\_resize', true ) ) : |
| [415](#L415) |  |
| [416](#L416) | $upload\_path = wp\_upload\_dir(); |
| [417](#L417) |  |
| [418](#L418) | // get path for image by converting URL, unless its already been set, thanks to using media library approach |
| [419](#L419) | if ( ! isset( $avatar\_full\_path ) ) { |
| [420](#L420) | $avatar\_full\_path = str\_replace( $upload\_path['baseurl'], $upload\_path['basedir'], $local\_avatars['full'] ); |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | // generate the new size |
| [424](#L424) | $editor = wp\_get\_image\_editor( $avatar\_full\_path ); |
| [425](#L425) | if ( ! is\_wp\_error( $editor ) ) { |
| [426](#L426) | $resized = $editor->resize( $size, $size, true ); |
| [427](#L427) | if ( ! is\_wp\_error( $resized ) ) { |
| [428](#L428) | $dest\_file = $editor->generate\_filename(); |
| [429](#L429) | $saved     = $editor->save( $dest\_file ); |
| [430](#L430) | if ( ! is\_wp\_error( $saved ) ) { |
| [431](#L431) | // Transform the destination file path into URL. |
| [432](#L432) | $dest\_file\_url = ''; |
| [433](#L433) | if ( false !== strpos( $dest\_file, $upload\_path['basedir'] ) ) { |
| [434](#L434) | $dest\_file\_url = str\_replace( $upload\_path['basedir'], $upload\_path['baseurl'], $dest\_file ); |
| [435](#L435) | } else if ( is\_multisite() && false !== strpos( $dest\_file, ABSPATH . 'wp-content/uploads' ) ) { |
| [436](#L436) | $dest\_file\_url = str\_replace( ABSPATH . 'wp-content/uploads', network\_site\_url( '/wp-content/uploads' ), $dest\_file ); |
| [437](#L437) | } |
| [438](#L438) |  |
| [439](#L439) | $local\_avatars[ $size ] = $dest\_file\_url; |
| [440](#L440) | } |
| [441](#L441) | } |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | // save updated avatar sizes |
| [445](#L445) | update\_user\_meta( $user\_id, $this->user\_key, $local\_avatars ); |
| [446](#L446) |  |
| [447](#L447) | endif; |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | if ( 'http' !== substr( $local\_avatars[ $size ], 0, 4 ) ) { |
| [451](#L451) | $local\_avatars[ $size ] = home\_url( $local\_avatars[ $size ] ); |
| [452](#L452) | } |
| [453](#L453) |  |
| [454](#L454) | return esc\_url( $local\_avatars[ $size ] ); |
| [455](#L455) | } |
| [456](#L456) |  |
| [457](#L457) | /\*\* |
| [458](#L458) | \* Get local avatar alt text. |
| [459](#L459) | \* |
| [460](#L460) | \* @since 2.5.0 |
| [461](#L461) | \* |
| [462](#L462) | \* @param mixed $id\_or\_email The Gravatar to retrieve. Accepts a user ID, Gravatar MD5 hash, |
| [463](#L463) | \*                           user email, WP\_User object, WP\_Post object, or WP\_Comment object. |
| [464](#L464) | \* @return string |
| [465](#L465) | \*/ |
| [466](#L466) | public function get\_simple\_local\_avatar\_alt( $id\_or\_email ) { |
| [467](#L467) | $user\_id = $this->get\_user\_id( $id\_or\_email ); |
| [468](#L468) |  |
| [469](#L469) | /\*\* |
| [470](#L470) | \* Filter the default avatar alt text. |
| [471](#L471) | \* |
| [472](#L472) | \* @param string $alt Default alt text. |
| [473](#L473) | \* @return string |
| [474](#L474) | \*/ |
| [475](#L475) | $default\_alt = apply\_filters( 'simple\_local\_avatars\_default\_alt', \_\_( 'Avatar photo', 'simple-local-avatars' ) ); |
| [476](#L476) |  |
| [477](#L477) | if ( empty( $user\_id ) ) { |
| [478](#L478) | return $default\_alt; |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | // Fetch local avatar from meta and make sure we have a media ID. |
| [482](#L482) | $local\_avatars = get\_user\_meta( $user\_id, 'simple\_local\_avatar', true ); |
| [483](#L483) | if ( empty( $local\_avatars['media\_id'] ) ) { |
| [484](#L484) | $alt = ''; |
| [485](#L485) | // If no avatar is set, check if we are using a default avatar with alt text. |
| [486](#L486) | if ( 'simple\_local\_avatar' === get\_option( 'avatar\_default' ) ) { |
| [487](#L487) | $default\_avatar\_id = get\_option( 'simple\_local\_avatar\_default', '' ); |
| [488](#L488) | if ( ! empty( $default\_avatar\_id ) ) { |
| [489](#L489) | $alt = get\_post\_meta( $default\_avatar\_id, '\_wp\_attachment\_image\_alt', true ); |
| [490](#L490) | } |
| [491](#L491) | } |
| [492](#L492) |  |
| [493](#L493) | return $alt ? $alt : $default\_alt; |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | $alt = get\_post\_meta( $local\_avatars['media\_id'], '\_wp\_attachment\_image\_alt', true ); |
| [497](#L497) |  |
| [498](#L498) | return $alt ? $alt : $default\_alt; |
| [499](#L499) | } |
| [500](#L500) |  |
| [501](#L501) | /\*\* |
| [502](#L502) | \* Get default avatar url |
| [503](#L503) | \* |
| [504](#L504) | \* @since 2.2.0 |
| [505](#L505) | \* |
| [506](#L506) | \* @param int $size Requested avatar size. |
| [507](#L507) | \*/ |
| [508](#L508) | public function get\_default\_avatar\_url( $size ) { |
| [509](#L509) | if ( empty( $default ) ) { |
| [510](#L510) | $avatar\_default = get\_option( 'avatar\_default' ); |
| [511](#L511) | if ( empty( $avatar\_default ) ) { |
| [512](#L512) | $default = 'mystery'; |
| [513](#L513) | } else { |
| [514](#L514) | $default = $avatar\_default; |
| [515](#L515) | } |
| [516](#L516) | } |
| [517](#L517) |  |
| [518](#L518) | $host = is\_ssl() ? 'https://secure.gravatar.com' : 'http://0.gravatar.com'; |
| [519](#L519) |  |
| [520](#L520) | if ( 'mystery' === $default ) { |
| [521](#L521) | $default = "$host/avatar/ad516503a11cd5ca435acc9bb6523536?s={$size}"; // ad516503a11cd5ca435acc9bb6523536 == md5('unknown@gravatar.com') |
| [522](#L522) | } elseif ( 'blank' === $default ) { |
| [523](#L523) | $default = includes\_url( 'images/blank.gif' ); |
| [524](#L524) | } elseif ( 'gravatar\_default' === $default ) { |
| [525](#L525) | $default = "$host/avatar/?s={$size}"; |
| [526](#L526) | } elseif ( 'simple\_local\_avatar' === $default ) { |
| [527](#L527) | $default           = "$host/avatar/?d=$default&amp;s={$size}"; |
| [528](#L528) | $default\_avatar\_id = get\_option( 'simple\_local\_avatar\_default', '' ); |
| [529](#L529) | if ( ! empty( $default\_avatar\_id ) ) { |
| [530](#L530) | $default = wp\_get\_attachment\_image\_url( $default\_avatar\_id ); |
| [531](#L531) | } |
| [532](#L532) | } else { |
| [533](#L533) | $default = "$host/avatar/?d=$default&amp;s={$size}"; |
| [534](#L534) | } |
| [535](#L535) |  |
| [536](#L536) | return $default; |
| [537](#L537) | } |
| [538](#L538) |  |
| [539](#L539) | /\*\* |
| [540](#L540) | \* Define the ratings avatar ratings. |
| [541](#L541) | \* |
| [542](#L542) | \* The ratings need to be defined after the languages have been loaded so |
| [543](#L543) | \* they can be translated. This method exists to define the ratings |
| [544](#L544) | \* after that has been done. |
| [545](#L545) | \* |
| [546](#L546) | \* @since 2.7.3 |
| [547](#L547) | \*/ |
| [548](#L548) | public function define\_avatar\_ratings() { |
| [549](#L549) | /\* |
| [550](#L550) | \* Avatar ratings. |
| [551](#L551) | \* |
| [552](#L552) | \* The key should not be translated as it's used by WP Core in it's |
| [553](#L553) | \* english form (G, PG, etc). |
| [554](#L554) | \* |
| [555](#L555) | \* The values should be translated, these include the initial rating |
| [556](#L556) | \* name and the description for display to users. |
| [557](#L557) | \*/ |
| [558](#L558) | $this->avatar\_ratings = array( |
| [559](#L559) | /\* translators: Content suitability rating: https://en.wikipedia.org/wiki/Motion\_Picture\_Association\_of\_America\_film\_rating\_system \*/ |
| [560](#L560) | 'G'  => \_\_( 'G &#8212; Suitable for all audiences' ), |
| [561](#L561) | /\* translators: Content suitability rating: https://en.wikipedia.org/wiki/Motion\_Picture\_Association\_of\_America\_film\_rating\_system \*/ |
| [562](#L562) | 'PG' => \_\_( 'PG &#8212; Possibly offensive, usually for audiences 13 and above' ), |
| [563](#L563) | /\* translators: Content suitability rating: https://en.wikipedia.org/wiki/Motion\_Picture\_Association\_of\_America\_film\_rating\_system \*/ |
| [564](#L564) | 'R'  => \_\_( 'R &#8212; Intended for adult audiences above 17' ), |
| [565](#L565) | /\* translators: Content suitability rating: https://en.wikipedia.org/wiki/Motion\_Picture\_Association\_of\_America\_film\_rating\_system \*/ |
| [566](#L566) | 'X'  => \_\_( 'X &#8212; Even more mature than above' ), |
| [567](#L567) | ); |
| [568](#L568) | } |
| [569](#L569) |  |
| [570](#L570) | /\*\* |
| [571](#L571) | \* Register admin settings. |
| [572](#L572) | \*/ |
| [573](#L573) | public function admin\_init() { |
| [574](#L574) | $this->define\_avatar\_ratings(); |
| [575](#L575) | // upgrade pre 2.0 option |
| [576](#L576) | $old\_ops = get\_option( 'simple\_local\_avatars\_caps' ); |
| [577](#L577) | if ( $old\_ops ) { |
| [578](#L578) | if ( ! empty( $old\_ops['simple\_local\_avatars\_caps'] ) ) { |
| [579](#L579) | update\_option( 'simple\_local\_avatars', array( 'caps' => 1 ) ); |
| [580](#L580) | } |
| [581](#L581) |  |
| [582](#L582) | delete\_option( 'simple\_local\_avatar\_caps' ); |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | register\_setting( 'discussion', 'simple\_local\_avatars', array( $this, 'sanitize\_options' ) ); |
| [586](#L586) | add\_settings\_field( |
| [587](#L587) | 'simple-local-avatars-only', |
| [588](#L588) | \_\_( 'Local Avatars Only', 'simple-local-avatars' ), |
| [589](#L589) | array( $this, 'avatar\_settings\_field' ), |
| [590](#L590) | 'discussion', |
| [591](#L591) | 'avatars', |
| [592](#L592) | array( |
| [593](#L593) | 'class' => 'simple-local-avatars', |
| [594](#L594) | 'key'   => 'only', |
| [595](#L595) | 'desc'  => \_\_( 'Only allow local avatars (still uses Gravatar for default avatars)', 'simple-local-avatars' ), |
| [596](#L596) | ) |
| [597](#L597) | ); |
| [598](#L598) | add\_settings\_field( |
| [599](#L599) | 'simple-local-avatars-caps', |
| [600](#L600) | \_\_( 'Local Upload Permissions', 'simple-local-avatars' ), |
| [601](#L601) | array( $this, 'avatar\_settings\_field' ), |
| [602](#L602) | 'discussion', |
| [603](#L603) | 'avatars', |
| [604](#L604) | array( |
| [605](#L605) | 'class' => 'simple-local-avatars', |
| [606](#L606) | 'key'   => 'caps', |
| [607](#L607) | 'desc'  => \_\_( 'Only allow users with file upload capabilities to upload local avatars (Authors and above)', 'simple-local-avatars' ), |
| [608](#L608) | ) |
| [609](#L609) | ); |
| [610](#L610) |  |
| [611](#L611) | if ( is\_multisite() ) { |
| [612](#L612) | add\_settings\_field( |
| [613](#L613) | 'simple-local-avatars-shared', |
| [614](#L614) | \_\_( 'Shared network avatars', 'simple-local-avatars' ), |
| [615](#L615) | array( $this, 'avatar\_settings\_field' ), |
| [616](#L616) | 'discussion', |
| [617](#L617) | 'avatars', |
| [618](#L618) | array( |
| [619](#L619) | 'class'   => 'simple-local-avatars', |
| [620](#L620) | 'key'     => 'shared', |
| [621](#L621) | 'desc'    => \_\_( 'Uploaded avatars will be shared across the entire network, instead of being unique per site', 'simple-local-avatars' ), |
| [622](#L622) | 'default' => 1, |
| [623](#L623) | ) |
| [624](#L624) | ); |
| [625](#L625) | } |
| [626](#L626) |  |
| [627](#L627) | add\_action( 'load-options-discussion.php', array( $this, 'load\_discussion\_page' ) ); |
| [628](#L628) |  |
| [629](#L629) | // This is for network site settings. |
| [630](#L630) | if ( SLA\_IS\_NETWORK && is\_network\_admin() ) { |
| [631](#L631) | add\_action( 'load-settings.php', array( $this, 'load\_network\_settings' ) ); |
| [632](#L632) | } |
| [633](#L633) |  |
| [634](#L634) | add\_settings\_field( |
| [635](#L635) | 'simple-local-avatars-migration', |
| [636](#L636) | \_\_( 'Migrate Other Local Avatars', 'simple-local-avatars' ), |
| [637](#L637) | array( $this, 'migrate\_from\_wp\_user\_avatar\_settings\_field' ), |
| [638](#L638) | 'discussion', |
| [639](#L639) | 'avatars' |
| [640](#L640) | ); |
| [641](#L641) | add\_settings\_field( |
| [642](#L642) | 'simple-local-avatars-clear', |
| [643](#L643) | esc\_html\_\_( 'Clear local avatar cache', 'simple-local-avatars' ), |
| [644](#L644) | array( $this, 'avatar\_settings\_field' ), |
| [645](#L645) | 'discussion', |
| [646](#L646) | 'avatars', |
| [647](#L647) | array( |
| [648](#L648) | 'key'  => 'clear\_cache', |
| [649](#L649) | 'desc' => esc\_html\_\_( 'Clear cache of stored avatars', 'simple-local-avatars' ), |
| [650](#L650) | ) |
| [651](#L651) | ); |
| [652](#L652) |  |
| [653](#L653) | // Save default avatar file. |
| [654](#L654) | $this->save\_default\_avatar\_file\_id(); |
| [655](#L655) | } |
| [656](#L656) |  |
| [657](#L657) | /\*\* |
| [658](#L658) | \* Fire code on the Discussion page |
| [659](#L659) | \*/ |
| [660](#L660) | public function load\_discussion\_page() { |
| [661](#L661) | add\_action( 'admin\_print\_styles', array( $this, 'admin\_print\_styles' ) ); |
| [662](#L662) | add\_filter( 'admin\_body\_class', array( $this, 'admin\_body\_class' ) ); |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | /\*\* |
| [666](#L666) | \* Load needed hooks to handle network settings |
| [667](#L667) | \*/ |
| [668](#L668) | public function load\_network\_settings() { |
| [669](#L669) | $this->options = (array) get\_site\_option( 'simple\_local\_avatars', array() ); |
| [670](#L670) |  |
| [671](#L671) | add\_action( 'wpmu\_options', array( $this, 'show\_network\_settings' ) ); |
| [672](#L672) | add\_action( 'update\_wpmu\_options', array( $this, 'save\_network\_settings' ) ); |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) | /\*\* |
| [676](#L676) | \* Show the network settings |
| [677](#L677) | \*/ |
| [678](#L678) | public function show\_network\_settings() { |
| [679](#L679) | $mode = $this->get\_network\_mode(); |
| [680](#L680) | ?> |
| [681](#L681) |  |
| [682](#L682) | <h2><?php esc\_html\_e( 'Simple Local Avatars Settings', 'simple-local-avatars' ); ?></h2> |
| [683](#L683) | <table id="simple-local-avatars" class="form-table"> |
| [684](#L684) | <tr> |
| [685](#L685) | <th scope="row"> |
| [686](#L686) | <?php esc\_html\_e( 'Mode', 'simple-local-avatars' ); ?> |
| [687](#L687) | </th> |
| [688](#L688) | <td> |
| [689](#L689) | <fieldset> |
| [690](#L690) | <legend class="screen-reader-text"><?php esc\_html\_e( 'Mode', 'simple-local-avatars' ); ?></legend> |
| [691](#L691) | <label><input name="simple\_local\_avatars[mode]" type="radio" id="sla-mode-default" value="default"<?php checked( $mode, 'default' ); ?> /> <?php esc\_html\_e( 'Default to the settings below when creating a new site', 'simple-local-avatars' ); ?></label><br/> |
| [692](#L692) | <label><input name="simple\_local\_avatars[mode]" type="radio" id="sla-mode-enforce" value="enforce"<?php checked( $mode, 'enforce' ); ?> /> <?php esc\_html\_e( 'Enforce the settings below across all sites', 'simple-local-avatars' ); ?></label><br/> |
| [693](#L693) | </fieldset> |
| [694](#L694) | </td> |
| [695](#L695) | </tr> |
| [696](#L696) | <tr> |
| [697](#L697) | <th scope="row"> |
| [698](#L698) | <?php esc\_html\_e( 'Local avatars only', 'simple-local-avatars' ); ?> |
| [699](#L699) | </th> |
| [700](#L700) | <td> |
| [701](#L701) | <?php |
| [702](#L702) | $this->avatar\_settings\_field( |
| [703](#L703) | array( |
| [704](#L704) | 'key'  => 'only', |
| [705](#L705) | 'desc' => \_\_( 'Only allow local avatars (still uses Gravatar for default avatars)       ', 'simple-local-avatars' ), |
| [706](#L706) | ) |
| [707](#L707) | ); |
| [708](#L708) | ?> |
| [709](#L709) | </td> |
| [710](#L710) | </tr> |
| [711](#L711) | <tr> |
| [712](#L712) | <th scope="row"> |
| [713](#L713) | <?php esc\_html\_e( 'Local upload permissions', 'simple-local-avatars' ); ?> |
| [714](#L714) | </th> |
| [715](#L715) | <td> |
| [716](#L716) | <?php |
| [717](#L717) | $this->avatar\_settings\_field( |
| [718](#L718) | array( |
| [719](#L719) | 'key'  => 'caps', |
| [720](#L720) | 'desc' => \_\_( 'Only allow users with file upload capabilities to upload local avatars (Authors and above)', 'simple-local-avatars' ), |
| [721](#L721) | ) |
| [722](#L722) | ); |
| [723](#L723) | ?> |
| [724](#L724) | </td> |
| [725](#L725) | </tr> |
| [726](#L726) | <tr> |
| [727](#L727) | <th scope="row"> |
| [728](#L728) | <?php esc\_html\_e( 'Shared network avatars', 'simple-local-avatars' ); ?> |
| [729](#L729) | </th> |
| [730](#L730) | <td> |
| [731](#L731) | <?php |
| [732](#L732) | $this->avatar\_settings\_field( |
| [733](#L733) | array( |
| [734](#L734) | 'key'     => 'shared', |
| [735](#L735) | 'desc'    => \_\_( 'Uploaded avatars will be shared across the entire network, instead of being unique per site', 'simple-local-avatars' ), |
| [736](#L736) | 'default' => 1, |
| [737](#L737) | ) |
| [738](#L738) | ); |
| [739](#L739) | ?> |
| [740](#L740) | </td> |
| [741](#L741) | </tr> |
| [742](#L742) | </table> |
| [743](#L743) |  |
| [744](#L744) | <?php |
| [745](#L745) | } |
| [746](#L746) |  |
| [747](#L747) | /\*\* |
| [748](#L748) | \* Handle saving the network settings |
| [749](#L749) | \*/ |
| [750](#L750) | public static function save\_network\_settings() { |
| [751](#L751) | $options   = array( |
| [752](#L752) | 'caps', |
| [753](#L753) | 'mode', |
| [754](#L754) | 'only', |
| [755](#L755) | 'shared', |
| [756](#L756) | ); |
| [757](#L757) | $sanitized = array(); |
| [758](#L758) |  |
| [759](#L759) | foreach ( $options as $option\_name ) { |
| [760](#L760) | if ( ! isset( $\_POST['simple\_local\_avatars'][ $option\_name ] ) ) { // phpcs:ignore WordPress.Security.NonceVerification |
| [761](#L761) | continue; |
| [762](#L762) | } |
| [763](#L763) |  |
| [764](#L764) | switch ( $option\_name ) { |
| [765](#L765) | case 'mode': |
| [766](#L766) | update\_site\_option( 'simple\_local\_avatars\_mode', sanitize\_text\_field( $\_POST['simple\_local\_avatars'][ $option\_name ] ) ); |
| [767](#L767) | break; |
| [768](#L768) | default: |
| [769](#L769) | $sanitized[ $option\_name ] = empty( $\_POST['simple\_local\_avatars'][ $option\_name ] ) ? 0 : 1; |
| [770](#L770) | } |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | update\_site\_option( 'simple\_local\_avatars', $sanitized ); |
| [774](#L774) | } |
| [775](#L775) |  |
| [776](#L776) | /\*\* |
| [777](#L777) | \* Add scripts to the profile editing page |
| [778](#L778) | \* |
| [779](#L779) | \* @param string $hook\_suffix Page hook |
| [780](#L780) | \*/ |
| [781](#L781) | public function enqueue\_scripts( $hook\_suffix ) { |
| [782](#L782) |  |
| [783](#L783) | /\*\* |
| [784](#L784) | \* Filter the admin screens where we enqueue our scripts. |
| [785](#L785) | \* |
| [786](#L786) | \* @param array $screens Array of admin screens. |
| [787](#L787) | \* @param string $hook\_suffix Page hook. |
| [788](#L788) | \* @return array |
| [789](#L789) | \*/ |
| [790](#L790) | $screens = apply\_filters( 'simple\_local\_avatars\_admin\_enqueue\_scripts', array( 'profile.php', 'user-edit.php', 'options-discussion.php' ), $hook\_suffix ); |
| [791](#L791) |  |
| [792](#L792) | // Allow SLA actions on a bbPress profile edit page at FE. |
| [793](#L793) | if ( function\_exists( 'bbp\_is\_user\_home\_edit' ) && bbp\_is\_user\_home\_edit() ) { |
| [794](#L794) | $hook\_suffix = 'profile.php'; |
| [795](#L795) | } |
| [796](#L796) |  |
| [797](#L797) | if ( ! in\_array( $hook\_suffix, $screens, true ) ) { |
| [798](#L798) | return; |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | if ( current\_user\_can( 'upload\_files' ) ) { |
| [802](#L802) | wp\_enqueue\_media(); |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | $user\_id = filter\_input( INPUT\_GET, 'user\_id', FILTER\_SANITIZE\_NUMBER\_INT ); |
| [806](#L806) | $user\_id = ( 'profile.php' === $hook\_suffix ) ? get\_current\_user\_id() : (int) $user\_id; |
| [807](#L807) |  |
| [808](#L808) | $this->remove\_nonce = wp\_create\_nonce( 'remove\_simple\_local\_avatar\_nonce' ); |
| [809](#L809) |  |
| [810](#L810) | wp\_enqueue\_script( 'simple-local-avatars', plugins\_url( '', dirname( \_\_FILE\_\_ ) ) . '/dist/simple-local-avatars.js', array( 'jquery' ), SLA\_VERSION, true ); |
| [811](#L811) | wp\_localize\_script( |
| [812](#L812) | 'simple-local-avatars', |
| [813](#L813) | 'i10n\_SimpleLocalAvatars', |
| [814](#L814) | array( |
| [815](#L815) | 'ajaxurl'                         => admin\_url( 'admin-ajax.php' ), |
| [816](#L816) | 'user\_id'                         => $user\_id, |
| [817](#L817) | 'insertIntoPost'                  => \_\_( 'Set as avatar', 'simple-local-avatars' ), |
| [818](#L818) | 'selectCrop'                      => \_\_( 'Select avatar and Crop', 'simple-local-avatars' ), |
| [819](#L819) | 'deleteNonce'                     => $this->remove\_nonce, |
| [820](#L820) | 'cacheNonce'                      => wp\_create\_nonce( 'sla\_clear\_cache\_nonce' ), |
| [821](#L821) | 'mediaNonce'                      => wp\_create\_nonce( 'assign\_simple\_local\_avatar\_nonce' ), |
| [822](#L822) | 'migrateFromWpUserAvatarNonce'    => wp\_create\_nonce( 'migrate\_from\_wp\_user\_avatar\_nonce' ), |
| [823](#L823) | 'clearCacheError'                 => esc\_html\_\_( 'Something went wrong while clearing cache, please try again.', 'simple-local-avatars' ), |
| [824](#L824) | 'insertMediaTitle'                => esc\_html\_\_( 'Choose default avatar', 'simple-local-avatars' ), |
| [825](#L825) | 'migrateFromWpUserAvatarSuccess'  => \_\_( 'Number of avatars successfully migrated from WP User Avatar', 'simple-local-avatars' ), |
| [826](#L826) | 'migrateFromWpUserAvatarFailure'  => \_\_( 'No avatars were migrated from WP User Avatar.', 'simple-local-avatars' ), |
| [827](#L827) | 'migrateFromWpUserAvatarProgress' => \_\_( 'Migration in progress.', 'simple-local-avatars' ), |
| [828](#L828) | ) |
| [829](#L829) | ); |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | /\*\* |
| [833](#L833) | \* Sanitize new settings field before saving |
| [834](#L834) | \* |
| [835](#L835) | \* @param  array|string $input Passed input values to sanitize |
| [836](#L836) | \* @return array|string Sanitized input fields |
| [837](#L837) | \*/ |
| [838](#L838) | public function sanitize\_options( $input ) { |
| [839](#L839) | $new\_input['caps'] = empty( $input['caps'] ) ? 0 : 1; |
| [840](#L840) | $new\_input['only'] = empty( $input['only'] ) ? 0 : 1; |
| [841](#L841) |  |
| [842](#L842) | if ( is\_multisite() ) { |
| [843](#L843) | $new\_input['shared'] = empty( $input['shared'] ) ? 0 : 1; |
| [844](#L844) | } |
| [845](#L845) |  |
| [846](#L846) | return $new\_input; |
| [847](#L847) | } |
| [848](#L848) |  |
| [849](#L849) | /\*\* |
| [850](#L850) | \* Settings field for avatar upload capabilities |
| [851](#L851) | \* |
| [852](#L852) | \* @param array $args Field arguments |
| [853](#L853) | \*/ |
| [854](#L854) | public function avatar\_settings\_field( $args ) { |
| [855](#L855) | $args = wp\_parse\_args( |
| [856](#L856) | $args, |
| [857](#L857) | array( |
| [858](#L858) | 'key'     => '', |
| [859](#L859) | 'desc'    => '', |
| [860](#L860) | 'default' => 0, |
| [861](#L861) | ) |
| [862](#L862) | ); |
| [863](#L863) |  |
| [864](#L864) | if ( ! isset( $this->options[ $args['key'] ] ) ) { |
| [865](#L865) | $this->options[ $args['key'] ] = $args['default']; |
| [866](#L866) | } |
| [867](#L867) |  |
| [868](#L868) | if ( 'clear\_cache' !== $args['key'] ) { |
| [869](#L869) | echo ' |
| [870](#L870) | <label for="simple-local-avatars-' . esc\_attr( $args['key'] ) . '"> |
| [871](#L871) | <input type="checkbox" name="simple\_local\_avatars[' . esc\_attr( $args['key'] ) . ']" id="simple-local-avatars-' . esc\_attr( $args['key'] ) . '" value="1" ' . checked( $this->options[ $args['key'] ], 1, false ) . ' /> |
| [872](#L872) | ' . esc\_html( $args['desc'] ) . ' |
| [873](#L873) | </label> |
| [874](#L874) | '; |
| [875](#L875) | } else { |
| [876](#L876) | echo '<button id="clear\_cache\_btn" class="button delete" name="clear\_cache\_btn" >' . esc\_html\_\_( 'Clear cache', 'simple-local-avatars' ) . '</button><br/>'; |
| [877](#L877) | echo '<span id="clear\_cache\_message" style="font-style:italic;font-size:14px;line-height:2;"></span>'; |
| [878](#L878) | } |
| [879](#L879) |  |
| [880](#L880) | // Output warning if needed. |
| [881](#L881) | if ( |
| [882](#L882) | SLA\_IS\_NETWORK // If network activated. |
| [883](#L883) | && $this->is\_enforced() // And in enforce mode. |
| [884](#L884) | && 'shared' === $args['key'] // And we are displaying the last setting. |
| [885](#L885) | ) { |
| [886](#L886) | echo ' |
| [887](#L887) | <div class="notice notice-warning inline"> |
| [888](#L888) | <p><strong>' . esc\_html\_\_( 'Simple Local Avatar settings are currently enforced across all sites on the network.', 'simple-local-avatars' ) . '</strong></p> |
| [889](#L889) | </div> |
| [890](#L890) | '; |
| [891](#L891) | } |
| [892](#L892) | } |
| [893](#L893) |  |
| [894](#L894) | /\*\* |
| [895](#L895) | \* Settings field for migrating avatars away from WP User Avatar |
| [896](#L896) | \*/ |
| [897](#L897) | public function migrate\_from\_wp\_user\_avatar\_settings\_field() { |
| [898](#L898) | printf( |
| [899](#L899) | '<p><button type="button" name="%1$s" id="%1$s" class="button button-secondary">%2$s</button></p><p class="%1$s-progress"></p>', |
| [900](#L900) | esc\_attr( 'simple-local-avatars-migrate-from-wp-user-avatar' ), |
| [901](#L901) | esc\_html\_\_( 'Migrate avatars from WP User Avatar to Simple Local Avatars', 'simple-local-avatars' ) |
| [902](#L902) | ); |
| [903](#L903) | } |
| [904](#L904) |  |
| [905](#L905) | /\*\* |
| [906](#L906) | \* Output new Avatar fields to user editing / profile screen |
| [907](#L907) | \* |
| [908](#L908) | \* @param object $profileuser User object |
| [909](#L909) | \*/ |
| [910](#L910) | public function edit\_user\_profile( $profileuser ) { |
| [911](#L911) | ?> |
| [912](#L912) | <div id="simple-local-avatar-section"> |
| [913](#L913) | <h3><?php esc\_html\_e( 'Avatar', 'simple-local-avatars' ); ?></h3> |
| [914](#L914) |  |
| [915](#L915) | <table class="form-table"> |
| [916](#L916) | <tr class="upload-avatar-row"> |
| [917](#L917) | <th scope="row"><label for="simple-local-avatar"><?php esc\_html\_e( 'Upload Avatar', 'simple-local-avatars' ); ?></label></th> |
| [918](#L918) | <td colspan="2"> |
| [919](#L919) | <div class="right-wrapper" style="display: flex; align-items: center;"> |
| [920](#L920) | <div id="simple-local-avatar-photo" class="image-container" style="width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; flex-direction: column;"> |
| [921](#L921) | <?php |
| [922](#L922) | add\_filter( 'pre\_option\_avatar\_rating', '\_\_return\_empty\_string' );     // ignore ratings here |
| [923](#L923) | echo get\_simple\_local\_avatar( $profileuser->ID ); |
| [924](#L924) | remove\_filter( 'pre\_option\_avatar\_rating', '\_\_return\_empty\_string' ); |
| [925](#L925) | ?> |
| [926](#L926) | <span class="spinner" id="simple-local-avatar-spinner"></span> |
| [927](#L927) | </div> |
| [928](#L928) | <div class="button-containet" style="padding-left: 20px;"> |
| [929](#L929) | <?php |
| [930](#L930) | $upload\_rights = current\_user\_can( 'upload\_files' ); |
| [931](#L931) | if ( ! $upload\_rights ) { |
| [932](#L932) | $upload\_rights = empty( $this->options['caps'] ); |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | if ( $upload\_rights ) { |
| [936](#L936) | do\_action( 'simple\_local\_avatar\_notices' ); |
| [937](#L937) | wp\_nonce\_field( 'simple\_local\_avatar\_nonce', '\_simple\_local\_avatar\_nonce', false ); |
| [938](#L938) | $remove\_url = add\_query\_arg( |
| [939](#L939) | array( |
| [940](#L940) | 'action'   => 'remove-simple-local-avatar', |
| [941](#L941) | 'user\_id'  => $profileuser->ID, |
| [942](#L942) | '\_wpnonce' => $this->remove\_nonce, |
| [943](#L943) | ) |
| [944](#L944) | ); |
| [945](#L945) | ?> |
| [946](#L946) | <?php |
| [947](#L947) | // if user is author and above hide the choose file option |
| [948](#L948) | // force them to use the WP Media Selector |
| [949](#L949) | // At FE, show the file input field regardless of the caps. |
| [950](#L950) | if ( ! is\_admin() || ! current\_user\_can( 'upload\_files' ) ) { |
| [951](#L951) | ?> |
| [952](#L952) | <p style="display: inline-block; width: 26em;"> |
| [953](#L953) | <span class="description"><?php esc\_html\_e( 'Choose an image from your computer:' ); ?></span><br /> |
| [954](#L954) | <input type="file" name="simple-local-avatar" id="simple-local-avatar" class="standard-text" /> |
| [955](#L955) | </p> |
| [956](#L956) | <?php } ?> |
| [957](#L957) | <p style="width: 28em"> |
| [958](#L958) | <?php if ( current\_user\_can( 'upload\_files' ) && did\_action( 'wp\_enqueue\_media' ) ) : ?> |
| [959](#L959) | <a href="#" class="button hide-if-no-js" id="simple-local-avatar-media"><?php esc\_html\_e( 'Choose from Media Library', 'simple-local-avatars' ); ?></a> &nbsp; |
| [960](#L960) | <?php endif; ?> |
| [961](#L961) | <a href="<?php echo esc\_url( $remove\_url ); ?>" class="button item-delete submitdelete deletion" id="simple-local-avatar-remove" <?php echo empty( $profileuser->simple\_local\_avatar ) ? ' style="display:none;"' : ''; ?>> |
| [962](#L962) | <?php esc\_html\_e( 'Remove local avatar', 'simple-local-avatars' ); ?> |
| [963](#L963) | </a> |
| [964](#L964) | </p> |
| [965](#L965) | <?php |
| [966](#L966) | } else { |
| [967](#L967) | if ( empty( $profileuser->simple\_local\_avatar ) ) { |
| [968](#L968) | echo '<span class="description">' . esc\_html\_\_( 'No local avatar is set. Set up your avatar at Gravatar.com.', 'simple-local-avatars' ) . '</span>'; |
| [969](#L969) | } else { |
| [970](#L970) | echo '<span class="description">' . esc\_html\_\_( 'You do not have media management permissions. To change your local avatar, contact the blog administrator.', 'simple-local-avatars' ) . '</span>'; |
| [971](#L971) | } |
| [972](#L972) | } |
| [973](#L973) | ?> |
| [974](#L974) | </div> |
| [975](#L975) | </div> |
| [976](#L976) | </td> |
| [977](#L977) | </tr> |
| [978](#L978) | <tr class="ratings-row"> |
| [979](#L979) | <th scope="row"><?php esc\_html\_e( 'Rating' ); ?></th> |
| [980](#L980) | <td colspan="2"> |
| [981](#L981) | <fieldset id="simple-local-avatar-ratings" <?php disabled( empty( $profileuser->simple\_local\_avatar ) ); ?>> |
| [982](#L982) | <legend class="screen-reader-text"><span><?php esc\_html\_e( 'Rating' ); ?></span></legend> |
| [983](#L983) | <?php |
| [984](#L984) | if ( empty( $profileuser->simple\_local\_avatar\_rating ) || ! array\_key\_exists( $profileuser->simple\_local\_avatar\_rating, $this->avatar\_ratings ) ) { |
| [985](#L985) | $profileuser->simple\_local\_avatar\_rating = 'G'; |
| [986](#L986) | } |
| [987](#L987) |  |
| [988](#L988) | foreach ( $this->avatar\_ratings as $key => $rating ) : |
| [989](#L989) | echo "\n\t<label><input type='radio' name='simple\_local\_avatar\_rating' value='" . esc\_attr( $key ) . "' " . checked( $profileuser->simple\_local\_avatar\_rating, $key, false ) . '/>' . esc\_html( $rating ) . '</label><br />'; |
| [990](#L990) | endforeach; |
| [991](#L991) | ?> |
| [992](#L992) | <p class="description"><?php esc\_html\_e( 'If the local avatar is inappropriate for this site, Gravatar will be attempted.', 'simple-local-avatars' ); ?></p> |
| [993](#L993) | </fieldset> |
| [994](#L994) | </td> |
| [995](#L995) | </tr> |
| [996](#L996) | </table> |
| [997](#L997) | </div> |
| [998](#L998) | <?php |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | /\*\* |
| [1002](#L1002) | \* Ensure that the profile form has proper encoding type |
| [1003](#L1003) | \*/ |
| [1004](#L1004) | public function user\_edit\_form\_tag() { |
| [1005](#L1005) | echo 'enctype="multipart/form-data"'; |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) | /\*\* |
| [1009](#L1009) | \* Saves avatar image to a user |
| [1010](#L1010) | \* |
| [1011](#L1011) | \* @param int|string $url\_or\_media\_id Local URL for avatar or ID of attachment |
| [1012](#L1012) | \* @param int        $user\_id         ID of user to assign image to |
| [1013](#L1013) | \*/ |
| [1014](#L1014) | public function assign\_new\_user\_avatar( $url\_or\_media\_id, $user\_id ) { |
| [1015](#L1015) | // delete the old avatar |
| [1016](#L1016) | $this->avatar\_delete( $user\_id ); // delete old images if successful. |
| [1017](#L1017) |  |
| [1018](#L1018) | $meta\_value = array(); |
| [1019](#L1019) |  |
| [1020](#L1020) | // set the new avatar |
| [1021](#L1021) | if ( is\_numeric( $url\_or\_media\_id ) ) { |
| [1022](#L1022) | $meta\_value['media\_id'] = $url\_or\_media\_id; |
| [1023](#L1023) | $url\_or\_media\_id        = wp\_get\_attachment\_url( $url\_or\_media\_id ); |
| [1024](#L1024) | } |
| [1025](#L1025) |  |
| [1026](#L1026) | $meta\_value['full']    = $url\_or\_media\_id; |
| [1027](#L1027) | $meta\_value['blog\_id'] = get\_current\_blog\_id(); |
| [1028](#L1028) |  |
| [1029](#L1029) | update\_user\_meta( $user\_id, $this->user\_key, $meta\_value ); // save user information (overwriting old). |
| [1030](#L1030) |  |
| [1031](#L1031) | /\*\* |
| [1032](#L1032) | \* Enable themes and other plugins to react to changes to a user's avatar. |
| [1033](#L1033) | \* |
| [1034](#L1034) | \* @since 2.6.0 |
| [1035](#L1035) | \* |
| [1036](#L1036) | \* @param int $user\_id Id of the user who's avatar was updated |
| [1037](#L1037) | \*/ |
| [1038](#L1038) | do\_action( 'simple\_local\_avatar\_updated' , $user\_id ); |
| [1039](#L1039) | } |
| [1040](#L1040) |  |
| [1041](#L1041) | /\*\* |
| [1042](#L1042) | \* Save any changes to the user profile |
| [1043](#L1043) | \* |
| [1044](#L1044) | \* @param int $user\_id ID of user being updated |
| [1045](#L1045) | \*/ |
| [1046](#L1046) | public function edit\_user\_profile\_update( $user\_id ) { |
| [1047](#L1047) | // check nonces |
| [1048](#L1048) | if ( empty( $\_POST['\_simple\_local\_avatar\_nonce'] ) || ! wp\_verify\_nonce( $\_POST['\_simple\_local\_avatar\_nonce'], 'simple\_local\_avatar\_nonce' ) ) { |
| [1049](#L1049) | return; |
| [1050](#L1050) | } |
| [1051](#L1051) |  |
| [1052](#L1052) | // check for uploaded files |
| [1053](#L1053) | if ( ! empty( $\_FILES['simple-local-avatar']['name'] ) && 0 === $\_FILES['simple-local-avatar']['error'] ) : |
| [1054](#L1054) |  |
| [1055](#L1055) | // need to be more secure since low privilege users can upload |
| [1056](#L1056) | $allowed\_mime\_types = wp\_get\_mime\_types(); |
| [1057](#L1057) | $file\_mime\_type     = strtolower( $\_FILES['simple-local-avatar']['type'] ); |
| [1058](#L1058) |  |
| [1059](#L1059) | if ( ! ( 0 === strpos( $file\_mime\_type, 'image/' ) ) || ! in\_array( $file\_mime\_type, $allowed\_mime\_types, true ) ) { |
| [1060](#L1060) | $this->avatar\_upload\_error = \_\_( 'Only images can be uploaded as an avatar', 'simple-local-avatars' ); |
| [1061](#L1061) | add\_action( 'user\_profile\_update\_errors', array( $this, 'user\_profile\_update\_errors' ) ); |
| [1062](#L1062) | return; |
| [1063](#L1063) | } |
| [1064](#L1064) |  |
| [1065](#L1065) | $max\_upload\_size = $this->upload\_size\_limit( wp\_max\_upload\_size() ); |
| [1066](#L1066) | if ( $\_FILES['simple-local-avatar']['size'] > $max\_upload\_size ) { |
| [1067](#L1067) | $this->avatar\_upload\_error = sprintf( \_\_( 'Max allowed avatar size is %s', 'simple-local-avatars' ), size\_format( $max\_upload\_size ) ); |
| [1068](#L1068) | add\_action( 'user\_profile\_update\_errors', array( $this, 'user\_profile\_update\_errors' ) ); |
| [1069](#L1069) | return; |
| [1070](#L1070) | } |
| [1071](#L1071) |  |
| [1072](#L1072) | // front end (theme my profile etc) support |
| [1073](#L1073) | if ( ! function\_exists( 'media\_handle\_upload' ) ) { |
| [1074](#L1074) | include\_once ABSPATH . 'wp-admin/includes/media.php'; |
| [1075](#L1075) | } |
| [1076](#L1076) |  |
| [1077](#L1077) | // front end (plugin bbPress etc) support |
| [1078](#L1078) | if ( ! function\_exists( 'wp\_handle\_upload' ) ) { |
| [1079](#L1079) | include\_once ABSPATH . 'wp-admin/includes/file.php'; |
| [1080](#L1080) | } |
| [1081](#L1081) | if ( ! function\_exists( 'wp\_generate\_attachment\_metadata' ) ) { |
| [1082](#L1082) | include\_once ABSPATH . 'wp-admin/includes/image.php'; |
| [1083](#L1083) | } |
| [1084](#L1084) |  |
| [1085](#L1085) | $this->user\_id\_being\_edited = $user\_id; // make user\_id known to unique\_filename\_callback function |
| [1086](#L1086) | $avatar\_id                  = media\_handle\_upload( |
| [1087](#L1087) | 'simple-local-avatar', |
| [1088](#L1088) | 0, |
| [1089](#L1089) | array(), |
| [1090](#L1090) | array( |
| [1091](#L1091) | 'mimes'                    => array( |
| [1092](#L1092) | 'jpg|jpeg|jpe' => 'image/jpeg', |
| [1093](#L1093) | 'gif'          => 'image/gif', |
| [1094](#L1094) | 'png'          => 'image/png', |
| [1095](#L1095) | ), |
| [1096](#L1096) | 'test\_form'                => false, |
| [1097](#L1097) | 'unique\_filename\_callback' => array( $this, 'unique\_filename\_callback' ), |
| [1098](#L1098) | ) |
| [1099](#L1099) | ); |
| [1100](#L1100) |  |
| [1101](#L1101) | if ( is\_wp\_error( $avatar\_id ) ) { // handle failures. |
| [1102](#L1102) | $this->avatar\_upload\_error = '<strong>' . \_\_( 'There was an error uploading the avatar:', 'simple-local-avatars' ) . '</strong> ' . esc\_html( $avatar\_id->get\_error\_message() ); |
| [1103](#L1103) | add\_action( 'user\_profile\_update\_errors', array( $this, 'user\_profile\_update\_errors' ) ); |
| [1104](#L1104) |  |
| [1105](#L1105) | return; |
| [1106](#L1106) | } |
| [1107](#L1107) |  |
| [1108](#L1108) | $this->assign\_new\_user\_avatar( $avatar\_id, $user\_id ); |
| [1109](#L1109) |  |
| [1110](#L1110) | endif; |
| [1111](#L1111) |  |
| [1112](#L1112) | // Handle ratings |
| [1113](#L1113) | if ( isset( $avatar\_id ) || get\_user\_meta( $user\_id, $this->user\_key, true ) ) { |
| [1114](#L1114) | if ( empty( $\_POST['simple\_local\_avatar\_rating'] ) || ! array\_key\_exists( $\_POST['simple\_local\_avatar\_rating'], $this->avatar\_ratings ) ) { |
| [1115](#L1115) | $\_POST['simple\_local\_avatar\_rating'] = key( $this->avatar\_ratings ); |
| [1116](#L1116) | } |
| [1117](#L1117) |  |
| [1118](#L1118) | update\_user\_meta( $user\_id, $this->rating\_key, $\_POST['simple\_local\_avatar\_rating'] ); |
| [1119](#L1119) | } |
| [1120](#L1120) | } |
| [1121](#L1121) |  |
| [1122](#L1122) | /\*\* |
| [1123](#L1123) | \* Allow developers to override the maximum allowable file size for avatar uploads |
| [1124](#L1124) | \* |
| [1125](#L1125) | \* @param  int $bytes WordPress default byte size check |
| [1126](#L1126) | \* @return int Maximum byte size |
| [1127](#L1127) | \*/ |
| [1128](#L1128) | public function upload\_size\_limit( $bytes ) { |
| [1129](#L1129) | return apply\_filters( 'simple\_local\_avatars\_upload\_limit', $bytes ); |
| [1130](#L1130) | } |
| [1131](#L1131) |  |
| [1132](#L1132) | /\*\* |
| [1133](#L1133) | \* Runs when a user clicks the Remove button for the avatar |
| [1134](#L1134) | \*/ |
| [1135](#L1135) | public function action\_remove\_simple\_local\_avatar() { |
| [1136](#L1136) | if ( ! empty( $\_GET['user\_id'] ) && ! empty( $\_GET['\_wpnonce'] ) && wp\_verify\_nonce( $\_GET['\_wpnonce'], 'remove\_simple\_local\_avatar\_nonce' ) ) { |
| [1137](#L1137) | $user\_id = (int) $\_GET['user\_id']; |
| [1138](#L1138) |  |
| [1139](#L1139) | if ( ! current\_user\_can( 'edit\_user', $user\_id ) ) { |
| [1140](#L1140) | wp\_die( esc\_html\_\_( 'You do not have permission to edit this user.', 'simple-local-avatars' ) ); |
| [1141](#L1141) | } |
| [1142](#L1142) |  |
| [1143](#L1143) | $this->avatar\_delete( $user\_id );    // delete old images if successful |
| [1144](#L1144) |  |
| [1145](#L1145) | if ( defined( 'DOING\_AJAX' ) && DOING\_AJAX ) { |
| [1146](#L1146) | echo get\_simple\_local\_avatar( $user\_id ); |
| [1147](#L1147) | } |
| [1148](#L1148) | } |
| [1149](#L1149) |  |
| [1150](#L1150) | if ( defined( 'DOING\_AJAX' ) && DOING\_AJAX ) { |
| [1151](#L1151) | die; |
| [1152](#L1152) | } |
| [1153](#L1153) | } |
| [1154](#L1154) |  |
| [1155](#L1155) | /\*\* |
| [1156](#L1156) | \* AJAX callback for assigning media ID fetched from media library to user |
| [1157](#L1157) | \*/ |
| [1158](#L1158) | public function ajax\_assign\_simple\_local\_avatar\_media() { |
| [1159](#L1159) | // check required information and permissions |
| [1160](#L1160) | if ( empty( $\_POST['user\_id'] ) || empty( $\_POST['media\_id'] ) || ! current\_user\_can( 'upload\_files' ) || ! current\_user\_can( 'edit\_user', $\_POST['user\_id'] ) || empty( $\_POST['\_wpnonce'] ) || ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'assign\_simple\_local\_avatar\_nonce' ) ) { |
| [1161](#L1161) | die; |
| [1162](#L1162) | } |
| [1163](#L1163) |  |
| [1164](#L1164) | $media\_id = (int) $\_POST['media\_id']; |
| [1165](#L1165) | $user\_id  = (int) $\_POST['user\_id']; |
| [1166](#L1166) |  |
| [1167](#L1167) | // ensure the media is real is an image |
| [1168](#L1168) | if ( wp\_attachment\_is\_image( $media\_id ) ) { |
| [1169](#L1169) | $this->assign\_new\_user\_avatar( $media\_id, $user\_id ); |
| [1170](#L1170) | } |
| [1171](#L1171) |  |
| [1172](#L1172) | echo get\_simple\_local\_avatar( $user\_id ); |
| [1173](#L1173) |  |
| [1174](#L1174) | die; |
| [1175](#L1175) | } |
| [1176](#L1176) |  |
| [1177](#L1177) | /\*\* |
| [1178](#L1178) | \* Delete avatars based on a user\_id |
| [1179](#L1179) | \* |
| [1180](#L1180) | \* @param int $user\_id User ID. |
| [1181](#L1181) | \*/ |
| [1182](#L1182) | public function avatar\_delete( $user\_id ) { |
| [1183](#L1183) | $old\_avatars = (array) get\_user\_meta( $user\_id, $this->user\_key, true ); |
| [1184](#L1184) |  |
| [1185](#L1185) | if ( empty( $old\_avatars ) ) { |
| [1186](#L1186) | return; |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | // if it was uploaded media, don't erase the full size or try to erase an the ID |
| [1190](#L1190) | if ( array\_key\_exists( 'media\_id', $old\_avatars ) ) { |
| [1191](#L1191) | unset( $old\_avatars['media\_id'], $old\_avatars['full'] ); |
| [1192](#L1192) | } |
| [1193](#L1193) |  |
| [1194](#L1194) | if ( ! empty( $old\_avatars ) ) { |
| [1195](#L1195) | $upload\_path = wp\_upload\_dir(); |
| [1196](#L1196) |  |
| [1197](#L1197) | foreach ( $old\_avatars as $old\_avatar ) { |
| [1198](#L1198) | // derive the path for the file based on the upload directory |
| [1199](#L1199) | $old\_avatar\_path = str\_replace( $upload\_path['baseurl'], $upload\_path['basedir'], $old\_avatar ); |
| [1200](#L1200) | if ( file\_exists( $old\_avatar\_path ) ) { |
| [1201](#L1201) | unlink( $old\_avatar\_path ); |
| [1202](#L1202) | } |
| [1203](#L1203) | } |
| [1204](#L1204) | } |
| [1205](#L1205) |  |
| [1206](#L1206) | delete\_user\_meta( $user\_id, $this->user\_key ); |
| [1207](#L1207) | delete\_user\_meta( $user\_id, $this->rating\_key ); |
| [1208](#L1208) |  |
| [1209](#L1209) | /\*\* |
| [1210](#L1210) | \* Enable themes and other plugins to react to avatar deletions. |
| [1211](#L1211) | \* |
| [1212](#L1212) | \* @since 2.6.0 |
| [1213](#L1213) | \* |
| [1214](#L1214) | \* @param int $user\_id Id of the user who's avatar was deleted. |
| [1215](#L1215) | \*/ |
| [1216](#L1216) | do\_action( 'simple\_local\_avatar\_deleted', $user\_id ); |
| [1217](#L1217) | } |
| [1218](#L1218) |  |
| [1219](#L1219) | /\*\* |
| [1220](#L1220) | \* Creates a unique, meaningful file name for uploaded avatars. |
| [1221](#L1221) | \* |
| [1222](#L1222) | \* @param  string $dir  Path for file |
| [1223](#L1223) | \* @param  string $name Filename |
| [1224](#L1224) | \* @param  string $ext  File extension (e.g. ".jpg") |
| [1225](#L1225) | \* @return string Final filename |
| [1226](#L1226) | \*/ |
| [1227](#L1227) | public function unique\_filename\_callback( $dir, $name, $ext ) { |
| [1228](#L1228) | $user = get\_user\_by( 'id', (int) $this->user\_id\_being\_edited ); |
| [1229](#L1229) | $name = $base\_name = sanitize\_file\_name( $user->display\_name . '\_avatar\_' . time() ); //phpcs:ignore |
| [1230](#L1230) |  |
| [1231](#L1231) | // ensure no conflicts with existing file names |
| [1232](#L1232) | $number = 1; |
| [1233](#L1233) | while ( file\_exists( $dir . "/$name$ext" ) ) { |
| [1234](#L1234) | $name = $base\_name . '\_' . $number; |
| [1235](#L1235) | $number ++; |
| [1236](#L1236) | } |
| [1237](#L1237) |  |
| [1238](#L1238) | return $name . $ext; |
| [1239](#L1239) | } |
| [1240](#L1240) |  |
| [1241](#L1241) | /\*\* |
| [1242](#L1242) | \* Adds errors based on avatar upload problems. |
| [1243](#L1243) | \* |
| [1244](#L1244) | \* @param WP\_Error $errors Error messages for user profile screen. |
| [1245](#L1245) | \*/ |
| [1246](#L1246) | public function user\_profile\_update\_errors( WP\_Error $errors ) { |
| [1247](#L1247) | $errors->add( 'avatar\_error', $this->avatar\_upload\_error ); |
| [1248](#L1248) | } |
| [1249](#L1249) |  |
| [1250](#L1250) | /\*\* |
| [1251](#L1251) | \* Registers the simple\_local\_avatar field in the REST API. |
| [1252](#L1252) | \*/ |
| [1253](#L1253) | public function register\_rest\_fields() { |
| [1254](#L1254) | register\_rest\_field( |
| [1255](#L1255) | 'user', |
| [1256](#L1256) | 'simple\_local\_avatar', |
| [1257](#L1257) | array( |
| [1258](#L1258) | 'get\_callback'    => array( $this, 'get\_avatar\_rest' ), |
| [1259](#L1259) | 'update\_callback' => array( $this, 'set\_avatar\_rest' ), |
| [1260](#L1260) | 'schema'          => array( |
| [1261](#L1261) | 'description' => 'The users simple local avatar', |
| [1262](#L1262) | 'type'        => 'object', |
| [1263](#L1263) | ), |
| [1264](#L1264) | ) |
| [1265](#L1265) | ); |
| [1266](#L1266) | } |
| [1267](#L1267) |  |
| [1268](#L1268) | /\*\* |
| [1269](#L1269) | \* Returns the simple\_local\_avatar meta key for the given user. |
| [1270](#L1270) | \* |
| [1271](#L1271) | \* @param object $user User object |
| [1272](#L1272) | \*/ |
| [1273](#L1273) | public function get\_avatar\_rest( $user ) { |
| [1274](#L1274) | $local\_avatar = get\_user\_meta( $user['id'], $this->user\_key, true ); |
| [1275](#L1275) | if ( empty( $local\_avatar ) ) { |
| [1276](#L1276) | return; |
| [1277](#L1277) | } |
| [1278](#L1278) |  |
| [1279](#L1279) | return $local\_avatar; |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | /\*\* |
| [1283](#L1283) | \* Updates the simple local avatar from a REST request. |
| [1284](#L1284) | \* |
| [1285](#L1285) | \* Since we are just adding a field to the existing user endpoint |
| [1286](#L1286) | \* we don't need to worry about ensuring the calling user has proper permissions. |
| [1287](#L1287) | \* Only the user or an administrator would be able to change the avatar. |
| [1288](#L1288) | \* |
| [1289](#L1289) | \* @param array  $input Input submitted via REST request. |
| [1290](#L1290) | \* @param object $user  The user making the request. |
| [1291](#L1291) | \*/ |
| [1292](#L1292) | public function set\_avatar\_rest( $input, $user ) { |
| [1293](#L1293) | $this->assign\_new\_user\_avatar( $input['media\_id'], $user->ID ); |
| [1294](#L1294) | } |
| [1295](#L1295) |  |
| [1296](#L1296) | /\*\* |
| [1297](#L1297) | \* Short-circuit filter the `simple\_local\_avatars` option to match network if necessary |
| [1298](#L1298) | \* |
| [1299](#L1299) | \* @param bool $value Value of `simple\_local\_avatars` option, typically false. |
| [1300](#L1300) | \* |
| [1301](#L1301) | \* @return array |
| [1302](#L1302) | \*/ |
| [1303](#L1303) | public function pre\_option\_simple\_local\_avatars( $value ) { |
| [1304](#L1304) | if ( SLA\_IS\_NETWORK && 'enforce' === $this->get\_network\_mode() ) { |
| [1305](#L1305) | $value = get\_site\_option( 'simple\_local\_avatars', array() ); |
| [1306](#L1306) | } |
| [1307](#L1307) |  |
| [1308](#L1308) | return $value; |
| [1309](#L1309) | } |
| [1310](#L1310) |  |
| [1311](#L1311) | /\*\* |
| [1312](#L1312) | \* Set plugin defaults for a new site |
| [1313](#L1313) | \* |
| [1314](#L1314) | \* @param int|WP\_Site $blog\_id Blog ID or object. |
| [1315](#L1315) | \*/ |
| [1316](#L1316) | public function set\_defaults( $blog\_id ) { |
| [1317](#L1317) | if ( 'enforce' === $this->get\_network\_mode() ) { |
| [1318](#L1318) | return; |
| [1319](#L1319) | } |
| [1320](#L1320) |  |
| [1321](#L1321) | if ( $blog\_id instanceof WP\_Site ) { |
| [1322](#L1322) | $blog\_id = (int) $blog\_id->blog\_id; |
| [1323](#L1323) | } |
| [1324](#L1324) |  |
| [1325](#L1325) | switch\_to\_blog( $blog\_id ); |
| [1326](#L1326) | update\_option( 'simple\_local\_avatars', $this->sanitize\_options( $this->options ) ); |
| [1327](#L1327) | restore\_current\_blog(); |
| [1328](#L1328) | } |
| [1329](#L1329) |  |
| [1330](#L1330) | /\*\* |
| [1331](#L1331) | \* Add some basic styling on the Discussion page |
| [1332](#L1332) | \*/ |
| [1333](#L1333) | public function admin\_print\_styles() { |
| [1334](#L1334) | ?> |
| [1335](#L1335) | <style> |
| [1336](#L1336) | .sla-enforced .simple-local-avatars th, |
| [1337](#L1337) | .sla-enforced .simple-local-avatars label { |
| [1338](#L1338) | opacity: 0.5; |
| [1339](#L1339) | pointer-events: none; |
| [1340](#L1340) | } |
| [1341](#L1341) |  |
| [1342](#L1342) | .sla-enforced .simple-local-avatars .notice { |
| [1343](#L1343) | margin-top: 20px; |
| [1344](#L1344) | } |
| [1345](#L1345) |  |
| [1346](#L1346) | @media screen and (min-width: 783px) { |
| [1347](#L1347) | .sla-enforced .simple-local-avatars .notice { |
| [1348](#L1348) | left: -220px; |
| [1349](#L1349) | position: relative; |
| [1350](#L1350) | } |
| [1351](#L1351) | } |
| [1352](#L1352) | </style> |
| [1353](#L1353) | <?php |
| [1354](#L1354) | } |
| [1355](#L1355) |  |
| [1356](#L1356) | /\*\* |
| [1357](#L1357) | \* Adds admin body classes to the Discussion options screen |
| [1358](#L1358) | \* |
| [1359](#L1359) | \* @param string $classes Space-separated list of classes to apply to the body element. |
| [1360](#L1360) | \* |
| [1361](#L1361) | \* @return string |
| [1362](#L1362) | \*/ |
| [1363](#L1363) | public function admin\_body\_class( $classes ) { |
| [1364](#L1364) | if ( $this->is\_enforced() ) { |
| [1365](#L1365) | $classes .= ' sla-enforced'; |
| [1366](#L1366) | } |
| [1367](#L1367) |  |
| [1368](#L1368) | return $classes; |
| [1369](#L1369) | } |
| [1370](#L1370) |  |
| [1371](#L1371) | /\*\* |
| [1372](#L1372) | \* Clear user cache. |
| [1373](#L1373) | \*/ |
| [1374](#L1374) | public function sla\_clear\_user\_cache() { |
| [1375](#L1375) | check\_ajax\_referer( 'sla\_clear\_cache\_nonce', 'nonce' ); |
| [1376](#L1376) | $step = isset( $\_REQUEST['step'] ) ? intval( $\_REQUEST['step'] ) : 1; |
| [1377](#L1377) |  |
| [1378](#L1378) | // Setup defaults. |
| [1379](#L1379) | $users\_per\_page = 50; |
| [1380](#L1380) | $offset         = ( $step - 1 ) \* $users\_per\_page; |
| [1381](#L1381) |  |
| [1382](#L1382) | $users\_query = new \WP\_User\_Query( |
| [1383](#L1383) | array( |
| [1384](#L1384) | 'fields' => array( 'ID' ), |
| [1385](#L1385) | 'number' => $users\_per\_page, |
| [1386](#L1386) | 'offset' => $offset, |
| [1387](#L1387) | ) |
| [1388](#L1388) | ); |
| [1389](#L1389) |  |
| [1390](#L1390) | // Total users in the site. |
| [1391](#L1391) | $total\_users = $users\_query->get\_total(); |
| [1392](#L1392) |  |
| [1393](#L1393) | // Get the users. |
| [1394](#L1394) | $users = $users\_query->get\_results(); |
| [1395](#L1395) |  |
| [1396](#L1396) | if ( ! empty( $users ) ) { |
| [1397](#L1397) | foreach ( $users as $user ) { |
| [1398](#L1398) | $user\_id       = $user->ID; |
| [1399](#L1399) | $local\_avatars = get\_user\_meta( $user\_id, 'simple\_local\_avatar', true ); |
| [1400](#L1400) | $media\_id      = isset( $local\_avatars['media\_id'] ) ? $local\_avatars['media\_id'] : ''; |
| [1401](#L1401) | $this->clear\_user\_avatar\_cache( $local\_avatars, $user\_id, $media\_id ); |
| [1402](#L1402) | } |
| [1403](#L1403) |  |
| [1404](#L1404) | wp\_send\_json\_success( |
| [1405](#L1405) | array( |
| [1406](#L1406) | 'step'    => $step + 1, |
| [1407](#L1407) | 'message' => sprintf( |
| [1408](#L1408) | /\* translators: 1: Offset, 2: Total users  \*/ |
| [1409](#L1409) | esc\_html\_\_( 'Processing %1$s/%2$s users...', 'simple-local-avatars' ), |
| [1410](#L1410) | $offset, |
| [1411](#L1411) | $total\_users |
| [1412](#L1412) | ), |
| [1413](#L1413) | ) |
| [1414](#L1414) | ); |
| [1415](#L1415) | } |
| [1416](#L1416) |  |
| [1417](#L1417) | wp\_send\_json\_success( |
| [1418](#L1418) | array( |
| [1419](#L1419) | 'step'    => 'done', |
| [1420](#L1420) | 'message' => sprintf( |
| [1421](#L1421) | /\* translators: %s Total users \*/ |
| [1422](#L1422) | esc\_html\_\_( 'Completed clearing cache for all %s user(s) avatars.', 'simple-local-avatars' ), |
| [1423](#L1423) | $total\_users |
| [1424](#L1424) | ), |
| [1425](#L1425) | ) |
| [1426](#L1426) | ); |
| [1427](#L1427) | } |
| [1428](#L1428) |  |
| [1429](#L1429) | /\*\* |
| [1430](#L1430) | \* Clear avatar cache for given user. |
| [1431](#L1431) | \* |
| [1432](#L1432) | \* @param array $local\_avatars Local avatars. |
| [1433](#L1433) | \* @param int   $user\_id       User ID. |
| [1434](#L1434) | \* @param mixed $media\_id      Media ID. |
| [1435](#L1435) | \*/ |
| [1436](#L1436) | private function clear\_user\_avatar\_cache( $local\_avatars, $user\_id, $media\_id ) { |
| [1437](#L1437) | if ( ! empty( $media\_id ) ) { |
| [1438](#L1438) | // In order to support WP 4.9. |
| [1439](#L1439) | if ( function\_exists( 'wp\_get\_original\_image\_path' ) ) { |
| [1440](#L1440) | $file\_name\_data = pathinfo( wp\_get\_original\_image\_path( $media\_id ) ); |
| [1441](#L1441) | } else { |
| [1442](#L1442) | $file\_name\_data = pathinfo( get\_attached\_file( $media\_id ) ); |
| [1443](#L1443) | } |
| [1444](#L1444) |  |
| [1445](#L1445) | $file\_dir\_name  = $file\_name\_data['dirname']; |
| [1446](#L1446) | $file\_name      = $file\_name\_data['filename']; |
| [1447](#L1447) | $file\_ext       = $file\_name\_data['extension']; |
| [1448](#L1448) | foreach ( $local\_avatars as $local\_avatars\_key => $local\_avatar\_value ) { |
| [1449](#L1449) | if ( ! in\_array( $local\_avatars\_key, [ 'media\_id', 'full' ], true ) ) { |
| [1450](#L1450) | $file\_size\_path = sprintf( '%1$s/%2$s-%3$sx%3$s.%4$s', $file\_dir\_name, $file\_name, $local\_avatars\_key, $file\_ext ); |
| [1451](#L1451) | if ( ! file\_exists( $file\_size\_path ) ) { |
| [1452](#L1452) | unset( $local\_avatars[ $local\_avatars\_key ] ); |
| [1453](#L1453) | } |
| [1454](#L1454) | } |
| [1455](#L1455) | } |
| [1456](#L1456) |  |
| [1457](#L1457) | // Update meta, remove sizes that don't exist. |
| [1458](#L1458) | update\_user\_meta( $user\_id, 'simple\_local\_avatar', $local\_avatars ); |
| [1459](#L1459) | } |
| [1460](#L1460) | } |
| [1461](#L1461) |  |
| [1462](#L1462) | /\*\* |
| [1463](#L1463) | \* Add default avatar upload file field. |
| [1464](#L1464) | \* |
| [1465](#L1465) | \* @param array $defaults Default options for avatar. |
| [1466](#L1466) | \* |
| [1467](#L1467) | \* @return array Default options of avatar. |
| [1468](#L1468) | \*/ |
| [1469](#L1469) | public function add\_avatar\_default\_field( $defaults ) { |
| [1470](#L1470) | $default\_avatar\_file\_url = ''; |
| [1471](#L1471) | $default\_avatar\_file\_id  = get\_option( 'simple\_local\_avatar\_default', '' ); |
| [1472](#L1472) | if ( ! empty( $default\_avatar\_file\_id ) ) { |
| [1473](#L1473) | $default\_avatar\_file\_url = wp\_get\_attachment\_image\_url( $default\_avatar\_file\_id ); |
| [1474](#L1474) | } |
| [1475](#L1475) | ob\_start(); |
| [1476](#L1476) | ?> |
| [1477](#L1477) | <input type="hidden" name="simple-local-avatar-file-id" id="simple-local-avatar-file-id" value="<?php echo ! empty( $default\_avatar\_file\_id ) ? esc\_attr( $default\_avatar\_file\_id ) : ''; ?>"/> |
| [1478](#L1478) | <input type="hidden" name="simple-local-avatar-file-url" id="simple-local-avatar-file-url" value="<?php echo ! empty( $default\_avatar\_file\_url ) ? esc\_url( $default\_avatar\_file\_url ) : ''; ?>"/> |
| [1479](#L1479) | <?php wp\_nonce\_field( 'simple\_local\_avatar\_default', 'simple-local-avatar-file-wpnonce' ); ?> |
| [1480](#L1480) | <input type="button" name="simple-local-avatar" id="simple-local-avatar-default" class="button-secondary" value="<?php esc\_attr\_e( 'Choose Default Avatar', 'simple-local-avatar' ); ?>"/> |
| [1481](#L1481) | <p class="description" style="margin-left: 23px;"><?php esc\_html\_e( 'Note that this avatar needs to be publicly available or a broken image will be shown.', 'simple-local-avatar' ); ?></p> |
| [1482](#L1482) | <?php |
| [1483](#L1483) | $defaults['simple\_local\_avatar'] = ob\_get\_clean(); |
| [1484](#L1484) |  |
| [1485](#L1485) | return $defaults; |
| [1486](#L1486) | } |
| [1487](#L1487) |  |
| [1488](#L1488) | /\*\* |
| [1489](#L1489) | \* Save default avatar attachment id in option. |
| [1490](#L1490) | \*/ |
| [1491](#L1491) | private function save\_default\_avatar\_file\_id() { |
| [1492](#L1492) | global $pagenow; |
| [1493](#L1493) |  |
| [1494](#L1494) | // Check if nonce is set. |
| [1495](#L1495) | if ( ! isset( $\_POST['simple-local-avatar-file-wpnonce'] ) || ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['simple-local-avatar-file-wpnonce'] ) ), 'simple\_local\_avatar\_default' ) ) { |
| [1496](#L1496) | return; |
| [1497](#L1497) | } |
| [1498](#L1498) |  |
| [1499](#L1499) | $file\_id = filter\_input( INPUT\_POST, 'simple-local-avatar-file-id', FILTER\_SANITIZE\_NUMBER\_INT ); |
| [1500](#L1500) |  |
| [1501](#L1501) | // check for uploaded files |
| [1502](#L1502) | if ( 'options.php' === $pagenow && ! empty( $file\_id ) ) { |
| [1503](#L1503) | update\_option( 'simple\_local\_avatar\_default', $file\_id ); |
| [1504](#L1504) | } |
| [1505](#L1505) | } |
| [1506](#L1506) |  |
| [1507](#L1507) | /\*\* |
| [1508](#L1508) | \* Migrate the user's avatar data from WP User Avatar/ProfilePress |
| [1509](#L1509) | \* |
| [1510](#L1510) | \* This function creates a new option in the wp\_options table to store the processed user IDs |
| [1511](#L1511) | \* so that we can run this command multiple times without processing the same user over and over again. |
| [1512](#L1512) | \* |
| [1513](#L1513) | \* Credit to Philip John for the Gist |
| [1514](#L1514) | \* |
| [1515](#L1515) | \* @see https://gist.github.com/philipjohn/822d3521a95481f6ad7e118a7106fbc7 |
| [1516](#L1516) | \* |
| [1517](#L1517) | \* @return int |
| [1518](#L1518) | \*/ |
| [1519](#L1519) | public function migrate\_from\_wp\_user\_avatar() { |
| [1520](#L1520) |  |
| [1521](#L1521) | global $wpdb; |
| [1522](#L1522) |  |
| [1523](#L1523) | $count = 0; |
| [1524](#L1524) |  |
| [1525](#L1525) | // Support single site and multisite installs. |
| [1526](#L1526) | // Use WordPress function if running multisite. |
| [1527](#L1527) | // Create generic class if running single site. |
| [1528](#L1528) | if ( is\_multisite() ) { |
| [1529](#L1529) | $sites = get\_sites(); |
| [1530](#L1530) | } else { |
| [1531](#L1531) | $site          = new stdClass(); |
| [1532](#L1532) | $site->blog\_id = 1; |
| [1533](#L1533) | $sites         = array( $site ); |
| [1534](#L1534) | } |
| [1535](#L1535) |  |
| [1536](#L1536) | // Bail early if we don't find sites. |
| [1537](#L1537) | if ( empty( $sites ) ) { |
| [1538](#L1538) | return $count; |
| [1539](#L1539) | } |
| [1540](#L1540) |  |
| [1541](#L1541) | foreach ( $sites as $site ) { |
| [1542](#L1542) | // Get the blog ID to use in the meta key and user query. |
| [1543](#L1543) | $blog\_id = isset( $site->blog\_id ) ? $site->blog\_id : 1; |
| [1544](#L1544) |  |
| [1545](#L1545) | // Get the name of the meta key for WP User Avatar. |
| [1546](#L1546) | $meta\_key = $wpdb->get\_blog\_prefix( $blog\_id ) . 'user\_avatar'; |
| [1547](#L1547) |  |
| [1548](#L1548) | // Get processed users from database. |
| [1549](#L1549) | $migrations      = get\_option( 'simple\_local\_avatars\_migrations', array() ); |
| [1550](#L1550) | $processed\_users = isset( $migrations['wp\_user\_avatar'] ) ? $migrations['wp\_user\_avatar'] : array(); |
| [1551](#L1551) |  |
| [1552](#L1552) | // Get all users that have a local avatar. |
| [1553](#L1553) | $users = get\_users( |
| [1554](#L1554) | array( |
| [1555](#L1555) | 'blog\_id'      => $blog\_id, |
| [1556](#L1556) | 'exclude'      => $processed\_users, |
| [1557](#L1557) | 'meta\_key'     => $meta\_key, |
| [1558](#L1558) | 'meta\_compare' => 'EXISTS', |
| [1559](#L1559) | ) |
| [1560](#L1560) | ); |
| [1561](#L1561) |  |
| [1562](#L1562) | // Bail early if we don't find users. |
| [1563](#L1563) | if ( empty( $users ) ) { |
| [1564](#L1564) | continue; |
| [1565](#L1565) | } |
| [1566](#L1566) |  |
| [1567](#L1567) | foreach ( $users as $user ) { |
| [1568](#L1568) | // Get the existing avatar media ID. |
| [1569](#L1569) | $avatar\_id = get\_user\_meta( $user->ID, $meta\_key, true ); |
| [1570](#L1570) |  |
| [1571](#L1571) | // Attach the user and media to Simple Local Avatars. |
| [1572](#L1572) | $sla = new Simple\_Local\_Avatars(); |
| [1573](#L1573) | $sla->assign\_new\_user\_avatar( (int) $avatar\_id, $user->ID ); |
| [1574](#L1574) |  |
| [1575](#L1575) | // Check that it worked. |
| [1576](#L1576) | $is\_migrated = get\_user\_meta( $user->ID, 'simple\_local\_avatar', true ); |
| [1577](#L1577) |  |
| [1578](#L1578) | if ( ! empty( $is\_migrated ) ) { |
| [1579](#L1579) | // Build array of user IDs. |
| [1580](#L1580) | $migrations['wp\_user\_avatar'][] = $user->ID; |
| [1581](#L1581) |  |
| [1582](#L1582) | // Record the user IDs so we don't process a second time. |
| [1583](#L1583) | $is\_saved = update\_option( 'simple\_local\_avatars\_migrations', $migrations ); |
| [1584](#L1584) |  |
| [1585](#L1585) | // Record how many avatars we migrate to be used in our messaging. |
| [1586](#L1586) | if ( $is\_saved ) { |
| [1587](#L1587) | $count ++; |
| [1588](#L1588) | } |
| [1589](#L1589) | } |
| [1590](#L1590) | } |
| [1591](#L1591) | } |
| [1592](#L1592) |  |
| [1593](#L1593) | return $count; |
| [1594](#L1594) | } |
| [1595](#L1595) |  |
| [1596](#L1596) | /\*\* |
| [1597](#L1597) | \* Migrate the user's avatar data away from WP User Avatar/ProfilePress via the dashboard. |
| [1598](#L1598) | \* |
| [1599](#L1599) | \* Sends the number of avatars processed back to the AJAX response before stopping execution. |
| [1600](#L1600) | \* |
| [1601](#L1601) | \* @return void |
| [1602](#L1602) | \*/ |
| [1603](#L1603) | public function ajax\_migrate\_from\_wp\_user\_avatar() { |
| [1604](#L1604) | // Bail early if nonce is not available. |
| [1605](#L1605) | if ( empty( sanitize\_text\_field( $\_POST['migrateFromWpUserAvatarNonce'] ) ) ) { |
| [1606](#L1606) | die; |
| [1607](#L1607) | } |
| [1608](#L1608) |  |
| [1609](#L1609) | // Bail early if nonce is invalid. |
| [1610](#L1610) | if ( ! wp\_verify\_nonce( sanitize\_text\_field( $\_POST['migrateFromWpUserAvatarNonce'] ), 'migrate\_from\_wp\_user\_avatar\_nonce' ) ) { |
| [1611](#L1611) | die(); |
| [1612](#L1612) | } |
| [1613](#L1613) |  |
| [1614](#L1614) | // Run the migration script and store the number of avatars processed. |
| [1615](#L1615) | $count = $this->migrate\_from\_wp\_user\_avatar(); |
| [1616](#L1616) |  |
| [1617](#L1617) | // Create the array we send back to javascript here. |
| [1618](#L1618) | $array\_we\_send\_back = array( 'count' => $count ); |
| [1619](#L1619) |  |
| [1620](#L1620) | // Make sure to json encode the output because that's what it is expecting. |
| [1621](#L1621) | echo wp\_json\_encode( $array\_we\_send\_back ); |
| [1622](#L1622) |  |
| [1623](#L1623) | // Make sure you die when finished doing ajax output. |
| [1624](#L1624) | wp\_die(); |
| [1625](#L1625) |  |
| [1626](#L1626) | } |
| [1627](#L1627) |  |
| [1628](#L1628) | /\*\* |
| [1629](#L1629) | \* Migrate the user's avatar data from WP User Avatar/ProfilePress via the command line. |
| [1630](#L1630) | \* |
| [1631](#L1631) | \* ## OPTIONS |
| [1632](#L1632) | \* |
| [1633](#L1633) | \* [--yes] |
| [1634](#L1634) | \* : Skips the confirmations (for automated systems). |
| [1635](#L1635) | \* |
| [1636](#L1636) | \* ## EXAMPLES |
| [1637](#L1637) | \* |
| [1638](#L1638) | \*     $ wp simple-local-avatars migrate wp-user-avatar |
| [1639](#L1639) | \*     Success: Number of avatars successfully migrated from WP User Avatar: 5 |
| [1640](#L1640) | \* |
| [1641](#L1641) | \* @param array $args       The arguments. |
| [1642](#L1642) | \* @param array $assoc\_args The associative arguments. |
| [1643](#L1643) | \* |
| [1644](#L1644) | \* @return void |
| [1645](#L1645) | \*/ |
| [1646](#L1646) | public function wp\_cli\_migrate\_from\_wp\_user\_avatar( $args, $assoc\_args ) { |
| [1647](#L1647) |  |
| [1648](#L1648) | // Argument --yes to prevent confirmation (for automated systems). |
| [1649](#L1649) | if ( ! isset( $assoc\_args['yes'] ) ) { |
| [1650](#L1650) | WP\_CLI::confirm( esc\_html\_\_( 'Do you want to migrate avatars from WP User Avatar?', 'simple-local-avatars' ) ); |
| [1651](#L1651) | } |
| [1652](#L1652) |  |
| [1653](#L1653) | // Run the migration script and store the number of avatars processed. |
| [1654](#L1654) | $count = $this->migrate\_from\_wp\_user\_avatar(); |
| [1655](#L1655) |  |
| [1656](#L1656) | // Error out if we don't process any avatars. |
| [1657](#L1657) | if ( 0 === absint( $count ) ) { |
| [1658](#L1658) | WP\_CLI::error( esc\_html\_\_( 'No avatars were migrated from WP User Avatar.', 'simple-local-avatars' ) ); |
| [1659](#L1659) | } |
| [1660](#L1660) |  |
| [1661](#L1661) | WP\_CLI::success( |
| [1662](#L1662) | sprintf( |
| [1663](#L1663) | '%s: %s', |
| [1664](#L1664) | esc\_html\_\_( 'Number of avatars successfully migrated from WP User Avatar', 'simple-local-avatars' ), |
| [1665](#L1665) | esc\_html( $count ) |
| [1666](#L1666) | ) |
| [1667](#L1667) | ); |
| [1668](#L1668) | } |
| [1669](#L1669) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/simple-local-avatars/tags/2.7.11/includes/class-simple-local-avatars.php?format=txt)
* [Original Format](/export/3222486/simple-local-avatars/tags/2.7.11/includes/class-simple-local-avatars.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_09add18b_20250114_220607.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Simple Local Avatars <= 2.7.11 - Missing Authorization to Authenticated (Subscriber+) User Cache Clearing

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Simple Local Avatars <= 2.7.11 - Missing Authorization to Authenticated (Subscriber+) User Cache Clearing

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-10786](https://www.cve.org/CVERecord?id=CVE-2024-10786) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | November 15, 2024 |
| Last Updated | November 16, 2024 |
| Researcher | [Trương Hữu Phúc (truonghuuphuc)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/phuc-truong-huu) |

### Description

The Simple Local Avatars plugin for WordPress is vulnerable to unauthorized modification of datadue to a missing capability check on the sla\_clear\_user\_cache function in all versions up to, and including, 2.7.11. This makes it possible for authenticated attackers, with Subscriber-level access and above, to clear user caches.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/simple-local-avatars/tags/2.7.11/includes/class-simple-local-avatars.php#L1374)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3186674/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsimple-local-avatars%2Fsimple-local-avatars-2711-missing-authorization-to-authenticated-subscriber-user-cache-clearing&t=Simple%20Local%20Avatars%20%3C%3D%202.7.11%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20User%20Cache%20Clearing "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsimple-local-avatars%2Fsimple-local-avatars-2711-missing-authorization-to-authenticated-subscriber-user-cache-clearing&text=Simple%20Local%20Avatars%20%3C%3D%202.7.11%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20User%20Cache%20Clearing "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsimple-local-avatars%2Fsimple-local-avatars-2711-missing-authorization-to-authenticated-subscriber-user-cache-clearing "LinkedIn")
Email

## Vulnerability Details for Simple Local Avatars

#### [Simple Local Avatars](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/simple-local-avatars)

| Software Type | Plugin |
| --- | --- |
| Software Slug | simple-local-avatars [(view on wordpress.org)](https://wordpress.org/plugins/simple-local-avatars) |
| Patched? | Yes |
| Remediation | Update to version 2.8.0, or a newer patched version |
| Affected Version | * <= 2.7.11 |
| Patched Version | * 2.8.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_0231900d_20250114_220606.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3186674%2Fsimple-local-avatars%2Ftags%2F2.8.0%2Fincludes%2Fclass-simple-local-avatars.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3121647/simple-local-avatars/trunk/includes/class-simple-local-avatars.php "Changeset 3121647 for simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php")
* Next Change →

---

# Changeset [3186674](/changeset/3186674 "Show full changeset") for [simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
11/12/2024 06:18:30 PM
([2 months](/timeline?from=2024-11-12T18%3A18%3A30Z&precision=second "See timeline at 11/12/2024 06:18:30 PM") ago)

Author:
10up
Message:

Update to version 2.8.0 from GitHub

Location:
[simple-local-avatars/tags/2.8.0](/browser/simple-local-avatars/tags/2.8.0?rev=3186674)
Files:

1 edited
1 copied

* [.](/browser/simple-local-avatars/tags/2.8.0?rev=3186674 "Show entry in browser")
  (copied)
  *(copied from [simple-local-avatars/trunk](/browser/simple-local-avatars/trunk?rev=3184095 "Show original file (revision 3186673)"))*
* [includes/class-simple-local-avatars.php](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674 "Show entry in browser")
  (modified)
  ([20 diffs](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php](/changeset/3186674/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php "Show the changeset 3186674 restricted to simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php")

  | [r3121647](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L66 "Show revision 3121647 of this file in browser") | [r3186674](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L66 "Show revision 3186674 of this file in browser") |  |
  | --- | --- | --- |
  | 66 | 66 | $this->add\_hooks(); |
  | 67 | 67 |  |
  | 68 |  | $this->options    = (array) get\_option( 'simple\_local\_avatars' ); |
  | 69 |  | $this->user\_key   = 'simple\_local\_avatar'; |
  | 70 |  | $this->rating\_key = 'simple\_local\_avatar\_rating'; |
  |  | 68 | $this->options    = (array) get\_option( 'simple\_local\_avatars' ); |
  |  | 69 | $this->user\_key   = 'simple\_local\_avatar'; |
  |  | 70 | $this->rating\_key = 'simple\_local\_avatar\_rating'; |
  | 71 | 71 |  |
  | 72 | 72 | if ( |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L328) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L328) |  |
  | 328 | 328 |  |
  | 329 | 329 | /\*\* |
  |  | 330 | \* Get the local avatar user meta. |
  |  | 331 | \* |
  |  | 332 | \* @param int $user\_id User ID. |
  |  | 333 | \* @return array Array with avatar data. |
  |  | 334 | \*/ |
  |  | 335 | public function get\_user\_local\_avatar( $user\_id ) { |
  |  | 336 | $local\_avatars = get\_user\_meta( $user\_id, $this->user\_key, true ); |
  |  | 337 | if ( ! is\_array( $local\_avatars ) || empty( $local\_avatars ) ) { |
  |  | 338 | return []; |
  |  | 339 | } |
  |  | 340 | return $local\_avatars; |
  |  | 341 | } |
  |  | 342 |  |
  |  | 343 | /\*\* |
  | 330 | 344 | \* Get local avatar url. |
  | 331 | 345 | \* |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L344) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L358) |  |
  | 344 | 358 |  |
  | 345 | 359 | // Fetch local avatar from meta and make sure it's properly set. |
  | 346 |  | $local\_avatars = ~~get\_user\_meta( $user\_id, $this->user\_key, true~~ ); |
  | 347 |  | if ( empty( $local\_avatars['full'] ) ) { |
  |  | 360 | $local\_avatars = $this->get\_user\_local\_avatar( $user\_id ); |
  |  | 361 | if ( ! isset( $local\_avatars['full'] ) || empty( $local\_avatars['full'] ) ) { |
  | 348 | 362 | return ''; |
  | 349 | 363 | } |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L433) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L447) |  |
  | 433 | 447 | if ( false !== strpos( $dest\_file, $upload\_path['basedir'] ) ) { |
  | 434 | 448 | $dest\_file\_url = str\_replace( $upload\_path['basedir'], $upload\_path['baseurl'], $dest\_file ); |
  | 435 |  | } elseif ( is\_multisite() && false !== strpos( $dest\_file, ABSPATH . 'wp-content/uploads' ) ) { |
  |  | 449 | } elseif ( is\_multisite() && false !== strpos( $dest\_file, ABSPATH . 'wp-content/uploads' ) ) { |
  | 436 | 450 | $dest\_file\_url = str\_replace( ABSPATH . 'wp-content/uploads', network\_site\_url( '/wp-content/uploads' ), $dest\_file ); |
  | 437 | 451 | } |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L480) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L494) |  |
  | 480 | 494 |  |
  | 481 | 495 | // Fetch local avatar from meta and make sure we have a media ID. |
  | 482 |  | $local\_avatars = ~~get\_user\_meta( $user\_id, 'simple\_local\_avatar', true~~ ); |
  | 483 |  | if ( empty( $local\_avatars['media\_id'] ) ) { |
  |  | 496 | $local\_avatars = $this->get\_user\_local\_avatar( $user\_id ); |
  |  | 497 | if ( ! isset( $local\_avatars['media\_id'] ) || empty( $local\_avatars['media\_id'] ) ) { |
  | 484 | 498 | $alt = ''; |
  | 485 | 499 | // If no avatar is set, check if we are using a default avatar with alt text. |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L558) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L572) |  |
  | 558 | 572 | $this->avatar\_ratings = array( |
  | 559 | 573 | /\* translators: Content suitability rating: https://en.wikipedia.org/wiki/Motion\_Picture\_Association\_of\_America\_film\_rating\_system \*/ |
  | 560 |  | 'G'  => \_\_( 'G &#8212; Suitable for all audiences' ), |
  |  | 574 | 'G'  => \_\_( 'G &#8212; Suitable for all audiences', 'simple-local-avatars' ), |
  | 561 | 575 | /\* translators: Content suitability rating: https://en.wikipedia.org/wiki/Motion\_Picture\_Association\_of\_America\_film\_rating\_system \*/ |
  | 562 |  | 'PG' => \_\_( 'PG &#8212; Possibly offensive, usually for audiences 13 and above' ), |
  |  | 576 | 'PG' => \_\_( 'PG &#8212; Possibly offensive, usually for audiences 13 and above', 'simple-local-avatars' ), |
  | 563 | 577 | /\* translators: Content suitability rating: https://en.wikipedia.org/wiki/Motion\_Picture\_Association\_of\_America\_film\_rating\_system \*/ |
  | 564 |  | 'R'  => \_\_( 'R &#8212; Intended for adult audiences above 17' ), |
  |  | 578 | 'R'  => \_\_( 'R &#8212; Intended for adult audiences above 17', 'simple-local-avatars' ), |
  | 565 | 579 | /\* translators: Content suitability rating: https://en.wikipedia.org/wiki/Motion\_Picture\_Association\_of\_America\_film\_rating\_system \*/ |
  | 566 |  | 'X'  => \_\_( 'X &#8212; Even more mature than above' ), |
  |  | 580 | 'X'  => \_\_( 'X &#8212; Even more mature than above', 'simple-local-avatars' ), |
  | 567 | 581 | ); |
  | 568 | 582 | } |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L703) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L717) |  |
  | 703 | 717 | array( |
  | 704 | 718 | 'key'  => 'only', |
  | 705 |  | 'desc' => \_\_( 'Only allow local avatars (still uses Gravatar for default avatars)', 'simple-local-avatars' ), |
  |  | 719 | 'desc' => \_\_( 'Only allow local avatars (still uses Gravatar for default avatars)', 'simple-local-avatars' ), |
  | 706 | 720 | ) |
  | 707 | 721 | ); |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L951) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L965) |  |
  | 951 | 965 | ?> |
  | 952 | 966 | <p style="display: inline-block; width: 26em;"> |
  | 953 |  | <span class="description"><?php esc\_html\_e( 'Choose an image from your computer:' ); ?></span><br /> |
  |  | 967 | <span class="description"><?php esc\_html\_e( 'Choose an image from your computer:', 'simple-local-avatars' ); ?></span><br /> |
  | 954 | 968 | <input type="file" name="simple-local-avatar" id="simple-local-avatar" class="standard-text" /> |
  | 955 | 969 | </p> |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L977) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L991) |  |
  | 977 | 991 | </tr> |
  | 978 | 992 | <tr class="ratings-row"> |
  | 979 |  | <th scope="row"><?php esc\_html\_e( 'Rating' ); ?></th> |
  |  | 993 | <th scope="row"><?php esc\_html\_e( 'Rating', 'simple-local-avatars' ); ?></th> |
  | 980 | 994 | <td colspan="2"> |
  | 981 | 995 | <fieldset id="simple-local-avatar-ratings" <?php disabled( empty( $profileuser->simple\_local\_avatar ) ); ?>> |
  | 982 |  | <legend class="screen-reader-text"><span><?php esc\_html\_e( 'Rating' ); ?></span></legend> |
  |  | 996 | <legend class="screen-reader-text"><span><?php esc\_html\_e( 'Rating', 'simple-local-avatars' ); ?></span></legend> |
  | 983 | 997 | <?php |
  | 984 | 998 | if ( empty( $profileuser->simple\_local\_avatar\_rating ) || ! array\_key\_exists( $profileuser->simple\_local\_avatar\_rating, $this->avatar\_ratings ) ) { |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1036) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1050) |  |
  | 1036 | 1050 | \* @param int $user\_id Id of the user who's avatar was updated |
  | 1037 | 1051 | \*/ |
  | 1038 |  | do\_action( 'simple\_local\_avatar\_updated', $user\_id ); |
  |  | 1052 | do\_action( 'simple\_local\_avatar\_updated', $user\_id ); |
  | 1039 | 1053 | } |
  | 1040 | 1054 |  |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1065) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1079) |  |
  | 1065 | 1079 | $max\_upload\_size = $this->upload\_size\_limit( wp\_max\_upload\_size() ); |
  | 1066 | 1080 | if ( $\_FILES['simple-local-avatar']['size'] > $max\_upload\_size ) { |
  |  | 1081 | // translators: %s: Formatted size. |
  | 1067 | 1082 | $this->avatar\_upload\_error = sprintf( \_\_( 'Max allowed avatar size is %s', 'simple-local-avatars' ), size\_format( $max\_upload\_size ) ); |
  | 1068 | 1083 | add\_action( 'user\_profile\_update\_errors', array( $this, 'user\_profile\_update\_errors' ) ); |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1111) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1126) |  |
  | 1111 | 1126 |  |
  | 1112 | 1127 | // Handle ratings |
  | 1113 |  | if ( isset( $avatar\_id ) || ~~get\_user\_meta( $user\_id, $this->user\_key, true~~ ) ) { |
  |  | 1128 | if ( isset( $avatar\_id ) || ! empty( $this->get\_user\_local\_avatar( $user\_id ) ) ) { |
  | 1114 | 1129 | if ( empty( $\_POST['simple\_local\_avatar\_rating'] ) || ! array\_key\_exists( $\_POST['simple\_local\_avatar\_rating'], $this->avatar\_ratings ) ) { |
  | 1115 | 1130 | $\_POST['simple\_local\_avatar\_rating'] = key( $this->avatar\_ratings ); |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1181) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1196) |  |
  | 1181 | 1196 | \*/ |
  | 1182 | 1197 | public function avatar\_delete( $user\_id ) { |
  | 1183 |  | $old\_avatars = ~~(array) get\_user\_meta( $user\_id, $this->user\_key, true~~ ); |
  |  | 1198 | $old\_avatars = $this->get\_user\_local\_avatar( $user\_id ); |
  | 1184 | 1199 |  |
  | 1185 | 1200 | if ( empty( $old\_avatars ) ) { |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1192) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1207) |  |
  | 1192 | 1207 | } |
  | 1193 | 1208 |  |
  |  | 1209 | // Remove the blog\_id key as we don't need to try deleting a file based on that. |
  |  | 1210 | if ( array\_key\_exists( 'blog\_id', $old\_avatars ) ) { |
  |  | 1211 | unset( $old\_avatars['blog\_id'] ); |
  |  | 1212 | } |
  |  | 1213 |  |
  | 1194 | 1214 | if ( ! empty( $old\_avatars ) ) { |
  | 1195 | 1215 | $upload\_path = wp\_upload\_dir(); |
  | 1196 | 1216 |  |
  | 1197 | 1217 | foreach ( $old\_avatars as $old\_avatar ) { |
  |  | 1218 | // Ensure the avatar is in the uploads directory before we delete it. |
  |  | 1219 | if ( strpos( $old\_avatar, $upload\_path['baseurl'] ) !== 0 ) { |
  |  | 1220 | continue; |
  |  | 1221 | } |
  |  | 1222 |  |
  | 1198 | 1223 | // derive the path for the file based on the upload directory |
  | 1199 | 1224 | $old\_avatar\_path = str\_replace( $upload\_path['baseurl'], $upload\_path['basedir'], $old\_avatar ); |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1272) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1297) |  |
  | 1272 | 1297 | \*/ |
  | 1273 | 1298 | public function get\_avatar\_rest( $user ) { |
  | 1274 |  | $local\_avatar = ~~get\_user\_meta( $user['id'], $this->user\_key, true~~ ); |
  |  | 1299 | $local\_avatar = $this->get\_user\_local\_avatar( $user['id'] ); |
  | 1275 | 1300 | if ( empty( $local\_avatar ) ) { |
  | 1276 | 1301 | return; |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1289) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1314) |  |
  | 1289 | 1314 | \* @param array  $input Input submitted via REST request. |
  | 1290 | 1315 | \* @param object $user  The user making the request. |
  |  | 1316 | \* @return null|\WP\_Error |
  | 1291 | 1317 | \*/ |
  | 1292 | 1318 | public function set\_avatar\_rest( $input, $user ) { |
  | 1293 |  | $this->assign\_new\_user\_avatar( $input['media\_id'], $user->ID ); |
  |  | 1319 | // Ensure media\_id is set and is a number. |
  |  | 1320 | if ( |
  |  | 1321 | empty( $input['media\_id'] ) || |
  |  | 1322 | ! is\_numeric( $input['media\_id'] ) |
  |  | 1323 | ) { |
  |  | 1324 | return new \WP\_Error( 'invalid\_media\_id', esc\_html\_\_( 'Request did not contain a valid media\_id field.', 'simple-local-avatars' ) ); |
  |  | 1325 | } |
  |  | 1326 |  |
  |  | 1327 | // Ensure this media\_id is a valid attachment. |
  |  | 1328 | if ( ! wp\_get\_attachment\_url( (int) $input['media\_id'] ) ) { |
  |  | 1329 | return new \WP\_Error( 'invalid\_media\_id', esc\_html\_\_( 'Media ID did not match a valid attachment.', 'simple-local-avatars' ) ); |
  |  | 1330 | } |
  |  | 1331 |  |
  |  | 1332 | $this->assign\_new\_user\_avatar( (int) $input['media\_id'], $user->ID ); |
  | 1294 | 1333 | } |
  | 1295 | 1334 |  |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1374) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1413) |  |
  | 1374 | 1413 | public function sla\_clear\_user\_cache() { |
  | 1375 | 1414 | check\_ajax\_referer( 'sla\_clear\_cache\_nonce', 'nonce' ); |
  |  | 1415 |  |
  |  | 1416 | // Ensure this was run by a user with proper privileges. |
  |  | 1417 | if ( ! current\_user\_can( 'manage\_options' ) ) { |
  |  | 1418 | // Match what `check\_ajax\_referer` does. |
  |  | 1419 | wp\_die( -1, 403 ); |
  |  | 1420 | } |
  |  | 1421 |  |
  | 1376 | 1422 | $step = isset( $\_REQUEST['step'] ) ? intval( $\_REQUEST['step'] ) : 1; |
  | 1377 | 1423 |  |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1397) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1443) |  |
  | 1397 | 1443 | foreach ( $users as $user ) { |
  | 1398 | 1444 | $user\_id       = $user->ID; |
  | 1399 |  | $local\_avatars = ~~get\_user\_meta( $user\_id, 'simple\_local\_avatar', true~~ ); |
  |  | 1445 | $local\_avatars = $this->get\_user\_local\_avatar( $user\_id ); |
  | 1400 | 1446 | $media\_id      = isset( $local\_avatars['media\_id'] ) ? $local\_avatars['media\_id'] : ''; |
  | 1401 | 1447 | $this->clear\_user\_avatar\_cache( $local\_avatars, $user\_id, $media\_id ); |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1443) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1489) |  |
  | 1443 | 1489 | } |
  | 1444 | 1490 |  |
  | 1445 |  | $file\_dir\_name = $file\_name\_data['dirname']; |
  | 1446 |  | $file\_name     = $file\_name\_data['filename']; |
  | 1447 |  | $file\_ext      = $file\_name\_data['extension']; |
  |  | 1491 | $file\_dir\_name = $file\_name\_data['dirname']; |
  |  | 1492 | $file\_name     = $file\_name\_data['filename']; |
  |  | 1493 | $file\_ext      = $file\_name\_data['extension']; |
  | 1448 | 1494 | foreach ( $local\_avatars as $local\_avatars\_key => $local\_avatar\_value ) { |
  | 1449 | 1495 | if ( ! in\_array( $local\_avatars\_key, [ 'media\_id', 'full' ], true ) ) { |
  | […](/browser/simple-local-avatars/trunk/includes/class-simple-local-avatars.php?rev=3121647#L1478) | […](/browser/simple-local-avatars/tags/2.8.0/includes/class-simple-local-avatars.php?rev=3186674#L1524) |  |
  | 1478 | 1524 | <input type="hidden" name="simple-local-avatar-file-url" id="simple-local-avatar-file-url" value="<?php echo ! empty( $default\_avatar\_file\_url ) ? esc\_url( $default\_avatar\_file\_url ) : ''; ?>"/> |
  | 1479 | 1525 | <?php wp\_nonce\_field( 'simple\_local\_avatar\_default', 'simple-local-avatar-file-wpnonce' ); ?> |
  | 1480 |  | <input type="button" name="simple-local-avatar" id="simple-local-avatar-default" class="button-secondary" value="<?php esc\_attr\_e( 'Choose Default Avatar', 'simple-local-avatar' ); ?>"/> |
  | 1481 |  | <p class="description" style="margin-left: 23px;"><?php esc\_html\_e( 'Note that this avatar needs to be publicly available or a broken image will be shown.', 'simple-local-avatar' ); ?></p> |
  |  | 1526 | <input type="button" name="simple-local-avatar" id="simple-local-avatar-default" class="button-secondary" value="<?php esc\_attr\_e( 'Choose Default Avatar', 'simple-local-avatars' ); ?>"/> |
  |  | 1527 | <p class="description" style="margin-left: 23px;"><?php esc\_html\_e( 'Note that this avatar needs to be publicly available or a broken image will be shown.', 'simple-local-avatars' ); ?></p> |
  | 1482 | 1528 | <?php |
  | 1483 | 1529 | $defaults['simple\_local\_avatar'] = ob\_get\_clean(); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3186674)
* [Zip Archive](?format=zip&new=3186674)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


