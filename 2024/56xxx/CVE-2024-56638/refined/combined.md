=== Content from git.kernel.org_d7eb444a_20250114_184216.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=53c7314208c865086d78b4e88da53bc33da0b603)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53c7314208c865086d78b4e88da53bc33da0b603)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53c7314208c865086d78b4e88da53bc33da0b603)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53c7314208c865086d78b4e88da53bc33da0b603)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-11-27 12:46:54 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:38 +0100 |
| commit | [53c7314208c865086d78b4e88da53bc33da0b603](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53c7314208c865086d78b4e88da53bc33da0b603) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=53c7314208c865086d78b4e88da53bc33da0b603)) | |
| tree | [504f74aa924b02bbda0a1e856c0156640637f5fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53c7314208c865086d78b4e88da53bc33da0b603) | |
| parent | [f309733a8c9da7d4266a8a3755020b738a570cae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f309733a8c9da7d4266a8a3755020b738a570cae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53c7314208c865086d78b4e88da53bc33da0b603&id2=f309733a8c9da7d4266a8a3755020b738a570cae)) | |
| download | [linux-53c7314208c865086d78b4e88da53bc33da0b603.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-53c7314208c865086d78b4e88da53bc33da0b603.tar.gz) | |

netfilter: nft\_inner: incorrect percpu area handling under softirq[ Upstream commit 7b1d83da254be3bf054965c8f3b1ad976f460ae5 ]
Softirq can interrupt ongoing packet from process context that is
walking over the percpu area that contains inner header offsets.
Disable bh and perform three checks before restoring the percpu inner
header offsets to validate that the percpu area is valid for this
skbuff:
1) If the NFT\_PKTINFO\_INNER\_FULL flag is set on, then this skbuff
has already been parsed before for inner header fetching to
register.
2) Validate that the percpu area refers to this skbuff using the
skbuff pointer as a cookie. If there is a cookie mismatch, then
this skbuff needs to be parsed again.
3) Finally, validate if the percpu area refers to this tunnel type.
Only after these three checks the percpu area is restored to a on-stack
copy and bh is enabled again.
After inner header fetching, the on-stack copy is stored back to the
percpu area.
Fixes: 3a07327d10a0 ("netfilter: nft\_inner: support for inner tunnel header matching")
Reported-by: syzbot+84d0441b9860f0d63285@syzkaller.appspotmail.com
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53c7314208c865086d78b4e88da53bc33da0b603)

| -rw-r--r-- | [include/net/netfilter/nf\_tables\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables_core.h?id=53c7314208c865086d78b4e88da53bc33da0b603) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nft\_inner.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_inner.c?id=53c7314208c865086d78b4e88da53bc33da0b603) | 57 | |  |  |  | | --- | --- | --- | |

2 files changed, 46 insertions, 12 deletions

| diff --git a/include/net/netfilter/nf\_tables\_core.h b/include/net/netfilter/nf\_tables\_core.hindex 780a5f6ad4a671..16855c2a03f8e9 100644--- a/[include/net/netfilter/nf\_tables\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables_core.h?id=f309733a8c9da7d4266a8a3755020b738a570cae)+++ b/[include/net/netfilter/nf\_tables\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables_core.h?id=53c7314208c865086d78b4e88da53bc33da0b603)@@ -161,6 +161,7 @@ enum { };  struct nft\_inner\_tun\_ctx {+ unsigned long cookie; u16 type; u16 inner\_tunoff; u16 inner\_lloff;diff --git a/net/netfilter/nft\_inner.c b/net/netfilter/nft\_inner.cindex 928312d01eb1d6..817ab978d24a19 100644--- a/[net/netfilter/nft\_inner.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_inner.c?id=f309733a8c9da7d4266a8a3755020b738a570cae)+++ b/[net/netfilter/nft\_inner.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_inner.c?id=53c7314208c865086d78b4e88da53bc33da0b603)@@ -210,35 +210,66 @@ static int nft\_inner\_parse(const struct nft\_inner \*priv, struct nft\_pktinfo \*pkt, struct nft\_inner\_tun\_ctx \*tun\_ctx) {- struct nft\_inner\_tun\_ctx ctx = {}; u32 off = pkt->inneroff;  if (priv->flags & NFT\_INNER\_HDRSIZE &&- nft\_inner\_parse\_tunhdr(priv, pkt, &ctx, &off) < 0)+ nft\_inner\_parse\_tunhdr(priv, pkt, tun\_ctx, &off) < 0) return -1;  if (priv->flags & (NFT\_INNER\_LL | NFT\_INNER\_NH)) {- if (nft\_inner\_parse\_l2l3(priv, pkt, &ctx, off) < 0)+ if (nft\_inner\_parse\_l2l3(priv, pkt, tun\_ctx, off) < 0) return -1; } else if (priv->flags & NFT\_INNER\_TH) {- ctx.inner\_thoff = off;- ctx.flags |= NFT\_PAYLOAD\_CTX\_INNER\_TH;+ tun\_ctx->inner\_thoff = off;+ tun\_ctx->flags |= NFT\_PAYLOAD\_CTX\_INNER\_TH; } - \*tun\_ctx = ctx; tun\_ctx->type = priv->type;+ tun\_ctx->cookie = (unsigned long)pkt->skb; pkt->flags |= NFT\_PKTINFO\_INNER\_FULL;  return 0; } +static bool nft\_inner\_restore\_tun\_ctx(const struct nft\_pktinfo \*pkt,+ struct nft\_inner\_tun\_ctx \*tun\_ctx)+{+ struct nft\_inner\_tun\_ctx \*this\_cpu\_tun\_ctx;++ local\_bh\_disable();+ this\_cpu\_tun\_ctx = this\_cpu\_ptr(&nft\_pcpu\_tun\_ctx);+ if (this\_cpu\_tun\_ctx->cookie != (unsigned long)pkt->skb) {+ local\_bh\_enable();+ return false;+ }+ \*tun\_ctx = \*this\_cpu\_tun\_ctx;+ local\_bh\_enable();++ return true;+}++static void nft\_inner\_save\_tun\_ctx(const struct nft\_pktinfo \*pkt,+ const struct nft\_inner\_tun\_ctx \*tun\_ctx)+{+ struct nft\_inner\_tun\_ctx \*this\_cpu\_tun\_ctx;++ local\_bh\_disable();+ this\_cpu\_tun\_ctx = this\_cpu\_ptr(&nft\_pcpu\_tun\_ctx);+ if (this\_cpu\_tun\_ctx->cookie != tun\_ctx->cookie)+ \*this\_cpu\_tun\_ctx = \*tun\_ctx;+ local\_bh\_enable();+}+ static bool nft\_inner\_parse\_needed(const struct nft\_inner \*priv, const struct nft\_pktinfo \*pkt,- const struct nft\_inner\_tun\_ctx \*tun\_ctx)+ struct nft\_inner\_tun\_ctx \*tun\_ctx) { if (!(pkt->flags & NFT\_PKTINFO\_INNER\_FULL)) return true; + if (!nft\_inner\_restore\_tun\_ctx(pkt, tun\_ctx))+ return true;+ if (priv->type != tun\_ctx->type) return true; @@ -248,27 +279,29 @@ static bool nft\_inner\_parse\_needed(const struct nft\_inner \*priv, static void nft\_inner\_eval(const struct nft\_expr \*expr, struct nft\_regs \*regs, const struct nft\_pktinfo \*pkt) {- struct nft\_inner\_tun\_ctx \*tun\_ctx = this\_cpu\_ptr(&nft\_pcpu\_tun\_ctx); const struct nft\_inner \*priv = nft\_expr\_priv(expr);+ struct nft\_inner\_tun\_ctx tun\_ctx = {};  if (nft\_payload\_inner\_offset(pkt) < 0) goto err; - if (nft\_inner\_parse\_needed(priv, pkt, tun\_ctx) &&- nft\_inner\_parse(priv, (struct nft\_pktinfo \*)pkt, tun\_ctx) < 0)+ if (nft\_inner\_parse\_needed(priv, pkt, &tun\_ctx) &&+ nft\_inner\_parse(priv, (struct nft\_pktinfo \*)pkt, &tun\_ctx) < 0) goto err;  switch (priv->expr\_type) { case NFT\_INNER\_EXPR\_PAYLOAD:- nft\_payload\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, tun\_ctx);+ nft\_payload\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, &tun\_ctx); break; case NFT\_INNER\_EXPR\_META:- nft\_meta\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, tun\_ctx);+ nft\_meta\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, &tun\_ctx); break; default: WARN\_ON\_ONCE(1); goto err; }+ nft\_inner\_save\_tun\_ctx(pkt, &tun\_ctx);+ return; err: regs->verdict.code = NFT\_BREAK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:40:53 +0000



=== Content from git.kernel.org_6d7ab01f_20250114_184216.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-11-27 12:46:54 +0100 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-12-03 22:10:58 +0100 |
| commit | [7b1d83da254be3bf054965c8f3b1ad976f460ae5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5)) | |
| tree | [2bbb595d8e5a0aa12eae64747e813f8cd1b024bb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5) | |
| parent | [b7529880cb961d515642ce63f9d7570869bbbdc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7529880cb961d515642ce63f9d7570869bbbdc3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5&id2=b7529880cb961d515642ce63f9d7570869bbbdc3)) | |
| download | [linux-7b1d83da254be3bf054965c8f3b1ad976f460ae5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7b1d83da254be3bf054965c8f3b1ad976f460ae5.tar.gz) | |

netfilter: nft\_inner: incorrect percpu area handling under softirqSoftirq can interrupt ongoing packet from process context that is
walking over the percpu area that contains inner header offsets.
Disable bh and perform three checks before restoring the percpu inner
header offsets to validate that the percpu area is valid for this
skbuff:
1) If the NFT\_PKTINFO\_INNER\_FULL flag is set on, then this skbuff
has already been parsed before for inner header fetching to
register.
2) Validate that the percpu area refers to this skbuff using the
skbuff pointer as a cookie. If there is a cookie mismatch, then
this skbuff needs to be parsed again.
3) Finally, validate if the percpu area refers to this tunnel type.
Only after these three checks the percpu area is restored to a on-stack
copy and bh is enabled again.
After inner header fetching, the on-stack copy is stored back to the
percpu area.
Fixes: 3a07327d10a0 ("netfilter: nft\_inner: support for inner tunnel header matching")
Reported-by: syzbot+84d0441b9860f0d63285@syzkaller.appspotmail.com
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5)

| -rw-r--r-- | [include/net/netfilter/nf\_tables\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables_core.h?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nft\_inner.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_inner.c?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5) | 57 | |  |  |  | | --- | --- | --- | |

2 files changed, 46 insertions, 12 deletions

| diff --git a/include/net/netfilter/nf\_tables\_core.h b/include/net/netfilter/nf\_tables\_core.hindex ff27cb2e166207..03b6165756fc5d 100644--- a/[include/net/netfilter/nf\_tables\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables_core.h?id=b7529880cb961d515642ce63f9d7570869bbbdc3)+++ b/[include/net/netfilter/nf\_tables\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables_core.h?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5)@@ -161,6 +161,7 @@ enum { };  struct nft\_inner\_tun\_ctx {+ unsigned long cookie; u16 type; u16 inner\_tunoff; u16 inner\_lloff;diff --git a/net/netfilter/nft\_inner.c b/net/netfilter/nft\_inner.cindex 928312d01eb1d6..817ab978d24a19 100644--- a/[net/netfilter/nft\_inner.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_inner.c?id=b7529880cb961d515642ce63f9d7570869bbbdc3)+++ b/[net/netfilter/nft\_inner.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_inner.c?id=7b1d83da254be3bf054965c8f3b1ad976f460ae5)@@ -210,35 +210,66 @@ static int nft\_inner\_parse(const struct nft\_inner \*priv, struct nft\_pktinfo \*pkt, struct nft\_inner\_tun\_ctx \*tun\_ctx) {- struct nft\_inner\_tun\_ctx ctx = {}; u32 off = pkt->inneroff;  if (priv->flags & NFT\_INNER\_HDRSIZE &&- nft\_inner\_parse\_tunhdr(priv, pkt, &ctx, &off) < 0)+ nft\_inner\_parse\_tunhdr(priv, pkt, tun\_ctx, &off) < 0) return -1;  if (priv->flags & (NFT\_INNER\_LL | NFT\_INNER\_NH)) {- if (nft\_inner\_parse\_l2l3(priv, pkt, &ctx, off) < 0)+ if (nft\_inner\_parse\_l2l3(priv, pkt, tun\_ctx, off) < 0) return -1; } else if (priv->flags & NFT\_INNER\_TH) {- ctx.inner\_thoff = off;- ctx.flags |= NFT\_PAYLOAD\_CTX\_INNER\_TH;+ tun\_ctx->inner\_thoff = off;+ tun\_ctx->flags |= NFT\_PAYLOAD\_CTX\_INNER\_TH; } - \*tun\_ctx = ctx; tun\_ctx->type = priv->type;+ tun\_ctx->cookie = (unsigned long)pkt->skb; pkt->flags |= NFT\_PKTINFO\_INNER\_FULL;  return 0; } +static bool nft\_inner\_restore\_tun\_ctx(const struct nft\_pktinfo \*pkt,+ struct nft\_inner\_tun\_ctx \*tun\_ctx)+{+ struct nft\_inner\_tun\_ctx \*this\_cpu\_tun\_ctx;++ local\_bh\_disable();+ this\_cpu\_tun\_ctx = this\_cpu\_ptr(&nft\_pcpu\_tun\_ctx);+ if (this\_cpu\_tun\_ctx->cookie != (unsigned long)pkt->skb) {+ local\_bh\_enable();+ return false;+ }+ \*tun\_ctx = \*this\_cpu\_tun\_ctx;+ local\_bh\_enable();++ return true;+}++static void nft\_inner\_save\_tun\_ctx(const struct nft\_pktinfo \*pkt,+ const struct nft\_inner\_tun\_ctx \*tun\_ctx)+{+ struct nft\_inner\_tun\_ctx \*this\_cpu\_tun\_ctx;++ local\_bh\_disable();+ this\_cpu\_tun\_ctx = this\_cpu\_ptr(&nft\_pcpu\_tun\_ctx);+ if (this\_cpu\_tun\_ctx->cookie != tun\_ctx->cookie)+ \*this\_cpu\_tun\_ctx = \*tun\_ctx;+ local\_bh\_enable();+}+ static bool nft\_inner\_parse\_needed(const struct nft\_inner \*priv, const struct nft\_pktinfo \*pkt,- const struct nft\_inner\_tun\_ctx \*tun\_ctx)+ struct nft\_inner\_tun\_ctx \*tun\_ctx) { if (!(pkt->flags & NFT\_PKTINFO\_INNER\_FULL)) return true; + if (!nft\_inner\_restore\_tun\_ctx(pkt, tun\_ctx))+ return true;+ if (priv->type != tun\_ctx->type) return true; @@ -248,27 +279,29 @@ static bool nft\_inner\_parse\_needed(const struct nft\_inner \*priv, static void nft\_inner\_eval(const struct nft\_expr \*expr, struct nft\_regs \*regs, const struct nft\_pktinfo \*pkt) {- struct nft\_inner\_tun\_ctx \*tun\_ctx = this\_cpu\_ptr(&nft\_pcpu\_tun\_ctx); const struct nft\_inner \*priv = nft\_expr\_priv(expr);+ struct nft\_inner\_tun\_ctx tun\_ctx = {};  if (nft\_payload\_inner\_offset(pkt) < 0) goto err; - if (nft\_inner\_parse\_needed(priv, pkt, tun\_ctx) &&- nft\_inner\_parse(priv, (struct nft\_pktinfo \*)pkt, tun\_ctx) < 0)+ if (nft\_inner\_parse\_needed(priv, pkt, &tun\_ctx) &&+ nft\_inner\_parse(priv, (struct nft\_pktinfo \*)pkt, &tun\_ctx) < 0) goto err;  switch (priv->expr\_type) { case NFT\_INNER\_EXPR\_PAYLOAD:- nft\_payload\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, tun\_ctx);+ nft\_payload\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, &tun\_ctx); break; case NFT\_INNER\_EXPR\_META:- nft\_meta\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, tun\_ctx);+ nft\_meta\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, &tun\_ctx); break; default: WARN\_ON\_ONCE(1); goto err; }+ nft\_inner\_save\_tun\_ctx(pkt, &tun\_ctx);+ return; err: regs->verdict.code = NFT\_BREAK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:40:53 +0000



=== Content from git.kernel.org_365b85f5_20250114_184217.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-11-27 12:46:54 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:07 +0100 |
| commit | [da5cc778e7bf78fe525bc90ec2043f41415c31d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9)) | |
| tree | [952d22eb62a6e9974791ec08f73e440bb8d7a56d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9) | |
| parent | [992fd34122de377b45cb75b64fc7f17fc1e6ed2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=992fd34122de377b45cb75b64fc7f17fc1e6ed2f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9&id2=992fd34122de377b45cb75b64fc7f17fc1e6ed2f)) | |
| download | [linux-da5cc778e7bf78fe525bc90ec2043f41415c31d9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-da5cc778e7bf78fe525bc90ec2043f41415c31d9.tar.gz) | |

netfilter: nft\_inner: incorrect percpu area handling under softirq[ Upstream commit 7b1d83da254be3bf054965c8f3b1ad976f460ae5 ]
Softirq can interrupt ongoing packet from process context that is
walking over the percpu area that contains inner header offsets.
Disable bh and perform three checks before restoring the percpu inner
header offsets to validate that the percpu area is valid for this
skbuff:
1) If the NFT\_PKTINFO\_INNER\_FULL flag is set on, then this skbuff
has already been parsed before for inner header fetching to
register.
2) Validate that the percpu area refers to this skbuff using the
skbuff pointer as a cookie. If there is a cookie mismatch, then
this skbuff needs to be parsed again.
3) Finally, validate if the percpu area refers to this tunnel type.
Only after these three checks the percpu area is restored to a on-stack
copy and bh is enabled again.
After inner header fetching, the on-stack copy is stored back to the
percpu area.
Fixes: 3a07327d10a0 ("netfilter: nft\_inner: support for inner tunnel header matching")
Reported-by: syzbot+84d0441b9860f0d63285@syzkaller.appspotmail.com
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9)

| -rw-r--r-- | [include/net/netfilter/nf\_tables\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables_core.h?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nft\_inner.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_inner.c?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9) | 57 | |  |  |  | | --- | --- | --- | |

2 files changed, 46 insertions, 12 deletions

| diff --git a/include/net/netfilter/nf\_tables\_core.h b/include/net/netfilter/nf\_tables\_core.hindex ff27cb2e166207..03b6165756fc5d 100644--- a/[include/net/netfilter/nf\_tables\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables_core.h?id=992fd34122de377b45cb75b64fc7f17fc1e6ed2f)+++ b/[include/net/netfilter/nf\_tables\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables_core.h?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9)@@ -161,6 +161,7 @@ enum { };  struct nft\_inner\_tun\_ctx {+ unsigned long cookie; u16 type; u16 inner\_tunoff; u16 inner\_lloff;diff --git a/net/netfilter/nft\_inner.c b/net/netfilter/nft\_inner.cindex 928312d01eb1d6..817ab978d24a19 100644--- a/[net/netfilter/nft\_inner.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_inner.c?id=992fd34122de377b45cb75b64fc7f17fc1e6ed2f)+++ b/[net/netfilter/nft\_inner.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_inner.c?id=da5cc778e7bf78fe525bc90ec2043f41415c31d9)@@ -210,35 +210,66 @@ static int nft\_inner\_parse(const struct nft\_inner \*priv, struct nft\_pktinfo \*pkt, struct nft\_inner\_tun\_ctx \*tun\_ctx) {- struct nft\_inner\_tun\_ctx ctx = {}; u32 off = pkt->inneroff;  if (priv->flags & NFT\_INNER\_HDRSIZE &&- nft\_inner\_parse\_tunhdr(priv, pkt, &ctx, &off) < 0)+ nft\_inner\_parse\_tunhdr(priv, pkt, tun\_ctx, &off) < 0) return -1;  if (priv->flags & (NFT\_INNER\_LL | NFT\_INNER\_NH)) {- if (nft\_inner\_parse\_l2l3(priv, pkt, &ctx, off) < 0)+ if (nft\_inner\_parse\_l2l3(priv, pkt, tun\_ctx, off) < 0) return -1; } else if (priv->flags & NFT\_INNER\_TH) {- ctx.inner\_thoff = off;- ctx.flags |= NFT\_PAYLOAD\_CTX\_INNER\_TH;+ tun\_ctx->inner\_thoff = off;+ tun\_ctx->flags |= NFT\_PAYLOAD\_CTX\_INNER\_TH; } - \*tun\_ctx = ctx; tun\_ctx->type = priv->type;+ tun\_ctx->cookie = (unsigned long)pkt->skb; pkt->flags |= NFT\_PKTINFO\_INNER\_FULL;  return 0; } +static bool nft\_inner\_restore\_tun\_ctx(const struct nft\_pktinfo \*pkt,+ struct nft\_inner\_tun\_ctx \*tun\_ctx)+{+ struct nft\_inner\_tun\_ctx \*this\_cpu\_tun\_ctx;++ local\_bh\_disable();+ this\_cpu\_tun\_ctx = this\_cpu\_ptr(&nft\_pcpu\_tun\_ctx);+ if (this\_cpu\_tun\_ctx->cookie != (unsigned long)pkt->skb) {+ local\_bh\_enable();+ return false;+ }+ \*tun\_ctx = \*this\_cpu\_tun\_ctx;+ local\_bh\_enable();++ return true;+}++static void nft\_inner\_save\_tun\_ctx(const struct nft\_pktinfo \*pkt,+ const struct nft\_inner\_tun\_ctx \*tun\_ctx)+{+ struct nft\_inner\_tun\_ctx \*this\_cpu\_tun\_ctx;++ local\_bh\_disable();+ this\_cpu\_tun\_ctx = this\_cpu\_ptr(&nft\_pcpu\_tun\_ctx);+ if (this\_cpu\_tun\_ctx->cookie != tun\_ctx->cookie)+ \*this\_cpu\_tun\_ctx = \*tun\_ctx;+ local\_bh\_enable();+}+ static bool nft\_inner\_parse\_needed(const struct nft\_inner \*priv, const struct nft\_pktinfo \*pkt,- const struct nft\_inner\_tun\_ctx \*tun\_ctx)+ struct nft\_inner\_tun\_ctx \*tun\_ctx) { if (!(pkt->flags & NFT\_PKTINFO\_INNER\_FULL)) return true; + if (!nft\_inner\_restore\_tun\_ctx(pkt, tun\_ctx))+ return true;+ if (priv->type != tun\_ctx->type) return true; @@ -248,27 +279,29 @@ static bool nft\_inner\_parse\_needed(const struct nft\_inner \*priv, static void nft\_inner\_eval(const struct nft\_expr \*expr, struct nft\_regs \*regs, const struct nft\_pktinfo \*pkt) {- struct nft\_inner\_tun\_ctx \*tun\_ctx = this\_cpu\_ptr(&nft\_pcpu\_tun\_ctx); const struct nft\_inner \*priv = nft\_expr\_priv(expr);+ struct nft\_inner\_tun\_ctx tun\_ctx = {};  if (nft\_payload\_inner\_offset(pkt) < 0) goto err; - if (nft\_inner\_parse\_needed(priv, pkt, tun\_ctx) &&- nft\_inner\_parse(priv, (struct nft\_pktinfo \*)pkt, tun\_ctx) < 0)+ if (nft\_inner\_parse\_needed(priv, pkt, &tun\_ctx) &&+ nft\_inner\_parse(priv, (struct nft\_pktinfo \*)pkt, &tun\_ctx) < 0) goto err;  switch (priv->expr\_type) { case NFT\_INNER\_EXPR\_PAYLOAD:- nft\_payload\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, tun\_ctx);+ nft\_payload\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, &tun\_ctx); break; case NFT\_INNER\_EXPR\_META:- nft\_meta\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, tun\_ctx);+ nft\_meta\_inner\_eval((struct nft\_expr \*)&priv->expr, regs, pkt, &tun\_ctx); break; default: WARN\_ON\_ONCE(1); goto err; }+ nft\_inner\_save\_tun\_ctx(pkt, &tun\_ctx);+ return; err: regs->verdict.code = NFT\_BREAK; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:40:54 +0000


