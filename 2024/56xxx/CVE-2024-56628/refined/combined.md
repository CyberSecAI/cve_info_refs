=== Content from git.kernel.org_d11b1ad0_20250114_193358.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bibo Mao <maobibo@loongson.cn> | 2024-12-02 16:42:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:51 +0100 |
| commit | [7dfbf011a57b9e1a40f5ce8080a53c497e105c6c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c)) | |
| tree | [6716f1ed2dd98fdf111e0bcdca0ad61f2bd2c93c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c) | |
| parent | [a7f0509556fa2f9789639dbcee9eed46e471ccef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7f0509556fa2f9789639dbcee9eed46e471ccef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c&id2=a7f0509556fa2f9789639dbcee9eed46e471ccef)) | |
| download | [linux-7dfbf011a57b9e1a40f5ce8080a53c497e105c6c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7dfbf011a57b9e1a40f5ce8080a53c497e105c6c.tar.gz) | |

LoongArch: Add architecture specific huge\_pte\_clear()commit 7cd1f5f77925ae905a57296932f0f9ef0dc364f8 upstream.
When executing mm selftests run\_vmtests.sh, there is such an error:
BUG: Bad page state in process uffd-unit-tests pfn:00000
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x0
flags: 0xffff0000002000(reserved|node=0|zone=0|lastcpupid=0xffff)
raw: 00ffff0000002000 ffffbf0000000008 ffffbf0000000008 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: PAGE\_FLAGS\_CHECK\_AT\_FREE flag(s) set
Modules linked in: snd\_seq\_dummy snd\_seq snd\_seq\_device rfkill vfat fat
virtio\_balloon efi\_pstore virtio\_net pstore net\_failover failover fuse
nfnetlink virtio\_scsi virtio\_gpu virtio\_dma\_buf dm\_multipath efivarfs
CPU: 2 UID: 0 PID: 1913 Comm: uffd-unit-tests Not tainted 6.12.0 #184
Hardware name: QEMU QEMU Virtual Machine, BIOS unknown 2/2/2022
Stack : 900000047c8ac000 0000000000000000 9000000000223a7c 900000047c8ac000
900000047c8af690 900000047c8af698 0000000000000000 900000047c8af7d8
900000047c8af7d0 900000047c8af7d0 900000047c8af5b0 0000000000000001
0000000000000001 900000047c8af698 10b3c7d53da40d26 0000010000000000
0000000000000022 0000000fffffffff fffffffffe000000 ffff800000000000
000000000000002f 0000800000000000 000000017a6d4000 90000000028f8940
0000000000000000 0000000000000000 90000000025aa5e0 9000000002905000
0000000000000000 90000000028f8940 ffff800000000000 0000000000000000
0000000000000000 0000000000000000 9000000000223a94 000000012001839c
00000000000000b0 0000000000000004 0000000000000000 0000000000071c1d
...
Call Trace:
[<9000000000223a94>] show\_stack+0x5c/0x180
[<9000000001c3fd64>] dump\_stack\_lvl+0x6c/0xa0
[<900000000056aa08>] bad\_page+0x1a0/0x1f0
[<9000000000574978>] free\_unref\_folios+0xbf0/0xd20
[<90000000004e65cc>] folios\_put\_refs+0x1a4/0x2b8
[<9000000000599a0c>] free\_pages\_and\_swap\_cache+0x164/0x260
[<9000000000547698>] tlb\_batch\_pages\_flush+0xa8/0x1c0
[<9000000000547f30>] tlb\_finish\_mmu+0xa8/0x218
[<9000000000543cb8>] exit\_mmap+0x1a0/0x360
[<9000000000247658>] \_\_mmput+0x78/0x200
[<900000000025583c>] do\_exit+0x43c/0xde8
[<9000000000256490>] do\_group\_exit+0x68/0x110
[<9000000000256554>] sys\_exit\_group+0x1c/0x20
[<9000000001c413b4>] do\_syscall+0x94/0x130
[<90000000002216d8>] handle\_syscall+0xb8/0x158
Disabling lock debugging due to kernel taint
BUG: non-zero pgtables\_bytes on freeing mm: -16384
On LoongArch system, invalid huge pte entry should be invalid\_pte\_table
or a single \_PAGE\_HUGE bit rather than a zero value. And it should be
the same with invalid pmd entry, since pmd\_none() is called by function
free\_pgd\_range() and pmd\_none() return 0 by huge\_pte\_clear(). So single
\_PAGE\_HUGE bit is also treated as a valid pte table and free\_pte\_range()
will be called in free\_pmd\_range().
free\_pmd\_range()
pmd = pmd\_offset(pud, addr);
do {
next = pmd\_addr\_end(addr, end);
if (pmd\_none\_or\_clear\_bad(pmd))
continue;
free\_pte\_range(tlb, pmd, addr);
} while (pmd++, addr = next, addr != end);
Here invalid\_pte\_table is used for both invalid huge pte entry and
pmd entry.
Cc: stable@vger.kernel.org
Fixes: 09cfefb7fa70 ("LoongArch: Add memory management")
Signed-off-by: Bibo Mao <maobibo@loongson.cn>
Signed-off-by: Huacai Chen <chenhuacai@loongson.cn>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c)

| -rw-r--r-- | [arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/include/asm/hugetlb.h?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 0 deletions

| diff --git a/arch/loongarch/include/asm/hugetlb.h b/arch/loongarch/include/asm/hugetlb.hindex aa44b3fe43dde7..427b487fbfd658 100644--- a/[arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/hugetlb.h?id=a7f0509556fa2f9789639dbcee9eed46e471ccef)+++ b/[arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/hugetlb.h?id=7dfbf011a57b9e1a40f5ce8080a53c497e105c6c)@@ -29,6 +29,16 @@ static inline int prepare\_hugepage\_range(struct file \*file, return 0; } +#define \_\_HAVE\_ARCH\_HUGE\_PTE\_CLEAR+static inline void huge\_pte\_clear(struct mm\_struct \*mm, unsigned long addr,+ pte\_t \*ptep, unsigned long sz)+{+ pte\_t clear;++ pte\_val(clear) = (unsigned long)invalid\_pte\_table;+ set\_pte\_at(mm, addr, ptep, clear);+}+ #define \_\_HAVE\_ARCH\_HUGE\_PTEP\_GET\_AND\_CLEAR static inline pte\_t huge\_ptep\_get\_and\_clear(struct mm\_struct \*mm, unsigned long addr, pte\_t \*ptep) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:32:35 +0000



=== Content from git.kernel.org_b931aa71_20250114_193359.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bibo Mao <maobibo@loongson.cn> | 2024-12-02 16:42:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:32 +0100 |
| commit | [dba3c45e333a3a2a01395b5f5e5f88f8baba74e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4)) | |
| tree | [a484ea1301b9fca9e8c45208d4cf19c1e59ec92b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4) | |
| parent | [2cd323c55bd3f356bf23ae1b4c20100abcdc29d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2cd323c55bd3f356bf23ae1b4c20100abcdc29d6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4&id2=2cd323c55bd3f356bf23ae1b4c20100abcdc29d6)) | |
| download | [linux-dba3c45e333a3a2a01395b5f5e5f88f8baba74e4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dba3c45e333a3a2a01395b5f5e5f88f8baba74e4.tar.gz) | |

LoongArch: Add architecture specific huge\_pte\_clear()commit 7cd1f5f77925ae905a57296932f0f9ef0dc364f8 upstream.
When executing mm selftests run\_vmtests.sh, there is such an error:
BUG: Bad page state in process uffd-unit-tests pfn:00000
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x0
flags: 0xffff0000002000(reserved|node=0|zone=0|lastcpupid=0xffff)
raw: 00ffff0000002000 ffffbf0000000008 ffffbf0000000008 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: PAGE\_FLAGS\_CHECK\_AT\_FREE flag(s) set
Modules linked in: snd\_seq\_dummy snd\_seq snd\_seq\_device rfkill vfat fat
virtio\_balloon efi\_pstore virtio\_net pstore net\_failover failover fuse
nfnetlink virtio\_scsi virtio\_gpu virtio\_dma\_buf dm\_multipath efivarfs
CPU: 2 UID: 0 PID: 1913 Comm: uffd-unit-tests Not tainted 6.12.0 #184
Hardware name: QEMU QEMU Virtual Machine, BIOS unknown 2/2/2022
Stack : 900000047c8ac000 0000000000000000 9000000000223a7c 900000047c8ac000
900000047c8af690 900000047c8af698 0000000000000000 900000047c8af7d8
900000047c8af7d0 900000047c8af7d0 900000047c8af5b0 0000000000000001
0000000000000001 900000047c8af698 10b3c7d53da40d26 0000010000000000
0000000000000022 0000000fffffffff fffffffffe000000 ffff800000000000
000000000000002f 0000800000000000 000000017a6d4000 90000000028f8940
0000000000000000 0000000000000000 90000000025aa5e0 9000000002905000
0000000000000000 90000000028f8940 ffff800000000000 0000000000000000
0000000000000000 0000000000000000 9000000000223a94 000000012001839c
00000000000000b0 0000000000000004 0000000000000000 0000000000071c1d
...
Call Trace:
[<9000000000223a94>] show\_stack+0x5c/0x180
[<9000000001c3fd64>] dump\_stack\_lvl+0x6c/0xa0
[<900000000056aa08>] bad\_page+0x1a0/0x1f0
[<9000000000574978>] free\_unref\_folios+0xbf0/0xd20
[<90000000004e65cc>] folios\_put\_refs+0x1a4/0x2b8
[<9000000000599a0c>] free\_pages\_and\_swap\_cache+0x164/0x260
[<9000000000547698>] tlb\_batch\_pages\_flush+0xa8/0x1c0
[<9000000000547f30>] tlb\_finish\_mmu+0xa8/0x218
[<9000000000543cb8>] exit\_mmap+0x1a0/0x360
[<9000000000247658>] \_\_mmput+0x78/0x200
[<900000000025583c>] do\_exit+0x43c/0xde8
[<9000000000256490>] do\_group\_exit+0x68/0x110
[<9000000000256554>] sys\_exit\_group+0x1c/0x20
[<9000000001c413b4>] do\_syscall+0x94/0x130
[<90000000002216d8>] handle\_syscall+0xb8/0x158
Disabling lock debugging due to kernel taint
BUG: non-zero pgtables\_bytes on freeing mm: -16384
On LoongArch system, invalid huge pte entry should be invalid\_pte\_table
or a single \_PAGE\_HUGE bit rather than a zero value. And it should be
the same with invalid pmd entry, since pmd\_none() is called by function
free\_pgd\_range() and pmd\_none() return 0 by huge\_pte\_clear(). So single
\_PAGE\_HUGE bit is also treated as a valid pte table and free\_pte\_range()
will be called in free\_pmd\_range().
free\_pmd\_range()
pmd = pmd\_offset(pud, addr);
do {
next = pmd\_addr\_end(addr, end);
if (pmd\_none\_or\_clear\_bad(pmd))
continue;
free\_pte\_range(tlb, pmd, addr);
} while (pmd++, addr = next, addr != end);
Here invalid\_pte\_table is used for both invalid huge pte entry and
pmd entry.
Cc: stable@vger.kernel.org
Fixes: 09cfefb7fa70 ("LoongArch: Add memory management")
Signed-off-by: Bibo Mao <maobibo@loongson.cn>
Signed-off-by: Huacai Chen <chenhuacai@loongson.cn>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4)

| -rw-r--r-- | [arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/include/asm/hugetlb.h?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 0 deletions

| diff --git a/arch/loongarch/include/asm/hugetlb.h b/arch/loongarch/include/asm/hugetlb.hindex aa44b3fe43dde7..427b487fbfd658 100644--- a/[arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/hugetlb.h?id=2cd323c55bd3f356bf23ae1b4c20100abcdc29d6)+++ b/[arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/hugetlb.h?id=dba3c45e333a3a2a01395b5f5e5f88f8baba74e4)@@ -29,6 +29,16 @@ static inline int prepare\_hugepage\_range(struct file \*file, return 0; } +#define \_\_HAVE\_ARCH\_HUGE\_PTE\_CLEAR+static inline void huge\_pte\_clear(struct mm\_struct \*mm, unsigned long addr,+ pte\_t \*ptep, unsigned long sz)+{+ pte\_t clear;++ pte\_val(clear) = (unsigned long)invalid\_pte\_table;+ set\_pte\_at(mm, addr, ptep, clear);+}+ #define \_\_HAVE\_ARCH\_HUGE\_PTEP\_GET\_AND\_CLEAR static inline pte\_t huge\_ptep\_get\_and\_clear(struct mm\_struct \*mm, unsigned long addr, pte\_t \*ptep) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:32:36 +0000



=== Content from git.kernel.org_e23e7e5b_20250114_193358.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bibo Mao <maobibo@loongson.cn> | 2024-12-02 16:42:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:20 +0100 |
| commit | [9b602190cf2d8ac957be0011e418ed6c3b49b9a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3)) | |
| tree | [a4061d8dc1b0f52e00e4a5bc77b25f3210001e2d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3) | |
| parent | [e689bc6697a7fcebd4a945ab0b1e1112c76024d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e689bc6697a7fcebd4a945ab0b1e1112c76024d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3&id2=e689bc6697a7fcebd4a945ab0b1e1112c76024d8)) | |
| download | [linux-9b602190cf2d8ac957be0011e418ed6c3b49b9a3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9b602190cf2d8ac957be0011e418ed6c3b49b9a3.tar.gz) | |

LoongArch: Add architecture specific huge\_pte\_clear()commit 7cd1f5f77925ae905a57296932f0f9ef0dc364f8 upstream.
When executing mm selftests run\_vmtests.sh, there is such an error:
BUG: Bad page state in process uffd-unit-tests pfn:00000
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x0
flags: 0xffff0000002000(reserved|node=0|zone=0|lastcpupid=0xffff)
raw: 00ffff0000002000 ffffbf0000000008 ffffbf0000000008 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: PAGE\_FLAGS\_CHECK\_AT\_FREE flag(s) set
Modules linked in: snd\_seq\_dummy snd\_seq snd\_seq\_device rfkill vfat fat
virtio\_balloon efi\_pstore virtio\_net pstore net\_failover failover fuse
nfnetlink virtio\_scsi virtio\_gpu virtio\_dma\_buf dm\_multipath efivarfs
CPU: 2 UID: 0 PID: 1913 Comm: uffd-unit-tests Not tainted 6.12.0 #184
Hardware name: QEMU QEMU Virtual Machine, BIOS unknown 2/2/2022
Stack : 900000047c8ac000 0000000000000000 9000000000223a7c 900000047c8ac000
900000047c8af690 900000047c8af698 0000000000000000 900000047c8af7d8
900000047c8af7d0 900000047c8af7d0 900000047c8af5b0 0000000000000001
0000000000000001 900000047c8af698 10b3c7d53da40d26 0000010000000000
0000000000000022 0000000fffffffff fffffffffe000000 ffff800000000000
000000000000002f 0000800000000000 000000017a6d4000 90000000028f8940
0000000000000000 0000000000000000 90000000025aa5e0 9000000002905000
0000000000000000 90000000028f8940 ffff800000000000 0000000000000000
0000000000000000 0000000000000000 9000000000223a94 000000012001839c
00000000000000b0 0000000000000004 0000000000000000 0000000000071c1d
...
Call Trace:
[<9000000000223a94>] show\_stack+0x5c/0x180
[<9000000001c3fd64>] dump\_stack\_lvl+0x6c/0xa0
[<900000000056aa08>] bad\_page+0x1a0/0x1f0
[<9000000000574978>] free\_unref\_folios+0xbf0/0xd20
[<90000000004e65cc>] folios\_put\_refs+0x1a4/0x2b8
[<9000000000599a0c>] free\_pages\_and\_swap\_cache+0x164/0x260
[<9000000000547698>] tlb\_batch\_pages\_flush+0xa8/0x1c0
[<9000000000547f30>] tlb\_finish\_mmu+0xa8/0x218
[<9000000000543cb8>] exit\_mmap+0x1a0/0x360
[<9000000000247658>] \_\_mmput+0x78/0x200
[<900000000025583c>] do\_exit+0x43c/0xde8
[<9000000000256490>] do\_group\_exit+0x68/0x110
[<9000000000256554>] sys\_exit\_group+0x1c/0x20
[<9000000001c413b4>] do\_syscall+0x94/0x130
[<90000000002216d8>] handle\_syscall+0xb8/0x158
Disabling lock debugging due to kernel taint
BUG: non-zero pgtables\_bytes on freeing mm: -16384
On LoongArch system, invalid huge pte entry should be invalid\_pte\_table
or a single \_PAGE\_HUGE bit rather than a zero value. And it should be
the same with invalid pmd entry, since pmd\_none() is called by function
free\_pgd\_range() and pmd\_none() return 0 by huge\_pte\_clear(). So single
\_PAGE\_HUGE bit is also treated as a valid pte table and free\_pte\_range()
will be called in free\_pmd\_range().
free\_pmd\_range()
pmd = pmd\_offset(pud, addr);
do {
next = pmd\_addr\_end(addr, end);
if (pmd\_none\_or\_clear\_bad(pmd))
continue;
free\_pte\_range(tlb, pmd, addr);
} while (pmd++, addr = next, addr != end);
Here invalid\_pte\_table is used for both invalid huge pte entry and
pmd entry.
Cc: stable@vger.kernel.org
Fixes: 09cfefb7fa70 ("LoongArch: Add memory management")
Signed-off-by: Bibo Mao <maobibo@loongson.cn>
Signed-off-by: Huacai Chen <chenhuacai@loongson.cn>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3)

| -rw-r--r-- | [arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/include/asm/hugetlb.h?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 0 deletions

| diff --git a/arch/loongarch/include/asm/hugetlb.h b/arch/loongarch/include/asm/hugetlb.hindex 5da32c00d483fb..376c0708e2979b 100644--- a/[arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/hugetlb.h?id=e689bc6697a7fcebd4a945ab0b1e1112c76024d8)+++ b/[arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/hugetlb.h?id=9b602190cf2d8ac957be0011e418ed6c3b49b9a3)@@ -29,6 +29,16 @@ static inline int prepare\_hugepage\_range(struct file \*file, return 0; } +#define \_\_HAVE\_ARCH\_HUGE\_PTE\_CLEAR+static inline void huge\_pte\_clear(struct mm\_struct \*mm, unsigned long addr,+ pte\_t \*ptep, unsigned long sz)+{+ pte\_t clear;++ pte\_val(clear) = (unsigned long)invalid\_pte\_table;+ set\_pte\_at(mm, addr, ptep, clear);+}+ #define \_\_HAVE\_ARCH\_HUGE\_PTEP\_GET\_AND\_CLEAR static inline pte\_t huge\_ptep\_get\_and\_clear(struct mm\_struct \*mm, unsigned long addr, pte\_t \*ptep) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:32:36 +0000



=== Content from git.kernel.org_bc3d3f59_20250114_193357.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bibo Mao <maobibo@loongson.cn> | 2024-12-02 16:42:08 +0800 |
| --- | --- | --- |
| committer | Huacai Chen <chenhuacai@loongson.cn> | 2024-12-02 16:42:08 +0800 |
| commit | [7cd1f5f77925ae905a57296932f0f9ef0dc364f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8)) | |
| tree | [c6f9ff8f8981df37c1dfdbfcab416b6768c13f80](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8) | |
| parent | [ad2a05a6d287aef7e069c06e329f1355756415c2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad2a05a6d287aef7e069c06e329f1355756415c2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8&id2=ad2a05a6d287aef7e069c06e329f1355756415c2)) | |
| download | [linux-7cd1f5f77925ae905a57296932f0f9ef0dc364f8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7cd1f5f77925ae905a57296932f0f9ef0dc364f8.tar.gz) | |

LoongArch: Add architecture specific huge\_pte\_clear()When executing mm selftests run\_vmtests.sh, there is such an error:
BUG: Bad page state in process uffd-unit-tests pfn:00000
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x0
flags: 0xffff0000002000(reserved|node=0|zone=0|lastcpupid=0xffff)
raw: 00ffff0000002000 ffffbf0000000008 ffffbf0000000008 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: PAGE\_FLAGS\_CHECK\_AT\_FREE flag(s) set
Modules linked in: snd\_seq\_dummy snd\_seq snd\_seq\_device rfkill vfat fat
virtio\_balloon efi\_pstore virtio\_net pstore net\_failover failover fuse
nfnetlink virtio\_scsi virtio\_gpu virtio\_dma\_buf dm\_multipath efivarfs
CPU: 2 UID: 0 PID: 1913 Comm: uffd-unit-tests Not tainted 6.12.0 #184
Hardware name: QEMU QEMU Virtual Machine, BIOS unknown 2/2/2022
Stack : 900000047c8ac000 0000000000000000 9000000000223a7c 900000047c8ac000
900000047c8af690 900000047c8af698 0000000000000000 900000047c8af7d8
900000047c8af7d0 900000047c8af7d0 900000047c8af5b0 0000000000000001
0000000000000001 900000047c8af698 10b3c7d53da40d26 0000010000000000
0000000000000022 0000000fffffffff fffffffffe000000 ffff800000000000
000000000000002f 0000800000000000 000000017a6d4000 90000000028f8940
0000000000000000 0000000000000000 90000000025aa5e0 9000000002905000
0000000000000000 90000000028f8940 ffff800000000000 0000000000000000
0000000000000000 0000000000000000 9000000000223a94 000000012001839c
00000000000000b0 0000000000000004 0000000000000000 0000000000071c1d
...
Call Trace:
[<9000000000223a94>] show\_stack+0x5c/0x180
[<9000000001c3fd64>] dump\_stack\_lvl+0x6c/0xa0
[<900000000056aa08>] bad\_page+0x1a0/0x1f0
[<9000000000574978>] free\_unref\_folios+0xbf0/0xd20
[<90000000004e65cc>] folios\_put\_refs+0x1a4/0x2b8
[<9000000000599a0c>] free\_pages\_and\_swap\_cache+0x164/0x260
[<9000000000547698>] tlb\_batch\_pages\_flush+0xa8/0x1c0
[<9000000000547f30>] tlb\_finish\_mmu+0xa8/0x218
[<9000000000543cb8>] exit\_mmap+0x1a0/0x360
[<9000000000247658>] \_\_mmput+0x78/0x200
[<900000000025583c>] do\_exit+0x43c/0xde8
[<9000000000256490>] do\_group\_exit+0x68/0x110
[<9000000000256554>] sys\_exit\_group+0x1c/0x20
[<9000000001c413b4>] do\_syscall+0x94/0x130
[<90000000002216d8>] handle\_syscall+0xb8/0x158
Disabling lock debugging due to kernel taint
BUG: non-zero pgtables\_bytes on freeing mm: -16384
On LoongArch system, invalid huge pte entry should be invalid\_pte\_table
or a single \_PAGE\_HUGE bit rather than a zero value. And it should be
the same with invalid pmd entry, since pmd\_none() is called by function
free\_pgd\_range() and pmd\_none() return 0 by huge\_pte\_clear(). So single
\_PAGE\_HUGE bit is also treated as a valid pte table and free\_pte\_range()
will be called in free\_pmd\_range().
free\_pmd\_range()
pmd = pmd\_offset(pud, addr);
do {
next = pmd\_addr\_end(addr, end);
if (pmd\_none\_or\_clear\_bad(pmd))
continue;
free\_pte\_range(tlb, pmd, addr);
} while (pmd++, addr = next, addr != end);
Here invalid\_pte\_table is used for both invalid huge pte entry and
pmd entry.
Cc: stable@vger.kernel.org
Fixes: 09cfefb7fa70 ("LoongArch: Add memory management")
Signed-off-by: Bibo Mao <maobibo@loongson.cn>
Signed-off-by: Huacai Chen <chenhuacai@loongson.cn>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8)

| -rw-r--r-- | [arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/include/asm/hugetlb.h?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 0 deletions

| diff --git a/arch/loongarch/include/asm/hugetlb.h b/arch/loongarch/include/asm/hugetlb.hindex b837c65a4894ea..c8e4057734d0de 100644--- a/[arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/hugetlb.h?id=ad2a05a6d287aef7e069c06e329f1355756415c2)+++ b/[arch/loongarch/include/asm/hugetlb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/include/asm/hugetlb.h?id=7cd1f5f77925ae905a57296932f0f9ef0dc364f8)@@ -24,6 +24,16 @@ static inline int prepare\_hugepage\_range(struct file \*file, return 0; } +#define \_\_HAVE\_ARCH\_HUGE\_PTE\_CLEAR+static inline void huge\_pte\_clear(struct mm\_struct \*mm, unsigned long addr,+ pte\_t \*ptep, unsigned long sz)+{+ pte\_t clear;++ pte\_val(clear) = (unsigned long)invalid\_pte\_table;+ set\_pte\_at(mm, addr, ptep, clear);+}+ #define \_\_HAVE\_ARCH\_HUGE\_PTEP\_GET\_AND\_CLEAR static inline pte\_t huge\_ptep\_get\_and\_clear(struct mm\_struct \*mm, unsigned long addr, pte\_t \*ptep) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:32:35 +0000


