=== Content from git.kernel.org_1eee82f3_20250114_225016.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cac822772c4dc27a285f09caf30072ab76d2bf38)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cac822772c4dc27a285f09caf30072ab76d2bf38)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cac822772c4dc27a285f09caf30072ab76d2bf38)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cac822772c4dc27a285f09caf30072ab76d2bf38)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Karol Wachowski <karol.wachowski@intel.com> | 2024-09-30 21:53:13 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:14 +0100 |
| commit | [cac822772c4dc27a285f09caf30072ab76d2bf38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cac822772c4dc27a285f09caf30072ab76d2bf38) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cac822772c4dc27a285f09caf30072ab76d2bf38)) | |
| tree | [99da652f91a139030433dc7eb4a5e72eab95f4d5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cac822772c4dc27a285f09caf30072ab76d2bf38) | |
| parent | [be8f3d1e4b8731bf133e554ee703cfdadb394c6c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be8f3d1e4b8731bf133e554ee703cfdadb394c6c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cac822772c4dc27a285f09caf30072ab76d2bf38&id2=be8f3d1e4b8731bf133e554ee703cfdadb394c6c)) | |
| download | [linux-cac822772c4dc27a285f09caf30072ab76d2bf38.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cac822772c4dc27a285f09caf30072ab76d2bf38.tar.gz) | |

accel/ivpu: Prevent recovery invocation during probe and resume[ Upstream commit 5eaa497411197c41b0813d61ba3fbd6267049082 ]
Refactor IPC send and receive functions to allow correct
handling of operations that should not trigger a recovery process.
Expose ivpu\_send\_receive\_internal(), which is now utilized by the D0i3
entry, DCT initialization, and HWS initialization functions.
These functions have been modified to return error codes gracefully,
rather than initiating recovery.
The updated functions are invoked within ivpu\_probe() and ivpu\_resume(),
ensuring that any errors encountered during these stages result in a proper
teardown or shutdown sequence. The previous approach of triggering recovery
within these functions could lead to a race condition, potentially causing
undefined behavior and kernel crashes due to null pointer dereferences.
Fixes: 45e45362e095 ("accel/ivpu: Introduce ivpu\_ipc\_send\_receive\_active()")
Signed-off-by: Karol Wachowski <karol.wachowski@intel.com>
Reviewed-by: Jacek Lawrynowicz <jacek.lawrynowicz@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240930195322.461209-23-jacek.lawrynowicz@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240930195322.461209-23-jacek.lawrynowicz%40linux.intel.com)
Signed-off-by: Jacek Lawrynowicz <jacek.lawrynowicz@linux.intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cac822772c4dc27a285f09caf30072ab76d2bf38)

| -rw-r--r-- | [drivers/accel/ivpu/ivpu\_ipc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/accel/ivpu/ivpu_ipc.c?id=cac822772c4dc27a285f09caf30072ab76d2bf38) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/accel/ivpu/ivpu\_ipc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/accel/ivpu/ivpu_ipc.h?id=cac822772c4dc27a285f09caf30072ab76d2bf38) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/accel/ivpu/ivpu\_jsm\_msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/accel/ivpu/ivpu_jsm_msg.c?id=cac822772c4dc27a285f09caf30072ab76d2bf38) | 19 | |  |  |  | | --- | --- | --- | |

3 files changed, 23 insertions, 38 deletions

| diff --git a/drivers/accel/ivpu/ivpu\_ipc.c b/drivers/accel/ivpu/ivpu\_ipc.cindex 78b32a8232419e..29b723039a3459 100644--- a/[drivers/accel/ivpu/ivpu\_ipc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.c?id=be8f3d1e4b8731bf133e554ee703cfdadb394c6c)+++ b/[drivers/accel/ivpu/ivpu\_ipc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.c?id=cac822772c4dc27a285f09caf30072ab76d2bf38)@@ -291,15 +291,16 @@ int ivpu\_ipc\_receive(struct ivpu\_device \*vdev, struct ivpu\_ipc\_consumer \*cons, return ret; } -static int+int ivpu\_ipc\_send\_receive\_internal(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req, enum vpu\_ipc\_msg\_type expected\_resp\_type,- struct vpu\_jsm\_msg \*resp, u32 channel,- unsigned long timeout\_ms)+ struct vpu\_jsm\_msg \*resp, u32 channel, unsigned long timeout\_ms) { struct ivpu\_ipc\_consumer cons; int ret; + drm\_WARN\_ON(&vdev->drm, pm\_runtime\_status\_suspended(vdev->drm.dev));+ ivpu\_ipc\_consumer\_add(vdev, &cons, channel, NULL);  ret = ivpu\_ipc\_send(vdev, &cons, req);@@ -325,19 +326,21 @@ consumer\_del: return ret; } -int ivpu\_ipc\_send\_receive\_active(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,- enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,- u32 channel, unsigned long timeout\_ms)+int ivpu\_ipc\_send\_receive(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,+ enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,+ u32 channel, unsigned long timeout\_ms) { struct vpu\_jsm\_msg hb\_req = { .type = VPU\_JSM\_MSG\_QUERY\_ENGINE\_HB }; struct vpu\_jsm\_msg hb\_resp; int ret, hb\_ret; - drm\_WARN\_ON(&vdev->drm, pm\_runtime\_status\_suspended(vdev->drm.dev));+ ret = ivpu\_rpm\_get(vdev);+ if (ret < 0)+ return ret;  ret = ivpu\_ipc\_send\_receive\_internal(vdev, req, expected\_resp, resp, channel, timeout\_ms); if (ret != -ETIMEDOUT)- return ret;+ goto rpm\_put;  hb\_ret = ivpu\_ipc\_send\_receive\_internal(vdev, &hb\_req, VPU\_JSM\_MSG\_QUERY\_ENGINE\_HB\_DONE, &hb\_resp, VPU\_IPC\_CHAN\_ASYNC\_CMD,@@ -345,21 +348,7 @@ int ivpu\_ipc\_send\_receive\_active(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*r if (hb\_ret == -ETIMEDOUT) ivpu\_pm\_trigger\_recovery(vdev, "IPC timeout"); - return ret;-}--int ivpu\_ipc\_send\_receive(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,- enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,- u32 channel, unsigned long timeout\_ms)-{- int ret;-- ret = ivpu\_rpm\_get(vdev);- if (ret < 0)- return ret;-- ret = ivpu\_ipc\_send\_receive\_active(vdev, req, expected\_resp, resp, channel, timeout\_ms);-+rpm\_put: ivpu\_rpm\_put(vdev); return ret; }diff --git a/drivers/accel/ivpu/ivpu\_ipc.h b/drivers/accel/ivpu/ivpu\_ipc.hindex 4fe38141045ea3..fb4de7fb8210ea 100644--- a/[drivers/accel/ivpu/ivpu\_ipc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.h?id=be8f3d1e4b8731bf133e554ee703cfdadb394c6c)+++ b/[drivers/accel/ivpu/ivpu\_ipc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.h?id=cac822772c4dc27a285f09caf30072ab76d2bf38)@@ -101,10 +101,9 @@ int ivpu\_ipc\_send(struct ivpu\_device \*vdev, struct ivpu\_ipc\_consumer \*cons, int ivpu\_ipc\_receive(struct ivpu\_device \*vdev, struct ivpu\_ipc\_consumer \*cons, struct ivpu\_ipc\_hdr \*ipc\_buf, struct vpu\_jsm\_msg \*jsm\_msg, unsigned long timeout\_ms);--int ivpu\_ipc\_send\_receive\_active(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,- enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,- u32 channel, unsigned long timeout\_ms);+int ivpu\_ipc\_send\_receive\_internal(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,+ enum vpu\_ipc\_msg\_type expected\_resp\_type,+ struct vpu\_jsm\_msg \*resp, u32 channel, unsigned long timeout\_ms); int ivpu\_ipc\_send\_receive(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req, enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp, u32 channel, unsigned long timeout\_ms);diff --git a/drivers/accel/ivpu/ivpu\_jsm\_msg.c b/drivers/accel/ivpu/ivpu\_jsm\_msg.cindex 46ef16c3c06910..88105963c1b288 100644--- a/[drivers/accel/ivpu/ivpu\_jsm\_msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_jsm_msg.c?id=be8f3d1e4b8731bf133e554ee703cfdadb394c6c)+++ b/[drivers/accel/ivpu/ivpu\_jsm\_msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_jsm_msg.c?id=cac822772c4dc27a285f09caf30072ab76d2bf38)@@ -270,9 +270,8 @@ int ivpu\_jsm\_pwr\_d0i3\_enter(struct ivpu\_device \*vdev)  req.payload.pwr\_d0i3\_enter.send\_response = 1; - ret = ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_PWR\_D0I3\_ENTER\_DONE,- &resp, VPU\_IPC\_CHAN\_GEN\_CMD,- vdev->timeout.d0i3\_entry\_msg);+ ret = ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_PWR\_D0I3\_ENTER\_DONE, &resp,+ VPU\_IPC\_CHAN\_GEN\_CMD, vdev->timeout.d0i3\_entry\_msg); if (ret) return ret; @@ -430,8 +429,8 @@ int ivpu\_jsm\_hws\_setup\_priority\_bands(struct ivpu\_device \*vdev)  req.payload.hws\_priority\_band\_setup.normal\_band\_percentage = 10; - ret = ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_SET\_PRIORITY\_BAND\_SETUP\_RSP,- &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm);+ ret = ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_SET\_PRIORITY\_BAND\_SETUP\_RSP,+ &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm); if (ret) ivpu\_warn\_ratelimited(vdev, "Failed to set priority bands: %d\n", ret); @@ -544,9 +543,8 @@ int ivpu\_jsm\_dct\_enable(struct ivpu\_device \*vdev, u32 active\_us, u32 inactive\_us req.payload.pwr\_dct\_control.dct\_active\_us = active\_us; req.payload.pwr\_dct\_control.dct\_inactive\_us = inactive\_us; - return ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_DCT\_ENABLE\_DONE,- &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD,- vdev->timeout.jsm);+ return ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_DCT\_ENABLE\_DONE, &resp,+ VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm); }  int ivpu\_jsm\_dct\_disable(struct ivpu\_device \*vdev)@@ -554,7 +552,6 @@ int ivpu\_jsm\_dct\_disable(struct ivpu\_device \*vdev) struct vpu\_jsm\_msg req = { .type = VPU\_JSM\_MSG\_DCT\_DISABLE }; struct vpu\_jsm\_msg resp; - return ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_DCT\_DISABLE\_DONE,- &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD,- vdev->timeout.jsm);+ return ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_DCT\_DISABLE\_DONE, &resp,+ VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:48:53 +0000



=== Content from git.kernel.org_d7099822_20250114_225014.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=362ef76020ea6219a4df4ac5b738672b59527239)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=362ef76020ea6219a4df4ac5b738672b59527239)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=362ef76020ea6219a4df4ac5b738672b59527239)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=362ef76020ea6219a4df4ac5b738672b59527239)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Karol Wachowski <karol.wachowski@intel.com> | 2024-09-30 21:53:13 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:44 +0100 |
| commit | [362ef76020ea6219a4df4ac5b738672b59527239](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=362ef76020ea6219a4df4ac5b738672b59527239) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=362ef76020ea6219a4df4ac5b738672b59527239)) | |
| tree | [0bbdfd44ee88aa45a6e927983c28970c59bb0723](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=362ef76020ea6219a4df4ac5b738672b59527239) | |
| parent | [a7662f65f482d0acb453c61c7ed3cf949e69baba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7662f65f482d0acb453c61c7ed3cf949e69baba) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=362ef76020ea6219a4df4ac5b738672b59527239&id2=a7662f65f482d0acb453c61c7ed3cf949e69baba)) | |
| download | [linux-362ef76020ea6219a4df4ac5b738672b59527239.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-362ef76020ea6219a4df4ac5b738672b59527239.tar.gz) | |

accel/ivpu: Prevent recovery invocation during probe and resume[ Upstream commit 5eaa497411197c41b0813d61ba3fbd6267049082 ]
Refactor IPC send and receive functions to allow correct
handling of operations that should not trigger a recovery process.
Expose ivpu\_send\_receive\_internal(), which is now utilized by the D0i3
entry, DCT initialization, and HWS initialization functions.
These functions have been modified to return error codes gracefully,
rather than initiating recovery.
The updated functions are invoked within ivpu\_probe() and ivpu\_resume(),
ensuring that any errors encountered during these stages result in a proper
teardown or shutdown sequence. The previous approach of triggering recovery
within these functions could lead to a race condition, potentially causing
undefined behavior and kernel crashes due to null pointer dereferences.
Fixes: 45e45362e095 ("accel/ivpu: Introduce ivpu\_ipc\_send\_receive\_active()")
Signed-off-by: Karol Wachowski <karol.wachowski@intel.com>
Reviewed-by: Jacek Lawrynowicz <jacek.lawrynowicz@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240930195322.461209-23-jacek.lawrynowicz@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240930195322.461209-23-jacek.lawrynowicz%40linux.intel.com)
Signed-off-by: Jacek Lawrynowicz <jacek.lawrynowicz@linux.intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=362ef76020ea6219a4df4ac5b738672b59527239)

| -rw-r--r-- | [drivers/accel/ivpu/ivpu\_ipc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/accel/ivpu/ivpu_ipc.c?id=362ef76020ea6219a4df4ac5b738672b59527239) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/accel/ivpu/ivpu\_ipc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/accel/ivpu/ivpu_ipc.h?id=362ef76020ea6219a4df4ac5b738672b59527239) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/accel/ivpu/ivpu\_jsm\_msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/accel/ivpu/ivpu_jsm_msg.c?id=362ef76020ea6219a4df4ac5b738672b59527239) | 19 | |  |  |  | | --- | --- | --- | |

3 files changed, 23 insertions, 38 deletions

| diff --git a/drivers/accel/ivpu/ivpu\_ipc.c b/drivers/accel/ivpu/ivpu\_ipc.cindex 78b32a8232419e..29b723039a3459 100644--- a/[drivers/accel/ivpu/ivpu\_ipc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.c?id=a7662f65f482d0acb453c61c7ed3cf949e69baba)+++ b/[drivers/accel/ivpu/ivpu\_ipc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.c?id=362ef76020ea6219a4df4ac5b738672b59527239)@@ -291,15 +291,16 @@ int ivpu\_ipc\_receive(struct ivpu\_device \*vdev, struct ivpu\_ipc\_consumer \*cons, return ret; } -static int+int ivpu\_ipc\_send\_receive\_internal(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req, enum vpu\_ipc\_msg\_type expected\_resp\_type,- struct vpu\_jsm\_msg \*resp, u32 channel,- unsigned long timeout\_ms)+ struct vpu\_jsm\_msg \*resp, u32 channel, unsigned long timeout\_ms) { struct ivpu\_ipc\_consumer cons; int ret; + drm\_WARN\_ON(&vdev->drm, pm\_runtime\_status\_suspended(vdev->drm.dev));+ ivpu\_ipc\_consumer\_add(vdev, &cons, channel, NULL);  ret = ivpu\_ipc\_send(vdev, &cons, req);@@ -325,19 +326,21 @@ consumer\_del: return ret; } -int ivpu\_ipc\_send\_receive\_active(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,- enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,- u32 channel, unsigned long timeout\_ms)+int ivpu\_ipc\_send\_receive(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,+ enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,+ u32 channel, unsigned long timeout\_ms) { struct vpu\_jsm\_msg hb\_req = { .type = VPU\_JSM\_MSG\_QUERY\_ENGINE\_HB }; struct vpu\_jsm\_msg hb\_resp; int ret, hb\_ret; - drm\_WARN\_ON(&vdev->drm, pm\_runtime\_status\_suspended(vdev->drm.dev));+ ret = ivpu\_rpm\_get(vdev);+ if (ret < 0)+ return ret;  ret = ivpu\_ipc\_send\_receive\_internal(vdev, req, expected\_resp, resp, channel, timeout\_ms); if (ret != -ETIMEDOUT)- return ret;+ goto rpm\_put;  hb\_ret = ivpu\_ipc\_send\_receive\_internal(vdev, &hb\_req, VPU\_JSM\_MSG\_QUERY\_ENGINE\_HB\_DONE, &hb\_resp, VPU\_IPC\_CHAN\_ASYNC\_CMD,@@ -345,21 +348,7 @@ int ivpu\_ipc\_send\_receive\_active(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*r if (hb\_ret == -ETIMEDOUT) ivpu\_pm\_trigger\_recovery(vdev, "IPC timeout"); - return ret;-}--int ivpu\_ipc\_send\_receive(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,- enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,- u32 channel, unsigned long timeout\_ms)-{- int ret;-- ret = ivpu\_rpm\_get(vdev);- if (ret < 0)- return ret;-- ret = ivpu\_ipc\_send\_receive\_active(vdev, req, expected\_resp, resp, channel, timeout\_ms);-+rpm\_put: ivpu\_rpm\_put(vdev); return ret; }diff --git a/drivers/accel/ivpu/ivpu\_ipc.h b/drivers/accel/ivpu/ivpu\_ipc.hindex 4fe38141045ea3..fb4de7fb8210ea 100644--- a/[drivers/accel/ivpu/ivpu\_ipc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.h?id=a7662f65f482d0acb453c61c7ed3cf949e69baba)+++ b/[drivers/accel/ivpu/ivpu\_ipc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.h?id=362ef76020ea6219a4df4ac5b738672b59527239)@@ -101,10 +101,9 @@ int ivpu\_ipc\_send(struct ivpu\_device \*vdev, struct ivpu\_ipc\_consumer \*cons, int ivpu\_ipc\_receive(struct ivpu\_device \*vdev, struct ivpu\_ipc\_consumer \*cons, struct ivpu\_ipc\_hdr \*ipc\_buf, struct vpu\_jsm\_msg \*jsm\_msg, unsigned long timeout\_ms);--int ivpu\_ipc\_send\_receive\_active(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,- enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,- u32 channel, unsigned long timeout\_ms);+int ivpu\_ipc\_send\_receive\_internal(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,+ enum vpu\_ipc\_msg\_type expected\_resp\_type,+ struct vpu\_jsm\_msg \*resp, u32 channel, unsigned long timeout\_ms); int ivpu\_ipc\_send\_receive(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req, enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp, u32 channel, unsigned long timeout\_ms);diff --git a/drivers/accel/ivpu/ivpu\_jsm\_msg.c b/drivers/accel/ivpu/ivpu\_jsm\_msg.cindex 46ef16c3c06910..88105963c1b288 100644--- a/[drivers/accel/ivpu/ivpu\_jsm\_msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_jsm_msg.c?id=a7662f65f482d0acb453c61c7ed3cf949e69baba)+++ b/[drivers/accel/ivpu/ivpu\_jsm\_msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_jsm_msg.c?id=362ef76020ea6219a4df4ac5b738672b59527239)@@ -270,9 +270,8 @@ int ivpu\_jsm\_pwr\_d0i3\_enter(struct ivpu\_device \*vdev)  req.payload.pwr\_d0i3\_enter.send\_response = 1; - ret = ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_PWR\_D0I3\_ENTER\_DONE,- &resp, VPU\_IPC\_CHAN\_GEN\_CMD,- vdev->timeout.d0i3\_entry\_msg);+ ret = ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_PWR\_D0I3\_ENTER\_DONE, &resp,+ VPU\_IPC\_CHAN\_GEN\_CMD, vdev->timeout.d0i3\_entry\_msg); if (ret) return ret; @@ -430,8 +429,8 @@ int ivpu\_jsm\_hws\_setup\_priority\_bands(struct ivpu\_device \*vdev)  req.payload.hws\_priority\_band\_setup.normal\_band\_percentage = 10; - ret = ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_SET\_PRIORITY\_BAND\_SETUP\_RSP,- &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm);+ ret = ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_SET\_PRIORITY\_BAND\_SETUP\_RSP,+ &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm); if (ret) ivpu\_warn\_ratelimited(vdev, "Failed to set priority bands: %d\n", ret); @@ -544,9 +543,8 @@ int ivpu\_jsm\_dct\_enable(struct ivpu\_device \*vdev, u32 active\_us, u32 inactive\_us req.payload.pwr\_dct\_control.dct\_active\_us = active\_us; req.payload.pwr\_dct\_control.dct\_inactive\_us = inactive\_us; - return ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_DCT\_ENABLE\_DONE,- &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD,- vdev->timeout.jsm);+ return ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_DCT\_ENABLE\_DONE, &resp,+ VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm); }  int ivpu\_jsm\_dct\_disable(struct ivpu\_device \*vdev)@@ -554,7 +552,6 @@ int ivpu\_jsm\_dct\_disable(struct ivpu\_device \*vdev) struct vpu\_jsm\_msg req = { .type = VPU\_JSM\_MSG\_DCT\_DISABLE }; struct vpu\_jsm\_msg resp; - return ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_DCT\_DISABLE\_DONE,- &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD,- vdev->timeout.jsm);+ return ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_DCT\_DISABLE\_DONE, &resp,+ VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:48:52 +0000



=== Content from git.kernel.org_3d6e9109_20250114_225015.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5eaa497411197c41b0813d61ba3fbd6267049082)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5eaa497411197c41b0813d61ba3fbd6267049082)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5eaa497411197c41b0813d61ba3fbd6267049082)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5eaa497411197c41b0813d61ba3fbd6267049082)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Karol Wachowski <karol.wachowski@intel.com> | 2024-09-30 21:53:13 +0200 |
| --- | --- | --- |
| committer | Jacek Lawrynowicz <jacek.lawrynowicz@linux.intel.com> | 2024-10-11 12:44:39 +0200 |
| commit | [5eaa497411197c41b0813d61ba3fbd6267049082](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5eaa497411197c41b0813d61ba3fbd6267049082) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5eaa497411197c41b0813d61ba3fbd6267049082)) | |
| tree | [1e6659dd442d0be18d270b9b53c8eb2585d9bb64](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5eaa497411197c41b0813d61ba3fbd6267049082) | |
| parent | [541a137254c71822e7a3ebdf8309c5a37b7de465](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=541a137254c71822e7a3ebdf8309c5a37b7de465) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5eaa497411197c41b0813d61ba3fbd6267049082&id2=541a137254c71822e7a3ebdf8309c5a37b7de465)) | |
| download | [linux-5eaa497411197c41b0813d61ba3fbd6267049082.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5eaa497411197c41b0813d61ba3fbd6267049082.tar.gz) | |

accel/ivpu: Prevent recovery invocation during probe and resumeRefactor IPC send and receive functions to allow correct
handling of operations that should not trigger a recovery process.
Expose ivpu\_send\_receive\_internal(), which is now utilized by the D0i3
entry, DCT initialization, and HWS initialization functions.
These functions have been modified to return error codes gracefully,
rather than initiating recovery.
The updated functions are invoked within ivpu\_probe() and ivpu\_resume(),
ensuring that any errors encountered during these stages result in a proper
teardown or shutdown sequence. The previous approach of triggering recovery
within these functions could lead to a race condition, potentially causing
undefined behavior and kernel crashes due to null pointer dereferences.
Fixes: 45e45362e095 ("accel/ivpu: Introduce ivpu\_ipc\_send\_receive\_active()")
Signed-off-by: Karol Wachowski <karol.wachowski@intel.com>
Reviewed-by: Jacek Lawrynowicz <jacek.lawrynowicz@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240930195322.461209-23-jacek.lawrynowicz@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240930195322.461209-23-jacek.lawrynowicz%40linux.intel.com)
Signed-off-by: Jacek Lawrynowicz <jacek.lawrynowicz@linux.intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5eaa497411197c41b0813d61ba3fbd6267049082)

| -rw-r--r-- | [drivers/accel/ivpu/ivpu\_ipc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/accel/ivpu/ivpu_ipc.c?id=5eaa497411197c41b0813d61ba3fbd6267049082) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/accel/ivpu/ivpu\_ipc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/accel/ivpu/ivpu_ipc.h?id=5eaa497411197c41b0813d61ba3fbd6267049082) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/accel/ivpu/ivpu\_jsm\_msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/accel/ivpu/ivpu_jsm_msg.c?id=5eaa497411197c41b0813d61ba3fbd6267049082) | 19 | |  |  |  | | --- | --- | --- | |

3 files changed, 23 insertions, 38 deletions

| diff --git a/drivers/accel/ivpu/ivpu\_ipc.c b/drivers/accel/ivpu/ivpu\_ipc.cindex e7bccc20e4e4e7..a4ebb761354c38 100644--- a/[drivers/accel/ivpu/ivpu\_ipc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.c?id=541a137254c71822e7a3ebdf8309c5a37b7de465)+++ b/[drivers/accel/ivpu/ivpu\_ipc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.c?id=5eaa497411197c41b0813d61ba3fbd6267049082)@@ -291,15 +291,16 @@ int ivpu\_ipc\_receive(struct ivpu\_device \*vdev, struct ivpu\_ipc\_consumer \*cons, return ret; } -static int+int ivpu\_ipc\_send\_receive\_internal(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req, enum vpu\_ipc\_msg\_type expected\_resp\_type,- struct vpu\_jsm\_msg \*resp, u32 channel,- unsigned long timeout\_ms)+ struct vpu\_jsm\_msg \*resp, u32 channel, unsigned long timeout\_ms) { struct ivpu\_ipc\_consumer cons; int ret; + drm\_WARN\_ON(&vdev->drm, pm\_runtime\_status\_suspended(vdev->drm.dev));+ ivpu\_ipc\_consumer\_add(vdev, &cons, channel, NULL);  ret = ivpu\_ipc\_send(vdev, &cons, req);@@ -325,19 +326,21 @@ consumer\_del: return ret; } -int ivpu\_ipc\_send\_receive\_active(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,- enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,- u32 channel, unsigned long timeout\_ms)+int ivpu\_ipc\_send\_receive(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,+ enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,+ u32 channel, unsigned long timeout\_ms) { struct vpu\_jsm\_msg hb\_req = { .type = VPU\_JSM\_MSG\_QUERY\_ENGINE\_HB }; struct vpu\_jsm\_msg hb\_resp; int ret, hb\_ret; - drm\_WARN\_ON(&vdev->drm, pm\_runtime\_status\_suspended(vdev->drm.dev));+ ret = ivpu\_rpm\_get(vdev);+ if (ret < 0)+ return ret;  ret = ivpu\_ipc\_send\_receive\_internal(vdev, req, expected\_resp, resp, channel, timeout\_ms); if (ret != -ETIMEDOUT)- return ret;+ goto rpm\_put;  hb\_ret = ivpu\_ipc\_send\_receive\_internal(vdev, &hb\_req, VPU\_JSM\_MSG\_QUERY\_ENGINE\_HB\_DONE, &hb\_resp, VPU\_IPC\_CHAN\_ASYNC\_CMD,@@ -345,21 +348,7 @@ int ivpu\_ipc\_send\_receive\_active(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*r if (hb\_ret == -ETIMEDOUT) ivpu\_pm\_trigger\_recovery(vdev, "IPC timeout"); - return ret;-}--int ivpu\_ipc\_send\_receive(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,- enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,- u32 channel, unsigned long timeout\_ms)-{- int ret;-- ret = ivpu\_rpm\_get(vdev);- if (ret < 0)- return ret;-- ret = ivpu\_ipc\_send\_receive\_active(vdev, req, expected\_resp, resp, channel, timeout\_ms);-+rpm\_put: ivpu\_rpm\_put(vdev); return ret; }diff --git a/drivers/accel/ivpu/ivpu\_ipc.h b/drivers/accel/ivpu/ivpu\_ipc.hindex 6bbe6e32c87490..b4dfb504679bac 100644--- a/[drivers/accel/ivpu/ivpu\_ipc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.h?id=541a137254c71822e7a3ebdf8309c5a37b7de465)+++ b/[drivers/accel/ivpu/ivpu\_ipc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_ipc.h?id=5eaa497411197c41b0813d61ba3fbd6267049082)@@ -101,10 +101,9 @@ int ivpu\_ipc\_send(struct ivpu\_device \*vdev, struct ivpu\_ipc\_consumer \*cons, int ivpu\_ipc\_receive(struct ivpu\_device \*vdev, struct ivpu\_ipc\_consumer \*cons, struct ivpu\_ipc\_hdr \*ipc\_buf, struct vpu\_jsm\_msg \*jsm\_msg, unsigned long timeout\_ms);--int ivpu\_ipc\_send\_receive\_active(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,- enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp,- u32 channel, unsigned long timeout\_ms);+int ivpu\_ipc\_send\_receive\_internal(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req,+ enum vpu\_ipc\_msg\_type expected\_resp\_type,+ struct vpu\_jsm\_msg \*resp, u32 channel, unsigned long timeout\_ms); int ivpu\_ipc\_send\_receive(struct ivpu\_device \*vdev, struct vpu\_jsm\_msg \*req, enum vpu\_ipc\_msg\_type expected\_resp, struct vpu\_jsm\_msg \*resp, u32 channel, unsigned long timeout\_ms);diff --git a/drivers/accel/ivpu/ivpu\_jsm\_msg.c b/drivers/accel/ivpu/ivpu\_jsm\_msg.cindex cd33964d292bc9..ae91ad24d10d86 100644--- a/[drivers/accel/ivpu/ivpu\_jsm\_msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_jsm_msg.c?id=541a137254c71822e7a3ebdf8309c5a37b7de465)+++ b/[drivers/accel/ivpu/ivpu\_jsm\_msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/accel/ivpu/ivpu_jsm_msg.c?id=5eaa497411197c41b0813d61ba3fbd6267049082)@@ -271,9 +271,8 @@ int ivpu\_jsm\_pwr\_d0i3\_enter(struct ivpu\_device \*vdev)  req.payload.pwr\_d0i3\_enter.send\_response = 1; - ret = ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_PWR\_D0I3\_ENTER\_DONE,- &resp, VPU\_IPC\_CHAN\_GEN\_CMD,- vdev->timeout.d0i3\_entry\_msg);+ ret = ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_PWR\_D0I3\_ENTER\_DONE, &resp,+ VPU\_IPC\_CHAN\_GEN\_CMD, vdev->timeout.d0i3\_entry\_msg); if (ret) return ret; @@ -431,8 +430,8 @@ int ivpu\_jsm\_hws\_setup\_priority\_bands(struct ivpu\_device \*vdev)  req.payload.hws\_priority\_band\_setup.normal\_band\_percentage = 10; - ret = ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_SET\_PRIORITY\_BAND\_SETUP\_RSP,- &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm);+ ret = ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_SET\_PRIORITY\_BAND\_SETUP\_RSP,+ &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm); if (ret) ivpu\_warn\_ratelimited(vdev, "Failed to set priority bands: %d\n", ret); @@ -545,9 +544,8 @@ int ivpu\_jsm\_dct\_enable(struct ivpu\_device \*vdev, u32 active\_us, u32 inactive\_us req.payload.pwr\_dct\_control.dct\_active\_us = active\_us; req.payload.pwr\_dct\_control.dct\_inactive\_us = inactive\_us; - return ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_DCT\_ENABLE\_DONE,- &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD,- vdev->timeout.jsm);+ return ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_DCT\_ENABLE\_DONE, &resp,+ VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm); }  int ivpu\_jsm\_dct\_disable(struct ivpu\_device \*vdev)@@ -555,9 +553,8 @@ int ivpu\_jsm\_dct\_disable(struct ivpu\_device \*vdev) struct vpu\_jsm\_msg req = { .type = VPU\_JSM\_MSG\_DCT\_DISABLE }; struct vpu\_jsm\_msg resp; - return ivpu\_ipc\_send\_receive\_active(vdev, &req, VPU\_JSM\_MSG\_DCT\_DISABLE\_DONE,- &resp, VPU\_IPC\_CHAN\_ASYNC\_CMD,- vdev->timeout.jsm);+ return ivpu\_ipc\_send\_receive\_internal(vdev, &req, VPU\_JSM\_MSG\_DCT\_DISABLE\_DONE, &resp,+ VPU\_IPC\_CHAN\_ASYNC\_CMD, vdev->timeout.jsm); }  int ivpu\_jsm\_state\_dump(struct ivpu\_device \*vdev) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:48:52 +0000


