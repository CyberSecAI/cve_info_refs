=== Content from git.kernel.org_9a9acef8_20250114_232653.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-10-22 16:36:23 +0800 |
| --- | --- | --- |
| committer | Jaegeuk Kim <jaegeuk@kernel.org> | 2024-11-01 01:24:41 +0000 |
| commit | [f10a890308a7cd8794e21f646f09827c6cb4bf5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d)) | |
| tree | [ceefd411c10433ff41fe91d1e17f9765bcc80737](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d) | |
| parent | [0c3a38a4b442893f8baca72e44a2a27d52d6cc75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c3a38a4b442893f8baca72e44a2a27d52d6cc75) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d&id2=0c3a38a4b442893f8baca72e44a2a27d52d6cc75)) | |
| download | [linux-f10a890308a7cd8794e21f646f09827c6cb4bf5d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f10a890308a7cd8794e21f646f09827c6cb4bf5d.tar.gz) | |

f2fs: fix to avoid potential deadlock in f2fs\_record\_stop\_reason()syzbot reports deadlock issue of f2fs as below:
======================================================
WARNING: possible circular locking dependency detected
6.12.0-rc3-syzkaller-00087-gc964ced77262 #0 Not tainted
------------------------------------------------------
kswapd0/79 is trying to acquire lock:
ffff888011824088 (&sbi->sb\_lock){++++}-{3:3}, at: f2fs\_down\_write fs/f2fs/f2fs.h:2199 [inline]
ffff888011824088 (&sbi->sb\_lock){++++}-{3:3}, at: f2fs\_record\_stop\_reason+0x52/0x1d0 fs/f2fs/super.c:4068
but task is already holding lock:
ffff88804bd92610 (sb\_internal#2){.+.+}-{0:0}, at: f2fs\_evict\_inode+0x662/0x15c0 fs/f2fs/inode.c:842
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #2 (sb\_internal#2){.+.+}-{0:0}:
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
percpu\_down\_read include/linux/percpu-rwsem.h:51 [inline]
\_\_sb\_start\_write include/linux/fs.h:1716 [inline]
sb\_start\_intwrite+0x4d/0x1c0 include/linux/fs.h:1899
f2fs\_evict\_inode+0x662/0x15c0 fs/f2fs/inode.c:842
evict+0x4e8/0x9b0 fs/inode.c:725
f2fs\_evict\_inode+0x1a4/0x15c0 fs/f2fs/inode.c:807
evict+0x4e8/0x9b0 fs/inode.c:725
dispose\_list fs/inode.c:774 [inline]
prune\_icache\_sb+0x239/0x2f0 fs/inode.c:963
super\_cache\_scan+0x38c/0x4b0 fs/super.c:223
do\_shrink\_slab+0x701/0x1160 mm/shrinker.c:435
shrink\_slab+0x1093/0x14d0 mm/shrinker.c:662
shrink\_one+0x43b/0x850 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x3799/0x3de0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat mm/vmscan.c:6957 [inline]
kswapd+0x1ca3/0x3700 mm/vmscan.c:7226
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
-> #1 (fs\_reclaim){+.+.}-{0:0}:
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
\_\_fs\_reclaim\_acquire mm/page\_alloc.c:3834 [inline]
fs\_reclaim\_acquire+0x88/0x130 mm/page\_alloc.c:3848
might\_alloc include/linux/sched/mm.h:318 [inline]
prepare\_alloc\_pages+0x147/0x5b0 mm/page\_alloc.c:4493
\_\_alloc\_pages\_noprof+0x16f/0x710 mm/page\_alloc.c:4722
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_pages\_noprof mm/mempolicy.c:2345 [inline]
folio\_alloc\_noprof+0x128/0x180 mm/mempolicy.c:2352
filemap\_alloc\_folio\_noprof+0xdf/0x500 mm/filemap.c:1010
do\_read\_cache\_folio+0x2eb/0x850 mm/filemap.c:3787
read\_mapping\_folio include/linux/pagemap.h:1011 [inline]
f2fs\_commit\_super+0x3c0/0x7d0 fs/f2fs/super.c:4032
f2fs\_record\_stop\_reason+0x13b/0x1d0 fs/f2fs/super.c:4079
f2fs\_handle\_critical\_error+0x2ac/0x5c0 fs/f2fs/super.c:4174
f2fs\_write\_inode+0x35f/0x4d0 fs/f2fs/inode.c:785
write\_inode fs/fs-writeback.c:1503 [inline]
\_\_writeback\_single\_inode+0x711/0x10d0 fs/fs-writeback.c:1723
writeback\_single\_inode+0x1f3/0x660 fs/fs-writeback.c:1779
sync\_inode\_metadata+0xc4/0x120 fs/fs-writeback.c:2849
f2fs\_release\_file+0xa8/0x100 fs/f2fs/file.c:1941
\_\_fput+0x23f/0x880 fs/file\_table.c:431
task\_work\_run+0x24f/0x310 kernel/task\_work.c:228
resume\_user\_mode\_work include/linux/resume\_user\_mode.h:50 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:114 [inline]
exit\_to\_user\_mode\_prepare include/linux/entry-common.h:328 [inline]
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:207 [inline]
syscall\_exit\_to\_user\_mode+0x168/0x370 kernel/entry/common.c:218
do\_syscall\_64+0x100/0x230 arch/x86/entry/common.c:89
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
-> #0 (&sbi->sb\_lock){++++}-{3:3}:
check\_prev\_add kernel/locking/lockdep.c:3161 [inline]
check\_prevs\_add kernel/locking/lockdep.c:3280 [inline]
validate\_chain+0x18ef/0x5920 kernel/locking/lockdep.c:3904
\_\_lock\_acquire+0x1384/0x2050 kernel/locking/lockdep.c:5202
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
down\_write+0x99/0x220 kernel/locking/rwsem.c:1577
f2fs\_down\_write fs/f2fs/f2fs.h:2199 [inline]
f2fs\_record\_stop\_reason+0x52/0x1d0 fs/f2fs/super.c:4068
f2fs\_handle\_critical\_error+0x2ac/0x5c0 fs/f2fs/super.c:4174
f2fs\_evict\_inode+0xa61/0x15c0 fs/f2fs/inode.c:883
evict+0x4e8/0x9b0 fs/inode.c:725
f2fs\_evict\_inode+0x1a4/0x15c0 fs/f2fs/inode.c:807
evict+0x4e8/0x9b0 fs/inode.c:725
dispose\_list fs/inode.c:774 [inline]
prune\_icache\_sb+0x239/0x2f0 fs/inode.c:963
super\_cache\_scan+0x38c/0x4b0 fs/super.c:223
do\_shrink\_slab+0x701/0x1160 mm/shrinker.c:435
shrink\_slab+0x1093/0x14d0 mm/shrinker.c:662
shrink\_one+0x43b/0x850 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x3799/0x3de0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat mm/vmscan.c:6957 [inline]
kswapd+0x1ca3/0x3700 mm/vmscan.c:7226
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
other info that might help us debug this:
Chain exists of:
&sbi->sb\_lock --> fs\_reclaim --> sb\_internal#2
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
rlock(sb\_internal#2);
lock(fs\_reclaim);
lock(sb\_internal#2);
lock(&sbi->sb\_lock);
Root cause is there will be potential deadlock in between
below tasks:
Thread A Kswapd
- f2fs\_ioc\_commit\_atomic\_write
- mnt\_want\_write\_file -- down\_read lock A
- balance\_pgdat
- \_\_fs\_reclaim\_acquire -- lock B
- shrink\_node
- prune\_icache\_sb
- dispose\_list
- f2fs\_evict\_inode
- sb\_start\_intwrite -- down\_read lock A
- f2fs\_do\_sync\_file
- f2fs\_write\_inode
- f2fs\_handle\_critical\_error
- f2fs\_record\_stop\_reason
- f2fs\_commit\_super
- read\_mapping\_folio
- filemap\_alloc\_folio\_noprof
- fs\_reclaim\_acquire -- lock B
Both threads try to acquire read lock of lock A, then its upcoming write
lock grabber will trigger deadlock.
Let's always create an asynchronous task in f2fs\_handle\_critical\_error()
rather than calling f2fs\_record\_stop\_reason() synchronously to avoid
this potential deadlock issue.
Fixes: b62e71be2110 ("f2fs: support errors=remount-ro|continue|panic mountoption")
Reported-by: syzbot+be4a9983e95a5e25c8d3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/6704d667.050a0220.1e4d62.0081.GAE@google.com
Signed-off-by: Chao Yu <chao@kernel.org>
Reviewed-by: Daejun Park <daejun7.park@samsung.com>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d)

| -rw-r--r-- | [fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/checkpoint.c?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/f2fs.h?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/super.c?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d) | 13 | |  |  |  | | --- | --- | --- | |

3 files changed, 9 insertions, 9 deletions

| diff --git a/fs/f2fs/checkpoint.c b/fs/f2fs/checkpoint.cindex 7f76460b721f2c..efda9a0229816b 100644--- a/[fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/checkpoint.c?id=0c3a38a4b442893f8baca72e44a2a27d52d6cc75)+++ b/[fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/checkpoint.c?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d)@@ -32,7 +32,7 @@ void f2fs\_stop\_checkpoint(struct f2fs\_sb\_info \*sbi, bool end\_io, f2fs\_build\_fault\_attr(sbi, 0, 0); if (!end\_io) f2fs\_flush\_merged\_writes(sbi);- f2fs\_handle\_critical\_error(sbi, reason, end\_io);+ f2fs\_handle\_critical\_error(sbi, reason); }  /\*diff --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.hindex 3c6f3cce577904..0ac55362777100 100644--- a/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=0c3a38a4b442893f8baca72e44a2a27d52d6cc75)+++ b/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d)@@ -3637,8 +3637,7 @@ int f2fs\_quota\_sync(struct super\_block \*sb, int type); loff\_t max\_file\_blocks(struct inode \*inode); void f2fs\_quota\_off\_umount(struct super\_block \*sb); void f2fs\_save\_errors(struct f2fs\_sb\_info \*sbi, unsigned char flag);-void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason,- bool irq\_context);+void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason); void f2fs\_handle\_error(struct f2fs\_sb\_info \*sbi, unsigned char error); void f2fs\_handle\_error\_async(struct f2fs\_sb\_info \*sbi, unsigned char error); int f2fs\_commit\_super(struct f2fs\_sb\_info \*sbi, bool recover);diff --git a/fs/f2fs/super.c b/fs/f2fs/super.cindex 80a53dbf1c38c0..49519439b770f1 100644--- a/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=0c3a38a4b442893f8baca72e44a2a27d52d6cc75)+++ b/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=f10a890308a7cd8794e21f646f09827c6cb4bf5d)@@ -4159,8 +4159,7 @@ static bool system\_going\_down(void) || system\_state == SYSTEM\_RESTART; } -void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason,- bool irq\_context)+void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason) { struct super\_block \*sb = sbi->sb; bool shutdown = reason == STOP\_CP\_REASON\_SHUTDOWN;@@ -4172,10 +4171,12 @@ void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason, if (!f2fs\_hw\_is\_readonly(sbi)) { save\_stop\_reason(sbi, reason); - if (irq\_context && !shutdown)- schedule\_work(&sbi->s\_error\_work);- else- f2fs\_record\_stop\_reason(sbi);+ /\*+ \* always create an asynchronous task to record stop\_reason+ \* in order to avoid potential deadlock when running into+ \* f2fs\_record\_stop\_reason() synchronously.+ \*/+ schedule\_work(&sbi->s\_error\_work); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:25:30 +0000



=== Content from git.kernel.org_88d8e26d_20250114_232651.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=801092a2c9c251ef6a8678fcb8fcc1220474a697)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=801092a2c9c251ef6a8678fcb8fcc1220474a697)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=801092a2c9c251ef6a8678fcb8fcc1220474a697)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=801092a2c9c251ef6a8678fcb8fcc1220474a697)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-10-22 16:36:23 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:22 +0100 |
| commit | [801092a2c9c251ef6a8678fcb8fcc1220474a697](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=801092a2c9c251ef6a8678fcb8fcc1220474a697) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=801092a2c9c251ef6a8678fcb8fcc1220474a697)) | |
| tree | [0df33794198cbe8cd0a699d25318ea3b1bceffcb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=801092a2c9c251ef6a8678fcb8fcc1220474a697) | |
| parent | [5e69964251f93c8152ac0c01c44b3f5f667e0402](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e69964251f93c8152ac0c01c44b3f5f667e0402) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=801092a2c9c251ef6a8678fcb8fcc1220474a697&id2=5e69964251f93c8152ac0c01c44b3f5f667e0402)) | |
| download | [linux-801092a2c9c251ef6a8678fcb8fcc1220474a697.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-801092a2c9c251ef6a8678fcb8fcc1220474a697.tar.gz) | |

f2fs: fix to avoid potential deadlock in f2fs\_record\_stop\_reason()[ Upstream commit f10a890308a7cd8794e21f646f09827c6cb4bf5d ]
syzbot reports deadlock issue of f2fs as below:
======================================================
WARNING: possible circular locking dependency detected
6.12.0-rc3-syzkaller-00087-gc964ced77262 #0 Not tainted
------------------------------------------------------
kswapd0/79 is trying to acquire lock:
ffff888011824088 (&sbi->sb\_lock){++++}-{3:3}, at: f2fs\_down\_write fs/f2fs/f2fs.h:2199 [inline]
ffff888011824088 (&sbi->sb\_lock){++++}-{3:3}, at: f2fs\_record\_stop\_reason+0x52/0x1d0 fs/f2fs/super.c:4068
but task is already holding lock:
ffff88804bd92610 (sb\_internal#2){.+.+}-{0:0}, at: f2fs\_evict\_inode+0x662/0x15c0 fs/f2fs/inode.c:842
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #2 (sb\_internal#2){.+.+}-{0:0}:
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
percpu\_down\_read include/linux/percpu-rwsem.h:51 [inline]
\_\_sb\_start\_write include/linux/fs.h:1716 [inline]
sb\_start\_intwrite+0x4d/0x1c0 include/linux/fs.h:1899
f2fs\_evict\_inode+0x662/0x15c0 fs/f2fs/inode.c:842
evict+0x4e8/0x9b0 fs/inode.c:725
f2fs\_evict\_inode+0x1a4/0x15c0 fs/f2fs/inode.c:807
evict+0x4e8/0x9b0 fs/inode.c:725
dispose\_list fs/inode.c:774 [inline]
prune\_icache\_sb+0x239/0x2f0 fs/inode.c:963
super\_cache\_scan+0x38c/0x4b0 fs/super.c:223
do\_shrink\_slab+0x701/0x1160 mm/shrinker.c:435
shrink\_slab+0x1093/0x14d0 mm/shrinker.c:662
shrink\_one+0x43b/0x850 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x3799/0x3de0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat mm/vmscan.c:6957 [inline]
kswapd+0x1ca3/0x3700 mm/vmscan.c:7226
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
-> #1 (fs\_reclaim){+.+.}-{0:0}:
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
\_\_fs\_reclaim\_acquire mm/page\_alloc.c:3834 [inline]
fs\_reclaim\_acquire+0x88/0x130 mm/page\_alloc.c:3848
might\_alloc include/linux/sched/mm.h:318 [inline]
prepare\_alloc\_pages+0x147/0x5b0 mm/page\_alloc.c:4493
\_\_alloc\_pages\_noprof+0x16f/0x710 mm/page\_alloc.c:4722
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_pages\_noprof mm/mempolicy.c:2345 [inline]
folio\_alloc\_noprof+0x128/0x180 mm/mempolicy.c:2352
filemap\_alloc\_folio\_noprof+0xdf/0x500 mm/filemap.c:1010
do\_read\_cache\_folio+0x2eb/0x850 mm/filemap.c:3787
read\_mapping\_folio include/linux/pagemap.h:1011 [inline]
f2fs\_commit\_super+0x3c0/0x7d0 fs/f2fs/super.c:4032
f2fs\_record\_stop\_reason+0x13b/0x1d0 fs/f2fs/super.c:4079
f2fs\_handle\_critical\_error+0x2ac/0x5c0 fs/f2fs/super.c:4174
f2fs\_write\_inode+0x35f/0x4d0 fs/f2fs/inode.c:785
write\_inode fs/fs-writeback.c:1503 [inline]
\_\_writeback\_single\_inode+0x711/0x10d0 fs/fs-writeback.c:1723
writeback\_single\_inode+0x1f3/0x660 fs/fs-writeback.c:1779
sync\_inode\_metadata+0xc4/0x120 fs/fs-writeback.c:2849
f2fs\_release\_file+0xa8/0x100 fs/f2fs/file.c:1941
\_\_fput+0x23f/0x880 fs/file\_table.c:431
task\_work\_run+0x24f/0x310 kernel/task\_work.c:228
resume\_user\_mode\_work include/linux/resume\_user\_mode.h:50 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:114 [inline]
exit\_to\_user\_mode\_prepare include/linux/entry-common.h:328 [inline]
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:207 [inline]
syscall\_exit\_to\_user\_mode+0x168/0x370 kernel/entry/common.c:218
do\_syscall\_64+0x100/0x230 arch/x86/entry/common.c:89
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
-> #0 (&sbi->sb\_lock){++++}-{3:3}:
check\_prev\_add kernel/locking/lockdep.c:3161 [inline]
check\_prevs\_add kernel/locking/lockdep.c:3280 [inline]
validate\_chain+0x18ef/0x5920 kernel/locking/lockdep.c:3904
\_\_lock\_acquire+0x1384/0x2050 kernel/locking/lockdep.c:5202
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
down\_write+0x99/0x220 kernel/locking/rwsem.c:1577
f2fs\_down\_write fs/f2fs/f2fs.h:2199 [inline]
f2fs\_record\_stop\_reason+0x52/0x1d0 fs/f2fs/super.c:4068
f2fs\_handle\_critical\_error+0x2ac/0x5c0 fs/f2fs/super.c:4174
f2fs\_evict\_inode+0xa61/0x15c0 fs/f2fs/inode.c:883
evict+0x4e8/0x9b0 fs/inode.c:725
f2fs\_evict\_inode+0x1a4/0x15c0 fs/f2fs/inode.c:807
evict+0x4e8/0x9b0 fs/inode.c:725
dispose\_list fs/inode.c:774 [inline]
prune\_icache\_sb+0x239/0x2f0 fs/inode.c:963
super\_cache\_scan+0x38c/0x4b0 fs/super.c:223
do\_shrink\_slab+0x701/0x1160 mm/shrinker.c:435
shrink\_slab+0x1093/0x14d0 mm/shrinker.c:662
shrink\_one+0x43b/0x850 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x3799/0x3de0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat mm/vmscan.c:6957 [inline]
kswapd+0x1ca3/0x3700 mm/vmscan.c:7226
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
other info that might help us debug this:
Chain exists of:
&sbi->sb\_lock --> fs\_reclaim --> sb\_internal#2
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
rlock(sb\_internal#2);
lock(fs\_reclaim);
lock(sb\_internal#2);
lock(&sbi->sb\_lock);
Root cause is there will be potential deadlock in between
below tasks:
Thread A Kswapd
- f2fs\_ioc\_commit\_atomic\_write
- mnt\_want\_write\_file -- down\_read lock A
- balance\_pgdat
- \_\_fs\_reclaim\_acquire -- lock B
- shrink\_node
- prune\_icache\_sb
- dispose\_list
- f2fs\_evict\_inode
- sb\_start\_intwrite -- down\_read lock A
- f2fs\_do\_sync\_file
- f2fs\_write\_inode
- f2fs\_handle\_critical\_error
- f2fs\_record\_stop\_reason
- f2fs\_commit\_super
- read\_mapping\_folio
- filemap\_alloc\_folio\_noprof
- fs\_reclaim\_acquire -- lock B
Both threads try to acquire read lock of lock A, then its upcoming write
lock grabber will trigger deadlock.
Let's always create an asynchronous task in f2fs\_handle\_critical\_error()
rather than calling f2fs\_record\_stop\_reason() synchronously to avoid
this potential deadlock issue.
Fixes: b62e71be2110 ("f2fs: support errors=remount-ro|continue|panic mountoption")
Reported-by: syzbot+be4a9983e95a5e25c8d3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/6704d667.050a0220.1e4d62.0081.GAE@google.com
Signed-off-by: Chao Yu <chao@kernel.org>
Reviewed-by: Daejun Park <daejun7.park@samsung.com>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=801092a2c9c251ef6a8678fcb8fcc1220474a697)

| -rw-r--r-- | [fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/checkpoint.c?id=801092a2c9c251ef6a8678fcb8fcc1220474a697) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/f2fs.h?id=801092a2c9c251ef6a8678fcb8fcc1220474a697) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/super.c?id=801092a2c9c251ef6a8678fcb8fcc1220474a697) | 13 | |  |  |  | | --- | --- | --- | |

3 files changed, 9 insertions, 9 deletions

| diff --git a/fs/f2fs/checkpoint.c b/fs/f2fs/checkpoint.cindex 7f76460b721f2c..efda9a0229816b 100644--- a/[fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/checkpoint.c?id=5e69964251f93c8152ac0c01c44b3f5f667e0402)+++ b/[fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/checkpoint.c?id=801092a2c9c251ef6a8678fcb8fcc1220474a697)@@ -32,7 +32,7 @@ void f2fs\_stop\_checkpoint(struct f2fs\_sb\_info \*sbi, bool end\_io, f2fs\_build\_fault\_attr(sbi, 0, 0); if (!end\_io) f2fs\_flush\_merged\_writes(sbi);- f2fs\_handle\_critical\_error(sbi, reason, end\_io);+ f2fs\_handle\_critical\_error(sbi, reason); }  /\*diff --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.hindex 33f5449dc22d50..93a5e1c24e566e 100644--- a/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=5e69964251f93c8152ac0c01c44b3f5f667e0402)+++ b/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=801092a2c9c251ef6a8678fcb8fcc1220474a697)@@ -3632,8 +3632,7 @@ int f2fs\_quota\_sync(struct super\_block \*sb, int type); loff\_t max\_file\_blocks(struct inode \*inode); void f2fs\_quota\_off\_umount(struct super\_block \*sb); void f2fs\_save\_errors(struct f2fs\_sb\_info \*sbi, unsigned char flag);-void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason,- bool irq\_context);+void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason); void f2fs\_handle\_error(struct f2fs\_sb\_info \*sbi, unsigned char error); void f2fs\_handle\_error\_async(struct f2fs\_sb\_info \*sbi, unsigned char error); int f2fs\_commit\_super(struct f2fs\_sb\_info \*sbi, bool recover);diff --git a/fs/f2fs/super.c b/fs/f2fs/super.cindex 8d4ecb2e855e67..0b5114caa37a18 100644--- a/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=5e69964251f93c8152ac0c01c44b3f5f667e0402)+++ b/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=801092a2c9c251ef6a8678fcb8fcc1220474a697)@@ -4155,8 +4155,7 @@ static bool system\_going\_down(void) || system\_state == SYSTEM\_RESTART; } -void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason,- bool irq\_context)+void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason) { struct super\_block \*sb = sbi->sb; bool shutdown = reason == STOP\_CP\_REASON\_SHUTDOWN;@@ -4168,10 +4167,12 @@ void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason, if (!f2fs\_hw\_is\_readonly(sbi)) { save\_stop\_reason(sbi, reason); - if (irq\_context && !shutdown)- schedule\_work(&sbi->s\_error\_work);- else- f2fs\_record\_stop\_reason(sbi);+ /\*+ \* always create an asynchronous task to record stop\_reason+ \* in order to avoid potential deadlock when running into+ \* f2fs\_record\_stop\_reason() synchronously.+ \*/+ schedule\_work(&sbi->s\_error\_work); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:25:27 +0000



=== Content from git.kernel.org_f459f818_20250114_232652.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-10-22 16:36:23 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:26 +0100 |
| commit | [ecf4e6782b01fd578b565b3dd2be7bb0ac91082e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e)) | |
| tree | [7b68c3658a2fc94a723cd27a9480fba149dd983e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e) | |
| parent | [67f4c664601166dd7be4eb639f78ae28001653f3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=67f4c664601166dd7be4eb639f78ae28001653f3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e&id2=67f4c664601166dd7be4eb639f78ae28001653f3)) | |
| download | [linux-ecf4e6782b01fd578b565b3dd2be7bb0ac91082e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ecf4e6782b01fd578b565b3dd2be7bb0ac91082e.tar.gz) | |

f2fs: fix to avoid potential deadlock in f2fs\_record\_stop\_reason()[ Upstream commit f10a890308a7cd8794e21f646f09827c6cb4bf5d ]
syzbot reports deadlock issue of f2fs as below:
======================================================
WARNING: possible circular locking dependency detected
6.12.0-rc3-syzkaller-00087-gc964ced77262 #0 Not tainted
------------------------------------------------------
kswapd0/79 is trying to acquire lock:
ffff888011824088 (&sbi->sb\_lock){++++}-{3:3}, at: f2fs\_down\_write fs/f2fs/f2fs.h:2199 [inline]
ffff888011824088 (&sbi->sb\_lock){++++}-{3:3}, at: f2fs\_record\_stop\_reason+0x52/0x1d0 fs/f2fs/super.c:4068
but task is already holding lock:
ffff88804bd92610 (sb\_internal#2){.+.+}-{0:0}, at: f2fs\_evict\_inode+0x662/0x15c0 fs/f2fs/inode.c:842
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #2 (sb\_internal#2){.+.+}-{0:0}:
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
percpu\_down\_read include/linux/percpu-rwsem.h:51 [inline]
\_\_sb\_start\_write include/linux/fs.h:1716 [inline]
sb\_start\_intwrite+0x4d/0x1c0 include/linux/fs.h:1899
f2fs\_evict\_inode+0x662/0x15c0 fs/f2fs/inode.c:842
evict+0x4e8/0x9b0 fs/inode.c:725
f2fs\_evict\_inode+0x1a4/0x15c0 fs/f2fs/inode.c:807
evict+0x4e8/0x9b0 fs/inode.c:725
dispose\_list fs/inode.c:774 [inline]
prune\_icache\_sb+0x239/0x2f0 fs/inode.c:963
super\_cache\_scan+0x38c/0x4b0 fs/super.c:223
do\_shrink\_slab+0x701/0x1160 mm/shrinker.c:435
shrink\_slab+0x1093/0x14d0 mm/shrinker.c:662
shrink\_one+0x43b/0x850 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x3799/0x3de0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat mm/vmscan.c:6957 [inline]
kswapd+0x1ca3/0x3700 mm/vmscan.c:7226
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
-> #1 (fs\_reclaim){+.+.}-{0:0}:
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
\_\_fs\_reclaim\_acquire mm/page\_alloc.c:3834 [inline]
fs\_reclaim\_acquire+0x88/0x130 mm/page\_alloc.c:3848
might\_alloc include/linux/sched/mm.h:318 [inline]
prepare\_alloc\_pages+0x147/0x5b0 mm/page\_alloc.c:4493
\_\_alloc\_pages\_noprof+0x16f/0x710 mm/page\_alloc.c:4722
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_pages\_noprof mm/mempolicy.c:2345 [inline]
folio\_alloc\_noprof+0x128/0x180 mm/mempolicy.c:2352
filemap\_alloc\_folio\_noprof+0xdf/0x500 mm/filemap.c:1010
do\_read\_cache\_folio+0x2eb/0x850 mm/filemap.c:3787
read\_mapping\_folio include/linux/pagemap.h:1011 [inline]
f2fs\_commit\_super+0x3c0/0x7d0 fs/f2fs/super.c:4032
f2fs\_record\_stop\_reason+0x13b/0x1d0 fs/f2fs/super.c:4079
f2fs\_handle\_critical\_error+0x2ac/0x5c0 fs/f2fs/super.c:4174
f2fs\_write\_inode+0x35f/0x4d0 fs/f2fs/inode.c:785
write\_inode fs/fs-writeback.c:1503 [inline]
\_\_writeback\_single\_inode+0x711/0x10d0 fs/fs-writeback.c:1723
writeback\_single\_inode+0x1f3/0x660 fs/fs-writeback.c:1779
sync\_inode\_metadata+0xc4/0x120 fs/fs-writeback.c:2849
f2fs\_release\_file+0xa8/0x100 fs/f2fs/file.c:1941
\_\_fput+0x23f/0x880 fs/file\_table.c:431
task\_work\_run+0x24f/0x310 kernel/task\_work.c:228
resume\_user\_mode\_work include/linux/resume\_user\_mode.h:50 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:114 [inline]
exit\_to\_user\_mode\_prepare include/linux/entry-common.h:328 [inline]
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:207 [inline]
syscall\_exit\_to\_user\_mode+0x168/0x370 kernel/entry/common.c:218
do\_syscall\_64+0x100/0x230 arch/x86/entry/common.c:89
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
-> #0 (&sbi->sb\_lock){++++}-{3:3}:
check\_prev\_add kernel/locking/lockdep.c:3161 [inline]
check\_prevs\_add kernel/locking/lockdep.c:3280 [inline]
validate\_chain+0x18ef/0x5920 kernel/locking/lockdep.c:3904
\_\_lock\_acquire+0x1384/0x2050 kernel/locking/lockdep.c:5202
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
down\_write+0x99/0x220 kernel/locking/rwsem.c:1577
f2fs\_down\_write fs/f2fs/f2fs.h:2199 [inline]
f2fs\_record\_stop\_reason+0x52/0x1d0 fs/f2fs/super.c:4068
f2fs\_handle\_critical\_error+0x2ac/0x5c0 fs/f2fs/super.c:4174
f2fs\_evict\_inode+0xa61/0x15c0 fs/f2fs/inode.c:883
evict+0x4e8/0x9b0 fs/inode.c:725
f2fs\_evict\_inode+0x1a4/0x15c0 fs/f2fs/inode.c:807
evict+0x4e8/0x9b0 fs/inode.c:725
dispose\_list fs/inode.c:774 [inline]
prune\_icache\_sb+0x239/0x2f0 fs/inode.c:963
super\_cache\_scan+0x38c/0x4b0 fs/super.c:223
do\_shrink\_slab+0x701/0x1160 mm/shrinker.c:435
shrink\_slab+0x1093/0x14d0 mm/shrinker.c:662
shrink\_one+0x43b/0x850 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x3799/0x3de0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat mm/vmscan.c:6957 [inline]
kswapd+0x1ca3/0x3700 mm/vmscan.c:7226
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
other info that might help us debug this:
Chain exists of:
&sbi->sb\_lock --> fs\_reclaim --> sb\_internal#2
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
rlock(sb\_internal#2);
lock(fs\_reclaim);
lock(sb\_internal#2);
lock(&sbi->sb\_lock);
Root cause is there will be potential deadlock in between
below tasks:
Thread A Kswapd
- f2fs\_ioc\_commit\_atomic\_write
- mnt\_want\_write\_file -- down\_read lock A
- balance\_pgdat
- \_\_fs\_reclaim\_acquire -- lock B
- shrink\_node
- prune\_icache\_sb
- dispose\_list
- f2fs\_evict\_inode
- sb\_start\_intwrite -- down\_read lock A
- f2fs\_do\_sync\_file
- f2fs\_write\_inode
- f2fs\_handle\_critical\_error
- f2fs\_record\_stop\_reason
- f2fs\_commit\_super
- read\_mapping\_folio
- filemap\_alloc\_folio\_noprof
- fs\_reclaim\_acquire -- lock B
Both threads try to acquire read lock of lock A, then its upcoming write
lock grabber will trigger deadlock.
Let's always create an asynchronous task in f2fs\_handle\_critical\_error()
rather than calling f2fs\_record\_stop\_reason() synchronously to avoid
this potential deadlock issue.
Fixes: b62e71be2110 ("f2fs: support errors=remount-ro|continue|panic mountoption")
Reported-by: syzbot+be4a9983e95a5e25c8d3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/6704d667.050a0220.1e4d62.0081.GAE@google.com
Signed-off-by: Chao Yu <chao@kernel.org>
Reviewed-by: Daejun Park <daejun7.park@samsung.com>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e)

| -rw-r--r-- | [fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/checkpoint.c?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/f2fs.h?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/super.c?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e) | 13 | |  |  |  | | --- | --- | --- | |

3 files changed, 9 insertions, 9 deletions

| diff --git a/fs/f2fs/checkpoint.c b/fs/f2fs/checkpoint.cindex 1a33a8c1623f24..c6317596e695cc 100644--- a/[fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/checkpoint.c?id=67f4c664601166dd7be4eb639f78ae28001653f3)+++ b/[fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/checkpoint.c?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e)@@ -32,7 +32,7 @@ void f2fs\_stop\_checkpoint(struct f2fs\_sb\_info \*sbi, bool end\_io, f2fs\_build\_fault\_attr(sbi, 0, 0); if (!end\_io) f2fs\_flush\_merged\_writes(sbi);- f2fs\_handle\_critical\_error(sbi, reason, end\_io);+ f2fs\_handle\_critical\_error(sbi, reason); }  /\*diff --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.hindex 7faf9446ea5dcb..33620642ae5ec8 100644--- a/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=67f4c664601166dd7be4eb639f78ae28001653f3)+++ b/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e)@@ -3588,8 +3588,7 @@ int f2fs\_quota\_sync(struct super\_block \*sb, int type); loff\_t max\_file\_blocks(struct inode \*inode); void f2fs\_quota\_off\_umount(struct super\_block \*sb); void f2fs\_save\_errors(struct f2fs\_sb\_info \*sbi, unsigned char flag);-void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason,- bool irq\_context);+void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason); void f2fs\_handle\_error(struct f2fs\_sb\_info \*sbi, unsigned char error); void f2fs\_handle\_error\_async(struct f2fs\_sb\_info \*sbi, unsigned char error); int f2fs\_commit\_super(struct f2fs\_sb\_info \*sbi, bool recover);diff --git a/fs/f2fs/super.c b/fs/f2fs/super.cindex 540fa1dfc77dff..f05d0e43db9e22 100644--- a/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=67f4c664601166dd7be4eb639f78ae28001653f3)+++ b/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=ecf4e6782b01fd578b565b3dd2be7bb0ac91082e)@@ -4093,8 +4093,7 @@ static bool system\_going\_down(void) || system\_state == SYSTEM\_RESTART; } -void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason,- bool irq\_context)+void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason) { struct super\_block \*sb = sbi->sb; bool shutdown = reason == STOP\_CP\_REASON\_SHUTDOWN;@@ -4106,10 +4105,12 @@ void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason, if (!f2fs\_hw\_is\_readonly(sbi)) { save\_stop\_reason(sbi, reason); - if (irq\_context && !shutdown)- schedule\_work(&sbi->s\_error\_work);- else- f2fs\_record\_stop\_reason(sbi);+ /\*+ \* always create an asynchronous task to record stop\_reason+ \* in order to avoid potential deadlock when running into+ \* f2fs\_record\_stop\_reason() synchronously.+ \*/+ schedule\_work(&sbi->s\_error\_work); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:25:29 +0000



=== Content from git.kernel.org_b5bbef0c_20250114_232649.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1539a088b108996bcdaddb7775070b5163b14233)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1539a088b108996bcdaddb7775070b5163b14233)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1539a088b108996bcdaddb7775070b5163b14233)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1539a088b108996bcdaddb7775070b5163b14233)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-10-22 16:36:23 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:49 +0100 |
| commit | [1539a088b108996bcdaddb7775070b5163b14233](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1539a088b108996bcdaddb7775070b5163b14233) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1539a088b108996bcdaddb7775070b5163b14233)) | |
| tree | [e81f5fc51be95101ea90725c61bb4d250e78d8e9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1539a088b108996bcdaddb7775070b5163b14233) | |
| parent | [9075aeef6a269322ac3632cf4f97cef3cef158dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9075aeef6a269322ac3632cf4f97cef3cef158dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1539a088b108996bcdaddb7775070b5163b14233&id2=9075aeef6a269322ac3632cf4f97cef3cef158dd)) | |
| download | [linux-1539a088b108996bcdaddb7775070b5163b14233.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1539a088b108996bcdaddb7775070b5163b14233.tar.gz) | |

f2fs: fix to avoid potential deadlock in f2fs\_record\_stop\_reason()[ Upstream commit f10a890308a7cd8794e21f646f09827c6cb4bf5d ]
syzbot reports deadlock issue of f2fs as below:
======================================================
WARNING: possible circular locking dependency detected
6.12.0-rc3-syzkaller-00087-gc964ced77262 #0 Not tainted
------------------------------------------------------
kswapd0/79 is trying to acquire lock:
ffff888011824088 (&sbi->sb\_lock){++++}-{3:3}, at: f2fs\_down\_write fs/f2fs/f2fs.h:2199 [inline]
ffff888011824088 (&sbi->sb\_lock){++++}-{3:3}, at: f2fs\_record\_stop\_reason+0x52/0x1d0 fs/f2fs/super.c:4068
but task is already holding lock:
ffff88804bd92610 (sb\_internal#2){.+.+}-{0:0}, at: f2fs\_evict\_inode+0x662/0x15c0 fs/f2fs/inode.c:842
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #2 (sb\_internal#2){.+.+}-{0:0}:
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
percpu\_down\_read include/linux/percpu-rwsem.h:51 [inline]
\_\_sb\_start\_write include/linux/fs.h:1716 [inline]
sb\_start\_intwrite+0x4d/0x1c0 include/linux/fs.h:1899
f2fs\_evict\_inode+0x662/0x15c0 fs/f2fs/inode.c:842
evict+0x4e8/0x9b0 fs/inode.c:725
f2fs\_evict\_inode+0x1a4/0x15c0 fs/f2fs/inode.c:807
evict+0x4e8/0x9b0 fs/inode.c:725
dispose\_list fs/inode.c:774 [inline]
prune\_icache\_sb+0x239/0x2f0 fs/inode.c:963
super\_cache\_scan+0x38c/0x4b0 fs/super.c:223
do\_shrink\_slab+0x701/0x1160 mm/shrinker.c:435
shrink\_slab+0x1093/0x14d0 mm/shrinker.c:662
shrink\_one+0x43b/0x850 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x3799/0x3de0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat mm/vmscan.c:6957 [inline]
kswapd+0x1ca3/0x3700 mm/vmscan.c:7226
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
-> #1 (fs\_reclaim){+.+.}-{0:0}:
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
\_\_fs\_reclaim\_acquire mm/page\_alloc.c:3834 [inline]
fs\_reclaim\_acquire+0x88/0x130 mm/page\_alloc.c:3848
might\_alloc include/linux/sched/mm.h:318 [inline]
prepare\_alloc\_pages+0x147/0x5b0 mm/page\_alloc.c:4493
\_\_alloc\_pages\_noprof+0x16f/0x710 mm/page\_alloc.c:4722
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_pages\_noprof mm/mempolicy.c:2345 [inline]
folio\_alloc\_noprof+0x128/0x180 mm/mempolicy.c:2352
filemap\_alloc\_folio\_noprof+0xdf/0x500 mm/filemap.c:1010
do\_read\_cache\_folio+0x2eb/0x850 mm/filemap.c:3787
read\_mapping\_folio include/linux/pagemap.h:1011 [inline]
f2fs\_commit\_super+0x3c0/0x7d0 fs/f2fs/super.c:4032
f2fs\_record\_stop\_reason+0x13b/0x1d0 fs/f2fs/super.c:4079
f2fs\_handle\_critical\_error+0x2ac/0x5c0 fs/f2fs/super.c:4174
f2fs\_write\_inode+0x35f/0x4d0 fs/f2fs/inode.c:785
write\_inode fs/fs-writeback.c:1503 [inline]
\_\_writeback\_single\_inode+0x711/0x10d0 fs/fs-writeback.c:1723
writeback\_single\_inode+0x1f3/0x660 fs/fs-writeback.c:1779
sync\_inode\_metadata+0xc4/0x120 fs/fs-writeback.c:2849
f2fs\_release\_file+0xa8/0x100 fs/f2fs/file.c:1941
\_\_fput+0x23f/0x880 fs/file\_table.c:431
task\_work\_run+0x24f/0x310 kernel/task\_work.c:228
resume\_user\_mode\_work include/linux/resume\_user\_mode.h:50 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:114 [inline]
exit\_to\_user\_mode\_prepare include/linux/entry-common.h:328 [inline]
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:207 [inline]
syscall\_exit\_to\_user\_mode+0x168/0x370 kernel/entry/common.c:218
do\_syscall\_64+0x100/0x230 arch/x86/entry/common.c:89
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
-> #0 (&sbi->sb\_lock){++++}-{3:3}:
check\_prev\_add kernel/locking/lockdep.c:3161 [inline]
check\_prevs\_add kernel/locking/lockdep.c:3280 [inline]
validate\_chain+0x18ef/0x5920 kernel/locking/lockdep.c:3904
\_\_lock\_acquire+0x1384/0x2050 kernel/locking/lockdep.c:5202
lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5825
down\_write+0x99/0x220 kernel/locking/rwsem.c:1577
f2fs\_down\_write fs/f2fs/f2fs.h:2199 [inline]
f2fs\_record\_stop\_reason+0x52/0x1d0 fs/f2fs/super.c:4068
f2fs\_handle\_critical\_error+0x2ac/0x5c0 fs/f2fs/super.c:4174
f2fs\_evict\_inode+0xa61/0x15c0 fs/f2fs/inode.c:883
evict+0x4e8/0x9b0 fs/inode.c:725
f2fs\_evict\_inode+0x1a4/0x15c0 fs/f2fs/inode.c:807
evict+0x4e8/0x9b0 fs/inode.c:725
dispose\_list fs/inode.c:774 [inline]
prune\_icache\_sb+0x239/0x2f0 fs/inode.c:963
super\_cache\_scan+0x38c/0x4b0 fs/super.c:223
do\_shrink\_slab+0x701/0x1160 mm/shrinker.c:435
shrink\_slab+0x1093/0x14d0 mm/shrinker.c:662
shrink\_one+0x43b/0x850 mm/vmscan.c:4818
shrink\_many mm/vmscan.c:4879 [inline]
lru\_gen\_shrink\_node mm/vmscan.c:4957 [inline]
shrink\_node+0x3799/0x3de0 mm/vmscan.c:5937
kswapd\_shrink\_node mm/vmscan.c:6765 [inline]
balance\_pgdat mm/vmscan.c:6957 [inline]
kswapd+0x1ca3/0x3700 mm/vmscan.c:7226
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
other info that might help us debug this:
Chain exists of:
&sbi->sb\_lock --> fs\_reclaim --> sb\_internal#2
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
rlock(sb\_internal#2);
lock(fs\_reclaim);
lock(sb\_internal#2);
lock(&sbi->sb\_lock);
Root cause is there will be potential deadlock in between
below tasks:
Thread A Kswapd
- f2fs\_ioc\_commit\_atomic\_write
- mnt\_want\_write\_file -- down\_read lock A
- balance\_pgdat
- \_\_fs\_reclaim\_acquire -- lock B
- shrink\_node
- prune\_icache\_sb
- dispose\_list
- f2fs\_evict\_inode
- sb\_start\_intwrite -- down\_read lock A
- f2fs\_do\_sync\_file
- f2fs\_write\_inode
- f2fs\_handle\_critical\_error
- f2fs\_record\_stop\_reason
- f2fs\_commit\_super
- read\_mapping\_folio
- filemap\_alloc\_folio\_noprof
- fs\_reclaim\_acquire -- lock B
Both threads try to acquire read lock of lock A, then its upcoming write
lock grabber will trigger deadlock.
Let's always create an asynchronous task in f2fs\_handle\_critical\_error()
rather than calling f2fs\_record\_stop\_reason() synchronously to avoid
this potential deadlock issue.
Fixes: b62e71be2110 ("f2fs: support errors=remount-ro|continue|panic mountoption")
Reported-by: syzbot+be4a9983e95a5e25c8d3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/6704d667.050a0220.1e4d62.0081.GAE@google.com
Signed-off-by: Chao Yu <chao@kernel.org>
Reviewed-by: Daejun Park <daejun7.park@samsung.com>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1539a088b108996bcdaddb7775070b5163b14233)

| -rw-r--r-- | [fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/checkpoint.c?id=1539a088b108996bcdaddb7775070b5163b14233) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/f2fs.h?id=1539a088b108996bcdaddb7775070b5163b14233) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/super.c?id=1539a088b108996bcdaddb7775070b5163b14233) | 13 | |  |  |  | | --- | --- | --- | |

3 files changed, 9 insertions, 9 deletions

| diff --git a/fs/f2fs/checkpoint.c b/fs/f2fs/checkpoint.cindex bdd96329dddd49..4184755535553b 100644--- a/[fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/checkpoint.c?id=9075aeef6a269322ac3632cf4f97cef3cef158dd)+++ b/[fs/f2fs/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/checkpoint.c?id=1539a088b108996bcdaddb7775070b5163b14233)@@ -32,7 +32,7 @@ void f2fs\_stop\_checkpoint(struct f2fs\_sb\_info \*sbi, bool end\_io, f2fs\_build\_fault\_attr(sbi, 0, 0); if (!end\_io) f2fs\_flush\_merged\_writes(sbi);- f2fs\_handle\_critical\_error(sbi, reason, end\_io);+ f2fs\_handle\_critical\_error(sbi, reason); }  /\*diff --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.hindex 3bdfa53b24bb9e..0c8afcd6385184 100644--- a/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=9075aeef6a269322ac3632cf4f97cef3cef158dd)+++ b/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=1539a088b108996bcdaddb7775070b5163b14233)@@ -3635,8 +3635,7 @@ int f2fs\_quota\_sync(struct super\_block \*sb, int type); loff\_t max\_file\_blocks(struct inode \*inode); void f2fs\_quota\_off\_umount(struct super\_block \*sb); void f2fs\_save\_errors(struct f2fs\_sb\_info \*sbi, unsigned char flag);-void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason,- bool irq\_context);+void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason); void f2fs\_handle\_error(struct f2fs\_sb\_info \*sbi, unsigned char error); void f2fs\_handle\_error\_async(struct f2fs\_sb\_info \*sbi, unsigned char error); int f2fs\_commit\_super(struct f2fs\_sb\_info \*sbi, bool recover);diff --git a/fs/f2fs/super.c b/fs/f2fs/super.cindex 615ca1f0ef59ba..bb892d92c5b263 100644--- a/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=9075aeef6a269322ac3632cf4f97cef3cef158dd)+++ b/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=1539a088b108996bcdaddb7775070b5163b14233)@@ -4136,8 +4136,7 @@ static bool system\_going\_down(void) || system\_state == SYSTEM\_RESTART; } -void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason,- bool irq\_context)+void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason) { struct super\_block \*sb = sbi->sb; bool shutdown = reason == STOP\_CP\_REASON\_SHUTDOWN;@@ -4149,10 +4148,12 @@ void f2fs\_handle\_critical\_error(struct f2fs\_sb\_info \*sbi, unsigned char reason, if (!f2fs\_hw\_is\_readonly(sbi)) { save\_stop\_reason(sbi, reason); - if (irq\_context && !shutdown)- schedule\_work(&sbi->s\_error\_work);- else- f2fs\_record\_stop\_reason(sbi);+ /\*+ \* always create an asynchronous task to record stop\_reason+ \* in order to avoid potential deadlock when running into+ \* f2fs\_record\_stop\_reason() synchronously.+ \*/+ schedule\_work(&sbi->s\_error\_work); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:25:25 +0000


