=== Content from git.kernel.org_5dd49857_20250115_090604.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-12-10 17:32:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:12:58 +0100 |
| commit | [9b53d2c2a38a1effc341d99be3f99fa7ef17047d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d)) | |
| tree | [74eb441164547985dcf00fdafc61dcafe258b0fc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d) | |
| parent | [7415bc5198efa973da1d5cdd62d8ee68021848ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7415bc5198efa973da1d5cdd62d8ee68021848ed) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d&id2=7415bc5198efa973da1d5cdd62d8ee68021848ed)) | |
| download | [linux-9b53d2c2a38a1effc341d99be3f99fa7ef17047d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9b53d2c2a38a1effc341d99be3f99fa7ef17047d.tar.gz) | |

bpf: Fix UAF via mismatching bpf\_prog/attachment RCU flavorscommit ef1b808e3b7c98612feceedf985c2fbbeb28f956 upstream.
Uprobes always use bpf\_prog\_run\_array\_uprobe() under tasks-trace-RCU
protection. But it is possible to attach a non-sleepable BPF program to a
uprobe, and non-sleepable BPF programs are freed via normal RCU (see
\_\_bpf\_prog\_put\_noref()). This leads to UAF of the bpf\_prog because a normal
RCU grace period does not imply a tasks-trace-RCU grace period.
Fix it by explicitly waiting for a tasks-trace-RCU grace period after
removing the attachment of a bpf\_prog to a perf\_event.
Fixes: 8c7dcb84e3b7 ("bpf: implement sleepable uprobes by chaining gps")
Suggested-by: Andrii Nakryiko <andrii@kernel.org>
Suggested-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/bpf/20241210-bpf-fix-actual-uprobe-uaf-v1-1-19439849dd44@google.com](https://lore.kernel.org/bpf/20241210-bpf-fix-actual-uprobe-uaf-v1-1-19439849dd44%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d)

| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex 792dc35414a3c3..841c59a6135a77 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=7415bc5198efa973da1d5cdd62d8ee68021848ed)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=9b53d2c2a38a1effc341d99be3f99fa7ef17047d)@@ -2223,6 +2223,13 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) bpf\_prog\_array\_free\_sleepable(old\_array); } + /\*+ \* It could be that the bpf\_prog is not sleepable (and will be freed+ \* via normal RCU), but is called from a point that supports sleepable+ \* programs and uses tasks-trace-RCU.+ \*/+ synchronize\_rcu\_tasks\_trace();+ bpf\_prog\_put(event->prog); event->prog = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:04:41 +0000



=== Content from git.kernel.org_d2520f13_20250115_090604.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-12-10 17:32:13 +0100 |
| --- | --- | --- |
| committer | Andrii Nakryiko <andrii@kernel.org> | 2024-12-10 10:14:02 -0800 |
| commit | [ef1b808e3b7c98612feceedf985c2fbbeb28f956](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956)) | |
| tree | [5d50f07351c8df31a38dce909f50075f061e8afe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956) | |
| parent | [11d5245f608f8ac01c97b93f31497cef7b96e457](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11d5245f608f8ac01c97b93f31497cef7b96e457) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956&id2=11d5245f608f8ac01c97b93f31497cef7b96e457)) | |
| download | [linux-ef1b808e3b7c98612feceedf985c2fbbeb28f956.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ef1b808e3b7c98612feceedf985c2fbbeb28f956.tar.gz) | |

bpf: Fix UAF via mismatching bpf\_prog/attachment RCU flavorsUprobes always use bpf\_prog\_run\_array\_uprobe() under tasks-trace-RCU
protection. But it is possible to attach a non-sleepable BPF program to a
uprobe, and non-sleepable BPF programs are freed via normal RCU (see
\_\_bpf\_prog\_put\_noref()). This leads to UAF of the bpf\_prog because a normal
RCU grace period does not imply a tasks-trace-RCU grace period.
Fix it by explicitly waiting for a tasks-trace-RCU grace period after
removing the attachment of a bpf\_prog to a perf\_event.
Fixes: 8c7dcb84e3b7 ("bpf: implement sleepable uprobes by chaining gps")
Suggested-by: Andrii Nakryiko <andrii@kernel.org>
Suggested-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/bpf/20241210-bpf-fix-actual-uprobe-uaf-v1-1-19439849dd44@google.com](https://lore.kernel.org/bpf/20241210-bpf-fix-actual-uprobe-uaf-v1-1-19439849dd44%40google.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956)

| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex 949a3870946c38..a403b05a709138 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=11d5245f608f8ac01c97b93f31497cef7b96e457)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956)@@ -2258,6 +2258,13 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) bpf\_prog\_array\_free\_sleepable(old\_array); } + /\*+ \* It could be that the bpf\_prog is not sleepable (and will be freed+ \* via normal RCU), but is called from a point that supports sleepable+ \* programs and uses tasks-trace-RCU.+ \*/+ synchronize\_rcu\_tasks\_trace();+ bpf\_prog\_put(event->prog); event->prog = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:04:41 +0000



=== Content from git.kernel.org_94abf2e1_20250115_090603.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9245459a992d22fe0e92e988f49db1fec82c184a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9245459a992d22fe0e92e988f49db1fec82c184a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9245459a992d22fe0e92e988f49db1fec82c184a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9245459a992d22fe0e92e988f49db1fec82c184a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-12-10 17:32:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:08:48 +0100 |
| commit | [9245459a992d22fe0e92e988f49db1fec82c184a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9245459a992d22fe0e92e988f49db1fec82c184a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9245459a992d22fe0e92e988f49db1fec82c184a)) | |
| tree | [74b91ee31e759ed7b252029603afece1ebec4396](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9245459a992d22fe0e92e988f49db1fec82c184a) | |
| parent | [52f863f820fd540a98596d0dc33ae5cb524fa1e9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52f863f820fd540a98596d0dc33ae5cb524fa1e9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9245459a992d22fe0e92e988f49db1fec82c184a&id2=52f863f820fd540a98596d0dc33ae5cb524fa1e9)) | |
| download | [linux-9245459a992d22fe0e92e988f49db1fec82c184a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9245459a992d22fe0e92e988f49db1fec82c184a.tar.gz) | |

bpf: Fix UAF via mismatching bpf\_prog/attachment RCU flavorscommit ef1b808e3b7c98612feceedf985c2fbbeb28f956 upstream.
Uprobes always use bpf\_prog\_run\_array\_uprobe() under tasks-trace-RCU
protection. But it is possible to attach a non-sleepable BPF program to a
uprobe, and non-sleepable BPF programs are freed via normal RCU (see
\_\_bpf\_prog\_put\_noref()). This leads to UAF of the bpf\_prog because a normal
RCU grace period does not imply a tasks-trace-RCU grace period.
Fix it by explicitly waiting for a tasks-trace-RCU grace period after
removing the attachment of a bpf\_prog to a perf\_event.
Fixes: 8c7dcb84e3b7 ("bpf: implement sleepable uprobes by chaining gps")
Suggested-by: Andrii Nakryiko <andrii@kernel.org>
Suggested-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/bpf/20241210-bpf-fix-actual-uprobe-uaf-v1-1-19439849dd44@google.com](https://lore.kernel.org/bpf/20241210-bpf-fix-actual-uprobe-uaf-v1-1-19439849dd44%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9245459a992d22fe0e92e988f49db1fec82c184a)

| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=9245459a992d22fe0e92e988f49db1fec82c184a) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex d8212fea1e99d9..2c4995f1a50490 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=52f863f820fd540a98596d0dc33ae5cb524fa1e9)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=9245459a992d22fe0e92e988f49db1fec82c184a)@@ -2188,6 +2188,13 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) bpf\_prog\_array\_free\_sleepable(old\_array); } + /\*+ \* It could be that the bpf\_prog is not sleepable (and will be freed+ \* via normal RCU), but is called from a point that supports sleepable+ \* programs and uses tasks-trace-RCU.+ \*/+ synchronize\_rcu\_tasks\_trace();+ bpf\_prog\_put(event->prog); event->prog = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:04:40 +0000



=== Content from git.kernel.org_2edf0555_20250115_090605.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f9f85df30118f3f4112761e6682fc60ebcce23e5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f9f85df30118f3f4112761e6682fc60ebcce23e5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f9f85df30118f3f4112761e6682fc60ebcce23e5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f9f85df30118f3f4112761e6682fc60ebcce23e5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-12-10 17:32:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:11:21 +0100 |
| commit | [f9f85df30118f3f4112761e6682fc60ebcce23e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f9f85df30118f3f4112761e6682fc60ebcce23e5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f9f85df30118f3f4112761e6682fc60ebcce23e5)) | |
| tree | [19a86caca13923ba286b22b2640f706ab11a78a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f9f85df30118f3f4112761e6682fc60ebcce23e5) | |
| parent | [a66cdcdc9e44b4c508190ea3cde5750954d1c4eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a66cdcdc9e44b4c508190ea3cde5750954d1c4eb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f9f85df30118f3f4112761e6682fc60ebcce23e5&id2=a66cdcdc9e44b4c508190ea3cde5750954d1c4eb)) | |
| download | [linux-f9f85df30118f3f4112761e6682fc60ebcce23e5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f9f85df30118f3f4112761e6682fc60ebcce23e5.tar.gz) | |

bpf: Fix UAF via mismatching bpf\_prog/attachment RCU flavorscommit ef1b808e3b7c98612feceedf985c2fbbeb28f956 upstream.
Uprobes always use bpf\_prog\_run\_array\_uprobe() under tasks-trace-RCU
protection. But it is possible to attach a non-sleepable BPF program to a
uprobe, and non-sleepable BPF programs are freed via normal RCU (see
\_\_bpf\_prog\_put\_noref()). This leads to UAF of the bpf\_prog because a normal
RCU grace period does not imply a tasks-trace-RCU grace period.
Fix it by explicitly waiting for a tasks-trace-RCU grace period after
removing the attachment of a bpf\_prog to a perf\_event.
Fixes: 8c7dcb84e3b7 ("bpf: implement sleepable uprobes by chaining gps")
Suggested-by: Andrii Nakryiko <andrii@kernel.org>
Suggested-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/bpf/20241210-bpf-fix-actual-uprobe-uaf-v1-1-19439849dd44@google.com](https://lore.kernel.org/bpf/20241210-bpf-fix-actual-uprobe-uaf-v1-1-19439849dd44%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f9f85df30118f3f4112761e6682fc60ebcce23e5)

| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=f9f85df30118f3f4112761e6682fc60ebcce23e5) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex e8fb6ada323c1a..99b8c2cf217a21 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=a66cdcdc9e44b4c508190ea3cde5750954d1c4eb)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=f9f85df30118f3f4112761e6682fc60ebcce23e5)@@ -2224,6 +2224,13 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) bpf\_prog\_array\_free\_sleepable(old\_array); } + /\*+ \* It could be that the bpf\_prog is not sleepable (and will be freed+ \* via normal RCU), but is called from a point that supports sleepable+ \* programs and uses tasks-trace-RCU.+ \*/+ synchronize\_rcu\_tasks\_trace();+ bpf\_prog\_put(event->prog); event->prog = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:04:42 +0000


