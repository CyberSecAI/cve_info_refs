=== Content from git.kernel.org_5eea434d_20250114_213319.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2d5df3a680ffdaf606baa10636bdb1daf757832e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d5df3a680ffdaf606baa10636bdb1daf757832e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d5df3a680ffdaf606baa10636bdb1daf757832e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d5df3a680ffdaf606baa10636bdb1daf757832e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2024-12-12 18:55:45 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-12-15 13:12:58 -0800 |
| commit | [2d5df3a680ffdaf606baa10636bdb1daf757832e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d5df3a680ffdaf606baa10636bdb1daf757832e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2d5df3a680ffdaf606baa10636bdb1daf757832e)) | |
| tree | [2787dacca8768ac495a3e5cbf047a9529872e681](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d5df3a680ffdaf606baa10636bdb1daf757832e) | |
| parent | [c296c0bf45181463b3243d8e8c6b4ed2f1a0a3dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c296c0bf45181463b3243d8e8c6b4ed2f1a0a3dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d5df3a680ffdaf606baa10636bdb1daf757832e&id2=c296c0bf45181463b3243d8e8c6b4ed2f1a0a3dd)) | |
| download | [linux-2d5df3a680ffdaf606baa10636bdb1daf757832e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2d5df3a680ffdaf606baa10636bdb1daf757832e.tar.gz) | |

net: mscc: ocelot: fix incorrect IFH SRC\_PORT field in ocelot\_ifh\_set\_basic()Packets injected by the CPU should have a SRC\_PORT field equal to the
CPU port module index in the Analyzer block (ocelot->num\_phys\_ports).
The blamed commit copied the ocelot\_ifh\_set\_basic() call incorrectly
from ocelot\_xmit\_common() in net/dsa/tag\_ocelot.c. Instead of calling
with "x", it calls with BIT\_ULL(x), but the field is not a port mask,
but rather a single port index.
[ side note: this is the technical debt of code duplication :( ]
The error used to be silent and doesn't appear to have other
user-visible manifestations, but with new changes in the packing
library, it now fails loudly as follows:
------------[ cut here ]------------
Cannot store 0x40 inside bits 46-43 - will truncate
sja1105 spi2.0: xmit timed out
WARNING: CPU: 1 PID: 102 at lib/packing.c:98 \_\_pack+0x90/0x198
sja1105 spi2.0: timed out polling for tstamp
CPU: 1 UID: 0 PID: 102 Comm: felix\_xmit
Tainted: G W N 6.13.0-rc1-00372-gf706b85d972d-dirty #2605
Call trace:
\_\_pack+0x90/0x198 (P)
\_\_pack+0x90/0x198 (L)
packing+0x78/0x98
ocelot\_ifh\_set\_basic+0x260/0x368
ocelot\_port\_inject\_frame+0xa8/0x250
felix\_port\_deferred\_xmit+0x14c/0x258
kthread\_worker\_fn+0x134/0x350
kthread+0x114/0x138
The code path pertains to the ocelot switchdev driver and to the felix
secondary DSA tag protocol, ocelot-8021q. Here seen with ocelot-8021q.
The messenger (packing) is not really to blame, so fix the original
commit instead.
Fixes: e1b9e80236c5 ("net: mscc: ocelot: fix QoS class for injected packets with "ocelot-8021q"")
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241212165546.879567-1-vladimir.oltean@nxp.com](https://patch.msgid.link/20241212165546.879567-1-vladimir.oltean%40nxp.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d5df3a680ffdaf606baa10636bdb1daf757832e)

| -rw-r--r-- | [drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mscc/ocelot.c?id=2d5df3a680ffdaf606baa10636bdb1daf757832e) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mscc/ocelot.c b/drivers/net/ethernet/mscc/ocelot.cindex 3d72aa7b130503..ef93df52088710 100644--- a/[drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mscc/ocelot.c?id=c296c0bf45181463b3243d8e8c6b4ed2f1a0a3dd)+++ b/[drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mscc/ocelot.c?id=2d5df3a680ffdaf606baa10636bdb1daf757832e)@@ -1432,7 +1432,7 @@ void ocelot\_ifh\_set\_basic(void \*ifh, struct ocelot \*ocelot, int port,  memset(ifh, 0, OCELOT\_TAG\_LEN); ocelot\_ifh\_set\_bypass(ifh, 1);- ocelot\_ifh\_set\_src(ifh, BIT\_ULL(ocelot->num\_phys\_ports));+ ocelot\_ifh\_set\_src(ifh, ocelot->num\_phys\_ports); ocelot\_ifh\_set\_dest(ifh, BIT\_ULL(port)); ocelot\_ifh\_set\_qos\_class(ifh, qos\_class); ocelot\_ifh\_set\_tag\_type(ifh, tag\_type); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:31:56 +0000



=== Content from git.kernel.org_f136d650_20250114_213320.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=59c4ca8d8d7918eb6e2df91d2c254827264be309)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=59c4ca8d8d7918eb6e2df91d2c254827264be309)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59c4ca8d8d7918eb6e2df91d2c254827264be309)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=59c4ca8d8d7918eb6e2df91d2c254827264be309)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2024-12-12 18:55:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-27 13:52:54 +0100 |
| commit | [59c4ca8d8d7918eb6e2df91d2c254827264be309](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59c4ca8d8d7918eb6e2df91d2c254827264be309) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=59c4ca8d8d7918eb6e2df91d2c254827264be309)) | |
| tree | [44e74e7530c6575bf95fb1acc3d65eb7987c13e8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=59c4ca8d8d7918eb6e2df91d2c254827264be309) | |
| parent | [d7d1f986ebb284b1db8dafca7d1bdb6dd2445cf6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d7d1f986ebb284b1db8dafca7d1bdb6dd2445cf6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=59c4ca8d8d7918eb6e2df91d2c254827264be309&id2=d7d1f986ebb284b1db8dafca7d1bdb6dd2445cf6)) | |
| download | [linux-59c4ca8d8d7918eb6e2df91d2c254827264be309.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-59c4ca8d8d7918eb6e2df91d2c254827264be309.tar.gz) | |

net: mscc: ocelot: fix incorrect IFH SRC\_PORT field in ocelot\_ifh\_set\_basic()[ Upstream commit 2d5df3a680ffdaf606baa10636bdb1daf757832e ]
Packets injected by the CPU should have a SRC\_PORT field equal to the
CPU port module index in the Analyzer block (ocelot->num\_phys\_ports).
The blamed commit copied the ocelot\_ifh\_set\_basic() call incorrectly
from ocelot\_xmit\_common() in net/dsa/tag\_ocelot.c. Instead of calling
with "x", it calls with BIT\_ULL(x), but the field is not a port mask,
but rather a single port index.
[ side note: this is the technical debt of code duplication :( ]
The error used to be silent and doesn't appear to have other
user-visible manifestations, but with new changes in the packing
library, it now fails loudly as follows:
------------[ cut here ]------------
Cannot store 0x40 inside bits 46-43 - will truncate
sja1105 spi2.0: xmit timed out
WARNING: CPU: 1 PID: 102 at lib/packing.c:98 \_\_pack+0x90/0x198
sja1105 spi2.0: timed out polling for tstamp
CPU: 1 UID: 0 PID: 102 Comm: felix\_xmit
Tainted: G W N 6.13.0-rc1-00372-gf706b85d972d-dirty #2605
Call trace:
\_\_pack+0x90/0x198 (P)
\_\_pack+0x90/0x198 (L)
packing+0x78/0x98
ocelot\_ifh\_set\_basic+0x260/0x368
ocelot\_port\_inject\_frame+0xa8/0x250
felix\_port\_deferred\_xmit+0x14c/0x258
kthread\_worker\_fn+0x134/0x350
kthread+0x114/0x138
The code path pertains to the ocelot switchdev driver and to the felix
secondary DSA tag protocol, ocelot-8021q. Here seen with ocelot-8021q.
The messenger (packing) is not really to blame, so fix the original
commit instead.
Fixes: e1b9e80236c5 ("net: mscc: ocelot: fix QoS class for injected packets with "ocelot-8021q"")
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241212165546.879567-1-vladimir.oltean@nxp.com](https://patch.msgid.link/20241212165546.879567-1-vladimir.oltean%40nxp.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=59c4ca8d8d7918eb6e2df91d2c254827264be309)

| -rw-r--r-- | [drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mscc/ocelot.c?id=59c4ca8d8d7918eb6e2df91d2c254827264be309) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mscc/ocelot.c b/drivers/net/ethernet/mscc/ocelot.cindex 310a36356f568e..71dbdac38020b2 100644--- a/[drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mscc/ocelot.c?id=d7d1f986ebb284b1db8dafca7d1bdb6dd2445cf6)+++ b/[drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mscc/ocelot.c?id=59c4ca8d8d7918eb6e2df91d2c254827264be309)@@ -1161,7 +1161,7 @@ void ocelot\_ifh\_set\_basic(void \*ifh, struct ocelot \*ocelot, int port,  memset(ifh, 0, OCELOT\_TAG\_LEN); ocelot\_ifh\_set\_bypass(ifh, 1);- ocelot\_ifh\_set\_src(ifh, BIT\_ULL(ocelot->num\_phys\_ports));+ ocelot\_ifh\_set\_src(ifh, ocelot->num\_phys\_ports); ocelot\_ifh\_set\_dest(ifh, BIT\_ULL(port)); ocelot\_ifh\_set\_qos\_class(ifh, qos\_class); ocelot\_ifh\_set\_tag\_type(ifh, tag\_type); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:31:57 +0000



=== Content from git.kernel.org_e1048219_20250114_213321.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2024-12-12 18:55:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-27 14:02:02 +0100 |
| commit | [a8836eae3288c351acd3b2743d2fad2a4ee2bd56](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56)) | |
| tree | [6c7cb969601d20c8897aaabbde484301cc6272cd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56) | |
| parent | [df3dfe1a93c6298d8c09a18e4fba19ef5b17763b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df3dfe1a93c6298d8c09a18e4fba19ef5b17763b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56&id2=df3dfe1a93c6298d8c09a18e4fba19ef5b17763b)) | |
| download | [linux-a8836eae3288c351acd3b2743d2fad2a4ee2bd56.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a8836eae3288c351acd3b2743d2fad2a4ee2bd56.tar.gz) | |

net: mscc: ocelot: fix incorrect IFH SRC\_PORT field in ocelot\_ifh\_set\_basic()[ Upstream commit 2d5df3a680ffdaf606baa10636bdb1daf757832e ]
Packets injected by the CPU should have a SRC\_PORT field equal to the
CPU port module index in the Analyzer block (ocelot->num\_phys\_ports).
The blamed commit copied the ocelot\_ifh\_set\_basic() call incorrectly
from ocelot\_xmit\_common() in net/dsa/tag\_ocelot.c. Instead of calling
with "x", it calls with BIT\_ULL(x), but the field is not a port mask,
but rather a single port index.
[ side note: this is the technical debt of code duplication :( ]
The error used to be silent and doesn't appear to have other
user-visible manifestations, but with new changes in the packing
library, it now fails loudly as follows:
------------[ cut here ]------------
Cannot store 0x40 inside bits 46-43 - will truncate
sja1105 spi2.0: xmit timed out
WARNING: CPU: 1 PID: 102 at lib/packing.c:98 \_\_pack+0x90/0x198
sja1105 spi2.0: timed out polling for tstamp
CPU: 1 UID: 0 PID: 102 Comm: felix\_xmit
Tainted: G W N 6.13.0-rc1-00372-gf706b85d972d-dirty #2605
Call trace:
\_\_pack+0x90/0x198 (P)
\_\_pack+0x90/0x198 (L)
packing+0x78/0x98
ocelot\_ifh\_set\_basic+0x260/0x368
ocelot\_port\_inject\_frame+0xa8/0x250
felix\_port\_deferred\_xmit+0x14c/0x258
kthread\_worker\_fn+0x134/0x350
kthread+0x114/0x138
The code path pertains to the ocelot switchdev driver and to the felix
secondary DSA tag protocol, ocelot-8021q. Here seen with ocelot-8021q.
The messenger (packing) is not really to blame, so fix the original
commit instead.
Fixes: e1b9e80236c5 ("net: mscc: ocelot: fix QoS class for injected packets with "ocelot-8021q"")
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241212165546.879567-1-vladimir.oltean@nxp.com](https://patch.msgid.link/20241212165546.879567-1-vladimir.oltean%40nxp.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56)

| -rw-r--r-- | [drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mscc/ocelot.c?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mscc/ocelot.c b/drivers/net/ethernet/mscc/ocelot.cindex 3d72aa7b130503..ef93df52088710 100644--- a/[drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mscc/ocelot.c?id=df3dfe1a93c6298d8c09a18e4fba19ef5b17763b)+++ b/[drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mscc/ocelot.c?id=a8836eae3288c351acd3b2743d2fad2a4ee2bd56)@@ -1432,7 +1432,7 @@ void ocelot\_ifh\_set\_basic(void \*ifh, struct ocelot \*ocelot, int port,  memset(ifh, 0, OCELOT\_TAG\_LEN); ocelot\_ifh\_set\_bypass(ifh, 1);- ocelot\_ifh\_set\_src(ifh, BIT\_ULL(ocelot->num\_phys\_ports));+ ocelot\_ifh\_set\_src(ifh, ocelot->num\_phys\_ports); ocelot\_ifh\_set\_dest(ifh, BIT\_ULL(port)); ocelot\_ifh\_set\_qos\_class(ifh, qos\_class); ocelot\_ifh\_set\_tag\_type(ifh, tag\_type); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:31:58 +0000



=== Content from git.kernel.org_c5264253_20250114_213319.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2f3c62ffe88116cd2a39cd73e01103535599970f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f3c62ffe88116cd2a39cd73e01103535599970f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f3c62ffe88116cd2a39cd73e01103535599970f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f3c62ffe88116cd2a39cd73e01103535599970f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2024-12-12 18:55:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-27 13:58:47 +0100 |
| commit | [2f3c62ffe88116cd2a39cd73e01103535599970f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f3c62ffe88116cd2a39cd73e01103535599970f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2f3c62ffe88116cd2a39cd73e01103535599970f)) | |
| tree | [9f9f26a6b4932de0d2653bc16da5ef22c52d2ff4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f3c62ffe88116cd2a39cd73e01103535599970f) | |
| parent | [7a6927814b4256d603e202ae7c5e38db3b338896](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a6927814b4256d603e202ae7c5e38db3b338896) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f3c62ffe88116cd2a39cd73e01103535599970f&id2=7a6927814b4256d603e202ae7c5e38db3b338896)) | |
| download | [linux-2f3c62ffe88116cd2a39cd73e01103535599970f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2f3c62ffe88116cd2a39cd73e01103535599970f.tar.gz) | |

net: mscc: ocelot: fix incorrect IFH SRC\_PORT field in ocelot\_ifh\_set\_basic()[ Upstream commit 2d5df3a680ffdaf606baa10636bdb1daf757832e ]
Packets injected by the CPU should have a SRC\_PORT field equal to the
CPU port module index in the Analyzer block (ocelot->num\_phys\_ports).
The blamed commit copied the ocelot\_ifh\_set\_basic() call incorrectly
from ocelot\_xmit\_common() in net/dsa/tag\_ocelot.c. Instead of calling
with "x", it calls with BIT\_ULL(x), but the field is not a port mask,
but rather a single port index.
[ side note: this is the technical debt of code duplication :( ]
The error used to be silent and doesn't appear to have other
user-visible manifestations, but with new changes in the packing
library, it now fails loudly as follows:
------------[ cut here ]------------
Cannot store 0x40 inside bits 46-43 - will truncate
sja1105 spi2.0: xmit timed out
WARNING: CPU: 1 PID: 102 at lib/packing.c:98 \_\_pack+0x90/0x198
sja1105 spi2.0: timed out polling for tstamp
CPU: 1 UID: 0 PID: 102 Comm: felix\_xmit
Tainted: G W N 6.13.0-rc1-00372-gf706b85d972d-dirty #2605
Call trace:
\_\_pack+0x90/0x198 (P)
\_\_pack+0x90/0x198 (L)
packing+0x78/0x98
ocelot\_ifh\_set\_basic+0x260/0x368
ocelot\_port\_inject\_frame+0xa8/0x250
felix\_port\_deferred\_xmit+0x14c/0x258
kthread\_worker\_fn+0x134/0x350
kthread+0x114/0x138
The code path pertains to the ocelot switchdev driver and to the felix
secondary DSA tag protocol, ocelot-8021q. Here seen with ocelot-8021q.
The messenger (packing) is not really to blame, so fix the original
commit instead.
Fixes: e1b9e80236c5 ("net: mscc: ocelot: fix QoS class for injected packets with "ocelot-8021q"")
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241212165546.879567-1-vladimir.oltean@nxp.com](https://patch.msgid.link/20241212165546.879567-1-vladimir.oltean%40nxp.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f3c62ffe88116cd2a39cd73e01103535599970f)

| -rw-r--r-- | [drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mscc/ocelot.c?id=2f3c62ffe88116cd2a39cd73e01103535599970f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mscc/ocelot.c b/drivers/net/ethernet/mscc/ocelot.cindex c2118bde908b11..f6aa5d6b6597e0 100644--- a/[drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mscc/ocelot.c?id=7a6927814b4256d603e202ae7c5e38db3b338896)+++ b/[drivers/net/ethernet/mscc/ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mscc/ocelot.c?id=2f3c62ffe88116cd2a39cd73e01103535599970f)@@ -1266,7 +1266,7 @@ void ocelot\_ifh\_set\_basic(void \*ifh, struct ocelot \*ocelot, int port,  memset(ifh, 0, OCELOT\_TAG\_LEN); ocelot\_ifh\_set\_bypass(ifh, 1);- ocelot\_ifh\_set\_src(ifh, BIT\_ULL(ocelot->num\_phys\_ports));+ ocelot\_ifh\_set\_src(ifh, ocelot->num\_phys\_ports); ocelot\_ifh\_set\_dest(ifh, BIT\_ULL(port)); ocelot\_ifh\_set\_qos\_class(ifh, qos\_class); ocelot\_ifh\_set\_tag\_type(ifh, tag\_type); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:31:57 +0000


