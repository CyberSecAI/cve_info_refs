=== Content from git.kernel.org_9cba1e11_20250114_201218.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=17af2b39daf12870cac61ffc360e62bc35798afb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17af2b39daf12870cac61ffc360e62bc35798afb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17af2b39daf12870cac61ffc360e62bc35798afb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17af2b39daf12870cac61ffc360e62bc35798afb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guoqing Jiang <guoqing.jiang@canonical.com> | 2024-09-12 10:48:01 +0800 |
| --- | --- | --- |
| committer | Hans Verkuil <hverkuil-cisco@xs4all.nl> | 2024-10-12 16:28:25 +0200 |
| commit | [17af2b39daf12870cac61ffc360e62bc35798afb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17af2b39daf12870cac61ffc360e62bc35798afb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=17af2b39daf12870cac61ffc360e62bc35798afb)) | |
| tree | [f08e9a904646f0372f09d88c65da04c90ae6f58c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17af2b39daf12870cac61ffc360e62bc35798afb) | |
| parent | [2c21fd53a1a0ab8cf0438a9d554ad47d1e9704b2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c21fd53a1a0ab8cf0438a9d554ad47d1e9704b2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17af2b39daf12870cac61ffc360e62bc35798afb&id2=2c21fd53a1a0ab8cf0438a9d554ad47d1e9704b2)) | |
| download | [linux-17af2b39daf12870cac61ffc360e62bc35798afb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-17af2b39daf12870cac61ffc360e62bc35798afb.tar.gz) | |

media: mtk-jpeg: Fix null-ptr-deref during unload moduleThe workqueue should be destroyed in mtk\_jpeg\_core.c since commit
09aea13ecf6f ("media: mtk-jpeg: refactor some variables"), otherwise
the below calltrace can be easily triggered.
[ 677.862514] Unable to handle kernel paging request at virtual address dfff800000000023
[ 677.863633] KASAN: null-ptr-deref in range [0x0000000000000118-0x000000000000011f]
...
[ 677.879654] CPU: 6 PID: 1071 Comm: modprobe Tainted: G O 6.8.12-mtk+gfa1a78e5d24b+ #17
...
[ 677.882838] pc : destroy\_workqueue+0x3c/0x770
[ 677.883413] lr : mtk\_jpegdec\_destroy\_workqueue+0x70/0x88 [mtk\_jpeg\_dec\_hw]
[ 677.884314] sp : ffff80008ad974f0
[ 677.884744] x29: ffff80008ad974f0 x28: ffff0000d7115580 x27: ffff0000dd691070
[ 677.885669] x26: ffff0000dd691408 x25: ffff8000844af3e0 x24: ffff80008ad97690
[ 677.886592] x23: ffff0000e051d400 x22: ffff0000dd691010 x21: dfff800000000000
[ 677.887515] x20: 0000000000000000 x19: 0000000000000000 x18: ffff800085397ac0
[ 677.888438] x17: 0000000000000000 x16: ffff8000801b87c8 x15: 1ffff000115b2e10
[ 677.889361] x14: 00000000f1f1f1f1 x13: 0000000000000000 x12: ffff7000115b2e4d
[ 677.890285] x11: 1ffff000115b2e4c x10: ffff7000115b2e4c x9 : ffff80000aa43e90
[ 677.891208] x8 : 00008fffeea4d1b4 x7 : ffff80008ad97267 x6 : 0000000000000001
[ 677.892131] x5 : ffff80008ad97260 x4 : ffff7000115b2e4d x3 : 0000000000000000
[ 677.893054] x2 : 0000000000000023 x1 : dfff800000000000 x0 : 0000000000000118
[ 677.893977] Call trace:
[ 677.894297] destroy\_workqueue+0x3c/0x770
[ 677.894826] mtk\_jpegdec\_destroy\_workqueue+0x70/0x88 [mtk\_jpeg\_dec\_hw]
[ 677.895677] devm\_action\_release+0x50/0x90
[ 677.896211] release\_nodes+0xe8/0x170
[ 677.896688] devres\_release\_all+0xf8/0x178
[ 677.897219] device\_unbind\_cleanup+0x24/0x170
[ 677.897785] device\_release\_driver\_internal+0x35c/0x480
[ 677.898461] device\_release\_driver+0x20/0x38
...
[ 677.912665] ---[ end trace 0000000000000000 ]---
Fixes: 09aea13ecf6f ("media: mtk-jpeg: refactor some variables")
Cc: <stable@vger.kernel.org>
Signed-off-by: Guoqing Jiang <guoqing.jiang@canonical.com>
Signed-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17af2b39daf12870cac61ffc360e62bc35798afb)

| -rw-r--r-- | [drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/mediatek/jpeg/mtk_jpeg_core.c?id=17af2b39daf12870cac61ffc360e62bc35798afb) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/mediatek/jpeg/mtk_jpeg_dec_hw.c?id=17af2b39daf12870cac61ffc360e62bc35798afb) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 10 insertions, 11 deletions

| diff --git a/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c b/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.cindex ac48658e2de403..ff269467635561 100644--- a/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_core.c?id=2c21fd53a1a0ab8cf0438a9d554ad47d1e9704b2)+++ b/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_core.c?id=17af2b39daf12870cac61ffc360e62bc35798afb)@@ -1293,6 +1293,11 @@ static int mtk\_jpeg\_single\_core\_init(struct platform\_device \*pdev, return 0; } +static void mtk\_jpeg\_destroy\_workqueue(void \*data)+{+ destroy\_workqueue(data);+}+ static int mtk\_jpeg\_probe(struct platform\_device \*pdev) { struct mtk\_jpeg\_dev \*jpeg;@@ -1337,6 +1342,11 @@ static int mtk\_jpeg\_probe(struct platform\_device \*pdev) | WQ\_FREEZABLE); if (!jpeg->workqueue) return -EINVAL;+ ret = devm\_add\_action\_or\_reset(&pdev->dev,+ mtk\_jpeg\_destroy\_workqueue,+ jpeg->workqueue);+ if (ret)+ return ret; }  ret = v4l2\_device\_register(&pdev->dev, &jpeg->v4l2\_dev);diff --git a/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c b/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.cindex 4a6ee211e18f97..2c5d74939d0a92 100644--- a/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_dec_hw.c?id=2c21fd53a1a0ab8cf0438a9d554ad47d1e9704b2)+++ b/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_dec_hw.c?id=17af2b39daf12870cac61ffc360e62bc35798afb)@@ -578,11 +578,6 @@ static int mtk\_jpegdec\_hw\_init\_irq(struct mtk\_jpegdec\_comp\_dev \*dev) return 0; } -static void mtk\_jpegdec\_destroy\_workqueue(void \*data)-{- destroy\_workqueue(data);-}- static int mtk\_jpegdec\_hw\_probe(struct platform\_device \*pdev) { struct mtk\_jpegdec\_clk \*jpegdec\_clk;@@ -606,12 +601,6 @@ static int mtk\_jpegdec\_hw\_probe(struct platform\_device \*pdev) dev->plat\_dev = pdev; dev->dev = &pdev->dev; - ret = devm\_add\_action\_or\_reset(&pdev->dev,- mtk\_jpegdec\_destroy\_workqueue,- master\_dev->workqueue);- if (ret)- return ret;- spin\_lock\_init(&dev->hw\_lock); dev->hw\_state = MTK\_JPEG\_HW\_IDLE; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:10:55 +0000



=== Content from git.kernel.org_e43dfa1d_20250114_201217.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0ba08c21c6a92e6512e73644555120427c9a49d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ba08c21c6a92e6512e73644555120427c9a49d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ba08c21c6a92e6512e73644555120427c9a49d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ba08c21c6a92e6512e73644555120427c9a49d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guoqing Jiang <guoqing.jiang@canonical.com> | 2024-09-12 10:48:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:33:02 +0100 |
| commit | [0ba08c21c6a92e6512e73644555120427c9a49d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ba08c21c6a92e6512e73644555120427c9a49d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0ba08c21c6a92e6512e73644555120427c9a49d4)) | |
| tree | [bd8087282afe82f894e691af5f3d779d2d2d653f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ba08c21c6a92e6512e73644555120427c9a49d4) | |
| parent | [68efeff2f7fccdfedc55f92e92be32997127d16e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68efeff2f7fccdfedc55f92e92be32997127d16e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ba08c21c6a92e6512e73644555120427c9a49d4&id2=68efeff2f7fccdfedc55f92e92be32997127d16e)) | |
| download | [linux-0ba08c21c6a92e6512e73644555120427c9a49d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0ba08c21c6a92e6512e73644555120427c9a49d4.tar.gz) | |

media: mtk-jpeg: Fix null-ptr-deref during unload modulecommit 17af2b39daf12870cac61ffc360e62bc35798afb upstream.
The workqueue should be destroyed in mtk\_jpeg\_core.c since commit
09aea13ecf6f ("media: mtk-jpeg: refactor some variables"), otherwise
the below calltrace can be easily triggered.
[ 677.862514] Unable to handle kernel paging request at virtual address dfff800000000023
[ 677.863633] KASAN: null-ptr-deref in range [0x0000000000000118-0x000000000000011f]
...
[ 677.879654] CPU: 6 PID: 1071 Comm: modprobe Tainted: G O 6.8.12-mtk+gfa1a78e5d24b+ #17
...
[ 677.882838] pc : destroy\_workqueue+0x3c/0x770
[ 677.883413] lr : mtk\_jpegdec\_destroy\_workqueue+0x70/0x88 [mtk\_jpeg\_dec\_hw]
[ 677.884314] sp : ffff80008ad974f0
[ 677.884744] x29: ffff80008ad974f0 x28: ffff0000d7115580 x27: ffff0000dd691070
[ 677.885669] x26: ffff0000dd691408 x25: ffff8000844af3e0 x24: ffff80008ad97690
[ 677.886592] x23: ffff0000e051d400 x22: ffff0000dd691010 x21: dfff800000000000
[ 677.887515] x20: 0000000000000000 x19: 0000000000000000 x18: ffff800085397ac0
[ 677.888438] x17: 0000000000000000 x16: ffff8000801b87c8 x15: 1ffff000115b2e10
[ 677.889361] x14: 00000000f1f1f1f1 x13: 0000000000000000 x12: ffff7000115b2e4d
[ 677.890285] x11: 1ffff000115b2e4c x10: ffff7000115b2e4c x9 : ffff80000aa43e90
[ 677.891208] x8 : 00008fffeea4d1b4 x7 : ffff80008ad97267 x6 : 0000000000000001
[ 677.892131] x5 : ffff80008ad97260 x4 : ffff7000115b2e4d x3 : 0000000000000000
[ 677.893054] x2 : 0000000000000023 x1 : dfff800000000000 x0 : 0000000000000118
[ 677.893977] Call trace:
[ 677.894297] destroy\_workqueue+0x3c/0x770
[ 677.894826] mtk\_jpegdec\_destroy\_workqueue+0x70/0x88 [mtk\_jpeg\_dec\_hw]
[ 677.895677] devm\_action\_release+0x50/0x90
[ 677.896211] release\_nodes+0xe8/0x170
[ 677.896688] devres\_release\_all+0xf8/0x178
[ 677.897219] device\_unbind\_cleanup+0x24/0x170
[ 677.897785] device\_release\_driver\_internal+0x35c/0x480
[ 677.898461] device\_release\_driver+0x20/0x38
...
[ 677.912665] ---[ end trace 0000000000000000 ]---
Fixes: 09aea13ecf6f ("media: mtk-jpeg: refactor some variables")
Cc: <stable@vger.kernel.org>
Signed-off-by: Guoqing Jiang <guoqing.jiang@canonical.com>
Signed-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ba08c21c6a92e6512e73644555120427c9a49d4)

| -rw-r--r-- | [drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/mediatek/jpeg/mtk_jpeg_core.c?id=0ba08c21c6a92e6512e73644555120427c9a49d4) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/mediatek/jpeg/mtk_jpeg_dec_hw.c?id=0ba08c21c6a92e6512e73644555120427c9a49d4) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 10 insertions, 11 deletions

| diff --git a/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c b/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.cindex c3456c700c07e2..4c7b46f5a7ddd5 100644--- a/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_core.c?id=68efeff2f7fccdfedc55f92e92be32997127d16e)+++ b/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_core.c?id=0ba08c21c6a92e6512e73644555120427c9a49d4)@@ -1294,6 +1294,11 @@ static int mtk\_jpeg\_single\_core\_init(struct platform\_device \*pdev, return 0; } +static void mtk\_jpeg\_destroy\_workqueue(void \*data)+{+ destroy\_workqueue(data);+}+ static int mtk\_jpeg\_probe(struct platform\_device \*pdev) { struct mtk\_jpeg\_dev \*jpeg;@@ -1338,6 +1343,11 @@ static int mtk\_jpeg\_probe(struct platform\_device \*pdev) | WQ\_FREEZABLE); if (!jpeg->workqueue) return -EINVAL;+ ret = devm\_add\_action\_or\_reset(&pdev->dev,+ mtk\_jpeg\_destroy\_workqueue,+ jpeg->workqueue);+ if (ret)+ return ret; }  ret = v4l2\_device\_register(&pdev->dev, &jpeg->v4l2\_dev);diff --git a/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c b/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.cindex 4a6ee211e18f97..2c5d74939d0a92 100644--- a/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_dec_hw.c?id=68efeff2f7fccdfedc55f92e92be32997127d16e)+++ b/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_dec_hw.c?id=0ba08c21c6a92e6512e73644555120427c9a49d4)@@ -578,11 +578,6 @@ static int mtk\_jpegdec\_hw\_init\_irq(struct mtk\_jpegdec\_comp\_dev \*dev) return 0; } -static void mtk\_jpegdec\_destroy\_workqueue(void \*data)-{- destroy\_workqueue(data);-}- static int mtk\_jpegdec\_hw\_probe(struct platform\_device \*pdev) { struct mtk\_jpegdec\_clk \*jpegdec\_clk;@@ -606,12 +601,6 @@ static int mtk\_jpegdec\_hw\_probe(struct platform\_device \*pdev) dev->plat\_dev = pdev; dev->dev = &pdev->dev; - ret = devm\_add\_action\_or\_reset(&pdev->dev,- mtk\_jpegdec\_destroy\_workqueue,- master\_dev->workqueue);- if (ret)- return ret;- spin\_lock\_init(&dev->hw\_lock); dev->hw\_state = MTK\_JPEG\_HW\_IDLE; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:10:54 +0000



=== Content from git.kernel.org_eda2e558_20250114_201219.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guoqing Jiang <guoqing.jiang@canonical.com> | 2024-09-12 10:48:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:40:58 +0100 |
| commit | [bc3889a39baf783c64c6d628bbb74d76ce164bb1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1)) | |
| tree | [c0349ea2c04f2b248f2e7b52099e6a474b656ed6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1) | |
| parent | [5ade59d28eade49194eb09765afdeb0ba717c39a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ade59d28eade49194eb09765afdeb0ba717c39a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1&id2=5ade59d28eade49194eb09765afdeb0ba717c39a)) | |
| download | [linux-bc3889a39baf783c64c6d628bbb74d76ce164bb1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bc3889a39baf783c64c6d628bbb74d76ce164bb1.tar.gz) | |

media: mtk-jpeg: Fix null-ptr-deref during unload modulecommit 17af2b39daf12870cac61ffc360e62bc35798afb upstream.
The workqueue should be destroyed in mtk\_jpeg\_core.c since commit
09aea13ecf6f ("media: mtk-jpeg: refactor some variables"), otherwise
the below calltrace can be easily triggered.
[ 677.862514] Unable to handle kernel paging request at virtual address dfff800000000023
[ 677.863633] KASAN: null-ptr-deref in range [0x0000000000000118-0x000000000000011f]
...
[ 677.879654] CPU: 6 PID: 1071 Comm: modprobe Tainted: G O 6.8.12-mtk+gfa1a78e5d24b+ #17
...
[ 677.882838] pc : destroy\_workqueue+0x3c/0x770
[ 677.883413] lr : mtk\_jpegdec\_destroy\_workqueue+0x70/0x88 [mtk\_jpeg\_dec\_hw]
[ 677.884314] sp : ffff80008ad974f0
[ 677.884744] x29: ffff80008ad974f0 x28: ffff0000d7115580 x27: ffff0000dd691070
[ 677.885669] x26: ffff0000dd691408 x25: ffff8000844af3e0 x24: ffff80008ad97690
[ 677.886592] x23: ffff0000e051d400 x22: ffff0000dd691010 x21: dfff800000000000
[ 677.887515] x20: 0000000000000000 x19: 0000000000000000 x18: ffff800085397ac0
[ 677.888438] x17: 0000000000000000 x16: ffff8000801b87c8 x15: 1ffff000115b2e10
[ 677.889361] x14: 00000000f1f1f1f1 x13: 0000000000000000 x12: ffff7000115b2e4d
[ 677.890285] x11: 1ffff000115b2e4c x10: ffff7000115b2e4c x9 : ffff80000aa43e90
[ 677.891208] x8 : 00008fffeea4d1b4 x7 : ffff80008ad97267 x6 : 0000000000000001
[ 677.892131] x5 : ffff80008ad97260 x4 : ffff7000115b2e4d x3 : 0000000000000000
[ 677.893054] x2 : 0000000000000023 x1 : dfff800000000000 x0 : 0000000000000118
[ 677.893977] Call trace:
[ 677.894297] destroy\_workqueue+0x3c/0x770
[ 677.894826] mtk\_jpegdec\_destroy\_workqueue+0x70/0x88 [mtk\_jpeg\_dec\_hw]
[ 677.895677] devm\_action\_release+0x50/0x90
[ 677.896211] release\_nodes+0xe8/0x170
[ 677.896688] devres\_release\_all+0xf8/0x178
[ 677.897219] device\_unbind\_cleanup+0x24/0x170
[ 677.897785] device\_release\_driver\_internal+0x35c/0x480
[ 677.898461] device\_release\_driver+0x20/0x38
...
[ 677.912665] ---[ end trace 0000000000000000 ]---
Fixes: 09aea13ecf6f ("media: mtk-jpeg: refactor some variables")
Cc: <stable@vger.kernel.org>
Signed-off-by: Guoqing Jiang <guoqing.jiang@canonical.com>
Signed-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1)

| -rw-r--r-- | [drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/mediatek/jpeg/mtk_jpeg_core.c?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/mediatek/jpeg/mtk_jpeg_dec_hw.c?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 10 insertions, 11 deletions

| diff --git a/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c b/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.cindex ac48658e2de403..ff269467635561 100644--- a/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_core.c?id=5ade59d28eade49194eb09765afdeb0ba717c39a)+++ b/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_core.c?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1)@@ -1293,6 +1293,11 @@ static int mtk\_jpeg\_single\_core\_init(struct platform\_device \*pdev, return 0; } +static void mtk\_jpeg\_destroy\_workqueue(void \*data)+{+ destroy\_workqueue(data);+}+ static int mtk\_jpeg\_probe(struct platform\_device \*pdev) { struct mtk\_jpeg\_dev \*jpeg;@@ -1337,6 +1342,11 @@ static int mtk\_jpeg\_probe(struct platform\_device \*pdev) | WQ\_FREEZABLE); if (!jpeg->workqueue) return -EINVAL;+ ret = devm\_add\_action\_or\_reset(&pdev->dev,+ mtk\_jpeg\_destroy\_workqueue,+ jpeg->workqueue);+ if (ret)+ return ret; }  ret = v4l2\_device\_register(&pdev->dev, &jpeg->v4l2\_dev);diff --git a/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c b/drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.cindex 4a6ee211e18f97..2c5d74939d0a92 100644--- a/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_dec_hw.c?id=5ade59d28eade49194eb09765afdeb0ba717c39a)+++ b/[drivers/media/platform/mediatek/jpeg/mtk\_jpeg\_dec\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/jpeg/mtk_jpeg_dec_hw.c?id=bc3889a39baf783c64c6d628bbb74d76ce164bb1)@@ -578,11 +578,6 @@ static int mtk\_jpegdec\_hw\_init\_irq(struct mtk\_jpegdec\_comp\_dev \*dev) return 0; } -static void mtk\_jpegdec\_destroy\_workqueue(void \*data)-{- destroy\_workqueue(data);-}- static int mtk\_jpegdec\_hw\_probe(struct platform\_device \*pdev) { struct mtk\_jpegdec\_clk \*jpegdec\_clk;@@ -606,12 +601,6 @@ static int mtk\_jpegdec\_hw\_probe(struct platform\_device \*pdev) dev->plat\_dev = pdev; dev->dev = &pdev->dev; - ret = devm\_add\_action\_or\_reset(&pdev->dev,- mtk\_jpegdec\_destroy\_workqueue,- master\_dev->workqueue);- if (ret)- return ret;- spin\_lock\_init(&dev->hw\_lock); dev->hw\_state = MTK\_JPEG\_HW\_IDLE; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:10:56 +0000


