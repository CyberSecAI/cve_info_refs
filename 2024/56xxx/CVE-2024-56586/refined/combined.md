=== Content from git.kernel.org_95995965_20250115_083914.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qi Han <hanqi@vivo.com> | 2024-09-18 02:44:00 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:47 +0100 |
| commit | [ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617)) | |
| tree | [1057e2222240304fc0027d200393128e4c3fc4f1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617) | |
| parent | [c6bdc332634f2992508d5118654532adca12b852](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6bdc332634f2992508d5118654532adca12b852) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617&id2=c6bdc332634f2992508d5118654532adca12b852)) | |
| download | [linux-ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617.tar.gz) | |

f2fs: fix f2fs\_bug\_on when uninstalling filesystem call f2fs\_evict\_inode.[ Upstream commit d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca ]
creating a large files during checkpoint disable until it runs out of
space and then delete it, then remount to enable checkpoint again, and
then unmount the filesystem triggers the f2fs\_bug\_on as below:
------------[ cut here ]------------
kernel BUG at fs/f2fs/inode.c:896!
CPU: 2 UID: 0 PID: 1286 Comm: umount Not tainted 6.11.0-rc7-dirty #360
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:f2fs\_evict\_inode+0x58c/0x610
Call Trace:
\_\_die\_body+0x15/0x60
die+0x33/0x50
do\_trap+0x10a/0x120
f2fs\_evict\_inode+0x58c/0x610
do\_error\_trap+0x60/0x80
f2fs\_evict\_inode+0x58c/0x610
exc\_invalid\_op+0x53/0x60
f2fs\_evict\_inode+0x58c/0x610
asm\_exc\_invalid\_op+0x16/0x20
f2fs\_evict\_inode+0x58c/0x610
evict+0x101/0x260
dispose\_list+0x30/0x50
evict\_inodes+0x140/0x190
generic\_shutdown\_super+0x2f/0x150
kill\_block\_super+0x11/0x40
kill\_f2fs\_super+0x7d/0x140
deactivate\_locked\_super+0x2a/0x70
cleanup\_mnt+0xb3/0x140
task\_work\_run+0x61/0x90
The root cause is: creating large files during disable checkpoint
period results in not enough free segments, so when writing back root
inode will failed in f2fs\_enable\_checkpoint. When umount the file
system after enabling checkpoint, the root inode is dirty in
f2fs\_evict\_inode function, which triggers BUG\_ON. The steps to
reproduce are as follows:
dd if=/dev/zero of=f2fs.img bs=1M count=55
mount f2fs.img f2fs\_dir -o checkpoint=disable:10%
dd if=/dev/zero of=big bs=1M count=50
sync
rm big
mount -o remount,checkpoint=enable f2fs\_dir
umount f2fs\_dir
Let's redirty inode when there is not free segments during checkpoint
is disable.
Signed-off-by: Qi Han <hanqi@vivo.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617)

| -rw-r--r-- | [fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/inode.c?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/f2fs/inode.c b/fs/f2fs/inode.cindex 5b672df194a999..0f350368dea73b 100644--- a/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=c6bdc332634f2992508d5118654532adca12b852)+++ b/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=ef517d2d21c3d8e2ad35b2bb728bd1c90a31e617)@@ -719,8 +719,10 @@ int f2fs\_write\_inode(struct inode \*inode, struct writeback\_control \*wbc) !is\_inode\_flag\_set(inode, FI\_DIRTY\_INODE)) return 0; - if (!f2fs\_is\_checkpoint\_ready(sbi))+ if (!f2fs\_is\_checkpoint\_ready(sbi)) {+ f2fs\_mark\_inode\_dirty\_sync(inode, true); return -ENOSPC;+ }  /\* \* We need to balance fs here to prevent from producing dirty node pages |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:37:51 +0000



=== Content from git.kernel.org_8333b32f_20250115_083909.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e28513fd2858911dcf47b84160a8824587536b6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e28513fd2858911dcf47b84160a8824587536b6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e28513fd2858911dcf47b84160a8824587536b6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e28513fd2858911dcf47b84160a8824587536b6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qi Han <hanqi@vivo.com> | 2024-09-18 02:44:00 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:04:03 +0100 |
| commit | [9e28513fd2858911dcf47b84160a8824587536b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e28513fd2858911dcf47b84160a8824587536b6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e28513fd2858911dcf47b84160a8824587536b6)) | |
| tree | [e8034c06fe3b79f4e5316fed9d1ec0e700f40ba0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e28513fd2858911dcf47b84160a8824587536b6) | |
| parent | [d6855f0604435202c9183b9838be1200b66cccfa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6855f0604435202c9183b9838be1200b66cccfa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e28513fd2858911dcf47b84160a8824587536b6&id2=d6855f0604435202c9183b9838be1200b66cccfa)) | |
| download | [linux-9e28513fd2858911dcf47b84160a8824587536b6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e28513fd2858911dcf47b84160a8824587536b6.tar.gz) | |

f2fs: fix f2fs\_bug\_on when uninstalling filesystem call f2fs\_evict\_inode.[ Upstream commit d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca ]
creating a large files during checkpoint disable until it runs out of
space and then delete it, then remount to enable checkpoint again, and
then unmount the filesystem triggers the f2fs\_bug\_on as below:
------------[ cut here ]------------
kernel BUG at fs/f2fs/inode.c:896!
CPU: 2 UID: 0 PID: 1286 Comm: umount Not tainted 6.11.0-rc7-dirty #360
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:f2fs\_evict\_inode+0x58c/0x610
Call Trace:
\_\_die\_body+0x15/0x60
die+0x33/0x50
do\_trap+0x10a/0x120
f2fs\_evict\_inode+0x58c/0x610
do\_error\_trap+0x60/0x80
f2fs\_evict\_inode+0x58c/0x610
exc\_invalid\_op+0x53/0x60
f2fs\_evict\_inode+0x58c/0x610
asm\_exc\_invalid\_op+0x16/0x20
f2fs\_evict\_inode+0x58c/0x610
evict+0x101/0x260
dispose\_list+0x30/0x50
evict\_inodes+0x140/0x190
generic\_shutdown\_super+0x2f/0x150
kill\_block\_super+0x11/0x40
kill\_f2fs\_super+0x7d/0x140
deactivate\_locked\_super+0x2a/0x70
cleanup\_mnt+0xb3/0x140
task\_work\_run+0x61/0x90
The root cause is: creating large files during disable checkpoint
period results in not enough free segments, so when writing back root
inode will failed in f2fs\_enable\_checkpoint. When umount the file
system after enabling checkpoint, the root inode is dirty in
f2fs\_evict\_inode function, which triggers BUG\_ON. The steps to
reproduce are as follows:
dd if=/dev/zero of=f2fs.img bs=1M count=55
mount f2fs.img f2fs\_dir -o checkpoint=disable:10%
dd if=/dev/zero of=big bs=1M count=50
sync
rm big
mount -o remount,checkpoint=enable f2fs\_dir
umount f2fs\_dir
Let's redirty inode when there is not free segments during checkpoint
is disable.
Signed-off-by: Qi Han <hanqi@vivo.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e28513fd2858911dcf47b84160a8824587536b6)

| -rw-r--r-- | [fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/inode.c?id=9e28513fd2858911dcf47b84160a8824587536b6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/f2fs/inode.c b/fs/f2fs/inode.cindex 1ed86df343a5d1..10780e37fc7b68 100644--- a/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=d6855f0604435202c9183b9838be1200b66cccfa)+++ b/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=9e28513fd2858911dcf47b84160a8824587536b6)@@ -775,8 +775,10 @@ int f2fs\_write\_inode(struct inode \*inode, struct writeback\_control \*wbc) !is\_inode\_flag\_set(inode, FI\_DIRTY\_INODE)) return 0; - if (!f2fs\_is\_checkpoint\_ready(sbi))+ if (!f2fs\_is\_checkpoint\_ready(sbi)) {+ f2fs\_mark\_inode\_dirty\_sync(inode, true); return -ENOSPC;+ }  /\* \* We need to balance fs here to prevent from producing dirty node pages |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:37:47 +0000



=== Content from git.kernel.org_5c426b63_20250115_083911.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qi Han <hanqi@vivo.com> | 2024-09-18 02:44:00 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:41 +0100 |
| commit | [a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7)) | |
| tree | [378f18a4227a94684c6f794918e1d2ec505eac17](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7) | |
| parent | [c710201af655f859b7842a63d850a4b4d78c7d6d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c710201af655f859b7842a63d850a4b4d78c7d6d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7&id2=c710201af655f859b7842a63d850a4b4d78c7d6d)) | |
| download | [linux-a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7.tar.gz) | |

f2fs: fix f2fs\_bug\_on when uninstalling filesystem call f2fs\_evict\_inode.[ Upstream commit d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca ]
creating a large files during checkpoint disable until it runs out of
space and then delete it, then remount to enable checkpoint again, and
then unmount the filesystem triggers the f2fs\_bug\_on as below:
------------[ cut here ]------------
kernel BUG at fs/f2fs/inode.c:896!
CPU: 2 UID: 0 PID: 1286 Comm: umount Not tainted 6.11.0-rc7-dirty #360
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:f2fs\_evict\_inode+0x58c/0x610
Call Trace:
\_\_die\_body+0x15/0x60
die+0x33/0x50
do\_trap+0x10a/0x120
f2fs\_evict\_inode+0x58c/0x610
do\_error\_trap+0x60/0x80
f2fs\_evict\_inode+0x58c/0x610
exc\_invalid\_op+0x53/0x60
f2fs\_evict\_inode+0x58c/0x610
asm\_exc\_invalid\_op+0x16/0x20
f2fs\_evict\_inode+0x58c/0x610
evict+0x101/0x260
dispose\_list+0x30/0x50
evict\_inodes+0x140/0x190
generic\_shutdown\_super+0x2f/0x150
kill\_block\_super+0x11/0x40
kill\_f2fs\_super+0x7d/0x140
deactivate\_locked\_super+0x2a/0x70
cleanup\_mnt+0xb3/0x140
task\_work\_run+0x61/0x90
The root cause is: creating large files during disable checkpoint
period results in not enough free segments, so when writing back root
inode will failed in f2fs\_enable\_checkpoint. When umount the file
system after enabling checkpoint, the root inode is dirty in
f2fs\_evict\_inode function, which triggers BUG\_ON. The steps to
reproduce are as follows:
dd if=/dev/zero of=f2fs.img bs=1M count=55
mount f2fs.img f2fs\_dir -o checkpoint=disable:10%
dd if=/dev/zero of=big bs=1M count=50
sync
rm big
mount -o remount,checkpoint=enable f2fs\_dir
umount f2fs\_dir
Let's redirty inode when there is not free segments during checkpoint
is disable.
Signed-off-by: Qi Han <hanqi@vivo.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7)

| -rw-r--r-- | [fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/inode.c?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/f2fs/inode.c b/fs/f2fs/inode.cindex 27bd8d1bae4d3d..558f478d037d0e 100644--- a/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=c710201af655f859b7842a63d850a4b4d78c7d6d)+++ b/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=a365de2fbfbe1e6740bfb75ab5c3245cf7bbe4d7)@@ -724,8 +724,10 @@ int f2fs\_write\_inode(struct inode \*inode, struct writeback\_control \*wbc) !is\_inode\_flag\_set(inode, FI\_DIRTY\_INODE)) return 0; - if (!f2fs\_is\_checkpoint\_ready(sbi))+ if (!f2fs\_is\_checkpoint\_ready(sbi)) {+ f2fs\_mark\_inode\_dirty\_sync(inode, true); return -ENOSPC;+ }  /\* \* We need to balance fs here to prevent from producing dirty node pages |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:37:47 +0000



=== Content from git.kernel.org_897dfc16_20250115_083913.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qi Han <hanqi@vivo.com> | 2024-09-18 02:44:00 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:31 +0100 |
| commit | [dff561e4060d28edc9a2960d4a87f3c945a96aa3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3)) | |
| tree | [ccde7114416017c61e916cd286db78ca105ab81e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3) | |
| parent | [22169b3675630110349d68214fbc309f43323aeb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22169b3675630110349d68214fbc309f43323aeb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3&id2=22169b3675630110349d68214fbc309f43323aeb)) | |
| download | [linux-dff561e4060d28edc9a2960d4a87f3c945a96aa3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dff561e4060d28edc9a2960d4a87f3c945a96aa3.tar.gz) | |

f2fs: fix f2fs\_bug\_on when uninstalling filesystem call f2fs\_evict\_inode.[ Upstream commit d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca ]
creating a large files during checkpoint disable until it runs out of
space and then delete it, then remount to enable checkpoint again, and
then unmount the filesystem triggers the f2fs\_bug\_on as below:
------------[ cut here ]------------
kernel BUG at fs/f2fs/inode.c:896!
CPU: 2 UID: 0 PID: 1286 Comm: umount Not tainted 6.11.0-rc7-dirty #360
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:f2fs\_evict\_inode+0x58c/0x610
Call Trace:
\_\_die\_body+0x15/0x60
die+0x33/0x50
do\_trap+0x10a/0x120
f2fs\_evict\_inode+0x58c/0x610
do\_error\_trap+0x60/0x80
f2fs\_evict\_inode+0x58c/0x610
exc\_invalid\_op+0x53/0x60
f2fs\_evict\_inode+0x58c/0x610
asm\_exc\_invalid\_op+0x16/0x20
f2fs\_evict\_inode+0x58c/0x610
evict+0x101/0x260
dispose\_list+0x30/0x50
evict\_inodes+0x140/0x190
generic\_shutdown\_super+0x2f/0x150
kill\_block\_super+0x11/0x40
kill\_f2fs\_super+0x7d/0x140
deactivate\_locked\_super+0x2a/0x70
cleanup\_mnt+0xb3/0x140
task\_work\_run+0x61/0x90
The root cause is: creating large files during disable checkpoint
period results in not enough free segments, so when writing back root
inode will failed in f2fs\_enable\_checkpoint. When umount the file
system after enabling checkpoint, the root inode is dirty in
f2fs\_evict\_inode function, which triggers BUG\_ON. The steps to
reproduce are as follows:
dd if=/dev/zero of=f2fs.img bs=1M count=55
mount f2fs.img f2fs\_dir -o checkpoint=disable:10%
dd if=/dev/zero of=big bs=1M count=50
sync
rm big
mount -o remount,checkpoint=enable f2fs\_dir
umount f2fs\_dir
Let's redirty inode when there is not free segments during checkpoint
is disable.
Signed-off-by: Qi Han <hanqi@vivo.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3)

| -rw-r--r-- | [fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/inode.c?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/f2fs/inode.c b/fs/f2fs/inode.cindex b23e6a848e9b7a..452c0240cc11eb 100644--- a/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=22169b3675630110349d68214fbc309f43323aeb)+++ b/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=dff561e4060d28edc9a2960d4a87f3c945a96aa3)@@ -701,8 +701,10 @@ int f2fs\_write\_inode(struct inode \*inode, struct writeback\_control \*wbc) !is\_inode\_flag\_set(inode, FI\_DIRTY\_INODE)) return 0; - if (!f2fs\_is\_checkpoint\_ready(sbi))+ if (!f2fs\_is\_checkpoint\_ready(sbi)) {+ f2fs\_mark\_inode\_dirty\_sync(inode, true); return -ENOSPC;+ }  /\* \* We need to balance fs here to prevent from producing dirty node pages |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:37:50 +0000



=== Content from git.kernel.org_fcd02754_20250115_083909.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qi Han <hanqi@vivo.com> | 2024-09-18 02:44:00 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:00:13 +0100 |
| commit | [9669b28f81e0ec6305af7773846fbe2cef1e7d61](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61)) | |
| tree | [a1e68f1d5fbc2a41049aa24e298da963c6460187](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61) | |
| parent | [56233417029561b662e93bac38d57a519e32f974](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56233417029561b662e93bac38d57a519e32f974) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61&id2=56233417029561b662e93bac38d57a519e32f974)) | |
| download | [linux-9669b28f81e0ec6305af7773846fbe2cef1e7d61.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9669b28f81e0ec6305af7773846fbe2cef1e7d61.tar.gz) | |

f2fs: fix f2fs\_bug\_on when uninstalling filesystem call f2fs\_evict\_inode.[ Upstream commit d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca ]
creating a large files during checkpoint disable until it runs out of
space and then delete it, then remount to enable checkpoint again, and
then unmount the filesystem triggers the f2fs\_bug\_on as below:
------------[ cut here ]------------
kernel BUG at fs/f2fs/inode.c:896!
CPU: 2 UID: 0 PID: 1286 Comm: umount Not tainted 6.11.0-rc7-dirty #360
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:f2fs\_evict\_inode+0x58c/0x610
Call Trace:
\_\_die\_body+0x15/0x60
die+0x33/0x50
do\_trap+0x10a/0x120
f2fs\_evict\_inode+0x58c/0x610
do\_error\_trap+0x60/0x80
f2fs\_evict\_inode+0x58c/0x610
exc\_invalid\_op+0x53/0x60
f2fs\_evict\_inode+0x58c/0x610
asm\_exc\_invalid\_op+0x16/0x20
f2fs\_evict\_inode+0x58c/0x610
evict+0x101/0x260
dispose\_list+0x30/0x50
evict\_inodes+0x140/0x190
generic\_shutdown\_super+0x2f/0x150
kill\_block\_super+0x11/0x40
kill\_f2fs\_super+0x7d/0x140
deactivate\_locked\_super+0x2a/0x70
cleanup\_mnt+0xb3/0x140
task\_work\_run+0x61/0x90
The root cause is: creating large files during disable checkpoint
period results in not enough free segments, so when writing back root
inode will failed in f2fs\_enable\_checkpoint. When umount the file
system after enabling checkpoint, the root inode is dirty in
f2fs\_evict\_inode function, which triggers BUG\_ON. The steps to
reproduce are as follows:
dd if=/dev/zero of=f2fs.img bs=1M count=55
mount f2fs.img f2fs\_dir -o checkpoint=disable:10%
dd if=/dev/zero of=big bs=1M count=50
sync
rm big
mount -o remount,checkpoint=enable f2fs\_dir
umount f2fs\_dir
Let's redirty inode when there is not free segments during checkpoint
is disable.
Signed-off-by: Qi Han <hanqi@vivo.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61)

| -rw-r--r-- | [fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/inode.c?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/f2fs/inode.c b/fs/f2fs/inode.cindex a3e0c927354331..7ad4a924175917 100644--- a/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=56233417029561b662e93bac38d57a519e32f974)+++ b/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=9669b28f81e0ec6305af7773846fbe2cef1e7d61)@@ -788,8 +788,10 @@ int f2fs\_write\_inode(struct inode \*inode, struct writeback\_control \*wbc) !is\_inode\_flag\_set(inode, FI\_DIRTY\_INODE)) return 0; - if (!f2fs\_is\_checkpoint\_ready(sbi))+ if (!f2fs\_is\_checkpoint\_ready(sbi)) {+ f2fs\_mark\_inode\_dirty\_sync(inode, true); return -ENOSPC;+ }  /\* \* We need to balance fs here to prevent from producing dirty node pages |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:37:46 +0000



=== Content from git.kernel.org_cc5f14b6_20250115_083912.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qi Han <hanqi@vivo.com> | 2024-09-18 02:44:00 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:54 +0100 |
| commit | [ac8aaf78bd039fa1be0acaa8e84a56499f79d721](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721)) | |
| tree | [af5b9489719519d3c3b6167879a7f8381fed58b5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721) | |
| parent | [77ae53c49084c9d23e6d98df240c9ea459cb697c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=77ae53c49084c9d23e6d98df240c9ea459cb697c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721&id2=77ae53c49084c9d23e6d98df240c9ea459cb697c)) | |
| download | [linux-ac8aaf78bd039fa1be0acaa8e84a56499f79d721.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ac8aaf78bd039fa1be0acaa8e84a56499f79d721.tar.gz) | |

f2fs: fix f2fs\_bug\_on when uninstalling filesystem call f2fs\_evict\_inode.[ Upstream commit d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca ]
creating a large files during checkpoint disable until it runs out of
space and then delete it, then remount to enable checkpoint again, and
then unmount the filesystem triggers the f2fs\_bug\_on as below:
------------[ cut here ]------------
kernel BUG at fs/f2fs/inode.c:896!
CPU: 2 UID: 0 PID: 1286 Comm: umount Not tainted 6.11.0-rc7-dirty #360
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:f2fs\_evict\_inode+0x58c/0x610
Call Trace:
\_\_die\_body+0x15/0x60
die+0x33/0x50
do\_trap+0x10a/0x120
f2fs\_evict\_inode+0x58c/0x610
do\_error\_trap+0x60/0x80
f2fs\_evict\_inode+0x58c/0x610
exc\_invalid\_op+0x53/0x60
f2fs\_evict\_inode+0x58c/0x610
asm\_exc\_invalid\_op+0x16/0x20
f2fs\_evict\_inode+0x58c/0x610
evict+0x101/0x260
dispose\_list+0x30/0x50
evict\_inodes+0x140/0x190
generic\_shutdown\_super+0x2f/0x150
kill\_block\_super+0x11/0x40
kill\_f2fs\_super+0x7d/0x140
deactivate\_locked\_super+0x2a/0x70
cleanup\_mnt+0xb3/0x140
task\_work\_run+0x61/0x90
The root cause is: creating large files during disable checkpoint
period results in not enough free segments, so when writing back root
inode will failed in f2fs\_enable\_checkpoint. When umount the file
system after enabling checkpoint, the root inode is dirty in
f2fs\_evict\_inode function, which triggers BUG\_ON. The steps to
reproduce are as follows:
dd if=/dev/zero of=f2fs.img bs=1M count=55
mount f2fs.img f2fs\_dir -o checkpoint=disable:10%
dd if=/dev/zero of=big bs=1M count=50
sync
rm big
mount -o remount,checkpoint=enable f2fs\_dir
umount f2fs\_dir
Let's redirty inode when there is not free segments during checkpoint
is disable.
Signed-off-by: Qi Han <hanqi@vivo.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721)

| -rw-r--r-- | [fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/inode.c?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/f2fs/inode.c b/fs/f2fs/inode.cindex 53e1a757e4e17e..b0cbb01df8cba8 100644--- a/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=77ae53c49084c9d23e6d98df240c9ea459cb697c)+++ b/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=ac8aaf78bd039fa1be0acaa8e84a56499f79d721)@@ -631,8 +631,10 @@ int f2fs\_write\_inode(struct inode \*inode, struct writeback\_control \*wbc) !is\_inode\_flag\_set(inode, FI\_DIRTY\_INODE)) return 0; - if (!f2fs\_is\_checkpoint\_ready(sbi))+ if (!f2fs\_is\_checkpoint\_ready(sbi)) {+ f2fs\_mark\_inode\_dirty\_sync(inode, true); return -ENOSPC;+ }  /\* \* We need to balance fs here to prevent from producing dirty node pages |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:37:48 +0000



=== Content from git.kernel.org_472f8cd8_20250115_083912.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qi Han <hanqi@vivo.com> | 2024-09-18 02:44:00 -0600 |
| --- | --- | --- |
| committer | Jaegeuk Kim <jaegeuk@kernel.org> | 2024-10-14 20:04:57 +0000 |
| commit | [d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca)) | |
| tree | [78ee0289041309af3b2de433d1c4cdf1d12c9210](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca) | |
| parent | [26413ce18e85de3dda2cd3d72c3c3e8ab8f4f996](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26413ce18e85de3dda2cd3d72c3c3e8ab8f4f996) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca&id2=26413ce18e85de3dda2cd3d72c3c3e8ab8f4f996)) | |
| download | [linux-d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca.tar.gz) | |

f2fs: fix f2fs\_bug\_on when uninstalling filesystem call f2fs\_evict\_inode.creating a large files during checkpoint disable until it runs out of
space and then delete it, then remount to enable checkpoint again, and
then unmount the filesystem triggers the f2fs\_bug\_on as below:
------------[ cut here ]------------
kernel BUG at fs/f2fs/inode.c:896!
CPU: 2 UID: 0 PID: 1286 Comm: umount Not tainted 6.11.0-rc7-dirty #360
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
RIP: 0010:f2fs\_evict\_inode+0x58c/0x610
Call Trace:
\_\_die\_body+0x15/0x60
die+0x33/0x50
do\_trap+0x10a/0x120
f2fs\_evict\_inode+0x58c/0x610
do\_error\_trap+0x60/0x80
f2fs\_evict\_inode+0x58c/0x610
exc\_invalid\_op+0x53/0x60
f2fs\_evict\_inode+0x58c/0x610
asm\_exc\_invalid\_op+0x16/0x20
f2fs\_evict\_inode+0x58c/0x610
evict+0x101/0x260
dispose\_list+0x30/0x50
evict\_inodes+0x140/0x190
generic\_shutdown\_super+0x2f/0x150
kill\_block\_super+0x11/0x40
kill\_f2fs\_super+0x7d/0x140
deactivate\_locked\_super+0x2a/0x70
cleanup\_mnt+0xb3/0x140
task\_work\_run+0x61/0x90
The root cause is: creating large files during disable checkpoint
period results in not enough free segments, so when writing back root
inode will failed in f2fs\_enable\_checkpoint. When umount the file
system after enabling checkpoint, the root inode is dirty in
f2fs\_evict\_inode function, which triggers BUG\_ON. The steps to
reproduce are as follows:
dd if=/dev/zero of=f2fs.img bs=1M count=55
mount f2fs.img f2fs\_dir -o checkpoint=disable:10%
dd if=/dev/zero of=big bs=1M count=50
sync
rm big
mount -o remount,checkpoint=enable f2fs\_dir
umount f2fs\_dir
Let's redirty inode when there is not free segments during checkpoint
is disable.
Signed-off-by: Qi Han <hanqi@vivo.com>
Reviewed-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca)

| -rw-r--r-- | [fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/inode.c?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/f2fs/inode.c b/fs/f2fs/inode.cindex 1ed86df343a5d1..10780e37fc7b68 100644--- a/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=26413ce18e85de3dda2cd3d72c3c3e8ab8f4f996)+++ b/[fs/f2fs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/inode.c?id=d5c367ef8287fb4d235c46a2f8c8d68715f3a0ca)@@ -775,8 +775,10 @@ int f2fs\_write\_inode(struct inode \*inode, struct writeback\_control \*wbc) !is\_inode\_flag\_set(inode, FI\_DIRTY\_INODE)) return 0; - if (!f2fs\_is\_checkpoint\_ready(sbi))+ if (!f2fs\_is\_checkpoint\_ready(sbi)) {+ f2fs\_mark\_inode\_dirty\_sync(inode, true); return -ENOSPC;+ }  /\* \* We need to balance fs here to prevent from producing dirty node pages |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:37:49 +0000


