=== Content from git.kernel.org_cfe4d2bb_20250114_225412.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Kuznetsov <vkuznets@redhat.com> | 2024-11-11 14:12:40 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:35 +0100 |
| commit | [3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160)) | |
| tree | [bd9400b8e9c6f391fd47f8e02933d59200249683](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160) | |
| parent | [acf588f9b6fb560e986365c6b175aaf589ef1f2a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acf588f9b6fb560e986365c6b175aaf589ef1f2a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160&id2=acf588f9b6fb560e986365c6b175aaf589ef1f2a)) | |
| download | [linux-3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160.tar.gz) | |

HID: hyperv: streamline driver probe to avoid devres issues[ Upstream commit 66ef47faa90d838cda131fe1f7776456cc3b59f2 ]
It was found that unloading 'hid\_hyperv' module results in a devres
complaint:
...
hv\_vmbus: unregistering driver hid\_hyperv
------------[ cut here ]------------
WARNING: CPU: 2 PID: 3983 at drivers/base/devres.c:691 devres\_release\_group+0x1f2/0x2c0
...
Call Trace:
<TASK>
? devres\_release\_group+0x1f2/0x2c0
? \_\_warn+0xd1/0x1c0
? devres\_release\_group+0x1f2/0x2c0
? report\_bug+0x32a/0x3c0
? handle\_bug+0x53/0xa0
? exc\_invalid\_op+0x18/0x50
? asm\_exc\_invalid\_op+0x1a/0x20
? devres\_release\_group+0x1f2/0x2c0
? devres\_release\_group+0x90/0x2c0
? rcu\_is\_watching+0x15/0xb0
? \_\_pfx\_devres\_release\_group+0x10/0x10
hid\_device\_remove+0xf5/0x220
device\_release\_driver\_internal+0x371/0x540
? klist\_put+0xf3/0x170
bus\_remove\_device+0x1f1/0x3f0
device\_del+0x33f/0x8c0
? \_\_pfx\_device\_del+0x10/0x10
? cleanup\_srcu\_struct+0x337/0x500
hid\_destroy\_device+0xc8/0x130
mousevsc\_remove+0xd2/0x1d0 [hid\_hyperv]
device\_release\_driver\_internal+0x371/0x540
driver\_detach+0xc5/0x180
bus\_remove\_driver+0x11e/0x2a0
? \_\_mutex\_unlock\_slowpath+0x160/0x5e0
vmbus\_driver\_unregister+0x62/0x2b0 [hv\_vmbus]
...
And the issue seems to be that the corresponding devres group is not
allocated. Normally, devres\_open\_group() is called from
\_\_hid\_device\_probe() but Hyper-V HID driver overrides 'hid\_dev->driver'
with 'mousevsc\_hid\_driver' stub and basically re-implements
\_\_hid\_device\_probe() by calling hid\_parse() and hid\_hw\_start() but not
devres\_open\_group(). hid\_device\_probe() does not call \_\_hid\_device\_probe()
for it. Later, when the driver is removed, hid\_device\_remove() calls
devres\_release\_group() as it doesn't check whether hdev->driver was
initially overridden or not.
The issue seems to be related to the commit 62c68e7cee33 ("HID: ensure
timely release of driver-allocated resources") but the commit itself seems
to be correct.
Fix the issue by dropping the 'hid\_dev->driver' override and using
hid\_register\_driver()/hid\_unregister\_driver() instead. Alternatively, it
would have been possible to rely on the default handling but
HID\_CONNECT\_DEFAULT implies HID\_CONNECT\_HIDRAW and it doesn't seem to work
for mousevsc as-is.
Fixes: 62c68e7cee33 ("HID: ensure timely release of driver-allocated resources")
Suggested-by: Michael Kelley <mhklinux@outlook.com>
Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Reviewed-by: Michael Kelley <mhklinux@outlook.com>
Tested-by: Saurabh Sengar <ssengar@linux.microsoft.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160)

| -rw-r--r-- | [drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/hid-hyperv.c?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160) | 58 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 17 deletions

| diff --git a/drivers/hid/hid-hyperv.c b/drivers/hid/hid-hyperv.cindex f33485d83d24ff..0fb210e40a4127 100644--- a/[drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/hid-hyperv.c?id=acf588f9b6fb560e986365c6b175aaf589ef1f2a)+++ b/[drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/hid-hyperv.c?id=3d48d0fbaaa74a04fb9092780a3f83dc4f3f8160)@@ -422,6 +422,25 @@ static int mousevsc\_hid\_raw\_request(struct hid\_device \*hid, return 0; } +static int mousevsc\_hid\_probe(struct hid\_device \*hid\_dev, const struct hid\_device\_id \*id)+{+ int ret;++ ret = hid\_parse(hid\_dev);+ if (ret) {+ hid\_err(hid\_dev, "parse failed\n");+ return ret;+ }++ ret = hid\_hw\_start(hid\_dev, HID\_CONNECT\_HIDINPUT | HID\_CONNECT\_HIDDEV);+ if (ret) {+ hid\_err(hid\_dev, "hw start failed\n");+ return ret;+ }++ return 0;+}+ static const struct hid\_ll\_driver mousevsc\_ll\_driver = { .parse = mousevsc\_hid\_parse, .open = mousevsc\_hid\_open,@@ -431,7 +450,16 @@ static const struct hid\_ll\_driver mousevsc\_ll\_driver = { .raw\_request = mousevsc\_hid\_raw\_request, }; -static struct hid\_driver mousevsc\_hid\_driver;+static const struct hid\_device\_id mousevsc\_devices[] = {+ { HID\_DEVICE(BUS\_VIRTUAL, HID\_GROUP\_ANY, 0x045E, 0x0621) },+ { }+};++static struct hid\_driver mousevsc\_hid\_driver = {+ .name = "hid-hyperv",+ .id\_table = mousevsc\_devices,+ .probe = mousevsc\_hid\_probe,+};  static int mousevsc\_probe(struct hv\_device \*device, const struct hv\_vmbus\_device\_id \*dev\_id)@@ -473,7 +501,6 @@ static int mousevsc\_probe(struct hv\_device \*device, }  hid\_dev->ll\_driver = &mousevsc\_ll\_driver;- hid\_dev->driver = &mousevsc\_hid\_driver; hid\_dev->bus = BUS\_VIRTUAL; hid\_dev->vendor = input\_dev->hid\_dev\_info.vendor; hid\_dev->product = input\_dev->hid\_dev\_info.product;@@ -488,20 +515,6 @@ static int mousevsc\_probe(struct hv\_device \*device, if (ret) goto probe\_err2; -- ret = hid\_parse(hid\_dev);- if (ret) {- hid\_err(hid\_dev, "parse failed\n");- goto probe\_err2;- }-- ret = hid\_hw\_start(hid\_dev, HID\_CONNECT\_HIDINPUT | HID\_CONNECT\_HIDDEV);-- if (ret) {- hid\_err(hid\_dev, "hw start failed\n");- goto probe\_err2;- }- device\_init\_wakeup(&device->device, true);  input\_dev->connected = true;@@ -579,12 +592,23 @@ static struct hv\_driver mousevsc\_drv = {  static int \_\_init mousevsc\_init(void) {- return vmbus\_driver\_register(&mousevsc\_drv);+ int ret;++ ret = hid\_register\_driver(&mousevsc\_hid\_driver);+ if (ret)+ return ret;++ ret = vmbus\_driver\_register(&mousevsc\_drv);+ if (ret)+ hid\_unregister\_driver(&mousevsc\_hid\_driver);++ return ret; }  static void \_\_exit mousevsc\_exit(void) { vmbus\_driver\_unregister(&mousevsc\_drv);+ hid\_unregister\_driver(&mousevsc\_hid\_driver); }  MODULE\_LICENSE("GPL"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:52:49 +0000



=== Content from git.kernel.org_bf230119_20250114_225411.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Kuznetsov <vkuznets@redhat.com> | 2024-11-11 14:12:40 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:06 +0100 |
| commit | [19a9457e5e210e408c1f8865b5d93c5a2c90409d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d)) | |
| tree | [ff0a673ca84cddcec52fb00e33cc0d91050ebdbf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d) | |
| parent | [9a1a26156363cd9e88c933d649bae7701e5e78cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a1a26156363cd9e88c933d649bae7701e5e78cb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d&id2=9a1a26156363cd9e88c933d649bae7701e5e78cb)) | |
| download | [linux-19a9457e5e210e408c1f8865b5d93c5a2c90409d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-19a9457e5e210e408c1f8865b5d93c5a2c90409d.tar.gz) | |

HID: hyperv: streamline driver probe to avoid devres issues[ Upstream commit 66ef47faa90d838cda131fe1f7776456cc3b59f2 ]
It was found that unloading 'hid\_hyperv' module results in a devres
complaint:
...
hv\_vmbus: unregistering driver hid\_hyperv
------------[ cut here ]------------
WARNING: CPU: 2 PID: 3983 at drivers/base/devres.c:691 devres\_release\_group+0x1f2/0x2c0
...
Call Trace:
<TASK>
? devres\_release\_group+0x1f2/0x2c0
? \_\_warn+0xd1/0x1c0
? devres\_release\_group+0x1f2/0x2c0
? report\_bug+0x32a/0x3c0
? handle\_bug+0x53/0xa0
? exc\_invalid\_op+0x18/0x50
? asm\_exc\_invalid\_op+0x1a/0x20
? devres\_release\_group+0x1f2/0x2c0
? devres\_release\_group+0x90/0x2c0
? rcu\_is\_watching+0x15/0xb0
? \_\_pfx\_devres\_release\_group+0x10/0x10
hid\_device\_remove+0xf5/0x220
device\_release\_driver\_internal+0x371/0x540
? klist\_put+0xf3/0x170
bus\_remove\_device+0x1f1/0x3f0
device\_del+0x33f/0x8c0
? \_\_pfx\_device\_del+0x10/0x10
? cleanup\_srcu\_struct+0x337/0x500
hid\_destroy\_device+0xc8/0x130
mousevsc\_remove+0xd2/0x1d0 [hid\_hyperv]
device\_release\_driver\_internal+0x371/0x540
driver\_detach+0xc5/0x180
bus\_remove\_driver+0x11e/0x2a0
? \_\_mutex\_unlock\_slowpath+0x160/0x5e0
vmbus\_driver\_unregister+0x62/0x2b0 [hv\_vmbus]
...
And the issue seems to be that the corresponding devres group is not
allocated. Normally, devres\_open\_group() is called from
\_\_hid\_device\_probe() but Hyper-V HID driver overrides 'hid\_dev->driver'
with 'mousevsc\_hid\_driver' stub and basically re-implements
\_\_hid\_device\_probe() by calling hid\_parse() and hid\_hw\_start() but not
devres\_open\_group(). hid\_device\_probe() does not call \_\_hid\_device\_probe()
for it. Later, when the driver is removed, hid\_device\_remove() calls
devres\_release\_group() as it doesn't check whether hdev->driver was
initially overridden or not.
The issue seems to be related to the commit 62c68e7cee33 ("HID: ensure
timely release of driver-allocated resources") but the commit itself seems
to be correct.
Fix the issue by dropping the 'hid\_dev->driver' override and using
hid\_register\_driver()/hid\_unregister\_driver() instead. Alternatively, it
would have been possible to rely on the default handling but
HID\_CONNECT\_DEFAULT implies HID\_CONNECT\_HIDRAW and it doesn't seem to work
for mousevsc as-is.
Fixes: 62c68e7cee33 ("HID: ensure timely release of driver-allocated resources")
Suggested-by: Michael Kelley <mhklinux@outlook.com>
Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Reviewed-by: Michael Kelley <mhklinux@outlook.com>
Tested-by: Saurabh Sengar <ssengar@linux.microsoft.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d)

| -rw-r--r-- | [drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/hid-hyperv.c?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d) | 58 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 17 deletions

| diff --git a/drivers/hid/hid-hyperv.c b/drivers/hid/hid-hyperv.cindex f33485d83d24ff..0fb210e40a4127 100644--- a/[drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/hid-hyperv.c?id=9a1a26156363cd9e88c933d649bae7701e5e78cb)+++ b/[drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/hid-hyperv.c?id=19a9457e5e210e408c1f8865b5d93c5a2c90409d)@@ -422,6 +422,25 @@ static int mousevsc\_hid\_raw\_request(struct hid\_device \*hid, return 0; } +static int mousevsc\_hid\_probe(struct hid\_device \*hid\_dev, const struct hid\_device\_id \*id)+{+ int ret;++ ret = hid\_parse(hid\_dev);+ if (ret) {+ hid\_err(hid\_dev, "parse failed\n");+ return ret;+ }++ ret = hid\_hw\_start(hid\_dev, HID\_CONNECT\_HIDINPUT | HID\_CONNECT\_HIDDEV);+ if (ret) {+ hid\_err(hid\_dev, "hw start failed\n");+ return ret;+ }++ return 0;+}+ static const struct hid\_ll\_driver mousevsc\_ll\_driver = { .parse = mousevsc\_hid\_parse, .open = mousevsc\_hid\_open,@@ -431,7 +450,16 @@ static const struct hid\_ll\_driver mousevsc\_ll\_driver = { .raw\_request = mousevsc\_hid\_raw\_request, }; -static struct hid\_driver mousevsc\_hid\_driver;+static const struct hid\_device\_id mousevsc\_devices[] = {+ { HID\_DEVICE(BUS\_VIRTUAL, HID\_GROUP\_ANY, 0x045E, 0x0621) },+ { }+};++static struct hid\_driver mousevsc\_hid\_driver = {+ .name = "hid-hyperv",+ .id\_table = mousevsc\_devices,+ .probe = mousevsc\_hid\_probe,+};  static int mousevsc\_probe(struct hv\_device \*device, const struct hv\_vmbus\_device\_id \*dev\_id)@@ -473,7 +501,6 @@ static int mousevsc\_probe(struct hv\_device \*device, }  hid\_dev->ll\_driver = &mousevsc\_ll\_driver;- hid\_dev->driver = &mousevsc\_hid\_driver; hid\_dev->bus = BUS\_VIRTUAL; hid\_dev->vendor = input\_dev->hid\_dev\_info.vendor; hid\_dev->product = input\_dev->hid\_dev\_info.product;@@ -488,20 +515,6 @@ static int mousevsc\_probe(struct hv\_device \*device, if (ret) goto probe\_err2; -- ret = hid\_parse(hid\_dev);- if (ret) {- hid\_err(hid\_dev, "parse failed\n");- goto probe\_err2;- }-- ret = hid\_hw\_start(hid\_dev, HID\_CONNECT\_HIDINPUT | HID\_CONNECT\_HIDDEV);-- if (ret) {- hid\_err(hid\_dev, "hw start failed\n");- goto probe\_err2;- }- device\_init\_wakeup(&device->device, true);  input\_dev->connected = true;@@ -579,12 +592,23 @@ static struct hv\_driver mousevsc\_drv = {  static int \_\_init mousevsc\_init(void) {- return vmbus\_driver\_register(&mousevsc\_drv);+ int ret;++ ret = hid\_register\_driver(&mousevsc\_hid\_driver);+ if (ret)+ return ret;++ ret = vmbus\_driver\_register(&mousevsc\_drv);+ if (ret)+ hid\_unregister\_driver(&mousevsc\_hid\_driver);++ return ret; }  static void \_\_exit mousevsc\_exit(void) { vmbus\_driver\_unregister(&mousevsc\_drv);+ hid\_unregister\_driver(&mousevsc\_hid\_driver); }  MODULE\_LICENSE("GPL"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:52:48 +0000



=== Content from git.kernel.org_e1fcf4c4_20250114_225414.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b03e713a400aeb5f969bab4daf47a7402d0df814)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b03e713a400aeb5f969bab4daf47a7402d0df814)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b03e713a400aeb5f969bab4daf47a7402d0df814)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b03e713a400aeb5f969bab4daf47a7402d0df814)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Kuznetsov <vkuznets@redhat.com> | 2024-11-11 14:12:40 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:31:58 +0100 |
| commit | [b03e713a400aeb5f969bab4daf47a7402d0df814](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b03e713a400aeb5f969bab4daf47a7402d0df814) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b03e713a400aeb5f969bab4daf47a7402d0df814)) | |
| tree | [f922971b1613e8a251eb80a0356c58a4b0ab5db0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b03e713a400aeb5f969bab4daf47a7402d0df814) | |
| parent | [599929021528f353ab1e4f0ab0d43342adf4d50a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=599929021528f353ab1e4f0ab0d43342adf4d50a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b03e713a400aeb5f969bab4daf47a7402d0df814&id2=599929021528f353ab1e4f0ab0d43342adf4d50a)) | |
| download | [linux-b03e713a400aeb5f969bab4daf47a7402d0df814.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b03e713a400aeb5f969bab4daf47a7402d0df814.tar.gz) | |

HID: hyperv: streamline driver probe to avoid devres issues[ Upstream commit 66ef47faa90d838cda131fe1f7776456cc3b59f2 ]
It was found that unloading 'hid\_hyperv' module results in a devres
complaint:
...
hv\_vmbus: unregistering driver hid\_hyperv
------------[ cut here ]------------
WARNING: CPU: 2 PID: 3983 at drivers/base/devres.c:691 devres\_release\_group+0x1f2/0x2c0
...
Call Trace:
<TASK>
? devres\_release\_group+0x1f2/0x2c0
? \_\_warn+0xd1/0x1c0
? devres\_release\_group+0x1f2/0x2c0
? report\_bug+0x32a/0x3c0
? handle\_bug+0x53/0xa0
? exc\_invalid\_op+0x18/0x50
? asm\_exc\_invalid\_op+0x1a/0x20
? devres\_release\_group+0x1f2/0x2c0
? devres\_release\_group+0x90/0x2c0
? rcu\_is\_watching+0x15/0xb0
? \_\_pfx\_devres\_release\_group+0x10/0x10
hid\_device\_remove+0xf5/0x220
device\_release\_driver\_internal+0x371/0x540
? klist\_put+0xf3/0x170
bus\_remove\_device+0x1f1/0x3f0
device\_del+0x33f/0x8c0
? \_\_pfx\_device\_del+0x10/0x10
? cleanup\_srcu\_struct+0x337/0x500
hid\_destroy\_device+0xc8/0x130
mousevsc\_remove+0xd2/0x1d0 [hid\_hyperv]
device\_release\_driver\_internal+0x371/0x540
driver\_detach+0xc5/0x180
bus\_remove\_driver+0x11e/0x2a0
? \_\_mutex\_unlock\_slowpath+0x160/0x5e0
vmbus\_driver\_unregister+0x62/0x2b0 [hv\_vmbus]
...
And the issue seems to be that the corresponding devres group is not
allocated. Normally, devres\_open\_group() is called from
\_\_hid\_device\_probe() but Hyper-V HID driver overrides 'hid\_dev->driver'
with 'mousevsc\_hid\_driver' stub and basically re-implements
\_\_hid\_device\_probe() by calling hid\_parse() and hid\_hw\_start() but not
devres\_open\_group(). hid\_device\_probe() does not call \_\_hid\_device\_probe()
for it. Later, when the driver is removed, hid\_device\_remove() calls
devres\_release\_group() as it doesn't check whether hdev->driver was
initially overridden or not.
The issue seems to be related to the commit 62c68e7cee33 ("HID: ensure
timely release of driver-allocated resources") but the commit itself seems
to be correct.
Fix the issue by dropping the 'hid\_dev->driver' override and using
hid\_register\_driver()/hid\_unregister\_driver() instead. Alternatively, it
would have been possible to rely on the default handling but
HID\_CONNECT\_DEFAULT implies HID\_CONNECT\_HIDRAW and it doesn't seem to work
for mousevsc as-is.
Fixes: 62c68e7cee33 ("HID: ensure timely release of driver-allocated resources")
Suggested-by: Michael Kelley <mhklinux@outlook.com>
Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Reviewed-by: Michael Kelley <mhklinux@outlook.com>
Tested-by: Saurabh Sengar <ssengar@linux.microsoft.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b03e713a400aeb5f969bab4daf47a7402d0df814)

| -rw-r--r-- | [drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/hid-hyperv.c?id=b03e713a400aeb5f969bab4daf47a7402d0df814) | 58 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 17 deletions

| diff --git a/drivers/hid/hid-hyperv.c b/drivers/hid/hid-hyperv.cindex f33485d83d24ff..0fb210e40a4127 100644--- a/[drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/hid-hyperv.c?id=599929021528f353ab1e4f0ab0d43342adf4d50a)+++ b/[drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/hid-hyperv.c?id=b03e713a400aeb5f969bab4daf47a7402d0df814)@@ -422,6 +422,25 @@ static int mousevsc\_hid\_raw\_request(struct hid\_device \*hid, return 0; } +static int mousevsc\_hid\_probe(struct hid\_device \*hid\_dev, const struct hid\_device\_id \*id)+{+ int ret;++ ret = hid\_parse(hid\_dev);+ if (ret) {+ hid\_err(hid\_dev, "parse failed\n");+ return ret;+ }++ ret = hid\_hw\_start(hid\_dev, HID\_CONNECT\_HIDINPUT | HID\_CONNECT\_HIDDEV);+ if (ret) {+ hid\_err(hid\_dev, "hw start failed\n");+ return ret;+ }++ return 0;+}+ static const struct hid\_ll\_driver mousevsc\_ll\_driver = { .parse = mousevsc\_hid\_parse, .open = mousevsc\_hid\_open,@@ -431,7 +450,16 @@ static const struct hid\_ll\_driver mousevsc\_ll\_driver = { .raw\_request = mousevsc\_hid\_raw\_request, }; -static struct hid\_driver mousevsc\_hid\_driver;+static const struct hid\_device\_id mousevsc\_devices[] = {+ { HID\_DEVICE(BUS\_VIRTUAL, HID\_GROUP\_ANY, 0x045E, 0x0621) },+ { }+};++static struct hid\_driver mousevsc\_hid\_driver = {+ .name = "hid-hyperv",+ .id\_table = mousevsc\_devices,+ .probe = mousevsc\_hid\_probe,+};  static int mousevsc\_probe(struct hv\_device \*device, const struct hv\_vmbus\_device\_id \*dev\_id)@@ -473,7 +501,6 @@ static int mousevsc\_probe(struct hv\_device \*device, }  hid\_dev->ll\_driver = &mousevsc\_ll\_driver;- hid\_dev->driver = &mousevsc\_hid\_driver; hid\_dev->bus = BUS\_VIRTUAL; hid\_dev->vendor = input\_dev->hid\_dev\_info.vendor; hid\_dev->product = input\_dev->hid\_dev\_info.product;@@ -488,20 +515,6 @@ static int mousevsc\_probe(struct hv\_device \*device, if (ret) goto probe\_err2; -- ret = hid\_parse(hid\_dev);- if (ret) {- hid\_err(hid\_dev, "parse failed\n");- goto probe\_err2;- }-- ret = hid\_hw\_start(hid\_dev, HID\_CONNECT\_HIDINPUT | HID\_CONNECT\_HIDDEV);-- if (ret) {- hid\_err(hid\_dev, "hw start failed\n");- goto probe\_err2;- }- device\_init\_wakeup(&device->device, true);  input\_dev->connected = true;@@ -579,12 +592,23 @@ static struct hv\_driver mousevsc\_drv = {  static int \_\_init mousevsc\_init(void) {- return vmbus\_driver\_register(&mousevsc\_drv);+ int ret;++ ret = hid\_register\_driver(&mousevsc\_hid\_driver);+ if (ret)+ return ret;++ ret = vmbus\_driver\_register(&mousevsc\_drv);+ if (ret)+ hid\_unregister\_driver(&mousevsc\_hid\_driver);++ return ret; }  static void \_\_exit mousevsc\_exit(void) { vmbus\_driver\_unregister(&mousevsc\_drv);+ hid\_unregister\_driver(&mousevsc\_hid\_driver); }  MODULE\_LICENSE("GPL"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:52:51 +0000



=== Content from git.kernel.org_0672d70d_20250114_225413.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=66ef47faa90d838cda131fe1f7776456cc3b59f2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66ef47faa90d838cda131fe1f7776456cc3b59f2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66ef47faa90d838cda131fe1f7776456cc3b59f2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66ef47faa90d838cda131fe1f7776456cc3b59f2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Kuznetsov <vkuznets@redhat.com> | 2024-11-11 14:12:40 +0100 |
| --- | --- | --- |
| committer | Jiri Kosina <jkosina@suse.com> | 2024-11-12 10:15:30 +0100 |
| commit | [66ef47faa90d838cda131fe1f7776456cc3b59f2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66ef47faa90d838cda131fe1f7776456cc3b59f2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=66ef47faa90d838cda131fe1f7776456cc3b59f2)) | |
| tree | [08d7c274eaaba6835db3bf55b434b3c67d3e1116](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66ef47faa90d838cda131fe1f7776456cc3b59f2) | |
| parent | [87a2f10395c82c2b4687bb8611a6c5663a12f9e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87a2f10395c82c2b4687bb8611a6c5663a12f9e7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66ef47faa90d838cda131fe1f7776456cc3b59f2&id2=87a2f10395c82c2b4687bb8611a6c5663a12f9e7)) | |
| download | [linux-66ef47faa90d838cda131fe1f7776456cc3b59f2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-66ef47faa90d838cda131fe1f7776456cc3b59f2.tar.gz) | |

HID: hyperv: streamline driver probe to avoid devres issuesIt was found that unloading 'hid\_hyperv' module results in a devres
complaint:
...
hv\_vmbus: unregistering driver hid\_hyperv
------------[ cut here ]------------
WARNING: CPU: 2 PID: 3983 at drivers/base/devres.c:691 devres\_release\_group+0x1f2/0x2c0
...
Call Trace:
<TASK>
? devres\_release\_group+0x1f2/0x2c0
? \_\_warn+0xd1/0x1c0
? devres\_release\_group+0x1f2/0x2c0
? report\_bug+0x32a/0x3c0
? handle\_bug+0x53/0xa0
? exc\_invalid\_op+0x18/0x50
? asm\_exc\_invalid\_op+0x1a/0x20
? devres\_release\_group+0x1f2/0x2c0
? devres\_release\_group+0x90/0x2c0
? rcu\_is\_watching+0x15/0xb0
? \_\_pfx\_devres\_release\_group+0x10/0x10
hid\_device\_remove+0xf5/0x220
device\_release\_driver\_internal+0x371/0x540
? klist\_put+0xf3/0x170
bus\_remove\_device+0x1f1/0x3f0
device\_del+0x33f/0x8c0
? \_\_pfx\_device\_del+0x10/0x10
? cleanup\_srcu\_struct+0x337/0x500
hid\_destroy\_device+0xc8/0x130
mousevsc\_remove+0xd2/0x1d0 [hid\_hyperv]
device\_release\_driver\_internal+0x371/0x540
driver\_detach+0xc5/0x180
bus\_remove\_driver+0x11e/0x2a0
? \_\_mutex\_unlock\_slowpath+0x160/0x5e0
vmbus\_driver\_unregister+0x62/0x2b0 [hv\_vmbus]
...
And the issue seems to be that the corresponding devres group is not
allocated. Normally, devres\_open\_group() is called from
\_\_hid\_device\_probe() but Hyper-V HID driver overrides 'hid\_dev->driver'
with 'mousevsc\_hid\_driver' stub and basically re-implements
\_\_hid\_device\_probe() by calling hid\_parse() and hid\_hw\_start() but not
devres\_open\_group(). hid\_device\_probe() does not call \_\_hid\_device\_probe()
for it. Later, when the driver is removed, hid\_device\_remove() calls
devres\_release\_group() as it doesn't check whether hdev->driver was
initially overridden or not.
The issue seems to be related to the commit 62c68e7cee33 ("HID: ensure
timely release of driver-allocated resources") but the commit itself seems
to be correct.
Fix the issue by dropping the 'hid\_dev->driver' override and using
hid\_register\_driver()/hid\_unregister\_driver() instead. Alternatively, it
would have been possible to rely on the default handling but
HID\_CONNECT\_DEFAULT implies HID\_CONNECT\_HIDRAW and it doesn't seem to work
for mousevsc as-is.
Fixes: 62c68e7cee33 ("HID: ensure timely release of driver-allocated resources")
Suggested-by: Michael Kelley <mhklinux@outlook.com>
Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Reviewed-by: Michael Kelley <mhklinux@outlook.com>
Tested-by: Saurabh Sengar <ssengar@linux.microsoft.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66ef47faa90d838cda131fe1f7776456cc3b59f2)

| -rw-r--r-- | [drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/hid-hyperv.c?id=66ef47faa90d838cda131fe1f7776456cc3b59f2) | 58 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 41 insertions, 17 deletions

| diff --git a/drivers/hid/hid-hyperv.c b/drivers/hid/hid-hyperv.cindex f33485d83d24ff..0fb210e40a4127 100644--- a/[drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/hid-hyperv.c?id=87a2f10395c82c2b4687bb8611a6c5663a12f9e7)+++ b/[drivers/hid/hid-hyperv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/hid-hyperv.c?id=66ef47faa90d838cda131fe1f7776456cc3b59f2)@@ -422,6 +422,25 @@ static int mousevsc\_hid\_raw\_request(struct hid\_device \*hid, return 0; } +static int mousevsc\_hid\_probe(struct hid\_device \*hid\_dev, const struct hid\_device\_id \*id)+{+ int ret;++ ret = hid\_parse(hid\_dev);+ if (ret) {+ hid\_err(hid\_dev, "parse failed\n");+ return ret;+ }++ ret = hid\_hw\_start(hid\_dev, HID\_CONNECT\_HIDINPUT | HID\_CONNECT\_HIDDEV);+ if (ret) {+ hid\_err(hid\_dev, "hw start failed\n");+ return ret;+ }++ return 0;+}+ static const struct hid\_ll\_driver mousevsc\_ll\_driver = { .parse = mousevsc\_hid\_parse, .open = mousevsc\_hid\_open,@@ -431,7 +450,16 @@ static const struct hid\_ll\_driver mousevsc\_ll\_driver = { .raw\_request = mousevsc\_hid\_raw\_request, }; -static struct hid\_driver mousevsc\_hid\_driver;+static const struct hid\_device\_id mousevsc\_devices[] = {+ { HID\_DEVICE(BUS\_VIRTUAL, HID\_GROUP\_ANY, 0x045E, 0x0621) },+ { }+};++static struct hid\_driver mousevsc\_hid\_driver = {+ .name = "hid-hyperv",+ .id\_table = mousevsc\_devices,+ .probe = mousevsc\_hid\_probe,+};  static int mousevsc\_probe(struct hv\_device \*device, const struct hv\_vmbus\_device\_id \*dev\_id)@@ -473,7 +501,6 @@ static int mousevsc\_probe(struct hv\_device \*device, }  hid\_dev->ll\_driver = &mousevsc\_ll\_driver;- hid\_dev->driver = &mousevsc\_hid\_driver; hid\_dev->bus = BUS\_VIRTUAL; hid\_dev->vendor = input\_dev->hid\_dev\_info.vendor; hid\_dev->product = input\_dev->hid\_dev\_info.product;@@ -488,20 +515,6 @@ static int mousevsc\_probe(struct hv\_device \*device, if (ret) goto probe\_err2; -- ret = hid\_parse(hid\_dev);- if (ret) {- hid\_err(hid\_dev, "parse failed\n");- goto probe\_err2;- }-- ret = hid\_hw\_start(hid\_dev, HID\_CONNECT\_HIDINPUT | HID\_CONNECT\_HIDDEV);-- if (ret) {- hid\_err(hid\_dev, "hw start failed\n");- goto probe\_err2;- }- device\_init\_wakeup(&device->device, true);  input\_dev->connected = true;@@ -579,12 +592,23 @@ static struct hv\_driver mousevsc\_drv = {  static int \_\_init mousevsc\_init(void) {- return vmbus\_driver\_register(&mousevsc\_drv);+ int ret;++ ret = hid\_register\_driver(&mousevsc\_hid\_driver);+ if (ret)+ return ret;++ ret = vmbus\_driver\_register(&mousevsc\_drv);+ if (ret)+ hid\_unregister\_driver(&mousevsc\_hid\_driver);++ return ret; }  static void \_\_exit mousevsc\_exit(void) { vmbus\_driver\_unregister(&mousevsc\_drv);+ hid\_unregister\_driver(&mousevsc\_hid\_driver); }  MODULE\_LICENSE("GPL"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:52:50 +0000


