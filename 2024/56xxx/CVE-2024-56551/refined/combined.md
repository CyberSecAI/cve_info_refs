=== Content from git.kernel.org_d4bd6420_20250114_224510.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b61badd20b443eabe132314669bb51a263982e5c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b61badd20b443eabe132314669bb51a263982e5c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b61badd20b443eabe132314669bb51a263982e5c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b61badd20b443eabe132314669bb51a263982e5c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Prosyak <vitaly.prosyak@amd.com> | 2024-11-11 17:24:08 -0500 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2024-11-21 15:56:22 -0500 |
| commit | [b61badd20b443eabe132314669bb51a263982e5c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b61badd20b443eabe132314669bb51a263982e5c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b61badd20b443eabe132314669bb51a263982e5c)) | |
| tree | [bf97326f6beef8e11eb10b4fcd50bd1091f48833](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b61badd20b443eabe132314669bb51a263982e5c) | |
| parent | [928cd772e18ffbd7723cb2361db4a8ccf2222235](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=928cd772e18ffbd7723cb2361db4a8ccf2222235) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b61badd20b443eabe132314669bb51a263982e5c&id2=928cd772e18ffbd7723cb2361db4a8ccf2222235)) | |
| download | [linux-b61badd20b443eabe132314669bb51a263982e5c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b61badd20b443eabe132314669bb51a263982e5c.tar.gz) | |

drm/amdgpu: fix usage slab after free[ +0.000021] BUG: KASAN: slab-use-after-free in drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000027] Read of size 8 at addr ffff8881b8605f88 by task amd\_pci\_unplug/2147
[ +0.000023] CPU: 6 PID: 2147 Comm: amd\_pci\_unplug Not tainted 6.10.0+ #1
[ +0.000016] Hardware name: ASUS System Product Name/ROG STRIX B550-F GAMING (WI-FI), BIOS 1401 12/03/2020
[ +0.000016] Call Trace:
[ +0.000008] <TASK>
[ +0.000009] dump\_stack\_lvl+0x76/0xa0
[ +0.000017] print\_report+0xce/0x5f0
[ +0.000017] ? drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000019] ? srso\_return\_thunk+0x5/0x5f
[ +0.000015] ? kasan\_complete\_mode\_report\_info+0x72/0x200
[ +0.000016] ? drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000019] kasan\_report+0xbe/0x110
[ +0.000015] ? drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000023] \_\_asan\_report\_load8\_noabort+0x14/0x30
[ +0.000014] drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000020] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? \_\_kasan\_check\_write+0x14/0x30
[ +0.000016] ? \_\_pfx\_drm\_sched\_entity\_flush+0x10/0x10 [gpu\_sched]
[ +0.000020] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? \_\_kasan\_check\_write+0x14/0x30
[ +0.000013] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? enable\_work+0x124/0x220
[ +0.000015] ? \_\_pfx\_enable\_work+0x10/0x10
[ +0.000013] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? free\_large\_kmalloc+0x85/0xf0
[ +0.000016] drm\_sched\_entity\_destroy+0x18/0x30 [gpu\_sched]
[ +0.000020] amdgpu\_vce\_sw\_fini+0x55/0x170 [amdgpu]
[ +0.000735] ? \_\_kasan\_check\_read+0x11/0x20
[ +0.000016] vce\_v4\_0\_sw\_fini+0x80/0x110 [amdgpu]
[ +0.000726] amdgpu\_device\_fini\_sw+0x331/0xfc0 [amdgpu]
[ +0.000679] ? mutex\_unlock+0x80/0xe0
[ +0.000017] ? \_\_pfx\_amdgpu\_device\_fini\_sw+0x10/0x10 [amdgpu]
[ +0.000662] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? \_\_kasan\_check\_write+0x14/0x30
[ +0.000013] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? mutex\_unlock+0x80/0xe0
[ +0.000016] amdgpu\_driver\_release\_kms+0x16/0x80 [amdgpu]
[ +0.000663] drm\_minor\_release+0xc9/0x140 [drm]
[ +0.000081] drm\_release+0x1fd/0x390 [drm]
[ +0.000082] \_\_fput+0x36c/0xad0
[ +0.000018] \_\_fput\_sync+0x3c/0x50
[ +0.000014] \_\_x64\_sys\_close+0x7d/0xe0
[ +0.000014] x64\_sys\_call+0x1bc6/0x2680
[ +0.000014] do\_syscall\_64+0x70/0x130
[ +0.000014] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? irqentry\_exit\_to\_user\_mode+0x60/0x190
[ +0.000015] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? irqentry\_exit+0x43/0x50
[ +0.000012] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? exc\_page\_fault+0x7c/0x110
[ +0.000015] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ +0.000014] RIP: 0033:0x7ffff7b14f67
[ +0.000013] Code: ff e8 0d 16 02 00 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 b8 03 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 41 c3 48 83 ec 18 89 7c 24 0c e8 73 ba f7 ff
[ +0.000026] RSP: 002b:00007fffffffe378 EFLAGS: 00000246 ORIG\_RAX: 0000000000000003
[ +0.000019] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007ffff7b14f67
[ +0.000014] RDX: 0000000000000000 RSI: 00007ffff7f6f47a RDI: 0000000000000003
[ +0.000014] RBP: 00007fffffffe3a0 R08: 0000555555569890 R09: 0000000000000000
[ +0.000014] R10: 0000000000000000 R11: 0000000000000246 R12: 00007fffffffe5c8
[ +0.000013] R13: 00005555555552a9 R14: 0000555555557d48 R15: 00007ffff7ffd040
[ +0.000020] </TASK>
[ +0.000016] Allocated by task 383 on cpu 7 at 26.880319s:
[ +0.000014] kasan\_save\_stack+0x28/0x60
[ +0.000008] kasan\_save\_track+0x18/0x70
[ +0.000007] kasan\_save\_alloc\_info+0x38/0x60
[ +0.000007] \_\_kasan\_kmalloc+0xc1/0xd0
[ +0.000007] kmalloc\_trace\_noprof+0x180/0x380
[ +0.000007] drm\_sched\_init+0x411/0xec0 [gpu\_sched]
[ +0.000012] amdgpu\_device\_init+0x695f/0xa610 [amdgpu]
[ +0.000658] amdgpu\_driver\_load\_kms+0x1a/0x120 [amdgpu]
[ +0.000662] amdgpu\_pci\_probe+0x361/0xf30 [amdgpu]
[ +0.000651] local\_pci\_probe+0xe7/0x1b0
[ +0.000009] pci\_device\_probe+0x248/0x890
[ +0.000008] really\_probe+0x1fd/0x950
[ +0.000008] \_\_driver\_probe\_device+0x307/0x410
[ +0.000007] driver\_probe\_device+0x4e/0x150
[ +0.000007] \_\_driver\_attach+0x223/0x510
[ +0.000006] bus\_for\_each\_dev+0x102/0x1a0
[ +0.000007] driver\_attach+0x3d/0x60
[ +0.000006] bus\_add\_driver+0x2ac/0x5f0
[ +0.000006] driver\_register+0x13d/0x490
[ +0.000008] \_\_pci\_register\_driver+0x1ee/0x2b0
[ +0.000007] llc\_sap\_close+0xb0/0x160 [llc]
[ +0.000009] do\_one\_initcall+0x9c/0x3e0
[ +0.000008] do\_init\_module+0x241/0x760
[ +0.000008] load\_module+0x51ac/0x6c30
[ +0.000006] \_\_do\_sys\_init\_module+0x234/0x270
[ +0.000007] \_\_x64\_sys\_init\_module+0x73/0xc0
[ +0.000006] x64\_sys\_call+0xe3/0x2680
[ +0.000006] do\_syscall\_64+0x70/0x130
[ +0.000007] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ +0.000015] Freed by task 2147 on cpu 6 at 160.507651s:
[ +0.000013] kasan\_save\_stack+0x28/0x60
[ +0.000007] kasan\_save\_track+0x18/0x70
[ +0.000007] kasan\_save\_free\_info+0x3b/0x60
[ +0.000007] poison\_slab\_object+0x115/0x1c0
[ +0.000007] \_\_kasan\_slab\_free+0x34/0x60
[ +0.000007] kfree+0xfa/0x2f0
[ +0.000007] drm\_sched\_fini+0x19d/0x410 [gpu\_sched]
[ +0.000012] amdgpu\_fence\_driver\_sw\_fini+0xc4/0x2f0 [amdgpu]
[ +0.000662] amdgpu\_device\_fini\_sw+0x77/0xfc0 [amdgpu]
[ +0.000653] amdgpu\_driver\_release\_kms+0x16/0x80 [amdgpu]
[ +0.000655] drm\_minor\_release+0xc9/0x140 [drm]
[ +0.000071] drm\_release+0x1fd/0x390 [drm]
[ +0.000071] \_\_fput+0x36c/0xad0
[ +0.000008] \_\_fput\_sync+0x3c/0x50
[ +0.000007] \_\_x64\_sys\_close+0x7d/0xe0
[ +0.000007] x64\_sys\_call+0x1bc6/0x2680
[ +0.000007] do\_syscall\_64+0x70/0x130
[ +0.000007] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ +0.000014] The buggy address belongs to the object at ffff8881b8605f80
which belongs to the cache kmalloc-64 of size 64
[ +0.000020] The buggy address is located 8 bytes inside of
freed 64-byte region [ffff8881b8605f80, ffff8881b8605fc0)
[ +0.000028] The buggy address belongs to the physical page:
[ +0.000011] page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x1b8605
[ +0.000008] anon flags: 0x17ffffc0000000(node=0|zone=2|lastcpupid=0x1fffff)
[ +0.000007] page\_type: 0xffffefff(slab)
[ +0.000009] raw: 0017ffffc0000000 ffff8881000428c0 0000000000000000 dead000000000001
[ +0.000006] raw: 0000000000000000 0000000000200020 00000001ffffefff 0000000000000000
[ +0.000006] page dumped because: kasan: bad access detected
[ +0.000012] Memory state around the buggy address:
[ +0.000011] ffff8881b8605e80: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ +0.000015] ffff8881b8605f00: 00 00 00 00 00 00 00 00 fc fc fc fc fc fc fc fc
[ +0.000015] >ffff8881b8605f80: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ +0.000013] ^
[ +0.000011] ffff8881b8606000: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fc
[ +0.000014] ffff8881b8606080: fc fc fc fc fc fc fc fa fb fb fb fb fb fb fb fb
[ +0.000013] ==================================================================
The issue reproduced on VG20 during the IGT pci\_unplug test.
The root cause of the issue is that the function drm\_sched\_fini is called before drm\_sched\_entity\_kill.
In drm\_sched\_fini, the drm\_sched\_rq structure is freed, but this structure is later accessed by
each entity within the run queue, leading to invalid memory access.
To resolve this, the order of cleanup calls is updated:
Before:
amdgpu\_fence\_driver\_sw\_fini
amdgpu\_device\_ip\_fini
After:
amdgpu\_device\_ip\_fini
amdgpu\_fence\_driver\_sw\_fini
This updated order ensures that all entities in the IPs are cleaned up first, followed by proper
cleanup of the schedulers.
Additional Investigation:
During debugging, another issue was identified in the amdgpu\_vce\_sw\_fini function. The vce.vcpu\_bo
buffer must be freed only as the final step in the cleanup process to prevent any premature
access during earlier cleanup stages.
v2: Using Christian suggestion call drm\_sched\_entity\_destroy before drm\_sched\_fini.
Cc: Christian König <christian.koenig@amd.com>
Cc: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Vitaly Prosyak <vitaly.prosyak@amd.com>
Reviewed-by: Christian König <christian.koenig@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b61badd20b443eabe132314669bb51a263982e5c)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=b61badd20b443eabe132314669bb51a263982e5c) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c?id=b61badd20b443eabe132314669bb51a263982e5c) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_device.cindex 714d2e586eacc7..9095c05e0269f9 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=928cd772e18ffbd7723cb2361db4a8ccf2222235)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=b61badd20b443eabe132314669bb51a263982e5c)@@ -4677,8 +4677,8 @@ void amdgpu\_device\_fini\_sw(struct amdgpu\_device \*adev) int idx; bool px; - amdgpu\_fence\_driver\_sw\_fini(adev); amdgpu\_device\_ip\_fini(adev);+ amdgpu\_fence\_driver\_sw\_fini(adev); amdgpu\_ucode\_release(&adev->firmware.gpu\_info\_fw); adev->accel\_working = false; dma\_fence\_put(rcu\_dereference\_protected(adev->gang\_submit, true));diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.cindex 74fdbf71d95b74..599d3ca4e0ef9e 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c?id=928cd772e18ffbd7723cb2361db4a8ccf2222235)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c?id=b61badd20b443eabe132314669bb51a263982e5c)@@ -214,15 +214,15 @@ int amdgpu\_vce\_sw\_fini(struct amdgpu\_device \*adev)  drm\_sched\_entity\_destroy(&adev->vce.entity); - amdgpu\_bo\_free\_kernel(&adev->vce.vcpu\_bo, &adev->vce.gpu\_addr,- (void \*\*)&adev->vce.cpu\_addr);- for (i = 0; i < adev->vce.num\_rings; i++) amdgpu\_ring\_fini(&adev->vce.ring[i]);  amdgpu\_ucode\_release(&adev->vce.fw); mutex\_destroy(&adev->vce.idle\_mutex); + amdgpu\_bo\_free\_kernel(&adev->vce.vcpu\_bo, &adev->vce.gpu\_addr,+ (void \*\*)&adev->vce.cpu\_addr);+ return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:43:47 +0000



=== Content from git.kernel.org_4ed2606a_20250114_224507.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3990ef742c064e22189b954522930db04fc6b1a7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3990ef742c064e22189b954522930db04fc6b1a7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3990ef742c064e22189b954522930db04fc6b1a7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3990ef742c064e22189b954522930db04fc6b1a7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Prosyak <vitaly.prosyak@amd.com> | 2024-11-11 17:24:08 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:33:11 +0100 |
| commit | [3990ef742c064e22189b954522930db04fc6b1a7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3990ef742c064e22189b954522930db04fc6b1a7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3990ef742c064e22189b954522930db04fc6b1a7)) | |
| tree | [a0392803d085069325f5eb3378435cf275dfc39e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3990ef742c064e22189b954522930db04fc6b1a7) | |
| parent | [70e6599a9e78384d22c3feb95da46514e5e5ee41](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70e6599a9e78384d22c3feb95da46514e5e5ee41) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3990ef742c064e22189b954522930db04fc6b1a7&id2=70e6599a9e78384d22c3feb95da46514e5e5ee41)) | |
| download | [linux-3990ef742c064e22189b954522930db04fc6b1a7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3990ef742c064e22189b954522930db04fc6b1a7.tar.gz) | |

drm/amdgpu: fix usage slab after freecommit b61badd20b443eabe132314669bb51a263982e5c upstream.
[ +0.000021] BUG: KASAN: slab-use-after-free in drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000027] Read of size 8 at addr ffff8881b8605f88 by task amd\_pci\_unplug/2147
[ +0.000023] CPU: 6 PID: 2147 Comm: amd\_pci\_unplug Not tainted 6.10.0+ #1
[ +0.000016] Hardware name: ASUS System Product Name/ROG STRIX B550-F GAMING (WI-FI), BIOS 1401 12/03/2020
[ +0.000016] Call Trace:
[ +0.000008] <TASK>
[ +0.000009] dump\_stack\_lvl+0x76/0xa0
[ +0.000017] print\_report+0xce/0x5f0
[ +0.000017] ? drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000019] ? srso\_return\_thunk+0x5/0x5f
[ +0.000015] ? kasan\_complete\_mode\_report\_info+0x72/0x200
[ +0.000016] ? drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000019] kasan\_report+0xbe/0x110
[ +0.000015] ? drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000023] \_\_asan\_report\_load8\_noabort+0x14/0x30
[ +0.000014] drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000020] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? \_\_kasan\_check\_write+0x14/0x30
[ +0.000016] ? \_\_pfx\_drm\_sched\_entity\_flush+0x10/0x10 [gpu\_sched]
[ +0.000020] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? \_\_kasan\_check\_write+0x14/0x30
[ +0.000013] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? enable\_work+0x124/0x220
[ +0.000015] ? \_\_pfx\_enable\_work+0x10/0x10
[ +0.000013] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? free\_large\_kmalloc+0x85/0xf0
[ +0.000016] drm\_sched\_entity\_destroy+0x18/0x30 [gpu\_sched]
[ +0.000020] amdgpu\_vce\_sw\_fini+0x55/0x170 [amdgpu]
[ +0.000735] ? \_\_kasan\_check\_read+0x11/0x20
[ +0.000016] vce\_v4\_0\_sw\_fini+0x80/0x110 [amdgpu]
[ +0.000726] amdgpu\_device\_fini\_sw+0x331/0xfc0 [amdgpu]
[ +0.000679] ? mutex\_unlock+0x80/0xe0
[ +0.000017] ? \_\_pfx\_amdgpu\_device\_fini\_sw+0x10/0x10 [amdgpu]
[ +0.000662] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? \_\_kasan\_check\_write+0x14/0x30
[ +0.000013] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? mutex\_unlock+0x80/0xe0
[ +0.000016] amdgpu\_driver\_release\_kms+0x16/0x80 [amdgpu]
[ +0.000663] drm\_minor\_release+0xc9/0x140 [drm]
[ +0.000081] drm\_release+0x1fd/0x390 [drm]
[ +0.000082] \_\_fput+0x36c/0xad0
[ +0.000018] \_\_fput\_sync+0x3c/0x50
[ +0.000014] \_\_x64\_sys\_close+0x7d/0xe0
[ +0.000014] x64\_sys\_call+0x1bc6/0x2680
[ +0.000014] do\_syscall\_64+0x70/0x130
[ +0.000014] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? irqentry\_exit\_to\_user\_mode+0x60/0x190
[ +0.000015] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? irqentry\_exit+0x43/0x50
[ +0.000012] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? exc\_page\_fault+0x7c/0x110
[ +0.000015] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ +0.000014] RIP: 0033:0x7ffff7b14f67
[ +0.000013] Code: ff e8 0d 16 02 00 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 b8 03 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 41 c3 48 83 ec 18 89 7c 24 0c e8 73 ba f7 ff
[ +0.000026] RSP: 002b:00007fffffffe378 EFLAGS: 00000246 ORIG\_RAX: 0000000000000003
[ +0.000019] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007ffff7b14f67
[ +0.000014] RDX: 0000000000000000 RSI: 00007ffff7f6f47a RDI: 0000000000000003
[ +0.000014] RBP: 00007fffffffe3a0 R08: 0000555555569890 R09: 0000000000000000
[ +0.000014] R10: 0000000000000000 R11: 0000000000000246 R12: 00007fffffffe5c8
[ +0.000013] R13: 00005555555552a9 R14: 0000555555557d48 R15: 00007ffff7ffd040
[ +0.000020] </TASK>
[ +0.000016] Allocated by task 383 on cpu 7 at 26.880319s:
[ +0.000014] kasan\_save\_stack+0x28/0x60
[ +0.000008] kasan\_save\_track+0x18/0x70
[ +0.000007] kasan\_save\_alloc\_info+0x38/0x60
[ +0.000007] \_\_kasan\_kmalloc+0xc1/0xd0
[ +0.000007] kmalloc\_trace\_noprof+0x180/0x380
[ +0.000007] drm\_sched\_init+0x411/0xec0 [gpu\_sched]
[ +0.000012] amdgpu\_device\_init+0x695f/0xa610 [amdgpu]
[ +0.000658] amdgpu\_driver\_load\_kms+0x1a/0x120 [amdgpu]
[ +0.000662] amdgpu\_pci\_probe+0x361/0xf30 [amdgpu]
[ +0.000651] local\_pci\_probe+0xe7/0x1b0
[ +0.000009] pci\_device\_probe+0x248/0x890
[ +0.000008] really\_probe+0x1fd/0x950
[ +0.000008] \_\_driver\_probe\_device+0x307/0x410
[ +0.000007] driver\_probe\_device+0x4e/0x150
[ +0.000007] \_\_driver\_attach+0x223/0x510
[ +0.000006] bus\_for\_each\_dev+0x102/0x1a0
[ +0.000007] driver\_attach+0x3d/0x60
[ +0.000006] bus\_add\_driver+0x2ac/0x5f0
[ +0.000006] driver\_register+0x13d/0x490
[ +0.000008] \_\_pci\_register\_driver+0x1ee/0x2b0
[ +0.000007] llc\_sap\_close+0xb0/0x160 [llc]
[ +0.000009] do\_one\_initcall+0x9c/0x3e0
[ +0.000008] do\_init\_module+0x241/0x760
[ +0.000008] load\_module+0x51ac/0x6c30
[ +0.000006] \_\_do\_sys\_init\_module+0x234/0x270
[ +0.000007] \_\_x64\_sys\_init\_module+0x73/0xc0
[ +0.000006] x64\_sys\_call+0xe3/0x2680
[ +0.000006] do\_syscall\_64+0x70/0x130
[ +0.000007] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ +0.000015] Freed by task 2147 on cpu 6 at 160.507651s:
[ +0.000013] kasan\_save\_stack+0x28/0x60
[ +0.000007] kasan\_save\_track+0x18/0x70
[ +0.000007] kasan\_save\_free\_info+0x3b/0x60
[ +0.000007] poison\_slab\_object+0x115/0x1c0
[ +0.000007] \_\_kasan\_slab\_free+0x34/0x60
[ +0.000007] kfree+0xfa/0x2f0
[ +0.000007] drm\_sched\_fini+0x19d/0x410 [gpu\_sched]
[ +0.000012] amdgpu\_fence\_driver\_sw\_fini+0xc4/0x2f0 [amdgpu]
[ +0.000662] amdgpu\_device\_fini\_sw+0x77/0xfc0 [amdgpu]
[ +0.000653] amdgpu\_driver\_release\_kms+0x16/0x80 [amdgpu]
[ +0.000655] drm\_minor\_release+0xc9/0x140 [drm]
[ +0.000071] drm\_release+0x1fd/0x390 [drm]
[ +0.000071] \_\_fput+0x36c/0xad0
[ +0.000008] \_\_fput\_sync+0x3c/0x50
[ +0.000007] \_\_x64\_sys\_close+0x7d/0xe0
[ +0.000007] x64\_sys\_call+0x1bc6/0x2680
[ +0.000007] do\_syscall\_64+0x70/0x130
[ +0.000007] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ +0.000014] The buggy address belongs to the object at ffff8881b8605f80
which belongs to the cache kmalloc-64 of size 64
[ +0.000020] The buggy address is located 8 bytes inside of
freed 64-byte region [ffff8881b8605f80, ffff8881b8605fc0)
[ +0.000028] The buggy address belongs to the physical page:
[ +0.000011] page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x1b8605
[ +0.000008] anon flags: 0x17ffffc0000000(node=0|zone=2|lastcpupid=0x1fffff)
[ +0.000007] page\_type: 0xffffefff(slab)
[ +0.000009] raw: 0017ffffc0000000 ffff8881000428c0 0000000000000000 dead000000000001
[ +0.000006] raw: 0000000000000000 0000000000200020 00000001ffffefff 0000000000000000
[ +0.000006] page dumped because: kasan: bad access detected
[ +0.000012] Memory state around the buggy address:
[ +0.000011] ffff8881b8605e80: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ +0.000015] ffff8881b8605f00: 00 00 00 00 00 00 00 00 fc fc fc fc fc fc fc fc
[ +0.000015] >ffff8881b8605f80: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ +0.000013] ^
[ +0.000011] ffff8881b8606000: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fc
[ +0.000014] ffff8881b8606080: fc fc fc fc fc fc fc fa fb fb fb fb fb fb fb fb
[ +0.000013] ==================================================================
The issue reproduced on VG20 during the IGT pci\_unplug test.
The root cause of the issue is that the function drm\_sched\_fini is called before drm\_sched\_entity\_kill.
In drm\_sched\_fini, the drm\_sched\_rq structure is freed, but this structure is later accessed by
each entity within the run queue, leading to invalid memory access.
To resolve this, the order of cleanup calls is updated:
Before:
amdgpu\_fence\_driver\_sw\_fini
amdgpu\_device\_ip\_fini
After:
amdgpu\_device\_ip\_fini
amdgpu\_fence\_driver\_sw\_fini
This updated order ensures that all entities in the IPs are cleaned up first, followed by proper
cleanup of the schedulers.
Additional Investigation:
During debugging, another issue was identified in the amdgpu\_vce\_sw\_fini function. The vce.vcpu\_bo
buffer must be freed only as the final step in the cleanup process to prevent any premature
access during earlier cleanup stages.
v2: Using Christian suggestion call drm\_sched\_entity\_destroy before drm\_sched\_fini.
Cc: Christian König <christian.koenig@amd.com>
Cc: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Vitaly Prosyak <vitaly.prosyak@amd.com>
Reviewed-by: Christian König <christian.koenig@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3990ef742c064e22189b954522930db04fc6b1a7)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=3990ef742c064e22189b954522930db04fc6b1a7) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c?id=3990ef742c064e22189b954522930db04fc6b1a7) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_device.cindex 9c99d69b4b083e..cd2d99e00b5d9d 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=70e6599a9e78384d22c3feb95da46514e5e5ee41)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=3990ef742c064e22189b954522930db04fc6b1a7)@@ -4020,8 +4020,8 @@ void amdgpu\_device\_fini\_sw(struct amdgpu\_device \*adev) int idx; bool px; - amdgpu\_fence\_driver\_sw\_fini(adev); amdgpu\_device\_ip\_fini(adev);+ amdgpu\_fence\_driver\_sw\_fini(adev); amdgpu\_ucode\_release(&adev->firmware.gpu\_info\_fw); adev->accel\_working = false; dma\_fence\_put(rcu\_dereference\_protected(adev->gang\_submit, true));diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.cindex 88a3aa36b41d77..8e91355ad42cc5 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c?id=70e6599a9e78384d22c3feb95da46514e5e5ee41)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c?id=3990ef742c064e22189b954522930db04fc6b1a7)@@ -214,15 +214,15 @@ int amdgpu\_vce\_sw\_fini(struct amdgpu\_device \*adev)  drm\_sched\_entity\_destroy(&adev->vce.entity); - amdgpu\_bo\_free\_kernel(&adev->vce.vcpu\_bo, &adev->vce.gpu\_addr,- (void \*\*)&adev->vce.cpu\_addr);- for (i = 0; i < adev->vce.num\_rings; i++) amdgpu\_ring\_fini(&adev->vce.ring[i]);  amdgpu\_ucode\_release(&adev->vce.fw); mutex\_destroy(&adev->vce.idle\_mutex); + amdgpu\_bo\_free\_kernel(&adev->vce.vcpu\_bo, &adev->vce.gpu\_addr,+ (void \*\*)&adev->vce.cpu\_addr);+ return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:43:44 +0000



=== Content from git.kernel.org_acc3a44a_20250114_224509.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6383199ada42d30562b4249c393592a2a9c38165)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6383199ada42d30562b4249c393592a2a9c38165)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6383199ada42d30562b4249c393592a2a9c38165)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6383199ada42d30562b4249c393592a2a9c38165)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Prosyak <vitaly.prosyak@amd.com> | 2024-11-11 17:24:08 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:41:15 +0100 |
| commit | [6383199ada42d30562b4249c393592a2a9c38165](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6383199ada42d30562b4249c393592a2a9c38165) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6383199ada42d30562b4249c393592a2a9c38165)) | |
| tree | [8ce7064651542ed4b869e423cb247a135853c1f5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6383199ada42d30562b4249c393592a2a9c38165) | |
| parent | [be51376b1f500f455d7403590b5e617f2f1444cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be51376b1f500f455d7403590b5e617f2f1444cd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6383199ada42d30562b4249c393592a2a9c38165&id2=be51376b1f500f455d7403590b5e617f2f1444cd)) | |
| download | [linux-6383199ada42d30562b4249c393592a2a9c38165.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6383199ada42d30562b4249c393592a2a9c38165.tar.gz) | |

drm/amdgpu: fix usage slab after freecommit b61badd20b443eabe132314669bb51a263982e5c upstream.
[ +0.000021] BUG: KASAN: slab-use-after-free in drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000027] Read of size 8 at addr ffff8881b8605f88 by task amd\_pci\_unplug/2147
[ +0.000023] CPU: 6 PID: 2147 Comm: amd\_pci\_unplug Not tainted 6.10.0+ #1
[ +0.000016] Hardware name: ASUS System Product Name/ROG STRIX B550-F GAMING (WI-FI), BIOS 1401 12/03/2020
[ +0.000016] Call Trace:
[ +0.000008] <TASK>
[ +0.000009] dump\_stack\_lvl+0x76/0xa0
[ +0.000017] print\_report+0xce/0x5f0
[ +0.000017] ? drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000019] ? srso\_return\_thunk+0x5/0x5f
[ +0.000015] ? kasan\_complete\_mode\_report\_info+0x72/0x200
[ +0.000016] ? drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000019] kasan\_report+0xbe/0x110
[ +0.000015] ? drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000023] \_\_asan\_report\_load8\_noabort+0x14/0x30
[ +0.000014] drm\_sched\_entity\_flush+0x6cb/0x7a0 [gpu\_sched]
[ +0.000020] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? \_\_kasan\_check\_write+0x14/0x30
[ +0.000016] ? \_\_pfx\_drm\_sched\_entity\_flush+0x10/0x10 [gpu\_sched]
[ +0.000020] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? \_\_kasan\_check\_write+0x14/0x30
[ +0.000013] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? enable\_work+0x124/0x220
[ +0.000015] ? \_\_pfx\_enable\_work+0x10/0x10
[ +0.000013] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? free\_large\_kmalloc+0x85/0xf0
[ +0.000016] drm\_sched\_entity\_destroy+0x18/0x30 [gpu\_sched]
[ +0.000020] amdgpu\_vce\_sw\_fini+0x55/0x170 [amdgpu]
[ +0.000735] ? \_\_kasan\_check\_read+0x11/0x20
[ +0.000016] vce\_v4\_0\_sw\_fini+0x80/0x110 [amdgpu]
[ +0.000726] amdgpu\_device\_fini\_sw+0x331/0xfc0 [amdgpu]
[ +0.000679] ? mutex\_unlock+0x80/0xe0
[ +0.000017] ? \_\_pfx\_amdgpu\_device\_fini\_sw+0x10/0x10 [amdgpu]
[ +0.000662] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? \_\_kasan\_check\_write+0x14/0x30
[ +0.000013] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? mutex\_unlock+0x80/0xe0
[ +0.000016] amdgpu\_driver\_release\_kms+0x16/0x80 [amdgpu]
[ +0.000663] drm\_minor\_release+0xc9/0x140 [drm]
[ +0.000081] drm\_release+0x1fd/0x390 [drm]
[ +0.000082] \_\_fput+0x36c/0xad0
[ +0.000018] \_\_fput\_sync+0x3c/0x50
[ +0.000014] \_\_x64\_sys\_close+0x7d/0xe0
[ +0.000014] x64\_sys\_call+0x1bc6/0x2680
[ +0.000014] do\_syscall\_64+0x70/0x130
[ +0.000014] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? irqentry\_exit\_to\_user\_mode+0x60/0x190
[ +0.000015] ? srso\_return\_thunk+0x5/0x5f
[ +0.000014] ? irqentry\_exit+0x43/0x50
[ +0.000012] ? srso\_return\_thunk+0x5/0x5f
[ +0.000013] ? exc\_page\_fault+0x7c/0x110
[ +0.000015] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ +0.000014] RIP: 0033:0x7ffff7b14f67
[ +0.000013] Code: ff e8 0d 16 02 00 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 b8 03 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 41 c3 48 83 ec 18 89 7c 24 0c e8 73 ba f7 ff
[ +0.000026] RSP: 002b:00007fffffffe378 EFLAGS: 00000246 ORIG\_RAX: 0000000000000003
[ +0.000019] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007ffff7b14f67
[ +0.000014] RDX: 0000000000000000 RSI: 00007ffff7f6f47a RDI: 0000000000000003
[ +0.000014] RBP: 00007fffffffe3a0 R08: 0000555555569890 R09: 0000000000000000
[ +0.000014] R10: 0000000000000000 R11: 0000000000000246 R12: 00007fffffffe5c8
[ +0.000013] R13: 00005555555552a9 R14: 0000555555557d48 R15: 00007ffff7ffd040
[ +0.000020] </TASK>
[ +0.000016] Allocated by task 383 on cpu 7 at 26.880319s:
[ +0.000014] kasan\_save\_stack+0x28/0x60
[ +0.000008] kasan\_save\_track+0x18/0x70
[ +0.000007] kasan\_save\_alloc\_info+0x38/0x60
[ +0.000007] \_\_kasan\_kmalloc+0xc1/0xd0
[ +0.000007] kmalloc\_trace\_noprof+0x180/0x380
[ +0.000007] drm\_sched\_init+0x411/0xec0 [gpu\_sched]
[ +0.000012] amdgpu\_device\_init+0x695f/0xa610 [amdgpu]
[ +0.000658] amdgpu\_driver\_load\_kms+0x1a/0x120 [amdgpu]
[ +0.000662] amdgpu\_pci\_probe+0x361/0xf30 [amdgpu]
[ +0.000651] local\_pci\_probe+0xe7/0x1b0
[ +0.000009] pci\_device\_probe+0x248/0x890
[ +0.000008] really\_probe+0x1fd/0x950
[ +0.000008] \_\_driver\_probe\_device+0x307/0x410
[ +0.000007] driver\_probe\_device+0x4e/0x150
[ +0.000007] \_\_driver\_attach+0x223/0x510
[ +0.000006] bus\_for\_each\_dev+0x102/0x1a0
[ +0.000007] driver\_attach+0x3d/0x60
[ +0.000006] bus\_add\_driver+0x2ac/0x5f0
[ +0.000006] driver\_register+0x13d/0x490
[ +0.000008] \_\_pci\_register\_driver+0x1ee/0x2b0
[ +0.000007] llc\_sap\_close+0xb0/0x160 [llc]
[ +0.000009] do\_one\_initcall+0x9c/0x3e0
[ +0.000008] do\_init\_module+0x241/0x760
[ +0.000008] load\_module+0x51ac/0x6c30
[ +0.000006] \_\_do\_sys\_init\_module+0x234/0x270
[ +0.000007] \_\_x64\_sys\_init\_module+0x73/0xc0
[ +0.000006] x64\_sys\_call+0xe3/0x2680
[ +0.000006] do\_syscall\_64+0x70/0x130
[ +0.000007] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ +0.000015] Freed by task 2147 on cpu 6 at 160.507651s:
[ +0.000013] kasan\_save\_stack+0x28/0x60
[ +0.000007] kasan\_save\_track+0x18/0x70
[ +0.000007] kasan\_save\_free\_info+0x3b/0x60
[ +0.000007] poison\_slab\_object+0x115/0x1c0
[ +0.000007] \_\_kasan\_slab\_free+0x34/0x60
[ +0.000007] kfree+0xfa/0x2f0
[ +0.000007] drm\_sched\_fini+0x19d/0x410 [gpu\_sched]
[ +0.000012] amdgpu\_fence\_driver\_sw\_fini+0xc4/0x2f0 [amdgpu]
[ +0.000662] amdgpu\_device\_fini\_sw+0x77/0xfc0 [amdgpu]
[ +0.000653] amdgpu\_driver\_release\_kms+0x16/0x80 [amdgpu]
[ +0.000655] drm\_minor\_release+0xc9/0x140 [drm]
[ +0.000071] drm\_release+0x1fd/0x390 [drm]
[ +0.000071] \_\_fput+0x36c/0xad0
[ +0.000008] \_\_fput\_sync+0x3c/0x50
[ +0.000007] \_\_x64\_sys\_close+0x7d/0xe0
[ +0.000007] x64\_sys\_call+0x1bc6/0x2680
[ +0.000007] do\_syscall\_64+0x70/0x130
[ +0.000007] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ +0.000014] The buggy address belongs to the object at ffff8881b8605f80
which belongs to the cache kmalloc-64 of size 64
[ +0.000020] The buggy address is located 8 bytes inside of
freed 64-byte region [ffff8881b8605f80, ffff8881b8605fc0)
[ +0.000028] The buggy address belongs to the physical page:
[ +0.000011] page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x1b8605
[ +0.000008] anon flags: 0x17ffffc0000000(node=0|zone=2|lastcpupid=0x1fffff)
[ +0.000007] page\_type: 0xffffefff(slab)
[ +0.000009] raw: 0017ffffc0000000 ffff8881000428c0 0000000000000000 dead000000000001
[ +0.000006] raw: 0000000000000000 0000000000200020 00000001ffffefff 0000000000000000
[ +0.000006] page dumped because: kasan: bad access detected
[ +0.000012] Memory state around the buggy address:
[ +0.000011] ffff8881b8605e80: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ +0.000015] ffff8881b8605f00: 00 00 00 00 00 00 00 00 fc fc fc fc fc fc fc fc
[ +0.000015] >ffff8881b8605f80: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ +0.000013] ^
[ +0.000011] ffff8881b8606000: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fc
[ +0.000014] ffff8881b8606080: fc fc fc fc fc fc fc fa fb fb fb fb fb fb fb fb
[ +0.000013] ==================================================================
The issue reproduced on VG20 during the IGT pci\_unplug test.
The root cause of the issue is that the function drm\_sched\_fini is called before drm\_sched\_entity\_kill.
In drm\_sched\_fini, the drm\_sched\_rq structure is freed, but this structure is later accessed by
each entity within the run queue, leading to invalid memory access.
To resolve this, the order of cleanup calls is updated:
Before:
amdgpu\_fence\_driver\_sw\_fini
amdgpu\_device\_ip\_fini
After:
amdgpu\_device\_ip\_fini
amdgpu\_fence\_driver\_sw\_fini
This updated order ensures that all entities in the IPs are cleaned up first, followed by proper
cleanup of the schedulers.
Additional Investigation:
During debugging, another issue was identified in the amdgpu\_vce\_sw\_fini function. The vce.vcpu\_bo
buffer must be freed only as the final step in the cleanup process to prevent any premature
access during earlier cleanup stages.
v2: Using Christian suggestion call drm\_sched\_entity\_destroy before drm\_sched\_fini.
Cc: Christian König <christian.koenig@amd.com>
Cc: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Vitaly Prosyak <vitaly.prosyak@amd.com>
Reviewed-by: Christian König <christian.koenig@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6383199ada42d30562b4249c393592a2a9c38165)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=6383199ada42d30562b4249c393592a2a9c38165) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c?id=6383199ada42d30562b4249c393592a2a9c38165) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_device.cindex c2394c8b4d6b21..1f08cb88d51be5 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=be51376b1f500f455d7403590b5e617f2f1444cd)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c?id=6383199ada42d30562b4249c393592a2a9c38165)@@ -4584,8 +4584,8 @@ void amdgpu\_device\_fini\_sw(struct amdgpu\_device \*adev) int idx; bool px; - amdgpu\_fence\_driver\_sw\_fini(adev); amdgpu\_device\_ip\_fini(adev);+ amdgpu\_fence\_driver\_sw\_fini(adev); amdgpu\_ucode\_release(&adev->firmware.gpu\_info\_fw); adev->accel\_working = false; dma\_fence\_put(rcu\_dereference\_protected(adev->gang\_submit, true));diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.cindex 74fdbf71d95b74..599d3ca4e0ef9e 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c?id=be51376b1f500f455d7403590b5e617f2f1444cd)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vce.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c?id=6383199ada42d30562b4249c393592a2a9c38165)@@ -214,15 +214,15 @@ int amdgpu\_vce\_sw\_fini(struct amdgpu\_device \*adev)  drm\_sched\_entity\_destroy(&adev->vce.entity); - amdgpu\_bo\_free\_kernel(&adev->vce.vcpu\_bo, &adev->vce.gpu\_addr,- (void \*\*)&adev->vce.cpu\_addr);- for (i = 0; i < adev->vce.num\_rings; i++) amdgpu\_ring\_fini(&adev->vce.ring[i]);  amdgpu\_ucode\_release(&adev->vce.fw); mutex\_destroy(&adev->vce.idle\_mutex); + amdgpu\_bo\_free\_kernel(&adev->vce.vcpu\_bo, &adev->vce.gpu\_addr,+ (void \*\*)&adev->vce.cpu\_addr);+ return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:43:46 +0000


