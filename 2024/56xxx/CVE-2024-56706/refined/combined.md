=== Content from git.kernel.org_aaa7b682_20250114_195216.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thomas Richter <tmricht@linux.ibm.com> | 2024-10-30 12:37:18 +0100 |
| --- | --- | --- |
| committer | Heiko Carstens <hca@linux.ibm.com> | 2024-10-31 10:50:06 +0100 |
| commit | [f55bd479d8663a4a4e403b3d308d3d1aa33d92df](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df)) | |
| tree | [20cf59076aefe8453f06d0e846c2d6af7b92085c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df) | |
| parent | [a5600f05d3d7a80be23a8905fdc128abd586c786](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a5600f05d3d7a80be23a8905fdc128abd586c786) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df&id2=a5600f05d3d7a80be23a8905fdc128abd586c786)) | |
| download | [linux-f55bd479d8663a4a4e403b3d308d3d1aa33d92df.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f55bd479d8663a4a4e403b3d308d3d1aa33d92df.tar.gz) | |

s390/cpum\_sf: Fix and protect memory allocation of SDBs with mutexReservation of the PMU hardware is done at first event creation
and is protected by a pair of mutex\_lock() and mutex\_unlock().
After reservation of the PMU hardware the memory
required for the PMUs the event is to be installed on is
allocated by allocate\_buffers() and alloc\_sampling\_buffer().
This done outside of the mutex protection.
Without mutex protection two or more concurrent invocations of
perf\_event\_init() may run in parallel.
This can lead to allocation of Sample Data Blocks (SDBs)
multiple times for the same PMU.
Prevent this and protect memory allocation of SDBs by
mutex.
Fixes: 8a6fe8f21ec4 ("s390/cpum\_sf: Use refcount\_t instead of atomic\_t")
Signed-off-by: Thomas Richter <tmricht@linux.ibm.com>
Reviewed-by: Sumanth Korikkar <sumanthk@linux.ibm.com>
Reviewed-by: Hendrik Brueckner <brueckner@linux.ibm.com>
Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df)

| -rw-r--r-- | [arch/s390/kernel/perf\_cpum\_sf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/kernel/perf_cpum_sf.c?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/s390/kernel/perf\_cpum\_sf.c b/arch/s390/kernel/perf\_cpum\_sf.cindex 2c1d4188e9874a..72c73cfa648f1a 100644--- a/[arch/s390/kernel/perf\_cpum\_sf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/kernel/perf_cpum_sf.c?id=a5600f05d3d7a80be23a8905fdc128abd586c786)+++ b/[arch/s390/kernel/perf\_cpum\_sf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/kernel/perf_cpum_sf.c?id=f55bd479d8663a4a4e403b3d308d3d1aa33d92df)@@ -758,7 +758,6 @@ static int \_\_hw\_perf\_event\_init(struct perf\_event \*event) reserve\_pmc\_hardware(); refcount\_set(&num\_events, 1); }- mutex\_unlock(&pmc\_reserve\_mutex); event->destroy = hw\_perf\_event\_destroy;  /\* Access per-CPU sampling information (query sampling info) \*/@@ -847,6 +846,7 @@ static int \_\_hw\_perf\_event\_init(struct perf\_event \*event) if (is\_default\_overflow\_handler(event)) event->overflow\_handler = cpumsf\_output\_event\_pid; out:+ mutex\_unlock(&pmc\_reserve\_mutex); return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:50:53 +0000



=== Content from git.kernel.org_8406017d_20250114_195215.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4b3bdfa89635db6a53e02955548bd07bebcae233)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b3bdfa89635db6a53e02955548bd07bebcae233)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b3bdfa89635db6a53e02955548bd07bebcae233)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b3bdfa89635db6a53e02955548bd07bebcae233)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thomas Richter <tmricht@linux.ibm.com> | 2024-10-30 12:37:18 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:12 +0100 |
| commit | [4b3bdfa89635db6a53e02955548bd07bebcae233](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b3bdfa89635db6a53e02955548bd07bebcae233) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4b3bdfa89635db6a53e02955548bd07bebcae233)) | |
| tree | [560fb318f99903b85229074e6b3cae815fa1daaa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b3bdfa89635db6a53e02955548bd07bebcae233) | |
| parent | [2a375beb4c3824bb984e65860ad7ec0197be91f7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a375beb4c3824bb984e65860ad7ec0197be91f7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b3bdfa89635db6a53e02955548bd07bebcae233&id2=2a375beb4c3824bb984e65860ad7ec0197be91f7)) | |
| download | [linux-4b3bdfa89635db6a53e02955548bd07bebcae233.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4b3bdfa89635db6a53e02955548bd07bebcae233.tar.gz) | |

s390/cpum\_sf: Fix and protect memory allocation of SDBs with mutex[ Upstream commit f55bd479d8663a4a4e403b3d308d3d1aa33d92df ]
Reservation of the PMU hardware is done at first event creation
and is protected by a pair of mutex\_lock() and mutex\_unlock().
After reservation of the PMU hardware the memory
required for the PMUs the event is to be installed on is
allocated by allocate\_buffers() and alloc\_sampling\_buffer().
This done outside of the mutex protection.
Without mutex protection two or more concurrent invocations of
perf\_event\_init() may run in parallel.
This can lead to allocation of Sample Data Blocks (SDBs)
multiple times for the same PMU.
Prevent this and protect memory allocation of SDBs by
mutex.
Fixes: 8a6fe8f21ec4 ("s390/cpum\_sf: Use refcount\_t instead of atomic\_t")
Signed-off-by: Thomas Richter <tmricht@linux.ibm.com>
Reviewed-by: Sumanth Korikkar <sumanthk@linux.ibm.com>
Reviewed-by: Hendrik Brueckner <brueckner@linux.ibm.com>
Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b3bdfa89635db6a53e02955548bd07bebcae233)

| -rw-r--r-- | [arch/s390/kernel/perf\_cpum\_sf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/kernel/perf_cpum_sf.c?id=4b3bdfa89635db6a53e02955548bd07bebcae233) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/s390/kernel/perf\_cpum\_sf.c b/arch/s390/kernel/perf\_cpum\_sf.cindex 5b765e3ccf0cad..3317f4878eaa70 100644--- a/[arch/s390/kernel/perf\_cpum\_sf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/kernel/perf_cpum_sf.c?id=2a375beb4c3824bb984e65860ad7ec0197be91f7)+++ b/[arch/s390/kernel/perf\_cpum\_sf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/kernel/perf_cpum_sf.c?id=4b3bdfa89635db6a53e02955548bd07bebcae233)@@ -759,7 +759,6 @@ static int \_\_hw\_perf\_event\_init(struct perf\_event \*event) reserve\_pmc\_hardware(); refcount\_set(&num\_events, 1); }- mutex\_unlock(&pmc\_reserve\_mutex); event->destroy = hw\_perf\_event\_destroy;  /\* Access per-CPU sampling information (query sampling info) \*/@@ -848,6 +847,7 @@ static int \_\_hw\_perf\_event\_init(struct perf\_event \*event) if (is\_default\_overflow\_handler(event)) event->overflow\_handler = cpumsf\_output\_event\_pid; out:+ mutex\_unlock(&pmc\_reserve\_mutex); return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:50:52 +0000


