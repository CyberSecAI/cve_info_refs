=== Content from git.kernel.org_0b92f7fe_20250114_214349.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Aurabindo Pillai <aurabindo.pillai@amd.com> | 2024-09-23 20:07:25 +0000 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2024-10-07 14:13:57 -0400 |
| commit | [d4f36e5fd800de7db74c1c4e62baf24a091a5ff6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6)) | |
| tree | [2ab3de81da2184e3c33ed7aa6100dfff36e6caf7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6) | |
| parent | [7671f62c10f2a4c77d89b39fd50fab7f918d6809](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7671f62c10f2a4c77d89b39fd50fab7f918d6809) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6&id2=7671f62c10f2a4c77d89b39fd50fab7f918d6809)) | |
| download | [linux-d4f36e5fd800de7db74c1c4e62baf24a091a5ff6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d4f36e5fd800de7db74c1c4e62baf24a091a5ff6.tar.gz) | |

drm/amd/display: fix a memleak issue when driver is removedRunning "modprobe amdgpu" the second time (followed by a modprobe -r
amdgpu) causes a call trace like:
[ 845.212163] Memory manager not clean during takedown.
[ 845.212170] WARNING: CPU: 4 PID: 2481 at drivers/gpu/drm/drm\_mm.c:999 drm\_mm\_takedown+0x2b/0x40
[ 845.212177] Modules linked in: amdgpu(OE-) amddrm\_ttm\_helper(OE) amddrm\_buddy(OE) amdxcp(OE) amd\_sched(OE) drm\_exec drm\_suballoc\_helper drm\_display\_helper i2c\_algo\_bit amdttm(OE) amdkcl(OE) cec rc\_core sunrpc qrtr intel\_rapl\_msr intel\_rapl\_common snd\_hda\_codec\_hdmi edac\_mce\_amd snd\_hda\_intel snd\_intel\_dspcfg snd\_intel\_sdw\_acpi snd\_usb\_audio snd\_hda\_codec snd\_usbmidi\_lib kvm\_amd snd\_hda\_core snd\_ump mc snd\_hwdep kvm snd\_pcm snd\_seq\_midi snd\_seq\_midi\_event irqbypass crct10dif\_pclmul snd\_rawmidi polyval\_clmulni polyval\_generic ghash\_clmulni\_intel sha256\_ssse3 sha1\_ssse3 snd\_seq aesni\_intel crypto\_simd snd\_seq\_device cryptd snd\_timer mfd\_aaeon asus\_nb\_wmi eeepc\_wmi joydev asus\_wmi snd ledtrig\_audio sparse\_keymap ccp wmi\_bmof input\_leds k10temp i2c\_piix4 platform\_profile rapl soundcore gpio\_amdpt mac\_hid binfmt\_misc msr parport\_pc ppdev lp parport efi\_pstore nfnetlink dmi\_sysfs ip\_tables x\_tables autofs4 hid\_logitech\_hidpp hid\_logitech\_dj hid\_generic usbhid hid ahci xhci\_pci igc crc32\_pclmul libahci xhci\_pci\_renesas video
[ 845.212284] wmi [last unloaded: amddrm\_ttm\_helper(OE)]
[ 845.212290] CPU: 4 PID: 2481 Comm: modprobe Tainted: G W OE 6.8.0-31-generic #31-Ubuntu
[ 845.212296] RIP: 0010:drm\_mm\_takedown+0x2b/0x40
[ 845.212300] Code: 1f 44 00 00 48 8b 47 38 48 83 c7 38 48 39 f8 75 09 31 c0 31 ff e9 90 2e 86 00 55 48 c7 c7 d0 f6 8e 8a 48 89 e5 e8 f5 db 45 ff <0f> 0b 5d 31 c0 31 ff e9 74 2e 86 00 66 0f 1f 84 00 00 00 00 00 90
[ 845.212302] RSP: 0018:ffffb11302127ae0 EFLAGS: 00010246
[ 845.212305] RAX: 0000000000000000 RBX: ffff92aa5020fc08 RCX: 0000000000000000
[ 845.212307] RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
[ 845.212309] RBP: ffffb11302127ae0 R08: 0000000000000000 R09: 0000000000000000
[ 845.212310] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000004
[ 845.212312] R13: ffff92aa50200000 R14: ffff92aa5020fb10 R15: ffff92aa5020faa0
[ 845.212313] FS: 0000707dd7c7c080(0000) GS:ffff92b93de00000(0000) knlGS:0000000000000000
[ 845.212316] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 845.212318] CR2: 00007d48b0aee200 CR3: 0000000115a58000 CR4: 0000000000f50ef0
[ 845.212320] PKRU: 55555554
[ 845.212321] Call Trace:
[ 845.212323] <TASK>
[ 845.212328] ? show\_regs+0x6d/0x80
[ 845.212333] ? \_\_warn+0x89/0x160
[ 845.212339] ? drm\_mm\_takedown+0x2b/0x40
[ 845.212344] ? report\_bug+0x17e/0x1b0
[ 845.212350] ? handle\_bug+0x51/0xa0
[ 845.212355] ? exc\_invalid\_op+0x18/0x80
[ 845.212359] ? asm\_exc\_invalid\_op+0x1b/0x20
[ 845.212366] ? drm\_mm\_takedown+0x2b/0x40
[ 845.212371] amdgpu\_gtt\_mgr\_fini+0xa9/0x130 [amdgpu]
[ 845.212645] amdgpu\_ttm\_fini+0x264/0x340 [amdgpu]
[ 845.212770] amdgpu\_bo\_fini+0x2e/0xc0 [amdgpu]
[ 845.212894] gmc\_v12\_0\_sw\_fini+0x2a/0x40 [amdgpu]
[ 845.213036] amdgpu\_device\_fini\_sw+0x11a/0x590 [amdgpu]
[ 845.213159] amdgpu\_driver\_release\_kms+0x16/0x40 [amdgpu]
[ 845.213302] devm\_drm\_dev\_init\_release+0x5e/0x90
[ 845.213305] devm\_action\_release+0x12/0x30
[ 845.213308] release\_nodes+0x42/0xd0
[ 845.213311] devres\_release\_all+0x97/0xe0
[ 845.213314] device\_unbind\_cleanup+0x12/0x80
[ 845.213317] device\_release\_driver\_internal+0x230/0x270
[ 845.213319] ? srso\_alias\_return\_thunk+0x5/0xfbef5
This is caused by lost memory during early init phase. First time driver
is removed, memory is freed but when second time the driver is inserted,
VBIOS dmub is not active, since the PSP policy is to retain the driver
loaded version on subsequent warm boots. Hence, communication with VBIOS
DMUB fails.
Fix this by aborting further communication with vbios dmub and release
the memory immediately.
Fixes: f59549c7e705 ("drm/amd/display: free bo used for dmub bounding box")
Reviewed-by: Rodrigo Siqueira <rodrigo.siqueira@amd.com>
Signed-off-by: Aurabindo Pillai <aurabindo.pillai@amd.com>
Signed-off-by: Rodrigo Siqueira <rodrigo.siqueira@amd.com>
Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6)

| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.h?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_helpers.c?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6) | 13 | |  |  |  | | --- | --- | --- | |

3 files changed, 33 insertions, 15 deletions

| diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.cindex b615718cac39a5..616f54d1e2ecdb 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=7671f62c10f2a4c77d89b39fd50fab7f918d6809)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6)@@ -1696,6 +1696,26 @@ dm\_allocate\_gpu\_mem( return da->cpu\_ptr; } +void+dm\_free\_gpu\_mem(+ struct amdgpu\_device \*adev,+ enum dc\_gpu\_mem\_alloc\_type type,+ void \*pvMem)+{+ struct dal\_allocation \*da;++ /\* walk the da list in DM \*/+ list\_for\_each\_entry(da, &adev->dm.da\_list, list) {+ if (pvMem == da->cpu\_ptr) {+ amdgpu\_bo\_free\_kernel(&da->bo, &da->gpu\_addr, &da->cpu\_ptr);+ list\_del(&da->list);+ kfree(da);+ break;+ }+ }++}+ static enum dmub\_status dm\_dmub\_send\_vbios\_gpint\_command(struct amdgpu\_device \*adev, enum dmub\_gpint\_command command\_code,@@ -1762,16 +1782,20 @@ static struct dml2\_soc\_bb \*dm\_dmub\_get\_vbios\_bounding\_box(struct amdgpu\_device \* /\* Send the chunk \*/ ret = dm\_dmub\_send\_vbios\_gpint\_command(adev, send\_addrs[i], chunk, 30000); if (ret != DMUB\_STATUS\_OK)- /\* No need to free bb here since it shall be done in dm\_sw\_fini() \*/- return NULL;+ goto free\_bb; }  /\* Now ask DMUB to copy the bb \*/ ret = dm\_dmub\_send\_vbios\_gpint\_command(adev, DMUB\_GPINT\_\_BB\_COPY, 1, 200000); if (ret != DMUB\_STATUS\_OK)- return NULL;+ goto free\_bb;  return bb;++free\_bb:+ dm\_free\_gpu\_mem(adev, DC\_MEM\_ALLOC\_TYPE\_GART, (void \*) bb);+ return NULL;+ }  static enum dmub\_ips\_disable\_type dm\_get\_default\_ips\_mode(@@ -2541,11 +2565,11 @@ static int dm\_sw\_fini(struct amdgpu\_ip\_block \*ip\_block) amdgpu\_bo\_free\_kernel(&da->bo, &da->gpu\_addr, &da->cpu\_ptr); list\_del(&da->list); kfree(da);+ adev->dm.bb\_from\_dmub = NULL; break; } } - adev->dm.bb\_from\_dmub = NULL;  kfree(adev->dm.dmub\_fb\_info); adev->dm.dmub\_fb\_info = NULL;diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.hindex 15d4690c74d60b..f5189b54a5cd6e 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.h?id=7671f62c10f2a4c77d89b39fd50fab7f918d6809)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.h?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6)@@ -1004,6 +1004,9 @@ void \*dm\_allocate\_gpu\_mem(struct amdgpu\_device \*adev, enum dc\_gpu\_mem\_alloc\_type type, size\_t size, long long \*addr);+void dm\_free\_gpu\_mem(struct amdgpu\_device \*adev,+ enum dc\_gpu\_mem\_alloc\_type type,+ void \*addr);  bool amdgpu\_dm\_is\_headless(struct amdgpu\_device \*adev); diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.cindex 069e0195e50a42..3f4b6f140374c3 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_helpers.c?id=7671f62c10f2a4c77d89b39fd50fab7f918d6809)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_helpers.c?id=d4f36e5fd800de7db74c1c4e62baf24a091a5ff6)@@ -1054,17 +1054,8 @@ void dm\_helpers\_free\_gpu\_mem( void \*pvMem) { struct amdgpu\_device \*adev = ctx->driver\_context;- struct dal\_allocation \*da;-- /\* walk the da list in DM \*/- list\_for\_each\_entry(da, &adev->dm.da\_list, list) {- if (pvMem == da->cpu\_ptr) {- amdgpu\_bo\_free\_kernel(&da->bo, &da->gpu\_addr, &da->cpu\_ptr);- list\_del(&da->list);- kfree(da);- break;- }- }++ dm\_free\_gpu\_mem(adev, type, pvMem); }  bool dm\_helpers\_dmub\_outbox\_interrupt\_control(struct dc\_context \*ctx, bool enable) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:42:26 +0000



=== Content from git.kernel.org_450a998e_20250114_214349.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5860c637513036a6ffc130950ea98676b591b47c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5860c637513036a6ffc130950ea98676b591b47c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5860c637513036a6ffc130950ea98676b591b47c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5860c637513036a6ffc130950ea98676b591b47c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Aurabindo Pillai <aurabindo.pillai@amd.com> | 2024-09-23 20:07:25 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:41 +0100 |
| commit | [5860c637513036a6ffc130950ea98676b591b47c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5860c637513036a6ffc130950ea98676b591b47c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5860c637513036a6ffc130950ea98676b591b47c)) | |
| tree | [123a847c1bd467628fb84a9a1229fcaaafb76110](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5860c637513036a6ffc130950ea98676b591b47c) | |
| parent | [13231df707a70aba9398c95998d3f224e7253b07](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13231df707a70aba9398c95998d3f224e7253b07) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5860c637513036a6ffc130950ea98676b591b47c&id2=13231df707a70aba9398c95998d3f224e7253b07)) | |
| download | [linux-5860c637513036a6ffc130950ea98676b591b47c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5860c637513036a6ffc130950ea98676b591b47c.tar.gz) | |

drm/amd/display: fix a memleak issue when driver is removed[ Upstream commit d4f36e5fd800de7db74c1c4e62baf24a091a5ff6 ]
Running "modprobe amdgpu" the second time (followed by a modprobe -r
amdgpu) causes a call trace like:
[ 845.212163] Memory manager not clean during takedown.
[ 845.212170] WARNING: CPU: 4 PID: 2481 at drivers/gpu/drm/drm\_mm.c:999 drm\_mm\_takedown+0x2b/0x40
[ 845.212177] Modules linked in: amdgpu(OE-) amddrm\_ttm\_helper(OE) amddrm\_buddy(OE) amdxcp(OE) amd\_sched(OE) drm\_exec drm\_suballoc\_helper drm\_display\_helper i2c\_algo\_bit amdttm(OE) amdkcl(OE) cec rc\_core sunrpc qrtr intel\_rapl\_msr intel\_rapl\_common snd\_hda\_codec\_hdmi edac\_mce\_amd snd\_hda\_intel snd\_intel\_dspcfg snd\_intel\_sdw\_acpi snd\_usb\_audio snd\_hda\_codec snd\_usbmidi\_lib kvm\_amd snd\_hda\_core snd\_ump mc snd\_hwdep kvm snd\_pcm snd\_seq\_midi snd\_seq\_midi\_event irqbypass crct10dif\_pclmul snd\_rawmidi polyval\_clmulni polyval\_generic ghash\_clmulni\_intel sha256\_ssse3 sha1\_ssse3 snd\_seq aesni\_intel crypto\_simd snd\_seq\_device cryptd snd\_timer mfd\_aaeon asus\_nb\_wmi eeepc\_wmi joydev asus\_wmi snd ledtrig\_audio sparse\_keymap ccp wmi\_bmof input\_leds k10temp i2c\_piix4 platform\_profile rapl soundcore gpio\_amdpt mac\_hid binfmt\_misc msr parport\_pc ppdev lp parport efi\_pstore nfnetlink dmi\_sysfs ip\_tables x\_tables autofs4 hid\_logitech\_hidpp hid\_logitech\_dj hid\_generic usbhid hid ahci xhci\_pci igc crc32\_pclmul libahci xhci\_pci\_renesas video
[ 845.212284] wmi [last unloaded: amddrm\_ttm\_helper(OE)]
[ 845.212290] CPU: 4 PID: 2481 Comm: modprobe Tainted: G W OE 6.8.0-31-generic #31-Ubuntu
[ 845.212296] RIP: 0010:drm\_mm\_takedown+0x2b/0x40
[ 845.212300] Code: 1f 44 00 00 48 8b 47 38 48 83 c7 38 48 39 f8 75 09 31 c0 31 ff e9 90 2e 86 00 55 48 c7 c7 d0 f6 8e 8a 48 89 e5 e8 f5 db 45 ff <0f> 0b 5d 31 c0 31 ff e9 74 2e 86 00 66 0f 1f 84 00 00 00 00 00 90
[ 845.212302] RSP: 0018:ffffb11302127ae0 EFLAGS: 00010246
[ 845.212305] RAX: 0000000000000000 RBX: ffff92aa5020fc08 RCX: 0000000000000000
[ 845.212307] RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
[ 845.212309] RBP: ffffb11302127ae0 R08: 0000000000000000 R09: 0000000000000000
[ 845.212310] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000004
[ 845.212312] R13: ffff92aa50200000 R14: ffff92aa5020fb10 R15: ffff92aa5020faa0
[ 845.212313] FS: 0000707dd7c7c080(0000) GS:ffff92b93de00000(0000) knlGS:0000000000000000
[ 845.212316] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 845.212318] CR2: 00007d48b0aee200 CR3: 0000000115a58000 CR4: 0000000000f50ef0
[ 845.212320] PKRU: 55555554
[ 845.212321] Call Trace:
[ 845.212323] <TASK>
[ 845.212328] ? show\_regs+0x6d/0x80
[ 845.212333] ? \_\_warn+0x89/0x160
[ 845.212339] ? drm\_mm\_takedown+0x2b/0x40
[ 845.212344] ? report\_bug+0x17e/0x1b0
[ 845.212350] ? handle\_bug+0x51/0xa0
[ 845.212355] ? exc\_invalid\_op+0x18/0x80
[ 845.212359] ? asm\_exc\_invalid\_op+0x1b/0x20
[ 845.212366] ? drm\_mm\_takedown+0x2b/0x40
[ 845.212371] amdgpu\_gtt\_mgr\_fini+0xa9/0x130 [amdgpu]
[ 845.212645] amdgpu\_ttm\_fini+0x264/0x340 [amdgpu]
[ 845.212770] amdgpu\_bo\_fini+0x2e/0xc0 [amdgpu]
[ 845.212894] gmc\_v12\_0\_sw\_fini+0x2a/0x40 [amdgpu]
[ 845.213036] amdgpu\_device\_fini\_sw+0x11a/0x590 [amdgpu]
[ 845.213159] amdgpu\_driver\_release\_kms+0x16/0x40 [amdgpu]
[ 845.213302] devm\_drm\_dev\_init\_release+0x5e/0x90
[ 845.213305] devm\_action\_release+0x12/0x30
[ 845.213308] release\_nodes+0x42/0xd0
[ 845.213311] devres\_release\_all+0x97/0xe0
[ 845.213314] device\_unbind\_cleanup+0x12/0x80
[ 845.213317] device\_release\_driver\_internal+0x230/0x270
[ 845.213319] ? srso\_alias\_return\_thunk+0x5/0xfbef5
This is caused by lost memory during early init phase. First time driver
is removed, memory is freed but when second time the driver is inserted,
VBIOS dmub is not active, since the PSP policy is to retain the driver
loaded version on subsequent warm boots. Hence, communication with VBIOS
DMUB fails.
Fix this by aborting further communication with vbios dmub and release
the memory immediately.
Fixes: f59549c7e705 ("drm/amd/display: free bo used for dmub bounding box")
Reviewed-by: Rodrigo Siqueira <rodrigo.siqueira@amd.com>
Signed-off-by: Aurabindo Pillai <aurabindo.pillai@amd.com>
Signed-off-by: Rodrigo Siqueira <rodrigo.siqueira@amd.com>
Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5860c637513036a6ffc130950ea98676b591b47c)

| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=5860c637513036a6ffc130950ea98676b591b47c) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.h?id=5860c637513036a6ffc130950ea98676b591b47c) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_helpers.c?id=5860c637513036a6ffc130950ea98676b591b47c) | 13 | |  |  |  | | --- | --- | --- | |

3 files changed, 33 insertions, 15 deletions

| diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.cindex 8d97f17ffe662a..24fbde7dd1c425 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=13231df707a70aba9398c95998d3f224e7253b07)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=5860c637513036a6ffc130950ea98676b591b47c)@@ -1696,6 +1696,26 @@ dm\_allocate\_gpu\_mem( return da->cpu\_ptr; } +void+dm\_free\_gpu\_mem(+ struct amdgpu\_device \*adev,+ enum dc\_gpu\_mem\_alloc\_type type,+ void \*pvMem)+{+ struct dal\_allocation \*da;++ /\* walk the da list in DM \*/+ list\_for\_each\_entry(da, &adev->dm.da\_list, list) {+ if (pvMem == da->cpu\_ptr) {+ amdgpu\_bo\_free\_kernel(&da->bo, &da->gpu\_addr, &da->cpu\_ptr);+ list\_del(&da->list);+ kfree(da);+ break;+ }+ }++}+ static enum dmub\_status dm\_dmub\_send\_vbios\_gpint\_command(struct amdgpu\_device \*adev, enum dmub\_gpint\_command command\_code,@@ -1762,16 +1782,20 @@ static struct dml2\_soc\_bb \*dm\_dmub\_get\_vbios\_bounding\_box(struct amdgpu\_device \* /\* Send the chunk \*/ ret = dm\_dmub\_send\_vbios\_gpint\_command(adev, send\_addrs[i], chunk, 30000); if (ret != DMUB\_STATUS\_OK)- /\* No need to free bb here since it shall be done in dm\_sw\_fini() \*/- return NULL;+ goto free\_bb; }  /\* Now ask DMUB to copy the bb \*/ ret = dm\_dmub\_send\_vbios\_gpint\_command(adev, DMUB\_GPINT\_\_BB\_COPY, 1, 200000); if (ret != DMUB\_STATUS\_OK)- return NULL;+ goto free\_bb;  return bb;++free\_bb:+ dm\_free\_gpu\_mem(adev, DC\_MEM\_ALLOC\_TYPE\_GART, (void \*) bb);+ return NULL;+ }  static enum dmub\_ips\_disable\_type dm\_get\_default\_ips\_mode(@@ -2541,11 +2565,11 @@ static int dm\_sw\_fini(void \*handle) amdgpu\_bo\_free\_kernel(&da->bo, &da->gpu\_addr, &da->cpu\_ptr); list\_del(&da->list); kfree(da);+ adev->dm.bb\_from\_dmub = NULL; break; } } - adev->dm.bb\_from\_dmub = NULL;  kfree(adev->dm.dmub\_fb\_info); adev->dm.dmub\_fb\_info = NULL;diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.hindex 90dfffec33cf49..a0bc2c0ac04d96 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.h?id=13231df707a70aba9398c95998d3f224e7253b07)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.h?id=5860c637513036a6ffc130950ea98676b591b47c)@@ -1004,6 +1004,9 @@ void \*dm\_allocate\_gpu\_mem(struct amdgpu\_device \*adev, enum dc\_gpu\_mem\_alloc\_type type, size\_t size, long long \*addr);+void dm\_free\_gpu\_mem(struct amdgpu\_device \*adev,+ enum dc\_gpu\_mem\_alloc\_type type,+ void \*addr);  bool amdgpu\_dm\_is\_headless(struct amdgpu\_device \*adev); diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.cindex eea317dcbe8c34..9752548cc5b21d 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_helpers.c?id=13231df707a70aba9398c95998d3f224e7253b07)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_helpers.c?id=5860c637513036a6ffc130950ea98676b591b47c)@@ -1055,17 +1055,8 @@ void dm\_helpers\_free\_gpu\_mem( void \*pvMem) { struct amdgpu\_device \*adev = ctx->driver\_context;- struct dal\_allocation \*da;-- /\* walk the da list in DM \*/- list\_for\_each\_entry(da, &adev->dm.da\_list, list) {- if (pvMem == da->cpu\_ptr) {- amdgpu\_bo\_free\_kernel(&da->bo, &da->gpu\_addr, &da->cpu\_ptr);- list\_del(&da->list);- kfree(da);- break;- }- }++ dm\_free\_gpu\_mem(adev, type, pvMem); }  bool dm\_helpers\_dmub\_outbox\_interrupt\_control(struct dc\_context \*ctx, bool enable) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:42:26 +0000



=== Content from git.kernel.org_7122694a_20250114_214350.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Aurabindo Pillai <aurabindo.pillai@amd.com> | 2024-09-23 20:07:25 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:11 +0100 |
| commit | [e51cbe40b77a32e8698ad8b9582e5b4fce6da364](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)) | |
| tree | [8cbcf0ce914b609da6f42b4d214c07e626b0cb00](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364) | |
| parent | [4e5d50b6f35fce4b4a27028fda48f5a24b8add17](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e5d50b6f35fce4b4a27028fda48f5a24b8add17) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364&id2=4e5d50b6f35fce4b4a27028fda48f5a24b8add17)) | |
| download | [linux-e51cbe40b77a32e8698ad8b9582e5b4fce6da364.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e51cbe40b77a32e8698ad8b9582e5b4fce6da364.tar.gz) | |

drm/amd/display: fix a memleak issue when driver is removed[ Upstream commit d4f36e5fd800de7db74c1c4e62baf24a091a5ff6 ]
Running "modprobe amdgpu" the second time (followed by a modprobe -r
amdgpu) causes a call trace like:
[ 845.212163] Memory manager not clean during takedown.
[ 845.212170] WARNING: CPU: 4 PID: 2481 at drivers/gpu/drm/drm\_mm.c:999 drm\_mm\_takedown+0x2b/0x40
[ 845.212177] Modules linked in: amdgpu(OE-) amddrm\_ttm\_helper(OE) amddrm\_buddy(OE) amdxcp(OE) amd\_sched(OE) drm\_exec drm\_suballoc\_helper drm\_display\_helper i2c\_algo\_bit amdttm(OE) amdkcl(OE) cec rc\_core sunrpc qrtr intel\_rapl\_msr intel\_rapl\_common snd\_hda\_codec\_hdmi edac\_mce\_amd snd\_hda\_intel snd\_intel\_dspcfg snd\_intel\_sdw\_acpi snd\_usb\_audio snd\_hda\_codec snd\_usbmidi\_lib kvm\_amd snd\_hda\_core snd\_ump mc snd\_hwdep kvm snd\_pcm snd\_seq\_midi snd\_seq\_midi\_event irqbypass crct10dif\_pclmul snd\_rawmidi polyval\_clmulni polyval\_generic ghash\_clmulni\_intel sha256\_ssse3 sha1\_ssse3 snd\_seq aesni\_intel crypto\_simd snd\_seq\_device cryptd snd\_timer mfd\_aaeon asus\_nb\_wmi eeepc\_wmi joydev asus\_wmi snd ledtrig\_audio sparse\_keymap ccp wmi\_bmof input\_leds k10temp i2c\_piix4 platform\_profile rapl soundcore gpio\_amdpt mac\_hid binfmt\_misc msr parport\_pc ppdev lp parport efi\_pstore nfnetlink dmi\_sysfs ip\_tables x\_tables autofs4 hid\_logitech\_hidpp hid\_logitech\_dj hid\_generic usbhid hid ahci xhci\_pci igc crc32\_pclmul libahci xhci\_pci\_renesas video
[ 845.212284] wmi [last unloaded: amddrm\_ttm\_helper(OE)]
[ 845.212290] CPU: 4 PID: 2481 Comm: modprobe Tainted: G W OE 6.8.0-31-generic #31-Ubuntu
[ 845.212296] RIP: 0010:drm\_mm\_takedown+0x2b/0x40
[ 845.212300] Code: 1f 44 00 00 48 8b 47 38 48 83 c7 38 48 39 f8 75 09 31 c0 31 ff e9 90 2e 86 00 55 48 c7 c7 d0 f6 8e 8a 48 89 e5 e8 f5 db 45 ff <0f> 0b 5d 31 c0 31 ff e9 74 2e 86 00 66 0f 1f 84 00 00 00 00 00 90
[ 845.212302] RSP: 0018:ffffb11302127ae0 EFLAGS: 00010246
[ 845.212305] RAX: 0000000000000000 RBX: ffff92aa5020fc08 RCX: 0000000000000000
[ 845.212307] RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
[ 845.212309] RBP: ffffb11302127ae0 R08: 0000000000000000 R09: 0000000000000000
[ 845.212310] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000004
[ 845.212312] R13: ffff92aa50200000 R14: ffff92aa5020fb10 R15: ffff92aa5020faa0
[ 845.212313] FS: 0000707dd7c7c080(0000) GS:ffff92b93de00000(0000) knlGS:0000000000000000
[ 845.212316] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 845.212318] CR2: 00007d48b0aee200 CR3: 0000000115a58000 CR4: 0000000000f50ef0
[ 845.212320] PKRU: 55555554
[ 845.212321] Call Trace:
[ 845.212323] <TASK>
[ 845.212328] ? show\_regs+0x6d/0x80
[ 845.212333] ? \_\_warn+0x89/0x160
[ 845.212339] ? drm\_mm\_takedown+0x2b/0x40
[ 845.212344] ? report\_bug+0x17e/0x1b0
[ 845.212350] ? handle\_bug+0x51/0xa0
[ 845.212355] ? exc\_invalid\_op+0x18/0x80
[ 845.212359] ? asm\_exc\_invalid\_op+0x1b/0x20
[ 845.212366] ? drm\_mm\_takedown+0x2b/0x40
[ 845.212371] amdgpu\_gtt\_mgr\_fini+0xa9/0x130 [amdgpu]
[ 845.212645] amdgpu\_ttm\_fini+0x264/0x340 [amdgpu]
[ 845.212770] amdgpu\_bo\_fini+0x2e/0xc0 [amdgpu]
[ 845.212894] gmc\_v12\_0\_sw\_fini+0x2a/0x40 [amdgpu]
[ 845.213036] amdgpu\_device\_fini\_sw+0x11a/0x590 [amdgpu]
[ 845.213159] amdgpu\_driver\_release\_kms+0x16/0x40 [amdgpu]
[ 845.213302] devm\_drm\_dev\_init\_release+0x5e/0x90
[ 845.213305] devm\_action\_release+0x12/0x30
[ 845.213308] release\_nodes+0x42/0xd0
[ 845.213311] devres\_release\_all+0x97/0xe0
[ 845.213314] device\_unbind\_cleanup+0x12/0x80
[ 845.213317] device\_release\_driver\_internal+0x230/0x270
[ 845.213319] ? srso\_alias\_return\_thunk+0x5/0xfbef5
This is caused by lost memory during early init phase. First time driver
is removed, memory is freed but when second time the driver is inserted,
VBIOS dmub is not active, since the PSP policy is to retain the driver
loaded version on subsequent warm boots. Hence, communication with VBIOS
DMUB fails.
Fix this by aborting further communication with vbios dmub and release
the memory immediately.
Fixes: f59549c7e705 ("drm/amd/display: free bo used for dmub bounding box")
Reviewed-by: Rodrigo Siqueira <rodrigo.siqueira@amd.com>
Signed-off-by: Aurabindo Pillai <aurabindo.pillai@amd.com>
Signed-off-by: Rodrigo Siqueira <rodrigo.siqueira@amd.com>
Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)

| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.h?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_helpers.c?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364) | 13 | |  |  |  | | --- | --- | --- | |

3 files changed, 33 insertions, 15 deletions

| diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.cindex 339bdfb7af2f81..9451552184966b 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=4e5d50b6f35fce4b4a27028fda48f5a24b8add17)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)@@ -1681,6 +1681,26 @@ dm\_allocate\_gpu\_mem( return da->cpu\_ptr; } +void+dm\_free\_gpu\_mem(+ struct amdgpu\_device \*adev,+ enum dc\_gpu\_mem\_alloc\_type type,+ void \*pvMem)+{+ struct dal\_allocation \*da;++ /\* walk the da list in DM \*/+ list\_for\_each\_entry(da, &adev->dm.da\_list, list) {+ if (pvMem == da->cpu\_ptr) {+ amdgpu\_bo\_free\_kernel(&da->bo, &da->gpu\_addr, &da->cpu\_ptr);+ list\_del(&da->list);+ kfree(da);+ break;+ }+ }++}+ static enum dmub\_status dm\_dmub\_send\_vbios\_gpint\_command(struct amdgpu\_device \*adev, enum dmub\_gpint\_command command\_code,@@ -1747,16 +1767,20 @@ static struct dml2\_soc\_bb \*dm\_dmub\_get\_vbios\_bounding\_box(struct amdgpu\_device \* /\* Send the chunk \*/ ret = dm\_dmub\_send\_vbios\_gpint\_command(adev, send\_addrs[i], chunk, 30000); if (ret != DMUB\_STATUS\_OK)- /\* No need to free bb here since it shall be done in dm\_sw\_fini() \*/- return NULL;+ goto free\_bb; }  /\* Now ask DMUB to copy the bb \*/ ret = dm\_dmub\_send\_vbios\_gpint\_command(adev, DMUB\_GPINT\_\_BB\_COPY, 1, 200000); if (ret != DMUB\_STATUS\_OK)- return NULL;+ goto free\_bb;  return bb;++free\_bb:+ dm\_free\_gpu\_mem(adev, DC\_MEM\_ALLOC\_TYPE\_GART, (void \*) bb);+ return NULL;+ }  static enum dmub\_ips\_disable\_type dm\_get\_default\_ips\_mode(@@ -2520,11 +2544,11 @@ static int dm\_sw\_fini(void \*handle) amdgpu\_bo\_free\_kernel(&da->bo, &da->gpu\_addr, &da->cpu\_ptr); list\_del(&da->list); kfree(da);+ adev->dm.bb\_from\_dmub = NULL; break; } } - adev->dm.bb\_from\_dmub = NULL;  kfree(adev->dm.dmub\_fb\_info); adev->dm.dmub\_fb\_info = NULL;diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.hindex 87a8d1d4f9a1b6..86b10471f2bdac 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.h?id=4e5d50b6f35fce4b4a27028fda48f5a24b8add17)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.h?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)@@ -1004,6 +1004,9 @@ void \*dm\_allocate\_gpu\_mem(struct amdgpu\_device \*adev, enum dc\_gpu\_mem\_alloc\_type type, size\_t size, long long \*addr);+void dm\_free\_gpu\_mem(struct amdgpu\_device \*adev,+ enum dc\_gpu\_mem\_alloc\_type type,+ void \*addr);  bool amdgpu\_dm\_is\_headless(struct amdgpu\_device \*adev); diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.cindex 28db4c1a0a2ad8..3dfbdf4ed3ee04 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_helpers.c?id=4e5d50b6f35fce4b4a27028fda48f5a24b8add17)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm\_helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_helpers.c?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)@@ -1055,17 +1055,8 @@ void dm\_helpers\_free\_gpu\_mem( void \*pvMem) { struct amdgpu\_device \*adev = ctx->driver\_context;- struct dal\_allocation \*da;-- /\* walk the da list in DM \*/- list\_for\_each\_entry(da, &adev->dm.da\_list, list) {- if (pvMem == da->cpu\_ptr) {- amdgpu\_bo\_free\_kernel(&da->bo, &da->gpu\_addr, &da->cpu\_ptr);- list\_del(&da->list);- kfree(da);- break;- }- }++ dm\_free\_gpu\_mem(adev, type, pvMem); }  bool dm\_helpers\_dmub\_outbox\_interrupt\_control(struct dc\_context \*ctx, bool enable) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:42:27 +0000


