=== Content from git.kernel.org_4e39a7b1_20250114_201523.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:06 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:29 +0100 |
| commit | [6ea17c03edc7ed0aabb1431eb26e2f94849af68a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a)) | |
| tree | [613f1354828f7554f9706e3ca3b87cd042e422ca](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a) | |
| parent | [b7c7c400de85d915e0da7c2c363553a801c47349](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7c7c400de85d915e0da7c2c363553a801c47349) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a&id2=b7c7c400de85d915e0da7c2c363553a801c47349)) | |
| download | [linux-6ea17c03edc7ed0aabb1431eb26e2f94849af68a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6ea17c03edc7ed0aabb1431eb26e2f94849af68a.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for PMIC devices[ Upstream commit 0350d783ab888cb1cb48ced36cc28b372723f1a4 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 24 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex ba441fd9c4ed43..9f44f793ca456e 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=b7c7c400de85d915e0da7c2c363553a801c47349)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=6ea17c03edc7ed0aabb1431eb26e2f94849af68a)@@ -227,21 +227,11 @@ static struct resource tmu\_resources[] = {  static struct mfd\_cell bxt\_wc\_dev[] = { {- .name = "bxt\_wcove\_gpadc",- .num\_resources = ARRAY\_SIZE(adc\_resources),- .resources = adc\_resources,- },- { .name = "bxt\_wcove\_thermal", .num\_resources = ARRAY\_SIZE(thermal\_resources), .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_bcu",- .num\_resources = ARRAY\_SIZE(bcu\_resources),- .resources = bcu\_resources,- },- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -259,6 +249,22 @@ static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_bcu\_dev[] = {+ {+ .name = "bxt\_wcove\_bcu",+ .num\_resources = ARRAY\_SIZE(bcu\_resources),+ .resources = bcu\_resources,+ },+};++static const struct mfd\_cell bxt\_wc\_adc\_dev[] = {+ {+ .name = "bxt\_wcove\_gpadc",+ .num\_resources = ARRAY\_SIZE(adc\_resources),+ .resources = adc\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -504,23 +510,23 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - /\* Add chained IRQ handler for BCU IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_BCU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_bcu,- &pmic->irq\_chip\_data\_bcu);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_bcu\_dev, ARRAY\_SIZE(bxt\_wc\_bcu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_BCU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_bcu,+ &pmic->irq\_chip\_data\_bcu); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add BUC IRQ chip\n");+ return ret; - /\* Add chained IRQ handler for ADC IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_ADC\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_adc,- &pmic->irq\_chip\_data\_adc);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_adc\_dev, ARRAY\_SIZE(bxt\_wc\_adc\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_ADC\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_adc,+ &pmic->irq\_chip\_data\_adc); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n");+ return ret;  ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev), pmic->irq\_chip\_data, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:14:00 +0000



=== Content from git.kernel.org_3a3a80a9_20250114_201522.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:06 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:58 +0100 |
| commit | [61d590d7076b50b6ebdea1f3b83bb041c01fc482](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482)) | |
| tree | [45d527332b1d5f143306786b58c8034c11cbe9ae](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482) | |
| parent | [c472b55cc0bc3df805db6a14f50a084884cf18ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c472b55cc0bc3df805db6a14f50a084884cf18ee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482&id2=c472b55cc0bc3df805db6a14f50a084884cf18ee)) | |
| download | [linux-61d590d7076b50b6ebdea1f3b83bb041c01fc482.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-61d590d7076b50b6ebdea1f3b83bb041c01fc482.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for PMIC devices[ Upstream commit 0350d783ab888cb1cb48ced36cc28b372723f1a4 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 24 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 8b55f839a946b0..6d708d6f7281af 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=c472b55cc0bc3df805db6a14f50a084884cf18ee)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=61d590d7076b50b6ebdea1f3b83bb041c01fc482)@@ -231,21 +231,11 @@ static struct resource tmu\_resources[] = {  static struct mfd\_cell bxt\_wc\_dev[] = { {- .name = "bxt\_wcove\_gpadc",- .num\_resources = ARRAY\_SIZE(adc\_resources),- .resources = adc\_resources,- },- { .name = "bxt\_wcove\_thermal", .num\_resources = ARRAY\_SIZE(thermal\_resources), .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_bcu",- .num\_resources = ARRAY\_SIZE(bcu\_resources),- .resources = bcu\_resources,- },- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -263,6 +253,22 @@ static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_bcu\_dev[] = {+ {+ .name = "bxt\_wcove\_bcu",+ .num\_resources = ARRAY\_SIZE(bcu\_resources),+ .resources = bcu\_resources,+ },+};++static const struct mfd\_cell bxt\_wc\_adc\_dev[] = {+ {+ .name = "bxt\_wcove\_gpadc",+ .num\_resources = ARRAY\_SIZE(adc\_resources),+ .resources = adc\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -504,23 +510,23 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - /\* Add chained IRQ handler for BCU IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_BCU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_bcu,- &pmic->irq\_chip\_data\_bcu);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_bcu\_dev, ARRAY\_SIZE(bxt\_wc\_bcu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_BCU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_bcu,+ &pmic->irq\_chip\_data\_bcu); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add BUC IRQ chip\n");+ return ret; - /\* Add chained IRQ handler for ADC IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_ADC\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_adc,- &pmic->irq\_chip\_data\_adc);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_adc\_dev, ARRAY\_SIZE(bxt\_wc\_adc\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_ADC\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_adc,+ &pmic->irq\_chip\_data\_adc); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n");+ return ret;  ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev), pmic->irq\_chip\_data, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:13:59 +0000



=== Content from git.kernel.org_215a424e_20250114_201521.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0350d783ab888cb1cb48ced36cc28b372723f1a4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0350d783ab888cb1cb48ced36cc28b372723f1a4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0350d783ab888cb1cb48ced36cc28b372723f1a4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0350d783ab888cb1cb48ced36cc28b372723f1a4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:06 +0300 |
| --- | --- | --- |
| committer | Lee Jones <lee@kernel.org> | 2024-10-16 09:04:11 +0100 |
| commit | [0350d783ab888cb1cb48ced36cc28b372723f1a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0350d783ab888cb1cb48ced36cc28b372723f1a4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0350d783ab888cb1cb48ced36cc28b372723f1a4)) | |
| tree | [bda05c821828f1ab44aef36914d9ce0dda68aef7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0350d783ab888cb1cb48ced36cc28b372723f1a4) | |
| parent | [9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0350d783ab888cb1cb48ced36cc28b372723f1a4&id2=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73)) | |
| download | [linux-0350d783ab888cb1cb48ced36cc28b372723f1a4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0350d783ab888cb1cb48ced36cc28b372723f1a4.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for PMIC devicesWhile design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0350d783ab888cb1cb48ced36cc28b372723f1a4)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=0350d783ab888cb1cb48ced36cc28b372723f1a4) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 24 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 628108dcf5454f..fefbeb4164fdee 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=0350d783ab888cb1cb48ced36cc28b372723f1a4)@@ -231,21 +231,11 @@ static const struct resource tmu\_resources[] = {  static struct mfd\_cell bxt\_wc\_dev[] = { {- .name = "bxt\_wcove\_gpadc",- .num\_resources = ARRAY\_SIZE(adc\_resources),- .resources = adc\_resources,- },- { .name = "bxt\_wcove\_thermal", .num\_resources = ARRAY\_SIZE(thermal\_resources), .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_bcu",- .num\_resources = ARRAY\_SIZE(bcu\_resources),- .resources = bcu\_resources,- },- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -263,6 +253,22 @@ static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_bcu\_dev[] = {+ {+ .name = "bxt\_wcove\_bcu",+ .num\_resources = ARRAY\_SIZE(bcu\_resources),+ .resources = bcu\_resources,+ },+};++static const struct mfd\_cell bxt\_wc\_adc\_dev[] = {+ {+ .name = "bxt\_wcove\_gpadc",+ .num\_resources = ARRAY\_SIZE(adc\_resources),+ .resources = adc\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -508,23 +514,23 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - /\* Add chained IRQ handler for BCU IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_BCU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_bcu,- &pmic->irq\_chip\_data\_bcu);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_bcu\_dev, ARRAY\_SIZE(bxt\_wc\_bcu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_BCU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_bcu,+ &pmic->irq\_chip\_data\_bcu); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add BUC IRQ chip\n");+ return ret; - /\* Add chained IRQ handler for ADC IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_ADC\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_adc,- &pmic->irq\_chip\_data\_adc);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_adc\_dev, ARRAY\_SIZE(bxt\_wc\_adc\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_ADC\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_adc,+ &pmic->irq\_chip\_data\_adc); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n");+ return ret;  ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev), pmic->irq\_chip\_data, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:13:58 +0000



=== Content from git.kernel.org_0642973b_20250114_201527.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bb6642d4b3136359b5b620049f76515876e6127e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb6642d4b3136359b5b620049f76515876e6127e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb6642d4b3136359b5b620049f76515876e6127e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb6642d4b3136359b5b620049f76515876e6127e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:06 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:01 +0100 |
| commit | [bb6642d4b3136359b5b620049f76515876e6127e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb6642d4b3136359b5b620049f76515876e6127e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bb6642d4b3136359b5b620049f76515876e6127e)) | |
| tree | [4f81a31a9a9270a3fb2750dc3509db31e5581692](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb6642d4b3136359b5b620049f76515876e6127e) | |
| parent | [da498e02c92e6d82df8001438dd583b90c570815](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da498e02c92e6d82df8001438dd583b90c570815) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb6642d4b3136359b5b620049f76515876e6127e&id2=da498e02c92e6d82df8001438dd583b90c570815)) | |
| download | [linux-bb6642d4b3136359b5b620049f76515876e6127e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bb6642d4b3136359b5b620049f76515876e6127e.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for PMIC devices[ Upstream commit 0350d783ab888cb1cb48ced36cc28b372723f1a4 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb6642d4b3136359b5b620049f76515876e6127e)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=bb6642d4b3136359b5b620049f76515876e6127e) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 24 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 4c5a8ae7b67625..7759d9c7ed343a 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=da498e02c92e6d82df8001438dd583b90c570815)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=bb6642d4b3136359b5b620049f76515876e6127e)@@ -231,21 +231,11 @@ static const struct resource tmu\_resources[] = {  static struct mfd\_cell bxt\_wc\_dev[] = { {- .name = "bxt\_wcove\_gpadc",- .num\_resources = ARRAY\_SIZE(adc\_resources),- .resources = adc\_resources,- },- { .name = "bxt\_wcove\_thermal", .num\_resources = ARRAY\_SIZE(thermal\_resources), .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_bcu",- .num\_resources = ARRAY\_SIZE(bcu\_resources),- .resources = bcu\_resources,- },- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -263,6 +253,22 @@ static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_bcu\_dev[] = {+ {+ .name = "bxt\_wcove\_bcu",+ .num\_resources = ARRAY\_SIZE(bcu\_resources),+ .resources = bcu\_resources,+ },+};++static const struct mfd\_cell bxt\_wc\_adc\_dev[] = {+ {+ .name = "bxt\_wcove\_gpadc",+ .num\_resources = ARRAY\_SIZE(adc\_resources),+ .resources = adc\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -504,23 +510,23 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - /\* Add chained IRQ handler for BCU IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_BCU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_bcu,- &pmic->irq\_chip\_data\_bcu);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_bcu\_dev, ARRAY\_SIZE(bxt\_wc\_bcu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_BCU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_bcu,+ &pmic->irq\_chip\_data\_bcu); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add BUC IRQ chip\n");+ return ret; - /\* Add chained IRQ handler for ADC IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_ADC\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_adc,- &pmic->irq\_chip\_data\_adc);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_adc\_dev, ARRAY\_SIZE(bxt\_wc\_adc\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_ADC\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_adc,+ &pmic->irq\_chip\_data\_adc); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n");+ return ret;  ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev), pmic->irq\_chip\_data, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:14:04 +0000



=== Content from git.kernel.org_a5fadd3c_20250114_201525.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=897713c9d24f6ec394585abfcf259a6e5cad22c8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=897713c9d24f6ec394585abfcf259a6e5cad22c8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=897713c9d24f6ec394585abfcf259a6e5cad22c8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=897713c9d24f6ec394585abfcf259a6e5cad22c8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:06 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:31 +0100 |
| commit | [897713c9d24f6ec394585abfcf259a6e5cad22c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=897713c9d24f6ec394585abfcf259a6e5cad22c8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=897713c9d24f6ec394585abfcf259a6e5cad22c8)) | |
| tree | [145f289b6ec51d73268fd9abc5a52acfb47862b1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=897713c9d24f6ec394585abfcf259a6e5cad22c8) | |
| parent | [2310f5336f32eac9ada2d59b965d578efe25c4bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2310f5336f32eac9ada2d59b965d578efe25c4bf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=897713c9d24f6ec394585abfcf259a6e5cad22c8&id2=2310f5336f32eac9ada2d59b965d578efe25c4bf)) | |
| download | [linux-897713c9d24f6ec394585abfcf259a6e5cad22c8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-897713c9d24f6ec394585abfcf259a6e5cad22c8.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for PMIC devices[ Upstream commit 0350d783ab888cb1cb48ced36cc28b372723f1a4 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=897713c9d24f6ec394585abfcf259a6e5cad22c8)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=897713c9d24f6ec394585abfcf259a6e5cad22c8) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 24 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex f4d50e35b84891..f588e0f1fd0ade 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=2310f5336f32eac9ada2d59b965d578efe25c4bf)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=897713c9d24f6ec394585abfcf259a6e5cad22c8)@@ -232,21 +232,11 @@ static const struct resource tmu\_resources[] = {  static struct mfd\_cell bxt\_wc\_dev[] = { {- .name = "bxt\_wcove\_gpadc",- .num\_resources = ARRAY\_SIZE(adc\_resources),- .resources = adc\_resources,- },- { .name = "bxt\_wcove\_thermal", .num\_resources = ARRAY\_SIZE(thermal\_resources), .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_bcu",- .num\_resources = ARRAY\_SIZE(bcu\_resources),- .resources = bcu\_resources,- },- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -264,6 +254,22 @@ static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_bcu\_dev[] = {+ {+ .name = "bxt\_wcove\_bcu",+ .num\_resources = ARRAY\_SIZE(bcu\_resources),+ .resources = bcu\_resources,+ },+};++static const struct mfd\_cell bxt\_wc\_adc\_dev[] = {+ {+ .name = "bxt\_wcove\_gpadc",+ .num\_resources = ARRAY\_SIZE(adc\_resources),+ .resources = adc\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -509,23 +515,23 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - /\* Add chained IRQ handler for BCU IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_BCU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_bcu,- &pmic->irq\_chip\_data\_bcu);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_bcu\_dev, ARRAY\_SIZE(bxt\_wc\_bcu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_BCU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_bcu,+ &pmic->irq\_chip\_data\_bcu); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add BUC IRQ chip\n");+ return ret; - /\* Add chained IRQ handler for ADC IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_ADC\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_adc,- &pmic->irq\_chip\_data\_adc);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_adc\_dev, ARRAY\_SIZE(bxt\_wc\_adc\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_ADC\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_adc,+ &pmic->irq\_chip\_data\_adc); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n");+ return ret;  ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev), pmic->irq\_chip\_data, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:14:02 +0000



=== Content from git.kernel.org_61fd889a_20250114_201529.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:06 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:14 +0100 |
| commit | [d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62)) | |
| tree | [f46458c96027b15f26df72b33b91499cfe9a6601](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62) | |
| parent | [1b734ad0e33648c3988c6a37c2ac16c2d63eda06](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62&id2=1b734ad0e33648c3988c6a37c2ac16c2d63eda06)) | |
| download | [linux-d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for PMIC devices[ Upstream commit 0350d783ab888cb1cb48ced36cc28b372723f1a4 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 24 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 5fc9d3aa614286..3aa7857271dadb 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=d4cc78bd6a25accb7ae2ac9fc445d1e1deda4a62)@@ -232,21 +232,11 @@ static const struct resource tmu\_resources[] = {  static struct mfd\_cell bxt\_wc\_dev[] = { {- .name = "bxt\_wcove\_gpadc",- .num\_resources = ARRAY\_SIZE(adc\_resources),- .resources = adc\_resources,- },- { .name = "bxt\_wcove\_thermal", .num\_resources = ARRAY\_SIZE(thermal\_resources), .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_bcu",- .num\_resources = ARRAY\_SIZE(bcu\_resources),- .resources = bcu\_resources,- },- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -264,6 +254,22 @@ static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_bcu\_dev[] = {+ {+ .name = "bxt\_wcove\_bcu",+ .num\_resources = ARRAY\_SIZE(bcu\_resources),+ .resources = bcu\_resources,+ },+};++static const struct mfd\_cell bxt\_wc\_adc\_dev[] = {+ {+ .name = "bxt\_wcove\_gpadc",+ .num\_resources = ARRAY\_SIZE(adc\_resources),+ .resources = adc\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -509,23 +515,23 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - /\* Add chained IRQ handler for BCU IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_BCU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_bcu,- &pmic->irq\_chip\_data\_bcu);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_bcu\_dev, ARRAY\_SIZE(bxt\_wc\_bcu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_BCU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_bcu,+ &pmic->irq\_chip\_data\_bcu); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add BUC IRQ chip\n");+ return ret; - /\* Add chained IRQ handler for ADC IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_ADC\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_adc,- &pmic->irq\_chip\_data\_adc);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_adc\_dev, ARRAY\_SIZE(bxt\_wc\_adc\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_ADC\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_adc,+ &pmic->irq\_chip\_data\_adc); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n");+ return ret;  ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev), pmic->irq\_chip\_data, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:14:06 +0000



=== Content from git.kernel.org_fd28b376_20250114_201524.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7ba45b8bc62e64da524d45532107ae93eb33c93c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ba45b8bc62e64da524d45532107ae93eb33c93c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ba45b8bc62e64da524d45532107ae93eb33c93c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ba45b8bc62e64da524d45532107ae93eb33c93c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:06 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:36 +0100 |
| commit | [7ba45b8bc62e64da524d45532107ae93eb33c93c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ba45b8bc62e64da524d45532107ae93eb33c93c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7ba45b8bc62e64da524d45532107ae93eb33c93c)) | |
| tree | [80e40a5bb3906b06e92c81adceccfd3a6b0d0a0d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ba45b8bc62e64da524d45532107ae93eb33c93c) | |
| parent | [56acf415772ee7e10e448b371f52b249aa2d0f7b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56acf415772ee7e10e448b371f52b249aa2d0f7b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ba45b8bc62e64da524d45532107ae93eb33c93c&id2=56acf415772ee7e10e448b371f52b249aa2d0f7b)) | |
| download | [linux-7ba45b8bc62e64da524d45532107ae93eb33c93c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7ba45b8bc62e64da524d45532107ae93eb33c93c.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for PMIC devices[ Upstream commit 0350d783ab888cb1cb48ced36cc28b372723f1a4 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ba45b8bc62e64da524d45532107ae93eb33c93c)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=7ba45b8bc62e64da524d45532107ae93eb33c93c) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 24 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 5fc9d3aa614286..3aa7857271dadb 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=56acf415772ee7e10e448b371f52b249aa2d0f7b)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=7ba45b8bc62e64da524d45532107ae93eb33c93c)@@ -232,21 +232,11 @@ static const struct resource tmu\_resources[] = {  static struct mfd\_cell bxt\_wc\_dev[] = { {- .name = "bxt\_wcove\_gpadc",- .num\_resources = ARRAY\_SIZE(adc\_resources),- .resources = adc\_resources,- },- { .name = "bxt\_wcove\_thermal", .num\_resources = ARRAY\_SIZE(thermal\_resources), .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_bcu",- .num\_resources = ARRAY\_SIZE(bcu\_resources),- .resources = bcu\_resources,- },- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -264,6 +254,22 @@ static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_bcu\_dev[] = {+ {+ .name = "bxt\_wcove\_bcu",+ .num\_resources = ARRAY\_SIZE(bcu\_resources),+ .resources = bcu\_resources,+ },+};++static const struct mfd\_cell bxt\_wc\_adc\_dev[] = {+ {+ .name = "bxt\_wcove\_gpadc",+ .num\_resources = ARRAY\_SIZE(adc\_resources),+ .resources = adc\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -509,23 +515,23 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - /\* Add chained IRQ handler for BCU IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_BCU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_bcu,- &pmic->irq\_chip\_data\_bcu);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_bcu\_dev, ARRAY\_SIZE(bxt\_wc\_bcu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_BCU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_bcu,+ &pmic->irq\_chip\_data\_bcu); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add BUC IRQ chip\n");+ return ret; - /\* Add chained IRQ handler for ADC IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_ADC\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_adc,- &pmic->irq\_chip\_data\_adc);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_adc\_dev, ARRAY\_SIZE(bxt\_wc\_adc\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_ADC\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_adc,+ &pmic->irq\_chip\_data\_adc); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n");+ return ret;  ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev), pmic->irq\_chip\_data, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:14:01 +0000



=== Content from git.kernel.org_ecd98a79_20250114_201526.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:06 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:04 +0100 |
| commit | [b3d45c19bcffb9a9a821df759f60be39d88c19f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4)) | |
| tree | [2b2dc31cafbd4842f403a1cce38598cb0d33a7d6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4) | |
| parent | [5bc6d0da4a32fe34a9960de577e0b7de3454de0c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4&id2=5bc6d0da4a32fe34a9960de577e0b7de3454de0c)) | |
| download | [linux-b3d45c19bcffb9a9a821df759f60be39d88c19f4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b3d45c19bcffb9a9a821df759f60be39d88c19f4.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for PMIC devices[ Upstream commit 0350d783ab888cb1cb48ced36cc28b372723f1a4 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-4-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4) | 54 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 24 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 628108dcf5454f..fefbeb4164fdee 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=b3d45c19bcffb9a9a821df759f60be39d88c19f4)@@ -231,21 +231,11 @@ static const struct resource tmu\_resources[] = {  static struct mfd\_cell bxt\_wc\_dev[] = { {- .name = "bxt\_wcove\_gpadc",- .num\_resources = ARRAY\_SIZE(adc\_resources),- .resources = adc\_resources,- },- { .name = "bxt\_wcove\_thermal", .num\_resources = ARRAY\_SIZE(thermal\_resources), .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_bcu",- .num\_resources = ARRAY\_SIZE(bcu\_resources),- .resources = bcu\_resources,- },- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -263,6 +253,22 @@ static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_bcu\_dev[] = {+ {+ .name = "bxt\_wcove\_bcu",+ .num\_resources = ARRAY\_SIZE(bcu\_resources),+ .resources = bcu\_resources,+ },+};++static const struct mfd\_cell bxt\_wc\_adc\_dev[] = {+ {+ .name = "bxt\_wcove\_gpadc",+ .num\_resources = ARRAY\_SIZE(adc\_resources),+ .resources = adc\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -508,23 +514,23 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - /\* Add chained IRQ handler for BCU IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_BCU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_bcu,- &pmic->irq\_chip\_data\_bcu);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_bcu\_dev, ARRAY\_SIZE(bxt\_wc\_bcu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_BCU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_bcu,+ &pmic->irq\_chip\_data\_bcu); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add BUC IRQ chip\n");+ return ret; - /\* Add chained IRQ handler for ADC IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_ADC\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_adc,- &pmic->irq\_chip\_data\_adc);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_adc\_dev, ARRAY\_SIZE(bxt\_wc\_adc\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_ADC\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_adc,+ &pmic->irq\_chip\_data\_adc); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n");+ return ret;  ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev), pmic->irq\_chip\_data, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:14:03 +0000


