=== Content from github.com_56153e4d_20250114_223330.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwithastro%2Fastro%2Fsecurity%2Fadvisories%2FGHSA-49w6-73cw-chjr)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwithastro%2Fastro%2Fsecurity%2Fadvisories%2FGHSA-49w6-73cw-chjr)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=withastro%2Fastro)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[withastro](/withastro)
/
**[astro](/withastro/astro)**
Public

* [Notifications](/login?return_to=%2Fwithastro%2Fastro) You must be signed in to change notification settings
* [Fork
  2.6k](/login?return_to=%2Fwithastro%2Fastro)
* [Star
   48.4k](/login?return_to=%2Fwithastro%2Fastro)

* [Code](/withastro/astro)
* [Issues
  138](/withastro/astro/issues)
* [Pull requests
  33](/withastro/astro/pulls)
* [Actions](/withastro/astro/actions)
* [Projects
  0](/withastro/astro/projects)
* [Security](/withastro/astro/security)
* [Insights](/withastro/astro/pulse)

Additional navigation options

* [Code](/withastro/astro)
* [Issues](/withastro/astro/issues)
* [Pull requests](/withastro/astro/pulls)
* [Actions](/withastro/astro/actions)
* [Projects](/withastro/astro/projects)
* [Security](/withastro/astro/security)
* [Insights](/withastro/astro/pulse)

# Server source code is exposed to the public if sourcemaps are enabled

High

[ematipico](/ematipico)
published
GHSA-49w6-73cw-chjr
Dec 19, 2024

## Package

npm

astro
([npm](/advisories?query=ecosystem%3Anpm))

## Affected versions

<=5.0.7
<=4.16.17

## Patched versions

5.0.8
4.16.18

## Description

### Summary

A bug in the build process allows any unauthenticated user to read parts of the server source code.

### Details

During build, along with client assets such as css and font files, the sourcemap files **for the server code** are moved to a publicly-accessible folder.

[astro/packages/astro/src/core/build/static-build.ts](https://github.com/withastro/astro/blob/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro/src/core/build/static-build.ts#L139)

Line 139
in
[176fe9f](/withastro/astro/commit/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c)

|  | await ssrMoveAssets(opts, ssrOutputAssetNames); |
| --- | --- |

Any outside party can read them with an unauthorized HTTP GET request to the same server hosting the rest of the website.

While some server files are hashed, making their access obscure, the files corresponding to the file system router (those in `src/pages`) are predictably named. For example. the sourcemap file for `src/pages/index.astro` gets named `dist/client/pages/index.astro.mjs.map`.

### PoC

Here is one example of an affected open-source website:

<https://creatorsgarten.org/pages/index.astro.mjs.map>

[![](https://private-user-images.githubusercontent.com/69170106/395477797-773c5532-87af-42b8-838e-8f5472bf9f68.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY4OTQzMDksIm5iZiI6MTczNjg5NDAwOSwicGF0aCI6Ii82OTE3MDEwNi8zOTU0Nzc3OTctNzczYzU1MzItODdhZi00MmI4LTgzOGUtOGY1NDcyYmY5ZjY4LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTE0VDIyMzMyOVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWZiNjFmMGM3MjFhNzE0OTNhOGNlYjRmOTRiY2NkYmIxOGIyMTA3YjM1ZjU1YjNhZWMyMjIzYmY4MDlkZWZhMzImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.hGl2FQh5Ftd9Bb-h3Djl3rP1FFYMuk5glf09YkkZhRk)](https://private-user-images.githubusercontent.com/69170106/395477797-773c5532-87af-42b8-838e-8f5472bf9f68.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY4OTQzMDksIm5iZiI6MTczNjg5NDAwOSwicGF0aCI6Ii82OTE3MDEwNi8zOTU0Nzc3OTctNzczYzU1MzItODdhZi00MmI4LTgzOGUtOGY1NDcyYmY5ZjY4LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTE0VDIyMzMyOVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWZiNjFmMGM3MjFhNzE0OTNhOGNlYjRmOTRiY2NkYmIxOGIyMTA3YjM1ZjU1YjNhZWMyMjIzYmY4MDlkZWZhMzImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.hGl2FQh5Ftd9Bb-h3Djl3rP1FFYMuk5glf09YkkZhRk)

The file can be saved and opened using <https://evanw.github.io/source-map-visualization/> to reconstruct the source code.

[![](https://private-user-images.githubusercontent.com/69170106/395478875-7d35d0ca-3a29-4666-be21-cfefe311ac9d.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY4OTQzMDksIm5iZiI6MTczNjg5NDAwOSwicGF0aCI6Ii82OTE3MDEwNi8zOTU0Nzg4NzUtN2QzNWQwY2EtM2EyOS00NjY2LWJlMjEtY2ZlZmUzMTFhYzlkLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTE0VDIyMzMyOVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTA4ZTkwOTRlNWQ0MzRkNWRiNGNmOWUwMjkyYTMwZjBjMjVjMDM2Y2U1MGE4NDA1YWVmZDAwNjI1Y2RmM2VhY2QmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.-rVVdi_0tBWql5zfaSUcq3uci6ef1F3bX0ap1jwYlmA)](https://private-user-images.githubusercontent.com/69170106/395478875-7d35d0ca-3a29-4666-be21-cfefe311ac9d.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY4OTQzMDksIm5iZiI6MTczNjg5NDAwOSwicGF0aCI6Ii82OTE3MDEwNi8zOTU0Nzg4NzUtN2QzNWQwY2EtM2EyOS00NjY2LWJlMjEtY2ZlZmUzMTFhYzlkLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTE0VDIyMzMyOVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTA4ZTkwOTRlNWQ0MzRkNWRiNGNmOWUwMjkyYTMwZjBjMjVjMDM2Y2U1MGE4NDA1YWVmZDAwNjI1Y2RmM2VhY2QmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.-rVVdi_0tBWql5zfaSUcq3uci6ef1F3bX0ap1jwYlmA)

The above accurately mirrors the source code as seen in the repository: <https://github.com/creatorsgarten/creatorsgarten.org/blob/main/src/pages/index.astro>

[![](https://private-user-images.githubusercontent.com/69170106/395479582-39e77197-8382-4556-a024-c526dacccc1c.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY4OTQzMDksIm5iZiI6MTczNjg5NDAwOSwicGF0aCI6Ii82OTE3MDEwNi8zOTU0Nzk1ODItMzllNzcxOTctODM4Mi00NTU2LWEwMjQtYzUyNmRhY2NjYzFjLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTE0VDIyMzMyOVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJmYjg3OGU2ZGUzNWJmNmI0N2RlYTM2MDliODZjNTBiNzIzODY4NmM1ZTM1NzBhNTk1YzFmYWRkZGVjZjE5MTkmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.Nzr4W3-w8xPORqj3JpqYctLiHo3vKn8Lt-25404zBAE)](https://private-user-images.githubusercontent.com/69170106/395479582-39e77197-8382-4556-a024-c526dacccc1c.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY4OTQzMDksIm5iZiI6MTczNjg5NDAwOSwicGF0aCI6Ii82OTE3MDEwNi8zOTU0Nzk1ODItMzllNzcxOTctODM4Mi00NTU2LWEwMjQtYzUyNmRhY2NjYzFjLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTE0VDIyMzMyOVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJmYjg3OGU2ZGUzNWJmNmI0N2RlYTM2MDliODZjNTBiNzIzODY4NmM1ZTM1NzBhNTk1YzFmYWRkZGVjZjE5MTkmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.Nzr4W3-w8xPORqj3JpqYctLiHo3vKn8Lt-25404zBAE)

The above was found as the 4th result (and the first one on Astro 5.0+) when making the following search query on GitHub.com ([search results link](https://github.com/search?q=path%3Aastro.config.mjs+%40sentry%2Fastro&type=code)):

```
path:astro.config.mjs @sentry/astro

```

This vulnerability is the root cause of [#12703](https://github.com/withastro/astro/issues/12703), which links to a simple stackblitz project demonstrating the vulnerability. Upon build, notice the contents of the `dist/client` (referred to as `config.build.client` in astro code) folder. All astro servers make the folder in question accessible to the public internet without any authentication. It contains `.map` files corresponding to the code that runs on the server.

### Impact

All **server-output** (SSR) projects on Astro 5 versions **v5.0.3** through **v5.0.6** (inclusive), that have **sourcemaps enabled**, either directly or through an add-on such as [sentry](https://github.com/getsentry/sentry-javascript/blob/develop/packages/astro/src/integration/index.ts#L50), are affected. The fix for **server-output** projects was released in **astro@5.0.7**.

Additionally, all **static-output** (SSG) projects built using Astro 4 versions **4.16.17 or older**, or Astro 5 versions **5.0.7 or older**, that have **sourcemaps enabled** are also affected. The fix for **static-output** projects was released in **astro@5.0.8**, and backported to Astro v4 in **astro@4.16.18**.

The immediate impact is limited to source code. Any secrets or environment variables are not exposed unless they are present verbatim in the source code.

There is no immediate loss of integrity within the the vulnerable server. However, it is possible to subsequently discover another vulnerability via the revealed source code .

There is no immediate impact to availability of the vulnerable server. However, the presence of an unsafe regular expression, for example, can quickly be exploited to subsequently compromise the availability.

* Network attack vector.
* Low attack complexity.
* No privileges required.
* No interaction required from an authorized user.
* Scope is limited to first party. Although the source code of closed-source third-party software may also be exposed.

### Remediation

The fix for **server-output** projects was released in **astro@5.0.7**, and the fix for **static-output** projects was released in **astro@5.0.8** and backported to Astro v4 in **astro@4.16.18**. Users are advised to update immediately if they are using sourcemaps or an integration that enables sourcemaps.

### Severity

High

7.8

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v4 base metrics

##### Exploitability Metrics

Attack Vector
Network

Attack Complexity
Low

Attack Requirements
None

Privileges Required
None

User interaction
None
##### Vulnerable System Impact Metrics

Confidentiality
Low

Integrity
None

Availability
None
##### Subsequent System Impact Metrics

Confidentiality
High

Integrity
Low

Availability
Low

Learn more about base metrics

# CVSS v4 base metrics

##### Exploitability Metrics

Attack Vector:
This metric reflects the context by which vulnerability exploitation is possible. This metric value (and consequently the resulting severity) will be larger the more remote (logically, and physically) an attacker can be in order to exploit the vulnerable system. The assumption is that the number of potential attackers for a vulnerability that could be exploited from across a network is larger than the number of potential attackers that could exploit a vulnerability requiring physical access to a device, and therefore warrants a greater severity.

Attack Complexity:
This metric captures measurable actions that must be taken by the attacker to actively evade or circumvent existing built-in security-enhancing conditions in order to obtain a working exploit. These are conditions whose primary purpose is to increase security and/or increase exploit engineering complexity. A vulnerability exploitable without a target-specific variable has a lower complexity than a vulnerability that would require non-trivial customization. This metric is meant to capture security mechanisms utilized by the vulnerable system.

Attack Requirements:
This metric captures the prerequisite deployment and execution conditions or variables of the vulnerable system that enable the attack. These differ from security-enhancing techniques/technologies (ref Attack Complexity) as the primary purpose of these conditions is not to explicitly mitigate attacks, but rather, emerge naturally as a consequence of the deployment and execution of the vulnerable system.

Privileges Required:
This metric describes the level of privileges an attacker must possess prior to successfully exploiting the vulnerability. The method by which the attacker obtains privileged credentials prior to the attack (e.g., free trial accounts), is outside the scope of this metric. Generally, self-service provisioned accounts do not constitute a privilege requirement if the attacker can grant themselves privileges as part of the attack.

User interaction:
This metric captures the requirement for a human user, other than the attacker, to participate in the successful compromise of the vulnerable system. This metric determines whether the vulnerability can be exploited solely at the will of the attacker, or whether a separate user (or user-initiated process) must participate in some manner.
##### Vulnerable System Impact Metrics

Confidentiality:
This metric measures the impact to the confidentiality of the information managed by the VULNERABLE SYSTEM due to a successfully exploited vulnerability. Confidentiality refers to limiting information access and disclosure to only authorized users, as well as preventing access by, or disclosure to, unauthorized ones.

Integrity:
This metric measures the impact to integrity of a successfully exploited vulnerability. Integrity refers to the trustworthiness and veracity of information. Integrity of the VULNERABLE SYSTEM is impacted when an attacker makes unauthorized modification of system data. Integrity is also impacted when a system user can repudiate critical actions taken in the context of the system (e.g. due to insufficient logging).

Availability:
This metric measures the impact to the availability of the VULNERABLE SYSTEM resulting from a successfully exploited vulnerability. While the Confidentiality and Integrity impact metrics apply to the loss of confidentiality or integrity of data (e.g., information, files) used by the system, this metric refers to the loss of availability of the impacted system itself, such as a networked service (e.g., web, database, email). Since availability refers to the accessibility of information resources, attacks that consume network bandwidth, processor cycles, or disk space all impact the availability of a system.
##### Subsequent System Impact Metrics

Confidentiality:
This metric measures the impact to the confidentiality of the information managed by the SUBSEQUENT SYSTEM due to a successfully exploited vulnerability. Confidentiality refers to limiting information access and disclosure to only authorized users, as well as preventing access by, or disclosure to, unauthorized ones.

Integrity:
This metric measures the impact to integrity of a successfully exploited vulnerability. Integrity refers to the trustworthiness and veracity of information. Integrity of the SUBSEQUENT SYSTEM is impacted when an attacker makes unauthorized modification of system data. Integrity is also impacted when a system user can repudiate critical actions taken in the context of the system (e.g. due to insufficient logging).

Availability:
This metric measures the impact to the availability of the SUBSEQUENT SYSTEM resulting from a successfully exploited vulnerability. While the Confidentiality and Integrity impact metrics apply to the loss of confidentiality or integrity of data (e.g., information, files) used by the system, this metric refers to the loss of availability of the impacted system itself, such as a networked service (e.g., web, database, email). Since availability refers to the accessibility of information resources, attacks that consume network bandwidth, processor cycles, or disk space all impact the availability of a system.

 CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:L/VI:N/VA:N/SC:H/SI:L/SA:L

### CVE ID

CVE-2024-56159

### Weaknesses

[CWE-219](/advisories?query=cwe%3A219)

### Credits

* [![@lilnasy](https://avatars.githubusercontent.com/u/69170106?s=40&v=4)](/lilnasy)
  [lilnasy](/lilnasy)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ffaabe7a_20250114_223327.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwithastro%2Fastro%2Fblob%2F176fe9f113fd912f9b61e848b00bbcfecd6d5c2c%2Fpackages%2Fastro%2Fsrc%2Fcore%2Fbuild%2Fstatic-build.ts)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwithastro%2Fastro%2Fblob%2F176fe9f113fd912f9b61e848b00bbcfecd6d5c2c%2Fpackages%2Fastro%2Fsrc%2Fcore%2Fbuild%2Fstatic-build.ts)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=withastro%2Fastro)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[withastro](/withastro)
/
**[astro](/withastro/astro)**
Public

* [Notifications](/login?return_to=%2Fwithastro%2Fastro) You must be signed in to change notification settings
* [Fork
  2.6k](/login?return_to=%2Fwithastro%2Fastro)
* [Star
   48.4k](/login?return_to=%2Fwithastro%2Fastro)

* [Code](/withastro/astro)
* [Issues
  138](/withastro/astro/issues)
* [Pull requests
  33](/withastro/astro/pulls)
* [Actions](/withastro/astro/actions)
* [Projects
  0](/withastro/astro/projects)
* [Security](/withastro/astro/security)
* [Insights](/withastro/astro/pulse)

Additional navigation options

* [Code](/withastro/astro)
* [Issues](/withastro/astro/issues)
* [Pull requests](/withastro/astro/pulls)
* [Actions](/withastro/astro/actions)
* [Projects](/withastro/astro/projects)
* [Security](/withastro/astro/security)
* [Insights](/withastro/astro/pulse)

## Files

 176fe9f
## Breadcrumbs

1. [astro](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c)
2. /[packages](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages)
3. /[astro](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro)
4. /[src](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro/src)
5. /[core](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro/src/core)
6. /[build](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro/src/core/build)
/
# static-build.ts

Copy path Blame  Blame
## Latest commit

## History

[History](/withastro/astro/commits/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro/src/core/build/static-build.ts)475 lines (436 loc) · 16.9 KB 176fe9f
## Breadcrumbs

1. [astro](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c)
2. /[packages](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages)
3. /[astro](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro)
4. /[src](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro/src)
5. /[core](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro/src/core)
6. /[build](/withastro/astro/tree/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro/src/core/build)
/
# static-build.ts

Top
## File metadata and controls

* Code
* Blame

475 lines (436 loc) · 16.9 KB[Raw](https://github.com/withastro/astro/raw/176fe9f113fd912f9b61e848b00bbcfecd6d5c2c/packages/astro/src/core/build/static-build.ts)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475import fs from 'node:fs';import path from 'node:path';import { fileURLToPath, pathToFileURL } from 'node:url';import { teardown } from '@astrojs/compiler';import glob from 'fast-glob';import { bgGreen, black, green } from 'kleur/colors';import \* as vite from 'vite';import { type BuildInternals, createBuildInternals } from '../../core/build/internal.js';import { emptyDir, removeEmptyDirs } from '../../core/fs/index.js';import { appendForwardSlash, prependForwardSlash } from '../../core/path.js';import { runHookBuildSetup } from '../../integrations/hooks.js';import { getOutputDirectory } from '../../prerender/utils.js';import type { RouteData } from '../../types/public/internal.js';import { PAGE\_SCRIPT\_ID } from '../../vite-plugin-scripts/index.js';import { routeIsRedirect } from '../redirects/index.js';import { getOutDirWithinCwd } from './common.js';import { CHUNKS\_PATH } from './consts.js';import { generatePages } from './generate.js';import { trackPageData } from './internal.js';import { type AstroBuildPluginContainer, createPluginContainer } from './plugin.js';import { registerAllPlugins } from './plugins/index.js';import { RESOLVED\_SSR\_MANIFEST\_VIRTUAL\_MODULE\_ID } from './plugins/plugin-manifest.js';import { ASTRO\_PAGE\_RESOLVED\_MODULE\_ID } from './plugins/plugin-pages.js';import { RESOLVED\_RENDERERS\_MODULE\_ID } from './plugins/plugin-renderers.js';import { RESOLVED\_SSR\_VIRTUAL\_MODULE\_ID } from './plugins/plugin-ssr.js';import { ASTRO\_PAGE\_EXTENSION\_POST\_PATTERN } from './plugins/util.js';import type { StaticBuildOptions } from './types.js';import { encodeName, getTimeStat, viteBuildReturnToRollupOutputs } from './util.js';
export async function viteBuild(opts: StaticBuildOptions) { const { allPages, settings } = opts;
 settings.timer.start('SSR build');
 // The pages to be built for rendering purposes. // (comment above may be outdated ?) const pageInput = new Set<string>();
 // Build internals needed by the CSS plugin const internals = createBuildInternals();
 for (const pageData of Object.values(allPages)) { const astroModuleURL = new URL('./' + pageData.component, settings.config.root); const astroModuleId = prependForwardSlash(pageData.component);
 // Track the page data in internals trackPageData(internals, pageData.component, pageData, astroModuleId, astroModuleURL);
 if (!routeIsRedirect(pageData.route)) { pageInput.add(astroModuleId); } }
 // Empty out the dist folder, if needed. Vite has a config for doing this // but because we are running 2 vite builds in parallel, that would cause a race // condition, so we are doing it ourselves if (settings.config?.vite?.build?.emptyOutDir !== false) { emptyDir(settings.config.outDir, new Set('.git')); }
 // Register plugins const container = createPluginContainer(opts, internals); registerAllPlugins(container); // Build your project (SSR application code, assets, client JS, etc.) const ssrTime = performance.now(); opts.logger.info('build', `Building ${settings.config.output} entrypoints...`); const ssrOutput = await ssrBuild(opts, internals, pageInput, container); opts.logger.info('build', green(`✓ Completed in ${getTimeStat(ssrTime, performance.now())}.`));
 settings.timer.end('SSR build');
 settings.timer.start('Client build');
 const rendererClientEntrypoints = settings.renderers .map((r) => r.clientEntrypoint) .filter((a) => typeof a === 'string') as string[];
 const clientInput = new Set([ ...internals.discoveredHydratedComponents.keys(), ...internals.discoveredClientOnlyComponents.keys(), ...rendererClientEntrypoints, ...internals.discoveredScripts, ]);
 if (settings.scripts.some((script) => script.stage === 'page')) { clientInput.add(PAGE\_SCRIPT\_ID); }
 // Run client build first, so the assets can be fed into the SSR rendered version. const clientOutput = await clientBuild(opts, internals, clientInput, container);
 const ssrOutputs = viteBuildReturnToRollupOutputs(ssrOutput); const clientOutputs = viteBuildReturnToRollupOutputs(clientOutput ?? []); await runPostBuildHooks(container, ssrOutputs, clientOutputs); let contentFileNames: string[] | undefined = undefined; settings.timer.end('Client build');
 // Free up memory internals.ssrEntryChunk = undefined; if (opts.teardownCompiler) { teardown(); }
 // For static builds, the SSR output won't be needed anymore after page generation. // We keep track of the names here so we only remove these specific files when finished. const ssrOutputChunkNames: string[] = []; const ssrOutputAssetNames: string[] = []; for (const output of ssrOutputs) { for (const chunk of output.output) { if (chunk.type === 'chunk') { ssrOutputChunkNames.push(chunk.fileName); } if (chunk.type === 'asset') { ssrOutputAssetNames.push(chunk.fileName); } } }
 return { internals, ssrOutputChunkNames, ssrOutputAssetNames, contentFileNames };}
export async function staticBuild( opts: StaticBuildOptions, internals: BuildInternals, ssrOutputChunkNames: string[], ssrOutputAssetNames: string[], contentFileNames?: string[],) { const { settings } = opts; if (settings.buildOutput === 'static') { settings.timer.start('Static generate'); await generatePages(opts, internals); await cleanServerOutput(opts, ssrOutputChunkNames, contentFileNames, internals); settings.timer.end('Static generate'); } else if (settings.buildOutput === 'server') { settings.timer.start('Server generate'); await generatePages(opts, internals); await cleanStaticOutput(opts, internals); await ssrMoveAssets(opts, ssrOutputAssetNames); settings.timer.end('Server generate'); }}
async function ssrBuild( opts: StaticBuildOptions, internals: BuildInternals, input: Set<string>, container: AstroBuildPluginContainer,) { const { allPages, settings, viteConfig } = opts; const ssr = settings.buildOutput === 'server'; const out = getOutputDirectory(settings); const routes = Object.values(allPages).flatMap((pageData) => pageData.route); const { lastVitePlugins, vitePlugins } = await container.runBeforeHook('server', input); const viteBuildConfig: vite.InlineConfig = { ...viteConfig, logLevel: viteConfig.logLevel ?? 'error', build: { target: 'esnext', // Vite defaults cssMinify to false in SSR by default, but we want to minify it // as the CSS generated are used and served to the client. cssMinify: viteConfig.build?.minify == null ? true : !!viteConfig.build?.minify, ...viteConfig.build, emptyOutDir: false, manifest: false, outDir: fileURLToPath(out), copyPublicDir: !ssr, rollupOptions: { ...viteConfig.build?.rollupOptions, // Setting as `exports-only` allows us to safely delete inputs that are only used during prerendering preserveEntrySignatures: 'exports-only', input: [], output: { hoistTransitiveImports: false, format: 'esm', minifyInternalExports: true, // Server chunks can't go in the assets (\_astro) folder // We need to keep these separate chunkFileNames(chunkInfo) { const { name } = chunkInfo; let prefix = CHUNKS\_PATH; let suffix = '\_[hash].mjs';
 // Sometimes chunks have the `@\_@astro` suffix due to SSR logic. Remove it! // TODO: refactor our build logic to avoid this if (name.includes(ASTRO\_PAGE\_EXTENSION\_POST\_PATTERN)) { const [sanitizedName] = name.split(ASTRO\_PAGE\_EXTENSION\_POST\_PATTERN); return [prefix, sanitizedName, suffix].join(''); } // Injected routes include "pages/[name].[ext]" already. Clean those up! if (name.startsWith('pages/')) { const sanitizedName = name.split('.')[0]; return [prefix, sanitizedName, suffix].join(''); } const encoded = encodeName(name); return [prefix, encoded, suffix].join(''); }, assetFileNames: `${settings.config.build.assets}/[name].[hash][extname]`, ...viteConfig.build?.rollupOptions?.output, entryFileNames(chunkInfo) { if (chunkInfo.facadeModuleId?.startsWith(ASTRO\_PAGE\_RESOLVED\_MODULE\_ID)) { return makeAstroPageEntryPointFileName( ASTRO\_PAGE\_RESOLVED\_MODULE\_ID, chunkInfo.facadeModuleId, routes, ); } else if (chunkInfo.facadeModuleId === RESOLVED\_SSR\_VIRTUAL\_MODULE\_ID) { return opts.settings.config.build.serverEntry; } else if (chunkInfo.facadeModuleId === RESOLVED\_RENDERERS\_MODULE\_ID) { return 'renderers.mjs'; } else if (chunkInfo.facadeModuleId === RESOLVED\_SSR\_MANIFEST\_VIRTUAL\_MODULE\_ID) { return 'manifest\_[hash].mjs'; } else if (chunkInfo.facadeModuleId === settings.adapter?.serverEntrypoint) { return 'adapter\_[hash].mjs'; } else { return '[name].mjs'; } }, }, }, ssr: true, ssrEmitAssets: true, // improve build performance minify: false, modulePreload: { polyfill: false }, reportCompressedSize: false, }, plugins: [...vitePlugins, ...(viteConfig.plugins || []), ...lastVitePlugins], envPrefix: viteConfig.envPrefix ?? 'PUBLIC\_', base: settings.config.base, };
 const updatedViteBuildConfig = await runHookBuildSetup({ config: settings.config, pages: internals.pagesByKeys, vite: viteBuildConfig, target: 'server', logger: opts.logger, });
 return await vite.build(updatedViteBuildConfig);}
async function clientBuild( opts: StaticBuildOptions, internals: BuildInternals, input: Set<string>, container: AstroBuildPluginContainer,) { const { settings, viteConfig } = opts; const ssr = settings.buildOutput === 'server'; const out = ssr ? settings.config.build.client : getOutDirWithinCwd(settings.config.outDir);
 // Nothing to do if there is no client-side JS. if (!input.size) { // If SSR, copy public over if (ssr) { await copyFiles(settings.config.publicDir, out, true); }
 return null; }
 const { lastVitePlugins, vitePlugins } = await container.runBeforeHook('client', input); opts.logger.info('SKIP\_FORMAT', `\n${bgGreen(black(' building client (vite) '))}`);
 const viteBuildConfig: vite.InlineConfig = { ...viteConfig, build: { target: 'esnext', ...viteConfig.build, emptyOutDir: false, outDir: fileURLToPath(out), copyPublicDir: ssr, rollupOptions: { ...viteConfig.build?.rollupOptions, input: Array.from(input), output: { format: 'esm', entryFileNames: `${settings.config.build.assets}/[name].[hash].js`, chunkFileNames: `${settings.config.build.assets}/[name].[hash].js`, assetFileNames: `${settings.config.build.assets}/[name].[hash][extname]`, ...viteConfig.build?.rollupOptions?.output, }, preserveEntrySignatures: 'exports-only', }, }, plugins: [...vitePlugins, ...(viteConfig.plugins || []), ...lastVitePlugins], envPrefix: viteConfig.envPrefix ?? 'PUBLIC\_', base: settings.config.base, };
 await runHookBuildSetup({ config: settings.config, pages: internals.pagesByKeys, vite: viteBuildConfig, target: 'client', logger: opts.logger, });
 const buildResult = await vite.build(viteBuildConfig); return buildResult;}
async function runPostBuildHooks( container: AstroBuildPluginContainer, ssrOutputs: vite.Rollup.RollupOutput[], clientOutputs: vite.Rollup.RollupOutput[],) { const mutations = await container.runPostHook(ssrOutputs, clientOutputs); const config = container.options.settings.config; const build = container.options.settings.config.build; for (const [fileName, mutation] of mutations) { const root = container.options.settings.buildOutput === 'server' ? mutation.targets.includes('server') ? build.server : build.client : getOutDirWithinCwd(config.outDir); const fullPath = path.join(fileURLToPath(root), fileName); const fileURL = pathToFileURL(fullPath); await fs.promises.mkdir(new URL('./', fileURL), { recursive: true }); await fs.promises.writeFile(fileURL, mutation.code, 'utf-8'); }}
/\*\* \* Remove chunks that are used for prerendering only \*/async function cleanStaticOutput(opts: StaticBuildOptions, internals: BuildInternals) { const ssr = opts.settings.buildOutput === 'server'; const out = ssr ? opts.settings.config.build.server : getOutDirWithinCwd(opts.settings.config.outDir); await Promise.all( internals.prerenderOnlyChunks.map(async (chunk) => { const url = new URL(chunk.fileName, out); try { // Entry chunks may be referenced by non-deleted code, so we don't actually delete it // but only empty its content. These chunks should never be executed in practice, but // it should prevent broken import paths if adapters do a secondary bundle. if (chunk.isEntry || chunk.isDynamicEntry) { await fs.promises.writeFile( url, "// Contents removed by Astro as it's used for prerendering only", 'utf-8', ); } else { await fs.promises.unlink(url); } } catch { // Best-effort only. Sometimes some chunks may be deleted by other plugins, like pure CSS chunks, // so they may already not exist. } }), );}
async function cleanServerOutput( opts: StaticBuildOptions, ssrOutputChunkNames: string[], contentFileNames: string[] | undefined, internals: BuildInternals,) { const out = getOutDirWithinCwd(opts.settings.config.outDir); // The SSR output chunks for Astro are all .mjs files const files = ssrOutputChunkNames .filter((f) => f.endsWith('.mjs')) .concat(contentFileNames ?? []); if (internals.manifestFileName) { files.push(internals.manifestFileName); } if (files.length) { // Remove all the SSR generated .mjs files await Promise.all( files.map(async (filename) => { const url = new URL(filename, out); await fs.promises.rm(url); }), );
 removeEmptyDirs(fileURLToPath(out)); }
 // Clean out directly if the outDir is outside of root if (out.toString() !== opts.settings.config.outDir.toString()) { // Remove .d.ts files const fileNames = await fs.promises.readdir(out); await Promise.all( fileNames .filter((fileName) => fileName.endsWith('.d.ts')) .map((fileName) => fs.promises.rm(new URL(fileName, out))), ); // Copy assets before cleaning directory if outside root await copyFiles(out, opts.settings.config.outDir, true); await fs.promises.rm(out, { recursive: true }); return; }}
export async function copyFiles(fromFolder: URL, toFolder: URL, includeDotfiles = false) { const files = await glob('\*\*/\*', { cwd: fileURLToPath(fromFolder), dot: includeDotfiles, }); if (files.length === 0) return; return await Promise.all( files.map(async function copyFile(filename) { const from = new URL(filename, fromFolder); const to = new URL(filename, toFolder); const lastFolder = new URL('./', to); return fs.promises.mkdir(lastFolder, { recursive: true }).then(async function fsCopyFile() { const p = await fs.promises.copyFile(from, to, fs.constants.COPYFILE\_FICLONE); return p; }); }), );}
async function ssrMoveAssets(opts: StaticBuildOptions, ssrOutputAssetNames: string[]) { opts.logger.info('build', 'Rearranging server assets...'); const serverRoot = opts.settings.buildOutput === 'static' ? opts.settings.config.build.client : opts.settings.config.build.server; const clientRoot = opts.settings.config.build.client; if (ssrOutputAssetNames.length > 0) { await Promise.all( ssrOutputAssetNames.map(async function moveAsset(filename) { const currentUrl = new URL(filename, appendForwardSlash(serverRoot.toString())); const clientUrl = new URL(filename, appendForwardSlash(clientRoot.toString())); const dir = new URL(path.parse(clientUrl.href).dir); // It can't find this file because the user defines a custom path // that includes the folder paths in `assetFileNames` if (!fs.existsSync(dir)) await fs.promises.mkdir(dir, { recursive: true }); return fs.promises.rename(currentUrl, clientUrl); }), ); removeEmptyDirs(fileURLToPath(serverRoot)); }}
/\*\* \* This function takes the virtual module name of any page entrypoint and \* transforms it to generate a final `.mjs` output file. \* \* Input: `@astro-page:src/pages/index@\_@astro` \* Output: `pages/index.astro.mjs` \* Input: `@astro-page:../node\_modules/my-dep/injected@\_@astro` \* Output: `pages/injected.mjs` \* \* 1. We clean the `facadeModuleId` by removing the `ASTRO\_PAGE\_MODULE\_ID` prefix and `ASTRO\_PAGE\_EXTENSION\_POST\_PATTERN`. \* 2. We find the matching route pattern in the manifest (or fallback to the cleaned module id) \* 3. We replace square brackets with underscore (`[slug]` => `\_slug\_`) and `...` with `` (`[...slug]` => `\_---slug\_`). \* 4. We append the `.mjs` extension, so the file will always be an ESM module \* \* @param prefix string \* @param facadeModuleId string \* @param pages AllPagesData \*/export function makeAstroPageEntryPointFileName( prefix: string, facadeModuleId: string, routes: RouteData[],) { const pageModuleId = facadeModuleId .replace(prefix, '') .replace(ASTRO\_PAGE\_EXTENSION\_POST\_PATTERN, '.'); const route = routes.find((routeData) => routeData.component === pageModuleId); const name = route?.route ?? pageModuleId; return `pages${name .replace(/\/$/, '/index') .replaceAll(/[[\]]/g, '\_') .replaceAll('...', '---')}.astro.mjs`;}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_697f67c2_20250114_223325.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgetsentry%2Fsentry-javascript%2Fblob%2Fdevelop%2Fpackages%2Fastro%2Fsrc%2Fintegration%2Findex.ts)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgetsentry%2Fsentry-javascript%2Fblob%2Fdevelop%2Fpackages%2Fastro%2Fsrc%2Fintegration%2Findex.ts)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=getsentry%2Fsentry-javascript)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[getsentry](/getsentry)
/
**[sentry-javascript](/getsentry/sentry-javascript)**
Public

* [Notifications](/login?return_to=%2Fgetsentry%2Fsentry-javascript) You must be signed in to change notification settings
* [Fork
  1.6k](/login?return_to=%2Fgetsentry%2Fsentry-javascript)
* [Star
   8.1k](/login?return_to=%2Fgetsentry%2Fsentry-javascript)

* [Code](/getsentry/sentry-javascript)
* [Issues
  342](/getsentry/sentry-javascript/issues)
* [Pull requests
  55](/getsentry/sentry-javascript/pulls)
* [Discussions](/getsentry/sentry-javascript/discussions)
* [Actions](/getsentry/sentry-javascript/actions)
* [Projects
  0](/getsentry/sentry-javascript/projects)
* [Security](/getsentry/sentry-javascript/security)
* [Insights](/getsentry/sentry-javascript/pulse)

Additional navigation options

* [Code](/getsentry/sentry-javascript)
* [Issues](/getsentry/sentry-javascript/issues)
* [Pull requests](/getsentry/sentry-javascript/pulls)
* [Discussions](/getsentry/sentry-javascript/discussions)
* [Actions](/getsentry/sentry-javascript/actions)
* [Projects](/getsentry/sentry-javascript/projects)
* [Security](/getsentry/sentry-javascript/security)
* [Insights](/getsentry/sentry-javascript/pulse)

## Files

 develop
## Breadcrumbs

1. [sentry-javascript](/getsentry/sentry-javascript/tree/develop)
2. /[packages](/getsentry/sentry-javascript/tree/develop/packages)
3. /[astro](/getsentry/sentry-javascript/tree/develop/packages/astro)
4. /[src](/getsentry/sentry-javascript/tree/develop/packages/astro/src)
5. /[integration](/getsentry/sentry-javascript/tree/develop/packages/astro/src/integration)
/
# index.ts

Copy path Blame  Blame
## Latest commit

## History

[History](/getsentry/sentry-javascript/commits/develop/packages/astro/src/integration/index.ts)257 lines (223 loc) · 11.1 KB develop
## Breadcrumbs

1. [sentry-javascript](/getsentry/sentry-javascript/tree/develop)
2. /[packages](/getsentry/sentry-javascript/tree/develop/packages)
3. /[astro](/getsentry/sentry-javascript/tree/develop/packages/astro)
4. /[src](/getsentry/sentry-javascript/tree/develop/packages/astro/src)
5. /[integration](/getsentry/sentry-javascript/tree/develop/packages/astro/src/integration)
/
# index.ts

Top
## File metadata and controls

* Code
* Blame

257 lines (223 loc) · 11.1 KB[Raw](https://github.com/getsentry/sentry-javascript/raw/refs/heads/develop/packages/astro/src/integration/index.ts)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257import \* as fs from 'fs';import \* as path from 'path';import { sentryVitePlugin } from '@sentry/vite-plugin';import type { AstroConfig, AstroIntegration } from 'astro';
import { consoleSandbox, dropUndefinedKeys } from '@sentry/core';import { buildClientSnippet, buildSdkInitFileImportSnippet, buildServerSnippet } from './snippets';import type { SentryOptions } from './types';
const PKG\_NAME = '@sentry/astro';
export const sentryAstro = (options: SentryOptions = {}): AstroIntegration => { return { name: PKG\_NAME, hooks: { // eslint-disable-next-line complexity 'astro:config:setup': async ({ updateConfig, injectScript, addMiddleware, config, command, logger }) => { // The third param here enables loading of all env vars, regardless of prefix // see: https://main.vitejs.dev/config/#using-environment-variables-in-config
 // TODO: Ideally, we want to load the environment with vite like this: // const env = loadEnv('production', process.cwd(), ''); // However, this currently throws a build error. // Will revisit this later. const env = process.env;
 const sdkEnabled = { client: typeof options.enabled === 'boolean' ? options.enabled : options.enabled?.client ?? true, server: typeof options.enabled === 'boolean' ? options.enabled : options.enabled?.server ?? true, };
 const sourceMapsNeeded = sdkEnabled.client || sdkEnabled.server; const uploadOptions = options.sourceMapsUploadOptions || {}; const shouldUploadSourcemaps = (sourceMapsNeeded && uploadOptions?.enabled) ?? true;
 // We don't need to check for AUTH\_TOKEN here, because the plugin will pick it up from the env if (shouldUploadSourcemaps && command !== 'dev') { const computedSourceMapSettings = getUpdatedSourceMapSettings(config, options);
 let updatedFilesToDeleteAfterUpload: string[] | undefined = undefined;
 if ( typeof uploadOptions?.filesToDeleteAfterUpload === 'undefined' && computedSourceMapSettings.previousUserSourceMapSetting === 'unset' ) { // This also works for adapters, as the source maps are also copied to e.g. the .vercel folder updatedFilesToDeleteAfterUpload = ['./dist/\*\*/client/\*\*/\*.map', './dist/\*\*/server/\*\*/\*.map'];
 consoleSandbox(() => { // eslint-disable-next-line no-console console.log( `[Sentry] Automatically setting \`sourceMapsUploadOptions.filesToDeleteAfterUpload: ${JSON.stringify( updatedFilesToDeleteAfterUpload, )}\` to delete generated source maps after they were uploaded to Sentry.`, ); }); }
 updateConfig({ vite: { build: { sourcemap: computedSourceMapSettings.updatedSourceMapSetting, }, plugins: [ sentryVitePlugin( dropUndefinedKeys({ org: uploadOptions.org ?? env.SENTRY\_ORG, project: uploadOptions.project ?? env.SENTRY\_PROJECT, authToken: uploadOptions.authToken ?? env.SENTRY\_AUTH\_TOKEN, telemetry: uploadOptions.telemetry ?? true, sourcemaps: { assets: uploadOptions.assets ?? [getSourcemapsAssetsGlob(config)], filesToDeleteAfterUpload: uploadOptions?.filesToDeleteAfterUpload ?? updatedFilesToDeleteAfterUpload, }, bundleSizeOptimizations: { ...options.bundleSizeOptimizations, // TODO: with a future version of the vite plugin (probably 2.22.0) this re-mapping is not needed anymore // ref: https://github.com/getsentry/sentry-javascript-bundler-plugins/pull/582 excludePerformanceMonitoring: options.bundleSizeOptimizations?.excludeTracing, }, \_metaOptions: { telemetry: { metaFramework: 'astro', }, }, debug: options.debug ?? false, }), ), ], }, }); }
 if (sdkEnabled.client) { const pathToClientInit = options.clientInitPath ? path.resolve(options.clientInitPath) : findDefaultSdkInitFile('client');
 if (pathToClientInit) { options.debug && logger.info(`Using ${pathToClientInit} for client init.`); injectScript('page', buildSdkInitFileImportSnippet(pathToClientInit)); } else { options.debug && logger.info('Using default client init.'); injectScript('page', buildClientSnippet(options || {})); } }
 if (sdkEnabled.server) { const pathToServerInit = options.serverInitPath ? path.resolve(options.serverInitPath) : findDefaultSdkInitFile('server'); if (pathToServerInit) { options.debug && logger.info(`Using ${pathToServerInit} for server init.`); injectScript('page-ssr', buildSdkInitFileImportSnippet(pathToServerInit)); } else { options.debug && logger.info('Using default server init.'); injectScript('page-ssr', buildServerSnippet(options || {})); }
 // Prevent Sentry from being externalized for SSR. // Cloudflare like environments have Node.js APIs are available under `node:` prefix. // Ref: https://developers.cloudflare.com/workers/runtime-apis/nodejs/ if (config?.adapter?.name.startsWith('@astrojs/cloudflare')) { updateConfig({ vite: { ssr: { // @sentry/node is required in case we have 2 different @sentry/node // packages installed in the same project. // Ref: https://github.com/getsentry/sentry-javascript/issues/10121 noExternal: ['@sentry/astro', '@sentry/node'], }, }, }); } }
 const isSSR = config && (config.output === 'server' || config.output === 'hybrid'); const shouldAddMiddleware = sdkEnabled.server && options.autoInstrumentation?.requestHandler !== false;
 // Guarding calling the addMiddleware function because it was only introduced in astro@3.5.0 // Users on older versions of astro will need to add the middleware manually. const supportsAddMiddleware = typeof addMiddleware === 'function';
 if (supportsAddMiddleware && isSSR && shouldAddMiddleware) { addMiddleware({ order: 'pre', entrypoint: '@sentry/astro/middleware', }); } }, }, };};
const possibleFileExtensions = ['ts', 'js', 'tsx', 'jsx', 'mjs', 'cjs', 'mts'];
function findDefaultSdkInitFile(type: 'server' | 'client'): string | undefined { const cwd = process.cwd(); return possibleFileExtensions .map(e => path.resolve(path.join(cwd, `sentry.${type}.config.${e}`))) .find(filename => fs.existsSync(filename));}
function getSourcemapsAssetsGlob(config: AstroConfig): string { // The vercel adapter puts the output into its .vercel directory // However, the way this adapter is written, the config.outDir value is update too late for // us to reliably detect it. Also, server files are first temporarily written to <root>/dist and then // only copied over to <root>/.vercel. This seems to happen too late though. // So we glob on both of these directories. // Another case of "it ain't pretty but it works":( if (config.adapter?.name?.startsWith('@astrojs/vercel')) { return '{.vercel,dist}/\*\*/\*'; }
 // paths are stored as "file://" URLs const outDirPathname = config.outDir && path.resolve(config.outDir.pathname); const rootDirName = path.resolve(config.root?.pathname || process.cwd());
 if (outDirPathname) { const relativePath = path.relative(rootDirName, outDirPathname); return `${relativePath}/\*\*/\*`; }
 // fallback to default output dir return 'dist/\*\*/\*';}
/\*\* \* Whether the user enabled (true, 'hidden', 'inline') or disabled (false) source maps \*/export type UserSourceMapSetting = 'enabled' | 'disabled' | 'unset' | undefined;
/\*\* There are 3 ways to set up source map generation (https://github.com/getsentry/sentry-javascript/issues/13993) \* \* 1. User explicitly disabled source maps \* - keep this setting (emit a warning that errors won't be unminified in Sentry) \* - We won't upload anything \* \* 2. Users enabled source map generation (true, 'hidden', 'inline'). \* - keep this setting (don't do anything - like deletion - besides uploading) \* \* 3. Users didn't set source maps generation \* - we enable 'hidden' source maps generation \* - configure `filesToDeleteAfterUpload` to delete all .map files (we emit a log about this) \* \* --> only exported for testing \*/export function getUpdatedSourceMapSettings( astroConfig: AstroConfig, sentryOptions?: SentryOptions,): { previousUserSourceMapSetting: UserSourceMapSetting; updatedSourceMapSetting: boolean | 'inline' | 'hidden' } { let previousUserSourceMapSetting: UserSourceMapSetting = undefined;
 astroConfig.build = astroConfig.build || {};
 const viteSourceMap = astroConfig?.vite?.build?.sourcemap; let updatedSourceMapSetting = viteSourceMap;
 const settingKey = 'vite.build.sourcemap';
 if (viteSourceMap === false) { previousUserSourceMapSetting = 'disabled'; updatedSourceMapSetting = viteSourceMap;
 consoleSandbox(() => { // eslint-disable-next-line no-console console.warn( `[Sentry] Source map generation is currently disabled in your Astro configuration (\`${settingKey}: false\`). This setting is either a default setting or was explicitly set in your configuration. Sentry won't override this setting. Without source maps, code snippets on the Sentry Issues page will remain minified. To show unminified code, enable source maps in \`${settingKey}\` (e.g. by setting them to \`hidden\`).`, ); }); } else if (viteSourceMap && ['hidden', 'inline', true].includes(viteSourceMap)) { previousUserSourceMapSetting = 'enabled'; updatedSourceMapSetting = viteSourceMap;
 if (sentryOptions?.debug) { consoleSandbox(() => { // eslint-disable-next-line no-console console.log( `[Sentry] We discovered \`${settingKey}\` is set to \`${viteSourceMap.toString()}\`. Sentry will keep this source map setting. This will un-minify the code snippet on the Sentry Issue page.`, ); }); } } else { previousUserSourceMapSetting = 'unset'; updatedSourceMapSetting = 'hidden';
 consoleSandbox(() => { // eslint-disable-next-line no-console console.log( `[Sentry] Enabled source map generation in the build options with \`${settingKey}: 'hidden'\`. The source maps will be deleted after they were uploaded to Sentry.`, ); }); }
 return { previousUserSourceMapSetting, updatedSourceMapSetting };}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_fae21e73_20250114_223329.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwithastro%2Fastro%2Fissues%2F12703)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwithastro%2Fastro%2Fissues%2F12703)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=withastro%2Fastro)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[withastro](/withastro)
/
**[astro](/withastro/astro)**
Public

* [Notifications](/login?return_to=%2Fwithastro%2Fastro) You must be signed in to change notification settings
* [Fork
  2.6k](/login?return_to=%2Fwithastro%2Fastro)
* [Star
   48.4k](/login?return_to=%2Fwithastro%2Fastro)

* [Code](/withastro/astro)
* [Issues
  138](/withastro/astro/issues)
* [Pull requests
  33](/withastro/astro/pulls)
* [Actions](/withastro/astro/actions)
* [Projects
  0](/withastro/astro/projects)
* [Security](/withastro/astro/security)
* [Insights](/withastro/astro/pulse)

Additional navigation options

* [Code](/withastro/astro)
* [Issues](/withastro/astro/issues)
* [Pull requests](/withastro/astro/pulls)
* [Actions](/withastro/astro/actions)
* [Projects](/withastro/astro/projects)
* [Security](/withastro/astro/security)
* [Insights](/withastro/astro/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fwithastro%2Fastro%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fwithastro%2Fastro%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Astro 5 breaks sourcemaps #12703

Closed

1 task

[lilnasy](/lilnasy) opened this issue
Dec 10, 2024
· 2 comments
 · Fixed by [#12877](https://github.com/withastro/astro/pull/12877)

Closed

1 task

# [Astro 5 breaks sourcemaps](#top) #12703

[lilnasy](/lilnasy) opened this issue
Dec 10, 2024
· 2 comments
 · Fixed by [#12877](https://github.com/withastro/astro/pull/12877)

Labels
[- P3: minor bug](/withastro/astro/labels/-%20P3%3A%20minor%20bug)
An edge case that only affects very specific usage (priority)
[feat: server islands](/withastro/astro/labels/feat%3A%20server%20islands)
Related to Server Islands (scope)

## Comments

[![@lilnasy](https://avatars.githubusercontent.com/u/69170106?s=80&v=4)](/lilnasy)

Copy link

Contributor

### **[lilnasy](/lilnasy)** commented [Dec 10, 2024](#issue-2728704562)

| Astro Info ``` Astro                    v5.0.4 Node                     v18.20.3 System                   Linux (x64) Package Manager          npm Output                   static Adapter                  @astrojs/node Integrations             none  ``` If this issue only occurs in one browser, which browser is a problem? *No response* Describe the Bug The logs report sourcemaps may be broken because of server islands.  ``` 06:46:03 [build] Building static entrypoints... [plugin astro:server-islands] Sourcemap is likely to be incorrect: a plugin (astro:server-islands) was used to transform files, but didn't generate a sourcemap for the transformation. Consult the plugin documentation for help 06:46:10 [vite] ✓ built in 5.94s  ```  And in fact, they are. error stacktraces show compiled locations. [image](https://private-user-images.githubusercontent.com/69170106/394069321-499260c4-e673-4348-8bb5-93cf23553b90.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY4OTQzMDgsIm5iZiI6MTczNjg5NDAwOCwicGF0aCI6Ii82OTE3MDEwNi8zOTQwNjkzMjEtNDk5MjYwYzQtZTY3My00MzQ4LThiYjUtOTNjZjIzNTUzYjkwLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTE0VDIyMzMyOFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTc5NGY1YTcxNjlmN2VkMzUzODEwOThiNjVkNDcwNWQyNGM0YTAzOWZiMjdjZDRhOGViNjdjMGY4NWY3MDY4ZjMmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.FRy3FLwmwtknM0Frm6FUliiwPZDayDj9hDHnejXQ0pI) What's the expected result? The same result from Astro 4  [image](https://private-user-images.githubusercontent.com/69170106/394069492-ea1a5428-de83-4d9a-8fc8-f785913e2523.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY4OTQzMDgsIm5iZiI6MTczNjg5NDAwOCwicGF0aCI6Ii82OTE3MDEwNi8zOTQwNjk0OTItZWExYTU0MjgtZGU4My00ZDlhLThmYzgtZjc4NTkxM2UyNTIzLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTE0VDIyMzMyOFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWYwZTVhYTQ1OWJkY2FmODc0NjM0YWM5NDUwZWM0NTNkNjQwOTM5YTJkZjI2OTFkMjcwMzI1MGRlNTNlYjY0MWEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.8tiOeNBTDgdId8DMNV3RlslNVuwX-HsOj2PBQgNejhk) Link to Minimal Reproducible Example <https://stackblitz.com/edit/github-gvpoqswg?file=astro.config.mjs,src%2Fpages%2Findex.astro&on=stackblitz> Participation  * I am willing to submit a pull request for this issue. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
added
the
[needs triage](/withastro/astro/labels/needs%20triage)
Issue needs to be triaged
label
[Dec 10, 2024](#event-15592969133)

[![@ascorbic](https://avatars.githubusercontent.com/u/213306?s=40&u=82654af51549dc9ed1544157a9f879b89e7b1d48&v=4)](/ascorbic)
[ascorbic](/ascorbic)
added
[feat: server islands](/withastro/astro/labels/feat%3A%20server%20islands)
Related to Server Islands (scope)
[- P3: minor bug](/withastro/astro/labels/-%20P3%3A%20minor%20bug)
An edge case that only affects very specific usage (priority)
and removed
[needs triage](/withastro/astro/labels/needs%20triage)
Issue needs to be triaged
labels
[Dec 10, 2024](#event-15602521381)

[lilnasy](/lilnasy)
added a commit
to lilnasy/tic-tac-toe
that referenced
this issue
[Dec 14, 2024](#ref-commit-b6daf0b)
[![@lilnasy](https://avatars.githubusercontent.com/u/69170106?s=40&v=4)](/lilnasy)

`[prevent warning from](/lilnasy/tic-tac-toe/commit/b6daf0b1cb610cf5e33cb97f6f081e71a31fe9c0 "prevent warning from https://github.com/withastro/astro/issues/12703") [withastro/astro#12703](https://github.com/withastro/astro/issues/12703)`

`[b6daf0b](/lilnasy/tic-tac-toe/commit/b6daf0b1cb610cf5e33cb97f6f081e71a31fe9c0)`

[![@jorgeluiz1586](https://avatars.githubusercontent.com/u/50534419?s=80&u=bb8b8e30bfdb2a1b72f77fb5fdd0c670cb65783d&v=4)](/jorgeluiz1586)

Copy link

### **[jorgeluiz1586](/jorgeluiz1586)** commented [Dec 16, 2024](#issuecomment-2546624391)

| Hello, I'm having the same problem, when I updated Astro and Vite to the latest version, I saw that new commits were uploaded but the error persists. |
| --- |

All reactions

Sorry, something went wrong.

[![@lilnasy](https://avatars.githubusercontent.com/u/69170106?s=80&v=4)](/lilnasy)

Copy link

Contributor

Author

### **[lilnasy](/lilnasy)** commented [Dec 18, 2024](#issuecomment-2551388925)

| As of `astro@5.0.9`, it's just a warning. The sourcemaps themselves are functional. |
| --- |

 👍
1
 jorgeluiz1586 reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@bluwy](https://avatars.githubusercontent.com/u/34116392?s=40&u=b156c6773cb1d21bf37c99bd427486ce73b2173d&v=4)](/bluwy)
[bluwy](/bluwy)
mentioned this issue
[Jan 2, 2025](#ref-pullrequest-2766150168)

[Fix sourcemap warning in server islands plugin
#12877](/withastro/astro/pull/12877)
 Merged

[![@bluwy](https://avatars.githubusercontent.com/u/34116392?s=40&u=b156c6773cb1d21bf37c99bd427486ce73b2173d&v=4)](/bluwy)
[bluwy](/bluwy)
closed this as [completed](/withastro/astro/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[#12877](/withastro/astro/pull/12877)
[Jan 3, 2025](#event-15808181076)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fwithastro%2Fastro%2Fissues%2F12703)

Assignees

No one assigned

Labels

[- P3: minor bug](/withastro/astro/labels/-%20P3%3A%20minor%20bug)
An edge case that only affects very specific usage (priority)
[feat: server islands](/withastro/astro/labels/feat%3A%20server%20islands)
Related to Server Islands (scope)

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [Fix sourcemap warning in server islands plugin](/withastro/astro/pull/12877)
 [withastro/astro](/withastro/astro)

3 participants

[![@ascorbic](https://avatars.githubusercontent.com/u/213306?s=52&v=4)](/ascorbic) [![@jorgeluiz1586](https://avatars.githubusercontent.com/u/50534419?s=52&v=4)](/jorgeluiz1586) [![@lilnasy](https://avatars.githubusercontent.com/u/69170106?s=52&v=4)](/lilnasy)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


