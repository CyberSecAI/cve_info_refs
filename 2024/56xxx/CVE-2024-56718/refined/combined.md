=== Content from git.kernel.org_5f3e3139_20250114_192703.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=841b1824750d3b8d1dc0a96b14db4418b952abbc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=841b1824750d3b8d1dc0a96b14db4418b952abbc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=841b1824750d3b8d1dc0a96b14db4418b952abbc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=841b1824750d3b8d1dc0a96b14db4418b952abbc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guangguan Wang <guangguan.wang@linux.alibaba.com> | 2024-12-11 17:21:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-27 14:02:01 +0100 |
| commit | [841b1824750d3b8d1dc0a96b14db4418b952abbc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=841b1824750d3b8d1dc0a96b14db4418b952abbc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=841b1824750d3b8d1dc0a96b14db4418b952abbc)) | |
| tree | [b1f2cf14875e7c5658dd1f5f1a98bbd3279a85e6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=841b1824750d3b8d1dc0a96b14db4418b952abbc) | |
| parent | [cec68375b8e15627d96557f3ae5e3e553fad1ea9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cec68375b8e15627d96557f3ae5e3e553fad1ea9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=841b1824750d3b8d1dc0a96b14db4418b952abbc&id2=cec68375b8e15627d96557f3ae5e3e553fad1ea9)) | |
| download | [linux-841b1824750d3b8d1dc0a96b14db4418b952abbc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-841b1824750d3b8d1dc0a96b14db4418b952abbc.tar.gz) | |

net/smc: protect link down work from execute after lgr freed[ Upstream commit 2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec ]
link down work may be scheduled before lgr freed but execute
after lgr freed, which may result in crash. So it is need to
hold a reference before shedule link down work, and put the
reference after work executed or canceled.
The relevant crash call stack as follows:
list\_del corruption. prev->next should be ffffb638c9c0fe20,
but was 0000000000000000
------------[ cut here ]------------
kernel BUG at lib/list\_debug.c:51!
invalid opcode: 0000 [#1] SMP NOPTI
CPU: 6 PID: 978112 Comm: kworker/6:119 Kdump: loaded Tainted: G #1
Hardware name: Alibaba Cloud Alibaba Cloud ECS, BIOS 2221b89 04/01/2014
Workqueue: events smc\_link\_down\_work [smc]
RIP: 0010:\_\_list\_del\_entry\_valid.cold+0x31/0x47
RSP: 0018:ffffb638c9c0fdd8 EFLAGS: 00010086
RAX: 0000000000000054 RBX: ffff942fb75e5128 RCX: 0000000000000000
RDX: ffff943520930aa0 RSI: ffff94352091fc80 RDI: ffff94352091fc80
RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb638c9c0fc38
R10: ffffb638c9c0fc30 R11: ffffffffa015eb28 R12: 0000000000000002
R13: ffffb638c9c0fe20 R14: 0000000000000001 R15: ffff942f9cd051c0
FS: 0000000000000000(0000) GS:ffff943520900000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f4f25214000 CR3: 000000025fbae004 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
rwsem\_down\_write\_slowpath+0x17e/0x470
smc\_link\_down\_work+0x3c/0x60 [smc]
process\_one\_work+0x1ac/0x350
worker\_thread+0x49/0x2f0
? rescuer\_thread+0x360/0x360
kthread+0x118/0x140
? \_\_kthread\_bind\_mask+0x60/0x60
ret\_from\_fork+0x1f/0x30
Fixes: 541afa10c126 ("net/smc: add smcr\_port\_err() and smcr\_link\_down() processing")
Signed-off-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Reviewed-by: Tony Lu <tonylu@linux.alibaba.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=841b1824750d3b8d1dc0a96b14db4418b952abbc)

| -rw-r--r-- | [net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_core.c?id=841b1824750d3b8d1dc0a96b14db4418b952abbc) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 2 deletions

| diff --git a/net/smc/smc\_core.c b/net/smc/smc\_core.cindex 4e694860ece4ac..68515a41d776c4 100644--- a/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=cec68375b8e15627d96557f3ae5e3e553fad1ea9)+++ b/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=841b1824750d3b8d1dc0a96b14db4418b952abbc)@@ -1818,7 +1818,9 @@ void smcr\_link\_down\_cond\_sched(struct smc\_link \*lnk) { if (smc\_link\_downing(&lnk->state)) { trace\_smcr\_link\_down(lnk, \_\_builtin\_return\_address(0));- schedule\_work(&lnk->link\_down\_wrk);+ smcr\_link\_hold(lnk); /\* smcr\_link\_put in link\_down\_wrk \*/+ if (!schedule\_work(&lnk->link\_down\_wrk))+ smcr\_link\_put(lnk); } } @@ -1850,11 +1852,14 @@ static void smc\_link\_down\_work(struct work\_struct \*work) struct smc\_link\_group \*lgr = link->lgr;  if (list\_empty(&lgr->list))- return;+ goto out; wake\_up\_all(&lgr->llc\_msg\_waiter); down\_write(&lgr->llc\_conf\_mutex); smcr\_link\_down(link); up\_write(&lgr->llc\_conf\_mutex);++out:+ smcr\_link\_put(link); /\* smcr\_link\_hold by schedulers of link\_down\_work \*/ }  static int smc\_vlan\_by\_tcpsk\_walk(struct net\_device \*lower\_dev, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:25:40 +0000



=== Content from git.kernel.org_d4955b94_20250114_192704.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bec2f52866d511e94c1c37cd962e4382b1b1a299)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bec2f52866d511e94c1c37cd962e4382b1b1a299)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bec2f52866d511e94c1c37cd962e4382b1b1a299)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bec2f52866d511e94c1c37cd962e4382b1b1a299)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guangguan Wang <guangguan.wang@linux.alibaba.com> | 2024-12-11 17:21:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-27 13:52:53 +0100 |
| commit | [bec2f52866d511e94c1c37cd962e4382b1b1a299](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bec2f52866d511e94c1c37cd962e4382b1b1a299) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bec2f52866d511e94c1c37cd962e4382b1b1a299)) | |
| tree | [b89785232f95269cc0a50784d40292e659031012](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bec2f52866d511e94c1c37cd962e4382b1b1a299) | |
| parent | [7334f371d11aab541e6e1df90576da6ada7b2443](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7334f371d11aab541e6e1df90576da6ada7b2443) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bec2f52866d511e94c1c37cd962e4382b1b1a299&id2=7334f371d11aab541e6e1df90576da6ada7b2443)) | |
| download | [linux-bec2f52866d511e94c1c37cd962e4382b1b1a299.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bec2f52866d511e94c1c37cd962e4382b1b1a299.tar.gz) | |

net/smc: protect link down work from execute after lgr freed[ Upstream commit 2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec ]
link down work may be scheduled before lgr freed but execute
after lgr freed, which may result in crash. So it is need to
hold a reference before shedule link down work, and put the
reference after work executed or canceled.
The relevant crash call stack as follows:
list\_del corruption. prev->next should be ffffb638c9c0fe20,
but was 0000000000000000
------------[ cut here ]------------
kernel BUG at lib/list\_debug.c:51!
invalid opcode: 0000 [#1] SMP NOPTI
CPU: 6 PID: 978112 Comm: kworker/6:119 Kdump: loaded Tainted: G #1
Hardware name: Alibaba Cloud Alibaba Cloud ECS, BIOS 2221b89 04/01/2014
Workqueue: events smc\_link\_down\_work [smc]
RIP: 0010:\_\_list\_del\_entry\_valid.cold+0x31/0x47
RSP: 0018:ffffb638c9c0fdd8 EFLAGS: 00010086
RAX: 0000000000000054 RBX: ffff942fb75e5128 RCX: 0000000000000000
RDX: ffff943520930aa0 RSI: ffff94352091fc80 RDI: ffff94352091fc80
RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb638c9c0fc38
R10: ffffb638c9c0fc30 R11: ffffffffa015eb28 R12: 0000000000000002
R13: ffffb638c9c0fe20 R14: 0000000000000001 R15: ffff942f9cd051c0
FS: 0000000000000000(0000) GS:ffff943520900000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f4f25214000 CR3: 000000025fbae004 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
rwsem\_down\_write\_slowpath+0x17e/0x470
smc\_link\_down\_work+0x3c/0x60 [smc]
process\_one\_work+0x1ac/0x350
worker\_thread+0x49/0x2f0
? rescuer\_thread+0x360/0x360
kthread+0x118/0x140
? \_\_kthread\_bind\_mask+0x60/0x60
ret\_from\_fork+0x1f/0x30
Fixes: 541afa10c126 ("net/smc: add smcr\_port\_err() and smcr\_link\_down() processing")
Signed-off-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Reviewed-by: Tony Lu <tonylu@linux.alibaba.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bec2f52866d511e94c1c37cd962e4382b1b1a299)

| -rw-r--r-- | [net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_core.c?id=bec2f52866d511e94c1c37cd962e4382b1b1a299) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 2 deletions

| diff --git a/net/smc/smc\_core.c b/net/smc/smc\_core.cindex 10d79cb55528d0..890785d4f6b69b 100644--- a/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=7334f371d11aab541e6e1df90576da6ada7b2443)+++ b/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=bec2f52866d511e94c1c37cd962e4382b1b1a299)@@ -1726,7 +1726,9 @@ void smcr\_link\_down\_cond\_sched(struct smc\_link \*lnk) { if (smc\_link\_downing(&lnk->state)) { trace\_smcr\_link\_down(lnk, \_\_builtin\_return\_address(0));- schedule\_work(&lnk->link\_down\_wrk);+ smcr\_link\_hold(lnk); /\* smcr\_link\_put in link\_down\_wrk \*/+ if (!schedule\_work(&lnk->link\_down\_wrk))+ smcr\_link\_put(lnk); } } @@ -1758,11 +1760,14 @@ static void smc\_link\_down\_work(struct work\_struct \*work) struct smc\_link\_group \*lgr = link->lgr;  if (list\_empty(&lgr->list))- return;+ goto out; wake\_up\_all(&lgr->llc\_msg\_waiter); mutex\_lock(&lgr->llc\_conf\_mutex); smcr\_link\_down(link); mutex\_unlock(&lgr->llc\_conf\_mutex);++out:+ smcr\_link\_put(link); /\* smcr\_link\_hold by schedulers of link\_down\_work \*/ }  static int smc\_vlan\_by\_tcpsk\_walk(struct net\_device \*lower\_dev, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:25:41 +0000



=== Content from git.kernel.org_f32c7fc2_20250114_192702.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guangguan Wang <guangguan.wang@linux.alibaba.com> | 2024-12-11 17:21:16 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2024-12-15 12:34:59 +0000 |
| commit | [2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec)) | |
| tree | [a0668f582a3d2c26c0f3c6cfc8ca060a88a3c4af](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec) | |
| parent | [429fde2d81bcef0ebab002215358955704586457](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=429fde2d81bcef0ebab002215358955704586457) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec&id2=429fde2d81bcef0ebab002215358955704586457)) | |
| download | [linux-2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec.tar.gz) | |

net/smc: protect link down work from execute after lgr freedlink down work may be scheduled before lgr freed but execute
after lgr freed, which may result in crash. So it is need to
hold a reference before shedule link down work, and put the
reference after work executed or canceled.
The relevant crash call stack as follows:
list\_del corruption. prev->next should be ffffb638c9c0fe20,
but was 0000000000000000
------------[ cut here ]------------
kernel BUG at lib/list\_debug.c:51!
invalid opcode: 0000 [#1] SMP NOPTI
CPU: 6 PID: 978112 Comm: kworker/6:119 Kdump: loaded Tainted: G #1
Hardware name: Alibaba Cloud Alibaba Cloud ECS, BIOS 2221b89 04/01/2014
Workqueue: events smc\_link\_down\_work [smc]
RIP: 0010:\_\_list\_del\_entry\_valid.cold+0x31/0x47
RSP: 0018:ffffb638c9c0fdd8 EFLAGS: 00010086
RAX: 0000000000000054 RBX: ffff942fb75e5128 RCX: 0000000000000000
RDX: ffff943520930aa0 RSI: ffff94352091fc80 RDI: ffff94352091fc80
RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb638c9c0fc38
R10: ffffb638c9c0fc30 R11: ffffffffa015eb28 R12: 0000000000000002
R13: ffffb638c9c0fe20 R14: 0000000000000001 R15: ffff942f9cd051c0
FS: 0000000000000000(0000) GS:ffff943520900000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f4f25214000 CR3: 000000025fbae004 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
rwsem\_down\_write\_slowpath+0x17e/0x470
smc\_link\_down\_work+0x3c/0x60 [smc]
process\_one\_work+0x1ac/0x350
worker\_thread+0x49/0x2f0
? rescuer\_thread+0x360/0x360
kthread+0x118/0x140
? \_\_kthread\_bind\_mask+0x60/0x60
ret\_from\_fork+0x1f/0x30
Fixes: 541afa10c126 ("net/smc: add smcr\_port\_err() and smcr\_link\_down() processing")
Signed-off-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Reviewed-by: Tony Lu <tonylu@linux.alibaba.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec)

| -rw-r--r-- | [net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_core.c?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 2 deletions

| diff --git a/net/smc/smc\_core.c b/net/smc/smc\_core.cindex 500952c2e67bab..3b125d348b4aed 100644--- a/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=429fde2d81bcef0ebab002215358955704586457)+++ b/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec)@@ -1818,7 +1818,9 @@ void smcr\_link\_down\_cond\_sched(struct smc\_link \*lnk) { if (smc\_link\_downing(&lnk->state)) { trace\_smcr\_link\_down(lnk, \_\_builtin\_return\_address(0));- schedule\_work(&lnk->link\_down\_wrk);+ smcr\_link\_hold(lnk); /\* smcr\_link\_put in link\_down\_wrk \*/+ if (!schedule\_work(&lnk->link\_down\_wrk))+ smcr\_link\_put(lnk); } } @@ -1850,11 +1852,14 @@ static void smc\_link\_down\_work(struct work\_struct \*work) struct smc\_link\_group \*lgr = link->lgr;  if (list\_empty(&lgr->list))- return;+ goto out; wake\_up\_all(&lgr->llc\_msg\_waiter); down\_write(&lgr->llc\_conf\_mutex); smcr\_link\_down(link); up\_write(&lgr->llc\_conf\_mutex);++out:+ smcr\_link\_put(link); /\* smcr\_link\_hold by schedulers of link\_down\_work \*/ }  static int smc\_vlan\_by\_tcpsk\_walk(struct net\_device \*lower\_dev, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:25:40 +0000



=== Content from git.kernel.org_38221728_20250114_192702.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guangguan Wang <guangguan.wang@linux.alibaba.com> | 2024-12-11 17:21:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-27 13:58:47 +0100 |
| commit | [2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2)) | |
| tree | [24141948485235dd51efbffc13a6c5976f5452fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2) | |
| parent | [06518a75de0ac4f2738f239c37f76b2ced67eaa3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06518a75de0ac4f2738f239c37f76b2ced67eaa3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2&id2=06518a75de0ac4f2738f239c37f76b2ced67eaa3)) | |
| download | [linux-2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2.tar.gz) | |

net/smc: protect link down work from execute after lgr freed[ Upstream commit 2b33eb8f1b3e8c2f87cfdbc8cc117f6bdfabc6ec ]
link down work may be scheduled before lgr freed but execute
after lgr freed, which may result in crash. So it is need to
hold a reference before shedule link down work, and put the
reference after work executed or canceled.
The relevant crash call stack as follows:
list\_del corruption. prev->next should be ffffb638c9c0fe20,
but was 0000000000000000
------------[ cut here ]------------
kernel BUG at lib/list\_debug.c:51!
invalid opcode: 0000 [#1] SMP NOPTI
CPU: 6 PID: 978112 Comm: kworker/6:119 Kdump: loaded Tainted: G #1
Hardware name: Alibaba Cloud Alibaba Cloud ECS, BIOS 2221b89 04/01/2014
Workqueue: events smc\_link\_down\_work [smc]
RIP: 0010:\_\_list\_del\_entry\_valid.cold+0x31/0x47
RSP: 0018:ffffb638c9c0fdd8 EFLAGS: 00010086
RAX: 0000000000000054 RBX: ffff942fb75e5128 RCX: 0000000000000000
RDX: ffff943520930aa0 RSI: ffff94352091fc80 RDI: ffff94352091fc80
RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb638c9c0fc38
R10: ffffb638c9c0fc30 R11: ffffffffa015eb28 R12: 0000000000000002
R13: ffffb638c9c0fe20 R14: 0000000000000001 R15: ffff942f9cd051c0
FS: 0000000000000000(0000) GS:ffff943520900000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f4f25214000 CR3: 000000025fbae004 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
rwsem\_down\_write\_slowpath+0x17e/0x470
smc\_link\_down\_work+0x3c/0x60 [smc]
process\_one\_work+0x1ac/0x350
worker\_thread+0x49/0x2f0
? rescuer\_thread+0x360/0x360
kthread+0x118/0x140
? \_\_kthread\_bind\_mask+0x60/0x60
ret\_from\_fork+0x1f/0x30
Fixes: 541afa10c126 ("net/smc: add smcr\_port\_err() and smcr\_link\_down() processing")
Signed-off-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Reviewed-by: Tony Lu <tonylu@linux.alibaba.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2)

| -rw-r--r-- | [net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_core.c?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 2 deletions

| diff --git a/net/smc/smc\_core.c b/net/smc/smc\_core.cindex 3d5c542cd23156..3c626c014d1d9e 100644--- a/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=06518a75de0ac4f2738f239c37f76b2ced67eaa3)+++ b/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=2627c3e8646932dfc7b9722c88c2e1ffcf7a9fb2)@@ -1767,7 +1767,9 @@ void smcr\_link\_down\_cond\_sched(struct smc\_link \*lnk) { if (smc\_link\_downing(&lnk->state)) { trace\_smcr\_link\_down(lnk, \_\_builtin\_return\_address(0));- schedule\_work(&lnk->link\_down\_wrk);+ smcr\_link\_hold(lnk); /\* smcr\_link\_put in link\_down\_wrk \*/+ if (!schedule\_work(&lnk->link\_down\_wrk))+ smcr\_link\_put(lnk); } } @@ -1799,11 +1801,14 @@ static void smc\_link\_down\_work(struct work\_struct \*work) struct smc\_link\_group \*lgr = link->lgr;  if (list\_empty(&lgr->list))- return;+ goto out; wake\_up\_all(&lgr->llc\_msg\_waiter); down\_write(&lgr->llc\_conf\_mutex); smcr\_link\_down(link); up\_write(&lgr->llc\_conf\_mutex);++out:+ smcr\_link\_put(link); /\* smcr\_link\_hold by schedulers of link\_down\_work \*/ }  static int smc\_vlan\_by\_tcpsk\_walk(struct net\_device \*lower\_dev, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:25:39 +0000


