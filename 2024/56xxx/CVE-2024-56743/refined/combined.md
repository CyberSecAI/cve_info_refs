=== Content from git.kernel.org_4fb23f00_20250114_185149.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mike Snitzer <snitzer@kernel.org> | 2024-11-13 22:59:38 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:27 +0100 |
| commit | [3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2)) | |
| tree | [a60373abedadf334938f32ba6d4619593bf0cae2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2) | |
| parent | [9e7c4cfdf7fef14378fd2183a91d235bff6c7906](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e7c4cfdf7fef14378fd2183a91d235bff6c7906) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2&id2=9e7c4cfdf7fef14378fd2183a91d235bff6c7906)) | |
| download | [linux-3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2.tar.gz) | |

nfs\_common: must not hold RCU while calling nfsd\_file\_put\_local[ Upstream commit c840b8e1f039e90f97ca55525667eb961422f86c ]
Move holding the RCU from nfs\_to\_nfsd\_file\_put\_local to
nfs\_to\_nfsd\_net\_put. It is the call to nfs\_to->nfsd\_serv\_put that
requires the RCU anyway (the puts for nfsd\_file and netns were
combined to avoid an extra indirect reference but that
micro-optimization isn't possible now).
This fixes xfstests generic/013 and it triggering:
"Voluntary context switch within RCU read-side critical section!"
[ 143.545738] Call Trace:
[ 143.546206] <TASK>
[ 143.546625] ? show\_regs+0x6d/0x80
[ 143.547267] ? \_\_warn+0x91/0x140
[ 143.547951] ? rcu\_note\_context\_switch+0x496/0x5d0
[ 143.548856] ? report\_bug+0x193/0x1a0
[ 143.549557] ? handle\_bug+0x63/0xa0
[ 143.550214] ? exc\_invalid\_op+0x1d/0x80
[ 143.550938] ? asm\_exc\_invalid\_op+0x1f/0x30
[ 143.551736] ? rcu\_note\_context\_switch+0x496/0x5d0
[ 143.552634] ? wakeup\_preempt+0x62/0x70
[ 143.553358] \_\_schedule+0xaa/0x1380
[ 143.554025] ? \_raw\_spin\_unlock\_irqrestore+0x12/0x40
[ 143.554958] ? try\_to\_wake\_up+0x1fe/0x6b0
[ 143.555715] ? wake\_up\_process+0x19/0x20
[ 143.556452] schedule+0x2e/0x120
[ 143.557066] schedule\_preempt\_disabled+0x19/0x30
[ 143.557933] rwsem\_down\_read\_slowpath+0x24d/0x4a0
[ 143.558818] ? xfs\_efi\_item\_format+0x50/0xc0 [xfs]
[ 143.559894] down\_read+0x4e/0xb0
[ 143.560519] xlog\_cil\_commit+0x1b2/0xbc0 [xfs]
[ 143.561460] ? \_raw\_spin\_unlock+0x12/0x30
[ 143.562212] ? xfs\_inode\_item\_precommit+0xc7/0x220 [xfs]
[ 143.563309] ? xfs\_trans\_run\_precommits+0x69/0xd0 [xfs]
[ 143.564394] \_\_xfs\_trans\_commit+0xb5/0x330 [xfs]
[ 143.565367] xfs\_trans\_roll+0x48/0xc0 [xfs]
[ 143.566262] xfs\_defer\_trans\_roll+0x57/0x100 [xfs]
[ 143.567278] xfs\_defer\_finish\_noroll+0x27a/0x490 [xfs]
[ 143.568342] xfs\_defer\_finish+0x1a/0x80 [xfs]
[ 143.569267] xfs\_bunmapi\_range+0x4d/0xb0 [xfs]
[ 143.570208] xfs\_itruncate\_extents\_flags+0x13d/0x230 [xfs]
[ 143.571353] xfs\_free\_eofblocks+0x12e/0x190 [xfs]
[ 143.572359] xfs\_file\_release+0x12d/0x140 [xfs]
[ 143.573324] \_\_fput+0xe8/0x2d0
[ 143.573922] \_\_fput\_sync+0x1d/0x30
[ 143.574574] nfsd\_filp\_close+0x33/0x60 [nfsd]
[ 143.575430] nfsd\_file\_free+0x96/0x150 [nfsd]
[ 143.576274] nfsd\_file\_put+0xf7/0x1a0 [nfsd]
[ 143.577104] nfsd\_file\_put\_local+0x18/0x30 [nfsd]
[ 143.578070] nfs\_close\_local\_fh+0x101/0x110 [nfs\_localio]
[ 143.579079] \_\_put\_nfs\_open\_context+0xc9/0x180 [nfs]
[ 143.580031] nfs\_file\_clear\_open\_context+0x4a/0x60 [nfs]
[ 143.581038] nfs\_file\_release+0x3e/0x60 [nfs]
[ 143.581879] \_\_fput+0xe8/0x2d0
[ 143.582464] \_\_fput\_sync+0x1d/0x30
[ 143.583108] \_\_x64\_sys\_close+0x41/0x80
[ 143.583823] x64\_sys\_call+0x189a/0x20d0
[ 143.584552] do\_syscall\_64+0x64/0x170
[ 143.585240] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 143.586185] RIP: 0033:0x7f3c5153efd7
Fixes: 65f2a5c36635 ("nfs\_common: fix race in NFS calls to nfsd\_file\_put\_local() and nfsd\_serv\_put()")
Signed-off-by: Mike Snitzer <snitzer@kernel.org>
Reviewed-by: NeilBrown <neilb@suse.de>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2)

| -rw-r--r-- | [fs/nfs\_common/nfslocalio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs_common/nfslocalio.c?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/filecache.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/filecache.c?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2) | 14 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/filecache.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/filecache.h?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/nfslocalio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/nfslocalio.h?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2) | 18 | |  |  |  | | --- | --- | --- | |

4 files changed, 26 insertions, 16 deletions

| diff --git a/fs/nfs\_common/nfslocalio.c b/fs/nfs\_common/nfslocalio.cindex 09404d142d1ae6..a74ec08f6c96d0 100644--- a/[fs/nfs\_common/nfslocalio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs_common/nfslocalio.c?id=9e7c4cfdf7fef14378fd2183a91d235bff6c7906)+++ b/[fs/nfs\_common/nfslocalio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs_common/nfslocalio.c?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2)@@ -155,11 +155,9 @@ struct nfsd\_file \*nfs\_open\_local\_fh(nfs\_uuid\_t \*uuid, /\* We have an implied reference to net thanks to nfsd\_serv\_try\_get \*/ localio = nfs\_to->nfsd\_open\_local\_fh(net, uuid->dom, rpc\_clnt, cred, nfs\_fh, fmode);- if (IS\_ERR(localio)) {- rcu\_read\_lock();- nfs\_to->nfsd\_serv\_put(net);- rcu\_read\_unlock();- }+ if (IS\_ERR(localio))+ nfs\_to\_nfsd\_net\_put(net);+ return localio; } EXPORT\_SYMBOL\_GPL(nfs\_open\_local\_fh);diff --git a/fs/nfsd/filecache.c b/fs/nfsd/filecache.cindex 2e6783f6371245..146a9463c3c230 100644--- a/[fs/nfsd/filecache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/filecache.c?id=9e7c4cfdf7fef14378fd2183a91d235bff6c7906)+++ b/[fs/nfsd/filecache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/filecache.c?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2)@@ -391,19 +391,19 @@ nfsd\_file\_put(struct nfsd\_file \*nf) }  /\*\*- \* nfsd\_file\_put\_local - put the reference to nfsd\_file and local nfsd\_serv- \* @nf: nfsd\_file of which to put the references+ \* nfsd\_file\_put\_local - put nfsd\_file reference and arm nfsd\_serv\_put in caller+ \* @nf: nfsd\_file of which to put the reference \*- \* First put the reference of the nfsd\_file and then put the- \* reference to the associated nn->nfsd\_serv.+ \* First save the associated net to return to caller, then put+ \* the reference of the nfsd\_file. \*/-void-nfsd\_file\_put\_local(struct nfsd\_file \*nf) \_\_must\_hold(rcu)+struct net \*+nfsd\_file\_put\_local(struct nfsd\_file \*nf) { struct net \*net = nf->nf\_net;  nfsd\_file\_put(nf);- nfsd\_serv\_put(net);+ return net; }  /\*\*diff --git a/fs/nfsd/filecache.h b/fs/nfsd/filecache.hindex cadf3c2689c44c..d5db6b34ba302c 100644--- a/[fs/nfsd/filecache.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/filecache.h?id=9e7c4cfdf7fef14378fd2183a91d235bff6c7906)+++ b/[fs/nfsd/filecache.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/filecache.h?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2)@@ -55,7 +55,7 @@ void nfsd\_file\_cache\_shutdown(void); int nfsd\_file\_cache\_start\_net(struct net \*net); void nfsd\_file\_cache\_shutdown\_net(struct net \*net); void nfsd\_file\_put(struct nfsd\_file \*nf);-void nfsd\_file\_put\_local(struct nfsd\_file \*nf);+struct net \*nfsd\_file\_put\_local(struct nfsd\_file \*nf); struct nfsd\_file \*nfsd\_file\_get(struct nfsd\_file \*nf); struct file \*nfsd\_file\_file(struct nfsd\_file \*nf); void nfsd\_file\_close\_inode\_sync(struct inode \*inode);diff --git a/include/linux/nfslocalio.h b/include/linux/nfslocalio.hindex 3982fea799195e..9202f4b24343d7 100644--- a/[include/linux/nfslocalio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/nfslocalio.h?id=9e7c4cfdf7fef14378fd2183a91d235bff6c7906)+++ b/[include/linux/nfslocalio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/nfslocalio.h?id=3e6e3e97d64f50d9b6b1d62274f08925b1adbfc2)@@ -55,7 +55,7 @@ struct nfsd\_localio\_operations { const struct cred \*, const struct nfs\_fh \*, const fmode\_t);- void (\*nfsd\_file\_put\_local)(struct nfsd\_file \*);+ struct net \*(\*nfsd\_file\_put\_local)(struct nfsd\_file \*); struct file \*(\*nfsd\_file\_file)(struct nfsd\_file \*); } \_\_\_\_cacheline\_aligned; @@ -66,7 +66,7 @@ struct nfsd\_file \*nfs\_open\_local\_fh(nfs\_uuid\_t \*, struct rpc\_clnt \*, const struct cred \*, const struct nfs\_fh \*, const fmode\_t); -static inline void nfs\_to\_nfsd\_file\_put\_local(struct nfsd\_file \*localio)+static inline void nfs\_to\_nfsd\_net\_put(struct net \*net) { /\* \* Once reference to nfsd\_serv is dropped, NFSD could be@@ -74,10 +74,22 @@ static inline void nfs\_to\_nfsd\_file\_put\_local(struct nfsd\_file \*localio) \* by always taking RCU. \*/ rcu\_read\_lock();- nfs\_to->nfsd\_file\_put\_local(localio);+ nfs\_to->nfsd\_serv\_put(net); rcu\_read\_unlock(); } +static inline void nfs\_to\_nfsd\_file\_put\_local(struct nfsd\_file \*localio)+{+ /\*+ \* Must not hold RCU otherwise nfsd\_file\_put() can easily trigger:+ \* "Voluntary context switch within RCU read-side critical section!"+ \* by scheduling deep in underlying filesystem (e.g. XFS).+ \*/+ struct net \*net = nfs\_to->nfsd\_file\_put\_local(localio);++ nfs\_to\_nfsd\_net\_put(net);+}+ #else /\* CONFIG\_NFS\_LOCALIO \*/ static inline void nfsd\_localio\_ops\_init(void) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:50:26 +0000



=== Content from git.kernel.org_1ea84fb8_20250114_185150.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c840b8e1f039e90f97ca55525667eb961422f86c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c840b8e1f039e90f97ca55525667eb961422f86c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c840b8e1f039e90f97ca55525667eb961422f86c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c840b8e1f039e90f97ca55525667eb961422f86c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mike Snitzer <snitzer@kernel.org> | 2024-11-13 22:59:38 -0500 |
| --- | --- | --- |
| committer | Chuck Lever <chuck.lever@oracle.com> | 2024-11-18 20:23:12 -0500 |
| commit | [c840b8e1f039e90f97ca55525667eb961422f86c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c840b8e1f039e90f97ca55525667eb961422f86c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c840b8e1f039e90f97ca55525667eb961422f86c)) | |
| tree | [77820d4413db3f253f10cbac9642bcf0a800be3d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c840b8e1f039e90f97ca55525667eb961422f86c) | |
| parent | [07442ec85bded6692f2e5909f16ab8bbc86fb3be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07442ec85bded6692f2e5909f16ab8bbc86fb3be) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c840b8e1f039e90f97ca55525667eb961422f86c&id2=07442ec85bded6692f2e5909f16ab8bbc86fb3be)) | |
| download | [linux-c840b8e1f039e90f97ca55525667eb961422f86c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c840b8e1f039e90f97ca55525667eb961422f86c.tar.gz) | |

nfs\_common: must not hold RCU while calling nfsd\_file\_put\_localMove holding the RCU from nfs\_to\_nfsd\_file\_put\_local to
nfs\_to\_nfsd\_net\_put. It is the call to nfs\_to->nfsd\_serv\_put that
requires the RCU anyway (the puts for nfsd\_file and netns were
combined to avoid an extra indirect reference but that
micro-optimization isn't possible now).
This fixes xfstests generic/013 and it triggering:
"Voluntary context switch within RCU read-side critical section!"
[ 143.545738] Call Trace:
[ 143.546206] <TASK>
[ 143.546625] ? show\_regs+0x6d/0x80
[ 143.547267] ? \_\_warn+0x91/0x140
[ 143.547951] ? rcu\_note\_context\_switch+0x496/0x5d0
[ 143.548856] ? report\_bug+0x193/0x1a0
[ 143.549557] ? handle\_bug+0x63/0xa0
[ 143.550214] ? exc\_invalid\_op+0x1d/0x80
[ 143.550938] ? asm\_exc\_invalid\_op+0x1f/0x30
[ 143.551736] ? rcu\_note\_context\_switch+0x496/0x5d0
[ 143.552634] ? wakeup\_preempt+0x62/0x70
[ 143.553358] \_\_schedule+0xaa/0x1380
[ 143.554025] ? \_raw\_spin\_unlock\_irqrestore+0x12/0x40
[ 143.554958] ? try\_to\_wake\_up+0x1fe/0x6b0
[ 143.555715] ? wake\_up\_process+0x19/0x20
[ 143.556452] schedule+0x2e/0x120
[ 143.557066] schedule\_preempt\_disabled+0x19/0x30
[ 143.557933] rwsem\_down\_read\_slowpath+0x24d/0x4a0
[ 143.558818] ? xfs\_efi\_item\_format+0x50/0xc0 [xfs]
[ 143.559894] down\_read+0x4e/0xb0
[ 143.560519] xlog\_cil\_commit+0x1b2/0xbc0 [xfs]
[ 143.561460] ? \_raw\_spin\_unlock+0x12/0x30
[ 143.562212] ? xfs\_inode\_item\_precommit+0xc7/0x220 [xfs]
[ 143.563309] ? xfs\_trans\_run\_precommits+0x69/0xd0 [xfs]
[ 143.564394] \_\_xfs\_trans\_commit+0xb5/0x330 [xfs]
[ 143.565367] xfs\_trans\_roll+0x48/0xc0 [xfs]
[ 143.566262] xfs\_defer\_trans\_roll+0x57/0x100 [xfs]
[ 143.567278] xfs\_defer\_finish\_noroll+0x27a/0x490 [xfs]
[ 143.568342] xfs\_defer\_finish+0x1a/0x80 [xfs]
[ 143.569267] xfs\_bunmapi\_range+0x4d/0xb0 [xfs]
[ 143.570208] xfs\_itruncate\_extents\_flags+0x13d/0x230 [xfs]
[ 143.571353] xfs\_free\_eofblocks+0x12e/0x190 [xfs]
[ 143.572359] xfs\_file\_release+0x12d/0x140 [xfs]
[ 143.573324] \_\_fput+0xe8/0x2d0
[ 143.573922] \_\_fput\_sync+0x1d/0x30
[ 143.574574] nfsd\_filp\_close+0x33/0x60 [nfsd]
[ 143.575430] nfsd\_file\_free+0x96/0x150 [nfsd]
[ 143.576274] nfsd\_file\_put+0xf7/0x1a0 [nfsd]
[ 143.577104] nfsd\_file\_put\_local+0x18/0x30 [nfsd]
[ 143.578070] nfs\_close\_local\_fh+0x101/0x110 [nfs\_localio]
[ 143.579079] \_\_put\_nfs\_open\_context+0xc9/0x180 [nfs]
[ 143.580031] nfs\_file\_clear\_open\_context+0x4a/0x60 [nfs]
[ 143.581038] nfs\_file\_release+0x3e/0x60 [nfs]
[ 143.581879] \_\_fput+0xe8/0x2d0
[ 143.582464] \_\_fput\_sync+0x1d/0x30
[ 143.583108] \_\_x64\_sys\_close+0x41/0x80
[ 143.583823] x64\_sys\_call+0x189a/0x20d0
[ 143.584552] do\_syscall\_64+0x64/0x170
[ 143.585240] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 143.586185] RIP: 0033:0x7f3c5153efd7
Fixes: 65f2a5c36635 ("nfs\_common: fix race in NFS calls to nfsd\_file\_put\_local() and nfsd\_serv\_put()")
Signed-off-by: Mike Snitzer <snitzer@kernel.org>
Reviewed-by: NeilBrown <neilb@suse.de>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c840b8e1f039e90f97ca55525667eb961422f86c)

| -rw-r--r-- | [fs/nfs\_common/nfslocalio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs_common/nfslocalio.c?id=c840b8e1f039e90f97ca55525667eb961422f86c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/filecache.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/filecache.c?id=c840b8e1f039e90f97ca55525667eb961422f86c) | 14 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/filecache.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/filecache.h?id=c840b8e1f039e90f97ca55525667eb961422f86c) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/nfslocalio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/nfslocalio.h?id=c840b8e1f039e90f97ca55525667eb961422f86c) | 18 | |  |  |  | | --- | --- | --- | |

4 files changed, 26 insertions, 16 deletions

| diff --git a/fs/nfs\_common/nfslocalio.c b/fs/nfs\_common/nfslocalio.cindex 09404d142d1ae6..a74ec08f6c96d0 100644--- a/[fs/nfs\_common/nfslocalio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs_common/nfslocalio.c?id=07442ec85bded6692f2e5909f16ab8bbc86fb3be)+++ b/[fs/nfs\_common/nfslocalio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs_common/nfslocalio.c?id=c840b8e1f039e90f97ca55525667eb961422f86c)@@ -155,11 +155,9 @@ struct nfsd\_file \*nfs\_open\_local\_fh(nfs\_uuid\_t \*uuid, /\* We have an implied reference to net thanks to nfsd\_serv\_try\_get \*/ localio = nfs\_to->nfsd\_open\_local\_fh(net, uuid->dom, rpc\_clnt, cred, nfs\_fh, fmode);- if (IS\_ERR(localio)) {- rcu\_read\_lock();- nfs\_to->nfsd\_serv\_put(net);- rcu\_read\_unlock();- }+ if (IS\_ERR(localio))+ nfs\_to\_nfsd\_net\_put(net);+ return localio; } EXPORT\_SYMBOL\_GPL(nfs\_open\_local\_fh);diff --git a/fs/nfsd/filecache.c b/fs/nfsd/filecache.cindex c16671135d1769..9a62b4da89bb78 100644--- a/[fs/nfsd/filecache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/filecache.c?id=07442ec85bded6692f2e5909f16ab8bbc86fb3be)+++ b/[fs/nfsd/filecache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/filecache.c?id=c840b8e1f039e90f97ca55525667eb961422f86c)@@ -391,19 +391,19 @@ nfsd\_file\_put(struct nfsd\_file \*nf) }  /\*\*- \* nfsd\_file\_put\_local - put the reference to nfsd\_file and local nfsd\_serv- \* @nf: nfsd\_file of which to put the references+ \* nfsd\_file\_put\_local - put nfsd\_file reference and arm nfsd\_serv\_put in caller+ \* @nf: nfsd\_file of which to put the reference \*- \* First put the reference of the nfsd\_file and then put the- \* reference to the associated nn->nfsd\_serv.+ \* First save the associated net to return to caller, then put+ \* the reference of the nfsd\_file. \*/-void-nfsd\_file\_put\_local(struct nfsd\_file \*nf) \_\_must\_hold(rcu)+struct net \*+nfsd\_file\_put\_local(struct nfsd\_file \*nf) { struct net \*net = nf->nf\_net;  nfsd\_file\_put(nf);- nfsd\_serv\_put(net);+ return net; }  /\*\*diff --git a/fs/nfsd/filecache.h b/fs/nfsd/filecache.hindex cadf3c2689c44c..d5db6b34ba302c 100644--- a/[fs/nfsd/filecache.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/filecache.h?id=07442ec85bded6692f2e5909f16ab8bbc86fb3be)+++ b/[fs/nfsd/filecache.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/filecache.h?id=c840b8e1f039e90f97ca55525667eb961422f86c)@@ -55,7 +55,7 @@ void nfsd\_file\_cache\_shutdown(void); int nfsd\_file\_cache\_start\_net(struct net \*net); void nfsd\_file\_cache\_shutdown\_net(struct net \*net); void nfsd\_file\_put(struct nfsd\_file \*nf);-void nfsd\_file\_put\_local(struct nfsd\_file \*nf);+struct net \*nfsd\_file\_put\_local(struct nfsd\_file \*nf); struct nfsd\_file \*nfsd\_file\_get(struct nfsd\_file \*nf); struct file \*nfsd\_file\_file(struct nfsd\_file \*nf); void nfsd\_file\_close\_inode\_sync(struct inode \*inode);diff --git a/include/linux/nfslocalio.h b/include/linux/nfslocalio.hindex 3982fea799195e..9202f4b24343d7 100644--- a/[include/linux/nfslocalio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/nfslocalio.h?id=07442ec85bded6692f2e5909f16ab8bbc86fb3be)+++ b/[include/linux/nfslocalio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/nfslocalio.h?id=c840b8e1f039e90f97ca55525667eb961422f86c)@@ -55,7 +55,7 @@ struct nfsd\_localio\_operations { const struct cred \*, const struct nfs\_fh \*, const fmode\_t);- void (\*nfsd\_file\_put\_local)(struct nfsd\_file \*);+ struct net \*(\*nfsd\_file\_put\_local)(struct nfsd\_file \*); struct file \*(\*nfsd\_file\_file)(struct nfsd\_file \*); } \_\_\_\_cacheline\_aligned; @@ -66,7 +66,7 @@ struct nfsd\_file \*nfs\_open\_local\_fh(nfs\_uuid\_t \*, struct rpc\_clnt \*, const struct cred \*, const struct nfs\_fh \*, const fmode\_t); -static inline void nfs\_to\_nfsd\_file\_put\_local(struct nfsd\_file \*localio)+static inline void nfs\_to\_nfsd\_net\_put(struct net \*net) { /\* \* Once reference to nfsd\_serv is dropped, NFSD could be@@ -74,10 +74,22 @@ static inline void nfs\_to\_nfsd\_file\_put\_local(struct nfsd\_file \*localio) \* by always taking RCU. \*/ rcu\_read\_lock();- nfs\_to->nfsd\_file\_put\_local(localio);+ nfs\_to->nfsd\_serv\_put(net); rcu\_read\_unlock(); } +static inline void nfs\_to\_nfsd\_file\_put\_local(struct nfsd\_file \*localio)+{+ /\*+ \* Must not hold RCU otherwise nfsd\_file\_put() can easily trigger:+ \* "Voluntary context switch within RCU read-side critical section!"+ \* by scheduling deep in underlying filesystem (e.g. XFS).+ \*/+ struct net \*net = nfs\_to->nfsd\_file\_put\_local(localio);++ nfs\_to\_nfsd\_net\_put(net);+}+ #else /\* CONFIG\_NFS\_LOCALIO \*/ static inline void nfsd\_localio\_ops\_init(void) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:50:27 +0000


