=== Content from git.kernel.org_0a3d64e5_20250115_094210.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mukesh Ojha <quic\_mojha@quicinc.com> | 2024-11-03 21:35:27 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:46 +0100 |
| commit | [50d9f68e4adf86901cbab1bd5b91f710aa9141b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9)) | |
| tree | [5ca4da7485e5475492cf409bf7dbb6256afb6d71](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9) | |
| parent | [6e8a13f27e1f7805004485553fe6054d85183fd9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e8a13f27e1f7805004485553fe6054d85183fd9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9&id2=6e8a13f27e1f7805004485553fe6054d85183fd9)) | |
| download | [linux-50d9f68e4adf86901cbab1bd5b91f710aa9141b9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-50d9f68e4adf86901cbab1bd5b91f710aa9141b9.tar.gz) | |

leds: class: Protect brightness\_show() with led\_cdev->led\_access mutex[ Upstream commit 4ca7cd938725a4050dcd62ae9472e931d603118d ]
There is NULL pointer issue observed if from Process A where hid device
being added which results in adding a led\_cdev addition and later a
another call to access of led\_cdev attribute from Process B can result
in NULL pointer issue.
Use mutex led\_cdev->led\_access to protect access to led->cdev and its
attribute inside brightness\_show() and max\_brightness\_show() and also
update the comment for mutex that it should be used to protect the led
class device fields.
Process A Process B
kthread+0x114
worker\_thread+0x244
process\_scheduled\_works+0x248
uhid\_device\_add\_worker+0x24
hid\_add\_device+0x120
device\_add+0x268
bus\_probe\_device+0x94
device\_initial\_probe+0x14
\_\_device\_attach+0xfc
bus\_for\_each\_drv+0x10c
\_\_device\_attach\_driver+0x14c
driver\_probe\_device+0x3c
\_\_driver\_probe\_device+0xa0
really\_probe+0x190
hid\_device\_probe+0x130
ps\_probe+0x990
ps\_led\_register+0x94
devm\_led\_classdev\_register\_ext+0x58
led\_classdev\_register\_ext+0x1f8
device\_create\_with\_groups+0x48
device\_create\_groups\_vargs+0xc8
device\_add+0x244
kobject\_uevent+0x14
kobject\_uevent\_env[jt]+0x224
mutex\_unlock[jt]+0xc4
\_\_mutex\_unlock\_slowpath+0xd4
wake\_up\_q+0x70
try\_to\_wake\_up[jt]+0x48c
preempt\_schedule\_common+0x28
\_\_schedule+0x628
\_\_switch\_to+0x174
el0t\_64\_sync+0x1a8/0x1ac
el0t\_64\_sync\_handler+0x68/0xbc
el0\_svc+0x38/0x68
do\_el0\_svc+0x1c/0x28
el0\_svc\_common+0x80/0xe0
invoke\_syscall+0x58/0x114
\_\_arm64\_sys\_read+0x1c/0x2c
ksys\_read+0x78/0xe8
vfs\_read+0x1e0/0x2c8
kernfs\_fop\_read\_iter+0x68/0x1b4
seq\_read\_iter+0x158/0x4ec
kernfs\_seq\_show+0x44/0x54
sysfs\_kf\_seq\_show+0xb4/0x130
dev\_attr\_show+0x38/0x74
brightness\_show+0x20/0x4c
dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874295][ T4013] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000060
[ 3313.874301][ T4013] Mem abort info:
[ 3313.874303][ T4013] ESR = 0x0000000096000006
[ 3313.874305][ T4013] EC = 0x25: DABT (current EL), IL = 32 bits
[ 3313.874307][ T4013] SET = 0, FnV = 0
[ 3313.874309][ T4013] EA = 0, S1PTW = 0
[ 3313.874311][ T4013] FSC = 0x06: level 2 translation fault
[ 3313.874313][ T4013] Data abort info:
[ 3313.874314][ T4013] ISV = 0, ISS = 0x00000006, ISS2 = 0x00000000
[ 3313.874316][ T4013] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 3313.874318][ T4013] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 3313.874320][ T4013] user pgtable: 4k pages, 39-bit VAs, pgdp=00000008f2b0a000
..
[ 3313.874332][ T4013] Dumping ftrace buffer:
[ 3313.874334][ T4013] (ftrace buffer empty)
..
..
[ dd3313.874639][ T4013] CPU: 6 PID: 4013 Comm: InputReader
[ 3313.874648][ T4013] pc : dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874653][ T4013] lr : led\_update\_brightness+0x38/0x60
[ 3313.874656][ T4013] sp : ffffffc0b910bbd0
..
..
[ 3313.874685][ T4013] Call trace:
[ 3313.874687][ T4013] dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874690][ T4013] brightness\_show+0x20/0x4c
[ 3313.874692][ T4013] dev\_attr\_show+0x38/0x74
[ 3313.874696][ T4013] sysfs\_kf\_seq\_show+0xb4/0x130
[ 3313.874700][ T4013] kernfs\_seq\_show+0x44/0x54
[ 3313.874703][ T4013] seq\_read\_iter+0x158/0x4ec
[ 3313.874705][ T4013] kernfs\_fop\_read\_iter+0x68/0x1b4
[ 3313.874708][ T4013] vfs\_read+0x1e0/0x2c8
[ 3313.874711][ T4013] ksys\_read+0x78/0xe8
[ 3313.874714][ T4013] \_\_arm64\_sys\_read+0x1c/0x2c
[ 3313.874718][ T4013] invoke\_syscall+0x58/0x114
[ 3313.874721][ T4013] el0\_svc\_common+0x80/0xe0
[ 3313.874724][ T4013] do\_el0\_svc+0x1c/0x28
[ 3313.874727][ T4013] el0\_svc+0x38/0x68
[ 3313.874730][ T4013] el0t\_64\_sync\_handler+0x68/0xbc
[ 3313.874732][ T4013] el0t\_64\_sync+0x1a8/0x1ac
Signed-off-by: Mukesh Ojha <quic\_mojha@quicinc.com>
Reviewed-by: Anish Kumar <yesanishhere@gmail.com>
Link: [https://lore.kernel.org/r/20241103160527.82487-1-quic\_mojha@quicinc.com](https://lore.kernel.org/r/20241103160527.82487-1-quic_mojha%40quicinc.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9)

| -rw-r--r-- | [drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/leds/led-class.c?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/leds.h?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/leds/led-class.c b/drivers/leds/led-class.cindex 7391d2cf1370a9..93fdca5c7dc5dc 100644--- a/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=6e8a13f27e1f7805004485553fe6054d85183fd9)+++ b/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9)@@ -28,11 +28,14 @@ static ssize\_t brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int brightness; - /\* no lock needed for this \*/+ mutex\_lock(&led\_cdev->led\_access); led\_update\_brightness(led\_cdev);+ brightness = led\_cdev->brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->brightness);+ return sprintf(buf, "%u\n", brightness); }  static ssize\_t brightness\_store(struct device \*dev,@@ -69,8 +72,13 @@ static ssize\_t max\_brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int max\_brightness;++ mutex\_lock(&led\_cdev->led\_access);+ max\_brightness = led\_cdev->max\_brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->max\_brightness);+ return sprintf(buf, "%u\n", max\_brightness); } static DEVICE\_ATTR\_RO(max\_brightness); diff --git a/include/linux/leds.h b/include/linux/leds.hindex 79ab2dfd3c72f1..01fccb1c50010a 100644--- a/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=6e8a13f27e1f7805004485553fe6054d85183fd9)+++ b/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=50d9f68e4adf86901cbab1bd5b91f710aa9141b9)@@ -161,7 +161,7 @@ struct led\_classdev { struct kernfs\_node \*brightness\_hw\_changed\_kn; #endif - /\* Ensures consistent access to the LED Flash Class device \*/+ /\* Ensures consistent access to the LED class device \*/ struct mutex led\_access; }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:40:47 +0000



=== Content from git.kernel.org_093881cd_20250115_094213.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mukesh Ojha <quic\_mojha@quicinc.com> | 2024-11-03 21:35:27 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:30 +0100 |
| commit | [ddcfc5708da9972ac23a9121b3d819b0a53d6f21](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21)) | |
| tree | [a10f651d1c5d467d2bea88babbd66b40c067eb59](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21) | |
| parent | [3dd2c5cb2c698a02a4ed2ea0acb7c9909374a8bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3dd2c5cb2c698a02a4ed2ea0acb7c9909374a8bf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21&id2=3dd2c5cb2c698a02a4ed2ea0acb7c9909374a8bf)) | |
| download | [linux-ddcfc5708da9972ac23a9121b3d819b0a53d6f21.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ddcfc5708da9972ac23a9121b3d819b0a53d6f21.tar.gz) | |

leds: class: Protect brightness\_show() with led\_cdev->led\_access mutex[ Upstream commit 4ca7cd938725a4050dcd62ae9472e931d603118d ]
There is NULL pointer issue observed if from Process A where hid device
being added which results in adding a led\_cdev addition and later a
another call to access of led\_cdev attribute from Process B can result
in NULL pointer issue.
Use mutex led\_cdev->led\_access to protect access to led->cdev and its
attribute inside brightness\_show() and max\_brightness\_show() and also
update the comment for mutex that it should be used to protect the led
class device fields.
Process A Process B
kthread+0x114
worker\_thread+0x244
process\_scheduled\_works+0x248
uhid\_device\_add\_worker+0x24
hid\_add\_device+0x120
device\_add+0x268
bus\_probe\_device+0x94
device\_initial\_probe+0x14
\_\_device\_attach+0xfc
bus\_for\_each\_drv+0x10c
\_\_device\_attach\_driver+0x14c
driver\_probe\_device+0x3c
\_\_driver\_probe\_device+0xa0
really\_probe+0x190
hid\_device\_probe+0x130
ps\_probe+0x990
ps\_led\_register+0x94
devm\_led\_classdev\_register\_ext+0x58
led\_classdev\_register\_ext+0x1f8
device\_create\_with\_groups+0x48
device\_create\_groups\_vargs+0xc8
device\_add+0x244
kobject\_uevent+0x14
kobject\_uevent\_env[jt]+0x224
mutex\_unlock[jt]+0xc4
\_\_mutex\_unlock\_slowpath+0xd4
wake\_up\_q+0x70
try\_to\_wake\_up[jt]+0x48c
preempt\_schedule\_common+0x28
\_\_schedule+0x628
\_\_switch\_to+0x174
el0t\_64\_sync+0x1a8/0x1ac
el0t\_64\_sync\_handler+0x68/0xbc
el0\_svc+0x38/0x68
do\_el0\_svc+0x1c/0x28
el0\_svc\_common+0x80/0xe0
invoke\_syscall+0x58/0x114
\_\_arm64\_sys\_read+0x1c/0x2c
ksys\_read+0x78/0xe8
vfs\_read+0x1e0/0x2c8
kernfs\_fop\_read\_iter+0x68/0x1b4
seq\_read\_iter+0x158/0x4ec
kernfs\_seq\_show+0x44/0x54
sysfs\_kf\_seq\_show+0xb4/0x130
dev\_attr\_show+0x38/0x74
brightness\_show+0x20/0x4c
dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874295][ T4013] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000060
[ 3313.874301][ T4013] Mem abort info:
[ 3313.874303][ T4013] ESR = 0x0000000096000006
[ 3313.874305][ T4013] EC = 0x25: DABT (current EL), IL = 32 bits
[ 3313.874307][ T4013] SET = 0, FnV = 0
[ 3313.874309][ T4013] EA = 0, S1PTW = 0
[ 3313.874311][ T4013] FSC = 0x06: level 2 translation fault
[ 3313.874313][ T4013] Data abort info:
[ 3313.874314][ T4013] ISV = 0, ISS = 0x00000006, ISS2 = 0x00000000
[ 3313.874316][ T4013] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 3313.874318][ T4013] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 3313.874320][ T4013] user pgtable: 4k pages, 39-bit VAs, pgdp=00000008f2b0a000
..
[ 3313.874332][ T4013] Dumping ftrace buffer:
[ 3313.874334][ T4013] (ftrace buffer empty)
..
..
[ dd3313.874639][ T4013] CPU: 6 PID: 4013 Comm: InputReader
[ 3313.874648][ T4013] pc : dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874653][ T4013] lr : led\_update\_brightness+0x38/0x60
[ 3313.874656][ T4013] sp : ffffffc0b910bbd0
..
..
[ 3313.874685][ T4013] Call trace:
[ 3313.874687][ T4013] dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874690][ T4013] brightness\_show+0x20/0x4c
[ 3313.874692][ T4013] dev\_attr\_show+0x38/0x74
[ 3313.874696][ T4013] sysfs\_kf\_seq\_show+0xb4/0x130
[ 3313.874700][ T4013] kernfs\_seq\_show+0x44/0x54
[ 3313.874703][ T4013] seq\_read\_iter+0x158/0x4ec
[ 3313.874705][ T4013] kernfs\_fop\_read\_iter+0x68/0x1b4
[ 3313.874708][ T4013] vfs\_read+0x1e0/0x2c8
[ 3313.874711][ T4013] ksys\_read+0x78/0xe8
[ 3313.874714][ T4013] \_\_arm64\_sys\_read+0x1c/0x2c
[ 3313.874718][ T4013] invoke\_syscall+0x58/0x114
[ 3313.874721][ T4013] el0\_svc\_common+0x80/0xe0
[ 3313.874724][ T4013] do\_el0\_svc+0x1c/0x28
[ 3313.874727][ T4013] el0\_svc+0x38/0x68
[ 3313.874730][ T4013] el0t\_64\_sync\_handler+0x68/0xbc
[ 3313.874732][ T4013] el0t\_64\_sync+0x1a8/0x1ac
Signed-off-by: Mukesh Ojha <quic\_mojha@quicinc.com>
Reviewed-by: Anish Kumar <yesanishhere@gmail.com>
Link: [https://lore.kernel.org/r/20241103160527.82487-1-quic\_mojha@quicinc.com](https://lore.kernel.org/r/20241103160527.82487-1-quic_mojha%40quicinc.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21)

| -rw-r--r-- | [drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/leds/led-class.c?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/leds.h?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/leds/led-class.c b/drivers/leds/led-class.cindex e28a4bb716032b..d7c1f2263a57a2 100644--- a/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=3dd2c5cb2c698a02a4ed2ea0acb7c9909374a8bf)+++ b/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21)@@ -28,11 +28,14 @@ static ssize\_t brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int brightness; - /\* no lock needed for this \*/+ mutex\_lock(&led\_cdev->led\_access); led\_update\_brightness(led\_cdev);+ brightness = led\_cdev->brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->brightness);+ return sprintf(buf, "%u\n", brightness); }  static ssize\_t brightness\_store(struct device \*dev,@@ -69,8 +72,13 @@ static ssize\_t max\_brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int max\_brightness;++ mutex\_lock(&led\_cdev->led\_access);+ max\_brightness = led\_cdev->max\_brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->max\_brightness);+ return sprintf(buf, "%u\n", max\_brightness); } static DEVICE\_ATTR\_RO(max\_brightness); diff --git a/include/linux/leds.h b/include/linux/leds.hindex 6a8d6409c993ed..d8b4a73454e96f 100644--- a/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=3dd2c5cb2c698a02a4ed2ea0acb7c9909374a8bf)+++ b/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=ddcfc5708da9972ac23a9121b3d819b0a53d6f21)@@ -155,7 +155,7 @@ struct led\_classdev { struct kernfs\_node \*brightness\_hw\_changed\_kn; #endif - /\* Ensures consistent access to the LED Flash Class device \*/+ /\* Ensures consistent access to the LED class device \*/ struct mutex led\_access; }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:40:50 +0000



=== Content from git.kernel.org_ce188ec6_20250115_094214.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mukesh Ojha <quic\_mojha@quicinc.com> | 2024-11-03 21:35:27 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:00:12 +0100 |
| commit | [f6d6fb563e4be245a17bc4261a4b294e8bf8a31e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e)) | |
| tree | [491398f290c0853677a01809c9815452e8d6df7b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e) | |
| parent | [8d37cb1c8f1a9c0830c47ae7d194b47547737509](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d37cb1c8f1a9c0830c47ae7d194b47547737509) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e&id2=8d37cb1c8f1a9c0830c47ae7d194b47547737509)) | |
| download | [linux-f6d6fb563e4be245a17bc4261a4b294e8bf8a31e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f6d6fb563e4be245a17bc4261a4b294e8bf8a31e.tar.gz) | |

leds: class: Protect brightness\_show() with led\_cdev->led\_access mutex[ Upstream commit 4ca7cd938725a4050dcd62ae9472e931d603118d ]
There is NULL pointer issue observed if from Process A where hid device
being added which results in adding a led\_cdev addition and later a
another call to access of led\_cdev attribute from Process B can result
in NULL pointer issue.
Use mutex led\_cdev->led\_access to protect access to led->cdev and its
attribute inside brightness\_show() and max\_brightness\_show() and also
update the comment for mutex that it should be used to protect the led
class device fields.
Process A Process B
kthread+0x114
worker\_thread+0x244
process\_scheduled\_works+0x248
uhid\_device\_add\_worker+0x24
hid\_add\_device+0x120
device\_add+0x268
bus\_probe\_device+0x94
device\_initial\_probe+0x14
\_\_device\_attach+0xfc
bus\_for\_each\_drv+0x10c
\_\_device\_attach\_driver+0x14c
driver\_probe\_device+0x3c
\_\_driver\_probe\_device+0xa0
really\_probe+0x190
hid\_device\_probe+0x130
ps\_probe+0x990
ps\_led\_register+0x94
devm\_led\_classdev\_register\_ext+0x58
led\_classdev\_register\_ext+0x1f8
device\_create\_with\_groups+0x48
device\_create\_groups\_vargs+0xc8
device\_add+0x244
kobject\_uevent+0x14
kobject\_uevent\_env[jt]+0x224
mutex\_unlock[jt]+0xc4
\_\_mutex\_unlock\_slowpath+0xd4
wake\_up\_q+0x70
try\_to\_wake\_up[jt]+0x48c
preempt\_schedule\_common+0x28
\_\_schedule+0x628
\_\_switch\_to+0x174
el0t\_64\_sync+0x1a8/0x1ac
el0t\_64\_sync\_handler+0x68/0xbc
el0\_svc+0x38/0x68
do\_el0\_svc+0x1c/0x28
el0\_svc\_common+0x80/0xe0
invoke\_syscall+0x58/0x114
\_\_arm64\_sys\_read+0x1c/0x2c
ksys\_read+0x78/0xe8
vfs\_read+0x1e0/0x2c8
kernfs\_fop\_read\_iter+0x68/0x1b4
seq\_read\_iter+0x158/0x4ec
kernfs\_seq\_show+0x44/0x54
sysfs\_kf\_seq\_show+0xb4/0x130
dev\_attr\_show+0x38/0x74
brightness\_show+0x20/0x4c
dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874295][ T4013] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000060
[ 3313.874301][ T4013] Mem abort info:
[ 3313.874303][ T4013] ESR = 0x0000000096000006
[ 3313.874305][ T4013] EC = 0x25: DABT (current EL), IL = 32 bits
[ 3313.874307][ T4013] SET = 0, FnV = 0
[ 3313.874309][ T4013] EA = 0, S1PTW = 0
[ 3313.874311][ T4013] FSC = 0x06: level 2 translation fault
[ 3313.874313][ T4013] Data abort info:
[ 3313.874314][ T4013] ISV = 0, ISS = 0x00000006, ISS2 = 0x00000000
[ 3313.874316][ T4013] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 3313.874318][ T4013] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 3313.874320][ T4013] user pgtable: 4k pages, 39-bit VAs, pgdp=00000008f2b0a000
..
[ 3313.874332][ T4013] Dumping ftrace buffer:
[ 3313.874334][ T4013] (ftrace buffer empty)
..
..
[ dd3313.874639][ T4013] CPU: 6 PID: 4013 Comm: InputReader
[ 3313.874648][ T4013] pc : dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874653][ T4013] lr : led\_update\_brightness+0x38/0x60
[ 3313.874656][ T4013] sp : ffffffc0b910bbd0
..
..
[ 3313.874685][ T4013] Call trace:
[ 3313.874687][ T4013] dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874690][ T4013] brightness\_show+0x20/0x4c
[ 3313.874692][ T4013] dev\_attr\_show+0x38/0x74
[ 3313.874696][ T4013] sysfs\_kf\_seq\_show+0xb4/0x130
[ 3313.874700][ T4013] kernfs\_seq\_show+0x44/0x54
[ 3313.874703][ T4013] seq\_read\_iter+0x158/0x4ec
[ 3313.874705][ T4013] kernfs\_fop\_read\_iter+0x68/0x1b4
[ 3313.874708][ T4013] vfs\_read+0x1e0/0x2c8
[ 3313.874711][ T4013] ksys\_read+0x78/0xe8
[ 3313.874714][ T4013] \_\_arm64\_sys\_read+0x1c/0x2c
[ 3313.874718][ T4013] invoke\_syscall+0x58/0x114
[ 3313.874721][ T4013] el0\_svc\_common+0x80/0xe0
[ 3313.874724][ T4013] do\_el0\_svc+0x1c/0x28
[ 3313.874727][ T4013] el0\_svc+0x38/0x68
[ 3313.874730][ T4013] el0t\_64\_sync\_handler+0x68/0xbc
[ 3313.874732][ T4013] el0t\_64\_sync+0x1a8/0x1ac
Signed-off-by: Mukesh Ojha <quic\_mojha@quicinc.com>
Reviewed-by: Anish Kumar <yesanishhere@gmail.com>
Link: [https://lore.kernel.org/r/20241103160527.82487-1-quic\_mojha@quicinc.com](https://lore.kernel.org/r/20241103160527.82487-1-quic_mojha%40quicinc.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e)

| -rw-r--r-- | [drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/leds/led-class.c?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/leds.h?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/leds/led-class.c b/drivers/leds/led-class.cindex c66d1bead0a4a3..e7d75716632b8b 100644--- a/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=8d37cb1c8f1a9c0830c47ae7d194b47547737509)+++ b/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e)@@ -29,11 +29,14 @@ static ssize\_t brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int brightness; - /\* no lock needed for this \*/+ mutex\_lock(&led\_cdev->led\_access); led\_update\_brightness(led\_cdev);+ brightness = led\_cdev->brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->brightness);+ return sprintf(buf, "%u\n", brightness); }  static ssize\_t brightness\_store(struct device \*dev,@@ -70,8 +73,13 @@ static ssize\_t max\_brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int max\_brightness;++ mutex\_lock(&led\_cdev->led\_access);+ max\_brightness = led\_cdev->max\_brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->max\_brightness);+ return sprintf(buf, "%u\n", max\_brightness); } static DEVICE\_ATTR\_RO(max\_brightness); diff --git a/include/linux/leds.h b/include/linux/leds.hindex d3056bc6f0a1a3..e91802cdc41611 100644--- a/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=8d37cb1c8f1a9c0830c47ae7d194b47547737509)+++ b/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=f6d6fb563e4be245a17bc4261a4b294e8bf8a31e)@@ -244,7 +244,7 @@ struct led\_classdev { struct kernfs\_node \*brightness\_hw\_changed\_kn; #endif - /\* Ensures consistent access to the LED Flash Class device \*/+ /\* Ensures consistent access to the LED class device \*/ struct mutex led\_access; }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:40:51 +0000



=== Content from git.kernel.org_4b779ea3_20250115_094212.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mukesh Ojha <quic\_mojha@quicinc.com> | 2024-11-03 21:35:27 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:41 +0100 |
| commit | [b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1)) | |
| tree | [0ace47a6b5c2801f33def9cffee33572b08e8855](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1) | |
| parent | [2174bbc235f79fce88ea71fd08cf836568fcad5f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2174bbc235f79fce88ea71fd08cf836568fcad5f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1&id2=2174bbc235f79fce88ea71fd08cf836568fcad5f)) | |
| download | [linux-b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1.tar.gz) | |

leds: class: Protect brightness\_show() with led\_cdev->led\_access mutex[ Upstream commit 4ca7cd938725a4050dcd62ae9472e931d603118d ]
There is NULL pointer issue observed if from Process A where hid device
being added which results in adding a led\_cdev addition and later a
another call to access of led\_cdev attribute from Process B can result
in NULL pointer issue.
Use mutex led\_cdev->led\_access to protect access to led->cdev and its
attribute inside brightness\_show() and max\_brightness\_show() and also
update the comment for mutex that it should be used to protect the led
class device fields.
Process A Process B
kthread+0x114
worker\_thread+0x244
process\_scheduled\_works+0x248
uhid\_device\_add\_worker+0x24
hid\_add\_device+0x120
device\_add+0x268
bus\_probe\_device+0x94
device\_initial\_probe+0x14
\_\_device\_attach+0xfc
bus\_for\_each\_drv+0x10c
\_\_device\_attach\_driver+0x14c
driver\_probe\_device+0x3c
\_\_driver\_probe\_device+0xa0
really\_probe+0x190
hid\_device\_probe+0x130
ps\_probe+0x990
ps\_led\_register+0x94
devm\_led\_classdev\_register\_ext+0x58
led\_classdev\_register\_ext+0x1f8
device\_create\_with\_groups+0x48
device\_create\_groups\_vargs+0xc8
device\_add+0x244
kobject\_uevent+0x14
kobject\_uevent\_env[jt]+0x224
mutex\_unlock[jt]+0xc4
\_\_mutex\_unlock\_slowpath+0xd4
wake\_up\_q+0x70
try\_to\_wake\_up[jt]+0x48c
preempt\_schedule\_common+0x28
\_\_schedule+0x628
\_\_switch\_to+0x174
el0t\_64\_sync+0x1a8/0x1ac
el0t\_64\_sync\_handler+0x68/0xbc
el0\_svc+0x38/0x68
do\_el0\_svc+0x1c/0x28
el0\_svc\_common+0x80/0xe0
invoke\_syscall+0x58/0x114
\_\_arm64\_sys\_read+0x1c/0x2c
ksys\_read+0x78/0xe8
vfs\_read+0x1e0/0x2c8
kernfs\_fop\_read\_iter+0x68/0x1b4
seq\_read\_iter+0x158/0x4ec
kernfs\_seq\_show+0x44/0x54
sysfs\_kf\_seq\_show+0xb4/0x130
dev\_attr\_show+0x38/0x74
brightness\_show+0x20/0x4c
dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874295][ T4013] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000060
[ 3313.874301][ T4013] Mem abort info:
[ 3313.874303][ T4013] ESR = 0x0000000096000006
[ 3313.874305][ T4013] EC = 0x25: DABT (current EL), IL = 32 bits
[ 3313.874307][ T4013] SET = 0, FnV = 0
[ 3313.874309][ T4013] EA = 0, S1PTW = 0
[ 3313.874311][ T4013] FSC = 0x06: level 2 translation fault
[ 3313.874313][ T4013] Data abort info:
[ 3313.874314][ T4013] ISV = 0, ISS = 0x00000006, ISS2 = 0x00000000
[ 3313.874316][ T4013] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 3313.874318][ T4013] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 3313.874320][ T4013] user pgtable: 4k pages, 39-bit VAs, pgdp=00000008f2b0a000
..
[ 3313.874332][ T4013] Dumping ftrace buffer:
[ 3313.874334][ T4013] (ftrace buffer empty)
..
..
[ dd3313.874639][ T4013] CPU: 6 PID: 4013 Comm: InputReader
[ 3313.874648][ T4013] pc : dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874653][ T4013] lr : led\_update\_brightness+0x38/0x60
[ 3313.874656][ T4013] sp : ffffffc0b910bbd0
..
..
[ 3313.874685][ T4013] Call trace:
[ 3313.874687][ T4013] dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874690][ T4013] brightness\_show+0x20/0x4c
[ 3313.874692][ T4013] dev\_attr\_show+0x38/0x74
[ 3313.874696][ T4013] sysfs\_kf\_seq\_show+0xb4/0x130
[ 3313.874700][ T4013] kernfs\_seq\_show+0x44/0x54
[ 3313.874703][ T4013] seq\_read\_iter+0x158/0x4ec
[ 3313.874705][ T4013] kernfs\_fop\_read\_iter+0x68/0x1b4
[ 3313.874708][ T4013] vfs\_read+0x1e0/0x2c8
[ 3313.874711][ T4013] ksys\_read+0x78/0xe8
[ 3313.874714][ T4013] \_\_arm64\_sys\_read+0x1c/0x2c
[ 3313.874718][ T4013] invoke\_syscall+0x58/0x114
[ 3313.874721][ T4013] el0\_svc\_common+0x80/0xe0
[ 3313.874724][ T4013] do\_el0\_svc+0x1c/0x28
[ 3313.874727][ T4013] el0\_svc+0x38/0x68
[ 3313.874730][ T4013] el0t\_64\_sync\_handler+0x68/0xbc
[ 3313.874732][ T4013] el0t\_64\_sync+0x1a8/0x1ac
Signed-off-by: Mukesh Ojha <quic\_mojha@quicinc.com>
Reviewed-by: Anish Kumar <yesanishhere@gmail.com>
Link: [https://lore.kernel.org/r/20241103160527.82487-1-quic\_mojha@quicinc.com](https://lore.kernel.org/r/20241103160527.82487-1-quic_mojha%40quicinc.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1)

| -rw-r--r-- | [drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/leds/led-class.c?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/leds.h?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/leds/led-class.c b/drivers/leds/led-class.cindex 6e88df4c87fa81..1e4fed64aee18d 100644--- a/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=2174bbc235f79fce88ea71fd08cf836568fcad5f)+++ b/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1)@@ -28,11 +28,14 @@ static ssize\_t brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int brightness; - /\* no lock needed for this \*/+ mutex\_lock(&led\_cdev->led\_access); led\_update\_brightness(led\_cdev);+ brightness = led\_cdev->brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->brightness);+ return sprintf(buf, "%u\n", brightness); }  static ssize\_t brightness\_store(struct device \*dev,@@ -69,8 +72,13 @@ static ssize\_t max\_brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int max\_brightness;++ mutex\_lock(&led\_cdev->led\_access);+ max\_brightness = led\_cdev->max\_brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->max\_brightness);+ return sprintf(buf, "%u\n", max\_brightness); } static DEVICE\_ATTR\_RO(max\_brightness); diff --git a/include/linux/leds.h b/include/linux/leds.hindex 79ab2dfd3c72f1..01fccb1c50010a 100644--- a/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=2174bbc235f79fce88ea71fd08cf836568fcad5f)+++ b/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=b8283d52ed15c02bb2eb9b1b8644dcc34f8e98f1)@@ -161,7 +161,7 @@ struct led\_classdev { struct kernfs\_node \*brightness\_hw\_changed\_kn; #endif - /\* Ensures consistent access to the LED Flash Class device \*/+ /\* Ensures consistent access to the LED class device \*/ struct mutex led\_access; }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:40:49 +0000



=== Content from git.kernel.org_45891447_20250115_094211.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mukesh Ojha <quic\_mojha@quicinc.com> | 2024-11-03 21:35:27 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:53 +0100 |
| commit | [84b42d5b5fcd767c9b7f30b0b32065ed949fe804](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804)) | |
| tree | [b3c674826b8eb485121ce51d46b6cd145708817c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804) | |
| parent | [c67aeff2894c32a4b2f1d43ec5bf84ae418e4360](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c67aeff2894c32a4b2f1d43ec5bf84ae418e4360) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804&id2=c67aeff2894c32a4b2f1d43ec5bf84ae418e4360)) | |
| download | [linux-84b42d5b5fcd767c9b7f30b0b32065ed949fe804.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-84b42d5b5fcd767c9b7f30b0b32065ed949fe804.tar.gz) | |

leds: class: Protect brightness\_show() with led\_cdev->led\_access mutex[ Upstream commit 4ca7cd938725a4050dcd62ae9472e931d603118d ]
There is NULL pointer issue observed if from Process A where hid device
being added which results in adding a led\_cdev addition and later a
another call to access of led\_cdev attribute from Process B can result
in NULL pointer issue.
Use mutex led\_cdev->led\_access to protect access to led->cdev and its
attribute inside brightness\_show() and max\_brightness\_show() and also
update the comment for mutex that it should be used to protect the led
class device fields.
Process A Process B
kthread+0x114
worker\_thread+0x244
process\_scheduled\_works+0x248
uhid\_device\_add\_worker+0x24
hid\_add\_device+0x120
device\_add+0x268
bus\_probe\_device+0x94
device\_initial\_probe+0x14
\_\_device\_attach+0xfc
bus\_for\_each\_drv+0x10c
\_\_device\_attach\_driver+0x14c
driver\_probe\_device+0x3c
\_\_driver\_probe\_device+0xa0
really\_probe+0x190
hid\_device\_probe+0x130
ps\_probe+0x990
ps\_led\_register+0x94
devm\_led\_classdev\_register\_ext+0x58
led\_classdev\_register\_ext+0x1f8
device\_create\_with\_groups+0x48
device\_create\_groups\_vargs+0xc8
device\_add+0x244
kobject\_uevent+0x14
kobject\_uevent\_env[jt]+0x224
mutex\_unlock[jt]+0xc4
\_\_mutex\_unlock\_slowpath+0xd4
wake\_up\_q+0x70
try\_to\_wake\_up[jt]+0x48c
preempt\_schedule\_common+0x28
\_\_schedule+0x628
\_\_switch\_to+0x174
el0t\_64\_sync+0x1a8/0x1ac
el0t\_64\_sync\_handler+0x68/0xbc
el0\_svc+0x38/0x68
do\_el0\_svc+0x1c/0x28
el0\_svc\_common+0x80/0xe0
invoke\_syscall+0x58/0x114
\_\_arm64\_sys\_read+0x1c/0x2c
ksys\_read+0x78/0xe8
vfs\_read+0x1e0/0x2c8
kernfs\_fop\_read\_iter+0x68/0x1b4
seq\_read\_iter+0x158/0x4ec
kernfs\_seq\_show+0x44/0x54
sysfs\_kf\_seq\_show+0xb4/0x130
dev\_attr\_show+0x38/0x74
brightness\_show+0x20/0x4c
dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874295][ T4013] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000060
[ 3313.874301][ T4013] Mem abort info:
[ 3313.874303][ T4013] ESR = 0x0000000096000006
[ 3313.874305][ T4013] EC = 0x25: DABT (current EL), IL = 32 bits
[ 3313.874307][ T4013] SET = 0, FnV = 0
[ 3313.874309][ T4013] EA = 0, S1PTW = 0
[ 3313.874311][ T4013] FSC = 0x06: level 2 translation fault
[ 3313.874313][ T4013] Data abort info:
[ 3313.874314][ T4013] ISV = 0, ISS = 0x00000006, ISS2 = 0x00000000
[ 3313.874316][ T4013] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 3313.874318][ T4013] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 3313.874320][ T4013] user pgtable: 4k pages, 39-bit VAs, pgdp=00000008f2b0a000
..
[ 3313.874332][ T4013] Dumping ftrace buffer:
[ 3313.874334][ T4013] (ftrace buffer empty)
..
..
[ dd3313.874639][ T4013] CPU: 6 PID: 4013 Comm: InputReader
[ 3313.874648][ T4013] pc : dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874653][ T4013] lr : led\_update\_brightness+0x38/0x60
[ 3313.874656][ T4013] sp : ffffffc0b910bbd0
..
..
[ 3313.874685][ T4013] Call trace:
[ 3313.874687][ T4013] dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874690][ T4013] brightness\_show+0x20/0x4c
[ 3313.874692][ T4013] dev\_attr\_show+0x38/0x74
[ 3313.874696][ T4013] sysfs\_kf\_seq\_show+0xb4/0x130
[ 3313.874700][ T4013] kernfs\_seq\_show+0x44/0x54
[ 3313.874703][ T4013] seq\_read\_iter+0x158/0x4ec
[ 3313.874705][ T4013] kernfs\_fop\_read\_iter+0x68/0x1b4
[ 3313.874708][ T4013] vfs\_read+0x1e0/0x2c8
[ 3313.874711][ T4013] ksys\_read+0x78/0xe8
[ 3313.874714][ T4013] \_\_arm64\_sys\_read+0x1c/0x2c
[ 3313.874718][ T4013] invoke\_syscall+0x58/0x114
[ 3313.874721][ T4013] el0\_svc\_common+0x80/0xe0
[ 3313.874724][ T4013] do\_el0\_svc+0x1c/0x28
[ 3313.874727][ T4013] el0\_svc+0x38/0x68
[ 3313.874730][ T4013] el0t\_64\_sync\_handler+0x68/0xbc
[ 3313.874732][ T4013] el0t\_64\_sync+0x1a8/0x1ac
Signed-off-by: Mukesh Ojha <quic\_mojha@quicinc.com>
Reviewed-by: Anish Kumar <yesanishhere@gmail.com>
Link: [https://lore.kernel.org/r/20241103160527.82487-1-quic\_mojha@quicinc.com](https://lore.kernel.org/r/20241103160527.82487-1-quic_mojha%40quicinc.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804)

| -rw-r--r-- | [drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/leds/led-class.c?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/leds.h?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/leds/led-class.c b/drivers/leds/led-class.cindex 0a4823d9797ae0..a9f37e82278812 100644--- a/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=c67aeff2894c32a4b2f1d43ec5bf84ae418e4360)+++ b/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804)@@ -27,11 +27,14 @@ static ssize\_t brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int brightness; - /\* no lock needed for this \*/+ mutex\_lock(&led\_cdev->led\_access); led\_update\_brightness(led\_cdev);+ brightness = led\_cdev->brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->brightness);+ return sprintf(buf, "%u\n", brightness); }  static ssize\_t brightness\_store(struct device \*dev,@@ -68,8 +71,13 @@ static ssize\_t max\_brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int max\_brightness;++ mutex\_lock(&led\_cdev->led\_access);+ max\_brightness = led\_cdev->max\_brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->max\_brightness);+ return sprintf(buf, "%u\n", max\_brightness); } static DEVICE\_ATTR\_RO(max\_brightness); diff --git a/include/linux/leds.h b/include/linux/leds.hindex efb309dba914a9..ef68aa9a00ff7f 100644--- a/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=c67aeff2894c32a4b2f1d43ec5bf84ae418e4360)+++ b/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=84b42d5b5fcd767c9b7f30b0b32065ed949fe804)@@ -146,7 +146,7 @@ struct led\_classdev { struct kernfs\_node \*brightness\_hw\_changed\_kn; #endif - /\* Ensures consistent access to the LED Flash Class device \*/+ /\* Ensures consistent access to the LED class device \*/ struct mutex led\_access; }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:40:48 +0000



=== Content from git.kernel.org_98bc2959_20250115_094209.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4ca7cd938725a4050dcd62ae9472e931d603118d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4ca7cd938725a4050dcd62ae9472e931d603118d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ca7cd938725a4050dcd62ae9472e931d603118d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4ca7cd938725a4050dcd62ae9472e931d603118d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mukesh Ojha <quic\_mojha@quicinc.com> | 2024-11-03 21:35:27 +0530 |
| --- | --- | --- |
| committer | Lee Jones <lee@kernel.org> | 2024-11-06 08:42:59 +0000 |
| commit | [4ca7cd938725a4050dcd62ae9472e931d603118d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ca7cd938725a4050dcd62ae9472e931d603118d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4ca7cd938725a4050dcd62ae9472e931d603118d)) | |
| tree | [15128844650ae80b7b7dbf51d7106319da292fad](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4ca7cd938725a4050dcd62ae9472e931d603118d) | |
| parent | [95c65546f03f888481eda98b499947252e1f3b20](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95c65546f03f888481eda98b499947252e1f3b20) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4ca7cd938725a4050dcd62ae9472e931d603118d&id2=95c65546f03f888481eda98b499947252e1f3b20)) | |
| download | [linux-4ca7cd938725a4050dcd62ae9472e931d603118d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4ca7cd938725a4050dcd62ae9472e931d603118d.tar.gz) | |

leds: class: Protect brightness\_show() with led\_cdev->led\_access mutexThere is NULL pointer issue observed if from Process A where hid device
being added which results in adding a led\_cdev addition and later a
another call to access of led\_cdev attribute from Process B can result
in NULL pointer issue.
Use mutex led\_cdev->led\_access to protect access to led->cdev and its
attribute inside brightness\_show() and max\_brightness\_show() and also
update the comment for mutex that it should be used to protect the led
class device fields.
Process A Process B
kthread+0x114
worker\_thread+0x244
process\_scheduled\_works+0x248
uhid\_device\_add\_worker+0x24
hid\_add\_device+0x120
device\_add+0x268
bus\_probe\_device+0x94
device\_initial\_probe+0x14
\_\_device\_attach+0xfc
bus\_for\_each\_drv+0x10c
\_\_device\_attach\_driver+0x14c
driver\_probe\_device+0x3c
\_\_driver\_probe\_device+0xa0
really\_probe+0x190
hid\_device\_probe+0x130
ps\_probe+0x990
ps\_led\_register+0x94
devm\_led\_classdev\_register\_ext+0x58
led\_classdev\_register\_ext+0x1f8
device\_create\_with\_groups+0x48
device\_create\_groups\_vargs+0xc8
device\_add+0x244
kobject\_uevent+0x14
kobject\_uevent\_env[jt]+0x224
mutex\_unlock[jt]+0xc4
\_\_mutex\_unlock\_slowpath+0xd4
wake\_up\_q+0x70
try\_to\_wake\_up[jt]+0x48c
preempt\_schedule\_common+0x28
\_\_schedule+0x628
\_\_switch\_to+0x174
el0t\_64\_sync+0x1a8/0x1ac
el0t\_64\_sync\_handler+0x68/0xbc
el0\_svc+0x38/0x68
do\_el0\_svc+0x1c/0x28
el0\_svc\_common+0x80/0xe0
invoke\_syscall+0x58/0x114
\_\_arm64\_sys\_read+0x1c/0x2c
ksys\_read+0x78/0xe8
vfs\_read+0x1e0/0x2c8
kernfs\_fop\_read\_iter+0x68/0x1b4
seq\_read\_iter+0x158/0x4ec
kernfs\_seq\_show+0x44/0x54
sysfs\_kf\_seq\_show+0xb4/0x130
dev\_attr\_show+0x38/0x74
brightness\_show+0x20/0x4c
dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874295][ T4013] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000060
[ 3313.874301][ T4013] Mem abort info:
[ 3313.874303][ T4013] ESR = 0x0000000096000006
[ 3313.874305][ T4013] EC = 0x25: DABT (current EL), IL = 32 bits
[ 3313.874307][ T4013] SET = 0, FnV = 0
[ 3313.874309][ T4013] EA = 0, S1PTW = 0
[ 3313.874311][ T4013] FSC = 0x06: level 2 translation fault
[ 3313.874313][ T4013] Data abort info:
[ 3313.874314][ T4013] ISV = 0, ISS = 0x00000006, ISS2 = 0x00000000
[ 3313.874316][ T4013] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 3313.874318][ T4013] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 3313.874320][ T4013] user pgtable: 4k pages, 39-bit VAs, pgdp=00000008f2b0a000
..
[ 3313.874332][ T4013] Dumping ftrace buffer:
[ 3313.874334][ T4013] (ftrace buffer empty)
..
..
[ dd3313.874639][ T4013] CPU: 6 PID: 4013 Comm: InputReader
[ 3313.874648][ T4013] pc : dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874653][ T4013] lr : led\_update\_brightness+0x38/0x60
[ 3313.874656][ T4013] sp : ffffffc0b910bbd0
..
..
[ 3313.874685][ T4013] Call trace:
[ 3313.874687][ T4013] dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874690][ T4013] brightness\_show+0x20/0x4c
[ 3313.874692][ T4013] dev\_attr\_show+0x38/0x74
[ 3313.874696][ T4013] sysfs\_kf\_seq\_show+0xb4/0x130
[ 3313.874700][ T4013] kernfs\_seq\_show+0x44/0x54
[ 3313.874703][ T4013] seq\_read\_iter+0x158/0x4ec
[ 3313.874705][ T4013] kernfs\_fop\_read\_iter+0x68/0x1b4
[ 3313.874708][ T4013] vfs\_read+0x1e0/0x2c8
[ 3313.874711][ T4013] ksys\_read+0x78/0xe8
[ 3313.874714][ T4013] \_\_arm64\_sys\_read+0x1c/0x2c
[ 3313.874718][ T4013] invoke\_syscall+0x58/0x114
[ 3313.874721][ T4013] el0\_svc\_common+0x80/0xe0
[ 3313.874724][ T4013] do\_el0\_svc+0x1c/0x28
[ 3313.874727][ T4013] el0\_svc+0x38/0x68
[ 3313.874730][ T4013] el0t\_64\_sync\_handler+0x68/0xbc
[ 3313.874732][ T4013] el0t\_64\_sync+0x1a8/0x1ac
Signed-off-by: Mukesh Ojha <quic\_mojha@quicinc.com>
Reviewed-by: Anish Kumar <yesanishhere@gmail.com>
Link: [https://lore.kernel.org/r/20241103160527.82487-1-quic\_mojha@quicinc.com](https://lore.kernel.org/r/20241103160527.82487-1-quic_mojha%40quicinc.com)
Signed-off-by: Lee Jones <lee@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4ca7cd938725a4050dcd62ae9472e931d603118d)

| -rw-r--r-- | [drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/leds/led-class.c?id=4ca7cd938725a4050dcd62ae9472e931d603118d) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/leds.h?id=4ca7cd938725a4050dcd62ae9472e931d603118d) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/leds/led-class.c b/drivers/leds/led-class.cindex 83e512df47dcce..2a04ac61574d5f 100644--- a/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=95c65546f03f888481eda98b499947252e1f3b20)+++ b/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=4ca7cd938725a4050dcd62ae9472e931d603118d)@@ -31,11 +31,14 @@ static ssize\_t brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int brightness; - /\* no lock needed for this \*/+ mutex\_lock(&led\_cdev->led\_access); led\_update\_brightness(led\_cdev);+ brightness = led\_cdev->brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->brightness);+ return sprintf(buf, "%u\n", brightness); }  static ssize\_t brightness\_store(struct device \*dev,@@ -71,8 +74,13 @@ static ssize\_t max\_brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int max\_brightness;++ mutex\_lock(&led\_cdev->led\_access);+ max\_brightness = led\_cdev->max\_brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->max\_brightness);+ return sprintf(buf, "%u\n", max\_brightness); } static DEVICE\_ATTR\_RO(max\_brightness); diff --git a/include/linux/leds.h b/include/linux/leds.hindex 9f34b9facaadbd..98f9719c924cb7 100644--- a/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=95c65546f03f888481eda98b499947252e1f3b20)+++ b/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=4ca7cd938725a4050dcd62ae9472e931d603118d)@@ -239,7 +239,7 @@ struct led\_classdev { struct kernfs\_node \*brightness\_hw\_changed\_kn; #endif - /\* Ensures consistent access to the LED Flash Class device \*/+ /\* Ensures consistent access to the LED class device \*/ struct mutex led\_access; }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:40:46 +0000



=== Content from git.kernel.org_aa8454e5_20250115_094212.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mukesh Ojha <quic\_mojha@quicinc.com> | 2024-11-03 21:35:27 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:04:01 +0100 |
| commit | [bb4a6236a430cfc3713f470f3a969f39d6d4ca25](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25)) | |
| tree | [101f89bbef3a3b39910defe06d5de32ac285f1ea](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25) | |
| parent | [f29438bcfad0a3fcf69e3b8f7eeb41a0040b2347](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f29438bcfad0a3fcf69e3b8f7eeb41a0040b2347) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25&id2=f29438bcfad0a3fcf69e3b8f7eeb41a0040b2347)) | |
| download | [linux-bb4a6236a430cfc3713f470f3a969f39d6d4ca25.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bb4a6236a430cfc3713f470f3a969f39d6d4ca25.tar.gz) | |

leds: class: Protect brightness\_show() with led\_cdev->led\_access mutex[ Upstream commit 4ca7cd938725a4050dcd62ae9472e931d603118d ]
There is NULL pointer issue observed if from Process A where hid device
being added which results in adding a led\_cdev addition and later a
another call to access of led\_cdev attribute from Process B can result
in NULL pointer issue.
Use mutex led\_cdev->led\_access to protect access to led->cdev and its
attribute inside brightness\_show() and max\_brightness\_show() and also
update the comment for mutex that it should be used to protect the led
class device fields.
Process A Process B
kthread+0x114
worker\_thread+0x244
process\_scheduled\_works+0x248
uhid\_device\_add\_worker+0x24
hid\_add\_device+0x120
device\_add+0x268
bus\_probe\_device+0x94
device\_initial\_probe+0x14
\_\_device\_attach+0xfc
bus\_for\_each\_drv+0x10c
\_\_device\_attach\_driver+0x14c
driver\_probe\_device+0x3c
\_\_driver\_probe\_device+0xa0
really\_probe+0x190
hid\_device\_probe+0x130
ps\_probe+0x990
ps\_led\_register+0x94
devm\_led\_classdev\_register\_ext+0x58
led\_classdev\_register\_ext+0x1f8
device\_create\_with\_groups+0x48
device\_create\_groups\_vargs+0xc8
device\_add+0x244
kobject\_uevent+0x14
kobject\_uevent\_env[jt]+0x224
mutex\_unlock[jt]+0xc4
\_\_mutex\_unlock\_slowpath+0xd4
wake\_up\_q+0x70
try\_to\_wake\_up[jt]+0x48c
preempt\_schedule\_common+0x28
\_\_schedule+0x628
\_\_switch\_to+0x174
el0t\_64\_sync+0x1a8/0x1ac
el0t\_64\_sync\_handler+0x68/0xbc
el0\_svc+0x38/0x68
do\_el0\_svc+0x1c/0x28
el0\_svc\_common+0x80/0xe0
invoke\_syscall+0x58/0x114
\_\_arm64\_sys\_read+0x1c/0x2c
ksys\_read+0x78/0xe8
vfs\_read+0x1e0/0x2c8
kernfs\_fop\_read\_iter+0x68/0x1b4
seq\_read\_iter+0x158/0x4ec
kernfs\_seq\_show+0x44/0x54
sysfs\_kf\_seq\_show+0xb4/0x130
dev\_attr\_show+0x38/0x74
brightness\_show+0x20/0x4c
dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874295][ T4013] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000060
[ 3313.874301][ T4013] Mem abort info:
[ 3313.874303][ T4013] ESR = 0x0000000096000006
[ 3313.874305][ T4013] EC = 0x25: DABT (current EL), IL = 32 bits
[ 3313.874307][ T4013] SET = 0, FnV = 0
[ 3313.874309][ T4013] EA = 0, S1PTW = 0
[ 3313.874311][ T4013] FSC = 0x06: level 2 translation fault
[ 3313.874313][ T4013] Data abort info:
[ 3313.874314][ T4013] ISV = 0, ISS = 0x00000006, ISS2 = 0x00000000
[ 3313.874316][ T4013] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 3313.874318][ T4013] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 3313.874320][ T4013] user pgtable: 4k pages, 39-bit VAs, pgdp=00000008f2b0a000
..
[ 3313.874332][ T4013] Dumping ftrace buffer:
[ 3313.874334][ T4013] (ftrace buffer empty)
..
..
[ dd3313.874639][ T4013] CPU: 6 PID: 4013 Comm: InputReader
[ 3313.874648][ T4013] pc : dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874653][ T4013] lr : led\_update\_brightness+0x38/0x60
[ 3313.874656][ T4013] sp : ffffffc0b910bbd0
..
..
[ 3313.874685][ T4013] Call trace:
[ 3313.874687][ T4013] dualshock4\_led\_get\_brightness+0xc/0x74
[ 3313.874690][ T4013] brightness\_show+0x20/0x4c
[ 3313.874692][ T4013] dev\_attr\_show+0x38/0x74
[ 3313.874696][ T4013] sysfs\_kf\_seq\_show+0xb4/0x130
[ 3313.874700][ T4013] kernfs\_seq\_show+0x44/0x54
[ 3313.874703][ T4013] seq\_read\_iter+0x158/0x4ec
[ 3313.874705][ T4013] kernfs\_fop\_read\_iter+0x68/0x1b4
[ 3313.874708][ T4013] vfs\_read+0x1e0/0x2c8
[ 3313.874711][ T4013] ksys\_read+0x78/0xe8
[ 3313.874714][ T4013] \_\_arm64\_sys\_read+0x1c/0x2c
[ 3313.874718][ T4013] invoke\_syscall+0x58/0x114
[ 3313.874721][ T4013] el0\_svc\_common+0x80/0xe0
[ 3313.874724][ T4013] do\_el0\_svc+0x1c/0x28
[ 3313.874727][ T4013] el0\_svc+0x38/0x68
[ 3313.874730][ T4013] el0t\_64\_sync\_handler+0x68/0xbc
[ 3313.874732][ T4013] el0t\_64\_sync+0x1a8/0x1ac
Signed-off-by: Mukesh Ojha <quic\_mojha@quicinc.com>
Reviewed-by: Anish Kumar <yesanishhere@gmail.com>
Link: [https://lore.kernel.org/r/20241103160527.82487-1-quic\_mojha@quicinc.com](https://lore.kernel.org/r/20241103160527.82487-1-quic_mojha%40quicinc.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25)

| -rw-r--r-- | [drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/leds/led-class.c?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/leds.h?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/leds/led-class.c b/drivers/leds/led-class.cindex 06b97fd49ad9a2..f69f4e928d6143 100644--- a/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=f29438bcfad0a3fcf69e3b8f7eeb41a0040b2347)+++ b/[drivers/leds/led-class.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/leds/led-class.c?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25)@@ -29,11 +29,14 @@ static ssize\_t brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int brightness; - /\* no lock needed for this \*/+ mutex\_lock(&led\_cdev->led\_access); led\_update\_brightness(led\_cdev);+ brightness = led\_cdev->brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->brightness);+ return sprintf(buf, "%u\n", brightness); }  static ssize\_t brightness\_store(struct device \*dev,@@ -70,8 +73,13 @@ static ssize\_t max\_brightness\_show(struct device \*dev, struct device\_attribute \*attr, char \*buf) { struct led\_classdev \*led\_cdev = dev\_get\_drvdata(dev);+ unsigned int max\_brightness;++ mutex\_lock(&led\_cdev->led\_access);+ max\_brightness = led\_cdev->max\_brightness;+ mutex\_unlock(&led\_cdev->led\_access); - return sprintf(buf, "%u\n", led\_cdev->max\_brightness);+ return sprintf(buf, "%u\n", max\_brightness); } static DEVICE\_ATTR\_RO(max\_brightness); diff --git a/include/linux/leds.h b/include/linux/leds.hindex e5968c3ed4ae08..2337f516fa7c2c 100644--- a/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=f29438bcfad0a3fcf69e3b8f7eeb41a0040b2347)+++ b/[include/linux/leds.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/leds.h?id=bb4a6236a430cfc3713f470f3a969f39d6d4ca25)@@ -238,7 +238,7 @@ struct led\_classdev { struct kernfs\_node \*brightness\_hw\_changed\_kn; #endif - /\* Ensures consistent access to the LED Flash Class device \*/+ /\* Ensures consistent access to the LED class device \*/ struct mutex led\_access; }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:40:49 +0000


