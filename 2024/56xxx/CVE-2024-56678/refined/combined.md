=== Content from git.kernel.org_1ce810cd_20250114_225945.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 22:59:42 +0530 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2024-10-23 18:50:29 +1100 |
| commit | [06dbbb4d5f7126b6307ab807cbf04ecfc459b933](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933)) | |
| tree | [bccdfdacaeaf85f8c2f9bb84f80efea3d295c2ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933) | |
| parent | [05b94cae1c47f94588c3e7096963c1007c4d9c1d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933&id2=05b94cae1c47f94588c3e7096963c1007c4d9c1d)) | |
| download | [linux-06dbbb4d5f7126b6307ab807cbf04ecfc459b933.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-06dbbb4d5f7126b6307ab807cbf04ecfc459b933.tar.gz) | |

powerpc/mm/fault: Fix kfence page fault reportingcopy\_from\_kernel\_nofault() can be called when doing read of /proc/kcore.
/proc/kcore can have some unmapped kfence objects which when read via
copy\_from\_kernel\_nofault() can cause page faults. Since \*\_nofault()
functions define their own fixup table for handling fault, use that
instead of asking kfence to handle such faults.
Hence we search the exception tables for the nip which generated the
fault. If there is an entry then we let the fixup table handler handle the
page fault by returning an error from within \_\_\_do\_page\_fault().
This can be easily triggered if someone tries to do dd from /proc/kcore.
eg. dd if=/proc/kcore of=/dev/null bs=1M
Some example false negatives:
===============================
BUG: KFENCE: invalid read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Invalid read at 0xc0000000fdff0000:
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
BUG: KFENCE: use-after-free read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Use-after-free read at 0xc0000000fe050000 (in kfence-#2):
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
Fixes: 90cbac0e995d ("powerpc: Enable KFENCE for PPC32")
Suggested-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Reported-by: Disha Goel <disgoel@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Reviewed-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list@gmail.com](https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933)

| -rw-r--r-- | [arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/mm/fault.c?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/arch/powerpc/mm/fault.c b/arch/powerpc/mm/fault.cindex 81c77ddce2e30a..c156fe0d53c378 100644--- a/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d)+++ b/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=06dbbb4d5f7126b6307ab807cbf04ecfc459b933)@@ -439,10 +439,16 @@ static int \_\_\_do\_page\_fault(struct pt\_regs \*regs, unsigned long address, /\* \* The kernel should never take an execute fault nor should it \* take a page fault to a kernel address or a page fault to a user- \* address outside of dedicated places+ \* address outside of dedicated places.+ \*+ \* Rather than kfence directly reporting false negatives, search whether+ \* the NIP belongs to the fixup table for cases where fault could come+ \* from functions like copy\_from\_kernel\_nofault(). \*/ if (unlikely(!is\_user && bad\_kernel\_fault(regs, error\_code, address, is\_write))) {- if (kfence\_handle\_page\_fault(address, is\_write, regs))+ if (is\_kfence\_address((void \*)address) &&+ !search\_exception\_tables(instruction\_pointer(regs)) &&+ kfence\_handle\_page\_fault(address, is\_write, regs)) return 0;  return SIGSEGV; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:58:22 +0000



=== Content from git.kernel.org_9ac3de7b_20250114_225948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 22:59:42 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:01 +0100 |
| commit | [e0a470b5733c1fe068d5c58b0bb91ad539604bc6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)) | |
| tree | [b1fba5afded1b24b8807c82d5ba62bc27b72d0ea](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6) | |
| parent | [5fe7709251e334cc27618473299c48340cecd3c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5fe7709251e334cc27618473299c48340cecd3c8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6&id2=5fe7709251e334cc27618473299c48340cecd3c8)) | |
| download | [linux-e0a470b5733c1fe068d5c58b0bb91ad539604bc6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e0a470b5733c1fe068d5c58b0bb91ad539604bc6.tar.gz) | |

powerpc/mm/fault: Fix kfence page fault reporting[ Upstream commit 06dbbb4d5f7126b6307ab807cbf04ecfc459b933 ]
copy\_from\_kernel\_nofault() can be called when doing read of /proc/kcore.
/proc/kcore can have some unmapped kfence objects which when read via
copy\_from\_kernel\_nofault() can cause page faults. Since \*\_nofault()
functions define their own fixup table for handling fault, use that
instead of asking kfence to handle such faults.
Hence we search the exception tables for the nip which generated the
fault. If there is an entry then we let the fixup table handler handle the
page fault by returning an error from within \_\_\_do\_page\_fault().
This can be easily triggered if someone tries to do dd from /proc/kcore.
eg. dd if=/proc/kcore of=/dev/null bs=1M
Some example false negatives:
===============================
BUG: KFENCE: invalid read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Invalid read at 0xc0000000fdff0000:
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
BUG: KFENCE: use-after-free read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Use-after-free read at 0xc0000000fe050000 (in kfence-#2):
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
Fixes: 90cbac0e995d ("powerpc: Enable KFENCE for PPC32")
Suggested-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Reported-by: Disha Goel <disgoel@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Reviewed-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list@gmail.com](https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)

| -rw-r--r-- | [arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/mm/fault.c?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/arch/powerpc/mm/fault.c b/arch/powerpc/mm/fault.cindex 4a15172dfef29e..1e5fbef64076df 100644--- a/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=5fe7709251e334cc27618473299c48340cecd3c8)+++ b/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)@@ -412,10 +412,16 @@ static int \_\_\_do\_page\_fault(struct pt\_regs \*regs, unsigned long address, /\* \* The kernel should never take an execute fault nor should it \* take a page fault to a kernel address or a page fault to a user- \* address outside of dedicated places+ \* address outside of dedicated places.+ \*+ \* Rather than kfence directly reporting false negatives, search whether+ \* the NIP belongs to the fixup table for cases where fault could come+ \* from functions like copy\_from\_kernel\_nofault(). \*/ if (unlikely(!is\_user && bad\_kernel\_fault(regs, error\_code, address, is\_write))) {- if (kfence\_handle\_page\_fault(address, is\_write, regs))+ if (is\_kfence\_address((void \*)address) &&+ !search\_exception\_tables(instruction\_pointer(regs)) &&+ kfence\_handle\_page\_fault(address, is\_write, regs)) return 0;  return SIGSEGV; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:58:25 +0000



=== Content from git.kernel.org_3039c1ee_20250114_225946.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4d2655754e94741b159aa807b72ea85518a65fd5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d2655754e94741b159aa807b72ea85518a65fd5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d2655754e94741b159aa807b72ea85518a65fd5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d2655754e94741b159aa807b72ea85518a65fd5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 22:59:42 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:37 +0100 |
| commit | [4d2655754e94741b159aa807b72ea85518a65fd5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d2655754e94741b159aa807b72ea85518a65fd5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4d2655754e94741b159aa807b72ea85518a65fd5)) | |
| tree | [7dee59a62e16d34800d3c3b1b3f4e5705e4f34fe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d2655754e94741b159aa807b72ea85518a65fd5) | |
| parent | [24cbc37e837fd9e31e5024480b779207d1d99f1d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=24cbc37e837fd9e31e5024480b779207d1d99f1d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d2655754e94741b159aa807b72ea85518a65fd5&id2=24cbc37e837fd9e31e5024480b779207d1d99f1d)) | |
| download | [linux-4d2655754e94741b159aa807b72ea85518a65fd5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4d2655754e94741b159aa807b72ea85518a65fd5.tar.gz) | |

powerpc/mm/fault: Fix kfence page fault reporting[ Upstream commit 06dbbb4d5f7126b6307ab807cbf04ecfc459b933 ]
copy\_from\_kernel\_nofault() can be called when doing read of /proc/kcore.
/proc/kcore can have some unmapped kfence objects which when read via
copy\_from\_kernel\_nofault() can cause page faults. Since \*\_nofault()
functions define their own fixup table for handling fault, use that
instead of asking kfence to handle such faults.
Hence we search the exception tables for the nip which generated the
fault. If there is an entry then we let the fixup table handler handle the
page fault by returning an error from within \_\_\_do\_page\_fault().
This can be easily triggered if someone tries to do dd from /proc/kcore.
eg. dd if=/proc/kcore of=/dev/null bs=1M
Some example false negatives:
===============================
BUG: KFENCE: invalid read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Invalid read at 0xc0000000fdff0000:
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
BUG: KFENCE: use-after-free read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Use-after-free read at 0xc0000000fe050000 (in kfence-#2):
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
Fixes: 90cbac0e995d ("powerpc: Enable KFENCE for PPC32")
Suggested-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Reported-by: Disha Goel <disgoel@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Reviewed-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list@gmail.com](https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d2655754e94741b159aa807b72ea85518a65fd5)

| -rw-r--r-- | [arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/mm/fault.c?id=4d2655754e94741b159aa807b72ea85518a65fd5) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/arch/powerpc/mm/fault.c b/arch/powerpc/mm/fault.cindex 644e4ec6ce99d0..4b59315cb820a6 100644--- a/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=24cbc37e837fd9e31e5024480b779207d1d99f1d)+++ b/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=4d2655754e94741b159aa807b72ea85518a65fd5)@@ -431,10 +431,16 @@ static int \_\_\_do\_page\_fault(struct pt\_regs \*regs, unsigned long address, /\* \* The kernel should never take an execute fault nor should it \* take a page fault to a kernel address or a page fault to a user- \* address outside of dedicated places+ \* address outside of dedicated places.+ \*+ \* Rather than kfence directly reporting false negatives, search whether+ \* the NIP belongs to the fixup table for cases where fault could come+ \* from functions like copy\_from\_kernel\_nofault(). \*/ if (unlikely(!is\_user && bad\_kernel\_fault(regs, error\_code, address, is\_write))) {- if (kfence\_handle\_page\_fault(address, is\_write, regs))+ if (is\_kfence\_address((void \*)address) &&+ !search\_exception\_tables(instruction\_pointer(regs)) &&+ kfence\_handle\_page\_fault(address, is\_write, regs)) return 0;  return SIGSEGV; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:58:23 +0000



=== Content from git.kernel.org_902b7239_20250114_225947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 22:59:42 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:33 +0100 |
| commit | [7eaeb7a49b6d16640f9f3c9074c05175d74c710b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b)) | |
| tree | [5efefd9f4f1e8bbf43dffa5a5bd0775b2ce5865b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b) | |
| parent | [bdd11a04d102f8310812aa7cec39545fdd6662d1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdd11a04d102f8310812aa7cec39545fdd6662d1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b&id2=bdd11a04d102f8310812aa7cec39545fdd6662d1)) | |
| download | [linux-7eaeb7a49b6d16640f9f3c9074c05175d74c710b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7eaeb7a49b6d16640f9f3c9074c05175d74c710b.tar.gz) | |

powerpc/mm/fault: Fix kfence page fault reporting[ Upstream commit 06dbbb4d5f7126b6307ab807cbf04ecfc459b933 ]
copy\_from\_kernel\_nofault() can be called when doing read of /proc/kcore.
/proc/kcore can have some unmapped kfence objects which when read via
copy\_from\_kernel\_nofault() can cause page faults. Since \*\_nofault()
functions define their own fixup table for handling fault, use that
instead of asking kfence to handle such faults.
Hence we search the exception tables for the nip which generated the
fault. If there is an entry then we let the fixup table handler handle the
page fault by returning an error from within \_\_\_do\_page\_fault().
This can be easily triggered if someone tries to do dd from /proc/kcore.
eg. dd if=/proc/kcore of=/dev/null bs=1M
Some example false negatives:
===============================
BUG: KFENCE: invalid read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Invalid read at 0xc0000000fdff0000:
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
BUG: KFENCE: use-after-free read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Use-after-free read at 0xc0000000fe050000 (in kfence-#2):
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
Fixes: 90cbac0e995d ("powerpc: Enable KFENCE for PPC32")
Suggested-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Reported-by: Disha Goel <disgoel@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Reviewed-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list@gmail.com](https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b)

| -rw-r--r-- | [arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/mm/fault.c?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/arch/powerpc/mm/fault.c b/arch/powerpc/mm/fault.cindex 81c77ddce2e30a..c156fe0d53c378 100644--- a/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=bdd11a04d102f8310812aa7cec39545fdd6662d1)+++ b/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=7eaeb7a49b6d16640f9f3c9074c05175d74c710b)@@ -439,10 +439,16 @@ static int \_\_\_do\_page\_fault(struct pt\_regs \*regs, unsigned long address, /\* \* The kernel should never take an execute fault nor should it \* take a page fault to a kernel address or a page fault to a user- \* address outside of dedicated places+ \* address outside of dedicated places.+ \*+ \* Rather than kfence directly reporting false negatives, search whether+ \* the NIP belongs to the fixup table for cases where fault could come+ \* from functions like copy\_from\_kernel\_nofault(). \*/ if (unlikely(!is\_user && bad\_kernel\_fault(regs, error\_code, address, is\_write))) {- if (kfence\_handle\_page\_fault(address, is\_write, regs))+ if (is\_kfence\_address((void \*)address) &&+ !search\_exception\_tables(instruction\_pointer(regs)) &&+ kfence\_handle\_page\_fault(address, is\_write, regs)) return 0;  return SIGSEGV; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:58:24 +0000



=== Content from git.kernel.org_6890e8bd_20250114_225946.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 22:59:42 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:05 +0100 |
| commit | [15f78d2c3d1452645bd8b9da909b0ca266f83c43](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43)) | |
| tree | [14244da691b7895ed40dd1176b6559b06fd83907](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43) | |
| parent | [24d7b074da8fc8e4d61fded89723c38c688ed3cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=24d7b074da8fc8e4d61fded89723c38c688ed3cb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43&id2=24d7b074da8fc8e4d61fded89723c38c688ed3cb)) | |
| download | [linux-15f78d2c3d1452645bd8b9da909b0ca266f83c43.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-15f78d2c3d1452645bd8b9da909b0ca266f83c43.tar.gz) | |

powerpc/mm/fault: Fix kfence page fault reporting[ Upstream commit 06dbbb4d5f7126b6307ab807cbf04ecfc459b933 ]
copy\_from\_kernel\_nofault() can be called when doing read of /proc/kcore.
/proc/kcore can have some unmapped kfence objects which when read via
copy\_from\_kernel\_nofault() can cause page faults. Since \*\_nofault()
functions define their own fixup table for handling fault, use that
instead of asking kfence to handle such faults.
Hence we search the exception tables for the nip which generated the
fault. If there is an entry then we let the fixup table handler handle the
page fault by returning an error from within \_\_\_do\_page\_fault().
This can be easily triggered if someone tries to do dd from /proc/kcore.
eg. dd if=/proc/kcore of=/dev/null bs=1M
Some example false negatives:
===============================
BUG: KFENCE: invalid read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Invalid read at 0xc0000000fdff0000:
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
BUG: KFENCE: use-after-free read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Use-after-free read at 0xc0000000fe050000 (in kfence-#2):
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
Fixes: 90cbac0e995d ("powerpc: Enable KFENCE for PPC32")
Suggested-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Reported-by: Disha Goel <disgoel@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Reviewed-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list@gmail.com](https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43)

| -rw-r--r-- | [arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/mm/fault.c?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/arch/powerpc/mm/fault.c b/arch/powerpc/mm/fault.cindex 81c77ddce2e30a..c156fe0d53c378 100644--- a/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=24d7b074da8fc8e4d61fded89723c38c688ed3cb)+++ b/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=15f78d2c3d1452645bd8b9da909b0ca266f83c43)@@ -439,10 +439,16 @@ static int \_\_\_do\_page\_fault(struct pt\_regs \*regs, unsigned long address, /\* \* The kernel should never take an execute fault nor should it \* take a page fault to a kernel address or a page fault to a user- \* address outside of dedicated places+ \* address outside of dedicated places.+ \*+ \* Rather than kfence directly reporting false negatives, search whether+ \* the NIP belongs to the fixup table for cases where fault could come+ \* from functions like copy\_from\_kernel\_nofault(). \*/ if (unlikely(!is\_user && bad\_kernel\_fault(regs, error\_code, address, is\_write))) {- if (kfence\_handle\_page\_fault(address, is\_write, regs))+ if (is\_kfence\_address((void \*)address) &&+ !search\_exception\_tables(instruction\_pointer(regs)) &&+ kfence\_handle\_page\_fault(address, is\_write, regs)) return 0;  return SIGSEGV; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:58:23 +0000



=== Content from git.kernel.org_4f5a0314_20250114_225947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 22:59:42 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:15 +0100 |
| commit | [9ea8d8bf9b625e8ad3be6b0432aecdc549914121](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121)) | |
| tree | [8e101df7216ddf3b74c148b8758ae0eec645408f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121) | |
| parent | [f1290871c8aaeb13029390a2b6e5c05733a1be6f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1290871c8aaeb13029390a2b6e5c05733a1be6f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121&id2=f1290871c8aaeb13029390a2b6e5c05733a1be6f)) | |
| download | [linux-9ea8d8bf9b625e8ad3be6b0432aecdc549914121.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ea8d8bf9b625e8ad3be6b0432aecdc549914121.tar.gz) | |

powerpc/mm/fault: Fix kfence page fault reporting[ Upstream commit 06dbbb4d5f7126b6307ab807cbf04ecfc459b933 ]
copy\_from\_kernel\_nofault() can be called when doing read of /proc/kcore.
/proc/kcore can have some unmapped kfence objects which when read via
copy\_from\_kernel\_nofault() can cause page faults. Since \*\_nofault()
functions define their own fixup table for handling fault, use that
instead of asking kfence to handle such faults.
Hence we search the exception tables for the nip which generated the
fault. If there is an entry then we let the fixup table handler handle the
page fault by returning an error from within \_\_\_do\_page\_fault().
This can be easily triggered if someone tries to do dd from /proc/kcore.
eg. dd if=/proc/kcore of=/dev/null bs=1M
Some example false negatives:
===============================
BUG: KFENCE: invalid read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Invalid read at 0xc0000000fdff0000:
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
BUG: KFENCE: use-after-free read in copy\_from\_kernel\_nofault+0x9c/0x1a0
Use-after-free read at 0xc0000000fe050000 (in kfence-#2):
copy\_from\_kernel\_nofault+0x9c/0x1a0
0xc00000000665f950
read\_kcore\_iter+0x57c/0xa04
proc\_reg\_read\_iter+0xe4/0x16c
vfs\_read+0x320/0x3ec
ksys\_read+0x90/0x154
system\_call\_exception+0x120/0x310
system\_call\_vectored\_common+0x15c/0x2ec
Fixes: 90cbac0e995d ("powerpc: Enable KFENCE for PPC32")
Suggested-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Reported-by: Disha Goel <disgoel@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Reviewed-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list@gmail.com](https://patch.msgid.link/a411788081d50e3b136c6270471e35aba3dfafa3.1729271995.git.ritesh.list%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121)

| -rw-r--r-- | [arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/mm/fault.c?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/arch/powerpc/mm/fault.c b/arch/powerpc/mm/fault.cindex b1723094d464cf..d3e0f5b3ecc74d 100644--- a/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=f1290871c8aaeb13029390a2b6e5c05733a1be6f)+++ b/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=9ea8d8bf9b625e8ad3be6b0432aecdc549914121)@@ -431,10 +431,16 @@ static int \_\_\_do\_page\_fault(struct pt\_regs \*regs, unsigned long address, /\* \* The kernel should never take an execute fault nor should it \* take a page fault to a kernel address or a page fault to a user- \* address outside of dedicated places+ \* address outside of dedicated places.+ \*+ \* Rather than kfence directly reporting false negatives, search whether+ \* the NIP belongs to the fixup table for cases where fault could come+ \* from functions like copy\_from\_kernel\_nofault(). \*/ if (unlikely(!is\_user && bad\_kernel\_fault(regs, error\_code, address, is\_write))) {- if (kfence\_handle\_page\_fault(address, is\_write, regs))+ if (is\_kfence\_address((void \*)address) &&+ !search\_exception\_tables(instruction\_pointer(regs)) &&+ kfence\_handle\_page\_fault(address, is\_write, regs)) return 0;  return SIGSEGV; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:58:25 +0000


