=== Content from git.kernel.org_8fedfd1c_20250114_182948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=650ee9a22d7a2de8999fac2d45983597a0c22359)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=650ee9a22d7a2de8999fac2d45983597a0c22359)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=650ee9a22d7a2de8999fac2d45983597a0c22359)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=650ee9a22d7a2de8999fac2d45983597a0c22359)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-11-27 14:05:12 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:19 +0100 |
| commit | [650ee9a22d7a2de8999fac2d45983597a0c22359](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=650ee9a22d7a2de8999fac2d45983597a0c22359) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=650ee9a22d7a2de8999fac2d45983597a0c22359)) | |
| tree | [5d60f93a37172349389b7337f634fb242ed3dcbe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=650ee9a22d7a2de8999fac2d45983597a0c22359) | |
| parent | [c99507fff94b926fc92279c92d80f229c91cb85d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c99507fff94b926fc92279c92d80f229c91cb85d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=650ee9a22d7a2de8999fac2d45983597a0c22359&id2=c99507fff94b926fc92279c92d80f229c91cb85d)) | |
| download | [linux-650ee9a22d7a2de8999fac2d45983597a0c22359.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-650ee9a22d7a2de8999fac2d45983597a0c22359.tar.gz) | |

tipc: Fix use-after-free of kernel socket in cleanup\_bearer().[ Upstream commit 6a2fa13312e51a621f652d522d7e2df7066330b6 ]
syzkaller reported a use-after-free of UDP kernel socket
in cleanup\_bearer() without repro. [0][1]
When bearer\_disable() calls tipc\_udp\_disable(), cleanup
of the UDP kernel socket is deferred by work calling
cleanup\_bearer().
tipc\_net\_stop() waits for such works to finish by checking
tipc\_net(net)->wq\_count. However, the work decrements the
count too early before releasing the kernel socket,
unblocking cleanup\_net() and resulting in use-after-free.
Let's move the decrement after releasing the socket in
cleanup\_bearer().
[0]:
ref\_tracker: net notrefcnt@000000009b3d1faf has 1/1 users at
sk\_alloc+0x438/0x608
inet\_create+0x4c8/0xcb0
\_\_sock\_create+0x350/0x6b8
sock\_create\_kern+0x58/0x78
udp\_sock\_create4+0x68/0x398
udp\_sock\_create+0x88/0xc8
tipc\_udp\_enable+0x5e8/0x848
\_\_tipc\_nl\_bearer\_enable+0x84c/0xed8
tipc\_nl\_bearer\_enable+0x38/0x60
genl\_family\_rcv\_msg\_doit+0x170/0x248
genl\_rcv\_msg+0x400/0x5b0
netlink\_rcv\_skb+0x1dc/0x398
genl\_rcv+0x44/0x68
netlink\_unicast+0x678/0x8b0
netlink\_sendmsg+0x5e4/0x898
\_\_\_\_sys\_sendmsg+0x500/0x830
[1]:
BUG: KMSAN: use-after-free in udp\_hashslot include/net/udp.h:85 [inline]
BUG: KMSAN: use-after-free in udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
udp\_hashslot include/net/udp.h:85 [inline]
udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
sk\_common\_release+0xaf/0x3f0 net/core/sock.c:3820
inet\_release+0x1e0/0x260 net/ipv4/af\_inet.c:437
inet6\_release+0x6f/0xd0 net/ipv6/af\_inet6.c:489
\_\_sock\_release net/socket.c:658 [inline]
sock\_release+0xa0/0x210 net/socket.c:686
cleanup\_bearer+0x42d/0x4c0 net/tipc/udp\_media.c:819
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
Uninit was created at:
slab\_free\_hook mm/slub.c:2269 [inline]
slab\_free mm/slub.c:4580 [inline]
kmem\_cache\_free+0x207/0xc40 mm/slub.c:4682
net\_free net/core/net\_namespace.c:454 [inline]
cleanup\_net+0x16f2/0x19d0 net/core/net\_namespace.c:647
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
CPU: 0 UID: 0 PID: 54 Comm: kworker/0:2 Not tainted 6.12.0-rc1-00131-gf66ebf37d69c #7 91723d6f74857f70725e1583cba3cf4adc716cfa
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
Workqueue: events cleanup\_bearer
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241127050512.28438-1-kuniyu@amazon.com](https://patch.msgid.link/20241127050512.28438-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=650ee9a22d7a2de8999fac2d45983597a0c22359)

| -rw-r--r-- | [net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/udp_media.c?id=650ee9a22d7a2de8999fac2d45983597a0c22359) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/tipc/udp\_media.c b/net/tipc/udp\_media.cindex ec6d7730b85224..d54b5c1d3c83c0 100644--- a/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=c99507fff94b926fc92279c92d80f229c91cb85d)+++ b/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=650ee9a22d7a2de8999fac2d45983597a0c22359)@@ -810,10 +810,10 @@ static void cleanup\_bearer(struct work\_struct \*work) kfree\_rcu(rcast, rcu); } - atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); dst\_cache\_destroy(&ub->rcast.dst\_cache); udp\_tunnel\_sock\_release(ub->ubsock); synchronize\_net();+ atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); kfree(ub); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:28:25 +0000



=== Content from git.kernel.org_4fd1c4fb_20250114_182948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4e69457f9dfae67435f3ccf29008768eae860415)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e69457f9dfae67435f3ccf29008768eae860415)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e69457f9dfae67435f3ccf29008768eae860415)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e69457f9dfae67435f3ccf29008768eae860415)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-11-27 14:05:12 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:46 +0100 |
| commit | [4e69457f9dfae67435f3ccf29008768eae860415](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e69457f9dfae67435f3ccf29008768eae860415) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4e69457f9dfae67435f3ccf29008768eae860415)) | |
| tree | [eace920deb6aa8bee3b8962231d30d2c9a1c2f39](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e69457f9dfae67435f3ccf29008768eae860415) | |
| parent | [bd09e2482d372d40bd77a69cb491a2202227d854](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd09e2482d372d40bd77a69cb491a2202227d854) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e69457f9dfae67435f3ccf29008768eae860415&id2=bd09e2482d372d40bd77a69cb491a2202227d854)) | |
| download | [linux-4e69457f9dfae67435f3ccf29008768eae860415.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4e69457f9dfae67435f3ccf29008768eae860415.tar.gz) | |

tipc: Fix use-after-free of kernel socket in cleanup\_bearer().[ Upstream commit 6a2fa13312e51a621f652d522d7e2df7066330b6 ]
syzkaller reported a use-after-free of UDP kernel socket
in cleanup\_bearer() without repro. [0][1]
When bearer\_disable() calls tipc\_udp\_disable(), cleanup
of the UDP kernel socket is deferred by work calling
cleanup\_bearer().
tipc\_net\_stop() waits for such works to finish by checking
tipc\_net(net)->wq\_count. However, the work decrements the
count too early before releasing the kernel socket,
unblocking cleanup\_net() and resulting in use-after-free.
Let's move the decrement after releasing the socket in
cleanup\_bearer().
[0]:
ref\_tracker: net notrefcnt@000000009b3d1faf has 1/1 users at
sk\_alloc+0x438/0x608
inet\_create+0x4c8/0xcb0
\_\_sock\_create+0x350/0x6b8
sock\_create\_kern+0x58/0x78
udp\_sock\_create4+0x68/0x398
udp\_sock\_create+0x88/0xc8
tipc\_udp\_enable+0x5e8/0x848
\_\_tipc\_nl\_bearer\_enable+0x84c/0xed8
tipc\_nl\_bearer\_enable+0x38/0x60
genl\_family\_rcv\_msg\_doit+0x170/0x248
genl\_rcv\_msg+0x400/0x5b0
netlink\_rcv\_skb+0x1dc/0x398
genl\_rcv+0x44/0x68
netlink\_unicast+0x678/0x8b0
netlink\_sendmsg+0x5e4/0x898
\_\_\_\_sys\_sendmsg+0x500/0x830
[1]:
BUG: KMSAN: use-after-free in udp\_hashslot include/net/udp.h:85 [inline]
BUG: KMSAN: use-after-free in udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
udp\_hashslot include/net/udp.h:85 [inline]
udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
sk\_common\_release+0xaf/0x3f0 net/core/sock.c:3820
inet\_release+0x1e0/0x260 net/ipv4/af\_inet.c:437
inet6\_release+0x6f/0xd0 net/ipv6/af\_inet6.c:489
\_\_sock\_release net/socket.c:658 [inline]
sock\_release+0xa0/0x210 net/socket.c:686
cleanup\_bearer+0x42d/0x4c0 net/tipc/udp\_media.c:819
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
Uninit was created at:
slab\_free\_hook mm/slub.c:2269 [inline]
slab\_free mm/slub.c:4580 [inline]
kmem\_cache\_free+0x207/0xc40 mm/slub.c:4682
net\_free net/core/net\_namespace.c:454 [inline]
cleanup\_net+0x16f2/0x19d0 net/core/net\_namespace.c:647
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
CPU: 0 UID: 0 PID: 54 Comm: kworker/0:2 Not tainted 6.12.0-rc1-00131-gf66ebf37d69c #7 91723d6f74857f70725e1583cba3cf4adc716cfa
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
Workqueue: events cleanup\_bearer
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241127050512.28438-1-kuniyu@amazon.com](https://patch.msgid.link/20241127050512.28438-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e69457f9dfae67435f3ccf29008768eae860415)

| -rw-r--r-- | [net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/udp_media.c?id=4e69457f9dfae67435f3ccf29008768eae860415) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/tipc/udp\_media.c b/net/tipc/udp\_media.cindex 4db2185a32aece..696a21208b24b6 100644--- a/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=bd09e2482d372d40bd77a69cb491a2202227d854)+++ b/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=4e69457f9dfae67435f3ccf29008768eae860415)@@ -805,10 +805,10 @@ static void cleanup\_bearer(struct work\_struct \*work) kfree\_rcu(rcast, rcu); } - atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); dst\_cache\_destroy(&ub->rcast.dst\_cache); udp\_tunnel\_sock\_release(ub->ubsock); synchronize\_net();+ atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); kfree(ub); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:28:25 +0000



=== Content from git.kernel.org_690e1bfe_20250114_182952.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-11-27 14:05:12 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:05 +0100 |
| commit | [e48b211c4c59062cb6dd6c2c37c51a7cc235a464](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464)) | |
| tree | [2f81010b5f7fe63ab8df46c01e89b6586d7f2344](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464) | |
| parent | [9ee68b0f23706a77f53c832457b9384178b76421](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ee68b0f23706a77f53c832457b9384178b76421) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464&id2=9ee68b0f23706a77f53c832457b9384178b76421)) | |
| download | [linux-e48b211c4c59062cb6dd6c2c37c51a7cc235a464.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e48b211c4c59062cb6dd6c2c37c51a7cc235a464.tar.gz) | |

tipc: Fix use-after-free of kernel socket in cleanup\_bearer().[ Upstream commit 6a2fa13312e51a621f652d522d7e2df7066330b6 ]
syzkaller reported a use-after-free of UDP kernel socket
in cleanup\_bearer() without repro. [0][1]
When bearer\_disable() calls tipc\_udp\_disable(), cleanup
of the UDP kernel socket is deferred by work calling
cleanup\_bearer().
tipc\_net\_stop() waits for such works to finish by checking
tipc\_net(net)->wq\_count. However, the work decrements the
count too early before releasing the kernel socket,
unblocking cleanup\_net() and resulting in use-after-free.
Let's move the decrement after releasing the socket in
cleanup\_bearer().
[0]:
ref\_tracker: net notrefcnt@000000009b3d1faf has 1/1 users at
sk\_alloc+0x438/0x608
inet\_create+0x4c8/0xcb0
\_\_sock\_create+0x350/0x6b8
sock\_create\_kern+0x58/0x78
udp\_sock\_create4+0x68/0x398
udp\_sock\_create+0x88/0xc8
tipc\_udp\_enable+0x5e8/0x848
\_\_tipc\_nl\_bearer\_enable+0x84c/0xed8
tipc\_nl\_bearer\_enable+0x38/0x60
genl\_family\_rcv\_msg\_doit+0x170/0x248
genl\_rcv\_msg+0x400/0x5b0
netlink\_rcv\_skb+0x1dc/0x398
genl\_rcv+0x44/0x68
netlink\_unicast+0x678/0x8b0
netlink\_sendmsg+0x5e4/0x898
\_\_\_\_sys\_sendmsg+0x500/0x830
[1]:
BUG: KMSAN: use-after-free in udp\_hashslot include/net/udp.h:85 [inline]
BUG: KMSAN: use-after-free in udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
udp\_hashslot include/net/udp.h:85 [inline]
udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
sk\_common\_release+0xaf/0x3f0 net/core/sock.c:3820
inet\_release+0x1e0/0x260 net/ipv4/af\_inet.c:437
inet6\_release+0x6f/0xd0 net/ipv6/af\_inet6.c:489
\_\_sock\_release net/socket.c:658 [inline]
sock\_release+0xa0/0x210 net/socket.c:686
cleanup\_bearer+0x42d/0x4c0 net/tipc/udp\_media.c:819
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
Uninit was created at:
slab\_free\_hook mm/slub.c:2269 [inline]
slab\_free mm/slub.c:4580 [inline]
kmem\_cache\_free+0x207/0xc40 mm/slub.c:4682
net\_free net/core/net\_namespace.c:454 [inline]
cleanup\_net+0x16f2/0x19d0 net/core/net\_namespace.c:647
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
CPU: 0 UID: 0 PID: 54 Comm: kworker/0:2 Not tainted 6.12.0-rc1-00131-gf66ebf37d69c #7 91723d6f74857f70725e1583cba3cf4adc716cfa
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
Workqueue: events cleanup\_bearer
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241127050512.28438-1-kuniyu@amazon.com](https://patch.msgid.link/20241127050512.28438-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464)

| -rw-r--r-- | [net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/udp_media.c?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/tipc/udp\_media.c b/net/tipc/udp\_media.cindex 439f7553997728..b7e25e7e9933b6 100644--- a/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=9ee68b0f23706a77f53c832457b9384178b76421)+++ b/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=e48b211c4c59062cb6dd6c2c37c51a7cc235a464)@@ -814,10 +814,10 @@ static void cleanup\_bearer(struct work\_struct \*work) kfree\_rcu(rcast, rcu); } - atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); dst\_cache\_destroy(&ub->rcast.dst\_cache); udp\_tunnel\_sock\_release(ub->ubsock); synchronize\_net();+ atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); kfree(ub); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:28:29 +0000



=== Content from git.kernel.org_e924227b_20250114_182949.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6a2fa13312e51a621f652d522d7e2df7066330b6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a2fa13312e51a621f652d522d7e2df7066330b6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a2fa13312e51a621f652d522d7e2df7066330b6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a2fa13312e51a621f652d522d7e2df7066330b6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-11-27 14:05:12 +0900 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-12-03 10:17:43 +0100 |
| commit | [6a2fa13312e51a621f652d522d7e2df7066330b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a2fa13312e51a621f652d522d7e2df7066330b6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6a2fa13312e51a621f652d522d7e2df7066330b6)) | |
| tree | [587c45f4fe270d9b04dbe9f8f53495bef5f0c5cd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a2fa13312e51a621f652d522d7e2df7066330b6) | |
| parent | [22be4727a8f898442066bcac34f8a1ad0bc72e14](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22be4727a8f898442066bcac34f8a1ad0bc72e14) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a2fa13312e51a621f652d522d7e2df7066330b6&id2=22be4727a8f898442066bcac34f8a1ad0bc72e14)) | |
| download | [linux-6a2fa13312e51a621f652d522d7e2df7066330b6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6a2fa13312e51a621f652d522d7e2df7066330b6.tar.gz) | |

tipc: Fix use-after-free of kernel socket in cleanup\_bearer().syzkaller reported a use-after-free of UDP kernel socket
in cleanup\_bearer() without repro. [0][1]
When bearer\_disable() calls tipc\_udp\_disable(), cleanup
of the UDP kernel socket is deferred by work calling
cleanup\_bearer().
tipc\_net\_stop() waits for such works to finish by checking
tipc\_net(net)->wq\_count. However, the work decrements the
count too early before releasing the kernel socket,
unblocking cleanup\_net() and resulting in use-after-free.
Let's move the decrement after releasing the socket in
cleanup\_bearer().
[0]:
ref\_tracker: net notrefcnt@000000009b3d1faf has 1/1 users at
sk\_alloc+0x438/0x608
inet\_create+0x4c8/0xcb0
\_\_sock\_create+0x350/0x6b8
sock\_create\_kern+0x58/0x78
udp\_sock\_create4+0x68/0x398
udp\_sock\_create+0x88/0xc8
tipc\_udp\_enable+0x5e8/0x848
\_\_tipc\_nl\_bearer\_enable+0x84c/0xed8
tipc\_nl\_bearer\_enable+0x38/0x60
genl\_family\_rcv\_msg\_doit+0x170/0x248
genl\_rcv\_msg+0x400/0x5b0
netlink\_rcv\_skb+0x1dc/0x398
genl\_rcv+0x44/0x68
netlink\_unicast+0x678/0x8b0
netlink\_sendmsg+0x5e4/0x898
\_\_\_\_sys\_sendmsg+0x500/0x830
[1]:
BUG: KMSAN: use-after-free in udp\_hashslot include/net/udp.h:85 [inline]
BUG: KMSAN: use-after-free in udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
udp\_hashslot include/net/udp.h:85 [inline]
udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
sk\_common\_release+0xaf/0x3f0 net/core/sock.c:3820
inet\_release+0x1e0/0x260 net/ipv4/af\_inet.c:437
inet6\_release+0x6f/0xd0 net/ipv6/af\_inet6.c:489
\_\_sock\_release net/socket.c:658 [inline]
sock\_release+0xa0/0x210 net/socket.c:686
cleanup\_bearer+0x42d/0x4c0 net/tipc/udp\_media.c:819
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
Uninit was created at:
slab\_free\_hook mm/slub.c:2269 [inline]
slab\_free mm/slub.c:4580 [inline]
kmem\_cache\_free+0x207/0xc40 mm/slub.c:4682
net\_free net/core/net\_namespace.c:454 [inline]
cleanup\_net+0x16f2/0x19d0 net/core/net\_namespace.c:647
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
CPU: 0 UID: 0 PID: 54 Comm: kworker/0:2 Not tainted 6.12.0-rc1-00131-gf66ebf37d69c #7 91723d6f74857f70725e1583cba3cf4adc716cfa
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
Workqueue: events cleanup\_bearer
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241127050512.28438-1-kuniyu@amazon.com](https://patch.msgid.link/20241127050512.28438-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a2fa13312e51a621f652d522d7e2df7066330b6)

| -rw-r--r-- | [net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/udp_media.c?id=6a2fa13312e51a621f652d522d7e2df7066330b6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/tipc/udp\_media.c b/net/tipc/udp\_media.cindex 439f7553997728..b7e25e7e9933b6 100644--- a/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=22be4727a8f898442066bcac34f8a1ad0bc72e14)+++ b/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=6a2fa13312e51a621f652d522d7e2df7066330b6)@@ -814,10 +814,10 @@ static void cleanup\_bearer(struct work\_struct \*work) kfree\_rcu(rcast, rcu); } - atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); dst\_cache\_destroy(&ub->rcast.dst\_cache); udp\_tunnel\_sock\_release(ub->ubsock); synchronize\_net();+ atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); kfree(ub); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:28:26 +0000



=== Content from git.kernel.org_da282d4d_20250114_182950.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-11-27 14:05:12 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:36 +0100 |
| commit | [d00d4470bf8c4282617a3a10e76b20a9c7e4cffa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa)) | |
| tree | [f43448fb7221dcf8a0019412c8afc05987338b92](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa) | |
| parent | [d3ec686a369fae5034303061f003cd3f94ddfd23](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3ec686a369fae5034303061f003cd3f94ddfd23) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa&id2=d3ec686a369fae5034303061f003cd3f94ddfd23)) | |
| download | [linux-d00d4470bf8c4282617a3a10e76b20a9c7e4cffa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d00d4470bf8c4282617a3a10e76b20a9c7e4cffa.tar.gz) | |

tipc: Fix use-after-free of kernel socket in cleanup\_bearer().[ Upstream commit 6a2fa13312e51a621f652d522d7e2df7066330b6 ]
syzkaller reported a use-after-free of UDP kernel socket
in cleanup\_bearer() without repro. [0][1]
When bearer\_disable() calls tipc\_udp\_disable(), cleanup
of the UDP kernel socket is deferred by work calling
cleanup\_bearer().
tipc\_net\_stop() waits for such works to finish by checking
tipc\_net(net)->wq\_count. However, the work decrements the
count too early before releasing the kernel socket,
unblocking cleanup\_net() and resulting in use-after-free.
Let's move the decrement after releasing the socket in
cleanup\_bearer().
[0]:
ref\_tracker: net notrefcnt@000000009b3d1faf has 1/1 users at
sk\_alloc+0x438/0x608
inet\_create+0x4c8/0xcb0
\_\_sock\_create+0x350/0x6b8
sock\_create\_kern+0x58/0x78
udp\_sock\_create4+0x68/0x398
udp\_sock\_create+0x88/0xc8
tipc\_udp\_enable+0x5e8/0x848
\_\_tipc\_nl\_bearer\_enable+0x84c/0xed8
tipc\_nl\_bearer\_enable+0x38/0x60
genl\_family\_rcv\_msg\_doit+0x170/0x248
genl\_rcv\_msg+0x400/0x5b0
netlink\_rcv\_skb+0x1dc/0x398
genl\_rcv+0x44/0x68
netlink\_unicast+0x678/0x8b0
netlink\_sendmsg+0x5e4/0x898
\_\_\_\_sys\_sendmsg+0x500/0x830
[1]:
BUG: KMSAN: use-after-free in udp\_hashslot include/net/udp.h:85 [inline]
BUG: KMSAN: use-after-free in udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
udp\_hashslot include/net/udp.h:85 [inline]
udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
sk\_common\_release+0xaf/0x3f0 net/core/sock.c:3820
inet\_release+0x1e0/0x260 net/ipv4/af\_inet.c:437
inet6\_release+0x6f/0xd0 net/ipv6/af\_inet6.c:489
\_\_sock\_release net/socket.c:658 [inline]
sock\_release+0xa0/0x210 net/socket.c:686
cleanup\_bearer+0x42d/0x4c0 net/tipc/udp\_media.c:819
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
Uninit was created at:
slab\_free\_hook mm/slub.c:2269 [inline]
slab\_free mm/slub.c:4580 [inline]
kmem\_cache\_free+0x207/0xc40 mm/slub.c:4682
net\_free net/core/net\_namespace.c:454 [inline]
cleanup\_net+0x16f2/0x19d0 net/core/net\_namespace.c:647
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
CPU: 0 UID: 0 PID: 54 Comm: kworker/0:2 Not tainted 6.12.0-rc1-00131-gf66ebf37d69c #7 91723d6f74857f70725e1583cba3cf4adc716cfa
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
Workqueue: events cleanup\_bearer
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241127050512.28438-1-kuniyu@amazon.com](https://patch.msgid.link/20241127050512.28438-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa)

| -rw-r--r-- | [net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/udp_media.c?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/tipc/udp\_media.c b/net/tipc/udp\_media.cindex cdc8378261ec3f..70a39e29a6352c 100644--- a/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=d3ec686a369fae5034303061f003cd3f94ddfd23)+++ b/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=d00d4470bf8c4282617a3a10e76b20a9c7e4cffa)@@ -814,10 +814,10 @@ static void cleanup\_bearer(struct work\_struct \*work) kfree\_rcu(rcast, rcu); } - atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); dst\_cache\_destroy(&ub->rcast.dst\_cache); udp\_tunnel\_sock\_release(ub->ubsock); synchronize\_net();+ atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); kfree(ub); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:28:27 +0000



=== Content from git.kernel.org_14f7da28_20250114_182952.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d62d5180c036eeac09f80660edc7a602b369125f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d62d5180c036eeac09f80660edc7a602b369125f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d62d5180c036eeac09f80660edc7a602b369125f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d62d5180c036eeac09f80660edc7a602b369125f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-11-27 14:05:12 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:22 +0100 |
| commit | [d62d5180c036eeac09f80660edc7a602b369125f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d62d5180c036eeac09f80660edc7a602b369125f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d62d5180c036eeac09f80660edc7a602b369125f)) | |
| tree | [d294bc0f4225e03c08b7c66b8e34971a2282c0ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d62d5180c036eeac09f80660edc7a602b369125f) | |
| parent | [6ff67909ee2ffad911e3122616df41dee23ff4f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ff67909ee2ffad911e3122616df41dee23ff4f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d62d5180c036eeac09f80660edc7a602b369125f&id2=6ff67909ee2ffad911e3122616df41dee23ff4f6)) | |
| download | [linux-d62d5180c036eeac09f80660edc7a602b369125f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d62d5180c036eeac09f80660edc7a602b369125f.tar.gz) | |

tipc: Fix use-after-free of kernel socket in cleanup\_bearer().[ Upstream commit 6a2fa13312e51a621f652d522d7e2df7066330b6 ]
syzkaller reported a use-after-free of UDP kernel socket
in cleanup\_bearer() without repro. [0][1]
When bearer\_disable() calls tipc\_udp\_disable(), cleanup
of the UDP kernel socket is deferred by work calling
cleanup\_bearer().
tipc\_net\_stop() waits for such works to finish by checking
tipc\_net(net)->wq\_count. However, the work decrements the
count too early before releasing the kernel socket,
unblocking cleanup\_net() and resulting in use-after-free.
Let's move the decrement after releasing the socket in
cleanup\_bearer().
[0]:
ref\_tracker: net notrefcnt@000000009b3d1faf has 1/1 users at
sk\_alloc+0x438/0x608
inet\_create+0x4c8/0xcb0
\_\_sock\_create+0x350/0x6b8
sock\_create\_kern+0x58/0x78
udp\_sock\_create4+0x68/0x398
udp\_sock\_create+0x88/0xc8
tipc\_udp\_enable+0x5e8/0x848
\_\_tipc\_nl\_bearer\_enable+0x84c/0xed8
tipc\_nl\_bearer\_enable+0x38/0x60
genl\_family\_rcv\_msg\_doit+0x170/0x248
genl\_rcv\_msg+0x400/0x5b0
netlink\_rcv\_skb+0x1dc/0x398
genl\_rcv+0x44/0x68
netlink\_unicast+0x678/0x8b0
netlink\_sendmsg+0x5e4/0x898
\_\_\_\_sys\_sendmsg+0x500/0x830
[1]:
BUG: KMSAN: use-after-free in udp\_hashslot include/net/udp.h:85 [inline]
BUG: KMSAN: use-after-free in udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
udp\_hashslot include/net/udp.h:85 [inline]
udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
sk\_common\_release+0xaf/0x3f0 net/core/sock.c:3820
inet\_release+0x1e0/0x260 net/ipv4/af\_inet.c:437
inet6\_release+0x6f/0xd0 net/ipv6/af\_inet6.c:489
\_\_sock\_release net/socket.c:658 [inline]
sock\_release+0xa0/0x210 net/socket.c:686
cleanup\_bearer+0x42d/0x4c0 net/tipc/udp\_media.c:819
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
Uninit was created at:
slab\_free\_hook mm/slub.c:2269 [inline]
slab\_free mm/slub.c:4580 [inline]
kmem\_cache\_free+0x207/0xc40 mm/slub.c:4682
net\_free net/core/net\_namespace.c:454 [inline]
cleanup\_net+0x16f2/0x19d0 net/core/net\_namespace.c:647
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
CPU: 0 UID: 0 PID: 54 Comm: kworker/0:2 Not tainted 6.12.0-rc1-00131-gf66ebf37d69c #7 91723d6f74857f70725e1583cba3cf4adc716cfa
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
Workqueue: events cleanup\_bearer
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241127050512.28438-1-kuniyu@amazon.com](https://patch.msgid.link/20241127050512.28438-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d62d5180c036eeac09f80660edc7a602b369125f)

| -rw-r--r-- | [net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/udp_media.c?id=d62d5180c036eeac09f80660edc7a602b369125f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/tipc/udp\_media.c b/net/tipc/udp\_media.cindex 73e461dc12d7b4..3f5a12b85b2d3e 100644--- a/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=6ff67909ee2ffad911e3122616df41dee23ff4f6)+++ b/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=d62d5180c036eeac09f80660edc7a602b369125f)@@ -818,10 +818,10 @@ static void cleanup\_bearer(struct work\_struct \*work) kfree\_rcu(rcast, rcu); } - atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); dst\_cache\_destroy(&ub->rcast.dst\_cache); udp\_tunnel\_sock\_release(ub->ubsock); synchronize\_net();+ atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); kfree(ub); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:28:29 +0000



=== Content from git.kernel.org_adb30508_20250114_182951.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d2a4894f238551eae178904e7f45af87577074fd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2a4894f238551eae178904e7f45af87577074fd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2a4894f238551eae178904e7f45af87577074fd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2a4894f238551eae178904e7f45af87577074fd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-11-27 14:05:12 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:27 +0100 |
| commit | [d2a4894f238551eae178904e7f45af87577074fd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2a4894f238551eae178904e7f45af87577074fd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d2a4894f238551eae178904e7f45af87577074fd)) | |
| tree | [3982aba084d44b13d27457054b917aec3b132d6b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2a4894f238551eae178904e7f45af87577074fd) | |
| parent | [bc3d4423def1a9412a0ae454cb4477089ab79276](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc3d4423def1a9412a0ae454cb4477089ab79276) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2a4894f238551eae178904e7f45af87577074fd&id2=bc3d4423def1a9412a0ae454cb4477089ab79276)) | |
| download | [linux-d2a4894f238551eae178904e7f45af87577074fd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d2a4894f238551eae178904e7f45af87577074fd.tar.gz) | |

tipc: Fix use-after-free of kernel socket in cleanup\_bearer().[ Upstream commit 6a2fa13312e51a621f652d522d7e2df7066330b6 ]
syzkaller reported a use-after-free of UDP kernel socket
in cleanup\_bearer() without repro. [0][1]
When bearer\_disable() calls tipc\_udp\_disable(), cleanup
of the UDP kernel socket is deferred by work calling
cleanup\_bearer().
tipc\_net\_stop() waits for such works to finish by checking
tipc\_net(net)->wq\_count. However, the work decrements the
count too early before releasing the kernel socket,
unblocking cleanup\_net() and resulting in use-after-free.
Let's move the decrement after releasing the socket in
cleanup\_bearer().
[0]:
ref\_tracker: net notrefcnt@000000009b3d1faf has 1/1 users at
sk\_alloc+0x438/0x608
inet\_create+0x4c8/0xcb0
\_\_sock\_create+0x350/0x6b8
sock\_create\_kern+0x58/0x78
udp\_sock\_create4+0x68/0x398
udp\_sock\_create+0x88/0xc8
tipc\_udp\_enable+0x5e8/0x848
\_\_tipc\_nl\_bearer\_enable+0x84c/0xed8
tipc\_nl\_bearer\_enable+0x38/0x60
genl\_family\_rcv\_msg\_doit+0x170/0x248
genl\_rcv\_msg+0x400/0x5b0
netlink\_rcv\_skb+0x1dc/0x398
genl\_rcv+0x44/0x68
netlink\_unicast+0x678/0x8b0
netlink\_sendmsg+0x5e4/0x898
\_\_\_\_sys\_sendmsg+0x500/0x830
[1]:
BUG: KMSAN: use-after-free in udp\_hashslot include/net/udp.h:85 [inline]
BUG: KMSAN: use-after-free in udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
udp\_hashslot include/net/udp.h:85 [inline]
udp\_lib\_unhash+0x3b8/0x930 net/ipv4/udp.c:1979
sk\_common\_release+0xaf/0x3f0 net/core/sock.c:3820
inet\_release+0x1e0/0x260 net/ipv4/af\_inet.c:437
inet6\_release+0x6f/0xd0 net/ipv6/af\_inet6.c:489
\_\_sock\_release net/socket.c:658 [inline]
sock\_release+0xa0/0x210 net/socket.c:686
cleanup\_bearer+0x42d/0x4c0 net/tipc/udp\_media.c:819
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
Uninit was created at:
slab\_free\_hook mm/slub.c:2269 [inline]
slab\_free mm/slub.c:4580 [inline]
kmem\_cache\_free+0x207/0xc40 mm/slub.c:4682
net\_free net/core/net\_namespace.c:454 [inline]
cleanup\_net+0x16f2/0x19d0 net/core/net\_namespace.c:647
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xcaf/0x1c90 kernel/workqueue.c:3310
worker\_thread+0xf6c/0x1510 kernel/workqueue.c:3391
kthread+0x531/0x6b0 kernel/kthread.c:389
ret\_from\_fork+0x60/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:244
CPU: 0 UID: 0 PID: 54 Comm: kworker/0:2 Not tainted 6.12.0-rc1-00131-gf66ebf37d69c #7 91723d6f74857f70725e1583cba3cf4adc716cfa
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
Workqueue: events cleanup\_bearer
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241127050512.28438-1-kuniyu@amazon.com](https://patch.msgid.link/20241127050512.28438-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2a4894f238551eae178904e7f45af87577074fd)

| -rw-r--r-- | [net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/udp_media.c?id=d2a4894f238551eae178904e7f45af87577074fd) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/tipc/udp\_media.c b/net/tipc/udp\_media.cindex 73e461dc12d7b4..3f5a12b85b2d3e 100644--- a/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=bc3d4423def1a9412a0ae454cb4477089ab79276)+++ b/[net/tipc/udp\_media.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/udp_media.c?id=d2a4894f238551eae178904e7f45af87577074fd)@@ -818,10 +818,10 @@ static void cleanup\_bearer(struct work\_struct \*work) kfree\_rcu(rcast, rcu); } - atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); dst\_cache\_destroy(&ub->rcast.dst\_cache); udp\_tunnel\_sock\_release(ub->ubsock); synchronize\_net();+ atomic\_dec(&tipc\_net(sock\_net(ub->ubsock->sk))->wq\_count); kfree(ub); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:28:28 +0000


