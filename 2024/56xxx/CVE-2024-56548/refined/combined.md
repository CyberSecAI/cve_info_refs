=== Content from git.kernel.org_bdd4808b_20250114_204856.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3d7bda75e1a6239db053c73acde17ca146317824)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d7bda75e1a6239db053c73acde17ca146317824)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d7bda75e1a6239db053c73acde17ca146317824)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d7bda75e1a6239db053c73acde17ca146317824)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-11-07 08:41:09 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:16 +0100 |
| commit | [3d7bda75e1a6239db053c73acde17ca146317824](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d7bda75e1a6239db053c73acde17ca146317824) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3d7bda75e1a6239db053c73acde17ca146317824)) | |
| tree | [eb1909362cfcf26b6d449651de2d025756abe41d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d7bda75e1a6239db053c73acde17ca146317824) | |
| parent | [b1a52470f107a5b20ff20013471586b6792d07aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1a52470f107a5b20ff20013471586b6792d07aa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d7bda75e1a6239db053c73acde17ca146317824&id2=b1a52470f107a5b20ff20013471586b6792d07aa)) | |
| download | [linux-3d7bda75e1a6239db053c73acde17ca146317824.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3d7bda75e1a6239db053c73acde17ca146317824.tar.gz) | |

hfsplus: don't query the device logical block size multiple times[ Upstream commit 1c82587cb57687de3f18ab4b98a8850c789bedcf ]
Devices block sizes may change. One of these cases is a loop device by
using ioctl LOOP\_SET\_BLOCK\_SIZE.
While this may cause other issues like IO being rejected, in the case of
hfsplus, it will allocate a block by using that size and potentially write
out-of-bounds when hfsplus\_read\_wrapper calls hfsplus\_submit\_bio and the
latter function reads a different io\_size.
Using a new min\_io\_size initally set to sb\_min\_blocksize works for the
purposes of the original fix, since it will be set to the max between
HFSPLUS\_SECTOR\_SIZE and the first seen logical block size. We still use the
max between HFSPLUS\_SECTOR\_SIZE and min\_io\_size in case the latter is not
initialized.
Tested by mounting an hfsplus filesystem with loop block sizes 512, 1024
and 4096.
The produced KASAN report before the fix looks like this:
[ 419.944641] ==================================================================
[ 419.945655] BUG: KASAN: slab-use-after-free in hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.946703] Read of size 2 at addr ffff88800721fc00 by task repro/10678
[ 419.947612]
[ 419.947846] CPU: 0 UID: 0 PID: 10678 Comm: repro Not tainted 6.12.0-rc5-00008-gdf56e0f2f3ca #84
[ 419.949007] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 419.950035] Call Trace:
[ 419.950384] <TASK>
[ 419.950676] dump\_stack\_lvl+0x57/0x78
[ 419.951212] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.951830] print\_report+0x14c/0x49e
[ 419.952361] ? \_\_virt\_addr\_valid+0x267/0x278
[ 419.952979] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 419.953561] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.954231] kasan\_report+0x89/0xb0
[ 419.954748] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955367] hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955948] ? \_\_pfx\_hfsplus\_read\_wrapper+0x10/0x10
[ 419.956618] ? do\_raw\_spin\_unlock+0x59/0x1a9
[ 419.957214] ? \_raw\_spin\_unlock+0x1a/0x2e
[ 419.957772] hfsplus\_fill\_super+0x348/0x1590
[ 419.958355] ? hlock\_class+0x4c/0x109
[ 419.958867] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.959499] ? \_\_pfx\_string+0x10/0x10
[ 419.960006] ? lock\_acquire+0x3e2/0x454
[ 419.960532] ? bdev\_name.constprop.0+0xce/0x243
[ 419.961129] ? \_\_pfx\_bdev\_name.constprop.0+0x10/0x10
[ 419.961799] ? pointer+0x3f0/0x62f
[ 419.962277] ? \_\_pfx\_pointer+0x10/0x10
[ 419.962761] ? vsnprintf+0x6c4/0xfba
[ 419.963178] ? \_\_pfx\_vsnprintf+0x10/0x10
[ 419.963621] ? setup\_bdev\_super+0x376/0x3b3
[ 419.964029] ? snprintf+0x9d/0xd2
[ 419.964344] ? \_\_pfx\_snprintf+0x10/0x10
[ 419.964675] ? lock\_acquired+0x45c/0x5e9
[ 419.965016] ? set\_blocksize+0x139/0x1c1
[ 419.965381] ? sb\_set\_blocksize+0x6d/0xae
[ 419.965742] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.966179] mount\_bdev+0x12f/0x1bf
[ 419.966512] ? \_\_pfx\_mount\_bdev+0x10/0x10
[ 419.966886] ? vfs\_parse\_fs\_string+0xce/0x111
[ 419.967293] ? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
[ 419.967702] ? \_\_pfx\_hfsplus\_mount+0x10/0x10
[ 419.968073] legacy\_get\_tree+0x104/0x178
[ 419.968414] vfs\_get\_tree+0x86/0x296
[ 419.968751] path\_mount+0xba3/0xd0b
[ 419.969157] ? \_\_pfx\_path\_mount+0x10/0x10
[ 419.969594] ? kmem\_cache\_free+0x1e2/0x260
[ 419.970311] do\_mount+0x99/0xe0
[ 419.970630] ? \_\_pfx\_do\_mount+0x10/0x10
[ 419.971008] \_\_do\_sys\_mount+0x199/0x1c9
[ 419.971397] do\_syscall\_64+0xd0/0x135
[ 419.971761] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 419.972233] RIP: 0033:0x7c3cb812972e
[ 419.972564] Code: 48 8b 0d f5 46 0d 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d c2 46 0d 00 f7 d8 64 89 01 48
[ 419.974371] RSP: 002b:00007ffe30632548 EFLAGS: 00000286 ORIG\_RAX: 00000000000000a5
[ 419.975048] RAX: ffffffffffffffda RBX: 00007ffe306328d8 RCX: 00007c3cb812972e
[ 419.975701] RDX: 0000000020000000 RSI: 0000000020000c80 RDI: 00007ffe306325d0
[ 419.976363] RBP: 00007ffe30632720 R08: 00007ffe30632610 R09: 0000000000000000
[ 419.977034] R10: 0000000000200008 R11: 0000000000000286 R12: 0000000000000000
[ 419.977713] R13: 00007ffe306328e8 R14: 00005a0eb298bc68 R15: 00007c3cb8356000
[ 419.978375] </TASK>
[ 419.978589]
Fixes: 6596528e391a ("hfsplus: ensure bio requests are not smaller than the hardware sectors")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Link: [https://lore.kernel.org/r/20241107114109.839253-1-cascardo@igalia.com](https://lore.kernel.org/r/20241107114109.839253-1-cascardo%40igalia.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d7bda75e1a6239db053c73acde17ca146317824)

| -rw-r--r-- | [fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/hfsplus_fs.h?id=3d7bda75e1a6239db053c73acde17ca146317824) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/wrapper.c?id=3d7bda75e1a6239db053c73acde17ca146317824) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/fs/hfsplus/hfsplus\_fs.h b/fs/hfsplus/hfsplus\_fs.hindex 7db213cd1eea8f..3227436f3a4a6e 100644--- a/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=b1a52470f107a5b20ff20013471586b6792d07aa)+++ b/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=3d7bda75e1a6239db053c73acde17ca146317824)@@ -156,6 +156,7 @@ struct hfsplus\_sb\_info {  /\* Runtime variables \*/ u32 blockoffset;+ u32 min\_io\_size; sector\_t part\_start; sector\_t sect\_count; int fs\_shift;@@ -306,7 +307,7 @@ struct hfsplus\_readdir\_data { \*/ static inline unsigned short hfsplus\_min\_io\_size(struct super\_block \*sb) {- return max\_t(unsigned short, bdev\_logical\_block\_size(sb->s\_bdev),+ return max\_t(unsigned short, HFSPLUS\_SB(sb)->min\_io\_size, HFSPLUS\_SECTOR\_SIZE); } diff --git a/fs/hfsplus/wrapper.c b/fs/hfsplus/wrapper.cindex 0b791adf02e53d..a51a58db3fef04 100644--- a/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=b1a52470f107a5b20ff20013471586b6792d07aa)+++ b/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=3d7bda75e1a6239db053c73acde17ca146317824)@@ -171,6 +171,8 @@ int hfsplus\_read\_wrapper(struct super\_block \*sb) if (!blocksize) goto out; + sbi->min\_io\_size = blocksize;+ if (hfsplus\_get\_last\_session(sb, &part\_start, &part\_size)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:47:33 +0000



=== Content from git.kernel.org_6faf7005_20250114_204858.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-11-07 08:41:09 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:44 +0100 |
| commit | [e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866)) | |
| tree | [b97ba6552a2932ecda61ca55eb16efd7e7f02617](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866) | |
| parent | [3cab4bbc6691215552741a40c3d865c3d5d93adc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3cab4bbc6691215552741a40c3d865c3d5d93adc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866&id2=3cab4bbc6691215552741a40c3d865c3d5d93adc)) | |
| download | [linux-e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866.tar.gz) | |

hfsplus: don't query the device logical block size multiple times[ Upstream commit 1c82587cb57687de3f18ab4b98a8850c789bedcf ]
Devices block sizes may change. One of these cases is a loop device by
using ioctl LOOP\_SET\_BLOCK\_SIZE.
While this may cause other issues like IO being rejected, in the case of
hfsplus, it will allocate a block by using that size and potentially write
out-of-bounds when hfsplus\_read\_wrapper calls hfsplus\_submit\_bio and the
latter function reads a different io\_size.
Using a new min\_io\_size initally set to sb\_min\_blocksize works for the
purposes of the original fix, since it will be set to the max between
HFSPLUS\_SECTOR\_SIZE and the first seen logical block size. We still use the
max between HFSPLUS\_SECTOR\_SIZE and min\_io\_size in case the latter is not
initialized.
Tested by mounting an hfsplus filesystem with loop block sizes 512, 1024
and 4096.
The produced KASAN report before the fix looks like this:
[ 419.944641] ==================================================================
[ 419.945655] BUG: KASAN: slab-use-after-free in hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.946703] Read of size 2 at addr ffff88800721fc00 by task repro/10678
[ 419.947612]
[ 419.947846] CPU: 0 UID: 0 PID: 10678 Comm: repro Not tainted 6.12.0-rc5-00008-gdf56e0f2f3ca #84
[ 419.949007] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 419.950035] Call Trace:
[ 419.950384] <TASK>
[ 419.950676] dump\_stack\_lvl+0x57/0x78
[ 419.951212] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.951830] print\_report+0x14c/0x49e
[ 419.952361] ? \_\_virt\_addr\_valid+0x267/0x278
[ 419.952979] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 419.953561] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.954231] kasan\_report+0x89/0xb0
[ 419.954748] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955367] hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955948] ? \_\_pfx\_hfsplus\_read\_wrapper+0x10/0x10
[ 419.956618] ? do\_raw\_spin\_unlock+0x59/0x1a9
[ 419.957214] ? \_raw\_spin\_unlock+0x1a/0x2e
[ 419.957772] hfsplus\_fill\_super+0x348/0x1590
[ 419.958355] ? hlock\_class+0x4c/0x109
[ 419.958867] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.959499] ? \_\_pfx\_string+0x10/0x10
[ 419.960006] ? lock\_acquire+0x3e2/0x454
[ 419.960532] ? bdev\_name.constprop.0+0xce/0x243
[ 419.961129] ? \_\_pfx\_bdev\_name.constprop.0+0x10/0x10
[ 419.961799] ? pointer+0x3f0/0x62f
[ 419.962277] ? \_\_pfx\_pointer+0x10/0x10
[ 419.962761] ? vsnprintf+0x6c4/0xfba
[ 419.963178] ? \_\_pfx\_vsnprintf+0x10/0x10
[ 419.963621] ? setup\_bdev\_super+0x376/0x3b3
[ 419.964029] ? snprintf+0x9d/0xd2
[ 419.964344] ? \_\_pfx\_snprintf+0x10/0x10
[ 419.964675] ? lock\_acquired+0x45c/0x5e9
[ 419.965016] ? set\_blocksize+0x139/0x1c1
[ 419.965381] ? sb\_set\_blocksize+0x6d/0xae
[ 419.965742] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.966179] mount\_bdev+0x12f/0x1bf
[ 419.966512] ? \_\_pfx\_mount\_bdev+0x10/0x10
[ 419.966886] ? vfs\_parse\_fs\_string+0xce/0x111
[ 419.967293] ? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
[ 419.967702] ? \_\_pfx\_hfsplus\_mount+0x10/0x10
[ 419.968073] legacy\_get\_tree+0x104/0x178
[ 419.968414] vfs\_get\_tree+0x86/0x296
[ 419.968751] path\_mount+0xba3/0xd0b
[ 419.969157] ? \_\_pfx\_path\_mount+0x10/0x10
[ 419.969594] ? kmem\_cache\_free+0x1e2/0x260
[ 419.970311] do\_mount+0x99/0xe0
[ 419.970630] ? \_\_pfx\_do\_mount+0x10/0x10
[ 419.971008] \_\_do\_sys\_mount+0x199/0x1c9
[ 419.971397] do\_syscall\_64+0xd0/0x135
[ 419.971761] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 419.972233] RIP: 0033:0x7c3cb812972e
[ 419.972564] Code: 48 8b 0d f5 46 0d 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d c2 46 0d 00 f7 d8 64 89 01 48
[ 419.974371] RSP: 002b:00007ffe30632548 EFLAGS: 00000286 ORIG\_RAX: 00000000000000a5
[ 419.975048] RAX: ffffffffffffffda RBX: 00007ffe306328d8 RCX: 00007c3cb812972e
[ 419.975701] RDX: 0000000020000000 RSI: 0000000020000c80 RDI: 00007ffe306325d0
[ 419.976363] RBP: 00007ffe30632720 R08: 00007ffe30632610 R09: 0000000000000000
[ 419.977034] R10: 0000000000200008 R11: 0000000000000286 R12: 0000000000000000
[ 419.977713] R13: 00007ffe306328e8 R14: 00005a0eb298bc68 R15: 00007c3cb8356000
[ 419.978375] </TASK>
[ 419.978589]
Fixes: 6596528e391a ("hfsplus: ensure bio requests are not smaller than the hardware sectors")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Link: [https://lore.kernel.org/r/20241107114109.839253-1-cascardo@igalia.com](https://lore.kernel.org/r/20241107114109.839253-1-cascardo%40igalia.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866)

| -rw-r--r-- | [fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/hfsplus_fs.h?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/wrapper.c?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/fs/hfsplus/hfsplus\_fs.h b/fs/hfsplus/hfsplus\_fs.hindex bfbe88e804eb03..c37a2f3d88af02 100644--- a/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=3cab4bbc6691215552741a40c3d865c3d5d93adc)+++ b/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866)@@ -156,6 +156,7 @@ struct hfsplus\_sb\_info {  /\* Runtime variables \*/ u32 blockoffset;+ u32 min\_io\_size; sector\_t part\_start; sector\_t sect\_count; int fs\_shift;@@ -306,7 +307,7 @@ struct hfsplus\_readdir\_data { \*/ static inline unsigned short hfsplus\_min\_io\_size(struct super\_block \*sb) {- return max\_t(unsigned short, bdev\_logical\_block\_size(sb->s\_bdev),+ return max\_t(unsigned short, HFSPLUS\_SB(sb)->min\_io\_size, HFSPLUS\_SECTOR\_SIZE); } diff --git a/fs/hfsplus/wrapper.c b/fs/hfsplus/wrapper.cindex 0350dc7821bf95..59ba0a30f5392d 100644--- a/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=3cab4bbc6691215552741a40c3d865c3d5d93adc)+++ b/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=e8a2b1c1c2ea85e9a5a2d0c5a5a7e7c639feb866)@@ -173,6 +173,8 @@ int hfsplus\_read\_wrapper(struct super\_block \*sb) if (!blocksize) goto out; + sbi->min\_io\_size = blocksize;+ if (hfsplus\_get\_last\_session(sb, &part\_start, &part\_size)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:47:35 +0000



=== Content from git.kernel.org_b7d88df6_20250114_204857.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-11-07 08:41:09 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:15 +0100 |
| commit | [bfeecda050aa9376f642d5b2a71c4112cc6c8216](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)) | |
| tree | [5b235a1951ae0aad4a0d2226b5441a668b5e1ad7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216) | |
| parent | [4d09ee08630475573fc43cf640fe4405745890d0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d09ee08630475573fc43cf640fe4405745890d0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216&id2=4d09ee08630475573fc43cf640fe4405745890d0)) | |
| download | [linux-bfeecda050aa9376f642d5b2a71c4112cc6c8216.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bfeecda050aa9376f642d5b2a71c4112cc6c8216.tar.gz) | |

hfsplus: don't query the device logical block size multiple times[ Upstream commit 1c82587cb57687de3f18ab4b98a8850c789bedcf ]
Devices block sizes may change. One of these cases is a loop device by
using ioctl LOOP\_SET\_BLOCK\_SIZE.
While this may cause other issues like IO being rejected, in the case of
hfsplus, it will allocate a block by using that size and potentially write
out-of-bounds when hfsplus\_read\_wrapper calls hfsplus\_submit\_bio and the
latter function reads a different io\_size.
Using a new min\_io\_size initally set to sb\_min\_blocksize works for the
purposes of the original fix, since it will be set to the max between
HFSPLUS\_SECTOR\_SIZE and the first seen logical block size. We still use the
max between HFSPLUS\_SECTOR\_SIZE and min\_io\_size in case the latter is not
initialized.
Tested by mounting an hfsplus filesystem with loop block sizes 512, 1024
and 4096.
The produced KASAN report before the fix looks like this:
[ 419.944641] ==================================================================
[ 419.945655] BUG: KASAN: slab-use-after-free in hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.946703] Read of size 2 at addr ffff88800721fc00 by task repro/10678
[ 419.947612]
[ 419.947846] CPU: 0 UID: 0 PID: 10678 Comm: repro Not tainted 6.12.0-rc5-00008-gdf56e0f2f3ca #84
[ 419.949007] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 419.950035] Call Trace:
[ 419.950384] <TASK>
[ 419.950676] dump\_stack\_lvl+0x57/0x78
[ 419.951212] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.951830] print\_report+0x14c/0x49e
[ 419.952361] ? \_\_virt\_addr\_valid+0x267/0x278
[ 419.952979] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 419.953561] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.954231] kasan\_report+0x89/0xb0
[ 419.954748] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955367] hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955948] ? \_\_pfx\_hfsplus\_read\_wrapper+0x10/0x10
[ 419.956618] ? do\_raw\_spin\_unlock+0x59/0x1a9
[ 419.957214] ? \_raw\_spin\_unlock+0x1a/0x2e
[ 419.957772] hfsplus\_fill\_super+0x348/0x1590
[ 419.958355] ? hlock\_class+0x4c/0x109
[ 419.958867] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.959499] ? \_\_pfx\_string+0x10/0x10
[ 419.960006] ? lock\_acquire+0x3e2/0x454
[ 419.960532] ? bdev\_name.constprop.0+0xce/0x243
[ 419.961129] ? \_\_pfx\_bdev\_name.constprop.0+0x10/0x10
[ 419.961799] ? pointer+0x3f0/0x62f
[ 419.962277] ? \_\_pfx\_pointer+0x10/0x10
[ 419.962761] ? vsnprintf+0x6c4/0xfba
[ 419.963178] ? \_\_pfx\_vsnprintf+0x10/0x10
[ 419.963621] ? setup\_bdev\_super+0x376/0x3b3
[ 419.964029] ? snprintf+0x9d/0xd2
[ 419.964344] ? \_\_pfx\_snprintf+0x10/0x10
[ 419.964675] ? lock\_acquired+0x45c/0x5e9
[ 419.965016] ? set\_blocksize+0x139/0x1c1
[ 419.965381] ? sb\_set\_blocksize+0x6d/0xae
[ 419.965742] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.966179] mount\_bdev+0x12f/0x1bf
[ 419.966512] ? \_\_pfx\_mount\_bdev+0x10/0x10
[ 419.966886] ? vfs\_parse\_fs\_string+0xce/0x111
[ 419.967293] ? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
[ 419.967702] ? \_\_pfx\_hfsplus\_mount+0x10/0x10
[ 419.968073] legacy\_get\_tree+0x104/0x178
[ 419.968414] vfs\_get\_tree+0x86/0x296
[ 419.968751] path\_mount+0xba3/0xd0b
[ 419.969157] ? \_\_pfx\_path\_mount+0x10/0x10
[ 419.969594] ? kmem\_cache\_free+0x1e2/0x260
[ 419.970311] do\_mount+0x99/0xe0
[ 419.970630] ? \_\_pfx\_do\_mount+0x10/0x10
[ 419.971008] \_\_do\_sys\_mount+0x199/0x1c9
[ 419.971397] do\_syscall\_64+0xd0/0x135
[ 419.971761] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 419.972233] RIP: 0033:0x7c3cb812972e
[ 419.972564] Code: 48 8b 0d f5 46 0d 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d c2 46 0d 00 f7 d8 64 89 01 48
[ 419.974371] RSP: 002b:00007ffe30632548 EFLAGS: 00000286 ORIG\_RAX: 00000000000000a5
[ 419.975048] RAX: ffffffffffffffda RBX: 00007ffe306328d8 RCX: 00007c3cb812972e
[ 419.975701] RDX: 0000000020000000 RSI: 0000000020000c80 RDI: 00007ffe306325d0
[ 419.976363] RBP: 00007ffe30632720 R08: 00007ffe30632610 R09: 0000000000000000
[ 419.977034] R10: 0000000000200008 R11: 0000000000000286 R12: 0000000000000000
[ 419.977713] R13: 00007ffe306328e8 R14: 00005a0eb298bc68 R15: 00007c3cb8356000
[ 419.978375] </TASK>
[ 419.978589]
Fixes: 6596528e391a ("hfsplus: ensure bio requests are not smaller than the hardware sectors")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Link: [https://lore.kernel.org/r/20241107114109.839253-1-cascardo@igalia.com](https://lore.kernel.org/r/20241107114109.839253-1-cascardo%40igalia.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)

| -rw-r--r-- | [fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/hfsplus_fs.h?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/wrapper.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/fs/hfsplus/hfsplus\_fs.h b/fs/hfsplus/hfsplus\_fs.hindex 59ce81dca73fce..5389918bbf29db 100644--- a/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=4d09ee08630475573fc43cf640fe4405745890d0)+++ b/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)@@ -156,6 +156,7 @@ struct hfsplus\_sb\_info {  /\* Runtime variables \*/ u32 blockoffset;+ u32 min\_io\_size; sector\_t part\_start; sector\_t sect\_count; int fs\_shift;@@ -307,7 +308,7 @@ struct hfsplus\_readdir\_data { \*/ static inline unsigned short hfsplus\_min\_io\_size(struct super\_block \*sb) {- return max\_t(unsigned short, bdev\_logical\_block\_size(sb->s\_bdev),+ return max\_t(unsigned short, HFSPLUS\_SB(sb)->min\_io\_size, HFSPLUS\_SECTOR\_SIZE); } diff --git a/fs/hfsplus/wrapper.c b/fs/hfsplus/wrapper.cindex 9592ffcb44e5ea..74801911bc1cc4 100644--- a/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=4d09ee08630475573fc43cf640fe4405745890d0)+++ b/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)@@ -172,6 +172,8 @@ int hfsplus\_read\_wrapper(struct super\_block \*sb) if (!blocksize) goto out; + sbi->min\_io\_size = blocksize;+ if (hfsplus\_get\_last\_session(sb, &part\_start, &part\_size)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:47:34 +0000



=== Content from git.kernel.org_2da8e714_20250114_204859.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f57725bcc5816425e25218fdf5fb6923bc578cdf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f57725bcc5816425e25218fdf5fb6923bc578cdf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f57725bcc5816425e25218fdf5fb6923bc578cdf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f57725bcc5816425e25218fdf5fb6923bc578cdf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-11-07 08:41:09 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:22 +0100 |
| commit | [f57725bcc5816425e25218fdf5fb6923bc578cdf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f57725bcc5816425e25218fdf5fb6923bc578cdf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f57725bcc5816425e25218fdf5fb6923bc578cdf)) | |
| tree | [3e034c25edee34709575a15240a2874be6ddeb2a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f57725bcc5816425e25218fdf5fb6923bc578cdf) | |
| parent | [b76579701b1789fc6c323021d552c267d80b4dc2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b76579701b1789fc6c323021d552c267d80b4dc2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f57725bcc5816425e25218fdf5fb6923bc578cdf&id2=b76579701b1789fc6c323021d552c267d80b4dc2)) | |
| download | [linux-f57725bcc5816425e25218fdf5fb6923bc578cdf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f57725bcc5816425e25218fdf5fb6923bc578cdf.tar.gz) | |

hfsplus: don't query the device logical block size multiple times[ Upstream commit 1c82587cb57687de3f18ab4b98a8850c789bedcf ]
Devices block sizes may change. One of these cases is a loop device by
using ioctl LOOP\_SET\_BLOCK\_SIZE.
While this may cause other issues like IO being rejected, in the case of
hfsplus, it will allocate a block by using that size and potentially write
out-of-bounds when hfsplus\_read\_wrapper calls hfsplus\_submit\_bio and the
latter function reads a different io\_size.
Using a new min\_io\_size initally set to sb\_min\_blocksize works for the
purposes of the original fix, since it will be set to the max between
HFSPLUS\_SECTOR\_SIZE and the first seen logical block size. We still use the
max between HFSPLUS\_SECTOR\_SIZE and min\_io\_size in case the latter is not
initialized.
Tested by mounting an hfsplus filesystem with loop block sizes 512, 1024
and 4096.
The produced KASAN report before the fix looks like this:
[ 419.944641] ==================================================================
[ 419.945655] BUG: KASAN: slab-use-after-free in hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.946703] Read of size 2 at addr ffff88800721fc00 by task repro/10678
[ 419.947612]
[ 419.947846] CPU: 0 UID: 0 PID: 10678 Comm: repro Not tainted 6.12.0-rc5-00008-gdf56e0f2f3ca #84
[ 419.949007] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 419.950035] Call Trace:
[ 419.950384] <TASK>
[ 419.950676] dump\_stack\_lvl+0x57/0x78
[ 419.951212] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.951830] print\_report+0x14c/0x49e
[ 419.952361] ? \_\_virt\_addr\_valid+0x267/0x278
[ 419.952979] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 419.953561] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.954231] kasan\_report+0x89/0xb0
[ 419.954748] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955367] hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955948] ? \_\_pfx\_hfsplus\_read\_wrapper+0x10/0x10
[ 419.956618] ? do\_raw\_spin\_unlock+0x59/0x1a9
[ 419.957214] ? \_raw\_spin\_unlock+0x1a/0x2e
[ 419.957772] hfsplus\_fill\_super+0x348/0x1590
[ 419.958355] ? hlock\_class+0x4c/0x109
[ 419.958867] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.959499] ? \_\_pfx\_string+0x10/0x10
[ 419.960006] ? lock\_acquire+0x3e2/0x454
[ 419.960532] ? bdev\_name.constprop.0+0xce/0x243
[ 419.961129] ? \_\_pfx\_bdev\_name.constprop.0+0x10/0x10
[ 419.961799] ? pointer+0x3f0/0x62f
[ 419.962277] ? \_\_pfx\_pointer+0x10/0x10
[ 419.962761] ? vsnprintf+0x6c4/0xfba
[ 419.963178] ? \_\_pfx\_vsnprintf+0x10/0x10
[ 419.963621] ? setup\_bdev\_super+0x376/0x3b3
[ 419.964029] ? snprintf+0x9d/0xd2
[ 419.964344] ? \_\_pfx\_snprintf+0x10/0x10
[ 419.964675] ? lock\_acquired+0x45c/0x5e9
[ 419.965016] ? set\_blocksize+0x139/0x1c1
[ 419.965381] ? sb\_set\_blocksize+0x6d/0xae
[ 419.965742] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.966179] mount\_bdev+0x12f/0x1bf
[ 419.966512] ? \_\_pfx\_mount\_bdev+0x10/0x10
[ 419.966886] ? vfs\_parse\_fs\_string+0xce/0x111
[ 419.967293] ? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
[ 419.967702] ? \_\_pfx\_hfsplus\_mount+0x10/0x10
[ 419.968073] legacy\_get\_tree+0x104/0x178
[ 419.968414] vfs\_get\_tree+0x86/0x296
[ 419.968751] path\_mount+0xba3/0xd0b
[ 419.969157] ? \_\_pfx\_path\_mount+0x10/0x10
[ 419.969594] ? kmem\_cache\_free+0x1e2/0x260
[ 419.970311] do\_mount+0x99/0xe0
[ 419.970630] ? \_\_pfx\_do\_mount+0x10/0x10
[ 419.971008] \_\_do\_sys\_mount+0x199/0x1c9
[ 419.971397] do\_syscall\_64+0xd0/0x135
[ 419.971761] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 419.972233] RIP: 0033:0x7c3cb812972e
[ 419.972564] Code: 48 8b 0d f5 46 0d 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d c2 46 0d 00 f7 d8 64 89 01 48
[ 419.974371] RSP: 002b:00007ffe30632548 EFLAGS: 00000286 ORIG\_RAX: 00000000000000a5
[ 419.975048] RAX: ffffffffffffffda RBX: 00007ffe306328d8 RCX: 00007c3cb812972e
[ 419.975701] RDX: 0000000020000000 RSI: 0000000020000c80 RDI: 00007ffe306325d0
[ 419.976363] RBP: 00007ffe30632720 R08: 00007ffe30632610 R09: 0000000000000000
[ 419.977034] R10: 0000000000200008 R11: 0000000000000286 R12: 0000000000000000
[ 419.977713] R13: 00007ffe306328e8 R14: 00005a0eb298bc68 R15: 00007c3cb8356000
[ 419.978375] </TASK>
[ 419.978589]
Fixes: 6596528e391a ("hfsplus: ensure bio requests are not smaller than the hardware sectors")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Link: [https://lore.kernel.org/r/20241107114109.839253-1-cascardo@igalia.com](https://lore.kernel.org/r/20241107114109.839253-1-cascardo%40igalia.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f57725bcc5816425e25218fdf5fb6923bc578cdf)

| -rw-r--r-- | [fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/hfsplus_fs.h?id=f57725bcc5816425e25218fdf5fb6923bc578cdf) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/wrapper.c?id=f57725bcc5816425e25218fdf5fb6923bc578cdf) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/fs/hfsplus/hfsplus\_fs.h b/fs/hfsplus/hfsplus\_fs.hindex 909e03956c3f22..86cfc147bf3d10 100644--- a/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=b76579701b1789fc6c323021d552c267d80b4dc2)+++ b/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=f57725bcc5816425e25218fdf5fb6923bc578cdf)@@ -156,6 +156,7 @@ struct hfsplus\_sb\_info {  /\* Runtime variables \*/ u32 blockoffset;+ u32 min\_io\_size; sector\_t part\_start; sector\_t sect\_count; int fs\_shift;@@ -306,7 +307,7 @@ struct hfsplus\_readdir\_data { \*/ static inline unsigned short hfsplus\_min\_io\_size(struct super\_block \*sb) {- return max\_t(unsigned short, bdev\_logical\_block\_size(sb->s\_bdev),+ return max\_t(unsigned short, HFSPLUS\_SB(sb)->min\_io\_size, HFSPLUS\_SECTOR\_SIZE); } diff --git a/fs/hfsplus/wrapper.c b/fs/hfsplus/wrapper.cindex 08c1580bdf7ad6..eb76ba8e8fec00 100644--- a/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=b76579701b1789fc6c323021d552c267d80b4dc2)+++ b/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=f57725bcc5816425e25218fdf5fb6923bc578cdf)@@ -170,6 +170,8 @@ int hfsplus\_read\_wrapper(struct super\_block \*sb) if (!blocksize) goto out; + sbi->min\_io\_size = blocksize;+ if (hfsplus\_get\_last\_session(sb, &part\_start, &part\_size)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:47:36 +0000



=== Content from git.kernel.org_f6bba8b8_20250114_204855.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2667c9b7b76efcbc7adbfea249892f20c313b0da)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2667c9b7b76efcbc7adbfea249892f20c313b0da)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2667c9b7b76efcbc7adbfea249892f20c313b0da)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2667c9b7b76efcbc7adbfea249892f20c313b0da)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-11-07 08:41:09 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:52:47 +0100 |
| commit | [2667c9b7b76efcbc7adbfea249892f20c313b0da](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2667c9b7b76efcbc7adbfea249892f20c313b0da) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2667c9b7b76efcbc7adbfea249892f20c313b0da)) | |
| tree | [5ab1ed5c273043fcfbfa2ad9daf96f213c57c717](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2667c9b7b76efcbc7adbfea249892f20c313b0da) | |
| parent | [8010207e9eaf31d5b3a861ac33df6866fba4643c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8010207e9eaf31d5b3a861ac33df6866fba4643c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2667c9b7b76efcbc7adbfea249892f20c313b0da&id2=8010207e9eaf31d5b3a861ac33df6866fba4643c)) | |
| download | [linux-2667c9b7b76efcbc7adbfea249892f20c313b0da.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2667c9b7b76efcbc7adbfea249892f20c313b0da.tar.gz) | |

hfsplus: don't query the device logical block size multiple times[ Upstream commit 1c82587cb57687de3f18ab4b98a8850c789bedcf ]
Devices block sizes may change. One of these cases is a loop device by
using ioctl LOOP\_SET\_BLOCK\_SIZE.
While this may cause other issues like IO being rejected, in the case of
hfsplus, it will allocate a block by using that size and potentially write
out-of-bounds when hfsplus\_read\_wrapper calls hfsplus\_submit\_bio and the
latter function reads a different io\_size.
Using a new min\_io\_size initally set to sb\_min\_blocksize works for the
purposes of the original fix, since it will be set to the max between
HFSPLUS\_SECTOR\_SIZE and the first seen logical block size. We still use the
max between HFSPLUS\_SECTOR\_SIZE and min\_io\_size in case the latter is not
initialized.
Tested by mounting an hfsplus filesystem with loop block sizes 512, 1024
and 4096.
The produced KASAN report before the fix looks like this:
[ 419.944641] ==================================================================
[ 419.945655] BUG: KASAN: slab-use-after-free in hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.946703] Read of size 2 at addr ffff88800721fc00 by task repro/10678
[ 419.947612]
[ 419.947846] CPU: 0 UID: 0 PID: 10678 Comm: repro Not tainted 6.12.0-rc5-00008-gdf56e0f2f3ca #84
[ 419.949007] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 419.950035] Call Trace:
[ 419.950384] <TASK>
[ 419.950676] dump\_stack\_lvl+0x57/0x78
[ 419.951212] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.951830] print\_report+0x14c/0x49e
[ 419.952361] ? \_\_virt\_addr\_valid+0x267/0x278
[ 419.952979] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 419.953561] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.954231] kasan\_report+0x89/0xb0
[ 419.954748] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955367] hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955948] ? \_\_pfx\_hfsplus\_read\_wrapper+0x10/0x10
[ 419.956618] ? do\_raw\_spin\_unlock+0x59/0x1a9
[ 419.957214] ? \_raw\_spin\_unlock+0x1a/0x2e
[ 419.957772] hfsplus\_fill\_super+0x348/0x1590
[ 419.958355] ? hlock\_class+0x4c/0x109
[ 419.958867] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.959499] ? \_\_pfx\_string+0x10/0x10
[ 419.960006] ? lock\_acquire+0x3e2/0x454
[ 419.960532] ? bdev\_name.constprop.0+0xce/0x243
[ 419.961129] ? \_\_pfx\_bdev\_name.constprop.0+0x10/0x10
[ 419.961799] ? pointer+0x3f0/0x62f
[ 419.962277] ? \_\_pfx\_pointer+0x10/0x10
[ 419.962761] ? vsnprintf+0x6c4/0xfba
[ 419.963178] ? \_\_pfx\_vsnprintf+0x10/0x10
[ 419.963621] ? setup\_bdev\_super+0x376/0x3b3
[ 419.964029] ? snprintf+0x9d/0xd2
[ 419.964344] ? \_\_pfx\_snprintf+0x10/0x10
[ 419.964675] ? lock\_acquired+0x45c/0x5e9
[ 419.965016] ? set\_blocksize+0x139/0x1c1
[ 419.965381] ? sb\_set\_blocksize+0x6d/0xae
[ 419.965742] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.966179] mount\_bdev+0x12f/0x1bf
[ 419.966512] ? \_\_pfx\_mount\_bdev+0x10/0x10
[ 419.966886] ? vfs\_parse\_fs\_string+0xce/0x111
[ 419.967293] ? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
[ 419.967702] ? \_\_pfx\_hfsplus\_mount+0x10/0x10
[ 419.968073] legacy\_get\_tree+0x104/0x178
[ 419.968414] vfs\_get\_tree+0x86/0x296
[ 419.968751] path\_mount+0xba3/0xd0b
[ 419.969157] ? \_\_pfx\_path\_mount+0x10/0x10
[ 419.969594] ? kmem\_cache\_free+0x1e2/0x260
[ 419.970311] do\_mount+0x99/0xe0
[ 419.970630] ? \_\_pfx\_do\_mount+0x10/0x10
[ 419.971008] \_\_do\_sys\_mount+0x199/0x1c9
[ 419.971397] do\_syscall\_64+0xd0/0x135
[ 419.971761] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 419.972233] RIP: 0033:0x7c3cb812972e
[ 419.972564] Code: 48 8b 0d f5 46 0d 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d c2 46 0d 00 f7 d8 64 89 01 48
[ 419.974371] RSP: 002b:00007ffe30632548 EFLAGS: 00000286 ORIG\_RAX: 00000000000000a5
[ 419.975048] RAX: ffffffffffffffda RBX: 00007ffe306328d8 RCX: 00007c3cb812972e
[ 419.975701] RDX: 0000000020000000 RSI: 0000000020000c80 RDI: 00007ffe306325d0
[ 419.976363] RBP: 00007ffe30632720 R08: 00007ffe30632610 R09: 0000000000000000
[ 419.977034] R10: 0000000000200008 R11: 0000000000000286 R12: 0000000000000000
[ 419.977713] R13: 00007ffe306328e8 R14: 00005a0eb298bc68 R15: 00007c3cb8356000
[ 419.978375] </TASK>
[ 419.978589]
Fixes: 6596528e391a ("hfsplus: ensure bio requests are not smaller than the hardware sectors")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Link: [https://lore.kernel.org/r/20241107114109.839253-1-cascardo@igalia.com](https://lore.kernel.org/r/20241107114109.839253-1-cascardo%40igalia.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2667c9b7b76efcbc7adbfea249892f20c313b0da)

| -rw-r--r-- | [fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/hfsplus_fs.h?id=2667c9b7b76efcbc7adbfea249892f20c313b0da) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/wrapper.c?id=2667c9b7b76efcbc7adbfea249892f20c313b0da) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/fs/hfsplus/hfsplus\_fs.h b/fs/hfsplus/hfsplus\_fs.hindex 9e78f181c24f48..c1433043473370 100644--- a/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=8010207e9eaf31d5b3a861ac33df6866fba4643c)+++ b/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=2667c9b7b76efcbc7adbfea249892f20c313b0da)@@ -156,6 +156,7 @@ struct hfsplus\_sb\_info {  /\* Runtime variables \*/ u32 blockoffset;+ u32 min\_io\_size; sector\_t part\_start; sector\_t sect\_count; int fs\_shift;@@ -307,7 +308,7 @@ struct hfsplus\_readdir\_data { \*/ static inline unsigned short hfsplus\_min\_io\_size(struct super\_block \*sb) {- return max\_t(unsigned short, bdev\_logical\_block\_size(sb->s\_bdev),+ return max\_t(unsigned short, HFSPLUS\_SB(sb)->min\_io\_size, HFSPLUS\_SECTOR\_SIZE); } diff --git a/fs/hfsplus/wrapper.c b/fs/hfsplus/wrapper.cindex ce9346099c72dc..4b0fdc49d1fe7e 100644--- a/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=8010207e9eaf31d5b3a861ac33df6866fba4643c)+++ b/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=2667c9b7b76efcbc7adbfea249892f20c313b0da)@@ -172,6 +172,8 @@ int hfsplus\_read\_wrapper(struct super\_block \*sb) if (!blocksize) goto out; + sbi->min\_io\_size = blocksize;+ if (hfsplus\_get\_last\_session(sb, &part\_start, &part\_size)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:47:32 +0000



=== Content from git.kernel.org_4d7922fa_20250114_204853.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-11-07 08:41:09 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:43 +0100 |
| commit | [06cbfbb13ac88f4154c2eb4bc4176f9d10139847](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847)) | |
| tree | [2fa4d7fe96d9fd7e2bf29dc3ecd192596c16cf70](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847) | |
| parent | [b5d785fb2000d0d6e880a5706e02e6f7f78b9b28](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5d785fb2000d0d6e880a5706e02e6f7f78b9b28) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847&id2=b5d785fb2000d0d6e880a5706e02e6f7f78b9b28)) | |
| download | [linux-06cbfbb13ac88f4154c2eb4bc4176f9d10139847.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-06cbfbb13ac88f4154c2eb4bc4176f9d10139847.tar.gz) | |

hfsplus: don't query the device logical block size multiple times[ Upstream commit 1c82587cb57687de3f18ab4b98a8850c789bedcf ]
Devices block sizes may change. One of these cases is a loop device by
using ioctl LOOP\_SET\_BLOCK\_SIZE.
While this may cause other issues like IO being rejected, in the case of
hfsplus, it will allocate a block by using that size and potentially write
out-of-bounds when hfsplus\_read\_wrapper calls hfsplus\_submit\_bio and the
latter function reads a different io\_size.
Using a new min\_io\_size initally set to sb\_min\_blocksize works for the
purposes of the original fix, since it will be set to the max between
HFSPLUS\_SECTOR\_SIZE and the first seen logical block size. We still use the
max between HFSPLUS\_SECTOR\_SIZE and min\_io\_size in case the latter is not
initialized.
Tested by mounting an hfsplus filesystem with loop block sizes 512, 1024
and 4096.
The produced KASAN report before the fix looks like this:
[ 419.944641] ==================================================================
[ 419.945655] BUG: KASAN: slab-use-after-free in hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.946703] Read of size 2 at addr ffff88800721fc00 by task repro/10678
[ 419.947612]
[ 419.947846] CPU: 0 UID: 0 PID: 10678 Comm: repro Not tainted 6.12.0-rc5-00008-gdf56e0f2f3ca #84
[ 419.949007] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 419.950035] Call Trace:
[ 419.950384] <TASK>
[ 419.950676] dump\_stack\_lvl+0x57/0x78
[ 419.951212] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.951830] print\_report+0x14c/0x49e
[ 419.952361] ? \_\_virt\_addr\_valid+0x267/0x278
[ 419.952979] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 419.953561] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.954231] kasan\_report+0x89/0xb0
[ 419.954748] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955367] hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955948] ? \_\_pfx\_hfsplus\_read\_wrapper+0x10/0x10
[ 419.956618] ? do\_raw\_spin\_unlock+0x59/0x1a9
[ 419.957214] ? \_raw\_spin\_unlock+0x1a/0x2e
[ 419.957772] hfsplus\_fill\_super+0x348/0x1590
[ 419.958355] ? hlock\_class+0x4c/0x109
[ 419.958867] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.959499] ? \_\_pfx\_string+0x10/0x10
[ 419.960006] ? lock\_acquire+0x3e2/0x454
[ 419.960532] ? bdev\_name.constprop.0+0xce/0x243
[ 419.961129] ? \_\_pfx\_bdev\_name.constprop.0+0x10/0x10
[ 419.961799] ? pointer+0x3f0/0x62f
[ 419.962277] ? \_\_pfx\_pointer+0x10/0x10
[ 419.962761] ? vsnprintf+0x6c4/0xfba
[ 419.963178] ? \_\_pfx\_vsnprintf+0x10/0x10
[ 419.963621] ? setup\_bdev\_super+0x376/0x3b3
[ 419.964029] ? snprintf+0x9d/0xd2
[ 419.964344] ? \_\_pfx\_snprintf+0x10/0x10
[ 419.964675] ? lock\_acquired+0x45c/0x5e9
[ 419.965016] ? set\_blocksize+0x139/0x1c1
[ 419.965381] ? sb\_set\_blocksize+0x6d/0xae
[ 419.965742] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.966179] mount\_bdev+0x12f/0x1bf
[ 419.966512] ? \_\_pfx\_mount\_bdev+0x10/0x10
[ 419.966886] ? vfs\_parse\_fs\_string+0xce/0x111
[ 419.967293] ? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
[ 419.967702] ? \_\_pfx\_hfsplus\_mount+0x10/0x10
[ 419.968073] legacy\_get\_tree+0x104/0x178
[ 419.968414] vfs\_get\_tree+0x86/0x296
[ 419.968751] path\_mount+0xba3/0xd0b
[ 419.969157] ? \_\_pfx\_path\_mount+0x10/0x10
[ 419.969594] ? kmem\_cache\_free+0x1e2/0x260
[ 419.970311] do\_mount+0x99/0xe0
[ 419.970630] ? \_\_pfx\_do\_mount+0x10/0x10
[ 419.971008] \_\_do\_sys\_mount+0x199/0x1c9
[ 419.971397] do\_syscall\_64+0xd0/0x135
[ 419.971761] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 419.972233] RIP: 0033:0x7c3cb812972e
[ 419.972564] Code: 48 8b 0d f5 46 0d 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d c2 46 0d 00 f7 d8 64 89 01 48
[ 419.974371] RSP: 002b:00007ffe30632548 EFLAGS: 00000286 ORIG\_RAX: 00000000000000a5
[ 419.975048] RAX: ffffffffffffffda RBX: 00007ffe306328d8 RCX: 00007c3cb812972e
[ 419.975701] RDX: 0000000020000000 RSI: 0000000020000c80 RDI: 00007ffe306325d0
[ 419.976363] RBP: 00007ffe30632720 R08: 00007ffe30632610 R09: 0000000000000000
[ 419.977034] R10: 0000000000200008 R11: 0000000000000286 R12: 0000000000000000
[ 419.977713] R13: 00007ffe306328e8 R14: 00005a0eb298bc68 R15: 00007c3cb8356000
[ 419.978375] </TASK>
[ 419.978589]
Fixes: 6596528e391a ("hfsplus: ensure bio requests are not smaller than the hardware sectors")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Link: [https://lore.kernel.org/r/20241107114109.839253-1-cascardo@igalia.com](https://lore.kernel.org/r/20241107114109.839253-1-cascardo%40igalia.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847)

| -rw-r--r-- | [fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/hfsplus_fs.h?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/wrapper.c?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/fs/hfsplus/hfsplus\_fs.h b/fs/hfsplus/hfsplus\_fs.hindex decb671db91b46..c01bf9ff56a961 100644--- a/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=b5d785fb2000d0d6e880a5706e02e6f7f78b9b28)+++ b/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847)@@ -156,6 +156,7 @@ struct hfsplus\_sb\_info {  /\* Runtime variables \*/ u32 blockoffset;+ u32 min\_io\_size; sector\_t part\_start; sector\_t sect\_count; int fs\_shift;@@ -306,7 +307,7 @@ struct hfsplus\_readdir\_data { \*/ static inline unsigned short hfsplus\_min\_io\_size(struct super\_block \*sb) {- return max\_t(unsigned short, bdev\_logical\_block\_size(sb->s\_bdev),+ return max\_t(unsigned short, HFSPLUS\_SB(sb)->min\_io\_size, HFSPLUS\_SECTOR\_SIZE); } diff --git a/fs/hfsplus/wrapper.c b/fs/hfsplus/wrapper.cindex 0350dc7821bf95..59ba0a30f5392d 100644--- a/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=b5d785fb2000d0d6e880a5706e02e6f7f78b9b28)+++ b/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=06cbfbb13ac88f4154c2eb4bc4176f9d10139847)@@ -173,6 +173,8 @@ int hfsplus\_read\_wrapper(struct super\_block \*sb) if (!blocksize) goto out; + sbi->min\_io\_size = blocksize;+ if (hfsplus\_get\_last\_session(sb, &part\_start, &part\_size)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:47:30 +0000



=== Content from git.kernel.org_dd11f0e4_20250114_204854.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=21900e8478126ff6afe3b66679f676e74d1f8830)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=21900e8478126ff6afe3b66679f676e74d1f8830)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=21900e8478126ff6afe3b66679f676e74d1f8830)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=21900e8478126ff6afe3b66679f676e74d1f8830)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-11-07 08:41:09 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:31:45 +0100 |
| commit | [21900e8478126ff6afe3b66679f676e74d1f8830](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=21900e8478126ff6afe3b66679f676e74d1f8830) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=21900e8478126ff6afe3b66679f676e74d1f8830)) | |
| tree | [241f3d62052848bc7a0f21e2d00ed7cb856c5f51](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=21900e8478126ff6afe3b66679f676e74d1f8830) | |
| parent | [13ebba9e57a6b176bb238d31ad7fb95bbbcc7688](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13ebba9e57a6b176bb238d31ad7fb95bbbcc7688) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=21900e8478126ff6afe3b66679f676e74d1f8830&id2=13ebba9e57a6b176bb238d31ad7fb95bbbcc7688)) | |
| download | [linux-21900e8478126ff6afe3b66679f676e74d1f8830.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-21900e8478126ff6afe3b66679f676e74d1f8830.tar.gz) | |

hfsplus: don't query the device logical block size multiple times[ Upstream commit 1c82587cb57687de3f18ab4b98a8850c789bedcf ]
Devices block sizes may change. One of these cases is a loop device by
using ioctl LOOP\_SET\_BLOCK\_SIZE.
While this may cause other issues like IO being rejected, in the case of
hfsplus, it will allocate a block by using that size and potentially write
out-of-bounds when hfsplus\_read\_wrapper calls hfsplus\_submit\_bio and the
latter function reads a different io\_size.
Using a new min\_io\_size initally set to sb\_min\_blocksize works for the
purposes of the original fix, since it will be set to the max between
HFSPLUS\_SECTOR\_SIZE and the first seen logical block size. We still use the
max between HFSPLUS\_SECTOR\_SIZE and min\_io\_size in case the latter is not
initialized.
Tested by mounting an hfsplus filesystem with loop block sizes 512, 1024
and 4096.
The produced KASAN report before the fix looks like this:
[ 419.944641] ==================================================================
[ 419.945655] BUG: KASAN: slab-use-after-free in hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.946703] Read of size 2 at addr ffff88800721fc00 by task repro/10678
[ 419.947612]
[ 419.947846] CPU: 0 UID: 0 PID: 10678 Comm: repro Not tainted 6.12.0-rc5-00008-gdf56e0f2f3ca #84
[ 419.949007] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 419.950035] Call Trace:
[ 419.950384] <TASK>
[ 419.950676] dump\_stack\_lvl+0x57/0x78
[ 419.951212] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.951830] print\_report+0x14c/0x49e
[ 419.952361] ? \_\_virt\_addr\_valid+0x267/0x278
[ 419.952979] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 419.953561] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.954231] kasan\_report+0x89/0xb0
[ 419.954748] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955367] hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955948] ? \_\_pfx\_hfsplus\_read\_wrapper+0x10/0x10
[ 419.956618] ? do\_raw\_spin\_unlock+0x59/0x1a9
[ 419.957214] ? \_raw\_spin\_unlock+0x1a/0x2e
[ 419.957772] hfsplus\_fill\_super+0x348/0x1590
[ 419.958355] ? hlock\_class+0x4c/0x109
[ 419.958867] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.959499] ? \_\_pfx\_string+0x10/0x10
[ 419.960006] ? lock\_acquire+0x3e2/0x454
[ 419.960532] ? bdev\_name.constprop.0+0xce/0x243
[ 419.961129] ? \_\_pfx\_bdev\_name.constprop.0+0x10/0x10
[ 419.961799] ? pointer+0x3f0/0x62f
[ 419.962277] ? \_\_pfx\_pointer+0x10/0x10
[ 419.962761] ? vsnprintf+0x6c4/0xfba
[ 419.963178] ? \_\_pfx\_vsnprintf+0x10/0x10
[ 419.963621] ? setup\_bdev\_super+0x376/0x3b3
[ 419.964029] ? snprintf+0x9d/0xd2
[ 419.964344] ? \_\_pfx\_snprintf+0x10/0x10
[ 419.964675] ? lock\_acquired+0x45c/0x5e9
[ 419.965016] ? set\_blocksize+0x139/0x1c1
[ 419.965381] ? sb\_set\_blocksize+0x6d/0xae
[ 419.965742] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.966179] mount\_bdev+0x12f/0x1bf
[ 419.966512] ? \_\_pfx\_mount\_bdev+0x10/0x10
[ 419.966886] ? vfs\_parse\_fs\_string+0xce/0x111
[ 419.967293] ? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
[ 419.967702] ? \_\_pfx\_hfsplus\_mount+0x10/0x10
[ 419.968073] legacy\_get\_tree+0x104/0x178
[ 419.968414] vfs\_get\_tree+0x86/0x296
[ 419.968751] path\_mount+0xba3/0xd0b
[ 419.969157] ? \_\_pfx\_path\_mount+0x10/0x10
[ 419.969594] ? kmem\_cache\_free+0x1e2/0x260
[ 419.970311] do\_mount+0x99/0xe0
[ 419.970630] ? \_\_pfx\_do\_mount+0x10/0x10
[ 419.971008] \_\_do\_sys\_mount+0x199/0x1c9
[ 419.971397] do\_syscall\_64+0xd0/0x135
[ 419.971761] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 419.972233] RIP: 0033:0x7c3cb812972e
[ 419.972564] Code: 48 8b 0d f5 46 0d 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d c2 46 0d 00 f7 d8 64 89 01 48
[ 419.974371] RSP: 002b:00007ffe30632548 EFLAGS: 00000286 ORIG\_RAX: 00000000000000a5
[ 419.975048] RAX: ffffffffffffffda RBX: 00007ffe306328d8 RCX: 00007c3cb812972e
[ 419.975701] RDX: 0000000020000000 RSI: 0000000020000c80 RDI: 00007ffe306325d0
[ 419.976363] RBP: 00007ffe30632720 R08: 00007ffe30632610 R09: 0000000000000000
[ 419.977034] R10: 0000000000200008 R11: 0000000000000286 R12: 0000000000000000
[ 419.977713] R13: 00007ffe306328e8 R14: 00005a0eb298bc68 R15: 00007c3cb8356000
[ 419.978375] </TASK>
[ 419.978589]
Fixes: 6596528e391a ("hfsplus: ensure bio requests are not smaller than the hardware sectors")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Link: [https://lore.kernel.org/r/20241107114109.839253-1-cascardo@igalia.com](https://lore.kernel.org/r/20241107114109.839253-1-cascardo%40igalia.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=21900e8478126ff6afe3b66679f676e74d1f8830)

| -rw-r--r-- | [fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/hfsplus_fs.h?id=21900e8478126ff6afe3b66679f676e74d1f8830) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/wrapper.c?id=21900e8478126ff6afe3b66679f676e74d1f8830) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/fs/hfsplus/hfsplus\_fs.h b/fs/hfsplus/hfsplus\_fs.hindex 583c196ecd5206..1473b04fc0f311 100644--- a/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=13ebba9e57a6b176bb238d31ad7fb95bbbcc7688)+++ b/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=21900e8478126ff6afe3b66679f676e74d1f8830)@@ -156,6 +156,7 @@ struct hfsplus\_sb\_info {  /\* Runtime variables \*/ u32 blockoffset;+ u32 min\_io\_size; sector\_t part\_start; sector\_t sect\_count; int fs\_shift;@@ -306,7 +307,7 @@ struct hfsplus\_readdir\_data { \*/ static inline unsigned short hfsplus\_min\_io\_size(struct super\_block \*sb) {- return max\_t(unsigned short, bdev\_logical\_block\_size(sb->s\_bdev),+ return max\_t(unsigned short, HFSPLUS\_SB(sb)->min\_io\_size, HFSPLUS\_SECTOR\_SIZE); } diff --git a/fs/hfsplus/wrapper.c b/fs/hfsplus/wrapper.cindex 0b791adf02e53d..a51a58db3fef04 100644--- a/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=13ebba9e57a6b176bb238d31ad7fb95bbbcc7688)+++ b/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=21900e8478126ff6afe3b66679f676e74d1f8830)@@ -171,6 +171,8 @@ int hfsplus\_read\_wrapper(struct super\_block \*sb) if (!blocksize) goto out; + sbi->min\_io\_size = blocksize;+ if (hfsplus\_get\_last\_session(sb, &part\_start, &part\_size)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:47:31 +0000



=== Content from git.kernel.org_0e064caf_20250114_204854.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c82587cb57687de3f18ab4b98a8850c789bedcf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c82587cb57687de3f18ab4b98a8850c789bedcf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c82587cb57687de3f18ab4b98a8850c789bedcf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c82587cb57687de3f18ab4b98a8850c789bedcf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-11-07 08:41:09 -0300 |
| --- | --- | --- |
| committer | Christian Brauner <brauner@kernel.org> | 2024-11-12 14:36:45 +0100 |
| commit | [1c82587cb57687de3f18ab4b98a8850c789bedcf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c82587cb57687de3f18ab4b98a8850c789bedcf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c82587cb57687de3f18ab4b98a8850c789bedcf)) | |
| tree | [30edf160b38f19cc6b358d3217b8eeedba30e2a0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c82587cb57687de3f18ab4b98a8850c789bedcf) | |
| parent | [fdfa4c02e6dd6c67f5cef8d78c6204e1ff7e12ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fdfa4c02e6dd6c67f5cef8d78c6204e1ff7e12ca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c82587cb57687de3f18ab4b98a8850c789bedcf&id2=fdfa4c02e6dd6c67f5cef8d78c6204e1ff7e12ca)) | |
| download | [linux-1c82587cb57687de3f18ab4b98a8850c789bedcf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c82587cb57687de3f18ab4b98a8850c789bedcf.tar.gz) | |

hfsplus: don't query the device logical block size multiple timesDevices block sizes may change. One of these cases is a loop device by
using ioctl LOOP\_SET\_BLOCK\_SIZE.
While this may cause other issues like IO being rejected, in the case of
hfsplus, it will allocate a block by using that size and potentially write
out-of-bounds when hfsplus\_read\_wrapper calls hfsplus\_submit\_bio and the
latter function reads a different io\_size.
Using a new min\_io\_size initally set to sb\_min\_blocksize works for the
purposes of the original fix, since it will be set to the max between
HFSPLUS\_SECTOR\_SIZE and the first seen logical block size. We still use the
max between HFSPLUS\_SECTOR\_SIZE and min\_io\_size in case the latter is not
initialized.
Tested by mounting an hfsplus filesystem with loop block sizes 512, 1024
and 4096.
The produced KASAN report before the fix looks like this:
[ 419.944641] ==================================================================
[ 419.945655] BUG: KASAN: slab-use-after-free in hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.946703] Read of size 2 at addr ffff88800721fc00 by task repro/10678
[ 419.947612]
[ 419.947846] CPU: 0 UID: 0 PID: 10678 Comm: repro Not tainted 6.12.0-rc5-00008-gdf56e0f2f3ca #84
[ 419.949007] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 419.950035] Call Trace:
[ 419.950384] <TASK>
[ 419.950676] dump\_stack\_lvl+0x57/0x78
[ 419.951212] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.951830] print\_report+0x14c/0x49e
[ 419.952361] ? \_\_virt\_addr\_valid+0x267/0x278
[ 419.952979] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 419.953561] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.954231] kasan\_report+0x89/0xb0
[ 419.954748] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955367] hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955948] ? \_\_pfx\_hfsplus\_read\_wrapper+0x10/0x10
[ 419.956618] ? do\_raw\_spin\_unlock+0x59/0x1a9
[ 419.957214] ? \_raw\_spin\_unlock+0x1a/0x2e
[ 419.957772] hfsplus\_fill\_super+0x348/0x1590
[ 419.958355] ? hlock\_class+0x4c/0x109
[ 419.958867] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.959499] ? \_\_pfx\_string+0x10/0x10
[ 419.960006] ? lock\_acquire+0x3e2/0x454
[ 419.960532] ? bdev\_name.constprop.0+0xce/0x243
[ 419.961129] ? \_\_pfx\_bdev\_name.constprop.0+0x10/0x10
[ 419.961799] ? pointer+0x3f0/0x62f
[ 419.962277] ? \_\_pfx\_pointer+0x10/0x10
[ 419.962761] ? vsnprintf+0x6c4/0xfba
[ 419.963178] ? \_\_pfx\_vsnprintf+0x10/0x10
[ 419.963621] ? setup\_bdev\_super+0x376/0x3b3
[ 419.964029] ? snprintf+0x9d/0xd2
[ 419.964344] ? \_\_pfx\_snprintf+0x10/0x10
[ 419.964675] ? lock\_acquired+0x45c/0x5e9
[ 419.965016] ? set\_blocksize+0x139/0x1c1
[ 419.965381] ? sb\_set\_blocksize+0x6d/0xae
[ 419.965742] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.966179] mount\_bdev+0x12f/0x1bf
[ 419.966512] ? \_\_pfx\_mount\_bdev+0x10/0x10
[ 419.966886] ? vfs\_parse\_fs\_string+0xce/0x111
[ 419.967293] ? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
[ 419.967702] ? \_\_pfx\_hfsplus\_mount+0x10/0x10
[ 419.968073] legacy\_get\_tree+0x104/0x178
[ 419.968414] vfs\_get\_tree+0x86/0x296
[ 419.968751] path\_mount+0xba3/0xd0b
[ 419.969157] ? \_\_pfx\_path\_mount+0x10/0x10
[ 419.969594] ? kmem\_cache\_free+0x1e2/0x260
[ 419.970311] do\_mount+0x99/0xe0
[ 419.970630] ? \_\_pfx\_do\_mount+0x10/0x10
[ 419.971008] \_\_do\_sys\_mount+0x199/0x1c9
[ 419.971397] do\_syscall\_64+0xd0/0x135
[ 419.971761] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 419.972233] RIP: 0033:0x7c3cb812972e
[ 419.972564] Code: 48 8b 0d f5 46 0d 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d c2 46 0d 00 f7 d8 64 89 01 48
[ 419.974371] RSP: 002b:00007ffe30632548 EFLAGS: 00000286 ORIG\_RAX: 00000000000000a5
[ 419.975048] RAX: ffffffffffffffda RBX: 00007ffe306328d8 RCX: 00007c3cb812972e
[ 419.975701] RDX: 0000000020000000 RSI: 0000000020000c80 RDI: 00007ffe306325d0
[ 419.976363] RBP: 00007ffe30632720 R08: 00007ffe30632610 R09: 0000000000000000
[ 419.977034] R10: 0000000000200008 R11: 0000000000000286 R12: 0000000000000000
[ 419.977713] R13: 00007ffe306328e8 R14: 00005a0eb298bc68 R15: 00007c3cb8356000
[ 419.978375] </TASK>
[ 419.978589]
Fixes: 6596528e391a ("hfsplus: ensure bio requests are not smaller than the hardware sectors")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Link: [https://lore.kernel.org/r/20241107114109.839253-1-cascardo@igalia.com](https://lore.kernel.org/r/20241107114109.839253-1-cascardo%40igalia.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c82587cb57687de3f18ab4b98a8850c789bedcf)

| -rw-r--r-- | [fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/hfsplus_fs.h?id=1c82587cb57687de3f18ab4b98a8850c789bedcf) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/wrapper.c?id=1c82587cb57687de3f18ab4b98a8850c789bedcf) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/fs/hfsplus/hfsplus\_fs.h b/fs/hfsplus/hfsplus\_fs.hindex 59ce81dca73fce..5389918bbf29db 100644--- a/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=fdfa4c02e6dd6c67f5cef8d78c6204e1ff7e12ca)+++ b/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=1c82587cb57687de3f18ab4b98a8850c789bedcf)@@ -156,6 +156,7 @@ struct hfsplus\_sb\_info {  /\* Runtime variables \*/ u32 blockoffset;+ u32 min\_io\_size; sector\_t part\_start; sector\_t sect\_count; int fs\_shift;@@ -307,7 +308,7 @@ struct hfsplus\_readdir\_data { \*/ static inline unsigned short hfsplus\_min\_io\_size(struct super\_block \*sb) {- return max\_t(unsigned short, bdev\_logical\_block\_size(sb->s\_bdev),+ return max\_t(unsigned short, HFSPLUS\_SB(sb)->min\_io\_size, HFSPLUS\_SECTOR\_SIZE); } diff --git a/fs/hfsplus/wrapper.c b/fs/hfsplus/wrapper.cindex ce9346099c72dc..4b0fdc49d1fe7e 100644--- a/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=fdfa4c02e6dd6c67f5cef8d78c6204e1ff7e12ca)+++ b/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=1c82587cb57687de3f18ab4b98a8850c789bedcf)@@ -172,6 +172,8 @@ int hfsplus\_read\_wrapper(struct super\_block \*sb) if (!blocksize) goto out; + sbi->min\_io\_size = blocksize;+ if (hfsplus\_get\_last\_session(sb, &part\_start, &part\_size)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:47:31 +0000



=== Content from git.kernel.org_730d6986_20250114_204856.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thadeu Lima de Souza Cascardo <cascardo@igalia.com> | 2024-11-07 08:41:09 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:30 +0100 |
| commit | [baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8)) | |
| tree | [ab3735eb263cda41b13fd3b3add45c43a48d308e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8) | |
| parent | [36a305d0caeb37d68bd11a2a0cc01a85a9084c11](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36a305d0caeb37d68bd11a2a0cc01a85a9084c11) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8&id2=36a305d0caeb37d68bd11a2a0cc01a85a9084c11)) | |
| download | [linux-baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8.tar.gz) | |

hfsplus: don't query the device logical block size multiple times[ Upstream commit 1c82587cb57687de3f18ab4b98a8850c789bedcf ]
Devices block sizes may change. One of these cases is a loop device by
using ioctl LOOP\_SET\_BLOCK\_SIZE.
While this may cause other issues like IO being rejected, in the case of
hfsplus, it will allocate a block by using that size and potentially write
out-of-bounds when hfsplus\_read\_wrapper calls hfsplus\_submit\_bio and the
latter function reads a different io\_size.
Using a new min\_io\_size initally set to sb\_min\_blocksize works for the
purposes of the original fix, since it will be set to the max between
HFSPLUS\_SECTOR\_SIZE and the first seen logical block size. We still use the
max between HFSPLUS\_SECTOR\_SIZE and min\_io\_size in case the latter is not
initialized.
Tested by mounting an hfsplus filesystem with loop block sizes 512, 1024
and 4096.
The produced KASAN report before the fix looks like this:
[ 419.944641] ==================================================================
[ 419.945655] BUG: KASAN: slab-use-after-free in hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.946703] Read of size 2 at addr ffff88800721fc00 by task repro/10678
[ 419.947612]
[ 419.947846] CPU: 0 UID: 0 PID: 10678 Comm: repro Not tainted 6.12.0-rc5-00008-gdf56e0f2f3ca #84
[ 419.949007] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014
[ 419.950035] Call Trace:
[ 419.950384] <TASK>
[ 419.950676] dump\_stack\_lvl+0x57/0x78
[ 419.951212] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.951830] print\_report+0x14c/0x49e
[ 419.952361] ? \_\_virt\_addr\_valid+0x267/0x278
[ 419.952979] ? kmem\_cache\_debug\_flags+0xc/0x1d
[ 419.953561] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.954231] kasan\_report+0x89/0xb0
[ 419.954748] ? hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955367] hfsplus\_read\_wrapper+0x659/0xa0a
[ 419.955948] ? \_\_pfx\_hfsplus\_read\_wrapper+0x10/0x10
[ 419.956618] ? do\_raw\_spin\_unlock+0x59/0x1a9
[ 419.957214] ? \_raw\_spin\_unlock+0x1a/0x2e
[ 419.957772] hfsplus\_fill\_super+0x348/0x1590
[ 419.958355] ? hlock\_class+0x4c/0x109
[ 419.958867] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.959499] ? \_\_pfx\_string+0x10/0x10
[ 419.960006] ? lock\_acquire+0x3e2/0x454
[ 419.960532] ? bdev\_name.constprop.0+0xce/0x243
[ 419.961129] ? \_\_pfx\_bdev\_name.constprop.0+0x10/0x10
[ 419.961799] ? pointer+0x3f0/0x62f
[ 419.962277] ? \_\_pfx\_pointer+0x10/0x10
[ 419.962761] ? vsnprintf+0x6c4/0xfba
[ 419.963178] ? \_\_pfx\_vsnprintf+0x10/0x10
[ 419.963621] ? setup\_bdev\_super+0x376/0x3b3
[ 419.964029] ? snprintf+0x9d/0xd2
[ 419.964344] ? \_\_pfx\_snprintf+0x10/0x10
[ 419.964675] ? lock\_acquired+0x45c/0x5e9
[ 419.965016] ? set\_blocksize+0x139/0x1c1
[ 419.965381] ? sb\_set\_blocksize+0x6d/0xae
[ 419.965742] ? \_\_pfx\_hfsplus\_fill\_super+0x10/0x10
[ 419.966179] mount\_bdev+0x12f/0x1bf
[ 419.966512] ? \_\_pfx\_mount\_bdev+0x10/0x10
[ 419.966886] ? vfs\_parse\_fs\_string+0xce/0x111
[ 419.967293] ? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
[ 419.967702] ? \_\_pfx\_hfsplus\_mount+0x10/0x10
[ 419.968073] legacy\_get\_tree+0x104/0x178
[ 419.968414] vfs\_get\_tree+0x86/0x296
[ 419.968751] path\_mount+0xba3/0xd0b
[ 419.969157] ? \_\_pfx\_path\_mount+0x10/0x10
[ 419.969594] ? kmem\_cache\_free+0x1e2/0x260
[ 419.970311] do\_mount+0x99/0xe0
[ 419.970630] ? \_\_pfx\_do\_mount+0x10/0x10
[ 419.971008] \_\_do\_sys\_mount+0x199/0x1c9
[ 419.971397] do\_syscall\_64+0xd0/0x135
[ 419.971761] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 419.972233] RIP: 0033:0x7c3cb812972e
[ 419.972564] Code: 48 8b 0d f5 46 0d 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d c2 46 0d 00 f7 d8 64 89 01 48
[ 419.974371] RSP: 002b:00007ffe30632548 EFLAGS: 00000286 ORIG\_RAX: 00000000000000a5
[ 419.975048] RAX: ffffffffffffffda RBX: 00007ffe306328d8 RCX: 00007c3cb812972e
[ 419.975701] RDX: 0000000020000000 RSI: 0000000020000c80 RDI: 00007ffe306325d0
[ 419.976363] RBP: 00007ffe30632720 R08: 00007ffe30632610 R09: 0000000000000000
[ 419.977034] R10: 0000000000200008 R11: 0000000000000286 R12: 0000000000000000
[ 419.977713] R13: 00007ffe306328e8 R14: 00005a0eb298bc68 R15: 00007c3cb8356000
[ 419.978375] </TASK>
[ 419.978589]
Fixes: 6596528e391a ("hfsplus: ensure bio requests are not smaller than the hardware sectors")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@igalia.com>
Link: [https://lore.kernel.org/r/20241107114109.839253-1-cascardo@igalia.com](https://lore.kernel.org/r/20241107114109.839253-1-cascardo%40igalia.com)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8)

| -rw-r--r-- | [fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/hfsplus_fs.h?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/wrapper.c?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/fs/hfsplus/hfsplus\_fs.h b/fs/hfsplus/hfsplus\_fs.hindex e9b13f771990b4..2d6f2c62230a36 100644--- a/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=36a305d0caeb37d68bd11a2a0cc01a85a9084c11)+++ b/[fs/hfsplus/hfsplus\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/hfsplus_fs.h?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8)@@ -156,6 +156,7 @@ struct hfsplus\_sb\_info {  /\* Runtime variables \*/ u32 blockoffset;+ u32 min\_io\_size; sector\_t part\_start; sector\_t sect\_count; int fs\_shift;@@ -306,7 +307,7 @@ struct hfsplus\_readdir\_data { \*/ static inline unsigned short hfsplus\_min\_io\_size(struct super\_block \*sb) {- return max\_t(unsigned short, bdev\_logical\_block\_size(sb->s\_bdev),+ return max\_t(unsigned short, HFSPLUS\_SB(sb)->min\_io\_size, HFSPLUS\_SECTOR\_SIZE); } diff --git a/fs/hfsplus/wrapper.c b/fs/hfsplus/wrapper.cindex 08c1580bdf7ad6..eb76ba8e8fec00 100644--- a/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=36a305d0caeb37d68bd11a2a0cc01a85a9084c11)+++ b/[fs/hfsplus/wrapper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/wrapper.c?id=baccb5e12577b7a9eff54ffba301fdaa0f3ee5a8)@@ -170,6 +170,8 @@ int hfsplus\_read\_wrapper(struct super\_block \*sb) if (!blocksize) goto out; + sbi->min\_io\_size = blocksize;+ if (hfsplus\_get\_last\_session(sb, &part\_start, &part\_size)) goto out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:47:34 +0000


