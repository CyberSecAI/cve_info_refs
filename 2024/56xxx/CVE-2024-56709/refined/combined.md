=== Content from git.kernel.org_423b678f_20250114_222316.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Begunkov <asml.silence@gmail.com> | 2024-12-19 19:52:58 +0000 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-12-19 13:31:53 -0700 |
| commit | [dbd2ca9367eb19bc5e269b8c58b0b1514ada9156](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156)) | |
| tree | [da5065c249b7ee9f18f4be51edc3b2a6bb399c50](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156) | |
| parent | [c261e4f1dd29fabab54b325bc1da8769a3998be1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c261e4f1dd29fabab54b325bc1da8769a3998be1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156&id2=c261e4f1dd29fabab54b325bc1da8769a3998be1)) | |
| download | [linux-dbd2ca9367eb19bc5e269b8c58b0b1514ada9156.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dbd2ca9367eb19bc5e269b8c58b0b1514ada9156.tar.gz) | |

io\_uring: check if iowq is killed before queuingtask work can be executed after the task has gone through io\_uring
termination, whether it's the final task\_work run or the fallback path.
In this case, task work will find ->io\_wq being already killed and
null'ed, which is a problem if it then tries to forward the request to
io\_queue\_iowq(). Make io\_queue\_iowq() fail requests in this case.
Note that it also checks PF\_KTHREAD, because the user can first close
a DEFER\_TASKRUN ring and shortly after kill the task, in which case
->iowq check would race.
Cc: stable@vger.kernel.org
Fixes: 50c52250e2d74 ("block: implement async io\_uring discard cmd")
Fixes: 773af69121ecc ("io\_uring: always reissue from task\_work context")
Reported-by: Will <willsroot@protonmail.com>
Signed-off-by: Pavel Begunkov <asml.silence@gmail.com>
Link: [https://lore.kernel.org/r/63312b4a2c2bb67ad67b857d17a300e1d3b078e8.1734637909.git.asml.silence@gmail.com](https://lore.kernel.org/r/63312b4a2c2bb67ad67b857d17a300e1d3b078e8.1734637909.git.asml.silence%40gmail.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156)

| -rw-r--r-- | [io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/io\_uring/io\_uring.c b/io\_uring/io\_uring.cindex 432b95ca9c85e4..d3403c8216db82 100644--- a/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=c261e4f1dd29fabab54b325bc1da8769a3998be1)+++ b/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=dbd2ca9367eb19bc5e269b8c58b0b1514ada9156)@@ -514,7 +514,11 @@ static void io\_queue\_iowq(struct io\_kiocb \*req) struct io\_uring\_task \*tctx = req->tctx;  BUG\_ON(!tctx);- BUG\_ON(!tctx->io\_wq);++ if ((current->flags & PF\_KTHREAD) || !tctx->io\_wq) {+ io\_req\_task\_queue\_fail(req, -ECANCELED);+ return;+ }  /\* init ->work of the whole link before punting \*/ io\_prep\_async\_link(req); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:21:53 +0000



=== Content from git.kernel.org_97fd6512_20250114_222312.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Begunkov <asml.silence@gmail.com> | 2024-12-19 19:52:58 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-27 14:02:17 +0100 |
| commit | [4f95a2186b7f2af09331e1e8069bcaf34fe019cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf)) | |
| tree | [ea175475422235195983e17fea5408757d71bc9f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf) | |
| parent | [06eb0894896bb666f34ea07e73ec00bca865c76a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06eb0894896bb666f34ea07e73ec00bca865c76a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf&id2=06eb0894896bb666f34ea07e73ec00bca865c76a)) | |
| download | [linux-4f95a2186b7f2af09331e1e8069bcaf34fe019cf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4f95a2186b7f2af09331e1e8069bcaf34fe019cf.tar.gz) | |

io\_uring: check if iowq is killed before queuingcommit dbd2ca9367eb19bc5e269b8c58b0b1514ada9156 upstream.
task work can be executed after the task has gone through io\_uring
termination, whether it's the final task\_work run or the fallback path.
In this case, task work will find ->io\_wq being already killed and
null'ed, which is a problem if it then tries to forward the request to
io\_queue\_iowq(). Make io\_queue\_iowq() fail requests in this case.
Note that it also checks PF\_KTHREAD, because the user can first close
a DEFER\_TASKRUN ring and shortly after kill the task, in which case
->iowq check would race.
Cc: stable@vger.kernel.org
Fixes: 50c52250e2d74 ("block: implement async io\_uring discard cmd")
Fixes: 773af69121ecc ("io\_uring: always reissue from task\_work context")
Reported-by: Will <willsroot@protonmail.com>
Signed-off-by: Pavel Begunkov <asml.silence@gmail.com>
Link: [https://lore.kernel.org/r/63312b4a2c2bb67ad67b857d17a300e1d3b078e8.1734637909.git.asml.silence@gmail.com](https://lore.kernel.org/r/63312b4a2c2bb67ad67b857d17a300e1d3b078e8.1734637909.git.asml.silence%40gmail.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf)

| -rw-r--r-- | [io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/io\_uring/io\_uring.c b/io\_uring/io\_uring.cindex 3fab8ee5154811..9849da128364af 100644--- a/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=06eb0894896bb666f34ea07e73ec00bca865c76a)+++ b/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=4f95a2186b7f2af09331e1e8069bcaf34fe019cf)@@ -515,7 +515,11 @@ static void io\_queue\_iowq(struct io\_kiocb \*req) struct io\_uring\_task \*tctx = req->task->io\_uring;  BUG\_ON(!tctx);- BUG\_ON(!tctx->io\_wq);++ if ((current->flags & PF\_KTHREAD) || !tctx->io\_wq) {+ io\_req\_task\_queue\_fail(req, -ECANCELED);+ return;+ }  /\* init ->work of the whole link before punting \*/ io\_prep\_async\_link(req); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:21:48 +0000



=== Content from git.kernel.org_d67cd496_20250114_222314.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=534d59ab38010aada88390db65985e65d0de7d9e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=534d59ab38010aada88390db65985e65d0de7d9e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=534d59ab38010aada88390db65985e65d0de7d9e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=534d59ab38010aada88390db65985e65d0de7d9e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Begunkov <asml.silence@gmail.com> | 2024-12-19 19:52:58 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-27 13:53:00 +0100 |
| commit | [534d59ab38010aada88390db65985e65d0de7d9e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=534d59ab38010aada88390db65985e65d0de7d9e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=534d59ab38010aada88390db65985e65d0de7d9e)) | |
| tree | [4f36869c4064b1cb758829af2dcddf2f99cd9dac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=534d59ab38010aada88390db65985e65d0de7d9e) | |
| parent | [c034ce2668ae94f04ff46d29b195409614feaf75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c034ce2668ae94f04ff46d29b195409614feaf75) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=534d59ab38010aada88390db65985e65d0de7d9e&id2=c034ce2668ae94f04ff46d29b195409614feaf75)) | |
| download | [linux-534d59ab38010aada88390db65985e65d0de7d9e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-534d59ab38010aada88390db65985e65d0de7d9e.tar.gz) | |

io\_uring: check if iowq is killed before queuingcommit dbd2ca9367eb19bc5e269b8c58b0b1514ada9156 upstream.
task work can be executed after the task has gone through io\_uring
termination, whether it's the final task\_work run or the fallback path.
In this case, task work will find ->io\_wq being already killed and
null'ed, which is a problem if it then tries to forward the request to
io\_queue\_iowq(). Make io\_queue\_iowq() fail requests in this case.
Note that it also checks PF\_KTHREAD, because the user can first close
a DEFER\_TASKRUN ring and shortly after kill the task, in which case
->iowq check would race.
Cc: stable@vger.kernel.org
Fixes: 50c52250e2d74 ("block: implement async io\_uring discard cmd")
Fixes: 773af69121ecc ("io\_uring: always reissue from task\_work context")
Reported-by: Will <willsroot@protonmail.com>
Signed-off-by: Pavel Begunkov <asml.silence@gmail.com>
Link: [https://lore.kernel.org/r/63312b4a2c2bb67ad67b857d17a300e1d3b078e8.1734637909.git.asml.silence@gmail.com](https://lore.kernel.org/r/63312b4a2c2bb67ad67b857d17a300e1d3b078e8.1734637909.git.asml.silence%40gmail.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=534d59ab38010aada88390db65985e65d0de7d9e)

| -rw-r--r-- | [io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=534d59ab38010aada88390db65985e65d0de7d9e) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/io\_uring/io\_uring.c b/io\_uring/io\_uring.cindex ae7a9545b87734..10070cd867b4ab 100644--- a/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=c034ce2668ae94f04ff46d29b195409614feaf75)+++ b/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=534d59ab38010aada88390db65985e65d0de7d9e)@@ -440,7 +440,11 @@ void io\_queue\_iowq(struct io\_kiocb \*req, bool \*dont\_use) struct io\_uring\_task \*tctx = req->task->io\_uring;  BUG\_ON(!tctx);- BUG\_ON(!tctx->io\_wq);++ if ((current->flags & PF\_KTHREAD) || !tctx->io\_wq) {+ io\_req\_task\_queue\_fail(req, -ECANCELED);+ return;+ }  /\* init ->work of the whole link before punting \*/ io\_prep\_async\_link(req); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:21:50 +0000



=== Content from git.kernel.org_6066a4b4_20250114_222311.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2ca94c8de36091067b9ce7527ae8db3812d38781)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ca94c8de36091067b9ce7527ae8db3812d38781)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ca94c8de36091067b9ce7527ae8db3812d38781)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ca94c8de36091067b9ce7527ae8db3812d38781)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Begunkov <asml.silence@gmail.com> | 2024-12-19 19:52:58 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-27 13:58:55 +0100 |
| commit | [2ca94c8de36091067b9ce7527ae8db3812d38781](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ca94c8de36091067b9ce7527ae8db3812d38781) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2ca94c8de36091067b9ce7527ae8db3812d38781)) | |
| tree | [19eaee25e3a6cf5df7e2149900594ac0eb2aa3f2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ca94c8de36091067b9ce7527ae8db3812d38781) | |
| parent | [a73f0425f44ba087751d8e0fa5738f6cd3adf7b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a73f0425f44ba087751d8e0fa5738f6cd3adf7b9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ca94c8de36091067b9ce7527ae8db3812d38781&id2=a73f0425f44ba087751d8e0fa5738f6cd3adf7b9)) | |
| download | [linux-2ca94c8de36091067b9ce7527ae8db3812d38781.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2ca94c8de36091067b9ce7527ae8db3812d38781.tar.gz) | |

io\_uring: check if iowq is killed before queuingcommit dbd2ca9367eb19bc5e269b8c58b0b1514ada9156 upstream.
task work can be executed after the task has gone through io\_uring
termination, whether it's the final task\_work run or the fallback path.
In this case, task work will find ->io\_wq being already killed and
null'ed, which is a problem if it then tries to forward the request to
io\_queue\_iowq(). Make io\_queue\_iowq() fail requests in this case.
Note that it also checks PF\_KTHREAD, because the user can first close
a DEFER\_TASKRUN ring and shortly after kill the task, in which case
->iowq check would race.
Cc: stable@vger.kernel.org
Fixes: 50c52250e2d74 ("block: implement async io\_uring discard cmd")
Fixes: 773af69121ecc ("io\_uring: always reissue from task\_work context")
Reported-by: Will <willsroot@protonmail.com>
Signed-off-by: Pavel Begunkov <asml.silence@gmail.com>
Link: [https://lore.kernel.org/r/63312b4a2c2bb67ad67b857d17a300e1d3b078e8.1734637909.git.asml.silence@gmail.com](https://lore.kernel.org/r/63312b4a2c2bb67ad67b857d17a300e1d3b078e8.1734637909.git.asml.silence%40gmail.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ca94c8de36091067b9ce7527ae8db3812d38781)

| -rw-r--r-- | [io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=2ca94c8de36091067b9ce7527ae8db3812d38781) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/io\_uring/io\_uring.c b/io\_uring/io\_uring.cindex cc31643b706930..cbf39f32e1ad20 100644--- a/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=a73f0425f44ba087751d8e0fa5738f6cd3adf7b9)+++ b/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=2ca94c8de36091067b9ce7527ae8db3812d38781)@@ -498,7 +498,11 @@ void io\_queue\_iowq(struct io\_kiocb \*req, struct io\_tw\_state \*ts\_dont\_use) struct io\_uring\_task \*tctx = req->task->io\_uring;  BUG\_ON(!tctx);- BUG\_ON(!tctx->io\_wq);++ if ((current->flags & PF\_KTHREAD) || !tctx->io\_wq) {+ io\_req\_task\_queue\_fail(req, -ECANCELED);+ return;+ }  /\* init ->work of the whole link before punting \*/ io\_prep\_async\_link(req); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:21:48 +0000


