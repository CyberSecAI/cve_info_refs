=== Content from git.kernel.org_578582cf_20250114_214008.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b90d061345bb8cd51fece561a800bae1c95448a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b90d061345bb8cd51fece561a800bae1c95448a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b90d061345bb8cd51fece561a800bae1c95448a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90d061345bb8cd51fece561a800bae1c95448a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Wiesner <jwiesner@suse.de> | 2024-11-28 09:59:50 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:19 +0100 |
| commit | [b90d061345bb8cd51fece561a800bae1c95448a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b90d061345bb8cd51fece561a800bae1c95448a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b90d061345bb8cd51fece561a800bae1c95448a6)) | |
| tree | [af40632efaf5ff58f71cf9210083d965b7fefe2e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b90d061345bb8cd51fece561a800bae1c95448a6) | |
| parent | [b3282c2bebeeb82ceec492ee4972f51ee7a4a132](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3282c2bebeeb82ceec492ee4972f51ee7a4a132) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90d061345bb8cd51fece561a800bae1c95448a6&id2=b3282c2bebeeb82ceec492ee4972f51ee7a4a132)) | |
| download | [linux-b90d061345bb8cd51fece561a800bae1c95448a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b90d061345bb8cd51fece561a800bae1c95448a6.tar.gz) | |

net/ipv6: release expired exception dst cached in socket[ Upstream commit 3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045 ]
Dst objects get leaked in ip6\_negative\_advice() when this function is
executed for an expired IPv6 route located in the exception table. There
are several conditions that must be fulfilled for the leak to occur:
\* an ICMPv6 packet indicating a change of the MTU for the path is received,
resulting in an exception dst being created
\* a TCP connection that uses the exception dst for routing packets must
start timing out so that TCP begins retransmissions
\* after the exception dst expires, the FIB6 garbage collector must not run
before TCP executes ip6\_negative\_advice() for the expired exception dst
When TCP executes ip6\_negative\_advice() for an exception dst that has
expired and if no other socket holds a reference to the exception dst, the
refcount of the exception dst is 2, which corresponds to the increment
made by dst\_init() and the increment made by the TCP socket for which the
connection is timing out. The refcount made by the socket is never
released. The refcount of the dst is decremented in sk\_dst\_reset() but
that decrement is counteracted by a dst\_hold() intentionally placed just
before the sk\_dst\_reset() in ip6\_negative\_advice(). After
ip6\_negative\_advice() has finished, there is no other object tied to the
dst. The socket lost its reference stored in sk\_dst\_cache and the dst is
no longer in the exception table. The exception dst becomes a leaked
object.
As a result of this dst leak, an unbalanced refcount is reported for the
loopback device of a net namespace being destroyed under kernels that do
not contain e5f80fcf869a ("ipv6: give an IPv6 dev to blackhole\_netdev"):
unregister\_netdevice: waiting for lo to become free. Usage count = 2
Fix the dst leak by removing the dst\_hold() in ip6\_negative\_advice(). The
patch that introduced the dst\_hold() in ip6\_negative\_advice() was
92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race"). But 92f1655aa2b22
merely refactored the code with regards to the dst refcount so the issue
was present even before 92f1655aa2b22. The bug was introduced in
54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually
expired.") where the expired cached route is deleted and the sk\_dst\_cache
member of the socket is set to NULL by calling dst\_negative\_advice() but
the refcount belonging to the socket is left unbalanced.
The IPv4 version - ipv4\_negative\_advice() - is not affected by this bug.
When the TCP connection times out ipv4\_negative\_advice() merely resets the
sk\_dst\_cache of the socket while decrementing the refcount of the
exception dst.
Fixes: 92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race")
Fixes: 54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually expired.")
Link: [https://lore.kernel.org/netdev/20241113105611.GA6723@incl/T/#u](https://lore.kernel.org/netdev/20241113105611.GA6723%40incl/T/#u)
Signed-off-by: Jiri Wiesner <jwiesner@suse.de>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241128085950.GA4505@incl](https://patch.msgid.link/20241128085950.GA4505%40incl)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b90d061345bb8cd51fece561a800bae1c95448a6)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=b90d061345bb8cd51fece561a800bae1c95448a6) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 37e05a77fe49eb..5dbf60dd4aa2cd 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=b3282c2bebeeb82ceec492ee4972f51ee7a4a132)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=b90d061345bb8cd51fece561a800bae1c95448a6)@@ -2641,10 +2641,10 @@ static void ip6\_negative\_advice(struct sock \*sk, if (rt->rt6i\_flags & RTF\_CACHE) { rcu\_read\_lock(); if (rt6\_check\_expired(rt)) {- /\* counteract the dst\_release() in sk\_dst\_reset() \*/- dst\_hold(dst);+ /\* rt/dst can not be destroyed yet,+ \* because of rcu\_read\_lock()+ \*/ sk\_dst\_reset(sk);- rt6\_remove\_exception\_rt(rt); } rcu\_read\_unlock(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:46 +0000



=== Content from git.kernel.org_1cb4fea5_20250114_214004.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0b8903e6c881f72c6849d4952de742c656eb5ab9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b8903e6c881f72c6849d4952de742c656eb5ab9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b8903e6c881f72c6849d4952de742c656eb5ab9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b8903e6c881f72c6849d4952de742c656eb5ab9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Wiesner <jwiesner@suse.de> | 2024-11-28 09:59:50 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:27 +0100 |
| commit | [0b8903e6c881f72c6849d4952de742c656eb5ab9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b8903e6c881f72c6849d4952de742c656eb5ab9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0b8903e6c881f72c6849d4952de742c656eb5ab9)) | |
| tree | [949760a39ec5df2e639a243a98403fedcb4fe70f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b8903e6c881f72c6849d4952de742c656eb5ab9) | |
| parent | [4199dd78a59896e091d3a7a05a77451aa7fd724d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4199dd78a59896e091d3a7a05a77451aa7fd724d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b8903e6c881f72c6849d4952de742c656eb5ab9&id2=4199dd78a59896e091d3a7a05a77451aa7fd724d)) | |
| download | [linux-0b8903e6c881f72c6849d4952de742c656eb5ab9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0b8903e6c881f72c6849d4952de742c656eb5ab9.tar.gz) | |

net/ipv6: release expired exception dst cached in socket[ Upstream commit 3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045 ]
Dst objects get leaked in ip6\_negative\_advice() when this function is
executed for an expired IPv6 route located in the exception table. There
are several conditions that must be fulfilled for the leak to occur:
\* an ICMPv6 packet indicating a change of the MTU for the path is received,
resulting in an exception dst being created
\* a TCP connection that uses the exception dst for routing packets must
start timing out so that TCP begins retransmissions
\* after the exception dst expires, the FIB6 garbage collector must not run
before TCP executes ip6\_negative\_advice() for the expired exception dst
When TCP executes ip6\_negative\_advice() for an exception dst that has
expired and if no other socket holds a reference to the exception dst, the
refcount of the exception dst is 2, which corresponds to the increment
made by dst\_init() and the increment made by the TCP socket for which the
connection is timing out. The refcount made by the socket is never
released. The refcount of the dst is decremented in sk\_dst\_reset() but
that decrement is counteracted by a dst\_hold() intentionally placed just
before the sk\_dst\_reset() in ip6\_negative\_advice(). After
ip6\_negative\_advice() has finished, there is no other object tied to the
dst. The socket lost its reference stored in sk\_dst\_cache and the dst is
no longer in the exception table. The exception dst becomes a leaked
object.
As a result of this dst leak, an unbalanced refcount is reported for the
loopback device of a net namespace being destroyed under kernels that do
not contain e5f80fcf869a ("ipv6: give an IPv6 dev to blackhole\_netdev"):
unregister\_netdevice: waiting for lo to become free. Usage count = 2
Fix the dst leak by removing the dst\_hold() in ip6\_negative\_advice(). The
patch that introduced the dst\_hold() in ip6\_negative\_advice() was
92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race"). But 92f1655aa2b22
merely refactored the code with regards to the dst refcount so the issue
was present even before 92f1655aa2b22. The bug was introduced in
54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually
expired.") where the expired cached route is deleted and the sk\_dst\_cache
member of the socket is set to NULL by calling dst\_negative\_advice() but
the refcount belonging to the socket is left unbalanced.
The IPv4 version - ipv4\_negative\_advice() - is not affected by this bug.
When the TCP connection times out ipv4\_negative\_advice() merely resets the
sk\_dst\_cache of the socket while decrementing the refcount of the
exception dst.
Fixes: 92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race")
Fixes: 54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually expired.")
Link: [https://lore.kernel.org/netdev/20241113105611.GA6723@incl/T/#u](https://lore.kernel.org/netdev/20241113105611.GA6723%40incl/T/#u)
Signed-off-by: Jiri Wiesner <jwiesner@suse.de>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241128085950.GA4505@incl](https://patch.msgid.link/20241128085950.GA4505%40incl)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b8903e6c881f72c6849d4952de742c656eb5ab9)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=0b8903e6c881f72c6849d4952de742c656eb5ab9) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 35d3f02ddf163c..407dba4327f534 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=4199dd78a59896e091d3a7a05a77451aa7fd724d)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=0b8903e6c881f72c6849d4952de742c656eb5ab9)@@ -2769,10 +2769,10 @@ static void ip6\_negative\_advice(struct sock \*sk, if (rt->rt6i\_flags & RTF\_CACHE) { rcu\_read\_lock(); if (rt6\_check\_expired(rt)) {- /\* counteract the dst\_release() in sk\_dst\_reset() \*/- dst\_hold(dst);+ /\* rt/dst can not be destroyed yet,+ \* because of rcu\_read\_lock()+ \*/ sk\_dst\_reset(sk);- rt6\_remove\_exception\_rt(rt); } rcu\_read\_unlock(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:41 +0000



=== Content from git.kernel.org_e3c66cfb_20250114_214006.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=535add1e9f274502209cb997801208bbe1ae6c6f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=535add1e9f274502209cb997801208bbe1ae6c6f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=535add1e9f274502209cb997801208bbe1ae6c6f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=535add1e9f274502209cb997801208bbe1ae6c6f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Wiesner <jwiesner@suse.de> | 2024-11-28 09:59:50 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:21 +0100 |
| commit | [535add1e9f274502209cb997801208bbe1ae6c6f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=535add1e9f274502209cb997801208bbe1ae6c6f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=535add1e9f274502209cb997801208bbe1ae6c6f)) | |
| tree | [2860b5f3a917a8270e69db518cf952fc9e975f02](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=535add1e9f274502209cb997801208bbe1ae6c6f) | |
| parent | [c3c87e14326ce5963ba4269b6b3e1b5bf8ebb223](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3c87e14326ce5963ba4269b6b3e1b5bf8ebb223) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=535add1e9f274502209cb997801208bbe1ae6c6f&id2=c3c87e14326ce5963ba4269b6b3e1b5bf8ebb223)) | |
| download | [linux-535add1e9f274502209cb997801208bbe1ae6c6f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-535add1e9f274502209cb997801208bbe1ae6c6f.tar.gz) | |

net/ipv6: release expired exception dst cached in socket[ Upstream commit 3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045 ]
Dst objects get leaked in ip6\_negative\_advice() when this function is
executed for an expired IPv6 route located in the exception table. There
are several conditions that must be fulfilled for the leak to occur:
\* an ICMPv6 packet indicating a change of the MTU for the path is received,
resulting in an exception dst being created
\* a TCP connection that uses the exception dst for routing packets must
start timing out so that TCP begins retransmissions
\* after the exception dst expires, the FIB6 garbage collector must not run
before TCP executes ip6\_negative\_advice() for the expired exception dst
When TCP executes ip6\_negative\_advice() for an exception dst that has
expired and if no other socket holds a reference to the exception dst, the
refcount of the exception dst is 2, which corresponds to the increment
made by dst\_init() and the increment made by the TCP socket for which the
connection is timing out. The refcount made by the socket is never
released. The refcount of the dst is decremented in sk\_dst\_reset() but
that decrement is counteracted by a dst\_hold() intentionally placed just
before the sk\_dst\_reset() in ip6\_negative\_advice(). After
ip6\_negative\_advice() has finished, there is no other object tied to the
dst. The socket lost its reference stored in sk\_dst\_cache and the dst is
no longer in the exception table. The exception dst becomes a leaked
object.
As a result of this dst leak, an unbalanced refcount is reported for the
loopback device of a net namespace being destroyed under kernels that do
not contain e5f80fcf869a ("ipv6: give an IPv6 dev to blackhole\_netdev"):
unregister\_netdevice: waiting for lo to become free. Usage count = 2
Fix the dst leak by removing the dst\_hold() in ip6\_negative\_advice(). The
patch that introduced the dst\_hold() in ip6\_negative\_advice() was
92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race"). But 92f1655aa2b22
merely refactored the code with regards to the dst refcount so the issue
was present even before 92f1655aa2b22. The bug was introduced in
54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually
expired.") where the expired cached route is deleted and the sk\_dst\_cache
member of the socket is set to NULL by calling dst\_negative\_advice() but
the refcount belonging to the socket is left unbalanced.
The IPv4 version - ipv4\_negative\_advice() - is not affected by this bug.
When the TCP connection times out ipv4\_negative\_advice() merely resets the
sk\_dst\_cache of the socket while decrementing the refcount of the
exception dst.
Fixes: 92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race")
Fixes: 54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually expired.")
Link: [https://lore.kernel.org/netdev/20241113105611.GA6723@incl/T/#u](https://lore.kernel.org/netdev/20241113105611.GA6723%40incl/T/#u)
Signed-off-by: Jiri Wiesner <jwiesner@suse.de>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241128085950.GA4505@incl](https://patch.msgid.link/20241128085950.GA4505%40incl)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=535add1e9f274502209cb997801208bbe1ae6c6f)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=535add1e9f274502209cb997801208bbe1ae6c6f) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 5da0c83a3ee8f5..5ae3ff6ffb7e92 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=c3c87e14326ce5963ba4269b6b3e1b5bf8ebb223)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=535add1e9f274502209cb997801208bbe1ae6c6f)@@ -2774,10 +2774,10 @@ static void ip6\_negative\_advice(struct sock \*sk, if (rt->rt6i\_flags & RTF\_CACHE) { rcu\_read\_lock(); if (rt6\_check\_expired(rt)) {- /\* counteract the dst\_release() in sk\_dst\_reset() \*/- dst\_hold(dst);+ /\* rt/dst can not be destroyed yet,+ \* because of rcu\_read\_lock()+ \*/ sk\_dst\_reset(sk);- rt6\_remove\_exception\_rt(rt); } rcu\_read\_unlock(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:43 +0000



=== Content from git.kernel.org_cdcdcdbd_20250114_214008.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a95808252e8acc0123bacd2dff8b9af10bc145b7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a95808252e8acc0123bacd2dff8b9af10bc145b7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a95808252e8acc0123bacd2dff8b9af10bc145b7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a95808252e8acc0123bacd2dff8b9af10bc145b7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Wiesner <jwiesner@suse.de> | 2024-11-28 09:59:50 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:45 +0100 |
| commit | [a95808252e8acc0123bacd2dff8b9af10bc145b7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a95808252e8acc0123bacd2dff8b9af10bc145b7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a95808252e8acc0123bacd2dff8b9af10bc145b7)) | |
| tree | [6b46253f321036446e4580f27c3b4e7f55be9f88](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a95808252e8acc0123bacd2dff8b9af10bc145b7) | |
| parent | [224e606a8d8e8c7db94036272c47a37455667313](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=224e606a8d8e8c7db94036272c47a37455667313) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a95808252e8acc0123bacd2dff8b9af10bc145b7&id2=224e606a8d8e8c7db94036272c47a37455667313)) | |
| download | [linux-a95808252e8acc0123bacd2dff8b9af10bc145b7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a95808252e8acc0123bacd2dff8b9af10bc145b7.tar.gz) | |

net/ipv6: release expired exception dst cached in socket[ Upstream commit 3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045 ]
Dst objects get leaked in ip6\_negative\_advice() when this function is
executed for an expired IPv6 route located in the exception table. There
are several conditions that must be fulfilled for the leak to occur:
\* an ICMPv6 packet indicating a change of the MTU for the path is received,
resulting in an exception dst being created
\* a TCP connection that uses the exception dst for routing packets must
start timing out so that TCP begins retransmissions
\* after the exception dst expires, the FIB6 garbage collector must not run
before TCP executes ip6\_negative\_advice() for the expired exception dst
When TCP executes ip6\_negative\_advice() for an exception dst that has
expired and if no other socket holds a reference to the exception dst, the
refcount of the exception dst is 2, which corresponds to the increment
made by dst\_init() and the increment made by the TCP socket for which the
connection is timing out. The refcount made by the socket is never
released. The refcount of the dst is decremented in sk\_dst\_reset() but
that decrement is counteracted by a dst\_hold() intentionally placed just
before the sk\_dst\_reset() in ip6\_negative\_advice(). After
ip6\_negative\_advice() has finished, there is no other object tied to the
dst. The socket lost its reference stored in sk\_dst\_cache and the dst is
no longer in the exception table. The exception dst becomes a leaked
object.
As a result of this dst leak, an unbalanced refcount is reported for the
loopback device of a net namespace being destroyed under kernels that do
not contain e5f80fcf869a ("ipv6: give an IPv6 dev to blackhole\_netdev"):
unregister\_netdevice: waiting for lo to become free. Usage count = 2
Fix the dst leak by removing the dst\_hold() in ip6\_negative\_advice(). The
patch that introduced the dst\_hold() in ip6\_negative\_advice() was
92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race"). But 92f1655aa2b22
merely refactored the code with regards to the dst refcount so the issue
was present even before 92f1655aa2b22. The bug was introduced in
54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually
expired.") where the expired cached route is deleted and the sk\_dst\_cache
member of the socket is set to NULL by calling dst\_negative\_advice() but
the refcount belonging to the socket is left unbalanced.
The IPv4 version - ipv4\_negative\_advice() - is not affected by this bug.
When the TCP connection times out ipv4\_negative\_advice() merely resets the
sk\_dst\_cache of the socket while decrementing the refcount of the
exception dst.
Fixes: 92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race")
Fixes: 54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually expired.")
Link: [https://lore.kernel.org/netdev/20241113105611.GA6723@incl/T/#u](https://lore.kernel.org/netdev/20241113105611.GA6723%40incl/T/#u)
Signed-off-by: Jiri Wiesner <jwiesner@suse.de>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241128085950.GA4505@incl](https://patch.msgid.link/20241128085950.GA4505%40incl)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a95808252e8acc0123bacd2dff8b9af10bc145b7)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=a95808252e8acc0123bacd2dff8b9af10bc145b7) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 2e91a563139a86..f1c2ac967e36c3 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=224e606a8d8e8c7db94036272c47a37455667313)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=a95808252e8acc0123bacd2dff8b9af10bc145b7)@@ -2670,10 +2670,10 @@ static void ip6\_negative\_advice(struct sock \*sk, if (rt->rt6i\_flags & RTF\_CACHE) { rcu\_read\_lock(); if (rt6\_check\_expired(rt)) {- /\* counteract the dst\_release() in sk\_dst\_reset() \*/- dst\_hold(dst);+ /\* rt/dst can not be destroyed yet,+ \* because of rcu\_read\_lock()+ \*/ sk\_dst\_reset(sk);- rt6\_remove\_exception\_rt(rt); } rcu\_read\_unlock(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:45 +0000



=== Content from git.kernel.org_6b43310e_20250114_214007.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8b591bd522b71c42a82898290e35d32b482047e4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8b591bd522b71c42a82898290e35d32b482047e4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b591bd522b71c42a82898290e35d32b482047e4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b591bd522b71c42a82898290e35d32b482047e4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Wiesner <jwiesner@suse.de> | 2024-11-28 09:59:50 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:05 +0100 |
| commit | [8b591bd522b71c42a82898290e35d32b482047e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b591bd522b71c42a82898290e35d32b482047e4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8b591bd522b71c42a82898290e35d32b482047e4)) | |
| tree | [cd72c913931be015b98354d8197010e920d9a932](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8b591bd522b71c42a82898290e35d32b482047e4) | |
| parent | [3027a9fe02eda2e7c08f46100456d10deb5940c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3027a9fe02eda2e7c08f46100456d10deb5940c0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b591bd522b71c42a82898290e35d32b482047e4&id2=3027a9fe02eda2e7c08f46100456d10deb5940c0)) | |
| download | [linux-8b591bd522b71c42a82898290e35d32b482047e4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8b591bd522b71c42a82898290e35d32b482047e4.tar.gz) | |

net/ipv6: release expired exception dst cached in socket[ Upstream commit 3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045 ]
Dst objects get leaked in ip6\_negative\_advice() when this function is
executed for an expired IPv6 route located in the exception table. There
are several conditions that must be fulfilled for the leak to occur:
\* an ICMPv6 packet indicating a change of the MTU for the path is received,
resulting in an exception dst being created
\* a TCP connection that uses the exception dst for routing packets must
start timing out so that TCP begins retransmissions
\* after the exception dst expires, the FIB6 garbage collector must not run
before TCP executes ip6\_negative\_advice() for the expired exception dst
When TCP executes ip6\_negative\_advice() for an exception dst that has
expired and if no other socket holds a reference to the exception dst, the
refcount of the exception dst is 2, which corresponds to the increment
made by dst\_init() and the increment made by the TCP socket for which the
connection is timing out. The refcount made by the socket is never
released. The refcount of the dst is decremented in sk\_dst\_reset() but
that decrement is counteracted by a dst\_hold() intentionally placed just
before the sk\_dst\_reset() in ip6\_negative\_advice(). After
ip6\_negative\_advice() has finished, there is no other object tied to the
dst. The socket lost its reference stored in sk\_dst\_cache and the dst is
no longer in the exception table. The exception dst becomes a leaked
object.
As a result of this dst leak, an unbalanced refcount is reported for the
loopback device of a net namespace being destroyed under kernels that do
not contain e5f80fcf869a ("ipv6: give an IPv6 dev to blackhole\_netdev"):
unregister\_netdevice: waiting for lo to become free. Usage count = 2
Fix the dst leak by removing the dst\_hold() in ip6\_negative\_advice(). The
patch that introduced the dst\_hold() in ip6\_negative\_advice() was
92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race"). But 92f1655aa2b22
merely refactored the code with regards to the dst refcount so the issue
was present even before 92f1655aa2b22. The bug was introduced in
54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually
expired.") where the expired cached route is deleted and the sk\_dst\_cache
member of the socket is set to NULL by calling dst\_negative\_advice() but
the refcount belonging to the socket is left unbalanced.
The IPv4 version - ipv4\_negative\_advice() - is not affected by this bug.
When the TCP connection times out ipv4\_negative\_advice() merely resets the
sk\_dst\_cache of the socket while decrementing the refcount of the
exception dst.
Fixes: 92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race")
Fixes: 54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually expired.")
Link: [https://lore.kernel.org/netdev/20241113105611.GA6723@incl/T/#u](https://lore.kernel.org/netdev/20241113105611.GA6723%40incl/T/#u)
Signed-off-by: Jiri Wiesner <jwiesner@suse.de>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241128085950.GA4505@incl](https://patch.msgid.link/20241128085950.GA4505%40incl)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b591bd522b71c42a82898290e35d32b482047e4)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=8b591bd522b71c42a82898290e35d32b482047e4) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex cff4fbbc66efb2..8ebfed5d63232e 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=3027a9fe02eda2e7c08f46100456d10deb5940c0)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=8b591bd522b71c42a82898290e35d32b482047e4)@@ -2780,10 +2780,10 @@ static void ip6\_negative\_advice(struct sock \*sk, if (rt->rt6i\_flags & RTF\_CACHE) { rcu\_read\_lock(); if (rt6\_check\_expired(rt)) {- /\* counteract the dst\_release() in sk\_dst\_reset() \*/- dst\_hold(dst);+ /\* rt/dst can not be destroyed yet,+ \* because of rcu\_read\_lock()+ \*/ sk\_dst\_reset(sk);- rt6\_remove\_exception\_rt(rt); } rcu\_read\_unlock(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:44 +0000



=== Content from git.kernel.org_c23ba455_20250114_214005.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Wiesner <jwiesner@suse.de> | 2024-11-28 09:59:50 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-12-02 19:24:54 -0800 |
| commit | [3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045)) | |
| tree | [50695b6bba5b45ac6aa580eb6988761234bb8d3b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045) | |
| parent | [ccb989e4d1efe0dd81b28c437443532d80d9ecee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ccb989e4d1efe0dd81b28c437443532d80d9ecee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045&id2=ccb989e4d1efe0dd81b28c437443532d80d9ecee)) | |
| download | [linux-3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045.tar.gz) | |

net/ipv6: release expired exception dst cached in socketDst objects get leaked in ip6\_negative\_advice() when this function is
executed for an expired IPv6 route located in the exception table. There
are several conditions that must be fulfilled for the leak to occur:
\* an ICMPv6 packet indicating a change of the MTU for the path is received,
resulting in an exception dst being created
\* a TCP connection that uses the exception dst for routing packets must
start timing out so that TCP begins retransmissions
\* after the exception dst expires, the FIB6 garbage collector must not run
before TCP executes ip6\_negative\_advice() for the expired exception dst
When TCP executes ip6\_negative\_advice() for an exception dst that has
expired and if no other socket holds a reference to the exception dst, the
refcount of the exception dst is 2, which corresponds to the increment
made by dst\_init() and the increment made by the TCP socket for which the
connection is timing out. The refcount made by the socket is never
released. The refcount of the dst is decremented in sk\_dst\_reset() but
that decrement is counteracted by a dst\_hold() intentionally placed just
before the sk\_dst\_reset() in ip6\_negative\_advice(). After
ip6\_negative\_advice() has finished, there is no other object tied to the
dst. The socket lost its reference stored in sk\_dst\_cache and the dst is
no longer in the exception table. The exception dst becomes a leaked
object.
As a result of this dst leak, an unbalanced refcount is reported for the
loopback device of a net namespace being destroyed under kernels that do
not contain e5f80fcf869a ("ipv6: give an IPv6 dev to blackhole\_netdev"):
unregister\_netdevice: waiting for lo to become free. Usage count = 2
Fix the dst leak by removing the dst\_hold() in ip6\_negative\_advice(). The
patch that introduced the dst\_hold() in ip6\_negative\_advice() was
92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race"). But 92f1655aa2b22
merely refactored the code with regards to the dst refcount so the issue
was present even before 92f1655aa2b22. The bug was introduced in
54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually
expired.") where the expired cached route is deleted and the sk\_dst\_cache
member of the socket is set to NULL by calling dst\_negative\_advice() but
the refcount belonging to the socket is left unbalanced.
The IPv4 version - ipv4\_negative\_advice() - is not affected by this bug.
When the TCP connection times out ipv4\_negative\_advice() merely resets the
sk\_dst\_cache of the socket while decrementing the refcount of the
exception dst.
Fixes: 92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race")
Fixes: 54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually expired.")
Link: [https://lore.kernel.org/netdev/20241113105611.GA6723@incl/T/#u](https://lore.kernel.org/netdev/20241113105611.GA6723%40incl/T/#u)
Signed-off-by: Jiri Wiesner <jwiesner@suse.de>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241128085950.GA4505@incl](https://patch.msgid.link/20241128085950.GA4505%40incl)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 63d7681c929fca..67ff16c047180b 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=ccb989e4d1efe0dd81b28c437443532d80d9ecee)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045)@@ -2780,10 +2780,10 @@ static void ip6\_negative\_advice(struct sock \*sk, if (rt->rt6i\_flags & RTF\_CACHE) { rcu\_read\_lock(); if (rt6\_check\_expired(rt)) {- /\* counteract the dst\_release() in sk\_dst\_reset() \*/- dst\_hold(dst);+ /\* rt/dst can not be destroyed yet,+ \* because of rcu\_read\_lock()+ \*/ sk\_dst\_reset(sk);- rt6\_remove\_exception\_rt(rt); } rcu\_read\_unlock(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:42 +0000



=== Content from git.kernel.org_28e37e49_20250114_214009.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Wiesner <jwiesner@suse.de> | 2024-11-28 09:59:50 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:35 +0100 |
| commit | [f43d12fd0fa8ee5b9caf8a3927e10d06431764d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2)) | |
| tree | [ec2fa15fd52a8742bc8bae318243d582f8b4427e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2) | |
| parent | [797a4c1f5b63602b963e066bfc425ce174087d0a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=797a4c1f5b63602b963e066bfc425ce174087d0a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2&id2=797a4c1f5b63602b963e066bfc425ce174087d0a)) | |
| download | [linux-f43d12fd0fa8ee5b9caf8a3927e10d06431764d2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f43d12fd0fa8ee5b9caf8a3927e10d06431764d2.tar.gz) | |

net/ipv6: release expired exception dst cached in socket[ Upstream commit 3301ab7d5aeb0fe270f73a3d4810c9d1b6a9f045 ]
Dst objects get leaked in ip6\_negative\_advice() when this function is
executed for an expired IPv6 route located in the exception table. There
are several conditions that must be fulfilled for the leak to occur:
\* an ICMPv6 packet indicating a change of the MTU for the path is received,
resulting in an exception dst being created
\* a TCP connection that uses the exception dst for routing packets must
start timing out so that TCP begins retransmissions
\* after the exception dst expires, the FIB6 garbage collector must not run
before TCP executes ip6\_negative\_advice() for the expired exception dst
When TCP executes ip6\_negative\_advice() for an exception dst that has
expired and if no other socket holds a reference to the exception dst, the
refcount of the exception dst is 2, which corresponds to the increment
made by dst\_init() and the increment made by the TCP socket for which the
connection is timing out. The refcount made by the socket is never
released. The refcount of the dst is decremented in sk\_dst\_reset() but
that decrement is counteracted by a dst\_hold() intentionally placed just
before the sk\_dst\_reset() in ip6\_negative\_advice(). After
ip6\_negative\_advice() has finished, there is no other object tied to the
dst. The socket lost its reference stored in sk\_dst\_cache and the dst is
no longer in the exception table. The exception dst becomes a leaked
object.
As a result of this dst leak, an unbalanced refcount is reported for the
loopback device of a net namespace being destroyed under kernels that do
not contain e5f80fcf869a ("ipv6: give an IPv6 dev to blackhole\_netdev"):
unregister\_netdevice: waiting for lo to become free. Usage count = 2
Fix the dst leak by removing the dst\_hold() in ip6\_negative\_advice(). The
patch that introduced the dst\_hold() in ip6\_negative\_advice() was
92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race"). But 92f1655aa2b22
merely refactored the code with regards to the dst refcount so the issue
was present even before 92f1655aa2b22. The bug was introduced in
54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually
expired.") where the expired cached route is deleted and the sk\_dst\_cache
member of the socket is set to NULL by calling dst\_negative\_advice() but
the refcount belonging to the socket is left unbalanced.
The IPv4 version - ipv4\_negative\_advice() - is not affected by this bug.
When the TCP connection times out ipv4\_negative\_advice() merely resets the
sk\_dst\_cache of the socket while decrementing the refcount of the
exception dst.
Fixes: 92f1655aa2b22 ("net: fix \_\_dst\_negative\_advice() race")
Fixes: 54c1a859efd9f ("ipv6: Don't drop cache route entry unless timer actually expired.")
Link: [https://lore.kernel.org/netdev/20241113105611.GA6723@incl/T/#u](https://lore.kernel.org/netdev/20241113105611.GA6723%40incl/T/#u)
Signed-off-by: Jiri Wiesner <jwiesner@suse.de>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241128085950.GA4505@incl](https://patch.msgid.link/20241128085950.GA4505%40incl)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 0fdd062d4b05b0..fc5c5346202530 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=797a4c1f5b63602b963e066bfc425ce174087d0a)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=f43d12fd0fa8ee5b9caf8a3927e10d06431764d2)@@ -2772,10 +2772,10 @@ static void ip6\_negative\_advice(struct sock \*sk, if (rt->rt6i\_flags & RTF\_CACHE) { rcu\_read\_lock(); if (rt6\_check\_expired(rt)) {- /\* counteract the dst\_release() in sk\_dst\_reset() \*/- dst\_hold(dst);+ /\* rt/dst can not be destroyed yet,+ \* because of rcu\_read\_lock()+ \*/ sk\_dst\_reset(sk);- rt6\_remove\_exception\_rt(rt); } rcu\_read\_unlock(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:46 +0000


