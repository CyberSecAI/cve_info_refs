=== Content from git.kernel.org_7d466412_20250114_184001.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2acc6192aa8570661ed37868c02c03002b1dc290)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2acc6192aa8570661ed37868c02c03002b1dc290)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2acc6192aa8570661ed37868c02c03002b1dc290)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2acc6192aa8570661ed37868c02c03002b1dc290)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Huan Yang <link@vivo.com> | 2024-09-18 10:52:25 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:08 +0100 |
| commit | [2acc6192aa8570661ed37868c02c03002b1dc290](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2acc6192aa8570661ed37868c02c03002b1dc290) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2acc6192aa8570661ed37868c02c03002b1dc290)) | |
| tree | [24e9b4d38b9ff384b1d26cb08313755a00fe743a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2acc6192aa8570661ed37868c02c03002b1dc290) | |
| parent | [7f9594610b7b005f6f1a4fc5bb29cd10e79d1545](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f9594610b7b005f6f1a4fc5bb29cd10e79d1545) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2acc6192aa8570661ed37868c02c03002b1dc290&id2=7f9594610b7b005f6f1a4fc5bb29cd10e79d1545)) | |
| download | [linux-2acc6192aa8570661ed37868c02c03002b1dc290.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2acc6192aa8570661ed37868c02c03002b1dc290.tar.gz) | |

udmabuf: change folios array from kmalloc to kvmalloc[ Upstream commit 1c0844c6184e658064e14c4335885785ad3bf84b ]
When PAGE\_SIZE 4096, MAX\_PAGE\_ORDER 10, 64bit machine,
page\_alloc only support 4MB.
If above this, trigger this warn and return NULL.
udmabuf can change size limit, if change it to 3072(3GB), and then alloc
3GB udmabuf, will fail create.
[ 4080.876581] ------------[ cut here ]------------
[ 4080.876843] WARNING: CPU: 3 PID: 2015 at mm/page\_alloc.c:4556 \_\_alloc\_pages+0x2c8/0x350
[ 4080.878839] RIP: 0010:\_\_alloc\_pages+0x2c8/0x350
[ 4080.879470] Call Trace:
[ 4080.879473] <TASK>
[ 4080.879473] ? \_\_alloc\_pages+0x2c8/0x350
[ 4080.879475] ? \_\_warn.cold+0x8e/0xe8
[ 4080.880647] ? \_\_alloc\_pages+0x2c8/0x350
[ 4080.880909] ? report\_bug+0xff/0x140
[ 4080.881175] ? handle\_bug+0x3c/0x80
[ 4080.881556] ? exc\_invalid\_op+0x17/0x70
[ 4080.881559] ? asm\_exc\_invalid\_op+0x1a/0x20
[ 4080.882077] ? udmabuf\_create+0x131/0x400
Because MAX\_PAGE\_ORDER, kmalloc can max alloc 4096 \* (1 << 10), 4MB
memory, each array entry is pointer(8byte), so can save 524288 pages(2GB).
Further more, costly order(order 3) may not be guaranteed that it can be
applied for, due to fragmentation.
This patch change udmabuf array use kvmalloc\_array, this can fallback
alloc into vmalloc, which can guarantee allocation for any size and does
not affect the performance of kmalloc allocations.
Signed-off-by: Huan Yang <link@vivo.com>
Acked-by: Christian König <christian.koenig@amd.com>
Acked-by: Vivek Kasireddy <vivek.kasireddy@intel.com>
Signed-off-by: Vivek Kasireddy <vivek.kasireddy@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240918025238.2957823-3-link@vivo.com](https://patchwork.freedesktop.org/patch/msgid/20240918025238.2957823-3-link%40vivo.com)
Stable-dep-of: 18d7de823b71 ("udmabuf: fix vmap\_udmabuf error page set")
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2acc6192aa8570661ed37868c02c03002b1dc290)

| -rw-r--r-- | [drivers/dma-buf/udmabuf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma-buf/udmabuf.c?id=2acc6192aa8570661ed37868c02c03002b1dc290) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 13 deletions

| diff --git a/drivers/dma-buf/udmabuf.c b/drivers/dma-buf/udmabuf.cindex 047c3cd2cefff6..bc94c194e172dc 100644--- a/[drivers/dma-buf/udmabuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma-buf/udmabuf.c?id=7f9594610b7b005f6f1a4fc5bb29cd10e79d1545)+++ b/[drivers/dma-buf/udmabuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma-buf/udmabuf.c?id=2acc6192aa8570661ed37868c02c03002b1dc290)@@ -80,7 +80,7 @@ static int vmap\_udmabuf(struct dma\_buf \*buf, struct iosys\_map \*map)  dma\_resv\_assert\_held(buf->resv); - pages = kmalloc\_array(ubuf->pagecount, sizeof(\*pages), GFP\_KERNEL);+ pages = kvmalloc\_array(ubuf->pagecount, sizeof(\*pages), GFP\_KERNEL); if (!pages) return -ENOMEM; @@ -88,7 +88,7 @@ static int vmap\_udmabuf(struct dma\_buf \*buf, struct iosys\_map \*map) pages[pg] = &ubuf->folios[pg]->page;  vaddr = vm\_map\_ram(pages, ubuf->pagecount, -1);- kfree(pages);+ kvfree(pages); if (!vaddr) return -EINVAL; @@ -196,8 +196,8 @@ static void release\_udmabuf(struct dma\_buf \*buf) put\_sg\_table(dev, ubuf->sg, DMA\_BIDIRECTIONAL);  unpin\_all\_folios(&ubuf->unpin\_list);- kfree(ubuf->offsets);- kfree(ubuf->folios);+ kvfree(ubuf->offsets);+ kvfree(ubuf->folios); kfree(ubuf); } @@ -322,14 +322,14 @@ static long udmabuf\_create(struct miscdevice \*device, if (!ubuf->pagecount) goto err; - ubuf->folios = kmalloc\_array(ubuf->pagecount, sizeof(\*ubuf->folios),- GFP\_KERNEL);+ ubuf->folios = kvmalloc\_array(ubuf->pagecount, sizeof(\*ubuf->folios),+ GFP\_KERNEL); if (!ubuf->folios) { ret = -ENOMEM; goto err; }- ubuf->offsets = kcalloc(ubuf->pagecount, sizeof(\*ubuf->offsets),- GFP\_KERNEL);+ ubuf->offsets = kvcalloc(ubuf->pagecount, sizeof(\*ubuf->offsets),+ GFP\_KERNEL); if (!ubuf->offsets) { ret = -ENOMEM; goto err;@@ -343,7 +343,7 @@ static long udmabuf\_create(struct miscdevice \*device, goto err;  pgcnt = list[i].size >> PAGE\_SHIFT;- folios = kmalloc\_array(pgcnt, sizeof(\*folios), GFP\_KERNEL);+ folios = kvmalloc\_array(pgcnt, sizeof(\*folios), GFP\_KERNEL); if (!folios) { ret = -ENOMEM; goto err;@@ -353,7 +353,7 @@ static long udmabuf\_create(struct miscdevice \*device, ret = memfd\_pin\_folios(memfd, list[i].offset, end, folios, pgcnt, &pgoff); if (ret <= 0) {- kfree(folios);+ kvfree(folios); if (!ret) ret = -EINVAL; goto err;@@ -382,7 +382,7 @@ static long udmabuf\_create(struct miscdevice \*device, } } - kfree(folios);+ kvfree(folios); fput(memfd); memfd = NULL; }@@ -398,8 +398,8 @@ err: if (memfd) fput(memfd); unpin\_all\_folios(&ubuf->unpin\_list);- kfree(ubuf->offsets);- kfree(ubuf->folios);+ kvfree(ubuf->offsets);+ kvfree(ubuf->folios); kfree(ubuf); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:38:38 +0000



=== Content from git.kernel.org_09335df1_20250114_184001.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c0844c6184e658064e14c4335885785ad3bf84b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c0844c6184e658064e14c4335885785ad3bf84b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c0844c6184e658064e14c4335885785ad3bf84b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c0844c6184e658064e14c4335885785ad3bf84b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Huan Yang <link@vivo.com> | 2024-09-18 10:52:25 +0800 |
| --- | --- | --- |
| committer | Vivek Kasireddy <vivek.kasireddy@intel.com> | 2024-09-20 14:07:31 -0700 |
| commit | [1c0844c6184e658064e14c4335885785ad3bf84b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c0844c6184e658064e14c4335885785ad3bf84b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c0844c6184e658064e14c4335885785ad3bf84b)) | |
| tree | [1929df2189ce857afc4d25ce33b64b8347cff436](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c0844c6184e658064e14c4335885785ad3bf84b) | |
| parent | [f0bbcc258e81288212c2092c587ae06428196598](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0bbcc258e81288212c2092c587ae06428196598) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c0844c6184e658064e14c4335885785ad3bf84b&id2=f0bbcc258e81288212c2092c587ae06428196598)) | |
| download | [linux-1c0844c6184e658064e14c4335885785ad3bf84b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c0844c6184e658064e14c4335885785ad3bf84b.tar.gz) | |

udmabuf: change folios array from kmalloc to kvmallocWhen PAGE\_SIZE 4096, MAX\_PAGE\_ORDER 10, 64bit machine,
page\_alloc only support 4MB.
If above this, trigger this warn and return NULL.
udmabuf can change size limit, if change it to 3072(3GB), and then alloc
3GB udmabuf, will fail create.
[ 4080.876581] ------------[ cut here ]------------
[ 4080.876843] WARNING: CPU: 3 PID: 2015 at mm/page\_alloc.c:4556 \_\_alloc\_pages+0x2c8/0x350
[ 4080.878839] RIP: 0010:\_\_alloc\_pages+0x2c8/0x350
[ 4080.879470] Call Trace:
[ 4080.879473] <TASK>
[ 4080.879473] ? \_\_alloc\_pages+0x2c8/0x350
[ 4080.879475] ? \_\_warn.cold+0x8e/0xe8
[ 4080.880647] ? \_\_alloc\_pages+0x2c8/0x350
[ 4080.880909] ? report\_bug+0xff/0x140
[ 4080.881175] ? handle\_bug+0x3c/0x80
[ 4080.881556] ? exc\_invalid\_op+0x17/0x70
[ 4080.881559] ? asm\_exc\_invalid\_op+0x1a/0x20
[ 4080.882077] ? udmabuf\_create+0x131/0x400
Because MAX\_PAGE\_ORDER, kmalloc can max alloc 4096 \* (1 << 10), 4MB
memory, each array entry is pointer(8byte), so can save 524288 pages(2GB).
Further more, costly order(order 3) may not be guaranteed that it can be
applied for, due to fragmentation.
This patch change udmabuf array use kvmalloc\_array, this can fallback
alloc into vmalloc, which can guarantee allocation for any size and does
not affect the performance of kmalloc allocations.
Signed-off-by: Huan Yang <link@vivo.com>
Acked-by: Christian König <christian.koenig@amd.com>
Acked-by: Vivek Kasireddy <vivek.kasireddy@intel.com>
Signed-off-by: Vivek Kasireddy <vivek.kasireddy@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240918025238.2957823-3-link@vivo.com](https://patchwork.freedesktop.org/patch/msgid/20240918025238.2957823-3-link%40vivo.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c0844c6184e658064e14c4335885785ad3bf84b)

| -rw-r--r-- | [drivers/dma-buf/udmabuf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma-buf/udmabuf.c?id=1c0844c6184e658064e14c4335885785ad3bf84b) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 13 deletions

| diff --git a/drivers/dma-buf/udmabuf.c b/drivers/dma-buf/udmabuf.cindex 2170d975cc7670..ba9dbc7caf7141 100644--- a/[drivers/dma-buf/udmabuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma-buf/udmabuf.c?id=f0bbcc258e81288212c2092c587ae06428196598)+++ b/[drivers/dma-buf/udmabuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma-buf/udmabuf.c?id=1c0844c6184e658064e14c4335885785ad3bf84b)@@ -109,7 +109,7 @@ static int vmap\_udmabuf(struct dma\_buf \*buf, struct iosys\_map \*map)  dma\_resv\_assert\_held(buf->resv); - pages = kmalloc\_array(ubuf->pagecount, sizeof(\*pages), GFP\_KERNEL);+ pages = kvmalloc\_array(ubuf->pagecount, sizeof(\*pages), GFP\_KERNEL); if (!pages) return -ENOMEM; @@ -117,7 +117,7 @@ static int vmap\_udmabuf(struct dma\_buf \*buf, struct iosys\_map \*map) pages[pg] = &ubuf->folios[pg]->page;  vaddr = vm\_map\_ram(pages, ubuf->pagecount, -1);- kfree(pages);+ kvfree(pages); if (!vaddr) return -EINVAL; @@ -225,8 +225,8 @@ static void release\_udmabuf(struct dma\_buf \*buf) put\_sg\_table(dev, ubuf->sg, DMA\_BIDIRECTIONAL);  unpin\_all\_folios(&ubuf->unpin\_list);- kfree(ubuf->offsets);- kfree(ubuf->folios);+ kvfree(ubuf->offsets);+ kvfree(ubuf->folios); kfree(ubuf); } @@ -351,14 +351,14 @@ static long udmabuf\_create(struct miscdevice \*device, if (!ubuf->pagecount) goto err; - ubuf->folios = kmalloc\_array(ubuf->pagecount, sizeof(\*ubuf->folios),- GFP\_KERNEL);+ ubuf->folios = kvmalloc\_array(ubuf->pagecount, sizeof(\*ubuf->folios),+ GFP\_KERNEL); if (!ubuf->folios) { ret = -ENOMEM; goto err; }- ubuf->offsets = kcalloc(ubuf->pagecount, sizeof(\*ubuf->offsets),- GFP\_KERNEL);+ ubuf->offsets = kvcalloc(ubuf->pagecount, sizeof(\*ubuf->offsets),+ GFP\_KERNEL); if (!ubuf->offsets) { ret = -ENOMEM; goto err;@@ -372,7 +372,7 @@ static long udmabuf\_create(struct miscdevice \*device, goto err;  pgcnt = list[i].size >> PAGE\_SHIFT;- folios = kmalloc\_array(pgcnt, sizeof(\*folios), GFP\_KERNEL);+ folios = kvmalloc\_array(pgcnt, sizeof(\*folios), GFP\_KERNEL); if (!folios) { ret = -ENOMEM; goto err;@@ -382,7 +382,7 @@ static long udmabuf\_create(struct miscdevice \*device, ret = memfd\_pin\_folios(memfd, list[i].offset, end, folios, pgcnt, &pgoff); if (ret <= 0) {- kfree(folios);+ kvfree(folios); if (!ret) ret = -EINVAL; goto err;@@ -411,7 +411,7 @@ static long udmabuf\_create(struct miscdevice \*device, } } - kfree(folios);+ kvfree(folios); fput(memfd); memfd = NULL; }@@ -427,8 +427,8 @@ err: if (memfd) fput(memfd); unpin\_all\_folios(&ubuf->unpin\_list);- kfree(ubuf->offsets);- kfree(ubuf->folios);+ kvfree(ubuf->offsets);+ kvfree(ubuf->folios); kfree(ubuf); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:38:38 +0000



=== Content from git.kernel.org_fd6744da_20250114_184002.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Huan Yang <link@vivo.com> | 2024-09-18 10:52:25 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:37 +0100 |
| commit | [85bb72397cb63649fe493c96e27e1d0e4ed2ff63](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63)) | |
| tree | [3555294ccc4dfe2428c2fdd1a1bb02c30e266f60](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63) | |
| parent | [aded1c7748791a9b782abcf7b9450eedeca0a042](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aded1c7748791a9b782abcf7b9450eedeca0a042) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63&id2=aded1c7748791a9b782abcf7b9450eedeca0a042)) | |
| download | [linux-85bb72397cb63649fe493c96e27e1d0e4ed2ff63.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-85bb72397cb63649fe493c96e27e1d0e4ed2ff63.tar.gz) | |

udmabuf: change folios array from kmalloc to kvmalloc[ Upstream commit 1c0844c6184e658064e14c4335885785ad3bf84b ]
When PAGE\_SIZE 4096, MAX\_PAGE\_ORDER 10, 64bit machine,
page\_alloc only support 4MB.
If above this, trigger this warn and return NULL.
udmabuf can change size limit, if change it to 3072(3GB), and then alloc
3GB udmabuf, will fail create.
[ 4080.876581] ------------[ cut here ]------------
[ 4080.876843] WARNING: CPU: 3 PID: 2015 at mm/page\_alloc.c:4556 \_\_alloc\_pages+0x2c8/0x350
[ 4080.878839] RIP: 0010:\_\_alloc\_pages+0x2c8/0x350
[ 4080.879470] Call Trace:
[ 4080.879473] <TASK>
[ 4080.879473] ? \_\_alloc\_pages+0x2c8/0x350
[ 4080.879475] ? \_\_warn.cold+0x8e/0xe8
[ 4080.880647] ? \_\_alloc\_pages+0x2c8/0x350
[ 4080.880909] ? report\_bug+0xff/0x140
[ 4080.881175] ? handle\_bug+0x3c/0x80
[ 4080.881556] ? exc\_invalid\_op+0x17/0x70
[ 4080.881559] ? asm\_exc\_invalid\_op+0x1a/0x20
[ 4080.882077] ? udmabuf\_create+0x131/0x400
Because MAX\_PAGE\_ORDER, kmalloc can max alloc 4096 \* (1 << 10), 4MB
memory, each array entry is pointer(8byte), so can save 524288 pages(2GB).
Further more, costly order(order 3) may not be guaranteed that it can be
applied for, due to fragmentation.
This patch change udmabuf array use kvmalloc\_array, this can fallback
alloc into vmalloc, which can guarantee allocation for any size and does
not affect the performance of kmalloc allocations.
Signed-off-by: Huan Yang <link@vivo.com>
Acked-by: Christian König <christian.koenig@amd.com>
Acked-by: Vivek Kasireddy <vivek.kasireddy@intel.com>
Signed-off-by: Vivek Kasireddy <vivek.kasireddy@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240918025238.2957823-3-link@vivo.com](https://patchwork.freedesktop.org/patch/msgid/20240918025238.2957823-3-link%40vivo.com)
Stable-dep-of: 18d7de823b71 ("udmabuf: fix vmap\_udmabuf error page set")
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63)

| -rw-r--r-- | [drivers/dma-buf/udmabuf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma-buf/udmabuf.c?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 13 deletions

| diff --git a/drivers/dma-buf/udmabuf.c b/drivers/dma-buf/udmabuf.cindex 047c3cd2cefff6..bc94c194e172dc 100644--- a/[drivers/dma-buf/udmabuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma-buf/udmabuf.c?id=aded1c7748791a9b782abcf7b9450eedeca0a042)+++ b/[drivers/dma-buf/udmabuf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma-buf/udmabuf.c?id=85bb72397cb63649fe493c96e27e1d0e4ed2ff63)@@ -80,7 +80,7 @@ static int vmap\_udmabuf(struct dma\_buf \*buf, struct iosys\_map \*map)  dma\_resv\_assert\_held(buf->resv); - pages = kmalloc\_array(ubuf->pagecount, sizeof(\*pages), GFP\_KERNEL);+ pages = kvmalloc\_array(ubuf->pagecount, sizeof(\*pages), GFP\_KERNEL); if (!pages) return -ENOMEM; @@ -88,7 +88,7 @@ static int vmap\_udmabuf(struct dma\_buf \*buf, struct iosys\_map \*map) pages[pg] = &ubuf->folios[pg]->page;  vaddr = vm\_map\_ram(pages, ubuf->pagecount, -1);- kfree(pages);+ kvfree(pages); if (!vaddr) return -EINVAL; @@ -196,8 +196,8 @@ static void release\_udmabuf(struct dma\_buf \*buf) put\_sg\_table(dev, ubuf->sg, DMA\_BIDIRECTIONAL);  unpin\_all\_folios(&ubuf->unpin\_list);- kfree(ubuf->offsets);- kfree(ubuf->folios);+ kvfree(ubuf->offsets);+ kvfree(ubuf->folios); kfree(ubuf); } @@ -322,14 +322,14 @@ static long udmabuf\_create(struct miscdevice \*device, if (!ubuf->pagecount) goto err; - ubuf->folios = kmalloc\_array(ubuf->pagecount, sizeof(\*ubuf->folios),- GFP\_KERNEL);+ ubuf->folios = kvmalloc\_array(ubuf->pagecount, sizeof(\*ubuf->folios),+ GFP\_KERNEL); if (!ubuf->folios) { ret = -ENOMEM; goto err; }- ubuf->offsets = kcalloc(ubuf->pagecount, sizeof(\*ubuf->offsets),- GFP\_KERNEL);+ ubuf->offsets = kvcalloc(ubuf->pagecount, sizeof(\*ubuf->offsets),+ GFP\_KERNEL); if (!ubuf->offsets) { ret = -ENOMEM; goto err;@@ -343,7 +343,7 @@ static long udmabuf\_create(struct miscdevice \*device, goto err;  pgcnt = list[i].size >> PAGE\_SHIFT;- folios = kmalloc\_array(pgcnt, sizeof(\*folios), GFP\_KERNEL);+ folios = kvmalloc\_array(pgcnt, sizeof(\*folios), GFP\_KERNEL); if (!folios) { ret = -ENOMEM; goto err;@@ -353,7 +353,7 @@ static long udmabuf\_create(struct miscdevice \*device, ret = memfd\_pin\_folios(memfd, list[i].offset, end, folios, pgcnt, &pgoff); if (ret <= 0) {- kfree(folios);+ kvfree(folios); if (!ret) ret = -EINVAL; goto err;@@ -382,7 +382,7 @@ static long udmabuf\_create(struct miscdevice \*device, } } - kfree(folios);+ kvfree(folios); fput(memfd); memfd = NULL; }@@ -398,8 +398,8 @@ err: if (memfd) fput(memfd); unpin\_all\_folios(&ubuf->unpin\_list);- kfree(ubuf->offsets);- kfree(ubuf->folios);+ kvfree(ubuf->offsets);+ kvfree(ubuf->folios); kfree(ubuf); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:38:39 +0000


