=== Content from git.kernel.org_b39ca9e3_20250115_101328.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0f6ede9fbc747e2553612271bce108f7517e7a45)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f6ede9fbc747e2553612271bce108f7517e7a45)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f6ede9fbc747e2553612271bce108f7517e7a45)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f6ede9fbc747e2553612271bce108f7517e7a45)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-12-04 12:54:55 +0000 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-12-06 17:45:08 -0800 |
| commit | [0f6ede9fbc747e2553612271bce108f7517e7a45](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f6ede9fbc747e2553612271bce108f7517e7a45) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0f6ede9fbc747e2553612271bce108f7517e7a45)) | |
| tree | [83760fbd75f64b5aee0e635879a994299c8d1279](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f6ede9fbc747e2553612271bce108f7517e7a45) | |
| parent | [a6d75ecee2bf828ac6a1b52724aba0a977e4eaf4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6d75ecee2bf828ac6a1b52724aba0a977e4eaf4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f6ede9fbc747e2553612271bce108f7517e7a45&id2=a6d75ecee2bf828ac6a1b52724aba0a977e4eaf4)) | |
| download | [linux-0f6ede9fbc747e2553612271bce108f7517e7a45.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0f6ede9fbc747e2553612271bce108f7517e7a45.tar.gz) | |

net: defer final 'struct net' free in netns dismantleIlya reported a slab-use-after-free in dst\_destroy [1]
Issue is in xfrm6\_net\_init() and xfrm4\_net\_init() :
They copy xfrm[46]\_dst\_ops\_template into net->xfrm.xfrm[46]\_dst\_ops.
But net structure might be freed before all the dst callbacks are
called. So when dst\_destroy() calls later :
if (dst->ops->destroy)
dst->ops->destroy(dst);
dst->ops points to the old net->xfrm.xfrm[46]\_dst\_ops, which has been freed.
See a relevant issue fixed in :
ac888d58869b ("net: do not delay dst\_entries\_add() in dst\_release()")
A fix is to queue the 'struct net' to be freed after one
another cleanup\_net() round (and existing rcu\_barrier())
[1]
BUG: KASAN: slab-use-after-free in dst\_destroy (net/core/dst.c:112)
Read of size 8 at addr ffff8882137ccab0 by task swapper/37/0
Dec 03 05:46:18 kernel:
CPU: 37 UID: 0 PID: 0 Comm: swapper/37 Kdump: loaded Not tainted 6.12.0 #67
Hardware name: Red Hat KVM/RHEL, BIOS 1.16.1-1.el9 04/01/2014
Call Trace:
<IRQ>
dump\_stack\_lvl (lib/dump\_stack.c:124)
print\_address\_description.constprop.0 (mm/kasan/report.c:378)
? dst\_destroy (net/core/dst.c:112)
print\_report (mm/kasan/report.c:489)
? dst\_destroy (net/core/dst.c:112)
? kasan\_addr\_to\_slab (mm/kasan/common.c:37)
kasan\_report (mm/kasan/report.c:603)
? dst\_destroy (net/core/dst.c:112)
? rcu\_do\_batch (kernel/rcu/tree.c:2567)
dst\_destroy (net/core/dst.c:112)
rcu\_do\_batch (kernel/rcu/tree.c:2567)
? \_\_pfx\_rcu\_do\_batch (kernel/rcu/tree.c:2491)
? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4339 kernel/locking/lockdep.c:4406)
rcu\_core (kernel/rcu/tree.c:2825)
handle\_softirqs (kernel/softirq.c:554)
\_\_irq\_exit\_rcu (kernel/softirq.c:589 kernel/softirq.c:428 kernel/softirq.c:637)
irq\_exit\_rcu (kernel/softirq.c:651)
sysvec\_apic\_timer\_interrupt (arch/x86/kernel/apic/apic.c:1049 arch/x86/kernel/apic/apic.c:1049)
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt (./arch/x86/include/asm/idtentry.h:702)
RIP: 0010:default\_idle (./arch/x86/include/asm/irqflags.h:37 ./arch/x86/include/asm/irqflags.h:92 arch/x86/kernel/process.c:743)
Code: 00 4d 29 c8 4c 01 c7 4c 29 c2 e9 6e ff ff ff 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 66 90 0f 00 2d c7 c9 27 00 fb f4 <fa> c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 90
RSP: 0018:ffff888100d2fe00 EFLAGS: 00000246
RAX: 00000000001870ed RBX: 1ffff110201a5fc2 RCX: ffffffffb61a3e46
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffffffffb3d4d123
RBP: 0000000000000000 R08: 0000000000000001 R09: ffffed11c7e1835d
R10: ffff888e3f0c1aeb R11: 0000000000000000 R12: 0000000000000000
R13: ffff888100d20000 R14: dffffc0000000000 R15: 0000000000000000
? ct\_kernel\_exit.constprop.0 (kernel/context\_tracking.c:148)
? cpuidle\_idle\_call (kernel/sched/idle.c:186)
default\_idle\_call (./include/linux/cpuidle.h:143 kernel/sched/idle.c:118)
cpuidle\_idle\_call (kernel/sched/idle.c:186)
? \_\_pfx\_cpuidle\_idle\_call (kernel/sched/idle.c:168)
? lock\_release (kernel/locking/lockdep.c:467 kernel/locking/lockdep.c:5848)
? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4347 kernel/locking/lockdep.c:4406)
? tsc\_verify\_tsc\_adjust (arch/x86/kernel/tsc\_sync.c:59)
do\_idle (kernel/sched/idle.c:326)
cpu\_startup\_entry (kernel/sched/idle.c:423 (discriminator 1))
start\_secondary (arch/x86/kernel/smpboot.c:202 arch/x86/kernel/smpboot.c:282)
? \_\_pfx\_start\_secondary (arch/x86/kernel/smpboot.c:232)
? soft\_restart\_cpu (arch/x86/kernel/head\_64.S:452)
common\_startup\_64 (arch/x86/kernel/head\_64.S:414)
</TASK>
Dec 03 05:46:18 kernel:
Allocated by task 12184:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (./arch/x86/include/asm/current.h:49 mm/kasan/common.c:60 mm/kasan/common.c:69)
\_\_kasan\_slab\_alloc (mm/kasan/common.c:319 mm/kasan/common.c:345)
kmem\_cache\_alloc\_noprof (mm/slub.c:4085 mm/slub.c:4134 mm/slub.c:4141)
copy\_net\_ns (net/core/net\_namespace.c:421 net/core/net\_namespace.c:480)
create\_new\_namespaces (kernel/nsproxy.c:110)
unshare\_nsproxy\_namespaces (kernel/nsproxy.c:228 (discriminator 4))
ksys\_unshare (kernel/fork.c:3313)
\_\_x64\_sys\_unshare (kernel/fork.c:3382)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Dec 03 05:46:18 kernel:
Freed by task 11:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (./arch/x86/include/asm/current.h:49 mm/kasan/common.c:60 mm/kasan/common.c:69)
kasan\_save\_free\_info (mm/kasan/generic.c:582)
\_\_kasan\_slab\_free (mm/kasan/common.c:271)
kmem\_cache\_free (mm/slub.c:4579 mm/slub.c:4681)
cleanup\_net (net/core/net\_namespace.c:456 net/core/net\_namespace.c:446 net/core/net\_namespace.c:647)
process\_one\_work (kernel/workqueue.c:3229)
worker\_thread (kernel/workqueue.c:3304 kernel/workqueue.c:3391)
kthread (kernel/kthread.c:389)
ret\_from\_fork (arch/x86/kernel/process.c:147)
ret\_from\_fork\_asm (arch/x86/entry/entry\_64.S:257)
Dec 03 05:46:18 kernel:
Last potentially related work creation:
kasan\_save\_stack (mm/kasan/common.c:48)
\_\_kasan\_record\_aux\_stack (mm/kasan/generic.c:541)
insert\_work (./include/linux/instrumented.h:68 ./include/asm-generic/bitops/instrumented-non-atomic.h:141 kernel/workqueue.c:788 kernel/workqueue.c:795 kernel/workqueue.c:2186)
\_\_queue\_work (kernel/workqueue.c:2340)
queue\_work\_on (kernel/workqueue.c:2391)
xfrm\_policy\_insert (net/xfrm/xfrm\_policy.c:1610)
xfrm\_add\_policy (net/xfrm/xfrm\_user.c:2116)
xfrm\_user\_rcv\_msg (net/xfrm/xfrm\_user.c:3321)
netlink\_rcv\_skb (net/netlink/af\_netlink.c:2536)
xfrm\_netlink\_rcv (net/xfrm/xfrm\_user.c:3344)
netlink\_unicast (net/netlink/af\_netlink.c:1316 net/netlink/af\_netlink.c:1342)
netlink\_sendmsg (net/netlink/af\_netlink.c:1886)
sock\_write\_iter (net/socket.c:729 net/socket.c:744 net/socket.c:1165)
vfs\_write (fs/read\_write.c:590 fs/read\_write.c:683)
ksys\_write (fs/read\_write.c:736)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Dec 03 05:46:18 kernel:
Second to last potentially related work creation:
kasan\_save\_stack (mm/kasan/common.c:48)
\_\_kasan\_record\_aux\_stack (mm/kasan/generic.c:541)
insert\_work (./include/linux/instrumented.h:68 ./include/asm-generic/bitops/instrumented-non-atomic.h:141 kernel/workqueue.c:788 kernel/workqueue.c:795 kernel/workqueue.c:2186)
\_\_queue\_work (kernel/workqueue.c:2340)
queue\_work\_on (kernel/workqueue.c:2391)
\_\_xfrm\_state\_insert (./include/linux/workqueue.h:723 net/xfrm/xfrm\_state.c:1150 net/xfrm/xfrm\_state.c:1145 net/xfrm/xfrm\_state.c:1513)
xfrm\_state\_update (./include/linux/spinlock.h:396 net/xfrm/xfrm\_state.c:1940)
xfrm\_add\_sa (net/xfrm/xfrm\_user.c:912)
xfrm\_user\_rcv\_msg (net/xfrm/xfrm\_user.c:3321)
netlink\_rcv\_skb (net/netlink/af\_netlink.c:2536)
xfrm\_netlink\_rcv (net/xfrm/xfrm\_user.c:3344)
netlink\_unicast (net/netlink/af\_netlink.c:1316 net/netlink/af\_netlink.c:1342)
netlink\_sendmsg (net/netlink/af\_netlink.c:1886)
sock\_write\_iter (net/socket.c:729 net/socket.c:744 net/socket.c:1165)
vfs\_write (fs/read\_write.c:590 fs/read\_write.c:683)
ksys\_write (fs/read\_write.c:736)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fixes: a8a572a6b5f2 ("xfrm: dst\_entries\_init() per-net dst\_ops")
Reported-by: Ilya Maximets <i.maximets@ovn.org>
Closes: https://lore.kernel.org/netdev/CANn89iKKYDVpB=MtmfH7nyv2p=rJWSLedO5k7wSZgtY\_tO8WQg@mail.gmail.com/T/#m02c98c3009fe66382b73cfb4db9cf1df6fab3fbf
Signed-off-by: Eric Dumazet <edumazet@google.com>
Acked-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241204125455.3871859-1-edumazet@google.com](https://patch.msgid.link/20241204125455.3871859-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f6ede9fbc747e2553612271bce108f7517e7a45)

| -rw-r--r-- | [include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/net_namespace.h?id=0f6ede9fbc747e2553612271bce108f7517e7a45) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/net_namespace.c?id=0f6ede9fbc747e2553612271bce108f7517e7a45) | 20 | |  |  |  | | --- | --- | --- | |

2 files changed, 20 insertions, 1 deletions

| diff --git a/include/net/net\_namespace.h b/include/net/net\_namespace.hindex f943bd79ef0382..5a2a0df8ad91b6 100644--- a/[include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/net_namespace.h?id=a6d75ecee2bf828ac6a1b52724aba0a977e4eaf4)+++ b/[include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/net_namespace.h?id=0f6ede9fbc747e2553612271bce108f7517e7a45)@@ -80,6 +80,7 @@ struct net { \* or to unregister pernet ops \* (pernet\_ops\_rwsem write locked). \*/+ struct llist\_node defer\_free\_list; struct llist\_node cleanup\_list; /\* namespaces on death row \*/  #ifdef CONFIG\_KEYSdiff --git a/net/core/net\_namespace.c b/net/core/net\_namespace.cindex ae34ac818cda76..b5cd3ae4f04cf2 100644--- a/[net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/net_namespace.c?id=a6d75ecee2bf828ac6a1b52724aba0a977e4eaf4)+++ b/[net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/net_namespace.c?id=0f6ede9fbc747e2553612271bce108f7517e7a45)@@ -449,6 +449,21 @@ out\_free: goto out; } +static LLIST\_HEAD(defer\_free\_list);++static void net\_complete\_free(void)+{+ struct llist\_node \*kill\_list;+ struct net \*net, \*next;++ /\* Get the list of namespaces to free from last round. \*/+ kill\_list = llist\_del\_all(&defer\_free\_list);++ llist\_for\_each\_entry\_safe(net, next, kill\_list, defer\_free\_list)+ kmem\_cache\_free(net\_cachep, net);++}+ static void net\_free(struct net \*net) { if (refcount\_dec\_and\_test(&net->passive)) {@@ -457,7 +472,8 @@ static void net\_free(struct net \*net) /\* There should not be any trackers left there. \*/ ref\_tracker\_dir\_exit(&net->notrefcnt\_tracker); - kmem\_cache\_free(net\_cachep, net);+ /\* Wait for an extra rcu\_barrier() before final free. \*/+ llist\_add(&net->defer\_free\_list, &defer\_free\_list); } } @@ -642,6 +658,8 @@ static void cleanup\_net(struct work\_struct \*work) \*/ rcu\_barrier(); + net\_complete\_free();+ /\* Finally it is safe to free my network namespace structure \*/ list\_for\_each\_entry\_safe(net, tmp, &net\_exit\_list, exit\_list) { list\_del\_init(&net->exit\_list); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:12:05 +0000



=== Content from git.kernel.org_e28d5038_20250115_101332.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-12-04 12:54:55 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:13:13 +0100 |
| commit | [6610c7f8a8d47fd1123eed55ba8c11c2444d8842](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842)) | |
| tree | [47a1e19cbb4d098d9eca278666d83cdfa9e179ee](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842) | |
| parent | [2b351355bbd50ae25d096785b6eb31998d2bf765](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b351355bbd50ae25d096785b6eb31998d2bf765) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842&id2=2b351355bbd50ae25d096785b6eb31998d2bf765)) | |
| download | [linux-6610c7f8a8d47fd1123eed55ba8c11c2444d8842.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6610c7f8a8d47fd1123eed55ba8c11c2444d8842.tar.gz) | |

net: defer final 'struct net' free in netns dismantle[ Upstream commit 0f6ede9fbc747e2553612271bce108f7517e7a45 ]
Ilya reported a slab-use-after-free in dst\_destroy [1]
Issue is in xfrm6\_net\_init() and xfrm4\_net\_init() :
They copy xfrm[46]\_dst\_ops\_template into net->xfrm.xfrm[46]\_dst\_ops.
But net structure might be freed before all the dst callbacks are
called. So when dst\_destroy() calls later :
if (dst->ops->destroy)
dst->ops->destroy(dst);
dst->ops points to the old net->xfrm.xfrm[46]\_dst\_ops, which has been freed.
See a relevant issue fixed in :
ac888d58869b ("net: do not delay dst\_entries\_add() in dst\_release()")
A fix is to queue the 'struct net' to be freed after one
another cleanup\_net() round (and existing rcu\_barrier())
[1]
BUG: KASAN: slab-use-after-free in dst\_destroy (net/core/dst.c:112)
Read of size 8 at addr ffff8882137ccab0 by task swapper/37/0
Dec 03 05:46:18 kernel:
CPU: 37 UID: 0 PID: 0 Comm: swapper/37 Kdump: loaded Not tainted 6.12.0 #67
Hardware name: Red Hat KVM/RHEL, BIOS 1.16.1-1.el9 04/01/2014
Call Trace:
<IRQ>
dump\_stack\_lvl (lib/dump\_stack.c:124)
print\_address\_description.constprop.0 (mm/kasan/report.c:378)
? dst\_destroy (net/core/dst.c:112)
print\_report (mm/kasan/report.c:489)
? dst\_destroy (net/core/dst.c:112)
? kasan\_addr\_to\_slab (mm/kasan/common.c:37)
kasan\_report (mm/kasan/report.c:603)
? dst\_destroy (net/core/dst.c:112)
? rcu\_do\_batch (kernel/rcu/tree.c:2567)
dst\_destroy (net/core/dst.c:112)
rcu\_do\_batch (kernel/rcu/tree.c:2567)
? \_\_pfx\_rcu\_do\_batch (kernel/rcu/tree.c:2491)
? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4339 kernel/locking/lockdep.c:4406)
rcu\_core (kernel/rcu/tree.c:2825)
handle\_softirqs (kernel/softirq.c:554)
\_\_irq\_exit\_rcu (kernel/softirq.c:589 kernel/softirq.c:428 kernel/softirq.c:637)
irq\_exit\_rcu (kernel/softirq.c:651)
sysvec\_apic\_timer\_interrupt (arch/x86/kernel/apic/apic.c:1049 arch/x86/kernel/apic/apic.c:1049)
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt (./arch/x86/include/asm/idtentry.h:702)
RIP: 0010:default\_idle (./arch/x86/include/asm/irqflags.h:37 ./arch/x86/include/asm/irqflags.h:92 arch/x86/kernel/process.c:743)
Code: 00 4d 29 c8 4c 01 c7 4c 29 c2 e9 6e ff ff ff 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 66 90 0f 00 2d c7 c9 27 00 fb f4 <fa> c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 90
RSP: 0018:ffff888100d2fe00 EFLAGS: 00000246
RAX: 00000000001870ed RBX: 1ffff110201a5fc2 RCX: ffffffffb61a3e46
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffffffffb3d4d123
RBP: 0000000000000000 R08: 0000000000000001 R09: ffffed11c7e1835d
R10: ffff888e3f0c1aeb R11: 0000000000000000 R12: 0000000000000000
R13: ffff888100d20000 R14: dffffc0000000000 R15: 0000000000000000
? ct\_kernel\_exit.constprop.0 (kernel/context\_tracking.c:148)
? cpuidle\_idle\_call (kernel/sched/idle.c:186)
default\_idle\_call (./include/linux/cpuidle.h:143 kernel/sched/idle.c:118)
cpuidle\_idle\_call (kernel/sched/idle.c:186)
? \_\_pfx\_cpuidle\_idle\_call (kernel/sched/idle.c:168)
? lock\_release (kernel/locking/lockdep.c:467 kernel/locking/lockdep.c:5848)
? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4347 kernel/locking/lockdep.c:4406)
? tsc\_verify\_tsc\_adjust (arch/x86/kernel/tsc\_sync.c:59)
do\_idle (kernel/sched/idle.c:326)
cpu\_startup\_entry (kernel/sched/idle.c:423 (discriminator 1))
start\_secondary (arch/x86/kernel/smpboot.c:202 arch/x86/kernel/smpboot.c:282)
? \_\_pfx\_start\_secondary (arch/x86/kernel/smpboot.c:232)
? soft\_restart\_cpu (arch/x86/kernel/head\_64.S:452)
common\_startup\_64 (arch/x86/kernel/head\_64.S:414)
</TASK>
Dec 03 05:46:18 kernel:
Allocated by task 12184:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (./arch/x86/include/asm/current.h:49 mm/kasan/common.c:60 mm/kasan/common.c:69)
\_\_kasan\_slab\_alloc (mm/kasan/common.c:319 mm/kasan/common.c:345)
kmem\_cache\_alloc\_noprof (mm/slub.c:4085 mm/slub.c:4134 mm/slub.c:4141)
copy\_net\_ns (net/core/net\_namespace.c:421 net/core/net\_namespace.c:480)
create\_new\_namespaces (kernel/nsproxy.c:110)
unshare\_nsproxy\_namespaces (kernel/nsproxy.c:228 (discriminator 4))
ksys\_unshare (kernel/fork.c:3313)
\_\_x64\_sys\_unshare (kernel/fork.c:3382)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Dec 03 05:46:18 kernel:
Freed by task 11:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (./arch/x86/include/asm/current.h:49 mm/kasan/common.c:60 mm/kasan/common.c:69)
kasan\_save\_free\_info (mm/kasan/generic.c:582)
\_\_kasan\_slab\_free (mm/kasan/common.c:271)
kmem\_cache\_free (mm/slub.c:4579 mm/slub.c:4681)
cleanup\_net (net/core/net\_namespace.c:456 net/core/net\_namespace.c:446 net/core/net\_namespace.c:647)
process\_one\_work (kernel/workqueue.c:3229)
worker\_thread (kernel/workqueue.c:3304 kernel/workqueue.c:3391)
kthread (kernel/kthread.c:389)
ret\_from\_fork (arch/x86/kernel/process.c:147)
ret\_from\_fork\_asm (arch/x86/entry/entry\_64.S:257)
Dec 03 05:46:18 kernel:
Last potentially related work creation:
kasan\_save\_stack (mm/kasan/common.c:48)
\_\_kasan\_record\_aux\_stack (mm/kasan/generic.c:541)
insert\_work (./include/linux/instrumented.h:68 ./include/asm-generic/bitops/instrumented-non-atomic.h:141 kernel/workqueue.c:788 kernel/workqueue.c:795 kernel/workqueue.c:2186)
\_\_queue\_work (kernel/workqueue.c:2340)
queue\_work\_on (kernel/workqueue.c:2391)
xfrm\_policy\_insert (net/xfrm/xfrm\_policy.c:1610)
xfrm\_add\_policy (net/xfrm/xfrm\_user.c:2116)
xfrm\_user\_rcv\_msg (net/xfrm/xfrm\_user.c:3321)
netlink\_rcv\_skb (net/netlink/af\_netlink.c:2536)
xfrm\_netlink\_rcv (net/xfrm/xfrm\_user.c:3344)
netlink\_unicast (net/netlink/af\_netlink.c:1316 net/netlink/af\_netlink.c:1342)
netlink\_sendmsg (net/netlink/af\_netlink.c:1886)
sock\_write\_iter (net/socket.c:729 net/socket.c:744 net/socket.c:1165)
vfs\_write (fs/read\_write.c:590 fs/read\_write.c:683)
ksys\_write (fs/read\_write.c:736)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Dec 03 05:46:18 kernel:
Second to last potentially related work creation:
kasan\_save\_stack (mm/kasan/common.c:48)
\_\_kasan\_record\_aux\_stack (mm/kasan/generic.c:541)
insert\_work (./include/linux/instrumented.h:68 ./include/asm-generic/bitops/instrumented-non-atomic.h:141 kernel/workqueue.c:788 kernel/workqueue.c:795 kernel/workqueue.c:2186)
\_\_queue\_work (kernel/workqueue.c:2340)
queue\_work\_on (kernel/workqueue.c:2391)
\_\_xfrm\_state\_insert (./include/linux/workqueue.h:723 net/xfrm/xfrm\_state.c:1150 net/xfrm/xfrm\_state.c:1145 net/xfrm/xfrm\_state.c:1513)
xfrm\_state\_update (./include/linux/spinlock.h:396 net/xfrm/xfrm\_state.c:1940)
xfrm\_add\_sa (net/xfrm/xfrm\_user.c:912)
xfrm\_user\_rcv\_msg (net/xfrm/xfrm\_user.c:3321)
netlink\_rcv\_skb (net/netlink/af\_netlink.c:2536)
xfrm\_netlink\_rcv (net/xfrm/xfrm\_user.c:3344)
netlink\_unicast (net/netlink/af\_netlink.c:1316 net/netlink/af\_netlink.c:1342)
netlink\_sendmsg (net/netlink/af\_netlink.c:1886)
sock\_write\_iter (net/socket.c:729 net/socket.c:744 net/socket.c:1165)
vfs\_write (fs/read\_write.c:590 fs/read\_write.c:683)
ksys\_write (fs/read\_write.c:736)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fixes: a8a572a6b5f2 ("xfrm: dst\_entries\_init() per-net dst\_ops")
Reported-by: Ilya Maximets <i.maximets@ovn.org>
Closes: https://lore.kernel.org/netdev/CANn89iKKYDVpB=MtmfH7nyv2p=rJWSLedO5k7wSZgtY\_tO8WQg@mail.gmail.com/T/#m02c98c3009fe66382b73cfb4db9cf1df6fab3fbf
Signed-off-by: Eric Dumazet <edumazet@google.com>
Acked-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241204125455.3871859-1-edumazet@google.com](https://patch.msgid.link/20241204125455.3871859-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842)

| -rw-r--r-- | [include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/net_namespace.h?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/net_namespace.c?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842) | 20 | |  |  |  | | --- | --- | --- | |

2 files changed, 20 insertions, 1 deletions

| diff --git a/include/net/net\_namespace.h b/include/net/net\_namespace.hindex e67b483cc8bbb8..9398c8f4995368 100644--- a/[include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/net_namespace.h?id=2b351355bbd50ae25d096785b6eb31998d2bf765)+++ b/[include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/net_namespace.h?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842)@@ -80,6 +80,7 @@ struct net { \* or to unregister pernet ops \* (pernet\_ops\_rwsem write locked). \*/+ struct llist\_node defer\_free\_list; struct llist\_node cleanup\_list; /\* namespaces on death row \*/  #ifdef CONFIG\_KEYSdiff --git a/net/core/net\_namespace.c b/net/core/net\_namespace.cindex e39479f1c9a486..70fea7c1a4b0a4 100644--- a/[net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/net_namespace.c?id=2b351355bbd50ae25d096785b6eb31998d2bf765)+++ b/[net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/net_namespace.c?id=6610c7f8a8d47fd1123eed55ba8c11c2444d8842)@@ -443,6 +443,21 @@ out\_free: goto out; } +static LLIST\_HEAD(defer\_free\_list);++static void net\_complete\_free(void)+{+ struct llist\_node \*kill\_list;+ struct net \*net, \*next;++ /\* Get the list of namespaces to free from last round. \*/+ kill\_list = llist\_del\_all(&defer\_free\_list);++ llist\_for\_each\_entry\_safe(net, next, kill\_list, defer\_free\_list)+ kmem\_cache\_free(net\_cachep, net);++}+ static void net\_free(struct net \*net) { if (refcount\_dec\_and\_test(&net->passive)) {@@ -451,7 +466,8 @@ static void net\_free(struct net \*net) /\* There should not be any trackers left there. \*/ ref\_tracker\_dir\_exit(&net->notrefcnt\_tracker); - kmem\_cache\_free(net\_cachep, net);+ /\* Wait for an extra rcu\_barrier() before final free. \*/+ llist\_add(&net->defer\_free\_list, &defer\_free\_list); } } @@ -636,6 +652,8 @@ static void cleanup\_net(struct work\_struct \*work) \*/ rcu\_barrier(); + net\_complete\_free();+ /\* Finally it is safe to free my network namespace structure \*/ list\_for\_each\_entry\_safe(net, tmp, &net\_exit\_list, exit\_list) { list\_del\_init(&net->exit\_list); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:12:08 +0000



=== Content from git.kernel.org_43501d1b_20250115_101333.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b7a79e51297f7b82adb687086f5cb2da446f1e40)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7a79e51297f7b82adb687086f5cb2da446f1e40)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7a79e51297f7b82adb687086f5cb2da446f1e40)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7a79e51297f7b82adb687086f5cb2da446f1e40)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-12-04 12:54:55 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:11:28 +0100 |
| commit | [b7a79e51297f7b82adb687086f5cb2da446f1e40](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7a79e51297f7b82adb687086f5cb2da446f1e40) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b7a79e51297f7b82adb687086f5cb2da446f1e40)) | |
| tree | [79e49c99ed8805d7bb1cc6db11eb2919e4bf450c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7a79e51297f7b82adb687086f5cb2da446f1e40) | |
| parent | [03e661b5e7aa1124f24054df9ab2ee5cb2178973](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03e661b5e7aa1124f24054df9ab2ee5cb2178973) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7a79e51297f7b82adb687086f5cb2da446f1e40&id2=03e661b5e7aa1124f24054df9ab2ee5cb2178973)) | |
| download | [linux-b7a79e51297f7b82adb687086f5cb2da446f1e40.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b7a79e51297f7b82adb687086f5cb2da446f1e40.tar.gz) | |

net: defer final 'struct net' free in netns dismantle[ Upstream commit 0f6ede9fbc747e2553612271bce108f7517e7a45 ]
Ilya reported a slab-use-after-free in dst\_destroy [1]
Issue is in xfrm6\_net\_init() and xfrm4\_net\_init() :
They copy xfrm[46]\_dst\_ops\_template into net->xfrm.xfrm[46]\_dst\_ops.
But net structure might be freed before all the dst callbacks are
called. So when dst\_destroy() calls later :
if (dst->ops->destroy)
dst->ops->destroy(dst);
dst->ops points to the old net->xfrm.xfrm[46]\_dst\_ops, which has been freed.
See a relevant issue fixed in :
ac888d58869b ("net: do not delay dst\_entries\_add() in dst\_release()")
A fix is to queue the 'struct net' to be freed after one
another cleanup\_net() round (and existing rcu\_barrier())
[1]
BUG: KASAN: slab-use-after-free in dst\_destroy (net/core/dst.c:112)
Read of size 8 at addr ffff8882137ccab0 by task swapper/37/0
Dec 03 05:46:18 kernel:
CPU: 37 UID: 0 PID: 0 Comm: swapper/37 Kdump: loaded Not tainted 6.12.0 #67
Hardware name: Red Hat KVM/RHEL, BIOS 1.16.1-1.el9 04/01/2014
Call Trace:
<IRQ>
dump\_stack\_lvl (lib/dump\_stack.c:124)
print\_address\_description.constprop.0 (mm/kasan/report.c:378)
? dst\_destroy (net/core/dst.c:112)
print\_report (mm/kasan/report.c:489)
? dst\_destroy (net/core/dst.c:112)
? kasan\_addr\_to\_slab (mm/kasan/common.c:37)
kasan\_report (mm/kasan/report.c:603)
? dst\_destroy (net/core/dst.c:112)
? rcu\_do\_batch (kernel/rcu/tree.c:2567)
dst\_destroy (net/core/dst.c:112)
rcu\_do\_batch (kernel/rcu/tree.c:2567)
? \_\_pfx\_rcu\_do\_batch (kernel/rcu/tree.c:2491)
? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4339 kernel/locking/lockdep.c:4406)
rcu\_core (kernel/rcu/tree.c:2825)
handle\_softirqs (kernel/softirq.c:554)
\_\_irq\_exit\_rcu (kernel/softirq.c:589 kernel/softirq.c:428 kernel/softirq.c:637)
irq\_exit\_rcu (kernel/softirq.c:651)
sysvec\_apic\_timer\_interrupt (arch/x86/kernel/apic/apic.c:1049 arch/x86/kernel/apic/apic.c:1049)
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt (./arch/x86/include/asm/idtentry.h:702)
RIP: 0010:default\_idle (./arch/x86/include/asm/irqflags.h:37 ./arch/x86/include/asm/irqflags.h:92 arch/x86/kernel/process.c:743)
Code: 00 4d 29 c8 4c 01 c7 4c 29 c2 e9 6e ff ff ff 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 66 90 0f 00 2d c7 c9 27 00 fb f4 <fa> c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 90
RSP: 0018:ffff888100d2fe00 EFLAGS: 00000246
RAX: 00000000001870ed RBX: 1ffff110201a5fc2 RCX: ffffffffb61a3e46
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffffffffb3d4d123
RBP: 0000000000000000 R08: 0000000000000001 R09: ffffed11c7e1835d
R10: ffff888e3f0c1aeb R11: 0000000000000000 R12: 0000000000000000
R13: ffff888100d20000 R14: dffffc0000000000 R15: 0000000000000000
? ct\_kernel\_exit.constprop.0 (kernel/context\_tracking.c:148)
? cpuidle\_idle\_call (kernel/sched/idle.c:186)
default\_idle\_call (./include/linux/cpuidle.h:143 kernel/sched/idle.c:118)
cpuidle\_idle\_call (kernel/sched/idle.c:186)
? \_\_pfx\_cpuidle\_idle\_call (kernel/sched/idle.c:168)
? lock\_release (kernel/locking/lockdep.c:467 kernel/locking/lockdep.c:5848)
? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4347 kernel/locking/lockdep.c:4406)
? tsc\_verify\_tsc\_adjust (arch/x86/kernel/tsc\_sync.c:59)
do\_idle (kernel/sched/idle.c:326)
cpu\_startup\_entry (kernel/sched/idle.c:423 (discriminator 1))
start\_secondary (arch/x86/kernel/smpboot.c:202 arch/x86/kernel/smpboot.c:282)
? \_\_pfx\_start\_secondary (arch/x86/kernel/smpboot.c:232)
? soft\_restart\_cpu (arch/x86/kernel/head\_64.S:452)
common\_startup\_64 (arch/x86/kernel/head\_64.S:414)
</TASK>
Dec 03 05:46:18 kernel:
Allocated by task 12184:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (./arch/x86/include/asm/current.h:49 mm/kasan/common.c:60 mm/kasan/common.c:69)
\_\_kasan\_slab\_alloc (mm/kasan/common.c:319 mm/kasan/common.c:345)
kmem\_cache\_alloc\_noprof (mm/slub.c:4085 mm/slub.c:4134 mm/slub.c:4141)
copy\_net\_ns (net/core/net\_namespace.c:421 net/core/net\_namespace.c:480)
create\_new\_namespaces (kernel/nsproxy.c:110)
unshare\_nsproxy\_namespaces (kernel/nsproxy.c:228 (discriminator 4))
ksys\_unshare (kernel/fork.c:3313)
\_\_x64\_sys\_unshare (kernel/fork.c:3382)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Dec 03 05:46:18 kernel:
Freed by task 11:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (./arch/x86/include/asm/current.h:49 mm/kasan/common.c:60 mm/kasan/common.c:69)
kasan\_save\_free\_info (mm/kasan/generic.c:582)
\_\_kasan\_slab\_free (mm/kasan/common.c:271)
kmem\_cache\_free (mm/slub.c:4579 mm/slub.c:4681)
cleanup\_net (net/core/net\_namespace.c:456 net/core/net\_namespace.c:446 net/core/net\_namespace.c:647)
process\_one\_work (kernel/workqueue.c:3229)
worker\_thread (kernel/workqueue.c:3304 kernel/workqueue.c:3391)
kthread (kernel/kthread.c:389)
ret\_from\_fork (arch/x86/kernel/process.c:147)
ret\_from\_fork\_asm (arch/x86/entry/entry\_64.S:257)
Dec 03 05:46:18 kernel:
Last potentially related work creation:
kasan\_save\_stack (mm/kasan/common.c:48)
\_\_kasan\_record\_aux\_stack (mm/kasan/generic.c:541)
insert\_work (./include/linux/instrumented.h:68 ./include/asm-generic/bitops/instrumented-non-atomic.h:141 kernel/workqueue.c:788 kernel/workqueue.c:795 kernel/workqueue.c:2186)
\_\_queue\_work (kernel/workqueue.c:2340)
queue\_work\_on (kernel/workqueue.c:2391)
xfrm\_policy\_insert (net/xfrm/xfrm\_policy.c:1610)
xfrm\_add\_policy (net/xfrm/xfrm\_user.c:2116)
xfrm\_user\_rcv\_msg (net/xfrm/xfrm\_user.c:3321)
netlink\_rcv\_skb (net/netlink/af\_netlink.c:2536)
xfrm\_netlink\_rcv (net/xfrm/xfrm\_user.c:3344)
netlink\_unicast (net/netlink/af\_netlink.c:1316 net/netlink/af\_netlink.c:1342)
netlink\_sendmsg (net/netlink/af\_netlink.c:1886)
sock\_write\_iter (net/socket.c:729 net/socket.c:744 net/socket.c:1165)
vfs\_write (fs/read\_write.c:590 fs/read\_write.c:683)
ksys\_write (fs/read\_write.c:736)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Dec 03 05:46:18 kernel:
Second to last potentially related work creation:
kasan\_save\_stack (mm/kasan/common.c:48)
\_\_kasan\_record\_aux\_stack (mm/kasan/generic.c:541)
insert\_work (./include/linux/instrumented.h:68 ./include/asm-generic/bitops/instrumented-non-atomic.h:141 kernel/workqueue.c:788 kernel/workqueue.c:795 kernel/workqueue.c:2186)
\_\_queue\_work (kernel/workqueue.c:2340)
queue\_work\_on (kernel/workqueue.c:2391)
\_\_xfrm\_state\_insert (./include/linux/workqueue.h:723 net/xfrm/xfrm\_state.c:1150 net/xfrm/xfrm\_state.c:1145 net/xfrm/xfrm\_state.c:1513)
xfrm\_state\_update (./include/linux/spinlock.h:396 net/xfrm/xfrm\_state.c:1940)
xfrm\_add\_sa (net/xfrm/xfrm\_user.c:912)
xfrm\_user\_rcv\_msg (net/xfrm/xfrm\_user.c:3321)
netlink\_rcv\_skb (net/netlink/af\_netlink.c:2536)
xfrm\_netlink\_rcv (net/xfrm/xfrm\_user.c:3344)
netlink\_unicast (net/netlink/af\_netlink.c:1316 net/netlink/af\_netlink.c:1342)
netlink\_sendmsg (net/netlink/af\_netlink.c:1886)
sock\_write\_iter (net/socket.c:729 net/socket.c:744 net/socket.c:1165)
vfs\_write (fs/read\_write.c:590 fs/read\_write.c:683)
ksys\_write (fs/read\_write.c:736)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fixes: a8a572a6b5f2 ("xfrm: dst\_entries\_init() per-net dst\_ops")
Reported-by: Ilya Maximets <i.maximets@ovn.org>
Closes: https://lore.kernel.org/netdev/CANn89iKKYDVpB=MtmfH7nyv2p=rJWSLedO5k7wSZgtY\_tO8WQg@mail.gmail.com/T/#m02c98c3009fe66382b73cfb4db9cf1df6fab3fbf
Signed-off-by: Eric Dumazet <edumazet@google.com>
Acked-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241204125455.3871859-1-edumazet@google.com](https://patch.msgid.link/20241204125455.3871859-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7a79e51297f7b82adb687086f5cb2da446f1e40)

| -rw-r--r-- | [include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/net_namespace.h?id=b7a79e51297f7b82adb687086f5cb2da446f1e40) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/net_namespace.c?id=b7a79e51297f7b82adb687086f5cb2da446f1e40) | 20 | |  |  |  | | --- | --- | --- | |

2 files changed, 20 insertions, 1 deletions

| diff --git a/include/net/net\_namespace.h b/include/net/net\_namespace.hindex eb6cd43b174638..958c805df1915b 100644--- a/[include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/net_namespace.h?id=03e661b5e7aa1124f24054df9ab2ee5cb2178973)+++ b/[include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/net_namespace.h?id=b7a79e51297f7b82adb687086f5cb2da446f1e40)@@ -82,6 +82,7 @@ struct net { \* or to unregister pernet ops \* (pernet\_ops\_rwsem write locked). \*/+ struct llist\_node defer\_free\_list; struct llist\_node cleanup\_list; /\* namespaces on death row \*/  #ifdef CONFIG\_KEYSdiff --git a/net/core/net\_namespace.c b/net/core/net\_namespace.cindex 018e213185a17f..92b7fea4d495cf 100644--- a/[net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/net_namespace.c?id=03e661b5e7aa1124f24054df9ab2ee5cb2178973)+++ b/[net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/net_namespace.c?id=b7a79e51297f7b82adb687086f5cb2da446f1e40)@@ -442,6 +442,21 @@ out\_free: goto out; } +static LLIST\_HEAD(defer\_free\_list);++static void net\_complete\_free(void)+{+ struct llist\_node \*kill\_list;+ struct net \*net, \*next;++ /\* Get the list of namespaces to free from last round. \*/+ kill\_list = llist\_del\_all(&defer\_free\_list);++ llist\_for\_each\_entry\_safe(net, next, kill\_list, defer\_free\_list)+ kmem\_cache\_free(net\_cachep, net);++}+ static void net\_free(struct net \*net) { if (refcount\_dec\_and\_test(&net->passive)) {@@ -450,7 +465,8 @@ static void net\_free(struct net \*net) /\* There should not be any trackers left there. \*/ ref\_tracker\_dir\_exit(&net->notrefcnt\_tracker); - kmem\_cache\_free(net\_cachep, net);+ /\* Wait for an extra rcu\_barrier() before final free. \*/+ llist\_add(&net->defer\_free\_list, &defer\_free\_list); } } @@ -627,6 +643,8 @@ static void cleanup\_net(struct work\_struct \*work) \*/ rcu\_barrier(); + net\_complete\_free();+ /\* Finally it is safe to free my network namespace structure \*/ list\_for\_each\_entry\_safe(net, tmp, &net\_exit\_list, exit\_list) { list\_del\_init(&net->exit\_list); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:12:10 +0000



=== Content from git.kernel.org_c005f399_20250115_101330.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-12-04 12:54:55 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:08:54 +0100 |
| commit | [3267b254dc0a04dfa362a2be24573cfa6d2d78f5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5)) | |
| tree | [0320b549470a059dc53f4257ecd07c3dcf816dac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5) | |
| parent | [f0949199651bc87c5ed2c12a7323f441f1af6fe9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0949199651bc87c5ed2c12a7323f441f1af6fe9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5&id2=f0949199651bc87c5ed2c12a7323f441f1af6fe9)) | |
| download | [linux-3267b254dc0a04dfa362a2be24573cfa6d2d78f5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3267b254dc0a04dfa362a2be24573cfa6d2d78f5.tar.gz) | |

net: defer final 'struct net' free in netns dismantlecommit 0f6ede9fbc747e2553612271bce108f7517e7a45 upstream.
Ilya reported a slab-use-after-free in dst\_destroy [1]
Issue is in xfrm6\_net\_init() and xfrm4\_net\_init() :
They copy xfrm[46]\_dst\_ops\_template into net->xfrm.xfrm[46]\_dst\_ops.
But net structure might be freed before all the dst callbacks are
called. So when dst\_destroy() calls later :
if (dst->ops->destroy)
dst->ops->destroy(dst);
dst->ops points to the old net->xfrm.xfrm[46]\_dst\_ops, which has been freed.
See a relevant issue fixed in :
ac888d58869b ("net: do not delay dst\_entries\_add() in dst\_release()")
A fix is to queue the 'struct net' to be freed after one
another cleanup\_net() round (and existing rcu\_barrier())
[1]
BUG: KASAN: slab-use-after-free in dst\_destroy (net/core/dst.c:112)
Read of size 8 at addr ffff8882137ccab0 by task swapper/37/0
Dec 03 05:46:18 kernel:
CPU: 37 UID: 0 PID: 0 Comm: swapper/37 Kdump: loaded Not tainted 6.12.0 #67
Hardware name: Red Hat KVM/RHEL, BIOS 1.16.1-1.el9 04/01/2014
Call Trace:
<IRQ>
dump\_stack\_lvl (lib/dump\_stack.c:124)
print\_address\_description.constprop.0 (mm/kasan/report.c:378)
? dst\_destroy (net/core/dst.c:112)
print\_report (mm/kasan/report.c:489)
? dst\_destroy (net/core/dst.c:112)
? kasan\_addr\_to\_slab (mm/kasan/common.c:37)
kasan\_report (mm/kasan/report.c:603)
? dst\_destroy (net/core/dst.c:112)
? rcu\_do\_batch (kernel/rcu/tree.c:2567)
dst\_destroy (net/core/dst.c:112)
rcu\_do\_batch (kernel/rcu/tree.c:2567)
? \_\_pfx\_rcu\_do\_batch (kernel/rcu/tree.c:2491)
? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4339 kernel/locking/lockdep.c:4406)
rcu\_core (kernel/rcu/tree.c:2825)
handle\_softirqs (kernel/softirq.c:554)
\_\_irq\_exit\_rcu (kernel/softirq.c:589 kernel/softirq.c:428 kernel/softirq.c:637)
irq\_exit\_rcu (kernel/softirq.c:651)
sysvec\_apic\_timer\_interrupt (arch/x86/kernel/apic/apic.c:1049 arch/x86/kernel/apic/apic.c:1049)
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt (./arch/x86/include/asm/idtentry.h:702)
RIP: 0010:default\_idle (./arch/x86/include/asm/irqflags.h:37 ./arch/x86/include/asm/irqflags.h:92 arch/x86/kernel/process.c:743)
Code: 00 4d 29 c8 4c 01 c7 4c 29 c2 e9 6e ff ff ff 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 66 90 0f 00 2d c7 c9 27 00 fb f4 <fa> c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 90
RSP: 0018:ffff888100d2fe00 EFLAGS: 00000246
RAX: 00000000001870ed RBX: 1ffff110201a5fc2 RCX: ffffffffb61a3e46
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffffffffb3d4d123
RBP: 0000000000000000 R08: 0000000000000001 R09: ffffed11c7e1835d
R10: ffff888e3f0c1aeb R11: 0000000000000000 R12: 0000000000000000
R13: ffff888100d20000 R14: dffffc0000000000 R15: 0000000000000000
? ct\_kernel\_exit.constprop.0 (kernel/context\_tracking.c:148)
? cpuidle\_idle\_call (kernel/sched/idle.c:186)
default\_idle\_call (./include/linux/cpuidle.h:143 kernel/sched/idle.c:118)
cpuidle\_idle\_call (kernel/sched/idle.c:186)
? \_\_pfx\_cpuidle\_idle\_call (kernel/sched/idle.c:168)
? lock\_release (kernel/locking/lockdep.c:467 kernel/locking/lockdep.c:5848)
? lockdep\_hardirqs\_on\_prepare (kernel/locking/lockdep.c:4347 kernel/locking/lockdep.c:4406)
? tsc\_verify\_tsc\_adjust (arch/x86/kernel/tsc\_sync.c:59)
do\_idle (kernel/sched/idle.c:326)
cpu\_startup\_entry (kernel/sched/idle.c:423 (discriminator 1))
start\_secondary (arch/x86/kernel/smpboot.c:202 arch/x86/kernel/smpboot.c:282)
? \_\_pfx\_start\_secondary (arch/x86/kernel/smpboot.c:232)
? soft\_restart\_cpu (arch/x86/kernel/head\_64.S:452)
common\_startup\_64 (arch/x86/kernel/head\_64.S:414)
</TASK>
Dec 03 05:46:18 kernel:
Allocated by task 12184:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (./arch/x86/include/asm/current.h:49 mm/kasan/common.c:60 mm/kasan/common.c:69)
\_\_kasan\_slab\_alloc (mm/kasan/common.c:319 mm/kasan/common.c:345)
kmem\_cache\_alloc\_noprof (mm/slub.c:4085 mm/slub.c:4134 mm/slub.c:4141)
copy\_net\_ns (net/core/net\_namespace.c:421 net/core/net\_namespace.c:480)
create\_new\_namespaces (kernel/nsproxy.c:110)
unshare\_nsproxy\_namespaces (kernel/nsproxy.c:228 (discriminator 4))
ksys\_unshare (kernel/fork.c:3313)
\_\_x64\_sys\_unshare (kernel/fork.c:3382)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Dec 03 05:46:18 kernel:
Freed by task 11:
kasan\_save\_stack (mm/kasan/common.c:48)
kasan\_save\_track (./arch/x86/include/asm/current.h:49 mm/kasan/common.c:60 mm/kasan/common.c:69)
kasan\_save\_free\_info (mm/kasan/generic.c:582)
\_\_kasan\_slab\_free (mm/kasan/common.c:271)
kmem\_cache\_free (mm/slub.c:4579 mm/slub.c:4681)
cleanup\_net (net/core/net\_namespace.c:456 net/core/net\_namespace.c:446 net/core/net\_namespace.c:647)
process\_one\_work (kernel/workqueue.c:3229)
worker\_thread (kernel/workqueue.c:3304 kernel/workqueue.c:3391)
kthread (kernel/kthread.c:389)
ret\_from\_fork (arch/x86/kernel/process.c:147)
ret\_from\_fork\_asm (arch/x86/entry/entry\_64.S:257)
Dec 03 05:46:18 kernel:
Last potentially related work creation:
kasan\_save\_stack (mm/kasan/common.c:48)
\_\_kasan\_record\_aux\_stack (mm/kasan/generic.c:541)
insert\_work (./include/linux/instrumented.h:68 ./include/asm-generic/bitops/instrumented-non-atomic.h:141 kernel/workqueue.c:788 kernel/workqueue.c:795 kernel/workqueue.c:2186)
\_\_queue\_work (kernel/workqueue.c:2340)
queue\_work\_on (kernel/workqueue.c:2391)
xfrm\_policy\_insert (net/xfrm/xfrm\_policy.c:1610)
xfrm\_add\_policy (net/xfrm/xfrm\_user.c:2116)
xfrm\_user\_rcv\_msg (net/xfrm/xfrm\_user.c:3321)
netlink\_rcv\_skb (net/netlink/af\_netlink.c:2536)
xfrm\_netlink\_rcv (net/xfrm/xfrm\_user.c:3344)
netlink\_unicast (net/netlink/af\_netlink.c:1316 net/netlink/af\_netlink.c:1342)
netlink\_sendmsg (net/netlink/af\_netlink.c:1886)
sock\_write\_iter (net/socket.c:729 net/socket.c:744 net/socket.c:1165)
vfs\_write (fs/read\_write.c:590 fs/read\_write.c:683)
ksys\_write (fs/read\_write.c:736)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Dec 03 05:46:18 kernel:
Second to last potentially related work creation:
kasan\_save\_stack (mm/kasan/common.c:48)
\_\_kasan\_record\_aux\_stack (mm/kasan/generic.c:541)
insert\_work (./include/linux/instrumented.h:68 ./include/asm-generic/bitops/instrumented-non-atomic.h:141 kernel/workqueue.c:788 kernel/workqueue.c:795 kernel/workqueue.c:2186)
\_\_queue\_work (kernel/workqueue.c:2340)
queue\_work\_on (kernel/workqueue.c:2391)
\_\_xfrm\_state\_insert (./include/linux/workqueue.h:723 net/xfrm/xfrm\_state.c:1150 net/xfrm/xfrm\_state.c:1145 net/xfrm/xfrm\_state.c:1513)
xfrm\_state\_update (./include/linux/spinlock.h:396 net/xfrm/xfrm\_state.c:1940)
xfrm\_add\_sa (net/xfrm/xfrm\_user.c:912)
xfrm\_user\_rcv\_msg (net/xfrm/xfrm\_user.c:3321)
netlink\_rcv\_skb (net/netlink/af\_netlink.c:2536)
xfrm\_netlink\_rcv (net/xfrm/xfrm\_user.c:3344)
netlink\_unicast (net/netlink/af\_netlink.c:1316 net/netlink/af\_netlink.c:1342)
netlink\_sendmsg (net/netlink/af\_netlink.c:1886)
sock\_write\_iter (net/socket.c:729 net/socket.c:744 net/socket.c:1165)
vfs\_write (fs/read\_write.c:590 fs/read\_write.c:683)
ksys\_write (fs/read\_write.c:736)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fixes: a8a572a6b5f2 ("xfrm: dst\_entries\_init() per-net dst\_ops")
Reported-by: Ilya Maximets <i.maximets@ovn.org>
Closes: https://lore.kernel.org/netdev/CANn89iKKYDVpB=MtmfH7nyv2p=rJWSLedO5k7wSZgtY\_tO8WQg@mail.gmail.com/T/#m02c98c3009fe66382b73cfb4db9cf1df6fab3fbf
Signed-off-by: Eric Dumazet <edumazet@google.com>
Acked-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://patch.msgid.link/20241204125455.3871859-1-edumazet@google.com](https://patch.msgid.link/20241204125455.3871859-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5)

| -rw-r--r-- | [include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/net_namespace.h?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/net_namespace.c?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5) | 21 | |  |  |  | | --- | --- | --- | |

2 files changed, 21 insertions, 1 deletions

| diff --git a/include/net/net\_namespace.h b/include/net/net\_namespace.hindex 8c3587d5c308f0..7ca4b7af57ca6e 100644--- a/[include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/net_namespace.h?id=f0949199651bc87c5ed2c12a7323f441f1af6fe9)+++ b/[include/net/net\_namespace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/net_namespace.h?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5)@@ -81,6 +81,7 @@ struct net { \* or to unregister pernet ops \* (pernet\_ops\_rwsem write locked). \*/+ struct llist\_node defer\_free\_list; struct llist\_node cleanup\_list; /\* namespaces on death row \*/  #ifdef CONFIG\_KEYSdiff --git a/net/core/net\_namespace.c b/net/core/net\_namespace.cindex 1d95a5adce4ec4..6c6d2a785c0049 100644--- a/[net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/net_namespace.c?id=f0949199651bc87c5ed2c12a7323f441f1af6fe9)+++ b/[net/core/net\_namespace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/net_namespace.c?id=3267b254dc0a04dfa362a2be24573cfa6d2d78f5)@@ -435,11 +435,28 @@ out\_free: goto out; } +static LLIST\_HEAD(defer\_free\_list);++static void net\_complete\_free(void)+{+ struct llist\_node \*kill\_list;+ struct net \*net, \*next;++ /\* Get the list of namespaces to free from last round. \*/+ kill\_list = llist\_del\_all(&defer\_free\_list);++ llist\_for\_each\_entry\_safe(net, next, kill\_list, defer\_free\_list)+ kmem\_cache\_free(net\_cachep, net);++}+ static void net\_free(struct net \*net) { if (refcount\_dec\_and\_test(&net->passive)) { kfree(rcu\_access\_pointer(net->gen));- kmem\_cache\_free(net\_cachep, net);++ /\* Wait for an extra rcu\_barrier() before final free. \*/+ llist\_add(&net->defer\_free\_list, &defer\_free\_list); } } @@ -614,6 +631,8 @@ static void cleanup\_net(struct work\_struct \*work) \*/ rcu\_barrier(); + net\_complete\_free();+ /\* Finally it is safe to free my network namespace structure \*/ list\_for\_each\_entry\_safe(net, tmp, &net\_exit\_list, exit\_list) { list\_del\_init(&net->exit\_list); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:12:06 +0000


