=== Content from git.kernel.org_d5e45b57_20250114_224632.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b718b68a9964181e24d15138a09ce95785a19002)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b718b68a9964181e24d15138a09ce95785a19002)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b718b68a9964181e24d15138a09ce95785a19002)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b718b68a9964181e24d15138a09ce95785a19002)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wei Fang <wei.fang@nxp.com> | 2024-11-25 17:07:19 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:03 +0100 |
| commit | [b718b68a9964181e24d15138a09ce95785a19002](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b718b68a9964181e24d15138a09ce95785a19002) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b718b68a9964181e24d15138a09ce95785a19002)) | |
| tree | [4e2734ff0646e9ce5bead15e58abeb35e0e478e8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b718b68a9964181e24d15138a09ce95785a19002) | |
| parent | [5bf92a924f1fd173b805b4c0ed78c73e14362cee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5bf92a924f1fd173b805b4c0ed78c73e14362cee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b718b68a9964181e24d15138a09ce95785a19002&id2=5bf92a924f1fd173b805b4c0ed78c73e14362cee)) | |
| download | [linux-b718b68a9964181e24d15138a09ce95785a19002.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b718b68a9964181e24d15138a09ce95785a19002.tar.gz) | |

net: enetc: Do not configure preemptible TCs if SIs do not support[ Upstream commit b2420b8c81ec674552d00c55d46245e5c184b260 ]
Both ENETC PF and VF drivers share enetc\_setup\_tc\_mqprio() to configure
MQPRIO. And enetc\_setup\_tc\_mqprio() calls enetc\_change\_preemptible\_tcs()
to configure preemptible TCs. However, only PF is able to configure
preemptible TCs. Because only PF has related registers, while VF does not
have these registers. So for VF, its hw->port pointer is NULL. Therefore,
VF will access an invalid pointer when accessing a non-existent register,
which will cause a crash issue. The simplified log is as follows.
root@ls1028ardb:~# tc qdisc add dev eno0vf0 parent root handle 100: \
mqprio num\_tc 4 map 0 0 1 1 2 2 3 3 queues 1@0 1@1 1@2 1@3 hw 1
[ 187.290775] Unable to handle kernel paging request at virtual address 0000000000001f00
[ 187.424831] pc : enetc\_mm\_commit\_preemptible\_tcs+0x1c4/0x400
[ 187.430518] lr : enetc\_mm\_commit\_preemptible\_tcs+0x30c/0x400
[ 187.511140] Call trace:
[ 187.513588] enetc\_mm\_commit\_preemptible\_tcs+0x1c4/0x400
[ 187.518918] enetc\_setup\_tc\_mqprio+0x180/0x214
[ 187.523374] enetc\_vf\_setup\_tc+0x1c/0x30
[ 187.527306] mqprio\_enable\_offload+0x144/0x178
[ 187.531766] mqprio\_init+0x3ec/0x668
[ 187.535351] qdisc\_create+0x15c/0x488
[ 187.539023] tc\_modify\_qdisc+0x398/0x73c
[ 187.542958] rtnetlink\_rcv\_msg+0x128/0x378
[ 187.547064] netlink\_rcv\_skb+0x60/0x130
[ 187.550910] rtnetlink\_rcv+0x18/0x24
[ 187.554492] netlink\_unicast+0x300/0x36c
[ 187.558425] netlink\_sendmsg+0x1a8/0x420
[ 187.606759] ---[ end trace 0000000000000000 ]---
In addition, some PFs also do not support configuring preemptible TCs,
such as eno1 and eno3 on LS1028A. It won't crash like it does for VFs,
but we should prevent these PFs from accessing these unimplemented
registers.
Fixes: 827145392a4a ("net: enetc: only commit preemptible TCs to hardware when MM TX is active")
Signed-off-by: Wei Fang <wei.fang@nxp.com>
Suggested-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Frank Li <Frank.Li@nxp.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b718b68a9964181e24d15138a09ce95785a19002)

| -rw-r--r-- | [drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/enetc/enetc.c?id=b718b68a9964181e24d15138a09ce95785a19002) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.cindex c09370eab319b2..16a7908c79f703 100644--- a/[drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc.c?id=5bf92a924f1fd173b805b4c0ed78c73e14362cee)+++ b/[drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc.c?id=b718b68a9964181e24d15138a09ce95785a19002)@@ -28,6 +28,9 @@ EXPORT\_SYMBOL\_GPL(enetc\_port\_mac\_wr); static void enetc\_change\_preemptible\_tcs(struct enetc\_ndev\_priv \*priv, u8 preemptible\_tcs) {+ if (!(priv->si->hw\_features & ENETC\_SI\_F\_QBU))+ return;+ priv->preemptible\_tcs = preemptible\_tcs; enetc\_mm\_commit\_preemptible\_tcs(priv); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:45:09 +0000



=== Content from git.kernel.org_0237a6d7_20250114_224631.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b2420b8c81ec674552d00c55d46245e5c184b260)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b2420b8c81ec674552d00c55d46245e5c184b260)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2420b8c81ec674552d00c55d46245e5c184b260)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2420b8c81ec674552d00c55d46245e5c184b260)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wei Fang <wei.fang@nxp.com> | 2024-11-25 17:07:19 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2024-11-29 12:52:04 +0000 |
| commit | [b2420b8c81ec674552d00c55d46245e5c184b260](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2420b8c81ec674552d00c55d46245e5c184b260) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b2420b8c81ec674552d00c55d46245e5c184b260)) | |
| tree | [e5cd439ab13722cfc844a1b6271d42a6873ca6a6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b2420b8c81ec674552d00c55d46245e5c184b260) | |
| parent | [8e00072c31e28e7de1ffd9b28c773a3143aa4167](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e00072c31e28e7de1ffd9b28c773a3143aa4167) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2420b8c81ec674552d00c55d46245e5c184b260&id2=8e00072c31e28e7de1ffd9b28c773a3143aa4167)) | |
| download | [linux-b2420b8c81ec674552d00c55d46245e5c184b260.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b2420b8c81ec674552d00c55d46245e5c184b260.tar.gz) | |

net: enetc: Do not configure preemptible TCs if SIs do not supportBoth ENETC PF and VF drivers share enetc\_setup\_tc\_mqprio() to configure
MQPRIO. And enetc\_setup\_tc\_mqprio() calls enetc\_change\_preemptible\_tcs()
to configure preemptible TCs. However, only PF is able to configure
preemptible TCs. Because only PF has related registers, while VF does not
have these registers. So for VF, its hw->port pointer is NULL. Therefore,
VF will access an invalid pointer when accessing a non-existent register,
which will cause a crash issue. The simplified log is as follows.
root@ls1028ardb:~# tc qdisc add dev eno0vf0 parent root handle 100: \
mqprio num\_tc 4 map 0 0 1 1 2 2 3 3 queues 1@0 1@1 1@2 1@3 hw 1
[ 187.290775] Unable to handle kernel paging request at virtual address 0000000000001f00
[ 187.424831] pc : enetc\_mm\_commit\_preemptible\_tcs+0x1c4/0x400
[ 187.430518] lr : enetc\_mm\_commit\_preemptible\_tcs+0x30c/0x400
[ 187.511140] Call trace:
[ 187.513588] enetc\_mm\_commit\_preemptible\_tcs+0x1c4/0x400
[ 187.518918] enetc\_setup\_tc\_mqprio+0x180/0x214
[ 187.523374] enetc\_vf\_setup\_tc+0x1c/0x30
[ 187.527306] mqprio\_enable\_offload+0x144/0x178
[ 187.531766] mqprio\_init+0x3ec/0x668
[ 187.535351] qdisc\_create+0x15c/0x488
[ 187.539023] tc\_modify\_qdisc+0x398/0x73c
[ 187.542958] rtnetlink\_rcv\_msg+0x128/0x378
[ 187.547064] netlink\_rcv\_skb+0x60/0x130
[ 187.550910] rtnetlink\_rcv+0x18/0x24
[ 187.554492] netlink\_unicast+0x300/0x36c
[ 187.558425] netlink\_sendmsg+0x1a8/0x420
[ 187.606759] ---[ end trace 0000000000000000 ]---
In addition, some PFs also do not support configuring preemptible TCs,
such as eno1 and eno3 on LS1028A. It won't crash like it does for VFs,
but we should prevent these PFs from accessing these unimplemented
registers.
Fixes: 827145392a4a ("net: enetc: only commit preemptible TCs to hardware when MM TX is active")
Signed-off-by: Wei Fang <wei.fang@nxp.com>
Suggested-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Frank Li <Frank.Li@nxp.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2420b8c81ec674552d00c55d46245e5c184b260)

| -rw-r--r-- | [drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/enetc/enetc.c?id=b2420b8c81ec674552d00c55d46245e5c184b260) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.cindex bece220535a1a4..535969fa0fdbef 100644--- a/[drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc.c?id=8e00072c31e28e7de1ffd9b28c773a3143aa4167)+++ b/[drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc.c?id=b2420b8c81ec674552d00c55d46245e5c184b260)@@ -29,6 +29,9 @@ EXPORT\_SYMBOL\_GPL(enetc\_port\_mac\_wr); static void enetc\_change\_preemptible\_tcs(struct enetc\_ndev\_priv \*priv, u8 preemptible\_tcs) {+ if (!(priv->si->hw\_features & ENETC\_SI\_F\_QBU))+ return;+ priv->preemptible\_tcs = preemptible\_tcs; enetc\_mm\_commit\_preemptible\_tcs(priv); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:45:08 +0000



=== Content from git.kernel.org_24831509_20250114_224631.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wei Fang <wei.fang@nxp.com> | 2024-11-25 17:07:19 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:34 +0100 |
| commit | [66127f0d1ecf00604aeab71132bde398fd9ec7c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9)) | |
| tree | [e68a8c3dd6ad08409663fdd3681691fc1fe32cc2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9) | |
| parent | [ea8e9f84ea15ac066ff2338b331ace80f1fb78ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea8e9f84ea15ac066ff2338b331ace80f1fb78ea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9&id2=ea8e9f84ea15ac066ff2338b331ace80f1fb78ea)) | |
| download | [linux-66127f0d1ecf00604aeab71132bde398fd9ec7c9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-66127f0d1ecf00604aeab71132bde398fd9ec7c9.tar.gz) | |

net: enetc: Do not configure preemptible TCs if SIs do not support[ Upstream commit b2420b8c81ec674552d00c55d46245e5c184b260 ]
Both ENETC PF and VF drivers share enetc\_setup\_tc\_mqprio() to configure
MQPRIO. And enetc\_setup\_tc\_mqprio() calls enetc\_change\_preemptible\_tcs()
to configure preemptible TCs. However, only PF is able to configure
preemptible TCs. Because only PF has related registers, while VF does not
have these registers. So for VF, its hw->port pointer is NULL. Therefore,
VF will access an invalid pointer when accessing a non-existent register,
which will cause a crash issue. The simplified log is as follows.
root@ls1028ardb:~# tc qdisc add dev eno0vf0 parent root handle 100: \
mqprio num\_tc 4 map 0 0 1 1 2 2 3 3 queues 1@0 1@1 1@2 1@3 hw 1
[ 187.290775] Unable to handle kernel paging request at virtual address 0000000000001f00
[ 187.424831] pc : enetc\_mm\_commit\_preemptible\_tcs+0x1c4/0x400
[ 187.430518] lr : enetc\_mm\_commit\_preemptible\_tcs+0x30c/0x400
[ 187.511140] Call trace:
[ 187.513588] enetc\_mm\_commit\_preemptible\_tcs+0x1c4/0x400
[ 187.518918] enetc\_setup\_tc\_mqprio+0x180/0x214
[ 187.523374] enetc\_vf\_setup\_tc+0x1c/0x30
[ 187.527306] mqprio\_enable\_offload+0x144/0x178
[ 187.531766] mqprio\_init+0x3ec/0x668
[ 187.535351] qdisc\_create+0x15c/0x488
[ 187.539023] tc\_modify\_qdisc+0x398/0x73c
[ 187.542958] rtnetlink\_rcv\_msg+0x128/0x378
[ 187.547064] netlink\_rcv\_skb+0x60/0x130
[ 187.550910] rtnetlink\_rcv+0x18/0x24
[ 187.554492] netlink\_unicast+0x300/0x36c
[ 187.558425] netlink\_sendmsg+0x1a8/0x420
[ 187.606759] ---[ end trace 0000000000000000 ]---
In addition, some PFs also do not support configuring preemptible TCs,
such as eno1 and eno3 on LS1028A. It won't crash like it does for VFs,
but we should prevent these PFs from accessing these unimplemented
registers.
Fixes: 827145392a4a ("net: enetc: only commit preemptible TCs to hardware when MM TX is active")
Signed-off-by: Wei Fang <wei.fang@nxp.com>
Suggested-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Frank Li <Frank.Li@nxp.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9)

| -rw-r--r-- | [drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/enetc/enetc.c?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.cindex c17b9e3385168f..87b27bd7a13bb1 100644--- a/[drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc.c?id=ea8e9f84ea15ac066ff2338b331ace80f1fb78ea)+++ b/[drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc.c?id=66127f0d1ecf00604aeab71132bde398fd9ec7c9)@@ -28,6 +28,9 @@ EXPORT\_SYMBOL\_GPL(enetc\_port\_mac\_wr); static void enetc\_change\_preemptible\_tcs(struct enetc\_ndev\_priv \*priv, u8 preemptible\_tcs) {+ if (!(priv->si->hw\_features & ENETC\_SI\_F\_QBU))+ return;+ priv->preemptible\_tcs = preemptible\_tcs; enetc\_mm\_commit\_preemptible\_tcs(priv); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:45:08 +0000


