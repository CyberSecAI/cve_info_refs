=== Content from git.kernel.org_bce0707d_20250115_094532.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7cf0bd232b565d9852cb25fd094f77254773e048)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7cf0bd232b565d9852cb25fd094f77254773e048)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7cf0bd232b565d9852cb25fd094f77254773e048)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cf0bd232b565d9852cb25fd094f77254773e048)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-12-07 12:14:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:13:18 +0100 |
| commit | [7cf0bd232b565d9852cb25fd094f77254773e048](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7cf0bd232b565d9852cb25fd094f77254773e048) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7cf0bd232b565d9852cb25fd094f77254773e048)) | |
| tree | [663d3b5ce8c820cbc828d05f8be42912fb8fc12f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7cf0bd232b565d9852cb25fd094f77254773e048) | |
| parent | [45fe76573a2557f632e248cc141342233f422b9a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=45fe76573a2557f632e248cc141342233f422b9a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cf0bd232b565d9852cb25fd094f77254773e048&id2=45fe76573a2557f632e248cc141342233f422b9a)) | |
| download | [linux-7cf0bd232b565d9852cb25fd094f77254773e048.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7cf0bd232b565d9852cb25fd094f77254773e048.tar.gz) | |

netfilter: nf\_tables: do not defer rule destruction via call\_rcu[ Upstream commit b04df3da1b5c6f6dc7cdccc37941740c078c4043 ]
nf\_tables\_chain\_destroy can sleep, it can't be used from call\_rcu
callbacks.
Moreover, nf\_tables\_rule\_release() is only safe for error unwinding,
while transaction mutex is held and the to-be-desroyed rule was not
exposed to either dataplane or dumps, as it deactives+frees without
the required synchronize\_rcu() in-between.
nft\_rule\_expr\_deactivate() callbacks will change ->use counters
of other chains/sets, see e.g. nft\_lookup .deactivate callback, these
must be serialized via transaction mutex.
Also add a few lockdep asserts to make this more explicit.
Calling synchronize\_rcu() isn't ideal, but fixing this without is hard
and way more intrusive. As-is, we can get:
WARNING: .. net/netfilter/nf\_tables\_api.c:5515 nft\_set\_destroy+0x..
Workqueue: events nf\_tables\_trans\_destroy\_work
RIP: 0010:nft\_set\_destroy+0x3fe/0x5c0
Call Trace:
<TASK>
nf\_tables\_trans\_destroy\_work+0x6b7/0xad0
process\_one\_work+0x64a/0xce0
worker\_thread+0x613/0x10d0
In case the synchronize\_rcu becomes an issue, we can explore alternatives.
One way would be to allocate nft\_trans\_rule objects + one nft\_trans\_chain
object, deactivate the rules + the chain and then defer the freeing to the
nft destroy workqueue. We'd still need to keep the synchronize\_rcu path as
a fallback to handle -ENOMEM corner cases though.
Reported-by: syzbot+b26935466701e56cfdc2@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/67478d92.050a0220.253251.0062.GAE@google.com/T/
Fixes: c03d278fdf35 ("netfilter: nf\_tables: wait for rcu grace period on net\_device removal")
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7cf0bd232b565d9852cb25fd094f77254773e048)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=7cf0bd232b565d9852cb25fd094f77254773e048) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=7cf0bd232b565d9852cb25fd094f77254773e048) | 32 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 21 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 066a3ea33b12e9..91ae20cb76485b 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=45fe76573a2557f632e248cc141342233f422b9a)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=7cf0bd232b565d9852cb25fd094f77254773e048)@@ -1103,7 +1103,6 @@ struct nft\_rule\_blob { \* @name: name of the chain \* @udlen: user data length \* @udata: user data in the chain- \* @rcu\_head: rcu head for deferred release \* @blob\_next: rule blob pointer to the next in the chain \*/ struct nft\_chain {@@ -1121,7 +1120,6 @@ struct nft\_chain { char \*name; u16 udlen; u8 \*udata;- struct rcu\_head rcu\_head;  /\* Only used during control plane commit phase: \*/ struct nft\_rule\_blob \*blob\_next;@@ -1265,7 +1263,6 @@ static inline void nft\_use\_inc\_restore(u32 \*use) \* @sets: sets in the table \* @objects: stateful objects in the table \* @flowtables: flow tables in the table- \* @net: netnamespace this table belongs to \* @hgenerator: handle generator state \* @handle: table handle \* @use: number of chain references to this table@@ -1285,7 +1282,6 @@ struct nft\_table { struct list\_head sets; struct list\_head objects; struct list\_head flowtables;- possible\_net\_t net; u64 hgenerator; u64 handle; u32 use;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 4a137afaf0b87e..0c5ff4afc37022 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=45fe76573a2557f632e248cc141342233f422b9a)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=7cf0bd232b565d9852cb25fd094f77254773e048)@@ -1495,7 +1495,6 @@ static int nf\_tables\_newtable(struct sk\_buff \*skb, const struct nfnl\_info \*info, INIT\_LIST\_HEAD(&table->sets); INIT\_LIST\_HEAD(&table->objects); INIT\_LIST\_HEAD(&table->flowtables);- write\_pnet(&table->net, net); table->family = family; table->flags = flags; table->handle = ++nft\_net->table\_handle;@@ -3884,8 +3883,11 @@ void nf\_tables\_rule\_destroy(const struct nft\_ctx \*ctx, struct nft\_rule \*rule) kfree(rule); } +/\* can only be used if rule is no longer visible to dumps \*/ static void nf\_tables\_rule\_release(const struct nft\_ctx \*ctx, struct nft\_rule \*rule) {+ lockdep\_commit\_lock\_is\_held(ctx->net);+ nft\_rule\_expr\_deactivate(ctx, rule, NFT\_TRANS\_RELEASE); nf\_tables\_rule\_destroy(ctx, rule); }@@ -5650,6 +5652,8 @@ void nf\_tables\_deactivate\_set(const struct nft\_ctx \*ctx, struct nft\_set \*set, struct nft\_set\_binding \*binding, enum nft\_trans\_phase phase) {+ lockdep\_commit\_lock\_is\_held(ctx->net);+ switch (phase) { case NFT\_TRANS\_PREPARE\_ERROR: nft\_set\_trans\_unbind(ctx, set);@@ -11456,19 +11460,6 @@ static void \_\_nft\_release\_basechain\_now(struct nft\_ctx \*ctx) nf\_tables\_chain\_destroy(ctx->chain); } -static void nft\_release\_basechain\_rcu(struct rcu\_head \*head)-{- struct nft\_chain \*chain = container\_of(head, struct nft\_chain, rcu\_head);- struct nft\_ctx ctx = {- .family = chain->table->family,- .chain = chain,- .net = read\_pnet(&chain->table->net),- };-- \_\_nft\_release\_basechain\_now(&ctx);- put\_net(ctx.net);-}- int \_\_nft\_release\_basechain(struct nft\_ctx \*ctx) { struct nft\_rule \*rule;@@ -11483,11 +11474,18 @@ int \_\_nft\_release\_basechain(struct nft\_ctx \*ctx) nft\_chain\_del(ctx->chain); nft\_use\_dec(&ctx->table->use); - if (maybe\_get\_net(ctx->net))- call\_rcu(&ctx->chain->rcu\_head, nft\_release\_basechain\_rcu);- else+ if (!maybe\_get\_net(ctx->net)) { \_\_nft\_release\_basechain\_now(ctx);+ return 0;+ }++ /\* wait for ruleset dumps to complete. Owning chain is no longer in+ \* lists, so new dumps can't find any of these rules anymore.+ \*/+ synchronize\_rcu(); + \_\_nft\_release\_basechain\_now(ctx);+ put\_net(ctx->net); return 0; } EXPORT\_SYMBOL\_GPL(\_\_nft\_release\_basechain); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:44:09 +0000



=== Content from git.kernel.org_b35da33a_20250115_094531.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-12-07 12:14:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:11:32 +0100 |
| commit | [27f0574253f6c24c8ee4e3f0a685b75ed3a256ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed)) | |
| tree | [912e568b2ef922d841a9584ae243e3c67c866413](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed) | |
| parent | [8c2c8445cda8f59c38dec7dc10509bcb23ae26a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c2c8445cda8f59c38dec7dc10509bcb23ae26a0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed&id2=8c2c8445cda8f59c38dec7dc10509bcb23ae26a0)) | |
| download | [linux-27f0574253f6c24c8ee4e3f0a685b75ed3a256ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-27f0574253f6c24c8ee4e3f0a685b75ed3a256ed.tar.gz) | |

netfilter: nf\_tables: do not defer rule destruction via call\_rcu[ Upstream commit b04df3da1b5c6f6dc7cdccc37941740c078c4043 ]
nf\_tables\_chain\_destroy can sleep, it can't be used from call\_rcu
callbacks.
Moreover, nf\_tables\_rule\_release() is only safe for error unwinding,
while transaction mutex is held and the to-be-desroyed rule was not
exposed to either dataplane or dumps, as it deactives+frees without
the required synchronize\_rcu() in-between.
nft\_rule\_expr\_deactivate() callbacks will change ->use counters
of other chains/sets, see e.g. nft\_lookup .deactivate callback, these
must be serialized via transaction mutex.
Also add a few lockdep asserts to make this more explicit.
Calling synchronize\_rcu() isn't ideal, but fixing this without is hard
and way more intrusive. As-is, we can get:
WARNING: .. net/netfilter/nf\_tables\_api.c:5515 nft\_set\_destroy+0x..
Workqueue: events nf\_tables\_trans\_destroy\_work
RIP: 0010:nft\_set\_destroy+0x3fe/0x5c0
Call Trace:
<TASK>
nf\_tables\_trans\_destroy\_work+0x6b7/0xad0
process\_one\_work+0x64a/0xce0
worker\_thread+0x613/0x10d0
In case the synchronize\_rcu becomes an issue, we can explore alternatives.
One way would be to allocate nft\_trans\_rule objects + one nft\_trans\_chain
object, deactivate the rules + the chain and then defer the freeing to the
nft destroy workqueue. We'd still need to keep the synchronize\_rcu path as
a fallback to handle -ENOMEM corner cases though.
Reported-by: syzbot+b26935466701e56cfdc2@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/67478d92.050a0220.253251.0062.GAE@google.com/T/
Fixes: c03d278fdf35 ("netfilter: nf\_tables: wait for rcu grace period on net\_device removal")
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed) | 32 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 21 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 804dcd3a7d8f7e..b5f9ee5810a347 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=8c2c8445cda8f59c38dec7dc10509bcb23ae26a0)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed)@@ -1080,7 +1080,6 @@ struct nft\_rule\_blob { \* @name: name of the chain \* @udlen: user data length \* @udata: user data in the chain- \* @rcu\_head: rcu head for deferred release \* @blob\_next: rule blob pointer to the next in the chain \*/ struct nft\_chain {@@ -1098,7 +1097,6 @@ struct nft\_chain { char \*name; u16 udlen; u8 \*udata;- struct rcu\_head rcu\_head;  /\* Only used during control plane commit phase: \*/ struct nft\_rule\_blob \*blob\_next;@@ -1242,7 +1240,6 @@ static inline void nft\_use\_inc\_restore(u32 \*use) \* @sets: sets in the table \* @objects: stateful objects in the table \* @flowtables: flow tables in the table- \* @net: netnamespace this table belongs to \* @hgenerator: handle generator state \* @handle: table handle \* @use: number of chain references to this table@@ -1259,7 +1256,6 @@ struct nft\_table { struct list\_head sets; struct list\_head objects; struct list\_head flowtables;- possible\_net\_t net; u64 hgenerator; u64 handle; u32 use;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex eee7997048fb97..a110aad45fe487 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=8c2c8445cda8f59c38dec7dc10509bcb23ae26a0)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=27f0574253f6c24c8ee4e3f0a685b75ed3a256ed)@@ -1431,7 +1431,6 @@ static int nf\_tables\_newtable(struct sk\_buff \*skb, const struct nfnl\_info \*info, INIT\_LIST\_HEAD(&table->sets); INIT\_LIST\_HEAD(&table->objects); INIT\_LIST\_HEAD(&table->flowtables);- write\_pnet(&table->net, net); table->family = family; table->flags = flags; table->handle = ++nft\_net->table\_handle;@@ -3784,8 +3783,11 @@ void nf\_tables\_rule\_destroy(const struct nft\_ctx \*ctx, struct nft\_rule \*rule) kfree(rule); } +/\* can only be used if rule is no longer visible to dumps \*/ static void nf\_tables\_rule\_release(const struct nft\_ctx \*ctx, struct nft\_rule \*rule) {+ lockdep\_commit\_lock\_is\_held(ctx->net);+ nft\_rule\_expr\_deactivate(ctx, rule, NFT\_TRANS\_RELEASE); nf\_tables\_rule\_destroy(ctx, rule); }@@ -5561,6 +5563,8 @@ void nf\_tables\_deactivate\_set(const struct nft\_ctx \*ctx, struct nft\_set \*set, struct nft\_set\_binding \*binding, enum nft\_trans\_phase phase) {+ lockdep\_commit\_lock\_is\_held(ctx->net);+ switch (phase) { case NFT\_TRANS\_PREPARE\_ERROR: nft\_set\_trans\_unbind(ctx, set);@@ -11182,19 +11186,6 @@ static void \_\_nft\_release\_basechain\_now(struct nft\_ctx \*ctx) nf\_tables\_chain\_destroy(ctx->chain); } -static void nft\_release\_basechain\_rcu(struct rcu\_head \*head)-{- struct nft\_chain \*chain = container\_of(head, struct nft\_chain, rcu\_head);- struct nft\_ctx ctx = {- .family = chain->table->family,- .chain = chain,- .net = read\_pnet(&chain->table->net),- };-- \_\_nft\_release\_basechain\_now(&ctx);- put\_net(ctx.net);-}- int \_\_nft\_release\_basechain(struct nft\_ctx \*ctx) { struct nft\_rule \*rule;@@ -11209,11 +11200,18 @@ int \_\_nft\_release\_basechain(struct nft\_ctx \*ctx) nft\_chain\_del(ctx->chain); nft\_use\_dec(&ctx->table->use); - if (maybe\_get\_net(ctx->net))- call\_rcu(&ctx->chain->rcu\_head, nft\_release\_basechain\_rcu);- else+ if (!maybe\_get\_net(ctx->net)) { \_\_nft\_release\_basechain\_now(ctx);+ return 0;+ }++ /\* wait for ruleset dumps to complete. Owning chain is no longer in+ \* lists, so new dumps can't find any of these rules anymore.+ \*/+ synchronize\_rcu(); + \_\_nft\_release\_basechain\_now(ctx);+ put\_net(ctx->net); return 0; } EXPORT\_SYMBOL\_GPL(\_\_nft\_release\_basechain); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:44:08 +0000



=== Content from git.kernel.org_e9db55b1_20250115_094532.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-12-07 12:14:48 +0100 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-12-11 23:27:50 +0100 |
| commit | [b04df3da1b5c6f6dc7cdccc37941740c078c4043](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043)) | |
| tree | [c8a69fefa952cdb51ba7eee1523b7f3ee35b9db1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043) | |
| parent | [f36b01994d68ffc253c8296e2228dfe6e6431c03](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f36b01994d68ffc253c8296e2228dfe6e6431c03) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043&id2=f36b01994d68ffc253c8296e2228dfe6e6431c03)) | |
| download | [linux-b04df3da1b5c6f6dc7cdccc37941740c078c4043.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b04df3da1b5c6f6dc7cdccc37941740c078c4043.tar.gz) | |

netfilter: nf\_tables: do not defer rule destruction via call\_rcunf\_tables\_chain\_destroy can sleep, it can't be used from call\_rcu
callbacks.
Moreover, nf\_tables\_rule\_release() is only safe for error unwinding,
while transaction mutex is held and the to-be-desroyed rule was not
exposed to either dataplane or dumps, as it deactives+frees without
the required synchronize\_rcu() in-between.
nft\_rule\_expr\_deactivate() callbacks will change ->use counters
of other chains/sets, see e.g. nft\_lookup .deactivate callback, these
must be serialized via transaction mutex.
Also add a few lockdep asserts to make this more explicit.
Calling synchronize\_rcu() isn't ideal, but fixing this without is hard
and way more intrusive. As-is, we can get:
WARNING: .. net/netfilter/nf\_tables\_api.c:5515 nft\_set\_destroy+0x..
Workqueue: events nf\_tables\_trans\_destroy\_work
RIP: 0010:nft\_set\_destroy+0x3fe/0x5c0
Call Trace:
<TASK>
nf\_tables\_trans\_destroy\_work+0x6b7/0xad0
process\_one\_work+0x64a/0xce0
worker\_thread+0x613/0x10d0
In case the synchronize\_rcu becomes an issue, we can explore alternatives.
One way would be to allocate nft\_trans\_rule objects + one nft\_trans\_chain
object, deactivate the rules + the chain and then defer the freeing to the
nft destroy workqueue. We'd still need to keep the synchronize\_rcu path as
a fallback to handle -ENOMEM corner cases though.
Reported-by: syzbot+b26935466701e56cfdc2@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/67478d92.050a0220.253251.0062.GAE@google.com/T/
Fixes: c03d278fdf35 ("netfilter: nf\_tables: wait for rcu grace period on net\_device removal")
Signed-off-by: Florian Westphal <fw@strlen.de>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043) | 32 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 21 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 80a537ac26cd2f..4afa64c813045f 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=f36b01994d68ffc253c8296e2228dfe6e6431c03)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043)@@ -1103,7 +1103,6 @@ struct nft\_rule\_blob { \* @name: name of the chain \* @udlen: user data length \* @udata: user data in the chain- \* @rcu\_head: rcu head for deferred release \* @blob\_next: rule blob pointer to the next in the chain \*/ struct nft\_chain {@@ -1121,7 +1120,6 @@ struct nft\_chain { char \*name; u16 udlen; u8 \*udata;- struct rcu\_head rcu\_head;  /\* Only used during control plane commit phase: \*/ struct nft\_rule\_blob \*blob\_next;@@ -1265,7 +1263,6 @@ static inline void nft\_use\_inc\_restore(u32 \*use) \* @sets: sets in the table \* @objects: stateful objects in the table \* @flowtables: flow tables in the table- \* @net: netnamespace this table belongs to \* @hgenerator: handle generator state \* @handle: table handle \* @use: number of chain references to this table@@ -1285,7 +1282,6 @@ struct nft\_table { struct list\_head sets; struct list\_head objects; struct list\_head flowtables;- possible\_net\_t net; u64 hgenerator; u64 handle; u32 use;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 21b6f7410a1f54..0b9f1e8dfe49b8 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=f36b01994d68ffc253c8296e2228dfe6e6431c03)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=b04df3da1b5c6f6dc7cdccc37941740c078c4043)@@ -1596,7 +1596,6 @@ static int nf\_tables\_newtable(struct sk\_buff \*skb, const struct nfnl\_info \*info, INIT\_LIST\_HEAD(&table->sets); INIT\_LIST\_HEAD(&table->objects); INIT\_LIST\_HEAD(&table->flowtables);- write\_pnet(&table->net, net); table->family = family; table->flags = flags; table->handle = ++nft\_net->table\_handle;@@ -3987,8 +3986,11 @@ void nf\_tables\_rule\_destroy(const struct nft\_ctx \*ctx, struct nft\_rule \*rule) kfree(rule); } +/\* can only be used if rule is no longer visible to dumps \*/ static void nf\_tables\_rule\_release(const struct nft\_ctx \*ctx, struct nft\_rule \*rule) {+ lockdep\_commit\_lock\_is\_held(ctx->net);+ nft\_rule\_expr\_deactivate(ctx, rule, NFT\_TRANS\_RELEASE); nf\_tables\_rule\_destroy(ctx, rule); }@@ -5757,6 +5759,8 @@ void nf\_tables\_deactivate\_set(const struct nft\_ctx \*ctx, struct nft\_set \*set, struct nft\_set\_binding \*binding, enum nft\_trans\_phase phase) {+ lockdep\_commit\_lock\_is\_held(ctx->net);+ switch (phase) { case NFT\_TRANS\_PREPARE\_ERROR: nft\_set\_trans\_unbind(ctx, set);@@ -11695,19 +11699,6 @@ static void \_\_nft\_release\_basechain\_now(struct nft\_ctx \*ctx) nf\_tables\_chain\_destroy(ctx->chain); } -static void nft\_release\_basechain\_rcu(struct rcu\_head \*head)-{- struct nft\_chain \*chain = container\_of(head, struct nft\_chain, rcu\_head);- struct nft\_ctx ctx = {- .family = chain->table->family,- .chain = chain,- .net = read\_pnet(&chain->table->net),- };-- \_\_nft\_release\_basechain\_now(&ctx);- put\_net(ctx.net);-}- int \_\_nft\_release\_basechain(struct nft\_ctx \*ctx) { struct nft\_rule \*rule;@@ -11722,11 +11713,18 @@ int \_\_nft\_release\_basechain(struct nft\_ctx \*ctx) nft\_chain\_del(ctx->chain); nft\_use\_dec(&ctx->table->use); - if (maybe\_get\_net(ctx->net))- call\_rcu(&ctx->chain->rcu\_head, nft\_release\_basechain\_rcu);- else+ if (!maybe\_get\_net(ctx->net)) { \_\_nft\_release\_basechain\_now(ctx);+ return 0;+ }++ /\* wait for ruleset dumps to complete. Owning chain is no longer in+ \* lists, so new dumps can't find any of these rules anymore.+ \*/+ synchronize\_rcu(); + \_\_nft\_release\_basechain\_now(ctx);+ put\_net(ctx->net); return 0; } EXPORT\_SYMBOL\_GPL(\_\_nft\_release\_basechain); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:44:09 +0000


