=== Content from git.kernel.org_e49728a0_20250115_093518.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1429826883bb18847092b2e04c6598ef34bae1d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1429826883bb18847092b2e04c6598ef34bae1d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1429826883bb18847092b2e04c6598ef34bae1d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1429826883bb18847092b2e04c6598ef34bae1d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stanislaw Gruszka <stanislaw.gruszka@linux.intel.com> | 2024-10-31 11:23:21 +0100 |
| --- | --- | --- |
| committer | Hans Verkuil <hverkuil@xs4all.nl> | 2024-11-07 09:05:58 +0100 |
| commit | [1429826883bb18847092b2e04c6598ef34bae1d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1429826883bb18847092b2e04c6598ef34bae1d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1429826883bb18847092b2e04c6598ef34bae1d4)) | |
| tree | [b0f46756804336a936d56aed44a27aaed15be26a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1429826883bb18847092b2e04c6598ef34bae1d4) | |
| parent | [0a33a4e050acb2b03826021ca46077cb33b5ef64](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a33a4e050acb2b03826021ca46077cb33b5ef64) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1429826883bb18847092b2e04c6598ef34bae1d4&id2=0a33a4e050acb2b03826021ca46077cb33b5ef64)) | |
| download | [linux-1429826883bb18847092b2e04c6598ef34bae1d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1429826883bb18847092b2e04c6598ef34bae1d4.tar.gz) | |

media: intel/ipu6: do not handle interrupts when device is disabledSome IPU6 devices have shared interrupts. We need to handle properly
case when interrupt is triggered from other device on shared irq line
and IPU6 itself disabled. In such case we get 0xffffffff from
ISR\_STATUS register and handle all irq's cases, for what we are not
not prepared and usually hang the whole system.
To avoid the issue use pm\_runtime\_get\_if\_active() to check if
the device is enabled and prevent suspending it when we handle irq
until the end of irq. Additionally use synchronize\_irq() in suspend
Fixes: ab29a2478e70 ("media: intel/ipu6: add IPU6 buttress interface driver")
Cc: stable@vger.kernel.org
Signed-off-by: Stanislaw Gruszka <stanislaw.gruszka@linux.intel.com>
Reviewed-by: Hans de Goede <hdegoede@redhat.com>
Tested-by: Hans de Goede <hdegoede@redhat.com> # ThinkPad X1 Yoga Gen 8, ov2740
Signed-off-by: Sakari Ailus <sakari.ailus@linux.intel.com>
Signed-off-by: Hans Verkuil <hverkuil@xs4all.nl>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1429826883bb18847092b2e04c6598ef34bae1d4)

| -rw-r--r-- | [drivers/media/pci/intel/ipu6/ipu6-buttress.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/pci/intel/ipu6/ipu6-buttress.c?id=1429826883bb18847092b2e04c6598ef34bae1d4) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/pci/intel/ipu6/ipu6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/pci/intel/ipu6/ipu6.c?id=1429826883bb18847092b2e04c6598ef34bae1d4) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/media/pci/intel/ipu6/ipu6-buttress.c b/drivers/media/pci/intel/ipu6/ipu6-buttress.cindex 2cb828c8796131..2e89af845166bf 100644--- a/[drivers/media/pci/intel/ipu6/ipu6-buttress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6-buttress.c?id=0a33a4e050acb2b03826021ca46077cb33b5ef64)+++ b/[drivers/media/pci/intel/ipu6/ipu6-buttress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6-buttress.c?id=1429826883bb18847092b2e04c6598ef34bae1d4)@@ -346,12 +346,16 @@ irqreturn\_t ipu6\_buttress\_isr(int irq, void \*isp\_ptr) u32 disable\_irqs = 0; u32 irq\_status; u32 i, count = 0;+ int active; - pm\_runtime\_get\_noresume(&isp->pdev->dev);+ active = pm\_runtime\_get\_if\_active(&isp->pdev->dev);+ if (!active)+ return IRQ\_NONE;  irq\_status = readl(isp->base + reg\_irq\_sts);- if (!irq\_status) {- pm\_runtime\_put\_noidle(&isp->pdev->dev);+ if (irq\_status == 0 || WARN\_ON\_ONCE(irq\_status == 0xffffffffu)) {+ if (active > 0)+ pm\_runtime\_put\_noidle(&isp->pdev->dev); return IRQ\_NONE; } @@ -427,7 +431,8 @@ irqreturn\_t ipu6\_buttress\_isr(int irq, void \*isp\_ptr) writel(BUTTRESS\_IRQS & ~disable\_irqs, isp->base + BUTTRESS\_REG\_ISR\_ENABLE); - pm\_runtime\_put(&isp->pdev->dev);+ if (active > 0)+ pm\_runtime\_put(&isp->pdev->dev);  return ret; }diff --git a/drivers/media/pci/intel/ipu6/ipu6.c b/drivers/media/pci/intel/ipu6/ipu6.cindex 797d11d1d3b1df..a38292e8eaac40 100644--- a/[drivers/media/pci/intel/ipu6/ipu6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6.c?id=0a33a4e050acb2b03826021ca46077cb33b5ef64)+++ b/[drivers/media/pci/intel/ipu6/ipu6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6.c?id=1429826883bb18847092b2e04c6598ef34bae1d4)@@ -753,6 +753,9 @@ static void ipu6\_pci\_reset\_done(struct pci\_dev \*pdev) \*/ static int ipu6\_suspend(struct device \*dev) {+ struct pci\_dev \*pdev = to\_pci\_dev(dev);++ synchronize\_irq(pdev->irq); return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:33:55 +0000



=== Content from git.kernel.org_376a9f6b_20250115_093518.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=57241487a3648515c9aa6fa89e31f2414eccfdbc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57241487a3648515c9aa6fa89e31f2414eccfdbc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57241487a3648515c9aa6fa89e31f2414eccfdbc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57241487a3648515c9aa6fa89e31f2414eccfdbc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stanislaw Gruszka <stanislaw.gruszka@linux.intel.com> | 2024-10-31 11:23:21 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:56 +0100 |
| commit | [57241487a3648515c9aa6fa89e31f2414eccfdbc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57241487a3648515c9aa6fa89e31f2414eccfdbc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=57241487a3648515c9aa6fa89e31f2414eccfdbc)) | |
| tree | [3b3848a8fdd8247417882d1855b3d74144f921cd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57241487a3648515c9aa6fa89e31f2414eccfdbc) | |
| parent | [80a3b2ee01eecf22dfa06968b3cde92c691dea10](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80a3b2ee01eecf22dfa06968b3cde92c691dea10) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57241487a3648515c9aa6fa89e31f2414eccfdbc&id2=80a3b2ee01eecf22dfa06968b3cde92c691dea10)) | |
| download | [linux-57241487a3648515c9aa6fa89e31f2414eccfdbc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-57241487a3648515c9aa6fa89e31f2414eccfdbc.tar.gz) | |

media: intel/ipu6: do not handle interrupts when device is disabledcommit 1429826883bb18847092b2e04c6598ef34bae1d4 upstream.
Some IPU6 devices have shared interrupts. We need to handle properly
case when interrupt is triggered from other device on shared irq line
and IPU6 itself disabled. In such case we get 0xffffffff from
ISR\_STATUS register and handle all irq's cases, for what we are not
not prepared and usually hang the whole system.
To avoid the issue use pm\_runtime\_get\_if\_active() to check if
the device is enabled and prevent suspending it when we handle irq
until the end of irq. Additionally use synchronize\_irq() in suspend
Fixes: ab29a2478e70 ("media: intel/ipu6: add IPU6 buttress interface driver")
Cc: stable@vger.kernel.org
Signed-off-by: Stanislaw Gruszka <stanislaw.gruszka@linux.intel.com>
Reviewed-by: Hans de Goede <hdegoede@redhat.com>
Tested-by: Hans de Goede <hdegoede@redhat.com> # ThinkPad X1 Yoga Gen 8, ov2740
Signed-off-by: Sakari Ailus <sakari.ailus@linux.intel.com>
Signed-off-by: Hans Verkuil <hverkuil@xs4all.nl>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57241487a3648515c9aa6fa89e31f2414eccfdbc)

| -rw-r--r-- | [drivers/media/pci/intel/ipu6/ipu6-buttress.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/pci/intel/ipu6/ipu6-buttress.c?id=57241487a3648515c9aa6fa89e31f2414eccfdbc) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/pci/intel/ipu6/ipu6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/pci/intel/ipu6/ipu6.c?id=57241487a3648515c9aa6fa89e31f2414eccfdbc) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/media/pci/intel/ipu6/ipu6-buttress.c b/drivers/media/pci/intel/ipu6/ipu6-buttress.cindex d66db537be4a66..1ee63ef4a40b22 100644--- a/[drivers/media/pci/intel/ipu6/ipu6-buttress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6-buttress.c?id=80a3b2ee01eecf22dfa06968b3cde92c691dea10)+++ b/[drivers/media/pci/intel/ipu6/ipu6-buttress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6-buttress.c?id=57241487a3648515c9aa6fa89e31f2414eccfdbc)@@ -346,12 +346,16 @@ irqreturn\_t ipu6\_buttress\_isr(int irq, void \*isp\_ptr) u32 disable\_irqs = 0; u32 irq\_status; u32 i, count = 0;+ int active; - pm\_runtime\_get\_noresume(&isp->pdev->dev);+ active = pm\_runtime\_get\_if\_active(&isp->pdev->dev);+ if (!active)+ return IRQ\_NONE;  irq\_status = readl(isp->base + reg\_irq\_sts);- if (!irq\_status) {- pm\_runtime\_put\_noidle(&isp->pdev->dev);+ if (irq\_status == 0 || WARN\_ON\_ONCE(irq\_status == 0xffffffffu)) {+ if (active > 0)+ pm\_runtime\_put\_noidle(&isp->pdev->dev); return IRQ\_NONE; } @@ -427,7 +431,8 @@ irqreturn\_t ipu6\_buttress\_isr(int irq, void \*isp\_ptr) writel(BUTTRESS\_IRQS & ~disable\_irqs, isp->base + BUTTRESS\_REG\_ISR\_ENABLE); - pm\_runtime\_put(&isp->pdev->dev);+ if (active > 0)+ pm\_runtime\_put(&isp->pdev->dev);  return ret; }diff --git a/drivers/media/pci/intel/ipu6/ipu6.c b/drivers/media/pci/intel/ipu6/ipu6.cindex 7fb707d3530967..91718eabd74e57 100644--- a/[drivers/media/pci/intel/ipu6/ipu6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6.c?id=80a3b2ee01eecf22dfa06968b3cde92c691dea10)+++ b/[drivers/media/pci/intel/ipu6/ipu6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6.c?id=57241487a3648515c9aa6fa89e31f2414eccfdbc)@@ -752,6 +752,9 @@ static void ipu6\_pci\_reset\_done(struct pci\_dev \*pdev) \*/ static int ipu6\_suspend(struct device \*dev) {+ struct pci\_dev \*pdev = to\_pci\_dev(dev);++ synchronize\_irq(pdev->irq); return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:33:56 +0000



=== Content from git.kernel.org_b882b287_20250115_093519.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ed4524c87249edc3104f6bb28ab11325bed3d536)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed4524c87249edc3104f6bb28ab11325bed3d536)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed4524c87249edc3104f6bb28ab11325bed3d536)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed4524c87249edc3104f6bb28ab11325bed3d536)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stanislaw Gruszka <stanislaw.gruszka@linux.intel.com> | 2024-10-31 11:23:21 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:22 +0100 |
| commit | [ed4524c87249edc3104f6bb28ab11325bed3d536](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed4524c87249edc3104f6bb28ab11325bed3d536) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ed4524c87249edc3104f6bb28ab11325bed3d536)) | |
| tree | [c1a0e049ecf0b2d6839aa2a4e9e8827e3d854388](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed4524c87249edc3104f6bb28ab11325bed3d536) | |
| parent | [2e63c908de357048180516b84740ed62dac0b269](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e63c908de357048180516b84740ed62dac0b269) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed4524c87249edc3104f6bb28ab11325bed3d536&id2=2e63c908de357048180516b84740ed62dac0b269)) | |
| download | [linux-ed4524c87249edc3104f6bb28ab11325bed3d536.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ed4524c87249edc3104f6bb28ab11325bed3d536.tar.gz) | |

media: intel/ipu6: do not handle interrupts when device is disabledcommit 1429826883bb18847092b2e04c6598ef34bae1d4 upstream.
Some IPU6 devices have shared interrupts. We need to handle properly
case when interrupt is triggered from other device on shared irq line
and IPU6 itself disabled. In such case we get 0xffffffff from
ISR\_STATUS register and handle all irq's cases, for what we are not
not prepared and usually hang the whole system.
To avoid the issue use pm\_runtime\_get\_if\_active() to check if
the device is enabled and prevent suspending it when we handle irq
until the end of irq. Additionally use synchronize\_irq() in suspend
Fixes: ab29a2478e70 ("media: intel/ipu6: add IPU6 buttress interface driver")
Cc: stable@vger.kernel.org
Signed-off-by: Stanislaw Gruszka <stanislaw.gruszka@linux.intel.com>
Reviewed-by: Hans de Goede <hdegoede@redhat.com>
Tested-by: Hans de Goede <hdegoede@redhat.com> # ThinkPad X1 Yoga Gen 8, ov2740
Signed-off-by: Sakari Ailus <sakari.ailus@linux.intel.com>
Signed-off-by: Hans Verkuil <hverkuil@xs4all.nl>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed4524c87249edc3104f6bb28ab11325bed3d536)

| -rw-r--r-- | [drivers/media/pci/intel/ipu6/ipu6-buttress.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/pci/intel/ipu6/ipu6-buttress.c?id=ed4524c87249edc3104f6bb28ab11325bed3d536) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/pci/intel/ipu6/ipu6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/pci/intel/ipu6/ipu6.c?id=ed4524c87249edc3104f6bb28ab11325bed3d536) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/media/pci/intel/ipu6/ipu6-buttress.c b/drivers/media/pci/intel/ipu6/ipu6-buttress.cindex d66db537be4a66..1ee63ef4a40b22 100644--- a/[drivers/media/pci/intel/ipu6/ipu6-buttress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6-buttress.c?id=2e63c908de357048180516b84740ed62dac0b269)+++ b/[drivers/media/pci/intel/ipu6/ipu6-buttress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6-buttress.c?id=ed4524c87249edc3104f6bb28ab11325bed3d536)@@ -346,12 +346,16 @@ irqreturn\_t ipu6\_buttress\_isr(int irq, void \*isp\_ptr) u32 disable\_irqs = 0; u32 irq\_status; u32 i, count = 0;+ int active; - pm\_runtime\_get\_noresume(&isp->pdev->dev);+ active = pm\_runtime\_get\_if\_active(&isp->pdev->dev);+ if (!active)+ return IRQ\_NONE;  irq\_status = readl(isp->base + reg\_irq\_sts);- if (!irq\_status) {- pm\_runtime\_put\_noidle(&isp->pdev->dev);+ if (irq\_status == 0 || WARN\_ON\_ONCE(irq\_status == 0xffffffffu)) {+ if (active > 0)+ pm\_runtime\_put\_noidle(&isp->pdev->dev); return IRQ\_NONE; } @@ -427,7 +431,8 @@ irqreturn\_t ipu6\_buttress\_isr(int irq, void \*isp\_ptr) writel(BUTTRESS\_IRQS & ~disable\_irqs, isp->base + BUTTRESS\_REG\_ISR\_ENABLE); - pm\_runtime\_put(&isp->pdev->dev);+ if (active > 0)+ pm\_runtime\_put(&isp->pdev->dev);  return ret; }diff --git a/drivers/media/pci/intel/ipu6/ipu6.c b/drivers/media/pci/intel/ipu6/ipu6.cindex bbd646378ab3ed..518d3377bfbecb 100644--- a/[drivers/media/pci/intel/ipu6/ipu6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6.c?id=2e63c908de357048180516b84740ed62dac0b269)+++ b/[drivers/media/pci/intel/ipu6/ipu6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/pci/intel/ipu6/ipu6.c?id=ed4524c87249edc3104f6bb28ab11325bed3d536)@@ -758,6 +758,9 @@ static void ipu6\_pci\_reset\_done(struct pci\_dev \*pdev) \*/ static int ipu6\_suspend(struct device \*dev) {+ struct pci\_dev \*pdev = to\_pci\_dev(dev);++ synchronize\_irq(pdev->irq); return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:33:56 +0000


