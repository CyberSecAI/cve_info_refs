=== Content from git.kernel.org_89fcbb74_20250114_195545.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-10-16 23:48:38 +0000 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2024-11-26 20:37:46 +0100 |
| commit | [ca70b8baf2bd125b2a4d96e76db79375c07d7ff2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2)) | |
| tree | [996a4ad8c8d73d93a4ed1fc39801df42b8e04e79](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2) | |
| parent | [6b64128a74ebcacc5a0de5a74834e3b9f47a354c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b64128a74ebcacc5a0de5a74834e3b9f47a354c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2&id2=6b64128a74ebcacc5a0de5a74834e3b9f47a354c)) | |
| download | [linux-ca70b8baf2bd125b2a4d96e76db79375c07d7ff2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ca70b8baf2bd125b2a4d96e76db79375c07d7ff2.tar.gz) | |

tcp\_bpf: Fix the sk\_mem\_uncharge logic in tcp\_bpf\_sendmsgThe current sk memory accounting logic in \_\_SK\_REDIRECT is pre-uncharging
tosend bytes, which is either msg->sg.size or a smaller value apply\_bytes.
Potential problems with this strategy are as follows:
- If the actual sent bytes are smaller than tosend, we need to charge some
bytes back, as in line 487, which is okay but seems not clean.
- When tosend is set to apply\_bytes, as in line 417, and (ret < 0), we may
miss uncharging (msg->sg.size - apply\_bytes) bytes.
[...]
415 tosend = msg->sg.size;
416 if (psock->apply\_bytes && psock->apply\_bytes < tosend)
417 tosend = psock->apply\_bytes;
[...]
443 sk\_msg\_return(sk, msg, tosend);
444 release\_sock(sk);
446 origsize = msg->sg.size;
447 ret = tcp\_bpf\_sendmsg\_redir(sk\_redir, redir\_ingress,
448 msg, tosend, flags);
449 sent = origsize - msg->sg.size;
[...]
454 lock\_sock(sk);
455 if (unlikely(ret < 0)) {
456 int free = sk\_msg\_free\_nocharge(sk, msg);
458 if (!cork)
459 \*copied -= free;
460 }
[...]
487 if (eval == \_\_SK\_REDIRECT)
488 sk\_mem\_charge(sk, tosend - sent);
[...]
When running the selftest test\_txmsg\_redir\_wait\_sndmem with txmsg\_apply,
the following warning will be reported:
------------[ cut here ]------------
WARNING: CPU: 6 PID: 57 at net/ipv4/af\_inet.c:156 inet\_sock\_destruct+0x190/0x1a0
Modules linked in:
CPU: 6 UID: 0 PID: 57 Comm: kworker/6:0 Not tainted 6.12.0-rc1.bm.1-amd64+ #43
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.12.0-1 04/01/2014
Workqueue: events sk\_psock\_destroy
RIP: 0010:inet\_sock\_destruct+0x190/0x1a0
RSP: 0018:ffffad0a8021fe08 EFLAGS: 00010206
RAX: 0000000000000011 RBX: ffff9aab4475b900 RCX: ffff9aab481a0800
RDX: 0000000000000303 RSI: 0000000000000011 RDI: ffff9aab4475b900
RBP: ffff9aab4475b990 R08: 0000000000000000 R09: ffff9aab40050ec0
R10: 0000000000000000 R11: ffff9aae6fdb1d01 R12: ffff9aab49c60400
R13: ffff9aab49c60598 R14: ffff9aab49c60598 R15: dead000000000100
FS: 0000000000000000(0000) GS:ffff9aae6fd80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ffec7e47bd8 CR3: 00000001a1a1c004 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<TASK>
? \_\_warn+0x89/0x130
? inet\_sock\_destruct+0x190/0x1a0
? report\_bug+0xfc/0x1e0
? handle\_bug+0x5c/0xa0
? exc\_invalid\_op+0x17/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? inet\_sock\_destruct+0x190/0x1a0
\_\_sk\_destruct+0x25/0x220
sk\_psock\_destroy+0x2b2/0x310
process\_scheduled\_works+0xa3/0x3e0
worker\_thread+0x117/0x240
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcf/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
---[ end trace 0000000000000000 ]---
In \_\_SK\_REDIRECT, a more concise way is delaying the uncharging after sent
bytes are finalized, and uncharge this value. When (ret < 0), we shall
invoke sk\_msg\_free.
Same thing happens in case \_\_SK\_DROP, when tosend is set to apply\_bytes,
we may miss uncharging (msg->sg.size - apply\_bytes) bytes. The same
warning will be reported in selftest.
[...]
468 case \_\_SK\_DROP:
469 default:
470 sk\_msg\_free\_partial(sk, msg, tosend);
471 sk\_msg\_apply\_bytes(psock, tosend);
472 \*copied -= (tosend + delta);
473 return -EACCES;
[...]
So instead of sk\_msg\_free\_partial we can do sk\_msg\_free here.
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk\_msg interface")
Fixes: 8ec95b94716a ("bpf, sockmap: Fix the sk->sk\_forward\_alloc warning of sk\_stream\_kill\_queues")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang@bytedance.com](https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang%40bytedance.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2)

| -rw-r--r-- | [net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_bpf.c?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 7 deletions

| diff --git a/net/ipv4/tcp\_bpf.c b/net/ipv4/tcp\_bpf.cindex 370993c03d3136..99cef92e6290cf 100644--- a/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=6b64128a74ebcacc5a0de5a74834e3b9f47a354c)+++ b/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=ca70b8baf2bd125b2a4d96e76db79375c07d7ff2)@@ -441,7 +441,6 @@ more\_data: cork = true; psock->cork = NULL; }- sk\_msg\_return(sk, msg, tosend); release\_sock(sk);  origsize = msg->sg.size;@@ -453,8 +452,9 @@ more\_data: sock\_put(sk\_redir);  lock\_sock(sk);+ sk\_mem\_uncharge(sk, sent); if (unlikely(ret < 0)) {- int free = sk\_msg\_free\_nocharge(sk, msg);+ int free = sk\_msg\_free(sk, msg);  if (!cork) \*copied -= free;@@ -468,7 +468,7 @@ more\_data: break; case \_\_SK\_DROP: default:- sk\_msg\_free\_partial(sk, msg, tosend);+ sk\_msg\_free(sk, msg); sk\_msg\_apply\_bytes(psock, tosend); \*copied -= (tosend + delta); return -EACCES;@@ -484,11 +484,8 @@ more\_data: } if (msg && msg->sg.data[msg->sg.start].page\_link &&- msg->sg.data[msg->sg.start].length) {- if (eval == \_\_SK\_REDIRECT)- sk\_mem\_charge(sk, tosend - sent);+ msg->sg.data[msg->sg.start].length) goto more\_data;- } } return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:54:22 +0000



=== Content from git.kernel.org_2e0181e8_20250114_195542.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-10-16 23:48:38 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:14 +0100 |
| commit | [5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56)) | |
| tree | [9d0171b8912550d0903cc76ea024cc000c36fb0d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56) | |
| parent | [8bc28b537d578b2153589411bbed27bbb53c59bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bc28b537d578b2153589411bbed27bbb53c59bc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56&id2=8bc28b537d578b2153589411bbed27bbb53c59bc)) | |
| download | [linux-5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56.tar.gz) | |

tcp\_bpf: Fix the sk\_mem\_uncharge logic in tcp\_bpf\_sendmsg[ Upstream commit ca70b8baf2bd125b2a4d96e76db79375c07d7ff2 ]
The current sk memory accounting logic in \_\_SK\_REDIRECT is pre-uncharging
tosend bytes, which is either msg->sg.size or a smaller value apply\_bytes.
Potential problems with this strategy are as follows:
- If the actual sent bytes are smaller than tosend, we need to charge some
bytes back, as in line 487, which is okay but seems not clean.
- When tosend is set to apply\_bytes, as in line 417, and (ret < 0), we may
miss uncharging (msg->sg.size - apply\_bytes) bytes.
[...]
415 tosend = msg->sg.size;
416 if (psock->apply\_bytes && psock->apply\_bytes < tosend)
417 tosend = psock->apply\_bytes;
[...]
443 sk\_msg\_return(sk, msg, tosend);
444 release\_sock(sk);
446 origsize = msg->sg.size;
447 ret = tcp\_bpf\_sendmsg\_redir(sk\_redir, redir\_ingress,
448 msg, tosend, flags);
449 sent = origsize - msg->sg.size;
[...]
454 lock\_sock(sk);
455 if (unlikely(ret < 0)) {
456 int free = sk\_msg\_free\_nocharge(sk, msg);
458 if (!cork)
459 \*copied -= free;
460 }
[...]
487 if (eval == \_\_SK\_REDIRECT)
488 sk\_mem\_charge(sk, tosend - sent);
[...]
When running the selftest test\_txmsg\_redir\_wait\_sndmem with txmsg\_apply,
the following warning will be reported:
------------[ cut here ]------------
WARNING: CPU: 6 PID: 57 at net/ipv4/af\_inet.c:156 inet\_sock\_destruct+0x190/0x1a0
Modules linked in:
CPU: 6 UID: 0 PID: 57 Comm: kworker/6:0 Not tainted 6.12.0-rc1.bm.1-amd64+ #43
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.12.0-1 04/01/2014
Workqueue: events sk\_psock\_destroy
RIP: 0010:inet\_sock\_destruct+0x190/0x1a0
RSP: 0018:ffffad0a8021fe08 EFLAGS: 00010206
RAX: 0000000000000011 RBX: ffff9aab4475b900 RCX: ffff9aab481a0800
RDX: 0000000000000303 RSI: 0000000000000011 RDI: ffff9aab4475b900
RBP: ffff9aab4475b990 R08: 0000000000000000 R09: ffff9aab40050ec0
R10: 0000000000000000 R11: ffff9aae6fdb1d01 R12: ffff9aab49c60400
R13: ffff9aab49c60598 R14: ffff9aab49c60598 R15: dead000000000100
FS: 0000000000000000(0000) GS:ffff9aae6fd80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ffec7e47bd8 CR3: 00000001a1a1c004 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<TASK>
? \_\_warn+0x89/0x130
? inet\_sock\_destruct+0x190/0x1a0
? report\_bug+0xfc/0x1e0
? handle\_bug+0x5c/0xa0
? exc\_invalid\_op+0x17/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? inet\_sock\_destruct+0x190/0x1a0
\_\_sk\_destruct+0x25/0x220
sk\_psock\_destroy+0x2b2/0x310
process\_scheduled\_works+0xa3/0x3e0
worker\_thread+0x117/0x240
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcf/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
---[ end trace 0000000000000000 ]---
In \_\_SK\_REDIRECT, a more concise way is delaying the uncharging after sent
bytes are finalized, and uncharge this value. When (ret < 0), we shall
invoke sk\_msg\_free.
Same thing happens in case \_\_SK\_DROP, when tosend is set to apply\_bytes,
we may miss uncharging (msg->sg.size - apply\_bytes) bytes. The same
warning will be reported in selftest.
[...]
468 case \_\_SK\_DROP:
469 default:
470 sk\_msg\_free\_partial(sk, msg, tosend);
471 sk\_msg\_apply\_bytes(psock, tosend);
472 \*copied -= (tosend + delta);
473 return -EACCES;
[...]
So instead of sk\_msg\_free\_partial we can do sk\_msg\_free here.
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk\_msg interface")
Fixes: 8ec95b94716a ("bpf, sockmap: Fix the sk->sk\_forward\_alloc warning of sk\_stream\_kill\_queues")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang@bytedance.com](https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang%40bytedance.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56)

| -rw-r--r-- | [net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_bpf.c?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 7 deletions

| diff --git a/net/ipv4/tcp\_bpf.c b/net/ipv4/tcp\_bpf.cindex 370993c03d3136..99cef92e6290cf 100644--- a/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=8bc28b537d578b2153589411bbed27bbb53c59bc)+++ b/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=5c9e3bb43a354a2245caebbbbb4a5b8c034fdd56)@@ -441,7 +441,6 @@ more\_data: cork = true; psock->cork = NULL; }- sk\_msg\_return(sk, msg, tosend); release\_sock(sk);  origsize = msg->sg.size;@@ -453,8 +452,9 @@ more\_data: sock\_put(sk\_redir);  lock\_sock(sk);+ sk\_mem\_uncharge(sk, sent); if (unlikely(ret < 0)) {- int free = sk\_msg\_free\_nocharge(sk, msg);+ int free = sk\_msg\_free(sk, msg);  if (!cork) \*copied -= free;@@ -468,7 +468,7 @@ more\_data: break; case \_\_SK\_DROP: default:- sk\_msg\_free\_partial(sk, msg, tosend);+ sk\_msg\_free(sk, msg); sk\_msg\_apply\_bytes(psock, tosend); \*copied -= (tosend + delta); return -EACCES;@@ -484,11 +484,8 @@ more\_data: } if (msg && msg->sg.data[msg->sg.start].page\_link &&- msg->sg.data[msg->sg.start].length) {- if (eval == \_\_SK\_REDIRECT)- sk\_mem\_charge(sk, tosend - sent);+ msg->sg.data[msg->sg.start].length) goto more\_data;- } } return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:54:19 +0000



=== Content from git.kernel.org_413059eb_20250114_195540.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-10-16 23:48:38 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:30 +0100 |
| commit | [0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12)) | |
| tree | [c979203e78f8f24b1af09612f89df61bcf7b6330](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12) | |
| parent | [ece859aac1d31b5a76b2b7649dda3b7c5d6fa746](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ece859aac1d31b5a76b2b7649dda3b7c5d6fa746) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12&id2=ece859aac1d31b5a76b2b7649dda3b7c5d6fa746)) | |
| download | [linux-0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12.tar.gz) | |

tcp\_bpf: Fix the sk\_mem\_uncharge logic in tcp\_bpf\_sendmsg[ Upstream commit ca70b8baf2bd125b2a4d96e76db79375c07d7ff2 ]
The current sk memory accounting logic in \_\_SK\_REDIRECT is pre-uncharging
tosend bytes, which is either msg->sg.size or a smaller value apply\_bytes.
Potential problems with this strategy are as follows:
- If the actual sent bytes are smaller than tosend, we need to charge some
bytes back, as in line 487, which is okay but seems not clean.
- When tosend is set to apply\_bytes, as in line 417, and (ret < 0), we may
miss uncharging (msg->sg.size - apply\_bytes) bytes.
[...]
415 tosend = msg->sg.size;
416 if (psock->apply\_bytes && psock->apply\_bytes < tosend)
417 tosend = psock->apply\_bytes;
[...]
443 sk\_msg\_return(sk, msg, tosend);
444 release\_sock(sk);
446 origsize = msg->sg.size;
447 ret = tcp\_bpf\_sendmsg\_redir(sk\_redir, redir\_ingress,
448 msg, tosend, flags);
449 sent = origsize - msg->sg.size;
[...]
454 lock\_sock(sk);
455 if (unlikely(ret < 0)) {
456 int free = sk\_msg\_free\_nocharge(sk, msg);
458 if (!cork)
459 \*copied -= free;
460 }
[...]
487 if (eval == \_\_SK\_REDIRECT)
488 sk\_mem\_charge(sk, tosend - sent);
[...]
When running the selftest test\_txmsg\_redir\_wait\_sndmem with txmsg\_apply,
the following warning will be reported:
------------[ cut here ]------------
WARNING: CPU: 6 PID: 57 at net/ipv4/af\_inet.c:156 inet\_sock\_destruct+0x190/0x1a0
Modules linked in:
CPU: 6 UID: 0 PID: 57 Comm: kworker/6:0 Not tainted 6.12.0-rc1.bm.1-amd64+ #43
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.12.0-1 04/01/2014
Workqueue: events sk\_psock\_destroy
RIP: 0010:inet\_sock\_destruct+0x190/0x1a0
RSP: 0018:ffffad0a8021fe08 EFLAGS: 00010206
RAX: 0000000000000011 RBX: ffff9aab4475b900 RCX: ffff9aab481a0800
RDX: 0000000000000303 RSI: 0000000000000011 RDI: ffff9aab4475b900
RBP: ffff9aab4475b990 R08: 0000000000000000 R09: ffff9aab40050ec0
R10: 0000000000000000 R11: ffff9aae6fdb1d01 R12: ffff9aab49c60400
R13: ffff9aab49c60598 R14: ffff9aab49c60598 R15: dead000000000100
FS: 0000000000000000(0000) GS:ffff9aae6fd80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ffec7e47bd8 CR3: 00000001a1a1c004 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<TASK>
? \_\_warn+0x89/0x130
? inet\_sock\_destruct+0x190/0x1a0
? report\_bug+0xfc/0x1e0
? handle\_bug+0x5c/0xa0
? exc\_invalid\_op+0x17/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? inet\_sock\_destruct+0x190/0x1a0
\_\_sk\_destruct+0x25/0x220
sk\_psock\_destroy+0x2b2/0x310
process\_scheduled\_works+0xa3/0x3e0
worker\_thread+0x117/0x240
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcf/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
---[ end trace 0000000000000000 ]---
In \_\_SK\_REDIRECT, a more concise way is delaying the uncharging after sent
bytes are finalized, and uncharge this value. When (ret < 0), we shall
invoke sk\_msg\_free.
Same thing happens in case \_\_SK\_DROP, when tosend is set to apply\_bytes,
we may miss uncharging (msg->sg.size - apply\_bytes) bytes. The same
warning will be reported in selftest.
[...]
468 case \_\_SK\_DROP:
469 default:
470 sk\_msg\_free\_partial(sk, msg, tosend);
471 sk\_msg\_apply\_bytes(psock, tosend);
472 \*copied -= (tosend + delta);
473 return -EACCES;
[...]
So instead of sk\_msg\_free\_partial we can do sk\_msg\_free here.
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk\_msg interface")
Fixes: 8ec95b94716a ("bpf, sockmap: Fix the sk->sk\_forward\_alloc warning of sk\_stream\_kill\_queues")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang@bytedance.com](https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang%40bytedance.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12)

| -rw-r--r-- | [net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_bpf.c?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 7 deletions

| diff --git a/net/ipv4/tcp\_bpf.c b/net/ipv4/tcp\_bpf.cindex 93f6a20f515201..f2ae1e51e59ff0 100644--- a/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=ece859aac1d31b5a76b2b7649dda3b7c5d6fa746)+++ b/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=0d6cd1151e26fc7c2d5daa85e8984aaa685a1a12)@@ -396,7 +396,6 @@ more\_data: cork = true; psock->cork = NULL; }- sk\_msg\_return(sk, msg, tosend); release\_sock(sk);  origsize = msg->sg.size;@@ -408,8 +407,9 @@ more\_data: sock\_put(sk\_redir);  lock\_sock(sk);+ sk\_mem\_uncharge(sk, sent); if (unlikely(ret < 0)) {- int free = sk\_msg\_free\_nocharge(sk, msg);+ int free = sk\_msg\_free(sk, msg);  if (!cork) \*copied -= free;@@ -423,7 +423,7 @@ more\_data: break; case \_\_SK\_DROP: default:- sk\_msg\_free\_partial(sk, msg, tosend);+ sk\_msg\_free(sk, msg); sk\_msg\_apply\_bytes(psock, tosend); \*copied -= (tosend + delta); return -EACCES;@@ -439,11 +439,8 @@ more\_data: } if (msg && msg->sg.data[msg->sg.start].page\_link &&- msg->sg.data[msg->sg.start].length) {- if (eval == \_\_SK\_REDIRECT)- sk\_mem\_charge(sk, tosend - sent);+ msg->sg.data[msg->sg.start].length) goto more\_data;- } } return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:54:17 +0000



=== Content from git.kernel.org_cc3fb230_20250114_195541.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=206d56f41a1509cadd06e2178c26cb830e45057d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=206d56f41a1509cadd06e2178c26cb830e45057d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=206d56f41a1509cadd06e2178c26cb830e45057d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=206d56f41a1509cadd06e2178c26cb830e45057d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-10-16 23:48:38 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:48 +0100 |
| commit | [206d56f41a1509cadd06e2178c26cb830e45057d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=206d56f41a1509cadd06e2178c26cb830e45057d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=206d56f41a1509cadd06e2178c26cb830e45057d)) | |
| tree | [81c66a350b74e6879734508818f16b8357fc6474](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=206d56f41a1509cadd06e2178c26cb830e45057d) | |
| parent | [f2f6d999a9341b7ec6af4a4cf91e3d563458be78](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2f6d999a9341b7ec6af4a4cf91e3d563458be78) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=206d56f41a1509cadd06e2178c26cb830e45057d&id2=f2f6d999a9341b7ec6af4a4cf91e3d563458be78)) | |
| download | [linux-206d56f41a1509cadd06e2178c26cb830e45057d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-206d56f41a1509cadd06e2178c26cb830e45057d.tar.gz) | |

tcp\_bpf: Fix the sk\_mem\_uncharge logic in tcp\_bpf\_sendmsg[ Upstream commit ca70b8baf2bd125b2a4d96e76db79375c07d7ff2 ]
The current sk memory accounting logic in \_\_SK\_REDIRECT is pre-uncharging
tosend bytes, which is either msg->sg.size or a smaller value apply\_bytes.
Potential problems with this strategy are as follows:
- If the actual sent bytes are smaller than tosend, we need to charge some
bytes back, as in line 487, which is okay but seems not clean.
- When tosend is set to apply\_bytes, as in line 417, and (ret < 0), we may
miss uncharging (msg->sg.size - apply\_bytes) bytes.
[...]
415 tosend = msg->sg.size;
416 if (psock->apply\_bytes && psock->apply\_bytes < tosend)
417 tosend = psock->apply\_bytes;
[...]
443 sk\_msg\_return(sk, msg, tosend);
444 release\_sock(sk);
446 origsize = msg->sg.size;
447 ret = tcp\_bpf\_sendmsg\_redir(sk\_redir, redir\_ingress,
448 msg, tosend, flags);
449 sent = origsize - msg->sg.size;
[...]
454 lock\_sock(sk);
455 if (unlikely(ret < 0)) {
456 int free = sk\_msg\_free\_nocharge(sk, msg);
458 if (!cork)
459 \*copied -= free;
460 }
[...]
487 if (eval == \_\_SK\_REDIRECT)
488 sk\_mem\_charge(sk, tosend - sent);
[...]
When running the selftest test\_txmsg\_redir\_wait\_sndmem with txmsg\_apply,
the following warning will be reported:
------------[ cut here ]------------
WARNING: CPU: 6 PID: 57 at net/ipv4/af\_inet.c:156 inet\_sock\_destruct+0x190/0x1a0
Modules linked in:
CPU: 6 UID: 0 PID: 57 Comm: kworker/6:0 Not tainted 6.12.0-rc1.bm.1-amd64+ #43
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.12.0-1 04/01/2014
Workqueue: events sk\_psock\_destroy
RIP: 0010:inet\_sock\_destruct+0x190/0x1a0
RSP: 0018:ffffad0a8021fe08 EFLAGS: 00010206
RAX: 0000000000000011 RBX: ffff9aab4475b900 RCX: ffff9aab481a0800
RDX: 0000000000000303 RSI: 0000000000000011 RDI: ffff9aab4475b900
RBP: ffff9aab4475b990 R08: 0000000000000000 R09: ffff9aab40050ec0
R10: 0000000000000000 R11: ffff9aae6fdb1d01 R12: ffff9aab49c60400
R13: ffff9aab49c60598 R14: ffff9aab49c60598 R15: dead000000000100
FS: 0000000000000000(0000) GS:ffff9aae6fd80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ffec7e47bd8 CR3: 00000001a1a1c004 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<TASK>
? \_\_warn+0x89/0x130
? inet\_sock\_destruct+0x190/0x1a0
? report\_bug+0xfc/0x1e0
? handle\_bug+0x5c/0xa0
? exc\_invalid\_op+0x17/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? inet\_sock\_destruct+0x190/0x1a0
\_\_sk\_destruct+0x25/0x220
sk\_psock\_destroy+0x2b2/0x310
process\_scheduled\_works+0xa3/0x3e0
worker\_thread+0x117/0x240
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcf/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
---[ end trace 0000000000000000 ]---
In \_\_SK\_REDIRECT, a more concise way is delaying the uncharging after sent
bytes are finalized, and uncharge this value. When (ret < 0), we shall
invoke sk\_msg\_free.
Same thing happens in case \_\_SK\_DROP, when tosend is set to apply\_bytes,
we may miss uncharging (msg->sg.size - apply\_bytes) bytes. The same
warning will be reported in selftest.
[...]
468 case \_\_SK\_DROP:
469 default:
470 sk\_msg\_free\_partial(sk, msg, tosend);
471 sk\_msg\_apply\_bytes(psock, tosend);
472 \*copied -= (tosend + delta);
473 return -EACCES;
[...]
So instead of sk\_msg\_free\_partial we can do sk\_msg\_free here.
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk\_msg interface")
Fixes: 8ec95b94716a ("bpf, sockmap: Fix the sk->sk\_forward\_alloc warning of sk\_stream\_kill\_queues")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang@bytedance.com](https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang%40bytedance.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=206d56f41a1509cadd06e2178c26cb830e45057d)

| -rw-r--r-- | [net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_bpf.c?id=206d56f41a1509cadd06e2178c26cb830e45057d) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 7 deletions

| diff --git a/net/ipv4/tcp\_bpf.c b/net/ipv4/tcp\_bpf.cindex 915286c3615a27..0a42d73c0850e0 100644--- a/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=f2f6d999a9341b7ec6af4a4cf91e3d563458be78)+++ b/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=206d56f41a1509cadd06e2178c26cb830e45057d)@@ -441,7 +441,6 @@ more\_data: cork = true; psock->cork = NULL; }- sk\_msg\_return(sk, msg, tosend); release\_sock(sk);  origsize = msg->sg.size;@@ -453,8 +452,9 @@ more\_data: sock\_put(sk\_redir);  lock\_sock(sk);+ sk\_mem\_uncharge(sk, sent); if (unlikely(ret < 0)) {- int free = sk\_msg\_free\_nocharge(sk, msg);+ int free = sk\_msg\_free(sk, msg);  if (!cork) \*copied -= free;@@ -468,7 +468,7 @@ more\_data: break; case \_\_SK\_DROP: default:- sk\_msg\_free\_partial(sk, msg, tosend);+ sk\_msg\_free(sk, msg); sk\_msg\_apply\_bytes(psock, tosend); \*copied -= (tosend + delta); return -EACCES;@@ -484,11 +484,8 @@ more\_data: } if (msg && msg->sg.data[msg->sg.start].page\_link &&- msg->sg.data[msg->sg.start].length) {- if (eval == \_\_SK\_REDIRECT)- sk\_mem\_charge(sk, tosend - sent);+ msg->sg.data[msg->sg.start].length) goto more\_data;- } } return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:54:18 +0000



=== Content from git.kernel.org_46d71288_20250114_195547.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-10-16 23:48:38 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:22 +0100 |
| commit | [dbedc7e142df5ea238a46fdd7462c1c42cd36a10](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10)) | |
| tree | [51ecdcaae9f860cf8b87c506b8256b60f5ac245c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10) | |
| parent | [8cd416aaac686657185b528e4ac52e844d7a9215](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8cd416aaac686657185b528e4ac52e844d7a9215) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10&id2=8cd416aaac686657185b528e4ac52e844d7a9215)) | |
| download | [linux-dbedc7e142df5ea238a46fdd7462c1c42cd36a10.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dbedc7e142df5ea238a46fdd7462c1c42cd36a10.tar.gz) | |

tcp\_bpf: Fix the sk\_mem\_uncharge logic in tcp\_bpf\_sendmsg[ Upstream commit ca70b8baf2bd125b2a4d96e76db79375c07d7ff2 ]
The current sk memory accounting logic in \_\_SK\_REDIRECT is pre-uncharging
tosend bytes, which is either msg->sg.size or a smaller value apply\_bytes.
Potential problems with this strategy are as follows:
- If the actual sent bytes are smaller than tosend, we need to charge some
bytes back, as in line 487, which is okay but seems not clean.
- When tosend is set to apply\_bytes, as in line 417, and (ret < 0), we may
miss uncharging (msg->sg.size - apply\_bytes) bytes.
[...]
415 tosend = msg->sg.size;
416 if (psock->apply\_bytes && psock->apply\_bytes < tosend)
417 tosend = psock->apply\_bytes;
[...]
443 sk\_msg\_return(sk, msg, tosend);
444 release\_sock(sk);
446 origsize = msg->sg.size;
447 ret = tcp\_bpf\_sendmsg\_redir(sk\_redir, redir\_ingress,
448 msg, tosend, flags);
449 sent = origsize - msg->sg.size;
[...]
454 lock\_sock(sk);
455 if (unlikely(ret < 0)) {
456 int free = sk\_msg\_free\_nocharge(sk, msg);
458 if (!cork)
459 \*copied -= free;
460 }
[...]
487 if (eval == \_\_SK\_REDIRECT)
488 sk\_mem\_charge(sk, tosend - sent);
[...]
When running the selftest test\_txmsg\_redir\_wait\_sndmem with txmsg\_apply,
the following warning will be reported:
------------[ cut here ]------------
WARNING: CPU: 6 PID: 57 at net/ipv4/af\_inet.c:156 inet\_sock\_destruct+0x190/0x1a0
Modules linked in:
CPU: 6 UID: 0 PID: 57 Comm: kworker/6:0 Not tainted 6.12.0-rc1.bm.1-amd64+ #43
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.12.0-1 04/01/2014
Workqueue: events sk\_psock\_destroy
RIP: 0010:inet\_sock\_destruct+0x190/0x1a0
RSP: 0018:ffffad0a8021fe08 EFLAGS: 00010206
RAX: 0000000000000011 RBX: ffff9aab4475b900 RCX: ffff9aab481a0800
RDX: 0000000000000303 RSI: 0000000000000011 RDI: ffff9aab4475b900
RBP: ffff9aab4475b990 R08: 0000000000000000 R09: ffff9aab40050ec0
R10: 0000000000000000 R11: ffff9aae6fdb1d01 R12: ffff9aab49c60400
R13: ffff9aab49c60598 R14: ffff9aab49c60598 R15: dead000000000100
FS: 0000000000000000(0000) GS:ffff9aae6fd80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ffec7e47bd8 CR3: 00000001a1a1c004 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<TASK>
? \_\_warn+0x89/0x130
? inet\_sock\_destruct+0x190/0x1a0
? report\_bug+0xfc/0x1e0
? handle\_bug+0x5c/0xa0
? exc\_invalid\_op+0x17/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? inet\_sock\_destruct+0x190/0x1a0
\_\_sk\_destruct+0x25/0x220
sk\_psock\_destroy+0x2b2/0x310
process\_scheduled\_works+0xa3/0x3e0
worker\_thread+0x117/0x240
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcf/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
---[ end trace 0000000000000000 ]---
In \_\_SK\_REDIRECT, a more concise way is delaying the uncharging after sent
bytes are finalized, and uncharge this value. When (ret < 0), we shall
invoke sk\_msg\_free.
Same thing happens in case \_\_SK\_DROP, when tosend is set to apply\_bytes,
we may miss uncharging (msg->sg.size - apply\_bytes) bytes. The same
warning will be reported in selftest.
[...]
468 case \_\_SK\_DROP:
469 default:
470 sk\_msg\_free\_partial(sk, msg, tosend);
471 sk\_msg\_apply\_bytes(psock, tosend);
472 \*copied -= (tosend + delta);
473 return -EACCES;
[...]
So instead of sk\_msg\_free\_partial we can do sk\_msg\_free here.
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk\_msg interface")
Fixes: 8ec95b94716a ("bpf, sockmap: Fix the sk->sk\_forward\_alloc warning of sk\_stream\_kill\_queues")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang@bytedance.com](https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang%40bytedance.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10)

| -rw-r--r-- | [net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_bpf.c?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 7 deletions

| diff --git a/net/ipv4/tcp\_bpf.c b/net/ipv4/tcp\_bpf.cindex ade27d63655c24..85ae2c310148da 100644--- a/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=8cd416aaac686657185b528e4ac52e844d7a9215)+++ b/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=dbedc7e142df5ea238a46fdd7462c1c42cd36a10)@@ -375,7 +375,6 @@ more\_data: cork = true; psock->cork = NULL; }- sk\_msg\_return(sk, msg, tosend); release\_sock(sk);  origsize = msg->sg.size;@@ -386,8 +385,9 @@ more\_data: sock\_put(sk\_redir);  lock\_sock(sk);+ sk\_mem\_uncharge(sk, sent); if (unlikely(ret < 0)) {- int free = sk\_msg\_free\_nocharge(sk, msg);+ int free = sk\_msg\_free(sk, msg);  if (!cork) \*copied -= free;@@ -401,7 +401,7 @@ more\_data: break; case \_\_SK\_DROP: default:- sk\_msg\_free\_partial(sk, msg, tosend);+ sk\_msg\_free(sk, msg); sk\_msg\_apply\_bytes(psock, tosend); \*copied -= (tosend + delta); return -EACCES;@@ -417,11 +417,8 @@ more\_data: } if (msg && msg->sg.data[msg->sg.start].page\_link &&- msg->sg.data[msg->sg.start].length) {- if (eval == \_\_SK\_REDIRECT)- sk\_mem\_charge(sk, tosend - sent);+ msg->sg.data[msg->sg.start].length) goto more\_data;- } } return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:54:23 +0000



=== Content from git.kernel.org_a24088fe_20250114_195544.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-10-16 23:48:38 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:47 +0100 |
| commit | [905d82e6e77d16ec3e089c92b7b59a14899dfc1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a)) | |
| tree | [6e3316bf0b85d1a42b8093d9188d13cb01304281](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a) | |
| parent | [079484a92812d0def4e92788786aae0131c4abd2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=079484a92812d0def4e92788786aae0131c4abd2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a&id2=079484a92812d0def4e92788786aae0131c4abd2)) | |
| download | [linux-905d82e6e77d16ec3e089c92b7b59a14899dfc1a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-905d82e6e77d16ec3e089c92b7b59a14899dfc1a.tar.gz) | |

tcp\_bpf: Fix the sk\_mem\_uncharge logic in tcp\_bpf\_sendmsg[ Upstream commit ca70b8baf2bd125b2a4d96e76db79375c07d7ff2 ]
The current sk memory accounting logic in \_\_SK\_REDIRECT is pre-uncharging
tosend bytes, which is either msg->sg.size or a smaller value apply\_bytes.
Potential problems with this strategy are as follows:
- If the actual sent bytes are smaller than tosend, we need to charge some
bytes back, as in line 487, which is okay but seems not clean.
- When tosend is set to apply\_bytes, as in line 417, and (ret < 0), we may
miss uncharging (msg->sg.size - apply\_bytes) bytes.
[...]
415 tosend = msg->sg.size;
416 if (psock->apply\_bytes && psock->apply\_bytes < tosend)
417 tosend = psock->apply\_bytes;
[...]
443 sk\_msg\_return(sk, msg, tosend);
444 release\_sock(sk);
446 origsize = msg->sg.size;
447 ret = tcp\_bpf\_sendmsg\_redir(sk\_redir, redir\_ingress,
448 msg, tosend, flags);
449 sent = origsize - msg->sg.size;
[...]
454 lock\_sock(sk);
455 if (unlikely(ret < 0)) {
456 int free = sk\_msg\_free\_nocharge(sk, msg);
458 if (!cork)
459 \*copied -= free;
460 }
[...]
487 if (eval == \_\_SK\_REDIRECT)
488 sk\_mem\_charge(sk, tosend - sent);
[...]
When running the selftest test\_txmsg\_redir\_wait\_sndmem with txmsg\_apply,
the following warning will be reported:
------------[ cut here ]------------
WARNING: CPU: 6 PID: 57 at net/ipv4/af\_inet.c:156 inet\_sock\_destruct+0x190/0x1a0
Modules linked in:
CPU: 6 UID: 0 PID: 57 Comm: kworker/6:0 Not tainted 6.12.0-rc1.bm.1-amd64+ #43
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.12.0-1 04/01/2014
Workqueue: events sk\_psock\_destroy
RIP: 0010:inet\_sock\_destruct+0x190/0x1a0
RSP: 0018:ffffad0a8021fe08 EFLAGS: 00010206
RAX: 0000000000000011 RBX: ffff9aab4475b900 RCX: ffff9aab481a0800
RDX: 0000000000000303 RSI: 0000000000000011 RDI: ffff9aab4475b900
RBP: ffff9aab4475b990 R08: 0000000000000000 R09: ffff9aab40050ec0
R10: 0000000000000000 R11: ffff9aae6fdb1d01 R12: ffff9aab49c60400
R13: ffff9aab49c60598 R14: ffff9aab49c60598 R15: dead000000000100
FS: 0000000000000000(0000) GS:ffff9aae6fd80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ffec7e47bd8 CR3: 00000001a1a1c004 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<TASK>
? \_\_warn+0x89/0x130
? inet\_sock\_destruct+0x190/0x1a0
? report\_bug+0xfc/0x1e0
? handle\_bug+0x5c/0xa0
? exc\_invalid\_op+0x17/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? inet\_sock\_destruct+0x190/0x1a0
\_\_sk\_destruct+0x25/0x220
sk\_psock\_destroy+0x2b2/0x310
process\_scheduled\_works+0xa3/0x3e0
worker\_thread+0x117/0x240
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcf/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
---[ end trace 0000000000000000 ]---
In \_\_SK\_REDIRECT, a more concise way is delaying the uncharging after sent
bytes are finalized, and uncharge this value. When (ret < 0), we shall
invoke sk\_msg\_free.
Same thing happens in case \_\_SK\_DROP, when tosend is set to apply\_bytes,
we may miss uncharging (msg->sg.size - apply\_bytes) bytes. The same
warning will be reported in selftest.
[...]
468 case \_\_SK\_DROP:
469 default:
470 sk\_msg\_free\_partial(sk, msg, tosend);
471 sk\_msg\_apply\_bytes(psock, tosend);
472 \*copied -= (tosend + delta);
473 return -EACCES;
[...]
So instead of sk\_msg\_free\_partial we can do sk\_msg\_free here.
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk\_msg interface")
Fixes: 8ec95b94716a ("bpf, sockmap: Fix the sk->sk\_forward\_alloc warning of sk\_stream\_kill\_queues")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang@bytedance.com](https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang%40bytedance.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a)

| -rw-r--r-- | [net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_bpf.c?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 7 deletions

| diff --git a/net/ipv4/tcp\_bpf.c b/net/ipv4/tcp\_bpf.cindex 0002a6730d2e96..8c1508a2e241a3 100644--- a/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=079484a92812d0def4e92788786aae0131c4abd2)+++ b/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=905d82e6e77d16ec3e089c92b7b59a14899dfc1a)@@ -370,7 +370,6 @@ more\_data: cork = true; psock->cork = NULL; }- sk\_msg\_return(sk, msg, tosend); release\_sock(sk);  origsize = msg->sg.size;@@ -381,8 +380,9 @@ more\_data: sock\_put(sk\_redir);  lock\_sock(sk);+ sk\_mem\_uncharge(sk, sent); if (unlikely(ret < 0)) {- int free = sk\_msg\_free\_nocharge(sk, msg);+ int free = sk\_msg\_free(sk, msg);  if (!cork) \*copied -= free;@@ -396,7 +396,7 @@ more\_data: break; case \_\_SK\_DROP: default:- sk\_msg\_free\_partial(sk, msg, tosend);+ sk\_msg\_free(sk, msg); sk\_msg\_apply\_bytes(psock, tosend); \*copied -= (tosend + delta); return -EACCES;@@ -412,11 +412,8 @@ more\_data: } if (msg && msg->sg.data[msg->sg.start].page\_link &&- msg->sg.data[msg->sg.start].length) {- if (eval == \_\_SK\_REDIRECT)- sk\_mem\_charge(sk, tosend - sent);+ msg->sg.data[msg->sg.start].length) goto more\_data;- } } return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:54:21 +0000



=== Content from git.kernel.org_0528b7d0_20250114_195541.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-10-16 23:48:38 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:30 +0100 |
| commit | [456f08d24afa51b5eb816c42e4ca1c44a247bd42](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42)) | |
| tree | [110894eb621f86f6cd3f629ebe672f2a327940f7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42) | |
| parent | [0f51eb88c39a0f4110f0f4352866c403e08262e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f51eb88c39a0f4110f0f4352866c403e08262e8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42&id2=0f51eb88c39a0f4110f0f4352866c403e08262e8)) | |
| download | [linux-456f08d24afa51b5eb816c42e4ca1c44a247bd42.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-456f08d24afa51b5eb816c42e4ca1c44a247bd42.tar.gz) | |

tcp\_bpf: Fix the sk\_mem\_uncharge logic in tcp\_bpf\_sendmsg[ Upstream commit ca70b8baf2bd125b2a4d96e76db79375c07d7ff2 ]
The current sk memory accounting logic in \_\_SK\_REDIRECT is pre-uncharging
tosend bytes, which is either msg->sg.size or a smaller value apply\_bytes.
Potential problems with this strategy are as follows:
- If the actual sent bytes are smaller than tosend, we need to charge some
bytes back, as in line 487, which is okay but seems not clean.
- When tosend is set to apply\_bytes, as in line 417, and (ret < 0), we may
miss uncharging (msg->sg.size - apply\_bytes) bytes.
[...]
415 tosend = msg->sg.size;
416 if (psock->apply\_bytes && psock->apply\_bytes < tosend)
417 tosend = psock->apply\_bytes;
[...]
443 sk\_msg\_return(sk, msg, tosend);
444 release\_sock(sk);
446 origsize = msg->sg.size;
447 ret = tcp\_bpf\_sendmsg\_redir(sk\_redir, redir\_ingress,
448 msg, tosend, flags);
449 sent = origsize - msg->sg.size;
[...]
454 lock\_sock(sk);
455 if (unlikely(ret < 0)) {
456 int free = sk\_msg\_free\_nocharge(sk, msg);
458 if (!cork)
459 \*copied -= free;
460 }
[...]
487 if (eval == \_\_SK\_REDIRECT)
488 sk\_mem\_charge(sk, tosend - sent);
[...]
When running the selftest test\_txmsg\_redir\_wait\_sndmem with txmsg\_apply,
the following warning will be reported:
------------[ cut here ]------------
WARNING: CPU: 6 PID: 57 at net/ipv4/af\_inet.c:156 inet\_sock\_destruct+0x190/0x1a0
Modules linked in:
CPU: 6 UID: 0 PID: 57 Comm: kworker/6:0 Not tainted 6.12.0-rc1.bm.1-amd64+ #43
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.12.0-1 04/01/2014
Workqueue: events sk\_psock\_destroy
RIP: 0010:inet\_sock\_destruct+0x190/0x1a0
RSP: 0018:ffffad0a8021fe08 EFLAGS: 00010206
RAX: 0000000000000011 RBX: ffff9aab4475b900 RCX: ffff9aab481a0800
RDX: 0000000000000303 RSI: 0000000000000011 RDI: ffff9aab4475b900
RBP: ffff9aab4475b990 R08: 0000000000000000 R09: ffff9aab40050ec0
R10: 0000000000000000 R11: ffff9aae6fdb1d01 R12: ffff9aab49c60400
R13: ffff9aab49c60598 R14: ffff9aab49c60598 R15: dead000000000100
FS: 0000000000000000(0000) GS:ffff9aae6fd80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ffec7e47bd8 CR3: 00000001a1a1c004 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<TASK>
? \_\_warn+0x89/0x130
? inet\_sock\_destruct+0x190/0x1a0
? report\_bug+0xfc/0x1e0
? handle\_bug+0x5c/0xa0
? exc\_invalid\_op+0x17/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? inet\_sock\_destruct+0x190/0x1a0
\_\_sk\_destruct+0x25/0x220
sk\_psock\_destroy+0x2b2/0x310
process\_scheduled\_works+0xa3/0x3e0
worker\_thread+0x117/0x240
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xcf/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x40
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
---[ end trace 0000000000000000 ]---
In \_\_SK\_REDIRECT, a more concise way is delaying the uncharging after sent
bytes are finalized, and uncharge this value. When (ret < 0), we shall
invoke sk\_msg\_free.
Same thing happens in case \_\_SK\_DROP, when tosend is set to apply\_bytes,
we may miss uncharging (msg->sg.size - apply\_bytes) bytes. The same
warning will be reported in selftest.
[...]
468 case \_\_SK\_DROP:
469 default:
470 sk\_msg\_free\_partial(sk, msg, tosend);
471 sk\_msg\_apply\_bytes(psock, tosend);
472 \*copied -= (tosend + delta);
473 return -EACCES;
[...]
So instead of sk\_msg\_free\_partial we can do sk\_msg\_free here.
Fixes: 604326b41a6f ("bpf, sockmap: convert to generic sk\_msg interface")
Fixes: 8ec95b94716a ("bpf, sockmap: Fix the sk->sk\_forward\_alloc warning of sk\_stream\_kill\_queues")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang@bytedance.com](https://lore.kernel.org/bpf/20241016234838.3167769-3-zijianzhang%40bytedance.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42)

| -rw-r--r-- | [net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_bpf.c?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 7 deletions

| diff --git a/net/ipv4/tcp\_bpf.c b/net/ipv4/tcp\_bpf.cindex f67e4c9f8d40ef..deb6286b588109 100644--- a/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=0f51eb88c39a0f4110f0f4352866c403e08262e8)+++ b/[net/ipv4/tcp\_bpf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_bpf.c?id=456f08d24afa51b5eb816c42e4ca1c44a247bd42)@@ -436,7 +436,6 @@ more\_data: cork = true; psock->cork = NULL; }- sk\_msg\_return(sk, msg, tosend); release\_sock(sk);  origsize = msg->sg.size;@@ -448,8 +447,9 @@ more\_data: sock\_put(sk\_redir);  lock\_sock(sk);+ sk\_mem\_uncharge(sk, sent); if (unlikely(ret < 0)) {- int free = sk\_msg\_free\_nocharge(sk, msg);+ int free = sk\_msg\_free(sk, msg);  if (!cork) \*copied -= free;@@ -463,7 +463,7 @@ more\_data: break; case \_\_SK\_DROP: default:- sk\_msg\_free\_partial(sk, msg, tosend);+ sk\_msg\_free(sk, msg); sk\_msg\_apply\_bytes(psock, tosend); \*copied -= (tosend + delta); return -EACCES;@@ -479,11 +479,8 @@ more\_data: } if (msg && msg->sg.data[msg->sg.start].page\_link &&- msg->sg.data[msg->sg.start].length) {- if (eval == \_\_SK\_REDIRECT)- sk\_mem\_charge(sk, tosend - sent);+ msg->sg.data[msg->sg.start].length) goto more\_data;- } } return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:54:18 +0000


