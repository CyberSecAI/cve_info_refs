=== Content from git.kernel.org_4a580db3_20250114_195512.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=410896624db639500f24f46478b4bfa05c76bf56)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=410896624db639500f24f46478b4bfa05c76bf56)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=410896624db639500f24f46478b4bfa05c76bf56)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=410896624db639500f24f46478b4bfa05c76bf56)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Erkun <yangerkun@huawei.com> | 2024-10-30 11:49:14 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:31:43 +0100 |
| commit | [410896624db639500f24f46478b4bfa05c76bf56](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=410896624db639500f24f46478b4bfa05c76bf56) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=410896624db639500f24f46478b4bfa05c76bf56)) | |
| tree | [996c48bb4511a2c76404abdb976374a6443affbd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=410896624db639500f24f46478b4bfa05c76bf56) | |
| parent | [83d123e27623713dd69eed2569eacf5f1b3c9033](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83d123e27623713dd69eed2569eacf5f1b3c9033) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=410896624db639500f24f46478b4bfa05c76bf56&id2=83d123e27623713dd69eed2569eacf5f1b3c9033)) | |
| download | [linux-410896624db639500f24f46478b4bfa05c76bf56.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-410896624db639500f24f46478b4bfa05c76bf56.tar.gz) | |

brd: defer automatic disk creation until module initialization succeeds[ Upstream commit 826cc42adf44930a633d11a5993676d85ddb0842 ]
My colleague Wupeng found the following problems during fault injection:
BUG: unable to handle page fault for address: fffffbfff809d073
PGD 6e648067 P4D 123ec8067 PUD 123ec4067 PMD 100e38067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 5 UID: 0 PID: 755 Comm: modprobe Not tainted 6.12.0-rc3+ #17
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.16.1-2.fc37 04/01/2014
RIP: 0010:\_\_asan\_load8+0x4c/0xa0
...
Call Trace:
<TASK>
blkdev\_put\_whole+0x41/0x70
bdev\_release+0x1a3/0x250
blkdev\_release+0x11/0x20
\_\_fput+0x1d7/0x4a0
task\_work\_run+0xfc/0x180
syscall\_exit\_to\_user\_mode+0x1de/0x1f0
do\_syscall\_64+0x6b/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
loop\_init() is calling loop\_add() after \_\_register\_blkdev() succeeds and
is ignoring disk\_add() failure from loop\_add(), for loop\_add() failure
is not fatal and successfully created disks are already visible to
bdev\_open().
brd\_init() is currently calling brd\_alloc() before \_\_register\_blkdev()
succeeds and is releasing successfully created disks when brd\_init()
returns an error. This can cause UAF for the latter two case:
case 1:
T1:
modprobe brd
brd\_init
brd\_alloc(0) // success
add\_disk
disk\_scan\_partitions
bdev\_file\_open\_by\_dev // alloc file
fput // won't free until back to userspace
brd\_alloc(1) // failed since mem alloc error inject
// error path for modprobe will release code segment
// back to userspace
\_\_fput
blkdev\_release
bdev\_release
blkdev\_put\_whole
bdev->bd\_disk->fops->release // fops is freed now, UAF!
case 2:
T1: T2:
modprobe brd
brd\_init
brd\_alloc(0) // success
open(/dev/ram0)
brd\_alloc(1) // fail
// error path for modprobe
close(/dev/ram0)
...
/\* UAF! \*/
bdev->bd\_disk->fops->release
Fix this problem by following what loop\_init() does. Besides,
reintroduce brd\_devices\_mutex to help serialize modifications to
brd\_list.
Fixes: 7f9b348cb5e9 ("brd: convert to blk\_alloc\_disk/blk\_cleanup\_disk")
Reported-by: Wupeng Ma <mawupeng1@huawei.com>
Signed-off-by: Yang Erkun <yangerkun@huawei.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Link: [https://lore.kernel.org/r/20241030034914.907829-1-yangerkun@huaweicloud.com](https://lore.kernel.org/r/20241030034914.907829-1-yangerkun%40huaweicloud.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=410896624db639500f24f46478b4bfa05c76bf56)

| -rw-r--r-- | [drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/brd.c?id=410896624db639500f24f46478b4bfa05c76bf56) | 66 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 44 insertions, 22 deletions

| diff --git a/drivers/block/brd.c b/drivers/block/brd.cindex 970bd6ff38c491..d816d1512531e4 100644--- a/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=83d123e27623713dd69eed2569eacf5f1b3c9033)+++ b/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=410896624db639500f24f46478b4bfa05c76bf56)@@ -310,8 +310,40 @@ \_\_setup("ramdisk\_size=", ramdisk\_size); \* (should share code eventually). \*/ static LIST\_HEAD(brd\_devices);+static DEFINE\_MUTEX(brd\_devices\_mutex); static struct dentry \*brd\_debugfs\_dir; +static struct brd\_device \*brd\_find\_or\_alloc\_device(int i)+{+ struct brd\_device \*brd;++ mutex\_lock(&brd\_devices\_mutex);+ list\_for\_each\_entry(brd, &brd\_devices, brd\_list) {+ if (brd->brd\_number == i) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-EEXIST);+ }+ }++ brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);+ if (!brd) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-ENOMEM);+ }+ brd->brd\_number = i;+ list\_add\_tail(&brd->brd\_list, &brd\_devices);+ mutex\_unlock(&brd\_devices\_mutex);+ return brd;+}++static void brd\_free\_device(struct brd\_device \*brd)+{+ mutex\_lock(&brd\_devices\_mutex);+ list\_del(&brd->brd\_list);+ mutex\_unlock(&brd\_devices\_mutex);+ kfree(brd);+}+ static int brd\_alloc(int i) { struct brd\_device \*brd;@@ -319,14 +351,9 @@ static int brd\_alloc(int i) char buf[DISK\_NAME\_LEN]; int err = -ENOMEM; - list\_for\_each\_entry(brd, &brd\_devices, brd\_list)- if (brd->brd\_number == i)- return -EEXIST;- brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);- if (!brd)- return -ENOMEM;- brd->brd\_number = i;- list\_add\_tail(&brd->brd\_list, &brd\_devices);+ brd = brd\_find\_or\_alloc\_device(i);+ if (IS\_ERR(brd))+ return PTR\_ERR(brd);  xa\_init(&brd->brd\_pages); @@ -369,8 +396,7 @@ static int brd\_alloc(int i) out\_cleanup\_disk: put\_disk(disk); out\_free\_dev:- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); return err; } @@ -389,8 +415,7 @@ static void brd\_cleanup(void) del\_gendisk(brd->brd\_disk); put\_disk(brd->brd\_disk); brd\_free\_pages(brd);- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); } } @@ -417,16 +442,6 @@ static int \_\_init brd\_init(void) { int err, i; - brd\_check\_and\_reset\_par();-- brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);-- for (i = 0; i < rd\_nr; i++) {- err = brd\_alloc(i);- if (err)- goto out\_free;- }- /\* \* brd module now has a feature to instantiate underlying device \* structure on-demand, provided that there is an access dev node.@@ -442,11 +457,18 @@ static int \_\_init brd\_init(void) \* dynamically. \*/ + brd\_check\_and\_reset\_par();++ brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);+ if (\_\_register\_blkdev(RAMDISK\_MAJOR, "ramdisk", brd\_probe)) { err = -EIO; goto out\_free; } + for (i = 0; i < rd\_nr; i++)+ brd\_alloc(i);+ pr\_info("brd: module loaded\n"); return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:53:49 +0000



=== Content from git.kernel.org_9e039462_20250114_195516.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=826cc42adf44930a633d11a5993676d85ddb0842)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=826cc42adf44930a633d11a5993676d85ddb0842)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=826cc42adf44930a633d11a5993676d85ddb0842)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=826cc42adf44930a633d11a5993676d85ddb0842)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Erkun <yangerkun@huawei.com> | 2024-10-30 11:49:14 +0800 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-10-30 07:31:07 -0600 |
| commit | [826cc42adf44930a633d11a5993676d85ddb0842](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=826cc42adf44930a633d11a5993676d85ddb0842) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=826cc42adf44930a633d11a5993676d85ddb0842)) | |
| tree | [7aa238f75d59e2732432449b98e53863790d5379](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=826cc42adf44930a633d11a5993676d85ddb0842) | |
| parent | [8d3fd059dd289e6c322e5741ad56794bcce699a2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d3fd059dd289e6c322e5741ad56794bcce699a2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=826cc42adf44930a633d11a5993676d85ddb0842&id2=8d3fd059dd289e6c322e5741ad56794bcce699a2)) | |
| download | [linux-826cc42adf44930a633d11a5993676d85ddb0842.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-826cc42adf44930a633d11a5993676d85ddb0842.tar.gz) | |

brd: defer automatic disk creation until module initialization succeedsMy colleague Wupeng found the following problems during fault injection:
BUG: unable to handle page fault for address: fffffbfff809d073
PGD 6e648067 P4D 123ec8067 PUD 123ec4067 PMD 100e38067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 5 UID: 0 PID: 755 Comm: modprobe Not tainted 6.12.0-rc3+ #17
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.16.1-2.fc37 04/01/2014
RIP: 0010:\_\_asan\_load8+0x4c/0xa0
...
Call Trace:
<TASK>
blkdev\_put\_whole+0x41/0x70
bdev\_release+0x1a3/0x250
blkdev\_release+0x11/0x20
\_\_fput+0x1d7/0x4a0
task\_work\_run+0xfc/0x180
syscall\_exit\_to\_user\_mode+0x1de/0x1f0
do\_syscall\_64+0x6b/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
loop\_init() is calling loop\_add() after \_\_register\_blkdev() succeeds and
is ignoring disk\_add() failure from loop\_add(), for loop\_add() failure
is not fatal and successfully created disks are already visible to
bdev\_open().
brd\_init() is currently calling brd\_alloc() before \_\_register\_blkdev()
succeeds and is releasing successfully created disks when brd\_init()
returns an error. This can cause UAF for the latter two case:
case 1:
T1:
modprobe brd
brd\_init
brd\_alloc(0) // success
add\_disk
disk\_scan\_partitions
bdev\_file\_open\_by\_dev // alloc file
fput // won't free until back to userspace
brd\_alloc(1) // failed since mem alloc error inject
// error path for modprobe will release code segment
// back to userspace
\_\_fput
blkdev\_release
bdev\_release
blkdev\_put\_whole
bdev->bd\_disk->fops->release // fops is freed now, UAF!
case 2:
T1: T2:
modprobe brd
brd\_init
brd\_alloc(0) // success
open(/dev/ram0)
brd\_alloc(1) // fail
// error path for modprobe
close(/dev/ram0)
...
/\* UAF! \*/
bdev->bd\_disk->fops->release
Fix this problem by following what loop\_init() does. Besides,
reintroduce brd\_devices\_mutex to help serialize modifications to
brd\_list.
Fixes: 7f9b348cb5e9 ("brd: convert to blk\_alloc\_disk/blk\_cleanup\_disk")
Reported-by: Wupeng Ma <mawupeng1@huawei.com>
Signed-off-by: Yang Erkun <yangerkun@huawei.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Link: [https://lore.kernel.org/r/20241030034914.907829-1-yangerkun@huaweicloud.com](https://lore.kernel.org/r/20241030034914.907829-1-yangerkun%40huaweicloud.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=826cc42adf44930a633d11a5993676d85ddb0842)

| -rw-r--r-- | [drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/brd.c?id=826cc42adf44930a633d11a5993676d85ddb0842) | 66 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 44 insertions, 22 deletions

| diff --git a/drivers/block/brd.c b/drivers/block/brd.cindex 2fd1ed1017481b..5a95671d81515c 100644--- a/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=8d3fd059dd289e6c322e5741ad56794bcce699a2)+++ b/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=826cc42adf44930a633d11a5993676d85ddb0842)@@ -316,8 +316,40 @@ \_\_setup("ramdisk\_size=", ramdisk\_size); \* (should share code eventually). \*/ static LIST\_HEAD(brd\_devices);+static DEFINE\_MUTEX(brd\_devices\_mutex); static struct dentry \*brd\_debugfs\_dir; +static struct brd\_device \*brd\_find\_or\_alloc\_device(int i)+{+ struct brd\_device \*brd;++ mutex\_lock(&brd\_devices\_mutex);+ list\_for\_each\_entry(brd, &brd\_devices, brd\_list) {+ if (brd->brd\_number == i) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-EEXIST);+ }+ }++ brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);+ if (!brd) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-ENOMEM);+ }+ brd->brd\_number = i;+ list\_add\_tail(&brd->brd\_list, &brd\_devices);+ mutex\_unlock(&brd\_devices\_mutex);+ return brd;+}++static void brd\_free\_device(struct brd\_device \*brd)+{+ mutex\_lock(&brd\_devices\_mutex);+ list\_del(&brd->brd\_list);+ mutex\_unlock(&brd\_devices\_mutex);+ kfree(brd);+}+ static int brd\_alloc(int i) { struct brd\_device \*brd;@@ -340,14 +372,9 @@ static int brd\_alloc(int i) BLK\_FEAT\_NOWAIT, }; - list\_for\_each\_entry(brd, &brd\_devices, brd\_list)- if (brd->brd\_number == i)- return -EEXIST;- brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);- if (!brd)- return -ENOMEM;- brd->brd\_number = i;- list\_add\_tail(&brd->brd\_list, &brd\_devices);+ brd = brd\_find\_or\_alloc\_device(i);+ if (IS\_ERR(brd))+ return PTR\_ERR(brd);  xa\_init(&brd->brd\_pages); @@ -378,8 +405,7 @@ static int brd\_alloc(int i) out\_cleanup\_disk: put\_disk(disk); out\_free\_dev:- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); return err; } @@ -398,8 +424,7 @@ static void brd\_cleanup(void) del\_gendisk(brd->brd\_disk); put\_disk(brd->brd\_disk); brd\_free\_pages(brd);- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); } } @@ -426,16 +451,6 @@ static int \_\_init brd\_init(void) { int err, i; - brd\_check\_and\_reset\_par();-- brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);-- for (i = 0; i < rd\_nr; i++) {- err = brd\_alloc(i);- if (err)- goto out\_free;- }- /\* \* brd module now has a feature to instantiate underlying device \* structure on-demand, provided that there is an access dev node.@@ -451,11 +466,18 @@ static int \_\_init brd\_init(void) \* dynamically. \*/ + brd\_check\_and\_reset\_par();++ brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);+ if (\_\_register\_blkdev(RAMDISK\_MAJOR, "ramdisk", brd\_probe)) { err = -EIO; goto out\_free; } + for (i = 0; i < rd\_nr; i++)+ brd\_alloc(i);+ pr\_info("brd: module loaded\n"); return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:53:53 +0000



=== Content from git.kernel.org_626f774b_20250114_195515.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=63dfd728b30f79495dacc886127695a379805152)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63dfd728b30f79495dacc886127695a379805152)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63dfd728b30f79495dacc886127695a379805152)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63dfd728b30f79495dacc886127695a379805152)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Erkun <yangerkun@huawei.com> | 2024-10-30 11:49:14 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:12 +0100 |
| commit | [63dfd728b30f79495dacc886127695a379805152](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63dfd728b30f79495dacc886127695a379805152) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=63dfd728b30f79495dacc886127695a379805152)) | |
| tree | [20365e65c4e6dcfb2a2e5b65112d392329b2b32a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63dfd728b30f79495dacc886127695a379805152) | |
| parent | [9978ff5dcaa9eebc720fd340d3e05343596f058f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9978ff5dcaa9eebc720fd340d3e05343596f058f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63dfd728b30f79495dacc886127695a379805152&id2=9978ff5dcaa9eebc720fd340d3e05343596f058f)) | |
| download | [linux-63dfd728b30f79495dacc886127695a379805152.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-63dfd728b30f79495dacc886127695a379805152.tar.gz) | |

brd: defer automatic disk creation until module initialization succeeds[ Upstream commit 826cc42adf44930a633d11a5993676d85ddb0842 ]
My colleague Wupeng found the following problems during fault injection:
BUG: unable to handle page fault for address: fffffbfff809d073
PGD 6e648067 P4D 123ec8067 PUD 123ec4067 PMD 100e38067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 5 UID: 0 PID: 755 Comm: modprobe Not tainted 6.12.0-rc3+ #17
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.16.1-2.fc37 04/01/2014
RIP: 0010:\_\_asan\_load8+0x4c/0xa0
...
Call Trace:
<TASK>
blkdev\_put\_whole+0x41/0x70
bdev\_release+0x1a3/0x250
blkdev\_release+0x11/0x20
\_\_fput+0x1d7/0x4a0
task\_work\_run+0xfc/0x180
syscall\_exit\_to\_user\_mode+0x1de/0x1f0
do\_syscall\_64+0x6b/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
loop\_init() is calling loop\_add() after \_\_register\_blkdev() succeeds and
is ignoring disk\_add() failure from loop\_add(), for loop\_add() failure
is not fatal and successfully created disks are already visible to
bdev\_open().
brd\_init() is currently calling brd\_alloc() before \_\_register\_blkdev()
succeeds and is releasing successfully created disks when brd\_init()
returns an error. This can cause UAF for the latter two case:
case 1:
T1:
modprobe brd
brd\_init
brd\_alloc(0) // success
add\_disk
disk\_scan\_partitions
bdev\_file\_open\_by\_dev // alloc file
fput // won't free until back to userspace
brd\_alloc(1) // failed since mem alloc error inject
// error path for modprobe will release code segment
// back to userspace
\_\_fput
blkdev\_release
bdev\_release
blkdev\_put\_whole
bdev->bd\_disk->fops->release // fops is freed now, UAF!
case 2:
T1: T2:
modprobe brd
brd\_init
brd\_alloc(0) // success
open(/dev/ram0)
brd\_alloc(1) // fail
// error path for modprobe
close(/dev/ram0)
...
/\* UAF! \*/
bdev->bd\_disk->fops->release
Fix this problem by following what loop\_init() does. Besides,
reintroduce brd\_devices\_mutex to help serialize modifications to
brd\_list.
Fixes: 7f9b348cb5e9 ("brd: convert to blk\_alloc\_disk/blk\_cleanup\_disk")
Reported-by: Wupeng Ma <mawupeng1@huawei.com>
Signed-off-by: Yang Erkun <yangerkun@huawei.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Link: [https://lore.kernel.org/r/20241030034914.907829-1-yangerkun@huaweicloud.com](https://lore.kernel.org/r/20241030034914.907829-1-yangerkun%40huaweicloud.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63dfd728b30f79495dacc886127695a379805152)

| -rw-r--r-- | [drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/brd.c?id=63dfd728b30f79495dacc886127695a379805152) | 66 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 44 insertions, 22 deletions

| diff --git a/drivers/block/brd.c b/drivers/block/brd.cindex 2fd1ed1017481b..5a95671d81515c 100644--- a/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=9978ff5dcaa9eebc720fd340d3e05343596f058f)+++ b/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=63dfd728b30f79495dacc886127695a379805152)@@ -316,8 +316,40 @@ \_\_setup("ramdisk\_size=", ramdisk\_size); \* (should share code eventually). \*/ static LIST\_HEAD(brd\_devices);+static DEFINE\_MUTEX(brd\_devices\_mutex); static struct dentry \*brd\_debugfs\_dir; +static struct brd\_device \*brd\_find\_or\_alloc\_device(int i)+{+ struct brd\_device \*brd;++ mutex\_lock(&brd\_devices\_mutex);+ list\_for\_each\_entry(brd, &brd\_devices, brd\_list) {+ if (brd->brd\_number == i) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-EEXIST);+ }+ }++ brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);+ if (!brd) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-ENOMEM);+ }+ brd->brd\_number = i;+ list\_add\_tail(&brd->brd\_list, &brd\_devices);+ mutex\_unlock(&brd\_devices\_mutex);+ return brd;+}++static void brd\_free\_device(struct brd\_device \*brd)+{+ mutex\_lock(&brd\_devices\_mutex);+ list\_del(&brd->brd\_list);+ mutex\_unlock(&brd\_devices\_mutex);+ kfree(brd);+}+ static int brd\_alloc(int i) { struct brd\_device \*brd;@@ -340,14 +372,9 @@ static int brd\_alloc(int i) BLK\_FEAT\_NOWAIT, }; - list\_for\_each\_entry(brd, &brd\_devices, brd\_list)- if (brd->brd\_number == i)- return -EEXIST;- brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);- if (!brd)- return -ENOMEM;- brd->brd\_number = i;- list\_add\_tail(&brd->brd\_list, &brd\_devices);+ brd = brd\_find\_or\_alloc\_device(i);+ if (IS\_ERR(brd))+ return PTR\_ERR(brd);  xa\_init(&brd->brd\_pages); @@ -378,8 +405,7 @@ static int brd\_alloc(int i) out\_cleanup\_disk: put\_disk(disk); out\_free\_dev:- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); return err; } @@ -398,8 +424,7 @@ static void brd\_cleanup(void) del\_gendisk(brd->brd\_disk); put\_disk(brd->brd\_disk); brd\_free\_pages(brd);- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); } } @@ -426,16 +451,6 @@ static int \_\_init brd\_init(void) { int err, i; - brd\_check\_and\_reset\_par();-- brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);-- for (i = 0; i < rd\_nr; i++) {- err = brd\_alloc(i);- if (err)- goto out\_free;- }- /\* \* brd module now has a feature to instantiate underlying device \* structure on-demand, provided that there is an access dev node.@@ -451,11 +466,18 @@ static int \_\_init brd\_init(void) \* dynamically. \*/ + brd\_check\_and\_reset\_par();++ brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);+ if (\_\_register\_blkdev(RAMDISK\_MAJOR, "ramdisk", brd\_probe)) { err = -EIO; goto out\_free; } + for (i = 0; i < rd\_nr; i++)+ brd\_alloc(i);+ pr\_info("brd: module loaded\n"); return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:53:52 +0000



=== Content from git.kernel.org_29c59e54_20250114_195511.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=259bf925583ec9e3781df778cadf00594095090d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=259bf925583ec9e3781df778cadf00594095090d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=259bf925583ec9e3781df778cadf00594095090d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=259bf925583ec9e3781df778cadf00594095090d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Erkun <yangerkun@huawei.com> | 2024-10-30 11:49:14 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:14 +0100 |
| commit | [259bf925583ec9e3781df778cadf00594095090d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=259bf925583ec9e3781df778cadf00594095090d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=259bf925583ec9e3781df778cadf00594095090d)) | |
| tree | [11c70ef917c9b2fc9eab0768b1e307ed5ea6cd96](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=259bf925583ec9e3781df778cadf00594095090d) | |
| parent | [2185802447683c98c3e5d621b310991f84def998](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2185802447683c98c3e5d621b310991f84def998) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=259bf925583ec9e3781df778cadf00594095090d&id2=2185802447683c98c3e5d621b310991f84def998)) | |
| download | [linux-259bf925583ec9e3781df778cadf00594095090d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-259bf925583ec9e3781df778cadf00594095090d.tar.gz) | |

brd: defer automatic disk creation until module initialization succeeds[ Upstream commit 826cc42adf44930a633d11a5993676d85ddb0842 ]
My colleague Wupeng found the following problems during fault injection:
BUG: unable to handle page fault for address: fffffbfff809d073
PGD 6e648067 P4D 123ec8067 PUD 123ec4067 PMD 100e38067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 5 UID: 0 PID: 755 Comm: modprobe Not tainted 6.12.0-rc3+ #17
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.16.1-2.fc37 04/01/2014
RIP: 0010:\_\_asan\_load8+0x4c/0xa0
...
Call Trace:
<TASK>
blkdev\_put\_whole+0x41/0x70
bdev\_release+0x1a3/0x250
blkdev\_release+0x11/0x20
\_\_fput+0x1d7/0x4a0
task\_work\_run+0xfc/0x180
syscall\_exit\_to\_user\_mode+0x1de/0x1f0
do\_syscall\_64+0x6b/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
loop\_init() is calling loop\_add() after \_\_register\_blkdev() succeeds and
is ignoring disk\_add() failure from loop\_add(), for loop\_add() failure
is not fatal and successfully created disks are already visible to
bdev\_open().
brd\_init() is currently calling brd\_alloc() before \_\_register\_blkdev()
succeeds and is releasing successfully created disks when brd\_init()
returns an error. This can cause UAF for the latter two case:
case 1:
T1:
modprobe brd
brd\_init
brd\_alloc(0) // success
add\_disk
disk\_scan\_partitions
bdev\_file\_open\_by\_dev // alloc file
fput // won't free until back to userspace
brd\_alloc(1) // failed since mem alloc error inject
// error path for modprobe will release code segment
// back to userspace
\_\_fput
blkdev\_release
bdev\_release
blkdev\_put\_whole
bdev->bd\_disk->fops->release // fops is freed now, UAF!
case 2:
T1: T2:
modprobe brd
brd\_init
brd\_alloc(0) // success
open(/dev/ram0)
brd\_alloc(1) // fail
// error path for modprobe
close(/dev/ram0)
...
/\* UAF! \*/
bdev->bd\_disk->fops->release
Fix this problem by following what loop\_init() does. Besides,
reintroduce brd\_devices\_mutex to help serialize modifications to
brd\_list.
Fixes: 7f9b348cb5e9 ("brd: convert to blk\_alloc\_disk/blk\_cleanup\_disk")
Reported-by: Wupeng Ma <mawupeng1@huawei.com>
Signed-off-by: Yang Erkun <yangerkun@huawei.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Link: [https://lore.kernel.org/r/20241030034914.907829-1-yangerkun@huaweicloud.com](https://lore.kernel.org/r/20241030034914.907829-1-yangerkun%40huaweicloud.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=259bf925583ec9e3781df778cadf00594095090d)

| -rw-r--r-- | [drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/brd.c?id=259bf925583ec9e3781df778cadf00594095090d) | 66 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 44 insertions, 22 deletions

| diff --git a/drivers/block/brd.c b/drivers/block/brd.cindex a8a77a1efe1e36..b2c109f08808a3 100644--- a/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=2185802447683c98c3e5d621b310991f84def998)+++ b/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=259bf925583ec9e3781df778cadf00594095090d)@@ -368,8 +368,40 @@ \_\_setup("ramdisk\_size=", ramdisk\_size); \* (should share code eventually). \*/ static LIST\_HEAD(brd\_devices);+static DEFINE\_MUTEX(brd\_devices\_mutex); static struct dentry \*brd\_debugfs\_dir; +static struct brd\_device \*brd\_find\_or\_alloc\_device(int i)+{+ struct brd\_device \*brd;++ mutex\_lock(&brd\_devices\_mutex);+ list\_for\_each\_entry(brd, &brd\_devices, brd\_list) {+ if (brd->brd\_number == i) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-EEXIST);+ }+ }++ brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);+ if (!brd) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-ENOMEM);+ }+ brd->brd\_number = i;+ list\_add\_tail(&brd->brd\_list, &brd\_devices);+ mutex\_unlock(&brd\_devices\_mutex);+ return brd;+}++static void brd\_free\_device(struct brd\_device \*brd)+{+ mutex\_lock(&brd\_devices\_mutex);+ list\_del(&brd->brd\_list);+ mutex\_unlock(&brd\_devices\_mutex);+ kfree(brd);+}+ static int brd\_alloc(int i) { struct brd\_device \*brd;@@ -377,14 +409,9 @@ static int brd\_alloc(int i) char buf[DISK\_NAME\_LEN]; int err = -ENOMEM; - list\_for\_each\_entry(brd, &brd\_devices, brd\_list)- if (brd->brd\_number == i)- return -EEXIST;- brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);- if (!brd)- return -ENOMEM;- brd->brd\_number = i;- list\_add\_tail(&brd->brd\_list, &brd\_devices);+ brd = brd\_find\_or\_alloc\_device(i);+ if (IS\_ERR(brd))+ return PTR\_ERR(brd);  spin\_lock\_init(&brd->brd\_lock); INIT\_RADIX\_TREE(&brd->brd\_pages, GFP\_ATOMIC);@@ -428,8 +455,7 @@ static int brd\_alloc(int i) out\_cleanup\_disk: put\_disk(disk); out\_free\_dev:- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); return err; } @@ -448,8 +474,7 @@ static void brd\_cleanup(void) del\_gendisk(brd->brd\_disk); put\_disk(brd->brd\_disk); brd\_free\_pages(brd);- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); } } @@ -476,16 +501,6 @@ static int \_\_init brd\_init(void) { int err, i; - brd\_check\_and\_reset\_par();-- brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);-- for (i = 0; i < rd\_nr; i++) {- err = brd\_alloc(i);- if (err)- goto out\_free;- }- /\* \* brd module now has a feature to instantiate underlying device \* structure on-demand, provided that there is an access dev node.@@ -501,11 +516,18 @@ static int \_\_init brd\_init(void) \* dynamically. \*/ + brd\_check\_and\_reset\_par();++ brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);+ if (\_\_register\_blkdev(RAMDISK\_MAJOR, "ramdisk", brd\_probe)) { err = -EIO; goto out\_free; } + for (i = 0; i < rd\_nr; i++)+ brd\_alloc(i);+ pr\_info("brd: module loaded\n"); return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:53:48 +0000



=== Content from git.kernel.org_02ae33be_20250114_195513.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Erkun <yangerkun@huawei.com> | 2024-10-30 11:49:14 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:42 +0100 |
| commit | [41219c147df8bbd6591f59af5d695fb6c9a1cbff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff)) | |
| tree | [a90dbdeda3d201a0945d0fc213877eced9c4ddc4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff) | |
| parent | [60f89db56246452443625cf36bb67f9b0acf6b94](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60f89db56246452443625cf36bb67f9b0acf6b94) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff&id2=60f89db56246452443625cf36bb67f9b0acf6b94)) | |
| download | [linux-41219c147df8bbd6591f59af5d695fb6c9a1cbff.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-41219c147df8bbd6591f59af5d695fb6c9a1cbff.tar.gz) | |

brd: defer automatic disk creation until module initialization succeeds[ Upstream commit 826cc42adf44930a633d11a5993676d85ddb0842 ]
My colleague Wupeng found the following problems during fault injection:
BUG: unable to handle page fault for address: fffffbfff809d073
PGD 6e648067 P4D 123ec8067 PUD 123ec4067 PMD 100e38067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 5 UID: 0 PID: 755 Comm: modprobe Not tainted 6.12.0-rc3+ #17
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.16.1-2.fc37 04/01/2014
RIP: 0010:\_\_asan\_load8+0x4c/0xa0
...
Call Trace:
<TASK>
blkdev\_put\_whole+0x41/0x70
bdev\_release+0x1a3/0x250
blkdev\_release+0x11/0x20
\_\_fput+0x1d7/0x4a0
task\_work\_run+0xfc/0x180
syscall\_exit\_to\_user\_mode+0x1de/0x1f0
do\_syscall\_64+0x6b/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
loop\_init() is calling loop\_add() after \_\_register\_blkdev() succeeds and
is ignoring disk\_add() failure from loop\_add(), for loop\_add() failure
is not fatal and successfully created disks are already visible to
bdev\_open().
brd\_init() is currently calling brd\_alloc() before \_\_register\_blkdev()
succeeds and is releasing successfully created disks when brd\_init()
returns an error. This can cause UAF for the latter two case:
case 1:
T1:
modprobe brd
brd\_init
brd\_alloc(0) // success
add\_disk
disk\_scan\_partitions
bdev\_file\_open\_by\_dev // alloc file
fput // won't free until back to userspace
brd\_alloc(1) // failed since mem alloc error inject
// error path for modprobe will release code segment
// back to userspace
\_\_fput
blkdev\_release
bdev\_release
blkdev\_put\_whole
bdev->bd\_disk->fops->release // fops is freed now, UAF!
case 2:
T1: T2:
modprobe brd
brd\_init
brd\_alloc(0) // success
open(/dev/ram0)
brd\_alloc(1) // fail
// error path for modprobe
close(/dev/ram0)
...
/\* UAF! \*/
bdev->bd\_disk->fops->release
Fix this problem by following what loop\_init() does. Besides,
reintroduce brd\_devices\_mutex to help serialize modifications to
brd\_list.
Fixes: 7f9b348cb5e9 ("brd: convert to blk\_alloc\_disk/blk\_cleanup\_disk")
Reported-by: Wupeng Ma <mawupeng1@huawei.com>
Signed-off-by: Yang Erkun <yangerkun@huawei.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Link: [https://lore.kernel.org/r/20241030034914.907829-1-yangerkun@huaweicloud.com](https://lore.kernel.org/r/20241030034914.907829-1-yangerkun%40huaweicloud.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff)

| -rw-r--r-- | [drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/brd.c?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff) | 66 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 44 insertions, 22 deletions

| diff --git a/drivers/block/brd.c b/drivers/block/brd.cindex db816baca55679..e4f470cc702f98 100644--- a/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=60f89db56246452443625cf36bb67f9b0acf6b94)+++ b/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=41219c147df8bbd6591f59af5d695fb6c9a1cbff)@@ -362,8 +362,40 @@ \_\_setup("ramdisk\_size=", ramdisk\_size); \* (should share code eventually). \*/ static LIST\_HEAD(brd\_devices);+static DEFINE\_MUTEX(brd\_devices\_mutex); static struct dentry \*brd\_debugfs\_dir; +static struct brd\_device \*brd\_find\_or\_alloc\_device(int i)+{+ struct brd\_device \*brd;++ mutex\_lock(&brd\_devices\_mutex);+ list\_for\_each\_entry(brd, &brd\_devices, brd\_list) {+ if (brd->brd\_number == i) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-EEXIST);+ }+ }++ brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);+ if (!brd) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-ENOMEM);+ }+ brd->brd\_number = i;+ list\_add\_tail(&brd->brd\_list, &brd\_devices);+ mutex\_unlock(&brd\_devices\_mutex);+ return brd;+}++static void brd\_free\_device(struct brd\_device \*brd)+{+ mutex\_lock(&brd\_devices\_mutex);+ list\_del(&brd->brd\_list);+ mutex\_unlock(&brd\_devices\_mutex);+ kfree(brd);+}+ static int brd\_alloc(int i) { struct brd\_device \*brd;@@ -371,14 +403,9 @@ static int brd\_alloc(int i) char buf[DISK\_NAME\_LEN]; int err = -ENOMEM; - list\_for\_each\_entry(brd, &brd\_devices, brd\_list)- if (brd->brd\_number == i)- return -EEXIST;- brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);- if (!brd)- return -ENOMEM;- brd->brd\_number = i;- list\_add\_tail(&brd->brd\_list, &brd\_devices);+ brd = brd\_find\_or\_alloc\_device(i);+ if (IS\_ERR(brd))+ return PTR\_ERR(brd);  spin\_lock\_init(&brd->brd\_lock); INIT\_RADIX\_TREE(&brd->brd\_pages, GFP\_ATOMIC);@@ -423,8 +450,7 @@ static int brd\_alloc(int i) out\_cleanup\_disk: blk\_cleanup\_disk(disk); out\_free\_dev:- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); return err; } @@ -443,8 +469,7 @@ static void brd\_cleanup(void) del\_gendisk(brd->brd\_disk); blk\_cleanup\_disk(brd->brd\_disk); brd\_free\_pages(brd);- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); } } @@ -471,16 +496,6 @@ static int \_\_init brd\_init(void) { int err, i; - brd\_check\_and\_reset\_par();-- brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);-- for (i = 0; i < rd\_nr; i++) {- err = brd\_alloc(i);- if (err)- goto out\_free;- }- /\* \* brd module now has a feature to instantiate underlying device \* structure on-demand, provided that there is an access dev node.@@ -496,11 +511,18 @@ static int \_\_init brd\_init(void) \* dynamically. \*/ + brd\_check\_and\_reset\_par();++ brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);+ if (\_\_register\_blkdev(RAMDISK\_MAJOR, "ramdisk", brd\_probe)) { err = -EIO; goto out\_free; } + for (i = 0; i < rd\_nr; i++)+ brd\_alloc(i);+ pr\_info("brd: module loaded\n"); return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:53:50 +0000



=== Content from git.kernel.org_719b26c8_20250114_195517.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Erkun <yangerkun@huawei.com> | 2024-10-30 11:49:14 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:52:44 +0100 |
| commit | [c0c2744cd2939ec5999c51dbaf2af16886548b7b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b)) | |
| tree | [bdaa69dbd1a36220f6e734fd6c2242b0c6599c87](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b) | |
| parent | [4b876507d4fc8e146acf86f898af1784558d5f46](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b876507d4fc8e146acf86f898af1784558d5f46) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b&id2=4b876507d4fc8e146acf86f898af1784558d5f46)) | |
| download | [linux-c0c2744cd2939ec5999c51dbaf2af16886548b7b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c0c2744cd2939ec5999c51dbaf2af16886548b7b.tar.gz) | |

brd: defer automatic disk creation until module initialization succeeds[ Upstream commit 826cc42adf44930a633d11a5993676d85ddb0842 ]
My colleague Wupeng found the following problems during fault injection:
BUG: unable to handle page fault for address: fffffbfff809d073
PGD 6e648067 P4D 123ec8067 PUD 123ec4067 PMD 100e38067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 5 UID: 0 PID: 755 Comm: modprobe Not tainted 6.12.0-rc3+ #17
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.16.1-2.fc37 04/01/2014
RIP: 0010:\_\_asan\_load8+0x4c/0xa0
...
Call Trace:
<TASK>
blkdev\_put\_whole+0x41/0x70
bdev\_release+0x1a3/0x250
blkdev\_release+0x11/0x20
\_\_fput+0x1d7/0x4a0
task\_work\_run+0xfc/0x180
syscall\_exit\_to\_user\_mode+0x1de/0x1f0
do\_syscall\_64+0x6b/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
loop\_init() is calling loop\_add() after \_\_register\_blkdev() succeeds and
is ignoring disk\_add() failure from loop\_add(), for loop\_add() failure
is not fatal and successfully created disks are already visible to
bdev\_open().
brd\_init() is currently calling brd\_alloc() before \_\_register\_blkdev()
succeeds and is releasing successfully created disks when brd\_init()
returns an error. This can cause UAF for the latter two case:
case 1:
T1:
modprobe brd
brd\_init
brd\_alloc(0) // success
add\_disk
disk\_scan\_partitions
bdev\_file\_open\_by\_dev // alloc file
fput // won't free until back to userspace
brd\_alloc(1) // failed since mem alloc error inject
// error path for modprobe will release code segment
// back to userspace
\_\_fput
blkdev\_release
bdev\_release
blkdev\_put\_whole
bdev->bd\_disk->fops->release // fops is freed now, UAF!
case 2:
T1: T2:
modprobe brd
brd\_init
brd\_alloc(0) // success
open(/dev/ram0)
brd\_alloc(1) // fail
// error path for modprobe
close(/dev/ram0)
...
/\* UAF! \*/
bdev->bd\_disk->fops->release
Fix this problem by following what loop\_init() does. Besides,
reintroduce brd\_devices\_mutex to help serialize modifications to
brd\_list.
Fixes: 7f9b348cb5e9 ("brd: convert to blk\_alloc\_disk/blk\_cleanup\_disk")
Reported-by: Wupeng Ma <mawupeng1@huawei.com>
Signed-off-by: Yang Erkun <yangerkun@huawei.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Link: [https://lore.kernel.org/r/20241030034914.907829-1-yangerkun@huaweicloud.com](https://lore.kernel.org/r/20241030034914.907829-1-yangerkun%40huaweicloud.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b)

| -rw-r--r-- | [drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/brd.c?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b) | 66 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 44 insertions, 22 deletions

| diff --git a/drivers/block/brd.c b/drivers/block/brd.cindex 2fd1ed1017481b..5a95671d81515c 100644--- a/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=4b876507d4fc8e146acf86f898af1784558d5f46)+++ b/[drivers/block/brd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/brd.c?id=c0c2744cd2939ec5999c51dbaf2af16886548b7b)@@ -316,8 +316,40 @@ \_\_setup("ramdisk\_size=", ramdisk\_size); \* (should share code eventually). \*/ static LIST\_HEAD(brd\_devices);+static DEFINE\_MUTEX(brd\_devices\_mutex); static struct dentry \*brd\_debugfs\_dir; +static struct brd\_device \*brd\_find\_or\_alloc\_device(int i)+{+ struct brd\_device \*brd;++ mutex\_lock(&brd\_devices\_mutex);+ list\_for\_each\_entry(brd, &brd\_devices, brd\_list) {+ if (brd->brd\_number == i) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-EEXIST);+ }+ }++ brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);+ if (!brd) {+ mutex\_unlock(&brd\_devices\_mutex);+ return ERR\_PTR(-ENOMEM);+ }+ brd->brd\_number = i;+ list\_add\_tail(&brd->brd\_list, &brd\_devices);+ mutex\_unlock(&brd\_devices\_mutex);+ return brd;+}++static void brd\_free\_device(struct brd\_device \*brd)+{+ mutex\_lock(&brd\_devices\_mutex);+ list\_del(&brd->brd\_list);+ mutex\_unlock(&brd\_devices\_mutex);+ kfree(brd);+}+ static int brd\_alloc(int i) { struct brd\_device \*brd;@@ -340,14 +372,9 @@ static int brd\_alloc(int i) BLK\_FEAT\_NOWAIT, }; - list\_for\_each\_entry(brd, &brd\_devices, brd\_list)- if (brd->brd\_number == i)- return -EEXIST;- brd = kzalloc(sizeof(\*brd), GFP\_KERNEL);- if (!brd)- return -ENOMEM;- brd->brd\_number = i;- list\_add\_tail(&brd->brd\_list, &brd\_devices);+ brd = brd\_find\_or\_alloc\_device(i);+ if (IS\_ERR(brd))+ return PTR\_ERR(brd);  xa\_init(&brd->brd\_pages); @@ -378,8 +405,7 @@ static int brd\_alloc(int i) out\_cleanup\_disk: put\_disk(disk); out\_free\_dev:- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); return err; } @@ -398,8 +424,7 @@ static void brd\_cleanup(void) del\_gendisk(brd->brd\_disk); put\_disk(brd->brd\_disk); brd\_free\_pages(brd);- list\_del(&brd->brd\_list);- kfree(brd);+ brd\_free\_device(brd); } } @@ -426,16 +451,6 @@ static int \_\_init brd\_init(void) { int err, i; - brd\_check\_and\_reset\_par();-- brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);-- for (i = 0; i < rd\_nr; i++) {- err = brd\_alloc(i);- if (err)- goto out\_free;- }- /\* \* brd module now has a feature to instantiate underlying device \* structure on-demand, provided that there is an access dev node.@@ -451,11 +466,18 @@ static int \_\_init brd\_init(void) \* dynamically. \*/ + brd\_check\_and\_reset\_par();++ brd\_debugfs\_dir = debugfs\_create\_dir("ramdisk\_pages", NULL);+ if (\_\_register\_blkdev(RAMDISK\_MAJOR, "ramdisk", brd\_probe)) { err = -EIO; goto out\_free; } + for (i = 0; i < rd\_nr; i++)+ brd\_alloc(i);+ pr\_info("brd: module loaded\n"); return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:53:54 +0000


