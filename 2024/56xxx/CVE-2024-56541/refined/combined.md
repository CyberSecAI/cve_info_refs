=== Content from git.kernel.org_ebdfe537_20250115_094734.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bdb281103373fd80eb5c91cede1e115ba270b4e9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bdb281103373fd80eb5c91cede1e115ba270b4e9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdb281103373fd80eb5c91cede1e115ba270b4e9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdb281103373fd80eb5c91cede1e115ba270b4e9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rameshkumar Sundaram <quic\_ramess@quicinc.com> | 2024-10-01 14:56:52 +0530 |
| --- | --- | --- |
| committer | Jeff Johnson <quic\_jjohnson@quicinc.com> | 2024-10-07 14:07:35 -0700 |
| commit | [bdb281103373fd80eb5c91cede1e115ba270b4e9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdb281103373fd80eb5c91cede1e115ba270b4e9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bdb281103373fd80eb5c91cede1e115ba270b4e9)) | |
| tree | [6c4904a105407bb853ed3a3956cd2a84e0b7cada](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bdb281103373fd80eb5c91cede1e115ba270b4e9) | |
| parent | [1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdb281103373fd80eb5c91cede1e115ba270b4e9&id2=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb)) | |
| download | [linux-bdb281103373fd80eb5c91cede1e115ba270b4e9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bdb281103373fd80eb5c91cede1e115ba270b4e9.tar.gz) | |

wifi: ath12k: fix use-after-free in ath12k\_dp\_cc\_cleanup()During ath12k module removal, in ath12k\_core\_deinit(),
ath12k\_mac\_destroy() un-registers ah->hw from mac80211 and frees
the ah->hw as well as all the ar's in it. After this
ath12k\_core\_soc\_destroy()-> ath12k\_dp\_free()-> ath12k\_dp\_cc\_cleanup()
tries to access one of the freed ar's from pending skb.
This is because during mac destroy, driver failed to flush few
data packets, which were accessed later in ath12k\_dp\_cc\_cleanup()
and freed, but using ar from the packet led to this use-after-free.
BUG: KASAN: use-after-free in ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
Write of size 4 at addr ffff888150bd3514 by task modprobe/8926
CPU: 0 UID: 0 PID: 8926 Comm: modprobe Not tainted
6.11.0-rc2-wt-ath+ #1746
Hardware name: Intel(R) Client Systems NUC8i7HVK/NUC8i7HVB, BIOS
HNKBLi70.86A.0067.2021.0528.1339 05/28/2021
Call Trace:
<TASK>
dump\_stack\_lvl+0x7d/0xe0
print\_address\_description.constprop.0+0x33/0x3a0
print\_report+0xb5/0x260
? kasan\_addr\_to\_slab+0x24/0x80
kasan\_report+0xd8/0x110
? ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
? ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
kasan\_check\_range+0xf3/0x1a0
\_\_kasan\_check\_write+0x14/0x20
ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
ath12k\_dp\_free+0x178/0x420 [ath12k]
ath12k\_core\_stop+0x176/0x200 [ath12k]
ath12k\_core\_deinit+0x13f/0x210 [ath12k]
ath12k\_pci\_remove+0xad/0x1c0 [ath12k]
pci\_device\_remove+0x9b/0x1b0
device\_remove+0xbf/0x150
device\_release\_driver\_internal+0x3c3/0x580
? \_\_kasan\_check\_read+0x11/0x20
driver\_detach+0xc4/0x190
bus\_remove\_driver+0x130/0x2a0
driver\_unregister+0x68/0x90
pci\_unregister\_driver+0x24/0x240
? find\_module\_all+0x13e/0x1e0
ath12k\_pci\_exit+0x10/0x20 [ath12k]
\_\_do\_sys\_delete\_module+0x32c/0x580
? module\_flags+0x2f0/0x2f0
? kmem\_cache\_free+0xf0/0x410
? \_\_fput+0x56f/0xab0
? \_\_fput+0x56f/0xab0
? debug\_smp\_processor\_id+0x17/0x20
\_\_x64\_sys\_delete\_module+0x4f/0x70
x64\_sys\_call+0x522/0x9f0
do\_syscall\_64+0x64/0x130
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7f8182c6ac8b
Commit 24de1b7b231c ("wifi: ath12k: fix flush failure in recovery
scenarios") added the change to decrement the pending packets count
in case of recovery which make sense as ah->hw as well all
ar's in it are intact during recovery, but during core deinit there
is no use in decrementing packets count or waking up the empty waitq
as the module is going to be removed also ar's from pending skb's
can't be used and the packets should just be released back.
To fix this, avoid accessing ar from skb->cb when driver is being
unregistered.
Tested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.1.1-00214-QCAHKSWPL\_SILICONZ-1
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0.c5-00481-QCAHMTSWPL\_V1.0\_V2.0\_SILICONZ-3
Fixes: 24de1b7b231c ("wifi: ath12k: fix flush failure in recovery scenarios")
Signed-off-by: Rameshkumar Sundaram <quic\_ramess@quicinc.com>
Acked-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Link: [https://patch.msgid.link/20241001092652.3134334-1-quic\_ramess@quicinc.com](https://patch.msgid.link/20241001092652.3134334-1-quic_ramess%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdb281103373fd80eb5c91cede1e115ba270b4e9)

| -rw-r--r-- | [drivers/net/wireless/ath/ath12k/dp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/dp.c?id=bdb281103373fd80eb5c91cede1e115ba270b4e9) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 4 deletions

| diff --git a/drivers/net/wireless/ath/ath12k/dp.c b/drivers/net/wireless/ath/ath12k/dp.cindex ecd3b5c76d26a7..2ab2a7d45be91b 100644--- a/[drivers/net/wireless/ath/ath12k/dp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/dp.c?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb)+++ b/[drivers/net/wireless/ath/ath12k/dp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/dp.c?id=bdb281103373fd80eb5c91cede1e115ba270b4e9)@@ -1202,10 +1202,16 @@ static void ath12k\_dp\_cc\_cleanup(struct ath12k\_base \*ab) if (!skb) continue; - skb\_cb = ATH12K\_SKB\_CB(skb);- ar = skb\_cb->ar;- if (atomic\_dec\_and\_test(&ar->dp.num\_tx\_pending))- wake\_up(&ar->dp.tx\_empty\_waitq);+ /\* if we are unregistering, hw would've been destroyed and+ \* ar is no longer valid.+ \*/+ if (!(test\_bit(ATH12K\_FLAG\_UNREGISTERING, &ab->dev\_flags))) {+ skb\_cb = ATH12K\_SKB\_CB(skb);+ ar = skb\_cb->ar;++ if (atomic\_dec\_and\_test(&ar->dp.num\_tx\_pending))+ wake\_up(&ar->dp.tx\_empty\_waitq);+ }  dma\_unmap\_single(ab->dev, ATH12K\_SKB\_CB(skb)->paddr, skb->len, DMA\_TO\_DEVICE); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:46:11 +0000



=== Content from git.kernel.org_9ee19bc2_20250115_094735.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rameshkumar Sundaram <quic\_ramess@quicinc.com> | 2024-10-01 14:56:52 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:11 +0100 |
| commit | [e5e15c8b42923bfb6c84d3d906a9965d9a0f111d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d)) | |
| tree | [1725b2bb96d849caf2597f6d98d78321855f058a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d) | |
| parent | [e51cbe40b77a32e8698ad8b9582e5b4fce6da364](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d&id2=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)) | |
| download | [linux-e5e15c8b42923bfb6c84d3d906a9965d9a0f111d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e5e15c8b42923bfb6c84d3d906a9965d9a0f111d.tar.gz) | |

wifi: ath12k: fix use-after-free in ath12k\_dp\_cc\_cleanup()[ Upstream commit bdb281103373fd80eb5c91cede1e115ba270b4e9 ]
During ath12k module removal, in ath12k\_core\_deinit(),
ath12k\_mac\_destroy() un-registers ah->hw from mac80211 and frees
the ah->hw as well as all the ar's in it. After this
ath12k\_core\_soc\_destroy()-> ath12k\_dp\_free()-> ath12k\_dp\_cc\_cleanup()
tries to access one of the freed ar's from pending skb.
This is because during mac destroy, driver failed to flush few
data packets, which were accessed later in ath12k\_dp\_cc\_cleanup()
and freed, but using ar from the packet led to this use-after-free.
BUG: KASAN: use-after-free in ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
Write of size 4 at addr ffff888150bd3514 by task modprobe/8926
CPU: 0 UID: 0 PID: 8926 Comm: modprobe Not tainted
6.11.0-rc2-wt-ath+ #1746
Hardware name: Intel(R) Client Systems NUC8i7HVK/NUC8i7HVB, BIOS
HNKBLi70.86A.0067.2021.0528.1339 05/28/2021
Call Trace:
<TASK>
dump\_stack\_lvl+0x7d/0xe0
print\_address\_description.constprop.0+0x33/0x3a0
print\_report+0xb5/0x260
? kasan\_addr\_to\_slab+0x24/0x80
kasan\_report+0xd8/0x110
? ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
? ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
kasan\_check\_range+0xf3/0x1a0
\_\_kasan\_check\_write+0x14/0x20
ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
ath12k\_dp\_free+0x178/0x420 [ath12k]
ath12k\_core\_stop+0x176/0x200 [ath12k]
ath12k\_core\_deinit+0x13f/0x210 [ath12k]
ath12k\_pci\_remove+0xad/0x1c0 [ath12k]
pci\_device\_remove+0x9b/0x1b0
device\_remove+0xbf/0x150
device\_release\_driver\_internal+0x3c3/0x580
? \_\_kasan\_check\_read+0x11/0x20
driver\_detach+0xc4/0x190
bus\_remove\_driver+0x130/0x2a0
driver\_unregister+0x68/0x90
pci\_unregister\_driver+0x24/0x240
? find\_module\_all+0x13e/0x1e0
ath12k\_pci\_exit+0x10/0x20 [ath12k]
\_\_do\_sys\_delete\_module+0x32c/0x580
? module\_flags+0x2f0/0x2f0
? kmem\_cache\_free+0xf0/0x410
? \_\_fput+0x56f/0xab0
? \_\_fput+0x56f/0xab0
? debug\_smp\_processor\_id+0x17/0x20
\_\_x64\_sys\_delete\_module+0x4f/0x70
x64\_sys\_call+0x522/0x9f0
do\_syscall\_64+0x64/0x130
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7f8182c6ac8b
Commit 24de1b7b231c ("wifi: ath12k: fix flush failure in recovery
scenarios") added the change to decrement the pending packets count
in case of recovery which make sense as ah->hw as well all
ar's in it are intact during recovery, but during core deinit there
is no use in decrementing packets count or waking up the empty waitq
as the module is going to be removed also ar's from pending skb's
can't be used and the packets should just be released back.
To fix this, avoid accessing ar from skb->cb when driver is being
unregistered.
Tested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.1.1-00214-QCAHKSWPL\_SILICONZ-1
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0.c5-00481-QCAHMTSWPL\_V1.0\_V2.0\_SILICONZ-3
Fixes: 24de1b7b231c ("wifi: ath12k: fix flush failure in recovery scenarios")
Signed-off-by: Rameshkumar Sundaram <quic\_ramess@quicinc.com>
Acked-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Link: [https://patch.msgid.link/20241001092652.3134334-1-quic\_ramess@quicinc.com](https://patch.msgid.link/20241001092652.3134334-1-quic_ramess%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d)

| -rw-r--r-- | [drivers/net/wireless/ath/ath12k/dp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/dp.c?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 4 deletions

| diff --git a/drivers/net/wireless/ath/ath12k/dp.c b/drivers/net/wireless/ath/ath12k/dp.cindex 61aa78d8bd8c8f..abddeafabfa1b7 100644--- a/[drivers/net/wireless/ath/ath12k/dp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/dp.c?id=e51cbe40b77a32e8698ad8b9582e5b4fce6da364)+++ b/[drivers/net/wireless/ath/ath12k/dp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/dp.c?id=e5e15c8b42923bfb6c84d3d906a9965d9a0f111d)@@ -1202,10 +1202,16 @@ static void ath12k\_dp\_cc\_cleanup(struct ath12k\_base \*ab) if (!skb) continue; - skb\_cb = ATH12K\_SKB\_CB(skb);- ar = skb\_cb->ar;- if (atomic\_dec\_and\_test(&ar->dp.num\_tx\_pending))- wake\_up(&ar->dp.tx\_empty\_waitq);+ /\* if we are unregistering, hw would've been destroyed and+ \* ar is no longer valid.+ \*/+ if (!(test\_bit(ATH12K\_FLAG\_UNREGISTERING, &ab->dev\_flags))) {+ skb\_cb = ATH12K\_SKB\_CB(skb);+ ar = skb\_cb->ar;++ if (atomic\_dec\_and\_test(&ar->dp.num\_tx\_pending))+ wake\_up(&ar->dp.tx\_empty\_waitq);+ }  dma\_unmap\_single(ab->dev, ATH12K\_SKB\_CB(skb)->paddr, skb->len, DMA\_TO\_DEVICE); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:46:12 +0000



=== Content from git.kernel.org_0d64a52c_20250115_094734.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35be5018a2a4d1b07bdfcf957c81121d22d16355)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35be5018a2a4d1b07bdfcf957c81121d22d16355)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35be5018a2a4d1b07bdfcf957c81121d22d16355)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35be5018a2a4d1b07bdfcf957c81121d22d16355)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rameshkumar Sundaram <quic\_ramess@quicinc.com> | 2024-10-01 14:56:52 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:41 +0100 |
| commit | [35be5018a2a4d1b07bdfcf957c81121d22d16355](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35be5018a2a4d1b07bdfcf957c81121d22d16355) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35be5018a2a4d1b07bdfcf957c81121d22d16355)) | |
| tree | [2cbeef43dfbe8c5cb6c64056a94b6d4383aaf424](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35be5018a2a4d1b07bdfcf957c81121d22d16355) | |
| parent | [5860c637513036a6ffc130950ea98676b591b47c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5860c637513036a6ffc130950ea98676b591b47c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35be5018a2a4d1b07bdfcf957c81121d22d16355&id2=5860c637513036a6ffc130950ea98676b591b47c)) | |
| download | [linux-35be5018a2a4d1b07bdfcf957c81121d22d16355.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35be5018a2a4d1b07bdfcf957c81121d22d16355.tar.gz) | |

wifi: ath12k: fix use-after-free in ath12k\_dp\_cc\_cleanup()[ Upstream commit bdb281103373fd80eb5c91cede1e115ba270b4e9 ]
During ath12k module removal, in ath12k\_core\_deinit(),
ath12k\_mac\_destroy() un-registers ah->hw from mac80211 and frees
the ah->hw as well as all the ar's in it. After this
ath12k\_core\_soc\_destroy()-> ath12k\_dp\_free()-> ath12k\_dp\_cc\_cleanup()
tries to access one of the freed ar's from pending skb.
This is because during mac destroy, driver failed to flush few
data packets, which were accessed later in ath12k\_dp\_cc\_cleanup()
and freed, but using ar from the packet led to this use-after-free.
BUG: KASAN: use-after-free in ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
Write of size 4 at addr ffff888150bd3514 by task modprobe/8926
CPU: 0 UID: 0 PID: 8926 Comm: modprobe Not tainted
6.11.0-rc2-wt-ath+ #1746
Hardware name: Intel(R) Client Systems NUC8i7HVK/NUC8i7HVB, BIOS
HNKBLi70.86A.0067.2021.0528.1339 05/28/2021
Call Trace:
<TASK>
dump\_stack\_lvl+0x7d/0xe0
print\_address\_description.constprop.0+0x33/0x3a0
print\_report+0xb5/0x260
? kasan\_addr\_to\_slab+0x24/0x80
kasan\_report+0xd8/0x110
? ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
? ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
kasan\_check\_range+0xf3/0x1a0
\_\_kasan\_check\_write+0x14/0x20
ath12k\_dp\_cc\_cleanup.part.0+0x5e2/0xd40 [ath12k]
ath12k\_dp\_free+0x178/0x420 [ath12k]
ath12k\_core\_stop+0x176/0x200 [ath12k]
ath12k\_core\_deinit+0x13f/0x210 [ath12k]
ath12k\_pci\_remove+0xad/0x1c0 [ath12k]
pci\_device\_remove+0x9b/0x1b0
device\_remove+0xbf/0x150
device\_release\_driver\_internal+0x3c3/0x580
? \_\_kasan\_check\_read+0x11/0x20
driver\_detach+0xc4/0x190
bus\_remove\_driver+0x130/0x2a0
driver\_unregister+0x68/0x90
pci\_unregister\_driver+0x24/0x240
? find\_module\_all+0x13e/0x1e0
ath12k\_pci\_exit+0x10/0x20 [ath12k]
\_\_do\_sys\_delete\_module+0x32c/0x580
? module\_flags+0x2f0/0x2f0
? kmem\_cache\_free+0xf0/0x410
? \_\_fput+0x56f/0xab0
? \_\_fput+0x56f/0xab0
? debug\_smp\_processor\_id+0x17/0x20
\_\_x64\_sys\_delete\_module+0x4f/0x70
x64\_sys\_call+0x522/0x9f0
do\_syscall\_64+0x64/0x130
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7f8182c6ac8b
Commit 24de1b7b231c ("wifi: ath12k: fix flush failure in recovery
scenarios") added the change to decrement the pending packets count
in case of recovery which make sense as ah->hw as well all
ar's in it are intact during recovery, but during core deinit there
is no use in decrementing packets count or waking up the empty waitq
as the module is going to be removed also ar's from pending skb's
can't be used and the packets should just be released back.
To fix this, avoid accessing ar from skb->cb when driver is being
unregistered.
Tested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.1.1-00214-QCAHKSWPL\_SILICONZ-1
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0.c5-00481-QCAHMTSWPL\_V1.0\_V2.0\_SILICONZ-3
Fixes: 24de1b7b231c ("wifi: ath12k: fix flush failure in recovery scenarios")
Signed-off-by: Rameshkumar Sundaram <quic\_ramess@quicinc.com>
Acked-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Link: [https://patch.msgid.link/20241001092652.3134334-1-quic\_ramess@quicinc.com](https://patch.msgid.link/20241001092652.3134334-1-quic_ramess%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35be5018a2a4d1b07bdfcf957c81121d22d16355)

| -rw-r--r-- | [drivers/net/wireless/ath/ath12k/dp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/dp.c?id=35be5018a2a4d1b07bdfcf957c81121d22d16355) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 4 deletions

| diff --git a/drivers/net/wireless/ath/ath12k/dp.c b/drivers/net/wireless/ath/ath12k/dp.cindex 61aa78d8bd8c8f..abddeafabfa1b7 100644--- a/[drivers/net/wireless/ath/ath12k/dp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/dp.c?id=5860c637513036a6ffc130950ea98676b591b47c)+++ b/[drivers/net/wireless/ath/ath12k/dp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/dp.c?id=35be5018a2a4d1b07bdfcf957c81121d22d16355)@@ -1202,10 +1202,16 @@ static void ath12k\_dp\_cc\_cleanup(struct ath12k\_base \*ab) if (!skb) continue; - skb\_cb = ATH12K\_SKB\_CB(skb);- ar = skb\_cb->ar;- if (atomic\_dec\_and\_test(&ar->dp.num\_tx\_pending))- wake\_up(&ar->dp.tx\_empty\_waitq);+ /\* if we are unregistering, hw would've been destroyed and+ \* ar is no longer valid.+ \*/+ if (!(test\_bit(ATH12K\_FLAG\_UNREGISTERING, &ab->dev\_flags))) {+ skb\_cb = ATH12K\_SKB\_CB(skb);+ ar = skb\_cb->ar;++ if (atomic\_dec\_and\_test(&ar->dp.num\_tx\_pending))+ wake\_up(&ar->dp.tx\_empty\_waitq);+ }  dma\_unmap\_single(ab->dev, ATH12K\_SKB\_CB(skb)->paddr, skb->len, DMA\_TO\_DEVICE); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:46:11 +0000


