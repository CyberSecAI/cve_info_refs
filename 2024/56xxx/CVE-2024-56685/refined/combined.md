=== Content from git.kernel.org_b482a9ae_20250114_203907.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=550279449ff54c5aa28cfca5c567308cbfb145f0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=550279449ff54c5aa28cfca5c567308cbfb145f0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=550279449ff54c5aa28cfca5c567308cbfb145f0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=550279449ff54c5aa28cfca5c567308cbfb145f0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nícolas F. R. A. Prado <nfraprado@collabora.com> | 2024-11-26 15:09:43 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:40 +0100 |
| commit | [550279449ff54c5aa28cfca5c567308cbfb145f0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=550279449ff54c5aa28cfca5c567308cbfb145f0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=550279449ff54c5aa28cfca5c567308cbfb145f0)) | |
| tree | [e122568f4fca7f8e6e565f4c9e7a1a8611ba3668](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=550279449ff54c5aa28cfca5c567308cbfb145f0) | |
| parent | [b4b69142aae7d6d84fbb157ad902c9fb39fd24d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4b69142aae7d6d84fbb157ad902c9fb39fd24d6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=550279449ff54c5aa28cfca5c567308cbfb145f0&id2=b4b69142aae7d6d84fbb157ad902c9fb39fd24d6)) | |
| download | [linux-550279449ff54c5aa28cfca5c567308cbfb145f0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-550279449ff54c5aa28cfca5c567308cbfb145f0.tar.gz) | |

ASoC: mediatek: Check num\_codecs is not zero to avoid panic during probe[ Upstream commit 2f2020327cc8561d7c520d2f2d9acea84fa7b3a3 ]
Following commit 13f58267cda3 ("ASoC: soc.h: don't create dummy
Component via COMP\_DUMMY()"), COMP\_DUMMY() became an array with zero
length, and only gets populated with the dummy struct after the card is
registered. Since the sound card driver's probe happens before the card
registration, accessing any of the members of a dummy component during
probe will result in undefined behavior.
This can be observed in the mt8188 and mt8195 machine sound drivers. By
omitting a dai link subnode in the sound card's node in the Devicetree,
the default uninitialized dummy codec is used, and when its dai\_name
pointer gets passed to strcmp() it results in a null pointer dereference
and a kernel panic.
In addition to that, set\_card\_codec\_info() in the generic helpers file,
mtk-soundcard-driver.c, will populate a dai link with a dummy codec when
a dai link node is present in DT but with no codec property.
The result is that at probe time, a dummy codec can either be
uninitialized with num\_codecs = 0, or be an initialized dummy codec,
with num\_codecs = 1 and dai\_name = "snd-soc-dummy-dai". In order to
accommodate for both situations, check that num\_codecs is not zero
before accessing the codecs' fields but still check for the codec's dai
name against "snd-soc-dummy-dai" as needed.
While at it, also drop the check that dai\_name is not null in the mt8192
driver, introduced in commit 4d4e1b6319e5 ("ASoC: mediatek: mt8192:
Check existence of dai\_name before dereferencing"), as it is actually
redundant given the preceding num\_codecs != 0 check.
Fixes: 13f58267cda3 ("ASoC: soc.h: don't create dummy Component via COMP\_DUMMY()")
Signed-off-by: Nícolas F. R. A. Prado <nfraprado@collabora.com>
Reviewed-by: AngeloGioacchino Del Regno <angelogioacchino.delregno@collabora.com>
Acked-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
Reviewed-by: Fei Shao <fshao@chromium.org>
Acked-by: Trevor Wu <trevor.wu@mediatek.com>
Link: [https://patch.msgid.link/20241126-asoc-mtk-dummy-panic-v1-1-42d53e168d2e@collabora.com](https://patch.msgid.link/20241126-asoc-mtk-dummy-panic-v1-1-42d53e168d2e%40collabora.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=550279449ff54c5aa28cfca5c567308cbfb145f0)

| -rw-r--r-- | [sound/soc/mediatek/mt8188/mt8188-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/mediatek/mt8188/mt8188-mt6359.c?id=550279449ff54c5aa28cfca5c567308cbfb145f0) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c?id=550279449ff54c5aa28cfca5c567308cbfb145f0) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/soc/mediatek/mt8195/mt8195-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/mediatek/mt8195/mt8195-mt6359.c?id=550279449ff54c5aa28cfca5c567308cbfb145f0) | 9 | |  |  |  | | --- | --- | --- | |

3 files changed, 16 insertions, 6 deletions

| diff --git a/sound/soc/mediatek/mt8188/mt8188-mt6359.c b/sound/soc/mediatek/mt8188/mt8188-mt6359.cindex 08ae962afeb929..4eed90d13a5326 100644--- a/[sound/soc/mediatek/mt8188/mt8188-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8188/mt8188-mt6359.c?id=b4b69142aae7d6d84fbb157ad902c9fb39fd24d6)+++ b/[sound/soc/mediatek/mt8188/mt8188-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8188/mt8188-mt6359.c?id=550279449ff54c5aa28cfca5c567308cbfb145f0)@@ -1279,10 +1279,12 @@ static int mt8188\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data,  for\_each\_card\_prelinks(card, i, dai\_link) { if (strcmp(dai\_link->name, "DPTX\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8188\_dptx\_codec\_init; } else if (strcmp(dai\_link->name, "ETDM3\_OUT\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8188\_hdmi\_codec\_init; } else if (strcmp(dai\_link->name, "DL\_SRC\_BE") == 0 || strcmp(dai\_link->name, "UL\_SRC\_BE") == 0) {@@ -1294,6 +1296,9 @@ static int mt8188\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data, strcmp(dai\_link->name, "ETDM2\_OUT\_BE") == 0 || strcmp(dai\_link->name, "ETDM1\_IN\_BE") == 0 || strcmp(dai\_link->name, "ETDM2\_IN\_BE") == 0) {+ if (!dai\_link->num\_codecs)+ continue;+ if (!strcmp(dai\_link->codecs->dai\_name, MAX98390\_CODEC\_DAI)) { /\* \* The TDM protocol settings with fixed 4 slots are defined indiff --git a/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c b/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.cindex db00704e206d6d..943f8116840373 100644--- a/[sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c?id=b4b69142aae7d6d84fbb157ad902c9fb39fd24d6)+++ b/[sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c?id=550279449ff54c5aa28cfca5c567308cbfb145f0)@@ -1099,7 +1099,7 @@ static int mt8192\_mt6359\_legacy\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data) dai\_link->ignore = 0; } - if (dai\_link->num\_codecs && dai\_link->codecs[0].dai\_name &&+ if (dai\_link->num\_codecs && strcmp(dai\_link->codecs[0].dai\_name, RT1015\_CODEC\_DAI) == 0) dai\_link->ops = &mt8192\_rt1015\_i2s\_ops; }@@ -1127,7 +1127,7 @@ static int mt8192\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data, int i;  for\_each\_card\_prelinks(card, i, dai\_link)- if (dai\_link->num\_codecs && dai\_link->codecs[0].dai\_name &&+ if (dai\_link->num\_codecs && strcmp(dai\_link->codecs[0].dai\_name, RT1015\_CODEC\_DAI) == 0) dai\_link->ops = &mt8192\_rt1015\_i2s\_ops; }diff --git a/sound/soc/mediatek/mt8195/mt8195-mt6359.c b/sound/soc/mediatek/mt8195/mt8195-mt6359.cindex 2832ef78eaed72..8ebf6c7502aa3d 100644--- a/[sound/soc/mediatek/mt8195/mt8195-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8195/mt8195-mt6359.c?id=b4b69142aae7d6d84fbb157ad902c9fb39fd24d6)+++ b/[sound/soc/mediatek/mt8195/mt8195-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8195/mt8195-mt6359.c?id=550279449ff54c5aa28cfca5c567308cbfb145f0)@@ -1380,10 +1380,12 @@ static int mt8195\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data,  for\_each\_card\_prelinks(card, i, dai\_link) { if (strcmp(dai\_link->name, "DPTX\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8195\_dptx\_codec\_init; } else if (strcmp(dai\_link->name, "ETDM3\_OUT\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8195\_hdmi\_codec\_init; } else if (strcmp(dai\_link->name, "DL\_SRC\_BE") == 0 || strcmp(dai\_link->name, "UL\_SRC1\_BE") == 0 ||@@ -1396,6 +1398,9 @@ static int mt8195\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data, strcmp(dai\_link->name, "ETDM2\_OUT\_BE") == 0 || strcmp(dai\_link->name, "ETDM1\_IN\_BE") == 0 || strcmp(dai\_link->name, "ETDM2\_IN\_BE") == 0) {+ if (!dai\_link->num\_codecs)+ continue;+ if (!strcmp(dai\_link->codecs->dai\_name, MAX98390\_CODEC\_DAI)) { if (!(codec\_init & MAX98390\_CODEC\_INIT)) { dai\_link->init = mt8195\_max98390\_init; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:44 +0000



=== Content from git.kernel.org_1577e146_20250114_203906.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nícolas F. R. A. Prado <nfraprado@collabora.com> | 2024-11-26 15:09:43 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:06 +0100 |
| commit | [376f4800f34a28def026ff5c5d4fc5e54e1744ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff)) | |
| tree | [f3aff477c6f9d25b025f582dcb8bee9233f81b68](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff) | |
| parent | [c92e92d3fdc5fb91baa12493a2aef6394130b476](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c92e92d3fdc5fb91baa12493a2aef6394130b476) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff&id2=c92e92d3fdc5fb91baa12493a2aef6394130b476)) | |
| download | [linux-376f4800f34a28def026ff5c5d4fc5e54e1744ff.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-376f4800f34a28def026ff5c5d4fc5e54e1744ff.tar.gz) | |

ASoC: mediatek: Check num\_codecs is not zero to avoid panic during probe[ Upstream commit 2f2020327cc8561d7c520d2f2d9acea84fa7b3a3 ]
Following commit 13f58267cda3 ("ASoC: soc.h: don't create dummy
Component via COMP\_DUMMY()"), COMP\_DUMMY() became an array with zero
length, and only gets populated with the dummy struct after the card is
registered. Since the sound card driver's probe happens before the card
registration, accessing any of the members of a dummy component during
probe will result in undefined behavior.
This can be observed in the mt8188 and mt8195 machine sound drivers. By
omitting a dai link subnode in the sound card's node in the Devicetree,
the default uninitialized dummy codec is used, and when its dai\_name
pointer gets passed to strcmp() it results in a null pointer dereference
and a kernel panic.
In addition to that, set\_card\_codec\_info() in the generic helpers file,
mtk-soundcard-driver.c, will populate a dai link with a dummy codec when
a dai link node is present in DT but with no codec property.
The result is that at probe time, a dummy codec can either be
uninitialized with num\_codecs = 0, or be an initialized dummy codec,
with num\_codecs = 1 and dai\_name = "snd-soc-dummy-dai". In order to
accommodate for both situations, check that num\_codecs is not zero
before accessing the codecs' fields but still check for the codec's dai
name against "snd-soc-dummy-dai" as needed.
While at it, also drop the check that dai\_name is not null in the mt8192
driver, introduced in commit 4d4e1b6319e5 ("ASoC: mediatek: mt8192:
Check existence of dai\_name before dereferencing"), as it is actually
redundant given the preceding num\_codecs != 0 check.
Fixes: 13f58267cda3 ("ASoC: soc.h: don't create dummy Component via COMP\_DUMMY()")
Signed-off-by: Nícolas F. R. A. Prado <nfraprado@collabora.com>
Reviewed-by: AngeloGioacchino Del Regno <angelogioacchino.delregno@collabora.com>
Acked-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
Reviewed-by: Fei Shao <fshao@chromium.org>
Acked-by: Trevor Wu <trevor.wu@mediatek.com>
Link: [https://patch.msgid.link/20241126-asoc-mtk-dummy-panic-v1-1-42d53e168d2e@collabora.com](https://patch.msgid.link/20241126-asoc-mtk-dummy-panic-v1-1-42d53e168d2e%40collabora.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff)

| -rw-r--r-- | [sound/soc/mediatek/mt8188/mt8188-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/mediatek/mt8188/mt8188-mt6359.c?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/soc/mediatek/mt8195/mt8195-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/mediatek/mt8195/mt8195-mt6359.c?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff) | 9 | |  |  |  | | --- | --- | --- | |

3 files changed, 16 insertions, 6 deletions

| diff --git a/sound/soc/mediatek/mt8188/mt8188-mt6359.c b/sound/soc/mediatek/mt8188/mt8188-mt6359.cindex 08ae962afeb929..4eed90d13a5326 100644--- a/[sound/soc/mediatek/mt8188/mt8188-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8188/mt8188-mt6359.c?id=c92e92d3fdc5fb91baa12493a2aef6394130b476)+++ b/[sound/soc/mediatek/mt8188/mt8188-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8188/mt8188-mt6359.c?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff)@@ -1279,10 +1279,12 @@ static int mt8188\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data,  for\_each\_card\_prelinks(card, i, dai\_link) { if (strcmp(dai\_link->name, "DPTX\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8188\_dptx\_codec\_init; } else if (strcmp(dai\_link->name, "ETDM3\_OUT\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8188\_hdmi\_codec\_init; } else if (strcmp(dai\_link->name, "DL\_SRC\_BE") == 0 || strcmp(dai\_link->name, "UL\_SRC\_BE") == 0) {@@ -1294,6 +1296,9 @@ static int mt8188\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data, strcmp(dai\_link->name, "ETDM2\_OUT\_BE") == 0 || strcmp(dai\_link->name, "ETDM1\_IN\_BE") == 0 || strcmp(dai\_link->name, "ETDM2\_IN\_BE") == 0) {+ if (!dai\_link->num\_codecs)+ continue;+ if (!strcmp(dai\_link->codecs->dai\_name, MAX98390\_CODEC\_DAI)) { /\* \* The TDM protocol settings with fixed 4 slots are defined indiff --git a/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c b/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.cindex 8b323fb199251b..de8737dcf53d70 100644--- a/[sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c?id=c92e92d3fdc5fb91baa12493a2aef6394130b476)+++ b/[sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff)@@ -1099,7 +1099,7 @@ static int mt8192\_mt6359\_legacy\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data) dai\_link->ignore = 0; } - if (dai\_link->num\_codecs && dai\_link->codecs[0].dai\_name &&+ if (dai\_link->num\_codecs && strcmp(dai\_link->codecs[0].dai\_name, RT1015\_CODEC\_DAI) == 0) dai\_link->ops = &mt8192\_rt1015\_i2s\_ops; }@@ -1129,7 +1129,7 @@ static int mt8192\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data, int i;  for\_each\_card\_prelinks(card, i, dai\_link)- if (dai\_link->num\_codecs && dai\_link->codecs[0].dai\_name &&+ if (dai\_link->num\_codecs && strcmp(dai\_link->codecs[0].dai\_name, RT1015\_CODEC\_DAI) == 0) dai\_link->ops = &mt8192\_rt1015\_i2s\_ops; }diff --git a/sound/soc/mediatek/mt8195/mt8195-mt6359.c b/sound/soc/mediatek/mt8195/mt8195-mt6359.cindex 2832ef78eaed72..8ebf6c7502aa3d 100644--- a/[sound/soc/mediatek/mt8195/mt8195-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8195/mt8195-mt6359.c?id=c92e92d3fdc5fb91baa12493a2aef6394130b476)+++ b/[sound/soc/mediatek/mt8195/mt8195-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8195/mt8195-mt6359.c?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff)@@ -1380,10 +1380,12 @@ static int mt8195\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data,  for\_each\_card\_prelinks(card, i, dai\_link) { if (strcmp(dai\_link->name, "DPTX\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8195\_dptx\_codec\_init; } else if (strcmp(dai\_link->name, "ETDM3\_OUT\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8195\_hdmi\_codec\_init; } else if (strcmp(dai\_link->name, "DL\_SRC\_BE") == 0 || strcmp(dai\_link->name, "UL\_SRC1\_BE") == 0 ||@@ -1396,6 +1398,9 @@ static int mt8195\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data, strcmp(dai\_link->name, "ETDM2\_OUT\_BE") == 0 || strcmp(dai\_link->name, "ETDM1\_IN\_BE") == 0 || strcmp(dai\_link->name, "ETDM2\_IN\_BE") == 0) {+ if (!dai\_link->num\_codecs)+ continue;+ if (!strcmp(dai\_link->codecs->dai\_name, MAX98390\_CODEC\_DAI)) { if (!(codec\_init & MAX98390\_CODEC\_INIT)) { dai\_link->init = mt8195\_max98390\_init; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:43 +0000



=== Content from git.kernel.org_1a0e872c_20250114_203906.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nícolas F. R. A. Prado <nfraprado@collabora.com> | 2024-11-26 15:09:43 -0500 |
| --- | --- | --- |
| committer | Mark Brown <broonie@kernel.org> | 2024-11-27 11:28:25 +0000 |
| commit | [2f2020327cc8561d7c520d2f2d9acea84fa7b3a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3)) | |
| tree | [42ec2d693c0992f8a424b2f7ff23aef492ddf70c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3) | |
| parent | [4095cf872084ecfdfdb0e681f3e9ff9745acfa75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4095cf872084ecfdfdb0e681f3e9ff9745acfa75) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3&id2=4095cf872084ecfdfdb0e681f3e9ff9745acfa75)) | |
| download | [linux-2f2020327cc8561d7c520d2f2d9acea84fa7b3a3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2f2020327cc8561d7c520d2f2d9acea84fa7b3a3.tar.gz) | |

ASoC: mediatek: Check num\_codecs is not zero to avoid panic during probeFollowing commit 13f58267cda3 ("ASoC: soc.h: don't create dummy
Component via COMP\_DUMMY()"), COMP\_DUMMY() became an array with zero
length, and only gets populated with the dummy struct after the card is
registered. Since the sound card driver's probe happens before the card
registration, accessing any of the members of a dummy component during
probe will result in undefined behavior.
This can be observed in the mt8188 and mt8195 machine sound drivers. By
omitting a dai link subnode in the sound card's node in the Devicetree,
the default uninitialized dummy codec is used, and when its dai\_name
pointer gets passed to strcmp() it results in a null pointer dereference
and a kernel panic.
In addition to that, set\_card\_codec\_info() in the generic helpers file,
mtk-soundcard-driver.c, will populate a dai link with a dummy codec when
a dai link node is present in DT but with no codec property.
The result is that at probe time, a dummy codec can either be
uninitialized with num\_codecs = 0, or be an initialized dummy codec,
with num\_codecs = 1 and dai\_name = "snd-soc-dummy-dai". In order to
accommodate for both situations, check that num\_codecs is not zero
before accessing the codecs' fields but still check for the codec's dai
name against "snd-soc-dummy-dai" as needed.
While at it, also drop the check that dai\_name is not null in the mt8192
driver, introduced in commit 4d4e1b6319e5 ("ASoC: mediatek: mt8192:
Check existence of dai\_name before dereferencing"), as it is actually
redundant given the preceding num\_codecs != 0 check.
Fixes: 13f58267cda3 ("ASoC: soc.h: don't create dummy Component via COMP\_DUMMY()")
Signed-off-by: Nícolas F. R. A. Prado <nfraprado@collabora.com>
Reviewed-by: AngeloGioacchino Del Regno <angelogioacchino.delregno@collabora.com>
Acked-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
Reviewed-by: Fei Shao <fshao@chromium.org>
Acked-by: Trevor Wu <trevor.wu@mediatek.com>
Link: [https://patch.msgid.link/20241126-asoc-mtk-dummy-panic-v1-1-42d53e168d2e@collabora.com](https://patch.msgid.link/20241126-asoc-mtk-dummy-panic-v1-1-42d53e168d2e%40collabora.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3)

| -rw-r--r-- | [sound/soc/mediatek/mt8188/mt8188-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/mediatek/mt8188/mt8188-mt6359.c?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/soc/mediatek/mt8195/mt8195-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/mediatek/mt8195/mt8195-mt6359.c?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3) | 9 | |  |  |  | | --- | --- | --- | |

3 files changed, 16 insertions, 6 deletions

| diff --git a/sound/soc/mediatek/mt8188/mt8188-mt6359.c b/sound/soc/mediatek/mt8188/mt8188-mt6359.cindex 84abdba9ddb6d6..e04b88a57535ce 100644--- a/[sound/soc/mediatek/mt8188/mt8188-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8188/mt8188-mt6359.c?id=4095cf872084ecfdfdb0e681f3e9ff9745acfa75)+++ b/[sound/soc/mediatek/mt8188/mt8188-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8188/mt8188-mt6359.c?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3)@@ -1277,10 +1277,12 @@ static int mt8188\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data,  for\_each\_card\_prelinks(card, i, dai\_link) { if (strcmp(dai\_link->name, "DPTX\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8188\_dptx\_codec\_init; } else if (strcmp(dai\_link->name, "ETDM3\_OUT\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8188\_hdmi\_codec\_init; } else if (strcmp(dai\_link->name, "DL\_SRC\_BE") == 0 || strcmp(dai\_link->name, "UL\_SRC\_BE") == 0) {@@ -1292,6 +1294,9 @@ static int mt8188\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data, strcmp(dai\_link->name, "ETDM2\_OUT\_BE") == 0 || strcmp(dai\_link->name, "ETDM1\_IN\_BE") == 0 || strcmp(dai\_link->name, "ETDM2\_IN\_BE") == 0) {+ if (!dai\_link->num\_codecs)+ continue;+ if (!strcmp(dai\_link->codecs->dai\_name, MAX98390\_CODEC\_DAI)) { /\* \* The TDM protocol settings with fixed 4 slots are defined indiff --git a/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c b/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.cindex 1aba9c75594eb6..b1598cc5587e30 100644--- a/[sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c?id=4095cf872084ecfdfdb0e681f3e9ff9745acfa75)+++ b/[sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8192/mt8192-mt6359-rt1015-rt5682.c?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3)@@ -1091,7 +1091,7 @@ static int mt8192\_mt6359\_legacy\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data) dai\_link->ignore = 0; } - if (dai\_link->num\_codecs && dai\_link->codecs[0].dai\_name &&+ if (dai\_link->num\_codecs && strcmp(dai\_link->codecs[0].dai\_name, RT1015\_CODEC\_DAI) == 0) dai\_link->ops = &mt8192\_rt1015\_i2s\_ops; }@@ -1119,7 +1119,7 @@ static int mt8192\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data, int i;  for\_each\_card\_prelinks(card, i, dai\_link)- if (dai\_link->num\_codecs && dai\_link->codecs[0].dai\_name &&+ if (dai\_link->num\_codecs && strcmp(dai\_link->codecs[0].dai\_name, RT1015\_CODEC\_DAI) == 0) dai\_link->ops = &mt8192\_rt1015\_i2s\_ops; }diff --git a/sound/soc/mediatek/mt8195/mt8195-mt6359.c b/sound/soc/mediatek/mt8195/mt8195-mt6359.cindex 56b9d2433a1eb1..2b9cb3248795b8 100644--- a/[sound/soc/mediatek/mt8195/mt8195-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8195/mt8195-mt6359.c?id=4095cf872084ecfdfdb0e681f3e9ff9745acfa75)+++ b/[sound/soc/mediatek/mt8195/mt8195-mt6359.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/mediatek/mt8195/mt8195-mt6359.c?id=2f2020327cc8561d7c520d2f2d9acea84fa7b3a3)@@ -1378,10 +1378,12 @@ static int mt8195\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data,  for\_each\_card\_prelinks(card, i, dai\_link) { if (strcmp(dai\_link->name, "DPTX\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8195\_dptx\_codec\_init; } else if (strcmp(dai\_link->name, "ETDM3\_OUT\_BE") == 0) {- if (strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai"))+ if (dai\_link->num\_codecs &&+ strcmp(dai\_link->codecs->dai\_name, "snd-soc-dummy-dai")) dai\_link->init = mt8195\_hdmi\_codec\_init; } else if (strcmp(dai\_link->name, "DL\_SRC\_BE") == 0 || strcmp(dai\_link->name, "UL\_SRC1\_BE") == 0 ||@@ -1394,6 +1396,9 @@ static int mt8195\_mt6359\_soc\_card\_probe(struct mtk\_soc\_card\_data \*soc\_card\_data, strcmp(dai\_link->name, "ETDM2\_OUT\_BE") == 0 || strcmp(dai\_link->name, "ETDM1\_IN\_BE") == 0 || strcmp(dai\_link->name, "ETDM2\_IN\_BE") == 0) {+ if (!dai\_link->num\_codecs)+ continue;+ if (!strcmp(dai\_link->codecs->dai\_name, MAX98390\_CODEC\_DAI)) { if (!(codec\_init & MAX98390\_CODEC\_INIT)) { dai\_link->init = mt8195\_max98390\_init; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:43 +0000


