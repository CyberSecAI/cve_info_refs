=== Content from git.kernel.org_3efad7af_20250115_095847.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=61832ee7fa2fbd569d129379e795038abfb0d128)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61832ee7fa2fbd569d129379e795038abfb0d128)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61832ee7fa2fbd569d129379e795038abfb0d128)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61832ee7fa2fbd569d129379e795038abfb0d128)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Long Li <leo.lilong@huawei.com> | 2024-09-06 17:17:46 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:15 +0100 |
| commit | [61832ee7fa2fbd569d129379e795038abfb0d128](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61832ee7fa2fbd569d129379e795038abfb0d128) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=61832ee7fa2fbd569d129379e795038abfb0d128)) | |
| tree | [26dc46931acc15f4fdd8913a7f2e52641a62deb4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61832ee7fa2fbd569d129379e795038abfb0d128) | |
| parent | [bfeecda050aa9376f642d5b2a71c4112cc6c8216](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61832ee7fa2fbd569d129379e795038abfb0d128&id2=bfeecda050aa9376f642d5b2a71c4112cc6c8216)) | |
| download | [linux-61832ee7fa2fbd569d129379e795038abfb0d128.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-61832ee7fa2fbd569d129379e795038abfb0d128.tar.gz) | |

ext4: fix race in buffer\_head read fault injection[ Upstream commit 2f3d93e210b9c2866c8b3662adae427d5bf511ec ]
When I enabled ext4 debug for fault injection testing, I encountered the
following warning:
EXT4-fs error (device sda): ext4\_read\_inode\_bitmap:201: comm fsstress:
Cannot read inode bitmap - block\_group = 8, inode\_bitmap = 1051
WARNING: CPU: 0 PID: 511 at fs/buffer.c:1181 mark\_buffer\_dirty+0x1b3/0x1d0
The root cause of the issue lies in the improper implementation of ext4's
buffer\_head read fault injection. The actual completion of buffer\_head
read and the buffer\_head fault injection are not atomic, which can lead
to the uptodate flag being cleared on normally used buffer\_heads in race
conditions.
[CPU0] [CPU1] [CPU2]
ext4\_read\_inode\_bitmap
ext4\_read\_bh()
<bh read complete>
ext4\_read\_inode\_bitmap
if (buffer\_uptodate(bh))
return bh
jbd2\_journal\_commit\_transaction
\_\_jbd2\_journal\_refile\_buffer
\_\_jbd2\_journal\_unfile\_buffer
\_\_jbd2\_journal\_temp\_unlink\_buffer
ext4\_simulate\_fail\_bh()
clear\_buffer\_uptodate
mark\_buffer\_dirty
<report warning>
WARN\_ON\_ONCE(!buffer\_uptodate(bh))
The best approach would be to perform fault injection in the IO completion
callback function, rather than after IO completion. However, the IO
completion callback function cannot get the fault injection code in sb.
Fix it by passing the result of fault injection into the bh read function,
we simulate faults within the bh read function itself. This requires adding
an extra parameter to the bh read functions that need fault injection.
Fixes: 46f870d690fe ("ext4: simulate various I/O and checksum errors when reading metadata")
Signed-off-by: Long Li <leo.lilong@huawei.com>
Link: [https://patch.msgid.link/20240906091746.510163-1-leo.lilong@huawei.com](https://patch.msgid.link/20240906091746.510163-1-leo.lilong%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61832ee7fa2fbd569d129379e795038abfb0d128)

| -rw-r--r-- | [fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/balloc.c?id=61832ee7fa2fbd569d129379e795038abfb0d128) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/ext4.h?id=61832ee7fa2fbd569d129379e795038abfb0d128) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=61832ee7fa2fbd569d129379e795038abfb0d128) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/ialloc.c?id=61832ee7fa2fbd569d129379e795038abfb0d128) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/indirect.c?id=61832ee7fa2fbd569d129379e795038abfb0d128) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/inode.c?id=61832ee7fa2fbd569d129379e795038abfb0d128) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/mmp.c?id=61832ee7fa2fbd569d129379e795038abfb0d128) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/move_extent.c?id=61832ee7fa2fbd569d129379e795038abfb0d128) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/resize.c?id=61832ee7fa2fbd569d129379e795038abfb0d128) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/super.c?id=61832ee7fa2fbd569d129379e795038abfb0d128) | 23 | |  |  |  | | --- | --- | --- | |

10 files changed, 29 insertions, 29 deletions

| diff --git a/fs/ext4/balloc.c b/fs/ext4/balloc.cindex 591fb3f710be72..8042ad87380897 100644--- a/[fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/balloc.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)+++ b/[fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/balloc.c?id=61832ee7fa2fbd569d129379e795038abfb0d128)@@ -550,7 +550,8 @@ ext4\_read\_block\_bitmap\_nowait(struct super\_block \*sb, ext4\_group\_t block\_group, trace\_ext4\_read\_block\_bitmap\_load(sb, block\_group, ignore\_locked); ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO | (ignore\_locked ? REQ\_RAHEAD : 0),- ext4\_end\_bitmap\_read);+ ext4\_end\_bitmap\_read,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_BBITMAP\_EIO)); return bh; verify: err = ext4\_validate\_block\_bitmap(sb, desc, block\_group, bh);@@ -577,7 +578,6 @@ int ext4\_wait\_block\_bitmap(struct super\_block \*sb, ext4\_group\_t block\_group, if (!desc) return -EFSCORRUPTED; wait\_on\_buffer(bh);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_BBITMAP\_EIO); if (!buffer\_uptodate(bh)) { ext4\_error\_err(sb, EIO, "Cannot read block bitmap - " "block\_group = %u, block\_bitmap = %llu",diff --git a/fs/ext4/ext4.h b/fs/ext4/ext4.hindex 44b0d418143c2e..bbffb76d9a9049 100644--- a/[fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ext4.h?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)+++ b/[fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ext4.h?id=61832ee7fa2fbd569d129379e795038abfb0d128)@@ -1865,14 +1865,6 @@ static inline bool ext4\_simulate\_fail(struct super\_block \*sb, return false; } -static inline void ext4\_simulate\_fail\_bh(struct super\_block \*sb,- struct buffer\_head \*bh,- unsigned long code)-{- if (!IS\_ERR(bh) && ext4\_simulate\_fail(sb, code))- clear\_buffer\_uptodate(bh);-}- /\* \* Error number codes for s\_{first,last}\_error\_errno \*@@ -3100,9 +3092,9 @@ extern struct buffer\_head \*ext4\_sb\_bread(struct super\_block \*sb, extern struct buffer\_head \*ext4\_sb\_bread\_unmovable(struct super\_block \*sb, sector\_t block); extern void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io);+ bh\_end\_io\_t \*end\_io, bool simu\_fail); extern int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io);+ bh\_end\_io\_t \*end\_io, bool simu\_fail); extern int ext4\_read\_bh\_lock(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bool wait); extern void ext4\_sb\_breadahead\_unmovable(struct super\_block \*sb, sector\_t block); extern int ext4\_seq\_options\_show(struct seq\_file \*seq, void \*offset);diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 34e25eee65219c..88f98dc4402753 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=61832ee7fa2fbd569d129379e795038abfb0d128)@@ -568,7 +568,7 @@ \_\_read\_extent\_tree\_block(const char \*function, unsigned int line,  if (!bh\_uptodate\_or\_lock(bh)) { trace\_ext4\_ext\_load\_extent(inode, pblk, \_RET\_IP\_);- err = ext4\_read\_bh(bh, 0, NULL);+ err = ext4\_read\_bh(bh, 0, NULL, false); if (err < 0) goto errout; }diff --git a/fs/ext4/ialloc.c b/fs/ext4/ialloc.cindex 7f1a5f90dbbdff..21d228073d7954 100644--- a/[fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ialloc.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)+++ b/[fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ialloc.c?id=61832ee7fa2fbd569d129379e795038abfb0d128)@@ -193,8 +193,9 @@ ext4\_read\_inode\_bitmap(struct super\_block \*sb, ext4\_group\_t block\_group) \* submit the buffer\_head for reading \*/ trace\_ext4\_load\_inode\_bitmap(sb, block\_group);- ext4\_read\_bh(bh, REQ\_META | REQ\_PRIO, ext4\_end\_bitmap\_read);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_IBITMAP\_EIO);+ ext4\_read\_bh(bh, REQ\_META | REQ\_PRIO,+ ext4\_end\_bitmap\_read,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_IBITMAP\_EIO)); if (!buffer\_uptodate(bh)) { put\_bh(bh); ext4\_error\_err(sb, EIO, "Cannot read inode bitmap - "diff --git a/fs/ext4/indirect.c b/fs/ext4/indirect.cindex 7404f0935c9032..7de327fa7b1c51 100644--- a/[fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/indirect.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)+++ b/[fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/indirect.c?id=61832ee7fa2fbd569d129379e795038abfb0d128)@@ -170,7 +170,7 @@ static Indirect \*ext4\_get\_branch(struct inode \*inode, int depth, }  if (!bh\_uptodate\_or\_lock(bh)) {- if (ext4\_read\_bh(bh, 0, NULL) < 0) {+ if (ext4\_read\_bh(bh, 0, NULL, false) < 0) { put\_bh(bh); goto failure; }diff --git a/fs/ext4/inode.c b/fs/ext4/inode.cindex 54bdd4884fe67d..99d09cd9c6a37e 100644--- a/[fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/inode.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)+++ b/[fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/inode.c?id=61832ee7fa2fbd569d129379e795038abfb0d128)@@ -4497,10 +4497,10 @@ make\_io: \* Read the block from disk. \*/ trace\_ext4\_load\_inode(sb, ino);- ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO, NULL);+ ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO, NULL,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_INODE\_EIO)); blk\_finish\_plug(&plug); wait\_on\_buffer(bh);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_INODE\_EIO); if (!buffer\_uptodate(bh)) { if (ret\_block) \*ret\_block = block;diff --git a/fs/ext4/mmp.c b/fs/ext4/mmp.cindex bd946d0c71b700..d64c04ed061ae9 100644--- a/[fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mmp.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)+++ b/[fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mmp.c?id=61832ee7fa2fbd569d129379e795038abfb0d128)@@ -94,7 +94,7 @@ static int read\_mmp\_block(struct super\_block \*sb, struct buffer\_head \*\*bh, }  lock\_buffer(\*bh);- ret = ext4\_read\_bh(\*bh, REQ\_META | REQ\_PRIO, NULL);+ ret = ext4\_read\_bh(\*bh, REQ\_META | REQ\_PRIO, NULL, false); if (ret) goto warn\_exit; diff --git a/fs/ext4/move\_extent.c b/fs/ext4/move\_extent.cindex b64661ea6e0ed7..898443e98efc9e 100644--- a/[fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/move_extent.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)+++ b/[fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/move_extent.c?id=61832ee7fa2fbd569d129379e795038abfb0d128)@@ -213,7 +213,7 @@ static int mext\_page\_mkuptodate(struct folio \*folio, size\_t from, size\_t to) unlock\_buffer(bh); continue; }- ext4\_read\_bh\_nowait(bh, 0, NULL);+ ext4\_read\_bh\_nowait(bh, 0, NULL, false); nr++; } while (block++, (bh = bh->b\_this\_page) != head); diff --git a/fs/ext4/resize.c b/fs/ext4/resize.cindex a2704f06436106..72f77f78ae8df3 100644--- a/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)+++ b/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=61832ee7fa2fbd569d129379e795038abfb0d128)@@ -1300,7 +1300,7 @@ static struct buffer\_head \*ext4\_get\_bitmap(struct super\_block \*sb, \_\_u64 block) if (unlikely(!bh)) return NULL; if (!bh\_uptodate\_or\_lock(bh)) {- if (ext4\_read\_bh(bh, 0, NULL) < 0) {+ if (ext4\_read\_bh(bh, 0, NULL, false) < 0) { brelse(bh); return NULL; }diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex 4645f162967327..95930e70b8aac7 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=bfeecda050aa9376f642d5b2a71c4112cc6c8216)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=61832ee7fa2fbd569d129379e795038abfb0d128)@@ -161,8 +161,14 @@ MODULE\_ALIAS("ext3");   static inline void \_\_ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io)+ bh\_end\_io\_t \*end\_io, bool simu\_fail) {+ if (simu\_fail) {+ clear\_buffer\_uptodate(bh);+ unlock\_buffer(bh);+ return;+ }+ /\* \* buffer's verified bit is no longer valid after reading from \* disk again due to write out error, clear it to make sure we@@ -176,7 +182,7 @@ static inline void \_\_ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, }  void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io)+ bh\_end\_io\_t \*end\_io, bool simu\_fail) { BUG\_ON(!buffer\_locked(bh)); @@ -184,10 +190,11 @@ void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags, unlock\_buffer(bh); return; }- \_\_ext4\_read\_bh(bh, op\_flags, end\_io);+ \_\_ext4\_read\_bh(bh, op\_flags, end\_io, simu\_fail); } -int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bh\_end\_io\_t \*end\_io)+int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,+ bh\_end\_io\_t \*end\_io, bool simu\_fail) { BUG\_ON(!buffer\_locked(bh)); @@ -196,7 +203,7 @@ int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bh\_end\_io\_t \*end\_io return 0; } - \_\_ext4\_read\_bh(bh, op\_flags, end\_io);+ \_\_ext4\_read\_bh(bh, op\_flags, end\_io, simu\_fail);  wait\_on\_buffer(bh); if (buffer\_uptodate(bh))@@ -208,10 +215,10 @@ int ext4\_read\_bh\_lock(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bool wait) { lock\_buffer(bh); if (!wait) {- ext4\_read\_bh\_nowait(bh, op\_flags, NULL);+ ext4\_read\_bh\_nowait(bh, op\_flags, NULL, false); return 0; }- return ext4\_read\_bh(bh, op\_flags, NULL);+ return ext4\_read\_bh(bh, op\_flags, NULL, false); }  /\*@@ -266,7 +273,7 @@ void ext4\_sb\_breadahead\_unmovable(struct super\_block \*sb, sector\_t block)  if (likely(bh)) { if (trylock\_buffer(bh))- ext4\_read\_bh\_nowait(bh, REQ\_RAHEAD, NULL);+ ext4\_read\_bh\_nowait(bh, REQ\_RAHEAD, NULL, false); brelse(bh); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:57:23 +0000



=== Content from git.kernel.org_77ec5ad7_20250115_095845.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Long Li <leo.lilong@huawei.com> | 2024-09-06 17:17:46 +0800 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2024-11-12 23:54:14 -0500 |
| commit | [2f3d93e210b9c2866c8b3662adae427d5bf511ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)) | |
| tree | [dac36d2f7fe94d651845a9b23894ed53337dd866](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | |
| parent | [a90825898becb730377b157884c82a725f1d3ffa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a90825898becb730377b157884c82a725f1d3ffa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec&id2=a90825898becb730377b157884c82a725f1d3ffa)) | |
| download | [linux-2f3d93e210b9c2866c8b3662adae427d5bf511ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2f3d93e210b9c2866c8b3662adae427d5bf511ec.tar.gz) | |

ext4: fix race in buffer\_head read fault injectionWhen I enabled ext4 debug for fault injection testing, I encountered the
following warning:
EXT4-fs error (device sda): ext4\_read\_inode\_bitmap:201: comm fsstress:
Cannot read inode bitmap - block\_group = 8, inode\_bitmap = 1051
WARNING: CPU: 0 PID: 511 at fs/buffer.c:1181 mark\_buffer\_dirty+0x1b3/0x1d0
The root cause of the issue lies in the improper implementation of ext4's
buffer\_head read fault injection. The actual completion of buffer\_head
read and the buffer\_head fault injection are not atomic, which can lead
to the uptodate flag being cleared on normally used buffer\_heads in race
conditions.
[CPU0] [CPU1] [CPU2]
ext4\_read\_inode\_bitmap
ext4\_read\_bh()
<bh read complete>
ext4\_read\_inode\_bitmap
if (buffer\_uptodate(bh))
return bh
jbd2\_journal\_commit\_transaction
\_\_jbd2\_journal\_refile\_buffer
\_\_jbd2\_journal\_unfile\_buffer
\_\_jbd2\_journal\_temp\_unlink\_buffer
ext4\_simulate\_fail\_bh()
clear\_buffer\_uptodate
mark\_buffer\_dirty
<report warning>
WARN\_ON\_ONCE(!buffer\_uptodate(bh))
The best approach would be to perform fault injection in the IO completion
callback function, rather than after IO completion. However, the IO
completion callback function cannot get the fault injection code in sb.
Fix it by passing the result of fault injection into the bh read function,
we simulate faults within the bh read function itself. This requires adding
an extra parameter to the bh read functions that need fault injection.
Fixes: 46f870d690fe ("ext4: simulate various I/O and checksum errors when reading metadata")
Signed-off-by: Long Li <leo.lilong@huawei.com>
Link: [https://patch.msgid.link/20240906091746.510163-1-leo.lilong@huawei.com](https://patch.msgid.link/20240906091746.510163-1-leo.lilong%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)

| -rw-r--r-- | [fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/balloc.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/ext4.h?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/ialloc.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/indirect.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/inode.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/mmp.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/move_extent.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/resize.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/super.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec) | 23 | |  |  |  | | --- | --- | --- | |

10 files changed, 29 insertions, 29 deletions

| diff --git a/fs/ext4/balloc.c b/fs/ext4/balloc.cindex 591fb3f710be72..8042ad87380897 100644--- a/[fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/balloc.c?id=a90825898becb730377b157884c82a725f1d3ffa)+++ b/[fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/balloc.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)@@ -550,7 +550,8 @@ ext4\_read\_block\_bitmap\_nowait(struct super\_block \*sb, ext4\_group\_t block\_group, trace\_ext4\_read\_block\_bitmap\_load(sb, block\_group, ignore\_locked); ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO | (ignore\_locked ? REQ\_RAHEAD : 0),- ext4\_end\_bitmap\_read);+ ext4\_end\_bitmap\_read,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_BBITMAP\_EIO)); return bh; verify: err = ext4\_validate\_block\_bitmap(sb, desc, block\_group, bh);@@ -577,7 +578,6 @@ int ext4\_wait\_block\_bitmap(struct super\_block \*sb, ext4\_group\_t block\_group, if (!desc) return -EFSCORRUPTED; wait\_on\_buffer(bh);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_BBITMAP\_EIO); if (!buffer\_uptodate(bh)) { ext4\_error\_err(sb, EIO, "Cannot read block bitmap - " "block\_group = %u, block\_bitmap = %llu",diff --git a/fs/ext4/ext4.h b/fs/ext4/ext4.hindex 44b0d418143c2e..bbffb76d9a9049 100644--- a/[fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ext4.h?id=a90825898becb730377b157884c82a725f1d3ffa)+++ b/[fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ext4.h?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)@@ -1865,14 +1865,6 @@ static inline bool ext4\_simulate\_fail(struct super\_block \*sb, return false; } -static inline void ext4\_simulate\_fail\_bh(struct super\_block \*sb,- struct buffer\_head \*bh,- unsigned long code)-{- if (!IS\_ERR(bh) && ext4\_simulate\_fail(sb, code))- clear\_buffer\_uptodate(bh);-}- /\* \* Error number codes for s\_{first,last}\_error\_errno \*@@ -3100,9 +3092,9 @@ extern struct buffer\_head \*ext4\_sb\_bread(struct super\_block \*sb, extern struct buffer\_head \*ext4\_sb\_bread\_unmovable(struct super\_block \*sb, sector\_t block); extern void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io);+ bh\_end\_io\_t \*end\_io, bool simu\_fail); extern int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io);+ bh\_end\_io\_t \*end\_io, bool simu\_fail); extern int ext4\_read\_bh\_lock(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bool wait); extern void ext4\_sb\_breadahead\_unmovable(struct super\_block \*sb, sector\_t block); extern int ext4\_seq\_options\_show(struct seq\_file \*seq, void \*offset);diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex c144fe43a29f26..1c8123866d81a1 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=a90825898becb730377b157884c82a725f1d3ffa)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)@@ -568,7 +568,7 @@ \_\_read\_extent\_tree\_block(const char \*function, unsigned int line,  if (!bh\_uptodate\_or\_lock(bh)) { trace\_ext4\_ext\_load\_extent(inode, pblk, \_RET\_IP\_);- err = ext4\_read\_bh(bh, 0, NULL);+ err = ext4\_read\_bh(bh, 0, NULL, false); if (err < 0) goto errout; }diff --git a/fs/ext4/ialloc.c b/fs/ext4/ialloc.cindex 7f1a5f90dbbdff..21d228073d7954 100644--- a/[fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ialloc.c?id=a90825898becb730377b157884c82a725f1d3ffa)+++ b/[fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ialloc.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)@@ -193,8 +193,9 @@ ext4\_read\_inode\_bitmap(struct super\_block \*sb, ext4\_group\_t block\_group) \* submit the buffer\_head for reading \*/ trace\_ext4\_load\_inode\_bitmap(sb, block\_group);- ext4\_read\_bh(bh, REQ\_META | REQ\_PRIO, ext4\_end\_bitmap\_read);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_IBITMAP\_EIO);+ ext4\_read\_bh(bh, REQ\_META | REQ\_PRIO,+ ext4\_end\_bitmap\_read,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_IBITMAP\_EIO)); if (!buffer\_uptodate(bh)) { put\_bh(bh); ext4\_error\_err(sb, EIO, "Cannot read inode bitmap - "diff --git a/fs/ext4/indirect.c b/fs/ext4/indirect.cindex 7404f0935c9032..7de327fa7b1c51 100644--- a/[fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/indirect.c?id=a90825898becb730377b157884c82a725f1d3ffa)+++ b/[fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/indirect.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)@@ -170,7 +170,7 @@ static Indirect \*ext4\_get\_branch(struct inode \*inode, int depth, }  if (!bh\_uptodate\_or\_lock(bh)) {- if (ext4\_read\_bh(bh, 0, NULL) < 0) {+ if (ext4\_read\_bh(bh, 0, NULL, false) < 0) { put\_bh(bh); goto failure; }diff --git a/fs/ext4/inode.c b/fs/ext4/inode.cindex 9b06c9e0a7c592..569887741bf146 100644--- a/[fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/inode.c?id=a90825898becb730377b157884c82a725f1d3ffa)+++ b/[fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/inode.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)@@ -4504,10 +4504,10 @@ make\_io: \* Read the block from disk. \*/ trace\_ext4\_load\_inode(sb, ino);- ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO, NULL);+ ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO, NULL,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_INODE\_EIO)); blk\_finish\_plug(&plug); wait\_on\_buffer(bh);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_INODE\_EIO); if (!buffer\_uptodate(bh)) { if (ret\_block) \*ret\_block = block;diff --git a/fs/ext4/mmp.c b/fs/ext4/mmp.cindex bd946d0c71b700..d64c04ed061ae9 100644--- a/[fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mmp.c?id=a90825898becb730377b157884c82a725f1d3ffa)+++ b/[fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mmp.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)@@ -94,7 +94,7 @@ static int read\_mmp\_block(struct super\_block \*sb, struct buffer\_head \*\*bh, }  lock\_buffer(\*bh);- ret = ext4\_read\_bh(\*bh, REQ\_META | REQ\_PRIO, NULL);+ ret = ext4\_read\_bh(\*bh, REQ\_META | REQ\_PRIO, NULL, false); if (ret) goto warn\_exit; diff --git a/fs/ext4/move\_extent.c b/fs/ext4/move\_extent.cindex b64661ea6e0ed7..898443e98efc9e 100644--- a/[fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/move_extent.c?id=a90825898becb730377b157884c82a725f1d3ffa)+++ b/[fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/move_extent.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)@@ -213,7 +213,7 @@ static int mext\_page\_mkuptodate(struct folio \*folio, size\_t from, size\_t to) unlock\_buffer(bh); continue; }- ext4\_read\_bh\_nowait(bh, 0, NULL);+ ext4\_read\_bh\_nowait(bh, 0, NULL, false); nr++; } while (block++, (bh = bh->b\_this\_page) != head); diff --git a/fs/ext4/resize.c b/fs/ext4/resize.cindex a2704f06436106..72f77f78ae8df3 100644--- a/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=a90825898becb730377b157884c82a725f1d3ffa)+++ b/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)@@ -1300,7 +1300,7 @@ static struct buffer\_head \*ext4\_get\_bitmap(struct super\_block \*sb, \_\_u64 block) if (unlikely(!bh)) return NULL; if (!bh\_uptodate\_or\_lock(bh)) {- if (ext4\_read\_bh(bh, 0, NULL) < 0) {+ if (ext4\_read\_bh(bh, 0, NULL, false) < 0) { brelse(bh); return NULL; }diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex dce37f784b59f9..cb0ce57bd89682 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=a90825898becb730377b157884c82a725f1d3ffa)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=2f3d93e210b9c2866c8b3662adae427d5bf511ec)@@ -161,8 +161,14 @@ MODULE\_ALIAS("ext3");   static inline void \_\_ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io)+ bh\_end\_io\_t \*end\_io, bool simu\_fail) {+ if (simu\_fail) {+ clear\_buffer\_uptodate(bh);+ unlock\_buffer(bh);+ return;+ }+ /\* \* buffer's verified bit is no longer valid after reading from \* disk again due to write out error, clear it to make sure we@@ -176,7 +182,7 @@ static inline void \_\_ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, }  void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io)+ bh\_end\_io\_t \*end\_io, bool simu\_fail) { BUG\_ON(!buffer\_locked(bh)); @@ -184,10 +190,11 @@ void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags, unlock\_buffer(bh); return; }- \_\_ext4\_read\_bh(bh, op\_flags, end\_io);+ \_\_ext4\_read\_bh(bh, op\_flags, end\_io, simu\_fail); } -int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bh\_end\_io\_t \*end\_io)+int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,+ bh\_end\_io\_t \*end\_io, bool simu\_fail) { BUG\_ON(!buffer\_locked(bh)); @@ -196,7 +203,7 @@ int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bh\_end\_io\_t \*end\_io return 0; } - \_\_ext4\_read\_bh(bh, op\_flags, end\_io);+ \_\_ext4\_read\_bh(bh, op\_flags, end\_io, simu\_fail);  wait\_on\_buffer(bh); if (buffer\_uptodate(bh))@@ -208,10 +215,10 @@ int ext4\_read\_bh\_lock(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bool wait) { lock\_buffer(bh); if (!wait) {- ext4\_read\_bh\_nowait(bh, op\_flags, NULL);+ ext4\_read\_bh\_nowait(bh, op\_flags, NULL, false); return 0; }- return ext4\_read\_bh(bh, op\_flags, NULL);+ return ext4\_read\_bh(bh, op\_flags, NULL, false); }  /\*@@ -266,7 +273,7 @@ void ext4\_sb\_breadahead\_unmovable(struct super\_block \*sb, sector\_t block)  if (likely(bh)) { if (trylock\_buffer(bh))- ext4\_read\_bh\_nowait(bh, REQ\_RAHEAD, NULL);+ ext4\_read\_bh\_nowait(bh, REQ\_RAHEAD, NULL, false); brelse(bh); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:57:22 +0000



=== Content from git.kernel.org_cc69e750_20250115_095848.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Long Li <leo.lilong@huawei.com> | 2024-09-06 17:17:46 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:31:46 +0100 |
| commit | [77035e4d27e15f87ea55929c8bb8fb1970129e2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)) | |
| tree | [05374b8ee24e8c02cc6336f36208f9f27bb26d27](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | |
| parent | [cca05950897540bc66c16b1e3b0a5e9c70402f70](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cca05950897540bc66c16b1e3b0a5e9c70402f70) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f&id2=cca05950897540bc66c16b1e3b0a5e9c70402f70)) | |
| download | [linux-77035e4d27e15f87ea55929c8bb8fb1970129e2f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-77035e4d27e15f87ea55929c8bb8fb1970129e2f.tar.gz) | |

ext4: fix race in buffer\_head read fault injection[ Upstream commit 2f3d93e210b9c2866c8b3662adae427d5bf511ec ]
When I enabled ext4 debug for fault injection testing, I encountered the
following warning:
EXT4-fs error (device sda): ext4\_read\_inode\_bitmap:201: comm fsstress:
Cannot read inode bitmap - block\_group = 8, inode\_bitmap = 1051
WARNING: CPU: 0 PID: 511 at fs/buffer.c:1181 mark\_buffer\_dirty+0x1b3/0x1d0
The root cause of the issue lies in the improper implementation of ext4's
buffer\_head read fault injection. The actual completion of buffer\_head
read and the buffer\_head fault injection are not atomic, which can lead
to the uptodate flag being cleared on normally used buffer\_heads in race
conditions.
[CPU0] [CPU1] [CPU2]
ext4\_read\_inode\_bitmap
ext4\_read\_bh()
<bh read complete>
ext4\_read\_inode\_bitmap
if (buffer\_uptodate(bh))
return bh
jbd2\_journal\_commit\_transaction
\_\_jbd2\_journal\_refile\_buffer
\_\_jbd2\_journal\_unfile\_buffer
\_\_jbd2\_journal\_temp\_unlink\_buffer
ext4\_simulate\_fail\_bh()
clear\_buffer\_uptodate
mark\_buffer\_dirty
<report warning>
WARN\_ON\_ONCE(!buffer\_uptodate(bh))
The best approach would be to perform fault injection in the IO completion
callback function, rather than after IO completion. However, the IO
completion callback function cannot get the fault injection code in sb.
Fix it by passing the result of fault injection into the bh read function,
we simulate faults within the bh read function itself. This requires adding
an extra parameter to the bh read functions that need fault injection.
Fixes: 46f870d690fe ("ext4: simulate various I/O and checksum errors when reading metadata")
Signed-off-by: Long Li <leo.lilong@huawei.com>
Link: [https://patch.msgid.link/20240906091746.510163-1-leo.lilong@huawei.com](https://patch.msgid.link/20240906091746.510163-1-leo.lilong%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)

| -rw-r--r-- | [fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/balloc.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/ext4.h?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/ialloc.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/indirect.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/inode.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/mmp.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/move_extent.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/resize.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/super.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f) | 23 | |  |  |  | | --- | --- | --- | |

10 files changed, 29 insertions, 29 deletions

| diff --git a/fs/ext4/balloc.c b/fs/ext4/balloc.cindex 79b20d6ae39ec4..396474e9e2bffe 100644--- a/[fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/balloc.c?id=cca05950897540bc66c16b1e3b0a5e9c70402f70)+++ b/[fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/balloc.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)@@ -545,7 +545,8 @@ ext4\_read\_block\_bitmap\_nowait(struct super\_block \*sb, ext4\_group\_t block\_group, trace\_ext4\_read\_block\_bitmap\_load(sb, block\_group, ignore\_locked); ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO | (ignore\_locked ? REQ\_RAHEAD : 0),- ext4\_end\_bitmap\_read);+ ext4\_end\_bitmap\_read,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_BBITMAP\_EIO)); return bh; verify: err = ext4\_validate\_block\_bitmap(sb, desc, block\_group, bh);@@ -569,7 +570,6 @@ int ext4\_wait\_block\_bitmap(struct super\_block \*sb, ext4\_group\_t block\_group, if (!desc) return -EFSCORRUPTED; wait\_on\_buffer(bh);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_BBITMAP\_EIO); if (!buffer\_uptodate(bh)) { ext4\_error\_err(sb, EIO, "Cannot read block bitmap - " "block\_group = %u, block\_bitmap = %llu",diff --git a/fs/ext4/ext4.h b/fs/ext4/ext4.hindex 7bbf0b9bdff239..3db01b933c3e8b 100644--- a/[fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ext4.h?id=cca05950897540bc66c16b1e3b0a5e9c70402f70)+++ b/[fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ext4.h?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)@@ -1849,14 +1849,6 @@ static inline bool ext4\_simulate\_fail(struct super\_block \*sb, return false; } -static inline void ext4\_simulate\_fail\_bh(struct super\_block \*sb,- struct buffer\_head \*bh,- unsigned long code)-{- if (!IS\_ERR(bh) && ext4\_simulate\_fail(sb, code))- clear\_buffer\_uptodate(bh);-}- /\* \* Error number codes for s\_{first,last}\_error\_errno \*@@ -3072,9 +3064,9 @@ extern struct buffer\_head \*ext4\_sb\_bread(struct super\_block \*sb, extern struct buffer\_head \*ext4\_sb\_bread\_unmovable(struct super\_block \*sb, sector\_t block); extern void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io);+ bh\_end\_io\_t \*end\_io, bool simu\_fail); extern int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io);+ bh\_end\_io\_t \*end\_io, bool simu\_fail); extern int ext4\_read\_bh\_lock(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bool wait); extern void ext4\_sb\_breadahead\_unmovable(struct super\_block \*sb, sector\_t block); extern int ext4\_seq\_options\_show(struct seq\_file \*seq, void \*offset);diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 1c059ac1c1ef27..5ea75af6ca2239 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=cca05950897540bc66c16b1e3b0a5e9c70402f70)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)@@ -564,7 +564,7 @@ \_\_read\_extent\_tree\_block(const char \*function, unsigned int line,  if (!bh\_uptodate\_or\_lock(bh)) { trace\_ext4\_ext\_load\_extent(inode, pblk, \_RET\_IP\_);- err = ext4\_read\_bh(bh, 0, NULL);+ err = ext4\_read\_bh(bh, 0, NULL, false); if (err < 0) goto errout; }diff --git a/fs/ext4/ialloc.c b/fs/ext4/ialloc.cindex 1a1e2214c581f3..d4d0ad689d3c1c 100644--- a/[fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ialloc.c?id=cca05950897540bc66c16b1e3b0a5e9c70402f70)+++ b/[fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ialloc.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)@@ -194,8 +194,9 @@ ext4\_read\_inode\_bitmap(struct super\_block \*sb, ext4\_group\_t block\_group) \* submit the buffer\_head for reading \*/ trace\_ext4\_load\_inode\_bitmap(sb, block\_group);- ext4\_read\_bh(bh, REQ\_META | REQ\_PRIO, ext4\_end\_bitmap\_read);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_IBITMAP\_EIO);+ ext4\_read\_bh(bh, REQ\_META | REQ\_PRIO,+ ext4\_end\_bitmap\_read,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_IBITMAP\_EIO)); if (!buffer\_uptodate(bh)) { put\_bh(bh); ext4\_error\_err(sb, EIO, "Cannot read inode bitmap - "diff --git a/fs/ext4/indirect.c b/fs/ext4/indirect.cindex a9f3716119d372..f2c495b745f1e4 100644--- a/[fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/indirect.c?id=cca05950897540bc66c16b1e3b0a5e9c70402f70)+++ b/[fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/indirect.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)@@ -170,7 +170,7 @@ static Indirect \*ext4\_get\_branch(struct inode \*inode, int depth, }  if (!bh\_uptodate\_or\_lock(bh)) {- if (ext4\_read\_bh(bh, 0, NULL) < 0) {+ if (ext4\_read\_bh(bh, 0, NULL, false) < 0) { put\_bh(bh); goto failure; }diff --git a/fs/ext4/inode.c b/fs/ext4/inode.cindex 14f7098bcefe1c..18ec9106c5b09f 100644--- a/[fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/inode.c?id=cca05950897540bc66c16b1e3b0a5e9c70402f70)+++ b/[fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/inode.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)@@ -4508,10 +4508,10 @@ make\_io: \* Read the block from disk. \*/ trace\_ext4\_load\_inode(sb, ino);- ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO, NULL);+ ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO, NULL,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_INODE\_EIO)); blk\_finish\_plug(&plug); wait\_on\_buffer(bh);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_INODE\_EIO); if (!buffer\_uptodate(bh)) { if (ret\_block) \*ret\_block = block;diff --git a/fs/ext4/mmp.c b/fs/ext4/mmp.cindex bd946d0c71b700..d64c04ed061ae9 100644--- a/[fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mmp.c?id=cca05950897540bc66c16b1e3b0a5e9c70402f70)+++ b/[fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mmp.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)@@ -94,7 +94,7 @@ static int read\_mmp\_block(struct super\_block \*sb, struct buffer\_head \*\*bh, }  lock\_buffer(\*bh);- ret = ext4\_read\_bh(\*bh, REQ\_META | REQ\_PRIO, NULL);+ ret = ext4\_read\_bh(\*bh, REQ\_META | REQ\_PRIO, NULL, false); if (ret) goto warn\_exit; diff --git a/fs/ext4/move\_extent.c b/fs/ext4/move\_extent.cindex f082bccdb01adc..5e6b07b3496006 100644--- a/[fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/move_extent.c?id=cca05950897540bc66c16b1e3b0a5e9c70402f70)+++ b/[fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/move_extent.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)@@ -214,7 +214,7 @@ static int mext\_page\_mkuptodate(struct folio \*folio, size\_t from, size\_t to) unlock\_buffer(bh); continue; }- ext4\_read\_bh\_nowait(bh, 0, NULL);+ ext4\_read\_bh\_nowait(bh, 0, NULL, false); nr++; } /\* No io required \*/diff --git a/fs/ext4/resize.c b/fs/ext4/resize.cindex 5f105171df7b56..b34007541e08cc 100644--- a/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=cca05950897540bc66c16b1e3b0a5e9c70402f70)+++ b/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)@@ -1301,7 +1301,7 @@ static struct buffer\_head \*ext4\_get\_bitmap(struct super\_block \*sb, \_\_u64 block) if (unlikely(!bh)) return NULL; if (!bh\_uptodate\_or\_lock(bh)) {- if (ext4\_read\_bh(bh, 0, NULL) < 0) {+ if (ext4\_read\_bh(bh, 0, NULL, false) < 0) { brelse(bh); return NULL; }diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex c7dc14af6438ad..04b0ad21fad27d 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=cca05950897540bc66c16b1e3b0a5e9c70402f70)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=77035e4d27e15f87ea55929c8bb8fb1970129e2f)@@ -161,8 +161,14 @@ MODULE\_ALIAS("ext3");   static inline void \_\_ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io)+ bh\_end\_io\_t \*end\_io, bool simu\_fail) {+ if (simu\_fail) {+ clear\_buffer\_uptodate(bh);+ unlock\_buffer(bh);+ return;+ }+ /\* \* buffer's verified bit is no longer valid after reading from \* disk again due to write out error, clear it to make sure we@@ -176,7 +182,7 @@ static inline void \_\_ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, }  void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io)+ bh\_end\_io\_t \*end\_io, bool simu\_fail) { BUG\_ON(!buffer\_locked(bh)); @@ -184,10 +190,11 @@ void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags, unlock\_buffer(bh); return; }- \_\_ext4\_read\_bh(bh, op\_flags, end\_io);+ \_\_ext4\_read\_bh(bh, op\_flags, end\_io, simu\_fail); } -int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bh\_end\_io\_t \*end\_io)+int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,+ bh\_end\_io\_t \*end\_io, bool simu\_fail) { BUG\_ON(!buffer\_locked(bh)); @@ -196,7 +203,7 @@ int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bh\_end\_io\_t \*end\_io return 0; } - \_\_ext4\_read\_bh(bh, op\_flags, end\_io);+ \_\_ext4\_read\_bh(bh, op\_flags, end\_io, simu\_fail);  wait\_on\_buffer(bh); if (buffer\_uptodate(bh))@@ -208,10 +215,10 @@ int ext4\_read\_bh\_lock(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bool wait) { lock\_buffer(bh); if (!wait) {- ext4\_read\_bh\_nowait(bh, op\_flags, NULL);+ ext4\_read\_bh\_nowait(bh, op\_flags, NULL, false); return 0; }- return ext4\_read\_bh(bh, op\_flags, NULL);+ return ext4\_read\_bh(bh, op\_flags, NULL, false); }  /\*@@ -259,7 +266,7 @@ void ext4\_sb\_breadahead\_unmovable(struct super\_block \*sb, sector\_t block)  if (likely(bh)) { if (trylock\_buffer(bh))- ext4\_read\_bh\_nowait(bh, REQ\_RAHEAD, NULL);+ ext4\_read\_bh\_nowait(bh, REQ\_RAHEAD, NULL, false); brelse(bh); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:57:25 +0000



=== Content from git.kernel.org_efa66b14_20250115_095845.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Long Li <leo.lilong@huawei.com> | 2024-09-06 17:17:46 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:52:48 +0100 |
| commit | [25a5acf88fed59e060405bbb48098f4a3a2c2adc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)) | |
| tree | [a3e9246493b819f4c221f05616dd5ccb92419510](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | |
| parent | [eaa3782d8988575bde720abd5ecc4f10688f287b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eaa3782d8988575bde720abd5ecc4f10688f287b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc&id2=eaa3782d8988575bde720abd5ecc4f10688f287b)) | |
| download | [linux-25a5acf88fed59e060405bbb48098f4a3a2c2adc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-25a5acf88fed59e060405bbb48098f4a3a2c2adc.tar.gz) | |

ext4: fix race in buffer\_head read fault injection[ Upstream commit 2f3d93e210b9c2866c8b3662adae427d5bf511ec ]
When I enabled ext4 debug for fault injection testing, I encountered the
following warning:
EXT4-fs error (device sda): ext4\_read\_inode\_bitmap:201: comm fsstress:
Cannot read inode bitmap - block\_group = 8, inode\_bitmap = 1051
WARNING: CPU: 0 PID: 511 at fs/buffer.c:1181 mark\_buffer\_dirty+0x1b3/0x1d0
The root cause of the issue lies in the improper implementation of ext4's
buffer\_head read fault injection. The actual completion of buffer\_head
read and the buffer\_head fault injection are not atomic, which can lead
to the uptodate flag being cleared on normally used buffer\_heads in race
conditions.
[CPU0] [CPU1] [CPU2]
ext4\_read\_inode\_bitmap
ext4\_read\_bh()
<bh read complete>
ext4\_read\_inode\_bitmap
if (buffer\_uptodate(bh))
return bh
jbd2\_journal\_commit\_transaction
\_\_jbd2\_journal\_refile\_buffer
\_\_jbd2\_journal\_unfile\_buffer
\_\_jbd2\_journal\_temp\_unlink\_buffer
ext4\_simulate\_fail\_bh()
clear\_buffer\_uptodate
mark\_buffer\_dirty
<report warning>
WARN\_ON\_ONCE(!buffer\_uptodate(bh))
The best approach would be to perform fault injection in the IO completion
callback function, rather than after IO completion. However, the IO
completion callback function cannot get the fault injection code in sb.
Fix it by passing the result of fault injection into the bh read function,
we simulate faults within the bh read function itself. This requires adding
an extra parameter to the bh read functions that need fault injection.
Fixes: 46f870d690fe ("ext4: simulate various I/O and checksum errors when reading metadata")
Signed-off-by: Long Li <leo.lilong@huawei.com>
Link: [https://patch.msgid.link/20240906091746.510163-1-leo.lilong@huawei.com](https://patch.msgid.link/20240906091746.510163-1-leo.lilong%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)

| -rw-r--r-- | [fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/balloc.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/ext4.h?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/ialloc.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/indirect.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/inode.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/mmp.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/move_extent.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/resize.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/super.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc) | 23 | |  |  |  | | --- | --- | --- | |

10 files changed, 29 insertions, 29 deletions

| diff --git a/fs/ext4/balloc.c b/fs/ext4/balloc.cindex 591fb3f710be72..8042ad87380897 100644--- a/[fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/balloc.c?id=eaa3782d8988575bde720abd5ecc4f10688f287b)+++ b/[fs/ext4/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/balloc.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)@@ -550,7 +550,8 @@ ext4\_read\_block\_bitmap\_nowait(struct super\_block \*sb, ext4\_group\_t block\_group, trace\_ext4\_read\_block\_bitmap\_load(sb, block\_group, ignore\_locked); ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO | (ignore\_locked ? REQ\_RAHEAD : 0),- ext4\_end\_bitmap\_read);+ ext4\_end\_bitmap\_read,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_BBITMAP\_EIO)); return bh; verify: err = ext4\_validate\_block\_bitmap(sb, desc, block\_group, bh);@@ -577,7 +578,6 @@ int ext4\_wait\_block\_bitmap(struct super\_block \*sb, ext4\_group\_t block\_group, if (!desc) return -EFSCORRUPTED; wait\_on\_buffer(bh);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_BBITMAP\_EIO); if (!buffer\_uptodate(bh)) { ext4\_error\_err(sb, EIO, "Cannot read block bitmap - " "block\_group = %u, block\_bitmap = %llu",diff --git a/fs/ext4/ext4.h b/fs/ext4/ext4.hindex 8bd302392d759a..b02d6e444cfb6e 100644--- a/[fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ext4.h?id=eaa3782d8988575bde720abd5ecc4f10688f287b)+++ b/[fs/ext4/ext4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ext4.h?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)@@ -1865,14 +1865,6 @@ static inline bool ext4\_simulate\_fail(struct super\_block \*sb, return false; } -static inline void ext4\_simulate\_fail\_bh(struct super\_block \*sb,- struct buffer\_head \*bh,- unsigned long code)-{- if (!IS\_ERR(bh) && ext4\_simulate\_fail(sb, code))- clear\_buffer\_uptodate(bh);-}- /\* \* Error number codes for s\_{first,last}\_error\_errno \*@@ -3098,9 +3090,9 @@ extern struct buffer\_head \*ext4\_sb\_bread(struct super\_block \*sb, extern struct buffer\_head \*ext4\_sb\_bread\_unmovable(struct super\_block \*sb, sector\_t block); extern void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io);+ bh\_end\_io\_t \*end\_io, bool simu\_fail); extern int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io);+ bh\_end\_io\_t \*end\_io, bool simu\_fail); extern int ext4\_read\_bh\_lock(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bool wait); extern void ext4\_sb\_breadahead\_unmovable(struct super\_block \*sb, sector\_t block); extern int ext4\_seq\_options\_show(struct seq\_file \*seq, void \*offset);diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex c64f7c1b1d9082..123a69e62e59be 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=eaa3782d8988575bde720abd5ecc4f10688f287b)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)@@ -564,7 +564,7 @@ \_\_read\_extent\_tree\_block(const char \*function, unsigned int line,  if (!bh\_uptodate\_or\_lock(bh)) { trace\_ext4\_ext\_load\_extent(inode, pblk, \_RET\_IP\_);- err = ext4\_read\_bh(bh, 0, NULL);+ err = ext4\_read\_bh(bh, 0, NULL, false); if (err < 0) goto errout; }diff --git a/fs/ext4/ialloc.c b/fs/ext4/ialloc.cindex 81641be38c0e8b..072084da50d33f 100644--- a/[fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ialloc.c?id=eaa3782d8988575bde720abd5ecc4f10688f287b)+++ b/[fs/ext4/ialloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/ialloc.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)@@ -194,8 +194,9 @@ ext4\_read\_inode\_bitmap(struct super\_block \*sb, ext4\_group\_t block\_group) \* submit the buffer\_head for reading \*/ trace\_ext4\_load\_inode\_bitmap(sb, block\_group);- ext4\_read\_bh(bh, REQ\_META | REQ\_PRIO, ext4\_end\_bitmap\_read);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_IBITMAP\_EIO);+ ext4\_read\_bh(bh, REQ\_META | REQ\_PRIO,+ ext4\_end\_bitmap\_read,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_IBITMAP\_EIO)); if (!buffer\_uptodate(bh)) { put\_bh(bh); ext4\_error\_err(sb, EIO, "Cannot read inode bitmap - "diff --git a/fs/ext4/indirect.c b/fs/ext4/indirect.cindex d8ca7f64f95234..8480bddde789b8 100644--- a/[fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/indirect.c?id=eaa3782d8988575bde720abd5ecc4f10688f287b)+++ b/[fs/ext4/indirect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/indirect.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)@@ -170,7 +170,7 @@ static Indirect \*ext4\_get\_branch(struct inode \*inode, int depth, }  if (!bh\_uptodate\_or\_lock(bh)) {- if (ext4\_read\_bh(bh, 0, NULL) < 0) {+ if (ext4\_read\_bh(bh, 0, NULL, false) < 0) { put\_bh(bh); goto failure; }diff --git a/fs/ext4/inode.c b/fs/ext4/inode.cindex a0fa5192db8ed3..235e22790ec628 100644--- a/[fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/inode.c?id=eaa3782d8988575bde720abd5ecc4f10688f287b)+++ b/[fs/ext4/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/inode.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)@@ -4530,10 +4530,10 @@ make\_io: \* Read the block from disk. \*/ trace\_ext4\_load\_inode(sb, ino);- ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO, NULL);+ ext4\_read\_bh\_nowait(bh, REQ\_META | REQ\_PRIO, NULL,+ ext4\_simulate\_fail(sb, EXT4\_SIM\_INODE\_EIO)); blk\_finish\_plug(&plug); wait\_on\_buffer(bh);- ext4\_simulate\_fail\_bh(sb, bh, EXT4\_SIM\_INODE\_EIO); if (!buffer\_uptodate(bh)) { if (ret\_block) \*ret\_block = block;diff --git a/fs/ext4/mmp.c b/fs/ext4/mmp.cindex bd946d0c71b700..d64c04ed061ae9 100644--- a/[fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mmp.c?id=eaa3782d8988575bde720abd5ecc4f10688f287b)+++ b/[fs/ext4/mmp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mmp.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)@@ -94,7 +94,7 @@ static int read\_mmp\_block(struct super\_block \*sb, struct buffer\_head \*\*bh, }  lock\_buffer(\*bh);- ret = ext4\_read\_bh(\*bh, REQ\_META | REQ\_PRIO, NULL);+ ret = ext4\_read\_bh(\*bh, REQ\_META | REQ\_PRIO, NULL, false); if (ret) goto warn\_exit; diff --git a/fs/ext4/move\_extent.c b/fs/ext4/move\_extent.cindex 42b52b6491a03b..fd3487df360a58 100644--- a/[fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/move_extent.c?id=eaa3782d8988575bde720abd5ecc4f10688f287b)+++ b/[fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/move_extent.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)@@ -212,7 +212,7 @@ static int mext\_page\_mkuptodate(struct folio \*folio, size\_t from, size\_t to) unlock\_buffer(bh); continue; }- ext4\_read\_bh\_nowait(bh, 0, NULL);+ ext4\_read\_bh\_nowait(bh, 0, NULL, false); nr++; } /\* No io required \*/diff --git a/fs/ext4/resize.c b/fs/ext4/resize.cindex f12ccaabf13d8b..e9da8bba0f9d72 100644--- a/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=eaa3782d8988575bde720abd5ecc4f10688f287b)+++ b/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)@@ -1300,7 +1300,7 @@ static struct buffer\_head \*ext4\_get\_bitmap(struct super\_block \*sb, \_\_u64 block) if (unlikely(!bh)) return NULL; if (!bh\_uptodate\_or\_lock(bh)) {- if (ext4\_read\_bh(bh, 0, NULL) < 0) {+ if (ext4\_read\_bh(bh, 0, NULL, false) < 0) { brelse(bh); return NULL; }diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex 42b1acac88e780..350b0830128516 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=eaa3782d8988575bde720abd5ecc4f10688f287b)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=25a5acf88fed59e060405bbb48098f4a3a2c2adc)@@ -161,8 +161,14 @@ MODULE\_ALIAS("ext3");   static inline void \_\_ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io)+ bh\_end\_io\_t \*end\_io, bool simu\_fail) {+ if (simu\_fail) {+ clear\_buffer\_uptodate(bh);+ unlock\_buffer(bh);+ return;+ }+ /\* \* buffer's verified bit is no longer valid after reading from \* disk again due to write out error, clear it to make sure we@@ -176,7 +182,7 @@ static inline void \_\_ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, }  void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags,- bh\_end\_io\_t \*end\_io)+ bh\_end\_io\_t \*end\_io, bool simu\_fail) { BUG\_ON(!buffer\_locked(bh)); @@ -184,10 +190,11 @@ void ext4\_read\_bh\_nowait(struct buffer\_head \*bh, blk\_opf\_t op\_flags, unlock\_buffer(bh); return; }- \_\_ext4\_read\_bh(bh, op\_flags, end\_io);+ \_\_ext4\_read\_bh(bh, op\_flags, end\_io, simu\_fail); } -int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bh\_end\_io\_t \*end\_io)+int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags,+ bh\_end\_io\_t \*end\_io, bool simu\_fail) { BUG\_ON(!buffer\_locked(bh)); @@ -196,7 +203,7 @@ int ext4\_read\_bh(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bh\_end\_io\_t \*end\_io return 0; } - \_\_ext4\_read\_bh(bh, op\_flags, end\_io);+ \_\_ext4\_read\_bh(bh, op\_flags, end\_io, simu\_fail);  wait\_on\_buffer(bh); if (buffer\_uptodate(bh))@@ -208,10 +215,10 @@ int ext4\_read\_bh\_lock(struct buffer\_head \*bh, blk\_opf\_t op\_flags, bool wait) { lock\_buffer(bh); if (!wait) {- ext4\_read\_bh\_nowait(bh, op\_flags, NULL);+ ext4\_read\_bh\_nowait(bh, op\_flags, NULL, false); return 0; }- return ext4\_read\_bh(bh, op\_flags, NULL);+ return ext4\_read\_bh(bh, op\_flags, NULL, false); }  /\*@@ -266,7 +273,7 @@ void ext4\_sb\_breadahead\_unmovable(struct super\_block \*sb, sector\_t block)  if (likely(bh)) { if (trylock\_buffer(bh))- ext4\_read\_bh\_nowait(bh, REQ\_RAHEAD, NULL);+ ext4\_read\_bh\_nowait(bh, REQ\_RAHEAD, NULL, false); brelse(bh); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:57:21 +0000


