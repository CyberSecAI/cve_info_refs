=== Content from git.kernel.org_1746b584_20250115_100825.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-15 11:29:21 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:40:56 +0100 |
| commit | [a6f9e7a0bf1185c9070c0de03bb85eafb9abd650](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650)) | |
| tree | [9274be5d0c5c73633ed9968ad1ed0a032aae7f77](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650) | |
| parent | [93992c3d9629b02dccf6849238559d5c24f2dece](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93992c3d9629b02dccf6849238559d5c24f2dece) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650&id2=93992c3d9629b02dccf6849238559d5c24f2dece)) | |
| download | [linux-a6f9e7a0bf1185c9070c0de03bb85eafb9abd650.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a6f9e7a0bf1185c9070c0de03bb85eafb9abd650.tar.gz) | |

btrfs: ref-verify: fix use-after-free after invalid ref action[ Upstream commit 7c4e39f9d2af4abaf82ca0e315d1fd340456620f ]
At btrfs\_ref\_tree\_mod() after we successfully inserted the new ref entry
(local variable 'ref') into the respective block entry's rbtree (local
variable 'be'), if we find an unexpected action of BTRFS\_DROP\_DELAYED\_REF,
we error out and free the ref entry without removing it from the block
entry's rbtree. Then in the error path of btrfs\_ref\_tree\_mod() we call
btrfs\_free\_ref\_cache(), which iterates over all block entries and then
calls free\_block\_entry() for each one, and there we will trigger a
use-after-free when we are called against the block entry to which we
added the freed ref entry to its rbtree, since the rbtree still points
to the block entry, as we didn't remove it from the rbtree before freeing
it in the error path at btrfs\_ref\_tree\_mod(). Fix this by removing the
new ref entry from the rbtree before freeing it.
Syzbot report this with the following stack traces:
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_insert\_empty\_items+0x9c/0x1a0 fs/btrfs/ctree.c:4314
btrfs\_insert\_empty\_item fs/btrfs/ctree.h:669 [inline]
btrfs\_insert\_orphan\_item+0x1f1/0x320 fs/btrfs/orphan.c:23
btrfs\_orphan\_add+0x6d/0x1a0 fs/btrfs/inode.c:3482
btrfs\_unlink+0x267/0x350 fs/btrfs/inode.c:4293
vfs\_unlink+0x365/0x650 fs/namei.c:4469
do\_unlinkat+0x4ae/0x830 fs/namei.c:4533
\_\_do\_sys\_unlinkat fs/namei.c:4576 [inline]
\_\_se\_sys\_unlinkat fs/namei.c:4569 [inline]
\_\_x64\_sys\_unlinkat+0xcc/0xf0 fs/namei.c:4569
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
BTRFS error (device loop0 state EA): Ref action 1, root 5, ref\_root 5, parent 0, owner 260, offset 0, num\_refs 1
\_\_btrfs\_mod\_ref+0x76b/0xac0 fs/btrfs/extent-tree.c:2521
update\_ref\_for\_cow+0x96a/0x11f0
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
==================================================================
BUG: KASAN: slab-use-after-free in rb\_first+0x69/0x70 lib/rbtree.c:473
Read of size 8 at addr ffff888042d1af38 by task syz.0.0/5329
CPU: 0 UID: 0 PID: 5329 Comm: syz.0.0 Not tainted 6.12.0-rc7-syzkaller #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:488
kasan\_report+0x143/0x180 mm/kasan/report.c:601
rb\_first+0x69/0x70 lib/rbtree.c:473
free\_block\_entry+0x78/0x230 fs/btrfs/ref-verify.c:248
btrfs\_free\_ref\_cache+0xa3/0x100 fs/btrfs/ref-verify.c:917
btrfs\_ref\_tree\_mod+0x139f/0x15e0 fs/btrfs/ref-verify.c:898
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f996df7e719
RSP: 002b:00007f996ede7038 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 00007f996e135f80 RCX: 00007f996df7e719
RDX: 0000000020000180 RSI: 00000000c4009420 RDI: 0000000000000004
RBP: 00007f996dff139e R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f996e135f80 R15: 00007fff79f32e68
</TASK>
Allocated by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0x98/0xb0 mm/kasan/common.c:394
kasan\_kmalloc include/linux/kasan.h:257 [inline]
\_\_kmalloc\_cache\_noprof+0x19c/0x2c0 mm/slub.c:4295
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
btrfs\_ref\_tree\_mod+0x264/0x15e0 fs/btrfs/ref-verify.c:701
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x1a0/0x440 mm/slub.c:4727
btrfs\_ref\_tree\_mod+0x136c/0x15e0
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
The buggy address belongs to the object at ffff888042d1af00
which belongs to the cache kmalloc-64 of size 64
The buggy address is located 56 bytes inside of
freed 64-byte region [ffff888042d1af00, ffff888042d1af40)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x42d1a
anon flags: 0x4fff00000000000(node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000000 ffff88801ac418c0 0000000000000000 dead000000000001
raw: 0000000000000000 0000000000200020 00000001f5000000 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x52c40(GFP\_NOFS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP), pid 5055, tgid 5055 (dhcpcd-run-hook), ts 40377240074, free\_ts 40376848335
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1541
prep\_new\_page mm/page\_alloc.c:1549 [inline]
get\_page\_from\_freelist+0x3649/0x3790 mm/page\_alloc.c:3459
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4735
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_slab\_page+0x6a/0x140 mm/slub.c:2412
allocate\_slab+0x5a/0x2f0 mm/slub.c:2578
new\_slab mm/slub.c:2631 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3818
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_do\_kmalloc\_node mm/slub.c:4263 [inline]
\_\_kmalloc\_noprof+0x25a/0x400 mm/slub.c:4276
kmalloc\_noprof include/linux/slab.h:882 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
tomoyo\_encode2 security/tomoyo/realpath.c:45 [inline]
tomoyo\_encode+0x26f/0x540 security/tomoyo/realpath.c:80
tomoyo\_realpath\_from\_path+0x59e/0x5e0 security/tomoyo/realpath.c:283
tomoyo\_get\_realpath security/tomoyo/file.c:151 [inline]
tomoyo\_check\_open\_permission+0x255/0x500 security/tomoyo/file.c:771
security\_file\_open+0x777/0x990 security/security.c:3109
do\_dentry\_open+0x369/0x1460 fs/open.c:945
vfs\_open+0x3e/0x330 fs/open.c:1088
do\_open fs/namei.c:3774 [inline]
path\_openat+0x2c84/0x3590 fs/namei.c:3933
page last free pid 5055 tgid 5055 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1112 [inline]
free\_unref\_page+0xcfb/0xf20 mm/page\_alloc.c:2642
free\_pipe\_info+0x300/0x390 fs/pipe.c:860
put\_pipe\_info fs/pipe.c:719 [inline]
pipe\_release+0x245/0x320 fs/pipe.c:742
\_\_fput+0x23f/0x880 fs/file\_table.c:431
\_\_do\_sys\_close fs/open.c:1567 [inline]
\_\_se\_sys\_close fs/open.c:1552 [inline]
\_\_x64\_sys\_close+0x7f/0x110 fs/open.c:1552
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Memory state around the buggy address:
ffff888042d1ae00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
ffff888042d1ae80: 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc fc
>ffff888042d1af00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
^
ffff888042d1af80: 00 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc
ffff888042d1b000: 00 00 00 00 00 fc fc 00 00 00 00 00 fc fc 00 00
Reported-by: syzbot+7325f164162e200000c1@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE@google.com/T/#u](https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE%40google.com/T/#u)
Fixes: fd708b81d972 ("Btrfs: add a extent ref verify tool")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650)

| -rw-r--r-- | [fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ref-verify.c?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/fs/btrfs/ref-verify.c b/fs/btrfs/ref-verify.cindex 9522a8b79d22b5..2928abf7eb8271 100644--- a/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=93992c3d9629b02dccf6849238559d5c24f2dece)+++ b/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=a6f9e7a0bf1185c9070c0de03bb85eafb9abd650)@@ -857,6 +857,7 @@ int btrfs\_ref\_tree\_mod(struct btrfs\_fs\_info \*fs\_info, "dropping a ref for a root that doesn't have a ref on the block"); dump\_block\_entry(fs\_info, be); dump\_ref\_action(fs\_info, ra);+ rb\_erase(&ref->node, &be->refs); kfree(ref); kfree(ra); goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:07:03 +0000



=== Content from git.kernel.org_0406a132_20250115_100824.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6fd018aa168e472ce35be32296d109db6adb87ea)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6fd018aa168e472ce35be32296d109db6adb87ea)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fd018aa168e472ce35be32296d109db6adb87ea)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fd018aa168e472ce35be32296d109db6adb87ea)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-15 11:29:21 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:16 +0100 |
| commit | [6fd018aa168e472ce35be32296d109db6adb87ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fd018aa168e472ce35be32296d109db6adb87ea) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6fd018aa168e472ce35be32296d109db6adb87ea)) | |
| tree | [e4617c1f9bac5b9b09a183034252b15f751c4888](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6fd018aa168e472ce35be32296d109db6adb87ea) | |
| parent | [6f3821acd7c3143145999248087de5fb4b48cf26](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f3821acd7c3143145999248087de5fb4b48cf26) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fd018aa168e472ce35be32296d109db6adb87ea&id2=6f3821acd7c3143145999248087de5fb4b48cf26)) | |
| download | [linux-6fd018aa168e472ce35be32296d109db6adb87ea.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6fd018aa168e472ce35be32296d109db6adb87ea.tar.gz) | |

btrfs: ref-verify: fix use-after-free after invalid ref action[ Upstream commit 7c4e39f9d2af4abaf82ca0e315d1fd340456620f ]
At btrfs\_ref\_tree\_mod() after we successfully inserted the new ref entry
(local variable 'ref') into the respective block entry's rbtree (local
variable 'be'), if we find an unexpected action of BTRFS\_DROP\_DELAYED\_REF,
we error out and free the ref entry without removing it from the block
entry's rbtree. Then in the error path of btrfs\_ref\_tree\_mod() we call
btrfs\_free\_ref\_cache(), which iterates over all block entries and then
calls free\_block\_entry() for each one, and there we will trigger a
use-after-free when we are called against the block entry to which we
added the freed ref entry to its rbtree, since the rbtree still points
to the block entry, as we didn't remove it from the rbtree before freeing
it in the error path at btrfs\_ref\_tree\_mod(). Fix this by removing the
new ref entry from the rbtree before freeing it.
Syzbot report this with the following stack traces:
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_insert\_empty\_items+0x9c/0x1a0 fs/btrfs/ctree.c:4314
btrfs\_insert\_empty\_item fs/btrfs/ctree.h:669 [inline]
btrfs\_insert\_orphan\_item+0x1f1/0x320 fs/btrfs/orphan.c:23
btrfs\_orphan\_add+0x6d/0x1a0 fs/btrfs/inode.c:3482
btrfs\_unlink+0x267/0x350 fs/btrfs/inode.c:4293
vfs\_unlink+0x365/0x650 fs/namei.c:4469
do\_unlinkat+0x4ae/0x830 fs/namei.c:4533
\_\_do\_sys\_unlinkat fs/namei.c:4576 [inline]
\_\_se\_sys\_unlinkat fs/namei.c:4569 [inline]
\_\_x64\_sys\_unlinkat+0xcc/0xf0 fs/namei.c:4569
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
BTRFS error (device loop0 state EA): Ref action 1, root 5, ref\_root 5, parent 0, owner 260, offset 0, num\_refs 1
\_\_btrfs\_mod\_ref+0x76b/0xac0 fs/btrfs/extent-tree.c:2521
update\_ref\_for\_cow+0x96a/0x11f0
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
==================================================================
BUG: KASAN: slab-use-after-free in rb\_first+0x69/0x70 lib/rbtree.c:473
Read of size 8 at addr ffff888042d1af38 by task syz.0.0/5329
CPU: 0 UID: 0 PID: 5329 Comm: syz.0.0 Not tainted 6.12.0-rc7-syzkaller #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:488
kasan\_report+0x143/0x180 mm/kasan/report.c:601
rb\_first+0x69/0x70 lib/rbtree.c:473
free\_block\_entry+0x78/0x230 fs/btrfs/ref-verify.c:248
btrfs\_free\_ref\_cache+0xa3/0x100 fs/btrfs/ref-verify.c:917
btrfs\_ref\_tree\_mod+0x139f/0x15e0 fs/btrfs/ref-verify.c:898
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f996df7e719
RSP: 002b:00007f996ede7038 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 00007f996e135f80 RCX: 00007f996df7e719
RDX: 0000000020000180 RSI: 00000000c4009420 RDI: 0000000000000004
RBP: 00007f996dff139e R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f996e135f80 R15: 00007fff79f32e68
</TASK>
Allocated by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0x98/0xb0 mm/kasan/common.c:394
kasan\_kmalloc include/linux/kasan.h:257 [inline]
\_\_kmalloc\_cache\_noprof+0x19c/0x2c0 mm/slub.c:4295
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
btrfs\_ref\_tree\_mod+0x264/0x15e0 fs/btrfs/ref-verify.c:701
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x1a0/0x440 mm/slub.c:4727
btrfs\_ref\_tree\_mod+0x136c/0x15e0
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
The buggy address belongs to the object at ffff888042d1af00
which belongs to the cache kmalloc-64 of size 64
The buggy address is located 56 bytes inside of
freed 64-byte region [ffff888042d1af00, ffff888042d1af40)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x42d1a
anon flags: 0x4fff00000000000(node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000000 ffff88801ac418c0 0000000000000000 dead000000000001
raw: 0000000000000000 0000000000200020 00000001f5000000 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x52c40(GFP\_NOFS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP), pid 5055, tgid 5055 (dhcpcd-run-hook), ts 40377240074, free\_ts 40376848335
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1541
prep\_new\_page mm/page\_alloc.c:1549 [inline]
get\_page\_from\_freelist+0x3649/0x3790 mm/page\_alloc.c:3459
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4735
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_slab\_page+0x6a/0x140 mm/slub.c:2412
allocate\_slab+0x5a/0x2f0 mm/slub.c:2578
new\_slab mm/slub.c:2631 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3818
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_do\_kmalloc\_node mm/slub.c:4263 [inline]
\_\_kmalloc\_noprof+0x25a/0x400 mm/slub.c:4276
kmalloc\_noprof include/linux/slab.h:882 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
tomoyo\_encode2 security/tomoyo/realpath.c:45 [inline]
tomoyo\_encode+0x26f/0x540 security/tomoyo/realpath.c:80
tomoyo\_realpath\_from\_path+0x59e/0x5e0 security/tomoyo/realpath.c:283
tomoyo\_get\_realpath security/tomoyo/file.c:151 [inline]
tomoyo\_check\_open\_permission+0x255/0x500 security/tomoyo/file.c:771
security\_file\_open+0x777/0x990 security/security.c:3109
do\_dentry\_open+0x369/0x1460 fs/open.c:945
vfs\_open+0x3e/0x330 fs/open.c:1088
do\_open fs/namei.c:3774 [inline]
path\_openat+0x2c84/0x3590 fs/namei.c:3933
page last free pid 5055 tgid 5055 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1112 [inline]
free\_unref\_page+0xcfb/0xf20 mm/page\_alloc.c:2642
free\_pipe\_info+0x300/0x390 fs/pipe.c:860
put\_pipe\_info fs/pipe.c:719 [inline]
pipe\_release+0x245/0x320 fs/pipe.c:742
\_\_fput+0x23f/0x880 fs/file\_table.c:431
\_\_do\_sys\_close fs/open.c:1567 [inline]
\_\_se\_sys\_close fs/open.c:1552 [inline]
\_\_x64\_sys\_close+0x7f/0x110 fs/open.c:1552
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Memory state around the buggy address:
ffff888042d1ae00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
ffff888042d1ae80: 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc fc
>ffff888042d1af00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
^
ffff888042d1af80: 00 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc
ffff888042d1b000: 00 00 00 00 00 fc fc 00 00 00 00 00 fc fc 00 00
Reported-by: syzbot+7325f164162e200000c1@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE@google.com/T/#u](https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE%40google.com/T/#u)
Fixes: fd708b81d972 ("Btrfs: add a extent ref verify tool")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fd018aa168e472ce35be32296d109db6adb87ea)

| -rw-r--r-- | [fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ref-verify.c?id=6fd018aa168e472ce35be32296d109db6adb87ea) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/fs/btrfs/ref-verify.c b/fs/btrfs/ref-verify.cindex c3711598a9be55..38e1ed4dc2a938 100644--- a/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=6f3821acd7c3143145999248087de5fb4b48cf26)+++ b/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=6fd018aa168e472ce35be32296d109db6adb87ea)@@ -862,6 +862,7 @@ int btrfs\_ref\_tree\_mod(struct btrfs\_fs\_info \*fs\_info, "dropping a ref for a root that doesn't have a ref on the block"); dump\_block\_entry(fs\_info, be); dump\_ref\_action(fs\_info, ra);+ rb\_erase(&ref->node, &be->refs); kfree(ref); kfree(ra); goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:07:01 +0000



=== Content from git.kernel.org_744a363a_20250115_100825.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-15 11:29:21 +0000 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2024-11-29 16:52:29 +0100 |
| commit | [7c4e39f9d2af4abaf82ca0e315d1fd340456620f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f)) | |
| tree | [9d23a77240f5f3f59ddf666dc6699a28ea49a67d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f) | |
| parent | [3ed51857a50f530ac7a1482e069dfbd1298558d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ed51857a50f530ac7a1482e069dfbd1298558d4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f&id2=3ed51857a50f530ac7a1482e069dfbd1298558d4)) | |
| download | [linux-7c4e39f9d2af4abaf82ca0e315d1fd340456620f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7c4e39f9d2af4abaf82ca0e315d1fd340456620f.tar.gz) | |

btrfs: ref-verify: fix use-after-free after invalid ref actionAt btrfs\_ref\_tree\_mod() after we successfully inserted the new ref entry
(local variable 'ref') into the respective block entry's rbtree (local
variable 'be'), if we find an unexpected action of BTRFS\_DROP\_DELAYED\_REF,
we error out and free the ref entry without removing it from the block
entry's rbtree. Then in the error path of btrfs\_ref\_tree\_mod() we call
btrfs\_free\_ref\_cache(), which iterates over all block entries and then
calls free\_block\_entry() for each one, and there we will trigger a
use-after-free when we are called against the block entry to which we
added the freed ref entry to its rbtree, since the rbtree still points
to the block entry, as we didn't remove it from the rbtree before freeing
it in the error path at btrfs\_ref\_tree\_mod(). Fix this by removing the
new ref entry from the rbtree before freeing it.
Syzbot report this with the following stack traces:
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_insert\_empty\_items+0x9c/0x1a0 fs/btrfs/ctree.c:4314
btrfs\_insert\_empty\_item fs/btrfs/ctree.h:669 [inline]
btrfs\_insert\_orphan\_item+0x1f1/0x320 fs/btrfs/orphan.c:23
btrfs\_orphan\_add+0x6d/0x1a0 fs/btrfs/inode.c:3482
btrfs\_unlink+0x267/0x350 fs/btrfs/inode.c:4293
vfs\_unlink+0x365/0x650 fs/namei.c:4469
do\_unlinkat+0x4ae/0x830 fs/namei.c:4533
\_\_do\_sys\_unlinkat fs/namei.c:4576 [inline]
\_\_se\_sys\_unlinkat fs/namei.c:4569 [inline]
\_\_x64\_sys\_unlinkat+0xcc/0xf0 fs/namei.c:4569
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
BTRFS error (device loop0 state EA): Ref action 1, root 5, ref\_root 5, parent 0, owner 260, offset 0, num\_refs 1
\_\_btrfs\_mod\_ref+0x76b/0xac0 fs/btrfs/extent-tree.c:2521
update\_ref\_for\_cow+0x96a/0x11f0
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
==================================================================
BUG: KASAN: slab-use-after-free in rb\_first+0x69/0x70 lib/rbtree.c:473
Read of size 8 at addr ffff888042d1af38 by task syz.0.0/5329
CPU: 0 UID: 0 PID: 5329 Comm: syz.0.0 Not tainted 6.12.0-rc7-syzkaller #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:488
kasan\_report+0x143/0x180 mm/kasan/report.c:601
rb\_first+0x69/0x70 lib/rbtree.c:473
free\_block\_entry+0x78/0x230 fs/btrfs/ref-verify.c:248
btrfs\_free\_ref\_cache+0xa3/0x100 fs/btrfs/ref-verify.c:917
btrfs\_ref\_tree\_mod+0x139f/0x15e0 fs/btrfs/ref-verify.c:898
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f996df7e719
RSP: 002b:00007f996ede7038 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 00007f996e135f80 RCX: 00007f996df7e719
RDX: 0000000020000180 RSI: 00000000c4009420 RDI: 0000000000000004
RBP: 00007f996dff139e R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f996e135f80 R15: 00007fff79f32e68
</TASK>
Allocated by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0x98/0xb0 mm/kasan/common.c:394
kasan\_kmalloc include/linux/kasan.h:257 [inline]
\_\_kmalloc\_cache\_noprof+0x19c/0x2c0 mm/slub.c:4295
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
btrfs\_ref\_tree\_mod+0x264/0x15e0 fs/btrfs/ref-verify.c:701
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x1a0/0x440 mm/slub.c:4727
btrfs\_ref\_tree\_mod+0x136c/0x15e0
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
The buggy address belongs to the object at ffff888042d1af00
which belongs to the cache kmalloc-64 of size 64
The buggy address is located 56 bytes inside of
freed 64-byte region [ffff888042d1af00, ffff888042d1af40)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x42d1a
anon flags: 0x4fff00000000000(node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000000 ffff88801ac418c0 0000000000000000 dead000000000001
raw: 0000000000000000 0000000000200020 00000001f5000000 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x52c40(GFP\_NOFS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP), pid 5055, tgid 5055 (dhcpcd-run-hook), ts 40377240074, free\_ts 40376848335
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1541
prep\_new\_page mm/page\_alloc.c:1549 [inline]
get\_page\_from\_freelist+0x3649/0x3790 mm/page\_alloc.c:3459
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4735
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_slab\_page+0x6a/0x140 mm/slub.c:2412
allocate\_slab+0x5a/0x2f0 mm/slub.c:2578
new\_slab mm/slub.c:2631 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3818
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_do\_kmalloc\_node mm/slub.c:4263 [inline]
\_\_kmalloc\_noprof+0x25a/0x400 mm/slub.c:4276
kmalloc\_noprof include/linux/slab.h:882 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
tomoyo\_encode2 security/tomoyo/realpath.c:45 [inline]
tomoyo\_encode+0x26f/0x540 security/tomoyo/realpath.c:80
tomoyo\_realpath\_from\_path+0x59e/0x5e0 security/tomoyo/realpath.c:283
tomoyo\_get\_realpath security/tomoyo/file.c:151 [inline]
tomoyo\_check\_open\_permission+0x255/0x500 security/tomoyo/file.c:771
security\_file\_open+0x777/0x990 security/security.c:3109
do\_dentry\_open+0x369/0x1460 fs/open.c:945
vfs\_open+0x3e/0x330 fs/open.c:1088
do\_open fs/namei.c:3774 [inline]
path\_openat+0x2c84/0x3590 fs/namei.c:3933
page last free pid 5055 tgid 5055 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1112 [inline]
free\_unref\_page+0xcfb/0xf20 mm/page\_alloc.c:2642
free\_pipe\_info+0x300/0x390 fs/pipe.c:860
put\_pipe\_info fs/pipe.c:719 [inline]
pipe\_release+0x245/0x320 fs/pipe.c:742
\_\_fput+0x23f/0x880 fs/file\_table.c:431
\_\_do\_sys\_close fs/open.c:1567 [inline]
\_\_se\_sys\_close fs/open.c:1552 [inline]
\_\_x64\_sys\_close+0x7f/0x110 fs/open.c:1552
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Memory state around the buggy address:
ffff888042d1ae00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
ffff888042d1ae80: 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc fc
>ffff888042d1af00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
^
ffff888042d1af80: 00 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc
ffff888042d1b000: 00 00 00 00 00 fc fc 00 00 00 00 00 fc fc 00 00
Reported-by: syzbot+7325f164162e200000c1@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE@google.com/T/#u](https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE%40google.com/T/#u)
Fixes: fd708b81d972 ("Btrfs: add a extent ref verify tool")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f)

| -rw-r--r-- | [fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ref-verify.c?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/fs/btrfs/ref-verify.c b/fs/btrfs/ref-verify.cindex 9522a8b79d22b5..2928abf7eb8271 100644--- a/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=3ed51857a50f530ac7a1482e069dfbd1298558d4)+++ b/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=7c4e39f9d2af4abaf82ca0e315d1fd340456620f)@@ -857,6 +857,7 @@ int btrfs\_ref\_tree\_mod(struct btrfs\_fs\_info \*fs\_info, "dropping a ref for a root that doesn't have a ref on the block"); dump\_block\_entry(fs\_info, be); dump\_ref\_action(fs\_info, ra);+ rb\_erase(&ref->node, &be->refs); kfree(ref); kfree(ra); goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:07:02 +0000



=== Content from git.kernel.org_679e83ef_20250115_100823.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-15 11:29:21 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:10 +0100 |
| commit | [6370db28af9a8ae3bbdfe97f8a48f8f995e144cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf)) | |
| tree | [395f4d63e544c98c43b5503b4d6996464a127bef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf) | |
| parent | [db66fb87c21e8ae724886e6a464dcbac562a64c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db66fb87c21e8ae724886e6a464dcbac562a64c6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf&id2=db66fb87c21e8ae724886e6a464dcbac562a64c6)) | |
| download | [linux-6370db28af9a8ae3bbdfe97f8a48f8f995e144cf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6370db28af9a8ae3bbdfe97f8a48f8f995e144cf.tar.gz) | |

btrfs: ref-verify: fix use-after-free after invalid ref action[ Upstream commit 7c4e39f9d2af4abaf82ca0e315d1fd340456620f ]
At btrfs\_ref\_tree\_mod() after we successfully inserted the new ref entry
(local variable 'ref') into the respective block entry's rbtree (local
variable 'be'), if we find an unexpected action of BTRFS\_DROP\_DELAYED\_REF,
we error out and free the ref entry without removing it from the block
entry's rbtree. Then in the error path of btrfs\_ref\_tree\_mod() we call
btrfs\_free\_ref\_cache(), which iterates over all block entries and then
calls free\_block\_entry() for each one, and there we will trigger a
use-after-free when we are called against the block entry to which we
added the freed ref entry to its rbtree, since the rbtree still points
to the block entry, as we didn't remove it from the rbtree before freeing
it in the error path at btrfs\_ref\_tree\_mod(). Fix this by removing the
new ref entry from the rbtree before freeing it.
Syzbot report this with the following stack traces:
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_insert\_empty\_items+0x9c/0x1a0 fs/btrfs/ctree.c:4314
btrfs\_insert\_empty\_item fs/btrfs/ctree.h:669 [inline]
btrfs\_insert\_orphan\_item+0x1f1/0x320 fs/btrfs/orphan.c:23
btrfs\_orphan\_add+0x6d/0x1a0 fs/btrfs/inode.c:3482
btrfs\_unlink+0x267/0x350 fs/btrfs/inode.c:4293
vfs\_unlink+0x365/0x650 fs/namei.c:4469
do\_unlinkat+0x4ae/0x830 fs/namei.c:4533
\_\_do\_sys\_unlinkat fs/namei.c:4576 [inline]
\_\_se\_sys\_unlinkat fs/namei.c:4569 [inline]
\_\_x64\_sys\_unlinkat+0xcc/0xf0 fs/namei.c:4569
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
BTRFS error (device loop0 state EA): Ref action 1, root 5, ref\_root 5, parent 0, owner 260, offset 0, num\_refs 1
\_\_btrfs\_mod\_ref+0x76b/0xac0 fs/btrfs/extent-tree.c:2521
update\_ref\_for\_cow+0x96a/0x11f0
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
==================================================================
BUG: KASAN: slab-use-after-free in rb\_first+0x69/0x70 lib/rbtree.c:473
Read of size 8 at addr ffff888042d1af38 by task syz.0.0/5329
CPU: 0 UID: 0 PID: 5329 Comm: syz.0.0 Not tainted 6.12.0-rc7-syzkaller #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:488
kasan\_report+0x143/0x180 mm/kasan/report.c:601
rb\_first+0x69/0x70 lib/rbtree.c:473
free\_block\_entry+0x78/0x230 fs/btrfs/ref-verify.c:248
btrfs\_free\_ref\_cache+0xa3/0x100 fs/btrfs/ref-verify.c:917
btrfs\_ref\_tree\_mod+0x139f/0x15e0 fs/btrfs/ref-verify.c:898
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f996df7e719
RSP: 002b:00007f996ede7038 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 00007f996e135f80 RCX: 00007f996df7e719
RDX: 0000000020000180 RSI: 00000000c4009420 RDI: 0000000000000004
RBP: 00007f996dff139e R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f996e135f80 R15: 00007fff79f32e68
</TASK>
Allocated by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0x98/0xb0 mm/kasan/common.c:394
kasan\_kmalloc include/linux/kasan.h:257 [inline]
\_\_kmalloc\_cache\_noprof+0x19c/0x2c0 mm/slub.c:4295
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
btrfs\_ref\_tree\_mod+0x264/0x15e0 fs/btrfs/ref-verify.c:701
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x1a0/0x440 mm/slub.c:4727
btrfs\_ref\_tree\_mod+0x136c/0x15e0
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
The buggy address belongs to the object at ffff888042d1af00
which belongs to the cache kmalloc-64 of size 64
The buggy address is located 56 bytes inside of
freed 64-byte region [ffff888042d1af00, ffff888042d1af40)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x42d1a
anon flags: 0x4fff00000000000(node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000000 ffff88801ac418c0 0000000000000000 dead000000000001
raw: 0000000000000000 0000000000200020 00000001f5000000 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x52c40(GFP\_NOFS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP), pid 5055, tgid 5055 (dhcpcd-run-hook), ts 40377240074, free\_ts 40376848335
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1541
prep\_new\_page mm/page\_alloc.c:1549 [inline]
get\_page\_from\_freelist+0x3649/0x3790 mm/page\_alloc.c:3459
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4735
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_slab\_page+0x6a/0x140 mm/slub.c:2412
allocate\_slab+0x5a/0x2f0 mm/slub.c:2578
new\_slab mm/slub.c:2631 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3818
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_do\_kmalloc\_node mm/slub.c:4263 [inline]
\_\_kmalloc\_noprof+0x25a/0x400 mm/slub.c:4276
kmalloc\_noprof include/linux/slab.h:882 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
tomoyo\_encode2 security/tomoyo/realpath.c:45 [inline]
tomoyo\_encode+0x26f/0x540 security/tomoyo/realpath.c:80
tomoyo\_realpath\_from\_path+0x59e/0x5e0 security/tomoyo/realpath.c:283
tomoyo\_get\_realpath security/tomoyo/file.c:151 [inline]
tomoyo\_check\_open\_permission+0x255/0x500 security/tomoyo/file.c:771
security\_file\_open+0x777/0x990 security/security.c:3109
do\_dentry\_open+0x369/0x1460 fs/open.c:945
vfs\_open+0x3e/0x330 fs/open.c:1088
do\_open fs/namei.c:3774 [inline]
path\_openat+0x2c84/0x3590 fs/namei.c:3933
page last free pid 5055 tgid 5055 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1112 [inline]
free\_unref\_page+0xcfb/0xf20 mm/page\_alloc.c:2642
free\_pipe\_info+0x300/0x390 fs/pipe.c:860
put\_pipe\_info fs/pipe.c:719 [inline]
pipe\_release+0x245/0x320 fs/pipe.c:742
\_\_fput+0x23f/0x880 fs/file\_table.c:431
\_\_do\_sys\_close fs/open.c:1567 [inline]
\_\_se\_sys\_close fs/open.c:1552 [inline]
\_\_x64\_sys\_close+0x7f/0x110 fs/open.c:1552
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Memory state around the buggy address:
ffff888042d1ae00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
ffff888042d1ae80: 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc fc
>ffff888042d1af00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
^
ffff888042d1af80: 00 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc
ffff888042d1b000: 00 00 00 00 00 fc fc 00 00 00 00 00 fc fc 00 00
Reported-by: syzbot+7325f164162e200000c1@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE@google.com/T/#u](https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE%40google.com/T/#u)
Fixes: fd708b81d972 ("Btrfs: add a extent ref verify tool")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf)

| -rw-r--r-- | [fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ref-verify.c?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/fs/btrfs/ref-verify.c b/fs/btrfs/ref-verify.cindex 8083fe866d2b49..56ceb23bd74092 100644--- a/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=db66fb87c21e8ae724886e6a464dcbac562a64c6)+++ b/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=6370db28af9a8ae3bbdfe97f8a48f8f995e144cf)@@ -846,6 +846,7 @@ int btrfs\_ref\_tree\_mod(struct btrfs\_fs\_info \*fs\_info, "dropping a ref for a root that doesn't have a ref on the block"); dump\_block\_entry(fs\_info, be); dump\_ref\_action(fs\_info, ra);+ rb\_erase(&ref->node, &be->refs); kfree(ref); kfree(ra); goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:07:01 +0000



=== Content from git.kernel.org_6bacdc50_20250115_100827.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-15 11:29:21 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:42 +0100 |
| commit | [dfb9fe7de61f34cc241ab3900bdde93341096e0e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e)) | |
| tree | [08b5f987ae313483c36f6cf83d66d72c872706a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e) | |
| parent | [a5abba5e0e586e258ded3e798fe5f69c66fec198](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a5abba5e0e586e258ded3e798fe5f69c66fec198) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e&id2=a5abba5e0e586e258ded3e798fe5f69c66fec198)) | |
| download | [linux-dfb9fe7de61f34cc241ab3900bdde93341096e0e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dfb9fe7de61f34cc241ab3900bdde93341096e0e.tar.gz) | |

btrfs: ref-verify: fix use-after-free after invalid ref action[ Upstream commit 7c4e39f9d2af4abaf82ca0e315d1fd340456620f ]
At btrfs\_ref\_tree\_mod() after we successfully inserted the new ref entry
(local variable 'ref') into the respective block entry's rbtree (local
variable 'be'), if we find an unexpected action of BTRFS\_DROP\_DELAYED\_REF,
we error out and free the ref entry without removing it from the block
entry's rbtree. Then in the error path of btrfs\_ref\_tree\_mod() we call
btrfs\_free\_ref\_cache(), which iterates over all block entries and then
calls free\_block\_entry() for each one, and there we will trigger a
use-after-free when we are called against the block entry to which we
added the freed ref entry to its rbtree, since the rbtree still points
to the block entry, as we didn't remove it from the rbtree before freeing
it in the error path at btrfs\_ref\_tree\_mod(). Fix this by removing the
new ref entry from the rbtree before freeing it.
Syzbot report this with the following stack traces:
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_insert\_empty\_items+0x9c/0x1a0 fs/btrfs/ctree.c:4314
btrfs\_insert\_empty\_item fs/btrfs/ctree.h:669 [inline]
btrfs\_insert\_orphan\_item+0x1f1/0x320 fs/btrfs/orphan.c:23
btrfs\_orphan\_add+0x6d/0x1a0 fs/btrfs/inode.c:3482
btrfs\_unlink+0x267/0x350 fs/btrfs/inode.c:4293
vfs\_unlink+0x365/0x650 fs/namei.c:4469
do\_unlinkat+0x4ae/0x830 fs/namei.c:4533
\_\_do\_sys\_unlinkat fs/namei.c:4576 [inline]
\_\_se\_sys\_unlinkat fs/namei.c:4569 [inline]
\_\_x64\_sys\_unlinkat+0xcc/0xf0 fs/namei.c:4569
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
BTRFS error (device loop0 state EA): Ref action 1, root 5, ref\_root 5, parent 0, owner 260, offset 0, num\_refs 1
\_\_btrfs\_mod\_ref+0x76b/0xac0 fs/btrfs/extent-tree.c:2521
update\_ref\_for\_cow+0x96a/0x11f0
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
==================================================================
BUG: KASAN: slab-use-after-free in rb\_first+0x69/0x70 lib/rbtree.c:473
Read of size 8 at addr ffff888042d1af38 by task syz.0.0/5329
CPU: 0 UID: 0 PID: 5329 Comm: syz.0.0 Not tainted 6.12.0-rc7-syzkaller #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:488
kasan\_report+0x143/0x180 mm/kasan/report.c:601
rb\_first+0x69/0x70 lib/rbtree.c:473
free\_block\_entry+0x78/0x230 fs/btrfs/ref-verify.c:248
btrfs\_free\_ref\_cache+0xa3/0x100 fs/btrfs/ref-verify.c:917
btrfs\_ref\_tree\_mod+0x139f/0x15e0 fs/btrfs/ref-verify.c:898
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f996df7e719
RSP: 002b:00007f996ede7038 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 00007f996e135f80 RCX: 00007f996df7e719
RDX: 0000000020000180 RSI: 00000000c4009420 RDI: 0000000000000004
RBP: 00007f996dff139e R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f996e135f80 R15: 00007fff79f32e68
</TASK>
Allocated by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0x98/0xb0 mm/kasan/common.c:394
kasan\_kmalloc include/linux/kasan.h:257 [inline]
\_\_kmalloc\_cache\_noprof+0x19c/0x2c0 mm/slub.c:4295
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
btrfs\_ref\_tree\_mod+0x264/0x15e0 fs/btrfs/ref-verify.c:701
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x1a0/0x440 mm/slub.c:4727
btrfs\_ref\_tree\_mod+0x136c/0x15e0
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
The buggy address belongs to the object at ffff888042d1af00
which belongs to the cache kmalloc-64 of size 64
The buggy address is located 56 bytes inside of
freed 64-byte region [ffff888042d1af00, ffff888042d1af40)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x42d1a
anon flags: 0x4fff00000000000(node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000000 ffff88801ac418c0 0000000000000000 dead000000000001
raw: 0000000000000000 0000000000200020 00000001f5000000 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x52c40(GFP\_NOFS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP), pid 5055, tgid 5055 (dhcpcd-run-hook), ts 40377240074, free\_ts 40376848335
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1541
prep\_new\_page mm/page\_alloc.c:1549 [inline]
get\_page\_from\_freelist+0x3649/0x3790 mm/page\_alloc.c:3459
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4735
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_slab\_page+0x6a/0x140 mm/slub.c:2412
allocate\_slab+0x5a/0x2f0 mm/slub.c:2578
new\_slab mm/slub.c:2631 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3818
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_do\_kmalloc\_node mm/slub.c:4263 [inline]
\_\_kmalloc\_noprof+0x25a/0x400 mm/slub.c:4276
kmalloc\_noprof include/linux/slab.h:882 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
tomoyo\_encode2 security/tomoyo/realpath.c:45 [inline]
tomoyo\_encode+0x26f/0x540 security/tomoyo/realpath.c:80
tomoyo\_realpath\_from\_path+0x59e/0x5e0 security/tomoyo/realpath.c:283
tomoyo\_get\_realpath security/tomoyo/file.c:151 [inline]
tomoyo\_check\_open\_permission+0x255/0x500 security/tomoyo/file.c:771
security\_file\_open+0x777/0x990 security/security.c:3109
do\_dentry\_open+0x369/0x1460 fs/open.c:945
vfs\_open+0x3e/0x330 fs/open.c:1088
do\_open fs/namei.c:3774 [inline]
path\_openat+0x2c84/0x3590 fs/namei.c:3933
page last free pid 5055 tgid 5055 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1112 [inline]
free\_unref\_page+0xcfb/0xf20 mm/page\_alloc.c:2642
free\_pipe\_info+0x300/0x390 fs/pipe.c:860
put\_pipe\_info fs/pipe.c:719 [inline]
pipe\_release+0x245/0x320 fs/pipe.c:742
\_\_fput+0x23f/0x880 fs/file\_table.c:431
\_\_do\_sys\_close fs/open.c:1567 [inline]
\_\_se\_sys\_close fs/open.c:1552 [inline]
\_\_x64\_sys\_close+0x7f/0x110 fs/open.c:1552
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Memory state around the buggy address:
ffff888042d1ae00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
ffff888042d1ae80: 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc fc
>ffff888042d1af00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
^
ffff888042d1af80: 00 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc
ffff888042d1b000: 00 00 00 00 00 fc fc 00 00 00 00 00 fc fc 00 00
Reported-by: syzbot+7325f164162e200000c1@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE@google.com/T/#u](https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE%40google.com/T/#u)
Fixes: fd708b81d972 ("Btrfs: add a extent ref verify tool")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e)

| -rw-r--r-- | [fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ref-verify.c?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/fs/btrfs/ref-verify.c b/fs/btrfs/ref-verify.cindex d59e89ef3251d2..4acde2a05d1162 100644--- a/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=a5abba5e0e586e258ded3e798fe5f69c66fec198)+++ b/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=dfb9fe7de61f34cc241ab3900bdde93341096e0e)@@ -851,6 +851,7 @@ int btrfs\_ref\_tree\_mod(struct btrfs\_fs\_info \*fs\_info, "dropping a ref for a root that doesn't have a ref on the block"); dump\_block\_entry(fs\_info, be); dump\_ref\_action(fs\_info, ra);+ rb\_erase(&ref->node, &be->refs); kfree(ref); kfree(ra); goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:07:04 +0000



=== Content from git.kernel.org_2d19ebf8_20250115_100826.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d2b85ce0561fde894e28fa01bd5d32820d585006)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2b85ce0561fde894e28fa01bd5d32820d585006)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2b85ce0561fde894e28fa01bd5d32820d585006)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2b85ce0561fde894e28fa01bd5d32820d585006)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-15 11:29:21 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:22 +0100 |
| commit | [d2b85ce0561fde894e28fa01bd5d32820d585006](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2b85ce0561fde894e28fa01bd5d32820d585006) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d2b85ce0561fde894e28fa01bd5d32820d585006)) | |
| tree | [ece1d3d4b26373417d64f486bc1d8b5936d1171f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2b85ce0561fde894e28fa01bd5d32820d585006) | |
| parent | [c71d114ef68c95da5a82ec85a721ab31f5bd905b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c71d114ef68c95da5a82ec85a721ab31f5bd905b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2b85ce0561fde894e28fa01bd5d32820d585006&id2=c71d114ef68c95da5a82ec85a721ab31f5bd905b)) | |
| download | [linux-d2b85ce0561fde894e28fa01bd5d32820d585006.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d2b85ce0561fde894e28fa01bd5d32820d585006.tar.gz) | |

btrfs: ref-verify: fix use-after-free after invalid ref action[ Upstream commit 7c4e39f9d2af4abaf82ca0e315d1fd340456620f ]
At btrfs\_ref\_tree\_mod() after we successfully inserted the new ref entry
(local variable 'ref') into the respective block entry's rbtree (local
variable 'be'), if we find an unexpected action of BTRFS\_DROP\_DELAYED\_REF,
we error out and free the ref entry without removing it from the block
entry's rbtree. Then in the error path of btrfs\_ref\_tree\_mod() we call
btrfs\_free\_ref\_cache(), which iterates over all block entries and then
calls free\_block\_entry() for each one, and there we will trigger a
use-after-free when we are called against the block entry to which we
added the freed ref entry to its rbtree, since the rbtree still points
to the block entry, as we didn't remove it from the rbtree before freeing
it in the error path at btrfs\_ref\_tree\_mod(). Fix this by removing the
new ref entry from the rbtree before freeing it.
Syzbot report this with the following stack traces:
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_insert\_empty\_items+0x9c/0x1a0 fs/btrfs/ctree.c:4314
btrfs\_insert\_empty\_item fs/btrfs/ctree.h:669 [inline]
btrfs\_insert\_orphan\_item+0x1f1/0x320 fs/btrfs/orphan.c:23
btrfs\_orphan\_add+0x6d/0x1a0 fs/btrfs/inode.c:3482
btrfs\_unlink+0x267/0x350 fs/btrfs/inode.c:4293
vfs\_unlink+0x365/0x650 fs/namei.c:4469
do\_unlinkat+0x4ae/0x830 fs/namei.c:4533
\_\_do\_sys\_unlinkat fs/namei.c:4576 [inline]
\_\_se\_sys\_unlinkat fs/namei.c:4569 [inline]
\_\_x64\_sys\_unlinkat+0xcc/0xf0 fs/namei.c:4569
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
BTRFS error (device loop0 state EA): Ref action 1, root 5, ref\_root 5, parent 0, owner 260, offset 0, num\_refs 1
\_\_btrfs\_mod\_ref+0x76b/0xac0 fs/btrfs/extent-tree.c:2521
update\_ref\_for\_cow+0x96a/0x11f0
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
==================================================================
BUG: KASAN: slab-use-after-free in rb\_first+0x69/0x70 lib/rbtree.c:473
Read of size 8 at addr ffff888042d1af38 by task syz.0.0/5329
CPU: 0 UID: 0 PID: 5329 Comm: syz.0.0 Not tainted 6.12.0-rc7-syzkaller #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:488
kasan\_report+0x143/0x180 mm/kasan/report.c:601
rb\_first+0x69/0x70 lib/rbtree.c:473
free\_block\_entry+0x78/0x230 fs/btrfs/ref-verify.c:248
btrfs\_free\_ref\_cache+0xa3/0x100 fs/btrfs/ref-verify.c:917
btrfs\_ref\_tree\_mod+0x139f/0x15e0 fs/btrfs/ref-verify.c:898
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f996df7e719
RSP: 002b:00007f996ede7038 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 00007f996e135f80 RCX: 00007f996df7e719
RDX: 0000000020000180 RSI: 00000000c4009420 RDI: 0000000000000004
RBP: 00007f996dff139e R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f996e135f80 R15: 00007fff79f32e68
</TASK>
Allocated by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0x98/0xb0 mm/kasan/common.c:394
kasan\_kmalloc include/linux/kasan.h:257 [inline]
\_\_kmalloc\_cache\_noprof+0x19c/0x2c0 mm/slub.c:4295
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
btrfs\_ref\_tree\_mod+0x264/0x15e0 fs/btrfs/ref-verify.c:701
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x1a0/0x440 mm/slub.c:4727
btrfs\_ref\_tree\_mod+0x136c/0x15e0
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
The buggy address belongs to the object at ffff888042d1af00
which belongs to the cache kmalloc-64 of size 64
The buggy address is located 56 bytes inside of
freed 64-byte region [ffff888042d1af00, ffff888042d1af40)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x42d1a
anon flags: 0x4fff00000000000(node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000000 ffff88801ac418c0 0000000000000000 dead000000000001
raw: 0000000000000000 0000000000200020 00000001f5000000 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x52c40(GFP\_NOFS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP), pid 5055, tgid 5055 (dhcpcd-run-hook), ts 40377240074, free\_ts 40376848335
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1541
prep\_new\_page mm/page\_alloc.c:1549 [inline]
get\_page\_from\_freelist+0x3649/0x3790 mm/page\_alloc.c:3459
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4735
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_slab\_page+0x6a/0x140 mm/slub.c:2412
allocate\_slab+0x5a/0x2f0 mm/slub.c:2578
new\_slab mm/slub.c:2631 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3818
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_do\_kmalloc\_node mm/slub.c:4263 [inline]
\_\_kmalloc\_noprof+0x25a/0x400 mm/slub.c:4276
kmalloc\_noprof include/linux/slab.h:882 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
tomoyo\_encode2 security/tomoyo/realpath.c:45 [inline]
tomoyo\_encode+0x26f/0x540 security/tomoyo/realpath.c:80
tomoyo\_realpath\_from\_path+0x59e/0x5e0 security/tomoyo/realpath.c:283
tomoyo\_get\_realpath security/tomoyo/file.c:151 [inline]
tomoyo\_check\_open\_permission+0x255/0x500 security/tomoyo/file.c:771
security\_file\_open+0x777/0x990 security/security.c:3109
do\_dentry\_open+0x369/0x1460 fs/open.c:945
vfs\_open+0x3e/0x330 fs/open.c:1088
do\_open fs/namei.c:3774 [inline]
path\_openat+0x2c84/0x3590 fs/namei.c:3933
page last free pid 5055 tgid 5055 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1112 [inline]
free\_unref\_page+0xcfb/0xf20 mm/page\_alloc.c:2642
free\_pipe\_info+0x300/0x390 fs/pipe.c:860
put\_pipe\_info fs/pipe.c:719 [inline]
pipe\_release+0x245/0x320 fs/pipe.c:742
\_\_fput+0x23f/0x880 fs/file\_table.c:431
\_\_do\_sys\_close fs/open.c:1567 [inline]
\_\_se\_sys\_close fs/open.c:1552 [inline]
\_\_x64\_sys\_close+0x7f/0x110 fs/open.c:1552
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Memory state around the buggy address:
ffff888042d1ae00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
ffff888042d1ae80: 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc fc
>ffff888042d1af00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
^
ffff888042d1af80: 00 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc
ffff888042d1b000: 00 00 00 00 00 fc fc 00 00 00 00 00 fc fc 00 00
Reported-by: syzbot+7325f164162e200000c1@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE@google.com/T/#u](https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE%40google.com/T/#u)
Fixes: fd708b81d972 ("Btrfs: add a extent ref verify tool")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2b85ce0561fde894e28fa01bd5d32820d585006)

| -rw-r--r-- | [fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ref-verify.c?id=d2b85ce0561fde894e28fa01bd5d32820d585006) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/fs/btrfs/ref-verify.c b/fs/btrfs/ref-verify.cindex 4925666910267d..5e46ca35b4fdf0 100644--- a/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=c71d114ef68c95da5a82ec85a721ab31f5bd905b)+++ b/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=d2b85ce0561fde894e28fa01bd5d32820d585006)@@ -846,6 +846,7 @@ int btrfs\_ref\_tree\_mod(struct btrfs\_fs\_info \*fs\_info, "dropping a ref for a root that doesn't have a ref on the block"); dump\_block\_entry(fs\_info, be); dump\_ref\_action(fs\_info, ra);+ rb\_erase(&ref->node, &be->refs); kfree(ref); kfree(ra); goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:07:03 +0000



=== Content from git.kernel.org_37d159f2_20250115_100823.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-11-15 11:29:21 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:33:01 +0100 |
| commit | [4275ac2741941c9c7c2293619fdbacb9f70ba85b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b)) | |
| tree | [4e13f4c4616f427db242f75b9c5149fdaabe59f1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b) | |
| parent | [757171d1369b3b47f36932d40a05a0715496dcab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=757171d1369b3b47f36932d40a05a0715496dcab) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b&id2=757171d1369b3b47f36932d40a05a0715496dcab)) | |
| download | [linux-4275ac2741941c9c7c2293619fdbacb9f70ba85b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4275ac2741941c9c7c2293619fdbacb9f70ba85b.tar.gz) | |

btrfs: ref-verify: fix use-after-free after invalid ref action[ Upstream commit 7c4e39f9d2af4abaf82ca0e315d1fd340456620f ]
At btrfs\_ref\_tree\_mod() after we successfully inserted the new ref entry
(local variable 'ref') into the respective block entry's rbtree (local
variable 'be'), if we find an unexpected action of BTRFS\_DROP\_DELAYED\_REF,
we error out and free the ref entry without removing it from the block
entry's rbtree. Then in the error path of btrfs\_ref\_tree\_mod() we call
btrfs\_free\_ref\_cache(), which iterates over all block entries and then
calls free\_block\_entry() for each one, and there we will trigger a
use-after-free when we are called against the block entry to which we
added the freed ref entry to its rbtree, since the rbtree still points
to the block entry, as we didn't remove it from the rbtree before freeing
it in the error path at btrfs\_ref\_tree\_mod(). Fix this by removing the
new ref entry from the rbtree before freeing it.
Syzbot report this with the following stack traces:
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_insert\_empty\_items+0x9c/0x1a0 fs/btrfs/ctree.c:4314
btrfs\_insert\_empty\_item fs/btrfs/ctree.h:669 [inline]
btrfs\_insert\_orphan\_item+0x1f1/0x320 fs/btrfs/orphan.c:23
btrfs\_orphan\_add+0x6d/0x1a0 fs/btrfs/inode.c:3482
btrfs\_unlink+0x267/0x350 fs/btrfs/inode.c:4293
vfs\_unlink+0x365/0x650 fs/namei.c:4469
do\_unlinkat+0x4ae/0x830 fs/namei.c:4533
\_\_do\_sys\_unlinkat fs/namei.c:4576 [inline]
\_\_se\_sys\_unlinkat fs/namei.c:4569 [inline]
\_\_x64\_sys\_unlinkat+0xcc/0xf0 fs/namei.c:4569
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
BTRFS error (device loop0 state EA): Ref action 1, root 5, ref\_root 5, parent 0, owner 260, offset 0, num\_refs 1
\_\_btrfs\_mod\_ref+0x76b/0xac0 fs/btrfs/extent-tree.c:2521
update\_ref\_for\_cow+0x96a/0x11f0
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
BTRFS error (device loop0 state EA): Ref action 2, root 5, ref\_root 0, parent 8564736, owner 0, offset 0, num\_refs 18446744073709551615
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
==================================================================
BUG: KASAN: slab-use-after-free in rb\_first+0x69/0x70 lib/rbtree.c:473
Read of size 8 at addr ffff888042d1af38 by task syz.0.0/5329
CPU: 0 UID: 0 PID: 5329 Comm: syz.0.0 Not tainted 6.12.0-rc7-syzkaller #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:488
kasan\_report+0x143/0x180 mm/kasan/report.c:601
rb\_first+0x69/0x70 lib/rbtree.c:473
free\_block\_entry+0x78/0x230 fs/btrfs/ref-verify.c:248
btrfs\_free\_ref\_cache+0xa3/0x100 fs/btrfs/ref-verify.c:917
btrfs\_ref\_tree\_mod+0x139f/0x15e0 fs/btrfs/ref-verify.c:898
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f996df7e719
RSP: 002b:00007f996ede7038 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 00007f996e135f80 RCX: 00007f996df7e719
RDX: 0000000020000180 RSI: 00000000c4009420 RDI: 0000000000000004
RBP: 00007f996dff139e R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f996e135f80 R15: 00007fff79f32e68
</TASK>
Allocated by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0x98/0xb0 mm/kasan/common.c:394
kasan\_kmalloc include/linux/kasan.h:257 [inline]
\_\_kmalloc\_cache\_noprof+0x19c/0x2c0 mm/slub.c:4295
kmalloc\_noprof include/linux/slab.h:878 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
btrfs\_ref\_tree\_mod+0x264/0x15e0 fs/btrfs/ref-verify.c:701
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 5329:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:579
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:230 [inline]
slab\_free\_hook mm/slub.c:2342 [inline]
slab\_free mm/slub.c:4579 [inline]
kfree+0x1a0/0x440 mm/slub.c:4727
btrfs\_ref\_tree\_mod+0x136c/0x15e0
btrfs\_free\_extent+0x33c/0x380 fs/btrfs/extent-tree.c:3544
\_\_btrfs\_mod\_ref+0x7dd/0xac0 fs/btrfs/extent-tree.c:2523
update\_ref\_for\_cow+0x9cd/0x11f0 fs/btrfs/ctree.c:512
btrfs\_force\_cow\_block+0x9f6/0x1da0 fs/btrfs/ctree.c:594
btrfs\_cow\_block+0x35e/0xa40 fs/btrfs/ctree.c:754
btrfs\_search\_slot+0xbdd/0x30d0 fs/btrfs/ctree.c:2116
btrfs\_lookup\_inode+0xdc/0x480 fs/btrfs/inode-item.c:411
\_\_btrfs\_update\_delayed\_inode+0x1e7/0xb90 fs/btrfs/delayed-inode.c:1030
btrfs\_update\_delayed\_inode fs/btrfs/delayed-inode.c:1114 [inline]
\_\_btrfs\_commit\_inode\_delayed\_items+0x2318/0x24a0 fs/btrfs/delayed-inode.c:1137
\_\_btrfs\_run\_delayed\_items+0x213/0x490 fs/btrfs/delayed-inode.c:1171
btrfs\_commit\_transaction+0x8a8/0x3740 fs/btrfs/transaction.c:2313
prepare\_to\_relocate+0x3c4/0x4c0 fs/btrfs/relocation.c:3586
relocate\_block\_group+0x16c/0xd40 fs/btrfs/relocation.c:3611
btrfs\_relocate\_block\_group+0x77d/0xd90 fs/btrfs/relocation.c:4081
btrfs\_relocate\_chunk+0x12c/0x3b0 fs/btrfs/volumes.c:3377
\_\_btrfs\_balance+0x1b0f/0x26b0 fs/btrfs/volumes.c:4161
btrfs\_balance+0xbdc/0x10c0 fs/btrfs/volumes.c:4538
btrfs\_ioctl\_balance+0x493/0x7c0 fs/btrfs/ioctl.c:3673
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xf9/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
The buggy address belongs to the object at ffff888042d1af00
which belongs to the cache kmalloc-64 of size 64
The buggy address is located 56 bytes inside of
freed 64-byte region [ffff888042d1af00, ffff888042d1af40)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x42d1a
anon flags: 0x4fff00000000000(node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000000 ffff88801ac418c0 0000000000000000 dead000000000001
raw: 0000000000000000 0000000000200020 00000001f5000000 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x52c40(GFP\_NOFS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP), pid 5055, tgid 5055 (dhcpcd-run-hook), ts 40377240074, free\_ts 40376848335
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1541
prep\_new\_page mm/page\_alloc.c:1549 [inline]
get\_page\_from\_freelist+0x3649/0x3790 mm/page\_alloc.c:3459
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4735
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_slab\_page+0x6a/0x140 mm/slub.c:2412
allocate\_slab+0x5a/0x2f0 mm/slub.c:2578
new\_slab mm/slub.c:2631 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3818
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3908
\_\_slab\_alloc\_node mm/slub.c:3961 [inline]
slab\_alloc\_node mm/slub.c:4122 [inline]
\_\_do\_kmalloc\_node mm/slub.c:4263 [inline]
\_\_kmalloc\_noprof+0x25a/0x400 mm/slub.c:4276
kmalloc\_noprof include/linux/slab.h:882 [inline]
kzalloc\_noprof include/linux/slab.h:1014 [inline]
tomoyo\_encode2 security/tomoyo/realpath.c:45 [inline]
tomoyo\_encode+0x26f/0x540 security/tomoyo/realpath.c:80
tomoyo\_realpath\_from\_path+0x59e/0x5e0 security/tomoyo/realpath.c:283
tomoyo\_get\_realpath security/tomoyo/file.c:151 [inline]
tomoyo\_check\_open\_permission+0x255/0x500 security/tomoyo/file.c:771
security\_file\_open+0x777/0x990 security/security.c:3109
do\_dentry\_open+0x369/0x1460 fs/open.c:945
vfs\_open+0x3e/0x330 fs/open.c:1088
do\_open fs/namei.c:3774 [inline]
path\_openat+0x2c84/0x3590 fs/namei.c:3933
page last free pid 5055 tgid 5055 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1112 [inline]
free\_unref\_page+0xcfb/0xf20 mm/page\_alloc.c:2642
free\_pipe\_info+0x300/0x390 fs/pipe.c:860
put\_pipe\_info fs/pipe.c:719 [inline]
pipe\_release+0x245/0x320 fs/pipe.c:742
\_\_fput+0x23f/0x880 fs/file\_table.c:431
\_\_do\_sys\_close fs/open.c:1567 [inline]
\_\_se\_sys\_close fs/open.c:1552 [inline]
\_\_x64\_sys\_close+0x7f/0x110 fs/open.c:1552
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Memory state around the buggy address:
ffff888042d1ae00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
ffff888042d1ae80: 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc fc
>ffff888042d1af00: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
^
ffff888042d1af80: 00 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc
ffff888042d1b000: 00 00 00 00 00 fc fc 00 00 00 00 00 fc fc 00 00
Reported-by: syzbot+7325f164162e200000c1@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE@google.com/T/#u](https://lore.kernel.org/linux-btrfs/673723eb.050a0220.1324f8.00a8.GAE%40google.com/T/#u)
Fixes: fd708b81d972 ("Btrfs: add a extent ref verify tool")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b)

| -rw-r--r-- | [fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ref-verify.c?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/fs/btrfs/ref-verify.c b/fs/btrfs/ref-verify.cindex 1ea5bfb8876e41..28ac7995716e04 100644--- a/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=757171d1369b3b47f36932d40a05a0715496dcab)+++ b/[fs/btrfs/ref-verify.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ref-verify.c?id=4275ac2741941c9c7c2293619fdbacb9f70ba85b)@@ -849,6 +849,7 @@ int btrfs\_ref\_tree\_mod(struct btrfs\_fs\_info \*fs\_info, "dropping a ref for a root that doesn't have a ref on the block"); dump\_block\_entry(fs\_info, be); dump\_ref\_action(fs\_info, ra);+ rb\_erase(&ref->node, &be->refs); kfree(ref); kfree(ra); goto out\_unlock; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:07:00 +0000


