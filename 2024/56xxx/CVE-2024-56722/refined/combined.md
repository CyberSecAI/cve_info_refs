=== Content from git.kernel.org_9b4e8134_20250114_181738.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | wenglianfa <wenglianfa@huawei.com> | 2024-10-24 20:40:00 +0800 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2024-10-30 14:13:55 +0200 |
| commit | [323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)) | |
| tree | [dbfc64438946a2cf01840c0ffe038acbc4878157](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999) | |
| parent | [d81fb6511abf18591befaa5f4a972ffc838690ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d81fb6511abf18591befaa5f4a972ffc838690ec) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999&id2=d81fb6511abf18591befaa5f4a972ffc838690ec)) | |
| download | [linux-323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999.tar.gz) | |

RDMA/hns: Fix cpu stuck caused by printings during resetDuring reset, cmd to destroy resources such as qp, cq, and mr may fail,
and error logs will be printed. When a large number of resources are
destroyed, there will be lots of printings, and it may lead to a cpu
stuck.
Delete some unnecessary printings and replace other printing functions
in these paths with the ratelimited version.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Fixes: c7bcb13442e1 ("RDMA/hns: Add SRQ support for hip08 kernel mode")
Fixes: 70f92521584f ("RDMA/hns: Use the reserved loopback QPs to free MR before destroying MPT")
Fixes: 926a01dc000d ("RDMA/hns: Add QP operations support for hip08 SoC")
Signed-off-by: wenglianfa <wenglianfa@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241024124000.2931869-6-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241024124000.2931869-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hem.c?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999) | 73 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_srq.c?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999) | 4 | |  |  |  | | --- | --- | --- | |

5 files changed, 41 insertions, 48 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex 4ec66611a14340..4106423a1b399d 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=d81fb6511abf18591befaa5f4a972ffc838690ec)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)@@ -179,8 +179,8 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) ret = hns\_roce\_destroy\_hw\_ctx(hr\_dev, HNS\_ROCE\_CMD\_DESTROY\_CQC, hr\_cq->cqn); if (ret)- dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret,- hr\_cq->cqn);+ dev\_err\_ratelimited(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n",+ ret, hr\_cq->cqn);  xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hem.c b/drivers/infiniband/hw/hns/hns\_roce\_hem.cindex ee5d2c1bb5ca07..f84521be3bea4a 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hem.c?id=d81fb6511abf18591befaa5f4a972ffc838690ec)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hem.c?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)@@ -672,8 +672,8 @@ void hns\_roce\_table\_put(struct hns\_roce\_dev \*hr\_dev,  ret = hr\_dev->hw->clear\_hem(hr\_dev, table, obj, HEM\_HOP\_STEP\_DIRECT); if (ret)- dev\_warn(dev, "failed to clear HEM base address, ret = %d.\n",- ret);+ dev\_warn\_ratelimited(dev, "failed to clear HEM base address, ret = %d.\n",+ ret);  hns\_roce\_free\_hem(hr\_dev, table->hem[i]); table->hem[i] = NULL;diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c b/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.cindex 4c3bc1f6a183ca..d1c075fb0ad892 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=d81fb6511abf18591befaa5f4a972ffc838690ec)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)@@ -373,19 +373,12 @@ static int set\_rwqe\_data\_seg(struct ib\_qp \*ibqp, const struct ib\_send\_wr \*wr, static int check\_send\_valid(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_qp \*hr\_qp) {- struct ib\_device \*ibdev = &hr\_dev->ib\_dev;- if (unlikely(hr\_qp->state == IB\_QPS\_RESET || hr\_qp->state == IB\_QPS\_INIT ||- hr\_qp->state == IB\_QPS\_RTR)) {- ibdev\_err(ibdev, "failed to post WQE, QP state %u!\n",- hr\_qp->state);+ hr\_qp->state == IB\_QPS\_RTR)) return -EINVAL;- } else if (unlikely(hr\_dev->state >= HNS\_ROCE\_DEVICE\_STATE\_RST\_DOWN)) {- ibdev\_err(ibdev, "failed to post WQE, dev state %d!\n",- hr\_dev->state);+ else if (unlikely(hr\_dev->state >= HNS\_ROCE\_DEVICE\_STATE\_RST\_DOWN)) return -EIO;- }  return 0; }@@ -2775,8 +2768,8 @@ static int free\_mr\_modify\_rsv\_qp(struct hns\_roce\_dev \*hr\_dev, ret = hr\_dev->hw->modify\_qp(&hr\_qp->ibqp, attr, mask, IB\_QPS\_INIT, IB\_QPS\_INIT, NULL); if (ret) {- ibdev\_err(ibdev, "failed to modify qp to init, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev, "failed to modify qp to init, ret = %d.\n",+ ret); return ret; } @@ -3421,8 +3414,8 @@ static int free\_mr\_post\_send\_lp\_wqe(struct hns\_roce\_qp \*hr\_qp)  ret = hns\_roce\_v2\_post\_send(&hr\_qp->ibqp, send\_wr, &bad\_wr); if (ret) {- ibdev\_err(ibdev, "failed to post wqe for free mr, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev, "failed to post wqe for free mr, ret = %d.\n",+ ret); return ret; } @@ -3461,9 +3454,9 @@ static void free\_mr\_send\_cmd\_to\_hw(struct hns\_roce\_dev \*hr\_dev)  ret = free\_mr\_post\_send\_lp\_wqe(hr\_qp); if (ret) {- ibdev\_err(ibdev,- "failed to send wqe (qp:0x%lx) for free mr, ret = %d.\n",- hr\_qp->qpn, ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to send wqe (qp:0x%lx) for free mr, ret = %d.\n",+ hr\_qp->qpn, ret); break; } @@ -3474,16 +3467,16 @@ static void free\_mr\_send\_cmd\_to\_hw(struct hns\_roce\_dev \*hr\_dev) while (cqe\_cnt) { npolled = hns\_roce\_v2\_poll\_cq(&free\_mr->rsv\_cq->ib\_cq, cqe\_cnt, wc); if (npolled < 0) {- ibdev\_err(ibdev,- "failed to poll cqe for free mr, remain %d cqe.\n",- cqe\_cnt);+ ibdev\_err\_ratelimited(ibdev,+ "failed to poll cqe for free mr, remain %d cqe.\n",+ cqe\_cnt); goto out; }  if (time\_after(jiffies, end)) {- ibdev\_err(ibdev,- "failed to poll cqe for free mr and timeout, remain %d cqe.\n",- cqe\_cnt);+ ibdev\_err\_ratelimited(ibdev,+ "failed to poll cqe for free mr and timeout, remain %d cqe.\n",+ cqe\_cnt); goto out; } cqe\_cnt -= npolled;@@ -5061,10 +5054,8 @@ static int hns\_roce\_v2\_set\_abs\_fields(struct ib\_qp \*ibqp, struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibqp->device); int ret = 0; - if (!check\_qp\_state(cur\_state, new\_state)) {- ibdev\_err(&hr\_dev->ib\_dev, "Illegal state for QP!\n");+ if (!check\_qp\_state(cur\_state, new\_state)) return -EINVAL;- }  if (cur\_state == IB\_QPS\_RESET && new\_state == IB\_QPS\_INIT) { memset(qpc\_mask, 0, hr\_dev->caps.qpc\_sz);@@ -5325,7 +5316,7 @@ static int hns\_roce\_v2\_modify\_qp(struct ib\_qp \*ibqp, /\* SW pass context to HW \*/ ret = hns\_roce\_v2\_qp\_modify(hr\_dev, context, qpc\_mask, hr\_qp); if (ret) {- ibdev\_err(ibdev, "failed to modify QP, ret = %d.\n", ret);+ ibdev\_err\_ratelimited(ibdev, "failed to modify QP, ret = %d.\n", ret); goto out; } @@ -5463,7 +5454,9 @@ static int hns\_roce\_v2\_query\_qp(struct ib\_qp \*ibqp, struct ib\_qp\_attr \*qp\_attr,  ret = hns\_roce\_v2\_query\_qpc(hr\_dev, hr\_qp->qpn, &context); if (ret) {- ibdev\_err(ibdev, "failed to query QPC, ret = %d.\n", ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to query QPC, ret = %d.\n",+ ret); ret = -EINVAL; goto out; }@@ -5471,7 +5464,7 @@ static int hns\_roce\_v2\_query\_qp(struct ib\_qp \*ibqp, struct ib\_qp\_attr \*qp\_attr, state = hr\_reg\_read(&context, QPC\_QP\_ST); tmp\_qp\_state = to\_ib\_qp\_st((enum hns\_roce\_v2\_qp\_state)state); if (tmp\_qp\_state == -1) {- ibdev\_err(ibdev, "Illegal ib\_qp\_state\n");+ ibdev\_err\_ratelimited(ibdev, "Illegal ib\_qp\_state\n"); ret = -EINVAL; goto out; }@@ -5564,9 +5557,9 @@ static int hns\_roce\_v2\_destroy\_qp\_common(struct hns\_roce\_dev \*hr\_dev, ret = hns\_roce\_v2\_modify\_qp(&hr\_qp->ibqp, NULL, 0, hr\_qp->state, IB\_QPS\_RESET, udata); if (ret)- ibdev\_err(ibdev,- "failed to modify QP to RST, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to modify QP to RST, ret = %d.\n",+ ret); }  send\_cq = hr\_qp->ibqp.send\_cq ? to\_hr\_cq(hr\_qp->ibqp.send\_cq) : NULL;@@ -5609,9 +5602,9 @@ int hns\_roce\_v2\_destroy\_qp(struct ib\_qp \*ibqp, struct ib\_udata \*udata)  ret = hns\_roce\_v2\_destroy\_qp\_common(hr\_dev, hr\_qp, udata); if (ret)- ibdev\_err(&hr\_dev->ib\_dev,- "failed to destroy QP, QPN = 0x%06lx, ret = %d.\n",- hr\_qp->qpn, ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to destroy QP, QPN = 0x%06lx, ret = %d.\n",+ hr\_qp->qpn, ret);  hns\_roce\_qp\_destroy(hr\_dev, hr\_qp, udata); @@ -5905,9 +5898,9 @@ static int hns\_roce\_v2\_modify\_cq(struct ib\_cq \*cq, u16 cq\_count, u16 cq\_period) HNS\_ROCE\_CMD\_MODIFY\_CQC, hr\_cq->cqn); hns\_roce\_free\_cmd\_mailbox(hr\_dev, mailbox); if (ret)- ibdev\_err(&hr\_dev->ib\_dev,- "failed to process cmd when modifying CQ, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to process cmd when modifying CQ, ret = %d.\n",+ ret);  err\_out: if (ret)@@ -5931,9 +5924,9 @@ static int hns\_roce\_v2\_query\_cqc(struct hns\_roce\_dev \*hr\_dev, u32 cqn, ret = hns\_roce\_cmd\_mbox(hr\_dev, 0, mailbox->dma, HNS\_ROCE\_CMD\_QUERY\_CQC, cqn); if (ret) {- ibdev\_err(&hr\_dev->ib\_dev,- "failed to process cmd when querying CQ, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to process cmd when querying CQ, ret = %d.\n",+ ret); goto err\_mailbox; } diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex 846da8c78b8b72..b3f4327d0e64af 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=d81fb6511abf18591befaa5f4a972ffc838690ec)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)@@ -138,8 +138,8 @@ static void hns\_roce\_mr\_free(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_mr \*mr key\_to\_hw\_index(mr->key) & (hr\_dev->caps.num\_mtpts - 1)); if (ret)- ibdev\_warn(ibdev, "failed to destroy mpt, ret = %d.\n",- ret);+ ibdev\_warn\_ratelimited(ibdev, "failed to destroy mpt, ret = %d.\n",+ ret); }  free\_mr\_pbl(hr\_dev, mr);diff --git a/drivers/infiniband/hw/hns/hns\_roce\_srq.c b/drivers/infiniband/hw/hns/hns\_roce\_srq.cindex c9b8233f4b0577..70c06ef65603d8 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_srq.c?id=d81fb6511abf18591befaa5f4a972ffc838690ec)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_srq.c?id=323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999)@@ -151,8 +151,8 @@ static void free\_srqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_srq \*srq) ret = hns\_roce\_destroy\_hw\_ctx(hr\_dev, HNS\_ROCE\_CMD\_DESTROY\_SRQ, srq->srqn); if (ret)- dev\_err(hr\_dev->dev, "DESTROY\_SRQ failed (%d) for SRQN %06lx\n",- ret, srq->srqn);+ dev\_err\_ratelimited(hr\_dev->dev, "DESTROY\_SRQ failed (%d) for SRQN %06lx\n",+ ret, srq->srqn);  xa\_erase\_irq(&srq\_table->xa, srq->srqn); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:16:15 +0000



=== Content from git.kernel.org_0d79d8b2_20250114_181740.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | wenglianfa <wenglianfa@huawei.com> | 2024-10-24 20:40:00 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:16 +0100 |
| commit | [b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)) | |
| tree | [519ff1b514b9e5dcd0142e78fb67885d2b859d54](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6) | |
| parent | [8e20ac838be89a3bc420a312d4460342e5c57f45](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e20ac838be89a3bc420a312d4460342e5c57f45) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6&id2=8e20ac838be89a3bc420a312d4460342e5c57f45)) | |
| download | [linux-b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6.tar.gz) | |

RDMA/hns: Fix cpu stuck caused by printings during reset[ Upstream commit 323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999 ]
During reset, cmd to destroy resources such as qp, cq, and mr may fail,
and error logs will be printed. When a large number of resources are
destroyed, there will be lots of printings, and it may lead to a cpu
stuck.
Delete some unnecessary printings and replace other printing functions
in these paths with the ratelimited version.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Fixes: c7bcb13442e1 ("RDMA/hns: Add SRQ support for hip08 kernel mode")
Fixes: 70f92521584f ("RDMA/hns: Use the reserved loopback QPs to free MR before destroying MPT")
Fixes: 926a01dc000d ("RDMA/hns: Add QP operations support for hip08 SoC")
Signed-off-by: wenglianfa <wenglianfa@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241024124000.2931869-6-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241024124000.2931869-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hem.c?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6) | 73 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_srq.c?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6) | 4 | |  |  |  | | --- | --- | --- | |

5 files changed, 41 insertions, 48 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex ff177466de9b49..9b91731a620795 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=8e20ac838be89a3bc420a312d4460342e5c57f45)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)@@ -180,8 +180,8 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) ret = hns\_roce\_destroy\_hw\_ctx(hr\_dev, HNS\_ROCE\_CMD\_DESTROY\_CQC, hr\_cq->cqn); if (ret)- dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret,- hr\_cq->cqn);+ dev\_err\_ratelimited(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n",+ ret, hr\_cq->cqn);  xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hem.c b/drivers/infiniband/hw/hns/hns\_roce\_hem.cindex 65c5583e834127..0ab514c49d5e6e 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hem.c?id=8e20ac838be89a3bc420a312d4460342e5c57f45)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hem.c?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)@@ -712,8 +712,8 @@ void hns\_roce\_table\_put(struct hns\_roce\_dev \*hr\_dev,  ret = hr\_dev->hw->clear\_hem(hr\_dev, table, obj, HEM\_HOP\_STEP\_DIRECT); if (ret)- dev\_warn(dev, "failed to clear HEM base address, ret = %d.\n",- ret);+ dev\_warn\_ratelimited(dev, "failed to clear HEM base address, ret = %d.\n",+ ret);  hns\_roce\_free\_hem(hr\_dev, table->hem[i]); table->hem[i] = NULL;diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c b/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.cindex 3c3be860e8180f..b29c12e4e45c42 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=8e20ac838be89a3bc420a312d4460342e5c57f45)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)@@ -372,19 +372,12 @@ static int set\_rwqe\_data\_seg(struct ib\_qp \*ibqp, const struct ib\_send\_wr \*wr, static int check\_send\_valid(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_qp \*hr\_qp) {- struct ib\_device \*ibdev = &hr\_dev->ib\_dev;- if (unlikely(hr\_qp->state == IB\_QPS\_RESET || hr\_qp->state == IB\_QPS\_INIT ||- hr\_qp->state == IB\_QPS\_RTR)) {- ibdev\_err(ibdev, "failed to post WQE, QP state %u!\n",- hr\_qp->state);+ hr\_qp->state == IB\_QPS\_RTR)) return -EINVAL;- } else if (unlikely(hr\_dev->state >= HNS\_ROCE\_DEVICE\_STATE\_RST\_DOWN)) {- ibdev\_err(ibdev, "failed to post WQE, dev state %d!\n",- hr\_dev->state);+ else if (unlikely(hr\_dev->state >= HNS\_ROCE\_DEVICE\_STATE\_RST\_DOWN)) return -EIO;- }  return 0; }@@ -2737,8 +2730,8 @@ static int free\_mr\_modify\_rsv\_qp(struct hns\_roce\_dev \*hr\_dev, ret = hr\_dev->hw->modify\_qp(&hr\_qp->ibqp, attr, mask, IB\_QPS\_INIT, IB\_QPS\_INIT, NULL); if (ret) {- ibdev\_err(ibdev, "failed to modify qp to init, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev, "failed to modify qp to init, ret = %d.\n",+ ret); return ret; } @@ -3384,8 +3377,8 @@ static int free\_mr\_post\_send\_lp\_wqe(struct hns\_roce\_qp \*hr\_qp)  ret = hns\_roce\_v2\_post\_send(&hr\_qp->ibqp, send\_wr, &bad\_wr); if (ret) {- ibdev\_err(ibdev, "failed to post wqe for free mr, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev, "failed to post wqe for free mr, ret = %d.\n",+ ret); return ret; } @@ -3424,9 +3417,9 @@ static void free\_mr\_send\_cmd\_to\_hw(struct hns\_roce\_dev \*hr\_dev)  ret = free\_mr\_post\_send\_lp\_wqe(hr\_qp); if (ret) {- ibdev\_err(ibdev,- "failed to send wqe (qp:0x%lx) for free mr, ret = %d.\n",- hr\_qp->qpn, ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to send wqe (qp:0x%lx) for free mr, ret = %d.\n",+ hr\_qp->qpn, ret); break; } @@ -3437,16 +3430,16 @@ static void free\_mr\_send\_cmd\_to\_hw(struct hns\_roce\_dev \*hr\_dev) while (cqe\_cnt) { npolled = hns\_roce\_v2\_poll\_cq(&free\_mr->rsv\_cq->ib\_cq, cqe\_cnt, wc); if (npolled < 0) {- ibdev\_err(ibdev,- "failed to poll cqe for free mr, remain %d cqe.\n",- cqe\_cnt);+ ibdev\_err\_ratelimited(ibdev,+ "failed to poll cqe for free mr, remain %d cqe.\n",+ cqe\_cnt); goto out; }  if (time\_after(jiffies, end)) {- ibdev\_err(ibdev,- "failed to poll cqe for free mr and timeout, remain %d cqe.\n",- cqe\_cnt);+ ibdev\_err\_ratelimited(ibdev,+ "failed to poll cqe for free mr and timeout, remain %d cqe.\n",+ cqe\_cnt); goto out; } cqe\_cnt -= npolled;@@ -4986,10 +4979,8 @@ static int hns\_roce\_v2\_set\_abs\_fields(struct ib\_qp \*ibqp, struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibqp->device); int ret = 0; - if (!check\_qp\_state(cur\_state, new\_state)) {- ibdev\_err(&hr\_dev->ib\_dev, "Illegal state for QP!\n");+ if (!check\_qp\_state(cur\_state, new\_state)) return -EINVAL;- }  if (cur\_state == IB\_QPS\_RESET && new\_state == IB\_QPS\_INIT) { memset(qpc\_mask, 0, hr\_dev->caps.qpc\_sz);@@ -5251,7 +5242,7 @@ static int hns\_roce\_v2\_modify\_qp(struct ib\_qp \*ibqp, /\* SW pass context to HW \*/ ret = hns\_roce\_v2\_qp\_modify(hr\_dev, context, qpc\_mask, hr\_qp); if (ret) {- ibdev\_err(ibdev, "failed to modify QP, ret = %d.\n", ret);+ ibdev\_err\_ratelimited(ibdev, "failed to modify QP, ret = %d.\n", ret); goto out; } @@ -5341,7 +5332,9 @@ static int hns\_roce\_v2\_query\_qp(struct ib\_qp \*ibqp, struct ib\_qp\_attr \*qp\_attr,  ret = hns\_roce\_v2\_query\_qpc(hr\_dev, hr\_qp->qpn, &context); if (ret) {- ibdev\_err(ibdev, "failed to query QPC, ret = %d.\n", ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to query QPC, ret = %d.\n",+ ret); ret = -EINVAL; goto out; }@@ -5349,7 +5342,7 @@ static int hns\_roce\_v2\_query\_qp(struct ib\_qp \*ibqp, struct ib\_qp\_attr \*qp\_attr, state = hr\_reg\_read(&context, QPC\_QP\_ST); tmp\_qp\_state = to\_ib\_qp\_st((enum hns\_roce\_v2\_qp\_state)state); if (tmp\_qp\_state == -1) {- ibdev\_err(ibdev, "Illegal ib\_qp\_state\n");+ ibdev\_err\_ratelimited(ibdev, "Illegal ib\_qp\_state\n"); ret = -EINVAL; goto out; }@@ -5442,9 +5435,9 @@ static int hns\_roce\_v2\_destroy\_qp\_common(struct hns\_roce\_dev \*hr\_dev, ret = hns\_roce\_v2\_modify\_qp(&hr\_qp->ibqp, NULL, 0, hr\_qp->state, IB\_QPS\_RESET, udata); if (ret)- ibdev\_err(ibdev,- "failed to modify QP to RST, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to modify QP to RST, ret = %d.\n",+ ret); }  send\_cq = hr\_qp->ibqp.send\_cq ? to\_hr\_cq(hr\_qp->ibqp.send\_cq) : NULL;@@ -5480,9 +5473,9 @@ int hns\_roce\_v2\_destroy\_qp(struct ib\_qp \*ibqp, struct ib\_udata \*udata)  ret = hns\_roce\_v2\_destroy\_qp\_common(hr\_dev, hr\_qp, udata); if (ret)- ibdev\_err(&hr\_dev->ib\_dev,- "failed to destroy QP, QPN = 0x%06lx, ret = %d.\n",- hr\_qp->qpn, ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to destroy QP, QPN = 0x%06lx, ret = %d.\n",+ hr\_qp->qpn, ret);  hns\_roce\_qp\_destroy(hr\_dev, hr\_qp, udata); @@ -5755,9 +5748,9 @@ static int hns\_roce\_v2\_modify\_cq(struct ib\_cq \*cq, u16 cq\_count, u16 cq\_period) HNS\_ROCE\_CMD\_MODIFY\_CQC, hr\_cq->cqn); hns\_roce\_free\_cmd\_mailbox(hr\_dev, mailbox); if (ret)- ibdev\_err(&hr\_dev->ib\_dev,- "failed to process cmd when modifying CQ, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to process cmd when modifying CQ, ret = %d.\n",+ ret);  return ret; }@@ -5777,9 +5770,9 @@ static int hns\_roce\_v2\_query\_cqc(struct hns\_roce\_dev \*hr\_dev, u32 cqn, ret = hns\_roce\_cmd\_mbox(hr\_dev, 0, mailbox->dma, HNS\_ROCE\_CMD\_QUERY\_CQC, cqn); if (ret) {- ibdev\_err(&hr\_dev->ib\_dev,- "failed to process cmd when querying CQ, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to process cmd when querying CQ, ret = %d.\n",+ ret); goto err\_mailbox; } diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex 980261969b0c0a..b053f2f43dacd4 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=8e20ac838be89a3bc420a312d4460342e5c57f45)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)@@ -130,8 +130,8 @@ static void hns\_roce\_mr\_free(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_mr \*mr key\_to\_hw\_index(mr->key) & (hr\_dev->caps.num\_mtpts - 1)); if (ret)- ibdev\_warn(ibdev, "failed to destroy mpt, ret = %d.\n",- ret);+ ibdev\_warn\_ratelimited(ibdev, "failed to destroy mpt, ret = %d.\n",+ ret); }  free\_mr\_pbl(hr\_dev, mr);diff --git a/drivers/infiniband/hw/hns/hns\_roce\_srq.c b/drivers/infiniband/hw/hns/hns\_roce\_srq.cindex 727f926500712c..652508b660a060 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_srq.c?id=8e20ac838be89a3bc420a312d4460342e5c57f45)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_srq.c?id=b4ba31e5aaffbda9b22d9a35c40b16dc39e475a6)@@ -150,8 +150,8 @@ static void free\_srqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_srq \*srq) ret = hns\_roce\_destroy\_hw\_ctx(hr\_dev, HNS\_ROCE\_CMD\_DESTROY\_SRQ, srq->srqn); if (ret)- dev\_err(hr\_dev->dev, "DESTROY\_SRQ failed (%d) for SRQN %06lx\n",- ret, srq->srqn);+ dev\_err\_ratelimited(hr\_dev->dev, "DESTROY\_SRQ failed (%d) for SRQN %06lx\n",+ ret, srq->srqn);  xa\_erase\_irq(&srq\_table->xa, srq->srqn); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:16:17 +0000



=== Content from git.kernel.org_a5719d8f_20250114_181738.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | wenglianfa <wenglianfa@huawei.com> | 2024-10-24 20:40:00 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:38 +0100 |
| commit | [31c6fe9b79ed42440094f2367897aea0c0ce96ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)) | |
| tree | [602b6205f72410e81cd8d7fb00925b67ed10e3d9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec) | |
| parent | [284a8650dfde5d4ae4e14698d6bcb633e27ab449](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=284a8650dfde5d4ae4e14698d6bcb633e27ab449) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec&id2=284a8650dfde5d4ae4e14698d6bcb633e27ab449)) | |
| download | [linux-31c6fe9b79ed42440094f2367897aea0c0ce96ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-31c6fe9b79ed42440094f2367897aea0c0ce96ec.tar.gz) | |

RDMA/hns: Fix cpu stuck caused by printings during reset[ Upstream commit 323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999 ]
During reset, cmd to destroy resources such as qp, cq, and mr may fail,
and error logs will be printed. When a large number of resources are
destroyed, there will be lots of printings, and it may lead to a cpu
stuck.
Delete some unnecessary printings and replace other printing functions
in these paths with the ratelimited version.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Fixes: c7bcb13442e1 ("RDMA/hns: Add SRQ support for hip08 kernel mode")
Fixes: 70f92521584f ("RDMA/hns: Use the reserved loopback QPs to free MR before destroying MPT")
Fixes: 926a01dc000d ("RDMA/hns: Add QP operations support for hip08 SoC")
Signed-off-by: wenglianfa <wenglianfa@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241024124000.2931869-6-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241024124000.2931869-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hem.c?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec) | 73 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_srq.c?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec) | 4 | |  |  |  | | --- | --- | --- | |

5 files changed, 41 insertions, 48 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex ff177466de9b49..9b91731a620795 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=284a8650dfde5d4ae4e14698d6bcb633e27ab449)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)@@ -180,8 +180,8 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) ret = hns\_roce\_destroy\_hw\_ctx(hr\_dev, HNS\_ROCE\_CMD\_DESTROY\_CQC, hr\_cq->cqn); if (ret)- dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret,- hr\_cq->cqn);+ dev\_err\_ratelimited(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n",+ ret, hr\_cq->cqn);  xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hem.c b/drivers/infiniband/hw/hns/hns\_roce\_hem.cindex d1b00bb389d9f1..f605eb8fd13a2a 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hem.c?id=284a8650dfde5d4ae4e14698d6bcb633e27ab449)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hem.c?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)@@ -712,8 +712,8 @@ void hns\_roce\_table\_put(struct hns\_roce\_dev \*hr\_dev,  ret = hr\_dev->hw->clear\_hem(hr\_dev, table, obj, HEM\_HOP\_STEP\_DIRECT); if (ret)- dev\_warn(dev, "failed to clear HEM base address, ret = %d.\n",- ret);+ dev\_warn\_ratelimited(dev, "failed to clear HEM base address, ret = %d.\n",+ ret);  hns\_roce\_free\_hem(hr\_dev, table->hem[i]); table->hem[i] = NULL;diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c b/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.cindex b190e0cd86b456..d0846d2c97ccfb 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=284a8650dfde5d4ae4e14698d6bcb633e27ab449)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)@@ -372,19 +372,12 @@ static int set\_rwqe\_data\_seg(struct ib\_qp \*ibqp, const struct ib\_send\_wr \*wr, static int check\_send\_valid(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_qp \*hr\_qp) {- struct ib\_device \*ibdev = &hr\_dev->ib\_dev;- if (unlikely(hr\_qp->state == IB\_QPS\_RESET || hr\_qp->state == IB\_QPS\_INIT ||- hr\_qp->state == IB\_QPS\_RTR)) {- ibdev\_err(ibdev, "failed to post WQE, QP state %u!\n",- hr\_qp->state);+ hr\_qp->state == IB\_QPS\_RTR)) return -EINVAL;- } else if (unlikely(hr\_dev->state >= HNS\_ROCE\_DEVICE\_STATE\_RST\_DOWN)) {- ibdev\_err(ibdev, "failed to post WQE, dev state %d!\n",- hr\_dev->state);+ else if (unlikely(hr\_dev->state >= HNS\_ROCE\_DEVICE\_STATE\_RST\_DOWN)) return -EIO;- }  return 0; }@@ -2845,8 +2838,8 @@ static int free\_mr\_modify\_rsv\_qp(struct hns\_roce\_dev \*hr\_dev, ret = hr\_dev->hw->modify\_qp(&hr\_qp->ibqp, attr, mask, IB\_QPS\_INIT, IB\_QPS\_INIT); if (ret) {- ibdev\_err(ibdev, "failed to modify qp to init, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev, "failed to modify qp to init, ret = %d.\n",+ ret); return ret; } @@ -3492,8 +3485,8 @@ static int free\_mr\_post\_send\_lp\_wqe(struct hns\_roce\_qp \*hr\_qp)  ret = hns\_roce\_v2\_post\_send(&hr\_qp->ibqp, send\_wr, &bad\_wr); if (ret) {- ibdev\_err(ibdev, "failed to post wqe for free mr, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev, "failed to post wqe for free mr, ret = %d.\n",+ ret); return ret; } @@ -3532,9 +3525,9 @@ static void free\_mr\_send\_cmd\_to\_hw(struct hns\_roce\_dev \*hr\_dev)  ret = free\_mr\_post\_send\_lp\_wqe(hr\_qp); if (ret) {- ibdev\_err(ibdev,- "failed to send wqe (qp:0x%lx) for free mr, ret = %d.\n",- hr\_qp->qpn, ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to send wqe (qp:0x%lx) for free mr, ret = %d.\n",+ hr\_qp->qpn, ret); break; } @@ -3545,16 +3538,16 @@ static void free\_mr\_send\_cmd\_to\_hw(struct hns\_roce\_dev \*hr\_dev) while (cqe\_cnt) { npolled = hns\_roce\_v2\_poll\_cq(&free\_mr->rsv\_cq->ib\_cq, cqe\_cnt, wc); if (npolled < 0) {- ibdev\_err(ibdev,- "failed to poll cqe for free mr, remain %d cqe.\n",- cqe\_cnt);+ ibdev\_err\_ratelimited(ibdev,+ "failed to poll cqe for free mr, remain %d cqe.\n",+ cqe\_cnt); goto out; }  if (time\_after(jiffies, end)) {- ibdev\_err(ibdev,- "failed to poll cqe for free mr and timeout, remain %d cqe.\n",- cqe\_cnt);+ ibdev\_err\_ratelimited(ibdev,+ "failed to poll cqe for free mr and timeout, remain %d cqe.\n",+ cqe\_cnt); goto out; } cqe\_cnt -= npolled;@@ -5125,10 +5118,8 @@ static int hns\_roce\_v2\_set\_abs\_fields(struct ib\_qp \*ibqp, struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibqp->device); int ret = 0; - if (!check\_qp\_state(cur\_state, new\_state)) {- ibdev\_err(&hr\_dev->ib\_dev, "Illegal state for QP!\n");+ if (!check\_qp\_state(cur\_state, new\_state)) return -EINVAL;- }  if (cur\_state == IB\_QPS\_RESET && new\_state == IB\_QPS\_INIT) { memset(qpc\_mask, 0, hr\_dev->caps.qpc\_sz);@@ -5390,7 +5381,7 @@ static int hns\_roce\_v2\_modify\_qp(struct ib\_qp \*ibqp, /\* SW pass context to HW \*/ ret = hns\_roce\_v2\_qp\_modify(hr\_dev, context, qpc\_mask, hr\_qp); if (ret) {- ibdev\_err(ibdev, "failed to modify QP, ret = %d.\n", ret);+ ibdev\_err\_ratelimited(ibdev, "failed to modify QP, ret = %d.\n", ret); goto out; } @@ -5480,7 +5471,9 @@ static int hns\_roce\_v2\_query\_qp(struct ib\_qp \*ibqp, struct ib\_qp\_attr \*qp\_attr,  ret = hns\_roce\_v2\_query\_qpc(hr\_dev, hr\_qp->qpn, &context); if (ret) {- ibdev\_err(ibdev, "failed to query QPC, ret = %d.\n", ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to query QPC, ret = %d.\n",+ ret); ret = -EINVAL; goto out; }@@ -5488,7 +5481,7 @@ static int hns\_roce\_v2\_query\_qp(struct ib\_qp \*ibqp, struct ib\_qp\_attr \*qp\_attr, state = hr\_reg\_read(&context, QPC\_QP\_ST); tmp\_qp\_state = to\_ib\_qp\_st((enum hns\_roce\_v2\_qp\_state)state); if (tmp\_qp\_state == -1) {- ibdev\_err(ibdev, "Illegal ib\_qp\_state\n");+ ibdev\_err\_ratelimited(ibdev, "Illegal ib\_qp\_state\n"); ret = -EINVAL; goto out; }@@ -5581,9 +5574,9 @@ static int hns\_roce\_v2\_destroy\_qp\_common(struct hns\_roce\_dev \*hr\_dev, ret = hns\_roce\_v2\_modify\_qp(&hr\_qp->ibqp, NULL, 0, hr\_qp->state, IB\_QPS\_RESET); if (ret)- ibdev\_err(ibdev,- "failed to modify QP to RST, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to modify QP to RST, ret = %d.\n",+ ret); }  send\_cq = hr\_qp->ibqp.send\_cq ? to\_hr\_cq(hr\_qp->ibqp.send\_cq) : NULL;@@ -5619,9 +5612,9 @@ int hns\_roce\_v2\_destroy\_qp(struct ib\_qp \*ibqp, struct ib\_udata \*udata)  ret = hns\_roce\_v2\_destroy\_qp\_common(hr\_dev, hr\_qp, udata); if (ret)- ibdev\_err(&hr\_dev->ib\_dev,- "failed to destroy QP, QPN = 0x%06lx, ret = %d.\n",- hr\_qp->qpn, ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to destroy QP, QPN = 0x%06lx, ret = %d.\n",+ hr\_qp->qpn, ret);  hns\_roce\_qp\_destroy(hr\_dev, hr\_qp, udata); @@ -5894,9 +5887,9 @@ static int hns\_roce\_v2\_modify\_cq(struct ib\_cq \*cq, u16 cq\_count, u16 cq\_period) HNS\_ROCE\_CMD\_MODIFY\_CQC, hr\_cq->cqn); hns\_roce\_free\_cmd\_mailbox(hr\_dev, mailbox); if (ret)- ibdev\_err(&hr\_dev->ib\_dev,- "failed to process cmd when modifying CQ, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to process cmd when modifying CQ, ret = %d.\n",+ ret);  return ret; }@@ -5916,9 +5909,9 @@ static int hns\_roce\_v2\_query\_cqc(struct hns\_roce\_dev \*hr\_dev, u32 cqn, ret = hns\_roce\_cmd\_mbox(hr\_dev, 0, mailbox->dma, HNS\_ROCE\_CMD\_QUERY\_CQC, cqn); if (ret) {- ibdev\_err(&hr\_dev->ib\_dev,- "failed to process cmd when querying CQ, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to process cmd when querying CQ, ret = %d.\n",+ ret); goto err\_mailbox; } diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex 980261969b0c0a..b053f2f43dacd4 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=284a8650dfde5d4ae4e14698d6bcb633e27ab449)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)@@ -130,8 +130,8 @@ static void hns\_roce\_mr\_free(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_mr \*mr key\_to\_hw\_index(mr->key) & (hr\_dev->caps.num\_mtpts - 1)); if (ret)- ibdev\_warn(ibdev, "failed to destroy mpt, ret = %d.\n",- ret);+ ibdev\_warn\_ratelimited(ibdev, "failed to destroy mpt, ret = %d.\n",+ ret); }  free\_mr\_pbl(hr\_dev, mr);diff --git a/drivers/infiniband/hw/hns/hns\_roce\_srq.c b/drivers/infiniband/hw/hns/hns\_roce\_srq.cindex 727f926500712c..652508b660a060 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_srq.c?id=284a8650dfde5d4ae4e14698d6bcb633e27ab449)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_srq.c?id=31c6fe9b79ed42440094f2367897aea0c0ce96ec)@@ -150,8 +150,8 @@ static void free\_srqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_srq \*srq) ret = hns\_roce\_destroy\_hw\_ctx(hr\_dev, HNS\_ROCE\_CMD\_DESTROY\_SRQ, srq->srqn); if (ret)- dev\_err(hr\_dev->dev, "DESTROY\_SRQ failed (%d) for SRQN %06lx\n",- ret, srq->srqn);+ dev\_err\_ratelimited(hr\_dev->dev, "DESTROY\_SRQ failed (%d) for SRQN %06lx\n",+ ret, srq->srqn);  xa\_erase\_irq(&srq\_table->xa, srq->srqn); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:16:15 +0000



=== Content from git.kernel.org_ff2977a1_20250114_181741.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | wenglianfa <wenglianfa@huawei.com> | 2024-10-24 20:40:00 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:07 +0100 |
| commit | [e2e64f9c42c717beb459ab209ec1c4baa73d3760](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)) | |
| tree | [210708cf37eb26d061dcaa490ed89e2b81fa420d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760) | |
| parent | [84676c47bef18d1e818f5ae0e6c96d03c9efcb82](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84676c47bef18d1e818f5ae0e6c96d03c9efcb82) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760&id2=84676c47bef18d1e818f5ae0e6c96d03c9efcb82)) | |
| download | [linux-e2e64f9c42c717beb459ab209ec1c4baa73d3760.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e2e64f9c42c717beb459ab209ec1c4baa73d3760.tar.gz) | |

RDMA/hns: Fix cpu stuck caused by printings during reset[ Upstream commit 323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999 ]
During reset, cmd to destroy resources such as qp, cq, and mr may fail,
and error logs will be printed. When a large number of resources are
destroyed, there will be lots of printings, and it may lead to a cpu
stuck.
Delete some unnecessary printings and replace other printing functions
in these paths with the ratelimited version.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Fixes: c7bcb13442e1 ("RDMA/hns: Add SRQ support for hip08 kernel mode")
Fixes: 70f92521584f ("RDMA/hns: Use the reserved loopback QPs to free MR before destroying MPT")
Fixes: 926a01dc000d ("RDMA/hns: Add QP operations support for hip08 SoC")
Signed-off-by: wenglianfa <wenglianfa@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241024124000.2931869-6-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241024124000.2931869-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hem.c?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760) | 73 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_srq.c?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760) | 4 | |  |  |  | | --- | --- | --- | |

5 files changed, 41 insertions, 48 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex 4ec66611a14340..4106423a1b399d 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=84676c47bef18d1e818f5ae0e6c96d03c9efcb82)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)@@ -179,8 +179,8 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) ret = hns\_roce\_destroy\_hw\_ctx(hr\_dev, HNS\_ROCE\_CMD\_DESTROY\_CQC, hr\_cq->cqn); if (ret)- dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret,- hr\_cq->cqn);+ dev\_err\_ratelimited(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n",+ ret, hr\_cq->cqn);  xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hem.c b/drivers/infiniband/hw/hns/hns\_roce\_hem.cindex ee5d2c1bb5ca07..f84521be3bea4a 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hem.c?id=84676c47bef18d1e818f5ae0e6c96d03c9efcb82)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hem.c?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)@@ -672,8 +672,8 @@ void hns\_roce\_table\_put(struct hns\_roce\_dev \*hr\_dev,  ret = hr\_dev->hw->clear\_hem(hr\_dev, table, obj, HEM\_HOP\_STEP\_DIRECT); if (ret)- dev\_warn(dev, "failed to clear HEM base address, ret = %d.\n",- ret);+ dev\_warn\_ratelimited(dev, "failed to clear HEM base address, ret = %d.\n",+ ret);  hns\_roce\_free\_hem(hr\_dev, table->hem[i]); table->hem[i] = NULL;diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c b/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.cindex 4c3bc1f6a183ca..d1c075fb0ad892 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=84676c47bef18d1e818f5ae0e6c96d03c9efcb82)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)@@ -373,19 +373,12 @@ static int set\_rwqe\_data\_seg(struct ib\_qp \*ibqp, const struct ib\_send\_wr \*wr, static int check\_send\_valid(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_qp \*hr\_qp) {- struct ib\_device \*ibdev = &hr\_dev->ib\_dev;- if (unlikely(hr\_qp->state == IB\_QPS\_RESET || hr\_qp->state == IB\_QPS\_INIT ||- hr\_qp->state == IB\_QPS\_RTR)) {- ibdev\_err(ibdev, "failed to post WQE, QP state %u!\n",- hr\_qp->state);+ hr\_qp->state == IB\_QPS\_RTR)) return -EINVAL;- } else if (unlikely(hr\_dev->state >= HNS\_ROCE\_DEVICE\_STATE\_RST\_DOWN)) {- ibdev\_err(ibdev, "failed to post WQE, dev state %d!\n",- hr\_dev->state);+ else if (unlikely(hr\_dev->state >= HNS\_ROCE\_DEVICE\_STATE\_RST\_DOWN)) return -EIO;- }  return 0; }@@ -2775,8 +2768,8 @@ static int free\_mr\_modify\_rsv\_qp(struct hns\_roce\_dev \*hr\_dev, ret = hr\_dev->hw->modify\_qp(&hr\_qp->ibqp, attr, mask, IB\_QPS\_INIT, IB\_QPS\_INIT, NULL); if (ret) {- ibdev\_err(ibdev, "failed to modify qp to init, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev, "failed to modify qp to init, ret = %d.\n",+ ret); return ret; } @@ -3421,8 +3414,8 @@ static int free\_mr\_post\_send\_lp\_wqe(struct hns\_roce\_qp \*hr\_qp)  ret = hns\_roce\_v2\_post\_send(&hr\_qp->ibqp, send\_wr, &bad\_wr); if (ret) {- ibdev\_err(ibdev, "failed to post wqe for free mr, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev, "failed to post wqe for free mr, ret = %d.\n",+ ret); return ret; } @@ -3461,9 +3454,9 @@ static void free\_mr\_send\_cmd\_to\_hw(struct hns\_roce\_dev \*hr\_dev)  ret = free\_mr\_post\_send\_lp\_wqe(hr\_qp); if (ret) {- ibdev\_err(ibdev,- "failed to send wqe (qp:0x%lx) for free mr, ret = %d.\n",- hr\_qp->qpn, ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to send wqe (qp:0x%lx) for free mr, ret = %d.\n",+ hr\_qp->qpn, ret); break; } @@ -3474,16 +3467,16 @@ static void free\_mr\_send\_cmd\_to\_hw(struct hns\_roce\_dev \*hr\_dev) while (cqe\_cnt) { npolled = hns\_roce\_v2\_poll\_cq(&free\_mr->rsv\_cq->ib\_cq, cqe\_cnt, wc); if (npolled < 0) {- ibdev\_err(ibdev,- "failed to poll cqe for free mr, remain %d cqe.\n",- cqe\_cnt);+ ibdev\_err\_ratelimited(ibdev,+ "failed to poll cqe for free mr, remain %d cqe.\n",+ cqe\_cnt); goto out; }  if (time\_after(jiffies, end)) {- ibdev\_err(ibdev,- "failed to poll cqe for free mr and timeout, remain %d cqe.\n",- cqe\_cnt);+ ibdev\_err\_ratelimited(ibdev,+ "failed to poll cqe for free mr and timeout, remain %d cqe.\n",+ cqe\_cnt); goto out; } cqe\_cnt -= npolled;@@ -5061,10 +5054,8 @@ static int hns\_roce\_v2\_set\_abs\_fields(struct ib\_qp \*ibqp, struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibqp->device); int ret = 0; - if (!check\_qp\_state(cur\_state, new\_state)) {- ibdev\_err(&hr\_dev->ib\_dev, "Illegal state for QP!\n");+ if (!check\_qp\_state(cur\_state, new\_state)) return -EINVAL;- }  if (cur\_state == IB\_QPS\_RESET && new\_state == IB\_QPS\_INIT) { memset(qpc\_mask, 0, hr\_dev->caps.qpc\_sz);@@ -5325,7 +5316,7 @@ static int hns\_roce\_v2\_modify\_qp(struct ib\_qp \*ibqp, /\* SW pass context to HW \*/ ret = hns\_roce\_v2\_qp\_modify(hr\_dev, context, qpc\_mask, hr\_qp); if (ret) {- ibdev\_err(ibdev, "failed to modify QP, ret = %d.\n", ret);+ ibdev\_err\_ratelimited(ibdev, "failed to modify QP, ret = %d.\n", ret); goto out; } @@ -5463,7 +5454,9 @@ static int hns\_roce\_v2\_query\_qp(struct ib\_qp \*ibqp, struct ib\_qp\_attr \*qp\_attr,  ret = hns\_roce\_v2\_query\_qpc(hr\_dev, hr\_qp->qpn, &context); if (ret) {- ibdev\_err(ibdev, "failed to query QPC, ret = %d.\n", ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to query QPC, ret = %d.\n",+ ret); ret = -EINVAL; goto out; }@@ -5471,7 +5464,7 @@ static int hns\_roce\_v2\_query\_qp(struct ib\_qp \*ibqp, struct ib\_qp\_attr \*qp\_attr, state = hr\_reg\_read(&context, QPC\_QP\_ST); tmp\_qp\_state = to\_ib\_qp\_st((enum hns\_roce\_v2\_qp\_state)state); if (tmp\_qp\_state == -1) {- ibdev\_err(ibdev, "Illegal ib\_qp\_state\n");+ ibdev\_err\_ratelimited(ibdev, "Illegal ib\_qp\_state\n"); ret = -EINVAL; goto out; }@@ -5564,9 +5557,9 @@ static int hns\_roce\_v2\_destroy\_qp\_common(struct hns\_roce\_dev \*hr\_dev, ret = hns\_roce\_v2\_modify\_qp(&hr\_qp->ibqp, NULL, 0, hr\_qp->state, IB\_QPS\_RESET, udata); if (ret)- ibdev\_err(ibdev,- "failed to modify QP to RST, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to modify QP to RST, ret = %d.\n",+ ret); }  send\_cq = hr\_qp->ibqp.send\_cq ? to\_hr\_cq(hr\_qp->ibqp.send\_cq) : NULL;@@ -5609,9 +5602,9 @@ int hns\_roce\_v2\_destroy\_qp(struct ib\_qp \*ibqp, struct ib\_udata \*udata)  ret = hns\_roce\_v2\_destroy\_qp\_common(hr\_dev, hr\_qp, udata); if (ret)- ibdev\_err(&hr\_dev->ib\_dev,- "failed to destroy QP, QPN = 0x%06lx, ret = %d.\n",- hr\_qp->qpn, ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to destroy QP, QPN = 0x%06lx, ret = %d.\n",+ hr\_qp->qpn, ret);  hns\_roce\_qp\_destroy(hr\_dev, hr\_qp, udata); @@ -5905,9 +5898,9 @@ static int hns\_roce\_v2\_modify\_cq(struct ib\_cq \*cq, u16 cq\_count, u16 cq\_period) HNS\_ROCE\_CMD\_MODIFY\_CQC, hr\_cq->cqn); hns\_roce\_free\_cmd\_mailbox(hr\_dev, mailbox); if (ret)- ibdev\_err(&hr\_dev->ib\_dev,- "failed to process cmd when modifying CQ, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to process cmd when modifying CQ, ret = %d.\n",+ ret);  err\_out: if (ret)@@ -5931,9 +5924,9 @@ static int hns\_roce\_v2\_query\_cqc(struct hns\_roce\_dev \*hr\_dev, u32 cqn, ret = hns\_roce\_cmd\_mbox(hr\_dev, 0, mailbox->dma, HNS\_ROCE\_CMD\_QUERY\_CQC, cqn); if (ret) {- ibdev\_err(&hr\_dev->ib\_dev,- "failed to process cmd when querying CQ, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to process cmd when querying CQ, ret = %d.\n",+ ret); goto err\_mailbox; } diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex 846da8c78b8b72..b3f4327d0e64af 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=84676c47bef18d1e818f5ae0e6c96d03c9efcb82)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)@@ -138,8 +138,8 @@ static void hns\_roce\_mr\_free(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_mr \*mr key\_to\_hw\_index(mr->key) & (hr\_dev->caps.num\_mtpts - 1)); if (ret)- ibdev\_warn(ibdev, "failed to destroy mpt, ret = %d.\n",- ret);+ ibdev\_warn\_ratelimited(ibdev, "failed to destroy mpt, ret = %d.\n",+ ret); }  free\_mr\_pbl(hr\_dev, mr);diff --git a/drivers/infiniband/hw/hns/hns\_roce\_srq.c b/drivers/infiniband/hw/hns/hns\_roce\_srq.cindex c9b8233f4b0577..70c06ef65603d8 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_srq.c?id=84676c47bef18d1e818f5ae0e6c96d03c9efcb82)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_srq.c?id=e2e64f9c42c717beb459ab209ec1c4baa73d3760)@@ -151,8 +151,8 @@ static void free\_srqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_srq \*srq) ret = hns\_roce\_destroy\_hw\_ctx(hr\_dev, HNS\_ROCE\_CMD\_DESTROY\_SRQ, srq->srqn); if (ret)- dev\_err(hr\_dev->dev, "DESTROY\_SRQ failed (%d) for SRQN %06lx\n",- ret, srq->srqn);+ dev\_err\_ratelimited(hr\_dev->dev, "DESTROY\_SRQ failed (%d) for SRQN %06lx\n",+ ret, srq->srqn);  xa\_erase\_irq(&srq\_table->xa, srq->srqn); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:16:18 +0000



=== Content from git.kernel.org_e36578be_20250114_181739.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a0e4c78770faa0d56d47391476fe1d827e72eded)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0e4c78770faa0d56d47391476fe1d827e72eded)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0e4c78770faa0d56d47391476fe1d827e72eded)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0e4c78770faa0d56d47391476fe1d827e72eded)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | wenglianfa <wenglianfa@huawei.com> | 2024-10-24 20:40:00 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:35 +0100 |
| commit | [a0e4c78770faa0d56d47391476fe1d827e72eded](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0e4c78770faa0d56d47391476fe1d827e72eded) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a0e4c78770faa0d56d47391476fe1d827e72eded)) | |
| tree | [c55d238d3aa1902460694d3d3369fff852b7a95a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0e4c78770faa0d56d47391476fe1d827e72eded) | |
| parent | [b29a038f4d22fa2d592afce2f3eb3383764b4a43](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b29a038f4d22fa2d592afce2f3eb3383764b4a43) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0e4c78770faa0d56d47391476fe1d827e72eded&id2=b29a038f4d22fa2d592afce2f3eb3383764b4a43)) | |
| download | [linux-a0e4c78770faa0d56d47391476fe1d827e72eded.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a0e4c78770faa0d56d47391476fe1d827e72eded.tar.gz) | |

RDMA/hns: Fix cpu stuck caused by printings during reset[ Upstream commit 323275ac2ff15b2b7b3eac391ae5d8c5a3c3a999 ]
During reset, cmd to destroy resources such as qp, cq, and mr may fail,
and error logs will be printed. When a large number of resources are
destroyed, there will be lots of printings, and it may lead to a cpu
stuck.
Delete some unnecessary printings and replace other printing functions
in these paths with the ratelimited version.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Fixes: c7bcb13442e1 ("RDMA/hns: Add SRQ support for hip08 kernel mode")
Fixes: 70f92521584f ("RDMA/hns: Use the reserved loopback QPs to free MR before destroying MPT")
Fixes: 926a01dc000d ("RDMA/hns: Add QP operations support for hip08 SoC")
Signed-off-by: wenglianfa <wenglianfa@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241024124000.2931869-6-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241024124000.2931869-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0e4c78770faa0d56d47391476fe1d827e72eded)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=a0e4c78770faa0d56d47391476fe1d827e72eded) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hem.c?id=a0e4c78770faa0d56d47391476fe1d827e72eded) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=a0e4c78770faa0d56d47391476fe1d827e72eded) | 73 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=a0e4c78770faa0d56d47391476fe1d827e72eded) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_srq.c?id=a0e4c78770faa0d56d47391476fe1d827e72eded) | 4 | |  |  |  | | --- | --- | --- | |

5 files changed, 41 insertions, 48 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex 4ec66611a14340..4106423a1b399d 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=b29a038f4d22fa2d592afce2f3eb3383764b4a43)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=a0e4c78770faa0d56d47391476fe1d827e72eded)@@ -179,8 +179,8 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) ret = hns\_roce\_destroy\_hw\_ctx(hr\_dev, HNS\_ROCE\_CMD\_DESTROY\_CQC, hr\_cq->cqn); if (ret)- dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret,- hr\_cq->cqn);+ dev\_err\_ratelimited(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n",+ ret, hr\_cq->cqn);  xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hem.c b/drivers/infiniband/hw/hns/hns\_roce\_hem.cindex ee5d2c1bb5ca07..f84521be3bea4a 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hem.c?id=b29a038f4d22fa2d592afce2f3eb3383764b4a43)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hem.c?id=a0e4c78770faa0d56d47391476fe1d827e72eded)@@ -672,8 +672,8 @@ void hns\_roce\_table\_put(struct hns\_roce\_dev \*hr\_dev,  ret = hr\_dev->hw->clear\_hem(hr\_dev, table, obj, HEM\_HOP\_STEP\_DIRECT); if (ret)- dev\_warn(dev, "failed to clear HEM base address, ret = %d.\n",- ret);+ dev\_warn\_ratelimited(dev, "failed to clear HEM base address, ret = %d.\n",+ ret);  hns\_roce\_free\_hem(hr\_dev, table->hem[i]); table->hem[i] = NULL;diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c b/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.cindex 4c3bc1f6a183ca..d1c075fb0ad892 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=b29a038f4d22fa2d592afce2f3eb3383764b4a43)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=a0e4c78770faa0d56d47391476fe1d827e72eded)@@ -373,19 +373,12 @@ static int set\_rwqe\_data\_seg(struct ib\_qp \*ibqp, const struct ib\_send\_wr \*wr, static int check\_send\_valid(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_qp \*hr\_qp) {- struct ib\_device \*ibdev = &hr\_dev->ib\_dev;- if (unlikely(hr\_qp->state == IB\_QPS\_RESET || hr\_qp->state == IB\_QPS\_INIT ||- hr\_qp->state == IB\_QPS\_RTR)) {- ibdev\_err(ibdev, "failed to post WQE, QP state %u!\n",- hr\_qp->state);+ hr\_qp->state == IB\_QPS\_RTR)) return -EINVAL;- } else if (unlikely(hr\_dev->state >= HNS\_ROCE\_DEVICE\_STATE\_RST\_DOWN)) {- ibdev\_err(ibdev, "failed to post WQE, dev state %d!\n",- hr\_dev->state);+ else if (unlikely(hr\_dev->state >= HNS\_ROCE\_DEVICE\_STATE\_RST\_DOWN)) return -EIO;- }  return 0; }@@ -2775,8 +2768,8 @@ static int free\_mr\_modify\_rsv\_qp(struct hns\_roce\_dev \*hr\_dev, ret = hr\_dev->hw->modify\_qp(&hr\_qp->ibqp, attr, mask, IB\_QPS\_INIT, IB\_QPS\_INIT, NULL); if (ret) {- ibdev\_err(ibdev, "failed to modify qp to init, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev, "failed to modify qp to init, ret = %d.\n",+ ret); return ret; } @@ -3421,8 +3414,8 @@ static int free\_mr\_post\_send\_lp\_wqe(struct hns\_roce\_qp \*hr\_qp)  ret = hns\_roce\_v2\_post\_send(&hr\_qp->ibqp, send\_wr, &bad\_wr); if (ret) {- ibdev\_err(ibdev, "failed to post wqe for free mr, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev, "failed to post wqe for free mr, ret = %d.\n",+ ret); return ret; } @@ -3461,9 +3454,9 @@ static void free\_mr\_send\_cmd\_to\_hw(struct hns\_roce\_dev \*hr\_dev)  ret = free\_mr\_post\_send\_lp\_wqe(hr\_qp); if (ret) {- ibdev\_err(ibdev,- "failed to send wqe (qp:0x%lx) for free mr, ret = %d.\n",- hr\_qp->qpn, ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to send wqe (qp:0x%lx) for free mr, ret = %d.\n",+ hr\_qp->qpn, ret); break; } @@ -3474,16 +3467,16 @@ static void free\_mr\_send\_cmd\_to\_hw(struct hns\_roce\_dev \*hr\_dev) while (cqe\_cnt) { npolled = hns\_roce\_v2\_poll\_cq(&free\_mr->rsv\_cq->ib\_cq, cqe\_cnt, wc); if (npolled < 0) {- ibdev\_err(ibdev,- "failed to poll cqe for free mr, remain %d cqe.\n",- cqe\_cnt);+ ibdev\_err\_ratelimited(ibdev,+ "failed to poll cqe for free mr, remain %d cqe.\n",+ cqe\_cnt); goto out; }  if (time\_after(jiffies, end)) {- ibdev\_err(ibdev,- "failed to poll cqe for free mr and timeout, remain %d cqe.\n",- cqe\_cnt);+ ibdev\_err\_ratelimited(ibdev,+ "failed to poll cqe for free mr and timeout, remain %d cqe.\n",+ cqe\_cnt); goto out; } cqe\_cnt -= npolled;@@ -5061,10 +5054,8 @@ static int hns\_roce\_v2\_set\_abs\_fields(struct ib\_qp \*ibqp, struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibqp->device); int ret = 0; - if (!check\_qp\_state(cur\_state, new\_state)) {- ibdev\_err(&hr\_dev->ib\_dev, "Illegal state for QP!\n");+ if (!check\_qp\_state(cur\_state, new\_state)) return -EINVAL;- }  if (cur\_state == IB\_QPS\_RESET && new\_state == IB\_QPS\_INIT) { memset(qpc\_mask, 0, hr\_dev->caps.qpc\_sz);@@ -5325,7 +5316,7 @@ static int hns\_roce\_v2\_modify\_qp(struct ib\_qp \*ibqp, /\* SW pass context to HW \*/ ret = hns\_roce\_v2\_qp\_modify(hr\_dev, context, qpc\_mask, hr\_qp); if (ret) {- ibdev\_err(ibdev, "failed to modify QP, ret = %d.\n", ret);+ ibdev\_err\_ratelimited(ibdev, "failed to modify QP, ret = %d.\n", ret); goto out; } @@ -5463,7 +5454,9 @@ static int hns\_roce\_v2\_query\_qp(struct ib\_qp \*ibqp, struct ib\_qp\_attr \*qp\_attr,  ret = hns\_roce\_v2\_query\_qpc(hr\_dev, hr\_qp->qpn, &context); if (ret) {- ibdev\_err(ibdev, "failed to query QPC, ret = %d.\n", ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to query QPC, ret = %d.\n",+ ret); ret = -EINVAL; goto out; }@@ -5471,7 +5464,7 @@ static int hns\_roce\_v2\_query\_qp(struct ib\_qp \*ibqp, struct ib\_qp\_attr \*qp\_attr, state = hr\_reg\_read(&context, QPC\_QP\_ST); tmp\_qp\_state = to\_ib\_qp\_st((enum hns\_roce\_v2\_qp\_state)state); if (tmp\_qp\_state == -1) {- ibdev\_err(ibdev, "Illegal ib\_qp\_state\n");+ ibdev\_err\_ratelimited(ibdev, "Illegal ib\_qp\_state\n"); ret = -EINVAL; goto out; }@@ -5564,9 +5557,9 @@ static int hns\_roce\_v2\_destroy\_qp\_common(struct hns\_roce\_dev \*hr\_dev, ret = hns\_roce\_v2\_modify\_qp(&hr\_qp->ibqp, NULL, 0, hr\_qp->state, IB\_QPS\_RESET, udata); if (ret)- ibdev\_err(ibdev,- "failed to modify QP to RST, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(ibdev,+ "failed to modify QP to RST, ret = %d.\n",+ ret); }  send\_cq = hr\_qp->ibqp.send\_cq ? to\_hr\_cq(hr\_qp->ibqp.send\_cq) : NULL;@@ -5609,9 +5602,9 @@ int hns\_roce\_v2\_destroy\_qp(struct ib\_qp \*ibqp, struct ib\_udata \*udata)  ret = hns\_roce\_v2\_destroy\_qp\_common(hr\_dev, hr\_qp, udata); if (ret)- ibdev\_err(&hr\_dev->ib\_dev,- "failed to destroy QP, QPN = 0x%06lx, ret = %d.\n",- hr\_qp->qpn, ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to destroy QP, QPN = 0x%06lx, ret = %d.\n",+ hr\_qp->qpn, ret);  hns\_roce\_qp\_destroy(hr\_dev, hr\_qp, udata); @@ -5905,9 +5898,9 @@ static int hns\_roce\_v2\_modify\_cq(struct ib\_cq \*cq, u16 cq\_count, u16 cq\_period) HNS\_ROCE\_CMD\_MODIFY\_CQC, hr\_cq->cqn); hns\_roce\_free\_cmd\_mailbox(hr\_dev, mailbox); if (ret)- ibdev\_err(&hr\_dev->ib\_dev,- "failed to process cmd when modifying CQ, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to process cmd when modifying CQ, ret = %d.\n",+ ret);  err\_out: if (ret)@@ -5931,9 +5924,9 @@ static int hns\_roce\_v2\_query\_cqc(struct hns\_roce\_dev \*hr\_dev, u32 cqn, ret = hns\_roce\_cmd\_mbox(hr\_dev, 0, mailbox->dma, HNS\_ROCE\_CMD\_QUERY\_CQC, cqn); if (ret) {- ibdev\_err(&hr\_dev->ib\_dev,- "failed to process cmd when querying CQ, ret = %d.\n",- ret);+ ibdev\_err\_ratelimited(&hr\_dev->ib\_dev,+ "failed to process cmd when querying CQ, ret = %d.\n",+ ret); goto err\_mailbox; } diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex 846da8c78b8b72..b3f4327d0e64af 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=b29a038f4d22fa2d592afce2f3eb3383764b4a43)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=a0e4c78770faa0d56d47391476fe1d827e72eded)@@ -138,8 +138,8 @@ static void hns\_roce\_mr\_free(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_mr \*mr key\_to\_hw\_index(mr->key) & (hr\_dev->caps.num\_mtpts - 1)); if (ret)- ibdev\_warn(ibdev, "failed to destroy mpt, ret = %d.\n",- ret);+ ibdev\_warn\_ratelimited(ibdev, "failed to destroy mpt, ret = %d.\n",+ ret); }  free\_mr\_pbl(hr\_dev, mr);diff --git a/drivers/infiniband/hw/hns/hns\_roce\_srq.c b/drivers/infiniband/hw/hns/hns\_roce\_srq.cindex c9b8233f4b0577..70c06ef65603d8 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_srq.c?id=b29a038f4d22fa2d592afce2f3eb3383764b4a43)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_srq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_srq.c?id=a0e4c78770faa0d56d47391476fe1d827e72eded)@@ -151,8 +151,8 @@ static void free\_srqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_srq \*srq) ret = hns\_roce\_destroy\_hw\_ctx(hr\_dev, HNS\_ROCE\_CMD\_DESTROY\_SRQ, srq->srqn); if (ret)- dev\_err(hr\_dev->dev, "DESTROY\_SRQ failed (%d) for SRQN %06lx\n",- ret, srq->srqn);+ dev\_err\_ratelimited(hr\_dev->dev, "DESTROY\_SRQ failed (%d) for SRQN %06lx\n",+ ret, srq->srqn);  xa\_erase\_irq(&srq\_table->xa, srq->srqn); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:16:16 +0000


