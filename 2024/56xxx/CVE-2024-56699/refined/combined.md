=== Content from git.kernel.org_fb158121_20250115_085347.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c4a585e952ca403a370586d3f16e8331a7564901)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c4a585e952ca403a370586d3f16e8331a7564901)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c4a585e952ca403a370586d3f16e8331a7564901)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c4a585e952ca403a370586d3f16e8331a7564901)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Schnelle <schnelle@linux.ibm.com> | 2024-11-25 16:02:38 +0100 |
| --- | --- | --- |
| committer | Heiko Carstens <hca@linux.ibm.com> | 2024-11-28 14:12:04 +0100 |
| commit | [c4a585e952ca403a370586d3f16e8331a7564901](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c4a585e952ca403a370586d3f16e8331a7564901) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c4a585e952ca403a370586d3f16e8331a7564901)) | |
| tree | [67cf1952f2cd9bf91388fe35ff63d3c9367634ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c4a585e952ca403a370586d3f16e8331a7564901) | |
| parent | [48796104c864cf4dafa80bd8c2ce88f9c92a65ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48796104c864cf4dafa80bd8c2ce88f9c92a65ea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c4a585e952ca403a370586d3f16e8331a7564901&id2=48796104c864cf4dafa80bd8c2ce88f9c92a65ea)) | |
| download | [linux-c4a585e952ca403a370586d3f16e8331a7564901.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c4a585e952ca403a370586d3f16e8331a7564901.tar.gz) | |

s390/pci: Fix potential double remove of hotplug slotIn commit 6ee600bfbe0f ("s390/pci: remove hotplug slot when releasing the
device") the zpci\_exit\_slot() was moved from zpci\_device\_reserved() to
zpci\_release\_device() with the intention of keeping the hotplug slot
around until the device is actually removed.
Now zpci\_release\_device() is only called once all references are
dropped. Since the zPCI subsystem only drops its reference once the
device is in the reserved state it follows that zpci\_release\_device()
must only deal with devices in the reserved state. Despite that it
contains code to tear down from both configured and standby state. For
the standby case this already includes the removal of the hotplug slot
so would cause a double removal if a device was ever removed in
either configured or standby state.
Instead of causing a potential double removal in a case that should
never happen explicitly WARN\_ON() if a device in non-reserved state is
released and get rid of the dead code cases.
Fixes: 6ee600bfbe0f ("s390/pci: remove hotplug slot when releasing the device")
Reviewed-by: Matthew Rosato <mjrosato@linux.ibm.com>
Reviewed-by: Gerd Bayer <gbayer@linux.ibm.com>
Tested-by: Gerd Bayer <gbayer@linux.ibm.com>
Signed-off-by: Niklas Schnelle <schnelle@linux.ibm.com>
Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c4a585e952ca403a370586d3f16e8331a7564901)

| -rw-r--r-- | [arch/s390/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/pci/pci.c?id=c4a585e952ca403a370586d3f16e8331a7564901) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 25 deletions

| diff --git a/arch/s390/pci/pci.c b/arch/s390/pci/pci.cindex 6a011d040dfef1..7aeab522f28deb 100644--- a/[arch/s390/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/pci/pci.c?id=48796104c864cf4dafa80bd8c2ce88f9c92a65ea)+++ b/[arch/s390/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/pci/pci.c?id=c4a585e952ca403a370586d3f16e8331a7564901)@@ -937,10 +937,8 @@ void zpci\_device\_reserved(struct zpci\_dev \*zdev) void zpci\_release\_device(struct kref \*kref) { struct zpci\_dev \*zdev = container\_of(kref, struct zpci\_dev, kref);- int ret; - if (zdev->has\_hp\_slot)- zpci\_exit\_slot(zdev);+ WARN\_ON(zdev->state != ZPCI\_FN\_STATE\_RESERVED);  if (zdev->zbus->bus) zpci\_bus\_remove\_device(zdev, false);@@ -948,28 +946,14 @@ void zpci\_release\_device(struct kref \*kref) if (zdev\_enabled(zdev)) zpci\_disable\_device(zdev); - switch (zdev->state) {- case ZPCI\_FN\_STATE\_CONFIGURED:- ret = sclp\_pci\_deconfigure(zdev->fid);- zpci\_dbg(3, "deconf fid:%x, rc:%d\n", zdev->fid, ret);- fallthrough;- case ZPCI\_FN\_STATE\_STANDBY:- if (zdev->has\_hp\_slot)- zpci\_exit\_slot(zdev);- spin\_lock(&zpci\_list\_lock);- list\_del(&zdev->entry);- spin\_unlock(&zpci\_list\_lock);- zpci\_dbg(3, "rsv fid:%x\n", zdev->fid);- fallthrough;- case ZPCI\_FN\_STATE\_RESERVED:- if (zdev->has\_resources)- zpci\_cleanup\_bus\_resources(zdev);- zpci\_bus\_device\_unregister(zdev);- zpci\_destroy\_iommu(zdev);- fallthrough;- default:- break;- }+ if (zdev->has\_hp\_slot)+ zpci\_exit\_slot(zdev);++ if (zdev->has\_resources)+ zpci\_cleanup\_bus\_resources(zdev);++ zpci\_bus\_device\_unregister(zdev);+ zpci\_destroy\_iommu(zdev); zpci\_dbg(3, "rem fid:%x\n", zdev->fid); kfree\_rcu(zdev, rcu); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:52:25 +0000



=== Content from git.kernel.org_93a0963c_20250115_085347.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c1489651071ab1be46d2af1da8adb15c9fc3c069)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c1489651071ab1be46d2af1da8adb15c9fc3c069)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1489651071ab1be46d2af1da8adb15c9fc3c069)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1489651071ab1be46d2af1da8adb15c9fc3c069)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Schnelle <schnelle@linux.ibm.com> | 2024-11-25 16:02:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:06 +0100 |
| commit | [c1489651071ab1be46d2af1da8adb15c9fc3c069](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1489651071ab1be46d2af1da8adb15c9fc3c069) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c1489651071ab1be46d2af1da8adb15c9fc3c069)) | |
| tree | [3e9e227d4d7862513082263b3a5ad0ec8df865a1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c1489651071ab1be46d2af1da8adb15c9fc3c069) | |
| parent | [376f4800f34a28def026ff5c5d4fc5e54e1744ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1489651071ab1be46d2af1da8adb15c9fc3c069&id2=376f4800f34a28def026ff5c5d4fc5e54e1744ff)) | |
| download | [linux-c1489651071ab1be46d2af1da8adb15c9fc3c069.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c1489651071ab1be46d2af1da8adb15c9fc3c069.tar.gz) | |

s390/pci: Fix potential double remove of hotplug slot[ Upstream commit c4a585e952ca403a370586d3f16e8331a7564901 ]
In commit 6ee600bfbe0f ("s390/pci: remove hotplug slot when releasing the
device") the zpci\_exit\_slot() was moved from zpci\_device\_reserved() to
zpci\_release\_device() with the intention of keeping the hotplug slot
around until the device is actually removed.
Now zpci\_release\_device() is only called once all references are
dropped. Since the zPCI subsystem only drops its reference once the
device is in the reserved state it follows that zpci\_release\_device()
must only deal with devices in the reserved state. Despite that it
contains code to tear down from both configured and standby state. For
the standby case this already includes the removal of the hotplug slot
so would cause a double removal if a device was ever removed in
either configured or standby state.
Instead of causing a potential double removal in a case that should
never happen explicitly WARN\_ON() if a device in non-reserved state is
released and get rid of the dead code cases.
Fixes: 6ee600bfbe0f ("s390/pci: remove hotplug slot when releasing the device")
Reviewed-by: Matthew Rosato <mjrosato@linux.ibm.com>
Reviewed-by: Gerd Bayer <gbayer@linux.ibm.com>
Tested-by: Gerd Bayer <gbayer@linux.ibm.com>
Signed-off-by: Niklas Schnelle <schnelle@linux.ibm.com>
Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1489651071ab1be46d2af1da8adb15c9fc3c069)

| -rw-r--r-- | [arch/s390/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/pci/pci.c?id=c1489651071ab1be46d2af1da8adb15c9fc3c069) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 25 deletions

| diff --git a/arch/s390/pci/pci.c b/arch/s390/pci/pci.cindex 759983d0e63ed0..827b4c7b4688cd 100644--- a/[arch/s390/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/pci/pci.c?id=376f4800f34a28def026ff5c5d4fc5e54e1744ff)+++ b/[arch/s390/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/pci/pci.c?id=c1489651071ab1be46d2af1da8adb15c9fc3c069)@@ -918,10 +918,8 @@ void zpci\_device\_reserved(struct zpci\_dev \*zdev) void zpci\_release\_device(struct kref \*kref) { struct zpci\_dev \*zdev = container\_of(kref, struct zpci\_dev, kref);- int ret; - if (zdev->has\_hp\_slot)- zpci\_exit\_slot(zdev);+ WARN\_ON(zdev->state != ZPCI\_FN\_STATE\_RESERVED);  if (zdev->zbus->bus) zpci\_bus\_remove\_device(zdev, false);@@ -929,28 +927,14 @@ void zpci\_release\_device(struct kref \*kref) if (zdev\_enabled(zdev)) zpci\_disable\_device(zdev); - switch (zdev->state) {- case ZPCI\_FN\_STATE\_CONFIGURED:- ret = sclp\_pci\_deconfigure(zdev->fid);- zpci\_dbg(3, "deconf fid:%x, rc:%d\n", zdev->fid, ret);- fallthrough;- case ZPCI\_FN\_STATE\_STANDBY:- if (zdev->has\_hp\_slot)- zpci\_exit\_slot(zdev);- spin\_lock(&zpci\_list\_lock);- list\_del(&zdev->entry);- spin\_unlock(&zpci\_list\_lock);- zpci\_dbg(3, "rsv fid:%x\n", zdev->fid);- fallthrough;- case ZPCI\_FN\_STATE\_RESERVED:- if (zdev->has\_resources)- zpci\_cleanup\_bus\_resources(zdev);- zpci\_bus\_device\_unregister(zdev);- zpci\_destroy\_iommu(zdev);- fallthrough;- default:- break;- }+ if (zdev->has\_hp\_slot)+ zpci\_exit\_slot(zdev);++ if (zdev->has\_resources)+ zpci\_cleanup\_bus\_resources(zdev);++ zpci\_bus\_device\_unregister(zdev);+ zpci\_destroy\_iommu(zdev); zpci\_dbg(3, "rem fid:%x\n", zdev->fid); kfree\_rcu(zdev, rcu); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:52:24 +0000



=== Content from git.kernel.org_8a568903_20250115_085346.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=371bd905599d18da62d75e3974acbf6a41e315c7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=371bd905599d18da62d75e3974acbf6a41e315c7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=371bd905599d18da62d75e3974acbf6a41e315c7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=371bd905599d18da62d75e3974acbf6a41e315c7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Niklas Schnelle <schnelle@linux.ibm.com> | 2024-11-25 16:02:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:40 +0100 |
| commit | [371bd905599d18da62d75e3974acbf6a41e315c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=371bd905599d18da62d75e3974acbf6a41e315c7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=371bd905599d18da62d75e3974acbf6a41e315c7)) | |
| tree | [2b029db22a6003ec3418b074251a927e0b5c568f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=371bd905599d18da62d75e3974acbf6a41e315c7) | |
| parent | [550279449ff54c5aa28cfca5c567308cbfb145f0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=550279449ff54c5aa28cfca5c567308cbfb145f0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=371bd905599d18da62d75e3974acbf6a41e315c7&id2=550279449ff54c5aa28cfca5c567308cbfb145f0)) | |
| download | [linux-371bd905599d18da62d75e3974acbf6a41e315c7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-371bd905599d18da62d75e3974acbf6a41e315c7.tar.gz) | |

s390/pci: Fix potential double remove of hotplug slot[ Upstream commit c4a585e952ca403a370586d3f16e8331a7564901 ]
In commit 6ee600bfbe0f ("s390/pci: remove hotplug slot when releasing the
device") the zpci\_exit\_slot() was moved from zpci\_device\_reserved() to
zpci\_release\_device() with the intention of keeping the hotplug slot
around until the device is actually removed.
Now zpci\_release\_device() is only called once all references are
dropped. Since the zPCI subsystem only drops its reference once the
device is in the reserved state it follows that zpci\_release\_device()
must only deal with devices in the reserved state. Despite that it
contains code to tear down from both configured and standby state. For
the standby case this already includes the removal of the hotplug slot
so would cause a double removal if a device was ever removed in
either configured or standby state.
Instead of causing a potential double removal in a case that should
never happen explicitly WARN\_ON() if a device in non-reserved state is
released and get rid of the dead code cases.
Fixes: 6ee600bfbe0f ("s390/pci: remove hotplug slot when releasing the device")
Reviewed-by: Matthew Rosato <mjrosato@linux.ibm.com>
Reviewed-by: Gerd Bayer <gbayer@linux.ibm.com>
Tested-by: Gerd Bayer <gbayer@linux.ibm.com>
Signed-off-by: Niklas Schnelle <schnelle@linux.ibm.com>
Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=371bd905599d18da62d75e3974acbf6a41e315c7)

| -rw-r--r-- | [arch/s390/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/pci/pci.c?id=371bd905599d18da62d75e3974acbf6a41e315c7) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 25 deletions

| diff --git a/arch/s390/pci/pci.c b/arch/s390/pci/pci.cindex be3299609f9b65..635fd8f2acbaa2 100644--- a/[arch/s390/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/pci/pci.c?id=550279449ff54c5aa28cfca5c567308cbfb145f0)+++ b/[arch/s390/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/pci/pci.c?id=371bd905599d18da62d75e3974acbf6a41e315c7)@@ -917,10 +917,8 @@ void zpci\_device\_reserved(struct zpci\_dev \*zdev) void zpci\_release\_device(struct kref \*kref) { struct zpci\_dev \*zdev = container\_of(kref, struct zpci\_dev, kref);- int ret; - if (zdev->has\_hp\_slot)- zpci\_exit\_slot(zdev);+ WARN\_ON(zdev->state != ZPCI\_FN\_STATE\_RESERVED);  if (zdev->zbus->bus) zpci\_bus\_remove\_device(zdev, false);@@ -928,28 +926,14 @@ void zpci\_release\_device(struct kref \*kref) if (zdev\_enabled(zdev)) zpci\_disable\_device(zdev); - switch (zdev->state) {- case ZPCI\_FN\_STATE\_CONFIGURED:- ret = sclp\_pci\_deconfigure(zdev->fid);- zpci\_dbg(3, "deconf fid:%x, rc:%d\n", zdev->fid, ret);- fallthrough;- case ZPCI\_FN\_STATE\_STANDBY:- if (zdev->has\_hp\_slot)- zpci\_exit\_slot(zdev);- spin\_lock(&zpci\_list\_lock);- list\_del(&zdev->entry);- spin\_unlock(&zpci\_list\_lock);- zpci\_dbg(3, "rsv fid:%x\n", zdev->fid);- fallthrough;- case ZPCI\_FN\_STATE\_RESERVED:- if (zdev->has\_resources)- zpci\_cleanup\_bus\_resources(zdev);- zpci\_bus\_device\_unregister(zdev);- zpci\_destroy\_iommu(zdev);- fallthrough;- default:- break;- }+ if (zdev->has\_hp\_slot)+ zpci\_exit\_slot(zdev);++ if (zdev->has\_resources)+ zpci\_cleanup\_bus\_resources(zdev);++ zpci\_bus\_device\_unregister(zdev);+ zpci\_destroy\_iommu(zdev); zpci\_dbg(3, "rem fid:%x\n", zdev->fid); kfree\_rcu(zdev, rcu); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:52:23 +0000


