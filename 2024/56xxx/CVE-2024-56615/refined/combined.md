=== Content from git.kernel.org_b86084e7_20250114_210556.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2024-11-22 13:10:30 +0100 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2024-11-25 14:25:48 -0800 |
| commit | [ab244dd7cf4c291f82faacdc50b45cc0f55b674d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d)) | |
| tree | [b14b9bfe5f9715563ba3acab2befb0449032069c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d) | |
| parent | [32cd3db7de97c0c7a018756ce66244342fd583f0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32cd3db7de97c0c7a018756ce66244342fd583f0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d&id2=32cd3db7de97c0c7a018756ce66244342fd583f0)) | |
| download | [linux-ab244dd7cf4c291f82faacdc50b45cc0f55b674d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ab244dd7cf4c291f82faacdc50b45cc0f55b674d.tar.gz) | |

bpf: fix OOB devmap writes when deleting elementsJordy reported issue against XSKMAP which also applies to DEVMAP - the
index used for accessing map entry, due to being a signed integer,
causes the OOB writes. Fix is simple as changing the type from int to
u32, however, when compared to XSKMAP case, one more thing needs to be
addressed.
When map is released from system via dev\_map\_free(), we iterate through
all of the entries and an iterator variable is also an int, which
implies OOB accesses. Again, change it to be u32.
Example splat below:
[ 160.724676] BUG: unable to handle page fault for address: ffffc8fc2c001000
[ 160.731662] #PF: supervisor read access in kernel mode
[ 160.736876] #PF: error\_code(0x0000) - not-present page
[ 160.742095] PGD 0 P4D 0
[ 160.744678] Oops: Oops: 0000 [#1] PREEMPT SMP
[ 160.749106] CPU: 1 UID: 0 PID: 520 Comm: kworker/u145:12 Not tainted 6.12.0-rc1+ #487
[ 160.757050] Hardware name: Intel Corporation S2600WFT/S2600WFT, BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[ 160.767642] Workqueue: events\_unbound bpf\_map\_free\_deferred
[ 160.773308] RIP: 0010:dev\_map\_free+0x77/0x170
[ 160.777735] Code: 00 e8 fd 91 ed ff e8 b8 73 ed ff 41 83 7d 18 19 74 6e 41 8b 45 24 49 8b bd f8 00 00 00 31 db 85 c0 74 48 48 63 c3 48 8d 04 c7 <48> 8b 28 48 85 ed 74 30 48 8b 7d 18 48 85 ff 74 05 e8 b3 52 fa ff
[ 160.796777] RSP: 0018:ffffc9000ee1fe38 EFLAGS: 00010202
[ 160.802086] RAX: ffffc8fc2c001000 RBX: 0000000080000000 RCX: 0000000000000024
[ 160.809331] RDX: 0000000000000000 RSI: 0000000000000024 RDI: ffffc9002c001000
[ 160.816576] RBP: 0000000000000000 R08: 0000000000000023 R09: 0000000000000001
[ 160.823823] R10: 0000000000000001 R11: 00000000000ee6b2 R12: dead000000000122
[ 160.831066] R13: ffff88810c928e00 R14: ffff8881002df405 R15: 0000000000000000
[ 160.838310] FS: 0000000000000000(0000) GS:ffff8897e0c40000(0000) knlGS:0000000000000000
[ 160.846528] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 160.852357] CR2: ffffc8fc2c001000 CR3: 0000000005c32006 CR4: 00000000007726f0
[ 160.859604] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 160.866847] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 160.874092] PKRU: 55555554
[ 160.876847] Call Trace:
[ 160.879338] <TASK>
[ 160.881477] ? \_\_die+0x20/0x60
[ 160.884586] ? page\_fault\_oops+0x15a/0x450
[ 160.888746] ? search\_extable+0x22/0x30
[ 160.892647] ? search\_bpf\_extables+0x5f/0x80
[ 160.896988] ? exc\_page\_fault+0xa9/0x140
[ 160.900973] ? asm\_exc\_page\_fault+0x22/0x30
[ 160.905232] ? dev\_map\_free+0x77/0x170
[ 160.909043] ? dev\_map\_free+0x58/0x170
[ 160.912857] bpf\_map\_free\_deferred+0x51/0x90
[ 160.917196] process\_one\_work+0x142/0x370
[ 160.921272] worker\_thread+0x29e/0x3b0
[ 160.925082] ? rescuer\_thread+0x4b0/0x4b0
[ 160.929157] kthread+0xd4/0x110
[ 160.932355] ? kthread\_park+0x80/0x80
[ 160.936079] ret\_from\_fork+0x2d/0x50
[ 160.943396] ? kthread\_park+0x80/0x80
[ 160.950803] ret\_from\_fork\_asm+0x11/0x20
[ 160.958482] </TASK>
Fixes: 546ac1ffb70d ("bpf: add devmap, a map for storing net device references")
CC: stable@vger.kernel.org
Reported-by: Jordy Zomer <jordyzomer@google.com>
Suggested-by: Jordy Zomer <jordyzomer@google.com>
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Link: [https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski@intel.com](https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski%40intel.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex 7878be18e9d264..3aa002a47a9666 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=32cd3db7de97c0c7a018756ce66244342fd583f0)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=ab244dd7cf4c291f82faacdc50b45cc0f55b674d)@@ -184,7 +184,7 @@ static struct bpf\_map \*dev\_map\_alloc(union bpf\_attr \*attr) static void dev\_map\_free(struct bpf\_map \*map) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map);- int i;+ u32 i;  /\* At this point bpf\_prog->aux->refcnt == 0 and this map->refcnt == 0, \* so the programs (can be more than one that used this map) were@@ -821,7 +821,7 @@ static long dev\_map\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key;  if (k >= map->max\_entries) return -EINVAL;@@ -838,7 +838,7 @@ static long dev\_map\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key; unsigned long flags; int ret = -ENOENT; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:04:33 +0000



=== Content from git.kernel.org_8754db8c_20250114_210554.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=70f3de869865f9c3da0508a5ea29f6f4c1889057)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=70f3de869865f9c3da0508a5ea29f6f4c1889057)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70f3de869865f9c3da0508a5ea29f6f4c1889057)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70f3de869865f9c3da0508a5ea29f6f4c1889057)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2024-11-22 13:10:30 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:24 +0100 |
| commit | [70f3de869865f9c3da0508a5ea29f6f4c1889057](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70f3de869865f9c3da0508a5ea29f6f4c1889057) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=70f3de869865f9c3da0508a5ea29f6f4c1889057)) | |
| tree | [46e306a375c5b900754966c6d9d4c56d3c06d7a3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=70f3de869865f9c3da0508a5ea29f6f4c1889057) | |
| parent | [336e30f32ae7c043fde0f6fa21586ff30bea9fe2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=336e30f32ae7c043fde0f6fa21586ff30bea9fe2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70f3de869865f9c3da0508a5ea29f6f4c1889057&id2=336e30f32ae7c043fde0f6fa21586ff30bea9fe2)) | |
| download | [linux-70f3de869865f9c3da0508a5ea29f6f4c1889057.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-70f3de869865f9c3da0508a5ea29f6f4c1889057.tar.gz) | |

bpf: fix OOB devmap writes when deleting elementscommit ab244dd7cf4c291f82faacdc50b45cc0f55b674d upstream.
Jordy reported issue against XSKMAP which also applies to DEVMAP - the
index used for accessing map entry, due to being a signed integer,
causes the OOB writes. Fix is simple as changing the type from int to
u32, however, when compared to XSKMAP case, one more thing needs to be
addressed.
When map is released from system via dev\_map\_free(), we iterate through
all of the entries and an iterator variable is also an int, which
implies OOB accesses. Again, change it to be u32.
Example splat below:
[ 160.724676] BUG: unable to handle page fault for address: ffffc8fc2c001000
[ 160.731662] #PF: supervisor read access in kernel mode
[ 160.736876] #PF: error\_code(0x0000) - not-present page
[ 160.742095] PGD 0 P4D 0
[ 160.744678] Oops: Oops: 0000 [#1] PREEMPT SMP
[ 160.749106] CPU: 1 UID: 0 PID: 520 Comm: kworker/u145:12 Not tainted 6.12.0-rc1+ #487
[ 160.757050] Hardware name: Intel Corporation S2600WFT/S2600WFT, BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[ 160.767642] Workqueue: events\_unbound bpf\_map\_free\_deferred
[ 160.773308] RIP: 0010:dev\_map\_free+0x77/0x170
[ 160.777735] Code: 00 e8 fd 91 ed ff e8 b8 73 ed ff 41 83 7d 18 19 74 6e 41 8b 45 24 49 8b bd f8 00 00 00 31 db 85 c0 74 48 48 63 c3 48 8d 04 c7 <48> 8b 28 48 85 ed 74 30 48 8b 7d 18 48 85 ff 74 05 e8 b3 52 fa ff
[ 160.796777] RSP: 0018:ffffc9000ee1fe38 EFLAGS: 00010202
[ 160.802086] RAX: ffffc8fc2c001000 RBX: 0000000080000000 RCX: 0000000000000024
[ 160.809331] RDX: 0000000000000000 RSI: 0000000000000024 RDI: ffffc9002c001000
[ 160.816576] RBP: 0000000000000000 R08: 0000000000000023 R09: 0000000000000001
[ 160.823823] R10: 0000000000000001 R11: 00000000000ee6b2 R12: dead000000000122
[ 160.831066] R13: ffff88810c928e00 R14: ffff8881002df405 R15: 0000000000000000
[ 160.838310] FS: 0000000000000000(0000) GS:ffff8897e0c40000(0000) knlGS:0000000000000000
[ 160.846528] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 160.852357] CR2: ffffc8fc2c001000 CR3: 0000000005c32006 CR4: 00000000007726f0
[ 160.859604] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 160.866847] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 160.874092] PKRU: 55555554
[ 160.876847] Call Trace:
[ 160.879338] <TASK>
[ 160.881477] ? \_\_die+0x20/0x60
[ 160.884586] ? page\_fault\_oops+0x15a/0x450
[ 160.888746] ? search\_extable+0x22/0x30
[ 160.892647] ? search\_bpf\_extables+0x5f/0x80
[ 160.896988] ? exc\_page\_fault+0xa9/0x140
[ 160.900973] ? asm\_exc\_page\_fault+0x22/0x30
[ 160.905232] ? dev\_map\_free+0x77/0x170
[ 160.909043] ? dev\_map\_free+0x58/0x170
[ 160.912857] bpf\_map\_free\_deferred+0x51/0x90
[ 160.917196] process\_one\_work+0x142/0x370
[ 160.921272] worker\_thread+0x29e/0x3b0
[ 160.925082] ? rescuer\_thread+0x4b0/0x4b0
[ 160.929157] kthread+0xd4/0x110
[ 160.932355] ? kthread\_park+0x80/0x80
[ 160.936079] ret\_from\_fork+0x2d/0x50
[ 160.943396] ? kthread\_park+0x80/0x80
[ 160.950803] ret\_from\_fork\_asm+0x11/0x20
[ 160.958482] </TASK>
Fixes: 546ac1ffb70d ("bpf: add devmap, a map for storing net device references")
CC: stable@vger.kernel.org
Reported-by: Jordy Zomer <jordyzomer@google.com>
Suggested-by: Jordy Zomer <jordyzomer@google.com>
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Link: [https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski@intel.com](https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski%40intel.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70f3de869865f9c3da0508a5ea29f6f4c1889057)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=70f3de869865f9c3da0508a5ea29f6f4c1889057) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex 7eb1282edc8e4f..e805811ac2c98d 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=336e30f32ae7c043fde0f6fa21586ff30bea9fe2)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=70f3de869865f9c3da0508a5ea29f6f4c1889057)@@ -198,7 +198,7 @@ static struct bpf\_map \*dev\_map\_alloc(union bpf\_attr \*attr) static void dev\_map\_free(struct bpf\_map \*map) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map);- int i;+ u32 i;  /\* At this point bpf\_prog->aux->refcnt == 0 and this map->refcnt == 0, \* so the programs (can be more than one that used this map) were@@ -557,7 +557,7 @@ static int dev\_map\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key;  if (k >= map->max\_entries) return -EINVAL;@@ -579,7 +579,7 @@ static int dev\_map\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key; unsigned long flags; int ret = -ENOENT; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:04:30 +0000



=== Content from git.kernel.org_0d6957f6_20250114_210553.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=178e31df1fb3d9e0890eb471da16709cbc82edee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=178e31df1fb3d9e0890eb471da16709cbc82edee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=178e31df1fb3d9e0890eb471da16709cbc82edee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=178e31df1fb3d9e0890eb471da16709cbc82edee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2024-11-22 13:10:30 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:30 +0100 |
| commit | [178e31df1fb3d9e0890eb471da16709cbc82edee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=178e31df1fb3d9e0890eb471da16709cbc82edee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=178e31df1fb3d9e0890eb471da16709cbc82edee)) | |
| tree | [70599f2789052f55f22cb6a36418ef6c6821d0b2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=178e31df1fb3d9e0890eb471da16709cbc82edee) | |
| parent | [3702a27a67c7302d8d2bb4312b904ae37045ba0c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3702a27a67c7302d8d2bb4312b904ae37045ba0c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=178e31df1fb3d9e0890eb471da16709cbc82edee&id2=3702a27a67c7302d8d2bb4312b904ae37045ba0c)) | |
| download | [linux-178e31df1fb3d9e0890eb471da16709cbc82edee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-178e31df1fb3d9e0890eb471da16709cbc82edee.tar.gz) | |

bpf: fix OOB devmap writes when deleting elementscommit ab244dd7cf4c291f82faacdc50b45cc0f55b674d upstream.
Jordy reported issue against XSKMAP which also applies to DEVMAP - the
index used for accessing map entry, due to being a signed integer,
causes the OOB writes. Fix is simple as changing the type from int to
u32, however, when compared to XSKMAP case, one more thing needs to be
addressed.
When map is released from system via dev\_map\_free(), we iterate through
all of the entries and an iterator variable is also an int, which
implies OOB accesses. Again, change it to be u32.
Example splat below:
[ 160.724676] BUG: unable to handle page fault for address: ffffc8fc2c001000
[ 160.731662] #PF: supervisor read access in kernel mode
[ 160.736876] #PF: error\_code(0x0000) - not-present page
[ 160.742095] PGD 0 P4D 0
[ 160.744678] Oops: Oops: 0000 [#1] PREEMPT SMP
[ 160.749106] CPU: 1 UID: 0 PID: 520 Comm: kworker/u145:12 Not tainted 6.12.0-rc1+ #487
[ 160.757050] Hardware name: Intel Corporation S2600WFT/S2600WFT, BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[ 160.767642] Workqueue: events\_unbound bpf\_map\_free\_deferred
[ 160.773308] RIP: 0010:dev\_map\_free+0x77/0x170
[ 160.777735] Code: 00 e8 fd 91 ed ff e8 b8 73 ed ff 41 83 7d 18 19 74 6e 41 8b 45 24 49 8b bd f8 00 00 00 31 db 85 c0 74 48 48 63 c3 48 8d 04 c7 <48> 8b 28 48 85 ed 74 30 48 8b 7d 18 48 85 ff 74 05 e8 b3 52 fa ff
[ 160.796777] RSP: 0018:ffffc9000ee1fe38 EFLAGS: 00010202
[ 160.802086] RAX: ffffc8fc2c001000 RBX: 0000000080000000 RCX: 0000000000000024
[ 160.809331] RDX: 0000000000000000 RSI: 0000000000000024 RDI: ffffc9002c001000
[ 160.816576] RBP: 0000000000000000 R08: 0000000000000023 R09: 0000000000000001
[ 160.823823] R10: 0000000000000001 R11: 00000000000ee6b2 R12: dead000000000122
[ 160.831066] R13: ffff88810c928e00 R14: ffff8881002df405 R15: 0000000000000000
[ 160.838310] FS: 0000000000000000(0000) GS:ffff8897e0c40000(0000) knlGS:0000000000000000
[ 160.846528] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 160.852357] CR2: ffffc8fc2c001000 CR3: 0000000005c32006 CR4: 00000000007726f0
[ 160.859604] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 160.866847] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 160.874092] PKRU: 55555554
[ 160.876847] Call Trace:
[ 160.879338] <TASK>
[ 160.881477] ? \_\_die+0x20/0x60
[ 160.884586] ? page\_fault\_oops+0x15a/0x450
[ 160.888746] ? search\_extable+0x22/0x30
[ 160.892647] ? search\_bpf\_extables+0x5f/0x80
[ 160.896988] ? exc\_page\_fault+0xa9/0x140
[ 160.900973] ? asm\_exc\_page\_fault+0x22/0x30
[ 160.905232] ? dev\_map\_free+0x77/0x170
[ 160.909043] ? dev\_map\_free+0x58/0x170
[ 160.912857] bpf\_map\_free\_deferred+0x51/0x90
[ 160.917196] process\_one\_work+0x142/0x370
[ 160.921272] worker\_thread+0x29e/0x3b0
[ 160.925082] ? rescuer\_thread+0x4b0/0x4b0
[ 160.929157] kthread+0xd4/0x110
[ 160.932355] ? kthread\_park+0x80/0x80
[ 160.936079] ret\_from\_fork+0x2d/0x50
[ 160.943396] ? kthread\_park+0x80/0x80
[ 160.950803] ret\_from\_fork\_asm+0x11/0x20
[ 160.958482] </TASK>
Fixes: 546ac1ffb70d ("bpf: add devmap, a map for storing net device references")
CC: stable@vger.kernel.org
Reported-by: Jordy Zomer <jordyzomer@google.com>
Suggested-by: Jordy Zomer <jordyzomer@google.com>
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Link: [https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski@intel.com](https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski%40intel.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=178e31df1fb3d9e0890eb471da16709cbc82edee)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=178e31df1fb3d9e0890eb471da16709cbc82edee) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex 7878be18e9d264..3aa002a47a9666 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=3702a27a67c7302d8d2bb4312b904ae37045ba0c)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=178e31df1fb3d9e0890eb471da16709cbc82edee)@@ -184,7 +184,7 @@ static struct bpf\_map \*dev\_map\_alloc(union bpf\_attr \*attr) static void dev\_map\_free(struct bpf\_map \*map) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map);- int i;+ u32 i;  /\* At this point bpf\_prog->aux->refcnt == 0 and this map->refcnt == 0, \* so the programs (can be more than one that used this map) were@@ -821,7 +821,7 @@ static long dev\_map\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key;  if (k >= map->max\_entries) return -EINVAL;@@ -838,7 +838,7 @@ static long dev\_map\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key; unsigned long flags; int ret = -ENOENT; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:04:29 +0000



=== Content from git.kernel.org_dbef523e_20250114_210557.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2024-11-22 13:10:30 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:33 +0100 |
| commit | [ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5)) | |
| tree | [960afb160fc37fc2d06013603a90409a2286761f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5) | |
| parent | [fb5fee35bdd18316a84b5f30881a24e1415e1464](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb5fee35bdd18316a84b5f30881a24e1415e1464) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5&id2=fb5fee35bdd18316a84b5f30881a24e1415e1464)) | |
| download | [linux-ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5.tar.gz) | |

bpf: fix OOB devmap writes when deleting elementscommit ab244dd7cf4c291f82faacdc50b45cc0f55b674d upstream.
Jordy reported issue against XSKMAP which also applies to DEVMAP - the
index used for accessing map entry, due to being a signed integer,
causes the OOB writes. Fix is simple as changing the type from int to
u32, however, when compared to XSKMAP case, one more thing needs to be
addressed.
When map is released from system via dev\_map\_free(), we iterate through
all of the entries and an iterator variable is also an int, which
implies OOB accesses. Again, change it to be u32.
Example splat below:
[ 160.724676] BUG: unable to handle page fault for address: ffffc8fc2c001000
[ 160.731662] #PF: supervisor read access in kernel mode
[ 160.736876] #PF: error\_code(0x0000) - not-present page
[ 160.742095] PGD 0 P4D 0
[ 160.744678] Oops: Oops: 0000 [#1] PREEMPT SMP
[ 160.749106] CPU: 1 UID: 0 PID: 520 Comm: kworker/u145:12 Not tainted 6.12.0-rc1+ #487
[ 160.757050] Hardware name: Intel Corporation S2600WFT/S2600WFT, BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[ 160.767642] Workqueue: events\_unbound bpf\_map\_free\_deferred
[ 160.773308] RIP: 0010:dev\_map\_free+0x77/0x170
[ 160.777735] Code: 00 e8 fd 91 ed ff e8 b8 73 ed ff 41 83 7d 18 19 74 6e 41 8b 45 24 49 8b bd f8 00 00 00 31 db 85 c0 74 48 48 63 c3 48 8d 04 c7 <48> 8b 28 48 85 ed 74 30 48 8b 7d 18 48 85 ff 74 05 e8 b3 52 fa ff
[ 160.796777] RSP: 0018:ffffc9000ee1fe38 EFLAGS: 00010202
[ 160.802086] RAX: ffffc8fc2c001000 RBX: 0000000080000000 RCX: 0000000000000024
[ 160.809331] RDX: 0000000000000000 RSI: 0000000000000024 RDI: ffffc9002c001000
[ 160.816576] RBP: 0000000000000000 R08: 0000000000000023 R09: 0000000000000001
[ 160.823823] R10: 0000000000000001 R11: 00000000000ee6b2 R12: dead000000000122
[ 160.831066] R13: ffff88810c928e00 R14: ffff8881002df405 R15: 0000000000000000
[ 160.838310] FS: 0000000000000000(0000) GS:ffff8897e0c40000(0000) knlGS:0000000000000000
[ 160.846528] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 160.852357] CR2: ffffc8fc2c001000 CR3: 0000000005c32006 CR4: 00000000007726f0
[ 160.859604] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 160.866847] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 160.874092] PKRU: 55555554
[ 160.876847] Call Trace:
[ 160.879338] <TASK>
[ 160.881477] ? \_\_die+0x20/0x60
[ 160.884586] ? page\_fault\_oops+0x15a/0x450
[ 160.888746] ? search\_extable+0x22/0x30
[ 160.892647] ? search\_bpf\_extables+0x5f/0x80
[ 160.896988] ? exc\_page\_fault+0xa9/0x140
[ 160.900973] ? asm\_exc\_page\_fault+0x22/0x30
[ 160.905232] ? dev\_map\_free+0x77/0x170
[ 160.909043] ? dev\_map\_free+0x58/0x170
[ 160.912857] bpf\_map\_free\_deferred+0x51/0x90
[ 160.917196] process\_one\_work+0x142/0x370
[ 160.921272] worker\_thread+0x29e/0x3b0
[ 160.925082] ? rescuer\_thread+0x4b0/0x4b0
[ 160.929157] kthread+0xd4/0x110
[ 160.932355] ? kthread\_park+0x80/0x80
[ 160.936079] ret\_from\_fork+0x2d/0x50
[ 160.943396] ? kthread\_park+0x80/0x80
[ 160.950803] ret\_from\_fork\_asm+0x11/0x20
[ 160.958482] </TASK>
Fixes: 546ac1ffb70d ("bpf: add devmap, a map for storing net device references")
CC: stable@vger.kernel.org
Reported-by: Jordy Zomer <jordyzomer@google.com>
Suggested-by: Jordy Zomer <jordyzomer@google.com>
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Link: [https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski@intel.com](https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski%40intel.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex 4118978951bb40..5e2e1c3284a393 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=fb5fee35bdd18316a84b5f30881a24e1415e1464)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=ad34306ac6836e5dd096b7d0ad4aa20cb7c8d9e5)@@ -183,7 +183,7 @@ static struct bpf\_map \*dev\_map\_alloc(union bpf\_attr \*attr) static void dev\_map\_free(struct bpf\_map \*map) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map);- int i;+ u32 i;  /\* At this point bpf\_prog->aux->refcnt == 0 and this map->refcnt == 0, \* so the programs (can be more than one that used this map) were@@ -806,7 +806,7 @@ static int dev\_map\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key;  if (k >= map->max\_entries) return -EINVAL;@@ -821,7 +821,7 @@ static int dev\_map\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key; unsigned long flags; int ret = -ENOENT; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:04:34 +0000



=== Content from git.kernel.org_7a481ce1_20250114_210555.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=98c03d05936d846073df8f550e9e8bf0dde1d77f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=98c03d05936d846073df8f550e9e8bf0dde1d77f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98c03d05936d846073df8f550e9e8bf0dde1d77f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98c03d05936d846073df8f550e9e8bf0dde1d77f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2024-11-22 13:10:30 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:35 +0100 |
| commit | [98c03d05936d846073df8f550e9e8bf0dde1d77f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98c03d05936d846073df8f550e9e8bf0dde1d77f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=98c03d05936d846073df8f550e9e8bf0dde1d77f)) | |
| tree | [16ba6db5d92bafce3fd0ce0ef5914648981f0958](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=98c03d05936d846073df8f550e9e8bf0dde1d77f) | |
| parent | [c23abcb314dced77869e6c8da4896da3280a86f1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c23abcb314dced77869e6c8da4896da3280a86f1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98c03d05936d846073df8f550e9e8bf0dde1d77f&id2=c23abcb314dced77869e6c8da4896da3280a86f1)) | |
| download | [linux-98c03d05936d846073df8f550e9e8bf0dde1d77f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-98c03d05936d846073df8f550e9e8bf0dde1d77f.tar.gz) | |

bpf: fix OOB devmap writes when deleting elementscommit ab244dd7cf4c291f82faacdc50b45cc0f55b674d upstream.
Jordy reported issue against XSKMAP which also applies to DEVMAP - the
index used for accessing map entry, due to being a signed integer,
causes the OOB writes. Fix is simple as changing the type from int to
u32, however, when compared to XSKMAP case, one more thing needs to be
addressed.
When map is released from system via dev\_map\_free(), we iterate through
all of the entries and an iterator variable is also an int, which
implies OOB accesses. Again, change it to be u32.
Example splat below:
[ 160.724676] BUG: unable to handle page fault for address: ffffc8fc2c001000
[ 160.731662] #PF: supervisor read access in kernel mode
[ 160.736876] #PF: error\_code(0x0000) - not-present page
[ 160.742095] PGD 0 P4D 0
[ 160.744678] Oops: Oops: 0000 [#1] PREEMPT SMP
[ 160.749106] CPU: 1 UID: 0 PID: 520 Comm: kworker/u145:12 Not tainted 6.12.0-rc1+ #487
[ 160.757050] Hardware name: Intel Corporation S2600WFT/S2600WFT, BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[ 160.767642] Workqueue: events\_unbound bpf\_map\_free\_deferred
[ 160.773308] RIP: 0010:dev\_map\_free+0x77/0x170
[ 160.777735] Code: 00 e8 fd 91 ed ff e8 b8 73 ed ff 41 83 7d 18 19 74 6e 41 8b 45 24 49 8b bd f8 00 00 00 31 db 85 c0 74 48 48 63 c3 48 8d 04 c7 <48> 8b 28 48 85 ed 74 30 48 8b 7d 18 48 85 ff 74 05 e8 b3 52 fa ff
[ 160.796777] RSP: 0018:ffffc9000ee1fe38 EFLAGS: 00010202
[ 160.802086] RAX: ffffc8fc2c001000 RBX: 0000000080000000 RCX: 0000000000000024
[ 160.809331] RDX: 0000000000000000 RSI: 0000000000000024 RDI: ffffc9002c001000
[ 160.816576] RBP: 0000000000000000 R08: 0000000000000023 R09: 0000000000000001
[ 160.823823] R10: 0000000000000001 R11: 00000000000ee6b2 R12: dead000000000122
[ 160.831066] R13: ffff88810c928e00 R14: ffff8881002df405 R15: 0000000000000000
[ 160.838310] FS: 0000000000000000(0000) GS:ffff8897e0c40000(0000) knlGS:0000000000000000
[ 160.846528] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 160.852357] CR2: ffffc8fc2c001000 CR3: 0000000005c32006 CR4: 00000000007726f0
[ 160.859604] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 160.866847] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 160.874092] PKRU: 55555554
[ 160.876847] Call Trace:
[ 160.879338] <TASK>
[ 160.881477] ? \_\_die+0x20/0x60
[ 160.884586] ? page\_fault\_oops+0x15a/0x450
[ 160.888746] ? search\_extable+0x22/0x30
[ 160.892647] ? search\_bpf\_extables+0x5f/0x80
[ 160.896988] ? exc\_page\_fault+0xa9/0x140
[ 160.900973] ? asm\_exc\_page\_fault+0x22/0x30
[ 160.905232] ? dev\_map\_free+0x77/0x170
[ 160.909043] ? dev\_map\_free+0x58/0x170
[ 160.912857] bpf\_map\_free\_deferred+0x51/0x90
[ 160.917196] process\_one\_work+0x142/0x370
[ 160.921272] worker\_thread+0x29e/0x3b0
[ 160.925082] ? rescuer\_thread+0x4b0/0x4b0
[ 160.929157] kthread+0xd4/0x110
[ 160.932355] ? kthread\_park+0x80/0x80
[ 160.936079] ret\_from\_fork+0x2d/0x50
[ 160.943396] ? kthread\_park+0x80/0x80
[ 160.950803] ret\_from\_fork\_asm+0x11/0x20
[ 160.958482] </TASK>
Fixes: 546ac1ffb70d ("bpf: add devmap, a map for storing net device references")
CC: stable@vger.kernel.org
Reported-by: Jordy Zomer <jordyzomer@google.com>
Suggested-by: Jordy Zomer <jordyzomer@google.com>
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Link: [https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski@intel.com](https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski%40intel.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98c03d05936d846073df8f550e9e8bf0dde1d77f)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=98c03d05936d846073df8f550e9e8bf0dde1d77f) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex 9699c30c3dc43d..ac1d5dbc891856 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=c23abcb314dced77869e6c8da4896da3280a86f1)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=98c03d05936d846073df8f550e9e8bf0dde1d77f)@@ -184,7 +184,7 @@ static struct bpf\_map \*dev\_map\_alloc(union bpf\_attr \*attr) static void dev\_map\_free(struct bpf\_map \*map) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map);- int i;+ u32 i;  /\* At this point bpf\_prog->aux->refcnt == 0 and this map->refcnt == 0, \* so the programs (can be more than one that used this map) were@@ -807,7 +807,7 @@ static int dev\_map\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key;  if (k >= map->max\_entries) return -EINVAL;@@ -822,7 +822,7 @@ static int dev\_map\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key; unsigned long flags; int ret = -ENOENT; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:04:32 +0000



=== Content from git.kernel.org_00eb61ba_20250114_210551.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2024-11-22 13:10:30 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:55 +0100 |
| commit | [0f170e91d3063ca60baec4bd9f544faf3bfe29eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb)) | |
| tree | [7f404acc2bab9718ca874a9cccbb142691d9f66c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb) | |
| parent | [8b69c887f1411e1d1ad1d9d2b967ea12a713dc2a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b69c887f1411e1d1ad1d9d2b967ea12a713dc2a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb&id2=8b69c887f1411e1d1ad1d9d2b967ea12a713dc2a)) | |
| download | [linux-0f170e91d3063ca60baec4bd9f544faf3bfe29eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0f170e91d3063ca60baec4bd9f544faf3bfe29eb.tar.gz) | |

bpf: fix OOB devmap writes when deleting elements[ Upstream commit ab244dd7cf4c291f82faacdc50b45cc0f55b674d ]
Jordy reported issue against XSKMAP which also applies to DEVMAP - the
index used for accessing map entry, due to being a signed integer,
causes the OOB writes. Fix is simple as changing the type from int to
u32, however, when compared to XSKMAP case, one more thing needs to be
addressed.
When map is released from system via dev\_map\_free(), we iterate through
all of the entries and an iterator variable is also an int, which
implies OOB accesses. Again, change it to be u32.
Example splat below:
[ 160.724676] BUG: unable to handle page fault for address: ffffc8fc2c001000
[ 160.731662] #PF: supervisor read access in kernel mode
[ 160.736876] #PF: error\_code(0x0000) - not-present page
[ 160.742095] PGD 0 P4D 0
[ 160.744678] Oops: Oops: 0000 [#1] PREEMPT SMP
[ 160.749106] CPU: 1 UID: 0 PID: 520 Comm: kworker/u145:12 Not tainted 6.12.0-rc1+ #487
[ 160.757050] Hardware name: Intel Corporation S2600WFT/S2600WFT, BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[ 160.767642] Workqueue: events\_unbound bpf\_map\_free\_deferred
[ 160.773308] RIP: 0010:dev\_map\_free+0x77/0x170
[ 160.777735] Code: 00 e8 fd 91 ed ff e8 b8 73 ed ff 41 83 7d 18 19 74 6e 41 8b 45 24 49 8b bd f8 00 00 00 31 db 85 c0 74 48 48 63 c3 48 8d 04 c7 <48> 8b 28 48 85 ed 74 30 48 8b 7d 18 48 85 ff 74 05 e8 b3 52 fa ff
[ 160.796777] RSP: 0018:ffffc9000ee1fe38 EFLAGS: 00010202
[ 160.802086] RAX: ffffc8fc2c001000 RBX: 0000000080000000 RCX: 0000000000000024
[ 160.809331] RDX: 0000000000000000 RSI: 0000000000000024 RDI: ffffc9002c001000
[ 160.816576] RBP: 0000000000000000 R08: 0000000000000023 R09: 0000000000000001
[ 160.823823] R10: 0000000000000001 R11: 00000000000ee6b2 R12: dead000000000122
[ 160.831066] R13: ffff88810c928e00 R14: ffff8881002df405 R15: 0000000000000000
[ 160.838310] FS: 0000000000000000(0000) GS:ffff8897e0c40000(0000) knlGS:0000000000000000
[ 160.846528] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 160.852357] CR2: ffffc8fc2c001000 CR3: 0000000005c32006 CR4: 00000000007726f0
[ 160.859604] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 160.866847] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 160.874092] PKRU: 55555554
[ 160.876847] Call Trace:
[ 160.879338] <TASK>
[ 160.881477] ? \_\_die+0x20/0x60
[ 160.884586] ? page\_fault\_oops+0x15a/0x450
[ 160.888746] ? search\_extable+0x22/0x30
[ 160.892647] ? search\_bpf\_extables+0x5f/0x80
[ 160.896988] ? exc\_page\_fault+0xa9/0x140
[ 160.900973] ? asm\_exc\_page\_fault+0x22/0x30
[ 160.905232] ? dev\_map\_free+0x77/0x170
[ 160.909043] ? dev\_map\_free+0x58/0x170
[ 160.912857] bpf\_map\_free\_deferred+0x51/0x90
[ 160.917196] process\_one\_work+0x142/0x370
[ 160.921272] worker\_thread+0x29e/0x3b0
[ 160.925082] ? rescuer\_thread+0x4b0/0x4b0
[ 160.929157] kthread+0xd4/0x110
[ 160.932355] ? kthread\_park+0x80/0x80
[ 160.936079] ret\_from\_fork+0x2d/0x50
[ 160.943396] ? kthread\_park+0x80/0x80
[ 160.950803] ret\_from\_fork\_asm+0x11/0x20
[ 160.958482] </TASK>
Fixes: 546ac1ffb70d ("bpf: add devmap, a map for storing net device references")
CC: stable@vger.kernel.org
Reported-by: Jordy Zomer <jordyzomer@google.com>
Suggested-by: Jordy Zomer <jordyzomer@google.com>
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Link: [https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski@intel.com](https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski%40intel.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex e63ecb21e0554e..40d42473785924 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=8b69c887f1411e1d1ad1d9d2b967ea12a713dc2a)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=0f170e91d3063ca60baec4bd9f544faf3bfe29eb)@@ -206,7 +206,7 @@ static struct bpf\_map \*dev\_map\_alloc(union bpf\_attr \*attr) static void dev\_map\_free(struct bpf\_map \*map) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map);- int i;+ u32 i;  /\* At this point bpf\_prog->aux->refcnt == 0 and this map->refcnt == 0, \* so the programs (can be more than one that used this map) were@@ -512,7 +512,7 @@ static int dev\_map\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key;  if (k >= map->max\_entries) return -EINVAL;@@ -535,7 +535,7 @@ static int dev\_map\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key; unsigned long flags; int ret = -ENOENT; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:04:28 +0000



=== Content from git.kernel.org_55ae1f1e_20250114_210554.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e858930695d3ebec423e85384c95427258c294f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e858930695d3ebec423e85384c95427258c294f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e858930695d3ebec423e85384c95427258c294f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e858930695d3ebec423e85384c95427258c294f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2024-11-22 13:10:30 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:56 +0100 |
| commit | [8e858930695d3ebec423e85384c95427258c294f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e858930695d3ebec423e85384c95427258c294f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e858930695d3ebec423e85384c95427258c294f)) | |
| tree | [2ef871f6e5b060e5fb517e22e24d8da0f9d985ab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e858930695d3ebec423e85384c95427258c294f) | |
| parent | [94666abe816328301e1e8885a46c99bc37b14f87](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94666abe816328301e1e8885a46c99bc37b14f87) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e858930695d3ebec423e85384c95427258c294f&id2=94666abe816328301e1e8885a46c99bc37b14f87)) | |
| download | [linux-8e858930695d3ebec423e85384c95427258c294f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e858930695d3ebec423e85384c95427258c294f.tar.gz) | |

bpf: fix OOB devmap writes when deleting elementscommit ab244dd7cf4c291f82faacdc50b45cc0f55b674d upstream.
Jordy reported issue against XSKMAP which also applies to DEVMAP - the
index used for accessing map entry, due to being a signed integer,
causes the OOB writes. Fix is simple as changing the type from int to
u32, however, when compared to XSKMAP case, one more thing needs to be
addressed.
When map is released from system via dev\_map\_free(), we iterate through
all of the entries and an iterator variable is also an int, which
implies OOB accesses. Again, change it to be u32.
Example splat below:
[ 160.724676] BUG: unable to handle page fault for address: ffffc8fc2c001000
[ 160.731662] #PF: supervisor read access in kernel mode
[ 160.736876] #PF: error\_code(0x0000) - not-present page
[ 160.742095] PGD 0 P4D 0
[ 160.744678] Oops: Oops: 0000 [#1] PREEMPT SMP
[ 160.749106] CPU: 1 UID: 0 PID: 520 Comm: kworker/u145:12 Not tainted 6.12.0-rc1+ #487
[ 160.757050] Hardware name: Intel Corporation S2600WFT/S2600WFT, BIOS SE5C620.86B.02.01.0008.031920191559 03/19/2019
[ 160.767642] Workqueue: events\_unbound bpf\_map\_free\_deferred
[ 160.773308] RIP: 0010:dev\_map\_free+0x77/0x170
[ 160.777735] Code: 00 e8 fd 91 ed ff e8 b8 73 ed ff 41 83 7d 18 19 74 6e 41 8b 45 24 49 8b bd f8 00 00 00 31 db 85 c0 74 48 48 63 c3 48 8d 04 c7 <48> 8b 28 48 85 ed 74 30 48 8b 7d 18 48 85 ff 74 05 e8 b3 52 fa ff
[ 160.796777] RSP: 0018:ffffc9000ee1fe38 EFLAGS: 00010202
[ 160.802086] RAX: ffffc8fc2c001000 RBX: 0000000080000000 RCX: 0000000000000024
[ 160.809331] RDX: 0000000000000000 RSI: 0000000000000024 RDI: ffffc9002c001000
[ 160.816576] RBP: 0000000000000000 R08: 0000000000000023 R09: 0000000000000001
[ 160.823823] R10: 0000000000000001 R11: 00000000000ee6b2 R12: dead000000000122
[ 160.831066] R13: ffff88810c928e00 R14: ffff8881002df405 R15: 0000000000000000
[ 160.838310] FS: 0000000000000000(0000) GS:ffff8897e0c40000(0000) knlGS:0000000000000000
[ 160.846528] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 160.852357] CR2: ffffc8fc2c001000 CR3: 0000000005c32006 CR4: 00000000007726f0
[ 160.859604] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 160.866847] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 160.874092] PKRU: 55555554
[ 160.876847] Call Trace:
[ 160.879338] <TASK>
[ 160.881477] ? \_\_die+0x20/0x60
[ 160.884586] ? page\_fault\_oops+0x15a/0x450
[ 160.888746] ? search\_extable+0x22/0x30
[ 160.892647] ? search\_bpf\_extables+0x5f/0x80
[ 160.896988] ? exc\_page\_fault+0xa9/0x140
[ 160.900973] ? asm\_exc\_page\_fault+0x22/0x30
[ 160.905232] ? dev\_map\_free+0x77/0x170
[ 160.909043] ? dev\_map\_free+0x58/0x170
[ 160.912857] bpf\_map\_free\_deferred+0x51/0x90
[ 160.917196] process\_one\_work+0x142/0x370
[ 160.921272] worker\_thread+0x29e/0x3b0
[ 160.925082] ? rescuer\_thread+0x4b0/0x4b0
[ 160.929157] kthread+0xd4/0x110
[ 160.932355] ? kthread\_park+0x80/0x80
[ 160.936079] ret\_from\_fork+0x2d/0x50
[ 160.943396] ? kthread\_park+0x80/0x80
[ 160.950803] ret\_from\_fork\_asm+0x11/0x20
[ 160.958482] </TASK>
Fixes: 546ac1ffb70d ("bpf: add devmap, a map for storing net device references")
CC: stable@vger.kernel.org
Reported-by: Jordy Zomer <jordyzomer@google.com>
Suggested-by: Jordy Zomer <jordyzomer@google.com>
Reviewed-by: Toke Høiland-Jørgensen <toke@redhat.com>
Acked-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Link: [https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski@intel.com](https://lore.kernel.org/r/20241122121030.716788-3-maciej.fijalkowski%40intel.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e858930695d3ebec423e85384c95427258c294f)

| -rw-r--r-- | [kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/devmap.c?id=8e858930695d3ebec423e85384c95427258c294f) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/kernel/bpf/devmap.c b/kernel/bpf/devmap.cindex 96b0345f76c2ce..5f2356b47b2ddc 100644--- a/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=94666abe816328301e1e8885a46c99bc37b14f87)+++ b/[kernel/bpf/devmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/devmap.c?id=8e858930695d3ebec423e85384c95427258c294f)@@ -180,7 +180,7 @@ static struct bpf\_map \*dev\_map\_alloc(union bpf\_attr \*attr) static void dev\_map\_free(struct bpf\_map \*map) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map);- int i;+ u32 i;  /\* At this point bpf\_prog->aux->refcnt == 0 and this map->refcnt == 0, \* so the programs (can be more than one that used this map) were@@ -813,7 +813,7 @@ static long dev\_map\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key;  if (k >= map->max\_entries) return -EINVAL;@@ -830,7 +830,7 @@ static long dev\_map\_hash\_delete\_elem(struct bpf\_map \*map, void \*key) { struct bpf\_dtab \*dtab = container\_of(map, struct bpf\_dtab, map); struct bpf\_dtab\_netdev \*old\_dev;- int k = \*(u32 \*)key;+ u32 k = \*(u32 \*)key; unsigned long flags; int ret = -ENOENT; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:04:31 +0000


