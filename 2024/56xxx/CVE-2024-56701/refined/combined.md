=== Content from git.kernel.org_a854d7a1_20250115_084657.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2024-08-19 22:24:01 +1000 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2024-10-29 23:01:36 +1100 |
| commit | [cadae3a45d23aa4f6485938a67cbc47aaaa25e38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38)) | |
| tree | [518b83d729d01f597ce617c027f2abda9ba6b385](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38) | |
| parent | [b23b9edf64b6387334aa2f8687cca6792b0d9d6c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b23b9edf64b6387334aa2f8687cca6792b0d9d6c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38&id2=b23b9edf64b6387334aa2f8687cca6792b0d9d6c)) | |
| download | [linux-cadae3a45d23aa4f6485938a67cbc47aaaa25e38.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cadae3a45d23aa4f6485938a67cbc47aaaa25e38.tar.gz) | |

powerpc/pseries: Fix dtl\_access\_lock to be a rw\_semaphoreThe dtl\_access\_lock needs to be a rw\_sempahore, a sleeping lock, because
the code calls kmalloc() while holding it, which can sleep:
# echo 1 > /proc/powerpc/vcpudispatch\_stats
BUG: sleeping function called from invalid context at include/linux/sched/mm.h:337
in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 199, name: sh
preempt\_count: 1, expected: 0
3 locks held by sh/199:
#0: c00000000a0743f8 (sb\_writers#3){.+.+}-{0:0}, at: vfs\_write+0x324/0x438
#1: c0000000028c7058 (dtl\_enable\_mutex){+.+.}-{3:3}, at: vcpudispatch\_stats\_write+0xd4/0x5f4
#2: c0000000028c70b8 (dtl\_access\_lock){+.+.}-{2:2}, at: vcpudispatch\_stats\_write+0x220/0x5f4
CPU: 0 PID: 199 Comm: sh Not tainted 6.10.0-rc4 #152
Hardware name: IBM pSeries (emulated by qemu) POWER9 (raw) 0x4e1202 0xf000005 of:SLOF,HEAD hv:linux,kvm pSeries
Call Trace:
dump\_stack\_lvl+0x130/0x148 (unreliable)
\_\_might\_resched+0x174/0x410
kmem\_cache\_alloc\_noprof+0x340/0x3d0
alloc\_dtl\_buffers+0x124/0x1ac
vcpudispatch\_stats\_write+0x2a8/0x5f4
proc\_reg\_write+0xf4/0x150
vfs\_write+0xfc/0x438
ksys\_write+0x88/0x148
system\_call\_exception+0x1c4/0x5a0
system\_call\_common+0xf4/0x258
Fixes: 06220d78f24a ("powerpc/pseries: Introduce rwlock to gatekeep DTLB usage")
Tested-by: Kajol Jain <kjain@linux.ibm.com>
Reviewed-by: Nysal Jan K.A <nysal@linux.ibm.com>
Reviewed-by: Kajol Jain <kjain@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/20240819122401.513203-1-mpe@ellerman.id.au](https://patch.msgid.link/20240819122401.513203-1-mpe%40ellerman.id.au)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38)

| -rw-r--r-- | [arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/dtl.h?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/dtl.c?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/lpar.c?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 10 deletions

| diff --git a/arch/powerpc/include/asm/dtl.h b/arch/powerpc/include/asm/dtl.hindex d6f43d149f8dcb..a5c21bc623cb00 100644--- a/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=b23b9edf64b6387334aa2f8687cca6792b0d9d6c)+++ b/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38)@@ -1,8 +1,8 @@ #ifndef \_ASM\_POWERPC\_DTL\_H #define \_ASM\_POWERPC\_DTL\_H +#include <linux/rwsem.h> #include <asm/lppaca.h>-#include <linux/spinlock\_types.h>  /\* \* Layout of entries in the hypervisor's dispatch trace log buffer.@@ -35,7 +35,7 @@ struct dtl\_entry { #define DTL\_LOG\_ALL (DTL\_LOG\_CEDE | DTL\_LOG\_PREEMPT | DTL\_LOG\_FAULT)  extern struct kmem\_cache \*dtl\_cache;-extern rwlock\_t dtl\_access\_lock;+extern struct rw\_semaphore dtl\_access\_lock;  extern void register\_dtl\_buffer(int cpu); extern void alloc\_dtl\_buffers(unsigned long \*time\_limit);diff --git a/arch/powerpc/platforms/pseries/dtl.c b/arch/powerpc/platforms/pseries/dtl.cindex 8cb9d36ea49159..f293588b8c7b51 100644--- a/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=b23b9edf64b6387334aa2f8687cca6792b0d9d6c)+++ b/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38)@@ -191,7 +191,7 @@ static int dtl\_enable(struct dtl \*dtl) return -EBUSY;  /\* ensure there are no other conflicting dtl users \*/- if (!read\_trylock(&dtl\_access\_lock))+ if (!down\_read\_trylock(&dtl\_access\_lock)) return -EBUSY;  n\_entries = dtl\_buf\_entries;@@ -199,7 +199,7 @@ static int dtl\_enable(struct dtl \*dtl) if (!buf) { printk(KERN\_WARNING "%s: buffer alloc failed for cpu %d\n", \_\_func\_\_, dtl->cpu);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); return -ENOMEM; } @@ -217,7 +217,7 @@ static int dtl\_enable(struct dtl \*dtl) spin\_unlock(&dtl->lock);  if (rc) {- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); kmem\_cache\_free(dtl\_cache, buf); } @@ -232,7 +232,7 @@ static void dtl\_disable(struct dtl \*dtl) dtl->buf = NULL; dtl->buf\_entries = 0; spin\_unlock(&dtl->lock);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); }  /\* file interface \*/diff --git a/arch/powerpc/platforms/pseries/lpar.c b/arch/powerpc/platforms/pseries/lpar.cindex 0c428f1ae71271..6a415febc53b74 100644--- a/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=b23b9edf64b6387334aa2f8687cca6792b0d9d6c)+++ b/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=cadae3a45d23aa4f6485938a67cbc47aaaa25e38)@@ -170,7 +170,7 @@ struct vcpu\_dispatch\_data { \*/ #define NR\_CPUS\_H NR\_CPUS -DEFINE\_RWLOCK(dtl\_access\_lock);+DECLARE\_RWSEM(dtl\_access\_lock); static DEFINE\_PER\_CPU(struct vcpu\_dispatch\_data, vcpu\_disp\_data); static DEFINE\_PER\_CPU(u64, dtl\_entry\_ridx); static DEFINE\_PER\_CPU(struct dtl\_worker, dtl\_workers);@@ -464,7 +464,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) { int rc = 0, state; - if (!write\_trylock(&dtl\_access\_lock)) {+ if (!down\_write\_trylock(&dtl\_access\_lock)) { rc = -EBUSY; goto out; }@@ -480,7 +480,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) pr\_err("vcpudispatch\_stats: unable to setup workqueue for DTL processing\n"); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); rc = -EINVAL; goto out; }@@ -495,7 +495,7 @@ static void dtl\_worker\_disable(unsigned long \*time\_limit) cpuhp\_remove\_state(dtl\_worker\_state); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); }  static ssize\_t vcpudispatch\_stats\_write(struct file \*file, const char \_\_user \*p, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:45:33 +0000



=== Content from git.kernel.org_1b1ab59d_20250115_084701.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fa5b5ea257135e771b489c83a2e93b5935d0108e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa5b5ea257135e771b489c83a2e93b5935d0108e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa5b5ea257135e771b489c83a2e93b5935d0108e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa5b5ea257135e771b489c83a2e93b5935d0108e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2024-08-19 22:24:01 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:37 +0100 |
| commit | [fa5b5ea257135e771b489c83a2e93b5935d0108e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa5b5ea257135e771b489c83a2e93b5935d0108e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fa5b5ea257135e771b489c83a2e93b5935d0108e)) | |
| tree | [0c8a1857486dabc4598592857bf0ec8e914aaa22](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa5b5ea257135e771b489c83a2e93b5935d0108e) | |
| parent | [4d2655754e94741b159aa807b72ea85518a65fd5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d2655754e94741b159aa807b72ea85518a65fd5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa5b5ea257135e771b489c83a2e93b5935d0108e&id2=4d2655754e94741b159aa807b72ea85518a65fd5)) | |
| download | [linux-fa5b5ea257135e771b489c83a2e93b5935d0108e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fa5b5ea257135e771b489c83a2e93b5935d0108e.tar.gz) | |

powerpc/pseries: Fix dtl\_access\_lock to be a rw\_semaphore[ Upstream commit cadae3a45d23aa4f6485938a67cbc47aaaa25e38 ]
The dtl\_access\_lock needs to be a rw\_sempahore, a sleeping lock, because
the code calls kmalloc() while holding it, which can sleep:
# echo 1 > /proc/powerpc/vcpudispatch\_stats
BUG: sleeping function called from invalid context at include/linux/sched/mm.h:337
in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 199, name: sh
preempt\_count: 1, expected: 0
3 locks held by sh/199:
#0: c00000000a0743f8 (sb\_writers#3){.+.+}-{0:0}, at: vfs\_write+0x324/0x438
#1: c0000000028c7058 (dtl\_enable\_mutex){+.+.}-{3:3}, at: vcpudispatch\_stats\_write+0xd4/0x5f4
#2: c0000000028c70b8 (dtl\_access\_lock){+.+.}-{2:2}, at: vcpudispatch\_stats\_write+0x220/0x5f4
CPU: 0 PID: 199 Comm: sh Not tainted 6.10.0-rc4 #152
Hardware name: IBM pSeries (emulated by qemu) POWER9 (raw) 0x4e1202 0xf000005 of:SLOF,HEAD hv:linux,kvm pSeries
Call Trace:
dump\_stack\_lvl+0x130/0x148 (unreliable)
\_\_might\_resched+0x174/0x410
kmem\_cache\_alloc\_noprof+0x340/0x3d0
alloc\_dtl\_buffers+0x124/0x1ac
vcpudispatch\_stats\_write+0x2a8/0x5f4
proc\_reg\_write+0xf4/0x150
vfs\_write+0xfc/0x438
ksys\_write+0x88/0x148
system\_call\_exception+0x1c4/0x5a0
system\_call\_common+0xf4/0x258
Fixes: 06220d78f24a ("powerpc/pseries: Introduce rwlock to gatekeep DTLB usage")
Tested-by: Kajol Jain <kjain@linux.ibm.com>
Reviewed-by: Nysal Jan K.A <nysal@linux.ibm.com>
Reviewed-by: Kajol Jain <kjain@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/20240819122401.513203-1-mpe@ellerman.id.au](https://patch.msgid.link/20240819122401.513203-1-mpe%40ellerman.id.au)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa5b5ea257135e771b489c83a2e93b5935d0108e)

| -rw-r--r-- | [arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/dtl.h?id=fa5b5ea257135e771b489c83a2e93b5935d0108e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/dtl.c?id=fa5b5ea257135e771b489c83a2e93b5935d0108e) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/lpar.c?id=fa5b5ea257135e771b489c83a2e93b5935d0108e) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 10 deletions

| diff --git a/arch/powerpc/include/asm/dtl.h b/arch/powerpc/include/asm/dtl.hindex 4bcb9f9ac76491..859af5de3c2f94 100644--- a/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=4d2655754e94741b159aa807b72ea85518a65fd5)+++ b/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=fa5b5ea257135e771b489c83a2e93b5935d0108e)@@ -1,8 +1,8 @@ #ifndef \_ASM\_POWERPC\_DTL\_H #define \_ASM\_POWERPC\_DTL\_H +#include <linux/rwsem.h> #include <asm/lppaca.h>-#include <linux/spinlock\_types.h>  /\* \* Layout of entries in the hypervisor's dispatch trace log buffer.@@ -35,7 +35,7 @@ struct dtl\_entry { #define DTL\_LOG\_ALL (DTL\_LOG\_CEDE | DTL\_LOG\_PREEMPT | DTL\_LOG\_FAULT)  extern struct kmem\_cache \*dtl\_cache;-extern rwlock\_t dtl\_access\_lock;+extern struct rw\_semaphore dtl\_access\_lock;  extern void register\_dtl\_buffer(int cpu); extern void alloc\_dtl\_buffers(unsigned long \*time\_limit);diff --git a/arch/powerpc/platforms/pseries/dtl.c b/arch/powerpc/platforms/pseries/dtl.cindex 3f1cdccebc9c15..ecc04ef8c53e31 100644--- a/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=4d2655754e94741b159aa807b72ea85518a65fd5)+++ b/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=fa5b5ea257135e771b489c83a2e93b5935d0108e)@@ -191,7 +191,7 @@ static int dtl\_enable(struct dtl \*dtl) return -EBUSY;  /\* ensure there are no other conflicting dtl users \*/- if (!read\_trylock(&dtl\_access\_lock))+ if (!down\_read\_trylock(&dtl\_access\_lock)) return -EBUSY;  n\_entries = dtl\_buf\_entries;@@ -199,7 +199,7 @@ static int dtl\_enable(struct dtl \*dtl) if (!buf) { printk(KERN\_WARNING "%s: buffer alloc failed for cpu %d\n", \_\_func\_\_, dtl->cpu);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); return -ENOMEM; } @@ -217,7 +217,7 @@ static int dtl\_enable(struct dtl \*dtl) spin\_unlock(&dtl->lock);  if (rc) {- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); kmem\_cache\_free(dtl\_cache, buf); } @@ -232,7 +232,7 @@ static void dtl\_disable(struct dtl \*dtl) dtl->buf = NULL; dtl->buf\_entries = 0; spin\_unlock(&dtl->lock);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); }  /\* file interface \*/diff --git a/arch/powerpc/platforms/pseries/lpar.c b/arch/powerpc/platforms/pseries/lpar.cindex 29d235b02f0622..98f8e0a39eb2f7 100644--- a/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=4d2655754e94741b159aa807b72ea85518a65fd5)+++ b/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=fa5b5ea257135e771b489c83a2e93b5935d0108e)@@ -167,7 +167,7 @@ struct vcpu\_dispatch\_data { \*/ #define NR\_CPUS\_H NR\_CPUS -DEFINE\_RWLOCK(dtl\_access\_lock);+DECLARE\_RWSEM(dtl\_access\_lock); static DEFINE\_PER\_CPU(struct vcpu\_dispatch\_data, vcpu\_disp\_data); static DEFINE\_PER\_CPU(u64, dtl\_entry\_ridx); static DEFINE\_PER\_CPU(struct dtl\_worker, dtl\_workers);@@ -461,7 +461,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) { int rc = 0, state; - if (!write\_trylock(&dtl\_access\_lock)) {+ if (!down\_write\_trylock(&dtl\_access\_lock)) { rc = -EBUSY; goto out; }@@ -477,7 +477,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) pr\_err("vcpudispatch\_stats: unable to setup workqueue for DTL processing\n"); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); rc = -EINVAL; goto out; }@@ -492,7 +492,7 @@ static void dtl\_worker\_disable(unsigned long \*time\_limit) cpuhp\_remove\_state(dtl\_worker\_state); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); }  static ssize\_t vcpudispatch\_stats\_write(struct file \*file, const char \_\_user \*p, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:45:37 +0000



=== Content from git.kernel.org_9959338a_20250115_084652.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2024-08-19 22:24:01 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:06 +0100 |
| commit | [525e18f1ba7c2b098c8ba587fb397efb34a6574c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c)) | |
| tree | [e5a651bb456c07e448f7fd1ea0f4ce61cfb4cdf6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c) | |
| parent | [81af1f63e9442609040f7d0f78ae28dc2a68c419](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81af1f63e9442609040f7d0f78ae28dc2a68c419) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c&id2=81af1f63e9442609040f7d0f78ae28dc2a68c419)) | |
| download | [linux-525e18f1ba7c2b098c8ba587fb397efb34a6574c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-525e18f1ba7c2b098c8ba587fb397efb34a6574c.tar.gz) | |

powerpc/pseries: Fix dtl\_access\_lock to be a rw\_semaphore[ Upstream commit cadae3a45d23aa4f6485938a67cbc47aaaa25e38 ]
The dtl\_access\_lock needs to be a rw\_sempahore, a sleeping lock, because
the code calls kmalloc() while holding it, which can sleep:
# echo 1 > /proc/powerpc/vcpudispatch\_stats
BUG: sleeping function called from invalid context at include/linux/sched/mm.h:337
in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 199, name: sh
preempt\_count: 1, expected: 0
3 locks held by sh/199:
#0: c00000000a0743f8 (sb\_writers#3){.+.+}-{0:0}, at: vfs\_write+0x324/0x438
#1: c0000000028c7058 (dtl\_enable\_mutex){+.+.}-{3:3}, at: vcpudispatch\_stats\_write+0xd4/0x5f4
#2: c0000000028c70b8 (dtl\_access\_lock){+.+.}-{2:2}, at: vcpudispatch\_stats\_write+0x220/0x5f4
CPU: 0 PID: 199 Comm: sh Not tainted 6.10.0-rc4 #152
Hardware name: IBM pSeries (emulated by qemu) POWER9 (raw) 0x4e1202 0xf000005 of:SLOF,HEAD hv:linux,kvm pSeries
Call Trace:
dump\_stack\_lvl+0x130/0x148 (unreliable)
\_\_might\_resched+0x174/0x410
kmem\_cache\_alloc\_noprof+0x340/0x3d0
alloc\_dtl\_buffers+0x124/0x1ac
vcpudispatch\_stats\_write+0x2a8/0x5f4
proc\_reg\_write+0xf4/0x150
vfs\_write+0xfc/0x438
ksys\_write+0x88/0x148
system\_call\_exception+0x1c4/0x5a0
system\_call\_common+0xf4/0x258
Fixes: 06220d78f24a ("powerpc/pseries: Introduce rwlock to gatekeep DTLB usage")
Tested-by: Kajol Jain <kjain@linux.ibm.com>
Reviewed-by: Nysal Jan K.A <nysal@linux.ibm.com>
Reviewed-by: Kajol Jain <kjain@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/20240819122401.513203-1-mpe@ellerman.id.au](https://patch.msgid.link/20240819122401.513203-1-mpe%40ellerman.id.au)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c)

| -rw-r--r-- | [arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/dtl.h?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/dtl.c?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/lpar.c?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 10 deletions

| diff --git a/arch/powerpc/include/asm/dtl.h b/arch/powerpc/include/asm/dtl.hindex d6f43d149f8dcb..a5c21bc623cb00 100644--- a/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=81af1f63e9442609040f7d0f78ae28dc2a68c419)+++ b/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c)@@ -1,8 +1,8 @@ #ifndef \_ASM\_POWERPC\_DTL\_H #define \_ASM\_POWERPC\_DTL\_H +#include <linux/rwsem.h> #include <asm/lppaca.h>-#include <linux/spinlock\_types.h>  /\* \* Layout of entries in the hypervisor's dispatch trace log buffer.@@ -35,7 +35,7 @@ struct dtl\_entry { #define DTL\_LOG\_ALL (DTL\_LOG\_CEDE | DTL\_LOG\_PREEMPT | DTL\_LOG\_FAULT)  extern struct kmem\_cache \*dtl\_cache;-extern rwlock\_t dtl\_access\_lock;+extern struct rw\_semaphore dtl\_access\_lock;  extern void register\_dtl\_buffer(int cpu); extern void alloc\_dtl\_buffers(unsigned long \*time\_limit);diff --git a/arch/powerpc/platforms/pseries/dtl.c b/arch/powerpc/platforms/pseries/dtl.cindex 8cb9d36ea49159..f293588b8c7b51 100644--- a/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=81af1f63e9442609040f7d0f78ae28dc2a68c419)+++ b/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c)@@ -191,7 +191,7 @@ static int dtl\_enable(struct dtl \*dtl) return -EBUSY;  /\* ensure there are no other conflicting dtl users \*/- if (!read\_trylock(&dtl\_access\_lock))+ if (!down\_read\_trylock(&dtl\_access\_lock)) return -EBUSY;  n\_entries = dtl\_buf\_entries;@@ -199,7 +199,7 @@ static int dtl\_enable(struct dtl \*dtl) if (!buf) { printk(KERN\_WARNING "%s: buffer alloc failed for cpu %d\n", \_\_func\_\_, dtl->cpu);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); return -ENOMEM; } @@ -217,7 +217,7 @@ static int dtl\_enable(struct dtl \*dtl) spin\_unlock(&dtl->lock);  if (rc) {- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); kmem\_cache\_free(dtl\_cache, buf); } @@ -232,7 +232,7 @@ static void dtl\_disable(struct dtl \*dtl) dtl->buf = NULL; dtl->buf\_entries = 0; spin\_unlock(&dtl->lock);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); }  /\* file interface \*/diff --git a/arch/powerpc/platforms/pseries/lpar.c b/arch/powerpc/platforms/pseries/lpar.cindex c1d8bee8f7018c..bb09990eec309a 100644--- a/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=81af1f63e9442609040f7d0f78ae28dc2a68c419)+++ b/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=525e18f1ba7c2b098c8ba587fb397efb34a6574c)@@ -169,7 +169,7 @@ struct vcpu\_dispatch\_data { \*/ #define NR\_CPUS\_H NR\_CPUS -DEFINE\_RWLOCK(dtl\_access\_lock);+DECLARE\_RWSEM(dtl\_access\_lock); static DEFINE\_PER\_CPU(struct vcpu\_dispatch\_data, vcpu\_disp\_data); static DEFINE\_PER\_CPU(u64, dtl\_entry\_ridx); static DEFINE\_PER\_CPU(struct dtl\_worker, dtl\_workers);@@ -463,7 +463,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) { int rc = 0, state; - if (!write\_trylock(&dtl\_access\_lock)) {+ if (!down\_write\_trylock(&dtl\_access\_lock)) { rc = -EBUSY; goto out; }@@ -479,7 +479,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) pr\_err("vcpudispatch\_stats: unable to setup workqueue for DTL processing\n"); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); rc = -EINVAL; goto out; }@@ -494,7 +494,7 @@ static void dtl\_worker\_disable(unsigned long \*time\_limit) cpuhp\_remove\_state(dtl\_worker\_state); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); }  static ssize\_t vcpudispatch\_stats\_write(struct file \*file, const char \_\_user \*p, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:45:29 +0000



=== Content from git.kernel.org_331766f3_20250115_084652.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6956c0e7346ce1bbfc726755aa8da10d26e84276)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6956c0e7346ce1bbfc726755aa8da10d26e84276)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6956c0e7346ce1bbfc726755aa8da10d26e84276)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6956c0e7346ce1bbfc726755aa8da10d26e84276)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2024-08-19 22:24:01 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:58 +0100 |
| commit | [6956c0e7346ce1bbfc726755aa8da10d26e84276](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6956c0e7346ce1bbfc726755aa8da10d26e84276) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6956c0e7346ce1bbfc726755aa8da10d26e84276)) | |
| tree | [13bfe9f9ee8ec6c5c0baf359bca70dc18589572a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6956c0e7346ce1bbfc726755aa8da10d26e84276) | |
| parent | [54cb5fa850f9306d84e49a3db44b7a7eb5536cd1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54cb5fa850f9306d84e49a3db44b7a7eb5536cd1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6956c0e7346ce1bbfc726755aa8da10d26e84276&id2=54cb5fa850f9306d84e49a3db44b7a7eb5536cd1)) | |
| download | [linux-6956c0e7346ce1bbfc726755aa8da10d26e84276.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6956c0e7346ce1bbfc726755aa8da10d26e84276.tar.gz) | |

powerpc/pseries: Fix dtl\_access\_lock to be a rw\_semaphore[ Upstream commit cadae3a45d23aa4f6485938a67cbc47aaaa25e38 ]
The dtl\_access\_lock needs to be a rw\_sempahore, a sleeping lock, because
the code calls kmalloc() while holding it, which can sleep:
# echo 1 > /proc/powerpc/vcpudispatch\_stats
BUG: sleeping function called from invalid context at include/linux/sched/mm.h:337
in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 199, name: sh
preempt\_count: 1, expected: 0
3 locks held by sh/199:
#0: c00000000a0743f8 (sb\_writers#3){.+.+}-{0:0}, at: vfs\_write+0x324/0x438
#1: c0000000028c7058 (dtl\_enable\_mutex){+.+.}-{3:3}, at: vcpudispatch\_stats\_write+0xd4/0x5f4
#2: c0000000028c70b8 (dtl\_access\_lock){+.+.}-{2:2}, at: vcpudispatch\_stats\_write+0x220/0x5f4
CPU: 0 PID: 199 Comm: sh Not tainted 6.10.0-rc4 #152
Hardware name: IBM pSeries (emulated by qemu) POWER9 (raw) 0x4e1202 0xf000005 of:SLOF,HEAD hv:linux,kvm pSeries
Call Trace:
dump\_stack\_lvl+0x130/0x148 (unreliable)
\_\_might\_resched+0x174/0x410
kmem\_cache\_alloc\_noprof+0x340/0x3d0
alloc\_dtl\_buffers+0x124/0x1ac
vcpudispatch\_stats\_write+0x2a8/0x5f4
proc\_reg\_write+0xf4/0x150
vfs\_write+0xfc/0x438
ksys\_write+0x88/0x148
system\_call\_exception+0x1c4/0x5a0
system\_call\_common+0xf4/0x258
Fixes: 06220d78f24a ("powerpc/pseries: Introduce rwlock to gatekeep DTLB usage")
Tested-by: Kajol Jain <kjain@linux.ibm.com>
Reviewed-by: Nysal Jan K.A <nysal@linux.ibm.com>
Reviewed-by: Kajol Jain <kjain@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/20240819122401.513203-1-mpe@ellerman.id.au](https://patch.msgid.link/20240819122401.513203-1-mpe%40ellerman.id.au)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6956c0e7346ce1bbfc726755aa8da10d26e84276)

| -rw-r--r-- | [arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/dtl.h?id=6956c0e7346ce1bbfc726755aa8da10d26e84276) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/dtl.c?id=6956c0e7346ce1bbfc726755aa8da10d26e84276) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/lpar.c?id=6956c0e7346ce1bbfc726755aa8da10d26e84276) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 10 deletions

| diff --git a/arch/powerpc/include/asm/dtl.h b/arch/powerpc/include/asm/dtl.hindex 1625888f27ef6b..5e40f27aa76e5a 100644--- a/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=54cb5fa850f9306d84e49a3db44b7a7eb5536cd1)+++ b/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=6956c0e7346ce1bbfc726755aa8da10d26e84276)@@ -1,8 +1,8 @@ #ifndef \_ASM\_POWERPC\_DTL\_H #define \_ASM\_POWERPC\_DTL\_H +#include <linux/rwsem.h> #include <asm/lppaca.h>-#include <linux/spinlock\_types.h>  /\* \* Layout of entries in the hypervisor's dispatch trace log buffer.@@ -35,7 +35,7 @@ struct dtl\_entry { #define DTL\_LOG\_ALL (DTL\_LOG\_CEDE | DTL\_LOG\_PREEMPT | DTL\_LOG\_FAULT)  extern struct kmem\_cache \*dtl\_cache;-extern rwlock\_t dtl\_access\_lock;+extern struct rw\_semaphore dtl\_access\_lock;  /\* \* When CONFIG\_VIRT\_CPU\_ACCOUNTING\_NATIVE = y, the cpu accounting code controlsdiff --git a/arch/powerpc/platforms/pseries/dtl.c b/arch/powerpc/platforms/pseries/dtl.cindex 982f069e4c318a..36a2eb23dbdc45 100644--- a/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=54cb5fa850f9306d84e49a3db44b7a7eb5536cd1)+++ b/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=6956c0e7346ce1bbfc726755aa8da10d26e84276)@@ -181,7 +181,7 @@ static int dtl\_enable(struct dtl \*dtl) return -EBUSY;  /\* ensure there are no other conflicting dtl users \*/- if (!read\_trylock(&dtl\_access\_lock))+ if (!down\_read\_trylock(&dtl\_access\_lock)) return -EBUSY;  n\_entries = dtl\_buf\_entries;@@ -189,7 +189,7 @@ static int dtl\_enable(struct dtl \*dtl) if (!buf) { printk(KERN\_WARNING "%s: buffer alloc failed for cpu %d\n", \_\_func\_\_, dtl->cpu);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); return -ENOMEM; } @@ -207,7 +207,7 @@ static int dtl\_enable(struct dtl \*dtl) spin\_unlock(&dtl->lock);  if (rc) {- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); kmem\_cache\_free(dtl\_cache, buf); } @@ -222,7 +222,7 @@ static void dtl\_disable(struct dtl \*dtl) dtl->buf = NULL; dtl->buf\_entries = 0; spin\_unlock(&dtl->lock);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); }  /\* file interface \*/diff --git a/arch/powerpc/platforms/pseries/lpar.c b/arch/powerpc/platforms/pseries/lpar.cindex aed67f1a1bc568..b19de0faf913c2 100644--- a/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=54cb5fa850f9306d84e49a3db44b7a7eb5536cd1)+++ b/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=6956c0e7346ce1bbfc726755aa8da10d26e84276)@@ -166,7 +166,7 @@ struct vcpu\_dispatch\_data { \*/ #define NR\_CPUS\_H NR\_CPUS -DEFINE\_RWLOCK(dtl\_access\_lock);+DECLARE\_RWSEM(dtl\_access\_lock); static DEFINE\_PER\_CPU(struct vcpu\_dispatch\_data, vcpu\_disp\_data); static DEFINE\_PER\_CPU(u64, dtl\_entry\_ridx); static DEFINE\_PER\_CPU(struct dtl\_worker, dtl\_workers);@@ -460,7 +460,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) { int rc = 0, state; - if (!write\_trylock(&dtl\_access\_lock)) {+ if (!down\_write\_trylock(&dtl\_access\_lock)) { rc = -EBUSY; goto out; }@@ -476,7 +476,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) pr\_err("vcpudispatch\_stats: unable to setup workqueue for DTL processing\n"); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); rc = -EINVAL; goto out; }@@ -491,7 +491,7 @@ static void dtl\_worker\_disable(unsigned long \*time\_limit) cpuhp\_remove\_state(dtl\_worker\_state); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); }  static ssize\_t vcpudispatch\_stats\_write(struct file \*file, const char \_\_user \*p, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:45:30 +0000



=== Content from git.kernel.org_640ef49f_20250115_084659.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f6ec133668757f84e5143f1eb141fd0b83778b9e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f6ec133668757f84e5143f1eb141fd0b83778b9e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6ec133668757f84e5143f1eb141fd0b83778b9e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6ec133668757f84e5143f1eb141fd0b83778b9e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2024-08-19 22:24:01 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:01 +0100 |
| commit | [f6ec133668757f84e5143f1eb141fd0b83778b9e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6ec133668757f84e5143f1eb141fd0b83778b9e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f6ec133668757f84e5143f1eb141fd0b83778b9e)) | |
| tree | [4fb3761e54dc66b4e3d230aacc1626d531592b5b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f6ec133668757f84e5143f1eb141fd0b83778b9e) | |
| parent | [e0a470b5733c1fe068d5c58b0bb91ad539604bc6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6ec133668757f84e5143f1eb141fd0b83778b9e&id2=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)) | |
| download | [linux-f6ec133668757f84e5143f1eb141fd0b83778b9e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f6ec133668757f84e5143f1eb141fd0b83778b9e.tar.gz) | |

powerpc/pseries: Fix dtl\_access\_lock to be a rw\_semaphore[ Upstream commit cadae3a45d23aa4f6485938a67cbc47aaaa25e38 ]
The dtl\_access\_lock needs to be a rw\_sempahore, a sleeping lock, because
the code calls kmalloc() while holding it, which can sleep:
# echo 1 > /proc/powerpc/vcpudispatch\_stats
BUG: sleeping function called from invalid context at include/linux/sched/mm.h:337
in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 199, name: sh
preempt\_count: 1, expected: 0
3 locks held by sh/199:
#0: c00000000a0743f8 (sb\_writers#3){.+.+}-{0:0}, at: vfs\_write+0x324/0x438
#1: c0000000028c7058 (dtl\_enable\_mutex){+.+.}-{3:3}, at: vcpudispatch\_stats\_write+0xd4/0x5f4
#2: c0000000028c70b8 (dtl\_access\_lock){+.+.}-{2:2}, at: vcpudispatch\_stats\_write+0x220/0x5f4
CPU: 0 PID: 199 Comm: sh Not tainted 6.10.0-rc4 #152
Hardware name: IBM pSeries (emulated by qemu) POWER9 (raw) 0x4e1202 0xf000005 of:SLOF,HEAD hv:linux,kvm pSeries
Call Trace:
dump\_stack\_lvl+0x130/0x148 (unreliable)
\_\_might\_resched+0x174/0x410
kmem\_cache\_alloc\_noprof+0x340/0x3d0
alloc\_dtl\_buffers+0x124/0x1ac
vcpudispatch\_stats\_write+0x2a8/0x5f4
proc\_reg\_write+0xf4/0x150
vfs\_write+0xfc/0x438
ksys\_write+0x88/0x148
system\_call\_exception+0x1c4/0x5a0
system\_call\_common+0xf4/0x258
Fixes: 06220d78f24a ("powerpc/pseries: Introduce rwlock to gatekeep DTLB usage")
Tested-by: Kajol Jain <kjain@linux.ibm.com>
Reviewed-by: Nysal Jan K.A <nysal@linux.ibm.com>
Reviewed-by: Kajol Jain <kjain@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/20240819122401.513203-1-mpe@ellerman.id.au](https://patch.msgid.link/20240819122401.513203-1-mpe%40ellerman.id.au)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f6ec133668757f84e5143f1eb141fd0b83778b9e)

| -rw-r--r-- | [arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/dtl.h?id=f6ec133668757f84e5143f1eb141fd0b83778b9e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/dtl.c?id=f6ec133668757f84e5143f1eb141fd0b83778b9e) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/lpar.c?id=f6ec133668757f84e5143f1eb141fd0b83778b9e) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 10 deletions

| diff --git a/arch/powerpc/include/asm/dtl.h b/arch/powerpc/include/asm/dtl.hindex 1625888f27ef6b..5e40f27aa76e5a 100644--- a/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)+++ b/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=f6ec133668757f84e5143f1eb141fd0b83778b9e)@@ -1,8 +1,8 @@ #ifndef \_ASM\_POWERPC\_DTL\_H #define \_ASM\_POWERPC\_DTL\_H +#include <linux/rwsem.h> #include <asm/lppaca.h>-#include <linux/spinlock\_types.h>  /\* \* Layout of entries in the hypervisor's dispatch trace log buffer.@@ -35,7 +35,7 @@ struct dtl\_entry { #define DTL\_LOG\_ALL (DTL\_LOG\_CEDE | DTL\_LOG\_PREEMPT | DTL\_LOG\_FAULT)  extern struct kmem\_cache \*dtl\_cache;-extern rwlock\_t dtl\_access\_lock;+extern struct rw\_semaphore dtl\_access\_lock;  /\* \* When CONFIG\_VIRT\_CPU\_ACCOUNTING\_NATIVE = y, the cpu accounting code controlsdiff --git a/arch/powerpc/platforms/pseries/dtl.c b/arch/powerpc/platforms/pseries/dtl.cindex 352af5b14a0f7b..b9096e343ffb8d 100644--- a/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)+++ b/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=f6ec133668757f84e5143f1eb141fd0b83778b9e)@@ -181,7 +181,7 @@ static int dtl\_enable(struct dtl \*dtl) return -EBUSY;  /\* ensure there are no other conflicting dtl users \*/- if (!read\_trylock(&dtl\_access\_lock))+ if (!down\_read\_trylock(&dtl\_access\_lock)) return -EBUSY;  n\_entries = dtl\_buf\_entries;@@ -189,7 +189,7 @@ static int dtl\_enable(struct dtl \*dtl) if (!buf) { printk(KERN\_WARNING "%s: buffer alloc failed for cpu %d\n", \_\_func\_\_, dtl->cpu);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); return -ENOMEM; } @@ -207,7 +207,7 @@ static int dtl\_enable(struct dtl \*dtl) spin\_unlock(&dtl->lock);  if (rc) {- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); kmem\_cache\_free(dtl\_cache, buf); } @@ -222,7 +222,7 @@ static void dtl\_disable(struct dtl \*dtl) dtl->buf = NULL; dtl->buf\_entries = 0; spin\_unlock(&dtl->lock);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); }  /\* file interface \*/diff --git a/arch/powerpc/platforms/pseries/lpar.c b/arch/powerpc/platforms/pseries/lpar.cindex c2fff9a339285d..49aaa5a6d165da 100644--- a/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=e0a470b5733c1fe068d5c58b0bb91ad539604bc6)+++ b/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=f6ec133668757f84e5143f1eb141fd0b83778b9e)@@ -167,7 +167,7 @@ struct vcpu\_dispatch\_data { \*/ #define NR\_CPUS\_H NR\_CPUS -DEFINE\_RWLOCK(dtl\_access\_lock);+DECLARE\_RWSEM(dtl\_access\_lock); static DEFINE\_PER\_CPU(struct vcpu\_dispatch\_data, vcpu\_disp\_data); static DEFINE\_PER\_CPU(u64, dtl\_entry\_ridx); static DEFINE\_PER\_CPU(struct dtl\_worker, dtl\_workers);@@ -461,7 +461,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) { int rc = 0, state; - if (!write\_trylock(&dtl\_access\_lock)) {+ if (!down\_write\_trylock(&dtl\_access\_lock)) { rc = -EBUSY; goto out; }@@ -477,7 +477,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) pr\_err("vcpudispatch\_stats: unable to setup workqueue for DTL processing\n"); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); rc = -EINVAL; goto out; }@@ -492,7 +492,7 @@ static void dtl\_worker\_disable(unsigned long \*time\_limit) cpuhp\_remove\_state(dtl\_worker\_state); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); }  static ssize\_t vcpudispatch\_stats\_write(struct file \*file, const char \_\_user \*p, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:45:36 +0000



=== Content from git.kernel.org_2e1771d6_20250115_084653.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2024-08-19 22:24:01 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:15 +0100 |
| commit | [a246daa26b717e755ccc9061f47f7cd1c0b358dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd)) | |
| tree | [12e0e1a620d78011756c03e219e3a0f4c44cb0fc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd) | |
| parent | [8a06435959cc182840198f6c07c8b2d1ce8a034e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a06435959cc182840198f6c07c8b2d1ce8a034e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd&id2=8a06435959cc182840198f6c07c8b2d1ce8a034e)) | |
| download | [linux-a246daa26b717e755ccc9061f47f7cd1c0b358dd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a246daa26b717e755ccc9061f47f7cd1c0b358dd.tar.gz) | |

powerpc/pseries: Fix dtl\_access\_lock to be a rw\_semaphore[ Upstream commit cadae3a45d23aa4f6485938a67cbc47aaaa25e38 ]
The dtl\_access\_lock needs to be a rw\_sempahore, a sleeping lock, because
the code calls kmalloc() while holding it, which can sleep:
# echo 1 > /proc/powerpc/vcpudispatch\_stats
BUG: sleeping function called from invalid context at include/linux/sched/mm.h:337
in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 199, name: sh
preempt\_count: 1, expected: 0
3 locks held by sh/199:
#0: c00000000a0743f8 (sb\_writers#3){.+.+}-{0:0}, at: vfs\_write+0x324/0x438
#1: c0000000028c7058 (dtl\_enable\_mutex){+.+.}-{3:3}, at: vcpudispatch\_stats\_write+0xd4/0x5f4
#2: c0000000028c70b8 (dtl\_access\_lock){+.+.}-{2:2}, at: vcpudispatch\_stats\_write+0x220/0x5f4
CPU: 0 PID: 199 Comm: sh Not tainted 6.10.0-rc4 #152
Hardware name: IBM pSeries (emulated by qemu) POWER9 (raw) 0x4e1202 0xf000005 of:SLOF,HEAD hv:linux,kvm pSeries
Call Trace:
dump\_stack\_lvl+0x130/0x148 (unreliable)
\_\_might\_resched+0x174/0x410
kmem\_cache\_alloc\_noprof+0x340/0x3d0
alloc\_dtl\_buffers+0x124/0x1ac
vcpudispatch\_stats\_write+0x2a8/0x5f4
proc\_reg\_write+0xf4/0x150
vfs\_write+0xfc/0x438
ksys\_write+0x88/0x148
system\_call\_exception+0x1c4/0x5a0
system\_call\_common+0xf4/0x258
Fixes: 06220d78f24a ("powerpc/pseries: Introduce rwlock to gatekeep DTLB usage")
Tested-by: Kajol Jain <kjain@linux.ibm.com>
Reviewed-by: Nysal Jan K.A <nysal@linux.ibm.com>
Reviewed-by: Kajol Jain <kjain@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/20240819122401.513203-1-mpe@ellerman.id.au](https://patch.msgid.link/20240819122401.513203-1-mpe%40ellerman.id.au)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd)

| -rw-r--r-- | [arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/dtl.h?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/dtl.c?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/lpar.c?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 10 deletions

| diff --git a/arch/powerpc/include/asm/dtl.h b/arch/powerpc/include/asm/dtl.hindex d6f43d149f8dcb..a5c21bc623cb00 100644--- a/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=8a06435959cc182840198f6c07c8b2d1ce8a034e)+++ b/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd)@@ -1,8 +1,8 @@ #ifndef \_ASM\_POWERPC\_DTL\_H #define \_ASM\_POWERPC\_DTL\_H +#include <linux/rwsem.h> #include <asm/lppaca.h>-#include <linux/spinlock\_types.h>  /\* \* Layout of entries in the hypervisor's dispatch trace log buffer.@@ -35,7 +35,7 @@ struct dtl\_entry { #define DTL\_LOG\_ALL (DTL\_LOG\_CEDE | DTL\_LOG\_PREEMPT | DTL\_LOG\_FAULT)  extern struct kmem\_cache \*dtl\_cache;-extern rwlock\_t dtl\_access\_lock;+extern struct rw\_semaphore dtl\_access\_lock;  extern void register\_dtl\_buffer(int cpu); extern void alloc\_dtl\_buffers(unsigned long \*time\_limit);diff --git a/arch/powerpc/platforms/pseries/dtl.c b/arch/powerpc/platforms/pseries/dtl.cindex 3f1cdccebc9c15..ecc04ef8c53e31 100644--- a/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=8a06435959cc182840198f6c07c8b2d1ce8a034e)+++ b/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd)@@ -191,7 +191,7 @@ static int dtl\_enable(struct dtl \*dtl) return -EBUSY;  /\* ensure there are no other conflicting dtl users \*/- if (!read\_trylock(&dtl\_access\_lock))+ if (!down\_read\_trylock(&dtl\_access\_lock)) return -EBUSY;  n\_entries = dtl\_buf\_entries;@@ -199,7 +199,7 @@ static int dtl\_enable(struct dtl \*dtl) if (!buf) { printk(KERN\_WARNING "%s: buffer alloc failed for cpu %d\n", \_\_func\_\_, dtl->cpu);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); return -ENOMEM; } @@ -217,7 +217,7 @@ static int dtl\_enable(struct dtl \*dtl) spin\_unlock(&dtl->lock);  if (rc) {- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); kmem\_cache\_free(dtl\_cache, buf); } @@ -232,7 +232,7 @@ static void dtl\_disable(struct dtl \*dtl) dtl->buf = NULL; dtl->buf\_entries = 0; spin\_unlock(&dtl->lock);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); }  /\* file interface \*/diff --git a/arch/powerpc/platforms/pseries/lpar.c b/arch/powerpc/platforms/pseries/lpar.cindex c3585e90c6db6b..cade33aef41477 100644--- a/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=8a06435959cc182840198f6c07c8b2d1ce8a034e)+++ b/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=a246daa26b717e755ccc9061f47f7cd1c0b358dd)@@ -169,7 +169,7 @@ struct vcpu\_dispatch\_data { \*/ #define NR\_CPUS\_H NR\_CPUS -DEFINE\_RWLOCK(dtl\_access\_lock);+DECLARE\_RWSEM(dtl\_access\_lock); static DEFINE\_PER\_CPU(struct vcpu\_dispatch\_data, vcpu\_disp\_data); static DEFINE\_PER\_CPU(u64, dtl\_entry\_ridx); static DEFINE\_PER\_CPU(struct dtl\_worker, dtl\_workers);@@ -463,7 +463,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) { int rc = 0, state; - if (!write\_trylock(&dtl\_access\_lock)) {+ if (!down\_write\_trylock(&dtl\_access\_lock)) { rc = -EBUSY; goto out; }@@ -479,7 +479,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) pr\_err("vcpudispatch\_stats: unable to setup workqueue for DTL processing\n"); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); rc = -EINVAL; goto out; }@@ -494,7 +494,7 @@ static void dtl\_worker\_disable(unsigned long \*time\_limit) cpuhp\_remove\_state(dtl\_worker\_state); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); }  static ssize\_t vcpudispatch\_stats\_write(struct file \*file, const char \_\_user \*p, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:45:30 +0000



=== Content from git.kernel.org_21a15e74_20250115_084655.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2024-08-19 22:24:01 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:33 +0100 |
| commit | [b125d0cf1adde7b2b47d7337fed7e9133eea3463](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463)) | |
| tree | [364847b0513564eaf32ee46bbfae3fd04642ad33](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463) | |
| parent | [4877e9748330e86a2b3f76d9e67562c72c7b4b35](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4877e9748330e86a2b3f76d9e67562c72c7b4b35) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463&id2=4877e9748330e86a2b3f76d9e67562c72c7b4b35)) | |
| download | [linux-b125d0cf1adde7b2b47d7337fed7e9133eea3463.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b125d0cf1adde7b2b47d7337fed7e9133eea3463.tar.gz) | |

powerpc/pseries: Fix dtl\_access\_lock to be a rw\_semaphore[ Upstream commit cadae3a45d23aa4f6485938a67cbc47aaaa25e38 ]
The dtl\_access\_lock needs to be a rw\_sempahore, a sleeping lock, because
the code calls kmalloc() while holding it, which can sleep:
# echo 1 > /proc/powerpc/vcpudispatch\_stats
BUG: sleeping function called from invalid context at include/linux/sched/mm.h:337
in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 199, name: sh
preempt\_count: 1, expected: 0
3 locks held by sh/199:
#0: c00000000a0743f8 (sb\_writers#3){.+.+}-{0:0}, at: vfs\_write+0x324/0x438
#1: c0000000028c7058 (dtl\_enable\_mutex){+.+.}-{3:3}, at: vcpudispatch\_stats\_write+0xd4/0x5f4
#2: c0000000028c70b8 (dtl\_access\_lock){+.+.}-{2:2}, at: vcpudispatch\_stats\_write+0x220/0x5f4
CPU: 0 PID: 199 Comm: sh Not tainted 6.10.0-rc4 #152
Hardware name: IBM pSeries (emulated by qemu) POWER9 (raw) 0x4e1202 0xf000005 of:SLOF,HEAD hv:linux,kvm pSeries
Call Trace:
dump\_stack\_lvl+0x130/0x148 (unreliable)
\_\_might\_resched+0x174/0x410
kmem\_cache\_alloc\_noprof+0x340/0x3d0
alloc\_dtl\_buffers+0x124/0x1ac
vcpudispatch\_stats\_write+0x2a8/0x5f4
proc\_reg\_write+0xf4/0x150
vfs\_write+0xfc/0x438
ksys\_write+0x88/0x148
system\_call\_exception+0x1c4/0x5a0
system\_call\_common+0xf4/0x258
Fixes: 06220d78f24a ("powerpc/pseries: Introduce rwlock to gatekeep DTLB usage")
Tested-by: Kajol Jain <kjain@linux.ibm.com>
Reviewed-by: Nysal Jan K.A <nysal@linux.ibm.com>
Reviewed-by: Kajol Jain <kjain@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/20240819122401.513203-1-mpe@ellerman.id.au](https://patch.msgid.link/20240819122401.513203-1-mpe%40ellerman.id.au)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463)

| -rw-r--r-- | [arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/dtl.h?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/dtl.c?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/lpar.c?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 10 deletions

| diff --git a/arch/powerpc/include/asm/dtl.h b/arch/powerpc/include/asm/dtl.hindex d6f43d149f8dcb..a5c21bc623cb00 100644--- a/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=4877e9748330e86a2b3f76d9e67562c72c7b4b35)+++ b/[arch/powerpc/include/asm/dtl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/dtl.h?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463)@@ -1,8 +1,8 @@ #ifndef \_ASM\_POWERPC\_DTL\_H #define \_ASM\_POWERPC\_DTL\_H +#include <linux/rwsem.h> #include <asm/lppaca.h>-#include <linux/spinlock\_types.h>  /\* \* Layout of entries in the hypervisor's dispatch trace log buffer.@@ -35,7 +35,7 @@ struct dtl\_entry { #define DTL\_LOG\_ALL (DTL\_LOG\_CEDE | DTL\_LOG\_PREEMPT | DTL\_LOG\_FAULT)  extern struct kmem\_cache \*dtl\_cache;-extern rwlock\_t dtl\_access\_lock;+extern struct rw\_semaphore dtl\_access\_lock;  extern void register\_dtl\_buffer(int cpu); extern void alloc\_dtl\_buffers(unsigned long \*time\_limit);diff --git a/arch/powerpc/platforms/pseries/dtl.c b/arch/powerpc/platforms/pseries/dtl.cindex 3f1cdccebc9c15..ecc04ef8c53e31 100644--- a/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=4877e9748330e86a2b3f76d9e67562c72c7b4b35)+++ b/[arch/powerpc/platforms/pseries/dtl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/dtl.c?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463)@@ -191,7 +191,7 @@ static int dtl\_enable(struct dtl \*dtl) return -EBUSY;  /\* ensure there are no other conflicting dtl users \*/- if (!read\_trylock(&dtl\_access\_lock))+ if (!down\_read\_trylock(&dtl\_access\_lock)) return -EBUSY;  n\_entries = dtl\_buf\_entries;@@ -199,7 +199,7 @@ static int dtl\_enable(struct dtl \*dtl) if (!buf) { printk(KERN\_WARNING "%s: buffer alloc failed for cpu %d\n", \_\_func\_\_, dtl->cpu);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); return -ENOMEM; } @@ -217,7 +217,7 @@ static int dtl\_enable(struct dtl \*dtl) spin\_unlock(&dtl->lock);  if (rc) {- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); kmem\_cache\_free(dtl\_cache, buf); } @@ -232,7 +232,7 @@ static void dtl\_disable(struct dtl \*dtl) dtl->buf = NULL; dtl->buf\_entries = 0; spin\_unlock(&dtl->lock);- read\_unlock(&dtl\_access\_lock);+ up\_read(&dtl\_access\_lock); }  /\* file interface \*/diff --git a/arch/powerpc/platforms/pseries/lpar.c b/arch/powerpc/platforms/pseries/lpar.cindex c1d8bee8f7018c..bb09990eec309a 100644--- a/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=4877e9748330e86a2b3f76d9e67562c72c7b4b35)+++ b/[arch/powerpc/platforms/pseries/lpar.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/lpar.c?id=b125d0cf1adde7b2b47d7337fed7e9133eea3463)@@ -169,7 +169,7 @@ struct vcpu\_dispatch\_data { \*/ #define NR\_CPUS\_H NR\_CPUS -DEFINE\_RWLOCK(dtl\_access\_lock);+DECLARE\_RWSEM(dtl\_access\_lock); static DEFINE\_PER\_CPU(struct vcpu\_dispatch\_data, vcpu\_disp\_data); static DEFINE\_PER\_CPU(u64, dtl\_entry\_ridx); static DEFINE\_PER\_CPU(struct dtl\_worker, dtl\_workers);@@ -463,7 +463,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) { int rc = 0, state; - if (!write\_trylock(&dtl\_access\_lock)) {+ if (!down\_write\_trylock(&dtl\_access\_lock)) { rc = -EBUSY; goto out; }@@ -479,7 +479,7 @@ static int dtl\_worker\_enable(unsigned long \*time\_limit) pr\_err("vcpudispatch\_stats: unable to setup workqueue for DTL processing\n"); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); rc = -EINVAL; goto out; }@@ -494,7 +494,7 @@ static void dtl\_worker\_disable(unsigned long \*time\_limit) cpuhp\_remove\_state(dtl\_worker\_state); free\_dtl\_buffers(time\_limit); reset\_global\_dtl\_mask();- write\_unlock(&dtl\_access\_lock);+ up\_write(&dtl\_access\_lock); }  static ssize\_t vcpudispatch\_stats\_write(struct file \*file, const char \_\_user \*p, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:45:31 +0000


