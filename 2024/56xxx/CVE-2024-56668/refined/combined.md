=== Content from git.kernel.org_cbb13a78_20250115_100222.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yi Liu <yi.l.liu@intel.com> | 2024-12-13 09:17:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:13:06 +0100 |
| commit | [ffd774c34774fd4cc0e9cf2976595623a6c3a077](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077)) | |
| tree | [ed1422db80ec7ec5af84c8b2ae39eef18d22f0a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077) | |
| parent | [9a0a72d3ed919ebe6491f527630998be053151d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a0a72d3ed919ebe6491f527630998be053151d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077&id2=9a0a72d3ed919ebe6491f527630998be053151d8)) | |
| download | [linux-ffd774c34774fd4cc0e9cf2976595623a6c3a077.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ffd774c34774fd4cc0e9cf2976595623a6c3a077.tar.gz) | |

iommu/vt-d: Fix qi\_batch NULL pointer with nested parent domaincommit 74536f91962d5f6af0a42414773ce61e653c10ee upstream.
The qi\_batch is allocated when assigning cache tag for a domain. While
for nested parent domain, it is missed. Hence, when trying to map pages
to the nested parent, NULL dereference occurred. Also, there is potential
memleak since there is no lock around domain->qi\_batch allocation.
To solve it, add a helper for qi\_batch allocation, and call it in both
the \_\_cache\_tag\_assign\_domain() and \_\_cache\_tag\_assign\_parent\_domain().
BUG: kernel NULL pointer dereference, address: 0000000000000200
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 8104795067 P4D 0
Oops: Oops: 0000 [#1] PREEMPT SMP NOPTI
CPU: 223 UID: 0 PID: 4357 Comm: qemu-system-x86 Not tainted 6.13.0-rc1-00028-g4b50c3c3b998-dirty #2632
Call Trace:
? \_\_die+0x24/0x70
? page\_fault\_oops+0x80/0x150
? do\_user\_addr\_fault+0x63/0x7b0
? exc\_page\_fault+0x7c/0x220
? asm\_exc\_page\_fault+0x26/0x30
? cache\_tag\_flush\_range\_np+0x13c/0x260
intel\_iommu\_iotlb\_sync\_map+0x1a/0x30
iommu\_map+0x61/0xf0
batch\_to\_domain+0x188/0x250
iopt\_area\_fill\_domains+0x125/0x320
? rcu\_is\_watching+0x11/0x50
iopt\_map\_pages+0x63/0x100
iopt\_map\_common.isra.0+0xa7/0x190
iopt\_map\_user\_pages+0x6a/0x80
iommufd\_ioas\_map+0xcd/0x1d0
iommufd\_fops\_ioctl+0x118/0x1c0
\_\_x64\_sys\_ioctl+0x93/0xc0
do\_syscall\_64+0x71/0x140
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 705c1cdf1e73 ("iommu/vt-d: Introduce batched cache invalidation")
Cc: stable@vger.kernel.org
Co-developed-by: Lu Baolu <baolu.lu@linux.intel.com>
Signed-off-by: Lu Baolu <baolu.lu@linux.intel.com>
Signed-off-by: Yi Liu <yi.l.liu@intel.com>
Reviewed-by: Kevin Tian <kevin.tian@intel.com>
Link: [https://lore.kernel.org/r/20241210130322.17175-1-yi.l.liu@intel.com](https://lore.kernel.org/r/20241210130322.17175-1-yi.l.liu%40intel.com)
Signed-off-by: Joerg Roedel <jroedel@suse.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077)

| -rw-r--r-- | [drivers/iommu/intel/cache.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/intel/cache.c?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 27 insertions, 7 deletions

| diff --git a/drivers/iommu/intel/cache.c b/drivers/iommu/intel/cache.cindex e5b89f728ad3b2..09694cca8752df 100644--- a/[drivers/iommu/intel/cache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/cache.c?id=9a0a72d3ed919ebe6491f527630998be053151d8)+++ b/[drivers/iommu/intel/cache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/cache.c?id=ffd774c34774fd4cc0e9cf2976595623a6c3a077)@@ -105,12 +105,35 @@ static void cache\_tag\_unassign(struct dmar\_domain \*domain, u16 did, spin\_unlock\_irqrestore(&domain->cache\_lock, flags); } +/\* domain->qi\_batch will be freed in iommu\_free\_domain() path. \*/+static int domain\_qi\_batch\_alloc(struct dmar\_domain \*domain)+{+ unsigned long flags;+ int ret = 0;++ spin\_lock\_irqsave(&domain->cache\_lock, flags);+ if (domain->qi\_batch)+ goto out\_unlock;++ domain->qi\_batch = kzalloc(sizeof(\*domain->qi\_batch), GFP\_ATOMIC);+ if (!domain->qi\_batch)+ ret = -ENOMEM;+out\_unlock:+ spin\_unlock\_irqrestore(&domain->cache\_lock, flags);++ return ret;+}+ static int \_\_cache\_tag\_assign\_domain(struct dmar\_domain \*domain, u16 did, struct device \*dev, ioasid\_t pasid) { struct device\_domain\_info \*info = dev\_iommu\_priv\_get(dev); int ret; + ret = domain\_qi\_batch\_alloc(domain);+ if (ret)+ return ret;+ ret = cache\_tag\_assign(domain, did, dev, pasid, CACHE\_TAG\_IOTLB); if (ret || !info->ats\_enabled) return ret;@@ -139,6 +162,10 @@ static int \_\_cache\_tag\_assign\_parent\_domain(struct dmar\_domain \*domain, u16 did, struct device\_domain\_info \*info = dev\_iommu\_priv\_get(dev); int ret; + ret = domain\_qi\_batch\_alloc(domain);+ if (ret)+ return ret;+ ret = cache\_tag\_assign(domain, did, dev, pasid, CACHE\_TAG\_NESTING\_IOTLB); if (ret || !info->ats\_enabled) return ret;@@ -190,13 +217,6 @@ int cache\_tag\_assign\_domain(struct dmar\_domain \*domain, u16 did = domain\_get\_id\_for\_dev(domain, dev); int ret; - /\* domain->qi\_bach will be freed in iommu\_free\_domain() path. \*/- if (!domain->qi\_batch) {- domain->qi\_batch = kzalloc(sizeof(\*domain->qi\_batch), GFP\_KERNEL);- if (!domain->qi\_batch)- return -ENOMEM;- }- ret = \_\_cache\_tag\_assign\_domain(domain, did, dev, pasid); if (ret || domain->domain.type != IOMMU\_DOMAIN\_NESTED) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:00:59 +0000



=== Content from git.kernel.org_cb8adfa3_20250115_100221.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=74536f91962d5f6af0a42414773ce61e653c10ee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=74536f91962d5f6af0a42414773ce61e653c10ee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74536f91962d5f6af0a42414773ce61e653c10ee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74536f91962d5f6af0a42414773ce61e653c10ee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yi Liu <yi.l.liu@intel.com> | 2024-12-13 09:17:51 +0800 |
| --- | --- | --- |
| committer | Joerg Roedel <jroedel@suse.de> | 2024-12-13 15:54:25 +0100 |
| commit | [74536f91962d5f6af0a42414773ce61e653c10ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74536f91962d5f6af0a42414773ce61e653c10ee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=74536f91962d5f6af0a42414773ce61e653c10ee)) | |
| tree | [c1bd48110d02123d2087653545c87fab414a6c7b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=74536f91962d5f6af0a42414773ce61e653c10ee) | |
| parent | [1f2557e08a617a4b5e92a48a1a9a6f86621def18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f2557e08a617a4b5e92a48a1a9a6f86621def18) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74536f91962d5f6af0a42414773ce61e653c10ee&id2=1f2557e08a617a4b5e92a48a1a9a6f86621def18)) | |
| download | [linux-74536f91962d5f6af0a42414773ce61e653c10ee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-74536f91962d5f6af0a42414773ce61e653c10ee.tar.gz) | |

iommu/vt-d: Fix qi\_batch NULL pointer with nested parent domainThe qi\_batch is allocated when assigning cache tag for a domain. While
for nested parent domain, it is missed. Hence, when trying to map pages
to the nested parent, NULL dereference occurred. Also, there is potential
memleak since there is no lock around domain->qi\_batch allocation.
To solve it, add a helper for qi\_batch allocation, and call it in both
the \_\_cache\_tag\_assign\_domain() and \_\_cache\_tag\_assign\_parent\_domain().
BUG: kernel NULL pointer dereference, address: 0000000000000200
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 8104795067 P4D 0
Oops: Oops: 0000 [#1] PREEMPT SMP NOPTI
CPU: 223 UID: 0 PID: 4357 Comm: qemu-system-x86 Not tainted 6.13.0-rc1-00028-g4b50c3c3b998-dirty #2632
Call Trace:
? \_\_die+0x24/0x70
? page\_fault\_oops+0x80/0x150
? do\_user\_addr\_fault+0x63/0x7b0
? exc\_page\_fault+0x7c/0x220
? asm\_exc\_page\_fault+0x26/0x30
? cache\_tag\_flush\_range\_np+0x13c/0x260
intel\_iommu\_iotlb\_sync\_map+0x1a/0x30
iommu\_map+0x61/0xf0
batch\_to\_domain+0x188/0x250
iopt\_area\_fill\_domains+0x125/0x320
? rcu\_is\_watching+0x11/0x50
iopt\_map\_pages+0x63/0x100
iopt\_map\_common.isra.0+0xa7/0x190
iopt\_map\_user\_pages+0x6a/0x80
iommufd\_ioas\_map+0xcd/0x1d0
iommufd\_fops\_ioctl+0x118/0x1c0
\_\_x64\_sys\_ioctl+0x93/0xc0
do\_syscall\_64+0x71/0x140
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 705c1cdf1e73 ("iommu/vt-d: Introduce batched cache invalidation")
Cc: stable@vger.kernel.org
Co-developed-by: Lu Baolu <baolu.lu@linux.intel.com>
Signed-off-by: Lu Baolu <baolu.lu@linux.intel.com>
Signed-off-by: Yi Liu <yi.l.liu@intel.com>
Reviewed-by: Kevin Tian <kevin.tian@intel.com>
Link: [https://lore.kernel.org/r/20241210130322.17175-1-yi.l.liu@intel.com](https://lore.kernel.org/r/20241210130322.17175-1-yi.l.liu%40intel.com)
Signed-off-by: Joerg Roedel <jroedel@suse.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74536f91962d5f6af0a42414773ce61e653c10ee)

| -rw-r--r-- | [drivers/iommu/intel/cache.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/intel/cache.c?id=74536f91962d5f6af0a42414773ce61e653c10ee) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 27 insertions, 7 deletions

| diff --git a/drivers/iommu/intel/cache.c b/drivers/iommu/intel/cache.cindex e5b89f728ad3b2..09694cca8752df 100644--- a/[drivers/iommu/intel/cache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/cache.c?id=1f2557e08a617a4b5e92a48a1a9a6f86621def18)+++ b/[drivers/iommu/intel/cache.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/cache.c?id=74536f91962d5f6af0a42414773ce61e653c10ee)@@ -105,12 +105,35 @@ static void cache\_tag\_unassign(struct dmar\_domain \*domain, u16 did, spin\_unlock\_irqrestore(&domain->cache\_lock, flags); } +/\* domain->qi\_batch will be freed in iommu\_free\_domain() path. \*/+static int domain\_qi\_batch\_alloc(struct dmar\_domain \*domain)+{+ unsigned long flags;+ int ret = 0;++ spin\_lock\_irqsave(&domain->cache\_lock, flags);+ if (domain->qi\_batch)+ goto out\_unlock;++ domain->qi\_batch = kzalloc(sizeof(\*domain->qi\_batch), GFP\_ATOMIC);+ if (!domain->qi\_batch)+ ret = -ENOMEM;+out\_unlock:+ spin\_unlock\_irqrestore(&domain->cache\_lock, flags);++ return ret;+}+ static int \_\_cache\_tag\_assign\_domain(struct dmar\_domain \*domain, u16 did, struct device \*dev, ioasid\_t pasid) { struct device\_domain\_info \*info = dev\_iommu\_priv\_get(dev); int ret; + ret = domain\_qi\_batch\_alloc(domain);+ if (ret)+ return ret;+ ret = cache\_tag\_assign(domain, did, dev, pasid, CACHE\_TAG\_IOTLB); if (ret || !info->ats\_enabled) return ret;@@ -139,6 +162,10 @@ static int \_\_cache\_tag\_assign\_parent\_domain(struct dmar\_domain \*domain, u16 did, struct device\_domain\_info \*info = dev\_iommu\_priv\_get(dev); int ret; + ret = domain\_qi\_batch\_alloc(domain);+ if (ret)+ return ret;+ ret = cache\_tag\_assign(domain, did, dev, pasid, CACHE\_TAG\_NESTING\_IOTLB); if (ret || !info->ats\_enabled) return ret;@@ -190,13 +217,6 @@ int cache\_tag\_assign\_domain(struct dmar\_domain \*domain, u16 did = domain\_get\_id\_for\_dev(domain, dev); int ret; - /\* domain->qi\_bach will be freed in iommu\_free\_domain() path. \*/- if (!domain->qi\_batch) {- domain->qi\_batch = kzalloc(sizeof(\*domain->qi\_batch), GFP\_KERNEL);- if (!domain->qi\_batch)- return -ENOMEM;- }- ret = \_\_cache\_tag\_assign\_domain(domain, did, dev, pasid); if (ret || domain->domain.type != IOMMU\_DOMAIN\_NESTED) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:00:57 +0000


