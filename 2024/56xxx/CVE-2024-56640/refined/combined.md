=== Content from git.kernel.org_5e2373dd_20250114_213236.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wen Gu <guwen@linux.alibaba.com> | 2024-11-27 21:30:14 +0800 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-12-03 10:42:29 +0100 |
| commit | [2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7)) | |
| tree | [104093f0859144aa2b2c8fb882af5b041cf6a95e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7) | |
| parent | [0541db8ee32c09463a72d0987382b3a3336b0043](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0541db8ee32c09463a72d0987382b3a3336b0043) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7&id2=0541db8ee32c09463a72d0987382b3a3336b0043)) | |
| download | [linux-2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7.tar.gz) | |

net/smc: fix LGR and link use-after-free issueWe encountered a LGR/link use-after-free issue, which manifested as
the LGR/link refcnt reaching 0 early and entering the clear process,
making resource access unsafe.
refcount\_t: addition on 0; use-after-free.
WARNING: CPU: 14 PID: 107447 at lib/refcount.c:25 refcount\_warn\_saturate+0x9c/0x140
Workqueue: events smc\_lgr\_terminate\_work [smc]
Call trace:
refcount\_warn\_saturate+0x9c/0x140
\_\_smc\_lgr\_terminate.part.45+0x2a8/0x370 [smc]
smc\_lgr\_terminate\_work+0x28/0x30 [smc]
process\_one\_work+0x1b8/0x420
worker\_thread+0x158/0x510
kthread+0x114/0x118
or
refcount\_t: underflow; use-after-free.
WARNING: CPU: 6 PID: 93140 at lib/refcount.c:28 refcount\_warn\_saturate+0xf0/0x140
Workqueue: smc\_hs\_wq smc\_listen\_work [smc]
Call trace:
refcount\_warn\_saturate+0xf0/0x140
smcr\_link\_put+0x1cc/0x1d8 [smc]
smc\_conn\_free+0x110/0x1b0 [smc]
smc\_conn\_abort+0x50/0x60 [smc]
smc\_listen\_find\_device+0x75c/0x790 [smc]
smc\_listen\_work+0x368/0x8a0 [smc]
process\_one\_work+0x1b8/0x420
worker\_thread+0x158/0x510
kthread+0x114/0x118
It is caused by repeated release of LGR/link refcnt. One suspect is that
smc\_conn\_free() is called repeatedly because some smc\_conn\_free() from
server listening path are not protected by sock lock.
e.g.
Calls under socklock | smc\_listen\_work
-------------------------------------------------------
lock\_sock(sk) | smc\_conn\_abort
smc\_conn\_free | \- smc\_conn\_free
\- smcr\_link\_put | \- smcr\_link\_put (duplicated)
release\_sock(sk)
So here add sock lock protection in smc\_listen\_work() path, making it
exclusive with other connection operations.
Fixes: 3b2dec2603d5 ("net/smc: restructure client and server code in af\_smc")
Co-developed-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Signed-off-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Co-developed-by: Kai <KaiShen@linux.alibaba.com>
Signed-off-by: Kai <KaiShen@linux.alibaba.com>
Signed-off-by: Wen Gu <guwen@linux.alibaba.com>
Reviewed-by: Wenjia Zhang <wenjia@linux.ibm.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7)

| -rw-r--r-- | [net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/af_smc.c?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/net/smc/af\_smc.c b/net/smc/af\_smc.cindex ed6d4d520bc7a0..9e6c69d18581ce 100644--- a/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=0541db8ee32c09463a72d0987382b3a3336b0043)+++ b/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7)@@ -1900,6 +1900,7 @@ static void smc\_listen\_out(struct smc\_sock \*new\_smc) if (tcp\_sk(new\_smc->clcsock->sk)->syn\_smc) atomic\_dec(&lsmc->queued\_smc\_hs); + release\_sock(newsmcsk); /\* lock in smc\_listen\_work() \*/ if (lsmc->sk.sk\_state == SMC\_LISTEN) { lock\_sock\_nested(&lsmc->sk, SINGLE\_DEPTH\_NESTING); smc\_accept\_enqueue(&lsmc->sk, newsmcsk);@@ -2421,6 +2422,7 @@ static void smc\_listen\_work(struct work\_struct \*work) u8 accept\_version; int rc = 0; + lock\_sock(&new\_smc->sk); /\* release in smc\_listen\_out() \*/ if (new\_smc->listen\_smc->sk.sk\_state != SMC\_LISTEN) return smc\_listen\_out\_err(new\_smc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:31:13 +0000



=== Content from git.kernel.org_81d93c5c_20250114_213242.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f502a88fdd415647a1f2dc45fac71b9c522a052b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f502a88fdd415647a1f2dc45fac71b9c522a052b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f502a88fdd415647a1f2dc45fac71b9c522a052b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f502a88fdd415647a1f2dc45fac71b9c522a052b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wen Gu <guwen@linux.alibaba.com> | 2024-11-27 21:30:14 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:27 +0100 |
| commit | [f502a88fdd415647a1f2dc45fac71b9c522a052b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f502a88fdd415647a1f2dc45fac71b9c522a052b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f502a88fdd415647a1f2dc45fac71b9c522a052b)) | |
| tree | [9f3bf8006f54107fd343dafd67b2a27afd30a2c1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f502a88fdd415647a1f2dc45fac71b9c522a052b) | |
| parent | [ebfee3e153f67c8b38eb94a7062ee94aa6f92708](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebfee3e153f67c8b38eb94a7062ee94aa6f92708) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f502a88fdd415647a1f2dc45fac71b9c522a052b&id2=ebfee3e153f67c8b38eb94a7062ee94aa6f92708)) | |
| download | [linux-f502a88fdd415647a1f2dc45fac71b9c522a052b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f502a88fdd415647a1f2dc45fac71b9c522a052b.tar.gz) | |

net/smc: fix LGR and link use-after-free issue[ Upstream commit 2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7 ]
We encountered a LGR/link use-after-free issue, which manifested as
the LGR/link refcnt reaching 0 early and entering the clear process,
making resource access unsafe.
refcount\_t: addition on 0; use-after-free.
WARNING: CPU: 14 PID: 107447 at lib/refcount.c:25 refcount\_warn\_saturate+0x9c/0x140
Workqueue: events smc\_lgr\_terminate\_work [smc]
Call trace:
refcount\_warn\_saturate+0x9c/0x140
\_\_smc\_lgr\_terminate.part.45+0x2a8/0x370 [smc]
smc\_lgr\_terminate\_work+0x28/0x30 [smc]
process\_one\_work+0x1b8/0x420
worker\_thread+0x158/0x510
kthread+0x114/0x118
or
refcount\_t: underflow; use-after-free.
WARNING: CPU: 6 PID: 93140 at lib/refcount.c:28 refcount\_warn\_saturate+0xf0/0x140
Workqueue: smc\_hs\_wq smc\_listen\_work [smc]
Call trace:
refcount\_warn\_saturate+0xf0/0x140
smcr\_link\_put+0x1cc/0x1d8 [smc]
smc\_conn\_free+0x110/0x1b0 [smc]
smc\_conn\_abort+0x50/0x60 [smc]
smc\_listen\_find\_device+0x75c/0x790 [smc]
smc\_listen\_work+0x368/0x8a0 [smc]
process\_one\_work+0x1b8/0x420
worker\_thread+0x158/0x510
kthread+0x114/0x118
It is caused by repeated release of LGR/link refcnt. One suspect is that
smc\_conn\_free() is called repeatedly because some smc\_conn\_free() from
server listening path are not protected by sock lock.
e.g.
Calls under socklock | smc\_listen\_work
-------------------------------------------------------
lock\_sock(sk) | smc\_conn\_abort
smc\_conn\_free | \- smc\_conn\_free
\- smcr\_link\_put | \- smcr\_link\_put (duplicated)
release\_sock(sk)
So here add sock lock protection in smc\_listen\_work() path, making it
exclusive with other connection operations.
Fixes: 3b2dec2603d5 ("net/smc: restructure client and server code in af\_smc")
Co-developed-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Signed-off-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Co-developed-by: Kai <KaiShen@linux.alibaba.com>
Signed-off-by: Kai <KaiShen@linux.alibaba.com>
Signed-off-by: Wen Gu <guwen@linux.alibaba.com>
Reviewed-by: Wenjia Zhang <wenjia@linux.ibm.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f502a88fdd415647a1f2dc45fac71b9c522a052b)

| -rw-r--r-- | [net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/af_smc.c?id=f502a88fdd415647a1f2dc45fac71b9c522a052b) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/net/smc/af\_smc.c b/net/smc/af\_smc.cindex d433b88e6a2771..1072b32a1d75da 100644--- a/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=ebfee3e153f67c8b38eb94a7062ee94aa6f92708)+++ b/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=f502a88fdd415647a1f2dc45fac71b9c522a052b)@@ -1509,6 +1509,7 @@ static void smc\_listen\_out(struct smc\_sock \*new\_smc) if (tcp\_sk(new\_smc->clcsock->sk)->syn\_smc) atomic\_dec(&lsmc->queued\_smc\_hs); + release\_sock(newsmcsk); /\* lock in smc\_listen\_work() \*/ if (lsmc->sk.sk\_state == SMC\_LISTEN) { lock\_sock\_nested(&lsmc->sk, SINGLE\_DEPTH\_NESTING); smc\_accept\_enqueue(&lsmc->sk, newsmcsk);@@ -1921,6 +1922,7 @@ static void smc\_listen\_work(struct work\_struct \*work) struct smc\_init\_info \*ini = NULL; int rc = 0; + lock\_sock(&new\_smc->sk); /\* release in smc\_listen\_out() \*/ if (new\_smc->listen\_smc->sk.sk\_state != SMC\_LISTEN) return smc\_listen\_out\_err(new\_smc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:31:18 +0000



=== Content from git.kernel.org_84fd91e9_20250114_213239.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6f0ae06a234a78ae137064f2c89135ac078a00eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6f0ae06a234a78ae137064f2c89135ac078a00eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f0ae06a234a78ae137064f2c89135ac078a00eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f0ae06a234a78ae137064f2c89135ac078a00eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wen Gu <guwen@linux.alibaba.com> | 2024-11-27 21:30:14 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:05 +0100 |
| commit | [6f0ae06a234a78ae137064f2c89135ac078a00eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f0ae06a234a78ae137064f2c89135ac078a00eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6f0ae06a234a78ae137064f2c89135ac078a00eb)) | |
| tree | [c47280df7107aac03539c676c5d84ccbf198604b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6f0ae06a234a78ae137064f2c89135ac078a00eb) | |
| parent | [6638e52dcfafaf1b9cbc34544f0c832db0069ea1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6638e52dcfafaf1b9cbc34544f0c832db0069ea1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f0ae06a234a78ae137064f2c89135ac078a00eb&id2=6638e52dcfafaf1b9cbc34544f0c832db0069ea1)) | |
| download | [linux-6f0ae06a234a78ae137064f2c89135ac078a00eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6f0ae06a234a78ae137064f2c89135ac078a00eb.tar.gz) | |

net/smc: fix LGR and link use-after-free issue[ Upstream commit 2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7 ]
We encountered a LGR/link use-after-free issue, which manifested as
the LGR/link refcnt reaching 0 early and entering the clear process,
making resource access unsafe.
refcount\_t: addition on 0; use-after-free.
WARNING: CPU: 14 PID: 107447 at lib/refcount.c:25 refcount\_warn\_saturate+0x9c/0x140
Workqueue: events smc\_lgr\_terminate\_work [smc]
Call trace:
refcount\_warn\_saturate+0x9c/0x140
\_\_smc\_lgr\_terminate.part.45+0x2a8/0x370 [smc]
smc\_lgr\_terminate\_work+0x28/0x30 [smc]
process\_one\_work+0x1b8/0x420
worker\_thread+0x158/0x510
kthread+0x114/0x118
or
refcount\_t: underflow; use-after-free.
WARNING: CPU: 6 PID: 93140 at lib/refcount.c:28 refcount\_warn\_saturate+0xf0/0x140
Workqueue: smc\_hs\_wq smc\_listen\_work [smc]
Call trace:
refcount\_warn\_saturate+0xf0/0x140
smcr\_link\_put+0x1cc/0x1d8 [smc]
smc\_conn\_free+0x110/0x1b0 [smc]
smc\_conn\_abort+0x50/0x60 [smc]
smc\_listen\_find\_device+0x75c/0x790 [smc]
smc\_listen\_work+0x368/0x8a0 [smc]
process\_one\_work+0x1b8/0x420
worker\_thread+0x158/0x510
kthread+0x114/0x118
It is caused by repeated release of LGR/link refcnt. One suspect is that
smc\_conn\_free() is called repeatedly because some smc\_conn\_free() from
server listening path are not protected by sock lock.
e.g.
Calls under socklock | smc\_listen\_work
-------------------------------------------------------
lock\_sock(sk) | smc\_conn\_abort
smc\_conn\_free | \- smc\_conn\_free
\- smcr\_link\_put | \- smcr\_link\_put (duplicated)
release\_sock(sk)
So here add sock lock protection in smc\_listen\_work() path, making it
exclusive with other connection operations.
Fixes: 3b2dec2603d5 ("net/smc: restructure client and server code in af\_smc")
Co-developed-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Signed-off-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Co-developed-by: Kai <KaiShen@linux.alibaba.com>
Signed-off-by: Kai <KaiShen@linux.alibaba.com>
Signed-off-by: Wen Gu <guwen@linux.alibaba.com>
Reviewed-by: Wenjia Zhang <wenjia@linux.ibm.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f0ae06a234a78ae137064f2c89135ac078a00eb)

| -rw-r--r-- | [net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/af_smc.c?id=6f0ae06a234a78ae137064f2c89135ac078a00eb) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/net/smc/af\_smc.c b/net/smc/af\_smc.cindex ed6d4d520bc7a0..9e6c69d18581ce 100644--- a/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=6638e52dcfafaf1b9cbc34544f0c832db0069ea1)+++ b/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=6f0ae06a234a78ae137064f2c89135ac078a00eb)@@ -1900,6 +1900,7 @@ static void smc\_listen\_out(struct smc\_sock \*new\_smc) if (tcp\_sk(new\_smc->clcsock->sk)->syn\_smc) atomic\_dec(&lsmc->queued\_smc\_hs); + release\_sock(newsmcsk); /\* lock in smc\_listen\_work() \*/ if (lsmc->sk.sk\_state == SMC\_LISTEN) { lock\_sock\_nested(&lsmc->sk, SINGLE\_DEPTH\_NESTING); smc\_accept\_enqueue(&lsmc->sk, newsmcsk);@@ -2421,6 +2422,7 @@ static void smc\_listen\_work(struct work\_struct \*work) u8 accept\_version; int rc = 0; + lock\_sock(&new\_smc->sk); /\* release in smc\_listen\_out() \*/ if (new\_smc->listen\_smc->sk.sk\_state != SMC\_LISTEN) return smc\_listen\_out\_err(new\_smc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:31:16 +0000



=== Content from git.kernel.org_41a94ead_20250114_213235.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0cf598548a6c36d90681d53c6b77d52363f2f295)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0cf598548a6c36d90681d53c6b77d52363f2f295)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0cf598548a6c36d90681d53c6b77d52363f2f295)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0cf598548a6c36d90681d53c6b77d52363f2f295)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wen Gu <guwen@linux.alibaba.com> | 2024-11-27 21:30:14 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:22 +0100 |
| commit | [0cf598548a6c36d90681d53c6b77d52363f2f295](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0cf598548a6c36d90681d53c6b77d52363f2f295) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0cf598548a6c36d90681d53c6b77d52363f2f295)) | |
| tree | [783c31e117f19373fab38df70f8bd028383bb0f7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0cf598548a6c36d90681d53c6b77d52363f2f295) | |
| parent | [d62d5180c036eeac09f80660edc7a602b369125f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d62d5180c036eeac09f80660edc7a602b369125f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0cf598548a6c36d90681d53c6b77d52363f2f295&id2=d62d5180c036eeac09f80660edc7a602b369125f)) | |
| download | [linux-0cf598548a6c36d90681d53c6b77d52363f2f295.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0cf598548a6c36d90681d53c6b77d52363f2f295.tar.gz) | |

net/smc: fix LGR and link use-after-free issue[ Upstream commit 2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7 ]
We encountered a LGR/link use-after-free issue, which manifested as
the LGR/link refcnt reaching 0 early and entering the clear process,
making resource access unsafe.
refcount\_t: addition on 0; use-after-free.
WARNING: CPU: 14 PID: 107447 at lib/refcount.c:25 refcount\_warn\_saturate+0x9c/0x140
Workqueue: events smc\_lgr\_terminate\_work [smc]
Call trace:
refcount\_warn\_saturate+0x9c/0x140
\_\_smc\_lgr\_terminate.part.45+0x2a8/0x370 [smc]
smc\_lgr\_terminate\_work+0x28/0x30 [smc]
process\_one\_work+0x1b8/0x420
worker\_thread+0x158/0x510
kthread+0x114/0x118
or
refcount\_t: underflow; use-after-free.
WARNING: CPU: 6 PID: 93140 at lib/refcount.c:28 refcount\_warn\_saturate+0xf0/0x140
Workqueue: smc\_hs\_wq smc\_listen\_work [smc]
Call trace:
refcount\_warn\_saturate+0xf0/0x140
smcr\_link\_put+0x1cc/0x1d8 [smc]
smc\_conn\_free+0x110/0x1b0 [smc]
smc\_conn\_abort+0x50/0x60 [smc]
smc\_listen\_find\_device+0x75c/0x790 [smc]
smc\_listen\_work+0x368/0x8a0 [smc]
process\_one\_work+0x1b8/0x420
worker\_thread+0x158/0x510
kthread+0x114/0x118
It is caused by repeated release of LGR/link refcnt. One suspect is that
smc\_conn\_free() is called repeatedly because some smc\_conn\_free() from
server listening path are not protected by sock lock.
e.g.
Calls under socklock | smc\_listen\_work
-------------------------------------------------------
lock\_sock(sk) | smc\_conn\_abort
smc\_conn\_free | \- smc\_conn\_free
\- smcr\_link\_put | \- smcr\_link\_put (duplicated)
release\_sock(sk)
So here add sock lock protection in smc\_listen\_work() path, making it
exclusive with other connection operations.
Fixes: 3b2dec2603d5 ("net/smc: restructure client and server code in af\_smc")
Co-developed-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Signed-off-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Co-developed-by: Kai <KaiShen@linux.alibaba.com>
Signed-off-by: Kai <KaiShen@linux.alibaba.com>
Signed-off-by: Wen Gu <guwen@linux.alibaba.com>
Reviewed-by: Wenjia Zhang <wenjia@linux.ibm.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0cf598548a6c36d90681d53c6b77d52363f2f295)

| -rw-r--r-- | [net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/af_smc.c?id=0cf598548a6c36d90681d53c6b77d52363f2f295) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/net/smc/af\_smc.c b/net/smc/af\_smc.cindex e86db21fef6e5e..868e722aef064e 100644--- a/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=d62d5180c036eeac09f80660edc7a602b369125f)+++ b/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=0cf598548a6c36d90681d53c6b77d52363f2f295)@@ -1860,6 +1860,7 @@ static void smc\_listen\_out(struct smc\_sock \*new\_smc) if (tcp\_sk(new\_smc->clcsock->sk)->syn\_smc) atomic\_dec(&lsmc->queued\_smc\_hs); + release\_sock(newsmcsk); /\* lock in smc\_listen\_work() \*/ if (lsmc->sk.sk\_state == SMC\_LISTEN) { lock\_sock\_nested(&lsmc->sk, SINGLE\_DEPTH\_NESTING); smc\_accept\_enqueue(&lsmc->sk, newsmcsk);@@ -2352,6 +2353,7 @@ static void smc\_listen\_work(struct work\_struct \*work) u8 accept\_version; int rc = 0; + lock\_sock(&new\_smc->sk); /\* release in smc\_listen\_out() \*/ if (new\_smc->listen\_smc->sk.sk\_state != SMC\_LISTEN) return smc\_listen\_out\_err(new\_smc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:31:12 +0000



=== Content from git.kernel.org_d85365b3_20250114_213238.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=673d606683ac70bc074ca6676b938bff18635226)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=673d606683ac70bc074ca6676b938bff18635226)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=673d606683ac70bc074ca6676b938bff18635226)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=673d606683ac70bc074ca6676b938bff18635226)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wen Gu <guwen@linux.alibaba.com> | 2024-11-27 21:30:14 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:37 +0100 |
| commit | [673d606683ac70bc074ca6676b938bff18635226](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=673d606683ac70bc074ca6676b938bff18635226) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=673d606683ac70bc074ca6676b938bff18635226)) | |
| tree | [d04f6cc47cbd411e661164a64f2454c3a0da9d47](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=673d606683ac70bc074ca6676b938bff18635226) | |
| parent | [f0c37002210aaede10dae849d1a78efc2243add2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0c37002210aaede10dae849d1a78efc2243add2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=673d606683ac70bc074ca6676b938bff18635226&id2=f0c37002210aaede10dae849d1a78efc2243add2)) | |
| download | [linux-673d606683ac70bc074ca6676b938bff18635226.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-673d606683ac70bc074ca6676b938bff18635226.tar.gz) | |

net/smc: fix LGR and link use-after-free issue[ Upstream commit 2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7 ]
We encountered a LGR/link use-after-free issue, which manifested as
the LGR/link refcnt reaching 0 early and entering the clear process,
making resource access unsafe.
refcount\_t: addition on 0; use-after-free.
WARNING: CPU: 14 PID: 107447 at lib/refcount.c:25 refcount\_warn\_saturate+0x9c/0x140
Workqueue: events smc\_lgr\_terminate\_work [smc]
Call trace:
refcount\_warn\_saturate+0x9c/0x140
\_\_smc\_lgr\_terminate.part.45+0x2a8/0x370 [smc]
smc\_lgr\_terminate\_work+0x28/0x30 [smc]
process\_one\_work+0x1b8/0x420
worker\_thread+0x158/0x510
kthread+0x114/0x118
or
refcount\_t: underflow; use-after-free.
WARNING: CPU: 6 PID: 93140 at lib/refcount.c:28 refcount\_warn\_saturate+0xf0/0x140
Workqueue: smc\_hs\_wq smc\_listen\_work [smc]
Call trace:
refcount\_warn\_saturate+0xf0/0x140
smcr\_link\_put+0x1cc/0x1d8 [smc]
smc\_conn\_free+0x110/0x1b0 [smc]
smc\_conn\_abort+0x50/0x60 [smc]
smc\_listen\_find\_device+0x75c/0x790 [smc]
smc\_listen\_work+0x368/0x8a0 [smc]
process\_one\_work+0x1b8/0x420
worker\_thread+0x158/0x510
kthread+0x114/0x118
It is caused by repeated release of LGR/link refcnt. One suspect is that
smc\_conn\_free() is called repeatedly because some smc\_conn\_free() from
server listening path are not protected by sock lock.
e.g.
Calls under socklock | smc\_listen\_work
-------------------------------------------------------
lock\_sock(sk) | smc\_conn\_abort
smc\_conn\_free | \- smc\_conn\_free
\- smcr\_link\_put | \- smcr\_link\_put (duplicated)
release\_sock(sk)
So here add sock lock protection in smc\_listen\_work() path, making it
exclusive with other connection operations.
Fixes: 3b2dec2603d5 ("net/smc: restructure client and server code in af\_smc")
Co-developed-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Signed-off-by: Guangguan Wang <guangguan.wang@linux.alibaba.com>
Co-developed-by: Kai <KaiShen@linux.alibaba.com>
Signed-off-by: Kai <KaiShen@linux.alibaba.com>
Signed-off-by: Wen Gu <guwen@linux.alibaba.com>
Reviewed-by: Wenjia Zhang <wenjia@linux.ibm.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=673d606683ac70bc074ca6676b938bff18635226)

| -rw-r--r-- | [net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/af_smc.c?id=673d606683ac70bc074ca6676b938bff18635226) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/net/smc/af\_smc.c b/net/smc/af\_smc.cindex 755659703a625f..77c6c0dff069ef 100644--- a/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=f0c37002210aaede10dae849d1a78efc2243add2)+++ b/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=673d606683ac70bc074ca6676b938bff18635226)@@ -1907,6 +1907,7 @@ static void smc\_listen\_out(struct smc\_sock \*new\_smc) if (tcp\_sk(new\_smc->clcsock->sk)->syn\_smc) atomic\_dec(&lsmc->queued\_smc\_hs); + release\_sock(newsmcsk); /\* lock in smc\_listen\_work() \*/ if (lsmc->sk.sk\_state == SMC\_LISTEN) { lock\_sock\_nested(&lsmc->sk, SINGLE\_DEPTH\_NESTING); smc\_accept\_enqueue(&lsmc->sk, newsmcsk);@@ -2428,6 +2429,7 @@ static void smc\_listen\_work(struct work\_struct \*work) u8 accept\_version; int rc = 0; + lock\_sock(&new\_smc->sk); /\* release in smc\_listen\_out() \*/ if (new\_smc->listen\_smc->sk.sk\_state != SMC\_LISTEN) return smc\_listen\_out\_err(new\_smc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:31:14 +0000


