=== Content from git.kernel.org_613b89b9_20250115_094950.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Koichiro Den <koichiro.den@canonical.com> | 2024-12-06 10:10:42 +0900 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-12-10 11:20:50 +0100 |
| commit | [3ddccbefebdbe0c4c72a248676e4d39ac66a8e26](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26)) | |
| tree | [87ce23873bf6eb1f7961edb7639bb85e128eb723](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26) | |
| parent | [af47a328e8130c81984cbcd1f771fc4bb777bd0f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af47a328e8130c81984cbcd1f771fc4bb777bd0f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26&id2=af47a328e8130c81984cbcd1f771fc4bb777bd0f)) | |
| download | [linux-3ddccbefebdbe0c4c72a248676e4d39ac66a8e26.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3ddccbefebdbe0c4c72a248676e4d39ac66a8e26.tar.gz) | |

virtio\_net: correct netdev\_tx\_reset\_queue() invocation pointWhen virtnet\_close is followed by virtnet\_open, some TX completions can
possibly remain unconsumed, until they are finally processed during the
first NAPI poll after the netdev\_tx\_reset\_queue(), resulting in a crash
[1]. Commit b96ed2c97c79 ("virtio\_net: move netdev\_tx\_reset\_queue() call
before RX napi enable") was not sufficient to eliminate all BQL crash
cases for virtio-net.
This issue can be reproduced with the latest net-next master by running:
`while :; do ip l set DEV down; ip l set DEV up; done` under heavy network
TX load from inside the machine.
netdev\_tx\_reset\_queue() can actually be dropped from virtnet\_open path;
the device is not stopped in any case. For BQL core part, it's just like
traffic nearly ceases to exist for some period. For stall detector added
to BQL, even if virtnet\_close could somehow lead to some TX completions
delayed for long, followed by virtnet\_open, we can just take it as stall
as mentioned in commit 6025b9135f7a ("net: dqs: add NIC stall detector
based on BQL"). Note also that users can still reset stall\_max via sysfs.
So, drop netdev\_tx\_reset\_queue() from virtnet\_enable\_queue\_pair(). This
eliminates the BQL crashes. As a result, netdev\_tx\_reset\_queue() is now
explicitly required in freeze/restore path. This patch adds it to
immediately after free\_unused\_bufs(), following the rule of thumb:
netdev\_tx\_reset\_queue() should follow any SKB freeing not followed by
netdev\_tx\_completed\_queue(). This seems the most consistent and
streamlined approach, and now netdev\_tx\_reset\_queue() runs whenever
free\_unused\_bufs() is done.
[1]:
------------[ cut here ]------------
kernel BUG at lib/dynamic\_queue\_limits.c:99!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 7 UID: 0 PID: 1598 Comm: ip Tainted: G N 6.12.0net-next\_main+ #2
Tainted: [N]=TEST
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), \
BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
RIP: 0010:dql\_completed+0x26b/0x290
Code: b7 c2 49 89 e9 44 89 da 89 c6 4c 89 d7 e8 ed 17 47 00 58 65 ff 0d
4d 27 90 7e 0f 85 fd fe ff ff e8 ea 53 8d ff e9 f3 fe ff ff <0f> 0b 01
d2 44 89 d1 29 d1 ba 00 00 00 00 0f 48 ca e9 28 ff ff ff
RSP: 0018:ffffc900002b0d08 EFLAGS: 00010297
RAX: 0000000000000000 RBX: ffff888102398c80 RCX: 0000000080190009
RDX: 0000000000000000 RSI: 000000000000006a RDI: 0000000000000000
RBP: ffff888102398c00 R08: 0000000000000000 R09: 0000000000000000
R10: 00000000000000ca R11: 0000000000015681 R12: 0000000000000001
R13: ffffc900002b0d68 R14: ffff88811115e000 R15: ffff8881107aca40
FS: 00007f41ded69500(0000) GS:ffff888667dc0000(0000)
knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000556ccc2dc1a0 CR3: 0000000104fd8003 CR4: 0000000000772ef0
PKRU: 55555554
Call Trace:
<IRQ>
? die+0x32/0x80
? do\_trap+0xd9/0x100
? dql\_completed+0x26b/0x290
? dql\_completed+0x26b/0x290
? do\_error\_trap+0x6d/0xb0
? dql\_completed+0x26b/0x290
? exc\_invalid\_op+0x4c/0x60
? dql\_completed+0x26b/0x290
? asm\_exc\_invalid\_op+0x16/0x20
? dql\_completed+0x26b/0x290
\_\_free\_old\_xmit+0xff/0x170 [virtio\_net]
free\_old\_xmit+0x54/0xc0 [virtio\_net]
virtnet\_poll+0xf4/0xe30 [virtio\_net]
? \_\_update\_load\_avg\_cfs\_rq+0x264/0x2d0
? update\_curr+0x35/0x260
? reweight\_entity+0x1be/0x260
\_\_napi\_poll.constprop.0+0x28/0x1c0
net\_rx\_action+0x329/0x420
? enqueue\_hrtimer+0x35/0x90
? trace\_hardirqs\_on+0x1d/0x80
? kvm\_sched\_clock\_read+0xd/0x20
? sched\_clock+0xc/0x30
? kvm\_sched\_clock\_read+0xd/0x20
? sched\_clock+0xc/0x30
? sched\_clock\_cpu+0xd/0x1a0
handle\_softirqs+0x138/0x3e0
do\_softirq.part.0+0x89/0xc0
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip+0xa7/0xb0
virtnet\_open+0xc8/0x310 [virtio\_net]
\_\_dev\_open+0xfa/0x1b0
\_\_dev\_change\_flags+0x1de/0x250
dev\_change\_flags+0x22/0x60
do\_setlink.isra.0+0x2df/0x10b0
? rtnetlink\_rcv\_msg+0x34f/0x3f0
? netlink\_rcv\_skb+0x54/0x100
? netlink\_unicast+0x23e/0x390
? netlink\_sendmsg+0x21e/0x490
? \_\_\_\_sys\_sendmsg+0x31b/0x350
? avc\_has\_perm\_noaudit+0x67/0xf0
? cred\_has\_capability.isra.0+0x75/0x110
? \_\_nla\_validate\_parse+0x5f/0xee0
? \_\_pfx\_\_\_probestub\_irq\_enable+0x3/0x10
? \_\_create\_object+0x5e/0x90
? security\_capable+0x3b/0x70
rtnl\_newlink+0x784/0xaf0
? avc\_has\_perm\_noaudit+0x67/0xf0
? cred\_has\_capability.isra.0+0x75/0x110
? stack\_depot\_save\_flags+0x24/0x6d0
? \_\_pfx\_rtnl\_newlink+0x10/0x10
rtnetlink\_rcv\_msg+0x34f/0x3f0
? do\_syscall\_64+0x6c/0x180
? entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
? \_\_pfx\_rtnetlink\_rcv\_msg+0x10/0x10
netlink\_rcv\_skb+0x54/0x100
netlink\_unicast+0x23e/0x390
netlink\_sendmsg+0x21e/0x490
\_\_\_\_sys\_sendmsg+0x31b/0x350
? copy\_msghdr\_from\_user+0x6d/0xa0
\_\_\_sys\_sendmsg+0x86/0xd0
? \_\_pte\_offset\_map+0x17/0x160
? preempt\_count\_add+0x69/0xa0
? \_\_call\_rcu\_common.constprop.0+0x147/0x610
? preempt\_count\_add+0x69/0xa0
? preempt\_count\_add+0x69/0xa0
? \_raw\_spin\_trylock+0x13/0x60
? trace\_hardirqs\_on+0x1d/0x80
\_\_sys\_sendmsg+0x66/0xc0
do\_syscall\_64+0x6c/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f41defe5b34
Code: 15 e1 12 0f 00 f7 d8 64 89 02 b8 ff ff ff ff eb bf 0f 1f 44 00 00
f3 0f 1e fa 80 3d 35 95 0f 00 00 74 13 b8 2e 00 00 00 0f 05 <48> 3d 00
f0 ff ff 77 4c c3 0f 1f 00 55 48 89 e5 48 83 ec 20 89 55
RSP: 002b:00007ffe5336ecc8 EFLAGS: 00000202 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 00007f41defe5b34
RDX: 0000000000000000 RSI: 00007ffe5336ed30 RDI: 0000000000000003
RBP: 00007ffe5336eda0 R08: 0000000000000010 R09: 0000000000000001
R10: 00007ffe5336f6f9 R11: 0000000000000202 R12: 0000000000000003
R13: 0000000067452259 R14: 0000556ccc28b040 R15: 0000000000000000
</TASK>
[...]
Fixes: c8bd1f7f3e61 ("virtio\_net: add support for Byte Queue Limits")
Cc: <stable@vger.kernel.org> # v6.11+
Signed-off-by: Koichiro Den <koichiro.den@canonical.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Xuan Zhuo <xuanzhuo@linux.alibaba.com>
[ pabeni: trimmed possibly troublesome separator ]
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26)

| -rw-r--r-- | [drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/virtio_net.c?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/drivers/net/virtio\_net.c b/drivers/net/virtio\_net.cindex 64c87bb48a41c0..6e0925f7f18217 100644--- a/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=af47a328e8130c81984cbcd1f771fc4bb777bd0f)+++ b/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=3ddccbefebdbe0c4c72a248676e4d39ac66a8e26)@@ -3054,7 +3054,6 @@ static int virtnet\_enable\_queue\_pair(struct virtnet\_info \*vi, int qp\_index) if (err < 0) goto err\_xdp\_reg\_mem\_model; - netdev\_tx\_reset\_queue(netdev\_get\_tx\_queue(vi->dev, qp\_index)); virtnet\_napi\_enable(vi->rq[qp\_index].vq, &vi->rq[qp\_index].napi); virtnet\_napi\_tx\_enable(vi, vi->sq[qp\_index].vq, &vi->sq[qp\_index].napi); @@ -6966,11 +6965,20 @@ free:  static void remove\_vq\_common(struct virtnet\_info \*vi) {+ int i;+ virtio\_reset\_device(vi->vdev);  /\* Free unused buffers in both send and recv, if any. \*/ free\_unused\_bufs(vi); + /\*+ \* Rule of thumb is netdev\_tx\_reset\_queue() should follow any+ \* skb freeing not followed by netdev\_tx\_completed\_queue()+ \*/+ for (i = 0; i < vi->max\_queue\_pairs; i++)+ netdev\_tx\_reset\_queue(netdev\_get\_tx\_queue(vi->dev, i));+ free\_receive\_bufs(vi);  free\_receive\_page\_frags(vi); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:48:27 +0000



=== Content from git.kernel.org_414334da_20250115_094951.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Koichiro Den <koichiro.den@canonical.com> | 2024-12-06 10:10:42 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:12:59 +0100 |
| commit | [b4294d4ac61fbb382811a1d64eaf81f446ce2af4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4)) | |
| tree | [782323366f1648f0062d0d1d4eca5f905ddc82c5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4) | |
| parent | [9891675bba06e9e46ee989037f8e2cf8b9064e70](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9891675bba06e9e46ee989037f8e2cf8b9064e70) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4&id2=9891675bba06e9e46ee989037f8e2cf8b9064e70)) | |
| download | [linux-b4294d4ac61fbb382811a1d64eaf81f446ce2af4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b4294d4ac61fbb382811a1d64eaf81f446ce2af4.tar.gz) | |

virtio\_net: correct netdev\_tx\_reset\_queue() invocation pointcommit 3ddccbefebdbe0c4c72a248676e4d39ac66a8e26 upstream.
When virtnet\_close is followed by virtnet\_open, some TX completions can
possibly remain unconsumed, until they are finally processed during the
first NAPI poll after the netdev\_tx\_reset\_queue(), resulting in a crash
[1]. Commit b96ed2c97c79 ("virtio\_net: move netdev\_tx\_reset\_queue() call
before RX napi enable") was not sufficient to eliminate all BQL crash
cases for virtio-net.
This issue can be reproduced with the latest net-next master by running:
`while :; do ip l set DEV down; ip l set DEV up; done` under heavy network
TX load from inside the machine.
netdev\_tx\_reset\_queue() can actually be dropped from virtnet\_open path;
the device is not stopped in any case. For BQL core part, it's just like
traffic nearly ceases to exist for some period. For stall detector added
to BQL, even if virtnet\_close could somehow lead to some TX completions
delayed for long, followed by virtnet\_open, we can just take it as stall
as mentioned in commit 6025b9135f7a ("net: dqs: add NIC stall detector
based on BQL"). Note also that users can still reset stall\_max via sysfs.
So, drop netdev\_tx\_reset\_queue() from virtnet\_enable\_queue\_pair(). This
eliminates the BQL crashes. As a result, netdev\_tx\_reset\_queue() is now
explicitly required in freeze/restore path. This patch adds it to
immediately after free\_unused\_bufs(), following the rule of thumb:
netdev\_tx\_reset\_queue() should follow any SKB freeing not followed by
netdev\_tx\_completed\_queue(). This seems the most consistent and
streamlined approach, and now netdev\_tx\_reset\_queue() runs whenever
free\_unused\_bufs() is done.
[1]:
------------[ cut here ]------------
kernel BUG at lib/dynamic\_queue\_limits.c:99!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 7 UID: 0 PID: 1598 Comm: ip Tainted: G N 6.12.0net-next\_main+ #2
Tainted: [N]=TEST
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), \
BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
RIP: 0010:dql\_completed+0x26b/0x290
Code: b7 c2 49 89 e9 44 89 da 89 c6 4c 89 d7 e8 ed 17 47 00 58 65 ff 0d
4d 27 90 7e 0f 85 fd fe ff ff e8 ea 53 8d ff e9 f3 fe ff ff <0f> 0b 01
d2 44 89 d1 29 d1 ba 00 00 00 00 0f 48 ca e9 28 ff ff ff
RSP: 0018:ffffc900002b0d08 EFLAGS: 00010297
RAX: 0000000000000000 RBX: ffff888102398c80 RCX: 0000000080190009
RDX: 0000000000000000 RSI: 000000000000006a RDI: 0000000000000000
RBP: ffff888102398c00 R08: 0000000000000000 R09: 0000000000000000
R10: 00000000000000ca R11: 0000000000015681 R12: 0000000000000001
R13: ffffc900002b0d68 R14: ffff88811115e000 R15: ffff8881107aca40
FS: 00007f41ded69500(0000) GS:ffff888667dc0000(0000)
knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000556ccc2dc1a0 CR3: 0000000104fd8003 CR4: 0000000000772ef0
PKRU: 55555554
Call Trace:
<IRQ>
? die+0x32/0x80
? do\_trap+0xd9/0x100
? dql\_completed+0x26b/0x290
? dql\_completed+0x26b/0x290
? do\_error\_trap+0x6d/0xb0
? dql\_completed+0x26b/0x290
? exc\_invalid\_op+0x4c/0x60
? dql\_completed+0x26b/0x290
? asm\_exc\_invalid\_op+0x16/0x20
? dql\_completed+0x26b/0x290
\_\_free\_old\_xmit+0xff/0x170 [virtio\_net]
free\_old\_xmit+0x54/0xc0 [virtio\_net]
virtnet\_poll+0xf4/0xe30 [virtio\_net]
? \_\_update\_load\_avg\_cfs\_rq+0x264/0x2d0
? update\_curr+0x35/0x260
? reweight\_entity+0x1be/0x260
\_\_napi\_poll.constprop.0+0x28/0x1c0
net\_rx\_action+0x329/0x420
? enqueue\_hrtimer+0x35/0x90
? trace\_hardirqs\_on+0x1d/0x80
? kvm\_sched\_clock\_read+0xd/0x20
? sched\_clock+0xc/0x30
? kvm\_sched\_clock\_read+0xd/0x20
? sched\_clock+0xc/0x30
? sched\_clock\_cpu+0xd/0x1a0
handle\_softirqs+0x138/0x3e0
do\_softirq.part.0+0x89/0xc0
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip+0xa7/0xb0
virtnet\_open+0xc8/0x310 [virtio\_net]
\_\_dev\_open+0xfa/0x1b0
\_\_dev\_change\_flags+0x1de/0x250
dev\_change\_flags+0x22/0x60
do\_setlink.isra.0+0x2df/0x10b0
? rtnetlink\_rcv\_msg+0x34f/0x3f0
? netlink\_rcv\_skb+0x54/0x100
? netlink\_unicast+0x23e/0x390
? netlink\_sendmsg+0x21e/0x490
? \_\_\_\_sys\_sendmsg+0x31b/0x350
? avc\_has\_perm\_noaudit+0x67/0xf0
? cred\_has\_capability.isra.0+0x75/0x110
? \_\_nla\_validate\_parse+0x5f/0xee0
? \_\_pfx\_\_\_probestub\_irq\_enable+0x3/0x10
? \_\_create\_object+0x5e/0x90
? security\_capable+0x3b/0x70
rtnl\_newlink+0x784/0xaf0
? avc\_has\_perm\_noaudit+0x67/0xf0
? cred\_has\_capability.isra.0+0x75/0x110
? stack\_depot\_save\_flags+0x24/0x6d0
? \_\_pfx\_rtnl\_newlink+0x10/0x10
rtnetlink\_rcv\_msg+0x34f/0x3f0
? do\_syscall\_64+0x6c/0x180
? entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
? \_\_pfx\_rtnetlink\_rcv\_msg+0x10/0x10
netlink\_rcv\_skb+0x54/0x100
netlink\_unicast+0x23e/0x390
netlink\_sendmsg+0x21e/0x490
\_\_\_\_sys\_sendmsg+0x31b/0x350
? copy\_msghdr\_from\_user+0x6d/0xa0
\_\_\_sys\_sendmsg+0x86/0xd0
? \_\_pte\_offset\_map+0x17/0x160
? preempt\_count\_add+0x69/0xa0
? \_\_call\_rcu\_common.constprop.0+0x147/0x610
? preempt\_count\_add+0x69/0xa0
? preempt\_count\_add+0x69/0xa0
? \_raw\_spin\_trylock+0x13/0x60
? trace\_hardirqs\_on+0x1d/0x80
\_\_sys\_sendmsg+0x66/0xc0
do\_syscall\_64+0x6c/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f41defe5b34
Code: 15 e1 12 0f 00 f7 d8 64 89 02 b8 ff ff ff ff eb bf 0f 1f 44 00 00
f3 0f 1e fa 80 3d 35 95 0f 00 00 74 13 b8 2e 00 00 00 0f 05 <48> 3d 00
f0 ff ff 77 4c c3 0f 1f 00 55 48 89 e5 48 83 ec 20 89 55
RSP: 002b:00007ffe5336ecc8 EFLAGS: 00000202 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 00007f41defe5b34
RDX: 0000000000000000 RSI: 00007ffe5336ed30 RDI: 0000000000000003
RBP: 00007ffe5336eda0 R08: 0000000000000010 R09: 0000000000000001
R10: 00007ffe5336f6f9 R11: 0000000000000202 R12: 0000000000000003
R13: 0000000067452259 R14: 0000556ccc28b040 R15: 0000000000000000
</TASK>
[...]
Fixes: c8bd1f7f3e61 ("virtio\_net: add support for Byte Queue Limits")
Cc: <stable@vger.kernel.org> # v6.11+
Signed-off-by: Koichiro Den <koichiro.den@canonical.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Xuan Zhuo <xuanzhuo@linux.alibaba.com>
[ pabeni: trimmed possibly troublesome separator ]
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4)

| -rw-r--r-- | [drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/virtio_net.c?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/drivers/net/virtio\_net.c b/drivers/net/virtio\_net.cindex c897afef0b414c..b34102a77b8dbe 100644--- a/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=9891675bba06e9e46ee989037f8e2cf8b9064e70)+++ b/[drivers/net/virtio\_net.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/virtio_net.c?id=b4294d4ac61fbb382811a1d64eaf81f446ce2af4)@@ -2898,7 +2898,6 @@ static int virtnet\_enable\_queue\_pair(struct virtnet\_info \*vi, int qp\_index) if (err < 0) goto err\_xdp\_reg\_mem\_model; - netdev\_tx\_reset\_queue(netdev\_get\_tx\_queue(vi->dev, qp\_index)); virtnet\_napi\_enable(vi->rq[qp\_index].vq, &vi->rq[qp\_index].napi); virtnet\_napi\_tx\_enable(vi, vi->sq[qp\_index].vq, &vi->sq[qp\_index].napi); @@ -6728,11 +6727,20 @@ free:  static void remove\_vq\_common(struct virtnet\_info \*vi) {+ int i;+ virtio\_reset\_device(vi->vdev);  /\* Free unused buffers in both send and recv, if any. \*/ free\_unused\_bufs(vi); + /\*+ \* Rule of thumb is netdev\_tx\_reset\_queue() should follow any+ \* skb freeing not followed by netdev\_tx\_completed\_queue()+ \*/+ for (i = 0; i < vi->max\_queue\_pairs; i++)+ netdev\_tx\_reset\_queue(netdev\_get\_tx\_queue(vi->dev, i));+ free\_receive\_bufs(vi);  free\_receive\_page\_frags(vi); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:48:28 +0000


