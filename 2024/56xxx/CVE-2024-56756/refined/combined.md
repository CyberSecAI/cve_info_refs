=== Content from git.kernel.org_9e55129a_20250114_224258.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christoph Hellwig <hch@lst.de> | 2024-11-01 05:40:04 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:43 +0100 |
| commit | [452f9ddd12bebc04cef741e8ba3806bf0e1fd015](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015)) | |
| tree | [ca3a046178e5e870ad507e56cb82aca9e8bca485](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015) | |
| parent | [d3df9f26cff97beaa5643e551031795d5d5cddbe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3df9f26cff97beaa5643e551031795d5d5cddbe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015&id2=d3df9f26cff97beaa5643e551031795d5d5cddbe)) | |
| download | [linux-452f9ddd12bebc04cef741e8ba3806bf0e1fd015.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-452f9ddd12bebc04cef741e8ba3806bf0e1fd015.tar.gz) | |

nvme-pci: fix freeing of the HMB descriptor table[ Upstream commit 3c2fb1ca8086eb139b2a551358137525ae8e0d7a ]
The HMB descriptor table is sized to the maximum number of descriptors
that could be used for a given device, but \_\_nvme\_alloc\_host\_mem could
break out of the loop earlier on memory allocation failure and end up
using less descriptors than planned for, which leads to an incorrect
size passed to dma\_free\_coherent.
In practice this was not showing up because the number of descriptors
tends to be low and the dma coherent allocator always allocates and
frees at least a page.
Fixes: 87ad72a59a38 ("nvme-pci: implement host memory buffer support")
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015)

| -rw-r--r-- | [drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/pci.c?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/drivers/nvme/host/pci.c b/drivers/nvme/host/pci.cindex 78cac4220e03af..875ebef6adc71d 100644--- a/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=d3df9f26cff97beaa5643e551031795d5d5cddbe)+++ b/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=452f9ddd12bebc04cef741e8ba3806bf0e1fd015)@@ -147,6 +147,7 @@ struct nvme\_dev { /\* host memory buffer support: \*/ u64 host\_mem\_size; u32 nr\_host\_mem\_descs;+ u32 host\_mem\_descs\_size; dma\_addr\_t host\_mem\_descs\_dma; struct nvme\_host\_mem\_buf\_desc \*host\_mem\_descs; void \*\*host\_mem\_desc\_bufs;@@ -1925,10 +1926,10 @@ static void nvme\_free\_host\_mem(struct nvme\_dev \*dev)  kfree(dev->host\_mem\_desc\_bufs); dev->host\_mem\_desc\_bufs = NULL;- dma\_free\_coherent(dev->dev,- dev->nr\_host\_mem\_descs \* sizeof(\*dev->host\_mem\_descs),+ dma\_free\_coherent(dev->dev, dev->host\_mem\_descs\_size, dev->host\_mem\_descs, dev->host\_mem\_descs\_dma); dev->host\_mem\_descs = NULL;+ dev->host\_mem\_descs\_size = 0; dev->nr\_host\_mem\_descs = 0; } @@ -1936,7 +1937,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, u32 chunk\_size) { struct nvme\_host\_mem\_buf\_desc \*descs;- u32 max\_entries, len;+ u32 max\_entries, len, descs\_size; dma\_addr\_t descs\_dma; int i = 0; void \*\*bufs;@@ -1949,8 +1950,9 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, if (dev->ctrl.hmmaxd && dev->ctrl.hmmaxd < max\_entries) max\_entries = dev->ctrl.hmmaxd; - descs = dma\_alloc\_coherent(dev->dev, max\_entries \* sizeof(\*descs),- &descs\_dma, GFP\_KERNEL);+ descs\_size = max\_entries \* sizeof(\*descs);+ descs = dma\_alloc\_coherent(dev->dev, descs\_size, &descs\_dma,+ GFP\_KERNEL); if (!descs) goto out; @@ -1979,6 +1981,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, dev->host\_mem\_size = size; dev->host\_mem\_descs = descs; dev->host\_mem\_descs\_dma = descs\_dma;+ dev->host\_mem\_descs\_size = descs\_size; dev->host\_mem\_desc\_bufs = bufs; return 0; @@ -1993,8 +1996,7 @@ out\_free\_bufs:  kfree(bufs); out\_free\_descs:- dma\_free\_coherent(dev->dev, max\_entries \* sizeof(\*descs), descs,- descs\_dma);+ dma\_free\_coherent(dev->dev, descs\_size, descs, descs\_dma); out: dev->host\_mem\_descs = NULL; return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:41:35 +0000



=== Content from git.kernel.org_df4cbaa9_20250114_224300.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6d0f599db73b099aa724a12736369c4d4d92849d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d0f599db73b099aa724a12736369c4d4d92849d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d0f599db73b099aa724a12736369c4d4d92849d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d0f599db73b099aa724a12736369c4d4d92849d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christoph Hellwig <hch@lst.de> | 2024-11-01 05:40:04 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:52:45 +0100 |
| commit | [6d0f599db73b099aa724a12736369c4d4d92849d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d0f599db73b099aa724a12736369c4d4d92849d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6d0f599db73b099aa724a12736369c4d4d92849d)) | |
| tree | [8d7bb088fafb1a57a6e0f8a1836c69b83e0914aa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d0f599db73b099aa724a12736369c4d4d92849d) | |
| parent | [70df8758130ec59c9f75629ebf15bee24c81106c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70df8758130ec59c9f75629ebf15bee24c81106c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d0f599db73b099aa724a12736369c4d4d92849d&id2=70df8758130ec59c9f75629ebf15bee24c81106c)) | |
| download | [linux-6d0f599db73b099aa724a12736369c4d4d92849d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6d0f599db73b099aa724a12736369c4d4d92849d.tar.gz) | |

nvme-pci: fix freeing of the HMB descriptor table[ Upstream commit 3c2fb1ca8086eb139b2a551358137525ae8e0d7a ]
The HMB descriptor table is sized to the maximum number of descriptors
that could be used for a given device, but \_\_nvme\_alloc\_host\_mem could
break out of the loop earlier on memory allocation failure and end up
using less descriptors than planned for, which leads to an incorrect
size passed to dma\_free\_coherent.
In practice this was not showing up because the number of descriptors
tends to be low and the dma coherent allocator always allocates and
frees at least a page.
Fixes: 87ad72a59a38 ("nvme-pci: implement host memory buffer support")
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d0f599db73b099aa724a12736369c4d4d92849d)

| -rw-r--r-- | [drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/pci.c?id=6d0f599db73b099aa724a12736369c4d4d92849d) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/drivers/nvme/host/pci.c b/drivers/nvme/host/pci.cindex 4b9fda0b1d9a33..34daf6d8db07b2 100644--- a/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=70df8758130ec59c9f75629ebf15bee24c81106c)+++ b/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=6d0f599db73b099aa724a12736369c4d4d92849d)@@ -153,6 +153,7 @@ struct nvme\_dev { /\* host memory buffer support: \*/ u64 host\_mem\_size; u32 nr\_host\_mem\_descs;+ u32 host\_mem\_descs\_size; dma\_addr\_t host\_mem\_descs\_dma; struct nvme\_host\_mem\_buf\_desc \*host\_mem\_descs; void \*\*host\_mem\_desc\_bufs;@@ -1966,10 +1967,10 @@ static void nvme\_free\_host\_mem(struct nvme\_dev \*dev)  kfree(dev->host\_mem\_desc\_bufs); dev->host\_mem\_desc\_bufs = NULL;- dma\_free\_coherent(dev->dev,- dev->nr\_host\_mem\_descs \* sizeof(\*dev->host\_mem\_descs),+ dma\_free\_coherent(dev->dev, dev->host\_mem\_descs\_size, dev->host\_mem\_descs, dev->host\_mem\_descs\_dma); dev->host\_mem\_descs = NULL;+ dev->host\_mem\_descs\_size = 0; dev->nr\_host\_mem\_descs = 0; } @@ -1977,7 +1978,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, u32 chunk\_size) { struct nvme\_host\_mem\_buf\_desc \*descs;- u32 max\_entries, len;+ u32 max\_entries, len, descs\_size; dma\_addr\_t descs\_dma; int i = 0; void \*\*bufs;@@ -1990,8 +1991,9 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, if (dev->ctrl.hmmaxd && dev->ctrl.hmmaxd < max\_entries) max\_entries = dev->ctrl.hmmaxd; - descs = dma\_alloc\_coherent(dev->dev, max\_entries \* sizeof(\*descs),- &descs\_dma, GFP\_KERNEL);+ descs\_size = max\_entries \* sizeof(\*descs);+ descs = dma\_alloc\_coherent(dev->dev, descs\_size, &descs\_dma,+ GFP\_KERNEL); if (!descs) goto out; @@ -2020,6 +2022,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, dev->host\_mem\_size = size; dev->host\_mem\_descs = descs; dev->host\_mem\_descs\_dma = descs\_dma;+ dev->host\_mem\_descs\_size = descs\_size; dev->host\_mem\_desc\_bufs = bufs; return 0; @@ -2034,8 +2037,7 @@ out\_free\_bufs:  kfree(bufs); out\_free\_descs:- dma\_free\_coherent(dev->dev, max\_entries \* sizeof(\*descs), descs,- descs\_dma);+ dma\_free\_coherent(dev->dev, descs\_size, descs, descs\_dma); out: dev->host\_mem\_descs = NULL; return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:41:37 +0000



=== Content from git.kernel.org_629f1662_20250114_224302.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ac22240540e0c5230d8c4138e3778420b712716a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ac22240540e0c5230d8c4138e3778420b712716a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac22240540e0c5230d8c4138e3778420b712716a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac22240540e0c5230d8c4138e3778420b712716a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christoph Hellwig <hch@lst.de> | 2024-11-01 05:40:04 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:22 +0100 |
| commit | [ac22240540e0c5230d8c4138e3778420b712716a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac22240540e0c5230d8c4138e3778420b712716a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ac22240540e0c5230d8c4138e3778420b712716a)) | |
| tree | [cd0e151333bf2b4112da560ed3fabfda06beba38](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ac22240540e0c5230d8c4138e3778420b712716a) | |
| parent | [c509b1acbd867d9e09580fe059a924cb5825afb1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c509b1acbd867d9e09580fe059a924cb5825afb1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac22240540e0c5230d8c4138e3778420b712716a&id2=c509b1acbd867d9e09580fe059a924cb5825afb1)) | |
| download | [linux-ac22240540e0c5230d8c4138e3778420b712716a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ac22240540e0c5230d8c4138e3778420b712716a.tar.gz) | |

nvme-pci: fix freeing of the HMB descriptor table[ Upstream commit 3c2fb1ca8086eb139b2a551358137525ae8e0d7a ]
The HMB descriptor table is sized to the maximum number of descriptors
that could be used for a given device, but \_\_nvme\_alloc\_host\_mem could
break out of the loop earlier on memory allocation failure and end up
using less descriptors than planned for, which leads to an incorrect
size passed to dma\_free\_coherent.
In practice this was not showing up because the number of descriptors
tends to be low and the dma coherent allocator always allocates and
frees at least a page.
Fixes: 87ad72a59a38 ("nvme-pci: implement host memory buffer support")
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac22240540e0c5230d8c4138e3778420b712716a)

| -rw-r--r-- | [drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/pci.c?id=ac22240540e0c5230d8c4138e3778420b712716a) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/drivers/nvme/host/pci.c b/drivers/nvme/host/pci.cindex 20f5616fd5182f..11df63d2149007 100644--- a/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=c509b1acbd867d9e09580fe059a924cb5825afb1)+++ b/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=ac22240540e0c5230d8c4138e3778420b712716a)@@ -125,6 +125,7 @@ struct nvme\_dev { /\* host memory buffer support: \*/ u64 host\_mem\_size; u32 nr\_host\_mem\_descs;+ u32 host\_mem\_descs\_size; dma\_addr\_t host\_mem\_descs\_dma; struct nvme\_host\_mem\_buf\_desc \*host\_mem\_descs; void \*\*host\_mem\_desc\_bufs;@@ -1924,10 +1925,10 @@ static void nvme\_free\_host\_mem(struct nvme\_dev \*dev)  kfree(dev->host\_mem\_desc\_bufs); dev->host\_mem\_desc\_bufs = NULL;- dma\_free\_coherent(dev->dev,- dev->nr\_host\_mem\_descs \* sizeof(\*dev->host\_mem\_descs),+ dma\_free\_coherent(dev->dev, dev->host\_mem\_descs\_size, dev->host\_mem\_descs, dev->host\_mem\_descs\_dma); dev->host\_mem\_descs = NULL;+ dev->host\_mem\_descs\_size = 0; dev->nr\_host\_mem\_descs = 0; } @@ -1935,7 +1936,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, u32 chunk\_size) { struct nvme\_host\_mem\_buf\_desc \*descs;- u32 max\_entries, len;+ u32 max\_entries, len, descs\_size; dma\_addr\_t descs\_dma; int i = 0; void \*\*bufs;@@ -1948,8 +1949,9 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, if (dev->ctrl.hmmaxd && dev->ctrl.hmmaxd < max\_entries) max\_entries = dev->ctrl.hmmaxd; - descs = dma\_alloc\_coherent(dev->dev, max\_entries \* sizeof(\*descs),- &descs\_dma, GFP\_KERNEL);+ descs\_size = max\_entries \* sizeof(\*descs);+ descs = dma\_alloc\_coherent(dev->dev, descs\_size, &descs\_dma,+ GFP\_KERNEL); if (!descs) goto out; @@ -1978,6 +1980,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, dev->host\_mem\_size = size; dev->host\_mem\_descs = descs; dev->host\_mem\_descs\_dma = descs\_dma;+ dev->host\_mem\_descs\_size = descs\_size; dev->host\_mem\_desc\_bufs = bufs; return 0; @@ -1992,8 +1995,7 @@ out\_free\_bufs:  kfree(bufs); out\_free\_descs:- dma\_free\_coherent(dev->dev, max\_entries \* sizeof(\*descs), descs,- descs\_dma);+ dma\_free\_coherent(dev->dev, descs\_size, descs, descs\_dma); out: dev->host\_mem\_descs = NULL; return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:41:39 +0000



=== Content from git.kernel.org_35d31cd0_20250114_224302.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cee3bff51a35cab1c5d842d409a7b11caefe2386)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cee3bff51a35cab1c5d842d409a7b11caefe2386)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cee3bff51a35cab1c5d842d409a7b11caefe2386)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cee3bff51a35cab1c5d842d409a7b11caefe2386)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christoph Hellwig <hch@lst.de> | 2024-11-01 05:40:04 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:31:44 +0100 |
| commit | [cee3bff51a35cab1c5d842d409a7b11caefe2386](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cee3bff51a35cab1c5d842d409a7b11caefe2386) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cee3bff51a35cab1c5d842d409a7b11caefe2386)) | |
| tree | [7a5ec34e15802d015d515e6df15f7f43ef59a6d3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cee3bff51a35cab1c5d842d409a7b11caefe2386) | |
| parent | [1a423bbbeaf9e3e20c4686501efd9b661fe834db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cee3bff51a35cab1c5d842d409a7b11caefe2386&id2=1a423bbbeaf9e3e20c4686501efd9b661fe834db)) | |
| download | [linux-cee3bff51a35cab1c5d842d409a7b11caefe2386.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cee3bff51a35cab1c5d842d409a7b11caefe2386.tar.gz) | |

nvme-pci: fix freeing of the HMB descriptor table[ Upstream commit 3c2fb1ca8086eb139b2a551358137525ae8e0d7a ]
The HMB descriptor table is sized to the maximum number of descriptors
that could be used for a given device, but \_\_nvme\_alloc\_host\_mem could
break out of the loop earlier on memory allocation failure and end up
using less descriptors than planned for, which leads to an incorrect
size passed to dma\_free\_coherent.
In practice this was not showing up because the number of descriptors
tends to be low and the dma coherent allocator always allocates and
frees at least a page.
Fixes: 87ad72a59a38 ("nvme-pci: implement host memory buffer support")
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cee3bff51a35cab1c5d842d409a7b11caefe2386)

| -rw-r--r-- | [drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/pci.c?id=cee3bff51a35cab1c5d842d409a7b11caefe2386) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/drivers/nvme/host/pci.c b/drivers/nvme/host/pci.cindex b701969cf1c2aa..e0b502573b427f 100644--- a/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db)+++ b/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=cee3bff51a35cab1c5d842d409a7b11caefe2386)@@ -153,6 +153,7 @@ struct nvme\_dev { /\* host memory buffer support: \*/ u64 host\_mem\_size; u32 nr\_host\_mem\_descs;+ u32 host\_mem\_descs\_size; dma\_addr\_t host\_mem\_descs\_dma; struct nvme\_host\_mem\_buf\_desc \*host\_mem\_descs; void \*\*host\_mem\_desc\_bufs;@@ -1929,10 +1930,10 @@ static void nvme\_free\_host\_mem(struct nvme\_dev \*dev)  kfree(dev->host\_mem\_desc\_bufs); dev->host\_mem\_desc\_bufs = NULL;- dma\_free\_coherent(dev->dev,- dev->nr\_host\_mem\_descs \* sizeof(\*dev->host\_mem\_descs),+ dma\_free\_coherent(dev->dev, dev->host\_mem\_descs\_size, dev->host\_mem\_descs, dev->host\_mem\_descs\_dma); dev->host\_mem\_descs = NULL;+ dev->host\_mem\_descs\_size = 0; dev->nr\_host\_mem\_descs = 0; } @@ -1940,7 +1941,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, u32 chunk\_size) { struct nvme\_host\_mem\_buf\_desc \*descs;- u32 max\_entries, len;+ u32 max\_entries, len, descs\_size; dma\_addr\_t descs\_dma; int i = 0; void \*\*bufs;@@ -1953,8 +1954,9 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, if (dev->ctrl.hmmaxd && dev->ctrl.hmmaxd < max\_entries) max\_entries = dev->ctrl.hmmaxd; - descs = dma\_alloc\_coherent(dev->dev, max\_entries \* sizeof(\*descs),- &descs\_dma, GFP\_KERNEL);+ descs\_size = max\_entries \* sizeof(\*descs);+ descs = dma\_alloc\_coherent(dev->dev, descs\_size, &descs\_dma,+ GFP\_KERNEL); if (!descs) goto out; @@ -1983,6 +1985,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, dev->host\_mem\_size = size; dev->host\_mem\_descs = descs; dev->host\_mem\_descs\_dma = descs\_dma;+ dev->host\_mem\_descs\_size = descs\_size; dev->host\_mem\_desc\_bufs = bufs; return 0; @@ -1997,8 +2000,7 @@ out\_free\_bufs:  kfree(bufs); out\_free\_descs:- dma\_free\_coherent(dev->dev, max\_entries \* sizeof(\*descs), descs,- descs\_dma);+ dma\_free\_coherent(dev->dev, descs\_size, descs, descs\_dma); out: dev->host\_mem\_descs = NULL; return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:41:39 +0000



=== Content from git.kernel.org_c35bcb9c_20250114_224257.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christoph Hellwig <hch@lst.de> | 2024-11-01 05:40:04 +0100 |
| --- | --- | --- |
| committer | Keith Busch <kbusch@kernel.org> | 2024-11-05 07:54:34 -0800 |
| commit | [3c2fb1ca8086eb139b2a551358137525ae8e0d7a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a)) | |
| tree | [c39ddeb3087392f13fa0858be5f67a09eac85b17](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a) | |
| parent | [5e52f71f858eaff252a47530a5ad5e79309bd415](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e52f71f858eaff252a47530a5ad5e79309bd415) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a&id2=5e52f71f858eaff252a47530a5ad5e79309bd415)) | |
| download | [linux-3c2fb1ca8086eb139b2a551358137525ae8e0d7a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3c2fb1ca8086eb139b2a551358137525ae8e0d7a.tar.gz) | |

nvme-pci: fix freeing of the HMB descriptor tableThe HMB descriptor table is sized to the maximum number of descriptors
that could be used for a given device, but \_\_nvme\_alloc\_host\_mem could
break out of the loop earlier on memory allocation failure and end up
using less descriptors than planned for, which leads to an incorrect
size passed to dma\_free\_coherent.
In practice this was not showing up because the number of descriptors
tends to be low and the dma coherent allocator always allocates and
frees at least a page.
Fixes: 87ad72a59a38 ("nvme-pci: implement host memory buffer support")
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a)

| -rw-r--r-- | [drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/pci.c?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/drivers/nvme/host/pci.c b/drivers/nvme/host/pci.cindex 4b9fda0b1d9a33..34daf6d8db07b2 100644--- a/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=5e52f71f858eaff252a47530a5ad5e79309bd415)+++ b/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=3c2fb1ca8086eb139b2a551358137525ae8e0d7a)@@ -153,6 +153,7 @@ struct nvme\_dev { /\* host memory buffer support: \*/ u64 host\_mem\_size; u32 nr\_host\_mem\_descs;+ u32 host\_mem\_descs\_size; dma\_addr\_t host\_mem\_descs\_dma; struct nvme\_host\_mem\_buf\_desc \*host\_mem\_descs; void \*\*host\_mem\_desc\_bufs;@@ -1966,10 +1967,10 @@ static void nvme\_free\_host\_mem(struct nvme\_dev \*dev)  kfree(dev->host\_mem\_desc\_bufs); dev->host\_mem\_desc\_bufs = NULL;- dma\_free\_coherent(dev->dev,- dev->nr\_host\_mem\_descs \* sizeof(\*dev->host\_mem\_descs),+ dma\_free\_coherent(dev->dev, dev->host\_mem\_descs\_size, dev->host\_mem\_descs, dev->host\_mem\_descs\_dma); dev->host\_mem\_descs = NULL;+ dev->host\_mem\_descs\_size = 0; dev->nr\_host\_mem\_descs = 0; } @@ -1977,7 +1978,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, u32 chunk\_size) { struct nvme\_host\_mem\_buf\_desc \*descs;- u32 max\_entries, len;+ u32 max\_entries, len, descs\_size; dma\_addr\_t descs\_dma; int i = 0; void \*\*bufs;@@ -1990,8 +1991,9 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, if (dev->ctrl.hmmaxd && dev->ctrl.hmmaxd < max\_entries) max\_entries = dev->ctrl.hmmaxd; - descs = dma\_alloc\_coherent(dev->dev, max\_entries \* sizeof(\*descs),- &descs\_dma, GFP\_KERNEL);+ descs\_size = max\_entries \* sizeof(\*descs);+ descs = dma\_alloc\_coherent(dev->dev, descs\_size, &descs\_dma,+ GFP\_KERNEL); if (!descs) goto out; @@ -2020,6 +2022,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, dev->host\_mem\_size = size; dev->host\_mem\_descs = descs; dev->host\_mem\_descs\_dma = descs\_dma;+ dev->host\_mem\_descs\_size = descs\_size; dev->host\_mem\_desc\_bufs = bufs; return 0; @@ -2034,8 +2037,7 @@ out\_free\_bufs:  kfree(bufs); out\_free\_descs:- dma\_free\_coherent(dev->dev, max\_entries \* sizeof(\*descs), descs,- descs\_dma);+ dma\_free\_coherent(dev->dev, descs\_size, descs, descs\_dma); out: dev->host\_mem\_descs = NULL; return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:41:34 +0000



=== Content from git.kernel.org_cb6ece89_20250114_224303.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fb96d5cfa97a7363245b3dd523f475b04296d87b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb96d5cfa97a7363245b3dd523f475b04296d87b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb96d5cfa97a7363245b3dd523f475b04296d87b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb96d5cfa97a7363245b3dd523f475b04296d87b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christoph Hellwig <hch@lst.de> | 2024-11-01 05:40:04 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:14 +0100 |
| commit | [fb96d5cfa97a7363245b3dd523f475b04296d87b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb96d5cfa97a7363245b3dd523f475b04296d87b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fb96d5cfa97a7363245b3dd523f475b04296d87b)) | |
| tree | [ca8c1bf5dd18469c1753da0eb0adedeba87fbdd3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb96d5cfa97a7363245b3dd523f475b04296d87b) | |
| parent | [f892ddcf9f645380c358e73653cb0900f6bc9eb8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb96d5cfa97a7363245b3dd523f475b04296d87b&id2=f892ddcf9f645380c358e73653cb0900f6bc9eb8)) | |
| download | [linux-fb96d5cfa97a7363245b3dd523f475b04296d87b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fb96d5cfa97a7363245b3dd523f475b04296d87b.tar.gz) | |

nvme-pci: fix freeing of the HMB descriptor table[ Upstream commit 3c2fb1ca8086eb139b2a551358137525ae8e0d7a ]
The HMB descriptor table is sized to the maximum number of descriptors
that could be used for a given device, but \_\_nvme\_alloc\_host\_mem could
break out of the loop earlier on memory allocation failure and end up
using less descriptors than planned for, which leads to an incorrect
size passed to dma\_free\_coherent.
In practice this was not showing up because the number of descriptors
tends to be low and the dma coherent allocator always allocates and
frees at least a page.
Fixes: 87ad72a59a38 ("nvme-pci: implement host memory buffer support")
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb96d5cfa97a7363245b3dd523f475b04296d87b)

| -rw-r--r-- | [drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/pci.c?id=fb96d5cfa97a7363245b3dd523f475b04296d87b) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/drivers/nvme/host/pci.c b/drivers/nvme/host/pci.cindex f0063962c2c877..e09df396eb14c8 100644--- a/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8)+++ b/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=fb96d5cfa97a7363245b3dd523f475b04296d87b)@@ -153,6 +153,7 @@ struct nvme\_dev { /\* host memory buffer support: \*/ u64 host\_mem\_size; u32 nr\_host\_mem\_descs;+ u32 host\_mem\_descs\_size; dma\_addr\_t host\_mem\_descs\_dma; struct nvme\_host\_mem\_buf\_desc \*host\_mem\_descs; void \*\*host\_mem\_desc\_bufs;@@ -2007,10 +2008,10 @@ static void nvme\_free\_host\_mem(struct nvme\_dev \*dev)  kfree(dev->host\_mem\_desc\_bufs); dev->host\_mem\_desc\_bufs = NULL;- dma\_free\_coherent(dev->dev,- dev->nr\_host\_mem\_descs \* sizeof(\*dev->host\_mem\_descs),+ dma\_free\_coherent(dev->dev, dev->host\_mem\_descs\_size, dev->host\_mem\_descs, dev->host\_mem\_descs\_dma); dev->host\_mem\_descs = NULL;+ dev->host\_mem\_descs\_size = 0; dev->nr\_host\_mem\_descs = 0; } @@ -2018,7 +2019,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, u32 chunk\_size) { struct nvme\_host\_mem\_buf\_desc \*descs;- u32 max\_entries, len;+ u32 max\_entries, len, descs\_size; dma\_addr\_t descs\_dma; int i = 0; void \*\*bufs;@@ -2031,8 +2032,9 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, if (dev->ctrl.hmmaxd && dev->ctrl.hmmaxd < max\_entries) max\_entries = dev->ctrl.hmmaxd; - descs = dma\_alloc\_coherent(dev->dev, max\_entries \* sizeof(\*descs),- &descs\_dma, GFP\_KERNEL);+ descs\_size = max\_entries \* sizeof(\*descs);+ descs = dma\_alloc\_coherent(dev->dev, descs\_size, &descs\_dma,+ GFP\_KERNEL); if (!descs) goto out; @@ -2061,6 +2063,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, dev->host\_mem\_size = size; dev->host\_mem\_descs = descs; dev->host\_mem\_descs\_dma = descs\_dma;+ dev->host\_mem\_descs\_size = descs\_size; dev->host\_mem\_desc\_bufs = bufs; return 0; @@ -2075,8 +2078,7 @@ out\_free\_bufs:  kfree(bufs); out\_free\_descs:- dma\_free\_coherent(dev->dev, max\_entries \* sizeof(\*descs), descs,- descs\_dma);+ dma\_free\_coherent(dev->dev, descs\_size, descs, descs\_dma); out: dev->host\_mem\_descs = NULL; return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:41:40 +0000



=== Content from git.kernel.org_e1f303ea_20250114_224259.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=582d9ed999b004fb1d415ecbfa86d4d8df455269)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=582d9ed999b004fb1d415ecbfa86d4d8df455269)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=582d9ed999b004fb1d415ecbfa86d4d8df455269)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=582d9ed999b004fb1d415ecbfa86d4d8df455269)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christoph Hellwig <hch@lst.de> | 2024-11-01 05:40:04 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:13 +0100 |
| commit | [582d9ed999b004fb1d415ecbfa86d4d8df455269](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=582d9ed999b004fb1d415ecbfa86d4d8df455269) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=582d9ed999b004fb1d415ecbfa86d4d8df455269)) | |
| tree | [64adab68f2f7070e482bf9f4634a4cf0a12a3a4e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=582d9ed999b004fb1d415ecbfa86d4d8df455269) | |
| parent | [ca16ec00cd004fe1a4cb8c88413f7864e861d337](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca16ec00cd004fe1a4cb8c88413f7864e861d337) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=582d9ed999b004fb1d415ecbfa86d4d8df455269&id2=ca16ec00cd004fe1a4cb8c88413f7864e861d337)) | |
| download | [linux-582d9ed999b004fb1d415ecbfa86d4d8df455269.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-582d9ed999b004fb1d415ecbfa86d4d8df455269.tar.gz) | |

nvme-pci: fix freeing of the HMB descriptor table[ Upstream commit 3c2fb1ca8086eb139b2a551358137525ae8e0d7a ]
The HMB descriptor table is sized to the maximum number of descriptors
that could be used for a given device, but \_\_nvme\_alloc\_host\_mem could
break out of the loop earlier on memory allocation failure and end up
using less descriptors than planned for, which leads to an incorrect
size passed to dma\_free\_coherent.
In practice this was not showing up because the number of descriptors
tends to be low and the dma coherent allocator always allocates and
frees at least a page.
Fixes: 87ad72a59a38 ("nvme-pci: implement host memory buffer support")
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=582d9ed999b004fb1d415ecbfa86d4d8df455269)

| -rw-r--r-- | [drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/pci.c?id=582d9ed999b004fb1d415ecbfa86d4d8df455269) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/drivers/nvme/host/pci.c b/drivers/nvme/host/pci.cindex 4b9fda0b1d9a33..34daf6d8db07b2 100644--- a/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=ca16ec00cd004fe1a4cb8c88413f7864e861d337)+++ b/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=582d9ed999b004fb1d415ecbfa86d4d8df455269)@@ -153,6 +153,7 @@ struct nvme\_dev { /\* host memory buffer support: \*/ u64 host\_mem\_size; u32 nr\_host\_mem\_descs;+ u32 host\_mem\_descs\_size; dma\_addr\_t host\_mem\_descs\_dma; struct nvme\_host\_mem\_buf\_desc \*host\_mem\_descs; void \*\*host\_mem\_desc\_bufs;@@ -1966,10 +1967,10 @@ static void nvme\_free\_host\_mem(struct nvme\_dev \*dev)  kfree(dev->host\_mem\_desc\_bufs); dev->host\_mem\_desc\_bufs = NULL;- dma\_free\_coherent(dev->dev,- dev->nr\_host\_mem\_descs \* sizeof(\*dev->host\_mem\_descs),+ dma\_free\_coherent(dev->dev, dev->host\_mem\_descs\_size, dev->host\_mem\_descs, dev->host\_mem\_descs\_dma); dev->host\_mem\_descs = NULL;+ dev->host\_mem\_descs\_size = 0; dev->nr\_host\_mem\_descs = 0; } @@ -1977,7 +1978,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, u32 chunk\_size) { struct nvme\_host\_mem\_buf\_desc \*descs;- u32 max\_entries, len;+ u32 max\_entries, len, descs\_size; dma\_addr\_t descs\_dma; int i = 0; void \*\*bufs;@@ -1990,8 +1991,9 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, if (dev->ctrl.hmmaxd && dev->ctrl.hmmaxd < max\_entries) max\_entries = dev->ctrl.hmmaxd; - descs = dma\_alloc\_coherent(dev->dev, max\_entries \* sizeof(\*descs),- &descs\_dma, GFP\_KERNEL);+ descs\_size = max\_entries \* sizeof(\*descs);+ descs = dma\_alloc\_coherent(dev->dev, descs\_size, &descs\_dma,+ GFP\_KERNEL); if (!descs) goto out; @@ -2020,6 +2022,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, dev->host\_mem\_size = size; dev->host\_mem\_descs = descs; dev->host\_mem\_descs\_dma = descs\_dma;+ dev->host\_mem\_descs\_size = descs\_size; dev->host\_mem\_desc\_bufs = bufs; return 0; @@ -2034,8 +2037,7 @@ out\_free\_bufs:  kfree(bufs); out\_free\_descs:- dma\_free\_coherent(dev->dev, max\_entries \* sizeof(\*descs), descs,- descs\_dma);+ dma\_free\_coherent(dev->dev, descs\_size, descs, descs\_dma); out: dev->host\_mem\_descs = NULL; return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:41:36 +0000



=== Content from git.kernel.org_e4be69b7_20250114_224301.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christoph Hellwig <hch@lst.de> | 2024-11-01 05:40:04 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:43 +0100 |
| commit | [869cf50b9c9d1059f5223f79ef68fc0bc6210095](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095)) | |
| tree | [47ce944020c9848a540af3c84e96bb4641674d53](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095) | |
| parent | [6983b8ac787b3add5571cda563574932a59a99bb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6983b8ac787b3add5571cda563574932a59a99bb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095&id2=6983b8ac787b3add5571cda563574932a59a99bb)) | |
| download | [linux-869cf50b9c9d1059f5223f79ef68fc0bc6210095.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-869cf50b9c9d1059f5223f79ef68fc0bc6210095.tar.gz) | |

nvme-pci: fix freeing of the HMB descriptor table[ Upstream commit 3c2fb1ca8086eb139b2a551358137525ae8e0d7a ]
The HMB descriptor table is sized to the maximum number of descriptors
that could be used for a given device, but \_\_nvme\_alloc\_host\_mem could
break out of the loop earlier on memory allocation failure and end up
using less descriptors than planned for, which leads to an incorrect
size passed to dma\_free\_coherent.
In practice this was not showing up because the number of descriptors
tends to be low and the dma coherent allocator always allocates and
frees at least a page.
Fixes: 87ad72a59a38 ("nvme-pci: implement host memory buffer support")
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095)

| -rw-r--r-- | [drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/pci.c?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/drivers/nvme/host/pci.c b/drivers/nvme/host/pci.cindex 9e80e238954cad..04fedb27e35ad6 100644--- a/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=6983b8ac787b3add5571cda563574932a59a99bb)+++ b/[drivers/nvme/host/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/pci.c?id=869cf50b9c9d1059f5223f79ef68fc0bc6210095)@@ -150,6 +150,7 @@ struct nvme\_dev { /\* host memory buffer support: \*/ u64 host\_mem\_size; u32 nr\_host\_mem\_descs;+ u32 host\_mem\_descs\_size; dma\_addr\_t host\_mem\_descs\_dma; struct nvme\_host\_mem\_buf\_desc \*host\_mem\_descs; void \*\*host\_mem\_desc\_bufs;@@ -1921,10 +1922,10 @@ static void nvme\_free\_host\_mem(struct nvme\_dev \*dev)  kfree(dev->host\_mem\_desc\_bufs); dev->host\_mem\_desc\_bufs = NULL;- dma\_free\_coherent(dev->dev,- dev->nr\_host\_mem\_descs \* sizeof(\*dev->host\_mem\_descs),+ dma\_free\_coherent(dev->dev, dev->host\_mem\_descs\_size, dev->host\_mem\_descs, dev->host\_mem\_descs\_dma); dev->host\_mem\_descs = NULL;+ dev->host\_mem\_descs\_size = 0; dev->nr\_host\_mem\_descs = 0; } @@ -1932,7 +1933,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, u32 chunk\_size) { struct nvme\_host\_mem\_buf\_desc \*descs;- u32 max\_entries, len;+ u32 max\_entries, len, descs\_size; dma\_addr\_t descs\_dma; int i = 0; void \*\*bufs;@@ -1945,8 +1946,9 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, if (dev->ctrl.hmmaxd && dev->ctrl.hmmaxd < max\_entries) max\_entries = dev->ctrl.hmmaxd; - descs = dma\_alloc\_coherent(dev->dev, max\_entries \* sizeof(\*descs),- &descs\_dma, GFP\_KERNEL);+ descs\_size = max\_entries \* sizeof(\*descs);+ descs = dma\_alloc\_coherent(dev->dev, descs\_size, &descs\_dma,+ GFP\_KERNEL); if (!descs) goto out; @@ -1975,6 +1977,7 @@ static int \_\_nvme\_alloc\_host\_mem(struct nvme\_dev \*dev, u64 preferred, dev->host\_mem\_size = size; dev->host\_mem\_descs = descs; dev->host\_mem\_descs\_dma = descs\_dma;+ dev->host\_mem\_descs\_size = descs\_size; dev->host\_mem\_desc\_bufs = bufs; return 0; @@ -1989,8 +1992,7 @@ out\_free\_bufs:  kfree(bufs); out\_free\_descs:- dma\_free\_coherent(dev->dev, max\_entries \* sizeof(\*descs), descs,- descs\_dma);+ dma\_free\_coherent(dev->dev, descs\_size, descs, descs\_dma); out: dev->host\_mem\_descs = NULL; return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:41:38 +0000


