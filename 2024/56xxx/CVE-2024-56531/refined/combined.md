=== Content from git.kernel.org_d0cf8d3f_20250114_182850.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-13 12:10:38 +0100 |
| --- | --- | --- |
| committer | Takashi Iwai <tiwai@suse.de> | 2024-11-13 13:33:47 +0100 |
| commit | [b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)) | |
| tree | [eb1eb63feb57b6a262980400829c3ef7c9b58929](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c) | |
| parent | [f86af06306a7c36451b0174e3c64bc935d04f5e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f86af06306a7c36451b0174e3c64bc935d04f5e5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c&id2=f86af06306a7c36451b0174e3c64bc935d04f5e5)) | |
| download | [linux-b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c.tar.gz) | |

ALSA: caiaq: Use snd\_card\_free\_when\_closed() at disconnectionThe USB disconnect callback is supposed to be short and not too-long
waiting. OTOH, the current code uses snd\_card\_free() at
disconnection, but this waits for the close of all used fds, hence it
can take long. It eventually blocks the upper layer USB ioctls, which
may trigger a soft lockup.
An easy workaround is to replace snd\_card\_free() with
snd\_card\_free\_when\_closed(). This variant returns immediately while
the release of resources is done asynchronously by the card device
release at the last close.
This patch also splits the code to the disconnect and the free phases;
the former is called immediately at the USB disconnect callback while
the latter is called from the card destructor.
Fixes: 523f1dce3743 ("[ALSA] Add Native Instrument usb audio device support")
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Link: [https://patch.msgid.link/20241113111042.15058-5-tiwai@suse.de](https://patch.msgid.link/20241113111042.15058-5-tiwai%40suse.de)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)

| -rw-r--r-- | [sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.c?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.h?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/device.c?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.c?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.h?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c) | 1 | |  |  |  | | --- | --- | --- | |

5 files changed, 34 insertions, 9 deletions

| diff --git a/sound/usb/caiaq/audio.c b/sound/usb/caiaq/audio.cindex 772c0ecb707738..05f964347ed6c2 100644--- a/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=f86af06306a7c36451b0174e3c64bc935d04f5e5)+++ b/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)@@ -858,14 +858,20 @@ int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev) return 0; } -void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { struct device \*dev = caiaqdev\_to\_dev(cdev);  dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); stream\_stop(cdev);+}++void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ struct device \*dev = caiaqdev\_to\_dev(cdev);++ dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); free\_urbs(cdev->data\_urbs\_in); free\_urbs(cdev->data\_urbs\_out); kfree(cdev->data\_cb\_info); }-diff --git a/sound/usb/caiaq/audio.h b/sound/usb/caiaq/audio.hindex 869bf6264d6a09..07f5d064456cf7 100644--- a/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=f86af06306a7c36451b0174e3c64bc935d04f5e5)+++ b/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)@@ -3,6 +3,7 @@ #define CAIAQ\_AUDIO\_H  int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif /\* CAIAQ\_AUDIO\_H \*/diff --git a/sound/usb/caiaq/device.c b/sound/usb/caiaq/device.cindex b5cbf1f195c48c..dfd820483849eb 100644--- a/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=f86af06306a7c36451b0174e3c64bc935d04f5e5)+++ b/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)@@ -376,6 +376,17 @@ static void setup\_card(struct snd\_usb\_caiaqdev \*cdev) dev\_err(dev, "Unable to set up control system (ret=%d)\n", ret); } +static void card\_free(struct snd\_card \*card)+{+ struct snd\_usb\_caiaqdev \*cdev = caiaqdev(card);++#ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT+ snd\_usb\_caiaq\_input\_free(cdev);+#endif+ snd\_usb\_caiaq\_audio\_free(cdev);+ usb\_reset\_device(cdev->chip.dev);+}+ static int create\_card(struct usb\_device \*usb\_dev, struct usb\_interface \*intf, struct snd\_card \*\*cardp)@@ -489,6 +500,7 @@ static int init\_card(struct snd\_usb\_caiaqdev \*cdev) cdev->vendor\_name, cdev->product\_name, usbpath);  setup\_card(cdev);+ card->private\_free = card\_free; return 0;  err\_kill\_urb:@@ -534,15 +546,14 @@ static void snd\_disconnect(struct usb\_interface \*intf) snd\_card\_disconnect(card);  #ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT- snd\_usb\_caiaq\_input\_free(cdev);+ snd\_usb\_caiaq\_input\_disconnect(cdev); #endif- snd\_usb\_caiaq\_audio\_free(cdev);+ snd\_usb\_caiaq\_audio\_disconnect(cdev);  usb\_kill\_urb(&cdev->ep1\_in\_urb); usb\_kill\_urb(&cdev->midi\_out\_urb); - snd\_card\_free(card);- usb\_reset\_device(interface\_to\_usbdev(intf));+ snd\_card\_free\_when\_closed(card); }  diff --git a/sound/usb/caiaq/input.c b/sound/usb/caiaq/input.cindex 84f26dce7f5d03..a9130891bb696d 100644--- a/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=f86af06306a7c36451b0174e3c64bc935d04f5e5)+++ b/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)@@ -829,15 +829,21 @@ exit\_free\_idev: return ret; } -void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { if (!cdev || !cdev->input\_dev) return;  usb\_kill\_urb(cdev->ep4\_in\_urb);+ input\_unregister\_device(cdev->input\_dev);+}++void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ if (!cdev || !cdev->input\_dev)+ return;+ usb\_free\_urb(cdev->ep4\_in\_urb); cdev->ep4\_in\_urb = NULL;-- input\_unregister\_device(cdev->input\_dev); cdev->input\_dev = NULL; }diff --git a/sound/usb/caiaq/input.h b/sound/usb/caiaq/input.hindex c42891e7be884d..fbe267f85d025f 100644--- a/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=f86af06306a7c36451b0174e3c64bc935d04f5e5)+++ b/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c)@@ -4,6 +4,7 @@  void snd\_usb\_caiaq\_input\_dispatch(struct snd\_usb\_caiaqdev \*cdev, char \*buf, unsigned int len); int snd\_usb\_caiaq\_input\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:27:26 +0000



=== Content from git.kernel.org_28d1ec18_20250114_182845.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-13 12:10:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:33 +0100 |
| commit | [3993edf44d3df7b6e8c753eac6ac8783473fcbab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)) | |
| tree | [b134c9cbdf215071ac726fdb3364d7415e1282ca](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab) | |
| parent | [020cbc4d7414f0962004213e2b7bc5cc607e9ec7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=020cbc4d7414f0962004213e2b7bc5cc607e9ec7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab&id2=020cbc4d7414f0962004213e2b7bc5cc607e9ec7)) | |
| download | [linux-3993edf44d3df7b6e8c753eac6ac8783473fcbab.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3993edf44d3df7b6e8c753eac6ac8783473fcbab.tar.gz) | |

ALSA: caiaq: Use snd\_card\_free\_when\_closed() at disconnection[ Upstream commit b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c ]
The USB disconnect callback is supposed to be short and not too-long
waiting. OTOH, the current code uses snd\_card\_free() at
disconnection, but this waits for the close of all used fds, hence it
can take long. It eventually blocks the upper layer USB ioctls, which
may trigger a soft lockup.
An easy workaround is to replace snd\_card\_free() with
snd\_card\_free\_when\_closed(). This variant returns immediately while
the release of resources is done asynchronously by the card device
release at the last close.
This patch also splits the code to the disconnect and the free phases;
the former is called immediately at the USB disconnect callback while
the latter is called from the card destructor.
Fixes: 523f1dce3743 ("[ALSA] Add Native Instrument usb audio device support")
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Link: [https://patch.msgid.link/20241113111042.15058-5-tiwai@suse.de](https://patch.msgid.link/20241113111042.15058-5-tiwai%40suse.de)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)

| -rw-r--r-- | [sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.c?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.h?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/device.c?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.c?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.h?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab) | 1 | |  |  |  | | --- | --- | --- | |

5 files changed, 34 insertions, 9 deletions

| diff --git a/sound/usb/caiaq/audio.c b/sound/usb/caiaq/audio.cindex c6108a3d7f8f8d..9c6a2295d45af9 100644--- a/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=020cbc4d7414f0962004213e2b7bc5cc607e9ec7)+++ b/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)@@ -890,14 +890,20 @@ int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev) return 0; } -void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { struct device \*dev = caiaqdev\_to\_dev(cdev);  dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); stream\_stop(cdev);+}++void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ struct device \*dev = caiaqdev\_to\_dev(cdev);++ dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); free\_urbs(cdev->data\_urbs\_in); free\_urbs(cdev->data\_urbs\_out); kfree(cdev->data\_cb\_info); }-diff --git a/sound/usb/caiaq/audio.h b/sound/usb/caiaq/audio.hindex 869bf6264d6a09..07f5d064456cf7 100644--- a/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=020cbc4d7414f0962004213e2b7bc5cc607e9ec7)+++ b/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)@@ -3,6 +3,7 @@ #define CAIAQ\_AUDIO\_H  int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif /\* CAIAQ\_AUDIO\_H \*/diff --git a/sound/usb/caiaq/device.c b/sound/usb/caiaq/device.cindex d55ca48de3ea3a..4df7f37aa670bf 100644--- a/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=020cbc4d7414f0962004213e2b7bc5cc607e9ec7)+++ b/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)@@ -402,6 +402,17 @@ static void setup\_card(struct snd\_usb\_caiaqdev \*cdev) dev\_err(dev, "Unable to set up control system (ret=%d)\n", ret); } +static void card\_free(struct snd\_card \*card)+{+ struct snd\_usb\_caiaqdev \*cdev = caiaqdev(card);++#ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT+ snd\_usb\_caiaq\_input\_free(cdev);+#endif+ snd\_usb\_caiaq\_audio\_free(cdev);+ usb\_reset\_device(cdev->chip.dev);+}+ static int create\_card(struct usb\_device \*usb\_dev, struct usb\_interface \*intf, struct snd\_card \*\*cardp)@@ -515,6 +526,7 @@ static int init\_card(struct snd\_usb\_caiaqdev \*cdev) cdev->vendor\_name, cdev->product\_name, usbpath);  setup\_card(cdev);+ card->private\_free = card\_free; return 0;  err\_kill\_urb:@@ -560,15 +572,14 @@ static void snd\_disconnect(struct usb\_interface \*intf) snd\_card\_disconnect(card);  #ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT- snd\_usb\_caiaq\_input\_free(cdev);+ snd\_usb\_caiaq\_input\_disconnect(cdev); #endif- snd\_usb\_caiaq\_audio\_free(cdev);+ snd\_usb\_caiaq\_audio\_disconnect(cdev);  usb\_kill\_urb(&cdev->ep1\_in\_urb); usb\_kill\_urb(&cdev->midi\_out\_urb); - snd\_card\_free(card);- usb\_reset\_device(interface\_to\_usbdev(intf));+ snd\_card\_free\_when\_closed(card); }  diff --git a/sound/usb/caiaq/input.c b/sound/usb/caiaq/input.cindex 19951e1dbbb019..a01a242f5c9956 100644--- a/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=020cbc4d7414f0962004213e2b7bc5cc607e9ec7)+++ b/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)@@ -842,15 +842,21 @@ exit\_free\_idev: return ret; } -void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { if (!cdev || !cdev->input\_dev) return;  usb\_kill\_urb(cdev->ep4\_in\_urb);+ input\_unregister\_device(cdev->input\_dev);+}++void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ if (!cdev || !cdev->input\_dev)+ return;+ usb\_free\_urb(cdev->ep4\_in\_urb); cdev->ep4\_in\_urb = NULL;-- input\_unregister\_device(cdev->input\_dev); cdev->input\_dev = NULL; }diff --git a/sound/usb/caiaq/input.h b/sound/usb/caiaq/input.hindex c42891e7be884d..fbe267f85d025f 100644--- a/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=020cbc4d7414f0962004213e2b7bc5cc607e9ec7)+++ b/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=3993edf44d3df7b6e8c753eac6ac8783473fcbab)@@ -4,6 +4,7 @@  void snd\_usb\_caiaq\_input\_dispatch(struct snd\_usb\_caiaqdev \*cdev, char \*buf, unsigned int len); int snd\_usb\_caiaq\_input\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:27:22 +0000



=== Content from git.kernel.org_3336d5f5_20250114_182851.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-13 12:10:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:59 +0100 |
| commit | [cadf1d8e9ddcd74584ec961aeac14ac549b261d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)) | |
| tree | [bd56764f2bed5b55f4a9f2c6185d73327f2c7496](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8) | |
| parent | [9a48bd2184b142c92a4e17eac074c61fcf975bc9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a48bd2184b142c92a4e17eac074c61fcf975bc9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8&id2=9a48bd2184b142c92a4e17eac074c61fcf975bc9)) | |
| download | [linux-cadf1d8e9ddcd74584ec961aeac14ac549b261d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cadf1d8e9ddcd74584ec961aeac14ac549b261d8.tar.gz) | |

ALSA: caiaq: Use snd\_card\_free\_when\_closed() at disconnection[ Upstream commit b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c ]
The USB disconnect callback is supposed to be short and not too-long
waiting. OTOH, the current code uses snd\_card\_free() at
disconnection, but this waits for the close of all used fds, hence it
can take long. It eventually blocks the upper layer USB ioctls, which
may trigger a soft lockup.
An easy workaround is to replace snd\_card\_free() with
snd\_card\_free\_when\_closed(). This variant returns immediately while
the release of resources is done asynchronously by the card device
release at the last close.
This patch also splits the code to the disconnect and the free phases;
the former is called immediately at the USB disconnect callback while
the latter is called from the card destructor.
Fixes: 523f1dce3743 ("[ALSA] Add Native Instrument usb audio device support")
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Link: [https://patch.msgid.link/20241113111042.15058-5-tiwai@suse.de](https://patch.msgid.link/20241113111042.15058-5-tiwai%40suse.de)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)

| -rw-r--r-- | [sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.c?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.h?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/device.c?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.c?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.h?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8) | 1 | |  |  |  | | --- | --- | --- | |

5 files changed, 34 insertions, 9 deletions

| diff --git a/sound/usb/caiaq/audio.c b/sound/usb/caiaq/audio.cindex 4981753652a7fe..7a89872aa0cbd6 100644--- a/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=9a48bd2184b142c92a4e17eac074c61fcf975bc9)+++ b/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)@@ -869,14 +869,20 @@ int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev) return 0; } -void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { struct device \*dev = caiaqdev\_to\_dev(cdev);  dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); stream\_stop(cdev);+}++void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ struct device \*dev = caiaqdev\_to\_dev(cdev);++ dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); free\_urbs(cdev->data\_urbs\_in); free\_urbs(cdev->data\_urbs\_out); kfree(cdev->data\_cb\_info); }-diff --git a/sound/usb/caiaq/audio.h b/sound/usb/caiaq/audio.hindex 869bf6264d6a09..07f5d064456cf7 100644--- a/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=9a48bd2184b142c92a4e17eac074c61fcf975bc9)+++ b/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)@@ -3,6 +3,7 @@ #define CAIAQ\_AUDIO\_H  int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif /\* CAIAQ\_AUDIO\_H \*/diff --git a/sound/usb/caiaq/device.c b/sound/usb/caiaq/device.cindex 49f63f878e6fe8..d5c01d3f126ee8 100644--- a/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=9a48bd2184b142c92a4e17eac074c61fcf975bc9)+++ b/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)@@ -376,6 +376,17 @@ static void setup\_card(struct snd\_usb\_caiaqdev \*cdev) dev\_err(dev, "Unable to set up control system (ret=%d)\n", ret); } +static void card\_free(struct snd\_card \*card)+{+ struct snd\_usb\_caiaqdev \*cdev = caiaqdev(card);++#ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT+ snd\_usb\_caiaq\_input\_free(cdev);+#endif+ snd\_usb\_caiaq\_audio\_free(cdev);+ usb\_reset\_device(cdev->chip.dev);+}+ static int create\_card(struct usb\_device \*usb\_dev, struct usb\_interface \*intf, struct snd\_card \*\*cardp)@@ -489,6 +500,7 @@ static int init\_card(struct snd\_usb\_caiaqdev \*cdev) cdev->vendor\_name, cdev->product\_name, usbpath);  setup\_card(cdev);+ card->private\_free = card\_free; return 0;  err\_kill\_urb:@@ -534,15 +546,14 @@ static void snd\_disconnect(struct usb\_interface \*intf) snd\_card\_disconnect(card);  #ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT- snd\_usb\_caiaq\_input\_free(cdev);+ snd\_usb\_caiaq\_input\_disconnect(cdev); #endif- snd\_usb\_caiaq\_audio\_free(cdev);+ snd\_usb\_caiaq\_audio\_disconnect(cdev);  usb\_kill\_urb(&cdev->ep1\_in\_urb); usb\_kill\_urb(&cdev->midi\_out\_urb); - snd\_card\_free(card);- usb\_reset\_device(interface\_to\_usbdev(intf));+ snd\_card\_free\_when\_closed(card); }  diff --git a/sound/usb/caiaq/input.c b/sound/usb/caiaq/input.cindex 84f26dce7f5d03..a9130891bb696d 100644--- a/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=9a48bd2184b142c92a4e17eac074c61fcf975bc9)+++ b/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)@@ -829,15 +829,21 @@ exit\_free\_idev: return ret; } -void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { if (!cdev || !cdev->input\_dev) return;  usb\_kill\_urb(cdev->ep4\_in\_urb);+ input\_unregister\_device(cdev->input\_dev);+}++void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ if (!cdev || !cdev->input\_dev)+ return;+ usb\_free\_urb(cdev->ep4\_in\_urb); cdev->ep4\_in\_urb = NULL;-- input\_unregister\_device(cdev->input\_dev); cdev->input\_dev = NULL; }diff --git a/sound/usb/caiaq/input.h b/sound/usb/caiaq/input.hindex c42891e7be884d..fbe267f85d025f 100644--- a/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=9a48bd2184b142c92a4e17eac074c61fcf975bc9)+++ b/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=cadf1d8e9ddcd74584ec961aeac14ac549b261d8)@@ -4,6 +4,7 @@  void snd\_usb\_caiaq\_input\_dispatch(struct snd\_usb\_caiaqdev \*cdev, char \*buf, unsigned int len); int snd\_usb\_caiaq\_input\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:27:28 +0000



=== Content from git.kernel.org_e8815614_20250114_182853.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ebad462eec93b0f701dfe4de98990e7355283801)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ebad462eec93b0f701dfe4de98990e7355283801)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebad462eec93b0f701dfe4de98990e7355283801)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebad462eec93b0f701dfe4de98990e7355283801)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-13 12:10:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:27 +0100 |
| commit | [ebad462eec93b0f701dfe4de98990e7355283801](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebad462eec93b0f701dfe4de98990e7355283801) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ebad462eec93b0f701dfe4de98990e7355283801)) | |
| tree | [3cb3d1960355016b68d49010028c471b341cfe25](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ebad462eec93b0f701dfe4de98990e7355283801) | |
| parent | [75f418b249d84021865eaa59515d3ed9b75ce4d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=75f418b249d84021865eaa59515d3ed9b75ce4d6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebad462eec93b0f701dfe4de98990e7355283801&id2=75f418b249d84021865eaa59515d3ed9b75ce4d6)) | |
| download | [linux-ebad462eec93b0f701dfe4de98990e7355283801.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ebad462eec93b0f701dfe4de98990e7355283801.tar.gz) | |

ALSA: caiaq: Use snd\_card\_free\_when\_closed() at disconnection[ Upstream commit b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c ]
The USB disconnect callback is supposed to be short and not too-long
waiting. OTOH, the current code uses snd\_card\_free() at
disconnection, but this waits for the close of all used fds, hence it
can take long. It eventually blocks the upper layer USB ioctls, which
may trigger a soft lockup.
An easy workaround is to replace snd\_card\_free() with
snd\_card\_free\_when\_closed(). This variant returns immediately while
the release of resources is done asynchronously by the card device
release at the last close.
This patch also splits the code to the disconnect and the free phases;
the former is called immediately at the USB disconnect callback while
the latter is called from the card destructor.
Fixes: 523f1dce3743 ("[ALSA] Add Native Instrument usb audio device support")
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Link: [https://patch.msgid.link/20241113111042.15058-5-tiwai@suse.de](https://patch.msgid.link/20241113111042.15058-5-tiwai%40suse.de)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebad462eec93b0f701dfe4de98990e7355283801)

| -rw-r--r-- | [sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.c?id=ebad462eec93b0f701dfe4de98990e7355283801) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.h?id=ebad462eec93b0f701dfe4de98990e7355283801) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/device.c?id=ebad462eec93b0f701dfe4de98990e7355283801) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.c?id=ebad462eec93b0f701dfe4de98990e7355283801) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.h?id=ebad462eec93b0f701dfe4de98990e7355283801) | 1 | |  |  |  | | --- | --- | --- | |

5 files changed, 34 insertions, 9 deletions

| diff --git a/sound/usb/caiaq/audio.c b/sound/usb/caiaq/audio.cindex 444bb637ce13c6..890fc5a34f6453 100644--- a/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=75f418b249d84021865eaa59515d3ed9b75ce4d6)+++ b/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=ebad462eec93b0f701dfe4de98990e7355283801)@@ -877,14 +877,20 @@ int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev) return 0; } -void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { struct device \*dev = caiaqdev\_to\_dev(cdev);  dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); stream\_stop(cdev);+}++void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ struct device \*dev = caiaqdev\_to\_dev(cdev);++ dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); free\_urbs(cdev->data\_urbs\_in); free\_urbs(cdev->data\_urbs\_out); kfree(cdev->data\_cb\_info); }-diff --git a/sound/usb/caiaq/audio.h b/sound/usb/caiaq/audio.hindex 869bf6264d6a09..07f5d064456cf7 100644--- a/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=75f418b249d84021865eaa59515d3ed9b75ce4d6)+++ b/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=ebad462eec93b0f701dfe4de98990e7355283801)@@ -3,6 +3,7 @@ #define CAIAQ\_AUDIO\_H  int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif /\* CAIAQ\_AUDIO\_H \*/diff --git a/sound/usb/caiaq/device.c b/sound/usb/caiaq/device.cindex b669e119f65465..13b57fbb6c6a7c 100644--- a/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=75f418b249d84021865eaa59515d3ed9b75ce4d6)+++ b/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=ebad462eec93b0f701dfe4de98990e7355283801)@@ -390,6 +390,17 @@ static void setup\_card(struct snd\_usb\_caiaqdev \*cdev) dev\_err(dev, "Unable to set up control system (ret=%d)\n", ret); } +static void card\_free(struct snd\_card \*card)+{+ struct snd\_usb\_caiaqdev \*cdev = caiaqdev(card);++#ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT+ snd\_usb\_caiaq\_input\_free(cdev);+#endif+ snd\_usb\_caiaq\_audio\_free(cdev);+ usb\_reset\_device(cdev->chip.dev);+}+ static int create\_card(struct usb\_device \*usb\_dev, struct usb\_interface \*intf, struct snd\_card \*\*cardp)@@ -503,6 +514,7 @@ static int init\_card(struct snd\_usb\_caiaqdev \*cdev) cdev->vendor\_name, cdev->product\_name, usbpath);  setup\_card(cdev);+ card->private\_free = card\_free; return 0;  err\_kill\_urb:@@ -548,15 +560,14 @@ static void snd\_disconnect(struct usb\_interface \*intf) snd\_card\_disconnect(card);  #ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT- snd\_usb\_caiaq\_input\_free(cdev);+ snd\_usb\_caiaq\_input\_disconnect(cdev); #endif- snd\_usb\_caiaq\_audio\_free(cdev);+ snd\_usb\_caiaq\_audio\_disconnect(cdev);  usb\_kill\_urb(&cdev->ep1\_in\_urb); usb\_kill\_urb(&cdev->midi\_out\_urb); - snd\_card\_free(card);- usb\_reset\_device(interface\_to\_usbdev(intf));+ snd\_card\_free\_when\_closed(card); }  diff --git a/sound/usb/caiaq/input.c b/sound/usb/caiaq/input.cindex cd5a8584dbe328..d22dc5553c2cd0 100644--- a/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=75f418b249d84021865eaa59515d3ed9b75ce4d6)+++ b/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=ebad462eec93b0f701dfe4de98990e7355283801)@@ -829,15 +829,21 @@ exit\_free\_idev: return ret; } -void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { if (!cdev || !cdev->input\_dev) return;  usb\_kill\_urb(cdev->ep4\_in\_urb);+ input\_unregister\_device(cdev->input\_dev);+}++void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ if (!cdev || !cdev->input\_dev)+ return;+ usb\_free\_urb(cdev->ep4\_in\_urb); cdev->ep4\_in\_urb = NULL;-- input\_unregister\_device(cdev->input\_dev); cdev->input\_dev = NULL; }diff --git a/sound/usb/caiaq/input.h b/sound/usb/caiaq/input.hindex c42891e7be884d..fbe267f85d025f 100644--- a/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=75f418b249d84021865eaa59515d3ed9b75ce4d6)+++ b/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=ebad462eec93b0f701dfe4de98990e7355283801)@@ -4,6 +4,7 @@  void snd\_usb\_caiaq\_input\_dispatch(struct snd\_usb\_caiaqdev \*cdev, char \*buf, unsigned int len); int snd\_usb\_caiaq\_input\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:27:29 +0000



=== Content from git.kernel.org_681dc768_20250114_182843.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=237f3faf0177bdde728fa3106d730d806436aa4d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=237f3faf0177bdde728fa3106d730d806436aa4d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=237f3faf0177bdde728fa3106d730d806436aa4d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=237f3faf0177bdde728fa3106d730d806436aa4d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-13 12:10:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:34 +0100 |
| commit | [237f3faf0177bdde728fa3106d730d806436aa4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=237f3faf0177bdde728fa3106d730d806436aa4d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=237f3faf0177bdde728fa3106d730d806436aa4d)) | |
| tree | [5c2fa2c1a2e1f8b501200730494634f5c52e1fbc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=237f3faf0177bdde728fa3106d730d806436aa4d) | |
| parent | [bc778ad3e495333eebda36fe91d5b2c93109cc16](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc778ad3e495333eebda36fe91d5b2c93109cc16) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=237f3faf0177bdde728fa3106d730d806436aa4d&id2=bc778ad3e495333eebda36fe91d5b2c93109cc16)) | |
| download | [linux-237f3faf0177bdde728fa3106d730d806436aa4d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-237f3faf0177bdde728fa3106d730d806436aa4d.tar.gz) | |

ALSA: caiaq: Use snd\_card\_free\_when\_closed() at disconnection[ Upstream commit b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c ]
The USB disconnect callback is supposed to be short and not too-long
waiting. OTOH, the current code uses snd\_card\_free() at
disconnection, but this waits for the close of all used fds, hence it
can take long. It eventually blocks the upper layer USB ioctls, which
may trigger a soft lockup.
An easy workaround is to replace snd\_card\_free() with
snd\_card\_free\_when\_closed(). This variant returns immediately while
the release of resources is done asynchronously by the card device
release at the last close.
This patch also splits the code to the disconnect and the free phases;
the former is called immediately at the USB disconnect callback while
the latter is called from the card destructor.
Fixes: 523f1dce3743 ("[ALSA] Add Native Instrument usb audio device support")
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Link: [https://patch.msgid.link/20241113111042.15058-5-tiwai@suse.de](https://patch.msgid.link/20241113111042.15058-5-tiwai%40suse.de)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=237f3faf0177bdde728fa3106d730d806436aa4d)

| -rw-r--r-- | [sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.c?id=237f3faf0177bdde728fa3106d730d806436aa4d) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.h?id=237f3faf0177bdde728fa3106d730d806436aa4d) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/device.c?id=237f3faf0177bdde728fa3106d730d806436aa4d) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.c?id=237f3faf0177bdde728fa3106d730d806436aa4d) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.h?id=237f3faf0177bdde728fa3106d730d806436aa4d) | 1 | |  |  |  | | --- | --- | --- | |

5 files changed, 34 insertions, 9 deletions

| diff --git a/sound/usb/caiaq/audio.c b/sound/usb/caiaq/audio.cindex 4981753652a7fe..7a89872aa0cbd6 100644--- a/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=bc778ad3e495333eebda36fe91d5b2c93109cc16)+++ b/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=237f3faf0177bdde728fa3106d730d806436aa4d)@@ -869,14 +869,20 @@ int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev) return 0; } -void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { struct device \*dev = caiaqdev\_to\_dev(cdev);  dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); stream\_stop(cdev);+}++void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ struct device \*dev = caiaqdev\_to\_dev(cdev);++ dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); free\_urbs(cdev->data\_urbs\_in); free\_urbs(cdev->data\_urbs\_out); kfree(cdev->data\_cb\_info); }-diff --git a/sound/usb/caiaq/audio.h b/sound/usb/caiaq/audio.hindex 869bf6264d6a09..07f5d064456cf7 100644--- a/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=bc778ad3e495333eebda36fe91d5b2c93109cc16)+++ b/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=237f3faf0177bdde728fa3106d730d806436aa4d)@@ -3,6 +3,7 @@ #define CAIAQ\_AUDIO\_H  int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif /\* CAIAQ\_AUDIO\_H \*/diff --git a/sound/usb/caiaq/device.c b/sound/usb/caiaq/device.cindex 49f63f878e6fe8..d5c01d3f126ee8 100644--- a/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=bc778ad3e495333eebda36fe91d5b2c93109cc16)+++ b/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=237f3faf0177bdde728fa3106d730d806436aa4d)@@ -376,6 +376,17 @@ static void setup\_card(struct snd\_usb\_caiaqdev \*cdev) dev\_err(dev, "Unable to set up control system (ret=%d)\n", ret); } +static void card\_free(struct snd\_card \*card)+{+ struct snd\_usb\_caiaqdev \*cdev = caiaqdev(card);++#ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT+ snd\_usb\_caiaq\_input\_free(cdev);+#endif+ snd\_usb\_caiaq\_audio\_free(cdev);+ usb\_reset\_device(cdev->chip.dev);+}+ static int create\_card(struct usb\_device \*usb\_dev, struct usb\_interface \*intf, struct snd\_card \*\*cardp)@@ -489,6 +500,7 @@ static int init\_card(struct snd\_usb\_caiaqdev \*cdev) cdev->vendor\_name, cdev->product\_name, usbpath);  setup\_card(cdev);+ card->private\_free = card\_free; return 0;  err\_kill\_urb:@@ -534,15 +546,14 @@ static void snd\_disconnect(struct usb\_interface \*intf) snd\_card\_disconnect(card);  #ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT- snd\_usb\_caiaq\_input\_free(cdev);+ snd\_usb\_caiaq\_input\_disconnect(cdev); #endif- snd\_usb\_caiaq\_audio\_free(cdev);+ snd\_usb\_caiaq\_audio\_disconnect(cdev);  usb\_kill\_urb(&cdev->ep1\_in\_urb); usb\_kill\_urb(&cdev->midi\_out\_urb); - snd\_card\_free(card);- usb\_reset\_device(interface\_to\_usbdev(intf));+ snd\_card\_free\_when\_closed(card); }  diff --git a/sound/usb/caiaq/input.c b/sound/usb/caiaq/input.cindex 84f26dce7f5d03..a9130891bb696d 100644--- a/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=bc778ad3e495333eebda36fe91d5b2c93109cc16)+++ b/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=237f3faf0177bdde728fa3106d730d806436aa4d)@@ -829,15 +829,21 @@ exit\_free\_idev: return ret; } -void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { if (!cdev || !cdev->input\_dev) return;  usb\_kill\_urb(cdev->ep4\_in\_urb);+ input\_unregister\_device(cdev->input\_dev);+}++void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ if (!cdev || !cdev->input\_dev)+ return;+ usb\_free\_urb(cdev->ep4\_in\_urb); cdev->ep4\_in\_urb = NULL;-- input\_unregister\_device(cdev->input\_dev); cdev->input\_dev = NULL; }diff --git a/sound/usb/caiaq/input.h b/sound/usb/caiaq/input.hindex c42891e7be884d..fbe267f85d025f 100644--- a/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=bc778ad3e495333eebda36fe91d5b2c93109cc16)+++ b/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=237f3faf0177bdde728fa3106d730d806436aa4d)@@ -4,6 +4,7 @@  void snd\_usb\_caiaq\_input\_dispatch(struct snd\_usb\_caiaqdev \*cdev, char \*buf, unsigned int len); int snd\_usb\_caiaq\_input\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:27:20 +0000



=== Content from git.kernel.org_d0da2735_20250114_182848.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-13 12:10:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:58 +0100 |
| commit | [a3f9314752dbb6f6aa1f0f2b4c58243bda800738](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)) | |
| tree | [289020b6b04bcdb373e58e6d44ada3a527227830](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738) | |
| parent | [9d5c530e4d70f64b1114f2cc29ac690ba7ac4a38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d5c530e4d70f64b1114f2cc29ac690ba7ac4a38) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738&id2=9d5c530e4d70f64b1114f2cc29ac690ba7ac4a38)) | |
| download | [linux-a3f9314752dbb6f6aa1f0f2b4c58243bda800738.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a3f9314752dbb6f6aa1f0f2b4c58243bda800738.tar.gz) | |

ALSA: caiaq: Use snd\_card\_free\_when\_closed() at disconnection[ Upstream commit b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c ]
The USB disconnect callback is supposed to be short and not too-long
waiting. OTOH, the current code uses snd\_card\_free() at
disconnection, but this waits for the close of all used fds, hence it
can take long. It eventually blocks the upper layer USB ioctls, which
may trigger a soft lockup.
An easy workaround is to replace snd\_card\_free() with
snd\_card\_free\_when\_closed(). This variant returns immediately while
the release of resources is done asynchronously by the card device
release at the last close.
This patch also splits the code to the disconnect and the free phases;
the former is called immediately at the USB disconnect callback while
the latter is called from the card destructor.
Fixes: 523f1dce3743 ("[ALSA] Add Native Instrument usb audio device support")
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Link: [https://patch.msgid.link/20241113111042.15058-5-tiwai@suse.de](https://patch.msgid.link/20241113111042.15058-5-tiwai%40suse.de)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)

| -rw-r--r-- | [sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.c?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.h?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/device.c?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.c?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.h?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738) | 1 | |  |  |  | | --- | --- | --- | |

5 files changed, 34 insertions, 9 deletions

| diff --git a/sound/usb/caiaq/audio.c b/sound/usb/caiaq/audio.cindex 772c0ecb707738..05f964347ed6c2 100644--- a/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=9d5c530e4d70f64b1114f2cc29ac690ba7ac4a38)+++ b/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)@@ -858,14 +858,20 @@ int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev) return 0; } -void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { struct device \*dev = caiaqdev\_to\_dev(cdev);  dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); stream\_stop(cdev);+}++void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ struct device \*dev = caiaqdev\_to\_dev(cdev);++ dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); free\_urbs(cdev->data\_urbs\_in); free\_urbs(cdev->data\_urbs\_out); kfree(cdev->data\_cb\_info); }-diff --git a/sound/usb/caiaq/audio.h b/sound/usb/caiaq/audio.hindex 869bf6264d6a09..07f5d064456cf7 100644--- a/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=9d5c530e4d70f64b1114f2cc29ac690ba7ac4a38)+++ b/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)@@ -3,6 +3,7 @@ #define CAIAQ\_AUDIO\_H  int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif /\* CAIAQ\_AUDIO\_H \*/diff --git a/sound/usb/caiaq/device.c b/sound/usb/caiaq/device.cindex b5cbf1f195c48c..dfd820483849eb 100644--- a/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=9d5c530e4d70f64b1114f2cc29ac690ba7ac4a38)+++ b/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)@@ -376,6 +376,17 @@ static void setup\_card(struct snd\_usb\_caiaqdev \*cdev) dev\_err(dev, "Unable to set up control system (ret=%d)\n", ret); } +static void card\_free(struct snd\_card \*card)+{+ struct snd\_usb\_caiaqdev \*cdev = caiaqdev(card);++#ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT+ snd\_usb\_caiaq\_input\_free(cdev);+#endif+ snd\_usb\_caiaq\_audio\_free(cdev);+ usb\_reset\_device(cdev->chip.dev);+}+ static int create\_card(struct usb\_device \*usb\_dev, struct usb\_interface \*intf, struct snd\_card \*\*cardp)@@ -489,6 +500,7 @@ static int init\_card(struct snd\_usb\_caiaqdev \*cdev) cdev->vendor\_name, cdev->product\_name, usbpath);  setup\_card(cdev);+ card->private\_free = card\_free; return 0;  err\_kill\_urb:@@ -534,15 +546,14 @@ static void snd\_disconnect(struct usb\_interface \*intf) snd\_card\_disconnect(card);  #ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT- snd\_usb\_caiaq\_input\_free(cdev);+ snd\_usb\_caiaq\_input\_disconnect(cdev); #endif- snd\_usb\_caiaq\_audio\_free(cdev);+ snd\_usb\_caiaq\_audio\_disconnect(cdev);  usb\_kill\_urb(&cdev->ep1\_in\_urb); usb\_kill\_urb(&cdev->midi\_out\_urb); - snd\_card\_free(card);- usb\_reset\_device(interface\_to\_usbdev(intf));+ snd\_card\_free\_when\_closed(card); }  diff --git a/sound/usb/caiaq/input.c b/sound/usb/caiaq/input.cindex 84f26dce7f5d03..a9130891bb696d 100644--- a/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=9d5c530e4d70f64b1114f2cc29ac690ba7ac4a38)+++ b/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)@@ -829,15 +829,21 @@ exit\_free\_idev: return ret; } -void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { if (!cdev || !cdev->input\_dev) return;  usb\_kill\_urb(cdev->ep4\_in\_urb);+ input\_unregister\_device(cdev->input\_dev);+}++void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ if (!cdev || !cdev->input\_dev)+ return;+ usb\_free\_urb(cdev->ep4\_in\_urb); cdev->ep4\_in\_urb = NULL;-- input\_unregister\_device(cdev->input\_dev); cdev->input\_dev = NULL; }diff --git a/sound/usb/caiaq/input.h b/sound/usb/caiaq/input.hindex c42891e7be884d..fbe267f85d025f 100644--- a/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=9d5c530e4d70f64b1114f2cc29ac690ba7ac4a38)+++ b/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=a3f9314752dbb6f6aa1f0f2b4c58243bda800738)@@ -4,6 +4,7 @@  void snd\_usb\_caiaq\_input\_dispatch(struct snd\_usb\_caiaqdev \*cdev, char \*buf, unsigned int len); int snd\_usb\_caiaq\_input\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:27:24 +0000



=== Content from git.kernel.org_51cb680e_20250114_182846.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-13 12:10:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:11 +0100 |
| commit | [4507a8b9b30344c5ddd8219945f446d47e966a6d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4507a8b9b30344c5ddd8219945f446d47e966a6d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)) | |
| tree | [dc0240af49d9f36b70ec1af550470b949cae55f7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4507a8b9b30344c5ddd8219945f446d47e966a6d) | |
| parent | [2938dd2648522336133c151dd67bb9bf01cbd390](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2938dd2648522336133c151dd67bb9bf01cbd390) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4507a8b9b30344c5ddd8219945f446d47e966a6d&id2=2938dd2648522336133c151dd67bb9bf01cbd390)) | |
| download | [linux-4507a8b9b30344c5ddd8219945f446d47e966a6d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4507a8b9b30344c5ddd8219945f446d47e966a6d.tar.gz) | |

ALSA: caiaq: Use snd\_card\_free\_when\_closed() at disconnection[ Upstream commit b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c ]
The USB disconnect callback is supposed to be short and not too-long
waiting. OTOH, the current code uses snd\_card\_free() at
disconnection, but this waits for the close of all used fds, hence it
can take long. It eventually blocks the upper layer USB ioctls, which
may trigger a soft lockup.
An easy workaround is to replace snd\_card\_free() with
snd\_card\_free\_when\_closed(). This variant returns immediately while
the release of resources is done asynchronously by the card device
release at the last close.
This patch also splits the code to the disconnect and the free phases;
the former is called immediately at the USB disconnect callback while
the latter is called from the card destructor.
Fixes: 523f1dce3743 ("[ALSA] Add Native Instrument usb audio device support")
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Link: [https://patch.msgid.link/20241113111042.15058-5-tiwai@suse.de](https://patch.msgid.link/20241113111042.15058-5-tiwai%40suse.de)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)

| -rw-r--r-- | [sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.c?id=4507a8b9b30344c5ddd8219945f446d47e966a6d) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.h?id=4507a8b9b30344c5ddd8219945f446d47e966a6d) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/device.c?id=4507a8b9b30344c5ddd8219945f446d47e966a6d) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.c?id=4507a8b9b30344c5ddd8219945f446d47e966a6d) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.h?id=4507a8b9b30344c5ddd8219945f446d47e966a6d) | 1 | |  |  |  | | --- | --- | --- | |

5 files changed, 34 insertions, 9 deletions

| diff --git a/sound/usb/caiaq/audio.c b/sound/usb/caiaq/audio.cindex 4981753652a7fe..7a89872aa0cbd6 100644--- a/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=2938dd2648522336133c151dd67bb9bf01cbd390)+++ b/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)@@ -869,14 +869,20 @@ int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev) return 0; } -void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { struct device \*dev = caiaqdev\_to\_dev(cdev);  dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); stream\_stop(cdev);+}++void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ struct device \*dev = caiaqdev\_to\_dev(cdev);++ dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); free\_urbs(cdev->data\_urbs\_in); free\_urbs(cdev->data\_urbs\_out); kfree(cdev->data\_cb\_info); }-diff --git a/sound/usb/caiaq/audio.h b/sound/usb/caiaq/audio.hindex 869bf6264d6a09..07f5d064456cf7 100644--- a/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=2938dd2648522336133c151dd67bb9bf01cbd390)+++ b/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)@@ -3,6 +3,7 @@ #define CAIAQ\_AUDIO\_H  int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif /\* CAIAQ\_AUDIO\_H \*/diff --git a/sound/usb/caiaq/device.c b/sound/usb/caiaq/device.cindex b5cbf1f195c48c..dfd820483849eb 100644--- a/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=2938dd2648522336133c151dd67bb9bf01cbd390)+++ b/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)@@ -376,6 +376,17 @@ static void setup\_card(struct snd\_usb\_caiaqdev \*cdev) dev\_err(dev, "Unable to set up control system (ret=%d)\n", ret); } +static void card\_free(struct snd\_card \*card)+{+ struct snd\_usb\_caiaqdev \*cdev = caiaqdev(card);++#ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT+ snd\_usb\_caiaq\_input\_free(cdev);+#endif+ snd\_usb\_caiaq\_audio\_free(cdev);+ usb\_reset\_device(cdev->chip.dev);+}+ static int create\_card(struct usb\_device \*usb\_dev, struct usb\_interface \*intf, struct snd\_card \*\*cardp)@@ -489,6 +500,7 @@ static int init\_card(struct snd\_usb\_caiaqdev \*cdev) cdev->vendor\_name, cdev->product\_name, usbpath);  setup\_card(cdev);+ card->private\_free = card\_free; return 0;  err\_kill\_urb:@@ -534,15 +546,14 @@ static void snd\_disconnect(struct usb\_interface \*intf) snd\_card\_disconnect(card);  #ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT- snd\_usb\_caiaq\_input\_free(cdev);+ snd\_usb\_caiaq\_input\_disconnect(cdev); #endif- snd\_usb\_caiaq\_audio\_free(cdev);+ snd\_usb\_caiaq\_audio\_disconnect(cdev);  usb\_kill\_urb(&cdev->ep1\_in\_urb); usb\_kill\_urb(&cdev->midi\_out\_urb); - snd\_card\_free(card);- usb\_reset\_device(interface\_to\_usbdev(intf));+ snd\_card\_free\_when\_closed(card); }  diff --git a/sound/usb/caiaq/input.c b/sound/usb/caiaq/input.cindex 84f26dce7f5d03..a9130891bb696d 100644--- a/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=2938dd2648522336133c151dd67bb9bf01cbd390)+++ b/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)@@ -829,15 +829,21 @@ exit\_free\_idev: return ret; } -void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { if (!cdev || !cdev->input\_dev) return;  usb\_kill\_urb(cdev->ep4\_in\_urb);+ input\_unregister\_device(cdev->input\_dev);+}++void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ if (!cdev || !cdev->input\_dev)+ return;+ usb\_free\_urb(cdev->ep4\_in\_urb); cdev->ep4\_in\_urb = NULL;-- input\_unregister\_device(cdev->input\_dev); cdev->input\_dev = NULL; }diff --git a/sound/usb/caiaq/input.h b/sound/usb/caiaq/input.hindex c42891e7be884d..fbe267f85d025f 100644--- a/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=2938dd2648522336133c151dd67bb9bf01cbd390)+++ b/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=4507a8b9b30344c5ddd8219945f446d47e966a6d)@@ -4,6 +4,7 @@  void snd\_usb\_caiaq\_input\_dispatch(struct snd\_usb\_caiaqdev \*cdev, char \*buf, unsigned int len); int snd\_usb\_caiaq\_input\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:27:23 +0000



=== Content from git.kernel.org_9e93ee7f_20250114_182851.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dd0de8cb708951cebf727aa045e8242ba651bb52)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dd0de8cb708951cebf727aa045e8242ba651bb52)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd0de8cb708951cebf727aa045e8242ba651bb52)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd0de8cb708951cebf727aa045e8242ba651bb52)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-13 12:10:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:26 +0100 |
| commit | [dd0de8cb708951cebf727aa045e8242ba651bb52](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd0de8cb708951cebf727aa045e8242ba651bb52) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dd0de8cb708951cebf727aa045e8242ba651bb52)) | |
| tree | [b8d133100b22f5a8064db8e52cc9cbe82f475779](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dd0de8cb708951cebf727aa045e8242ba651bb52) | |
| parent | [9b27924dc8d7f8a8c35e521287d4ccb9a006e597](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b27924dc8d7f8a8c35e521287d4ccb9a006e597) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd0de8cb708951cebf727aa045e8242ba651bb52&id2=9b27924dc8d7f8a8c35e521287d4ccb9a006e597)) | |
| download | [linux-dd0de8cb708951cebf727aa045e8242ba651bb52.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dd0de8cb708951cebf727aa045e8242ba651bb52.tar.gz) | |

ALSA: caiaq: Use snd\_card\_free\_when\_closed() at disconnection[ Upstream commit b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c ]
The USB disconnect callback is supposed to be short and not too-long
waiting. OTOH, the current code uses snd\_card\_free() at
disconnection, but this waits for the close of all used fds, hence it
can take long. It eventually blocks the upper layer USB ioctls, which
may trigger a soft lockup.
An easy workaround is to replace snd\_card\_free() with
snd\_card\_free\_when\_closed(). This variant returns immediately while
the release of resources is done asynchronously by the card device
release at the last close.
This patch also splits the code to the disconnect and the free phases;
the former is called immediately at the USB disconnect callback while
the latter is called from the card destructor.
Fixes: 523f1dce3743 ("[ALSA] Add Native Instrument usb audio device support")
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Link: [https://patch.msgid.link/20241113111042.15058-5-tiwai@suse.de](https://patch.msgid.link/20241113111042.15058-5-tiwai%40suse.de)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd0de8cb708951cebf727aa045e8242ba651bb52)

| -rw-r--r-- | [sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.c?id=dd0de8cb708951cebf727aa045e8242ba651bb52) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.h?id=dd0de8cb708951cebf727aa045e8242ba651bb52) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/device.c?id=dd0de8cb708951cebf727aa045e8242ba651bb52) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.c?id=dd0de8cb708951cebf727aa045e8242ba651bb52) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.h?id=dd0de8cb708951cebf727aa045e8242ba651bb52) | 1 | |  |  |  | | --- | --- | --- | |

5 files changed, 34 insertions, 9 deletions

| diff --git a/sound/usb/caiaq/audio.c b/sound/usb/caiaq/audio.cindex 4981753652a7fe..7a89872aa0cbd6 100644--- a/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=9b27924dc8d7f8a8c35e521287d4ccb9a006e597)+++ b/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=dd0de8cb708951cebf727aa045e8242ba651bb52)@@ -869,14 +869,20 @@ int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev) return 0; } -void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { struct device \*dev = caiaqdev\_to\_dev(cdev);  dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); stream\_stop(cdev);+}++void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ struct device \*dev = caiaqdev\_to\_dev(cdev);++ dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); free\_urbs(cdev->data\_urbs\_in); free\_urbs(cdev->data\_urbs\_out); kfree(cdev->data\_cb\_info); }-diff --git a/sound/usb/caiaq/audio.h b/sound/usb/caiaq/audio.hindex 869bf6264d6a09..07f5d064456cf7 100644--- a/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=9b27924dc8d7f8a8c35e521287d4ccb9a006e597)+++ b/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=dd0de8cb708951cebf727aa045e8242ba651bb52)@@ -3,6 +3,7 @@ #define CAIAQ\_AUDIO\_H  int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif /\* CAIAQ\_AUDIO\_H \*/diff --git a/sound/usb/caiaq/device.c b/sound/usb/caiaq/device.cindex b5cbf1f195c48c..dfd820483849eb 100644--- a/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=9b27924dc8d7f8a8c35e521287d4ccb9a006e597)+++ b/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=dd0de8cb708951cebf727aa045e8242ba651bb52)@@ -376,6 +376,17 @@ static void setup\_card(struct snd\_usb\_caiaqdev \*cdev) dev\_err(dev, "Unable to set up control system (ret=%d)\n", ret); } +static void card\_free(struct snd\_card \*card)+{+ struct snd\_usb\_caiaqdev \*cdev = caiaqdev(card);++#ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT+ snd\_usb\_caiaq\_input\_free(cdev);+#endif+ snd\_usb\_caiaq\_audio\_free(cdev);+ usb\_reset\_device(cdev->chip.dev);+}+ static int create\_card(struct usb\_device \*usb\_dev, struct usb\_interface \*intf, struct snd\_card \*\*cardp)@@ -489,6 +500,7 @@ static int init\_card(struct snd\_usb\_caiaqdev \*cdev) cdev->vendor\_name, cdev->product\_name, usbpath);  setup\_card(cdev);+ card->private\_free = card\_free; return 0;  err\_kill\_urb:@@ -534,15 +546,14 @@ static void snd\_disconnect(struct usb\_interface \*intf) snd\_card\_disconnect(card);  #ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT- snd\_usb\_caiaq\_input\_free(cdev);+ snd\_usb\_caiaq\_input\_disconnect(cdev); #endif- snd\_usb\_caiaq\_audio\_free(cdev);+ snd\_usb\_caiaq\_audio\_disconnect(cdev);  usb\_kill\_urb(&cdev->ep1\_in\_urb); usb\_kill\_urb(&cdev->midi\_out\_urb); - snd\_card\_free(card);- usb\_reset\_device(interface\_to\_usbdev(intf));+ snd\_card\_free\_when\_closed(card); }  diff --git a/sound/usb/caiaq/input.c b/sound/usb/caiaq/input.cindex 84f26dce7f5d03..a9130891bb696d 100644--- a/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=9b27924dc8d7f8a8c35e521287d4ccb9a006e597)+++ b/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=dd0de8cb708951cebf727aa045e8242ba651bb52)@@ -829,15 +829,21 @@ exit\_free\_idev: return ret; } -void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { if (!cdev || !cdev->input\_dev) return;  usb\_kill\_urb(cdev->ep4\_in\_urb);+ input\_unregister\_device(cdev->input\_dev);+}++void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ if (!cdev || !cdev->input\_dev)+ return;+ usb\_free\_urb(cdev->ep4\_in\_urb); cdev->ep4\_in\_urb = NULL;-- input\_unregister\_device(cdev->input\_dev); cdev->input\_dev = NULL; }diff --git a/sound/usb/caiaq/input.h b/sound/usb/caiaq/input.hindex c42891e7be884d..fbe267f85d025f 100644--- a/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=9b27924dc8d7f8a8c35e521287d4ccb9a006e597)+++ b/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=dd0de8cb708951cebf727aa045e8242ba651bb52)@@ -4,6 +4,7 @@  void snd\_usb\_caiaq\_input\_dispatch(struct snd\_usb\_caiaqdev \*cdev, char \*buf, unsigned int len); int snd\_usb\_caiaq\_input\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:27:28 +0000



=== Content from git.kernel.org_0434cb27_20250114_182846.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-13 12:10:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:56 +0100 |
| commit | [4dd821dcbfcecf7af6a08370b0b217cde2818acf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)) | |
| tree | [4cd9bd1894eff9fe9b312d523cd4145d25a512b8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf) | |
| parent | [bf0aa35a7cb8602cccf2387712114e836f65c154](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf0aa35a7cb8602cccf2387712114e836f65c154) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf&id2=bf0aa35a7cb8602cccf2387712114e836f65c154)) | |
| download | [linux-4dd821dcbfcecf7af6a08370b0b217cde2818acf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4dd821dcbfcecf7af6a08370b0b217cde2818acf.tar.gz) | |

ALSA: caiaq: Use snd\_card\_free\_when\_closed() at disconnection[ Upstream commit b04dcbb7f7b1908806b7dc22671cdbe78ff2b82c ]
The USB disconnect callback is supposed to be short and not too-long
waiting. OTOH, the current code uses snd\_card\_free() at
disconnection, but this waits for the close of all used fds, hence it
can take long. It eventually blocks the upper layer USB ioctls, which
may trigger a soft lockup.
An easy workaround is to replace snd\_card\_free() with
snd\_card\_free\_when\_closed(). This variant returns immediately while
the release of resources is done asynchronously by the card device
release at the last close.
This patch also splits the code to the disconnect and the free phases;
the former is called immediately at the USB disconnect callback while
the latter is called from the card destructor.
Fixes: 523f1dce3743 ("[ALSA] Add Native Instrument usb audio device support")
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Link: [https://patch.msgid.link/20241113111042.15058-5-tiwai@suse.de](https://patch.msgid.link/20241113111042.15058-5-tiwai%40suse.de)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)

| -rw-r--r-- | [sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.c?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/audio.h?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/device.c?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf) | 19 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.c?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/caiaq/input.h?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf) | 1 | |  |  |  | | --- | --- | --- | |

5 files changed, 34 insertions, 9 deletions

| diff --git a/sound/usb/caiaq/audio.c b/sound/usb/caiaq/audio.cindex 3b6bb2cbe886b3..1308415b55ed88 100644--- a/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=bf0aa35a7cb8602cccf2387712114e836f65c154)+++ b/[sound/usb/caiaq/audio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.c?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)@@ -869,14 +869,20 @@ int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev) return 0; } -void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { struct device \*dev = caiaqdev\_to\_dev(cdev);  dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); stream\_stop(cdev);+}++void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ struct device \*dev = caiaqdev\_to\_dev(cdev);++ dev\_dbg(dev, "%s(%p)\n", \_\_func\_\_, cdev); free\_urbs(cdev->data\_urbs\_in); free\_urbs(cdev->data\_urbs\_out); kfree(cdev->data\_cb\_info); }-diff --git a/sound/usb/caiaq/audio.h b/sound/usb/caiaq/audio.hindex 869bf6264d6a09..07f5d064456cf7 100644--- a/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=bf0aa35a7cb8602cccf2387712114e836f65c154)+++ b/[sound/usb/caiaq/audio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/audio.h?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)@@ -3,6 +3,7 @@ #define CAIAQ\_AUDIO\_H  int snd\_usb\_caiaq\_audio\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_audio\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_audio\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif /\* CAIAQ\_AUDIO\_H \*/diff --git a/sound/usb/caiaq/device.c b/sound/usb/caiaq/device.cindex 2af3b7eb0a88c5..482d4915e0a700 100644--- a/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=bf0aa35a7cb8602cccf2387712114e836f65c154)+++ b/[sound/usb/caiaq/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/device.c?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)@@ -390,6 +390,17 @@ static void setup\_card(struct snd\_usb\_caiaqdev \*cdev) dev\_err(dev, "Unable to set up control system (ret=%d)\n", ret); } +static void card\_free(struct snd\_card \*card)+{+ struct snd\_usb\_caiaqdev \*cdev = caiaqdev(card);++#ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT+ snd\_usb\_caiaq\_input\_free(cdev);+#endif+ snd\_usb\_caiaq\_audio\_free(cdev);+ usb\_reset\_device(cdev->chip.dev);+}+ static int create\_card(struct usb\_device \*usb\_dev, struct usb\_interface \*intf, struct snd\_card \*\*cardp)@@ -503,6 +514,7 @@ static int init\_card(struct snd\_usb\_caiaqdev \*cdev) cdev->vendor\_name, cdev->product\_name, usbpath);  setup\_card(cdev);+ card->private\_free = card\_free; return 0;  err\_kill\_urb:@@ -548,15 +560,14 @@ static void snd\_disconnect(struct usb\_interface \*intf) snd\_card\_disconnect(card);  #ifdef CONFIG\_SND\_USB\_CAIAQ\_INPUT- snd\_usb\_caiaq\_input\_free(cdev);+ snd\_usb\_caiaq\_input\_disconnect(cdev); #endif- snd\_usb\_caiaq\_audio\_free(cdev);+ snd\_usb\_caiaq\_audio\_disconnect(cdev);  usb\_kill\_urb(&cdev->ep1\_in\_urb); usb\_kill\_urb(&cdev->midi\_out\_urb); - snd\_card\_free(card);- usb\_reset\_device(interface\_to\_usbdev(intf));+ snd\_card\_free\_when\_closed(card); }  diff --git a/sound/usb/caiaq/input.c b/sound/usb/caiaq/input.cindex 84f26dce7f5d03..a9130891bb696d 100644--- a/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=bf0aa35a7cb8602cccf2387712114e836f65c154)+++ b/[sound/usb/caiaq/input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.c?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)@@ -829,15 +829,21 @@ exit\_free\_idev: return ret; } -void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev) { if (!cdev || !cdev->input\_dev) return;  usb\_kill\_urb(cdev->ep4\_in\_urb);+ input\_unregister\_device(cdev->input\_dev);+}++void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev)+{+ if (!cdev || !cdev->input\_dev)+ return;+ usb\_free\_urb(cdev->ep4\_in\_urb); cdev->ep4\_in\_urb = NULL;-- input\_unregister\_device(cdev->input\_dev); cdev->input\_dev = NULL; }diff --git a/sound/usb/caiaq/input.h b/sound/usb/caiaq/input.hindex c42891e7be884d..fbe267f85d025f 100644--- a/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=bf0aa35a7cb8602cccf2387712114e836f65c154)+++ b/[sound/usb/caiaq/input.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/caiaq/input.h?id=4dd821dcbfcecf7af6a08370b0b217cde2818acf)@@ -4,6 +4,7 @@  void snd\_usb\_caiaq\_input\_dispatch(struct snd\_usb\_caiaqdev \*cdev, char \*buf, unsigned int len); int snd\_usb\_caiaq\_input\_init(struct snd\_usb\_caiaqdev \*cdev);+void snd\_usb\_caiaq\_input\_disconnect(struct snd\_usb\_caiaqdev \*cdev); void snd\_usb\_caiaq\_input\_free(struct snd\_usb\_caiaqdev \*cdev);  #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:27:23 +0000


