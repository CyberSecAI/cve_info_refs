=== Content from git.kernel.org_e6f14d7c_20250115_101840.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ramya Gnanasekar <quic\_rgnanase@quicinc.com> | 2024-09-05 09:58:51 +0530 |
| --- | --- | --- |
| committer | Kalle Valo <quic\_kvalo@quicinc.com> | 2024-09-28 12:25:31 +0300 |
| commit | [1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb)) | |
| tree | [4b54d57157ebf1b9ff909ff36c13d6e84798184a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb) | |
| parent | [02d697272cc62665a66930f3a3f9fd12f820eba7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02d697272cc62665a66930f3a3f9fd12f820eba7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb&id2=02d697272cc62665a66930f3a3f9fd12f820eba7)) | |
| download | [linux-1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb.tar.gz) | |

wifi: ath12k: Skip Rx TID cleanup for self peerDuring peer create, dp setup for the peer is done where Rx TID is
updated for all the TIDs. Peer object for self peer will not go through
dp setup.
When core halts, dp cleanup is done for all the peers. While cleanup,
rx\_tid::ab is accessed which causes below stack trace for self peer.
WARNING: CPU: 6 PID: 12297 at drivers/net/wireless/ath/ath12k/dp\_rx.c:851
Call Trace:
\_\_warn+0x7b/0x1a0
ath12k\_dp\_rx\_frags\_cleanup+0xd2/0xe0 [ath12k]
report\_bug+0x10b/0x200
handle\_bug+0x3f/0x70
exc\_invalid\_op+0x13/0x60
asm\_exc\_invalid\_op+0x16/0x20
ath12k\_dp\_rx\_frags\_cleanup+0xd2/0xe0 [ath12k]
ath12k\_dp\_rx\_frags\_cleanup+0xca/0xe0 [ath12k]
ath12k\_dp\_rx\_peer\_tid\_cleanup+0x39/0xa0 [ath12k]
ath12k\_mac\_peer\_cleanup\_all+0x61/0x100 [ath12k]
ath12k\_core\_halt+0x3b/0x100 [ath12k]
ath12k\_core\_reset+0x494/0x4c0 [ath12k]
sta object in peer will be updated when remote peer is created. Hence
use peer::sta to detect the self peer and skip the cleanup.
Tested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.0.1-00029-QCAHKSWPL\_SILICONZ-1
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0.c5-00481-QCAHMTSWPL\_V1.0\_V2.0\_SILICONZ-3
Fixes: d889913205cf ("wifi: ath12k: driver for Qualcomm Wi-Fi 7 devices")
Signed-off-by: Ramya Gnanasekar <quic\_rgnanase@quicinc.com>
Acked-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Kalle Valo <quic\_kvalo@quicinc.com>
Link: [https://patch.msgid.link/20240905042851.2282306-1-quic\_rgnanase@quicinc.com](https://patch.msgid.link/20240905042851.2282306-1-quic_rgnanase%40quicinc.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb)

| -rw-r--r-- | [drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/mac.c?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath12k/mac.c b/drivers/net/wireless/ath/ath12k/mac.cindex 137394c364603b..6d0784a21558ea 100644--- a/[drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/mac.c?id=02d697272cc62665a66930f3a3f9fd12f820eba7)+++ b/[drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/mac.c?id=1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb)@@ -917,7 +917,10 @@ void ath12k\_mac\_peer\_cleanup\_all(struct ath12k \*ar)  spin\_lock\_bh(&ab->base\_lock); list\_for\_each\_entry\_safe(peer, tmp, &ab->peers, list) {- ath12k\_dp\_rx\_peer\_tid\_cleanup(ar, peer);+ /\* Skip Rx TID cleanup for self peer \*/+ if (peer->sta)+ ath12k\_dp\_rx\_peer\_tid\_cleanup(ar, peer);+ list\_del(&peer->list); kfree(peer); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:17:16 +0000



=== Content from git.kernel.org_33331785_20250115_101842.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ramya Gnanasekar <quic\_rgnanase@quicinc.com> | 2024-09-05 09:58:51 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:39 +0100 |
| commit | [a052483d495a4dc62c814f2fd17d0ceb308fc6a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6)) | |
| tree | [565d31c2b094d23a180036f89280df3d7a0cb25b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6) | |
| parent | [f007119e1524bc9388f0c836203b3970a19ea850](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f007119e1524bc9388f0c836203b3970a19ea850) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6&id2=f007119e1524bc9388f0c836203b3970a19ea850)) | |
| download | [linux-a052483d495a4dc62c814f2fd17d0ceb308fc6a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a052483d495a4dc62c814f2fd17d0ceb308fc6a6.tar.gz) | |

wifi: ath12k: Skip Rx TID cleanup for self peer[ Upstream commit 1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb ]
During peer create, dp setup for the peer is done where Rx TID is
updated for all the TIDs. Peer object for self peer will not go through
dp setup.
When core halts, dp cleanup is done for all the peers. While cleanup,
rx\_tid::ab is accessed which causes below stack trace for self peer.
WARNING: CPU: 6 PID: 12297 at drivers/net/wireless/ath/ath12k/dp\_rx.c:851
Call Trace:
\_\_warn+0x7b/0x1a0
ath12k\_dp\_rx\_frags\_cleanup+0xd2/0xe0 [ath12k]
report\_bug+0x10b/0x200
handle\_bug+0x3f/0x70
exc\_invalid\_op+0x13/0x60
asm\_exc\_invalid\_op+0x16/0x20
ath12k\_dp\_rx\_frags\_cleanup+0xd2/0xe0 [ath12k]
ath12k\_dp\_rx\_frags\_cleanup+0xca/0xe0 [ath12k]
ath12k\_dp\_rx\_peer\_tid\_cleanup+0x39/0xa0 [ath12k]
ath12k\_mac\_peer\_cleanup\_all+0x61/0x100 [ath12k]
ath12k\_core\_halt+0x3b/0x100 [ath12k]
ath12k\_core\_reset+0x494/0x4c0 [ath12k]
sta object in peer will be updated when remote peer is created. Hence
use peer::sta to detect the self peer and skip the cleanup.
Tested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.0.1-00029-QCAHKSWPL\_SILICONZ-1
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0.c5-00481-QCAHMTSWPL\_V1.0\_V2.0\_SILICONZ-3
Fixes: d889913205cf ("wifi: ath12k: driver for Qualcomm Wi-Fi 7 devices")
Signed-off-by: Ramya Gnanasekar <quic\_rgnanase@quicinc.com>
Acked-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Kalle Valo <quic\_kvalo@quicinc.com>
Link: [https://patch.msgid.link/20240905042851.2282306-1-quic\_rgnanase@quicinc.com](https://patch.msgid.link/20240905042851.2282306-1-quic_rgnanase%40quicinc.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6)

| -rw-r--r-- | [drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/mac.c?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath12k/mac.c b/drivers/net/wireless/ath/ath12k/mac.cindex 137394c364603b..6d0784a21558ea 100644--- a/[drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/mac.c?id=f007119e1524bc9388f0c836203b3970a19ea850)+++ b/[drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/mac.c?id=a052483d495a4dc62c814f2fd17d0ceb308fc6a6)@@ -917,7 +917,10 @@ void ath12k\_mac\_peer\_cleanup\_all(struct ath12k \*ar)  spin\_lock\_bh(&ab->base\_lock); list\_for\_each\_entry\_safe(peer, tmp, &ab->peers, list) {- ath12k\_dp\_rx\_peer\_tid\_cleanup(ar, peer);+ /\* Skip Rx TID cleanup for self peer \*/+ if (peer->sta)+ ath12k\_dp\_rx\_peer\_tid\_cleanup(ar, peer);+ list\_del(&peer->list); kfree(peer); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:17:19 +0000



=== Content from git.kernel.org_76663e80_20250115_101843.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a1e2d6738b29c74c2024eb23167dfff68aadd984)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a1e2d6738b29c74c2024eb23167dfff68aadd984)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a1e2d6738b29c74c2024eb23167dfff68aadd984)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a1e2d6738b29c74c2024eb23167dfff68aadd984)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ramya Gnanasekar <quic\_rgnanase@quicinc.com> | 2024-09-05 09:58:51 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:10 +0100 |
| commit | [a1e2d6738b29c74c2024eb23167dfff68aadd984](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a1e2d6738b29c74c2024eb23167dfff68aadd984) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a1e2d6738b29c74c2024eb23167dfff68aadd984)) | |
| tree | [3561908c2ba363f760cfed41d39a12d67b72f4bd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a1e2d6738b29c74c2024eb23167dfff68aadd984) | |
| parent | [fde7c192e6e2710247795bbd6d72a1f4b6f0cfb7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fde7c192e6e2710247795bbd6d72a1f4b6f0cfb7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a1e2d6738b29c74c2024eb23167dfff68aadd984&id2=fde7c192e6e2710247795bbd6d72a1f4b6f0cfb7)) | |
| download | [linux-a1e2d6738b29c74c2024eb23167dfff68aadd984.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a1e2d6738b29c74c2024eb23167dfff68aadd984.tar.gz) | |

wifi: ath12k: Skip Rx TID cleanup for self peer[ Upstream commit 1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb ]
During peer create, dp setup for the peer is done where Rx TID is
updated for all the TIDs. Peer object for self peer will not go through
dp setup.
When core halts, dp cleanup is done for all the peers. While cleanup,
rx\_tid::ab is accessed which causes below stack trace for self peer.
WARNING: CPU: 6 PID: 12297 at drivers/net/wireless/ath/ath12k/dp\_rx.c:851
Call Trace:
\_\_warn+0x7b/0x1a0
ath12k\_dp\_rx\_frags\_cleanup+0xd2/0xe0 [ath12k]
report\_bug+0x10b/0x200
handle\_bug+0x3f/0x70
exc\_invalid\_op+0x13/0x60
asm\_exc\_invalid\_op+0x16/0x20
ath12k\_dp\_rx\_frags\_cleanup+0xd2/0xe0 [ath12k]
ath12k\_dp\_rx\_frags\_cleanup+0xca/0xe0 [ath12k]
ath12k\_dp\_rx\_peer\_tid\_cleanup+0x39/0xa0 [ath12k]
ath12k\_mac\_peer\_cleanup\_all+0x61/0x100 [ath12k]
ath12k\_core\_halt+0x3b/0x100 [ath12k]
ath12k\_core\_reset+0x494/0x4c0 [ath12k]
sta object in peer will be updated when remote peer is created. Hence
use peer::sta to detect the self peer and skip the cleanup.
Tested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.0.1-00029-QCAHKSWPL\_SILICONZ-1
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0.c5-00481-QCAHMTSWPL\_V1.0\_V2.0\_SILICONZ-3
Fixes: d889913205cf ("wifi: ath12k: driver for Qualcomm Wi-Fi 7 devices")
Signed-off-by: Ramya Gnanasekar <quic\_rgnanase@quicinc.com>
Acked-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Kalle Valo <quic\_kvalo@quicinc.com>
Link: [https://patch.msgid.link/20240905042851.2282306-1-quic\_rgnanase@quicinc.com](https://patch.msgid.link/20240905042851.2282306-1-quic_rgnanase%40quicinc.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a1e2d6738b29c74c2024eb23167dfff68aadd984)

| -rw-r--r-- | [drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/mac.c?id=a1e2d6738b29c74c2024eb23167dfff68aadd984) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath12k/mac.c b/drivers/net/wireless/ath/ath12k/mac.cindex a3248d97753298..3608ede55b1eb7 100644--- a/[drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/mac.c?id=fde7c192e6e2710247795bbd6d72a1f4b6f0cfb7)+++ b/[drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/mac.c?id=a1e2d6738b29c74c2024eb23167dfff68aadd984)@@ -917,7 +917,10 @@ void ath12k\_mac\_peer\_cleanup\_all(struct ath12k \*ar)  spin\_lock\_bh(&ab->base\_lock); list\_for\_each\_entry\_safe(peer, tmp, &ab->peers, list) {- ath12k\_dp\_rx\_peer\_tid\_cleanup(ar, peer);+ /\* Skip Rx TID cleanup for self peer \*/+ if (peer->sta)+ ath12k\_dp\_rx\_peer\_tid\_cleanup(ar, peer);+ list\_del(&peer->list); kfree(peer); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:17:20 +0000



=== Content from git.kernel.org_20a920e7_20250115_101844.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d73da0dd2853887b7aab71f0d572fd3314dafafe)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d73da0dd2853887b7aab71f0d572fd3314dafafe)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d73da0dd2853887b7aab71f0d572fd3314dafafe)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d73da0dd2853887b7aab71f0d572fd3314dafafe)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ramya Gnanasekar <quic\_rgnanase@quicinc.com> | 2024-09-05 09:58:51 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:01 +0100 |
| commit | [d73da0dd2853887b7aab71f0d572fd3314dafafe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d73da0dd2853887b7aab71f0d572fd3314dafafe) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d73da0dd2853887b7aab71f0d572fd3314dafafe)) | |
| tree | [dbcec19178e2dc2cc07fac8018e91c6f1342895c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d73da0dd2853887b7aab71f0d572fd3314dafafe) | |
| parent | [8325a50983c1726da203df09d0fc7e260da1d82c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8325a50983c1726da203df09d0fc7e260da1d82c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d73da0dd2853887b7aab71f0d572fd3314dafafe&id2=8325a50983c1726da203df09d0fc7e260da1d82c)) | |
| download | [linux-d73da0dd2853887b7aab71f0d572fd3314dafafe.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d73da0dd2853887b7aab71f0d572fd3314dafafe.tar.gz) | |

wifi: ath12k: Skip Rx TID cleanup for self peer[ Upstream commit 1a0c640ce1cdcde3eb131a0c1e70ca1ed7cf27cb ]
During peer create, dp setup for the peer is done where Rx TID is
updated for all the TIDs. Peer object for self peer will not go through
dp setup.
When core halts, dp cleanup is done for all the peers. While cleanup,
rx\_tid::ab is accessed which causes below stack trace for self peer.
WARNING: CPU: 6 PID: 12297 at drivers/net/wireless/ath/ath12k/dp\_rx.c:851
Call Trace:
\_\_warn+0x7b/0x1a0
ath12k\_dp\_rx\_frags\_cleanup+0xd2/0xe0 [ath12k]
report\_bug+0x10b/0x200
handle\_bug+0x3f/0x70
exc\_invalid\_op+0x13/0x60
asm\_exc\_invalid\_op+0x16/0x20
ath12k\_dp\_rx\_frags\_cleanup+0xd2/0xe0 [ath12k]
ath12k\_dp\_rx\_frags\_cleanup+0xca/0xe0 [ath12k]
ath12k\_dp\_rx\_peer\_tid\_cleanup+0x39/0xa0 [ath12k]
ath12k\_mac\_peer\_cleanup\_all+0x61/0x100 [ath12k]
ath12k\_core\_halt+0x3b/0x100 [ath12k]
ath12k\_core\_reset+0x494/0x4c0 [ath12k]
sta object in peer will be updated when remote peer is created. Hence
use peer::sta to detect the self peer and skip the cleanup.
Tested-on: QCN9274 hw2.0 PCI WLAN.WBE.1.0.1-00029-QCAHKSWPL\_SILICONZ-1
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0.c5-00481-QCAHMTSWPL\_V1.0\_V2.0\_SILICONZ-3
Fixes: d889913205cf ("wifi: ath12k: driver for Qualcomm Wi-Fi 7 devices")
Signed-off-by: Ramya Gnanasekar <quic\_rgnanase@quicinc.com>
Acked-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Kalle Valo <quic\_kvalo@quicinc.com>
Link: [https://patch.msgid.link/20240905042851.2282306-1-quic\_rgnanase@quicinc.com](https://patch.msgid.link/20240905042851.2282306-1-quic_rgnanase%40quicinc.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d73da0dd2853887b7aab71f0d572fd3314dafafe)

| -rw-r--r-- | [drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/mac.c?id=d73da0dd2853887b7aab71f0d572fd3314dafafe) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath12k/mac.c b/drivers/net/wireless/ath/ath12k/mac.cindex 4bb30e40372877..f90191a290c26a 100644--- a/[drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/mac.c?id=8325a50983c1726da203df09d0fc7e260da1d82c)+++ b/[drivers/net/wireless/ath/ath12k/mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/mac.c?id=d73da0dd2853887b7aab71f0d572fd3314dafafe)@@ -775,7 +775,10 @@ void ath12k\_mac\_peer\_cleanup\_all(struct ath12k \*ar)  spin\_lock\_bh(&ab->base\_lock); list\_for\_each\_entry\_safe(peer, tmp, &ab->peers, list) {- ath12k\_dp\_rx\_peer\_tid\_cleanup(ar, peer);+ /\* Skip Rx TID cleanup for self peer \*/+ if (peer->sta)+ ath12k\_dp\_rx\_peer\_tid\_cleanup(ar, peer);+ list\_del(&peer->list); kfree(peer); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:17:21 +0000


