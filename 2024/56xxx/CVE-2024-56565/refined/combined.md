=== Content from git.kernel.org_964f16ac_20250114_190746.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=15136c3861a3341db261ebdbb6ae4ae1765635e2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=15136c3861a3341db261ebdbb6ae4ae1765635e2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15136c3861a3341db261ebdbb6ae4ae1765635e2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15136c3861a3341db261ebdbb6ae4ae1765635e2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-11-21 22:17:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:41:05 +0100 |
| commit | [15136c3861a3341db261ebdbb6ae4ae1765635e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15136c3861a3341db261ebdbb6ae4ae1765635e2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=15136c3861a3341db261ebdbb6ae4ae1765635e2)) | |
| tree | [edf631b503335df8f97d014667d92ca9e31d54e8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=15136c3861a3341db261ebdbb6ae4ae1765635e2) | |
| parent | [943c0f601cd28c1073b92b5f944c6c6c2643e709](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=943c0f601cd28c1073b92b5f944c6c6c2643e709) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15136c3861a3341db261ebdbb6ae4ae1765635e2&id2=943c0f601cd28c1073b92b5f944c6c6c2643e709)) | |
| download | [linux-15136c3861a3341db261ebdbb6ae4ae1765635e2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-15136c3861a3341db261ebdbb6ae4ae1765635e2.tar.gz) | |

f2fs: fix to drop all discards after creating snapshot on lvm devicecommit bc8aeb04fd80cb8cfae3058445c84410fd0beb5e upstream.
Piergiorgio reported a bug in bugzilla as below:
------------[ cut here ]------------
WARNING: CPU: 2 PID: 969 at fs/f2fs/segment.c:1330
RIP: 0010:\_\_submit\_discard\_cmd+0x27d/0x400 [f2fs]
Call Trace:
\_\_issue\_discard\_cmd+0x1ca/0x350 [f2fs]
issue\_discard\_thread+0x191/0x480 [f2fs]
kthread+0xcf/0x100
ret\_from\_fork+0x31/0x50
ret\_from\_fork\_asm+0x1a/0x30
w/ below testcase, it can reproduce this bug quickly:
- pvcreate /dev/vdb
- vgcreate myvg1 /dev/vdb
- lvcreate -L 1024m -n mylv1 myvg1
- mount /dev/myvg1/mylv1 /mnt/f2fs
- dd if=/dev/zero of=/mnt/f2fs/file bs=1M count=20
- sync
- rm /mnt/f2fs/file
- sync
- lvcreate -L 1024m -s -n mylv1-snapshot /dev/myvg1/mylv1
- umount /mnt/f2fs
The root cause is: it will update discard\_max\_bytes of mounted lvm
device to zero after creating snapshot on this lvm device, then,
\_\_submit\_discard\_cmd() will pass parameter @nr\_sects w/ zero value
to \_\_blkdev\_issue\_discard(), it returns a NULL bio pointer, result
in panic.
This patch changes as below for fixing:
1. Let's drop all remained discards in f2fs\_unfreeze() if snapshot
of lvm device is created.
2. Checking discard\_max\_bytes before submitting discard during
\_\_submit\_discard\_cmd().
Cc: stable@vger.kernel.org
Fixes: 35ec7d574884 ("f2fs: split discard command in prior to block layer")
Reported-by: Piergiorgio Sartor <piergiorgio.sartor@nexgo.de>
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=219484
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=15136c3861a3341db261ebdbb6ae4ae1765635e2)

| -rw-r--r-- | [fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.c?id=15136c3861a3341db261ebdbb6ae4ae1765635e2) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/super.c?id=15136c3861a3341db261ebdbb6ae4ae1765635e2) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 21 insertions, 7 deletions

| diff --git a/fs/f2fs/segment.c b/fs/f2fs/segment.cindex edf205093f4358..b9ffb2ee9548ae 100644--- a/[fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.c?id=943c0f601cd28c1073b92b5f944c6c6c2643e709)+++ b/[fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.c?id=15136c3861a3341db261ebdbb6ae4ae1765635e2)@@ -1290,16 +1290,18 @@ static int \_\_submit\_discard\_cmd(struct f2fs\_sb\_info \*sbi, wait\_list, issued); return 0; }-- /\*- \* Issue discard for conventional zones only if the device- \* supports discard.- \*/- if (!bdev\_max\_discard\_sectors(bdev))- return -EOPNOTSUPP; } #endif + /\*+ \* stop issuing discard for any of below cases:+ \* 1. device is conventional zone, but it doesn't support discard.+ \* 2. device is regulare device, after snapshot it doesn't support+ \* discard.+ \*/+ if (!bdev\_max\_discard\_sectors(bdev))+ return -EOPNOTSUPP;+ trace\_f2fs\_issue\_discard(bdev, dc->di.start, dc->di.len);  lstart = dc->di.lstart;diff --git a/fs/f2fs/super.c b/fs/f2fs/super.cindex 983fdd98fc3755..a622056f27f3a2 100644--- a/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=943c0f601cd28c1073b92b5f944c6c6c2643e709)+++ b/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=15136c3861a3341db261ebdbb6ae4ae1765635e2)@@ -1748,6 +1748,18 @@ static int f2fs\_freeze(struct super\_block \*sb)  static int f2fs\_unfreeze(struct super\_block \*sb) {+ struct f2fs\_sb\_info \*sbi = F2FS\_SB(sb);++ /\*+ \* It will update discard\_max\_bytes of mounted lvm device to zero+ \* after creating snapshot on this lvm device, let's drop all+ \* remained discards.+ \* We don't need to disable real-time discard because discard\_max\_bytes+ \* will recover after removal of snapshot.+ \*/+ if (test\_opt(sbi, DISCARD) && !f2fs\_hw\_support\_discard(sbi))+ f2fs\_issue\_discard\_timeout(sbi);+ clear\_sbi\_flag(F2FS\_SB(sb), SBI\_IS\_FREEZING); return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:23 +0000



=== Content from git.kernel.org_c3a8608f_20250114_190747.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-11-21 22:17:16 +0800 |
| --- | --- | --- |
| committer | Jaegeuk Kim <jaegeuk@kernel.org> | 2024-11-23 15:48:15 +0000 |
| commit | [bc8aeb04fd80cb8cfae3058445c84410fd0beb5e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e)) | |
| tree | [dcd5d14adadcf5e00cd981bc924342a7380391d4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e) | |
| parent | [009a8241a8e5a14ea2dd0b8db42dbf283527dd44](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=009a8241a8e5a14ea2dd0b8db42dbf283527dd44) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e&id2=009a8241a8e5a14ea2dd0b8db42dbf283527dd44)) | |
| download | [linux-bc8aeb04fd80cb8cfae3058445c84410fd0beb5e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bc8aeb04fd80cb8cfae3058445c84410fd0beb5e.tar.gz) | |

f2fs: fix to drop all discards after creating snapshot on lvm devicePiergiorgio reported a bug in bugzilla as below:
------------[ cut here ]------------
WARNING: CPU: 2 PID: 969 at fs/f2fs/segment.c:1330
RIP: 0010:\_\_submit\_discard\_cmd+0x27d/0x400 [f2fs]
Call Trace:
\_\_issue\_discard\_cmd+0x1ca/0x350 [f2fs]
issue\_discard\_thread+0x191/0x480 [f2fs]
kthread+0xcf/0x100
ret\_from\_fork+0x31/0x50
ret\_from\_fork\_asm+0x1a/0x30
w/ below testcase, it can reproduce this bug quickly:
- pvcreate /dev/vdb
- vgcreate myvg1 /dev/vdb
- lvcreate -L 1024m -n mylv1 myvg1
- mount /dev/myvg1/mylv1 /mnt/f2fs
- dd if=/dev/zero of=/mnt/f2fs/file bs=1M count=20
- sync
- rm /mnt/f2fs/file
- sync
- lvcreate -L 1024m -s -n mylv1-snapshot /dev/myvg1/mylv1
- umount /mnt/f2fs
The root cause is: it will update discard\_max\_bytes of mounted lvm
device to zero after creating snapshot on this lvm device, then,
\_\_submit\_discard\_cmd() will pass parameter @nr\_sects w/ zero value
to \_\_blkdev\_issue\_discard(), it returns a NULL bio pointer, result
in panic.
This patch changes as below for fixing:
1. Let's drop all remained discards in f2fs\_unfreeze() if snapshot
of lvm device is created.
2. Checking discard\_max\_bytes before submitting discard during
\_\_submit\_discard\_cmd().
Cc: stable@vger.kernel.org
Fixes: 35ec7d574884 ("f2fs: split discard command in prior to block layer")
Reported-by: Piergiorgio Sartor <piergiorgio.sartor@nexgo.de>
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=219484
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e)

| -rw-r--r-- | [fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.c?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/super.c?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 21 insertions, 7 deletions

| diff --git a/fs/f2fs/segment.c b/fs/f2fs/segment.cindex 4236040e3994cc..eade36c5ef138c 100644--- a/[fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.c?id=009a8241a8e5a14ea2dd0b8db42dbf283527dd44)+++ b/[fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.c?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e)@@ -1290,16 +1290,18 @@ static int \_\_submit\_discard\_cmd(struct f2fs\_sb\_info \*sbi, wait\_list, issued); return 0; }-- /\*- \* Issue discard for conventional zones only if the device- \* supports discard.- \*/- if (!bdev\_max\_discard\_sectors(bdev))- return -EOPNOTSUPP; } #endif + /\*+ \* stop issuing discard for any of below cases:+ \* 1. device is conventional zone, but it doesn't support discard.+ \* 2. device is regulare device, after snapshot it doesn't support+ \* discard.+ \*/+ if (!bdev\_max\_discard\_sectors(bdev))+ return -EOPNOTSUPP;+ trace\_f2fs\_issue\_discard(bdev, dc->di.start, dc->di.len);  lstart = dc->di.lstart;diff --git a/fs/f2fs/super.c b/fs/f2fs/super.cindex c0670cd6195630..fc7d463dee158a 100644--- a/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=009a8241a8e5a14ea2dd0b8db42dbf283527dd44)+++ b/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=bc8aeb04fd80cb8cfae3058445c84410fd0beb5e)@@ -1760,6 +1760,18 @@ static int f2fs\_freeze(struct super\_block \*sb)  static int f2fs\_unfreeze(struct super\_block \*sb) {+ struct f2fs\_sb\_info \*sbi = F2FS\_SB(sb);++ /\*+ \* It will update discard\_max\_bytes of mounted lvm device to zero+ \* after creating snapshot on this lvm device, let's drop all+ \* remained discards.+ \* We don't need to disable real-time discard because discard\_max\_bytes+ \* will recover after removal of snapshot.+ \*/+ if (test\_opt(sbi, DISCARD) && !f2fs\_hw\_support\_discard(sbi))+ f2fs\_issue\_discard\_timeout(sbi);+ clear\_sbi\_flag(F2FS\_SB(sb), SBI\_IS\_FREEZING); return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:25 +0000



=== Content from git.kernel.org_62dc237a_20250114_190748.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-11-21 22:17:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:45 +0100 |
| commit | [ed24ab98242f8d22b66fbe0452c97751b5ea4e22](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22)) | |
| tree | [6e46614c33518e3cb7328d3c571aa846b5305cbb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22) | |
| parent | [f3ae93e738dbce362809662da7ac99c7297ee00c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3ae93e738dbce362809662da7ac99c7297ee00c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22&id2=f3ae93e738dbce362809662da7ac99c7297ee00c)) | |
| download | [linux-ed24ab98242f8d22b66fbe0452c97751b5ea4e22.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ed24ab98242f8d22b66fbe0452c97751b5ea4e22.tar.gz) | |

f2fs: fix to drop all discards after creating snapshot on lvm device[ Upstream commit bc8aeb04fd80cb8cfae3058445c84410fd0beb5e ]
Piergiorgio reported a bug in bugzilla as below:
------------[ cut here ]------------
WARNING: CPU: 2 PID: 969 at fs/f2fs/segment.c:1330
RIP: 0010:\_\_submit\_discard\_cmd+0x27d/0x400 [f2fs]
Call Trace:
\_\_issue\_discard\_cmd+0x1ca/0x350 [f2fs]
issue\_discard\_thread+0x191/0x480 [f2fs]
kthread+0xcf/0x100
ret\_from\_fork+0x31/0x50
ret\_from\_fork\_asm+0x1a/0x30
w/ below testcase, it can reproduce this bug quickly:
- pvcreate /dev/vdb
- vgcreate myvg1 /dev/vdb
- lvcreate -L 1024m -n mylv1 myvg1
- mount /dev/myvg1/mylv1 /mnt/f2fs
- dd if=/dev/zero of=/mnt/f2fs/file bs=1M count=20
- sync
- rm /mnt/f2fs/file
- sync
- lvcreate -L 1024m -s -n mylv1-snapshot /dev/myvg1/mylv1
- umount /mnt/f2fs
The root cause is: it will update discard\_max\_bytes of mounted lvm
device to zero after creating snapshot on this lvm device, then,
\_\_submit\_discard\_cmd() will pass parameter @nr\_sects w/ zero value
to \_\_blkdev\_issue\_discard(), it returns a NULL bio pointer, result
in panic.
This patch changes as below for fixing:
1. Let's drop all remained discards in f2fs\_unfreeze() if snapshot
of lvm device is created.
2. Checking discard\_max\_bytes before submitting discard during
\_\_submit\_discard\_cmd().
Cc: stable@vger.kernel.org
Fixes: 35ec7d574884 ("f2fs: split discard command in prior to block layer")
Reported-by: Piergiorgio Sartor <piergiorgio.sartor@nexgo.de>
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=219484
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22)

| -rw-r--r-- | [fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.c?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/super.c?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 21 insertions, 0 deletions

| diff --git a/fs/f2fs/segment.c b/fs/f2fs/segment.cindex 670104628ddbea..156d92b945258a 100644--- a/[fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.c?id=f3ae93e738dbce362809662da7ac99c7297ee00c)+++ b/[fs/f2fs/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.c?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22)@@ -1282,6 +1282,15 @@ static int \_\_submit\_discard\_cmd(struct f2fs\_sb\_info \*sbi, } #endif + /\*+ \* stop issuing discard for any of below cases:+ \* 1. device is conventional zone, but it doesn't support discard.+ \* 2. device is regulare device, after snapshot it doesn't support+ \* discard.+ \*/+ if (!bdev\_max\_discard\_sectors(bdev))+ return -EOPNOTSUPP;+ trace\_f2fs\_issue\_discard(bdev, dc->di.start, dc->di.len);  lstart = dc->di.lstart;diff --git a/fs/f2fs/super.c b/fs/f2fs/super.cindex f05d0e43db9e22..b72fa103b9632a 100644--- a/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=f3ae93e738dbce362809662da7ac99c7297ee00c)+++ b/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=ed24ab98242f8d22b66fbe0452c97751b5ea4e22)@@ -1735,6 +1735,18 @@ static int f2fs\_freeze(struct super\_block \*sb)  static int f2fs\_unfreeze(struct super\_block \*sb) {+ struct f2fs\_sb\_info \*sbi = F2FS\_SB(sb);++ /\*+ \* It will update discard\_max\_bytes of mounted lvm device to zero+ \* after creating snapshot on this lvm device, let's drop all+ \* remained discards.+ \* We don't need to disable real-time discard because discard\_max\_bytes+ \* will recover after removal of snapshot.+ \*/+ if (test\_opt(sbi, DISCARD) && !f2fs\_hw\_support\_discard(sbi))+ f2fs\_issue\_discard\_timeout(sbi);+ clear\_sbi\_flag(F2FS\_SB(sb), SBI\_IS\_FREEZING); return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:25 +0000


