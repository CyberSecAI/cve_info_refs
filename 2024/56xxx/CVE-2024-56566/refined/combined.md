=== Content from git.kernel.org_5fc5e66e_20250115_094613.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dbc16915279a548a204154368da23d402c141c81)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dbc16915279a548a204154368da23d402c141c81)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbc16915279a548a204154368da23d402c141c81)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbc16915279a548a204154368da23d402c141c81)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | yuan.gao <yuan.gao@ucloud.cn> | 2024-10-18 14:44:35 +0800 |
| --- | --- | --- |
| committer | Vlastimil Babka <vbabka@suse.cz> | 2024-11-16 21:19:39 +0100 |
| commit | [dbc16915279a548a204154368da23d402c141c81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbc16915279a548a204154368da23d402c141c81) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dbc16915279a548a204154368da23d402c141c81)) | |
| tree | [50ff9edfc00495a5d5b219c4a3cfee5e8e6cb51e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dbc16915279a548a204154368da23d402c141c81) | |
| parent | [080c8579c37ec9c11cfb8b9eb25b74912b33dc06](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=080c8579c37ec9c11cfb8b9eb25b74912b33dc06) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbc16915279a548a204154368da23d402c141c81&id2=080c8579c37ec9c11cfb8b9eb25b74912b33dc06)) | |
| download | [linux-dbc16915279a548a204154368da23d402c141c81.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dbc16915279a548a204154368da23d402c141c81.tar.gz) | |

mm/slub: Avoid list corruption when removing a slab from the full listBoot with slub\_debug=UFPZ.
If allocated object failed in alloc\_consistency\_checks, all objects of
the slab will be marked as used, and then the slab will be removed from
the partial list.
When an object belonging to the slab got freed later, the remove\_full()
function is called. Because the slab is neither on the partial list nor
on the full list, it eventually lead to a list corruption (actually a
list poison being detected).
So we need to mark and isolate the slab page with metadata corruption,
do not put it back in circulation.
Because the debug caches avoid all the fastpaths, reusing the frozen bit
to mark slab page with metadata corruption seems to be fine.
[ 4277.385669] list\_del corruption, ffffea00044b3e50->next is LIST\_POISON1 (dead000000000100)
[ 4277.387023] ------------[ cut here ]------------
[ 4277.387880] kernel BUG at lib/list\_debug.c:56!
[ 4277.388680] invalid opcode: 0000 [#1] PREEMPT SMP PTI
[ 4277.389562] CPU: 5 PID: 90 Comm: kworker/5:1 Kdump: loaded Tainted: G OE 6.6.1-1 #1
[ 4277.392113] Workqueue: xfs-inodegc/vda1 xfs\_inodegc\_worker [xfs]
[ 4277.393551] RIP: 0010:\_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.394518] Code: 48 91 82 e8 37 f9 9a ff 0f 0b 48 89 fe 48 c7 c7 28 49 91 82 e8 26 f9 9a ff 0f 0b 48 89 fe 48 c7 c7 58 49 91
[ 4277.397292] RSP: 0018:ffffc90000333b38 EFLAGS: 00010082
[ 4277.398202] RAX: 000000000000004e RBX: ffffea00044b3e50 RCX: 0000000000000000
[ 4277.399340] RDX: 0000000000000002 RSI: ffffffff828f8715 RDI: 00000000ffffffff
[ 4277.400545] RBP: ffffea00044b3e40 R08: 0000000000000000 R09: ffffc900003339f0
[ 4277.401710] R10: 0000000000000003 R11: ffffffff82d44088 R12: ffff888112cf9910
[ 4277.402887] R13: 0000000000000001 R14: 0000000000000001 R15: ffff8881000424c0
[ 4277.404049] FS: 0000000000000000(0000) GS:ffff88842fd40000(0000) knlGS:0000000000000000
[ 4277.405357] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 4277.406389] CR2: 00007f2ad0b24000 CR3: 0000000102a3a006 CR4: 00000000007706e0
[ 4277.407589] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 4277.408780] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 4277.410000] PKRU: 55555554
[ 4277.410645] Call Trace:
[ 4277.411234] <TASK>
[ 4277.411777] ? die+0x32/0x80
[ 4277.412439] ? do\_trap+0xd6/0x100
[ 4277.413150] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.414158] ? do\_error\_trap+0x6a/0x90
[ 4277.414948] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.415915] ? exc\_invalid\_op+0x4c/0x60
[ 4277.416710] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.417675] ? asm\_exc\_invalid\_op+0x16/0x20
[ 4277.418482] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.419466] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.420410] free\_to\_partial\_list+0x515/0x5e0
[ 4277.421242] ? xfs\_iext\_remove+0x41a/0xa10 [xfs]
[ 4277.422298] xfs\_iext\_remove+0x41a/0xa10 [xfs]
[ 4277.423316] ? xfs\_inodegc\_worker+0xb4/0x1a0 [xfs]
[ 4277.424383] xfs\_bmap\_del\_extent\_delay+0x4fe/0x7d0 [xfs]
[ 4277.425490] \_\_xfs\_bunmapi+0x50d/0x840 [xfs]
[ 4277.426445] xfs\_itruncate\_extents\_flags+0x13a/0x490 [xfs]
[ 4277.427553] xfs\_inactive\_truncate+0xa3/0x120 [xfs]
[ 4277.428567] xfs\_inactive+0x22d/0x290 [xfs]
[ 4277.429500] xfs\_inodegc\_worker+0xb4/0x1a0 [xfs]
[ 4277.430479] process\_one\_work+0x171/0x340
[ 4277.431227] worker\_thread+0x277/0x390
[ 4277.431962] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 4277.432752] kthread+0xf0/0x120
[ 4277.433382] ? \_\_pfx\_kthread+0x10/0x10
[ 4277.434134] ret\_from\_fork+0x2d/0x50
[ 4277.434837] ? \_\_pfx\_kthread+0x10/0x10
[ 4277.435566] ret\_from\_fork\_asm+0x1b/0x30
[ 4277.436280] </TASK>
Fixes: 643b113849d8 ("slub: enable tracking of full slabs")
Suggested-by: Hyeonggon Yoo <42.hyeyoo@gmail.com>
Suggested-by: Vlastimil Babka <vbabka@suse.cz>
Cc: <stable@vger.kernel.org>
Signed-off-by: yuan.gao <yuan.gao@ucloud.cn>
Reviewed-by: Hyeonggon Yoo <42.hyeyoo@gmail.com>
Acked-by: Christoph Lameter <cl@linux.com>
Signed-off-by: Vlastimil Babka <vbabka@suse.cz>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbc16915279a548a204154368da23d402c141c81)

| -rw-r--r-- | [mm/slab.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/slab.h?id=dbc16915279a548a204154368da23d402c141c81) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/slub.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/slub.c?id=dbc16915279a548a204154368da23d402c141c81) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 1 deletions

| diff --git a/mm/slab.h b/mm/slab.hindex 2985670194857e..632fedd71fea7b 100644--- a/[mm/slab.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slab.h?id=080c8579c37ec9c11cfb8b9eb25b74912b33dc06)+++ b/[mm/slab.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slab.h?id=dbc16915279a548a204154368da23d402c141c81)@@ -73,6 +73,11 @@ struct slab { struct { unsigned inuse:16; unsigned objects:15;+ /\*+ \* If slab debugging is enabled then the+ \* frozen bit can be reused to indicate+ \* that the slab was corrupted+ \*/ unsigned frozen:1; }; };diff --git a/mm/slub.c b/mm/slub.cindex 4284cbe41d0d00..ccbdd7eb37a87f 100644--- a/[mm/slub.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slub.c?id=080c8579c37ec9c11cfb8b9eb25b74912b33dc06)+++ b/[mm/slub.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slub.c?id=dbc16915279a548a204154368da23d402c141c81)@@ -1409,6 +1409,11 @@ static int check\_slab(struct kmem\_cache \*s, struct slab \*slab) slab->inuse, slab->objects); return 0; }+ if (slab->frozen) {+ slab\_err(s, slab, "Slab disabled since SLUB metadata consistency check failed");+ return 0;+ }+ /\* Slab\_pad\_check fixes things up after itself \*/ slab\_pad\_check(s, slab); return 1;@@ -1589,6 +1594,7 @@ bad: slab\_fix(s, "Marking all objects used"); slab->inuse = slab->objects; slab->freelist = NULL;+ slab->frozen = 1; /\* mark consistency-failed slab as frozen \*/ } return false; }@@ -2730,7 +2736,8 @@ static void \*alloc\_single\_from\_partial(struct kmem\_cache \*s, slab->inuse++;  if (!alloc\_debug\_processing(s, slab, object, orig\_size)) {- remove\_partial(n, slab);+ if (folio\_test\_slab(slab\_folio(slab)))+ remove\_partial(n, slab); return NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:44:49 +0000



=== Content from git.kernel.org_003c5d79_20250115_094611.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=33a213c04faff6c3a7fe77e947db81bc7270fe32)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=33a213c04faff6c3a7fe77e947db81bc7270fe32)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33a213c04faff6c3a7fe77e947db81bc7270fe32)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33a213c04faff6c3a7fe77e947db81bc7270fe32)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | yuan.gao <yuan.gao@ucloud.cn> | 2024-10-18 14:44:35 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:33:06 +0100 |
| commit | [33a213c04faff6c3a7fe77e947db81bc7270fe32](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33a213c04faff6c3a7fe77e947db81bc7270fe32) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=33a213c04faff6c3a7fe77e947db81bc7270fe32)) | |
| tree | [0f67c2c29c4dd44a9eca732e046fbb1c158add3a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=33a213c04faff6c3a7fe77e947db81bc7270fe32) | |
| parent | [2c932d5c7aac987b2c74e47fff94a9fd10ce2fc5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c932d5c7aac987b2c74e47fff94a9fd10ce2fc5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33a213c04faff6c3a7fe77e947db81bc7270fe32&id2=2c932d5c7aac987b2c74e47fff94a9fd10ce2fc5)) | |
| download | [linux-33a213c04faff6c3a7fe77e947db81bc7270fe32.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-33a213c04faff6c3a7fe77e947db81bc7270fe32.tar.gz) | |

mm/slub: Avoid list corruption when removing a slab from the full listcommit dbc16915279a548a204154368da23d402c141c81 upstream.
Boot with slub\_debug=UFPZ.
If allocated object failed in alloc\_consistency\_checks, all objects of
the slab will be marked as used, and then the slab will be removed from
the partial list.
When an object belonging to the slab got freed later, the remove\_full()
function is called. Because the slab is neither on the partial list nor
on the full list, it eventually lead to a list corruption (actually a
list poison being detected).
So we need to mark and isolate the slab page with metadata corruption,
do not put it back in circulation.
Because the debug caches avoid all the fastpaths, reusing the frozen bit
to mark slab page with metadata corruption seems to be fine.
[ 4277.385669] list\_del corruption, ffffea00044b3e50->next is LIST\_POISON1 (dead000000000100)
[ 4277.387023] ------------[ cut here ]------------
[ 4277.387880] kernel BUG at lib/list\_debug.c:56!
[ 4277.388680] invalid opcode: 0000 [#1] PREEMPT SMP PTI
[ 4277.389562] CPU: 5 PID: 90 Comm: kworker/5:1 Kdump: loaded Tainted: G OE 6.6.1-1 #1
[ 4277.392113] Workqueue: xfs-inodegc/vda1 xfs\_inodegc\_worker [xfs]
[ 4277.393551] RIP: 0010:\_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.394518] Code: 48 91 82 e8 37 f9 9a ff 0f 0b 48 89 fe 48 c7 c7 28 49 91 82 e8 26 f9 9a ff 0f 0b 48 89 fe 48 c7 c7 58 49 91
[ 4277.397292] RSP: 0018:ffffc90000333b38 EFLAGS: 00010082
[ 4277.398202] RAX: 000000000000004e RBX: ffffea00044b3e50 RCX: 0000000000000000
[ 4277.399340] RDX: 0000000000000002 RSI: ffffffff828f8715 RDI: 00000000ffffffff
[ 4277.400545] RBP: ffffea00044b3e40 R08: 0000000000000000 R09: ffffc900003339f0
[ 4277.401710] R10: 0000000000000003 R11: ffffffff82d44088 R12: ffff888112cf9910
[ 4277.402887] R13: 0000000000000001 R14: 0000000000000001 R15: ffff8881000424c0
[ 4277.404049] FS: 0000000000000000(0000) GS:ffff88842fd40000(0000) knlGS:0000000000000000
[ 4277.405357] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 4277.406389] CR2: 00007f2ad0b24000 CR3: 0000000102a3a006 CR4: 00000000007706e0
[ 4277.407589] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 4277.408780] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 4277.410000] PKRU: 55555554
[ 4277.410645] Call Trace:
[ 4277.411234] <TASK>
[ 4277.411777] ? die+0x32/0x80
[ 4277.412439] ? do\_trap+0xd6/0x100
[ 4277.413150] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.414158] ? do\_error\_trap+0x6a/0x90
[ 4277.414948] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.415915] ? exc\_invalid\_op+0x4c/0x60
[ 4277.416710] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.417675] ? asm\_exc\_invalid\_op+0x16/0x20
[ 4277.418482] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.419466] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.420410] free\_to\_partial\_list+0x515/0x5e0
[ 4277.421242] ? xfs\_iext\_remove+0x41a/0xa10 [xfs]
[ 4277.422298] xfs\_iext\_remove+0x41a/0xa10 [xfs]
[ 4277.423316] ? xfs\_inodegc\_worker+0xb4/0x1a0 [xfs]
[ 4277.424383] xfs\_bmap\_del\_extent\_delay+0x4fe/0x7d0 [xfs]
[ 4277.425490] \_\_xfs\_bunmapi+0x50d/0x840 [xfs]
[ 4277.426445] xfs\_itruncate\_extents\_flags+0x13a/0x490 [xfs]
[ 4277.427553] xfs\_inactive\_truncate+0xa3/0x120 [xfs]
[ 4277.428567] xfs\_inactive+0x22d/0x290 [xfs]
[ 4277.429500] xfs\_inodegc\_worker+0xb4/0x1a0 [xfs]
[ 4277.430479] process\_one\_work+0x171/0x340
[ 4277.431227] worker\_thread+0x277/0x390
[ 4277.431962] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 4277.432752] kthread+0xf0/0x120
[ 4277.433382] ? \_\_pfx\_kthread+0x10/0x10
[ 4277.434134] ret\_from\_fork+0x2d/0x50
[ 4277.434837] ? \_\_pfx\_kthread+0x10/0x10
[ 4277.435566] ret\_from\_fork\_asm+0x1b/0x30
[ 4277.436280] </TASK>
Fixes: 643b113849d8 ("slub: enable tracking of full slabs")
Suggested-by: Hyeonggon Yoo <42.hyeyoo@gmail.com>
Suggested-by: Vlastimil Babka <vbabka@suse.cz>
Cc: <stable@vger.kernel.org>
Signed-off-by: yuan.gao <yuan.gao@ucloud.cn>
Reviewed-by: Hyeonggon Yoo <42.hyeyoo@gmail.com>
Acked-by: Christoph Lameter <cl@linux.com>
Signed-off-by: Vlastimil Babka <vbabka@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33a213c04faff6c3a7fe77e947db81bc7270fe32)

| -rw-r--r-- | [mm/slab.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/slab.h?id=33a213c04faff6c3a7fe77e947db81bc7270fe32) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/slub.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/slub.c?id=33a213c04faff6c3a7fe77e947db81bc7270fe32) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 1 deletions

| diff --git a/mm/slab.h b/mm/slab.hindex 799a315695c679..62df6eeeb5ead7 100644--- a/[mm/slab.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slab.h?id=2c932d5c7aac987b2c74e47fff94a9fd10ce2fc5)+++ b/[mm/slab.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slab.h?id=33a213c04faff6c3a7fe77e947db81bc7270fe32)@@ -78,6 +78,11 @@ struct slab { struct { unsigned inuse:16; unsigned objects:15;+ /\*+ \* If slab debugging is enabled then the+ \* frozen bit can be reused to indicate+ \* that the slab was corrupted+ \*/ unsigned frozen:1; }; };diff --git a/mm/slub.c b/mm/slub.cindex f7940048138c5a..d2544c88a5c43c 100644--- a/[mm/slub.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slub.c?id=2c932d5c7aac987b2c74e47fff94a9fd10ce2fc5)+++ b/[mm/slub.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slub.c?id=33a213c04faff6c3a7fe77e947db81bc7270fe32)@@ -1275,6 +1275,11 @@ static int check\_slab(struct kmem\_cache \*s, struct slab \*slab) slab->inuse, slab->objects); return 0; }+ if (slab->frozen) {+ slab\_err(s, slab, "Slab disabled since SLUB metadata consistency check failed");+ return 0;+ }+ /\* Slab\_pad\_check fixes things up after itself \*/ slab\_pad\_check(s, slab); return 1;@@ -1463,6 +1468,7 @@ bad: slab\_fix(s, "Marking all objects used"); slab->inuse = slab->objects; slab->freelist = NULL;+ slab->frozen = 1; /\* mark consistency-failed slab as frozen \*/ } return false; }@@ -2162,7 +2168,8 @@ static void \*alloc\_single\_from\_partial(struct kmem\_cache \*s, slab->inuse++;  if (!alloc\_debug\_processing(s, slab, object, orig\_size)) {- remove\_partial(n, slab);+ if (folio\_test\_slab(slab\_folio(slab)))+ remove\_partial(n, slab); return NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:44:48 +0000



=== Content from git.kernel.org_7913f91d_20250115_094612.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=943c0f601cd28c1073b92b5f944c6c6c2643e709)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=943c0f601cd28c1073b92b5f944c6c6c2643e709)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=943c0f601cd28c1073b92b5f944c6c6c2643e709)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=943c0f601cd28c1073b92b5f944c6c6c2643e709)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | yuan.gao <yuan.gao@ucloud.cn> | 2024-10-18 14:44:35 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:41:04 +0100 |
| commit | [943c0f601cd28c1073b92b5f944c6c6c2643e709](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=943c0f601cd28c1073b92b5f944c6c6c2643e709) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=943c0f601cd28c1073b92b5f944c6c6c2643e709)) | |
| tree | [5a1b2dbd67b1f176aa50a944e62fd2a0f5ac5dc5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=943c0f601cd28c1073b92b5f944c6c6c2643e709) | |
| parent | [ac43ea3d27a8f9beadf3af66c9ea4a566ebfff1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac43ea3d27a8f9beadf3af66c9ea4a566ebfff1f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=943c0f601cd28c1073b92b5f944c6c6c2643e709&id2=ac43ea3d27a8f9beadf3af66c9ea4a566ebfff1f)) | |
| download | [linux-943c0f601cd28c1073b92b5f944c6c6c2643e709.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-943c0f601cd28c1073b92b5f944c6c6c2643e709.tar.gz) | |

mm/slub: Avoid list corruption when removing a slab from the full listcommit dbc16915279a548a204154368da23d402c141c81 upstream.
Boot with slub\_debug=UFPZ.
If allocated object failed in alloc\_consistency\_checks, all objects of
the slab will be marked as used, and then the slab will be removed from
the partial list.
When an object belonging to the slab got freed later, the remove\_full()
function is called. Because the slab is neither on the partial list nor
on the full list, it eventually lead to a list corruption (actually a
list poison being detected).
So we need to mark and isolate the slab page with metadata corruption,
do not put it back in circulation.
Because the debug caches avoid all the fastpaths, reusing the frozen bit
to mark slab page with metadata corruption seems to be fine.
[ 4277.385669] list\_del corruption, ffffea00044b3e50->next is LIST\_POISON1 (dead000000000100)
[ 4277.387023] ------------[ cut here ]------------
[ 4277.387880] kernel BUG at lib/list\_debug.c:56!
[ 4277.388680] invalid opcode: 0000 [#1] PREEMPT SMP PTI
[ 4277.389562] CPU: 5 PID: 90 Comm: kworker/5:1 Kdump: loaded Tainted: G OE 6.6.1-1 #1
[ 4277.392113] Workqueue: xfs-inodegc/vda1 xfs\_inodegc\_worker [xfs]
[ 4277.393551] RIP: 0010:\_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.394518] Code: 48 91 82 e8 37 f9 9a ff 0f 0b 48 89 fe 48 c7 c7 28 49 91 82 e8 26 f9 9a ff 0f 0b 48 89 fe 48 c7 c7 58 49 91
[ 4277.397292] RSP: 0018:ffffc90000333b38 EFLAGS: 00010082
[ 4277.398202] RAX: 000000000000004e RBX: ffffea00044b3e50 RCX: 0000000000000000
[ 4277.399340] RDX: 0000000000000002 RSI: ffffffff828f8715 RDI: 00000000ffffffff
[ 4277.400545] RBP: ffffea00044b3e40 R08: 0000000000000000 R09: ffffc900003339f0
[ 4277.401710] R10: 0000000000000003 R11: ffffffff82d44088 R12: ffff888112cf9910
[ 4277.402887] R13: 0000000000000001 R14: 0000000000000001 R15: ffff8881000424c0
[ 4277.404049] FS: 0000000000000000(0000) GS:ffff88842fd40000(0000) knlGS:0000000000000000
[ 4277.405357] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 4277.406389] CR2: 00007f2ad0b24000 CR3: 0000000102a3a006 CR4: 00000000007706e0
[ 4277.407589] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 4277.408780] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 4277.410000] PKRU: 55555554
[ 4277.410645] Call Trace:
[ 4277.411234] <TASK>
[ 4277.411777] ? die+0x32/0x80
[ 4277.412439] ? do\_trap+0xd6/0x100
[ 4277.413150] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.414158] ? do\_error\_trap+0x6a/0x90
[ 4277.414948] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.415915] ? exc\_invalid\_op+0x4c/0x60
[ 4277.416710] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.417675] ? asm\_exc\_invalid\_op+0x16/0x20
[ 4277.418482] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.419466] ? \_\_list\_del\_entry\_valid\_or\_report+0x7b/0xc0
[ 4277.420410] free\_to\_partial\_list+0x515/0x5e0
[ 4277.421242] ? xfs\_iext\_remove+0x41a/0xa10 [xfs]
[ 4277.422298] xfs\_iext\_remove+0x41a/0xa10 [xfs]
[ 4277.423316] ? xfs\_inodegc\_worker+0xb4/0x1a0 [xfs]
[ 4277.424383] xfs\_bmap\_del\_extent\_delay+0x4fe/0x7d0 [xfs]
[ 4277.425490] \_\_xfs\_bunmapi+0x50d/0x840 [xfs]
[ 4277.426445] xfs\_itruncate\_extents\_flags+0x13a/0x490 [xfs]
[ 4277.427553] xfs\_inactive\_truncate+0xa3/0x120 [xfs]
[ 4277.428567] xfs\_inactive+0x22d/0x290 [xfs]
[ 4277.429500] xfs\_inodegc\_worker+0xb4/0x1a0 [xfs]
[ 4277.430479] process\_one\_work+0x171/0x340
[ 4277.431227] worker\_thread+0x277/0x390
[ 4277.431962] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 4277.432752] kthread+0xf0/0x120
[ 4277.433382] ? \_\_pfx\_kthread+0x10/0x10
[ 4277.434134] ret\_from\_fork+0x2d/0x50
[ 4277.434837] ? \_\_pfx\_kthread+0x10/0x10
[ 4277.435566] ret\_from\_fork\_asm+0x1b/0x30
[ 4277.436280] </TASK>
Fixes: 643b113849d8 ("slub: enable tracking of full slabs")
Suggested-by: Hyeonggon Yoo <42.hyeyoo@gmail.com>
Suggested-by: Vlastimil Babka <vbabka@suse.cz>
Cc: <stable@vger.kernel.org>
Signed-off-by: yuan.gao <yuan.gao@ucloud.cn>
Reviewed-by: Hyeonggon Yoo <42.hyeyoo@gmail.com>
Acked-by: Christoph Lameter <cl@linux.com>
Signed-off-by: Vlastimil Babka <vbabka@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=943c0f601cd28c1073b92b5f944c6c6c2643e709)

| -rw-r--r-- | [mm/slab.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/slab.h?id=943c0f601cd28c1073b92b5f944c6c6c2643e709) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/slub.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/slub.c?id=943c0f601cd28c1073b92b5f944c6c6c2643e709) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 1 deletions

| diff --git a/mm/slab.h b/mm/slab.hindex 6c6fe6d630ce3d..92ca5ff2037534 100644--- a/[mm/slab.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slab.h?id=ac43ea3d27a8f9beadf3af66c9ea4a566ebfff1f)+++ b/[mm/slab.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slab.h?id=943c0f601cd28c1073b92b5f944c6c6c2643e709)@@ -73,6 +73,11 @@ struct slab { struct { unsigned inuse:16; unsigned objects:15;+ /\*+ \* If slab debugging is enabled then the+ \* frozen bit can be reused to indicate+ \* that the slab was corrupted+ \*/ unsigned frozen:1; }; };diff --git a/mm/slub.c b/mm/slub.cindex 5b832512044e3e..15ba89fef89a1f 100644--- a/[mm/slub.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slub.c?id=ac43ea3d27a8f9beadf3af66c9ea4a566ebfff1f)+++ b/[mm/slub.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/slub.c?id=943c0f601cd28c1073b92b5f944c6c6c2643e709)@@ -1423,6 +1423,11 @@ static int check\_slab(struct kmem\_cache \*s, struct slab \*slab) slab->inuse, slab->objects); return 0; }+ if (slab->frozen) {+ slab\_err(s, slab, "Slab disabled since SLUB metadata consistency check failed");+ return 0;+ }+ /\* Slab\_pad\_check fixes things up after itself \*/ slab\_pad\_check(s, slab); return 1;@@ -1603,6 +1608,7 @@ bad: slab\_fix(s, "Marking all objects used"); slab->inuse = slab->objects; slab->freelist = NULL;+ slab->frozen = 1; /\* mark consistency-failed slab as frozen \*/ } return false; }@@ -2744,7 +2750,8 @@ static void \*alloc\_single\_from\_partial(struct kmem\_cache \*s, slab->inuse++;  if (!alloc\_debug\_processing(s, slab, object, orig\_size)) {- remove\_partial(n, slab);+ if (folio\_test\_slab(slab\_folio(slab)))+ remove\_partial(n, slab); return NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:44:49 +0000


