=== Content from git.kernel.org_d5738dfb_20250114_181333.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f564f15f88490b484e02442dc4c4b11640ea172)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f564f15f88490b484e02442dc4c4b11640ea172)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f564f15f88490b484e02442dc4c4b11640ea172)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f564f15f88490b484e02442dc4c4b11640ea172)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yihang Li <liyihang9@huawei.com> | 2024-10-08 10:18:21 +0800 |
| --- | --- | --- |
| committer | Martin K. Petersen <martin.petersen@oracle.com> | 2024-10-15 22:33:35 -0400 |
| commit | [9f564f15f88490b484e02442dc4c4b11640ea172](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f564f15f88490b484e02442dc4c4b11640ea172) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f564f15f88490b484e02442dc4c4b11640ea172)) | |
| tree | [41da4c3fee51c0224a658029bd5f1ab7b8668984](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f564f15f88490b484e02442dc4c4b11640ea172) | |
| parent | [90f17e3431d9c643558c3c343407ee37783d5e43](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90f17e3431d9c643558c3c343407ee37783d5e43) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f564f15f88490b484e02442dc4c4b11640ea172&id2=90f17e3431d9c643558c3c343407ee37783d5e43)) | |
| download | [linux-9f564f15f88490b484e02442dc4c4b11640ea172.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f564f15f88490b484e02442dc4c4b11640ea172.tar.gz) | |

scsi: hisi\_sas: Create all dump files during debugfs initializationFor the current debugfs of hisi\_sas, after user triggers dump, the
driver allocate memory space to save the register information and create
debugfs files to display the saved information. In this process, the
debugfs files created after each dump.
Therefore, when the dump is triggered while the driver is unbind, the
following hang occurs:
[67840.853907] Unable to handle kernel NULL pointer dereference at virtual address 00000000000000a0
[67840.862947] Mem abort info:
[67840.865855] ESR = 0x0000000096000004
[67840.869713] EC = 0x25: DABT (current EL), IL = 32 bits
[67840.875125] SET = 0, FnV = 0
[67840.878291] EA = 0, S1PTW = 0
[67840.881545] FSC = 0x04: level 0 translation fault
[67840.886528] Data abort info:
[67840.889524] ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
[67840.895117] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[67840.900284] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[67840.905709] user pgtable: 4k pages, 48-bit VAs, pgdp=0000002803a1f000
[67840.912263] [00000000000000a0] pgd=0000000000000000, p4d=0000000000000000
[67840.919177] Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
[67840.996435] pstate: 80400009 (Nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[67841.003628] pc : down\_write+0x30/0x98
[67841.007546] lr : start\_creating.part.0+0x60/0x198
[67841.012495] sp : ffff8000b979ba20
[67841.016046] x29: ffff8000b979ba20 x28: 0000000000000010 x27: 0000000000024b40
[67841.023412] x26: 0000000000000012 x25: ffff20202b355ae8 x24: ffff20202b35a8c8
[67841.030779] x23: ffffa36877928208 x22: ffffa368b4972240 x21: ffff8000b979bb18
[67841.038147] x20: ffff00281dc1e3c0 x19: fffffffffffffffe x18: 0000000000000020
[67841.045515] x17: 0000000000000000 x16: ffffa368b128a530 x15: ffffffffffffffff
[67841.052888] x14: ffff8000b979bc18 x13: ffffffffffffffff x12: ffff8000b979bb18
[67841.060263] x11: 0000000000000000 x10: 0000000000000000 x9 : ffffa368b1289b18
[67841.067640] x8 : 0000000000000012 x7 : 0000000000000000 x6 : 00000000000003a9
[67841.075014] x5 : 0000000000000000 x4 : ffff002818c5cb00 x3 : 0000000000000001
[67841.082388] x2 : 0000000000000000 x1 : ffff002818c5cb00 x0 : 00000000000000a0
[67841.089759] Call trace:
[67841.092456] down\_write+0x30/0x98
[67841.096017] start\_creating.part.0+0x60/0x198
[67841.100613] debugfs\_create\_dir+0x48/0x1f8
[67841.104950] debugfs\_create\_files\_v3\_hw+0x88/0x348 [hisi\_sas\_v3\_hw]
[67841.111447] debugfs\_snapshot\_regs\_v3\_hw+0x708/0x798 [hisi\_sas\_v3\_hw]
[67841.118111] debugfs\_trigger\_dump\_v3\_hw\_write+0x9c/0x120 [hisi\_sas\_v3\_hw]
[67841.125115] full\_proxy\_write+0x68/0xc8
[67841.129175] vfs\_write+0xd8/0x3f0
[67841.132708] ksys\_write+0x70/0x108
[67841.136317] \_\_arm64\_sys\_write+0x24/0x38
[67841.140440] invoke\_syscall+0x50/0x128
[67841.144385] el0\_svc\_common.constprop.0+0xc8/0xf0
[67841.149273] do\_el0\_svc+0x24/0x38
[67841.152773] el0\_svc+0x38/0xd8
[67841.156009] el0t\_64\_sync\_handler+0xc0/0xc8
[67841.160361] el0t\_64\_sync+0x1a4/0x1a8
[67841.164189] Code: b9000882 d2800002 d2800023 f9800011 (c85ffc05)
[67841.170443] ---[ end trace 0000000000000000 ]---
To fix this issue, create all directories and files during debugfs
initialization. In this way, the driver only needs to allocate memory
space to save information each time the user triggers dumping.
Signed-off-by: Yihang Li <liyihang9@huawei.com>
Link: [https://lore.kernel.org/r/20241008021822.2617339-13-liyihang9@huawei.com](https://lore.kernel.org/r/20241008021822.2617339-13-liyihang9%40huawei.com)
Reviewed-by: Xingui Yang <yangxingui@huawei.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f564f15f88490b484e02442dc4c4b11640ea172)

| -rw-r--r-- | [drivers/scsi/hisi\_sas/hisi\_sas\_v3\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/hisi_sas/hisi_sas_v3_hw.c?id=9f564f15f88490b484e02442dc4c4b11640ea172) | 99 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 77 insertions, 22 deletions

| diff --git a/drivers/scsi/hisi\_sas/hisi\_sas\_v3\_hw.c b/drivers/scsi/hisi\_sas/hisi\_sas\_v3\_hw.cindex bc5c96320f5a5d..8250d44f0b3e92 100644--- a/[drivers/scsi/hisi\_sas/hisi\_sas\_v3\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/hisi_sas/hisi_sas_v3_hw.c?id=90f17e3431d9c643558c3c343407ee37783d5e43)+++ b/[drivers/scsi/hisi\_sas/hisi\_sas\_v3\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/hisi_sas/hisi_sas_v3_hw.c?id=9f564f15f88490b484e02442dc4c4b11640ea172)@@ -3576,6 +3576,11 @@ debugfs\_to\_reg\_name\_v3\_hw(int off, int base\_off, return NULL; } +static bool debugfs\_dump\_is\_generated\_v3\_hw(void \*p)+{+ return p ? true : false;+}+ static void debugfs\_print\_reg\_v3\_hw(u32 \*regs\_val, struct seq\_file \*s, const struct hisi\_sas\_debugfs\_reg \*reg) {@@ -3601,6 +3606,9 @@ static int debugfs\_global\_v3\_hw\_show(struct seq\_file \*s, void \*p) { struct hisi\_sas\_debugfs\_regs \*global = s->private; + if (!debugfs\_dump\_is\_generated\_v3\_hw(global->data))+ return -EPERM;+ debugfs\_print\_reg\_v3\_hw(global->data, s, &debugfs\_global\_reg); @@ -3612,6 +3620,9 @@ static int debugfs\_axi\_v3\_hw\_show(struct seq\_file \*s, void \*p) { struct hisi\_sas\_debugfs\_regs \*axi = s->private; + if (!debugfs\_dump\_is\_generated\_v3\_hw(axi->data))+ return -EPERM;+ debugfs\_print\_reg\_v3\_hw(axi->data, s, &debugfs\_axi\_reg); @@ -3623,6 +3634,9 @@ static int debugfs\_ras\_v3\_hw\_show(struct seq\_file \*s, void \*p) { struct hisi\_sas\_debugfs\_regs \*ras = s->private; + if (!debugfs\_dump\_is\_generated\_v3\_hw(ras->data))+ return -EPERM;+ debugfs\_print\_reg\_v3\_hw(ras->data, s, &debugfs\_ras\_reg); @@ -3635,6 +3649,9 @@ static int debugfs\_port\_v3\_hw\_show(struct seq\_file \*s, void \*p) struct hisi\_sas\_debugfs\_port \*port = s->private; const struct hisi\_sas\_debugfs\_reg \*reg\_port = &debugfs\_port\_reg; + if (!debugfs\_dump\_is\_generated\_v3\_hw(port->data))+ return -EPERM;+ debugfs\_print\_reg\_v3\_hw(port->data, s, reg\_port);  return 0;@@ -3690,6 +3707,9 @@ static int debugfs\_cq\_v3\_hw\_show(struct seq\_file \*s, void \*p) struct hisi\_sas\_debugfs\_cq \*debugfs\_cq = s->private; int slot; + if (!debugfs\_dump\_is\_generated\_v3\_hw(debugfs\_cq->complete\_hdr))+ return -EPERM;+ for (slot = 0; slot < HISI\_SAS\_QUEUE\_SLOTS; slot++) debugfs\_cq\_show\_slot\_v3\_hw(s, slot, debugfs\_cq); @@ -3711,8 +3731,12 @@ static void debugfs\_dq\_show\_slot\_v3\_hw(struct seq\_file \*s, int slot,  static int debugfs\_dq\_v3\_hw\_show(struct seq\_file \*s, void \*p) {+ struct hisi\_sas\_debugfs\_dq \*debugfs\_dq = s->private; int slot; + if (!debugfs\_dump\_is\_generated\_v3\_hw(debugfs\_dq->hdr))+ return -EPERM;+ for (slot = 0; slot < HISI\_SAS\_QUEUE\_SLOTS; slot++) debugfs\_dq\_show\_slot\_v3\_hw(s, slot, s->private); @@ -3726,6 +3750,9 @@ static int debugfs\_iost\_v3\_hw\_show(struct seq\_file \*s, void \*p) struct hisi\_sas\_iost \*iost = debugfs\_iost->iost; int i, max\_command\_entries = HISI\_SAS\_MAX\_COMMANDS; + if (!debugfs\_dump\_is\_generated\_v3\_hw(iost))+ return -EPERM;+ for (i = 0; i < max\_command\_entries; i++, iost++) { \_\_le64 \*data = &iost->qw0; @@ -3745,6 +3772,9 @@ static int debugfs\_iost\_cache\_v3\_hw\_show(struct seq\_file \*s, void \*p) int i, tab\_idx; \_\_le64 \*iost; + if (!debugfs\_dump\_is\_generated\_v3\_hw(iost\_cache))+ return -EPERM;+ for (i = 0; i < HISI\_SAS\_IOST\_ITCT\_CACHE\_NUM; i++, iost\_cache++) { /\* \* Data struct of IOST cache:@@ -3768,6 +3798,9 @@ static int debugfs\_itct\_v3\_hw\_show(struct seq\_file \*s, void \*p) struct hisi\_sas\_debugfs\_itct \*debugfs\_itct = s->private; struct hisi\_sas\_itct \*itct = debugfs\_itct->itct; + if (!debugfs\_dump\_is\_generated\_v3\_hw(itct))+ return -EPERM;+ for (i = 0; i < HISI\_SAS\_MAX\_ITCT\_ENTRIES; i++, itct++) { \_\_le64 \*data = &itct->qw0; @@ -3787,6 +3820,9 @@ static int debugfs\_itct\_cache\_v3\_hw\_show(struct seq\_file \*s, void \*p) int i, tab\_idx; \_\_le64 \*itct; + if (!debugfs\_dump\_is\_generated\_v3\_hw(itct\_cache))+ return -EPERM;+ for (i = 0; i < HISI\_SAS\_IOST\_ITCT\_CACHE\_NUM; i++, itct\_cache++) { /\* \* Data struct of ITCT cache:@@ -3804,10 +3840,9 @@ static int debugfs\_itct\_cache\_v3\_hw\_show(struct seq\_file \*s, void \*p) } DEFINE\_SHOW\_ATTRIBUTE(debugfs\_itct\_cache\_v3\_hw); -static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba)+static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba, int index) { u64 \*debugfs\_timestamp;- int dump\_index = hisi\_hba->debugfs\_dump\_index; struct dentry \*dump\_dentry; struct dentry \*dentry; char name[256];@@ -3815,17 +3850,17 @@ static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba) int c; int d; - snprintf(name, 256, "%d", dump\_index);+ snprintf(name, 256, "%d", index);  dump\_dentry = debugfs\_create\_dir(name, hisi\_hba->debugfs\_dump\_dentry); - debugfs\_timestamp = &hisi\_hba->debugfs\_timestamp[dump\_index];+ debugfs\_timestamp = &hisi\_hba->debugfs\_timestamp[index];  debugfs\_create\_u64("timestamp", 0400, dump\_dentry, debugfs\_timestamp);  debugfs\_create\_file("global", 0400, dump\_dentry,- &hisi\_hba->debugfs\_regs[dump\_index][DEBUGFS\_GLOBAL],+ &hisi\_hba->debugfs\_regs[index][DEBUGFS\_GLOBAL], &debugfs\_global\_v3\_hw\_fops);  /\* Create port dir and files \*/@@ -3834,7 +3869,7 @@ static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba) snprintf(name, 256, "%d", p);  debugfs\_create\_file(name, 0400, dentry,- &hisi\_hba->debugfs\_port\_reg[dump\_index][p],+ &hisi\_hba->debugfs\_port\_reg[index][p], &debugfs\_port\_v3\_hw\_fops); } @@ -3844,7 +3879,7 @@ static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba) snprintf(name, 256, "%d", c);  debugfs\_create\_file(name, 0400, dentry,- &hisi\_hba->debugfs\_cq[dump\_index][c],+ &hisi\_hba->debugfs\_cq[index][c], &debugfs\_cq\_v3\_hw\_fops); } @@ -3854,32 +3889,32 @@ static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba) snprintf(name, 256, "%d", d);  debugfs\_create\_file(name, 0400, dentry,- &hisi\_hba->debugfs\_dq[dump\_index][d],+ &hisi\_hba->debugfs\_dq[index][d], &debugfs\_dq\_v3\_hw\_fops); }  debugfs\_create\_file("iost", 0400, dump\_dentry,- &hisi\_hba->debugfs\_iost[dump\_index],+ &hisi\_hba->debugfs\_iost[index], &debugfs\_iost\_v3\_hw\_fops);  debugfs\_create\_file("iost\_cache", 0400, dump\_dentry,- &hisi\_hba->debugfs\_iost\_cache[dump\_index],+ &hisi\_hba->debugfs\_iost\_cache[index], &debugfs\_iost\_cache\_v3\_hw\_fops);  debugfs\_create\_file("itct", 0400, dump\_dentry,- &hisi\_hba->debugfs\_itct[dump\_index],+ &hisi\_hba->debugfs\_itct[index], &debugfs\_itct\_v3\_hw\_fops);  debugfs\_create\_file("itct\_cache", 0400, dump\_dentry,- &hisi\_hba->debugfs\_itct\_cache[dump\_index],+ &hisi\_hba->debugfs\_itct\_cache[index], &debugfs\_itct\_cache\_v3\_hw\_fops);  debugfs\_create\_file("axi", 0400, dump\_dentry,- &hisi\_hba->debugfs\_regs[dump\_index][DEBUGFS\_AXI],+ &hisi\_hba->debugfs\_regs[index][DEBUGFS\_AXI], &debugfs\_axi\_v3\_hw\_fops);  debugfs\_create\_file("ras", 0400, dump\_dentry,- &hisi\_hba->debugfs\_regs[dump\_index][DEBUGFS\_RAS],+ &hisi\_hba->debugfs\_regs[index][DEBUGFS\_RAS], &debugfs\_ras\_v3\_hw\_fops); } @@ -4542,22 +4577,34 @@ static void debugfs\_release\_v3\_hw(struct hisi\_hba \*hisi\_hba, int dump\_index) int i;  devm\_kfree(dev, hisi\_hba->debugfs\_iost\_cache[dump\_index].cache);+ hisi\_hba->debugfs\_iost\_cache[dump\_index].cache = NULL; devm\_kfree(dev, hisi\_hba->debugfs\_itct\_cache[dump\_index].cache);+ hisi\_hba->debugfs\_itct\_cache[dump\_index].cache = NULL; devm\_kfree(dev, hisi\_hba->debugfs\_iost[dump\_index].iost);+ hisi\_hba->debugfs\_iost[dump\_index].iost = NULL; devm\_kfree(dev, hisi\_hba->debugfs\_itct[dump\_index].itct);+ hisi\_hba->debugfs\_itct[dump\_index].itct = NULL; - for (i = 0; i < hisi\_hba->queue\_count; i++)+ for (i = 0; i < hisi\_hba->queue\_count; i++) { devm\_kfree(dev, hisi\_hba->debugfs\_dq[dump\_index][i].hdr);+ hisi\_hba->debugfs\_dq[dump\_index][i].hdr = NULL;+ } - for (i = 0; i < hisi\_hba->queue\_count; i++)+ for (i = 0; i < hisi\_hba->queue\_count; i++) { devm\_kfree(dev, hisi\_hba->debugfs\_cq[dump\_index][i].complete\_hdr);+ hisi\_hba->debugfs\_cq[dump\_index][i].complete\_hdr = NULL;+ } - for (i = 0; i < DEBUGFS\_REGS\_NUM; i++)+ for (i = 0; i < DEBUGFS\_REGS\_NUM; i++) { devm\_kfree(dev, hisi\_hba->debugfs\_regs[dump\_index][i].data);+ hisi\_hba->debugfs\_regs[dump\_index][i].data = NULL;+ } - for (i = 0; i < hisi\_hba->n\_phy; i++)+ for (i = 0; i < hisi\_hba->n\_phy; i++) { devm\_kfree(dev, hisi\_hba->debugfs\_port\_reg[dump\_index][i].data);+ hisi\_hba->debugfs\_port\_reg[dump\_index][i].data = NULL;+ } }  static const struct hisi\_sas\_debugfs\_reg \*debugfs\_reg\_array\_v3\_hw[DEBUGFS\_REGS\_NUM] = {@@ -4684,8 +4731,6 @@ static int debugfs\_snapshot\_regs\_v3\_hw(struct hisi\_hba \*hisi\_hba) debugfs\_snapshot\_itct\_reg\_v3\_hw(hisi\_hba); debugfs\_snapshot\_iost\_reg\_v3\_hw(hisi\_hba); - debugfs\_create\_files\_v3\_hw(hisi\_hba);- debugfs\_snapshot\_restore\_v3\_hw(hisi\_hba); hisi\_hba->debugfs\_dump\_index++; @@ -4769,6 +4814,17 @@ static void debugfs\_bist\_init\_v3\_hw(struct hisi\_hba \*hisi\_hba) hisi\_hba->debugfs\_bist\_linkrate = SAS\_LINK\_RATE\_1\_5\_GBPS; } +static void debugfs\_dump\_init\_v3\_hw(struct hisi\_hba \*hisi\_hba)+{+ int i;++ hisi\_hba->debugfs\_dump\_dentry =+ debugfs\_create\_dir("dump", hisi\_hba->debugfs\_dir);++ for (i = 0; i < hisi\_sas\_debugfs\_dump\_count; i++)+ debugfs\_create\_files\_v3\_hw(hisi\_hba, i);+}+ static void debugfs\_exit\_v3\_hw(struct hisi\_hba \*hisi\_hba) { debugfs\_remove\_recursive(hisi\_hba->debugfs\_dir);@@ -4784,8 +4840,7 @@ static void debugfs\_init\_v3\_hw(struct hisi\_hba \*hisi\_hba) /\* create bist structures \*/ debugfs\_bist\_init\_v3\_hw(hisi\_hba); - hisi\_hba->debugfs\_dump\_dentry =- debugfs\_create\_dir("dump", hisi\_hba->debugfs\_dir);+ debugfs\_dump\_init\_v3\_hw(hisi\_hba);  debugfs\_phy\_down\_cnt\_init\_v3\_hw(hisi\_hba); debugfs\_fifo\_init\_v3\_hw(hisi\_hba); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:12:10 +0000



=== Content from git.kernel.org_7578bba5_20250114_181332.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6c55f99123075e5429850b41b06f7dfffcb708eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c55f99123075e5429850b41b06f7dfffcb708eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c55f99123075e5429850b41b06f7dfffcb708eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c55f99123075e5429850b41b06f7dfffcb708eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yihang Li <liyihang9@huawei.com> | 2024-10-08 10:18:21 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:59 +0100 |
| commit | [6c55f99123075e5429850b41b06f7dfffcb708eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c55f99123075e5429850b41b06f7dfffcb708eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6c55f99123075e5429850b41b06f7dfffcb708eb)) | |
| tree | [72d2bf40f3f4a003e279242c9ac3eec1d1f4a75e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c55f99123075e5429850b41b06f7dfffcb708eb) | |
| parent | [601f8001373fc3fbad498f9be427254908b7fcce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=601f8001373fc3fbad498f9be427254908b7fcce) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c55f99123075e5429850b41b06f7dfffcb708eb&id2=601f8001373fc3fbad498f9be427254908b7fcce)) | |
| download | [linux-6c55f99123075e5429850b41b06f7dfffcb708eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6c55f99123075e5429850b41b06f7dfffcb708eb.tar.gz) | |

scsi: hisi\_sas: Create all dump files during debugfs initialization[ Upstream commit 9f564f15f88490b484e02442dc4c4b11640ea172 ]
For the current debugfs of hisi\_sas, after user triggers dump, the
driver allocate memory space to save the register information and create
debugfs files to display the saved information. In this process, the
debugfs files created after each dump.
Therefore, when the dump is triggered while the driver is unbind, the
following hang occurs:
[67840.853907] Unable to handle kernel NULL pointer dereference at virtual address 00000000000000a0
[67840.862947] Mem abort info:
[67840.865855] ESR = 0x0000000096000004
[67840.869713] EC = 0x25: DABT (current EL), IL = 32 bits
[67840.875125] SET = 0, FnV = 0
[67840.878291] EA = 0, S1PTW = 0
[67840.881545] FSC = 0x04: level 0 translation fault
[67840.886528] Data abort info:
[67840.889524] ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
[67840.895117] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[67840.900284] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[67840.905709] user pgtable: 4k pages, 48-bit VAs, pgdp=0000002803a1f000
[67840.912263] [00000000000000a0] pgd=0000000000000000, p4d=0000000000000000
[67840.919177] Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
[67840.996435] pstate: 80400009 (Nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[67841.003628] pc : down\_write+0x30/0x98
[67841.007546] lr : start\_creating.part.0+0x60/0x198
[67841.012495] sp : ffff8000b979ba20
[67841.016046] x29: ffff8000b979ba20 x28: 0000000000000010 x27: 0000000000024b40
[67841.023412] x26: 0000000000000012 x25: ffff20202b355ae8 x24: ffff20202b35a8c8
[67841.030779] x23: ffffa36877928208 x22: ffffa368b4972240 x21: ffff8000b979bb18
[67841.038147] x20: ffff00281dc1e3c0 x19: fffffffffffffffe x18: 0000000000000020
[67841.045515] x17: 0000000000000000 x16: ffffa368b128a530 x15: ffffffffffffffff
[67841.052888] x14: ffff8000b979bc18 x13: ffffffffffffffff x12: ffff8000b979bb18
[67841.060263] x11: 0000000000000000 x10: 0000000000000000 x9 : ffffa368b1289b18
[67841.067640] x8 : 0000000000000012 x7 : 0000000000000000 x6 : 00000000000003a9
[67841.075014] x5 : 0000000000000000 x4 : ffff002818c5cb00 x3 : 0000000000000001
[67841.082388] x2 : 0000000000000000 x1 : ffff002818c5cb00 x0 : 00000000000000a0
[67841.089759] Call trace:
[67841.092456] down\_write+0x30/0x98
[67841.096017] start\_creating.part.0+0x60/0x198
[67841.100613] debugfs\_create\_dir+0x48/0x1f8
[67841.104950] debugfs\_create\_files\_v3\_hw+0x88/0x348 [hisi\_sas\_v3\_hw]
[67841.111447] debugfs\_snapshot\_regs\_v3\_hw+0x708/0x798 [hisi\_sas\_v3\_hw]
[67841.118111] debugfs\_trigger\_dump\_v3\_hw\_write+0x9c/0x120 [hisi\_sas\_v3\_hw]
[67841.125115] full\_proxy\_write+0x68/0xc8
[67841.129175] vfs\_write+0xd8/0x3f0
[67841.132708] ksys\_write+0x70/0x108
[67841.136317] \_\_arm64\_sys\_write+0x24/0x38
[67841.140440] invoke\_syscall+0x50/0x128
[67841.144385] el0\_svc\_common.constprop.0+0xc8/0xf0
[67841.149273] do\_el0\_svc+0x24/0x38
[67841.152773] el0\_svc+0x38/0xd8
[67841.156009] el0t\_64\_sync\_handler+0xc0/0xc8
[67841.160361] el0t\_64\_sync+0x1a4/0x1a8
[67841.164189] Code: b9000882 d2800002 d2800023 f9800011 (c85ffc05)
[67841.170443] ---[ end trace 0000000000000000 ]---
To fix this issue, create all directories and files during debugfs
initialization. In this way, the driver only needs to allocate memory
space to save information each time the user triggers dumping.
Signed-off-by: Yihang Li <liyihang9@huawei.com>
Link: [https://lore.kernel.org/r/20241008021822.2617339-13-liyihang9@huawei.com](https://lore.kernel.org/r/20241008021822.2617339-13-liyihang9%40huawei.com)
Reviewed-by: Xingui Yang <yangxingui@huawei.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c55f99123075e5429850b41b06f7dfffcb708eb)

| -rw-r--r-- | [drivers/scsi/hisi\_sas/hisi\_sas\_v3\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/hisi_sas/hisi_sas_v3_hw.c?id=6c55f99123075e5429850b41b06f7dfffcb708eb) | 99 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 77 insertions, 22 deletions

| diff --git a/drivers/scsi/hisi\_sas/hisi\_sas\_v3\_hw.c b/drivers/scsi/hisi\_sas/hisi\_sas\_v3\_hw.cindex a7401bade099a6..cd394d8c9f07f0 100644--- a/[drivers/scsi/hisi\_sas/hisi\_sas\_v3\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/hisi_sas/hisi_sas_v3_hw.c?id=601f8001373fc3fbad498f9be427254908b7fcce)+++ b/[drivers/scsi/hisi\_sas/hisi\_sas\_v3\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/hisi_sas/hisi_sas_v3_hw.c?id=6c55f99123075e5429850b41b06f7dfffcb708eb)@@ -3551,6 +3551,11 @@ debugfs\_to\_reg\_name\_v3\_hw(int off, int base\_off, return NULL; } +static bool debugfs\_dump\_is\_generated\_v3\_hw(void \*p)+{+ return p ? true : false;+}+ static void debugfs\_print\_reg\_v3\_hw(u32 \*regs\_val, struct seq\_file \*s, const struct hisi\_sas\_debugfs\_reg \*reg) {@@ -3576,6 +3581,9 @@ static int debugfs\_global\_v3\_hw\_show(struct seq\_file \*s, void \*p) { struct hisi\_sas\_debugfs\_regs \*global = s->private; + if (!debugfs\_dump\_is\_generated\_v3\_hw(global->data))+ return -EPERM;+ debugfs\_print\_reg\_v3\_hw(global->data, s, &debugfs\_global\_reg); @@ -3587,6 +3595,9 @@ static int debugfs\_axi\_v3\_hw\_show(struct seq\_file \*s, void \*p) { struct hisi\_sas\_debugfs\_regs \*axi = s->private; + if (!debugfs\_dump\_is\_generated\_v3\_hw(axi->data))+ return -EPERM;+ debugfs\_print\_reg\_v3\_hw(axi->data, s, &debugfs\_axi\_reg); @@ -3598,6 +3609,9 @@ static int debugfs\_ras\_v3\_hw\_show(struct seq\_file \*s, void \*p) { struct hisi\_sas\_debugfs\_regs \*ras = s->private; + if (!debugfs\_dump\_is\_generated\_v3\_hw(ras->data))+ return -EPERM;+ debugfs\_print\_reg\_v3\_hw(ras->data, s, &debugfs\_ras\_reg); @@ -3610,6 +3624,9 @@ static int debugfs\_port\_v3\_hw\_show(struct seq\_file \*s, void \*p) struct hisi\_sas\_debugfs\_port \*port = s->private; const struct hisi\_sas\_debugfs\_reg \*reg\_port = &debugfs\_port\_reg; + if (!debugfs\_dump\_is\_generated\_v3\_hw(port->data))+ return -EPERM;+ debugfs\_print\_reg\_v3\_hw(port->data, s, reg\_port);  return 0;@@ -3665,6 +3682,9 @@ static int debugfs\_cq\_v3\_hw\_show(struct seq\_file \*s, void \*p) struct hisi\_sas\_debugfs\_cq \*debugfs\_cq = s->private; int slot; + if (!debugfs\_dump\_is\_generated\_v3\_hw(debugfs\_cq->complete\_hdr))+ return -EPERM;+ for (slot = 0; slot < HISI\_SAS\_QUEUE\_SLOTS; slot++) debugfs\_cq\_show\_slot\_v3\_hw(s, slot, debugfs\_cq); @@ -3686,8 +3706,12 @@ static void debugfs\_dq\_show\_slot\_v3\_hw(struct seq\_file \*s, int slot,  static int debugfs\_dq\_v3\_hw\_show(struct seq\_file \*s, void \*p) {+ struct hisi\_sas\_debugfs\_dq \*debugfs\_dq = s->private; int slot; + if (!debugfs\_dump\_is\_generated\_v3\_hw(debugfs\_dq->hdr))+ return -EPERM;+ for (slot = 0; slot < HISI\_SAS\_QUEUE\_SLOTS; slot++) debugfs\_dq\_show\_slot\_v3\_hw(s, slot, s->private); @@ -3701,6 +3725,9 @@ static int debugfs\_iost\_v3\_hw\_show(struct seq\_file \*s, void \*p) struct hisi\_sas\_iost \*iost = debugfs\_iost->iost; int i, max\_command\_entries = HISI\_SAS\_MAX\_COMMANDS; + if (!debugfs\_dump\_is\_generated\_v3\_hw(iost))+ return -EPERM;+ for (i = 0; i < max\_command\_entries; i++, iost++) { \_\_le64 \*data = &iost->qw0; @@ -3720,6 +3747,9 @@ static int debugfs\_iost\_cache\_v3\_hw\_show(struct seq\_file \*s, void \*p) int i, tab\_idx; \_\_le64 \*iost; + if (!debugfs\_dump\_is\_generated\_v3\_hw(iost\_cache))+ return -EPERM;+ for (i = 0; i < HISI\_SAS\_IOST\_ITCT\_CACHE\_NUM; i++, iost\_cache++) { /\* \* Data struct of IOST cache:@@ -3743,6 +3773,9 @@ static int debugfs\_itct\_v3\_hw\_show(struct seq\_file \*s, void \*p) struct hisi\_sas\_debugfs\_itct \*debugfs\_itct = s->private; struct hisi\_sas\_itct \*itct = debugfs\_itct->itct; + if (!debugfs\_dump\_is\_generated\_v3\_hw(itct))+ return -EPERM;+ for (i = 0; i < HISI\_SAS\_MAX\_ITCT\_ENTRIES; i++, itct++) { \_\_le64 \*data = &itct->qw0; @@ -3762,6 +3795,9 @@ static int debugfs\_itct\_cache\_v3\_hw\_show(struct seq\_file \*s, void \*p) int i, tab\_idx; \_\_le64 \*itct; + if (!debugfs\_dump\_is\_generated\_v3\_hw(itct\_cache))+ return -EPERM;+ for (i = 0; i < HISI\_SAS\_IOST\_ITCT\_CACHE\_NUM; i++, itct\_cache++) { /\* \* Data struct of ITCT cache:@@ -3779,10 +3815,9 @@ static int debugfs\_itct\_cache\_v3\_hw\_show(struct seq\_file \*s, void \*p) } DEFINE\_SHOW\_ATTRIBUTE(debugfs\_itct\_cache\_v3\_hw); -static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba)+static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba, int index) { u64 \*debugfs\_timestamp;- int dump\_index = hisi\_hba->debugfs\_dump\_index; struct dentry \*dump\_dentry; struct dentry \*dentry; char name[256];@@ -3790,17 +3825,17 @@ static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba) int c; int d; - snprintf(name, 256, "%d", dump\_index);+ snprintf(name, 256, "%d", index);  dump\_dentry = debugfs\_create\_dir(name, hisi\_hba->debugfs\_dump\_dentry); - debugfs\_timestamp = &hisi\_hba->debugfs\_timestamp[dump\_index];+ debugfs\_timestamp = &hisi\_hba->debugfs\_timestamp[index];  debugfs\_create\_u64("timestamp", 0400, dump\_dentry, debugfs\_timestamp);  debugfs\_create\_file("global", 0400, dump\_dentry,- &hisi\_hba->debugfs\_regs[dump\_index][DEBUGFS\_GLOBAL],+ &hisi\_hba->debugfs\_regs[index][DEBUGFS\_GLOBAL], &debugfs\_global\_v3\_hw\_fops);  /\* Create port dir and files \*/@@ -3809,7 +3844,7 @@ static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba) snprintf(name, 256, "%d", p);  debugfs\_create\_file(name, 0400, dentry,- &hisi\_hba->debugfs\_port\_reg[dump\_index][p],+ &hisi\_hba->debugfs\_port\_reg[index][p], &debugfs\_port\_v3\_hw\_fops); } @@ -3819,7 +3854,7 @@ static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba) snprintf(name, 256, "%d", c);  debugfs\_create\_file(name, 0400, dentry,- &hisi\_hba->debugfs\_cq[dump\_index][c],+ &hisi\_hba->debugfs\_cq[index][c], &debugfs\_cq\_v3\_hw\_fops); } @@ -3829,32 +3864,32 @@ static void debugfs\_create\_files\_v3\_hw(struct hisi\_hba \*hisi\_hba) snprintf(name, 256, "%d", d);  debugfs\_create\_file(name, 0400, dentry,- &hisi\_hba->debugfs\_dq[dump\_index][d],+ &hisi\_hba->debugfs\_dq[index][d], &debugfs\_dq\_v3\_hw\_fops); }  debugfs\_create\_file("iost", 0400, dump\_dentry,- &hisi\_hba->debugfs\_iost[dump\_index],+ &hisi\_hba->debugfs\_iost[index], &debugfs\_iost\_v3\_hw\_fops);  debugfs\_create\_file("iost\_cache", 0400, dump\_dentry,- &hisi\_hba->debugfs\_iost\_cache[dump\_index],+ &hisi\_hba->debugfs\_iost\_cache[index], &debugfs\_iost\_cache\_v3\_hw\_fops);  debugfs\_create\_file("itct", 0400, dump\_dentry,- &hisi\_hba->debugfs\_itct[dump\_index],+ &hisi\_hba->debugfs\_itct[index], &debugfs\_itct\_v3\_hw\_fops);  debugfs\_create\_file("itct\_cache", 0400, dump\_dentry,- &hisi\_hba->debugfs\_itct\_cache[dump\_index],+ &hisi\_hba->debugfs\_itct\_cache[index], &debugfs\_itct\_cache\_v3\_hw\_fops);  debugfs\_create\_file("axi", 0400, dump\_dentry,- &hisi\_hba->debugfs\_regs[dump\_index][DEBUGFS\_AXI],+ &hisi\_hba->debugfs\_regs[index][DEBUGFS\_AXI], &debugfs\_axi\_v3\_hw\_fops);  debugfs\_create\_file("ras", 0400, dump\_dentry,- &hisi\_hba->debugfs\_regs[dump\_index][DEBUGFS\_RAS],+ &hisi\_hba->debugfs\_regs[index][DEBUGFS\_RAS], &debugfs\_ras\_v3\_hw\_fops); } @@ -4517,22 +4552,34 @@ static void debugfs\_release\_v3\_hw(struct hisi\_hba \*hisi\_hba, int dump\_index) int i;  devm\_kfree(dev, hisi\_hba->debugfs\_iost\_cache[dump\_index].cache);+ hisi\_hba->debugfs\_iost\_cache[dump\_index].cache = NULL; devm\_kfree(dev, hisi\_hba->debugfs\_itct\_cache[dump\_index].cache);+ hisi\_hba->debugfs\_itct\_cache[dump\_index].cache = NULL; devm\_kfree(dev, hisi\_hba->debugfs\_iost[dump\_index].iost);+ hisi\_hba->debugfs\_iost[dump\_index].iost = NULL; devm\_kfree(dev, hisi\_hba->debugfs\_itct[dump\_index].itct);+ hisi\_hba->debugfs\_itct[dump\_index].itct = NULL; - for (i = 0; i < hisi\_hba->queue\_count; i++)+ for (i = 0; i < hisi\_hba->queue\_count; i++) { devm\_kfree(dev, hisi\_hba->debugfs\_dq[dump\_index][i].hdr);+ hisi\_hba->debugfs\_dq[dump\_index][i].hdr = NULL;+ } - for (i = 0; i < hisi\_hba->queue\_count; i++)+ for (i = 0; i < hisi\_hba->queue\_count; i++) { devm\_kfree(dev, hisi\_hba->debugfs\_cq[dump\_index][i].complete\_hdr);+ hisi\_hba->debugfs\_cq[dump\_index][i].complete\_hdr = NULL;+ } - for (i = 0; i < DEBUGFS\_REGS\_NUM; i++)+ for (i = 0; i < DEBUGFS\_REGS\_NUM; i++) { devm\_kfree(dev, hisi\_hba->debugfs\_regs[dump\_index][i].data);+ hisi\_hba->debugfs\_regs[dump\_index][i].data = NULL;+ } - for (i = 0; i < hisi\_hba->n\_phy; i++)+ for (i = 0; i < hisi\_hba->n\_phy; i++) { devm\_kfree(dev, hisi\_hba->debugfs\_port\_reg[dump\_index][i].data);+ hisi\_hba->debugfs\_port\_reg[dump\_index][i].data = NULL;+ } }  static const struct hisi\_sas\_debugfs\_reg \*debugfs\_reg\_array\_v3\_hw[DEBUGFS\_REGS\_NUM] = {@@ -4659,8 +4706,6 @@ static int debugfs\_snapshot\_regs\_v3\_hw(struct hisi\_hba \*hisi\_hba) debugfs\_snapshot\_itct\_reg\_v3\_hw(hisi\_hba); debugfs\_snapshot\_iost\_reg\_v3\_hw(hisi\_hba); - debugfs\_create\_files\_v3\_hw(hisi\_hba);- debugfs\_snapshot\_restore\_v3\_hw(hisi\_hba); hisi\_hba->debugfs\_dump\_index++; @@ -4744,6 +4789,17 @@ static void debugfs\_bist\_init\_v3\_hw(struct hisi\_hba \*hisi\_hba) hisi\_hba->debugfs\_bist\_linkrate = SAS\_LINK\_RATE\_1\_5\_GBPS; } +static void debugfs\_dump\_init\_v3\_hw(struct hisi\_hba \*hisi\_hba)+{+ int i;++ hisi\_hba->debugfs\_dump\_dentry =+ debugfs\_create\_dir("dump", hisi\_hba->debugfs\_dir);++ for (i = 0; i < hisi\_sas\_debugfs\_dump\_count; i++)+ debugfs\_create\_files\_v3\_hw(hisi\_hba, i);+}+ static void debugfs\_exit\_v3\_hw(struct hisi\_hba \*hisi\_hba) { debugfs\_remove\_recursive(hisi\_hba->debugfs\_dir);@@ -4764,8 +4820,7 @@ static void debugfs\_init\_v3\_hw(struct hisi\_hba \*hisi\_hba) /\* create bist structures \*/ debugfs\_bist\_init\_v3\_hw(hisi\_hba); - hisi\_hba->debugfs\_dump\_dentry =- debugfs\_create\_dir("dump", hisi\_hba->debugfs\_dir);+ debugfs\_dump\_init\_v3\_hw(hisi\_hba);  debugfs\_phy\_down\_cnt\_init\_v3\_hw(hisi\_hba); debugfs\_fifo\_init\_v3\_hw(hisi\_hba); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:12:09 +0000


