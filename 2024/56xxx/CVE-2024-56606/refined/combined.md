=== Content from git.kernel.org_531590ae_20250114_195636.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-14 16:38:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:51 +0100 |
| commit | [71b22837a5e55ac27d6a14b9cdf2326587405c4f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f)) | |
| tree | [1a784d9230f3c1d123966cd7a97daf58135a3c0d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f) | |
| parent | [4803d81373ae3d2bdfb4b4a5f36354980228f32e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4803d81373ae3d2bdfb4b4a5f36354980228f32e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f&id2=4803d81373ae3d2bdfb4b4a5f36354980228f32e)) | |
| download | [linux-71b22837a5e55ac27d6a14b9cdf2326587405c4f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-71b22837a5e55ac27d6a14b9cdf2326587405c4f.tar.gz) | |

af\_packet: avoid erroring out after sock\_init\_data() in packet\_create()[ Upstream commit 46f2a11cb82b657fd15bab1c47821b635e03838b ]
After sock\_init\_data() the allocated sk object is attached to the provided
sock object. On error, packet\_create() frees the sk object leaving the
dangling pointer in the sock object on return. Some other code may try
to use this pointer and cause use-after-free.
Suggested-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241014153808.51894-2-ignat@cloudflare.com](https://patch.msgid.link/20241014153808.51894-2-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f)

| -rw-r--r-- | [net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/packet/af_packet.c?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/net/packet/af\_packet.c b/net/packet/af\_packet.cindex 6aed6a36ea456e..88bc4a21dda455 100644--- a/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=4803d81373ae3d2bdfb4b4a5f36354980228f32e)+++ b/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=71b22837a5e55ac27d6a14b9cdf2326587405c4f)@@ -3357,18 +3357,18 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, if (sock->type == SOCK\_PACKET) sock->ops = &packet\_ops\_spkt; + po = pkt\_sk(sk);+ err = packet\_alloc\_pending(po);+ if (err)+ goto out\_sk\_free;+ sock\_init\_data(sock, sk); - po = pkt\_sk(sk); init\_completion(&po->skb\_completion); sk->sk\_family = PF\_PACKET; po->num = proto; po->xmit = dev\_queue\_xmit; - err = packet\_alloc\_pending(po);- if (err)- goto out2;- packet\_cached\_dev\_reset(po);  sk->sk\_destruct = packet\_sock\_destruct;@@ -3403,7 +3403,7 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, preempt\_enable();  return 0;-out2:+out\_sk\_free: sk\_free(sk); out: return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:13 +0000



=== Content from git.kernel.org_067d14e2_20250114_195634.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=157f08db94123e2ba56877dd0ac88908b13a5dd0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=157f08db94123e2ba56877dd0ac88908b13a5dd0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=157f08db94123e2ba56877dd0ac88908b13a5dd0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=157f08db94123e2ba56877dd0ac88908b13a5dd0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-14 16:38:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:00:04 +0100 |
| commit | [157f08db94123e2ba56877dd0ac88908b13a5dd0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=157f08db94123e2ba56877dd0ac88908b13a5dd0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=157f08db94123e2ba56877dd0ac88908b13a5dd0)) | |
| tree | [c20cccae3849722f2a2314116c51cd80c47c4fc1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=157f08db94123e2ba56877dd0ac88908b13a5dd0) | |
| parent | [b77109f18a8ddc7c74743694cff27c22dc49811c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b77109f18a8ddc7c74743694cff27c22dc49811c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=157f08db94123e2ba56877dd0ac88908b13a5dd0&id2=b77109f18a8ddc7c74743694cff27c22dc49811c)) | |
| download | [linux-157f08db94123e2ba56877dd0ac88908b13a5dd0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-157f08db94123e2ba56877dd0ac88908b13a5dd0.tar.gz) | |

af\_packet: avoid erroring out after sock\_init\_data() in packet\_create()[ Upstream commit 46f2a11cb82b657fd15bab1c47821b635e03838b ]
After sock\_init\_data() the allocated sk object is attached to the provided
sock object. On error, packet\_create() frees the sk object leaving the
dangling pointer in the sock object on return. Some other code may try
to use this pointer and cause use-after-free.
Suggested-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241014153808.51894-2-ignat@cloudflare.com](https://patch.msgid.link/20241014153808.51894-2-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=157f08db94123e2ba56877dd0ac88908b13a5dd0)

| -rw-r--r-- | [net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/packet/af_packet.c?id=157f08db94123e2ba56877dd0ac88908b13a5dd0) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/net/packet/af\_packet.c b/net/packet/af\_packet.cindex 3e5703537e4eb8..56e3ae3b6be93f 100644--- a/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=b77109f18a8ddc7c74743694cff27c22dc49811c)+++ b/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=157f08db94123e2ba56877dd0ac88908b13a5dd0)@@ -3428,17 +3428,17 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, if (sock->type == SOCK\_PACKET) sock->ops = &packet\_ops\_spkt; + po = pkt\_sk(sk);+ err = packet\_alloc\_pending(po);+ if (err)+ goto out\_sk\_free;+ sock\_init\_data(sock, sk); - po = pkt\_sk(sk); init\_completion(&po->skb\_completion); sk->sk\_family = PF\_PACKET; po->num = proto; - err = packet\_alloc\_pending(po);- if (err)- goto out2;- packet\_cached\_dev\_reset(po);  sk->sk\_destruct = packet\_sock\_destruct;@@ -3470,7 +3470,7 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, sock\_prot\_inuse\_add(net, &packet\_proto, 1);  return 0;-out2:+out\_sk\_free: sk\_free(sk); out: return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:12 +0000



=== Content from git.kernel.org_36b71785_20250114_195636.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a6cf750b737374454a4e03a5ed449a3eb0c96414)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6cf750b737374454a4e03a5ed449a3eb0c96414)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6cf750b737374454a4e03a5ed449a3eb0c96414)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6cf750b737374454a4e03a5ed449a3eb0c96414)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-14 16:38:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:41 +0100 |
| commit | [a6cf750b737374454a4e03a5ed449a3eb0c96414](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6cf750b737374454a4e03a5ed449a3eb0c96414) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a6cf750b737374454a4e03a5ed449a3eb0c96414)) | |
| tree | [6b72449bb9c15780ab2970be3011fe2f2c5db362](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6cf750b737374454a4e03a5ed449a3eb0c96414) | |
| parent | [a478f3841e6c2f17f4ede2c2bcf44864381f8bac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a478f3841e6c2f17f4ede2c2bcf44864381f8bac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6cf750b737374454a4e03a5ed449a3eb0c96414&id2=a478f3841e6c2f17f4ede2c2bcf44864381f8bac)) | |
| download | [linux-a6cf750b737374454a4e03a5ed449a3eb0c96414.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a6cf750b737374454a4e03a5ed449a3eb0c96414.tar.gz) | |

af\_packet: avoid erroring out after sock\_init\_data() in packet\_create()[ Upstream commit 46f2a11cb82b657fd15bab1c47821b635e03838b ]
After sock\_init\_data() the allocated sk object is attached to the provided
sock object. On error, packet\_create() frees the sk object leaving the
dangling pointer in the sock object on return. Some other code may try
to use this pointer and cause use-after-free.
Suggested-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241014153808.51894-2-ignat@cloudflare.com](https://patch.msgid.link/20241014153808.51894-2-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6cf750b737374454a4e03a5ed449a3eb0c96414)

| -rw-r--r-- | [net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/packet/af_packet.c?id=a6cf750b737374454a4e03a5ed449a3eb0c96414) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/net/packet/af\_packet.c b/net/packet/af\_packet.cindex c9c813f731c6ec..9da9e41899c655 100644--- a/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=a478f3841e6c2f17f4ede2c2bcf44864381f8bac)+++ b/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=a6cf750b737374454a4e03a5ed449a3eb0c96414)@@ -3418,18 +3418,18 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, if (sock->type == SOCK\_PACKET) sock->ops = &packet\_ops\_spkt; + po = pkt\_sk(sk);+ err = packet\_alloc\_pending(po);+ if (err)+ goto out\_sk\_free;+ sock\_init\_data(sock, sk); - po = pkt\_sk(sk); init\_completion(&po->skb\_completion); sk->sk\_family = PF\_PACKET; po->num = proto; po->xmit = dev\_queue\_xmit; - err = packet\_alloc\_pending(po);- if (err)- goto out2;- packet\_cached\_dev\_reset(po);  sk->sk\_destruct = packet\_sock\_destruct;@@ -3462,7 +3462,7 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, sock\_prot\_inuse\_add(net, &packet\_proto, 1);  return 0;-out2:+out\_sk\_free: sk\_free(sk); out: return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:13 +0000



=== Content from git.kernel.org_3de4d690_20250114_195635.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=46f2a11cb82b657fd15bab1c47821b635e03838b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=46f2a11cb82b657fd15bab1c47821b635e03838b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46f2a11cb82b657fd15bab1c47821b635e03838b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=46f2a11cb82b657fd15bab1c47821b635e03838b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-14 16:38:00 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-10-15 18:43:07 -0700 |
| commit | [46f2a11cb82b657fd15bab1c47821b635e03838b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46f2a11cb82b657fd15bab1c47821b635e03838b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=46f2a11cb82b657fd15bab1c47821b635e03838b)) | |
| tree | [c672257cfcad494edf338ce282f75958e35d672d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=46f2a11cb82b657fd15bab1c47821b635e03838b) | |
| parent | [397006ba5d918f9b74e734867e8fddbc36dc2282](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=397006ba5d918f9b74e734867e8fddbc36dc2282) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=46f2a11cb82b657fd15bab1c47821b635e03838b&id2=397006ba5d918f9b74e734867e8fddbc36dc2282)) | |
| download | [linux-46f2a11cb82b657fd15bab1c47821b635e03838b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-46f2a11cb82b657fd15bab1c47821b635e03838b.tar.gz) | |

af\_packet: avoid erroring out after sock\_init\_data() in packet\_create()After sock\_init\_data() the allocated sk object is attached to the provided
sock object. On error, packet\_create() frees the sk object leaving the
dangling pointer in the sock object on return. Some other code may try
to use this pointer and cause use-after-free.
Suggested-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241014153808.51894-2-ignat@cloudflare.com](https://patch.msgid.link/20241014153808.51894-2-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=46f2a11cb82b657fd15bab1c47821b635e03838b)

| -rw-r--r-- | [net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/packet/af_packet.c?id=46f2a11cb82b657fd15bab1c47821b635e03838b) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/net/packet/af\_packet.c b/net/packet/af\_packet.cindex 2ff4b251842d49..886c0dd47b6621 100644--- a/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=397006ba5d918f9b74e734867e8fddbc36dc2282)+++ b/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=46f2a11cb82b657fd15bab1c47821b635e03838b)@@ -3422,17 +3422,17 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, if (sock->type == SOCK\_PACKET) sock->ops = &packet\_ops\_spkt; + po = pkt\_sk(sk);+ err = packet\_alloc\_pending(po);+ if (err)+ goto out\_sk\_free;+ sock\_init\_data(sock, sk); - po = pkt\_sk(sk); init\_completion(&po->skb\_completion); sk->sk\_family = PF\_PACKET; po->num = proto; - err = packet\_alloc\_pending(po);- if (err)- goto out2;- packet\_cached\_dev\_reset(po);  sk->sk\_destruct = packet\_sock\_destruct;@@ -3464,7 +3464,7 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, sock\_prot\_inuse\_add(net, &packet\_proto, 1);  return 0;-out2:+out\_sk\_free: sk\_free(sk); out: return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:12 +0000



=== Content from git.kernel.org_ff8141c0_20250114_195634.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-14 16:38:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:37 +0100 |
| commit | [132e615bb1d7cdec2d3cfbdec2efa630e923fd21](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21)) | |
| tree | [7041e5293c8b27e0c1ae835b10fc43d5064eba5f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21) | |
| parent | [3cc92d542384058a49fb9b174341c9c4b9cd7e37](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3cc92d542384058a49fb9b174341c9c4b9cd7e37) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21&id2=3cc92d542384058a49fb9b174341c9c4b9cd7e37)) | |
| download | [linux-132e615bb1d7cdec2d3cfbdec2efa630e923fd21.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-132e615bb1d7cdec2d3cfbdec2efa630e923fd21.tar.gz) | |

af\_packet: avoid erroring out after sock\_init\_data() in packet\_create()[ Upstream commit 46f2a11cb82b657fd15bab1c47821b635e03838b ]
After sock\_init\_data() the allocated sk object is attached to the provided
sock object. On error, packet\_create() frees the sk object leaving the
dangling pointer in the sock object on return. Some other code may try
to use this pointer and cause use-after-free.
Suggested-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241014153808.51894-2-ignat@cloudflare.com](https://patch.msgid.link/20241014153808.51894-2-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21)

| -rw-r--r-- | [net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/packet/af_packet.c?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/net/packet/af\_packet.c b/net/packet/af\_packet.cindex d1ae1d9133d304..dd38cf0c9040d8 100644--- a/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=3cc92d542384058a49fb9b174341c9c4b9cd7e37)+++ b/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=132e615bb1d7cdec2d3cfbdec2efa630e923fd21)@@ -3384,18 +3384,18 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, if (sock->type == SOCK\_PACKET) sock->ops = &packet\_ops\_spkt; + po = pkt\_sk(sk);+ err = packet\_alloc\_pending(po);+ if (err)+ goto out\_sk\_free;+ sock\_init\_data(sock, sk); - po = pkt\_sk(sk); init\_completion(&po->skb\_completion); sk->sk\_family = PF\_PACKET; po->num = proto; po->xmit = dev\_queue\_xmit; - err = packet\_alloc\_pending(po);- if (err)- goto out2;- packet\_cached\_dev\_reset(po);  sk->sk\_destruct = packet\_sock\_destruct;@@ -3428,7 +3428,7 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, sock\_prot\_inuse\_add(net, &packet\_proto, 1);  return 0;-out2:+out\_sk\_free: sk\_free(sk); out: return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:11 +0000



=== Content from git.kernel.org_0b253556_20250114_195637.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fd09880b16d33aa5a7420578e01cd79148fa9829)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd09880b16d33aa5a7420578e01cd79148fa9829)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd09880b16d33aa5a7420578e01cd79148fa9829)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd09880b16d33aa5a7420578e01cd79148fa9829)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-14 16:38:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:47 +0100 |
| commit | [fd09880b16d33aa5a7420578e01cd79148fa9829](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd09880b16d33aa5a7420578e01cd79148fa9829) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fd09880b16d33aa5a7420578e01cd79148fa9829)) | |
| tree | [3770dca26c24ab6829d0a47f71473d91e7f462fe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd09880b16d33aa5a7420578e01cd79148fa9829) | |
| parent | [ef18243f8ecb2592af2f4eee91dc652b972fd078](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef18243f8ecb2592af2f4eee91dc652b972fd078) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd09880b16d33aa5a7420578e01cd79148fa9829&id2=ef18243f8ecb2592af2f4eee91dc652b972fd078)) | |
| download | [linux-fd09880b16d33aa5a7420578e01cd79148fa9829.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fd09880b16d33aa5a7420578e01cd79148fa9829.tar.gz) | |

af\_packet: avoid erroring out after sock\_init\_data() in packet\_create()[ Upstream commit 46f2a11cb82b657fd15bab1c47821b635e03838b ]
After sock\_init\_data() the allocated sk object is attached to the provided
sock object. On error, packet\_create() frees the sk object leaving the
dangling pointer in the sock object on return. Some other code may try
to use this pointer and cause use-after-free.
Suggested-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241014153808.51894-2-ignat@cloudflare.com](https://patch.msgid.link/20241014153808.51894-2-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd09880b16d33aa5a7420578e01cd79148fa9829)

| -rw-r--r-- | [net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/packet/af_packet.c?id=fd09880b16d33aa5a7420578e01cd79148fa9829) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/net/packet/af\_packet.c b/net/packet/af\_packet.cindex a705ec21425409..97774bd4b6cb11 100644--- a/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=ef18243f8ecb2592af2f4eee91dc652b972fd078)+++ b/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=fd09880b16d33aa5a7420578e01cd79148fa9829)@@ -3421,17 +3421,17 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, if (sock->type == SOCK\_PACKET) sock->ops = &packet\_ops\_spkt; + po = pkt\_sk(sk);+ err = packet\_alloc\_pending(po);+ if (err)+ goto out\_sk\_free;+ sock\_init\_data(sock, sk); - po = pkt\_sk(sk); init\_completion(&po->skb\_completion); sk->sk\_family = PF\_PACKET; po->num = proto; - err = packet\_alloc\_pending(po);- if (err)- goto out2;- packet\_cached\_dev\_reset(po);  sk->sk\_destruct = packet\_sock\_destruct;@@ -3463,7 +3463,7 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, sock\_prot\_inuse\_add(net, &packet\_proto, 1);  return 0;-out2:+out\_sk\_free: sk\_free(sk); out: return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:14 +0000



=== Content from git.kernel.org_8adbd7c8_20250114_195635.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1dc1e1db927056cb323296e2294a855cd003dfe7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1dc1e1db927056cb323296e2294a855cd003dfe7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1dc1e1db927056cb323296e2294a855cd003dfe7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1dc1e1db927056cb323296e2294a855cd003dfe7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2024-10-14 16:38:00 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:27 +0100 |
| commit | [1dc1e1db927056cb323296e2294a855cd003dfe7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1dc1e1db927056cb323296e2294a855cd003dfe7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1dc1e1db927056cb323296e2294a855cd003dfe7)) | |
| tree | [ee00534f496ec8bde6021f0149752f0578eca346](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1dc1e1db927056cb323296e2294a855cd003dfe7) | |
| parent | [50a90e5af4996d0613ff4c525fc3104031df6007](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50a90e5af4996d0613ff4c525fc3104031df6007) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1dc1e1db927056cb323296e2294a855cd003dfe7&id2=50a90e5af4996d0613ff4c525fc3104031df6007)) | |
| download | [linux-1dc1e1db927056cb323296e2294a855cd003dfe7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1dc1e1db927056cb323296e2294a855cd003dfe7.tar.gz) | |

af\_packet: avoid erroring out after sock\_init\_data() in packet\_create()[ Upstream commit 46f2a11cb82b657fd15bab1c47821b635e03838b ]
After sock\_init\_data() the allocated sk object is attached to the provided
sock object. On error, packet\_create() frees the sk object leaving the
dangling pointer in the sock object on return. Some other code may try
to use this pointer and cause use-after-free.
Suggested-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241014153808.51894-2-ignat@cloudflare.com](https://patch.msgid.link/20241014153808.51894-2-ignat%40cloudflare.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1dc1e1db927056cb323296e2294a855cd003dfe7)

| -rw-r--r-- | [net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/packet/af_packet.c?id=1dc1e1db927056cb323296e2294a855cd003dfe7) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/net/packet/af\_packet.c b/net/packet/af\_packet.cindex ce3e20bcde4ab5..01a191c8194b48 100644--- a/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=50a90e5af4996d0613ff4c525fc3104031df6007)+++ b/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/packet/af_packet.c?id=1dc1e1db927056cb323296e2294a855cd003dfe7)@@ -3386,18 +3386,18 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, if (sock->type == SOCK\_PACKET) sock->ops = &packet\_ops\_spkt; + po = pkt\_sk(sk);+ err = packet\_alloc\_pending(po);+ if (err)+ goto out\_sk\_free;+ sock\_init\_data(sock, sk); - po = pkt\_sk(sk); init\_completion(&po->skb\_completion); sk->sk\_family = PF\_PACKET; po->num = proto; po->xmit = dev\_queue\_xmit; - err = packet\_alloc\_pending(po);- if (err)- goto out2;- packet\_cached\_dev\_reset(po);  sk->sk\_destruct = packet\_sock\_destruct;@@ -3432,7 +3432,7 @@ static int packet\_create(struct net \*net, struct socket \*sock, int protocol, preempt\_enable();  return 0;-out2:+out\_sk\_free: sk\_free(sk); out: return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:12 +0000


