=== Content from git.kernel.org_151525b7_20250114_210256.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=da498e02c92e6d82df8001438dd583b90c570815)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da498e02c92e6d82df8001438dd583b90c570815)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da498e02c92e6d82df8001438dd583b90c570815)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da498e02c92e6d82df8001438dd583b90c570815)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:05 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:01 +0100 |
| commit | [da498e02c92e6d82df8001438dd583b90c570815](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da498e02c92e6d82df8001438dd583b90c570815) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=da498e02c92e6d82df8001438dd583b90c570815)) | |
| tree | [c9258343e7462ddaef1db8f2e149a336d8cc676d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da498e02c92e6d82df8001438dd583b90c570815) | |
| parent | [23230ac3c5ca3f154b64849d1cf50583b4e6b98c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da498e02c92e6d82df8001438dd583b90c570815&id2=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)) | |
| download | [linux-da498e02c92e6d82df8001438dd583b90c570815.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-da498e02c92e6d82df8001438dd583b90c570815.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for TMU device[ Upstream commit 9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 957ae5098185 ("platform/x86: Add Whiskey Cove PMIC TMU support")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Acked-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da498e02c92e6d82df8001438dd583b90c570815)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=da498e02c92e6d82df8001438dd583b90c570815) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/bxtwc_tmu.c?id=da498e02c92e6d82df8001438dd583b90c570815) | 22 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 30 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex d2c13ef4bf33f9..4c5a8ae7b67625 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=da498e02c92e6d82df8001438dd583b90c570815)@@ -246,12 +246,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = bcu\_resources, }, {- .name = "bxt\_wcove\_tmu",- .num\_resources = ARRAY\_SIZE(tmu\_resources),- .resources = tmu\_resources,- },-- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -261,6 +255,14 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = {+ {+ .name = "bxt\_wcove\_tmu",+ .num\_resources = ARRAY\_SIZE(tmu\_resources),+ .resources = tmu\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -485,6 +487,15 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add IRQ chip\n"); + ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_tmu\_dev, ARRAY\_SIZE(bxt\_wc\_tmu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_TMU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_tmu,+ &pmic->irq\_chip\_data\_tmu);+ if (ret)+ return ret;+ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_PWRBTN\_LVL1\_IRQ, IRQF\_ONESHOT,@@ -493,14 +504,6 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_TMU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_tmu,- &pmic->irq\_chip\_data\_tmu);- if (ret)- return dev\_err\_probe(dev, ret, "Failed to add TMU IRQ chip\n");- /\* Add chained IRQ handler for BCU IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_BCU\_LVL1\_IRQ,diff --git a/drivers/platform/x86/intel/bxtwc\_tmu.c b/drivers/platform/x86/intel/bxtwc\_tmu.cindex 7ccf583649e6be..3c9778366d9303 100644--- a/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)+++ b/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=da498e02c92e6d82df8001438dd583b90c570815)@@ -48,9 +48,8 @@ static irqreturn\_t bxt\_wcove\_tmu\_irq\_handler(int irq, void \*data) static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) { struct intel\_soc\_pmic \*pmic = dev\_get\_drvdata(pdev->dev.parent);- struct regmap\_irq\_chip\_data \*regmap\_irq\_chip; struct wcove\_tmu \*wctmu;- int ret, virq, irq;+ int ret;  wctmu = devm\_kzalloc(&pdev->dev, sizeof(\*wctmu), GFP\_KERNEL); if (!wctmu)@@ -59,27 +58,18 @@ static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) wctmu->dev = &pdev->dev; wctmu->regmap = pmic->regmap; - irq = platform\_get\_irq(pdev, 0);- if (irq < 0)- return irq;+ wctmu->irq = platform\_get\_irq(pdev, 0);+ if (wctmu->irq < 0)+ return wctmu->irq; - regmap\_irq\_chip = pmic->irq\_chip\_data\_tmu;- virq = regmap\_irq\_get\_virq(regmap\_irq\_chip, irq);- if (virq < 0) {- dev\_err(&pdev->dev,- "failed to get virtual interrupt=%d\n", irq);- return virq;- }-- ret = devm\_request\_threaded\_irq(&pdev->dev, virq,+ ret = devm\_request\_threaded\_irq(&pdev->dev, wctmu->irq, NULL, bxt\_wcove\_tmu\_irq\_handler, IRQF\_ONESHOT, "bxt\_wcove\_tmu", wctmu); if (ret) { dev\_err(&pdev->dev, "request irq failed: %d,virq: %d\n",- ret, virq);+ ret, wctmu->irq); return ret; }- wctmu->irq = virq;  /\* Unmask TMU second level Wake & System alarm \*/ regmap\_update\_bits(wctmu->regmap, BXTWC\_MTMUIRQ\_REG, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:01:33 +0000



=== Content from git.kernel.org_75af8e97_20250114_210253.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2310f5336f32eac9ada2d59b965d578efe25c4bf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2310f5336f32eac9ada2d59b965d578efe25c4bf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2310f5336f32eac9ada2d59b965d578efe25c4bf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2310f5336f32eac9ada2d59b965d578efe25c4bf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:05 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:31 +0100 |
| commit | [2310f5336f32eac9ada2d59b965d578efe25c4bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2310f5336f32eac9ada2d59b965d578efe25c4bf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2310f5336f32eac9ada2d59b965d578efe25c4bf)) | |
| tree | [4cfa3177d88200404ba86ab699556a9d9c97b458](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2310f5336f32eac9ada2d59b965d578efe25c4bf) | |
| parent | [518e414d24e7037d6cc7198e942bf47fe6f5e8e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2310f5336f32eac9ada2d59b965d578efe25c4bf&id2=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)) | |
| download | [linux-2310f5336f32eac9ada2d59b965d578efe25c4bf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2310f5336f32eac9ada2d59b965d578efe25c4bf.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for TMU device[ Upstream commit 9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 957ae5098185 ("platform/x86: Add Whiskey Cove PMIC TMU support")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Acked-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2310f5336f32eac9ada2d59b965d578efe25c4bf)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=2310f5336f32eac9ada2d59b965d578efe25c4bf) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/bxtwc_tmu.c?id=2310f5336f32eac9ada2d59b965d578efe25c4bf) | 22 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 30 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 5c35ccfc534ad7..f4d50e35b84891 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=2310f5336f32eac9ada2d59b965d578efe25c4bf)@@ -247,12 +247,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = bcu\_resources, }, {- .name = "bxt\_wcove\_tmu",- .num\_resources = ARRAY\_SIZE(tmu\_resources),- .resources = tmu\_resources,- },-- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -262,6 +256,14 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = {+ {+ .name = "bxt\_wcove\_tmu",+ .num\_resources = ARRAY\_SIZE(tmu\_resources),+ .resources = tmu\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -490,6 +492,15 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add IRQ chip\n"); + ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_tmu\_dev, ARRAY\_SIZE(bxt\_wc\_tmu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_TMU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_tmu,+ &pmic->irq\_chip\_data\_tmu);+ if (ret)+ return ret;+ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_PWRBTN\_LVL1\_IRQ, IRQF\_ONESHOT,@@ -498,14 +509,6 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_TMU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_tmu,- &pmic->irq\_chip\_data\_tmu);- if (ret)- return dev\_err\_probe(dev, ret, "Failed to add TMU IRQ chip\n");- /\* Add chained IRQ handler for BCU IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_BCU\_LVL1\_IRQ,diff --git a/drivers/platform/x86/intel/bxtwc\_tmu.c b/drivers/platform/x86/intel/bxtwc\_tmu.cindex d0e2a3c293b0b0..9ac801b929b93c 100644--- a/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)+++ b/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=2310f5336f32eac9ada2d59b965d578efe25c4bf)@@ -48,9 +48,8 @@ static irqreturn\_t bxt\_wcove\_tmu\_irq\_handler(int irq, void \*data) static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) { struct intel\_soc\_pmic \*pmic = dev\_get\_drvdata(pdev->dev.parent);- struct regmap\_irq\_chip\_data \*regmap\_irq\_chip; struct wcove\_tmu \*wctmu;- int ret, virq, irq;+ int ret;  wctmu = devm\_kzalloc(&pdev->dev, sizeof(\*wctmu), GFP\_KERNEL); if (!wctmu)@@ -59,27 +58,18 @@ static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) wctmu->dev = &pdev->dev; wctmu->regmap = pmic->regmap; - irq = platform\_get\_irq(pdev, 0);- if (irq < 0)- return irq;+ wctmu->irq = platform\_get\_irq(pdev, 0);+ if (wctmu->irq < 0)+ return wctmu->irq; - regmap\_irq\_chip = pmic->irq\_chip\_data\_tmu;- virq = regmap\_irq\_get\_virq(regmap\_irq\_chip, irq);- if (virq < 0) {- dev\_err(&pdev->dev,- "failed to get virtual interrupt=%d\n", irq);- return virq;- }-- ret = devm\_request\_threaded\_irq(&pdev->dev, virq,+ ret = devm\_request\_threaded\_irq(&pdev->dev, wctmu->irq, NULL, bxt\_wcove\_tmu\_irq\_handler, IRQF\_ONESHOT, "bxt\_wcove\_tmu", wctmu); if (ret) { dev\_err(&pdev->dev, "request irq failed: %d,virq: %d\n",- ret, virq);+ ret, wctmu->irq); return ret; }- wctmu->irq = virq;  /\* Unmask TMU second level Wake & System alarm \*/ regmap\_update\_bits(wctmu->regmap, BXTWC\_MTMUIRQ\_REG, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:01:30 +0000



=== Content from git.kernel.org_d2362cd1_20250114_210252.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:05 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:13 +0100 |
| commit | [1b734ad0e33648c3988c6a37c2ac16c2d63eda06](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06)) | |
| tree | [077fa1f78a8c1344c34d6baee56914c5c6c957d4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06) | |
| parent | [e1ef62e8d262e3f27446d26742208c1c81e9ee18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06&id2=e1ef62e8d262e3f27446d26742208c1c81e9ee18)) | |
| download | [linux-1b734ad0e33648c3988c6a37c2ac16c2d63eda06.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1b734ad0e33648c3988c6a37c2ac16c2d63eda06.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for TMU device[ Upstream commit 9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 957ae5098185 ("platform/x86: Add Whiskey Cove PMIC TMU support")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Acked-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/bxtwc_tmu.c?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06) | 22 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 30 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 6ea98321bbf203..5fc9d3aa614286 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06)@@ -247,12 +247,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = bcu\_resources, }, {- .name = "bxt\_wcove\_tmu",- .num\_resources = ARRAY\_SIZE(tmu\_resources),- .resources = tmu\_resources,- },-- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -262,6 +256,14 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = {+ {+ .name = "bxt\_wcove\_tmu",+ .num\_resources = ARRAY\_SIZE(tmu\_resources),+ .resources = tmu\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -490,6 +492,15 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add IRQ chip\n"); + ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_tmu\_dev, ARRAY\_SIZE(bxt\_wc\_tmu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_TMU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_tmu,+ &pmic->irq\_chip\_data\_tmu);+ if (ret)+ return ret;+ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_PWRBTN\_LVL1\_IRQ, IRQF\_ONESHOT,@@ -498,14 +509,6 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_TMU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_tmu,- &pmic->irq\_chip\_data\_tmu);- if (ret)- return dev\_err\_probe(dev, ret, "Failed to add TMU IRQ chip\n");- /\* Add chained IRQ handler for BCU IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_BCU\_LVL1\_IRQ,diff --git a/drivers/platform/x86/intel/bxtwc\_tmu.c b/drivers/platform/x86/intel/bxtwc\_tmu.cindex d0e2a3c293b0b0..9ac801b929b93c 100644--- a/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18)+++ b/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=1b734ad0e33648c3988c6a37c2ac16c2d63eda06)@@ -48,9 +48,8 @@ static irqreturn\_t bxt\_wcove\_tmu\_irq\_handler(int irq, void \*data) static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) { struct intel\_soc\_pmic \*pmic = dev\_get\_drvdata(pdev->dev.parent);- struct regmap\_irq\_chip\_data \*regmap\_irq\_chip; struct wcove\_tmu \*wctmu;- int ret, virq, irq;+ int ret;  wctmu = devm\_kzalloc(&pdev->dev, sizeof(\*wctmu), GFP\_KERNEL); if (!wctmu)@@ -59,27 +58,18 @@ static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) wctmu->dev = &pdev->dev; wctmu->regmap = pmic->regmap; - irq = platform\_get\_irq(pdev, 0);- if (irq < 0)- return irq;+ wctmu->irq = platform\_get\_irq(pdev, 0);+ if (wctmu->irq < 0)+ return wctmu->irq; - regmap\_irq\_chip = pmic->irq\_chip\_data\_tmu;- virq = regmap\_irq\_get\_virq(regmap\_irq\_chip, irq);- if (virq < 0) {- dev\_err(&pdev->dev,- "failed to get virtual interrupt=%d\n", irq);- return virq;- }-- ret = devm\_request\_threaded\_irq(&pdev->dev, virq,+ ret = devm\_request\_threaded\_irq(&pdev->dev, wctmu->irq, NULL, bxt\_wcove\_tmu\_irq\_handler, IRQF\_ONESHOT, "bxt\_wcove\_tmu", wctmu); if (ret) { dev\_err(&pdev->dev, "request irq failed: %d,virq: %d\n",- ret, virq);+ ret, wctmu->irq); return ret; }- wctmu->irq = virq;  /\* Unmask TMU second level Wake & System alarm \*/ regmap\_update\_bits(wctmu->regmap, BXTWC\_MTMUIRQ\_REG, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:01:29 +0000



=== Content from git.kernel.org_3d5ca1f6_20250114_210255.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b7c7c400de85d915e0da7c2c363553a801c47349)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7c7c400de85d915e0da7c2c363553a801c47349)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7c7c400de85d915e0da7c2c363553a801c47349)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7c7c400de85d915e0da7c2c363553a801c47349)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:05 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:29 +0100 |
| commit | [b7c7c400de85d915e0da7c2c363553a801c47349](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7c7c400de85d915e0da7c2c363553a801c47349) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b7c7c400de85d915e0da7c2c363553a801c47349)) | |
| tree | [363e343a2bf69cd9fe42623287eae66e535239f9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7c7c400de85d915e0da7c2c363553a801c47349) | |
| parent | [0997e77c51330c2866a4f39480e762cca92ad953](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0997e77c51330c2866a4f39480e762cca92ad953) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7c7c400de85d915e0da7c2c363553a801c47349&id2=0997e77c51330c2866a4f39480e762cca92ad953)) | |
| download | [linux-b7c7c400de85d915e0da7c2c363553a801c47349.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b7c7c400de85d915e0da7c2c363553a801c47349.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for TMU device[ Upstream commit 9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 957ae5098185 ("platform/x86: Add Whiskey Cove PMIC TMU support")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Acked-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7c7c400de85d915e0da7c2c363553a801c47349)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=b7c7c400de85d915e0da7c2c363553a801c47349) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/platform/x86/intel\_bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel_bxtwc_tmu.c?id=b7c7c400de85d915e0da7c2c363553a801c47349) | 22 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 30 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 9b5edc1b47d89d..ba441fd9c4ed43 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=0997e77c51330c2866a4f39480e762cca92ad953)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=b7c7c400de85d915e0da7c2c363553a801c47349)@@ -242,12 +242,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = bcu\_resources, }, {- .name = "bxt\_wcove\_tmu",- .num\_resources = ARRAY\_SIZE(tmu\_resources),- .resources = tmu\_resources,- },-- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -257,6 +251,14 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = {+ {+ .name = "bxt\_wcove\_tmu",+ .num\_resources = ARRAY\_SIZE(tmu\_resources),+ .resources = tmu\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -485,6 +487,15 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add IRQ chip\n"); + ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_tmu\_dev, ARRAY\_SIZE(bxt\_wc\_tmu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_TMU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_tmu,+ &pmic->irq\_chip\_data\_tmu);+ if (ret)+ return ret;+ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_PWRBTN\_LVL1\_IRQ, IRQF\_ONESHOT,@@ -493,14 +504,6 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_TMU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_tmu,- &pmic->irq\_chip\_data\_tmu);- if (ret)- return dev\_err\_probe(dev, ret, "Failed to add TMU IRQ chip\n");- /\* Add chained IRQ handler for BCU IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_BCU\_LVL1\_IRQ,diff --git a/drivers/platform/x86/intel\_bxtwc\_tmu.c b/drivers/platform/x86/intel\_bxtwc\_tmu.cindex 7ccf583649e6be..3c9778366d9303 100644--- a/[drivers/platform/x86/intel\_bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel_bxtwc_tmu.c?id=0997e77c51330c2866a4f39480e762cca92ad953)+++ b/[drivers/platform/x86/intel\_bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel_bxtwc_tmu.c?id=b7c7c400de85d915e0da7c2c363553a801c47349)@@ -48,9 +48,8 @@ static irqreturn\_t bxt\_wcove\_tmu\_irq\_handler(int irq, void \*data) static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) { struct intel\_soc\_pmic \*pmic = dev\_get\_drvdata(pdev->dev.parent);- struct regmap\_irq\_chip\_data \*regmap\_irq\_chip; struct wcove\_tmu \*wctmu;- int ret, virq, irq;+ int ret;  wctmu = devm\_kzalloc(&pdev->dev, sizeof(\*wctmu), GFP\_KERNEL); if (!wctmu)@@ -59,27 +58,18 @@ static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) wctmu->dev = &pdev->dev; wctmu->regmap = pmic->regmap; - irq = platform\_get\_irq(pdev, 0);- if (irq < 0)- return irq;+ wctmu->irq = platform\_get\_irq(pdev, 0);+ if (wctmu->irq < 0)+ return wctmu->irq; - regmap\_irq\_chip = pmic->irq\_chip\_data\_tmu;- virq = regmap\_irq\_get\_virq(regmap\_irq\_chip, irq);- if (virq < 0) {- dev\_err(&pdev->dev,- "failed to get virtual interrupt=%d\n", irq);- return virq;- }-- ret = devm\_request\_threaded\_irq(&pdev->dev, virq,+ ret = devm\_request\_threaded\_irq(&pdev->dev, wctmu->irq, NULL, bxt\_wcove\_tmu\_irq\_handler, IRQF\_ONESHOT, "bxt\_wcove\_tmu", wctmu); if (ret) { dev\_err(&pdev->dev, "request irq failed: %d,virq: %d\n",- ret, virq);+ ret, wctmu->irq); return ret; }- wctmu->irq = virq;  /\* Unmask TMU second level Wake & System alarm \*/ regmap\_update\_bits(wctmu->regmap, BXTWC\_MTMUIRQ\_REG, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:01:32 +0000



=== Content from git.kernel.org_d9cdf49e_20250114_210255.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c472b55cc0bc3df805db6a14f50a084884cf18ee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c472b55cc0bc3df805db6a14f50a084884cf18ee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c472b55cc0bc3df805db6a14f50a084884cf18ee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c472b55cc0bc3df805db6a14f50a084884cf18ee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:05 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:58 +0100 |
| commit | [c472b55cc0bc3df805db6a14f50a084884cf18ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c472b55cc0bc3df805db6a14f50a084884cf18ee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c472b55cc0bc3df805db6a14f50a084884cf18ee)) | |
| tree | [2eeac49a26e2eb377f2b4adc45ae8ad4e446522f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c472b55cc0bc3df805db6a14f50a084884cf18ee) | |
| parent | [0b648968bfa4f5c9c4983bca9f2de17626ed6fb6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c472b55cc0bc3df805db6a14f50a084884cf18ee&id2=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)) | |
| download | [linux-c472b55cc0bc3df805db6a14f50a084884cf18ee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c472b55cc0bc3df805db6a14f50a084884cf18ee.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for TMU device[ Upstream commit 9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 957ae5098185 ("platform/x86: Add Whiskey Cove PMIC TMU support")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Acked-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c472b55cc0bc3df805db6a14f50a084884cf18ee)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=c472b55cc0bc3df805db6a14f50a084884cf18ee) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/platform/x86/intel\_bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel_bxtwc_tmu.c?id=c472b55cc0bc3df805db6a14f50a084884cf18ee) | 22 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 30 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 82c71b475a7e06..8b55f839a946b0 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=c472b55cc0bc3df805db6a14f50a084884cf18ee)@@ -246,12 +246,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = bcu\_resources, }, {- .name = "bxt\_wcove\_tmu",- .num\_resources = ARRAY\_SIZE(tmu\_resources),- .resources = tmu\_resources,- },-- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -261,6 +255,14 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = {+ {+ .name = "bxt\_wcove\_tmu",+ .num\_resources = ARRAY\_SIZE(tmu\_resources),+ .resources = tmu\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -485,6 +487,15 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add IRQ chip\n"); + ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_tmu\_dev, ARRAY\_SIZE(bxt\_wc\_tmu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_TMU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_tmu,+ &pmic->irq\_chip\_data\_tmu);+ if (ret)+ return ret;+ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_PWRBTN\_LVL1\_IRQ, IRQF\_ONESHOT,@@ -493,14 +504,6 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_TMU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_tmu,- &pmic->irq\_chip\_data\_tmu);- if (ret)- return dev\_err\_probe(dev, ret, "Failed to add TMU IRQ chip\n");- /\* Add chained IRQ handler for BCU IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_BCU\_LVL1\_IRQ,diff --git a/drivers/platform/x86/intel\_bxtwc\_tmu.c b/drivers/platform/x86/intel\_bxtwc\_tmu.cindex 7ccf583649e6be..3c9778366d9303 100644--- a/[drivers/platform/x86/intel\_bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel_bxtwc_tmu.c?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)+++ b/[drivers/platform/x86/intel\_bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel_bxtwc_tmu.c?id=c472b55cc0bc3df805db6a14f50a084884cf18ee)@@ -48,9 +48,8 @@ static irqreturn\_t bxt\_wcove\_tmu\_irq\_handler(int irq, void \*data) static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) { struct intel\_soc\_pmic \*pmic = dev\_get\_drvdata(pdev->dev.parent);- struct regmap\_irq\_chip\_data \*regmap\_irq\_chip; struct wcove\_tmu \*wctmu;- int ret, virq, irq;+ int ret;  wctmu = devm\_kzalloc(&pdev->dev, sizeof(\*wctmu), GFP\_KERNEL); if (!wctmu)@@ -59,27 +58,18 @@ static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) wctmu->dev = &pdev->dev; wctmu->regmap = pmic->regmap; - irq = platform\_get\_irq(pdev, 0);- if (irq < 0)- return irq;+ wctmu->irq = platform\_get\_irq(pdev, 0);+ if (wctmu->irq < 0)+ return wctmu->irq; - regmap\_irq\_chip = pmic->irq\_chip\_data\_tmu;- virq = regmap\_irq\_get\_virq(regmap\_irq\_chip, irq);- if (virq < 0) {- dev\_err(&pdev->dev,- "failed to get virtual interrupt=%d\n", irq);- return virq;- }-- ret = devm\_request\_threaded\_irq(&pdev->dev, virq,+ ret = devm\_request\_threaded\_irq(&pdev->dev, wctmu->irq, NULL, bxt\_wcove\_tmu\_irq\_handler, IRQF\_ONESHOT, "bxt\_wcove\_tmu", wctmu); if (ret) { dev\_err(&pdev->dev, "request irq failed: %d,virq: %d\n",- ret, virq);+ ret, wctmu->irq); return ret; }- wctmu->irq = virq;  /\* Unmask TMU second level Wake & System alarm \*/ regmap\_update\_bits(wctmu->regmap, BXTWC\_MTMUIRQ\_REG, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:01:32 +0000



=== Content from git.kernel.org_d93c81ba_20250114_210254.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:05 +0300 |
| --- | --- | --- |
| committer | Lee Jones <lee@kernel.org> | 2024-10-16 09:04:11 +0100 |
| commit | [9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73)) | |
| tree | [8f8d95a139a0c120841b1a0b3be4011b88b54676](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73) | |
| parent | [686fb77712a4bc94b76a0c5ae74c60118b7a0d79](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73&id2=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)) | |
| download | [linux-9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for TMU deviceWhile design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 957ae5098185 ("platform/x86: Add Whiskey Cove PMIC TMU support")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Acked-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/bxtwc_tmu.c?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73) | 22 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 30 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex d72995a9e8207f..628108dcf5454f 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73)@@ -246,12 +246,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = bcu\_resources, }, {- .name = "bxt\_wcove\_tmu",- .num\_resources = ARRAY\_SIZE(tmu\_resources),- .resources = tmu\_resources,- },-- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -261,6 +255,14 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = {+ {+ .name = "bxt\_wcove\_tmu",+ .num\_resources = ARRAY\_SIZE(tmu\_resources),+ .resources = tmu\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -489,6 +491,15 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add IRQ chip\n"); + ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_tmu\_dev, ARRAY\_SIZE(bxt\_wc\_tmu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_TMU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_tmu,+ &pmic->irq\_chip\_data\_tmu);+ if (ret)+ return ret;+ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_PWRBTN\_LVL1\_IRQ, IRQF\_ONESHOT,@@ -497,14 +508,6 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_TMU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_tmu,- &pmic->irq\_chip\_data\_tmu);- if (ret)- return dev\_err\_probe(dev, ret, "Failed to add TMU IRQ chip\n");- /\* Add chained IRQ handler for BCU IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_BCU\_LVL1\_IRQ,diff --git a/drivers/platform/x86/intel/bxtwc\_tmu.c b/drivers/platform/x86/intel/bxtwc\_tmu.cindex d0e2a3c293b0b0..9ac801b929b93c 100644--- a/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)+++ b/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73)@@ -48,9 +48,8 @@ static irqreturn\_t bxt\_wcove\_tmu\_irq\_handler(int irq, void \*data) static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) { struct intel\_soc\_pmic \*pmic = dev\_get\_drvdata(pdev->dev.parent);- struct regmap\_irq\_chip\_data \*regmap\_irq\_chip; struct wcove\_tmu \*wctmu;- int ret, virq, irq;+ int ret;  wctmu = devm\_kzalloc(&pdev->dev, sizeof(\*wctmu), GFP\_KERNEL); if (!wctmu)@@ -59,27 +58,18 @@ static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) wctmu->dev = &pdev->dev; wctmu->regmap = pmic->regmap; - irq = platform\_get\_irq(pdev, 0);- if (irq < 0)- return irq;+ wctmu->irq = platform\_get\_irq(pdev, 0);+ if (wctmu->irq < 0)+ return wctmu->irq; - regmap\_irq\_chip = pmic->irq\_chip\_data\_tmu;- virq = regmap\_irq\_get\_virq(regmap\_irq\_chip, irq);- if (virq < 0) {- dev\_err(&pdev->dev,- "failed to get virtual interrupt=%d\n", irq);- return virq;- }-- ret = devm\_request\_threaded\_irq(&pdev->dev, virq,+ ret = devm\_request\_threaded\_irq(&pdev->dev, wctmu->irq, NULL, bxt\_wcove\_tmu\_irq\_handler, IRQF\_ONESHOT, "bxt\_wcove\_tmu", wctmu); if (ret) { dev\_err(&pdev->dev, "request irq failed: %d,virq: %d\n",- ret, virq);+ ret, wctmu->irq); return ret; }- wctmu->irq = virq;  /\* Unmask TMU second level Wake & System alarm \*/ regmap\_update\_bits(wctmu->regmap, BXTWC\_MTMUIRQ\_REG, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:01:31 +0000



=== Content from git.kernel.org_16756ff4_20250114_210253.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=56acf415772ee7e10e448b371f52b249aa2d0f7b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=56acf415772ee7e10e448b371f52b249aa2d0f7b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56acf415772ee7e10e448b371f52b249aa2d0f7b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=56acf415772ee7e10e448b371f52b249aa2d0f7b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:05 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:36 +0100 |
| commit | [56acf415772ee7e10e448b371f52b249aa2d0f7b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56acf415772ee7e10e448b371f52b249aa2d0f7b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=56acf415772ee7e10e448b371f52b249aa2d0f7b)) | |
| tree | [3c482b07d03e351c0f5c40ae7c6fe2c3217bc73a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=56acf415772ee7e10e448b371f52b249aa2d0f7b) | |
| parent | [c310e6916c0b297011d0fec03f168a6b24e9e984](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c310e6916c0b297011d0fec03f168a6b24e9e984) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=56acf415772ee7e10e448b371f52b249aa2d0f7b&id2=c310e6916c0b297011d0fec03f168a6b24e9e984)) | |
| download | [linux-56acf415772ee7e10e448b371f52b249aa2d0f7b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-56acf415772ee7e10e448b371f52b249aa2d0f7b.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for TMU device[ Upstream commit 9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 957ae5098185 ("platform/x86: Add Whiskey Cove PMIC TMU support")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Acked-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=56acf415772ee7e10e448b371f52b249aa2d0f7b)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=56acf415772ee7e10e448b371f52b249aa2d0f7b) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/bxtwc_tmu.c?id=56acf415772ee7e10e448b371f52b249aa2d0f7b) | 22 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 30 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 6ea98321bbf203..5fc9d3aa614286 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=c310e6916c0b297011d0fec03f168a6b24e9e984)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=56acf415772ee7e10e448b371f52b249aa2d0f7b)@@ -247,12 +247,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = bcu\_resources, }, {- .name = "bxt\_wcove\_tmu",- .num\_resources = ARRAY\_SIZE(tmu\_resources),- .resources = tmu\_resources,- },-- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -262,6 +256,14 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = {+ {+ .name = "bxt\_wcove\_tmu",+ .num\_resources = ARRAY\_SIZE(tmu\_resources),+ .resources = tmu\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -490,6 +492,15 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add IRQ chip\n"); + ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_tmu\_dev, ARRAY\_SIZE(bxt\_wc\_tmu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_TMU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_tmu,+ &pmic->irq\_chip\_data\_tmu);+ if (ret)+ return ret;+ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_PWRBTN\_LVL1\_IRQ, IRQF\_ONESHOT,@@ -498,14 +509,6 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_TMU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_tmu,- &pmic->irq\_chip\_data\_tmu);- if (ret)- return dev\_err\_probe(dev, ret, "Failed to add TMU IRQ chip\n");- /\* Add chained IRQ handler for BCU IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_BCU\_LVL1\_IRQ,diff --git a/drivers/platform/x86/intel/bxtwc\_tmu.c b/drivers/platform/x86/intel/bxtwc\_tmu.cindex 7ccf583649e6be..3c9778366d9303 100644--- a/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=c310e6916c0b297011d0fec03f168a6b24e9e984)+++ b/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=56acf415772ee7e10e448b371f52b249aa2d0f7b)@@ -48,9 +48,8 @@ static irqreturn\_t bxt\_wcove\_tmu\_irq\_handler(int irq, void \*data) static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) { struct intel\_soc\_pmic \*pmic = dev\_get\_drvdata(pdev->dev.parent);- struct regmap\_irq\_chip\_data \*regmap\_irq\_chip; struct wcove\_tmu \*wctmu;- int ret, virq, irq;+ int ret;  wctmu = devm\_kzalloc(&pdev->dev, sizeof(\*wctmu), GFP\_KERNEL); if (!wctmu)@@ -59,27 +58,18 @@ static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) wctmu->dev = &pdev->dev; wctmu->regmap = pmic->regmap; - irq = platform\_get\_irq(pdev, 0);- if (irq < 0)- return irq;+ wctmu->irq = platform\_get\_irq(pdev, 0);+ if (wctmu->irq < 0)+ return wctmu->irq; - regmap\_irq\_chip = pmic->irq\_chip\_data\_tmu;- virq = regmap\_irq\_get\_virq(regmap\_irq\_chip, irq);- if (virq < 0) {- dev\_err(&pdev->dev,- "failed to get virtual interrupt=%d\n", irq);- return virq;- }-- ret = devm\_request\_threaded\_irq(&pdev->dev, virq,+ ret = devm\_request\_threaded\_irq(&pdev->dev, wctmu->irq, NULL, bxt\_wcove\_tmu\_irq\_handler, IRQF\_ONESHOT, "bxt\_wcove\_tmu", wctmu); if (ret) { dev\_err(&pdev->dev, "request irq failed: %d,virq: %d\n",- ret, virq);+ ret, wctmu->irq); return ret; }- wctmu->irq = virq;  /\* Unmask TMU second level Wake & System alarm \*/ regmap\_update\_bits(wctmu->regmap, BXTWC\_MTMUIRQ\_REG, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:01:31 +0000



=== Content from git.kernel.org_84694bb9_20250114_210254.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:05 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:04 +0100 |
| commit | [5bc6d0da4a32fe34a9960de577e0b7de3454de0c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c)) | |
| tree | [7bd96c64e3915a3e2c59d1c43dac9021165911df](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c) | |
| parent | [87a07a5b0b296e489c606ca95ffc16c18821975b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87a07a5b0b296e489c606ca95ffc16c18821975b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c&id2=87a07a5b0b296e489c606ca95ffc16c18821975b)) | |
| download | [linux-5bc6d0da4a32fe34a9960de577e0b7de3454de0c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5bc6d0da4a32fe34a9960de577e0b7de3454de0c.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for TMU device[ Upstream commit 9b79d59e6b2b515eb9a22bc469ef7b8f0904fc73 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 957ae5098185 ("platform/x86: Add Whiskey Cove PMIC TMU support")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Acked-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Link: [https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-3-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/bxtwc_tmu.c?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c) | 22 | |  |  |  | | --- | --- | --- | |

2 files changed, 23 insertions, 30 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex d72995a9e8207f..628108dcf5454f 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=87a07a5b0b296e489c606ca95ffc16c18821975b)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c)@@ -246,12 +246,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = bcu\_resources, }, {- .name = "bxt\_wcove\_tmu",- .num\_resources = ARRAY\_SIZE(tmu\_resources),- .resources = tmu\_resources,- },-- { .name = "bxt\_wcove\_gpio", .num\_resources = ARRAY\_SIZE(gpio\_resources), .resources = gpio\_resources,@@ -261,6 +255,14 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static const struct mfd\_cell bxt\_wc\_tmu\_dev[] = {+ {+ .name = "bxt\_wcove\_tmu",+ .num\_resources = ARRAY\_SIZE(tmu\_resources),+ .resources = tmu\_resources,+ },+};+ static struct mfd\_cell bxt\_wc\_chgr\_dev[] = { { .name = "bxt\_wcove\_usbc",@@ -489,6 +491,15 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add IRQ chip\n"); + ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_tmu\_dev, ARRAY\_SIZE(bxt\_wc\_tmu\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_TMU\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_tmu,+ &pmic->irq\_chip\_data\_tmu);+ if (ret)+ return ret;+ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_PWRBTN\_LVL1\_IRQ, IRQF\_ONESHOT,@@ -497,14 +508,6 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add PWRBTN IRQ chip\n"); - ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_TMU\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_tmu,- &pmic->irq\_chip\_data\_tmu);- if (ret)- return dev\_err\_probe(dev, ret, "Failed to add TMU IRQ chip\n");- /\* Add chained IRQ handler for BCU IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data, BXTWC\_BCU\_LVL1\_IRQ,diff --git a/drivers/platform/x86/intel/bxtwc\_tmu.c b/drivers/platform/x86/intel/bxtwc\_tmu.cindex d0e2a3c293b0b0..9ac801b929b93c 100644--- a/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=87a07a5b0b296e489c606ca95ffc16c18821975b)+++ b/[drivers/platform/x86/intel/bxtwc\_tmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/bxtwc_tmu.c?id=5bc6d0da4a32fe34a9960de577e0b7de3454de0c)@@ -48,9 +48,8 @@ static irqreturn\_t bxt\_wcove\_tmu\_irq\_handler(int irq, void \*data) static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) { struct intel\_soc\_pmic \*pmic = dev\_get\_drvdata(pdev->dev.parent);- struct regmap\_irq\_chip\_data \*regmap\_irq\_chip; struct wcove\_tmu \*wctmu;- int ret, virq, irq;+ int ret;  wctmu = devm\_kzalloc(&pdev->dev, sizeof(\*wctmu), GFP\_KERNEL); if (!wctmu)@@ -59,27 +58,18 @@ static int bxt\_wcove\_tmu\_probe(struct platform\_device \*pdev) wctmu->dev = &pdev->dev; wctmu->regmap = pmic->regmap; - irq = platform\_get\_irq(pdev, 0);- if (irq < 0)- return irq;+ wctmu->irq = platform\_get\_irq(pdev, 0);+ if (wctmu->irq < 0)+ return wctmu->irq; - regmap\_irq\_chip = pmic->irq\_chip\_data\_tmu;- virq = regmap\_irq\_get\_virq(regmap\_irq\_chip, irq);- if (virq < 0) {- dev\_err(&pdev->dev,- "failed to get virtual interrupt=%d\n", irq);- return virq;- }-- ret = devm\_request\_threaded\_irq(&pdev->dev, virq,+ ret = devm\_request\_threaded\_irq(&pdev->dev, wctmu->irq, NULL, bxt\_wcove\_tmu\_irq\_handler, IRQF\_ONESHOT, "bxt\_wcove\_tmu", wctmu); if (ret) { dev\_err(&pdev->dev, "request irq failed: %d,virq: %d\n",- ret, virq);+ ret, wctmu->irq); return ret; }- wctmu->irq = virq;  /\* Unmask TMU second level Wake & System alarm \*/ regmap\_update\_bits(wctmu->regmap, BXTWC\_MTMUIRQ\_REG, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:01:31 +0000


