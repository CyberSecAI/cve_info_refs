=== Content from git.kernel.org_1504a6cf_20250114_225143.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Norbert van Bolhuis <nvbolhuis@gmail.com> | 2024-11-07 14:28:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:44 +0100 |
| commit | [67a25ea28f8ec1da8894f2f115d01d3becf67dc7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7)) | |
| tree | [e413692d54098cb1de98e7514762e1f2db3a9a3a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7) | |
| parent | [4adc692826344b6759fa53adfda6c19d9b660cdc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4adc692826344b6759fa53adfda6c19d9b660cdc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7&id2=4adc692826344b6759fa53adfda6c19d9b660cdc)) | |
| download | [linux-67a25ea28f8ec1da8894f2f115d01d3becf67dc7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-67a25ea28f8ec1da8894f2f115d01d3becf67dc7.tar.gz) | |

wifi: brcmfmac: Fix oops due to NULL pointer dereference in brcmf\_sdiod\_sglist\_rw()[ Upstream commit 857282b819cbaa0675aaab1e7542e2c0579f52d7 ]
This patch fixes a NULL pointer dereference bug in brcmfmac that occurs
when a high 'sd\_sgentry\_align' value applies (e.g. 512) and a lot of queued SKBs
are sent from the pkt queue.
The problem is the number of entries in the pre-allocated sgtable, it is
nents = max(rxglom\_size, txglom\_size) + max(rxglom\_size, txglom\_size) >> 4 + 1.
Given the default [rt]xglom\_size=32 it's actually 35 which is too small.
Worst case, the pkt queue can end up with 64 SKBs. This occurs when a new SKB
is added for each original SKB if tailroom isn't enough to hold tail\_pad.
At least one sg entry is needed for each SKB. So, eventually the "skb\_queue\_walk loop"
in brcmf\_sdiod\_sglist\_rw may run out of sg entries. This makes sg\_next return
NULL and this causes the oops.
The patch sets nents to max(rxglom\_size, txglom\_size) \* 2 to be able handle
the worst-case.
Btw. this requires only 64-35=29 \* 16 (or 20 if CONFIG\_NEED\_SG\_DMA\_LENGTH) = 464
additional bytes of memory.
Signed-off-by: Norbert van Bolhuis <nvbolhuis@gmail.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241107132903.13513-1-nvbolhuis@gmail.com](https://patch.msgid.link/20241107132903.13513-1-nvbolhuis%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7)

| -rw-r--r-- | [drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.cindex e300278ea38c66..9217e9f6e90765 100644--- a/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=4adc692826344b6759fa53adfda6c19d9b660cdc)+++ b/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=67a25ea28f8ec1da8894f2f115d01d3becf67dc7)@@ -770,7 +770,7 @@ void brcmf\_sdiod\_sgtable\_alloc(struct brcmf\_sdio\_dev \*sdiodev)  nents = max\_t(uint, BRCMF\_DEFAULT\_RXGLOM\_SIZE, sdiodev->settings->bus.sdio.txglomsz);- nents += (nents >> 4) + 1;+ nents \*= 2;  WARN\_ON(nents > sdiodev->max\_segment\_count); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:50:20 +0000



=== Content from git.kernel.org_79994ab0_20250114_225146.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Norbert van Bolhuis <nvbolhuis@gmail.com> | 2024-11-07 14:28:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:39 +0100 |
| commit | [dfb3f9d3f602602de208da7bdcc0f6d5ee74af68](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68)) | |
| tree | [5f2bd3c54e67247a3f708a42e1fad758bca4746b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68) | |
| parent | [0824dcc63580e16d53df0107cf53c3b5f8f6b00d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0824dcc63580e16d53df0107cf53c3b5f8f6b00d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68&id2=0824dcc63580e16d53df0107cf53c3b5f8f6b00d)) | |
| download | [linux-dfb3f9d3f602602de208da7bdcc0f6d5ee74af68.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dfb3f9d3f602602de208da7bdcc0f6d5ee74af68.tar.gz) | |

wifi: brcmfmac: Fix oops due to NULL pointer dereference in brcmf\_sdiod\_sglist\_rw()[ Upstream commit 857282b819cbaa0675aaab1e7542e2c0579f52d7 ]
This patch fixes a NULL pointer dereference bug in brcmfmac that occurs
when a high 'sd\_sgentry\_align' value applies (e.g. 512) and a lot of queued SKBs
are sent from the pkt queue.
The problem is the number of entries in the pre-allocated sgtable, it is
nents = max(rxglom\_size, txglom\_size) + max(rxglom\_size, txglom\_size) >> 4 + 1.
Given the default [rt]xglom\_size=32 it's actually 35 which is too small.
Worst case, the pkt queue can end up with 64 SKBs. This occurs when a new SKB
is added for each original SKB if tailroom isn't enough to hold tail\_pad.
At least one sg entry is needed for each SKB. So, eventually the "skb\_queue\_walk loop"
in brcmf\_sdiod\_sglist\_rw may run out of sg entries. This makes sg\_next return
NULL and this causes the oops.
The patch sets nents to max(rxglom\_size, txglom\_size) \* 2 to be able handle
the worst-case.
Btw. this requires only 64-35=29 \* 16 (or 20 if CONFIG\_NEED\_SG\_DMA\_LENGTH) = 464
additional bytes of memory.
Signed-off-by: Norbert van Bolhuis <nvbolhuis@gmail.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241107132903.13513-1-nvbolhuis@gmail.com](https://patch.msgid.link/20241107132903.13513-1-nvbolhuis%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68)

| -rw-r--r-- | [drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.cindex ac02244a6fdf11..16c46845566efd 100644--- a/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=0824dcc63580e16d53df0107cf53c3b5f8f6b00d)+++ b/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=dfb3f9d3f602602de208da7bdcc0f6d5ee74af68)@@ -770,7 +770,7 @@ void brcmf\_sdiod\_sgtable\_alloc(struct brcmf\_sdio\_dev \*sdiodev)  nents = max\_t(uint, BRCMF\_DEFAULT\_RXGLOM\_SIZE, sdiodev->settings->bus.sdio.txglomsz);- nents += (nents >> 4) + 1;+ nents \*= 2;  WARN\_ON(nents > sdiodev->max\_segment\_count); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:50:23 +0000



=== Content from git.kernel.org_6d5d6b63_20250114_225144.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7522d7d745d13fbeff3350fe6aa56c8dae263571)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7522d7d745d13fbeff3350fe6aa56c8dae263571)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7522d7d745d13fbeff3350fe6aa56c8dae263571)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7522d7d745d13fbeff3350fe6aa56c8dae263571)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Norbert van Bolhuis <nvbolhuis@gmail.com> | 2024-11-07 14:28:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:29 +0100 |
| commit | [7522d7d745d13fbeff3350fe6aa56c8dae263571](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7522d7d745d13fbeff3350fe6aa56c8dae263571) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7522d7d745d13fbeff3350fe6aa56c8dae263571)) | |
| tree | [cc3e127c1d29a90f4d6dc010062a34b2651d8408](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7522d7d745d13fbeff3350fe6aa56c8dae263571) | |
| parent | [856b24b5d92c6bb0b9060e1938f73ec9e61c71fd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=856b24b5d92c6bb0b9060e1938f73ec9e61c71fd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7522d7d745d13fbeff3350fe6aa56c8dae263571&id2=856b24b5d92c6bb0b9060e1938f73ec9e61c71fd)) | |
| download | [linux-7522d7d745d13fbeff3350fe6aa56c8dae263571.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7522d7d745d13fbeff3350fe6aa56c8dae263571.tar.gz) | |

wifi: brcmfmac: Fix oops due to NULL pointer dereference in brcmf\_sdiod\_sglist\_rw()[ Upstream commit 857282b819cbaa0675aaab1e7542e2c0579f52d7 ]
This patch fixes a NULL pointer dereference bug in brcmfmac that occurs
when a high 'sd\_sgentry\_align' value applies (e.g. 512) and a lot of queued SKBs
are sent from the pkt queue.
The problem is the number of entries in the pre-allocated sgtable, it is
nents = max(rxglom\_size, txglom\_size) + max(rxglom\_size, txglom\_size) >> 4 + 1.
Given the default [rt]xglom\_size=32 it's actually 35 which is too small.
Worst case, the pkt queue can end up with 64 SKBs. This occurs when a new SKB
is added for each original SKB if tailroom isn't enough to hold tail\_pad.
At least one sg entry is needed for each SKB. So, eventually the "skb\_queue\_walk loop"
in brcmf\_sdiod\_sglist\_rw may run out of sg entries. This makes sg\_next return
NULL and this causes the oops.
The patch sets nents to max(rxglom\_size, txglom\_size) \* 2 to be able handle
the worst-case.
Btw. this requires only 64-35=29 \* 16 (or 20 if CONFIG\_NEED\_SG\_DMA\_LENGTH) = 464
additional bytes of memory.
Signed-off-by: Norbert van Bolhuis <nvbolhuis@gmail.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241107132903.13513-1-nvbolhuis@gmail.com](https://patch.msgid.link/20241107132903.13513-1-nvbolhuis%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7522d7d745d13fbeff3350fe6aa56c8dae263571)

| -rw-r--r-- | [drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=7522d7d745d13fbeff3350fe6aa56c8dae263571) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.cindex b6d0bc73923fcf..75dc7904a4bd69 100644--- a/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=856b24b5d92c6bb0b9060e1938f73ec9e61c71fd)+++ b/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=7522d7d745d13fbeff3350fe6aa56c8dae263571)@@ -769,7 +769,7 @@ void brcmf\_sdiod\_sgtable\_alloc(struct brcmf\_sdio\_dev \*sdiodev)  nents = max\_t(uint, BRCMF\_DEFAULT\_RXGLOM\_SIZE, sdiodev->settings->bus.sdio.txglomsz);- nents += (nents >> 4) + 1;+ nents \*= 2;  WARN\_ON(nents > sdiodev->max\_segment\_count); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:50:21 +0000



=== Content from git.kernel.org_da7f297d_20250114_225141.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Norbert van Bolhuis <nvbolhuis@gmail.com> | 2024-11-07 14:28:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:00:08 +0100 |
| commit | [07c020c6d14d29e5a3ea4e4576b8ecf956a80834](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834)) | |
| tree | [66172022fee8d9b3a295d7571f66457a402c3fb6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834) | |
| parent | [3afd475d5af927eb7e99e4499e4bca5872488323](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3afd475d5af927eb7e99e4499e4bca5872488323) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834&id2=3afd475d5af927eb7e99e4499e4bca5872488323)) | |
| download | [linux-07c020c6d14d29e5a3ea4e4576b8ecf956a80834.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-07c020c6d14d29e5a3ea4e4576b8ecf956a80834.tar.gz) | |

wifi: brcmfmac: Fix oops due to NULL pointer dereference in brcmf\_sdiod\_sglist\_rw()[ Upstream commit 857282b819cbaa0675aaab1e7542e2c0579f52d7 ]
This patch fixes a NULL pointer dereference bug in brcmfmac that occurs
when a high 'sd\_sgentry\_align' value applies (e.g. 512) and a lot of queued SKBs
are sent from the pkt queue.
The problem is the number of entries in the pre-allocated sgtable, it is
nents = max(rxglom\_size, txglom\_size) + max(rxglom\_size, txglom\_size) >> 4 + 1.
Given the default [rt]xglom\_size=32 it's actually 35 which is too small.
Worst case, the pkt queue can end up with 64 SKBs. This occurs when a new SKB
is added for each original SKB if tailroom isn't enough to hold tail\_pad.
At least one sg entry is needed for each SKB. So, eventually the "skb\_queue\_walk loop"
in brcmf\_sdiod\_sglist\_rw may run out of sg entries. This makes sg\_next return
NULL and this causes the oops.
The patch sets nents to max(rxglom\_size, txglom\_size) \* 2 to be able handle
the worst-case.
Btw. this requires only 64-35=29 \* 16 (or 20 if CONFIG\_NEED\_SG\_DMA\_LENGTH) = 464
additional bytes of memory.
Signed-off-by: Norbert van Bolhuis <nvbolhuis@gmail.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241107132903.13513-1-nvbolhuis@gmail.com](https://patch.msgid.link/20241107132903.13513-1-nvbolhuis%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834)

| -rw-r--r-- | [drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.cindex 00679a990e3dac..7710367c319ec8 100644--- a/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=3afd475d5af927eb7e99e4499e4bca5872488323)+++ b/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=07c020c6d14d29e5a3ea4e4576b8ecf956a80834)@@ -770,7 +770,7 @@ void brcmf\_sdiod\_sgtable\_alloc(struct brcmf\_sdio\_dev \*sdiodev)  nents = max\_t(uint, BRCMF\_DEFAULT\_RXGLOM\_SIZE, sdiodev->settings->bus.sdio.txglomsz);- nents += (nents >> 4) + 1;+ nents \*= 2;  WARN\_ON(nents > sdiodev->max\_segment\_count); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:50:18 +0000



=== Content from git.kernel.org_22427a52_20250114_225142.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=34941321b516bd7c6103bd01287d71a1804d19d3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=34941321b516bd7c6103bd01287d71a1804d19d3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=34941321b516bd7c6103bd01287d71a1804d19d3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=34941321b516bd7c6103bd01287d71a1804d19d3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Norbert van Bolhuis <nvbolhuis@gmail.com> | 2024-11-07 14:28:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:54 +0100 |
| commit | [34941321b516bd7c6103bd01287d71a1804d19d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=34941321b516bd7c6103bd01287d71a1804d19d3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=34941321b516bd7c6103bd01287d71a1804d19d3)) | |
| tree | [886947f2a5daea4dd6a79df69a0c20a28568f976](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=34941321b516bd7c6103bd01287d71a1804d19d3) | |
| parent | [d82d48ab0c8cb5b9aafac65ee3c0c8530ba6c64f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d82d48ab0c8cb5b9aafac65ee3c0c8530ba6c64f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=34941321b516bd7c6103bd01287d71a1804d19d3&id2=d82d48ab0c8cb5b9aafac65ee3c0c8530ba6c64f)) | |
| download | [linux-34941321b516bd7c6103bd01287d71a1804d19d3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-34941321b516bd7c6103bd01287d71a1804d19d3.tar.gz) | |

wifi: brcmfmac: Fix oops due to NULL pointer dereference in brcmf\_sdiod\_sglist\_rw()[ Upstream commit 857282b819cbaa0675aaab1e7542e2c0579f52d7 ]
This patch fixes a NULL pointer dereference bug in brcmfmac that occurs
when a high 'sd\_sgentry\_align' value applies (e.g. 512) and a lot of queued SKBs
are sent from the pkt queue.
The problem is the number of entries in the pre-allocated sgtable, it is
nents = max(rxglom\_size, txglom\_size) + max(rxglom\_size, txglom\_size) >> 4 + 1.
Given the default [rt]xglom\_size=32 it's actually 35 which is too small.
Worst case, the pkt queue can end up with 64 SKBs. This occurs when a new SKB
is added for each original SKB if tailroom isn't enough to hold tail\_pad.
At least one sg entry is needed for each SKB. So, eventually the "skb\_queue\_walk loop"
in brcmf\_sdiod\_sglist\_rw may run out of sg entries. This makes sg\_next return
NULL and this causes the oops.
The patch sets nents to max(rxglom\_size, txglom\_size) \* 2 to be able handle
the worst-case.
Btw. this requires only 64-35=29 \* 16 (or 20 if CONFIG\_NEED\_SG\_DMA\_LENGTH) = 464
additional bytes of memory.
Signed-off-by: Norbert van Bolhuis <nvbolhuis@gmail.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241107132903.13513-1-nvbolhuis@gmail.com](https://patch.msgid.link/20241107132903.13513-1-nvbolhuis%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=34941321b516bd7c6103bd01287d71a1804d19d3)

| -rw-r--r-- | [drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=34941321b516bd7c6103bd01287d71a1804d19d3) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.cindex d35262335eaf79..8a1e3376424487 100644--- a/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=d82d48ab0c8cb5b9aafac65ee3c0c8530ba6c64f)+++ b/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=34941321b516bd7c6103bd01287d71a1804d19d3)@@ -770,7 +770,7 @@ void brcmf\_sdiod\_sgtable\_alloc(struct brcmf\_sdio\_dev \*sdiodev)  nents = max\_t(uint, BRCMF\_DEFAULT\_RXGLOM\_SIZE, sdiodev->settings->bus.sdio.txglomsz);- nents += (nents >> 4) + 1;+ nents \*= 2;  WARN\_ON(nents > sdiodev->max\_segment\_count); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:50:19 +0000



=== Content from git.kernel.org_2199ec00_20250114_225145.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=857282b819cbaa0675aaab1e7542e2c0579f52d7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=857282b819cbaa0675aaab1e7542e2c0579f52d7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=857282b819cbaa0675aaab1e7542e2c0579f52d7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=857282b819cbaa0675aaab1e7542e2c0579f52d7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Norbert van Bolhuis <nvbolhuis@gmail.com> | 2024-11-07 14:28:13 +0100 |
| --- | --- | --- |
| committer | Kalle Valo <kvalo@kernel.org> | 2024-11-11 14:11:17 +0200 |
| commit | [857282b819cbaa0675aaab1e7542e2c0579f52d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=857282b819cbaa0675aaab1e7542e2c0579f52d7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=857282b819cbaa0675aaab1e7542e2c0579f52d7)) | |
| tree | [dfd7d2f25f671d027c77c9a84a66d39236929936](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=857282b819cbaa0675aaab1e7542e2c0579f52d7) | |
| parent | [b41f96ecb9b7b36c101bf3c9c3eba017cec2a307](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b41f96ecb9b7b36c101bf3c9c3eba017cec2a307) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=857282b819cbaa0675aaab1e7542e2c0579f52d7&id2=b41f96ecb9b7b36c101bf3c9c3eba017cec2a307)) | |
| download | [linux-857282b819cbaa0675aaab1e7542e2c0579f52d7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-857282b819cbaa0675aaab1e7542e2c0579f52d7.tar.gz) | |

wifi: brcmfmac: Fix oops due to NULL pointer dereference in brcmf\_sdiod\_sglist\_rw()This patch fixes a NULL pointer dereference bug in brcmfmac that occurs
when a high 'sd\_sgentry\_align' value applies (e.g. 512) and a lot of queued SKBs
are sent from the pkt queue.
The problem is the number of entries in the pre-allocated sgtable, it is
nents = max(rxglom\_size, txglom\_size) + max(rxglom\_size, txglom\_size) >> 4 + 1.
Given the default [rt]xglom\_size=32 it's actually 35 which is too small.
Worst case, the pkt queue can end up with 64 SKBs. This occurs when a new SKB
is added for each original SKB if tailroom isn't enough to hold tail\_pad.
At least one sg entry is needed for each SKB. So, eventually the "skb\_queue\_walk loop"
in brcmf\_sdiod\_sglist\_rw may run out of sg entries. This makes sg\_next return
NULL and this causes the oops.
The patch sets nents to max(rxglom\_size, txglom\_size) \* 2 to be able handle
the worst-case.
Btw. this requires only 64-35=29 \* 16 (or 20 if CONFIG\_NEED\_SG\_DMA\_LENGTH) = 464
additional bytes of memory.
Signed-off-by: Norbert van Bolhuis <nvbolhuis@gmail.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241107132903.13513-1-nvbolhuis@gmail.com](https://patch.msgid.link/20241107132903.13513-1-nvbolhuis%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=857282b819cbaa0675aaab1e7542e2c0579f52d7)

| -rw-r--r-- | [drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=857282b819cbaa0675aaab1e7542e2c0579f52d7) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.cindex 17f6b33beabd87..42d991d9f8cb48 100644--- a/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=b41f96ecb9b7b36c101bf3c9c3eba017cec2a307)+++ b/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=857282b819cbaa0675aaab1e7542e2c0579f52d7)@@ -770,7 +770,7 @@ void brcmf\_sdiod\_sgtable\_alloc(struct brcmf\_sdio\_dev \*sdiodev)  nents = max\_t(uint, BRCMF\_DEFAULT\_RXGLOM\_SIZE, sdiodev->settings->bus.sdio.txglomsz);- nents += (nents >> 4) + 1;+ nents \*= 2;  WARN\_ON(nents > sdiodev->max\_segment\_count); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:50:22 +0000



=== Content from git.kernel.org_68b2dd8f_20250114_225142.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=342f87d263462c2670b77ea9a32074cab2ac6fa1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=342f87d263462c2670b77ea9a32074cab2ac6fa1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=342f87d263462c2670b77ea9a32074cab2ac6fa1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=342f87d263462c2670b77ea9a32074cab2ac6fa1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Norbert van Bolhuis <nvbolhuis@gmail.com> | 2024-11-07 14:28:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:52 +0100 |
| commit | [342f87d263462c2670b77ea9a32074cab2ac6fa1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=342f87d263462c2670b77ea9a32074cab2ac6fa1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=342f87d263462c2670b77ea9a32074cab2ac6fa1)) | |
| tree | [ce772dcae2c7c27de24c425a07e9c9cc37f9901e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=342f87d263462c2670b77ea9a32074cab2ac6fa1) | |
| parent | [d336bf86802e770c9124dd0398c0a4284d5501d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d336bf86802e770c9124dd0398c0a4284d5501d6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=342f87d263462c2670b77ea9a32074cab2ac6fa1&id2=d336bf86802e770c9124dd0398c0a4284d5501d6)) | |
| download | [linux-342f87d263462c2670b77ea9a32074cab2ac6fa1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-342f87d263462c2670b77ea9a32074cab2ac6fa1.tar.gz) | |

wifi: brcmfmac: Fix oops due to NULL pointer dereference in brcmf\_sdiod\_sglist\_rw()[ Upstream commit 857282b819cbaa0675aaab1e7542e2c0579f52d7 ]
This patch fixes a NULL pointer dereference bug in brcmfmac that occurs
when a high 'sd\_sgentry\_align' value applies (e.g. 512) and a lot of queued SKBs
are sent from the pkt queue.
The problem is the number of entries in the pre-allocated sgtable, it is
nents = max(rxglom\_size, txglom\_size) + max(rxglom\_size, txglom\_size) >> 4 + 1.
Given the default [rt]xglom\_size=32 it's actually 35 which is too small.
Worst case, the pkt queue can end up with 64 SKBs. This occurs when a new SKB
is added for each original SKB if tailroom isn't enough to hold tail\_pad.
At least one sg entry is needed for each SKB. So, eventually the "skb\_queue\_walk loop"
in brcmf\_sdiod\_sglist\_rw may run out of sg entries. This makes sg\_next return
NULL and this causes the oops.
The patch sets nents to max(rxglom\_size, txglom\_size) \* 2 to be able handle
the worst-case.
Btw. this requires only 64-35=29 \* 16 (or 20 if CONFIG\_NEED\_SG\_DMA\_LENGTH) = 464
additional bytes of memory.
Signed-off-by: Norbert van Bolhuis <nvbolhuis@gmail.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241107132903.13513-1-nvbolhuis@gmail.com](https://patch.msgid.link/20241107132903.13513-1-nvbolhuis%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=342f87d263462c2670b77ea9a32074cab2ac6fa1)

| -rw-r--r-- | [drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=342f87d263462c2670b77ea9a32074cab2ac6fa1) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.cindex c492d2d2db1dfe..32ac1fa5bdecf5 100644--- a/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=d336bf86802e770c9124dd0398c0a4284d5501d6)+++ b/[drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcmsdh.c?id=342f87d263462c2670b77ea9a32074cab2ac6fa1)@@ -770,7 +770,7 @@ void brcmf\_sdiod\_sgtable\_alloc(struct brcmf\_sdio\_dev \*sdiodev)  nents = max\_t(uint, BRCMF\_DEFAULT\_RXGLOM\_SIZE, sdiodev->settings->bus.sdio.txglomsz);- nents += (nents >> 4) + 1;+ nents \*= 2;  WARN\_ON(nents > sdiodev->max\_segment\_count); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:50:19 +0000


