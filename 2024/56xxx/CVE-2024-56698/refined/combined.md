=== Content from git.kernel.org_c7aa9d28_20250114_224119.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thinh Nguyen <Thinh.Nguyen@synopsys.com> | 2024-11-14 01:02:18 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:12 +0100 |
| commit | [8ceb21d76426bbe7072cc3e43281e70c0d664cc7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7)) | |
| tree | [5403bb931662225c3b7bd1984b9f4260eed356bc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7) | |
| parent | [a98340265f2885043770701d73020af28dc85568](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a98340265f2885043770701d73020af28dc85568) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7&id2=a98340265f2885043770701d73020af28dc85568)) | |
| download | [linux-8ceb21d76426bbe7072cc3e43281e70c0d664cc7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8ceb21d76426bbe7072cc3e43281e70c0d664cc7.tar.gz) | |

usb: dwc3: gadget: Fix looping of queued SG entriescommit b7fc65f5141c24785dc8c19249ca4efcf71b3524 upstream.
The dwc3\_request->num\_queued\_sgs is decremented on completion. If a
partially completed request is handled, then the
dwc3\_request->num\_queued\_sgs no longer reflects the total number of
num\_queued\_sgs (it would be cleared).
Correctly check the number of request SG entries remained to be prepare
and queued. Failure to do this may cause null pointer dereference when
accessing non-existent SG entry.
Cc: stable@vger.kernel.org
Fixes: c96e6725db9d ("usb: dwc3: gadget: Correct the logic for queuing sgs")
Signed-off-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Link: [https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen@synopsys.com](https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen%40synopsys.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex 7dc6b9c95fcaf9..2665c7d27f19bc 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=a98340265f2885043770701d73020af28dc85568)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=8ceb21d76426bbe7072cc3e43281e70c0d664cc7)@@ -1188,8 +1188,8 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, struct scatterlist \*s; int i; unsigned int length = req->request.length;- unsigned int remaining = req->request.num\_mapped\_sgs- - req->num\_queued\_sgs;+ unsigned int remaining = req->num\_pending\_sgs;+ unsigned int num\_queued\_sgs = req->request.num\_mapped\_sgs - remaining; unsigned int num\_trbs = req->num\_trbs; bool needs\_extra\_trb = dwc3\_needs\_extra\_trb(dep, req); @@ -1197,7 +1197,7 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, \* If we resume preparing the request, then get the remaining length of \* the request and resume where we left off. \*/- for\_each\_sg(req->request.sg, s, req->num\_queued\_sgs, i)+ for\_each\_sg(req->request.sg, s, num\_queued\_sgs, i) length -= sg\_dma\_len(s);  for\_each\_sg(sg, s, remaining, i) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:39:56 +0000



=== Content from git.kernel.org_8b724389_20250114_224120.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thinh Nguyen <Thinh.Nguyen@synopsys.com> | 2024-11-14 01:02:18 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:25 +0100 |
| commit | [b7c3d0b59213ebeedff63d128728ce0b3d7a51ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec)) | |
| tree | [7669da9c48649d7a08634d074618a1bc6f1d78b5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec) | |
| parent | [fb3c0449e1a63268246bde611a3d6541fccef743](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb3c0449e1a63268246bde611a3d6541fccef743) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec&id2=fb3c0449e1a63268246bde611a3d6541fccef743)) | |
| download | [linux-b7c3d0b59213ebeedff63d128728ce0b3d7a51ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b7c3d0b59213ebeedff63d128728ce0b3d7a51ec.tar.gz) | |

usb: dwc3: gadget: Fix looping of queued SG entriescommit b7fc65f5141c24785dc8c19249ca4efcf71b3524 upstream.
The dwc3\_request->num\_queued\_sgs is decremented on completion. If a
partially completed request is handled, then the
dwc3\_request->num\_queued\_sgs no longer reflects the total number of
num\_queued\_sgs (it would be cleared).
Correctly check the number of request SG entries remained to be prepare
and queued. Failure to do this may cause null pointer dereference when
accessing non-existent SG entry.
Cc: stable@vger.kernel.org
Fixes: c96e6725db9d ("usb: dwc3: gadget: Correct the logic for queuing sgs")
Signed-off-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Link: [https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen@synopsys.com](https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen%40synopsys.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex 881072cc3992bc..271f9dc9c03574 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=fb3c0449e1a63268246bde611a3d6541fccef743)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=b7c3d0b59213ebeedff63d128728ce0b3d7a51ec)@@ -1417,8 +1417,8 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, struct scatterlist \*s; int i; unsigned int length = req->request.length;- unsigned int remaining = req->request.num\_mapped\_sgs- - req->num\_queued\_sgs;+ unsigned int remaining = req->num\_pending\_sgs;+ unsigned int num\_queued\_sgs = req->request.num\_mapped\_sgs - remaining; unsigned int num\_trbs = req->num\_trbs; bool needs\_extra\_trb = dwc3\_needs\_extra\_trb(dep, req); @@ -1426,7 +1426,7 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, \* If we resume preparing the request, then get the remaining length of \* the request and resume where we left off. \*/- for\_each\_sg(req->request.sg, s, req->num\_queued\_sgs, i)+ for\_each\_sg(req->request.sg, s, num\_queued\_sgs, i) length -= sg\_dma\_len(s);  for\_each\_sg(sg, s, remaining, i) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:39:57 +0000



=== Content from git.kernel.org_dc9686aa_20250114_224121.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thinh Nguyen <Thinh.Nguyen@synopsys.com> | 2024-11-14 01:02:18 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-16 09:04:56 +0100 |
| commit | [b7fc65f5141c24785dc8c19249ca4efcf71b3524](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524)) | |
| tree | [39d5436a08c7d0461b34e1c8a746ff30556f1b1b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524) | |
| parent | [02a6982b0ccfcdc39e20016f5fc9a1b7826a6ee7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02a6982b0ccfcdc39e20016f5fc9a1b7826a6ee7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524&id2=02a6982b0ccfcdc39e20016f5fc9a1b7826a6ee7)) | |
| download | [linux-b7fc65f5141c24785dc8c19249ca4efcf71b3524.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b7fc65f5141c24785dc8c19249ca4efcf71b3524.tar.gz) | |

usb: dwc3: gadget: Fix looping of queued SG entriesThe dwc3\_request->num\_queued\_sgs is decremented on completion. If a
partially completed request is handled, then the
dwc3\_request->num\_queued\_sgs no longer reflects the total number of
num\_queued\_sgs (it would be cleared).
Correctly check the number of request SG entries remained to be prepare
and queued. Failure to do this may cause null pointer dereference when
accessing non-existent SG entry.
Cc: stable@vger.kernel.org
Fixes: c96e6725db9d ("usb: dwc3: gadget: Correct the logic for queuing sgs")
Signed-off-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Link: [https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen@synopsys.com](https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen%40synopsys.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex 38c3769a6c480a..3a5a0d8be33c04 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=02a6982b0ccfcdc39e20016f5fc9a1b7826a6ee7)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=b7fc65f5141c24785dc8c19249ca4efcf71b3524)@@ -1470,8 +1470,8 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, struct scatterlist \*s; int i; unsigned int length = req->request.length;- unsigned int remaining = req->request.num\_mapped\_sgs- - req->num\_queued\_sgs;+ unsigned int remaining = req->num\_pending\_sgs;+ unsigned int num\_queued\_sgs = req->request.num\_mapped\_sgs - remaining; unsigned int num\_trbs = req->num\_trbs; bool needs\_extra\_trb = dwc3\_needs\_extra\_trb(dep, req); @@ -1479,7 +1479,7 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, \* If we resume preparing the request, then get the remaining length of \* the request and resume where we left off. \*/- for\_each\_sg(req->request.sg, s, req->num\_queued\_sgs, i)+ for\_each\_sg(req->request.sg, s, num\_queued\_sgs, i) length -= sg\_dma\_len(s);  for\_each\_sg(sg, s, remaining, i) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:39:58 +0000



=== Content from git.kernel.org_16058f9f_20250114_224118.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1534f6f69393aac773465d80d31801b554352627)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1534f6f69393aac773465d80d31801b554352627)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1534f6f69393aac773465d80d31801b554352627)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1534f6f69393aac773465d80d31801b554352627)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thinh Nguyen <Thinh.Nguyen@synopsys.com> | 2024-11-14 01:02:18 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:53 +0100 |
| commit | [1534f6f69393aac773465d80d31801b554352627](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1534f6f69393aac773465d80d31801b554352627) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1534f6f69393aac773465d80d31801b554352627)) | |
| tree | [d51fa5f5e65a319675e8848c023221479c35ea8d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1534f6f69393aac773465d80d31801b554352627) | |
| parent | [bb6bf24fe03bd77f126eea4745a4e0098ef62543](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb6bf24fe03bd77f126eea4745a4e0098ef62543) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1534f6f69393aac773465d80d31801b554352627&id2=bb6bf24fe03bd77f126eea4745a4e0098ef62543)) | |
| download | [linux-1534f6f69393aac773465d80d31801b554352627.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1534f6f69393aac773465d80d31801b554352627.tar.gz) | |

usb: dwc3: gadget: Fix looping of queued SG entriescommit b7fc65f5141c24785dc8c19249ca4efcf71b3524 upstream.
The dwc3\_request->num\_queued\_sgs is decremented on completion. If a
partially completed request is handled, then the
dwc3\_request->num\_queued\_sgs no longer reflects the total number of
num\_queued\_sgs (it would be cleared).
Correctly check the number of request SG entries remained to be prepare
and queued. Failure to do this may cause null pointer dereference when
accessing non-existent SG entry.
Cc: stable@vger.kernel.org
Fixes: c96e6725db9d ("usb: dwc3: gadget: Correct the logic for queuing sgs")
Signed-off-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Link: [https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen@synopsys.com](https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen%40synopsys.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1534f6f69393aac773465d80d31801b554352627)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=1534f6f69393aac773465d80d31801b554352627) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex cbbffb785ee199..9971076c31de64 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=bb6bf24fe03bd77f126eea4745a4e0098ef62543)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=1534f6f69393aac773465d80d31801b554352627)@@ -1436,8 +1436,8 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, struct scatterlist \*s; int i; unsigned int length = req->request.length;- unsigned int remaining = req->request.num\_mapped\_sgs- - req->num\_queued\_sgs;+ unsigned int remaining = req->num\_pending\_sgs;+ unsigned int num\_queued\_sgs = req->request.num\_mapped\_sgs - remaining; unsigned int num\_trbs = req->num\_trbs; bool needs\_extra\_trb = dwc3\_needs\_extra\_trb(dep, req); @@ -1445,7 +1445,7 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, \* If we resume preparing the request, then get the remaining length of \* the request and resume where we left off. \*/- for\_each\_sg(req->request.sg, s, req->num\_queued\_sgs, i)+ for\_each\_sg(req->request.sg, s, num\_queued\_sgs, i) length -= sg\_dma\_len(s);  for\_each\_sg(sg, s, remaining, i) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:39:55 +0000



=== Content from git.kernel.org_0e8ed101_20250114_224118.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0247da93bf62d33304b7bf97850ebf2a86e06d28)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0247da93bf62d33304b7bf97850ebf2a86e06d28)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0247da93bf62d33304b7bf97850ebf2a86e06d28)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0247da93bf62d33304b7bf97850ebf2a86e06d28)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thinh Nguyen <Thinh.Nguyen@synopsys.com> | 2024-11-14 01:02:18 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:18 +0100 |
| commit | [0247da93bf62d33304b7bf97850ebf2a86e06d28](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0247da93bf62d33304b7bf97850ebf2a86e06d28) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0247da93bf62d33304b7bf97850ebf2a86e06d28)) | |
| tree | [30259e2b15929c5a526985156a1fddb506f4e7ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0247da93bf62d33304b7bf97850ebf2a86e06d28) | |
| parent | [893f9ea3f6f11c6599f89b6048695d5639d31874](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=893f9ea3f6f11c6599f89b6048695d5639d31874) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0247da93bf62d33304b7bf97850ebf2a86e06d28&id2=893f9ea3f6f11c6599f89b6048695d5639d31874)) | |
| download | [linux-0247da93bf62d33304b7bf97850ebf2a86e06d28.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0247da93bf62d33304b7bf97850ebf2a86e06d28.tar.gz) | |

usb: dwc3: gadget: Fix looping of queued SG entriescommit b7fc65f5141c24785dc8c19249ca4efcf71b3524 upstream.
The dwc3\_request->num\_queued\_sgs is decremented on completion. If a
partially completed request is handled, then the
dwc3\_request->num\_queued\_sgs no longer reflects the total number of
num\_queued\_sgs (it would be cleared).
Correctly check the number of request SG entries remained to be prepare
and queued. Failure to do this may cause null pointer dereference when
accessing non-existent SG entry.
Cc: stable@vger.kernel.org
Fixes: c96e6725db9d ("usb: dwc3: gadget: Correct the logic for queuing sgs")
Signed-off-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Link: [https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen@synopsys.com](https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen%40synopsys.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0247da93bf62d33304b7bf97850ebf2a86e06d28)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=0247da93bf62d33304b7bf97850ebf2a86e06d28) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex c488e5658e2f33..7ab6307fba85f0 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=893f9ea3f6f11c6599f89b6048695d5639d31874)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=0247da93bf62d33304b7bf97850ebf2a86e06d28)@@ -1403,8 +1403,8 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, struct scatterlist \*s; int i; unsigned int length = req->request.length;- unsigned int remaining = req->request.num\_mapped\_sgs- - req->num\_queued\_sgs;+ unsigned int remaining = req->num\_pending\_sgs;+ unsigned int num\_queued\_sgs = req->request.num\_mapped\_sgs - remaining; unsigned int num\_trbs = req->num\_trbs; bool needs\_extra\_trb = dwc3\_needs\_extra\_trb(dep, req); @@ -1412,7 +1412,7 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, \* If we resume preparing the request, then get the remaining length of \* the request and resume where we left off. \*/- for\_each\_sg(req->request.sg, s, req->num\_queued\_sgs, i)+ for\_each\_sg(req->request.sg, s, num\_queued\_sgs, i) length -= sg\_dma\_len(s);  for\_each\_sg(sg, s, remaining, i) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:39:55 +0000



=== Content from git.kernel.org_7539f1cb_20250114_224119.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=70777a23a54e359cfdfafc625a57cd56434f3859)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=70777a23a54e359cfdfafc625a57cd56434f3859)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70777a23a54e359cfdfafc625a57cd56434f3859)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70777a23a54e359cfdfafc625a57cd56434f3859)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thinh Nguyen <Thinh.Nguyen@synopsys.com> | 2024-11-14 01:02:18 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:03:01 +0100 |
| commit | [70777a23a54e359cfdfafc625a57cd56434f3859](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70777a23a54e359cfdfafc625a57cd56434f3859) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=70777a23a54e359cfdfafc625a57cd56434f3859)) | |
| tree | [f186e829eef6c9abe044481ad9f55db0b5bd855d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=70777a23a54e359cfdfafc625a57cd56434f3859) | |
| parent | [2f6c3acece2b87bfa11a1e5fc4018488d9139d56](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f6c3acece2b87bfa11a1e5fc4018488d9139d56) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70777a23a54e359cfdfafc625a57cd56434f3859&id2=2f6c3acece2b87bfa11a1e5fc4018488d9139d56)) | |
| download | [linux-70777a23a54e359cfdfafc625a57cd56434f3859.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-70777a23a54e359cfdfafc625a57cd56434f3859.tar.gz) | |

usb: dwc3: gadget: Fix looping of queued SG entriescommit b7fc65f5141c24785dc8c19249ca4efcf71b3524 upstream.
The dwc3\_request->num\_queued\_sgs is decremented on completion. If a
partially completed request is handled, then the
dwc3\_request->num\_queued\_sgs no longer reflects the total number of
num\_queued\_sgs (it would be cleared).
Correctly check the number of request SG entries remained to be prepare
and queued. Failure to do this may cause null pointer dereference when
accessing non-existent SG entry.
Cc: stable@vger.kernel.org
Fixes: c96e6725db9d ("usb: dwc3: gadget: Correct the logic for queuing sgs")
Signed-off-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Link: [https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen@synopsys.com](https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen%40synopsys.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70777a23a54e359cfdfafc625a57cd56434f3859)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=70777a23a54e359cfdfafc625a57cd56434f3859) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex 45a458cffb2c65..56744b11e67cb9 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=2f6c3acece2b87bfa11a1e5fc4018488d9139d56)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=70777a23a54e359cfdfafc625a57cd56434f3859)@@ -1455,8 +1455,8 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, struct scatterlist \*s; int i; unsigned int length = req->request.length;- unsigned int remaining = req->request.num\_mapped\_sgs- - req->num\_queued\_sgs;+ unsigned int remaining = req->num\_pending\_sgs;+ unsigned int num\_queued\_sgs = req->request.num\_mapped\_sgs - remaining; unsigned int num\_trbs = req->num\_trbs; bool needs\_extra\_trb = dwc3\_needs\_extra\_trb(dep, req); @@ -1464,7 +1464,7 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, \* If we resume preparing the request, then get the remaining length of \* the request and resume where we left off. \*/- for\_each\_sg(req->request.sg, s, req->num\_queued\_sgs, i)+ for\_each\_sg(req->request.sg, s, num\_queued\_sgs, i) length -= sg\_dma\_len(s);  for\_each\_sg(sg, s, remaining, i) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:39:56 +0000



=== Content from git.kernel.org_d2f8db07_20250114_224121.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c9e72352a10ae89a430449f7bfeb043e75c255d9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9e72352a10ae89a430449f7bfeb043e75c255d9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9e72352a10ae89a430449f7bfeb043e75c255d9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9e72352a10ae89a430449f7bfeb043e75c255d9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thinh Nguyen <Thinh.Nguyen@synopsys.com> | 2024-11-14 01:02:18 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:05 +0100 |
| commit | [c9e72352a10ae89a430449f7bfeb043e75c255d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9e72352a10ae89a430449f7bfeb043e75c255d9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c9e72352a10ae89a430449f7bfeb043e75c255d9)) | |
| tree | [8f6bfab62173be8dcf95a40f56a9c9873fd064a3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9e72352a10ae89a430449f7bfeb043e75c255d9) | |
| parent | [6cb33da1c8dd958e1c48ec4dce70538e08d47eda](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6cb33da1c8dd958e1c48ec4dce70538e08d47eda) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9e72352a10ae89a430449f7bfeb043e75c255d9&id2=6cb33da1c8dd958e1c48ec4dce70538e08d47eda)) | |
| download | [linux-c9e72352a10ae89a430449f7bfeb043e75c255d9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c9e72352a10ae89a430449f7bfeb043e75c255d9.tar.gz) | |

usb: dwc3: gadget: Fix looping of queued SG entriescommit b7fc65f5141c24785dc8c19249ca4efcf71b3524 upstream.
The dwc3\_request->num\_queued\_sgs is decremented on completion. If a
partially completed request is handled, then the
dwc3\_request->num\_queued\_sgs no longer reflects the total number of
num\_queued\_sgs (it would be cleared).
Correctly check the number of request SG entries remained to be prepare
and queued. Failure to do this may cause null pointer dereference when
accessing non-existent SG entry.
Cc: stable@vger.kernel.org
Fixes: c96e6725db9d ("usb: dwc3: gadget: Correct the logic for queuing sgs")
Signed-off-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Link: [https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen@synopsys.com](https://lore.kernel.org/r/d07a7c4aa0fcf746cdca0515150dbe5c52000af7.1731545781.git.Thinh.Nguyen%40synopsys.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9e72352a10ae89a430449f7bfeb043e75c255d9)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=c9e72352a10ae89a430449f7bfeb043e75c255d9) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex c6bf5e1f70f059..8eb75cfd416225 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=6cb33da1c8dd958e1c48ec4dce70538e08d47eda)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=c9e72352a10ae89a430449f7bfeb043e75c255d9)@@ -1443,8 +1443,8 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, struct scatterlist \*s; int i; unsigned int length = req->request.length;- unsigned int remaining = req->request.num\_mapped\_sgs- - req->num\_queued\_sgs;+ unsigned int remaining = req->num\_pending\_sgs;+ unsigned int num\_queued\_sgs = req->request.num\_mapped\_sgs - remaining; unsigned int num\_trbs = req->num\_trbs; bool needs\_extra\_trb = dwc3\_needs\_extra\_trb(dep, req); @@ -1452,7 +1452,7 @@ static int dwc3\_prepare\_trbs\_sg(struct dwc3\_ep \*dep, \* If we resume preparing the request, then get the remaining length of \* the request and resume where we left off. \*/- for\_each\_sg(req->request.sg, s, req->num\_queued\_sgs, i)+ for\_each\_sg(req->request.sg, s, num\_queued\_sgs, i) length -= sg\_dma\_len(s);  for\_each\_sg(sg, s, remaining, i) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:39:58 +0000


