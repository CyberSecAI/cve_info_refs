=== Content from git.kernel.org_32bdc1c0_20250114_224129.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:04 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:57 +0100 |
| commit | [0b648968bfa4f5c9c4983bca9f2de17626ed6fb6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)) | |
| tree | [d0eb4532105e358c95fb808d236063838c71657f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6) | |
| parent | [48d3964f2bcdc946343e0bce4423378035a8ba44](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48d3964f2bcdc946343e0bce4423378035a8ba44) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6&id2=48d3964f2bcdc946343e0bce4423378035a8ba44)) | |
| download | [linux-0b648968bfa4f5c9c4983bca9f2de17626ed6fb6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0b648968bfa4f5c9c4983bca9f2de17626ed6fb6.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for USB Type-C device[ Upstream commit 686fb77712a4bc94b76a0c5ae74c60118b7a0d79 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 9c6235c86332 ("mfd: intel\_soc\_pmic\_bxtwc: Add bxt\_wcove\_usbc device")
Fixes: d2061f9cc32d ("usb: typec: add driver for Intel Whiskey Cove PMIC USB Type-C PHY")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Link: [https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6) | 57 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/tcpm/wcove.c?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 40 insertions, 21 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 3b41cc2d1ec01b..82c71b475a7e06 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=48d3964f2bcdc946343e0bce4423378035a8ba44)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)@@ -241,16 +241,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_usbc",- .num\_resources = ARRAY\_SIZE(usbc\_resources),- .resources = usbc\_resources,- },- {- .name = "bxt\_wcove\_ext\_charger",- .num\_resources = ARRAY\_SIZE(charger\_resources),- .resources = charger\_resources,- },- { .name = "bxt\_wcove\_bcu", .num\_resources = ARRAY\_SIZE(bcu\_resources), .resources = bcu\_resources,@@ -271,6 +261,19 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static struct mfd\_cell bxt\_wc\_chgr\_dev[] = {+ {+ .name = "bxt\_wcove\_usbc",+ .num\_resources = ARRAY\_SIZE(usbc\_resources),+ .resources = usbc\_resources,+ },+ {+ .name = "bxt\_wcove\_ext\_charger",+ .num\_resources = ARRAY\_SIZE(charger\_resources),+ .resources = charger\_resources,+ },+};+ static int regmap\_ipc\_byte\_reg\_read(void \*context, unsigned int reg, unsigned int \*val) {@@ -418,6 +421,26 @@ static int bxtwc\_add\_chained\_irq\_chip(struct intel\_soc\_pmic \*pmic, 0, chip, data); } +static int bxtwc\_add\_chained\_devices(struct intel\_soc\_pmic \*pmic,+ const struct mfd\_cell \*cells, int n\_devs,+ struct regmap\_irq\_chip\_data \*pdata,+ int pirq, int irq\_flags,+ const struct regmap\_irq\_chip \*chip,+ struct regmap\_irq\_chip\_data \*\*data)+{+ struct device \*dev = pmic->dev;+ struct irq\_domain \*domain;+ int ret;++ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pdata, pirq, irq\_flags, chip, data);+ if (ret)+ return dev\_err\_probe(dev, ret, "Failed to add %s IRQ chip\n", chip->name);++ domain = regmap\_irq\_get\_domain(\*data);++ return devm\_mfd\_add\_devices(dev, PLATFORM\_DEVID\_NONE, cells, n\_devs, NULL, 0, domain);+}+ static int bxtwc\_probe(struct platform\_device \*pdev) { struct device \*dev = &pdev->dev;@@ -496,14 +519,14 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n"); - /\* Add chained IRQ handler for CHGR IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_CHGR\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_chgr,- &pmic->irq\_chip\_data\_chgr);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_CHGR\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_chgr,+ &pmic->irq\_chip\_data\_chgr); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add CHGR IRQ chip\n");+ return ret;  /\* Add chained IRQ handler for CRIT IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,diff --git a/drivers/usb/typec/tcpm/wcove.c b/drivers/usb/typec/tcpm/wcove.cindex 7e9c279bf49dff..22fe8d60fe3689 100644--- a/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=48d3964f2bcdc946343e0bce4423378035a8ba44)+++ b/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=0b648968bfa4f5c9c4983bca9f2de17626ed6fb6)@@ -620,10 +620,6 @@ static int wcove\_typec\_probe(struct platform\_device \*pdev) if (irq < 0) return irq; - irq = regmap\_irq\_get\_virq(pmic->irq\_chip\_data\_chgr, irq);- if (irq < 0)- return irq;- ret = guid\_parse(WCOVE\_DSM\_UUID, &wcove->guid); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:06 +0000



=== Content from git.kernel.org_9c40f821_20250114_224132.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:04 +0300 |
| --- | --- | --- |
| committer | Lee Jones <lee@kernel.org> | 2024-10-16 09:04:11 +0100 |
| commit | [686fb77712a4bc94b76a0c5ae74c60118b7a0d79](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)) | |
| tree | [5d7f49e2ab4a6f259f0be867e28ed93f9dccec0f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79) | |
| parent | [6af8d30527e6abb31833b15823cac15afaa0b4a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6af8d30527e6abb31833b15823cac15afaa0b4a4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79&id2=6af8d30527e6abb31833b15823cac15afaa0b4a4)) | |
| download | [linux-686fb77712a4bc94b76a0c5ae74c60118b7a0d79.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-686fb77712a4bc94b76a0c5ae74c60118b7a0d79.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for USB Type-C deviceWhile design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 9c6235c86332 ("mfd: intel\_soc\_pmic\_bxtwc: Add bxt\_wcove\_usbc device")
Fixes: d2061f9cc32d ("usb: typec: add driver for Intel Whiskey Cove PMIC USB Type-C PHY")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Link: [https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79) | 57 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/tcpm/wcove.c?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 40 insertions, 21 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex ccd76800d8e49b..d72995a9e8207f 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=6af8d30527e6abb31833b15823cac15afaa0b4a4)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)@@ -241,16 +241,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_usbc",- .num\_resources = ARRAY\_SIZE(usbc\_resources),- .resources = usbc\_resources,- },- {- .name = "bxt\_wcove\_ext\_charger",- .num\_resources = ARRAY\_SIZE(charger\_resources),- .resources = charger\_resources,- },- { .name = "bxt\_wcove\_bcu", .num\_resources = ARRAY\_SIZE(bcu\_resources), .resources = bcu\_resources,@@ -271,6 +261,19 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static struct mfd\_cell bxt\_wc\_chgr\_dev[] = {+ {+ .name = "bxt\_wcove\_usbc",+ .num\_resources = ARRAY\_SIZE(usbc\_resources),+ .resources = usbc\_resources,+ },+ {+ .name = "bxt\_wcove\_ext\_charger",+ .num\_resources = ARRAY\_SIZE(charger\_resources),+ .resources = charger\_resources,+ },+};+ static int regmap\_ipc\_byte\_reg\_read(void \*context, unsigned int reg, unsigned int \*val) {@@ -425,6 +428,26 @@ static int bxtwc\_add\_chained\_irq\_chip(struct intel\_soc\_pmic \*pmic, 0, chip, data); } +static int bxtwc\_add\_chained\_devices(struct intel\_soc\_pmic \*pmic,+ const struct mfd\_cell \*cells, int n\_devs,+ struct regmap\_irq\_chip\_data \*pdata,+ int pirq, int irq\_flags,+ const struct regmap\_irq\_chip \*chip,+ struct regmap\_irq\_chip\_data \*\*data)+{+ struct device \*dev = pmic->dev;+ struct irq\_domain \*domain;+ int ret;++ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pdata, pirq, irq\_flags, chip, data);+ if (ret)+ return dev\_err\_probe(dev, ret, "Failed to add %s IRQ chip\n", chip->name);++ domain = regmap\_irq\_get\_domain(\*data);++ return devm\_mfd\_add\_devices(dev, PLATFORM\_DEVID\_NONE, cells, n\_devs, NULL, 0, domain);+}+ static int bxtwc\_probe(struct platform\_device \*pdev) { struct device \*dev = &pdev->dev;@@ -500,14 +523,14 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n"); - /\* Add chained IRQ handler for CHGR IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_CHGR\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_chgr,- &pmic->irq\_chip\_data\_chgr);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_CHGR\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_chgr,+ &pmic->irq\_chip\_data\_chgr); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add CHGR IRQ chip\n");+ return ret;  /\* Add chained IRQ handler for CRIT IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,diff --git a/drivers/usb/typec/tcpm/wcove.c b/drivers/usb/typec/tcpm/wcove.cindex cf719307b3f6b9..60b2766a69bf8a 100644--- a/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=6af8d30527e6abb31833b15823cac15afaa0b4a4)+++ b/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=686fb77712a4bc94b76a0c5ae74c60118b7a0d79)@@ -621,10 +621,6 @@ static int wcove\_typec\_probe(struct platform\_device \*pdev) if (irq < 0) return irq; - irq = regmap\_irq\_get\_virq(pmic->irq\_chip\_data\_chgr, irq);- if (irq < 0)- return irq;- ret = guid\_parse(WCOVE\_DSM\_UUID, &wcove->guid); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:08 +0000



=== Content from git.kernel.org_6829e604_20250114_224129.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0997e77c51330c2866a4f39480e762cca92ad953)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0997e77c51330c2866a4f39480e762cca92ad953)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0997e77c51330c2866a4f39480e762cca92ad953)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0997e77c51330c2866a4f39480e762cca92ad953)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:04 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:28 +0100 |
| commit | [0997e77c51330c2866a4f39480e762cca92ad953](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0997e77c51330c2866a4f39480e762cca92ad953) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0997e77c51330c2866a4f39480e762cca92ad953)) | |
| tree | [8edc68b3e0cf81223ef2dbe0c0ec677826ffd7f7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0997e77c51330c2866a4f39480e762cca92ad953) | |
| parent | [851f94e403eef145e5650e55bb8f504f16bb9873](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=851f94e403eef145e5650e55bb8f504f16bb9873) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0997e77c51330c2866a4f39480e762cca92ad953&id2=851f94e403eef145e5650e55bb8f504f16bb9873)) | |
| download | [linux-0997e77c51330c2866a4f39480e762cca92ad953.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0997e77c51330c2866a4f39480e762cca92ad953.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for USB Type-C device[ Upstream commit 686fb77712a4bc94b76a0c5ae74c60118b7a0d79 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 9c6235c86332 ("mfd: intel\_soc\_pmic\_bxtwc: Add bxt\_wcove\_usbc device")
Fixes: d2061f9cc32d ("usb: typec: add driver for Intel Whiskey Cove PMIC USB Type-C PHY")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Link: [https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0997e77c51330c2866a4f39480e762cca92ad953)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=0997e77c51330c2866a4f39480e762cca92ad953) | 57 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/tcpm/wcove.c?id=0997e77c51330c2866a4f39480e762cca92ad953) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 40 insertions, 21 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 072ed3226a83f6..9b5edc1b47d89d 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=851f94e403eef145e5650e55bb8f504f16bb9873)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=0997e77c51330c2866a4f39480e762cca92ad953)@@ -237,16 +237,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_usbc",- .num\_resources = ARRAY\_SIZE(usbc\_resources),- .resources = usbc\_resources,- },- {- .name = "bxt\_wcove\_ext\_charger",- .num\_resources = ARRAY\_SIZE(charger\_resources),- .resources = charger\_resources,- },- { .name = "bxt\_wcove\_bcu", .num\_resources = ARRAY\_SIZE(bcu\_resources), .resources = bcu\_resources,@@ -267,6 +257,19 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static struct mfd\_cell bxt\_wc\_chgr\_dev[] = {+ {+ .name = "bxt\_wcove\_usbc",+ .num\_resources = ARRAY\_SIZE(usbc\_resources),+ .resources = usbc\_resources,+ },+ {+ .name = "bxt\_wcove\_ext\_charger",+ .num\_resources = ARRAY\_SIZE(charger\_resources),+ .resources = charger\_resources,+ },+};+ static int regmap\_ipc\_byte\_reg\_read(void \*context, unsigned int reg, unsigned int \*val) {@@ -422,6 +425,26 @@ static int bxtwc\_add\_chained\_irq\_chip(struct intel\_soc\_pmic \*pmic, 0, chip, data); } +static int bxtwc\_add\_chained\_devices(struct intel\_soc\_pmic \*pmic,+ const struct mfd\_cell \*cells, int n\_devs,+ struct regmap\_irq\_chip\_data \*pdata,+ int pirq, int irq\_flags,+ const struct regmap\_irq\_chip \*chip,+ struct regmap\_irq\_chip\_data \*\*data)+{+ struct device \*dev = pmic->dev;+ struct irq\_domain \*domain;+ int ret;++ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pdata, pirq, irq\_flags, chip, data);+ if (ret)+ return dev\_err\_probe(dev, ret, "Failed to add %s IRQ chip\n", chip->name);++ domain = regmap\_irq\_get\_domain(\*data);++ return devm\_mfd\_add\_devices(dev, PLATFORM\_DEVID\_NONE, cells, n\_devs, NULL, 0, domain);+}+ static int bxtwc\_probe(struct platform\_device \*pdev) { struct device \*dev = &pdev->dev;@@ -496,14 +519,14 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n"); - /\* Add chained IRQ handler for CHGR IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_CHGR\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_chgr,- &pmic->irq\_chip\_data\_chgr);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_CHGR\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_chgr,+ &pmic->irq\_chip\_data\_chgr); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add CHGR IRQ chip\n");+ return ret;  /\* Add chained IRQ handler for CRIT IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,diff --git a/drivers/usb/typec/tcpm/wcove.c b/drivers/usb/typec/tcpm/wcove.cindex 7e9c279bf49dff..22fe8d60fe3689 100644--- a/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=851f94e403eef145e5650e55bb8f504f16bb9873)+++ b/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=0997e77c51330c2866a4f39480e762cca92ad953)@@ -620,10 +620,6 @@ static int wcove\_typec\_probe(struct platform\_device \*pdev) if (irq < 0) return irq; - irq = regmap\_irq\_get\_virq(pmic->irq\_chip\_data\_chgr, irq);- if (irq < 0)- return irq;- ret = guid\_parse(WCOVE\_DSM\_UUID, &wcove->guid); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:06 +0000



=== Content from git.kernel.org_42572d14_20250114_224130.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:04 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:00 +0100 |
| commit | [23230ac3c5ca3f154b64849d1cf50583b4e6b98c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)) | |
| tree | [ebb1225f9cf1f2cf7ad84f1a5615f496a9958f71](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c) | |
| parent | [91cee88255a31db69ceab6035c8fd00d917e5909](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91cee88255a31db69ceab6035c8fd00d917e5909) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c&id2=91cee88255a31db69ceab6035c8fd00d917e5909)) | |
| download | [linux-23230ac3c5ca3f154b64849d1cf50583b4e6b98c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-23230ac3c5ca3f154b64849d1cf50583b4e6b98c.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for USB Type-C device[ Upstream commit 686fb77712a4bc94b76a0c5ae74c60118b7a0d79 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 9c6235c86332 ("mfd: intel\_soc\_pmic\_bxtwc: Add bxt\_wcove\_usbc device")
Fixes: d2061f9cc32d ("usb: typec: add driver for Intel Whiskey Cove PMIC USB Type-C PHY")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Link: [https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c) | 57 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/tcpm/wcove.c?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 40 insertions, 21 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 8e699844f23ba3..d2c13ef4bf33f9 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=91cee88255a31db69ceab6035c8fd00d917e5909)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)@@ -241,16 +241,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_usbc",- .num\_resources = ARRAY\_SIZE(usbc\_resources),- .resources = usbc\_resources,- },- {- .name = "bxt\_wcove\_ext\_charger",- .num\_resources = ARRAY\_SIZE(charger\_resources),- .resources = charger\_resources,- },- { .name = "bxt\_wcove\_bcu", .num\_resources = ARRAY\_SIZE(bcu\_resources), .resources = bcu\_resources,@@ -271,6 +261,19 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static struct mfd\_cell bxt\_wc\_chgr\_dev[] = {+ {+ .name = "bxt\_wcove\_usbc",+ .num\_resources = ARRAY\_SIZE(usbc\_resources),+ .resources = usbc\_resources,+ },+ {+ .name = "bxt\_wcove\_ext\_charger",+ .num\_resources = ARRAY\_SIZE(charger\_resources),+ .resources = charger\_resources,+ },+};+ static int regmap\_ipc\_byte\_reg\_read(void \*context, unsigned int reg, unsigned int \*val) {@@ -418,6 +421,26 @@ static int bxtwc\_add\_chained\_irq\_chip(struct intel\_soc\_pmic \*pmic, 0, chip, data); } +static int bxtwc\_add\_chained\_devices(struct intel\_soc\_pmic \*pmic,+ const struct mfd\_cell \*cells, int n\_devs,+ struct regmap\_irq\_chip\_data \*pdata,+ int pirq, int irq\_flags,+ const struct regmap\_irq\_chip \*chip,+ struct regmap\_irq\_chip\_data \*\*data)+{+ struct device \*dev = pmic->dev;+ struct irq\_domain \*domain;+ int ret;++ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pdata, pirq, irq\_flags, chip, data);+ if (ret)+ return dev\_err\_probe(dev, ret, "Failed to add %s IRQ chip\n", chip->name);++ domain = regmap\_irq\_get\_domain(\*data);++ return devm\_mfd\_add\_devices(dev, PLATFORM\_DEVID\_NONE, cells, n\_devs, NULL, 0, domain);+}+ static int bxtwc\_probe(struct platform\_device \*pdev) { struct device \*dev = &pdev->dev;@@ -496,14 +519,14 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n"); - /\* Add chained IRQ handler for CHGR IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_CHGR\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_chgr,- &pmic->irq\_chip\_data\_chgr);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_CHGR\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_chgr,+ &pmic->irq\_chip\_data\_chgr); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add CHGR IRQ chip\n");+ return ret;  /\* Add chained IRQ handler for CRIT IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,diff --git a/drivers/usb/typec/tcpm/wcove.c b/drivers/usb/typec/tcpm/wcove.cindex 20917d85d6f4c3..5d34466a0abf24 100644--- a/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=91cee88255a31db69ceab6035c8fd00d917e5909)+++ b/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=23230ac3c5ca3f154b64849d1cf50583b4e6b98c)@@ -621,10 +621,6 @@ static int wcove\_typec\_probe(struct platform\_device \*pdev) if (irq < 0) return irq; - irq = regmap\_irq\_get\_virq(pmic->irq\_chip\_data\_chgr, irq);- if (irq < 0)- return irq;- ret = guid\_parse(WCOVE\_DSM\_UUID, &wcove->guid); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:07 +0000



=== Content from git.kernel.org_c64ca87d_20250114_224135.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:04 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:13 +0100 |
| commit | [e1ef62e8d262e3f27446d26742208c1c81e9ee18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18)) | |
| tree | [60c6e45cfad4b877176233e4a19239b3a36314d6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18) | |
| parent | [d80635d7ebefdbbb8eb398a2663183bb91b7f9e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d80635d7ebefdbbb8eb398a2663183bb91b7f9e8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18&id2=d80635d7ebefdbbb8eb398a2663183bb91b7f9e8)) | |
| download | [linux-e1ef62e8d262e3f27446d26742208c1c81e9ee18.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e1ef62e8d262e3f27446d26742208c1c81e9ee18.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for USB Type-C device[ Upstream commit 686fb77712a4bc94b76a0c5ae74c60118b7a0d79 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 9c6235c86332 ("mfd: intel\_soc\_pmic\_bxtwc: Add bxt\_wcove\_usbc device")
Fixes: d2061f9cc32d ("usb: typec: add driver for Intel Whiskey Cove PMIC USB Type-C PHY")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Link: [https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18) | 57 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/tcpm/wcove.c?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 40 insertions, 21 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 8dac0d41f64f3e..6ea98321bbf203 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=d80635d7ebefdbbb8eb398a2663183bb91b7f9e8)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18)@@ -242,16 +242,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_usbc",- .num\_resources = ARRAY\_SIZE(usbc\_resources),- .resources = usbc\_resources,- },- {- .name = "bxt\_wcove\_ext\_charger",- .num\_resources = ARRAY\_SIZE(charger\_resources),- .resources = charger\_resources,- },- { .name = "bxt\_wcove\_bcu", .num\_resources = ARRAY\_SIZE(bcu\_resources), .resources = bcu\_resources,@@ -272,6 +262,19 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static struct mfd\_cell bxt\_wc\_chgr\_dev[] = {+ {+ .name = "bxt\_wcove\_usbc",+ .num\_resources = ARRAY\_SIZE(usbc\_resources),+ .resources = usbc\_resources,+ },+ {+ .name = "bxt\_wcove\_ext\_charger",+ .num\_resources = ARRAY\_SIZE(charger\_resources),+ .resources = charger\_resources,+ },+};+ static int regmap\_ipc\_byte\_reg\_read(void \*context, unsigned int reg, unsigned int \*val) {@@ -426,6 +429,26 @@ static int bxtwc\_add\_chained\_irq\_chip(struct intel\_soc\_pmic \*pmic, 0, chip, data); } +static int bxtwc\_add\_chained\_devices(struct intel\_soc\_pmic \*pmic,+ const struct mfd\_cell \*cells, int n\_devs,+ struct regmap\_irq\_chip\_data \*pdata,+ int pirq, int irq\_flags,+ const struct regmap\_irq\_chip \*chip,+ struct regmap\_irq\_chip\_data \*\*data)+{+ struct device \*dev = pmic->dev;+ struct irq\_domain \*domain;+ int ret;++ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pdata, pirq, irq\_flags, chip, data);+ if (ret)+ return dev\_err\_probe(dev, ret, "Failed to add %s IRQ chip\n", chip->name);++ domain = regmap\_irq\_get\_domain(\*data);++ return devm\_mfd\_add\_devices(dev, PLATFORM\_DEVID\_NONE, cells, n\_devs, NULL, 0, domain);+}+ static int bxtwc\_probe(struct platform\_device \*pdev) { struct device \*dev = &pdev->dev;@@ -501,14 +524,14 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n"); - /\* Add chained IRQ handler for CHGR IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_CHGR\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_chgr,- &pmic->irq\_chip\_data\_chgr);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_CHGR\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_chgr,+ &pmic->irq\_chip\_data\_chgr); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add CHGR IRQ chip\n");+ return ret;  /\* Add chained IRQ handler for CRIT IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,diff --git a/drivers/usb/typec/tcpm/wcove.c b/drivers/usb/typec/tcpm/wcove.cindex 87d4abde0ea279..e08244f555f039 100644--- a/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=d80635d7ebefdbbb8eb398a2663183bb91b7f9e8)+++ b/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=e1ef62e8d262e3f27446d26742208c1c81e9ee18)@@ -621,10 +621,6 @@ static int wcove\_typec\_probe(struct platform\_device \*pdev) if (irq < 0) return irq; - irq = regmap\_irq\_get\_virq(pmic->irq\_chip\_data\_chgr, irq);- if (irq < 0)- return irq;- ret = guid\_parse(WCOVE\_DSM\_UUID, &wcove->guid); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:12 +0000



=== Content from git.kernel.org_0d9e2e91_20250114_224130.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:04 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:31 +0100 |
| commit | [518e414d24e7037d6cc7198e942bf47fe6f5e8e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)) | |
| tree | [5a695351389980864fb2c99295f673255c70ebcf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1) | |
| parent | [7fd26c70eee0889b74bd9bc458a7fee01e8b0c26](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7fd26c70eee0889b74bd9bc458a7fee01e8b0c26) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1&id2=7fd26c70eee0889b74bd9bc458a7fee01e8b0c26)) | |
| download | [linux-518e414d24e7037d6cc7198e942bf47fe6f5e8e1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-518e414d24e7037d6cc7198e942bf47fe6f5e8e1.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for USB Type-C device[ Upstream commit 686fb77712a4bc94b76a0c5ae74c60118b7a0d79 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 9c6235c86332 ("mfd: intel\_soc\_pmic\_bxtwc: Add bxt\_wcove\_usbc device")
Fixes: d2061f9cc32d ("usb: typec: add driver for Intel Whiskey Cove PMIC USB Type-C PHY")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Link: [https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1) | 57 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/tcpm/wcove.c?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 40 insertions, 21 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex ba32cacfc499f3..5c35ccfc534ad7 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=7fd26c70eee0889b74bd9bc458a7fee01e8b0c26)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)@@ -242,16 +242,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_usbc",- .num\_resources = ARRAY\_SIZE(usbc\_resources),- .resources = usbc\_resources,- },- {- .name = "bxt\_wcove\_ext\_charger",- .num\_resources = ARRAY\_SIZE(charger\_resources),- .resources = charger\_resources,- },- { .name = "bxt\_wcove\_bcu", .num\_resources = ARRAY\_SIZE(bcu\_resources), .resources = bcu\_resources,@@ -272,6 +262,19 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static struct mfd\_cell bxt\_wc\_chgr\_dev[] = {+ {+ .name = "bxt\_wcove\_usbc",+ .num\_resources = ARRAY\_SIZE(usbc\_resources),+ .resources = usbc\_resources,+ },+ {+ .name = "bxt\_wcove\_ext\_charger",+ .num\_resources = ARRAY\_SIZE(charger\_resources),+ .resources = charger\_resources,+ },+};+ static int regmap\_ipc\_byte\_reg\_read(void \*context, unsigned int reg, unsigned int \*val) {@@ -426,6 +429,26 @@ static int bxtwc\_add\_chained\_irq\_chip(struct intel\_soc\_pmic \*pmic, 0, chip, data); } +static int bxtwc\_add\_chained\_devices(struct intel\_soc\_pmic \*pmic,+ const struct mfd\_cell \*cells, int n\_devs,+ struct regmap\_irq\_chip\_data \*pdata,+ int pirq, int irq\_flags,+ const struct regmap\_irq\_chip \*chip,+ struct regmap\_irq\_chip\_data \*\*data)+{+ struct device \*dev = pmic->dev;+ struct irq\_domain \*domain;+ int ret;++ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pdata, pirq, irq\_flags, chip, data);+ if (ret)+ return dev\_err\_probe(dev, ret, "Failed to add %s IRQ chip\n", chip->name);++ domain = regmap\_irq\_get\_domain(\*data);++ return devm\_mfd\_add\_devices(dev, PLATFORM\_DEVID\_NONE, cells, n\_devs, NULL, 0, domain);+}+ static int bxtwc\_probe(struct platform\_device \*pdev) { struct device \*dev = &pdev->dev;@@ -501,14 +524,14 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n"); - /\* Add chained IRQ handler for CHGR IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_CHGR\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_chgr,- &pmic->irq\_chip\_data\_chgr);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_CHGR\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_chgr,+ &pmic->irq\_chip\_data\_chgr); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add CHGR IRQ chip\n");+ return ret;  /\* Add chained IRQ handler for CRIT IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,diff --git a/drivers/usb/typec/tcpm/wcove.c b/drivers/usb/typec/tcpm/wcove.cindex cf719307b3f6b9..60b2766a69bf8a 100644--- a/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=7fd26c70eee0889b74bd9bc458a7fee01e8b0c26)+++ b/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=518e414d24e7037d6cc7198e942bf47fe6f5e8e1)@@ -621,10 +621,6 @@ static int wcove\_typec\_probe(struct platform\_device \*pdev) if (irq < 0) return irq; - irq = regmap\_irq\_get\_virq(pmic->irq\_chip\_data\_chgr, irq);- if (irq < 0)- return irq;- ret = guid\_parse(WCOVE\_DSM\_UUID, &wcove->guid); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:08 +0000



=== Content from git.kernel.org_3d937515_20250114_224134.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c310e6916c0b297011d0fec03f168a6b24e9e984)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c310e6916c0b297011d0fec03f168a6b24e9e984)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c310e6916c0b297011d0fec03f168a6b24e9e984)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c310e6916c0b297011d0fec03f168a6b24e9e984)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:04 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:35 +0100 |
| commit | [c310e6916c0b297011d0fec03f168a6b24e9e984](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c310e6916c0b297011d0fec03f168a6b24e9e984) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c310e6916c0b297011d0fec03f168a6b24e9e984)) | |
| tree | [6af520c3f5045b63cb2bed540e3cd2ccba04437c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c310e6916c0b297011d0fec03f168a6b24e9e984) | |
| parent | [50952a6ff5fa399c4d8a8ec517d1e8f4e0494fb0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50952a6ff5fa399c4d8a8ec517d1e8f4e0494fb0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c310e6916c0b297011d0fec03f168a6b24e9e984&id2=50952a6ff5fa399c4d8a8ec517d1e8f4e0494fb0)) | |
| download | [linux-c310e6916c0b297011d0fec03f168a6b24e9e984.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c310e6916c0b297011d0fec03f168a6b24e9e984.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for USB Type-C device[ Upstream commit 686fb77712a4bc94b76a0c5ae74c60118b7a0d79 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 9c6235c86332 ("mfd: intel\_soc\_pmic\_bxtwc: Add bxt\_wcove\_usbc device")
Fixes: d2061f9cc32d ("usb: typec: add driver for Intel Whiskey Cove PMIC USB Type-C PHY")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Link: [https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c310e6916c0b297011d0fec03f168a6b24e9e984)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=c310e6916c0b297011d0fec03f168a6b24e9e984) | 57 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/tcpm/wcove.c?id=c310e6916c0b297011d0fec03f168a6b24e9e984) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 40 insertions, 21 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex 8dac0d41f64f3e..6ea98321bbf203 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=50952a6ff5fa399c4d8a8ec517d1e8f4e0494fb0)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=c310e6916c0b297011d0fec03f168a6b24e9e984)@@ -242,16 +242,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_usbc",- .num\_resources = ARRAY\_SIZE(usbc\_resources),- .resources = usbc\_resources,- },- {- .name = "bxt\_wcove\_ext\_charger",- .num\_resources = ARRAY\_SIZE(charger\_resources),- .resources = charger\_resources,- },- { .name = "bxt\_wcove\_bcu", .num\_resources = ARRAY\_SIZE(bcu\_resources), .resources = bcu\_resources,@@ -272,6 +262,19 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static struct mfd\_cell bxt\_wc\_chgr\_dev[] = {+ {+ .name = "bxt\_wcove\_usbc",+ .num\_resources = ARRAY\_SIZE(usbc\_resources),+ .resources = usbc\_resources,+ },+ {+ .name = "bxt\_wcove\_ext\_charger",+ .num\_resources = ARRAY\_SIZE(charger\_resources),+ .resources = charger\_resources,+ },+};+ static int regmap\_ipc\_byte\_reg\_read(void \*context, unsigned int reg, unsigned int \*val) {@@ -426,6 +429,26 @@ static int bxtwc\_add\_chained\_irq\_chip(struct intel\_soc\_pmic \*pmic, 0, chip, data); } +static int bxtwc\_add\_chained\_devices(struct intel\_soc\_pmic \*pmic,+ const struct mfd\_cell \*cells, int n\_devs,+ struct regmap\_irq\_chip\_data \*pdata,+ int pirq, int irq\_flags,+ const struct regmap\_irq\_chip \*chip,+ struct regmap\_irq\_chip\_data \*\*data)+{+ struct device \*dev = pmic->dev;+ struct irq\_domain \*domain;+ int ret;++ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pdata, pirq, irq\_flags, chip, data);+ if (ret)+ return dev\_err\_probe(dev, ret, "Failed to add %s IRQ chip\n", chip->name);++ domain = regmap\_irq\_get\_domain(\*data);++ return devm\_mfd\_add\_devices(dev, PLATFORM\_DEVID\_NONE, cells, n\_devs, NULL, 0, domain);+}+ static int bxtwc\_probe(struct platform\_device \*pdev) { struct device \*dev = &pdev->dev;@@ -501,14 +524,14 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n"); - /\* Add chained IRQ handler for CHGR IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_CHGR\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_chgr,- &pmic->irq\_chip\_data\_chgr);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_CHGR\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_chgr,+ &pmic->irq\_chip\_data\_chgr); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add CHGR IRQ chip\n");+ return ret;  /\* Add chained IRQ handler for CRIT IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,diff --git a/drivers/usb/typec/tcpm/wcove.c b/drivers/usb/typec/tcpm/wcove.cindex 20917d85d6f4c3..5d34466a0abf24 100644--- a/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=50952a6ff5fa399c4d8a8ec517d1e8f4e0494fb0)+++ b/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=c310e6916c0b297011d0fec03f168a6b24e9e984)@@ -621,10 +621,6 @@ static int wcove\_typec\_probe(struct platform\_device \*pdev) if (irq < 0) return irq; - irq = regmap\_irq\_get\_virq(pmic->irq\_chip\_data\_chgr, irq);- if (irq < 0)- return irq;- ret = guid\_parse(WCOVE\_DSM\_UUID, &wcove->guid); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:10 +0000



=== Content from git.kernel.org_14339ce5_20250114_224133.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=87a07a5b0b296e489c606ca95ffc16c18821975b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=87a07a5b0b296e489c606ca95ffc16c18821975b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87a07a5b0b296e489c606ca95ffc16c18821975b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87a07a5b0b296e489c606ca95ffc16c18821975b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andy Shevchenko <andriy.shevchenko@linux.intel.com> | 2024-10-05 22:27:04 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:03 +0100 |
| commit | [87a07a5b0b296e489c606ca95ffc16c18821975b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87a07a5b0b296e489c606ca95ffc16c18821975b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=87a07a5b0b296e489c606ca95ffc16c18821975b)) | |
| tree | [c3a1c20a96375b9ad8c8c2b08aae12bda33b074d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=87a07a5b0b296e489c606ca95ffc16c18821975b) | |
| parent | [691333e2987dd696c877c2f0aad6174f5c670df5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=691333e2987dd696c877c2f0aad6174f5c670df5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87a07a5b0b296e489c606ca95ffc16c18821975b&id2=691333e2987dd696c877c2f0aad6174f5c670df5)) | |
| download | [linux-87a07a5b0b296e489c606ca95ffc16c18821975b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-87a07a5b0b296e489c606ca95ffc16c18821975b.tar.gz) | |

mfd: intel\_soc\_pmic\_bxtwc: Use IRQ domain for USB Type-C device[ Upstream commit 686fb77712a4bc94b76a0c5ae74c60118b7a0d79 ]
While design wise the idea of converting the driver to use
the hierarchy of the IRQ chips is correct, the implementation
has (inherited) flaws. This was unveiled when platform\_get\_irq()
had started WARN() on IRQ 0 that is supposed to be a Linux
IRQ number (also known as vIRQ).
Rework the driver to respect IRQ domain when creating each MFD
device separately, as the domain is not the same for all of them.
Fixes: 9c6235c86332 ("mfd: intel\_soc\_pmic\_bxtwc: Add bxt\_wcove\_usbc device")
Fixes: d2061f9cc32d ("usb: typec: add driver for Intel Whiskey Cove PMIC USB Type-C PHY")
Fixes: 57129044f504 ("mfd: intel\_soc\_pmic\_bxtwc: Use chained IRQs for second level IRQ chips")
Reported-by: Zhang Ning <zhangn1985@outlook.com>
Closes: https://lore.kernel.org/r/TY2PR01MB3322FEDCDC048B7D3794F922CDBA2@TY2PR01MB3322.jpnprd01.prod.outlook.com
Tested-by: Zhang Ning <zhangn1985@outlook.com>
Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Link: [https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko@linux.intel.com](https://lore.kernel.org/r/20241005193029.1929139-2-andriy.shevchenko%40linux.intel.com)
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87a07a5b0b296e489c606ca95ffc16c18821975b)

| -rw-r--r-- | [drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mfd/intel_soc_pmic_bxtwc.c?id=87a07a5b0b296e489c606ca95ffc16c18821975b) | 57 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/tcpm/wcove.c?id=87a07a5b0b296e489c606ca95ffc16c18821975b) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 40 insertions, 21 deletions

| diff --git a/drivers/mfd/intel\_soc\_pmic\_bxtwc.c b/drivers/mfd/intel\_soc\_pmic\_bxtwc.cindex ccd76800d8e49b..d72995a9e8207f 100644--- a/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=691333e2987dd696c877c2f0aad6174f5c670df5)+++ b/[drivers/mfd/intel\_soc\_pmic\_bxtwc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mfd/intel_soc_pmic_bxtwc.c?id=87a07a5b0b296e489c606ca95ffc16c18821975b)@@ -241,16 +241,6 @@ static struct mfd\_cell bxt\_wc\_dev[] = { .resources = thermal\_resources, }, {- .name = "bxt\_wcove\_usbc",- .num\_resources = ARRAY\_SIZE(usbc\_resources),- .resources = usbc\_resources,- },- {- .name = "bxt\_wcove\_ext\_charger",- .num\_resources = ARRAY\_SIZE(charger\_resources),- .resources = charger\_resources,- },- { .name = "bxt\_wcove\_bcu", .num\_resources = ARRAY\_SIZE(bcu\_resources), .resources = bcu\_resources,@@ -271,6 +261,19 @@ static struct mfd\_cell bxt\_wc\_dev[] = { }, }; +static struct mfd\_cell bxt\_wc\_chgr\_dev[] = {+ {+ .name = "bxt\_wcove\_usbc",+ .num\_resources = ARRAY\_SIZE(usbc\_resources),+ .resources = usbc\_resources,+ },+ {+ .name = "bxt\_wcove\_ext\_charger",+ .num\_resources = ARRAY\_SIZE(charger\_resources),+ .resources = charger\_resources,+ },+};+ static int regmap\_ipc\_byte\_reg\_read(void \*context, unsigned int reg, unsigned int \*val) {@@ -425,6 +428,26 @@ static int bxtwc\_add\_chained\_irq\_chip(struct intel\_soc\_pmic \*pmic, 0, chip, data); } +static int bxtwc\_add\_chained\_devices(struct intel\_soc\_pmic \*pmic,+ const struct mfd\_cell \*cells, int n\_devs,+ struct regmap\_irq\_chip\_data \*pdata,+ int pirq, int irq\_flags,+ const struct regmap\_irq\_chip \*chip,+ struct regmap\_irq\_chip\_data \*\*data)+{+ struct device \*dev = pmic->dev;+ struct irq\_domain \*domain;+ int ret;++ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pdata, pirq, irq\_flags, chip, data);+ if (ret)+ return dev\_err\_probe(dev, ret, "Failed to add %s IRQ chip\n", chip->name);++ domain = regmap\_irq\_get\_domain(\*data);++ return devm\_mfd\_add\_devices(dev, PLATFORM\_DEVID\_NONE, cells, n\_devs, NULL, 0, domain);+}+ static int bxtwc\_probe(struct platform\_device \*pdev) { struct device \*dev = &pdev->dev;@@ -500,14 +523,14 @@ static int bxtwc\_probe(struct platform\_device \*pdev) if (ret) return dev\_err\_probe(dev, ret, "Failed to add ADC IRQ chip\n"); - /\* Add chained IRQ handler for CHGR IRQs \*/- ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,- BXTWC\_CHGR\_LVL1\_IRQ,- IRQF\_ONESHOT,- &bxtwc\_regmap\_irq\_chip\_chgr,- &pmic->irq\_chip\_data\_chgr);+ ret = bxtwc\_add\_chained\_devices(pmic, bxt\_wc\_chgr\_dev, ARRAY\_SIZE(bxt\_wc\_chgr\_dev),+ pmic->irq\_chip\_data,+ BXTWC\_CHGR\_LVL1\_IRQ,+ IRQF\_ONESHOT,+ &bxtwc\_regmap\_irq\_chip\_chgr,+ &pmic->irq\_chip\_data\_chgr); if (ret)- return dev\_err\_probe(dev, ret, "Failed to add CHGR IRQ chip\n");+ return ret;  /\* Add chained IRQ handler for CRIT IRQs \*/ ret = bxtwc\_add\_chained\_irq\_chip(pmic, pmic->irq\_chip\_data,diff --git a/drivers/usb/typec/tcpm/wcove.c b/drivers/usb/typec/tcpm/wcove.cindex cf719307b3f6b9..60b2766a69bf8a 100644--- a/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=691333e2987dd696c877c2f0aad6174f5c670df5)+++ b/[drivers/usb/typec/tcpm/wcove.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/tcpm/wcove.c?id=87a07a5b0b296e489c606ca95ffc16c18821975b)@@ -621,10 +621,6 @@ static int wcove\_typec\_probe(struct platform\_device \*pdev) if (irq < 0) return irq; - irq = regmap\_irq\_get\_virq(pmic->irq\_chip\_data\_chgr, irq);- if (irq < 0)- return irq;- ret = guid\_parse(WCOVE\_DSM\_UUID, &wcove->guid); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:09 +0000


