=== Content from git.kernel.org_2afce7df_20250115_100039.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=43e25adc80269f917d2a195f0d59f74cdd182955)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=43e25adc80269f917d2a195f0d59f74cdd182955)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43e25adc80269f917d2a195f0d59f74cdd182955)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43e25adc80269f917d2a195f0d59f74cdd182955)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-11-05 19:23:50 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:10 +0100 |
| commit | [43e25adc80269f917d2a195f0d59f74cdd182955](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43e25adc80269f917d2a195f0d59f74cdd182955) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=43e25adc80269f917d2a195f0d59f74cdd182955)) | |
| tree | [2163c0f1a962109fc776a83350583febd16a1dde](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=43e25adc80269f917d2a195f0d59f74cdd182955) | |
| parent | [70530a2f8120ff26895f2cf6cfa7f300d5164497](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70530a2f8120ff26895f2cf6cfa7f300d5164497) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43e25adc80269f917d2a195f0d59f74cdd182955&id2=70530a2f8120ff26895f2cf6cfa7f300d5164497)) | |
| download | [linux-43e25adc80269f917d2a195f0d59f74cdd182955.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-43e25adc80269f917d2a195f0d59f74cdd182955.tar.gz) | |

ipv6: release nexthop on device removal[ Upstream commit eb02688c5c45c3e7af7e71f036a7144f5639cbfe ]
The CI is hitting some aperiodic hangup at device removal time in the
pmtu.sh self-test:
unregister\_netdevice: waiting for veth\_A-R1 to become free. Usage count = 6
ref\_tracker: veth\_A-R1@ffff888013df15d8 has 1/5 users at
dst\_init+0x84/0x4a0
dst\_alloc+0x97/0x150
ip6\_dst\_alloc+0x23/0x90
ip6\_rt\_pcpu\_alloc+0x1e6/0x520
ip6\_pol\_route+0x56f/0x840
fib6\_rule\_lookup+0x334/0x630
ip6\_route\_output\_flags+0x259/0x480
ip6\_dst\_lookup\_tail.constprop.0+0x5c2/0x940
ip6\_dst\_lookup\_flow+0x88/0x190
udp\_tunnel6\_dst\_lookup+0x2a7/0x4c0
vxlan\_xmit\_one+0xbde/0x4a50 [vxlan]
vxlan\_xmit+0x9ad/0xf20 [vxlan]
dev\_hard\_start\_xmit+0x10e/0x360
\_\_dev\_queue\_xmit+0xf95/0x18c0
arp\_solicit+0x4a2/0xe00
neigh\_probe+0xaa/0xf0
While the first suspect is the dst\_cache, explicitly tracking the dst
owing the last device reference via probes proved such dst is held by
the nexthop in the originating fib6\_info.
Similar to commit f5b51fe804ec ("ipv6: route: purge exception on
removal"), we need to explicitly release the originating fib info when
disconnecting a to-be-removed device from a live ipv6 dst: move the
fib6\_info cleanup into ip6\_dst\_ifdown().
Tested running:
./pmtu.sh cleanup\_ipv6\_exception
in a tight loop for more than 400 iterations with no spat, running an
unpatched kernel I observed a splat every ~10 iterations.
Fixes: f88d8ea67fbd ("ipv6: Plumb support for nexthop object in a fib6\_info")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/604c45c188c609b732286b47ac2a451a40f6cf6d.1730828007.git.pabeni@redhat.com](https://patch.msgid.link/604c45c188c609b732286b47ac2a451a40f6cf6d.1730828007.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43e25adc80269f917d2a195f0d59f74cdd182955)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=43e25adc80269f917d2a195f0d59f74cdd182955) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 341a42c2d6f14f..e320dfa7fe7fc7 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=70530a2f8120ff26895f2cf6cfa7f300d5164497)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=43e25adc80269f917d2a195f0d59f74cdd182955)@@ -376,6 +376,7 @@ static void ip6\_dst\_ifdown(struct dst\_entry \*dst, struct net\_device \*dev) { struct rt6\_info \*rt = (struct rt6\_info \*)dst; struct inet6\_dev \*idev = rt->rt6i\_idev;+ struct fib6\_info \*from;  if (idev && idev->dev != blackhole\_netdev) { struct inet6\_dev \*blackhole\_idev = in6\_dev\_get(blackhole\_netdev);@@ -385,6 +386,8 @@ static void ip6\_dst\_ifdown(struct dst\_entry \*dst, struct net\_device \*dev) in6\_dev\_put(idev); } }+ from = unrcu\_pointer(xchg(&rt->from, NULL));+ fib6\_info\_release(from); }  static bool \_\_rt6\_check\_expired(const struct rt6\_info \*rt)@@ -1447,7 +1450,6 @@ static DEFINE\_SPINLOCK(rt6\_exception\_lock); static void rt6\_remove\_exception(struct rt6\_exception\_bucket \*bucket, struct rt6\_exception \*rt6\_ex) {- struct fib6\_info \*from; struct net \*net;  if (!bucket || !rt6\_ex)@@ -1459,8 +1461,6 @@ static void rt6\_remove\_exception(struct rt6\_exception\_bucket \*bucket, /\* purge completely the exception to allow releasing the held resources: \* some [sk] cache may keep the dst around for unlimited time \*/- from = unrcu\_pointer(xchg(&rt6\_ex->rt6i->from, NULL));- fib6\_info\_release(from); dst\_dev\_put(&rt6\_ex->rt6i->dst);  hlist\_del\_rcu(&rt6\_ex->hlist); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:59:15 +0000



=== Content from git.kernel.org_93515295_20250115_100037.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-11-05 19:23:50 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:55 +0100 |
| commit | [0e4c6faaef8a24b762a24ffb767280e263ef8e10](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10)) | |
| tree | [76bd400db971f96f276a694d8cf699dd92697209](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10) | |
| parent | [08baa3f0a1af543330388e33c0ce52cda21d69c4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08baa3f0a1af543330388e33c0ce52cda21d69c4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10&id2=08baa3f0a1af543330388e33c0ce52cda21d69c4)) | |
| download | [linux-0e4c6faaef8a24b762a24ffb767280e263ef8e10.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0e4c6faaef8a24b762a24ffb767280e263ef8e10.tar.gz) | |

ipv6: release nexthop on device removal[ Upstream commit eb02688c5c45c3e7af7e71f036a7144f5639cbfe ]
The CI is hitting some aperiodic hangup at device removal time in the
pmtu.sh self-test:
unregister\_netdevice: waiting for veth\_A-R1 to become free. Usage count = 6
ref\_tracker: veth\_A-R1@ffff888013df15d8 has 1/5 users at
dst\_init+0x84/0x4a0
dst\_alloc+0x97/0x150
ip6\_dst\_alloc+0x23/0x90
ip6\_rt\_pcpu\_alloc+0x1e6/0x520
ip6\_pol\_route+0x56f/0x840
fib6\_rule\_lookup+0x334/0x630
ip6\_route\_output\_flags+0x259/0x480
ip6\_dst\_lookup\_tail.constprop.0+0x5c2/0x940
ip6\_dst\_lookup\_flow+0x88/0x190
udp\_tunnel6\_dst\_lookup+0x2a7/0x4c0
vxlan\_xmit\_one+0xbde/0x4a50 [vxlan]
vxlan\_xmit+0x9ad/0xf20 [vxlan]
dev\_hard\_start\_xmit+0x10e/0x360
\_\_dev\_queue\_xmit+0xf95/0x18c0
arp\_solicit+0x4a2/0xe00
neigh\_probe+0xaa/0xf0
While the first suspect is the dst\_cache, explicitly tracking the dst
owing the last device reference via probes proved such dst is held by
the nexthop in the originating fib6\_info.
Similar to commit f5b51fe804ec ("ipv6: route: purge exception on
removal"), we need to explicitly release the originating fib info when
disconnecting a to-be-removed device from a live ipv6 dst: move the
fib6\_info cleanup into ip6\_dst\_ifdown().
Tested running:
./pmtu.sh cleanup\_ipv6\_exception
in a tight loop for more than 400 iterations with no spat, running an
unpatched kernel I observed a splat every ~10 iterations.
Fixes: f88d8ea67fbd ("ipv6: Plumb support for nexthop object in a fib6\_info")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/604c45c188c609b732286b47ac2a451a40f6cf6d.1730828007.git.pabeni@redhat.com](https://patch.msgid.link/604c45c188c609b732286b47ac2a451a40f6cf6d.1730828007.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex b4251915585f75..76bea6db59764a 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=08baa3f0a1af543330388e33c0ce52cda21d69c4)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=0e4c6faaef8a24b762a24ffb767280e263ef8e10)@@ -374,6 +374,7 @@ static void ip6\_dst\_ifdown(struct dst\_entry \*dst, struct net\_device \*dev) { struct rt6\_info \*rt = dst\_rt6\_info(dst); struct inet6\_dev \*idev = rt->rt6i\_idev;+ struct fib6\_info \*from;  if (idev && idev->dev != blackhole\_netdev) { struct inet6\_dev \*blackhole\_idev = in6\_dev\_get(blackhole\_netdev);@@ -383,6 +384,8 @@ static void ip6\_dst\_ifdown(struct dst\_entry \*dst, struct net\_device \*dev) in6\_dev\_put(idev); } }+ from = unrcu\_pointer(xchg(&rt->from, NULL));+ fib6\_info\_release(from); }  static bool \_\_rt6\_check\_expired(const struct rt6\_info \*rt)@@ -1455,7 +1458,6 @@ static DEFINE\_SPINLOCK(rt6\_exception\_lock); static void rt6\_remove\_exception(struct rt6\_exception\_bucket \*bucket, struct rt6\_exception \*rt6\_ex) {- struct fib6\_info \*from; struct net \*net;  if (!bucket || !rt6\_ex)@@ -1467,8 +1469,6 @@ static void rt6\_remove\_exception(struct rt6\_exception\_bucket \*bucket, /\* purge completely the exception to allow releasing the held resources: \* some [sk] cache may keep the dst around for unlimited time \*/- from = unrcu\_pointer(xchg(&rt6\_ex->rt6i->from, NULL));- fib6\_info\_release(from); dst\_dev\_put(&rt6\_ex->rt6i->dst);  hlist\_del\_rcu(&rt6\_ex->hlist); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:59:14 +0000



=== Content from git.kernel.org_350219a3_20250115_100042.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-11-05 19:23:50 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-11-06 17:27:35 -0800 |
| commit | [eb02688c5c45c3e7af7e71f036a7144f5639cbfe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe)) | |
| tree | [2f578574c27b66ca3cbc2707e5b12fb1cfbf7545](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe) | |
| parent | [a84e8c05f58305dfa808bc5465c5175c29d7c9b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a84e8c05f58305dfa808bc5465c5175c29d7c9b6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe&id2=a84e8c05f58305dfa808bc5465c5175c29d7c9b6)) | |
| download | [linux-eb02688c5c45c3e7af7e71f036a7144f5639cbfe.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eb02688c5c45c3e7af7e71f036a7144f5639cbfe.tar.gz) | |

ipv6: release nexthop on device removalThe CI is hitting some aperiodic hangup at device removal time in the
pmtu.sh self-test:
unregister\_netdevice: waiting for veth\_A-R1 to become free. Usage count = 6
ref\_tracker: veth\_A-R1@ffff888013df15d8 has 1/5 users at
dst\_init+0x84/0x4a0
dst\_alloc+0x97/0x150
ip6\_dst\_alloc+0x23/0x90
ip6\_rt\_pcpu\_alloc+0x1e6/0x520
ip6\_pol\_route+0x56f/0x840
fib6\_rule\_lookup+0x334/0x630
ip6\_route\_output\_flags+0x259/0x480
ip6\_dst\_lookup\_tail.constprop.0+0x5c2/0x940
ip6\_dst\_lookup\_flow+0x88/0x190
udp\_tunnel6\_dst\_lookup+0x2a7/0x4c0
vxlan\_xmit\_one+0xbde/0x4a50 [vxlan]
vxlan\_xmit+0x9ad/0xf20 [vxlan]
dev\_hard\_start\_xmit+0x10e/0x360
\_\_dev\_queue\_xmit+0xf95/0x18c0
arp\_solicit+0x4a2/0xe00
neigh\_probe+0xaa/0xf0
While the first suspect is the dst\_cache, explicitly tracking the dst
owing the last device reference via probes proved such dst is held by
the nexthop in the originating fib6\_info.
Similar to commit f5b51fe804ec ("ipv6: route: purge exception on
removal"), we need to explicitly release the originating fib info when
disconnecting a to-be-removed device from a live ipv6 dst: move the
fib6\_info cleanup into ip6\_dst\_ifdown().
Tested running:
./pmtu.sh cleanup\_ipv6\_exception
in a tight loop for more than 400 iterations with no spat, running an
unpatched kernel I observed a splat every ~10 iterations.
Fixes: f88d8ea67fbd ("ipv6: Plumb support for nexthop object in a fib6\_info")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/604c45c188c609b732286b47ac2a451a40f6cf6d.1730828007.git.pabeni@redhat.com](https://patch.msgid.link/604c45c188c609b732286b47ac2a451a40f6cf6d.1730828007.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex d7ce5cf2017a57..038c1eeef0be1e 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=a84e8c05f58305dfa808bc5465c5175c29d7c9b6)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=eb02688c5c45c3e7af7e71f036a7144f5639cbfe)@@ -374,6 +374,7 @@ static void ip6\_dst\_ifdown(struct dst\_entry \*dst, struct net\_device \*dev) { struct rt6\_info \*rt = dst\_rt6\_info(dst); struct inet6\_dev \*idev = rt->rt6i\_idev;+ struct fib6\_info \*from;  if (idev && idev->dev != blackhole\_netdev) { struct inet6\_dev \*blackhole\_idev = in6\_dev\_get(blackhole\_netdev);@@ -383,6 +384,8 @@ static void ip6\_dst\_ifdown(struct dst\_entry \*dst, struct net\_device \*dev) in6\_dev\_put(idev); } }+ from = unrcu\_pointer(xchg(&rt->from, NULL));+ fib6\_info\_release(from); }  static bool \_\_rt6\_check\_expired(const struct rt6\_info \*rt)@@ -1455,7 +1458,6 @@ static DEFINE\_SPINLOCK(rt6\_exception\_lock); static void rt6\_remove\_exception(struct rt6\_exception\_bucket \*bucket, struct rt6\_exception \*rt6\_ex) {- struct fib6\_info \*from; struct net \*net;  if (!bucket || !rt6\_ex)@@ -1467,8 +1469,6 @@ static void rt6\_remove\_exception(struct rt6\_exception\_bucket \*bucket, /\* purge completely the exception to allow releasing the held resources: \* some [sk] cache may keep the dst around for unlimited time \*/- from = unrcu\_pointer(xchg(&rt6\_ex->rt6i->from, NULL));- fib6\_info\_release(from); dst\_dev\_put(&rt6\_ex->rt6i->dst);  hlist\_del\_rcu(&rt6\_ex->hlist); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:59:20 +0000



=== Content from git.kernel.org_e16681be_20250115_100041.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b2f26a27ea3f72f75d18330f76f5d1007c791848)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b2f26a27ea3f72f75d18330f76f5d1007c791848)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2f26a27ea3f72f75d18330f76f5d1007c791848)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2f26a27ea3f72f75d18330f76f5d1007c791848)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-11-05 19:23:50 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:33 +0100 |
| commit | [b2f26a27ea3f72f75d18330f76f5d1007c791848](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2f26a27ea3f72f75d18330f76f5d1007c791848) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b2f26a27ea3f72f75d18330f76f5d1007c791848)) | |
| tree | [0e07df220f92e6e3cb5d95dad93c2edddc71854a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b2f26a27ea3f72f75d18330f76f5d1007c791848) | |
| parent | [ad3c88eb3cc53f881cbbf41d584a9451c5d0e7e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad3c88eb3cc53f881cbbf41d584a9451c5d0e7e4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2f26a27ea3f72f75d18330f76f5d1007c791848&id2=ad3c88eb3cc53f881cbbf41d584a9451c5d0e7e4)) | |
| download | [linux-b2f26a27ea3f72f75d18330f76f5d1007c791848.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b2f26a27ea3f72f75d18330f76f5d1007c791848.tar.gz) | |

ipv6: release nexthop on device removal[ Upstream commit eb02688c5c45c3e7af7e71f036a7144f5639cbfe ]
The CI is hitting some aperiodic hangup at device removal time in the
pmtu.sh self-test:
unregister\_netdevice: waiting for veth\_A-R1 to become free. Usage count = 6
ref\_tracker: veth\_A-R1@ffff888013df15d8 has 1/5 users at
dst\_init+0x84/0x4a0
dst\_alloc+0x97/0x150
ip6\_dst\_alloc+0x23/0x90
ip6\_rt\_pcpu\_alloc+0x1e6/0x520
ip6\_pol\_route+0x56f/0x840
fib6\_rule\_lookup+0x334/0x630
ip6\_route\_output\_flags+0x259/0x480
ip6\_dst\_lookup\_tail.constprop.0+0x5c2/0x940
ip6\_dst\_lookup\_flow+0x88/0x190
udp\_tunnel6\_dst\_lookup+0x2a7/0x4c0
vxlan\_xmit\_one+0xbde/0x4a50 [vxlan]
vxlan\_xmit+0x9ad/0xf20 [vxlan]
dev\_hard\_start\_xmit+0x10e/0x360
\_\_dev\_queue\_xmit+0xf95/0x18c0
arp\_solicit+0x4a2/0xe00
neigh\_probe+0xaa/0xf0
While the first suspect is the dst\_cache, explicitly tracking the dst
owing the last device reference via probes proved such dst is held by
the nexthop in the originating fib6\_info.
Similar to commit f5b51fe804ec ("ipv6: route: purge exception on
removal"), we need to explicitly release the originating fib info when
disconnecting a to-be-removed device from a live ipv6 dst: move the
fib6\_info cleanup into ip6\_dst\_ifdown().
Tested running:
./pmtu.sh cleanup\_ipv6\_exception
in a tight loop for more than 400 iterations with no spat, running an
unpatched kernel I observed a splat every ~10 iterations.
Fixes: f88d8ea67fbd ("ipv6: Plumb support for nexthop object in a fib6\_info")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/604c45c188c609b732286b47ac2a451a40f6cf6d.1730828007.git.pabeni@redhat.com](https://patch.msgid.link/604c45c188c609b732286b47ac2a451a40f6cf6d.1730828007.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b2f26a27ea3f72f75d18330f76f5d1007c791848)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=b2f26a27ea3f72f75d18330f76f5d1007c791848) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex 10e7517d126d98..5da0c83a3ee8f5 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=ad3c88eb3cc53f881cbbf41d584a9451c5d0e7e4)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=b2f26a27ea3f72f75d18330f76f5d1007c791848)@@ -378,6 +378,7 @@ static void ip6\_dst\_ifdown(struct dst\_entry \*dst, struct net\_device \*dev, { struct rt6\_info \*rt = (struct rt6\_info \*)dst; struct inet6\_dev \*idev = rt->rt6i\_idev;+ struct fib6\_info \*from;  if (idev && idev->dev != blackhole\_netdev) { struct inet6\_dev \*blackhole\_idev = in6\_dev\_get(blackhole\_netdev);@@ -387,6 +388,8 @@ static void ip6\_dst\_ifdown(struct dst\_entry \*dst, struct net\_device \*dev, in6\_dev\_put(idev); } }+ from = unrcu\_pointer(xchg(&rt->from, NULL));+ fib6\_info\_release(from); }  static bool \_\_rt6\_check\_expired(const struct rt6\_info \*rt)@@ -1449,7 +1452,6 @@ static DEFINE\_SPINLOCK(rt6\_exception\_lock); static void rt6\_remove\_exception(struct rt6\_exception\_bucket \*bucket, struct rt6\_exception \*rt6\_ex) {- struct fib6\_info \*from; struct net \*net;  if (!bucket || !rt6\_ex)@@ -1461,8 +1463,6 @@ static void rt6\_remove\_exception(struct rt6\_exception\_bucket \*bucket, /\* purge completely the exception to allow releasing the held resources: \* some [sk] cache may keep the dst around for unlimited time \*/- from = unrcu\_pointer(xchg(&rt6\_ex->rt6i->from, NULL));- fib6\_info\_release(from); dst\_dev\_put(&rt6\_ex->rt6i->dst);  hlist\_del\_rcu(&rt6\_ex->hlist); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:59:18 +0000



=== Content from git.kernel.org_b93894cb_20250115_100040.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a3c3f8a4d025acc8c857246ec2b812c59102487a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3c3f8a4d025acc8c857246ec2b812c59102487a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3c3f8a4d025acc8c857246ec2b812c59102487a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3c3f8a4d025acc8c857246ec2b812c59102487a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-11-05 19:23:50 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:23 +0100 |
| commit | [a3c3f8a4d025acc8c857246ec2b812c59102487a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3c3f8a4d025acc8c857246ec2b812c59102487a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a3c3f8a4d025acc8c857246ec2b812c59102487a)) | |
| tree | [f5ba2ce49dd015cdf92b2438d9ec8ad0f8b4cd8d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3c3f8a4d025acc8c857246ec2b812c59102487a) | |
| parent | [0edec6f93e355a8ec593a26ea4ccf2a08b3bd624](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0edec6f93e355a8ec593a26ea4ccf2a08b3bd624) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3c3f8a4d025acc8c857246ec2b812c59102487a&id2=0edec6f93e355a8ec593a26ea4ccf2a08b3bd624)) | |
| download | [linux-a3c3f8a4d025acc8c857246ec2b812c59102487a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a3c3f8a4d025acc8c857246ec2b812c59102487a.tar.gz) | |

ipv6: release nexthop on device removal[ Upstream commit eb02688c5c45c3e7af7e71f036a7144f5639cbfe ]
The CI is hitting some aperiodic hangup at device removal time in the
pmtu.sh self-test:
unregister\_netdevice: waiting for veth\_A-R1 to become free. Usage count = 6
ref\_tracker: veth\_A-R1@ffff888013df15d8 has 1/5 users at
dst\_init+0x84/0x4a0
dst\_alloc+0x97/0x150
ip6\_dst\_alloc+0x23/0x90
ip6\_rt\_pcpu\_alloc+0x1e6/0x520
ip6\_pol\_route+0x56f/0x840
fib6\_rule\_lookup+0x334/0x630
ip6\_route\_output\_flags+0x259/0x480
ip6\_dst\_lookup\_tail.constprop.0+0x5c2/0x940
ip6\_dst\_lookup\_flow+0x88/0x190
udp\_tunnel6\_dst\_lookup+0x2a7/0x4c0
vxlan\_xmit\_one+0xbde/0x4a50 [vxlan]
vxlan\_xmit+0x9ad/0xf20 [vxlan]
dev\_hard\_start\_xmit+0x10e/0x360
\_\_dev\_queue\_xmit+0xf95/0x18c0
arp\_solicit+0x4a2/0xe00
neigh\_probe+0xaa/0xf0
While the first suspect is the dst\_cache, explicitly tracking the dst
owing the last device reference via probes proved such dst is held by
the nexthop in the originating fib6\_info.
Similar to commit f5b51fe804ec ("ipv6: route: purge exception on
removal"), we need to explicitly release the originating fib info when
disconnecting a to-be-removed device from a live ipv6 dst: move the
fib6\_info cleanup into ip6\_dst\_ifdown().
Tested running:
./pmtu.sh cleanup\_ipv6\_exception
in a tight loop for more than 400 iterations with no spat, running an
unpatched kernel I observed a splat every ~10 iterations.
Fixes: f88d8ea67fbd ("ipv6: Plumb support for nexthop object in a fib6\_info")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/604c45c188c609b732286b47ac2a451a40f6cf6d.1730828007.git.pabeni@redhat.com](https://patch.msgid.link/604c45c188c609b732286b47ac2a451a40f6cf6d.1730828007.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3c3f8a4d025acc8c857246ec2b812c59102487a)

| -rw-r--r-- | [net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/route.c?id=a3c3f8a4d025acc8c857246ec2b812c59102487a) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/net/ipv6/route.c b/net/ipv6/route.cindex b4dcd8f3e7baba..606cdd87745a6a 100644--- a/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=0edec6f93e355a8ec593a26ea4ccf2a08b3bd624)+++ b/[net/ipv6/route.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/route.c?id=a3c3f8a4d025acc8c857246ec2b812c59102487a)@@ -374,6 +374,7 @@ static void ip6\_dst\_ifdown(struct dst\_entry \*dst, struct net\_device \*dev) { struct rt6\_info \*rt = dst\_rt6\_info(dst); struct inet6\_dev \*idev = rt->rt6i\_idev;+ struct fib6\_info \*from;  if (idev && idev->dev != blackhole\_netdev) { struct inet6\_dev \*blackhole\_idev = in6\_dev\_get(blackhole\_netdev);@@ -383,6 +384,8 @@ static void ip6\_dst\_ifdown(struct dst\_entry \*dst, struct net\_device \*dev) in6\_dev\_put(idev); } }+ from = unrcu\_pointer(xchg(&rt->from, NULL));+ fib6\_info\_release(from); }  static bool \_\_rt6\_check\_expired(const struct rt6\_info \*rt)@@ -1455,7 +1458,6 @@ static DEFINE\_SPINLOCK(rt6\_exception\_lock); static void rt6\_remove\_exception(struct rt6\_exception\_bucket \*bucket, struct rt6\_exception \*rt6\_ex) {- struct fib6\_info \*from; struct net \*net;  if (!bucket || !rt6\_ex)@@ -1467,8 +1469,6 @@ static void rt6\_remove\_exception(struct rt6\_exception\_bucket \*bucket, /\* purge completely the exception to allow releasing the held resources: \* some [sk] cache may keep the dst around for unlimited time \*/- from = unrcu\_pointer(xchg(&rt6\_ex->rt6i->from, NULL));- fib6\_info\_release(from); dst\_dev\_put(&rt6\_ex->rt6i->dst);  hlist\_del\_rcu(&rt6\_ex->hlist); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:59:17 +0000


