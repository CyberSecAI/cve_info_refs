=== Content from git.kernel.org_f4468ef8_20250115_102319.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=87651f31ae4e6e6e7e6c7270b9b469405e747407)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=87651f31ae4e6e6e7e6c7270b9b469405e747407)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87651f31ae4e6e6e7e6c7270b9b469405e747407)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87651f31ae4e6e6e7e6c7270b9b469405e747407)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-11-22 16:19:17 +0000 |
| --- | --- | --- |
| committer | Thomas Hellström <thomas.hellstrom@linux.intel.com> | 2024-11-28 15:22:36 +0100 |
| commit | [87651f31ae4e6e6e7e6c7270b9b469405e747407](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87651f31ae4e6e6e7e6c7270b9b469405e747407) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=87651f31ae4e6e6e7e6c7270b9b469405e747407)) | |
| tree | [e561349bebe300ed3c8f2da2fe3ed03f76d44e91](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=87651f31ae4e6e6e7e6c7270b9b469405e747407) | |
| parent | [6965f91a000a24b2c25480a92696a007545d97ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6965f91a000a24b2c25480a92696a007545d97ec) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87651f31ae4e6e6e7e6c7270b9b469405e747407&id2=6965f91a000a24b2c25480a92696a007545d97ec)) | |
| download | [linux-87651f31ae4e6e6e7e6c7270b9b469405e747407.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-87651f31ae4e6e6e7e6c7270b9b469405e747407.tar.gz) | |

drm/xe/guc\_submit: fix race around suspend\_pendingCurrently in some testcases we can trigger:
xe 0000:03:00.0: [drm] Assertion `exec\_queue\_destroyed(q)` failed!
....
WARNING: CPU: 18 PID: 2640 at drivers/gpu/drm/xe/xe\_guc\_submit.c:1826 xe\_guc\_sched\_done\_handler+0xa54/0xef0 [xe]
xe 0000:03:00.0: [drm] \*ERROR\* GT1: DEREGISTER\_DONE: Unexpected engine state 0x00a1, guc\_id=57
Looking at a snippet of corresponding ftrace for this GuC id we can see:
162.673311: xe\_sched\_msg\_add: dev=0000:03:00.0, gt=1 guc\_id=57, opcode=3
162.673317: xe\_sched\_msg\_recv: dev=0000:03:00.0, gt=1 guc\_id=57, opcode=3
162.673319: xe\_exec\_queue\_scheduling\_disable: dev=0000:03:00.0, 1:0x2, gt=1, width=1, guc\_id=57, guc\_state=0x29, flags=0x0
162.674089: xe\_exec\_queue\_kill: dev=0000:03:00.0, 1:0x2, gt=1, width=1, guc\_id=57, guc\_state=0x29, flags=0x0
162.674108: xe\_exec\_queue\_close: dev=0000:03:00.0, 1:0x2, gt=1, width=1, guc\_id=57, guc\_state=0xa9, flags=0x0
162.674488: xe\_exec\_queue\_scheduling\_done: dev=0000:03:00.0, 1:0x2, gt=1, width=1, guc\_id=57, guc\_state=0xa9, flags=0x0
162.678452: xe\_exec\_queue\_deregister: dev=0000:03:00.0, 1:0x2, gt=1, width=1, guc\_id=57, guc\_state=0xa1, flags=0x0
It looks like we try to suspend the queue (opcode=3), setting
suspend\_pending and triggering a disable\_scheduling. The user then
closes the queue. However the close will also forcefully signal the
suspend fence after killing the queue, later when the G2H response for
disable\_scheduling comes back we have now cleared suspend\_pending when
signalling the suspend fence, so the disable\_scheduling now incorrectly
tries to also deregister the queue. This leads to warnings since the queue
has yet to even be marked for destruction. We also seem to trigger
errors later with trying to double unregister the same queue.
To fix this tweak the ordering when handling the response to ensure we
don't race with a disable\_scheduling that didn't actually intend to
perform an unregister. The destruction path should now also correctly
wait for any pending\_disable before marking as destroyed.
Fixes: dd08ebf6c352 ("drm/xe: Introduce a new DRM driver for Intel GPUs")
Closes: https://gitlab.freedesktop.org/drm/xe/kernel/-/issues/3371
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Matthew Brost <matthew.brost@intel.com>
Cc: <stable@vger.kernel.org> # v6.8+
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20241122161914.321263-6-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20241122161914.321263-6-matthew.auld%40intel.com)
(cherry picked from commit f161809b362f027b6d72bd998e47f8f0bad60a2e)
Signed-off-by: Thomas Hellström <thomas.hellstrom@linux.intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=87651f31ae4e6e6e7e6c7270b9b469405e747407)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_guc_submit.c?id=87651f31ae4e6e6e7e6c7270b9b469405e747407) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_guc\_submit.c b/drivers/gpu/drm/xe/xe\_guc\_submit.cindex ebc85d98b02534..5f3ef8b1f19498 100644--- a/[drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_submit.c?id=6965f91a000a24b2c25480a92696a007545d97ec)+++ b/[drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_submit.c?id=87651f31ae4e6e6e7e6c7270b9b469405e747407)@@ -1871,16 +1871,29 @@ static void handle\_sched\_done(struct xe\_guc \*guc, struct xe\_exec\_queue \*q, xe\_gt\_assert(guc\_to\_gt(guc), runnable\_state == 0); xe\_gt\_assert(guc\_to\_gt(guc), exec\_queue\_pending\_disable(q)); - clear\_exec\_queue\_pending\_disable(q); if (q->guc->suspend\_pending) { suspend\_fence\_signal(q);+ clear\_exec\_queue\_pending\_disable(q); } else { if (exec\_queue\_banned(q) || check\_timeout) { smp\_wmb(); wake\_up\_all(&guc->ct.wq); }- if (!check\_timeout)+ if (!check\_timeout && exec\_queue\_destroyed(q)) {+ /\*+ \* Make sure to clear the pending\_disable only+ \* after sampling the destroyed state. We want+ \* to ensure we don't trigger the unregister too+ \* early with something intending to only+ \* disable scheduling. The caller doing the+ \* destroy must wait for an ongoing+ \* pending\_disable before marking as destroyed.+ \*/+ clear\_exec\_queue\_pending\_disable(q); deregister\_exec\_queue(guc, q);+ } else {+ clear\_exec\_queue\_pending\_disable(q);+ } } } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:21:55 +0000



=== Content from git.kernel.org_1091d43f_20250115_102316.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-11-22 16:19:17 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:41:14 +0100 |
| commit | [5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd)) | |
| tree | [8e5c6d2700d4f7830fdc43c706a1131d6fb7a318](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd) | |
| parent | [1c052c66461f0bf6a6fcc6273999e9b93db54856](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c052c66461f0bf6a6fcc6273999e9b93db54856) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd&id2=1c052c66461f0bf6a6fcc6273999e9b93db54856)) | |
| download | [linux-5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd.tar.gz) | |

drm/xe/guc\_submit: fix race around suspend\_pendingcommit 87651f31ae4e6e6e7e6c7270b9b469405e747407 upstream.
Currently in some testcases we can trigger:
xe 0000:03:00.0: [drm] Assertion `exec\_queue\_destroyed(q)` failed!
....
WARNING: CPU: 18 PID: 2640 at drivers/gpu/drm/xe/xe\_guc\_submit.c:1826 xe\_guc\_sched\_done\_handler+0xa54/0xef0 [xe]
xe 0000:03:00.0: [drm] \*ERROR\* GT1: DEREGISTER\_DONE: Unexpected engine state 0x00a1, guc\_id=57
Looking at a snippet of corresponding ftrace for this GuC id we can see:
162.673311: xe\_sched\_msg\_add: dev=0000:03:00.0, gt=1 guc\_id=57, opcode=3
162.673317: xe\_sched\_msg\_recv: dev=0000:03:00.0, gt=1 guc\_id=57, opcode=3
162.673319: xe\_exec\_queue\_scheduling\_disable: dev=0000:03:00.0, 1:0x2, gt=1, width=1, guc\_id=57, guc\_state=0x29, flags=0x0
162.674089: xe\_exec\_queue\_kill: dev=0000:03:00.0, 1:0x2, gt=1, width=1, guc\_id=57, guc\_state=0x29, flags=0x0
162.674108: xe\_exec\_queue\_close: dev=0000:03:00.0, 1:0x2, gt=1, width=1, guc\_id=57, guc\_state=0xa9, flags=0x0
162.674488: xe\_exec\_queue\_scheduling\_done: dev=0000:03:00.0, 1:0x2, gt=1, width=1, guc\_id=57, guc\_state=0xa9, flags=0x0
162.678452: xe\_exec\_queue\_deregister: dev=0000:03:00.0, 1:0x2, gt=1, width=1, guc\_id=57, guc\_state=0xa1, flags=0x0
It looks like we try to suspend the queue (opcode=3), setting
suspend\_pending and triggering a disable\_scheduling. The user then
closes the queue. However the close will also forcefully signal the
suspend fence after killing the queue, later when the G2H response for
disable\_scheduling comes back we have now cleared suspend\_pending when
signalling the suspend fence, so the disable\_scheduling now incorrectly
tries to also deregister the queue. This leads to warnings since the queue
has yet to even be marked for destruction. We also seem to trigger
errors later with trying to double unregister the same queue.
To fix this tweak the ordering when handling the response to ensure we
don't race with a disable\_scheduling that didn't actually intend to
perform an unregister. The destruction path should now also correctly
wait for any pending\_disable before marking as destroyed.
Fixes: dd08ebf6c352 ("drm/xe: Introduce a new DRM driver for Intel GPUs")
Closes: https://gitlab.freedesktop.org/drm/xe/kernel/-/issues/3371
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Matthew Brost <matthew.brost@intel.com>
Cc: <stable@vger.kernel.org> # v6.8+
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20241122161914.321263-6-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20241122161914.321263-6-matthew.auld%40intel.com)
(cherry picked from commit f161809b362f027b6d72bd998e47f8f0bad60a2e)
Signed-off-by: Thomas Hellström <thomas.hellstrom@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_guc_submit.c?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_guc\_submit.c b/drivers/gpu/drm/xe/xe\_guc\_submit.cindex 4f5d00aea7168b..2927745d689549 100644--- a/[drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_submit.c?id=1c052c66461f0bf6a6fcc6273999e9b93db54856)+++ b/[drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_submit.c?id=5ddcb50b700221fa7d7be2adcb3d7d7afe8633dd)@@ -1846,16 +1846,29 @@ static void handle\_sched\_done(struct xe\_guc \*guc, struct xe\_exec\_queue \*q, xe\_gt\_assert(guc\_to\_gt(guc), runnable\_state == 0); xe\_gt\_assert(guc\_to\_gt(guc), exec\_queue\_pending\_disable(q)); - clear\_exec\_queue\_pending\_disable(q); if (q->guc->suspend\_pending) { suspend\_fence\_signal(q);+ clear\_exec\_queue\_pending\_disable(q); } else { if (exec\_queue\_banned(q) || check\_timeout) { smp\_wmb(); wake\_up\_all(&guc->ct.wq); }- if (!check\_timeout)+ if (!check\_timeout && exec\_queue\_destroyed(q)) {+ /\*+ \* Make sure to clear the pending\_disable only+ \* after sampling the destroyed state. We want+ \* to ensure we don't trigger the unregister too+ \* early with something intending to only+ \* disable scheduling. The caller doing the+ \* destroy must wait for an ongoing+ \* pending\_disable before marking as destroyed.+ \*/+ clear\_exec\_queue\_pending\_disable(q); deregister\_exec\_queue(guc, q);+ } else {+ clear\_exec\_queue\_pending\_disable(q);+ } } } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:21:52 +0000


