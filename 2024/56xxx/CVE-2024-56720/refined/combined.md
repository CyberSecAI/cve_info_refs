=== Content from git.kernel.org_4fa2e264_20250114_182241.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-11-06 22:25:19 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:09 +0100 |
| commit | [98c7ea7d11f2588e8197db042e0291e4ac8f8346](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346)) | |
| tree | [23a758b19e6c8dacc87ba078e46173876690b264](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346) | |
| parent | [a53ad8ab116d5bfb2bbcbb080f73355717d358be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a53ad8ab116d5bfb2bbcbb080f73355717d358be) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346&id2=a53ad8ab116d5bfb2bbcbb080f73355717d358be)) | |
| download | [linux-98c7ea7d11f2588e8197db042e0291e4ac8f8346.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-98c7ea7d11f2588e8197db042e0291e4ac8f8346.tar.gz) | |

bpf, sockmap: Several fixes to bpf\_msg\_pop\_data[ Upstream commit 5d609ba262475db450ba69b8e8a557bd768ac07a ]
Several fixes to bpf\_msg\_pop\_data,
1. In sk\_msg\_shift\_left, we should put\_page
2. if (len == 0), return early is better
3. pop the entire sk\_msg (last == msg->sg.size) should be supported
4. Fix for the value of variable "a"
5. In sk\_msg\_shift\_left, after shifting, i has already pointed to the next
element. Addtional sk\_msg\_iter\_var\_next may result in BUG.
Fixes: 7246d8ed4dcc ("bpf: helper to pop data from messages")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang@bytedance.com](https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang%40bytedance.com)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346)

| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 6 deletions

| diff --git a/net/core/filter.c b/net/core/filter.cindex 62092948b390fc..c223e072b35e92 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=a53ad8ab116d5bfb2bbcbb080f73355717d358be)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=98c7ea7d11f2588e8197db042e0291e4ac8f8346)@@ -2902,8 +2902,10 @@ static const struct bpf\_func\_proto bpf\_msg\_push\_data\_proto = {  static void sk\_msg\_shift\_left(struct sk\_msg \*msg, int i) {+ struct scatterlist \*sge = sk\_msg\_elem(msg, i); int prev; + put\_page(sg\_page(sge)); do { prev = i; sk\_msg\_iter\_var\_next(i);@@ -2940,6 +2942,9 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(flags)) return -EINVAL; + if (unlikely(len == 0))+ return 0;+ /\* First find the starting scatterlist element \*/ i = msg->sg.start; do {@@ -2952,7 +2957,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, } while (i != msg->sg.end);  /\* Bounds checks: start and pop must be inside message \*/- if (start >= offset + l || last >= msg->sg.size)+ if (start >= offset + l || last > msg->sg.size) return -EINVAL;  space = MAX\_MSG\_FRAGS - sk\_msg\_elem\_used(msg);@@ -2981,12 +2986,12 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, \*/ if (start != offset) { struct scatterlist \*nsge, \*sge = sk\_msg\_elem(msg, i);- int a = start;+ int a = start - offset; int b = sge->length - pop - a;  sk\_msg\_iter\_var\_next(i); - if (pop < sge->length - a) {+ if (b > 0) { if (space) { sge->length = a; sk\_msg\_shift\_right(msg, i);@@ -3005,7 +3010,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(!page)) return -ENOMEM; - sge->length = a; orig = sg\_page(sge); from = sg\_virt(sge); to = page\_address(page);@@ -3015,7 +3019,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, put\_page(orig); } pop = 0;- } else if (pop >= sge->length - a) {+ } else { pop -= (sge->length - a); sge->length = a; }@@ -3049,7 +3053,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, pop -= sge->length; sk\_msg\_shift\_left(msg, i); }- sk\_msg\_iter\_var\_next(i); }  sk\_mem\_uncharge(msg->sk, len - pop); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:21:18 +0000



=== Content from git.kernel.org_0549bdc0_20250114_182243.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d3f5763b3062514a234114e97bbde74d8d702449)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3f5763b3062514a234114e97bbde74d8d702449)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3f5763b3062514a234114e97bbde74d8d702449)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3f5763b3062514a234114e97bbde74d8d702449)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-11-06 22:25:19 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:27 +0100 |
| commit | [d3f5763b3062514a234114e97bbde74d8d702449](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3f5763b3062514a234114e97bbde74d8d702449) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d3f5763b3062514a234114e97bbde74d8d702449)) | |
| tree | [760fdcbfa5cd145b07e53b64f1084c7d5e9dae8d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3f5763b3062514a234114e97bbde74d8d702449) | |
| parent | [962932ee621ac5a347713175d459f9f48f5bbb9a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=962932ee621ac5a347713175d459f9f48f5bbb9a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3f5763b3062514a234114e97bbde74d8d702449&id2=962932ee621ac5a347713175d459f9f48f5bbb9a)) | |
| download | [linux-d3f5763b3062514a234114e97bbde74d8d702449.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d3f5763b3062514a234114e97bbde74d8d702449.tar.gz) | |

bpf, sockmap: Several fixes to bpf\_msg\_pop\_data[ Upstream commit 5d609ba262475db450ba69b8e8a557bd768ac07a ]
Several fixes to bpf\_msg\_pop\_data,
1. In sk\_msg\_shift\_left, we should put\_page
2. if (len == 0), return early is better
3. pop the entire sk\_msg (last == msg->sg.size) should be supported
4. Fix for the value of variable "a"
5. In sk\_msg\_shift\_left, after shifting, i has already pointed to the next
element. Addtional sk\_msg\_iter\_var\_next may result in BUG.
Fixes: 7246d8ed4dcc ("bpf: helper to pop data from messages")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang@bytedance.com](https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang%40bytedance.com)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3f5763b3062514a234114e97bbde74d8d702449)

| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=d3f5763b3062514a234114e97bbde74d8d702449) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/net/core/filter.c b/net/core/filter.cindex 1fe76d49d7f2c4..5c9b7c270739f7 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=962932ee621ac5a347713175d459f9f48f5bbb9a)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=d3f5763b3062514a234114e97bbde74d8d702449)@@ -2518,8 +2518,10 @@ static const struct bpf\_func\_proto bpf\_msg\_push\_data\_proto = {  static void sk\_msg\_shift\_left(struct sk\_msg \*msg, int i) {+ struct scatterlist \*sge = sk\_msg\_elem(msg, i); int prev; + put\_page(sg\_page(sge)); do { prev = i; sk\_msg\_iter\_var\_next(i);@@ -2571,7 +2573,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, } while (i != msg->sg.end);  /\* Bounds checks: start and pop must be inside message \*/- if (start >= offset + l || last >= msg->sg.size)+ if (start >= offset + l || last > msg->sg.size) return -EINVAL;  space = MAX\_MSG\_FRAGS - sk\_msg\_elem\_used(msg);@@ -2600,12 +2602,12 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, \*/ if (start != offset) { struct scatterlist \*nsge, \*sge = sk\_msg\_elem(msg, i);- int a = start;+ int a = start - offset; int b = sge->length - pop - a;  sk\_msg\_iter\_var\_next(i); - if (pop < sge->length - a) {+ if (b > 0) { if (space) { sge->length = a; sk\_msg\_shift\_right(msg, i);@@ -2624,7 +2626,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(!page)) return -ENOMEM; - sge->length = a; orig = sg\_page(sge); from = sg\_virt(sge); to = page\_address(page);@@ -2634,7 +2635,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, put\_page(orig); } pop = 0;- } else if (pop >= sge->length - a) {+ } else { pop -= (sge->length - a); sge->length = a; }@@ -2668,7 +2669,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, pop -= sge->length; sk\_msg\_shift\_left(msg, i); }- sk\_msg\_iter\_var\_next(i); }  sk\_mem\_uncharge(msg->sk, len - pop); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:21:20 +0000



=== Content from git.kernel.org_6286b098_20250114_182240.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5d609ba262475db450ba69b8e8a557bd768ac07a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d609ba262475db450ba69b8e8a557bd768ac07a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d609ba262475db450ba69b8e8a557bd768ac07a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d609ba262475db450ba69b8e8a557bd768ac07a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-11-06 22:25:19 +0000 |
| --- | --- | --- |
| committer | Martin KaFai Lau <martin.lau@kernel.org> | 2024-11-06 16:01:53 -0800 |
| commit | [5d609ba262475db450ba69b8e8a557bd768ac07a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d609ba262475db450ba69b8e8a557bd768ac07a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5d609ba262475db450ba69b8e8a557bd768ac07a)) | |
| tree | [74808609f30b5ff5386490d1a11549480913a61d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d609ba262475db450ba69b8e8a557bd768ac07a) | |
| parent | [15ab0548e3107665c34579ae523b2b6e7c22082a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15ab0548e3107665c34579ae523b2b6e7c22082a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d609ba262475db450ba69b8e8a557bd768ac07a&id2=15ab0548e3107665c34579ae523b2b6e7c22082a)) | |
| download | [linux-5d609ba262475db450ba69b8e8a557bd768ac07a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5d609ba262475db450ba69b8e8a557bd768ac07a.tar.gz) | |

bpf, sockmap: Several fixes to bpf\_msg\_pop\_dataSeveral fixes to bpf\_msg\_pop\_data,
1. In sk\_msg\_shift\_left, we should put\_page
2. if (len == 0), return early is better
3. pop the entire sk\_msg (last == msg->sg.size) should be supported
4. Fix for the value of variable "a"
5. In sk\_msg\_shift\_left, after shifting, i has already pointed to the next
element. Addtional sk\_msg\_iter\_var\_next may result in BUG.
Fixes: 7246d8ed4dcc ("bpf: helper to pop data from messages")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang@bytedance.com](https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang%40bytedance.com)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d609ba262475db450ba69b8e8a557bd768ac07a)

| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=5d609ba262475db450ba69b8e8a557bd768ac07a) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 6 deletions

| diff --git a/net/core/filter.c b/net/core/filter.cindex 255d58bae2a900..2fdba950b57515 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=15ab0548e3107665c34579ae523b2b6e7c22082a)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=5d609ba262475db450ba69b8e8a557bd768ac07a)@@ -2904,8 +2904,10 @@ static const struct bpf\_func\_proto bpf\_msg\_push\_data\_proto = {  static void sk\_msg\_shift\_left(struct sk\_msg \*msg, int i) {+ struct scatterlist \*sge = sk\_msg\_elem(msg, i); int prev; + put\_page(sg\_page(sge)); do { prev = i; sk\_msg\_iter\_var\_next(i);@@ -2942,6 +2944,9 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(flags)) return -EINVAL; + if (unlikely(len == 0))+ return 0;+ /\* First find the starting scatterlist element \*/ i = msg->sg.start; do {@@ -2954,7 +2959,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, } while (i != msg->sg.end);  /\* Bounds checks: start and pop must be inside message \*/- if (start >= offset + l || last >= msg->sg.size)+ if (start >= offset + l || last > msg->sg.size) return -EINVAL;  space = MAX\_MSG\_FRAGS - sk\_msg\_elem\_used(msg);@@ -2983,12 +2988,12 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, \*/ if (start != offset) { struct scatterlist \*nsge, \*sge = sk\_msg\_elem(msg, i);- int a = start;+ int a = start - offset; int b = sge->length - pop - a;  sk\_msg\_iter\_var\_next(i); - if (pop < sge->length - a) {+ if (b > 0) { if (space) { sge->length = a; sk\_msg\_shift\_right(msg, i);@@ -3007,7 +3012,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(!page)) return -ENOMEM; - sge->length = a; orig = sg\_page(sge); from = sg\_virt(sge); to = page\_address(page);@@ -3017,7 +3021,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, put\_page(orig); } pop = 0;- } else if (pop >= sge->length - a) {+ } else { pop -= (sge->length - a); sge->length = a; }@@ -3051,7 +3055,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, pop -= sge->length; sk\_msg\_shift\_left(msg, i); }- sk\_msg\_iter\_var\_next(i); }  sk\_mem\_uncharge(msg->sk, len - pop); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:21:17 +0000



=== Content from git.kernel.org_7b181e5a_20250114_182239.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-11-06 22:25:19 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:55 +0100 |
| commit | [275a9f3ef8fabb0cb282a62b9e164dedba7284c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5)) | |
| tree | [454c885c645115f788f9eeb3565aa325f628214a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5) | |
| parent | [ce06c450acb5d94c9acf36a018d649df128f779f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce06c450acb5d94c9acf36a018d649df128f779f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5&id2=ce06c450acb5d94c9acf36a018d649df128f779f)) | |
| download | [linux-275a9f3ef8fabb0cb282a62b9e164dedba7284c5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-275a9f3ef8fabb0cb282a62b9e164dedba7284c5.tar.gz) | |

bpf, sockmap: Several fixes to bpf\_msg\_pop\_data[ Upstream commit 5d609ba262475db450ba69b8e8a557bd768ac07a ]
Several fixes to bpf\_msg\_pop\_data,
1. In sk\_msg\_shift\_left, we should put\_page
2. if (len == 0), return early is better
3. pop the entire sk\_msg (last == msg->sg.size) should be supported
4. Fix for the value of variable "a"
5. In sk\_msg\_shift\_left, after shifting, i has already pointed to the next
element. Addtional sk\_msg\_iter\_var\_next may result in BUG.
Fixes: 7246d8ed4dcc ("bpf: helper to pop data from messages")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang@bytedance.com](https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang%40bytedance.com)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5)

| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 6 deletions

| diff --git a/net/core/filter.c b/net/core/filter.cindex 0315ebbabe728d..60c6e1e4662bdd 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=ce06c450acb5d94c9acf36a018d649df128f779f)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=275a9f3ef8fabb0cb282a62b9e164dedba7284c5)@@ -2921,8 +2921,10 @@ static const struct bpf\_func\_proto bpf\_msg\_push\_data\_proto = {  static void sk\_msg\_shift\_left(struct sk\_msg \*msg, int i) {+ struct scatterlist \*sge = sk\_msg\_elem(msg, i); int prev; + put\_page(sg\_page(sge)); do { prev = i; sk\_msg\_iter\_var\_next(i);@@ -2959,6 +2961,9 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(flags)) return -EINVAL; + if (unlikely(len == 0))+ return 0;+ /\* First find the starting scatterlist element \*/ i = msg->sg.start; do {@@ -2971,7 +2976,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, } while (i != msg->sg.end);  /\* Bounds checks: start and pop must be inside message \*/- if (start >= offset + l || last >= msg->sg.size)+ if (start >= offset + l || last > msg->sg.size) return -EINVAL;  space = MAX\_MSG\_FRAGS - sk\_msg\_elem\_used(msg);@@ -3000,12 +3005,12 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, \*/ if (start != offset) { struct scatterlist \*nsge, \*sge = sk\_msg\_elem(msg, i);- int a = start;+ int a = start - offset; int b = sge->length - pop - a;  sk\_msg\_iter\_var\_next(i); - if (pop < sge->length - a) {+ if (b > 0) { if (space) { sge->length = a; sk\_msg\_shift\_right(msg, i);@@ -3024,7 +3029,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(!page)) return -ENOMEM; - sge->length = a; orig = sg\_page(sge); from = sg\_virt(sge); to = page\_address(page);@@ -3034,7 +3038,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, put\_page(orig); } pop = 0;- } else if (pop >= sge->length - a) {+ } else { pop -= (sge->length - a); sge->length = a; }@@ -3068,7 +3072,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, pop -= sge->length; sk\_msg\_shift\_left(msg, i); }- sk\_msg\_iter\_var\_next(i); }  sk\_mem\_uncharge(msg->sk, len - pop); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:21:17 +0000



=== Content from git.kernel.org_9a08f0e6_20250114_182242.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d26d977633d1d0b8bf9407278189bd0a8d973323)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d26d977633d1d0b8bf9407278189bd0a8d973323)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d26d977633d1d0b8bf9407278189bd0a8d973323)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d26d977633d1d0b8bf9407278189bd0a8d973323)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-11-06 22:25:19 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:55 +0100 |
| commit | [d26d977633d1d0b8bf9407278189bd0a8d973323](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d26d977633d1d0b8bf9407278189bd0a8d973323) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d26d977633d1d0b8bf9407278189bd0a8d973323)) | |
| tree | [62dd417719ad850c652d83729f7a4540286bf071](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d26d977633d1d0b8bf9407278189bd0a8d973323) | |
| parent | [2b4530ecc01846827883fbae9738f77e7f73c1dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b4530ecc01846827883fbae9738f77e7f73c1dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d26d977633d1d0b8bf9407278189bd0a8d973323&id2=2b4530ecc01846827883fbae9738f77e7f73c1dd)) | |
| download | [linux-d26d977633d1d0b8bf9407278189bd0a8d973323.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d26d977633d1d0b8bf9407278189bd0a8d973323.tar.gz) | |

bpf, sockmap: Several fixes to bpf\_msg\_pop\_data[ Upstream commit 5d609ba262475db450ba69b8e8a557bd768ac07a ]
Several fixes to bpf\_msg\_pop\_data,
1. In sk\_msg\_shift\_left, we should put\_page
2. if (len == 0), return early is better
3. pop the entire sk\_msg (last == msg->sg.size) should be supported
4. Fix for the value of variable "a"
5. In sk\_msg\_shift\_left, after shifting, i has already pointed to the next
element. Addtional sk\_msg\_iter\_var\_next may result in BUG.
Fixes: 7246d8ed4dcc ("bpf: helper to pop data from messages")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang@bytedance.com](https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang%40bytedance.com)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d26d977633d1d0b8bf9407278189bd0a8d973323)

| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=d26d977633d1d0b8bf9407278189bd0a8d973323) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 6 deletions

| diff --git a/net/core/filter.c b/net/core/filter.cindex 0ef77fb72af782..345e6c5c71f063 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=2b4530ecc01846827883fbae9738f77e7f73c1dd)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=d26d977633d1d0b8bf9407278189bd0a8d973323)@@ -2900,8 +2900,10 @@ static const struct bpf\_func\_proto bpf\_msg\_push\_data\_proto = {  static void sk\_msg\_shift\_left(struct sk\_msg \*msg, int i) {+ struct scatterlist \*sge = sk\_msg\_elem(msg, i); int prev; + put\_page(sg\_page(sge)); do { prev = i; sk\_msg\_iter\_var\_next(i);@@ -2938,6 +2940,9 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(flags)) return -EINVAL; + if (unlikely(len == 0))+ return 0;+ /\* First find the starting scatterlist element \*/ i = msg->sg.start; do {@@ -2950,7 +2955,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, } while (i != msg->sg.end);  /\* Bounds checks: start and pop must be inside message \*/- if (start >= offset + l || last >= msg->sg.size)+ if (start >= offset + l || last > msg->sg.size) return -EINVAL;  space = MAX\_MSG\_FRAGS - sk\_msg\_elem\_used(msg);@@ -2979,12 +2984,12 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, \*/ if (start != offset) { struct scatterlist \*nsge, \*sge = sk\_msg\_elem(msg, i);- int a = start;+ int a = start - offset; int b = sge->length - pop - a;  sk\_msg\_iter\_var\_next(i); - if (pop < sge->length - a) {+ if (b > 0) { if (space) { sge->length = a; sk\_msg\_shift\_right(msg, i);@@ -3003,7 +3008,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(!page)) return -ENOMEM; - sge->length = a; orig = sg\_page(sge); from = sg\_virt(sge); to = page\_address(page);@@ -3013,7 +3017,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, put\_page(orig); } pop = 0;- } else if (pop >= sge->length - a) {+ } else { pop -= (sge->length - a); sge->length = a; }@@ -3047,7 +3051,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, pop -= sge->length; sk\_msg\_shift\_left(msg, i); }- sk\_msg\_iter\_var\_next(i); }  sk\_mem\_uncharge(msg->sk, len - pop); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:21:20 +0000



=== Content from git.kernel.org_40abae1d_20250114_182244.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-11-06 22:25:19 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:58 +0100 |
| commit | [e1f54c61c4c9a5244eb8159dce60d248f7d97b32](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32)) | |
| tree | [e3e9ef76d33ae81e5e034762e704e67d5f8b975a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32) | |
| parent | [0f8db9b3693004c8cfe9ddb5e80b64a0db338a87](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f8db9b3693004c8cfe9ddb5e80b64a0db338a87) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32&id2=0f8db9b3693004c8cfe9ddb5e80b64a0db338a87)) | |
| download | [linux-e1f54c61c4c9a5244eb8159dce60d248f7d97b32.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e1f54c61c4c9a5244eb8159dce60d248f7d97b32.tar.gz) | |

bpf, sockmap: Several fixes to bpf\_msg\_pop\_data[ Upstream commit 5d609ba262475db450ba69b8e8a557bd768ac07a ]
Several fixes to bpf\_msg\_pop\_data,
1. In sk\_msg\_shift\_left, we should put\_page
2. if (len == 0), return early is better
3. pop the entire sk\_msg (last == msg->sg.size) should be supported
4. Fix for the value of variable "a"
5. In sk\_msg\_shift\_left, after shifting, i has already pointed to the next
element. Addtional sk\_msg\_iter\_var\_next may result in BUG.
Fixes: 7246d8ed4dcc ("bpf: helper to pop data from messages")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang@bytedance.com](https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang%40bytedance.com)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32)

| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 6 deletions

| diff --git a/net/core/filter.c b/net/core/filter.cindex c5d15fceee6dae..8b51f57aaa251f 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=0f8db9b3693004c8cfe9ddb5e80b64a0db338a87)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=e1f54c61c4c9a5244eb8159dce60d248f7d97b32)@@ -2883,8 +2883,10 @@ static const struct bpf\_func\_proto bpf\_msg\_push\_data\_proto = {  static void sk\_msg\_shift\_left(struct sk\_msg \*msg, int i) {+ struct scatterlist \*sge = sk\_msg\_elem(msg, i); int prev; + put\_page(sg\_page(sge)); do { prev = i; sk\_msg\_iter\_var\_next(i);@@ -2921,6 +2923,9 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(flags)) return -EINVAL; + if (unlikely(len == 0))+ return 0;+ /\* First find the starting scatterlist element \*/ i = msg->sg.start; do {@@ -2933,7 +2938,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, } while (i != msg->sg.end);  /\* Bounds checks: start and pop must be inside message \*/- if (start >= offset + l || last >= msg->sg.size)+ if (start >= offset + l || last > msg->sg.size) return -EINVAL;  space = MAX\_MSG\_FRAGS - sk\_msg\_elem\_used(msg);@@ -2962,12 +2967,12 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, \*/ if (start != offset) { struct scatterlist \*nsge, \*sge = sk\_msg\_elem(msg, i);- int a = start;+ int a = start - offset; int b = sge->length - pop - a;  sk\_msg\_iter\_var\_next(i); - if (pop < sge->length - a) {+ if (b > 0) { if (space) { sge->length = a; sk\_msg\_shift\_right(msg, i);@@ -2986,7 +2991,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(!page)) return -ENOMEM; - sge->length = a; orig = sg\_page(sge); from = sg\_virt(sge); to = page\_address(page);@@ -2996,7 +3000,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, put\_page(orig); } pop = 0;- } else if (pop >= sge->length - a) {+ } else { pop -= (sge->length - a); sge->length = a; }@@ -3030,7 +3034,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, pop -= sge->length; sk\_msg\_shift\_left(msg, i); }- sk\_msg\_iter\_var\_next(i); }  sk\_mem\_uncharge(msg->sk, len - pop); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:21:21 +0000



=== Content from git.kernel.org_ef8e49c8_20250114_182245.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-11-06 22:25:19 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:32 +0100 |
| commit | [f58d3aa457e77a3d9b3df2ab081dcf9950f6029f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f)) | |
| tree | [db3051da1ea8581f7da707e46f1db57bf2ed12c4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f) | |
| parent | [cadfa4d23f52b0f13e702ad08de92014756fba55](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cadfa4d23f52b0f13e702ad08de92014756fba55) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f&id2=cadfa4d23f52b0f13e702ad08de92014756fba55)) | |
| download | [linux-f58d3aa457e77a3d9b3df2ab081dcf9950f6029f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f58d3aa457e77a3d9b3df2ab081dcf9950f6029f.tar.gz) | |

bpf, sockmap: Several fixes to bpf\_msg\_pop\_data[ Upstream commit 5d609ba262475db450ba69b8e8a557bd768ac07a ]
Several fixes to bpf\_msg\_pop\_data,
1. In sk\_msg\_shift\_left, we should put\_page
2. if (len == 0), return early is better
3. pop the entire sk\_msg (last == msg->sg.size) should be supported
4. Fix for the value of variable "a"
5. In sk\_msg\_shift\_left, after shifting, i has already pointed to the next
element. Addtional sk\_msg\_iter\_var\_next may result in BUG.
Fixes: 7246d8ed4dcc ("bpf: helper to pop data from messages")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang@bytedance.com](https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang%40bytedance.com)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f)

| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 6 deletions

| diff --git a/net/core/filter.c b/net/core/filter.cindex b4ed0d9177818f..5174f4d48647f7 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=cadfa4d23f52b0f13e702ad08de92014756fba55)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=f58d3aa457e77a3d9b3df2ab081dcf9950f6029f)@@ -2894,8 +2894,10 @@ static const struct bpf\_func\_proto bpf\_msg\_push\_data\_proto = {  static void sk\_msg\_shift\_left(struct sk\_msg \*msg, int i) {+ struct scatterlist \*sge = sk\_msg\_elem(msg, i); int prev; + put\_page(sg\_page(sge)); do { prev = i; sk\_msg\_iter\_var\_next(i);@@ -2932,6 +2934,9 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(flags)) return -EINVAL; + if (unlikely(len == 0))+ return 0;+ /\* First find the starting scatterlist element \*/ i = msg->sg.start; do {@@ -2944,7 +2949,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, } while (i != msg->sg.end);  /\* Bounds checks: start and pop must be inside message \*/- if (start >= offset + l || last >= msg->sg.size)+ if (start >= offset + l || last > msg->sg.size) return -EINVAL;  space = MAX\_MSG\_FRAGS - sk\_msg\_elem\_used(msg);@@ -2973,12 +2978,12 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, \*/ if (start != offset) { struct scatterlist \*nsge, \*sge = sk\_msg\_elem(msg, i);- int a = start;+ int a = start - offset; int b = sge->length - pop - a;  sk\_msg\_iter\_var\_next(i); - if (pop < sge->length - a) {+ if (b > 0) { if (space) { sge->length = a; sk\_msg\_shift\_right(msg, i);@@ -2997,7 +3002,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(!page)) return -ENOMEM; - sge->length = a; orig = sg\_page(sge); from = sg\_virt(sge); to = page\_address(page);@@ -3007,7 +3011,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, put\_page(orig); } pop = 0;- } else if (pop >= sge->length - a) {+ } else { pop -= (sge->length - a); sge->length = a; }@@ -3041,7 +3045,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, pop -= sge->length; sk\_msg\_shift\_left(msg, i); }- sk\_msg\_iter\_var\_next(i); }  sk\_mem\_uncharge(msg->sk, len - pop); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:21:22 +0000



=== Content from git.kernel.org_c41ac2c2_20250114_182241.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zijian Zhang <zijianzhang@bytedance.com> | 2024-11-06 22:25:19 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:23 +0100 |
| commit | [785180bed9879680d8e5c5e1b54c8ae8d948f4c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8)) | |
| tree | [4bf72259c683d1a637d7755dcb4e004f4dd5835b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8) | |
| parent | [1a0d5c17d5ce1019aa2a48b4e6a7b4ce877382c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a0d5c17d5ce1019aa2a48b4e6a7b4ce877382c9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8&id2=1a0d5c17d5ce1019aa2a48b4e6a7b4ce877382c9)) | |
| download | [linux-785180bed9879680d8e5c5e1b54c8ae8d948f4c8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-785180bed9879680d8e5c5e1b54c8ae8d948f4c8.tar.gz) | |

bpf, sockmap: Several fixes to bpf\_msg\_pop\_data[ Upstream commit 5d609ba262475db450ba69b8e8a557bd768ac07a ]
Several fixes to bpf\_msg\_pop\_data,
1. In sk\_msg\_shift\_left, we should put\_page
2. if (len == 0), return early is better
3. pop the entire sk\_msg (last == msg->sg.size) should be supported
4. Fix for the value of variable "a"
5. In sk\_msg\_shift\_left, after shifting, i has already pointed to the next
element. Addtional sk\_msg\_iter\_var\_next may result in BUG.
Fixes: 7246d8ed4dcc ("bpf: helper to pop data from messages")
Signed-off-by: Zijian Zhang <zijianzhang@bytedance.com>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Link: [https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang@bytedance.com](https://lore.kernel.org/r/20241106222520.527076-8-zijianzhang%40bytedance.com)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8)

| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 6 deletions

| diff --git a/net/core/filter.c b/net/core/filter.cindex b7597f8d4159c4..3c136631fda897 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=1a0d5c17d5ce1019aa2a48b4e6a7b4ce877382c9)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=785180bed9879680d8e5c5e1b54c8ae8d948f4c8)@@ -2920,8 +2920,10 @@ static const struct bpf\_func\_proto bpf\_msg\_push\_data\_proto = {  static void sk\_msg\_shift\_left(struct sk\_msg \*msg, int i) {+ struct scatterlist \*sge = sk\_msg\_elem(msg, i); int prev; + put\_page(sg\_page(sge)); do { prev = i; sk\_msg\_iter\_var\_next(i);@@ -2958,6 +2960,9 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(flags)) return -EINVAL; + if (unlikely(len == 0))+ return 0;+ /\* First find the starting scatterlist element \*/ i = msg->sg.start; do {@@ -2970,7 +2975,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, } while (i != msg->sg.end);  /\* Bounds checks: start and pop must be inside message \*/- if (start >= offset + l || last >= msg->sg.size)+ if (start >= offset + l || last > msg->sg.size) return -EINVAL;  space = MAX\_MSG\_FRAGS - sk\_msg\_elem\_used(msg);@@ -2999,12 +3004,12 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, \*/ if (start != offset) { struct scatterlist \*nsge, \*sge = sk\_msg\_elem(msg, i);- int a = start;+ int a = start - offset; int b = sge->length - pop - a;  sk\_msg\_iter\_var\_next(i); - if (pop < sge->length - a) {+ if (b > 0) { if (space) { sge->length = a; sk\_msg\_shift\_right(msg, i);@@ -3023,7 +3028,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, if (unlikely(!page)) return -ENOMEM; - sge->length = a; orig = sg\_page(sge); from = sg\_virt(sge); to = page\_address(page);@@ -3033,7 +3037,7 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, put\_page(orig); } pop = 0;- } else if (pop >= sge->length - a) {+ } else { pop -= (sge->length - a); sge->length = a; }@@ -3067,7 +3071,6 @@ BPF\_CALL\_4(bpf\_msg\_pop\_data, struct sk\_msg \*, msg, u32, start, pop -= sge->length; sk\_msg\_shift\_left(msg, i); }- sk\_msg\_iter\_var\_next(i); }  sk\_mem\_uncharge(msg->sk, len - pop); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:21:18 +0000


