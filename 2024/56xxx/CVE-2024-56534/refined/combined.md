=== Content from git.kernel.org_fd75d345_20250114_230331.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hao Ge <gehao@kylinos.cn> | 2024-11-06 16:28:41 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:22 +0100 |
| commit | [34f090ddb3630a26e5a6b220bf3bfaf5c7b70393](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393)) | |
| tree | [2158cb83cdbb13611cee39a7647201dda2a89059](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393) | |
| parent | [60623296b142f46ca5c7367c64e5be3e4b431424](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60623296b142f46ca5c7367c64e5be3e4b431424) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393&id2=60623296b142f46ca5c7367c64e5be3e4b431424)) | |
| download | [linux-34f090ddb3630a26e5a6b220bf3bfaf5c7b70393.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-34f090ddb3630a26e5a6b220bf3bfaf5c7b70393.tar.gz) | |

isofs: avoid memory leak in iocharset[ Upstream commit 0b5bbeee4de616a268db77e2f40f19ab010a367b ]
A memleak was found as below:
unreferenced object 0xffff0000d10164d8 (size 8):
comm "pool-udisksd", pid 108217, jiffies 4295408555
hex dump (first 8 bytes):
75 74 66 38 00 cc cc cc utf8....
backtrace (crc de430d31):
[<ffff800081046e6c>] kmemleak\_alloc+0xb8/0xc8
[<ffff8000803e6c3c>] \_\_kmalloc\_node\_track\_caller\_noprof+0x380/0x474
[<ffff800080363b74>] kstrdup+0x70/0xfc
[<ffff80007bb3c6a4>] isofs\_parse\_param+0x228/0x2c0 [isofs]
[<ffff8000804d7f68>] vfs\_parse\_fs\_param+0xf4/0x164
[<ffff8000804d8064>] vfs\_parse\_fs\_string+0x8c/0xd4
[<ffff8000804d815c>] vfs\_parse\_monolithic\_sep+0xb0/0xfc
[<ffff8000804d81d8>] generic\_parse\_monolithic+0x30/0x3c
[<ffff8000804d8bfc>] parse\_monolithic\_mount\_data+0x40/0x4c
[<ffff8000804b6a64>] path\_mount+0x6c4/0x9ec
[<ffff8000804b6e38>] do\_mount+0xac/0xc4
[<ffff8000804b7494>] \_\_arm64\_sys\_mount+0x16c/0x2b0
[<ffff80008002b8dc>] invoke\_syscall+0x7c/0x104
[<ffff80008002ba44>] el0\_svc\_common.constprop.1+0xe0/0x104
[<ffff80008002ba94>] do\_el0\_svc+0x2c/0x38
[<ffff800081041108>] el0\_svc+0x3c/0x1b8
The opt->iocharset is freed inside the isofs\_fill\_super function,
But there may be situations where it's not possible to
enter this function.
For example, in the get\_tree\_bdev\_flags function,when
encountering the situation where "Can't mount, would change RO state,"
In such a case, isofs\_fill\_super will not have the opportunity
to be called,which means that opt->iocharset will not have the chance
to be freed,ultimately leading to a memory leak.
Let's move the memory freeing of opt->iocharset into
isofs\_free\_fc function.
Fixes: 1b17a46c9243 ("isofs: convert isofs to use the new mount API")
Signed-off-by: Hao Ge <gehao@kylinos.cn>
Reviewed-by: Eric Sandeen <sandeen@redhat.com>
Signed-off-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20241106082841.51773-1-hao.ge@linux.dev](https://patch.msgid.link/20241106082841.51773-1-hao.ge%40linux.dev)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393)

| -rw-r--r-- | [fs/isofs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/isofs/inode.c?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/fs/isofs/inode.c b/fs/isofs/inode.cindex f50311a6b4299d..47038e6608123c 100644--- a/[fs/isofs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/isofs/inode.c?id=60623296b142f46ca5c7367c64e5be3e4b431424)+++ b/[fs/isofs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/isofs/inode.c?id=34f090ddb3630a26e5a6b220bf3bfaf5c7b70393)@@ -948,8 +948,6 @@ root\_found: goto out\_no\_inode; } - kfree(opt->iocharset);- return 0;  /\*@@ -987,7 +985,6 @@ out\_freebh: brelse(bh); brelse(pri\_bh); out\_freesbi:- kfree(opt->iocharset); kfree(sbi); s->s\_fs\_info = NULL; return error;@@ -1528,7 +1525,10 @@ static int isofs\_get\_tree(struct fs\_context \*fc)  static void isofs\_free\_fc(struct fs\_context \*fc) {- kfree(fc->fs\_private);+ struct isofs\_options \*opt = fc->fs\_private;++ kfree(opt->iocharset);+ kfree(opt); }  static const struct fs\_context\_operations isofs\_context\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:02:08 +0000



=== Content from git.kernel.org_0d69365d_20250114_230329.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0b5bbeee4de616a268db77e2f40f19ab010a367b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b5bbeee4de616a268db77e2f40f19ab010a367b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b5bbeee4de616a268db77e2f40f19ab010a367b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b5bbeee4de616a268db77e2f40f19ab010a367b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hao Ge <gehao@kylinos.cn> | 2024-11-06 16:28:41 +0800 |
| --- | --- | --- |
| committer | Jan Kara <jack@suse.cz> | 2024-11-06 20:24:41 +0100 |
| commit | [0b5bbeee4de616a268db77e2f40f19ab010a367b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b5bbeee4de616a268db77e2f40f19ab010a367b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0b5bbeee4de616a268db77e2f40f19ab010a367b)) | |
| tree | [9a92405a1fe282853134f84b7b1c286a0a6a186c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b5bbeee4de616a268db77e2f40f19ab010a367b) | |
| parent | [2e1b3cc9d7f790145a80cb705b168f05dab65df2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e1b3cc9d7f790145a80cb705b168f05dab65df2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b5bbeee4de616a268db77e2f40f19ab010a367b&id2=2e1b3cc9d7f790145a80cb705b168f05dab65df2)) | |
| download | [linux-0b5bbeee4de616a268db77e2f40f19ab010a367b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0b5bbeee4de616a268db77e2f40f19ab010a367b.tar.gz) | |

isofs: avoid memory leak in iocharsetA memleak was found as below:
unreferenced object 0xffff0000d10164d8 (size 8):
comm "pool-udisksd", pid 108217, jiffies 4295408555
hex dump (first 8 bytes):
75 74 66 38 00 cc cc cc utf8....
backtrace (crc de430d31):
[<ffff800081046e6c>] kmemleak\_alloc+0xb8/0xc8
[<ffff8000803e6c3c>] \_\_kmalloc\_node\_track\_caller\_noprof+0x380/0x474
[<ffff800080363b74>] kstrdup+0x70/0xfc
[<ffff80007bb3c6a4>] isofs\_parse\_param+0x228/0x2c0 [isofs]
[<ffff8000804d7f68>] vfs\_parse\_fs\_param+0xf4/0x164
[<ffff8000804d8064>] vfs\_parse\_fs\_string+0x8c/0xd4
[<ffff8000804d815c>] vfs\_parse\_monolithic\_sep+0xb0/0xfc
[<ffff8000804d81d8>] generic\_parse\_monolithic+0x30/0x3c
[<ffff8000804d8bfc>] parse\_monolithic\_mount\_data+0x40/0x4c
[<ffff8000804b6a64>] path\_mount+0x6c4/0x9ec
[<ffff8000804b6e38>] do\_mount+0xac/0xc4
[<ffff8000804b7494>] \_\_arm64\_sys\_mount+0x16c/0x2b0
[<ffff80008002b8dc>] invoke\_syscall+0x7c/0x104
[<ffff80008002ba44>] el0\_svc\_common.constprop.1+0xe0/0x104
[<ffff80008002ba94>] do\_el0\_svc+0x2c/0x38
[<ffff800081041108>] el0\_svc+0x3c/0x1b8
The opt->iocharset is freed inside the isofs\_fill\_super function,
But there may be situations where it's not possible to
enter this function.
For example, in the get\_tree\_bdev\_flags function,when
encountering the situation where "Can't mount, would change RO state,"
In such a case, isofs\_fill\_super will not have the opportunity
to be called,which means that opt->iocharset will not have the chance
to be freed,ultimately leading to a memory leak.
Let's move the memory freeing of opt->iocharset into
isofs\_free\_fc function.
Fixes: 1b17a46c9243 ("isofs: convert isofs to use the new mount API")
Signed-off-by: Hao Ge <gehao@kylinos.cn>
Reviewed-by: Eric Sandeen <sandeen@redhat.com>
Signed-off-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20241106082841.51773-1-hao.ge@linux.dev](https://patch.msgid.link/20241106082841.51773-1-hao.ge%40linux.dev)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b5bbeee4de616a268db77e2f40f19ab010a367b)

| -rw-r--r-- | [fs/isofs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/isofs/inode.c?id=0b5bbeee4de616a268db77e2f40f19ab010a367b) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/fs/isofs/inode.c b/fs/isofs/inode.cindex f50311a6b4299d..47038e6608123c 100644--- a/[fs/isofs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/isofs/inode.c?id=2e1b3cc9d7f790145a80cb705b168f05dab65df2)+++ b/[fs/isofs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/isofs/inode.c?id=0b5bbeee4de616a268db77e2f40f19ab010a367b)@@ -948,8 +948,6 @@ root\_found: goto out\_no\_inode; } - kfree(opt->iocharset);- return 0;  /\*@@ -987,7 +985,6 @@ out\_freebh: brelse(bh); brelse(pri\_bh); out\_freesbi:- kfree(opt->iocharset); kfree(sbi); s->s\_fs\_info = NULL; return error;@@ -1528,7 +1525,10 @@ static int isofs\_get\_tree(struct fs\_context \*fc)  static void isofs\_free\_fc(struct fs\_context \*fc) {- kfree(fc->fs\_private);+ struct isofs\_options \*opt = fc->fs\_private;++ kfree(opt->iocharset);+ kfree(opt); }  static const struct fs\_context\_operations isofs\_context\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:02:07 +0000



=== Content from git.kernel.org_efd37e74_20250114_230330.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0fbab266ca8000333c966f5b58cb9b9cac658573)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0fbab266ca8000333c966f5b58cb9b9cac658573)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fbab266ca8000333c966f5b58cb9b9cac658573)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0fbab266ca8000333c966f5b58cb9b9cac658573)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hao Ge <gehao@kylinos.cn> | 2024-11-06 16:28:41 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:54 +0100 |
| commit | [0fbab266ca8000333c966f5b58cb9b9cac658573](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fbab266ca8000333c966f5b58cb9b9cac658573) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0fbab266ca8000333c966f5b58cb9b9cac658573)) | |
| tree | [55743867c359a8d51de1c969edac5932670c59b7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0fbab266ca8000333c966f5b58cb9b9cac658573) | |
| parent | [63b2cc96026193294d18bc7be8d6e4b0a354ae75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63b2cc96026193294d18bc7be8d6e4b0a354ae75) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0fbab266ca8000333c966f5b58cb9b9cac658573&id2=63b2cc96026193294d18bc7be8d6e4b0a354ae75)) | |
| download | [linux-0fbab266ca8000333c966f5b58cb9b9cac658573.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0fbab266ca8000333c966f5b58cb9b9cac658573.tar.gz) | |

isofs: avoid memory leak in iocharset[ Upstream commit 0b5bbeee4de616a268db77e2f40f19ab010a367b ]
A memleak was found as below:
unreferenced object 0xffff0000d10164d8 (size 8):
comm "pool-udisksd", pid 108217, jiffies 4295408555
hex dump (first 8 bytes):
75 74 66 38 00 cc cc cc utf8....
backtrace (crc de430d31):
[<ffff800081046e6c>] kmemleak\_alloc+0xb8/0xc8
[<ffff8000803e6c3c>] \_\_kmalloc\_node\_track\_caller\_noprof+0x380/0x474
[<ffff800080363b74>] kstrdup+0x70/0xfc
[<ffff80007bb3c6a4>] isofs\_parse\_param+0x228/0x2c0 [isofs]
[<ffff8000804d7f68>] vfs\_parse\_fs\_param+0xf4/0x164
[<ffff8000804d8064>] vfs\_parse\_fs\_string+0x8c/0xd4
[<ffff8000804d815c>] vfs\_parse\_monolithic\_sep+0xb0/0xfc
[<ffff8000804d81d8>] generic\_parse\_monolithic+0x30/0x3c
[<ffff8000804d8bfc>] parse\_monolithic\_mount\_data+0x40/0x4c
[<ffff8000804b6a64>] path\_mount+0x6c4/0x9ec
[<ffff8000804b6e38>] do\_mount+0xac/0xc4
[<ffff8000804b7494>] \_\_arm64\_sys\_mount+0x16c/0x2b0
[<ffff80008002b8dc>] invoke\_syscall+0x7c/0x104
[<ffff80008002ba44>] el0\_svc\_common.constprop.1+0xe0/0x104
[<ffff80008002ba94>] do\_el0\_svc+0x2c/0x38
[<ffff800081041108>] el0\_svc+0x3c/0x1b8
The opt->iocharset is freed inside the isofs\_fill\_super function,
But there may be situations where it's not possible to
enter this function.
For example, in the get\_tree\_bdev\_flags function,when
encountering the situation where "Can't mount, would change RO state,"
In such a case, isofs\_fill\_super will not have the opportunity
to be called,which means that opt->iocharset will not have the chance
to be freed,ultimately leading to a memory leak.
Let's move the memory freeing of opt->iocharset into
isofs\_free\_fc function.
Fixes: 1b17a46c9243 ("isofs: convert isofs to use the new mount API")
Signed-off-by: Hao Ge <gehao@kylinos.cn>
Reviewed-by: Eric Sandeen <sandeen@redhat.com>
Signed-off-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20241106082841.51773-1-hao.ge@linux.dev](https://patch.msgid.link/20241106082841.51773-1-hao.ge%40linux.dev)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0fbab266ca8000333c966f5b58cb9b9cac658573)

| -rw-r--r-- | [fs/isofs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/isofs/inode.c?id=0fbab266ca8000333c966f5b58cb9b9cac658573) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/fs/isofs/inode.c b/fs/isofs/inode.cindex f50311a6b4299d..47038e6608123c 100644--- a/[fs/isofs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/isofs/inode.c?id=63b2cc96026193294d18bc7be8d6e4b0a354ae75)+++ b/[fs/isofs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/isofs/inode.c?id=0fbab266ca8000333c966f5b58cb9b9cac658573)@@ -948,8 +948,6 @@ root\_found: goto out\_no\_inode; } - kfree(opt->iocharset);- return 0;  /\*@@ -987,7 +985,6 @@ out\_freebh: brelse(bh); brelse(pri\_bh); out\_freesbi:- kfree(opt->iocharset); kfree(sbi); s->s\_fs\_info = NULL; return error;@@ -1528,7 +1525,10 @@ static int isofs\_get\_tree(struct fs\_context \*fc)  static void isofs\_free\_fc(struct fs\_context \*fc) {- kfree(fc->fs\_private);+ struct isofs\_options \*opt = fc->fs\_private;++ kfree(opt->iocharset);+ kfree(opt); }  static const struct fs\_context\_operations isofs\_context\_ops = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:02:07 +0000


