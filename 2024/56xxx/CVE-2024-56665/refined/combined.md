=== Content from git.kernel.org_ecaa0221_20250115_093612.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Olsa <jolsa@kernel.org> | 2024-12-08 15:25:07 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:11:25 +0100 |
| commit | [c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d)) | |
| tree | [4e0f5c9a3117d6e7c593b26e2ad7401fb5a4379e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d) | |
| parent | [68d23ee1bdf1c7ce499897d738033d67db46fffa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68d23ee1bdf1c7ce499897d738033d67db46fffa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d&id2=68d23ee1bdf1c7ce499897d738033d67db46fffa)) | |
| download | [linux-c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d.tar.gz) | |

bpf,perf: Fix invalid prog\_array access in perf\_event\_detach\_bpf\_progcommit 978c4486cca5c7b9253d3ab98a88c8e769cb9bbd upstream.
Syzbot reported [1] crash that happens for following tracing scenario:
- create tracepoint perf event with attr.inherit=1, attach it to the
process and set bpf program to it
- attached process forks -> chid creates inherited event
the new child event shares the parent's bpf program and tp\_event
(hence prog\_array) which is global for tracepoint
- exit both process and its child -> release both events
- first perf\_event\_detach\_bpf\_prog call will release tp\_event->prog\_array
and second perf\_event\_detach\_bpf\_prog will crash, because
tp\_event->prog\_array is NULL
The fix makes sure the perf\_event\_detach\_bpf\_prog checks prog\_array
is valid before it tries to remove the bpf program from it.
[1] https://lore.kernel.org/bpf/Z1MR6dCIKajNS6nU@krava/T/#m91dbf0688221ec7a7fc95e896a7ef9ff93b0b8ad
Fixes: 0ee288e69d03 ("bpf,perf: Fix perf\_event\_detach\_bpf\_prog error handling")
Reported-by: syzbot+2e0d2840414ce817aaac@syzkaller.appspotmail.com
Signed-off-by: Jiri Olsa <jolsa@kernel.org>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Link: [https://lore.kernel.org/bpf/20241208142507.1207698-1-jolsa@kernel.org](https://lore.kernel.org/bpf/20241208142507.1207698-1-jolsa%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d)

| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex 99b8c2cf217a21..aab43ba3daeb51 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=68d23ee1bdf1c7ce499897d738033d67db46fffa)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=c2b6b47662d5f2dfce92e5ffbdcac8229f321d9d)@@ -2216,6 +2216,9 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) goto unlock;  old\_array = bpf\_event\_rcu\_dereference(event->tp\_event->prog\_array);+ if (!old\_array)+ goto put;+ ret = bpf\_prog\_array\_copy(old\_array, event->prog, NULL, 0, &new\_array); if (ret < 0) { bpf\_prog\_array\_delete\_safe(old\_array, event->prog);@@ -2224,6 +2227,7 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) bpf\_prog\_array\_free\_sleepable(old\_array); } +put: /\* \* It could be that the bpf\_prog is not sleepable (and will be freed \* via normal RCU), but is called from a point that supports sleepable |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:49 +0000



=== Content from git.kernel.org_b34c24e9_20250115_093611.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=842e5af282453983586e2eae3c8eaf252de5f22f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=842e5af282453983586e2eae3c8eaf252de5f22f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=842e5af282453983586e2eae3c8eaf252de5f22f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=842e5af282453983586e2eae3c8eaf252de5f22f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Olsa <jolsa@kernel.org> | 2024-12-08 15:25:07 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:08:51 +0100 |
| commit | [842e5af282453983586e2eae3c8eaf252de5f22f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=842e5af282453983586e2eae3c8eaf252de5f22f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=842e5af282453983586e2eae3c8eaf252de5f22f)) | |
| tree | [d9cd93af4e5d95504f35f86f6084f3a9e5af8960](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=842e5af282453983586e2eae3c8eaf252de5f22f) | |
| parent | [ccab6aad139a2a50d1557a0dd1e1bea4634a52e3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ccab6aad139a2a50d1557a0dd1e1bea4634a52e3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=842e5af282453983586e2eae3c8eaf252de5f22f&id2=ccab6aad139a2a50d1557a0dd1e1bea4634a52e3)) | |
| download | [linux-842e5af282453983586e2eae3c8eaf252de5f22f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-842e5af282453983586e2eae3c8eaf252de5f22f.tar.gz) | |

bpf,perf: Fix invalid prog\_array access in perf\_event\_detach\_bpf\_progcommit 978c4486cca5c7b9253d3ab98a88c8e769cb9bbd upstream.
Syzbot reported [1] crash that happens for following tracing scenario:
- create tracepoint perf event with attr.inherit=1, attach it to the
process and set bpf program to it
- attached process forks -> chid creates inherited event
the new child event shares the parent's bpf program and tp\_event
(hence prog\_array) which is global for tracepoint
- exit both process and its child -> release both events
- first perf\_event\_detach\_bpf\_prog call will release tp\_event->prog\_array
and second perf\_event\_detach\_bpf\_prog will crash, because
tp\_event->prog\_array is NULL
The fix makes sure the perf\_event\_detach\_bpf\_prog checks prog\_array
is valid before it tries to remove the bpf program from it.
[1] https://lore.kernel.org/bpf/Z1MR6dCIKajNS6nU@krava/T/#m91dbf0688221ec7a7fc95e896a7ef9ff93b0b8ad
Fixes: 0ee288e69d03 ("bpf,perf: Fix perf\_event\_detach\_bpf\_prog error handling")
Reported-by: syzbot+2e0d2840414ce817aaac@syzkaller.appspotmail.com
Signed-off-by: Jiri Olsa <jolsa@kernel.org>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Link: [https://lore.kernel.org/bpf/20241208142507.1207698-1-jolsa@kernel.org](https://lore.kernel.org/bpf/20241208142507.1207698-1-jolsa%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=842e5af282453983586e2eae3c8eaf252de5f22f)

| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=842e5af282453983586e2eae3c8eaf252de5f22f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex 2c4995f1a50490..e7b7be074e5a32 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=ccab6aad139a2a50d1557a0dd1e1bea4634a52e3)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=842e5af282453983586e2eae3c8eaf252de5f22f)@@ -2180,6 +2180,9 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) goto unlock;  old\_array = bpf\_event\_rcu\_dereference(event->tp\_event->prog\_array);+ if (!old\_array)+ goto put;+ ret = bpf\_prog\_array\_copy(old\_array, event->prog, NULL, 0, &new\_array); if (ret < 0) { bpf\_prog\_array\_delete\_safe(old\_array, event->prog);@@ -2188,6 +2191,7 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) bpf\_prog\_array\_free\_sleepable(old\_array); } +put: /\* \* It could be that the bpf\_prog is not sleepable (and will be freed \* via normal RCU), but is called from a point that supports sleepable |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:48 +0000



=== Content from git.kernel.org_dc780706_20250115_093612.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Olsa <jolsa@kernel.org> | 2024-12-08 15:25:07 +0100 |
| --- | --- | --- |
| committer | Andrii Nakryiko <andrii@kernel.org> | 2024-12-10 10:16:28 -0800 |
| commit | [978c4486cca5c7b9253d3ab98a88c8e769cb9bbd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd)) | |
| tree | [dbb6496d5c83d5132757b195c3a3ddfb18391909](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd) | |
| parent | [ef1b808e3b7c98612feceedf985c2fbbeb28f956](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd&id2=ef1b808e3b7c98612feceedf985c2fbbeb28f956)) | |
| download | [linux-978c4486cca5c7b9253d3ab98a88c8e769cb9bbd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-978c4486cca5c7b9253d3ab98a88c8e769cb9bbd.tar.gz) | |

bpf,perf: Fix invalid prog\_array access in perf\_event\_detach\_bpf\_progSyzbot reported [1] crash that happens for following tracing scenario:
- create tracepoint perf event with attr.inherit=1, attach it to the
process and set bpf program to it
- attached process forks -> chid creates inherited event
the new child event shares the parent's bpf program and tp\_event
(hence prog\_array) which is global for tracepoint
- exit both process and its child -> release both events
- first perf\_event\_detach\_bpf\_prog call will release tp\_event->prog\_array
and second perf\_event\_detach\_bpf\_prog will crash, because
tp\_event->prog\_array is NULL
The fix makes sure the perf\_event\_detach\_bpf\_prog checks prog\_array
is valid before it tries to remove the bpf program from it.
[1] https://lore.kernel.org/bpf/Z1MR6dCIKajNS6nU@krava/T/#m91dbf0688221ec7a7fc95e896a7ef9ff93b0b8ad
Fixes: 0ee288e69d03 ("bpf,perf: Fix perf\_event\_detach\_bpf\_prog error handling")
Reported-by: syzbot+2e0d2840414ce817aaac@syzkaller.appspotmail.com
Signed-off-by: Jiri Olsa <jolsa@kernel.org>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Link: [https://lore.kernel.org/bpf/20241208142507.1207698-1-jolsa@kernel.org](https://lore.kernel.org/bpf/20241208142507.1207698-1-jolsa%40kernel.org)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd)

| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex a403b05a709138..1b8db5aee9d38c 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=ef1b808e3b7c98612feceedf985c2fbbeb28f956)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=978c4486cca5c7b9253d3ab98a88c8e769cb9bbd)@@ -2250,6 +2250,9 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) goto unlock;  old\_array = bpf\_event\_rcu\_dereference(event->tp\_event->prog\_array);+ if (!old\_array)+ goto put;+ ret = bpf\_prog\_array\_copy(old\_array, event->prog, NULL, 0, &new\_array); if (ret < 0) { bpf\_prog\_array\_delete\_safe(old\_array, event->prog);@@ -2258,6 +2261,7 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) bpf\_prog\_array\_free\_sleepable(old\_array); } +put: /\* \* It could be that the bpf\_prog is not sleepable (and will be freed \* via normal RCU), but is called from a point that supports sleepable |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:49 +0000



=== Content from git.kernel.org_e0ec5515_20250115_093613.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Olsa <jolsa@kernel.org> | 2024-12-08 15:25:07 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:13:09 +0100 |
| commit | [dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3)) | |
| tree | [089d8a9127e77be8e69f7926bf0cc70465ad52aa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3) | |
| parent | [e6d1dec1424c3ffede17445a75d3794cd0d794d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6d1dec1424c3ffede17445a75d3794cd0d794d7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3&id2=e6d1dec1424c3ffede17445a75d3794cd0d794d7)) | |
| download | [linux-dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3.tar.gz) | |

bpf,perf: Fix invalid prog\_array access in perf\_event\_detach\_bpf\_progcommit 978c4486cca5c7b9253d3ab98a88c8e769cb9bbd upstream.
Syzbot reported [1] crash that happens for following tracing scenario:
- create tracepoint perf event with attr.inherit=1, attach it to the
process and set bpf program to it
- attached process forks -> chid creates inherited event
the new child event shares the parent's bpf program and tp\_event
(hence prog\_array) which is global for tracepoint
- exit both process and its child -> release both events
- first perf\_event\_detach\_bpf\_prog call will release tp\_event->prog\_array
and second perf\_event\_detach\_bpf\_prog will crash, because
tp\_event->prog\_array is NULL
The fix makes sure the perf\_event\_detach\_bpf\_prog checks prog\_array
is valid before it tries to remove the bpf program from it.
[1] https://lore.kernel.org/bpf/Z1MR6dCIKajNS6nU@krava/T/#m91dbf0688221ec7a7fc95e896a7ef9ff93b0b8ad
Fixes: 0ee288e69d03 ("bpf,perf: Fix perf\_event\_detach\_bpf\_prog error handling")
Reported-by: syzbot+2e0d2840414ce817aaac@syzkaller.appspotmail.com
Signed-off-by: Jiri Olsa <jolsa@kernel.org>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Link: [https://lore.kernel.org/bpf/20241208142507.1207698-1-jolsa@kernel.org](https://lore.kernel.org/bpf/20241208142507.1207698-1-jolsa%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3)

| -rw-r--r-- | [kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/bpf_trace.c?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/kernel/trace/bpf\_trace.c b/kernel/trace/bpf\_trace.cindex 841c59a6135a77..50881898e758d8 100644--- a/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=e6d1dec1424c3ffede17445a75d3794cd0d794d7)+++ b/[kernel/trace/bpf\_trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/bpf_trace.c?id=dfb15ddf3b65e0df2129f9756d1b4fa78055cdb3)@@ -2215,6 +2215,9 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) goto unlock;  old\_array = bpf\_event\_rcu\_dereference(event->tp\_event->prog\_array);+ if (!old\_array)+ goto put;+ ret = bpf\_prog\_array\_copy(old\_array, event->prog, NULL, 0, &new\_array); if (ret < 0) { bpf\_prog\_array\_delete\_safe(old\_array, event->prog);@@ -2223,6 +2226,7 @@ void perf\_event\_detach\_bpf\_prog(struct perf\_event \*event) bpf\_prog\_array\_free\_sleepable(old\_array); } +put: /\* \* It could be that the bpf\_prog is not sleepable (and will be freed \* via normal RCU), but is called from a point that supports sleepable |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:50 +0000


