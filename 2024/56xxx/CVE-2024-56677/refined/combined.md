=== Content from git.kernel.org_5c430962_20250114_203913.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 21:47:57 +0530 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2024-10-21 15:26:50 +1100 |
| commit | [05b94cae1c47f94588c3e7096963c1007c4d9c1d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d)) | |
| tree | [d2d720c03d7d857b571df97d0fcff6512b04a4de](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d) | |
| parent | [6faeac507beb2935d9171a01c3877b0505689c58](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6faeac507beb2935d9171a01c3877b0505689c58) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d&id2=6faeac507beb2935d9171a01c3877b0505689c58)) | |
| download | [linux-05b94cae1c47f94588c3e7096963c1007c4d9c1d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-05b94cae1c47f94588c3e7096963c1007c4d9c1d.tar.gz) | |

powerpc/fadump: Move fadump\_cma\_init to setup\_arch() after initmem\_init()During early init CMA\_MIN\_ALIGNMENT\_BYTES can be PAGE\_SIZE,
since pageblock\_order is still zero and it gets initialized
later during initmem\_init() e.g.
setup\_arch() -> initmem\_init() -> sparse\_init() -> set\_pageblock\_order()
One such use case where this causes issue is -
early\_setup() -> early\_init\_devtree() -> fadump\_reserve\_mem() -> fadump\_cma\_init()
This causes CMA memory alignment check to be bypassed in
cma\_init\_reserved\_mem(). Then later cma\_activate\_area() can hit
a VM\_BUG\_ON\_PAGE(pfn & ((1 << order) - 1)) if the reserved memory
area was not pageblock\_order aligned.
Fix it by moving the fadump\_cma\_init() after initmem\_init(),
where other such cma reservations also gets called.
<stack trace>
==============
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x10010
flags: 0x13ffff800000000(node=1|zone=0|lastcpupid=0x7ffff) CMA
raw: 013ffff800000000 5deadbeef0000100 5deadbeef0000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: VM\_BUG\_ON\_PAGE(pfn & ((1 << order) - 1))
------------[ cut here ]------------
kernel BUG at mm/page\_alloc.c:778!
Call Trace:
\_\_free\_one\_page+0x57c/0x7b0 (unreliable)
free\_pcppages\_bulk+0x1a8/0x2c8
free\_unref\_page\_commit+0x3d4/0x4e4
free\_unref\_page+0x458/0x6d0
init\_cma\_reserved\_pageblock+0x114/0x198
cma\_init\_reserved\_areas+0x270/0x3e0
do\_one\_initcall+0x80/0x2f8
kernel\_init\_freeable+0x33c/0x530
kernel\_init+0x34/0x26c
ret\_from\_kernel\_user\_thread+0x14/0x1c
Fixes: 11ac3e87ce09 ("mm: cma: use pageblock\_order as the single alignment")
Suggested-by: David Hildenbrand <david@redhat.com>
Reported-by: Sachin P Bappalige <sachinpb@linux.ibm.com>
Acked-by: Hari Bathini <hbathini@linux.ibm.com>
Reviewed-by: Madhavan Srinivasan <maddy@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/3ae208e48c0d9cefe53d2dc4f593388067405b7d.1729146153.git.ritesh.list@gmail.com](https://patch.msgid.link/3ae208e48c0d9cefe53d2dc4f593388067405b7d.1729146153.git.ritesh.list%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d)

| -rw-r--r-- | [arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/fadump.h?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/fadump.c?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/setup-common.c?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d) | 6 | |  |  |  | | --- | --- | --- | |

3 files changed, 12 insertions, 7 deletions

| diff --git a/arch/powerpc/include/asm/fadump.h b/arch/powerpc/include/asm/fadump.hindex ef40c9b6972a6e..3638f04447f592 100644--- a/[arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fadump.h?id=6faeac507beb2935d9171a01c3877b0505689c58)+++ b/[arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fadump.h?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d)@@ -34,4 +34,11 @@ extern int early\_init\_dt\_scan\_fw\_dump(unsigned long node, const char \*uname, int depth, void \*data); extern int fadump\_reserve\_mem(void); #endif++#if defined(CONFIG\_FA\_DUMP) && defined(CONFIG\_CMA)+void fadump\_cma\_init(void);+#else+static inline void fadump\_cma\_init(void) { }+#endif+ #endif /\* \_ASM\_POWERPC\_FADUMP\_H \*/diff --git a/arch/powerpc/kernel/fadump.c b/arch/powerpc/kernel/fadump.cindex ffaec625b7a801..c42f89862893eb 100644--- a/[arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/fadump.c?id=6faeac507beb2935d9171a01c3877b0505689c58)+++ b/[arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/fadump.c?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d)@@ -78,7 +78,7 @@ static struct cma \*fadump\_cma; \* But for some reason even if it fails we still have the memory reservation \* with us and we can still continue doing fadump. \*/-static void \_\_init fadump\_cma\_init(void)+void \_\_init fadump\_cma\_init(void) { unsigned long long base, size, end; int rc;@@ -139,8 +139,6 @@ static void \_\_init fadump\_cma\_init(void) fw\_dump.boot\_memory\_size >> 20); return; }-#else-static void \_\_init fadump\_cma\_init(void) { } #endif /\* CONFIG\_CMA \*/  /\*@@ -642,8 +640,6 @@ int \_\_init fadump\_reserve\_mem(void)  pr\_info("Reserved %lldMB of memory at %#016llx (System RAM: %lldMB)\n", (size >> 20), base, (memblock\_phys\_mem\_size() >> 20));-- fadump\_cma\_init(); }  return ret;diff --git a/arch/powerpc/kernel/setup-common.c b/arch/powerpc/kernel/setup-common.cindex 943430077375a4..b6b01502e50472 100644--- a/[arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/setup-common.c?id=6faeac507beb2935d9171a01c3877b0505689c58)+++ b/[arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/setup-common.c?id=05b94cae1c47f94588c3e7096963c1007c4d9c1d)@@ -997,9 +997,11 @@ void \_\_init setup\_arch(char \*\*cmdline\_p) initmem\_init();  /\*- \* Reserve large chunks of memory for use by CMA for KVM and hugetlb. These must- \* be called after initmem\_init(), so that pageblock\_order is initialised.+ \* Reserve large chunks of memory for use by CMA for fadump, KVM and+ \* hugetlb. These must be called after initmem\_init(), so that+ \* pageblock\_order is initialised. \*/+ fadump\_cma\_init(); kvm\_cma\_reserve(); gigantic\_hugetlb\_cma\_reserve(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:51 +0000



=== Content from git.kernel.org_97195988_20250114_203916.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f551637fe9bf863386309e03f9d148d97f535ad1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f551637fe9bf863386309e03f9d148d97f535ad1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f551637fe9bf863386309e03f9d148d97f535ad1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f551637fe9bf863386309e03f9d148d97f535ad1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 21:47:57 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:33 +0100 |
| commit | [f551637fe9bf863386309e03f9d148d97f535ad1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f551637fe9bf863386309e03f9d148d97f535ad1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f551637fe9bf863386309e03f9d148d97f535ad1)) | |
| tree | [d1efb48c8bf85a6b953439a6950e259c37782446](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f551637fe9bf863386309e03f9d148d97f535ad1) | |
| parent | [c9fbc877776d6d6ae9c93fb71f3a8c317f9fe371](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9fbc877776d6d6ae9c93fb71f3a8c317f9fe371) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f551637fe9bf863386309e03f9d148d97f535ad1&id2=c9fbc877776d6d6ae9c93fb71f3a8c317f9fe371)) | |
| download | [linux-f551637fe9bf863386309e03f9d148d97f535ad1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f551637fe9bf863386309e03f9d148d97f535ad1.tar.gz) | |

powerpc/fadump: Move fadump\_cma\_init to setup\_arch() after initmem\_init()[ Upstream commit 05b94cae1c47f94588c3e7096963c1007c4d9c1d ]
During early init CMA\_MIN\_ALIGNMENT\_BYTES can be PAGE\_SIZE,
since pageblock\_order is still zero and it gets initialized
later during initmem\_init() e.g.
setup\_arch() -> initmem\_init() -> sparse\_init() -> set\_pageblock\_order()
One such use case where this causes issue is -
early\_setup() -> early\_init\_devtree() -> fadump\_reserve\_mem() -> fadump\_cma\_init()
This causes CMA memory alignment check to be bypassed in
cma\_init\_reserved\_mem(). Then later cma\_activate\_area() can hit
a VM\_BUG\_ON\_PAGE(pfn & ((1 << order) - 1)) if the reserved memory
area was not pageblock\_order aligned.
Fix it by moving the fadump\_cma\_init() after initmem\_init(),
where other such cma reservations also gets called.
<stack trace>
==============
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x10010
flags: 0x13ffff800000000(node=1|zone=0|lastcpupid=0x7ffff) CMA
raw: 013ffff800000000 5deadbeef0000100 5deadbeef0000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: VM\_BUG\_ON\_PAGE(pfn & ((1 << order) - 1))
------------[ cut here ]------------
kernel BUG at mm/page\_alloc.c:778!
Call Trace:
\_\_free\_one\_page+0x57c/0x7b0 (unreliable)
free\_pcppages\_bulk+0x1a8/0x2c8
free\_unref\_page\_commit+0x3d4/0x4e4
free\_unref\_page+0x458/0x6d0
init\_cma\_reserved\_pageblock+0x114/0x198
cma\_init\_reserved\_areas+0x270/0x3e0
do\_one\_initcall+0x80/0x2f8
kernel\_init\_freeable+0x33c/0x530
kernel\_init+0x34/0x26c
ret\_from\_kernel\_user\_thread+0x14/0x1c
Fixes: 11ac3e87ce09 ("mm: cma: use pageblock\_order as the single alignment")
Suggested-by: David Hildenbrand <david@redhat.com>
Reported-by: Sachin P Bappalige <sachinpb@linux.ibm.com>
Acked-by: Hari Bathini <hbathini@linux.ibm.com>
Reviewed-by: Madhavan Srinivasan <maddy@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/3ae208e48c0d9cefe53d2dc4f593388067405b7d.1729146153.git.ritesh.list@gmail.com](https://patch.msgid.link/3ae208e48c0d9cefe53d2dc4f593388067405b7d.1729146153.git.ritesh.list%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f551637fe9bf863386309e03f9d148d97f535ad1)

| -rw-r--r-- | [arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/fadump.h?id=f551637fe9bf863386309e03f9d148d97f535ad1) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/fadump.c?id=f551637fe9bf863386309e03f9d148d97f535ad1) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/setup-common.c?id=f551637fe9bf863386309e03f9d148d97f535ad1) | 6 | |  |  |  | | --- | --- | --- | |

3 files changed, 12 insertions, 7 deletions

| diff --git a/arch/powerpc/include/asm/fadump.h b/arch/powerpc/include/asm/fadump.hindex ef40c9b6972a6e..3638f04447f592 100644--- a/[arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fadump.h?id=c9fbc877776d6d6ae9c93fb71f3a8c317f9fe371)+++ b/[arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fadump.h?id=f551637fe9bf863386309e03f9d148d97f535ad1)@@ -34,4 +34,11 @@ extern int early\_init\_dt\_scan\_fw\_dump(unsigned long node, const char \*uname, int depth, void \*data); extern int fadump\_reserve\_mem(void); #endif++#if defined(CONFIG\_FA\_DUMP) && defined(CONFIG\_CMA)+void fadump\_cma\_init(void);+#else+static inline void fadump\_cma\_init(void) { }+#endif+ #endif /\* \_ASM\_POWERPC\_FADUMP\_H \*/diff --git a/arch/powerpc/kernel/fadump.c b/arch/powerpc/kernel/fadump.cindex 162327d66982ec..ac7b4e1645e55d 100644--- a/[arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/fadump.c?id=c9fbc877776d6d6ae9c93fb71f3a8c317f9fe371)+++ b/[arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/fadump.c?id=f551637fe9bf863386309e03f9d148d97f535ad1)@@ -78,7 +78,7 @@ static struct cma \*fadump\_cma; \* But for some reason even if it fails we still have the memory reservation \* with us and we can still continue doing fadump. \*/-static void \_\_init fadump\_cma\_init(void)+void \_\_init fadump\_cma\_init(void) { unsigned long long base, size; int rc;@@ -122,8 +122,6 @@ static void \_\_init fadump\_cma\_init(void) (unsigned long)cma\_get\_base(fadump\_cma) >> 20, fw\_dump.reserve\_dump\_area\_size); }-#else-static void \_\_init fadump\_cma\_init(void) { } #endif /\* CONFIG\_CMA \*/  /\*@@ -632,8 +630,6 @@ int \_\_init fadump\_reserve\_mem(void)  pr\_info("Reserved %lldMB of memory at %#016llx (System RAM: %lldMB)\n", (size >> 20), base, (memblock\_phys\_mem\_size() >> 20));-- fadump\_cma\_init(); }  return ret;diff --git a/arch/powerpc/kernel/setup-common.c b/arch/powerpc/kernel/setup-common.cindex 943430077375a4..b6b01502e50472 100644--- a/[arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/setup-common.c?id=c9fbc877776d6d6ae9c93fb71f3a8c317f9fe371)+++ b/[arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/setup-common.c?id=f551637fe9bf863386309e03f9d148d97f535ad1)@@ -997,9 +997,11 @@ void \_\_init setup\_arch(char \*\*cmdline\_p) initmem\_init();  /\*- \* Reserve large chunks of memory for use by CMA for KVM and hugetlb. These must- \* be called after initmem\_init(), so that pageblock\_order is initialised.+ \* Reserve large chunks of memory for use by CMA for fadump, KVM and+ \* hugetlb. These must be called after initmem\_init(), so that+ \* pageblock\_order is initialised. \*/+ fadump\_cma\_init(); kvm\_cma\_reserve(); gigantic\_hugetlb\_cma\_reserve(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:53 +0000



=== Content from git.kernel.org_af5e35cb_20250114_203915.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 21:47:57 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:14 +0100 |
| commit | [c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74)) | |
| tree | [f339cdc6913d4a974463d6d733e661398b305ddc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74) | |
| parent | [92f7cc84c3dbbfb71a453d5de21e00f1b31a49b0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92f7cc84c3dbbfb71a453d5de21e00f1b31a49b0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74&id2=92f7cc84c3dbbfb71a453d5de21e00f1b31a49b0)) | |
| download | [linux-c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74.tar.gz) | |

powerpc/fadump: Move fadump\_cma\_init to setup\_arch() after initmem\_init()[ Upstream commit 05b94cae1c47f94588c3e7096963c1007c4d9c1d ]
During early init CMA\_MIN\_ALIGNMENT\_BYTES can be PAGE\_SIZE,
since pageblock\_order is still zero and it gets initialized
later during initmem\_init() e.g.
setup\_arch() -> initmem\_init() -> sparse\_init() -> set\_pageblock\_order()
One such use case where this causes issue is -
early\_setup() -> early\_init\_devtree() -> fadump\_reserve\_mem() -> fadump\_cma\_init()
This causes CMA memory alignment check to be bypassed in
cma\_init\_reserved\_mem(). Then later cma\_activate\_area() can hit
a VM\_BUG\_ON\_PAGE(pfn & ((1 << order) - 1)) if the reserved memory
area was not pageblock\_order aligned.
Fix it by moving the fadump\_cma\_init() after initmem\_init(),
where other such cma reservations also gets called.
<stack trace>
==============
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x10010
flags: 0x13ffff800000000(node=1|zone=0|lastcpupid=0x7ffff) CMA
raw: 013ffff800000000 5deadbeef0000100 5deadbeef0000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: VM\_BUG\_ON\_PAGE(pfn & ((1 << order) - 1))
------------[ cut here ]------------
kernel BUG at mm/page\_alloc.c:778!
Call Trace:
\_\_free\_one\_page+0x57c/0x7b0 (unreliable)
free\_pcppages\_bulk+0x1a8/0x2c8
free\_unref\_page\_commit+0x3d4/0x4e4
free\_unref\_page+0x458/0x6d0
init\_cma\_reserved\_pageblock+0x114/0x198
cma\_init\_reserved\_areas+0x270/0x3e0
do\_one\_initcall+0x80/0x2f8
kernel\_init\_freeable+0x33c/0x530
kernel\_init+0x34/0x26c
ret\_from\_kernel\_user\_thread+0x14/0x1c
Fixes: 11ac3e87ce09 ("mm: cma: use pageblock\_order as the single alignment")
Suggested-by: David Hildenbrand <david@redhat.com>
Reported-by: Sachin P Bappalige <sachinpb@linux.ibm.com>
Acked-by: Hari Bathini <hbathini@linux.ibm.com>
Reviewed-by: Madhavan Srinivasan <maddy@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/3ae208e48c0d9cefe53d2dc4f593388067405b7d.1729146153.git.ritesh.list@gmail.com](https://patch.msgid.link/3ae208e48c0d9cefe53d2dc4f593388067405b7d.1729146153.git.ritesh.list%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74)

| -rw-r--r-- | [arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/fadump.h?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/fadump.c?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/setup-common.c?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74) | 6 | |  |  |  | | --- | --- | --- | |

3 files changed, 12 insertions, 7 deletions

| diff --git a/arch/powerpc/include/asm/fadump.h b/arch/powerpc/include/asm/fadump.hindex 526a6a6473128a..daa44b2ef35ad0 100644--- a/[arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fadump.h?id=92f7cc84c3dbbfb71a453d5de21e00f1b31a49b0)+++ b/[arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fadump.h?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74)@@ -32,4 +32,11 @@ extern int early\_init\_dt\_scan\_fw\_dump(unsigned long node, const char \*uname, int depth, void \*data); extern int fadump\_reserve\_mem(void); #endif++#if defined(CONFIG\_FA\_DUMP) && defined(CONFIG\_CMA)+void fadump\_cma\_init(void);+#else+static inline void fadump\_cma\_init(void) { }+#endif+ #endif /\* \_ASM\_POWERPC\_FADUMP\_H \*/diff --git a/arch/powerpc/kernel/fadump.c b/arch/powerpc/kernel/fadump.cindex 4722a9e606e61f..1866bac2340007 100644--- a/[arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/fadump.c?id=92f7cc84c3dbbfb71a453d5de21e00f1b31a49b0)+++ b/[arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/fadump.c?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74)@@ -80,7 +80,7 @@ static struct cma \*fadump\_cma; \* But for some reason even if it fails we still have the memory reservation \* with us and we can still continue doing fadump. \*/-static void \_\_init fadump\_cma\_init(void)+void \_\_init fadump\_cma\_init(void) { unsigned long long base, size; int rc;@@ -124,8 +124,6 @@ static void \_\_init fadump\_cma\_init(void) (unsigned long)cma\_get\_base(fadump\_cma) >> 20, fw\_dump.reserve\_dump\_area\_size); }-#else-static void \_\_init fadump\_cma\_init(void) { } #endif /\* CONFIG\_CMA \*/  /\* Scan the Firmware Assisted dump configuration details. \*/@@ -642,8 +640,6 @@ int \_\_init fadump\_reserve\_mem(void)  pr\_info("Reserved %lldMB of memory at %#016llx (System RAM: %lldMB)\n", (size >> 20), base, (memblock\_phys\_mem\_size() >> 20));-- fadump\_cma\_init(); }  return ret;diff --git a/arch/powerpc/kernel/setup-common.c b/arch/powerpc/kernel/setup-common.cindex 03eaad5949f141..d43db8150767be 100644--- a/[arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/setup-common.c?id=92f7cc84c3dbbfb71a453d5de21e00f1b31a49b0)+++ b/[arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/setup-common.c?id=c5c1d1ef70834013fc3bd12b6a0f4664c6d75a74)@@ -988,9 +988,11 @@ void \_\_init setup\_arch(char \*\*cmdline\_p) initmem\_init();  /\*- \* Reserve large chunks of memory for use by CMA for KVM and hugetlb. These must- \* be called after initmem\_init(), so that pageblock\_order is initialised.+ \* Reserve large chunks of memory for use by CMA for fadump, KVM and+ \* hugetlb. These must be called after initmem\_init(), so that+ \* pageblock\_order is initialised. \*/+ fadump\_cma\_init(); kvm\_cma\_reserve(); gigantic\_hugetlb\_cma\_reserve(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:52 +0000



=== Content from git.kernel.org_9b67b329_20250114_203914.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 21:47:57 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:36 +0100 |
| commit | [aabef6301dcf410dfd2b8759cd413b2a003c7e3f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f)) | |
| tree | [b648fdb1e260c956bafae96f671c7587a3d72487](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f) | |
| parent | [6ffdb03366a9dfdf4b0fc2d239a04e5886a64bae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ffdb03366a9dfdf4b0fc2d239a04e5886a64bae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f&id2=6ffdb03366a9dfdf4b0fc2d239a04e5886a64bae)) | |
| download | [linux-aabef6301dcf410dfd2b8759cd413b2a003c7e3f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aabef6301dcf410dfd2b8759cd413b2a003c7e3f.tar.gz) | |

powerpc/fadump: Move fadump\_cma\_init to setup\_arch() after initmem\_init()[ Upstream commit 05b94cae1c47f94588c3e7096963c1007c4d9c1d ]
During early init CMA\_MIN\_ALIGNMENT\_BYTES can be PAGE\_SIZE,
since pageblock\_order is still zero and it gets initialized
later during initmem\_init() e.g.
setup\_arch() -> initmem\_init() -> sparse\_init() -> set\_pageblock\_order()
One such use case where this causes issue is -
early\_setup() -> early\_init\_devtree() -> fadump\_reserve\_mem() -> fadump\_cma\_init()
This causes CMA memory alignment check to be bypassed in
cma\_init\_reserved\_mem(). Then later cma\_activate\_area() can hit
a VM\_BUG\_ON\_PAGE(pfn & ((1 << order) - 1)) if the reserved memory
area was not pageblock\_order aligned.
Fix it by moving the fadump\_cma\_init() after initmem\_init(),
where other such cma reservations also gets called.
<stack trace>
==============
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x10010
flags: 0x13ffff800000000(node=1|zone=0|lastcpupid=0x7ffff) CMA
raw: 013ffff800000000 5deadbeef0000100 5deadbeef0000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: VM\_BUG\_ON\_PAGE(pfn & ((1 << order) - 1))
------------[ cut here ]------------
kernel BUG at mm/page\_alloc.c:778!
Call Trace:
\_\_free\_one\_page+0x57c/0x7b0 (unreliable)
free\_pcppages\_bulk+0x1a8/0x2c8
free\_unref\_page\_commit+0x3d4/0x4e4
free\_unref\_page+0x458/0x6d0
init\_cma\_reserved\_pageblock+0x114/0x198
cma\_init\_reserved\_areas+0x270/0x3e0
do\_one\_initcall+0x80/0x2f8
kernel\_init\_freeable+0x33c/0x530
kernel\_init+0x34/0x26c
ret\_from\_kernel\_user\_thread+0x14/0x1c
Fixes: 11ac3e87ce09 ("mm: cma: use pageblock\_order as the single alignment")
Suggested-by: David Hildenbrand <david@redhat.com>
Reported-by: Sachin P Bappalige <sachinpb@linux.ibm.com>
Acked-by: Hari Bathini <hbathini@linux.ibm.com>
Reviewed-by: Madhavan Srinivasan <maddy@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/3ae208e48c0d9cefe53d2dc4f593388067405b7d.1729146153.git.ritesh.list@gmail.com](https://patch.msgid.link/3ae208e48c0d9cefe53d2dc4f593388067405b7d.1729146153.git.ritesh.list%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f)

| -rw-r--r-- | [arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/fadump.h?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/fadump.c?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/setup-common.c?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f) | 6 | |  |  |  | | --- | --- | --- | |

3 files changed, 12 insertions, 7 deletions

| diff --git a/arch/powerpc/include/asm/fadump.h b/arch/powerpc/include/asm/fadump.hindex 526a6a6473128a..daa44b2ef35ad0 100644--- a/[arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fadump.h?id=6ffdb03366a9dfdf4b0fc2d239a04e5886a64bae)+++ b/[arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fadump.h?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f)@@ -32,4 +32,11 @@ extern int early\_init\_dt\_scan\_fw\_dump(unsigned long node, const char \*uname, int depth, void \*data); extern int fadump\_reserve\_mem(void); #endif++#if defined(CONFIG\_FA\_DUMP) && defined(CONFIG\_CMA)+void fadump\_cma\_init(void);+#else+static inline void fadump\_cma\_init(void) { }+#endif+ #endif /\* \_ASM\_POWERPC\_FADUMP\_H \*/diff --git a/arch/powerpc/kernel/fadump.c b/arch/powerpc/kernel/fadump.cindex 4722a9e606e61f..1866bac2340007 100644--- a/[arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/fadump.c?id=6ffdb03366a9dfdf4b0fc2d239a04e5886a64bae)+++ b/[arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/fadump.c?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f)@@ -80,7 +80,7 @@ static struct cma \*fadump\_cma; \* But for some reason even if it fails we still have the memory reservation \* with us and we can still continue doing fadump. \*/-static void \_\_init fadump\_cma\_init(void)+void \_\_init fadump\_cma\_init(void) { unsigned long long base, size; int rc;@@ -124,8 +124,6 @@ static void \_\_init fadump\_cma\_init(void) (unsigned long)cma\_get\_base(fadump\_cma) >> 20, fw\_dump.reserve\_dump\_area\_size); }-#else-static void \_\_init fadump\_cma\_init(void) { } #endif /\* CONFIG\_CMA \*/  /\* Scan the Firmware Assisted dump configuration details. \*/@@ -642,8 +640,6 @@ int \_\_init fadump\_reserve\_mem(void)  pr\_info("Reserved %lldMB of memory at %#016llx (System RAM: %lldMB)\n", (size >> 20), base, (memblock\_phys\_mem\_size() >> 20));-- fadump\_cma\_init(); }  return ret;diff --git a/arch/powerpc/kernel/setup-common.c b/arch/powerpc/kernel/setup-common.cindex 56f6b958926d7c..41c03c8e41b414 100644--- a/[arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/setup-common.c?id=6ffdb03366a9dfdf4b0fc2d239a04e5886a64bae)+++ b/[arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/setup-common.c?id=aabef6301dcf410dfd2b8759cd413b2a003c7e3f)@@ -982,9 +982,11 @@ void \_\_init setup\_arch(char \*\*cmdline\_p) initmem\_init();  /\*- \* Reserve large chunks of memory for use by CMA for KVM and hugetlb. These must- \* be called after initmem\_init(), so that pageblock\_order is initialised.+ \* Reserve large chunks of memory for use by CMA for fadump, KVM and+ \* hugetlb. These must be called after initmem\_init(), so that+ \* pageblock\_order is initialised. \*/+ fadump\_cma\_init(); kvm\_cma\_reserve(); gigantic\_hugetlb\_cma\_reserve(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:52 +0000



=== Content from git.kernel.org_45c4f942_20250114_203914.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7351c5a6507b4401aeecadb5959131410a339520)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7351c5a6507b4401aeecadb5959131410a339520)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7351c5a6507b4401aeecadb5959131410a339520)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7351c5a6507b4401aeecadb5959131410a339520)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani (IBM) <ritesh.list@gmail.com> | 2024-10-18 21:47:57 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:04 +0100 |
| commit | [7351c5a6507b4401aeecadb5959131410a339520](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7351c5a6507b4401aeecadb5959131410a339520) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7351c5a6507b4401aeecadb5959131410a339520)) | |
| tree | [7f88641caea0a2062f845acb58d6391c1ca49e9a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7351c5a6507b4401aeecadb5959131410a339520) | |
| parent | [7528e270fa9973f597b65b4d3681c77eb71847fe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7528e270fa9973f597b65b4d3681c77eb71847fe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7351c5a6507b4401aeecadb5959131410a339520&id2=7528e270fa9973f597b65b4d3681c77eb71847fe)) | |
| download | [linux-7351c5a6507b4401aeecadb5959131410a339520.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7351c5a6507b4401aeecadb5959131410a339520.tar.gz) | |

powerpc/fadump: Move fadump\_cma\_init to setup\_arch() after initmem\_init()[ Upstream commit 05b94cae1c47f94588c3e7096963c1007c4d9c1d ]
During early init CMA\_MIN\_ALIGNMENT\_BYTES can be PAGE\_SIZE,
since pageblock\_order is still zero and it gets initialized
later during initmem\_init() e.g.
setup\_arch() -> initmem\_init() -> sparse\_init() -> set\_pageblock\_order()
One such use case where this causes issue is -
early\_setup() -> early\_init\_devtree() -> fadump\_reserve\_mem() -> fadump\_cma\_init()
This causes CMA memory alignment check to be bypassed in
cma\_init\_reserved\_mem(). Then later cma\_activate\_area() can hit
a VM\_BUG\_ON\_PAGE(pfn & ((1 << order) - 1)) if the reserved memory
area was not pageblock\_order aligned.
Fix it by moving the fadump\_cma\_init() after initmem\_init(),
where other such cma reservations also gets called.
<stack trace>
==============
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x10010
flags: 0x13ffff800000000(node=1|zone=0|lastcpupid=0x7ffff) CMA
raw: 013ffff800000000 5deadbeef0000100 5deadbeef0000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: VM\_BUG\_ON\_PAGE(pfn & ((1 << order) - 1))
------------[ cut here ]------------
kernel BUG at mm/page\_alloc.c:778!
Call Trace:
\_\_free\_one\_page+0x57c/0x7b0 (unreliable)
free\_pcppages\_bulk+0x1a8/0x2c8
free\_unref\_page\_commit+0x3d4/0x4e4
free\_unref\_page+0x458/0x6d0
init\_cma\_reserved\_pageblock+0x114/0x198
cma\_init\_reserved\_areas+0x270/0x3e0
do\_one\_initcall+0x80/0x2f8
kernel\_init\_freeable+0x33c/0x530
kernel\_init+0x34/0x26c
ret\_from\_kernel\_user\_thread+0x14/0x1c
Fixes: 11ac3e87ce09 ("mm: cma: use pageblock\_order as the single alignment")
Suggested-by: David Hildenbrand <david@redhat.com>
Reported-by: Sachin P Bappalige <sachinpb@linux.ibm.com>
Acked-by: Hari Bathini <hbathini@linux.ibm.com>
Reviewed-by: Madhavan Srinivasan <maddy@linux.ibm.com>
Signed-off-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://patch.msgid.link/3ae208e48c0d9cefe53d2dc4f593388067405b7d.1729146153.git.ritesh.list@gmail.com](https://patch.msgid.link/3ae208e48c0d9cefe53d2dc4f593388067405b7d.1729146153.git.ritesh.list%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7351c5a6507b4401aeecadb5959131410a339520)

| -rw-r--r-- | [arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/fadump.h?id=7351c5a6507b4401aeecadb5959131410a339520) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/fadump.c?id=7351c5a6507b4401aeecadb5959131410a339520) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/setup-common.c?id=7351c5a6507b4401aeecadb5959131410a339520) | 6 | |  |  |  | | --- | --- | --- | |

3 files changed, 12 insertions, 7 deletions

| diff --git a/arch/powerpc/include/asm/fadump.h b/arch/powerpc/include/asm/fadump.hindex ef40c9b6972a6e..3638f04447f592 100644--- a/[arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fadump.h?id=7528e270fa9973f597b65b4d3681c77eb71847fe)+++ b/[arch/powerpc/include/asm/fadump.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fadump.h?id=7351c5a6507b4401aeecadb5959131410a339520)@@ -34,4 +34,11 @@ extern int early\_init\_dt\_scan\_fw\_dump(unsigned long node, const char \*uname, int depth, void \*data); extern int fadump\_reserve\_mem(void); #endif++#if defined(CONFIG\_FA\_DUMP) && defined(CONFIG\_CMA)+void fadump\_cma\_init(void);+#else+static inline void fadump\_cma\_init(void) { }+#endif+ #endif /\* \_ASM\_POWERPC\_FADUMP\_H \*/diff --git a/arch/powerpc/kernel/fadump.c b/arch/powerpc/kernel/fadump.cindex 162327d66982ec..ac7b4e1645e55d 100644--- a/[arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/fadump.c?id=7528e270fa9973f597b65b4d3681c77eb71847fe)+++ b/[arch/powerpc/kernel/fadump.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/fadump.c?id=7351c5a6507b4401aeecadb5959131410a339520)@@ -78,7 +78,7 @@ static struct cma \*fadump\_cma; \* But for some reason even if it fails we still have the memory reservation \* with us and we can still continue doing fadump. \*/-static void \_\_init fadump\_cma\_init(void)+void \_\_init fadump\_cma\_init(void) { unsigned long long base, size; int rc;@@ -122,8 +122,6 @@ static void \_\_init fadump\_cma\_init(void) (unsigned long)cma\_get\_base(fadump\_cma) >> 20, fw\_dump.reserve\_dump\_area\_size); }-#else-static void \_\_init fadump\_cma\_init(void) { } #endif /\* CONFIG\_CMA \*/  /\*@@ -632,8 +630,6 @@ int \_\_init fadump\_reserve\_mem(void)  pr\_info("Reserved %lldMB of memory at %#016llx (System RAM: %lldMB)\n", (size >> 20), base, (memblock\_phys\_mem\_size() >> 20));-- fadump\_cma\_init(); }  return ret;diff --git a/arch/powerpc/kernel/setup-common.c b/arch/powerpc/kernel/setup-common.cindex 943430077375a4..b6b01502e50472 100644--- a/[arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/setup-common.c?id=7528e270fa9973f597b65b4d3681c77eb71847fe)+++ b/[arch/powerpc/kernel/setup-common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/setup-common.c?id=7351c5a6507b4401aeecadb5959131410a339520)@@ -997,9 +997,11 @@ void \_\_init setup\_arch(char \*\*cmdline\_p) initmem\_init();  /\*- \* Reserve large chunks of memory for use by CMA for KVM and hugetlb. These must- \* be called after initmem\_init(), so that pageblock\_order is initialised.+ \* Reserve large chunks of memory for use by CMA for fadump, KVM and+ \* hugetlb. These must be called after initmem\_init(), so that+ \* pageblock\_order is initialised. \*/+ fadump\_cma\_init(); kvm\_cma\_reserve(); gigantic\_hugetlb\_cma\_reserve(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:51 +0000


