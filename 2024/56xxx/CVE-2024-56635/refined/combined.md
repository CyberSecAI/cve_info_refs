=== Content from git.kernel.org_8c17424a_20250115_090428.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3265aab0736f78bb218200b06b1abb525c316269)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3265aab0736f78bb218200b06b1abb525c316269)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3265aab0736f78bb218200b06b1abb525c316269)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3265aab0736f78bb218200b06b1abb525c316269)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-12-03 17:09:33 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:40 +0100 |
| commit | [3265aab0736f78bb218200b06b1abb525c316269](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3265aab0736f78bb218200b06b1abb525c316269) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3265aab0736f78bb218200b06b1abb525c316269)) | |
| tree | [e931d69cd7445e654d9d36f05cbc4bab4cf5a9b8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3265aab0736f78bb218200b06b1abb525c316269) | |
| parent | [4bd8ced2b9f65b75cedeaa66c4ffe6ab2a853b6e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4bd8ced2b9f65b75cedeaa66c4ffe6ab2a853b6e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3265aab0736f78bb218200b06b1abb525c316269&id2=4bd8ced2b9f65b75cedeaa66c4ffe6ab2a853b6e)) | |
| download | [linux-3265aab0736f78bb218200b06b1abb525c316269.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3265aab0736f78bb218200b06b1abb525c316269.tar.gz) | |

net: avoid potential UAF in default\_operstate()[ Upstream commit 750e51603395e755537da08f745864c93e3ce741 ]
syzbot reported an UAF in default\_operstate() [1]
Issue is a race between device and netns dismantles.
After calling \_\_rtnl\_unlock() from netdev\_run\_todo(),
we can not assume the netns of each device is still alive.
Make sure the device is not in NETREG\_UNREGISTERED state,
and add an ASSERT\_RTNL() before the call to
\_\_dev\_get\_by\_index().
We might move this ASSERT\_RTNL() in \_\_dev\_get\_by\_index()
in the future.
[1]
BUG: KASAN: slab-use-after-free in \_\_dev\_get\_by\_index+0x5d/0x110 net/core/dev.c:852
Read of size 8 at addr ffff888043eba1b0 by task syz.0.0/5339
CPU: 0 UID: 0 PID: 5339 Comm: syz.0.0 Not tainted 6.12.0-syzkaller-10296-gaaf20f870da0 #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:378 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:489
kasan\_report+0x143/0x180 mm/kasan/report.c:602
\_\_dev\_get\_by\_index+0x5d/0x110 net/core/dev.c:852
default\_operstate net/core/link\_watch.c:51 [inline]
rfc2863\_policy+0x224/0x300 net/core/link\_watch.c:67
linkwatch\_do\_dev+0x3e/0x170 net/core/link\_watch.c:170
netdev\_run\_todo+0x461/0x1000 net/core/dev.c:10894
rtnl\_unlock net/core/rtnetlink.c:152 [inline]
rtnl\_net\_unlock include/linux/rtnetlink.h:133 [inline]
rtnl\_dellink+0x760/0x8d0 net/core/rtnetlink.c:3520
rtnetlink\_rcv\_msg+0x791/0xcf0 net/core/rtnetlink.c:6911
netlink\_rcv\_skb+0x1e3/0x430 net/netlink/af\_netlink.c:2541
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1321 [inline]
netlink\_unicast+0x7f6/0x990 net/netlink/af\_netlink.c:1347
netlink\_sendmsg+0x8e4/0xcb0 net/netlink/af\_netlink.c:1891
sock\_sendmsg\_nosec net/socket.c:711 [inline]
\_\_sock\_sendmsg+0x221/0x270 net/socket.c:726
\_\_\_\_sys\_sendmsg+0x52a/0x7e0 net/socket.c:2583
\_\_\_sys\_sendmsg net/socket.c:2637 [inline]
\_\_sys\_sendmsg+0x269/0x350 net/socket.c:2669
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f2a3cb80809
Code: ff ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 a8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f2a3d9cd058 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00007f2a3cd45fa0 RCX: 00007f2a3cb80809
RDX: 0000000000000000 RSI: 0000000020000000 RDI: 0000000000000008
RBP: 00007f2a3cbf393e R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f2a3cd45fa0 R15: 00007ffd03bc65c8
</TASK>
Allocated by task 5339:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0x98/0xb0 mm/kasan/common.c:394
kasan\_kmalloc include/linux/kasan.h:260 [inline]
\_\_kmalloc\_cache\_noprof+0x243/0x390 mm/slub.c:4314
kmalloc\_noprof include/linux/slab.h:901 [inline]
kmalloc\_array\_noprof include/linux/slab.h:945 [inline]
netdev\_create\_hash net/core/dev.c:11870 [inline]
netdev\_init+0x10c/0x250 net/core/dev.c:11890
ops\_init+0x31e/0x590 net/core/net\_namespace.c:138
setup\_net+0x287/0x9e0 net/core/net\_namespace.c:362
copy\_net\_ns+0x33f/0x570 net/core/net\_namespace.c:500
create\_new\_namespaces+0x425/0x7b0 kernel/nsproxy.c:110
unshare\_nsproxy\_namespaces+0x124/0x180 kernel/nsproxy.c:228
ksys\_unshare+0x57d/0xa70 kernel/fork.c:3314
\_\_do\_sys\_unshare kernel/fork.c:3385 [inline]
\_\_se\_sys\_unshare kernel/fork.c:3383 [inline]
\_\_x64\_sys\_unshare+0x38/0x40 kernel/fork.c:3383
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 12:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:582
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:233 [inline]
slab\_free\_hook mm/slub.c:2338 [inline]
slab\_free mm/slub.c:4598 [inline]
kfree+0x196/0x420 mm/slub.c:4746
netdev\_exit+0x65/0xd0 net/core/dev.c:11992
ops\_exit\_list net/core/net\_namespace.c:172 [inline]
cleanup\_net+0x802/0xcc0 net/core/net\_namespace.c:632
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xa63/0x1850 kernel/workqueue.c:3310
worker\_thread+0x870/0xd30 kernel/workqueue.c:3391
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
The buggy address belongs to the object at ffff888043eba000
which belongs to the cache kmalloc-2k of size 2048
The buggy address is located 432 bytes inside of
freed 2048-byte region [ffff888043eba000, ffff888043eba800)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x43eb8
head: order:3 mapcount:0 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
flags: 0x4fff00000000040(head|node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000040 ffff88801ac42000 dead000000000122 0000000000000000
raw: 0000000000000000 0000000000080008 00000001f5000000 0000000000000000
head: 04fff00000000040 ffff88801ac42000 dead000000000122 0000000000000000
head: 0000000000000000 0000000000080008 00000001f5000000 0000000000000000
head: 04fff00000000003 ffffea00010fae01 ffffffffffffffff 0000000000000000
head: 0000000000000008 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 3, migratetype Unmovable, gfp\_mask 0xd20c0(\_\_GFP\_IO|\_\_GFP\_FS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP|\_\_GFP\_NOMEMALLOC), pid 5339, tgid 5338 (syz.0.0), ts 69674195892, free\_ts 69663220888
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1556
prep\_new\_page mm/page\_alloc.c:1564 [inline]
get\_page\_from\_freelist+0x3649/0x3790 mm/page\_alloc.c:3474
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4751
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_slab\_page+0x6a/0x140 mm/slub.c:2408
allocate\_slab+0x5a/0x2f0 mm/slub.c:2574
new\_slab mm/slub.c:2627 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3815
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3905
\_\_slab\_alloc\_node mm/slub.c:3980 [inline]
slab\_alloc\_node mm/slub.c:4141 [inline]
\_\_do\_kmalloc\_node mm/slub.c:4282 [inline]
\_\_kmalloc\_noprof+0x2e6/0x4c0 mm/slub.c:4295
kmalloc\_noprof include/linux/slab.h:905 [inline]
sk\_prot\_alloc+0xe0/0x210 net/core/sock.c:2165
sk\_alloc+0x38/0x370 net/core/sock.c:2218
\_\_netlink\_create+0x65/0x260 net/netlink/af\_netlink.c:629
\_\_netlink\_kernel\_create+0x174/0x6f0 net/netlink/af\_netlink.c:2015
netlink\_kernel\_create include/linux/netlink.h:62 [inline]
uevent\_net\_init+0xed/0x2d0 lib/kobject\_uevent.c:783
ops\_init+0x31e/0x590 net/core/net\_namespace.c:138
setup\_net+0x287/0x9e0 net/core/net\_namespace.c:362
page last free pid 1032 tgid 1032 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1127 [inline]
free\_unref\_page+0xdf9/0x1140 mm/page\_alloc.c:2657
\_\_slab\_free+0x31b/0x3d0 mm/slub.c:4509
qlink\_free mm/kasan/quarantine.c:163 [inline]
qlist\_free\_all+0x9a/0x140 mm/kasan/quarantine.c:179
kasan\_quarantine\_reduce+0x14f/0x170 mm/kasan/quarantine.c:286
\_\_kasan\_slab\_alloc+0x23/0x80 mm/kasan/common.c:329
kasan\_slab\_alloc include/linux/kasan.h:250 [inline]
slab\_post\_alloc\_hook mm/slub.c:4104 [inline]
slab\_alloc\_node mm/slub.c:4153 [inline]
kmem\_cache\_alloc\_node\_noprof+0x1d9/0x380 mm/slub.c:4205
\_\_alloc\_skb+0x1c3/0x440 net/core/skbuff.c:668
alloc\_skb include/linux/skbuff.h:1323 [inline]
alloc\_skb\_with\_frags+0xc3/0x820 net/core/skbuff.c:6612
sock\_alloc\_send\_pskb+0x91a/0xa60 net/core/sock.c:2881
sock\_alloc\_send\_skb include/net/sock.h:1797 [inline]
mld\_newpack+0x1c3/0xaf0 net/ipv6/mcast.c:1747
add\_grhead net/ipv6/mcast.c:1850 [inline]
add\_grec+0x1492/0x19a0 net/ipv6/mcast.c:1988
mld\_send\_initial\_cr+0x228/0x4b0 net/ipv6/mcast.c:2234
ipv6\_mc\_dad\_complete+0x88/0x490 net/ipv6/mcast.c:2245
addrconf\_dad\_completed+0x712/0xcd0 net/ipv6/addrconf.c:4342
addrconf\_dad\_work+0xdc2/0x16f0
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xa63/0x1850 kernel/workqueue.c:3310
Memory state around the buggy address:
ffff888043eba080: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff888043eba100: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
>ffff888043eba180: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
^
ffff888043eba200: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff888043eba280: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
Fixes: 8c55facecd7a ("net: linkwatch: only report IF\_OPER\_LOWERLAYERDOWN if iflink is actually down")
Reported-by: syzbot+1939f24bdb783e9e43d9@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/674f3a18.050a0220.48a03.0041.GAE@google.com/T/#u
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Link: [https://patch.msgid.link/20241203170933.2449307-1-edumazet@google.com](https://patch.msgid.link/20241203170933.2449307-1-edumazet%40google.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3265aab0736f78bb218200b06b1abb525c316269)

| -rw-r--r-- | [net/core/link\_watch.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/link_watch.c?id=3265aab0736f78bb218200b06b1abb525c316269) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/net/core/link\_watch.c b/net/core/link\_watch.cindex cf867f6e38bf17..66422c95c83c77 100644--- a/[net/core/link\_watch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/link_watch.c?id=4bd8ced2b9f65b75cedeaa66c4ffe6ab2a853b6e)+++ b/[net/core/link\_watch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/link_watch.c?id=3265aab0736f78bb218200b06b1abb525c316269)@@ -45,9 +45,14 @@ static unsigned char default\_operstate(const struct net\_device \*dev) int iflink = dev\_get\_iflink(dev); struct net\_device \*peer; - if (iflink == dev->ifindex)+ /\* If called from netdev\_run\_todo()/linkwatch\_sync\_dev(),+ \* dev\_net(dev) can be already freed, and RTNL is not held.+ \*/+ if (dev->reg\_state == NETREG\_UNREGISTERED ||+ iflink == dev->ifindex) return IF\_OPER\_DOWN; + ASSERT\_RTNL(); peer = \_\_dev\_get\_by\_index(dev\_net(dev), iflink); if (!peer) return IF\_OPER\_DOWN; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:03:05 +0000



=== Content from git.kernel.org_8c2a3261_20250115_090427.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=316183d58319f191e16503bc2dffa156c4442df2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=316183d58319f191e16503bc2dffa156c4442df2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=316183d58319f191e16503bc2dffa156c4442df2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=316183d58319f191e16503bc2dffa156c4442df2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-12-03 17:09:33 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:10 +0100 |
| commit | [316183d58319f191e16503bc2dffa156c4442df2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=316183d58319f191e16503bc2dffa156c4442df2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=316183d58319f191e16503bc2dffa156c4442df2)) | |
| tree | [9149f682e26df76cc04f321a80718c08ce16cc67](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=316183d58319f191e16503bc2dffa156c4442df2) | |
| parent | [876113e99ae15ae5bd3672baee3f48e492c6c64e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=876113e99ae15ae5bd3672baee3f48e492c6c64e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=316183d58319f191e16503bc2dffa156c4442df2&id2=876113e99ae15ae5bd3672baee3f48e492c6c64e)) | |
| download | [linux-316183d58319f191e16503bc2dffa156c4442df2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-316183d58319f191e16503bc2dffa156c4442df2.tar.gz) | |

net: avoid potential UAF in default\_operstate()[ Upstream commit 750e51603395e755537da08f745864c93e3ce741 ]
syzbot reported an UAF in default\_operstate() [1]
Issue is a race between device and netns dismantles.
After calling \_\_rtnl\_unlock() from netdev\_run\_todo(),
we can not assume the netns of each device is still alive.
Make sure the device is not in NETREG\_UNREGISTERED state,
and add an ASSERT\_RTNL() before the call to
\_\_dev\_get\_by\_index().
We might move this ASSERT\_RTNL() in \_\_dev\_get\_by\_index()
in the future.
[1]
BUG: KASAN: slab-use-after-free in \_\_dev\_get\_by\_index+0x5d/0x110 net/core/dev.c:852
Read of size 8 at addr ffff888043eba1b0 by task syz.0.0/5339
CPU: 0 UID: 0 PID: 5339 Comm: syz.0.0 Not tainted 6.12.0-syzkaller-10296-gaaf20f870da0 #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:378 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:489
kasan\_report+0x143/0x180 mm/kasan/report.c:602
\_\_dev\_get\_by\_index+0x5d/0x110 net/core/dev.c:852
default\_operstate net/core/link\_watch.c:51 [inline]
rfc2863\_policy+0x224/0x300 net/core/link\_watch.c:67
linkwatch\_do\_dev+0x3e/0x170 net/core/link\_watch.c:170
netdev\_run\_todo+0x461/0x1000 net/core/dev.c:10894
rtnl\_unlock net/core/rtnetlink.c:152 [inline]
rtnl\_net\_unlock include/linux/rtnetlink.h:133 [inline]
rtnl\_dellink+0x760/0x8d0 net/core/rtnetlink.c:3520
rtnetlink\_rcv\_msg+0x791/0xcf0 net/core/rtnetlink.c:6911
netlink\_rcv\_skb+0x1e3/0x430 net/netlink/af\_netlink.c:2541
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1321 [inline]
netlink\_unicast+0x7f6/0x990 net/netlink/af\_netlink.c:1347
netlink\_sendmsg+0x8e4/0xcb0 net/netlink/af\_netlink.c:1891
sock\_sendmsg\_nosec net/socket.c:711 [inline]
\_\_sock\_sendmsg+0x221/0x270 net/socket.c:726
\_\_\_\_sys\_sendmsg+0x52a/0x7e0 net/socket.c:2583
\_\_\_sys\_sendmsg net/socket.c:2637 [inline]
\_\_sys\_sendmsg+0x269/0x350 net/socket.c:2669
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f2a3cb80809
Code: ff ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 a8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f2a3d9cd058 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00007f2a3cd45fa0 RCX: 00007f2a3cb80809
RDX: 0000000000000000 RSI: 0000000020000000 RDI: 0000000000000008
RBP: 00007f2a3cbf393e R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f2a3cd45fa0 R15: 00007ffd03bc65c8
</TASK>
Allocated by task 5339:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0x98/0xb0 mm/kasan/common.c:394
kasan\_kmalloc include/linux/kasan.h:260 [inline]
\_\_kmalloc\_cache\_noprof+0x243/0x390 mm/slub.c:4314
kmalloc\_noprof include/linux/slab.h:901 [inline]
kmalloc\_array\_noprof include/linux/slab.h:945 [inline]
netdev\_create\_hash net/core/dev.c:11870 [inline]
netdev\_init+0x10c/0x250 net/core/dev.c:11890
ops\_init+0x31e/0x590 net/core/net\_namespace.c:138
setup\_net+0x287/0x9e0 net/core/net\_namespace.c:362
copy\_net\_ns+0x33f/0x570 net/core/net\_namespace.c:500
create\_new\_namespaces+0x425/0x7b0 kernel/nsproxy.c:110
unshare\_nsproxy\_namespaces+0x124/0x180 kernel/nsproxy.c:228
ksys\_unshare+0x57d/0xa70 kernel/fork.c:3314
\_\_do\_sys\_unshare kernel/fork.c:3385 [inline]
\_\_se\_sys\_unshare kernel/fork.c:3383 [inline]
\_\_x64\_sys\_unshare+0x38/0x40 kernel/fork.c:3383
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 12:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:582
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:233 [inline]
slab\_free\_hook mm/slub.c:2338 [inline]
slab\_free mm/slub.c:4598 [inline]
kfree+0x196/0x420 mm/slub.c:4746
netdev\_exit+0x65/0xd0 net/core/dev.c:11992
ops\_exit\_list net/core/net\_namespace.c:172 [inline]
cleanup\_net+0x802/0xcc0 net/core/net\_namespace.c:632
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xa63/0x1850 kernel/workqueue.c:3310
worker\_thread+0x870/0xd30 kernel/workqueue.c:3391
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
The buggy address belongs to the object at ffff888043eba000
which belongs to the cache kmalloc-2k of size 2048
The buggy address is located 432 bytes inside of
freed 2048-byte region [ffff888043eba000, ffff888043eba800)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x43eb8
head: order:3 mapcount:0 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
flags: 0x4fff00000000040(head|node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000040 ffff88801ac42000 dead000000000122 0000000000000000
raw: 0000000000000000 0000000000080008 00000001f5000000 0000000000000000
head: 04fff00000000040 ffff88801ac42000 dead000000000122 0000000000000000
head: 0000000000000000 0000000000080008 00000001f5000000 0000000000000000
head: 04fff00000000003 ffffea00010fae01 ffffffffffffffff 0000000000000000
head: 0000000000000008 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 3, migratetype Unmovable, gfp\_mask 0xd20c0(\_\_GFP\_IO|\_\_GFP\_FS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP|\_\_GFP\_NOMEMALLOC), pid 5339, tgid 5338 (syz.0.0), ts 69674195892, free\_ts 69663220888
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1556
prep\_new\_page mm/page\_alloc.c:1564 [inline]
get\_page\_from\_freelist+0x3649/0x3790 mm/page\_alloc.c:3474
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4751
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_slab\_page+0x6a/0x140 mm/slub.c:2408
allocate\_slab+0x5a/0x2f0 mm/slub.c:2574
new\_slab mm/slub.c:2627 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3815
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3905
\_\_slab\_alloc\_node mm/slub.c:3980 [inline]
slab\_alloc\_node mm/slub.c:4141 [inline]
\_\_do\_kmalloc\_node mm/slub.c:4282 [inline]
\_\_kmalloc\_noprof+0x2e6/0x4c0 mm/slub.c:4295
kmalloc\_noprof include/linux/slab.h:905 [inline]
sk\_prot\_alloc+0xe0/0x210 net/core/sock.c:2165
sk\_alloc+0x38/0x370 net/core/sock.c:2218
\_\_netlink\_create+0x65/0x260 net/netlink/af\_netlink.c:629
\_\_netlink\_kernel\_create+0x174/0x6f0 net/netlink/af\_netlink.c:2015
netlink\_kernel\_create include/linux/netlink.h:62 [inline]
uevent\_net\_init+0xed/0x2d0 lib/kobject\_uevent.c:783
ops\_init+0x31e/0x590 net/core/net\_namespace.c:138
setup\_net+0x287/0x9e0 net/core/net\_namespace.c:362
page last free pid 1032 tgid 1032 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1127 [inline]
free\_unref\_page+0xdf9/0x1140 mm/page\_alloc.c:2657
\_\_slab\_free+0x31b/0x3d0 mm/slub.c:4509
qlink\_free mm/kasan/quarantine.c:163 [inline]
qlist\_free\_all+0x9a/0x140 mm/kasan/quarantine.c:179
kasan\_quarantine\_reduce+0x14f/0x170 mm/kasan/quarantine.c:286
\_\_kasan\_slab\_alloc+0x23/0x80 mm/kasan/common.c:329
kasan\_slab\_alloc include/linux/kasan.h:250 [inline]
slab\_post\_alloc\_hook mm/slub.c:4104 [inline]
slab\_alloc\_node mm/slub.c:4153 [inline]
kmem\_cache\_alloc\_node\_noprof+0x1d9/0x380 mm/slub.c:4205
\_\_alloc\_skb+0x1c3/0x440 net/core/skbuff.c:668
alloc\_skb include/linux/skbuff.h:1323 [inline]
alloc\_skb\_with\_frags+0xc3/0x820 net/core/skbuff.c:6612
sock\_alloc\_send\_pskb+0x91a/0xa60 net/core/sock.c:2881
sock\_alloc\_send\_skb include/net/sock.h:1797 [inline]
mld\_newpack+0x1c3/0xaf0 net/ipv6/mcast.c:1747
add\_grhead net/ipv6/mcast.c:1850 [inline]
add\_grec+0x1492/0x19a0 net/ipv6/mcast.c:1988
mld\_send\_initial\_cr+0x228/0x4b0 net/ipv6/mcast.c:2234
ipv6\_mc\_dad\_complete+0x88/0x490 net/ipv6/mcast.c:2245
addrconf\_dad\_completed+0x712/0xcd0 net/ipv6/addrconf.c:4342
addrconf\_dad\_work+0xdc2/0x16f0
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xa63/0x1850 kernel/workqueue.c:3310
Memory state around the buggy address:
ffff888043eba080: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff888043eba100: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
>ffff888043eba180: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
^
ffff888043eba200: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff888043eba280: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
Fixes: 8c55facecd7a ("net: linkwatch: only report IF\_OPER\_LOWERLAYERDOWN if iflink is actually down")
Reported-by: syzbot+1939f24bdb783e9e43d9@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/674f3a18.050a0220.48a03.0041.GAE@google.com/T/#u
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Link: [https://patch.msgid.link/20241203170933.2449307-1-edumazet@google.com](https://patch.msgid.link/20241203170933.2449307-1-edumazet%40google.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=316183d58319f191e16503bc2dffa156c4442df2)

| -rw-r--r-- | [net/core/link\_watch.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/link_watch.c?id=316183d58319f191e16503bc2dffa156c4442df2) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/net/core/link\_watch.c b/net/core/link\_watch.cindex ab150641142aa1..1b4d39e3808427 100644--- a/[net/core/link\_watch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/link_watch.c?id=876113e99ae15ae5bd3672baee3f48e492c6c64e)+++ b/[net/core/link\_watch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/link_watch.c?id=316183d58319f191e16503bc2dffa156c4442df2)@@ -45,9 +45,14 @@ static unsigned int default\_operstate(const struct net\_device \*dev) int iflink = dev\_get\_iflink(dev); struct net\_device \*peer; - if (iflink == dev->ifindex)+ /\* If called from netdev\_run\_todo()/linkwatch\_sync\_dev(),+ \* dev\_net(dev) can be already freed, and RTNL is not held.+ \*/+ if (dev->reg\_state == NETREG\_UNREGISTERED ||+ iflink == dev->ifindex) return IF\_OPER\_DOWN; + ASSERT\_RTNL(); peer = \_\_dev\_get\_by\_index(dev\_net(dev), iflink); if (!peer) return IF\_OPER\_DOWN; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:03:04 +0000



=== Content from git.kernel.org_66873ce3_20250115_090428.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=750e51603395e755537da08f745864c93e3ce741)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=750e51603395e755537da08f745864c93e3ce741)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=750e51603395e755537da08f745864c93e3ce741)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=750e51603395e755537da08f745864c93e3ce741)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-12-03 17:09:33 +0000 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-12-05 11:57:26 +0100 |
| commit | [750e51603395e755537da08f745864c93e3ce741](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=750e51603395e755537da08f745864c93e3ce741) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=750e51603395e755537da08f745864c93e3ce741)) | |
| tree | [20a39a3dd4477bc1bf44a11554383290f15aa73a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=750e51603395e755537da08f745864c93e3ce741) | |
| parent | [7b998e073ff217f140acb59bc38e822e3cdf7612](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b998e073ff217f140acb59bc38e822e3cdf7612) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=750e51603395e755537da08f745864c93e3ce741&id2=7b998e073ff217f140acb59bc38e822e3cdf7612)) | |
| download | [linux-750e51603395e755537da08f745864c93e3ce741.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-750e51603395e755537da08f745864c93e3ce741.tar.gz) | |

net: avoid potential UAF in default\_operstate()syzbot reported an UAF in default\_operstate() [1]
Issue is a race between device and netns dismantles.
After calling \_\_rtnl\_unlock() from netdev\_run\_todo(),
we can not assume the netns of each device is still alive.
Make sure the device is not in NETREG\_UNREGISTERED state,
and add an ASSERT\_RTNL() before the call to
\_\_dev\_get\_by\_index().
We might move this ASSERT\_RTNL() in \_\_dev\_get\_by\_index()
in the future.
[1]
BUG: KASAN: slab-use-after-free in \_\_dev\_get\_by\_index+0x5d/0x110 net/core/dev.c:852
Read of size 8 at addr ffff888043eba1b0 by task syz.0.0/5339
CPU: 0 UID: 0 PID: 5339 Comm: syz.0.0 Not tainted 6.12.0-syzkaller-10296-gaaf20f870da0 #0
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
print\_address\_description mm/kasan/report.c:378 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:489
kasan\_report+0x143/0x180 mm/kasan/report.c:602
\_\_dev\_get\_by\_index+0x5d/0x110 net/core/dev.c:852
default\_operstate net/core/link\_watch.c:51 [inline]
rfc2863\_policy+0x224/0x300 net/core/link\_watch.c:67
linkwatch\_do\_dev+0x3e/0x170 net/core/link\_watch.c:170
netdev\_run\_todo+0x461/0x1000 net/core/dev.c:10894
rtnl\_unlock net/core/rtnetlink.c:152 [inline]
rtnl\_net\_unlock include/linux/rtnetlink.h:133 [inline]
rtnl\_dellink+0x760/0x8d0 net/core/rtnetlink.c:3520
rtnetlink\_rcv\_msg+0x791/0xcf0 net/core/rtnetlink.c:6911
netlink\_rcv\_skb+0x1e3/0x430 net/netlink/af\_netlink.c:2541
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1321 [inline]
netlink\_unicast+0x7f6/0x990 net/netlink/af\_netlink.c:1347
netlink\_sendmsg+0x8e4/0xcb0 net/netlink/af\_netlink.c:1891
sock\_sendmsg\_nosec net/socket.c:711 [inline]
\_\_sock\_sendmsg+0x221/0x270 net/socket.c:726
\_\_\_\_sys\_sendmsg+0x52a/0x7e0 net/socket.c:2583
\_\_\_sys\_sendmsg net/socket.c:2637 [inline]
\_\_sys\_sendmsg+0x269/0x350 net/socket.c:2669
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f2a3cb80809
Code: ff ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 a8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f2a3d9cd058 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00007f2a3cd45fa0 RCX: 00007f2a3cb80809
RDX: 0000000000000000 RSI: 0000000020000000 RDI: 0000000000000008
RBP: 00007f2a3cbf393e R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f2a3cd45fa0 R15: 00007ffd03bc65c8
</TASK>
Allocated by task 5339:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
poison\_kmalloc\_redzone mm/kasan/common.c:377 [inline]
\_\_kasan\_kmalloc+0x98/0xb0 mm/kasan/common.c:394
kasan\_kmalloc include/linux/kasan.h:260 [inline]
\_\_kmalloc\_cache\_noprof+0x243/0x390 mm/slub.c:4314
kmalloc\_noprof include/linux/slab.h:901 [inline]
kmalloc\_array\_noprof include/linux/slab.h:945 [inline]
netdev\_create\_hash net/core/dev.c:11870 [inline]
netdev\_init+0x10c/0x250 net/core/dev.c:11890
ops\_init+0x31e/0x590 net/core/net\_namespace.c:138
setup\_net+0x287/0x9e0 net/core/net\_namespace.c:362
copy\_net\_ns+0x33f/0x570 net/core/net\_namespace.c:500
create\_new\_namespaces+0x425/0x7b0 kernel/nsproxy.c:110
unshare\_nsproxy\_namespaces+0x124/0x180 kernel/nsproxy.c:228
ksys\_unshare+0x57d/0xa70 kernel/fork.c:3314
\_\_do\_sys\_unshare kernel/fork.c:3385 [inline]
\_\_se\_sys\_unshare kernel/fork.c:3383 [inline]
\_\_x64\_sys\_unshare+0x38/0x40 kernel/fork.c:3383
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 12:
kasan\_save\_stack mm/kasan/common.c:47 [inline]
kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68
kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:582
poison\_slab\_object mm/kasan/common.c:247 [inline]
\_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264
kasan\_slab\_free include/linux/kasan.h:233 [inline]
slab\_free\_hook mm/slub.c:2338 [inline]
slab\_free mm/slub.c:4598 [inline]
kfree+0x196/0x420 mm/slub.c:4746
netdev\_exit+0x65/0xd0 net/core/dev.c:11992
ops\_exit\_list net/core/net\_namespace.c:172 [inline]
cleanup\_net+0x802/0xcc0 net/core/net\_namespace.c:632
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xa63/0x1850 kernel/workqueue.c:3310
worker\_thread+0x870/0xd30 kernel/workqueue.c:3391
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
The buggy address belongs to the object at ffff888043eba000
which belongs to the cache kmalloc-2k of size 2048
The buggy address is located 432 bytes inside of
freed 2048-byte region [ffff888043eba000, ffff888043eba800)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x43eb8
head: order:3 mapcount:0 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
flags: 0x4fff00000000040(head|node=1|zone=1|lastcpupid=0x7ff)
page\_type: f5(slab)
raw: 04fff00000000040 ffff88801ac42000 dead000000000122 0000000000000000
raw: 0000000000000000 0000000000080008 00000001f5000000 0000000000000000
head: 04fff00000000040 ffff88801ac42000 dead000000000122 0000000000000000
head: 0000000000000000 0000000000080008 00000001f5000000 0000000000000000
head: 04fff00000000003 ffffea00010fae01 ffffffffffffffff 0000000000000000
head: 0000000000000008 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 3, migratetype Unmovable, gfp\_mask 0xd20c0(\_\_GFP\_IO|\_\_GFP\_FS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP|\_\_GFP\_NOMEMALLOC), pid 5339, tgid 5338 (syz.0.0), ts 69674195892, free\_ts 69663220888
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1556
prep\_new\_page mm/page\_alloc.c:1564 [inline]
get\_page\_from\_freelist+0x3649/0x3790 mm/page\_alloc.c:3474
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4751
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
alloc\_slab\_page+0x6a/0x140 mm/slub.c:2408
allocate\_slab+0x5a/0x2f0 mm/slub.c:2574
new\_slab mm/slub.c:2627 [inline]
\_\_\_slab\_alloc+0xcd1/0x14b0 mm/slub.c:3815
\_\_slab\_alloc+0x58/0xa0 mm/slub.c:3905
\_\_slab\_alloc\_node mm/slub.c:3980 [inline]
slab\_alloc\_node mm/slub.c:4141 [inline]
\_\_do\_kmalloc\_node mm/slub.c:4282 [inline]
\_\_kmalloc\_noprof+0x2e6/0x4c0 mm/slub.c:4295
kmalloc\_noprof include/linux/slab.h:905 [inline]
sk\_prot\_alloc+0xe0/0x210 net/core/sock.c:2165
sk\_alloc+0x38/0x370 net/core/sock.c:2218
\_\_netlink\_create+0x65/0x260 net/netlink/af\_netlink.c:629
\_\_netlink\_kernel\_create+0x174/0x6f0 net/netlink/af\_netlink.c:2015
netlink\_kernel\_create include/linux/netlink.h:62 [inline]
uevent\_net\_init+0xed/0x2d0 lib/kobject\_uevent.c:783
ops\_init+0x31e/0x590 net/core/net\_namespace.c:138
setup\_net+0x287/0x9e0 net/core/net\_namespace.c:362
page last free pid 1032 tgid 1032 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1127 [inline]
free\_unref\_page+0xdf9/0x1140 mm/page\_alloc.c:2657
\_\_slab\_free+0x31b/0x3d0 mm/slub.c:4509
qlink\_free mm/kasan/quarantine.c:163 [inline]
qlist\_free\_all+0x9a/0x140 mm/kasan/quarantine.c:179
kasan\_quarantine\_reduce+0x14f/0x170 mm/kasan/quarantine.c:286
\_\_kasan\_slab\_alloc+0x23/0x80 mm/kasan/common.c:329
kasan\_slab\_alloc include/linux/kasan.h:250 [inline]
slab\_post\_alloc\_hook mm/slub.c:4104 [inline]
slab\_alloc\_node mm/slub.c:4153 [inline]
kmem\_cache\_alloc\_node\_noprof+0x1d9/0x380 mm/slub.c:4205
\_\_alloc\_skb+0x1c3/0x440 net/core/skbuff.c:668
alloc\_skb include/linux/skbuff.h:1323 [inline]
alloc\_skb\_with\_frags+0xc3/0x820 net/core/skbuff.c:6612
sock\_alloc\_send\_pskb+0x91a/0xa60 net/core/sock.c:2881
sock\_alloc\_send\_skb include/net/sock.h:1797 [inline]
mld\_newpack+0x1c3/0xaf0 net/ipv6/mcast.c:1747
add\_grhead net/ipv6/mcast.c:1850 [inline]
add\_grec+0x1492/0x19a0 net/ipv6/mcast.c:1988
mld\_send\_initial\_cr+0x228/0x4b0 net/ipv6/mcast.c:2234
ipv6\_mc\_dad\_complete+0x88/0x490 net/ipv6/mcast.c:2245
addrconf\_dad\_completed+0x712/0xcd0 net/ipv6/addrconf.c:4342
addrconf\_dad\_work+0xdc2/0x16f0
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0xa63/0x1850 kernel/workqueue.c:3310
Memory state around the buggy address:
ffff888043eba080: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff888043eba100: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
>ffff888043eba180: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
^
ffff888043eba200: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff888043eba280: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
Fixes: 8c55facecd7a ("net: linkwatch: only report IF\_OPER\_LOWERLAYERDOWN if iflink is actually down")
Reported-by: syzbot+1939f24bdb783e9e43d9@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/674f3a18.050a0220.48a03.0041.GAE@google.com/T/#u
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Link: [https://patch.msgid.link/20241203170933.2449307-1-edumazet@google.com](https://patch.msgid.link/20241203170933.2449307-1-edumazet%40google.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=750e51603395e755537da08f745864c93e3ce741)

| -rw-r--r-- | [net/core/link\_watch.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/link_watch.c?id=750e51603395e755537da08f745864c93e3ce741) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/net/core/link\_watch.c b/net/core/link\_watch.cindex ab150641142aa1..1b4d39e3808427 100644--- a/[net/core/link\_watch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/link_watch.c?id=7b998e073ff217f140acb59bc38e822e3cdf7612)+++ b/[net/core/link\_watch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/link_watch.c?id=750e51603395e755537da08f745864c93e3ce741)@@ -45,9 +45,14 @@ static unsigned int default\_operstate(const struct net\_device \*dev) int iflink = dev\_get\_iflink(dev); struct net\_device \*peer; - if (iflink == dev->ifindex)+ /\* If called from netdev\_run\_todo()/linkwatch\_sync\_dev(),+ \* dev\_net(dev) can be already freed, and RTNL is not held.+ \*/+ if (dev->reg\_state == NETREG\_UNREGISTERED ||+ iflink == dev->ifindex) return IF\_OPER\_DOWN; + ASSERT\_RTNL(); peer = \_\_dev\_get\_by\_index(dev\_net(dev), iflink); if (!peer) return IF\_OPER\_DOWN; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:03:05 +0000


