=== Content from git.kernel.org_c2ad4923_20250114_205656.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Thumshirn <johannes.thumshirn@wdc.com> | 2024-11-13 18:16:48 +0100 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2024-11-28 20:45:43 +0100 |
| commit | [05b36b04d74a517d6675bf2f90829ff1ac7e28dc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc)) | |
| tree | [bd6f2f3e0012ebfc0a8d8d3f9f43041b9b3c23c7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc) | |
| parent | [e82c936293aafb4f33b153c684c37291b3eed377](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e82c936293aafb4f33b153c684c37291b3eed377) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc&id2=e82c936293aafb4f33b153c684c37291b3eed377)) | |
| download | [linux-05b36b04d74a517d6675bf2f90829ff1ac7e28dc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-05b36b04d74a517d6675bf2f90829ff1ac7e28dc.tar.gz) | |

btrfs: fix use-after-free in btrfs\_encoded\_read\_endio()Shinichiro reported the following use-after free that sometimes is
happening in our CI system when running fstests' btrfs/284 on a TCMU
runner device:
BUG: KASAN: slab-use-after-free in lock\_release+0x708/0x780
Read of size 8 at addr ffff888106a83f18 by task kworker/u80:6/219
CPU: 8 UID: 0 PID: 219 Comm: kworker/u80:6 Not tainted 6.12.0-rc6-kts+ #15
Hardware name: Supermicro Super Server/X11SPi-TF, BIOS 3.3 02/21/2020
Workqueue: btrfs-endio btrfs\_end\_bio\_work [btrfs]
Call Trace:
<TASK>
dump\_stack\_lvl+0x6e/0xa0
? lock\_release+0x708/0x780
print\_report+0x174/0x505
? lock\_release+0x708/0x780
? \_\_virt\_addr\_valid+0x224/0x410
? lock\_release+0x708/0x780
kasan\_report+0xda/0x1b0
? lock\_release+0x708/0x780
? \_\_wake\_up+0x44/0x60
lock\_release+0x708/0x780
? \_\_pfx\_lock\_release+0x10/0x10
? \_\_pfx\_do\_raw\_spin\_lock+0x10/0x10
? lock\_is\_held\_type+0x9a/0x110
\_raw\_spin\_unlock\_irqrestore+0x1f/0x60
\_\_wake\_up+0x44/0x60
btrfs\_encoded\_read\_endio+0x14b/0x190 [btrfs]
btrfs\_check\_read\_bio+0x8d9/0x1360 [btrfs]
? lock\_release+0x1b0/0x780
? trace\_lock\_acquire+0x12f/0x1a0
? \_\_pfx\_btrfs\_check\_read\_bio+0x10/0x10 [btrfs]
? process\_one\_work+0x7e3/0x1460
? lock\_acquire+0x31/0xc0
? process\_one\_work+0x7e3/0x1460
process\_one\_work+0x85c/0x1460
? \_\_pfx\_process\_one\_work+0x10/0x10
? assign\_work+0x16c/0x240
worker\_thread+0x5e6/0xfc0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0x2c3/0x3a0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x70
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 3661:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
btrfs\_encoded\_read\_regular\_fill\_pages+0x16c/0x6d0 [btrfs]
send\_extent\_data+0xf0f/0x24a0 [btrfs]
process\_extent+0x48a/0x1830 [btrfs]
changed\_cb+0x178b/0x2ea0 [btrfs]
btrfs\_ioctl\_send+0x3bf9/0x5c20 [btrfs]
\_btrfs\_ioctl\_send+0x117/0x330 [btrfs]
btrfs\_ioctl+0x184a/0x60a0 [btrfs]
\_\_x64\_sys\_ioctl+0x12e/0x1a0
do\_syscall\_64+0x95/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Freed by task 3661:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x70
\_\_kasan\_slab\_free+0x4f/0x70
kfree+0x143/0x490
btrfs\_encoded\_read\_regular\_fill\_pages+0x531/0x6d0 [btrfs]
send\_extent\_data+0xf0f/0x24a0 [btrfs]
process\_extent+0x48a/0x1830 [btrfs]
changed\_cb+0x178b/0x2ea0 [btrfs]
btrfs\_ioctl\_send+0x3bf9/0x5c20 [btrfs]
\_btrfs\_ioctl\_send+0x117/0x330 [btrfs]
btrfs\_ioctl+0x184a/0x60a0 [btrfs]
\_\_x64\_sys\_ioctl+0x12e/0x1a0
do\_syscall\_64+0x95/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
The buggy address belongs to the object at ffff888106a83f00
which belongs to the cache kmalloc-rnd-07-96 of size 96
The buggy address is located 24 bytes inside of
freed 96-byte region [ffff888106a83f00, ffff888106a83f60)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff888106a83800 pfn:0x106a83
flags: 0x17ffffc0000000(node=0|zone=2|lastcpupid=0x1fffff)
page\_type: f5(slab)
raw: 0017ffffc0000000 ffff888100053680 ffffea0004917200 0000000000000004
raw: ffff888106a83800 0000000080200019 00000001f5000000 0000000000000000
page dumped because: kasan: bad access detected
Memory state around the buggy address:
ffff888106a83e00: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
ffff888106a83e80: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
>ffff888106a83f00: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
^
ffff888106a83f80: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
ffff888106a84000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
==================================================================
Further analyzing the trace and the crash dump's vmcore file shows that
the wake\_up() call in btrfs\_encoded\_read\_endio() is calling wake\_up() on
the wait\_queue that is in the private data passed to the end\_io handler.
Commit 4ff47df40447 ("btrfs: move priv off stack in
btrfs\_encoded\_read\_regular\_fill\_pages()") moved 'struct
btrfs\_encoded\_read\_private' off the stack.
Before that commit one can see a corruption of the private data when
analyzing the vmcore after a crash:
\*(struct btrfs\_encoded\_read\_private \*)0xffff88815626eec8 = {
.wait = (wait\_queue\_head\_t){
.lock = (spinlock\_t){
.rlock = (struct raw\_spinlock){
.raw\_lock = (arch\_spinlock\_t){
.val = (atomic\_t){
.counter = (int)-2005885696,
},
.locked = (u8)0,
.pending = (u8)157,
.locked\_pending = (u16)40192,
.tail = (u16)34928,
},
.magic = (unsigned int)536325682,
.owner\_cpu = (unsigned int)29,
.owner = (void \*)\_\_SCT\_\_tp\_func\_btrfs\_transaction\_commit+0x0 = 0x0,
.dep\_map = (struct lockdep\_map){
.key = (struct lock\_class\_key \*)0xffff8881575a3b6c,
.class\_cache = (struct lock\_class \*[2]){ 0xffff8882a71985c0, 0xffffea00066f5d40 },
.name = (const char \*)0xffff88815626f100 = "",
.wait\_type\_outer = (u8)37,
.wait\_type\_inner = (u8)178,
.lock\_type = (u8)154,
},
},
.\_\_padding = (u8 [24]){ 0, 157, 112, 136, 50, 174, 247, 31, 29 },
.dep\_map = (struct lockdep\_map){
.key = (struct lock\_class\_key \*)0xffff8881575a3b6c,
.class\_cache = (struct lock\_class \*[2]){ 0xffff8882a71985c0, 0xffffea00066f5d40 },
.name = (const char \*)0xffff88815626f100 = "",
.wait\_type\_outer = (u8)37,
.wait\_type\_inner = (u8)178,
.lock\_type = (u8)154,
},
},
.head = (struct list\_head){
.next = (struct list\_head \*)0x112cca,
.prev = (struct list\_head \*)0x47,
},
},
.pending = (atomic\_t){
.counter = (int)-1491499288,
},
.status = (blk\_status\_t)130,
}
Here we can see several indicators of in-memory data corruption, e.g. the
large negative atomic values of ->pending or
->wait->lock->rlock->raw\_lock->val, as well as the bogus spinlock magic
0x1ff7ae32 (decimal 536325682 above) instead of 0xdead4ead or the bogus
pointer values for ->wait->head.
To fix this, change atomic\_dec\_return() to atomic\_dec\_and\_test() to fix the
corruption, as atomic\_dec\_return() is defined as two instructions on
x86\_64, whereas atomic\_dec\_and\_test() is defined as a single atomic
operation. This can lead to a situation where counter value is already
decremented but the if statement in btrfs\_encoded\_read\_endio() is not
completely processed, i.e. the 0 test has not completed. If another thread
continues executing btrfs\_encoded\_read\_regular\_fill\_pages() the
atomic\_dec\_return() there can see an already updated ->pending counter and
continues by freeing the private data. Continuing in the endio handler the
test for 0 succeeds and the wait\_queue is woken up, resulting in a
use-after-free.
Reported-by: Shinichiro Kawasaki <shinichiro.kawasaki@wdc.com>
Suggested-by: Damien Le Moal <Damien.LeMoal@wdc.com>
Fixes: 1881fba89bd5 ("btrfs: add BTRFS\_IOC\_ENCODED\_READ ioctl")
CC: stable@vger.kernel.org # 6.1+
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc)

| -rw-r--r-- | [fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/inode.c?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/inode.c b/fs/btrfs/inode.cindex 22b8e2764619fb..fdad1adee1a33e 100644--- a/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=e82c936293aafb4f33b153c684c37291b3eed377)+++ b/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=05b36b04d74a517d6675bf2f90829ff1ac7e28dc)@@ -9089,7 +9089,7 @@ static void btrfs\_encoded\_read\_endio(struct btrfs\_bio \*bbio) \*/ WRITE\_ONCE(priv->status, bbio->bio.bi\_status); }- if (atomic\_dec\_return(&priv->pending) == 0) {+ if (atomic\_dec\_and\_test(&priv->pending)) { int err = blk\_status\_to\_errno(READ\_ONCE(priv->status));  if (priv->uring\_ctx) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:55:32 +0000



=== Content from git.kernel.org_d384f252_20250114_205656.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Thumshirn <johannes.thumshirn@wdc.com> | 2024-11-13 18:16:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:40:55 +0100 |
| commit | [f8a5129e4a9fc3f6aa3f137513253b51b31b94d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4)) | |
| tree | [13d714ff3e7d5e7ea65edd046e6c5fbc8e301501](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4) | |
| parent | [13bfaeafbfe3c9af38c0a838a0f718ea29645e87](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13bfaeafbfe3c9af38c0a838a0f718ea29645e87) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4&id2=13bfaeafbfe3c9af38c0a838a0f718ea29645e87)) | |
| download | [linux-f8a5129e4a9fc3f6aa3f137513253b51b31b94d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f8a5129e4a9fc3f6aa3f137513253b51b31b94d4.tar.gz) | |

btrfs: fix use-after-free in btrfs\_encoded\_read\_endio()[ Upstream commit 05b36b04d74a517d6675bf2f90829ff1ac7e28dc ]
Shinichiro reported the following use-after free that sometimes is
happening in our CI system when running fstests' btrfs/284 on a TCMU
runner device:
BUG: KASAN: slab-use-after-free in lock\_release+0x708/0x780
Read of size 8 at addr ffff888106a83f18 by task kworker/u80:6/219
CPU: 8 UID: 0 PID: 219 Comm: kworker/u80:6 Not tainted 6.12.0-rc6-kts+ #15
Hardware name: Supermicro Super Server/X11SPi-TF, BIOS 3.3 02/21/2020
Workqueue: btrfs-endio btrfs\_end\_bio\_work [btrfs]
Call Trace:
<TASK>
dump\_stack\_lvl+0x6e/0xa0
? lock\_release+0x708/0x780
print\_report+0x174/0x505
? lock\_release+0x708/0x780
? \_\_virt\_addr\_valid+0x224/0x410
? lock\_release+0x708/0x780
kasan\_report+0xda/0x1b0
? lock\_release+0x708/0x780
? \_\_wake\_up+0x44/0x60
lock\_release+0x708/0x780
? \_\_pfx\_lock\_release+0x10/0x10
? \_\_pfx\_do\_raw\_spin\_lock+0x10/0x10
? lock\_is\_held\_type+0x9a/0x110
\_raw\_spin\_unlock\_irqrestore+0x1f/0x60
\_\_wake\_up+0x44/0x60
btrfs\_encoded\_read\_endio+0x14b/0x190 [btrfs]
btrfs\_check\_read\_bio+0x8d9/0x1360 [btrfs]
? lock\_release+0x1b0/0x780
? trace\_lock\_acquire+0x12f/0x1a0
? \_\_pfx\_btrfs\_check\_read\_bio+0x10/0x10 [btrfs]
? process\_one\_work+0x7e3/0x1460
? lock\_acquire+0x31/0xc0
? process\_one\_work+0x7e3/0x1460
process\_one\_work+0x85c/0x1460
? \_\_pfx\_process\_one\_work+0x10/0x10
? assign\_work+0x16c/0x240
worker\_thread+0x5e6/0xfc0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0x2c3/0x3a0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x70
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 3661:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
btrfs\_encoded\_read\_regular\_fill\_pages+0x16c/0x6d0 [btrfs]
send\_extent\_data+0xf0f/0x24a0 [btrfs]
process\_extent+0x48a/0x1830 [btrfs]
changed\_cb+0x178b/0x2ea0 [btrfs]
btrfs\_ioctl\_send+0x3bf9/0x5c20 [btrfs]
\_btrfs\_ioctl\_send+0x117/0x330 [btrfs]
btrfs\_ioctl+0x184a/0x60a0 [btrfs]
\_\_x64\_sys\_ioctl+0x12e/0x1a0
do\_syscall\_64+0x95/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Freed by task 3661:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x70
\_\_kasan\_slab\_free+0x4f/0x70
kfree+0x143/0x490
btrfs\_encoded\_read\_regular\_fill\_pages+0x531/0x6d0 [btrfs]
send\_extent\_data+0xf0f/0x24a0 [btrfs]
process\_extent+0x48a/0x1830 [btrfs]
changed\_cb+0x178b/0x2ea0 [btrfs]
btrfs\_ioctl\_send+0x3bf9/0x5c20 [btrfs]
\_btrfs\_ioctl\_send+0x117/0x330 [btrfs]
btrfs\_ioctl+0x184a/0x60a0 [btrfs]
\_\_x64\_sys\_ioctl+0x12e/0x1a0
do\_syscall\_64+0x95/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
The buggy address belongs to the object at ffff888106a83f00
which belongs to the cache kmalloc-rnd-07-96 of size 96
The buggy address is located 24 bytes inside of
freed 96-byte region [ffff888106a83f00, ffff888106a83f60)
The buggy address belongs to the physical page:
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff888106a83800 pfn:0x106a83
flags: 0x17ffffc0000000(node=0|zone=2|lastcpupid=0x1fffff)
page\_type: f5(slab)
raw: 0017ffffc0000000 ffff888100053680 ffffea0004917200 0000000000000004
raw: ffff888106a83800 0000000080200019 00000001f5000000 0000000000000000
page dumped because: kasan: bad access detected
Memory state around the buggy address:
ffff888106a83e00: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
ffff888106a83e80: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
>ffff888106a83f00: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
^
ffff888106a83f80: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
ffff888106a84000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
==================================================================
Further analyzing the trace and the crash dump's vmcore file shows that
the wake\_up() call in btrfs\_encoded\_read\_endio() is calling wake\_up() on
the wait\_queue that is in the private data passed to the end\_io handler.
Commit 4ff47df40447 ("btrfs: move priv off stack in
btrfs\_encoded\_read\_regular\_fill\_pages()") moved 'struct
btrfs\_encoded\_read\_private' off the stack.
Before that commit one can see a corruption of the private data when
analyzing the vmcore after a crash:
\*(struct btrfs\_encoded\_read\_private \*)0xffff88815626eec8 = {
.wait = (wait\_queue\_head\_t){
.lock = (spinlock\_t){
.rlock = (struct raw\_spinlock){
.raw\_lock = (arch\_spinlock\_t){
.val = (atomic\_t){
.counter = (int)-2005885696,
},
.locked = (u8)0,
.pending = (u8)157,
.locked\_pending = (u16)40192,
.tail = (u16)34928,
},
.magic = (unsigned int)536325682,
.owner\_cpu = (unsigned int)29,
.owner = (void \*)\_\_SCT\_\_tp\_func\_btrfs\_transaction\_commit+0x0 = 0x0,
.dep\_map = (struct lockdep\_map){
.key = (struct lock\_class\_key \*)0xffff8881575a3b6c,
.class\_cache = (struct lock\_class \*[2]){ 0xffff8882a71985c0, 0xffffea00066f5d40 },
.name = (const char \*)0xffff88815626f100 = "",
.wait\_type\_outer = (u8)37,
.wait\_type\_inner = (u8)178,
.lock\_type = (u8)154,
},
},
.\_\_padding = (u8 [24]){ 0, 157, 112, 136, 50, 174, 247, 31, 29 },
.dep\_map = (struct lockdep\_map){
.key = (struct lock\_class\_key \*)0xffff8881575a3b6c,
.class\_cache = (struct lock\_class \*[2]){ 0xffff8882a71985c0, 0xffffea00066f5d40 },
.name = (const char \*)0xffff88815626f100 = "",
.wait\_type\_outer = (u8)37,
.wait\_type\_inner = (u8)178,
.lock\_type = (u8)154,
},
},
.head = (struct list\_head){
.next = (struct list\_head \*)0x112cca,
.prev = (struct list\_head \*)0x47,
},
},
.pending = (atomic\_t){
.counter = (int)-1491499288,
},
.status = (blk\_status\_t)130,
}
Here we can see several indicators of in-memory data corruption, e.g. the
large negative atomic values of ->pending or
->wait->lock->rlock->raw\_lock->val, as well as the bogus spinlock magic
0x1ff7ae32 (decimal 536325682 above) instead of 0xdead4ead or the bogus
pointer values for ->wait->head.
To fix this, change atomic\_dec\_return() to atomic\_dec\_and\_test() to fix the
corruption, as atomic\_dec\_return() is defined as two instructions on
x86\_64, whereas atomic\_dec\_and\_test() is defined as a single atomic
operation. This can lead to a situation where counter value is already
decremented but the if statement in btrfs\_encoded\_read\_endio() is not
completely processed, i.e. the 0 test has not completed. If another thread
continues executing btrfs\_encoded\_read\_regular\_fill\_pages() the
atomic\_dec\_return() there can see an already updated ->pending counter and
continues by freeing the private data. Continuing in the endio handler the
test for 0 succeeds and the wait\_queue is woken up, resulting in a
use-after-free.
Reported-by: Shinichiro Kawasaki <shinichiro.kawasaki@wdc.com>
Suggested-by: Damien Le Moal <Damien.LeMoal@wdc.com>
Fixes: 1881fba89bd5 ("btrfs: add BTRFS\_IOC\_ENCODED\_READ ioctl")
CC: stable@vger.kernel.org # 6.1+
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4)

| -rw-r--r-- | [fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/inode.c?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/btrfs/inode.c b/fs/btrfs/inode.cindex 857cbe9b07d28d..d067db2619713f 100644--- a/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=13bfaeafbfe3c9af38c0a838a0f718ea29645e87)+++ b/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=f8a5129e4a9fc3f6aa3f137513253b51b31b94d4)@@ -9126,7 +9126,7 @@ static void btrfs\_encoded\_read\_endio(struct btrfs\_bio \*bbio) \*/ WRITE\_ONCE(priv->status, bbio->bio.bi\_status); }- if (!atomic\_dec\_return(&priv->pending))+ if (atomic\_dec\_and\_test(&priv->pending)) wake\_up(&priv->wait); bio\_put(&bbio->bio); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:55:33 +0000


