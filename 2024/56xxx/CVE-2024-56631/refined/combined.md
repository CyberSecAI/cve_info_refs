=== Content from git.kernel.org_6da3d8a4_20250114_195212.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Suraj Sonawane <surajsonawane0215@gmail.com> | 2024-11-20 18:29:44 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 20:03:18 +0100 |
| commit | [1f5e2f1ca5875728fcf62bc1a054707444ab4960](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960)) | |
| tree | [912f6a3dc6f0e40a8387cdb570878b3cbdff6c4c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960) | |
| parent | [05b436f3cf65c957eff86c5ea5ddfa2604b32c63](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05b436f3cf65c957eff86c5ea5ddfa2604b32c63) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960&id2=05b436f3cf65c957eff86c5ea5ddfa2604b32c63)) | |
| download | [linux-1f5e2f1ca5875728fcf62bc1a054707444ab4960.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1f5e2f1ca5875728fcf62bc1a054707444ab4960.tar.gz) | |

scsi: sg: Fix slab-use-after-free read in sg\_release()[ Upstream commit f10593ad9bc36921f623361c9e3dd96bd52d85ee ]
Fix a use-after-free bug in sg\_release(), detected by syzbot with KASAN:
BUG: KASAN: slab-use-after-free in lock\_release+0x151/0xa30
kernel/locking/lockdep.c:5838
\_\_mutex\_unlock\_slowpath+0xe2/0x750 kernel/locking/mutex.c:912
sg\_release+0x1f4/0x2e0 drivers/scsi/sg.c:407
In sg\_release(), the function kref\_put(&sfp->f\_ref, sg\_remove\_sfp) is
called before releasing the open\_rel\_lock mutex. The kref\_put() call may
decrement the reference count of sfp to zero, triggering its cleanup
through sg\_remove\_sfp(). This cleanup includes scheduling deferred work
via sg\_remove\_sfp\_usercontext(), which ultimately frees sfp.
After kref\_put(), sg\_release() continues to unlock open\_rel\_lock and may
reference sfp or sdp. If sfp has already been freed, this results in a
slab-use-after-free error.
Move the kref\_put(&sfp->f\_ref, sg\_remove\_sfp) call after unlocking the
open\_rel\_lock mutex. This ensures:
- No references to sfp or sdp occur after the reference count is
decremented.
- Cleanup functions such as sg\_remove\_sfp() and
sg\_remove\_sfp\_usercontext() can safely execute without impacting the
mutex handling in sg\_release().
The fix has been tested and validated by syzbot. This patch closes the
bug reported at the following syzkaller link and ensures proper
sequencing of resource cleanup and mutex operations, eliminating the
risk of use-after-free errors in sg\_release().
Reported-by: syzbot+7efb5850a17ba6ce098b@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7efb5850a17ba6ce098b
Tested-by: syzbot+7efb5850a17ba6ce098b@syzkaller.appspotmail.com
Fixes: cc833acbee9d ("sg: O\_EXCL and other lock handling")
Signed-off-by: Suraj Sonawane <surajsonawane0215@gmail.com>
Link: [https://lore.kernel.org/r/20241120125944.88095-1-surajsonawane0215@gmail.com](https://lore.kernel.org/r/20241120125944.88095-1-surajsonawane0215%40gmail.com)
Reviewed-by: Bart Van Assche <bvanassche@acm.org>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960)

| -rw-r--r-- | [drivers/scsi/sg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/sg.c?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/scsi/sg.c b/drivers/scsi/sg.cindex 84334ab39c8107..94127868bedf8a 100644--- a/[drivers/scsi/sg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/sg.c?id=05b436f3cf65c957eff86c5ea5ddfa2604b32c63)+++ b/[drivers/scsi/sg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/sg.c?id=1f5e2f1ca5875728fcf62bc1a054707444ab4960)@@ -386,7 +386,6 @@ sg\_release(struct inode \*inode, struct file \*filp) SCSI\_LOG\_TIMEOUT(3, sg\_printk(KERN\_INFO, sdp, "sg\_release\n"));  mutex\_lock(&sdp->open\_rel\_lock);- kref\_put(&sfp->f\_ref, sg\_remove\_sfp); sdp->open\_cnt--;  /\* possibly many open()s waiting on exlude clearing, start many;@@ -398,6 +397,7 @@ sg\_release(struct inode \*inode, struct file \*filp) wake\_up\_interruptible(&sdp->open\_wait); } mutex\_unlock(&sdp->open\_rel\_lock);+ kref\_put(&sfp->f\_ref, sg\_remove\_sfp); return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:50:49 +0000



=== Content from git.kernel.org_8bf29872_20250114_195212.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=59b30afa578637169e2819536bb66459fdddc39d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=59b30afa578637169e2819536bb66459fdddc39d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59b30afa578637169e2819536bb66459fdddc39d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=59b30afa578637169e2819536bb66459fdddc39d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Suraj Sonawane <surajsonawane0215@gmail.com> | 2024-11-20 18:29:44 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:49 +0100 |
| commit | [59b30afa578637169e2819536bb66459fdddc39d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59b30afa578637169e2819536bb66459fdddc39d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=59b30afa578637169e2819536bb66459fdddc39d)) | |
| tree | [a50be8e18d683dd803f5c6f67eabc186accabe88](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=59b30afa578637169e2819536bb66459fdddc39d) | |
| parent | [c169daf3cf3939df45796f025bed12565e0c8202](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c169daf3cf3939df45796f025bed12565e0c8202) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=59b30afa578637169e2819536bb66459fdddc39d&id2=c169daf3cf3939df45796f025bed12565e0c8202)) | |
| download | [linux-59b30afa578637169e2819536bb66459fdddc39d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-59b30afa578637169e2819536bb66459fdddc39d.tar.gz) | |

scsi: sg: Fix slab-use-after-free read in sg\_release()[ Upstream commit f10593ad9bc36921f623361c9e3dd96bd52d85ee ]
Fix a use-after-free bug in sg\_release(), detected by syzbot with KASAN:
BUG: KASAN: slab-use-after-free in lock\_release+0x151/0xa30
kernel/locking/lockdep.c:5838
\_\_mutex\_unlock\_slowpath+0xe2/0x750 kernel/locking/mutex.c:912
sg\_release+0x1f4/0x2e0 drivers/scsi/sg.c:407
In sg\_release(), the function kref\_put(&sfp->f\_ref, sg\_remove\_sfp) is
called before releasing the open\_rel\_lock mutex. The kref\_put() call may
decrement the reference count of sfp to zero, triggering its cleanup
through sg\_remove\_sfp(). This cleanup includes scheduling deferred work
via sg\_remove\_sfp\_usercontext(), which ultimately frees sfp.
After kref\_put(), sg\_release() continues to unlock open\_rel\_lock and may
reference sfp or sdp. If sfp has already been freed, this results in a
slab-use-after-free error.
Move the kref\_put(&sfp->f\_ref, sg\_remove\_sfp) call after unlocking the
open\_rel\_lock mutex. This ensures:
- No references to sfp or sdp occur after the reference count is
decremented.
- Cleanup functions such as sg\_remove\_sfp() and
sg\_remove\_sfp\_usercontext() can safely execute without impacting the
mutex handling in sg\_release().
The fix has been tested and validated by syzbot. This patch closes the
bug reported at the following syzkaller link and ensures proper
sequencing of resource cleanup and mutex operations, eliminating the
risk of use-after-free errors in sg\_release().
Reported-by: syzbot+7efb5850a17ba6ce098b@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7efb5850a17ba6ce098b
Tested-by: syzbot+7efb5850a17ba6ce098b@syzkaller.appspotmail.com
Fixes: cc833acbee9d ("sg: O\_EXCL and other lock handling")
Signed-off-by: Suraj Sonawane <surajsonawane0215@gmail.com>
Link: [https://lore.kernel.org/r/20241120125944.88095-1-surajsonawane0215@gmail.com](https://lore.kernel.org/r/20241120125944.88095-1-surajsonawane0215%40gmail.com)
Reviewed-by: Bart Van Assche <bvanassche@acm.org>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=59b30afa578637169e2819536bb66459fdddc39d)

| -rw-r--r-- | [drivers/scsi/sg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/sg.c?id=59b30afa578637169e2819536bb66459fdddc39d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/scsi/sg.c b/drivers/scsi/sg.cindex dc9722b290f20d..62574886a9111e 100644--- a/[drivers/scsi/sg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/sg.c?id=c169daf3cf3939df45796f025bed12565e0c8202)+++ b/[drivers/scsi/sg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/sg.c?id=59b30afa578637169e2819536bb66459fdddc39d)@@ -386,7 +386,6 @@ sg\_release(struct inode \*inode, struct file \*filp) SCSI\_LOG\_TIMEOUT(3, sg\_printk(KERN\_INFO, sdp, "sg\_release\n"));  mutex\_lock(&sdp->open\_rel\_lock);- kref\_put(&sfp->f\_ref, sg\_remove\_sfp); sdp->open\_cnt--;  /\* possibly many open()s waiting on exlude clearing, start many;@@ -398,6 +397,7 @@ sg\_release(struct inode \*inode, struct file \*filp) wake\_up\_interruptible(&sdp->open\_wait); } mutex\_unlock(&sdp->open\_rel\_lock);+ kref\_put(&sfp->f\_ref, sg\_remove\_sfp); return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:50:50 +0000



=== Content from git.kernel.org_1cc06dfb_20250114_195213.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Suraj Sonawane <surajsonawane0215@gmail.com> | 2024-11-20 18:29:44 +0530 |
| --- | --- | --- |
| committer | Martin K. Petersen <martin.petersen@oracle.com> | 2024-12-04 13:22:59 -0500 |
| commit | [f10593ad9bc36921f623361c9e3dd96bd52d85ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee)) | |
| tree | [6e55499569c4d955e585304047f8e5af2f318738](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee) | |
| parent | [eb48e9fc0028bed94a40a9352d065909f19e333c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb48e9fc0028bed94a40a9352d065909f19e333c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee&id2=eb48e9fc0028bed94a40a9352d065909f19e333c)) | |
| download | [linux-f10593ad9bc36921f623361c9e3dd96bd52d85ee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f10593ad9bc36921f623361c9e3dd96bd52d85ee.tar.gz) | |

scsi: sg: Fix slab-use-after-free read in sg\_release()Fix a use-after-free bug in sg\_release(), detected by syzbot with KASAN:
BUG: KASAN: slab-use-after-free in lock\_release+0x151/0xa30
kernel/locking/lockdep.c:5838
\_\_mutex\_unlock\_slowpath+0xe2/0x750 kernel/locking/mutex.c:912
sg\_release+0x1f4/0x2e0 drivers/scsi/sg.c:407
In sg\_release(), the function kref\_put(&sfp->f\_ref, sg\_remove\_sfp) is
called before releasing the open\_rel\_lock mutex. The kref\_put() call may
decrement the reference count of sfp to zero, triggering its cleanup
through sg\_remove\_sfp(). This cleanup includes scheduling deferred work
via sg\_remove\_sfp\_usercontext(), which ultimately frees sfp.
After kref\_put(), sg\_release() continues to unlock open\_rel\_lock and may
reference sfp or sdp. If sfp has already been freed, this results in a
slab-use-after-free error.
Move the kref\_put(&sfp->f\_ref, sg\_remove\_sfp) call after unlocking the
open\_rel\_lock mutex. This ensures:
- No references to sfp or sdp occur after the reference count is
decremented.
- Cleanup functions such as sg\_remove\_sfp() and
sg\_remove\_sfp\_usercontext() can safely execute without impacting the
mutex handling in sg\_release().
The fix has been tested and validated by syzbot. This patch closes the
bug reported at the following syzkaller link and ensures proper
sequencing of resource cleanup and mutex operations, eliminating the
risk of use-after-free errors in sg\_release().
Reported-by: syzbot+7efb5850a17ba6ce098b@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7efb5850a17ba6ce098b
Tested-by: syzbot+7efb5850a17ba6ce098b@syzkaller.appspotmail.com
Fixes: cc833acbee9d ("sg: O\_EXCL and other lock handling")
Signed-off-by: Suraj Sonawane <surajsonawane0215@gmail.com>
Link: [https://lore.kernel.org/r/20241120125944.88095-1-surajsonawane0215@gmail.com](https://lore.kernel.org/r/20241120125944.88095-1-surajsonawane0215%40gmail.com)
Reviewed-by: Bart Van Assche <bvanassche@acm.org>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee)

| -rw-r--r-- | [drivers/scsi/sg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/sg.c?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/scsi/sg.c b/drivers/scsi/sg.cindex 84334ab39c8107..94127868bedf8a 100644--- a/[drivers/scsi/sg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/sg.c?id=eb48e9fc0028bed94a40a9352d065909f19e333c)+++ b/[drivers/scsi/sg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/sg.c?id=f10593ad9bc36921f623361c9e3dd96bd52d85ee)@@ -386,7 +386,6 @@ sg\_release(struct inode \*inode, struct file \*filp) SCSI\_LOG\_TIMEOUT(3, sg\_printk(KERN\_INFO, sdp, "sg\_release\n"));  mutex\_lock(&sdp->open\_rel\_lock);- kref\_put(&sfp->f\_ref, sg\_remove\_sfp); sdp->open\_cnt--;  /\* possibly many open()s waiting on exlude clearing, start many;@@ -398,6 +397,7 @@ sg\_release(struct inode \*inode, struct file \*filp) wake\_up\_interruptible(&sdp->open\_wait); } mutex\_unlock(&sdp->open\_rel\_lock);+ kref\_put(&sfp->f\_ref, sg\_remove\_sfp); return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:50:50 +0000


