=== Content from www.wordfence.com_5122ab15_20250114_210227.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Mollie for Contact Form 7 <= 5.0.0 - Reflected Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Mollie for Contact Form 7 <= 5.0.0 - Reflected Cross-Site Scripting

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-12165](https://www.cve.org/CVERecord?id=CVE-2024-12165) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | December 6, 2024 |
| Last Updated | December 7, 2024 |
| Researcher | [Colin Xu](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/colin-xu) |

### Description

The Mollie for Contact Form 7 plugin for WordPress is vulnerable to Reflected Cross-Site Scripting via the 'page' parameter in all versions up to, and including, 5.0.0 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick a user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/cf7-mollie/trunk/includes/php/admin_menu.php#L164)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcf7-mollie%2Fmollie-for-contact-form-7-500-reflected-cross-site-scripting&t=Mollie%20for%20Contact%20Form%207%20%3C%3D%205.0.0%20-%20Reflected%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcf7-mollie%2Fmollie-for-contact-form-7-500-reflected-cross-site-scripting&text=Mollie%20for%20Contact%20Form%207%20%3C%3D%205.0.0%20-%20Reflected%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcf7-mollie%2Fmollie-for-contact-form-7-500-reflected-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for Mollie for Contact Form 7

#### [Mollie for Contact Form 7](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/cf7-mollie)

| Software Type | Plugin |
| --- | --- |
| Software Slug | cf7-mollie [(view on wordpress.org)](https://wordpress.org/plugins/cf7-mollie) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 5.0.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_4ccf41b1_20250114_210226.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcf7-mollie%2Ftrunk%2Fincludes%2Fphp%2Fadmin_menu.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/cf7-mollie/trunk/includes/php/admin_menu.php?rev=2230954 "Revision 2230954")
* Next Revision →
* [Blame](/browser/cf7-mollie/trunk/includes/php/admin_menu.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/cf7-mollie/trunk/includes/php/admin_menu.php)

---

# [source:](/browser?order=name "Go to repository root") [cf7-mollie](/browser/cf7-mollie?order=name "View cf7-mollie")/[trunk](/browser/cf7-mollie/trunk?order=name "View trunk")/[includes](/browser/cf7-mollie/trunk/includes?order=name "View includes")/[php](/browser/cf7-mollie/trunk/includes/php?order=name "View php")/[admin\_menu.php](/browser/cf7-mollie/trunk/includes/php/admin_menu.php?order=name "View admin_menu.php")

View diff against:

View revision:

| [Last change](/changeset/2235204/cf7-mollie/trunk/includes/php/admin_menu.php "View differences") on this file was [2235204](/changeset/2235204/ "View changeset 2235204"), checked in by tsjippy, [5 years ago](/timeline?from=2020-01-29T12%3A56%3A57Z&precision=second "See timeline at 01/29/2020 12:56:57 PM") |
| --- |
| table overview update |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 33.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if(!class\_exists('WP\_List\_Table')){ |
| [3](#L3) | require\_once( ABSPATH . 'wp-admin/includes/class-wp-list-table.php' ); |
| [4](#L4) | } |
| [5](#L5) |  |
| [6](#L6) | require \_\_DIR\_\_ . '/initialize.php'; |
| [7](#L7) | global $wpdb; |
| [8](#L8) | $table\_name = $wpdb->prefix . 'cf7\_mollie'; |
| [9](#L9) |  |
| [10](#L10) | //$wpdb->query($wpdb->prepare("UPDATE {$table\_name} SET paymentid='%s' WHERE orderid='1571221517'","blbla")); |
| [11](#L11) |  |
| [12](#L12) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* CREATE A PACKAGE CLASS \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* |
| [13](#L13) | \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* |
| [14](#L14) | \* Create a new list table package that extends the core WP\_List\_Table class. |
| [15](#L15) | \* WP\_List\_Table contains most of the framework for generating the table, but we |
| [16](#L16) | \* need to define and override some methods so that our data can be displayed |
| [17](#L17) | \* exactly the way we need it to be. |
| [18](#L18) | \* |
| [19](#L19) | \* To display this example on a page, you will first need to instantiate the class, |
| [20](#L20) | \* then call $yourInstance->prepare\_items() to handle any data manipulation, then |
| [21](#L21) | \* finally call $yourInstance->display() to render the table to the page. |
| [22](#L22) | \* |
| [23](#L23) | \* Our theme for this list table is going to be payments. |
| [24](#L24) | \*/ |
| [25](#L25) | class CF7\_Mollie\_Payment\_List\_Table extends WP\_List\_Table { |
| [26](#L26) | /\*\* \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* |
| [27](#L27) | \* REQUIRED. Set up a constructor that references the parent constructor. We |
| [28](#L28) | \* use the parent reference to set some default configs. |
| [29](#L29) | \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [30](#L30) | function \_\_construct(){ |
| [31](#L31) | global $status, $page; |
| [32](#L32) |  |
| [33](#L33) | //Set parent defaults |
| [34](#L34) | parent::\_\_construct( array( |
| [35](#L35) | 'singular'  => 'payment',     //singular name of the listed records |
| [36](#L36) | 'plural'    => 'payments',    //plural name of the listed records |
| [37](#L37) | 'ajax'      => false        //does this table support ajax? |
| [38](#L38) | ) ); |
| [39](#L39) | } |
| [40](#L40) |  |
| [41](#L41) | //Add extra buttons to the table header |
| [42](#L42) | function extra\_tablenav( $which ) { |
| [43](#L43) | if ( $which == "top" ){ |
| [44](#L44) | //Add rows dropdown |
| [45](#L45) | ?> |
| [46](#L46) | <div class="alignleft actions bulkactions"> |
| [47](#L47) | <label>Rows:</label> |
| [48](#L48) | </div> |
| [49](#L49) | <div class="alignleft actions bulkactions"> |
| [50](#L50) | <select id="visible\_rows" onchange="redirect\_rows()" class="visible\_rows"> |
| [51](#L51) | <option value="5" |
| [52](#L52) | <?php |
| [53](#L53) | if (!empty($\_GET["rows"]) and $\_GET["rows"] == 5){ |
| [54](#L54) | echo 'selected="selected"'; |
| [55](#L55) | } |
| [56](#L56) | ?> |
| [57](#L57) | >5</option> |
| [58](#L58) | <option value="10" |
| [59](#L59) | <?php |
| [60](#L60) | if (!empty($\_GET["rows"]) and $\_GET["rows"] == 10){ |
| [61](#L61) | echo 'selected="selected"'; |
| [62](#L62) | } |
| [63](#L63) | ?> |
| [64](#L64) | >10</option> |
| [65](#L65) | <option value="20" |
| [66](#L66) | <?php |
| [67](#L67) | if (!empty($\_GET["rows"]) and $\_GET["rows"] == 20){ |
| [68](#L68) | echo 'selected="selected"'; |
| [69](#L69) | } |
| [70](#L70) | ?> |
| [71](#L71) | >20</option> |
| [72](#L72) | <option value="30" |
| [73](#L73) | <?php |
| [74](#L74) | if (!empty($\_GET["rows"]) and $\_GET["rows"] == 30){ |
| [75](#L75) | echo 'selected="selected"'; |
| [76](#L76) | } |
| [77](#L77) | ?> |
| [78](#L78) | >30</option> |
| [79](#L79) | <option value="40" |
| [80](#L80) | <?php |
| [81](#L81) | if (!empty($\_GET["rows"]) and $\_GET["rows"] == 40){ |
| [82](#L82) | echo 'selected="selected"'; |
| [83](#L83) | } |
| [84](#L84) | ?> |
| [85](#L85) | >40</option> |
| [86](#L86) | <option value="50" |
| [87](#L87) | <?php |
| [88](#L88) | if (empty($\_GET["rows"]) or $\_GET["rows"] == 50){ |
| [89](#L89) | echo 'selected="selected"'; |
| [90](#L90) | } |
| [91](#L91) | ?> |
| [92](#L92) | >50</option> |
| [93](#L93) | <option value="100" |
| [94](#L94) | <?php |
| [95](#L95) | if (!empty($\_GET["rows"]) and $\_GET["rows"] == 100){ |
| [96](#L96) | echo 'selected="selected"'; |
| [97](#L97) | } |
| [98](#L98) | ?> |
| [99](#L99) | >100</option> |
| [100](#L100) | <option value="200" |
| [101](#L101) | <?php |
| [102](#L102) | if (!empty($\_GET["rows"]) and $\_GET["rows"] == 200){ |
| [103](#L103) | echo 'selected="selected"'; |
| [104](#L104) | } |
| [105](#L105) | ?> |
| [106](#L106) | >200</option> |
| [107](#L107) | <option value="400" |
| [108](#L108) | <?php |
| [109](#L109) | if (!empty($\_GET["rows"]) and $\_GET["rows"] == 400){ |
| [110](#L110) | echo 'selected="selected"'; |
| [111](#L111) | } |
| [112](#L112) | ?> |
| [113](#L113) | >400</option> |
| [114](#L114) | </select> |
| [115](#L115) | <?php |
| [116](#L116) | $this->search\_box('Search', 'search'); |
| [117](#L117) | ?> |
| [118](#L118) | </div> |
| [119](#L119) | <?php |
| [120](#L120) | echo " |
| [121](#L121) | <script type=\"text/javascript\"> |
| [122](#L122) | function redirect\_rows() { |
| [123](#L123) | var visible\_rows = document.getElementById('visible\_rows'); |
| [124](#L124) | visible\_rows = visible\_rows.options[visible\_rows.selectedIndex].value; |
| [125](#L125) |  |
| [126](#L126) | var url = window.location.href; |
| [127](#L127) | if (url.indexOf('?') > -1){ |
| [128](#L128) | url += '&rows='+visible\_rows; |
| [129](#L129) | }else{ |
| [130](#L130) | url += '?rows='+visible\_rows; |
| [131](#L131) | } |
| [132](#L132) | window.location.href = url; |
| [133](#L133) | } |
| [134](#L134) | </script> |
| [135](#L135) | "; |
| [136](#L136) | } |
| [137](#L137) | } |
| [138](#L138) |  |
| [139](#L139) | //Default output |
| [140](#L140) | function column\_default($item, $column\_name){ |
| [141](#L141) | switch($column\_name){ |
| [142](#L142) | case 'time': |
| [143](#L143) | case 'orderid': |
| [144](#L144) | case 'name': |
| [145](#L145) | case 'email': |
| [146](#L146) | case 'amount': |
| [147](#L147) | case 'description': |
| [148](#L148) | case 'status': |
| [149](#L149) | case 'frequency': |
| [150](#L150) | case 'startdate': |
| [151](#L151) | case 'subscriptionid': |
| [152](#L152) | return $item[$column\_name]; |
| [153](#L153) | default: |
| [154](#L154) | return print\_r($item,true); //Show the whole array for troubleshooting purposes |
| [155](#L155) | } |
| [156](#L156) | } |
| [157](#L157) |  |
| [158](#L158) | //output for the payment column |
| [159](#L159) | function column\_paymentid($item){ |
| [160](#L160) | //Build row actions |
| [161](#L161) | //Only subscriptions are editable, it makes no sense to edit payments already made. |
| [162](#L162) | if ($item['subscriptionid'] != ""){ |
| [163](#L163) | $actions = array( |
| [164](#L164) | 'edit'      => sprintf('<a href="?page=%s&action=%s&payment=%s">'.\_\_('Edit', 'cf7-mollie-translation').'</a>',$\_REQUEST['page'],'edit',$item['id']), |
| [165](#L165) | 'delete'    => sprintf('<a href="?page=%s&action=%s&payment[]=%s">'.\_\_('Delete', 'cf7-mollie-translation').'</a>',$\_REQUEST['page'],'delete',$item['id']), |
| [166](#L166) | ); |
| [167](#L167) | } |
| [168](#L168) |  |
| [169](#L169) | //Return the paymentid contents |
| [170](#L170) | return sprintf('%1$s <span style="color:silver">(id:%2$s)</span>%3$s', |
| [171](#L171) | /\*$1%s\*/ $item['paymentid'], |
| [172](#L172) | /\*$2%s\*/ $item['id'], |
| [173](#L173) | /\*$3%s\*/ $this->row\_actions($actions) |
| [174](#L174) | ); |
| [175](#L175) | } |
| [176](#L176) |  |
| [177](#L177) | //output for the customerid column |
| [178](#L178) | function column\_customerid($item){ |
| [179](#L179) | //Build row actions |
| [180](#L180) | //Only subscriptions are editable, it makes no sense to edit payments already made. |
| [181](#L181) | if ($item['subscriptionid'] != ""){ |
| [182](#L182) | $actions = array( |
| [183](#L183) | 'show'      => sprintf('<a href="?page=%s&customerid=%s">%s</a>',$\_REQUEST['page'],$item['customerid'],\_\_('Show payments', 'cf7-mollie-translation')), |
| [184](#L184) | ); |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | //Return the paymentid contents |
| [188](#L188) | if ($item['subscriptionid'] != ""){ |
| [189](#L189) | return sprintf('%1$s <span style="color:silver">%2$s</span>', |
| [190](#L190) | /\*$1%s\*/ $item['customerid'], |
| [191](#L191) | /\*$2%s\*/ $this->row\_actions($actions) |
| [192](#L192) | ); |
| [193](#L193) | }else{ |
| [194](#L194) | return $item['customerid']; |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | //Settings for the Checkbox column |
| [200](#L200) | function column\_cb($item){ |
| [201](#L201) | return sprintf( |
| [202](#L202) | '<input type="checkbox" name="%1$s[]" value="%2$s" />', |
| [203](#L203) | /\*$1%s\*/ $this->\_args['singular'],  //Let's simply repurpose the table's singular label ("payment") |
| [204](#L204) | /\*$2%s\*/ $item['id']                //The value of the checkbox should be the record's id |
| [205](#L205) | ); |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) |  |
| [209](#L209) | //Define the visible columns |
| [210](#L210) | function get\_columns(){ |
| [211](#L211) | $columns = array( |
| [212](#L212) | 'cb'        => '<input type="checkbox" />', //Render a checkbox instead of text |
| [213](#L213) | 'time'     => \_\_('Time', 'cf7-mollie-translation'), |
| [214](#L214) | 'paymentid'     => \_\_('Payment ID', 'cf7-mollie-translation'), |
| [215](#L215) | 'customerid'     => \_\_('Customer ID', 'cf7-mollie-translation'), |
| [216](#L216) | 'orderid'    => \_\_('Order ID', 'cf7-mollie-translation'), |
| [217](#L217) | 'name'  => \_\_('Name', 'cf7-mollie-translation'), |
| [218](#L218) | 'email'    => \_\_('E-mail', 'cf7-mollie-translation'), |
| [219](#L219) | 'amount'    => \_\_('Amount', 'cf7-mollie-translation'), |
| [220](#L220) | 'description'    => \_\_('Description', 'cf7-mollie-translation'), |
| [221](#L221) | 'status'    => \_\_('Status', 'cf7-mollie-translation'), |
| [222](#L222) | 'frequency'    => \_\_('Frequency', 'cf7-mollie-translation'), |
| [223](#L223) | 'startdate'    => \_\_('Start date', 'cf7-mollie-translation'), |
| [224](#L224) | 'subscriptionid'    => \_\_('Subscription ID', 'cf7-mollie-translation') |
| [225](#L225) | ); |
| [226](#L226) | return $columns; |
| [227](#L227) | } |
| [228](#L228) |  |
| [229](#L229) |  |
| [230](#L230) | //Set which columns are sortable |
| [231](#L231) | function get\_sortable\_columns() { |
| [232](#L232) | $sortable\_columns = array( |
| [233](#L233) | 'time'     => array('time',false), |
| [234](#L234) | 'paymentid'     => array('paymentid',false),     //true means it's already sorted |
| [235](#L235) | 'orderid'    => array('orderid',false), |
| [236](#L236) | 'customerid'    => array('customerid',false), |
| [237](#L237) | 'name'  => array('name',false), |
| [238](#L238) | 'email'  => array('email',false), |
| [239](#L239) | 'amount'  => array('amount',false), |
| [240](#L240) | 'description'  => array('description',false), |
| [241](#L241) | 'status'  => array('status',false), |
| [242](#L242) | 'frequency'  => array('frequency',false), |
| [243](#L243) | 'startdate'  => array('startdate',false), |
| [244](#L244) | 'subscriptionid'  => array('subscriptionid',false) |
| [245](#L245) | ); |
| [246](#L246) | return $sortable\_columns; |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) |  |
| [250](#L250) | //Define available bulkactions |
| [251](#L251) | function get\_bulk\_actions() { |
| [252](#L252) | $actions = array( |
| [253](#L253) | 'delete'    => 'Delete' |
| [254](#L254) | ); |
| [255](#L255) | return $actions; |
| [256](#L256) | } |
| [257](#L257) |  |
| [258](#L258) |  |
| [259](#L259) | //Functions to handle bulkactions |
| [260](#L260) | function process\_bulk\_action() { |
| [261](#L261) | global $mollie; |
| [262](#L262) | cf7\_mollie\_setapikey(); |
| [263](#L263) | global $wpdb; |
| [264](#L264) | global $table\_name; |
| [265](#L265) |  |
| [266](#L266) | //Detect when a bulk action is being triggered... |
| [267](#L267) | if( 'delete'===$this->current\_action() ) { |
| [268](#L268) | echo cf7\_mollie\_delete\_recurring\_payment(); |
| [269](#L269) | wp\_die(); |
| [270](#L270) | }elseif( 'edit'===$this->current\_action() ) { |
| [271](#L271) | echo cf7\_mollie\_edit\_recurring\_payment(); |
| [272](#L272) | wp\_die(); |
| [273](#L273) | } |
| [274](#L274) | } |
| [275](#L275) |  |
| [276](#L276) |  |
| [277](#L277) | //Prepare the data to show |
| [278](#L278) | function prepare\_items() { |
| [279](#L279) | global $wpdb; //This is used only if making any database queries |
| [280](#L280) | global $table\_name; |
| [281](#L281) |  |
| [282](#L282) | $search = ( isset( $\_REQUEST['s'] ) ) ? $\_REQUEST['s'] : ""; |
| [283](#L283) |  |
| [284](#L284) | $columns = $this->get\_columns(); |
| [285](#L285) | $hidden = array(); |
| [286](#L286) | $sortable = $this->get\_sortable\_columns(); |
| [287](#L287) |  |
| [288](#L288) | $this->\_column\_headers = array($columns, $hidden, $sortable); |
| [289](#L289) |  |
| [290](#L290) | $this->process\_bulk\_action(); |
| [291](#L291) |  |
| [292](#L292) | /\* -- Preparing your query -- \*/ |
| [293](#L293) | $query = "SELECT \* FROM {$table\_name}"; |
| [294](#L294) |  |
| [295](#L295) | //Include an optional search |
| [296](#L296) | if(!empty($search)){ |
| [297](#L297) | $query .= " WHERE (paymentid LIKE '%{$search}%' OR orderid LIKE '%{$search}%' OR customerid LIKE '%{$search}%'  OR name LIKE '%{$search}%' OR email LIKE '%{$search}%' OR amount LIKE '%{$search}%' OR description LIKE '%{$search}%' OR status LIKE '%{$search}%' OR frequency LIKE '%{$search}%' OR startdate LIKE '%{$search}%' OR subscriptionid LIKE '%{$search}%')"; |
| [298](#L298) | } |
| [299](#L299) |  |
| [300](#L300) | /\* -- Ordering parameters -- \*/ |
| [301](#L301) | //Parameters that are going to be used to order the result |
| [302](#L302) | $orderby = !empty($\_GET["orderby"]) ? esc\_sql($\_GET["orderby"]) : 'ASC'; |
| [303](#L303) | $order = !empty($\_GET["order"]) ? esc\_sql($\_GET["order"]) : ''; |
| [304](#L304) | if(!empty($orderby) & !empty($order)){ $query.=' ORDER BY '.$orderby.' '.$order; } |
| [305](#L305) | /\* -- Pagination parameters -- \*/ |
| [306](#L306) | //Number of elements in your table? |
| [307](#L307) | $totalitems = $wpdb->query($query); //return the total number of affected rows |
| [308](#L308) | //How many to display per page? |
| [309](#L309) | $perpage = !empty($\_GET["rows"]) ? $\_GET["rows"] : 50; |
| [310](#L310) | if ($perpage == "all"){$perpage = $totalitems;} |
| [311](#L311) | //Which page is this? |
| [312](#L312) | $paged = !empty($\_GET["paged"]) ? esc\_sql($\_GET["paged"]) : ''; |
| [313](#L313) | //Page Number |
| [314](#L314) | if(empty($paged) || !is\_numeric($paged) || $paged<=0 ){ $paged=1; } |
| [315](#L315) | //How many pages do we have in total? |
| [316](#L316) | $totalpages = ceil($totalitems/$perpage); |
| [317](#L317) | //adjust the query to take pagination into account |
| [318](#L318) | if(!empty($paged) && !empty($perpage)){ |
| [319](#L319) | $offset=($paged-1)\*$perpage; |
| [320](#L320) | $query.=' LIMIT '.(int)$offset.','.(int)$perpage; |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | /\* -- Register the pagination -- \*/ |
| [324](#L324) | $this->set\_pagination\_args( array( |
| [325](#L325) | "total\_items" => $totalitems, |
| [326](#L326) | "total\_pages" => $totalpages, |
| [327](#L327) | "per\_page" => $perpage, |
| [328](#L328) | ) ); |
| [329](#L329) | //The pagination links are automatically built according to those parameters |
| [330](#L330) |  |
| [331](#L331) | /\* — Register the Columns — \*/ |
| [332](#L332) | $columns = $this->get\_columns(); |
| [333](#L333) | $hidden = array(); |
| [334](#L334) | $sortable = $this->get\_sortable\_columns(); |
| [335](#L335) | $this->\_column\_headers = array($columns, $hidden, $sortable); |
| [336](#L336) |  |
| [337](#L337) | /\* -- Fetch the items -- \*/ |
| [338](#L338) | $this->items = json\_decode(json\_encode($wpdb->get\_results($query)), True); |
| [339](#L339) | } |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | //Add admin menu |
| [343](#L343) | add\_action('admin\_menu', 'cf7mollie\_menu\_pages'); |
| [344](#L344) | function cf7mollie\_menu\_pages(){ |
| [345](#L345) | add\_submenu\_page( 'wpcf7', "Mollie", "Mollie", "administrator", 'wpcf7-mollie-config', 'cf7mollie\_menu\_output'  ); |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | function cf7mollie\_menu\_output(){ |
| [349](#L349) | $count = 0; |
| [350](#L350) | global $wpdb; |
| [351](#L351) | $table\_name = $wpdb->prefix . 'cf7\_mollie'; |
| [352](#L352) | if (!empty($\_POST['import\_button'])) { |
| [353](#L353) | $import = sanitize\_text\_field($\_POST['import\_button']); |
| [354](#L354) | if ($import==\_\_("Import All Payments", 'cf7-mollie-translation')){ |
| [355](#L355) | $import="payment"; |
| [356](#L356) | $count = cf7\_mollie\_import\_payments();//in database.php |
| [357](#L357) | }elseif($import==\_\_("Import Subscriptions", 'cf7-mollie-translation')){ |
| [358](#L358) | $import="subscription"; |
| [359](#L359) | $count = cf7\_mollie\_import\_subscriptions();//in database.php |
| [360](#L360) | } |
| [361](#L361) |  |
| [362](#L362) | if ($count > 0){ |
| [363](#L363) | if ($count > 1){ |
| [364](#L364) | $import .= "s"; |
| [365](#L365) | } |
| [366](#L366) | $text = sprintf(\_n("%s %s is imported succesfully","%s %s are imported succesfully", $count, 'cf7-mollie-translation'),$count,$import); |
| [367](#L367) | $color = "green"; |
| [368](#L368) | }elseif($count == 0){ |
| [369](#L369) | $text = sprintf(\_\_("No %s are imported.", 'cf7-mollie-translation'),$import); |
| [370](#L370) | $color = "red"; |
| [371](#L371) | } |
| [372](#L372) | cf7mollie\_allert\_message($text,$color); |
| [373](#L373) | }elseif (!empty($\_POST['bankname'])) { |
| [374](#L374) | cf7mollie\_process\_mandate(); |
| [375](#L375) | }elseif (!empty($\_POST['cf7\_mollie\_amount'])) { |
| [376](#L376) | cf7mollie\_process\_payment\_update(); |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | //Determine active tab |
| [380](#L380) | $active\_tab = isset( $\_GET[ 'tab' ] ) ? $\_GET[ 'tab' ] : 'payments\_made'; |
| [381](#L381) |  |
| [382](#L382) | //Define tabs |
| [383](#L383) | ?> |
| [384](#L384) | <h2 class="nav-tab-wrapper"> |
| [385](#L385) | <a href="?page=wpcf7-mollie-config&tab=payments\_made" class="nav-tab  <?php echo $active\_tab == 'payments\_made' ? 'nav-tab-active' : ''; ?>"><?php \_e("Payments made", 'cf7-mollie-translation')?></a> |
| [386](#L386) | <a href="?page=wpcf7-mollie-config&tab=mollie\_api" class="nav-tab <?php echo $active\_tab == 'mollie\_api' ? 'nav-tab-active' : ''; ?>"><?php \_e("Mollie Settings", 'cf7-mollie-translation')?></a> |
| [387](#L387) | <a href="?page=wpcf7-mollie-config&tab=mandate" class="nav-tab <?php echo $active\_tab == 'mandate' ? 'nav-tab-active' : ''; ?>"><?php \_e("Add payment mandate", 'cf7-mollie-translation')?></a> |
| [388](#L388) | </h2> |
| [389](#L389) | <?php |
| [390](#L390) |  |
| [391](#L391) | //Set contents of the tabs |
| [392](#L392) | if( $active\_tab == 'payments\_made' ) { |
| [393](#L393) | if(empty($\_GET['customerid'])){ |
| [394](#L394) | cf7mollie\_payments\_tab(); |
| [395](#L395) | }else{ |
| [396](#L396) | echo cf7\_mollie\_show\_payments(); |
| [397](#L397) | } |
| [398](#L398) | } elseif ( $active\_tab == 'mollie\_api' ) { |
| [399](#L399) | cf7mollie\_api\_key\_tab(); |
| [400](#L400) | }else{ |
| [401](#L401) | cf7\_mollie\_mandate\_tab(); |
| [402](#L402) | } |
| [403](#L403) | } |
| [404](#L404) |  |
| [405](#L405) | function cf7mollie\_payments\_tab(){ |
| [406](#L406) | //Create an instance of our package class... |
| [407](#L407) | $ListTable = new CF7\_Mollie\_Payment\_List\_Table(); |
| [408](#L408) | //Fetch, prepare, sort, and filter our data... |
| [409](#L409) | $ListTable->prepare\_items(); |
| [410](#L410) | ?> |
| [411](#L411) | <div class="wrap"> |
| [412](#L412) | <div id="icon-users" class="icon32"><br/></div> |
| [413](#L413) | <h2><?php \_e("Payments Table", 'cf7-mollie-translation')?></h2> |
| [414](#L414) |  |
| [415](#L415) | <div> |
| [416](#L416) | <font size="3"> |
| [417](#L417) | <?php \_e("Below you can find all payments done.", 'cf7-mollie-translation')?><br> |
| [418](#L418) | <?php \_e("All payments with a Subscription ID can be edited, that will edit the actual subscription on the Mollie side.", 'cf7-mollie-translation')?><br> |
| [419](#L419) | <?php \_e("When deleting a subscription the subscription will be cancelled at the Mollie side.", 'cf7-mollie-translation')?> |
| [420](#L420) | <br><br><br> |
| [421](#L421) | </font> |
| [422](#L422) | </div> |
| [423](#L423) |  |
| [424](#L424) | <!-- Forms are NOT created automatically, so you need to wrap the table in one to use features like bulk actions --> |
| [425](#L425) | <form id="payments-filter" method="get"> |
| [426](#L426) | <!-- For plugins, we also need to ensure that the form posts back to our current page --> |
| [427](#L427) | <input type="hidden" name="page" value="<?php echo $\_REQUEST['page'] ?>" /> |
| [428](#L428) | <!-- Now we can render the completed list table --> |
| [429](#L429) | <?php $ListTable->display() ?> |
| [430](#L430) | </form> |
| [431](#L431) |  |
| [432](#L432) | </div> |
| [433](#L433) | <?php |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | function cf7mollie\_api\_key\_tab(){ |
| [437](#L437) | if (get\_option("CF7\_mollie\_global\_key") and (get\_option("CF7\_mollie\_global\_key")) != ""){ |
| [438](#L438) | $buttontext = \_\_("Reset Api Key", 'cf7-mollie-translation'); |
| [439](#L439) | }else{ |
| [440](#L440) | $buttontext = \_\_("Set Api Key", 'cf7-mollie-translation'); |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) | ?> |
| [444](#L444) | <div class="wrap"> |
| [445](#L445) | <h2> |
| [446](#L446) | <?php \_e("Mollie Settings", 'cf7-mollie-translation')?> |
| [447](#L447) | </h2> |
| [448](#L448) | </div> |
| [449](#L449) |  |
| [450](#L450) | <?php if(isset($\_POST['apikey'])): |
| [451](#L451) | $apikey=$\_POST['apikey']; |
| [452](#L452) | if (strpos($apikey, 'test\_')==0 or strpos($apikey, 'live\_')==0): |
| [453](#L453) | $text = \_\_("Your Mollie Api Key is saved.", 'cf7-mollie-translation'); |
| [454](#L454) | $color = "green"; |
| [455](#L455) | update\_option("CF7\_mollie\_global\_key",$apikey); |
| [456](#L456) | $buttontext = \_\_("Reset Api Key", 'cf7-mollie-translation'); |
| [457](#L457) | //Remove the dabase |
| [458](#L458) | cf7\_mollie\_remove(); |
| [459](#L459) | //Recreate the database |
| [460](#L460) | cf7\_mollie\_install(); |
| [461](#L461) | else: |
| [462](#L462) | $text = \_\_("Please enter a valid api key!", 'cf7-mollie-translation'); |
| [463](#L463) | $color = "red"; |
| [464](#L464) | endif; |
| [465](#L465) |  |
| [466](#L466) | cf7mollie\_allert\_message($text,$color); |
| [467](#L467) | endif; ?> |
| [468](#L468) |  |
| [469](#L469) | <div> |
| [470](#L470) | <form name="cf7\_name" id="cf7\_name" action="admin.php?page=wpcf7-mollie-config&tab=mollie\_api" method="post"> |
| [471](#L471) | <label for="apikey" class="cf7\_mollie\_api\_api\_label"><?php \_e("Mollie Api Key:", 'cf7-mollie-translation')?></label> |
| [472](#L472) | <input type="text" name="apikey" maxlength="50" value='<?php echo get\_option("CF7\_mollie\_global\_key"); ?>' style="height:2em; width:25em;"> |
| [473](#L473) | <input type="submit" name="formSubmit" value='<?php echo $buttontext; ?>' class="button"> |
| [474](#L474) | </form> |
| [475](#L475) | <br> |
| [476](#L476) | <?php \_e("Press the button to import all payments from Mollie", 'cf7-mollie-translation')?> |
| [477](#L477) | <form name="cf7\_mollie\_Import\_all\_payments" id="cf7\_mollie\_Import\_payments" action="admin.php?page=wpcf7-mollie-config" method="post"> |
| [478](#L478) | <input type="submit" name="import\_button" value="<?php \_e("Import All Payments", 'cf7-mollie-translation')?>" class="button"> |
| [479](#L479) | </form> |
| [480](#L480) | <br> |
| [481](#L481) | <?php \_e("Press the button to import all subscriptions from Mollie", 'cf7-mollie-translation')?> |
| [482](#L482) | <form name="cf7\_mollie\_Import\_subscriptions" id="cf7\_mollie\_Import\_subscriptions" action="admin.php?page=wpcf7-mollie-config" method="post"> |
| [483](#L483) | <input type="submit" name="import\_button" value="<?php \_e("Import Subscriptions", 'cf7-mollie-translation')?>" class="button"> |
| [484](#L484) | </form> |
| [485](#L485) | </div> |
| [486](#L486) | <?php |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | function cf7mollie\_allert\_message($text, $color){ |
| [490](#L490) | ?> |
| [491](#L491) | <div class="wrap select-specific"> |
| [492](#L492) | <div style="color:<?php echo $color; ?>;" class="cf7\_mollie\_api\_alert"> |
| [493](#L493) | <span style="color:<?php echo $color; ?>;" class="cf7\_mollie\_api\_closebtn" onclick="this.parentElement.style.display='none';">&times;</span> |
| [494](#L494) | <?php echo $text;?> |
| [495](#L495) | </div> |
| [496](#L496) | </div> |
| [497](#L497) | <?php |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | function cf7\_mollie\_mandate\_tab(){ |
| [501](#L501) | $html = ' |
| [502](#L502) | <div class="wrap"> |
| [503](#L503) | <div id="icon-users" class="icon32"><br/></div> |
| [504](#L504) | <h2>'.\_\_("Add a payment mandate.", 'cf7-mollie-translation').'</h2>'. |
| [505](#L505) | \_\_("Fill in the form below to:", 'cf7-mollie-translation').'<br> |
| [506](#L506) | \* '.\_\_("Create a customer", 'cf7-mollie-translation').'<br> |
| [507](#L507) | \* '.\_\_("Create a payment mandate for that customer", 'cf7-mollie-translation').'<br> |
| [508](#L508) | \* '.\_\_("Create a subscription for that customer (optional)", 'cf7-mollie-translation').' <br><br> |
| [509](#L509) | <form action="admin.php?page=wpcf7-mollie-config&tab=payments\_made" method="post"> |
| [510](#L510) | '.\_\_("Display Name:", 'cf7-mollie-translation').'<br> |
| [511](#L511) | <input type="text" name="name" class="cf7\_mollie\_name"><br> |
| [512](#L512) | '.\_\_("Bank account name:", 'cf7-mollie-translation').'<br> |
| [513](#L513) | <input type="text" name="bankname" class="cf7\_mollie\_bankname"><br> |
| [514](#L514) | '.\_\_("E-mail:", 'cf7-mollie-translation').'<br> |
| [515](#L515) | <input type="text" name="email" class="cf7\_mollie\_email"><br> |
| [516](#L516) | '.\_\_("Bank account IBAN:", 'cf7-mollie-translation').'<br> |
| [517](#L517) | <input type="text" name="iban" class="cf7\_mollie\_iban"><br> |
| [518](#L518) | '.\_\_("Signature date", 'cf7-mollie-translation').'<br> |
| [519](#L519) | <input type="date" name="signaturedate" id="signaturedate" class="cf7\_mollie\_signaturedate" max="'.date('Y-m-d').'"><br> |
| [520](#L520) | <br> |
| [521](#L521) | '.\_\_("Fill in the fields below only if you want to add a subscription as well.", 'cf7-mollie-translation').'<br> |
| [522](#L522) | '.\_\_("If you add an existing order ID you can change an oneoff payment to a subscription.", 'cf7-mollie-translation').'<br><br> |
| [523](#L523) | '.\_\_("Amount:", 'cf7-mollie-translation').'<br> |
| [524](#L524) | <input type="text" name="amount" class="cf7\_mollie\_amount"><br> |
| [525](#L525) | '.\_\_("Description:", 'cf7-mollie-translation').'<br> |
| [526](#L526) | <input type="text" name="description" class="cf7\_mollie\_description"><br> |
| [527](#L527) | '.\_\_("Interval:", 'cf7-mollie-translation').'<br> |
| [528](#L528) | <input type="number" name="interval" class="cf7\_mollie\_interval" value="1"> |
| [529](#L529) | <select name="interval\_type" class="cf7\_mollie\_interval\_type"> |
| [530](#L530) | <option value="days">'.\_\_("Days", 'cf7-mollie-translation').'</option> |
| [531](#L531) | <option value="weeks">'.\_\_("Weeks", 'cf7-mollie-translation').'</option> |
| [532](#L532) | <option value="months" selected>'.\_\_("Months", 'cf7-mollie-translation').'</option> |
| [533](#L533) | </select> |
| [534](#L534) | <br> |
| [535](#L535) | '.\_\_("Times:", 'cf7-mollie-translation').'<br> |
| [536](#L536) | <input type="number" name="times" class="cf7\_mollie\_times"><br> |
| [537](#L537) | '.\_\_("Start date", 'cf7-mollie-translation').'<br> |
| [538](#L538) | <input type="date" name="startdate" id="startdate" class="cf7\_mollie\_startdate"   min="'.date('Y-m-d').'"><br> |
| [539](#L539) | '.\_\_("OrderID (Optional):", 'cf7-mollie-translation').'<br> |
| [540](#L540) | <input type="text" name="order\_id" class="cf7\_mollie\_order\_id"><br> |
| [541](#L541) | '.\_\_("Webhook URL:", 'cf7-mollie-translation').'<br> |
| [542](#L542) | '.home\_url().'/<input type="text" name="webhook" class="cf7\_mollie\_webhook"><br> |
| [543](#L543) | <br> |
| [544](#L544) | <input type="submit" value="'.\_\_("Submit", 'cf7-mollie-translation').'" class="button"> |
| [545](#L545) | </form> |
| [546](#L546) | </div>'; |
| [547](#L547) |  |
| [548](#L548) | echo $html; |
| [549](#L549) |  |
| [550](#L550) | wp\_die(); |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | function cf7mollie\_process\_payment\_update(){ |
| [554](#L554) | require \_\_DIR\_\_ . '/initialize.php'; |
| [555](#L555) | global $wpdb; |
| [556](#L556) | $table\_name = $wpdb->prefix . 'cf7\_mollie'; |
| [557](#L557) | cf7\_mollie\_setapikey(); |
| [558](#L558) | global $mollie; |
| [559](#L559) |  |
| [560](#L560) | $row\_id = sanitize\_text\_field($\_POST['row\_id']); |
| [561](#L561) | $name = sanitize\_text\_field($\_POST['cf7\_mollie\_name']); |
| [562](#L562) | $email = sanitize\_email($\_POST['cf7\_mollie\_email']); |
| [563](#L563) | $amount = sanitize\_text\_field($\_POST['cf7\_mollie\_amount']); |
| [564](#L564) | $times = sanitize\_text\_field($\_POST['cf7\_mollie\_times']); |
| [565](#L565) | $startdate = sanitize\_text\_field($\_POST['cf7\_mollie\_startdate']); |
| [566](#L566) | $description = sanitize\_text\_field($\_POST['cf7\_mollie\_description']); |
| [567](#L567) | $interval = sanitize\_text\_field($\_POST['cf7\_mollie\_interval']); |
| [568](#L568) | $interval\_type = sanitize\_text\_field($\_POST['cf7\_mollie\_interval\_type']); |
| [569](#L569) |  |
| [570](#L570) | echo "test"; |
| [571](#L571) | echo $interval; |
| [572](#L572) | echo $interval\_type; |
| [573](#L573) | echo "test"; |
| [574](#L574) |  |
| [575](#L575) | try{ |
| [576](#L576) | //Update Mollie |
| [577](#L577) | $query = "SELECT \* FROM {$table\_name} WHERE id = '{$row\_id}'"; |
| [578](#L578) | $result = json\_decode(json\_encode($wpdb->get\_results($query)), True); |
| [579](#L579) | $customer = $mollie->customers->get($result[0]['customerid']); |
| [580](#L580) | $customer->name = "{$name}"; |
| [581](#L581) | $customer->email = "{$email}"; |
| [582](#L582) | $customer->update(); |
| [583](#L583) | $subscription = $customer->getSubscription($result[0]['subscriptionid']); |
| [584](#L584) | $subscription->amount = (object) [ |
| [585](#L585) | "currency" => "EUR", |
| [586](#L586) | "value" => "{$amount}", |
| [587](#L587) | ]; |
| [588](#L588) | $subscription->times = "{$times}"; |
| [589](#L589) | $subscription->interval = "{$interval} {$interval\_type}"; |
| [590](#L590) |  |
| [591](#L591) | if ($startdate >= date('Y-m-d') and $startdate != ""){ |
| [592](#L592) | $subscription->startDate = "{$startdate}"; |
| [593](#L593) | }else{ |
| [594](#L594) | $startdate = $subscription->startDate; |
| [595](#L595) | $subscription->startDate = null; |
| [596](#L596) | } |
| [597](#L597) | $subscription->description = "{$description}"; |
| [598](#L598) | $updatedSubscription = $subscription->update(); |
| [599](#L599) |  |
| [600](#L600) | //Update Database |
| [601](#L601) | $wpdb->query($wpdb->prepare("UPDATE {$table\_name} SET amount='%s', name='{$name}', email='{$email}', times='{$times}', startdate= '{$startdate}', description='{$description}' WHERE orderid='{$result[0]['orderid']}'",$amount)); |
| [602](#L602) | } catch (\Mollie\Api\Exceptions\ApiException $e) { |
| [603](#L603) | echo "Admin menu 3: API call failed: " . htmlspecialchars($e->getMessage()); |
| [604](#L604) | } |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) | function cf7mollie\_process\_mandate(){ |
| [608](#L608) | require \_\_DIR\_\_ . '/initialize.php'; |
| [609](#L609) | global $wpdb; |
| [610](#L610) | $table\_name = $wpdb->prefix . 'cf7\_mollie'; |
| [611](#L611) | cf7\_mollie\_setapikey(); |
| [612](#L612) | global $mollie; |
| [613](#L613) |  |
| [614](#L614) | try{ |
| [615](#L615) | $name = sanitize\_text\_field($\_POST['name']); |
| [616](#L616) | $bankname = sanitize\_text\_field($\_POST['bankname']); |
| [617](#L617) | $email = sanitize\_email($\_POST['email']); |
| [618](#L618) | $iban = sanitize\_text\_field($\_POST['iban']); |
| [619](#L619) | $amount = str\_replace(',', '.', $\_POST['amount']); |
| [620](#L620) | $amount = number\_format($amount,2,".",""); |
| [621](#L621) | $amount = sanitize\_text\_field($amount); |
| [622](#L622) | $times = sanitize\_text\_field($\_POST['times']); |
| [623](#L623) | $interval = sanitize\_text\_field($\_POST['interval']); |
| [624](#L624) | $interval\_type = sanitize\_text\_field($\_POST['interval\_type']); |
| [625](#L625) | $startdate = sanitize\_text\_field($\_POST['startdate']); |
| [626](#L626) | if ($startdate == null or $startdate == "0000-00-00"){ |
| [627](#L627) | $startdate = date('Y-m-d'); |
| [628](#L628) | } |
| [629](#L629) | $signaturedate = sanitize\_text\_field($\_POST['signaturedate']); |
| [630](#L630) | $description = sanitize\_text\_field($\_POST['description']); |
| [631](#L631) | $order\_id =! empty($\_POST["order\_id"]) ? $\_POST["order\_id"] : time(); |
| [632](#L632) | $webhook = esc\_url\_raw($\_POST['webhook']); |
| [633](#L633) |  |
| [634](#L634) | //Create Mollie customer |
| [635](#L635) | $customer = $mollie->customers->create([ |
| [636](#L636) | "name" => "{$name}", |
| [637](#L637) | "email" => "{$email}", |
| [638](#L638) | ]); |
| [639](#L639) | $customerid = $customer->id; |
| [640](#L640) |  |
| [641](#L641) | //Create Mollie mandate |
| [642](#L642) | $mandate = $mollie->customers->get($customer->id)->createMandate([ |
| [643](#L643) | "method" => \Mollie\Api\Types\MandateMethod::DIRECTDEBIT, |
| [644](#L644) | "consumerName" => "{$bankname}", |
| [645](#L645) | "consumerAccount" => "{$iban}", |
| [646](#L646) | "signatureDate" => "{$signaturedate}", |
| [647](#L647) | ]); |
| [648](#L648) |  |
| [649](#L649) | if ($amount != ""){ |
| [650](#L650) | //Create Mollie subscription |
| [651](#L651) | $customer->createSubscription([ |
| [652](#L652) | "amount" => [ |
| [653](#L653) | "currency" => "EUR", |
| [654](#L654) | "value" => "{$amount}", |
| [655](#L655) | ], |
| [656](#L656) | "interval" => "{$interval} {$interval\_type}", |
| [657](#L657) | "startDate" => "{$startdate}", |
| [658](#L658) | "metadata" => [ |
| [659](#L659) | "order\_id" => "{$order\_id}", |
| [660](#L660) | ], |
| [661](#L661) | "description" => "{$description}", |
| [662](#L662) | "webhookUrl" => "{$webhook}", |
| [663](#L663) | ]); |
| [664](#L664) |  |
| [665](#L665) | $subscriptions = $customer->subscriptions(); |
| [666](#L666) | $subscriptionId = $subscriptions[0]->id; |
| [667](#L667) | $subscription = $customer->getSubscription($subscriptionId); |
| [668](#L668) | if ($times != ""){ |
| [669](#L669) | $subscription->times = "{$times}"; |
| [670](#L670) | } |
| [671](#L671) | } |
| [672](#L672) |  |
| [673](#L673) | //Update Database |
| [674](#L674) | $result = $wpdb->query($wpdb->prepare("UPDATE {$table\_name} SET amount='%s', name='{$name}', email='{$email}', times='{$times}', startdate='{$startdate}', description='{$description}' WHERE orderid='{$order\_id}'",$amount)); |
| [675](#L675) |  |
| [676](#L676) | if ($result==0){ |
| [677](#L677) | $wpdb->insert( |
| [678](#L678) | $table\_name, |
| [679](#L679) | array( |
| [680](#L680) | 'time' => current\_time( 'mysql' ), |
| [681](#L681) | 'orderid' => "{$order\_id}", |
| [682](#L682) | 'amount' => "{$amount}", |
| [683](#L683) | 'description' => "{$description}", |
| [684](#L684) | 'customerid' => "{$customerid}", |
| [685](#L685) | 'name' => "{$name}", |
| [686](#L686) | 'email' => "{$email}", |
| [687](#L687) | 'frequency'=>"{$interval} {$interval\_type}", |
| [688](#L688) | 'times' => "{$times}", |
| [689](#L689) | 'subscriptionid' => "{$subscriptionId}", |
| [690](#L690) | 'startdate' => "{$startdate}" |
| [691](#L691) | ) |
| [692](#L692) | ); |
| [693](#L693) | } |
| [694](#L694) | } catch (\Mollie\Api\Exceptions\ApiException $e) { |
| [695](#L695) | echo "Admin menu 4: API call failed: " . htmlspecialchars($e->getMessage()); |
| [696](#L696) | } |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | function cf7\_mollie\_show\_payments(){ |
| [700](#L700) | require \_\_DIR\_\_ . '/initialize.php'; |
| [701](#L701) | global $wpdb; |
| [702](#L702) | $table\_name = $wpdb->prefix . 'cf7\_mollie'; |
| [703](#L703) | cf7\_mollie\_setapikey(); |
| [704](#L704) | global $mollie; |
| [705](#L705) |  |
| [706](#L706) | $customer = sanitize\_text\_field($\_GET['customerid']); |
| [707](#L707) |  |
| [708](#L708) | try{ |
| [709](#L709) | $payments = $mollie->customers->get("{$customer}")->payments(); |
| [710](#L710) | $name = $mollie->customers->get("{$customer}")->name; |
| [711](#L711) | global $wp; |
| [712](#L712) | $current\_url = add\_query\_arg( $wp->query\_vars, home\_url( $wp->request ) ); |
| [713](#L713) | //echo '<pre>'; print\_r($payments); echo '</pre>'; |
| [714](#L714) |  |
| [715](#L715) | $html .= '<div id="cf7-mollie-client-payments-overview-wrapper"> |
| [716](#L716) | <h4>'.\_\_("Payments for customer", 'cf7-mollie-translation')." ".$name.'</h4> |
| [717](#L717) | <table class="cf7-mollie-client-payments-overview-table"> |
| [718](#L718) | <thead class="cf7-mollie-payments-head"> |
| [719](#L719) | <tr> |
| [720](#L720) | <th>'.\_\_("Date", 'cf7-mollie-translation').'</th> |
| [721](#L721) | <th>'.\_\_("Amount", 'cf7-mollie-translation').'</th> |
| [722](#L722) | <th>'.\_\_("Status", 'cf7-mollie-translation').'</th> |
| [723](#L723) | </tr> |
| [724](#L724) | </thead> |
| [725](#L725) | <tbody class="cf7-mollie-payments-body">'; |
| [726](#L726) |  |
| [727](#L727) | $i = 0; |
| [728](#L728) | foreach ($payments as $payment) { |
| [729](#L729) | //echo '<pre>'; print\_r($payment); echo '</pre>'; |
| [730](#L730) | $i++; |
| [731](#L731) | $html .= '<tr class="cf7-mollie-payments-row-'.$i.'"> |
| [732](#L732) | <td>'.date('d-m-Y',strtotime(substr($payment->createdAt, 0, 10))).'</td> |
| [733](#L733) | <td>'.$payment->amount->value.'</td> |
| [734](#L734) | <td>'.\_\_($payment->status, 'cf7-mollie-translation').'</td> |
| [735](#L735) | </tr>'; |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | $html .= '</tbody> |
| [739](#L739) | </table> |
| [740](#L740) | <br> |
| [741](#L741) | <a href="'.str\_replace ("customerid=".$\_GET['customerid'],"",$current\_url).'">'.\_\_( 'Back to main page', 'cf7-mollie-translation').'</a> |
| [742](#L742) | </div>'; |
| [743](#L743) |  |
| [744](#L744) | return $html; |
| [745](#L745) | } catch (\Mollie\Api\Exceptions\ApiException $e) { |
| [746](#L746) | echo "Admin menu 5: API call failed: " . htmlspecialchars($e->getMessage()); |
| [747](#L747) | } |
| [748](#L748) |  |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | function cf7\_mollie\_edit\_recurring\_payment($DatabaseID=""){ |
| [752](#L752) | global $mollie; |
| [753](#L753) | cf7\_mollie\_setapikey(); |
| [754](#L754) | global $wpdb; |
| [755](#L755) | global $table\_name; |
| [756](#L756) |  |
| [757](#L757) | //Retrieve information from database |
| [758](#L758) | if ($DatabaseID == ""){ |
| [759](#L759) | $DatabaseID = !empty($\_GET["payment"]) ? $\_GET["payment"] : "1"; |
| [760](#L760) | } |
| [761](#L761) | $query = "SELECT \* FROM {$table\_name} WHERE `id` =".$DatabaseID; |
| [762](#L762) | $result = json\_decode(json\_encode($wpdb->get\_results($query)), True); |
| [763](#L763) | //Retrieve information from Mollie |
| [764](#L764) | try{ |
| [765](#L765) | $customer = $mollie->customers->get("{$result[0]['customerid']}"); |
| [766](#L766) | $name = $customer->name; |
| [767](#L767) | $email = $customer->email; |
| [768](#L768) | $subscription = $customer->getSubscription("{$result[0]['subscriptionid']}"); |
| [769](#L769) | $amount = $subscription->amount->value; |
| [770](#L770) | $frequency\_string = $subscription->interval; |
| [771](#L771) | $frequency = explode (" ",$frequency\_string)[0]; |
| [772](#L772) | $frequency\_type = explode (" ",$frequency\_string)[1]; |
| [773](#L773) |  |
| [774](#L774) | } catch (\Mollie\Api\Exceptions\ApiException $e) { |
| [775](#L775) | echo "Admin menu 2: API call failed: " . htmlspecialchars($e->getMessage()); |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | global $wp; |
| [779](#L779) | $current\_url = add\_query\_arg( $wp->query\_string, '', home\_url( $wp->request ) ); |
| [780](#L780) |  |
| [781](#L781) | if ($\_GET['page'] == "wpcf7-mollie-config"){ |
| [782](#L782) | $current\_url .= "/wp-admin/admin.php?page=wpcf7-mollie-config"; |
| [783](#L783) | }else{ |
| [784](#L784) | $current\_url = "/test/?page\_id=930"; |
| [785](#L785) | } |
| [786](#L786) |  |
| [787](#L787) | $html = ' |
| [788](#L788) | <div class="cf7\_mollie\_update\_payment"> |
| [789](#L789) | <div id="icon-users" class="icon32"><br/></div> |
| [790](#L790) | <h2>'.\_\_("Edit values", 'cf7-mollie-translation').'</h2>'. |
| [791](#L791) | \_\_("The values below are retrieved from Mollie.", 'cf7-mollie-translation').'<br>'. |
| [792](#L792) | \_\_("All changed values will also be changed at the side of Mollie.", 'cf7-mollie-translation').'<br><br> |
| [793](#L793) | <form action="'.$current\_url.'" method="post"> |
| [794](#L794) | <input type="hidden" name="row\_id" class="row\_id" value="'.$DatabaseID.'">'. |
| [795](#L795) | \_\_("Name", 'cf7-mollie-translation').':<br> |
| [796](#L796) | <input type="text" name="cf7\_mollie\_name" class="cf7\_mollie\_name" value="'.$name .'"><br>'. |
| [797](#L797) | \_\_("E-mail", 'cf7-mollie-translation').':<br> |
| [798](#L798) | <input type="text" name="cf7\_mollie\_email" class="cf7\_mollie\_email" value="'. $email .'"><br>'. |
| [799](#L799) | \_\_("Amount", 'cf7-mollie-translation').':<br> |
| [800](#L800) | <input type="text" name="cf7\_mollie\_amount" class="cf7\_mollie\_amount" value="'. $amount .'"><br>'. |
| [801](#L801) | \_\_("Description", 'cf7-mollie-translation').':<br> |
| [802](#L802) | <input type="text" name="cf7\_mollie\_description" class="cf7\_mollie\_description" value="'. $subscription->description  .'"><br>'. |
| [803](#L803) | \_\_("Times", 'cf7-mollie-translation').':<br> |
| [804](#L804) | <input type="number" name="cf7\_mollie\_times" class="cf7\_mollie\_times" value="'.$subscription->times  .'"><br>'. |
| [805](#L805) | \_\_("Frequency", 'cf7-mollie-translation').':<br> |
| [806](#L806) | <input type="number" name="cf7\_mollie\_interval" class="cf7\_mollie\_interval" value="'.$frequency.'"> |
| [807](#L807) | <select name="cf7\_mollie\_interval\_type" class="cf7\_mollie\_interval\_type">'; |
| [808](#L808) |  |
| [809](#L809) | foreach(["months","weeks","days"] as $value){ |
| [810](#L810) | if ($value == $frequency\_type){ |
| [811](#L811) | $html .= '<option value="'.$value.'" selected="selected">'.\_\_($value, 'cf7-mollie-translation').'</option>'; |
| [812](#L812) | }else{ |
| [813](#L813) | $html .= '<option value="'.$value.'">'.\_\_($value, 'cf7-mollie-translation').'</option>'; |
| [814](#L814) | } |
| [815](#L815) | } |
| [816](#L816) | $html .= '</select><br>'; |
| [817](#L817) |  |
| [818](#L818) |  |
| [819](#L819) | if ($subscription->startDate >= date('Y-m-d')){ |
| [820](#L820) | $html .= \_\_("Start date", 'cf7-mollie-translation').'<br> |
| [821](#L821) | <input type="date" name="cf7\_mollie\_startdate" id="startdate" class="cf7\_mollie\_startdate" value="'. $subscription->startDate .'"   min="'. date('Y-m-d').'">'; |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | $html .= '<br><br><br> |
| [825](#L825) | <input type="submit" value="'.\_\_("Submit", 'cf7-mollie-translation').'" class="button"> |
| [826](#L826) | </form> |
| [827](#L827) | </div>'; |
| [828](#L828) |  |
| [829](#L829) | return $html; |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | function cf7\_mollie\_delete\_recurring\_payment($ID=""){ |
| [833](#L833) | global $mollie; |
| [834](#L834) | cf7\_mollie\_setapikey(); |
| [835](#L835) | global $wpdb; |
| [836](#L836) | global $table\_name; |
| [837](#L837) |  |
| [838](#L838) | $DatabaseID = $ID; |
| [839](#L839) |  |
| [840](#L840) | if ($DatabaseID == ""){ |
| [841](#L841) | $DatabaseID = !empty($\_GET["payment"]) ? $\_GET["payment"] : "1"; |
| [842](#L842) | } |
| [843](#L843) | $confirm = !empty($\_GET["confirm"]) ? $\_GET["confirm"] : ""; |
| [844](#L844) | $confirm = sanitize\_text\_field($confirm); |
| [845](#L845) |  |
| [846](#L846) | $subscription\_count = 0; |
| [847](#L847) | foreach ($DatabaseID as $ID){ |
| [848](#L848) | //Retrieve information from database |
| [849](#L849) | $query = "SELECT \* FROM {$table\_name} WHERE `id` =".$ID; |
| [850](#L850) | $result = json\_decode(json\_encode($wpdb->get\_results($query)), True); |
| [851](#L851) |  |
| [852](#L852) | if ($result[0]['subscriptionid'] != ""){ |
| [853](#L853) | $subscription\_count++; |
| [854](#L854) | }else{ |
| [855](#L855) | $wpdb->delete( $table\_name, array( 'id' => $ID )); |
| [856](#L856) | } |
| [857](#L857) |  |
| [858](#L858) | if ($result[0]['subscriptionid'] != ""){ |
| [859](#L859) | if ($confirm=="true"){ |
| [860](#L860) | try{ |
| [861](#L861) | $customer = $mollie->customers->get("{$result[0]['customerid']}"); |
| [862](#L862) | $subscription = $customer->cancelSubscription("{$result[0]['subscriptionid']}"); |
| [863](#L863) | } catch (\Mollie\Api\Exceptions\ApiException $e) { |
| [864](#L864) | echo "Admin menu 1: API call failed: " . htmlspecialchars($e->getMessage()); |
| [865](#L865) | } |
| [866](#L866) | } |
| [867](#L867) | if ($confirm!=""){ |
| [868](#L868) | $wpdb->delete( $table\_name, array( 'id' => $ID )); |
| [869](#L869) | } |
| [870](#L870) | } |
| [871](#L871) | } |
| [872](#L872) |  |
| [873](#L873) | if ($subscription\_count != 0 and $confirm==""){ |
| [874](#L874) | if ($ID==""){ |
| [875](#L875) | $parameter = "confirm="; |
| [876](#L876) | }else{ |
| [877](#L877) | $parameter = "payment[0]={$ID}&confirm="; |
| [878](#L878) | } |
| [879](#L879) | ?> |
| [880](#L880) | <div class="cf7\_mollie\_delete\_payment"> |
| [881](#L881) | <div id="icon-users" class="icon32"><br/></div> |
| [882](#L882) | <h2><?php \_\_("Confirm subscription cancellation", 'cf7-mollie-translation') ?></h2> |
| [883](#L883) | <br> |
| [884](#L884) | <font size="3"> |
| [885](#L885) | <?php |
| [886](#L886) | if (count ($DatabaseID)==1){ |
| [887](#L887) | echo sprintf(\_\_("Are you sure to cancel the subscription with id '%s'?", 'cf7-mollie-translation'),$result[0]['subscriptionid']); |
| [888](#L888) | ?><br><br> |
| [889](#L889) | <?php }else{ |
| [890](#L890) | echo sprintf(\_\_("Are you sure to cancel all %s subscriptions?", 'cf7-mollie-translation'),$subscription\_count); ?> <br><br> |
| [891](#L891) | <?php } ?> |
| [892](#L892) | <button id="yes" onclick="get\_url('<?php echo $parameter; ?>true')" class="button"> |
| [893](#L893) | <?php \_e("Yes", 'cf7-mollie-translation') ?> |
| [894](#L894) | </button> |
| [895](#L895) | <button id="no" onclick="get\_url('<?php echo $parameter; ?>false')" class="button"> |
| [896](#L896) | <?php \_e("No", 'cf7-mollie-translation') ?> |
| [897](#L897) | </button> |
| [898](#L898) | </font> |
| [899](#L899) | </div> |
| [900](#L900) | <script> |
| [901](#L901) | function get\_url(a) { |
| [902](#L902) | \_url = location.href; |
| [903](#L903) | \_url += ((\_url.split('?').length==2) ? '&':'?') + a; |
| [904](#L904) | location.href = \_url; |
| [905](#L905) | } |
| [906](#L906) | </script> |
| [907](#L907) |  |
| [908](#L908) | <?php |
| [909](#L909) | }else{ |
| [910](#L910) | if ($confirm=="true"){ |
| [911](#L911) | \_e("Items deleted scuccesfully from mollie and local database", 'cf7-mollie-translation'); |
| [912](#L912) | }else{ |
| [913](#L913) | \_e("Items deleted scuccesfully from local database only.", 'cf7-mollie-translation'); |
| [914](#L914) | } |
| [915](#L915) |  |
| [916](#L916) | global $wp; |
| [917](#L917) | $current\_url = add\_query\_arg( $wp->query\_string, '', home\_url( $wp->request ) ); |
| [918](#L918) | header("Location: ".$current\_url); |
| [919](#L919) |  |
| [920](#L920) | //Redirect to main screen after 3 seconds |
| [921](#L921) | echo " |
| [922](#L922) | <script type=\"text/javascript\"> |
| [923](#L923) | setTimeout(function(){ |
| [924](#L924) | window.location = window.location.href.split('?')[0]+'?page=wpcf7-mollie-config'; |
| [925](#L925) | }, 3000); |
| [926](#L926) | </script> |
| [927](#L927) | "; |
| [928](#L928) | } |
| [929](#L929) | return $html; |
| [930](#L930) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/cf7-mollie/trunk/includes/php/admin_menu.php?format=txt)
* [Original Format](/export/3222474/cf7-mollie/trunk/includes/php/admin_menu.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


