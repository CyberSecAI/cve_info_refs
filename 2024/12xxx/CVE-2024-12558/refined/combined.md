=== Content from www.wordfence.com_8234f861_20250114_231108.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WP BASE Booking of Appointments, Services and Events <= 4.9.2 - Missing Authorization to Authenticated (Subscriber+) Sensitive Information Exposure via app\_export\_db

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WP BASE Booking of Appointments, Services and Events <= 4.9.2 - Missing Authorization to Authenticated (Subscriber+) Sensitive Information Exposure via app\_export\_db

6.5

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N)

| CVE | [CVE-2024-12558](https://www.cve.org/CVERecord?id=CVE-2024-12558) |
| --- | --- |
| CVSS | 6.5 (Medium) |
| Publicly Published | December 20, 2024 |
| Last Updated | December 21, 2024 |
| Researcher | [Thanh Nam Tran](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/thanh-nam-tran) |

### Description

The WP BASE Booking of Appointments, Services and Events plugin for WordPress is vulnerable to unauthorized access of data due to a missing capability check on the export\_db function in all versions up to, and including, 4.9.2. This makes it possible for authenticated attackers, with Subscriber-level access and above, to expose sensitive information from the database, such as the hashed administrator password.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3210164/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?old=3207827&old_path=wp-base-booking-of-appointments-services-and-events%2Ftags%2F4.9.2%2Fincludes%2Ffreeons%2Fexport-import.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-base-booking-of-appointments-services-and-events%2Fwp-base-booking-of-appointments-services-and-events-492-missing-authorization-to-authenticated-subscriber-sensitive-information-exposure-via-app-export-db&t=WP%20BASE%20Booking%20of%20Appointments%2C%20Services%20and%20Events%20%3C%3D%204.9.2%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20Sensitive%20Information%20Exposure%20via%20app_export_db "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-base-booking-of-appointments-services-and-events%2Fwp-base-booking-of-appointments-services-and-events-492-missing-authorization-to-authenticated-subscriber-sensitive-information-exposure-via-app-export-db&text=WP%20BASE%20Booking%20of%20Appointments%2C%20Services%20and%20Events%20%3C%3D%204.9.2%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20Sensitive%20Information%20Exposure%20via%20app_export_db "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-base-booking-of-appointments-services-and-events%2Fwp-base-booking-of-appointments-services-and-events-492-missing-authorization-to-authenticated-subscriber-sensitive-information-exposure-via-app-export-db "LinkedIn")
Email

## Vulnerability Details for WP BASE Booking of Appointments, Services and Events

#### [WP BASE Booking of Appointments, Services and Events](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-base-booking-of-appointments-services-and-events)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-base-booking-of-appointments-services-and-events [(view on wordpress.org)](https://wordpress.org/plugins/wp-base-booking-of-appointments-services-and-events) |
| Patched? | Yes |
| Remediation | Update to version 5.0.0, or a newer patched version |
| Affected Version | * <= 4.9.2 |
| Patched Version | * 5.0.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_0bf1cdaf_20250114_231101.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-base-booking-of-appointments-services-and-events%2Ftags%2F4.9.2%2Fincludes%2Ffreeons%2Fexport-import.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-base-booking-of-appointments-services-and-events](/browser/wp-base-booking-of-appointments-services-and-events?order=name "View wp-base-booking-of-appointments-services-and-events")/[tags](/browser/wp-base-booking-of-appointments-services-and-events/tags?order=name "View tags")/[4.9.2](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2?order=name "View 4.9.2")/[includes](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes?order=name "View includes")/[freeons](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons?order=name "View freeons")/[export-import.php](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?order=name "View export-import.php")

View diff against:

View revision:

| [Last change](/changeset/3207827/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php "View differences") on this file was [3207827](/changeset/3207827/ "View changeset 3207827"), checked in by PuckRobin, [5 weeks ago](/timeline?from=2024-12-14T02%3A52%3A19Z&precision=second "See timeline at 12/14/2024 02:52:19 AM") |
| --- |
| Uploading V4.9.2 - I |
| **File size:** 66.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | \* Plugin Name: WP BASE Addon: Export & Import |
| [4](#L4) | \* Description: Allows export and import of WP BASE settings and database tables from A+ on the same blog or from WP BASE from another blog/subsite |
| [5](#L5) | \* Class Name: WpBEXIM |
| [6](#L6) | \* ID: 248 |
| [7](#L7) | \* Category: Free |
| [8](#L8) | \* Author: Hakan Ozevin |
| [9](#L9) | \* Version: 4.0.1 |
| [10](#L10) | \* WPB requires: 4.0.0 |
| [11](#L11) | \* |
| [12](#L12) | \* Copyright © 2018 - 2024 Hakan Ozevin |
| [13](#L13) | \* @package WP BASE |
| [14](#L14) | \* @author Hakan Ozevin |
| [15](#L15) | \*/ |
| [16](#L16) |  |
| [17](#L17) | if ( ! defined( 'ABSPATH' ) ) exit; |
| [18](#L18) |  |
| [19](#L19) | if ( ! class\_exists( 'WpBEXIM' ) ) { |
| [20](#L20) |  |
| [21](#L21) | class WpBEXIM { |
| [22](#L22) |  |
| [23](#L23) | /\*\* |
| [24](#L24) | \* WP BASE instance |
| [25](#L25) | \*/ |
| [26](#L26) | protected $a                                    = null; |
| [27](#L27) | private $error                                  = array(); |
| [28](#L28) | private $wh\_queries                     = array(); |
| [29](#L29) | private $users\_to\_replace               = array(); |
| [30](#L30) | protected $users\_added                  = 0; |
| [31](#L31) | protected $posts\_added                  = 0; |
| [32](#L32) | protected $records\_added                = 0; |
| [33](#L33) | protected $app\_worker\_updated   = 0; |
| [34](#L34) | protected $options\_added                = 0; |
| [35](#L35) | protected $old\_suppress\_state   = null; |
| [36](#L36) | protected $skip\_error\_recording = null; |
| [37](#L37) |  |
| [38](#L38) | /\*\* |
| [39](#L39) | \* Constructor |
| [40](#L40) | \*/ |
| [41](#L41) | public function \_\_construct() { |
| [42](#L42) | if ( ! defined( 'WPB\_EXPORT\_PHP\_MAXMEMORY' ) ) define( 'WPB\_EXPORT\_PHP\_MAXMEMORY', 128 \* MB\_IN\_BYTES ); |
| [43](#L43) | if ( ! defined( 'WPB\_EXPORT\_CHUNK\_SIZE' ) ) define( 'WPB\_EXPORT\_CHUNK\_SIZE', 100 ); |
| [44](#L44) | if ( ! defined( 'WPB\_IMPORT\_CHUNK\_SIZE' ) ) define( 'WPB\_IMPORT\_CHUNK\_SIZE', 20 ); |
| [45](#L45) | if ( ! defined( 'WPB\_IMPORT\_ERROR\_RECORD\_SIZE' ) ) define( 'WPB\_IMPORT\_ERROR\_RECORD\_SIZE', 50 ); |
| [46](#L46) |  |
| [47](#L47) | $this->a = BASE(); |
| [48](#L48) | } |
| [49](#L49) |  |
| [50](#L50) | /\*\* |
| [51](#L51) | \* Add actions and filters |
| [52](#L52) | \*/ |
| [53](#L53) | public function add\_hooks() { |
| [54](#L54) |  |
| [55](#L55) | // Export Settings and DB |
| [56](#L56) | add\_filter( 'appointments\_tools\_tabs', array( $this, 'add\_tab' ), 20 ); |
| [57](#L57) | add\_action( 'app\_addon\_settings\_link', array( $this, 'settings\_link' ), 14 );           // Add settings link to Addons page |
| [58](#L58) | add\_action( 'app\_save\_settings', array( $this, 'save\_settings' ), 8 );                          // Handle Import actions |
| [59](#L59) | add\_action( 'wp\_ajax\_app\_export', array( $this, 'export\_csv' ) );                                       // Export apps in CSV format |
| [60](#L60) | add\_action( 'wp\_ajax\_app\_export\_settings', array( $this, 'export\_settings' ) );         // Export settings |
| [61](#L61) | add\_action( 'wp\_ajax\_app\_export\_db', array( $this, 'export\_db' ) );                                     // Export DB |
| [62](#L62) | add\_action( 'app\_tools\_impex\_tab', array( $this, 'render\_tab' ) );                                      // Create HTML for impex tab |
| [63](#L63) | add\_action( 'app\_tools\_import\_from\_a\_plus\_tab', array( $this, 'render\_tab\_a' ) );       // Create HTML for import from A+ |
| [64](#L64) | add\_action( 'admin\_init', array( $this, 'init' ) ); |
| [65](#L65) | add\_action( 'template\_redirect', array( $this, 'init' ), 100 ); |
| [66](#L66) |  |
| [67](#L67) | add\_filter( 'app\_disable\_addon', function( $result, $addon ){return wpb\_disable\_addon( $result, $addon, \_\_FILE\_\_ );}, 10, 2 ); |
| [68](#L68) |  |
| [69](#L69) | do\_action( 'app\_export\_addon\_loaded' ); |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | public static function prefix(){ |
| [73](#L73) | return BASE()->db->prefix; |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | public static function base\_prefix(){ |
| [77](#L77) | return BASE()->db->base\_prefix; |
| [78](#L78) | } |
| [79](#L79) |  |
| [80](#L80) | /\*\* |
| [81](#L81) | \* Save settings |
| [82](#L82) | \*/ |
| [83](#L83) | public function save\_settings() { |
| [84](#L84) |  |
| [85](#L85) | if ( empty( $\_POST['action\_app'] ) ) { |
| [86](#L86) | return; |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) | // Import settings |
| [90](#L90) | if ( isset( $\_POST['import\_settings'] ) && 'import\_settings' == $\_POST['action\_app'] ) { |
| [91](#L91) | $this->import\_settings(); |
| [92](#L92) | return; |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | // Import DB tables |
| [96](#L96) | if ( isset( $\_POST['import\_db'] ) && 'import\_db' == $\_POST['action\_app'] ) { |
| [97](#L97) | $this->import\_db(); |
| [98](#L98) | return; |
| [99](#L99) | } |
| [100](#L100) |  |
| [101](#L101) | // Import From A+ |
| [102](#L102) | if ( isset( $\_POST['import\_a\_plus'] ) && 'import\_a\_plus' == $\_POST['action\_app'] ) { |
| [103](#L103) | if ( $result = wpb\_import\_from\_a\_plus() ) { |
| [104](#L104) | update\_option( 'app\_imported\_from\_a\_plus', $result ); |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | return; |
| [108](#L108) | } |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) | /\*\* |
| [112](#L112) | \* Check if there is admin notice to be displayed |
| [113](#L113) | \* @since 3.1.0 |
| [114](#L114) | \*/ |
| [115](#L115) | public function init(){ |
| [116](#L116) | if ( ! empty( $\_GET['export-failed'] ) ) { |
| [117](#L117) | wpb\_notice( esc\_html( urldecode( $\_GET['export-failed'] ) ), 'error' ); |
| [118](#L118) | } |
| [119](#L119) | } |
| [120](#L120) |  |
| [121](#L121) | /\*\* |
| [122](#L122) | \* Save a CSV file of all appointments |
| [123](#L123) | \* @since 1.0.9 |
| [124](#L124) | \*/ |
| [125](#L125) | function export\_csv(){ |
| [126](#L126) |  |
| [127](#L127) | if ( empty( $\_GET['export\_csv\_nonce'] ) || ! wp\_verify\_nonce( $\_GET['export\_csv\_nonce'], 'export\_csv' ) ) { |
| [128](#L128) | return; |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | if ( ! defined( 'WPB\_EXPORT\_CSV\_DEMILITER' ) ) define( 'WPB\_EXPORT\_CSV\_DEMILITER', ',' ); |
| [132](#L132) |  |
| [133](#L133) | $start          = ! empty( $\_POST['start'] ) ? date( 'Y-m-d H:i:s', strtotime( $\_POST['start'] ) ) : '1970-01-01'; |
| [134](#L134) | $end            = ! empty( $\_POST['end'] ) ? date( 'Y-m-d H:i:s', strtotime( $\_POST['end'] ) ) : '2040-01-01'; |
| [135](#L135) | $only\_own\_q = apply\_filters( 'app\_export\_csv\_query', (! empty( $\_GET['only\_own'] ) ? $this->a->db->prepare( 'worker=%d', get\_current\_user\_id() ) : '1=1') ); |
| [136](#L136) | $referer        = ! empty( $\_GET['referer'] ) ? urldecode( $\_GET['referer'] ) : admin\_url( 'admin.php?page=app\_tools' ); |
| [137](#L137) |  |
| [138](#L138) | $apps = $this->a->db->get\_results( $this->a->db->prepare( |
| [139](#L139) | "SELECT \* FROM " . $this->a->app\_table . |
| [140](#L140) | " WHERE start >= %s AND start <= %s AND {$only\_own\_q}". |
| [141](#L141) | " ORDER BY ID", $start, $end ), ARRAY\_A ); |
| [142](#L142) |  |
| [143](#L143) | if ( ! is\_array( $apps ) || empty( $apps ) ) { |
| [144](#L144) | wp\_redirect( add\_query\_arg( array( |
| [145](#L145) | 'export-failed' => urldecode( \_\_('There are no matching data records.','wp-base') ), |
| [146](#L146) | ), $referer ) ); |
| [147](#L147) | exit; |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | $cols = apply\_filters( 'app\_export\_csv\_columns', $this->a->db->get\_col\_info(), 'file' ); |
| [151](#L151) |  |
| [152](#L152) | if ( ( $key = array\_search( 'manual\_payment', $cols ) ) !== false ) { |
| [153](#L153) | unset( $cols[$key] ); |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | $selected = $unselected = array(); |
| [157](#L157) |  |
| [158](#L158) | foreach ( $cols as $col ) { |
| [159](#L159) | if ( isset( $\_POST["app\_csv\_".$col] ) && 1 ==  $\_POST["app\_csv\_".$col] ) { |
| [160](#L160) | $selected[] = $col; |
| [161](#L161) | } else { |
| [162](#L162) | $unselected[] = $col; |
| [163](#L163) | } |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | if ( empty( $selected ) ) { |
| [167](#L167) | wp\_redirect( add\_query\_arg( array( |
| [168](#L168) | 'export-failed' => urldecode( \_\_('Please tick some check boxes.','wp-base') ), |
| [169](#L169) | ), $referer ) ); |
| [170](#L170) | exit; |
| [171](#L171) | } |
| [172](#L172) |  |
| [173](#L173) | // Save user preference |
| [174](#L174) | update\_user\_meta( get\_current\_user\_id(), 'app\_export\_unchecked\_columns', $unselected ); |
| [175](#L175) |  |
| [176](#L176) | $col\_data = apply\_filters( 'app\_export\_csv\_column\_names', array\_combine( $selected, $selected ), 'file' ); |
| [177](#L177) |  |
| [178](#L178) | array\_walk( $col\_data, array( $this, 'correct\_field\_name' ) ); |
| [179](#L179) |  |
| [180](#L180) | $file = fopen('php://temp/maxmemory:'. WPB\_EXPORT\_PHP\_MAXMEMORY, 'r+'); |
| [181](#L181) |  |
| [182](#L182) | fputcsv( $file, $col\_data, WPB\_EXPORT\_CSV\_DEMILITER ); |
| [183](#L183) |  |
| [184](#L184) | foreach ( $apps as $app ) { |
| [185](#L185) |  |
| [186](#L186) | if ( apply\_filters( 'app\_export\_csv\_skip\_item', false, $app ) ) { |
| [187](#L187) | continue; |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) | foreach ( $unselected as $unset ) { |
| [191](#L191) | unset( $app[ $unset ] ); |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | $orig\_app = $app; |
| [195](#L195) |  |
| [196](#L196) | array\_walk( $app, array( $this, 'export\_helper') ); |
| [197](#L197) |  |
| [198](#L198) | fputcsv( $file, apply\_filters( 'app\_export\_csv\_row', $app, $col\_data, $orig\_app ), WPB\_EXPORT\_CSV\_DEMILITER ); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | $filename = apply\_filters( 'app\_export\_csv\_filename', sanitize\_file\_name( "wp-base-bookings-". get\_bloginfo( 'name' ) . "\_". date('F')."\_".date('d')."\_".date('Y') ) ) .".csv"; |
| [202](#L202) |  |
| [203](#L203) | //serve the file |
| [204](#L204) | rewind($file); |
| [205](#L205) |  |
| [206](#L206) | if ( ob\_get\_length() ) { |
| [207](#L207) | ob\_end\_clean(); |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | header('Content-Description: File Transfer'); |
| [211](#L211) | header('Content-Type: text/csv'); |
| [212](#L212) | header('Content-Disposition: attachment; filename="'.$filename.'"'); |
| [213](#L213) | header('Content-Transfer-Encoding: binary'); |
| [214](#L214) | header('Expires: 0'); |
| [215](#L215) | header('Cache-Control: must-revalidate, post-check=0, pre-check=0'); |
| [216](#L216) | header('Pragma: public'); |
| [217](#L217) | $output = stream\_get\_contents($file); |
| [218](#L218) | header('Content-Length: ' . strlen($output)); |
| [219](#L219) | fclose($file); |
| [220](#L220) | die($output); |
| [221](#L221) | } |
| [222](#L222) |  |
| [223](#L223) | /\*\* |
| [224](#L224) | \* Correct field names (Make first letter uppercase and replace underscores with spaces |
| [225](#L225) | \* @since 2.0 |
| [226](#L226) | \*/ |
| [227](#L227) | function correct\_field\_name( &$value, $key ) { |
| [228](#L228) | if ( 'ID' == $value ) { |
| [229](#L229) | $value = 'ID'; |
| [230](#L230) | } else { |
| [231](#L231) | $value = $this->a->get\_text( $key ) ?: ucfirst( str\_replace( "\_", " ", $value ) ); |
| [232](#L232) | } |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | /\*\* |
| [236](#L236) | \* Helper function for export |
| [237](#L237) | \* @since 1.0.9 |
| [238](#L238) | \*/ |
| [239](#L239) | function export\_helper( &$value, $key ) { |
| [240](#L240) | if ( 'created' == $key || 'start' == $key || 'end' == $key ) { |
| [241](#L241) | $value = mysql2date( $this->a->dt\_format, $value );     // Also translates |
| [242](#L242) | } else if ( 'user' == $key && $value ) { |
| [243](#L243) | $userdata = BASE('User')->\_get\_userdata( $value ); |
| [244](#L244) | if ( isset( $userdata->ID ) ) |
| [245](#L245) | $value = BASE('User')->get\_name( $userdata->ID ); |
| [246](#L246) | } else if ( 'location' == $key ) { |
| [247](#L247) | $value = $this->a->get\_location\_name( $value ); |
| [248](#L248) | } else if ( 'service' == $key ) { |
| [249](#L249) | $value = $this->a->get\_service\_name( $value ); |
| [250](#L250) | } else if ( 'worker' == $key ) { |
| [251](#L251) | $value = $this->a->get\_worker\_name( $value ); |
| [252](#L252) | } else if ( 'status' == $key ) { |
| [253](#L253) | $value = $this->a->get\_status\_name( $value ); |
| [254](#L254) | } |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) | /\*\* |
| [258](#L258) | \* Save a txt file of settings |
| [259](#L259) | \* @param save: If true, file is saved to be attached to email. If false, pdf file is sent to browser. |
| [260](#L260) | \* @since 2.0 |
| [261](#L261) | \*/ |
| [262](#L262) | function export\_settings( $save = false ){ |
| [263](#L263) |  |
| [264](#L264) | $file = fopen('php://temp/maxmemory:'. WPB\_EXPORT\_PHP\_MAXMEMORY, 'r+'); |
| [265](#L265) |  |
| [266](#L266) | fwrite( $file, wp\_json\_encode( |
| [267](#L267) | array( |
| [268](#L268) | 'settings'                              => get\_option( 'wp\_base\_options' ), |
| [269](#L269) | 'custom\_texts'                  => get\_option( 'wp\_base\_texts' ), |
| [270](#L270) | 'translations'                  => get\_option( 'wp\_base\_multilang' ), |
| [271](#L271) | ) |
| [272](#L272) | ) |
| [273](#L273) | ); |
| [274](#L274) |  |
| [275](#L275) | $filename = sanitize\_file\_name( "wp-base-settings-". get\_bloginfo( 'name' ) . "\_". date('F')."\_".date('d')."\_".date('Y') ).".json"; |
| [276](#L276) |  |
| [277](#L277) | //Start serve the file |
| [278](#L278) | rewind($file); |
| [279](#L279) |  |
| [280](#L280) | if ( ob\_get\_length() ) { |
| [281](#L281) | ob\_end\_clean(); |
| [282](#L282) | } |
| [283](#L283) |  |
| [284](#L284) | // Save this file to uploads folder to be used as attachment |
| [285](#L285) | if ( $save ) { |
| [286](#L286) | $output = stream\_get\_contents($file); |
| [287](#L287) | $result = file\_put\_contents( $this->a->uploads\_dir . '/' . $filename, $output ); |
| [288](#L288) | if ( $result ) { |
| [289](#L289) | return $filename; |
| [290](#L290) | } else { |
| [291](#L291) | return false; |
| [292](#L292) | } |
| [293](#L293) | } |
| [294](#L294) |  |
| [295](#L295) | // Or, serve the file to the browser |
| [296](#L296) | header('Content-Description: File Transfer'); |
| [297](#L297) | header('Content-Type: text/plain'); |
| [298](#L298) | header('Content-Disposition: attachment; filename="'.$filename.'"'); |
| [299](#L299) | header('Content-Transfer-Encoding: binary'); |
| [300](#L300) | header('Expires: 0'); |
| [301](#L301) | header('Cache-Control: must-revalidate, post-check=0, pre-check=0'); |
| [302](#L302) | header('Pragma: public'); |
| [303](#L303) | $output = stream\_get\_contents($file); |
| [304](#L304) | header('Content-Length: ' . strlen($output)); |
| [305](#L305) | fclose($file); |
| [306](#L306) | die($output); |
| [307](#L307) | } |
| [308](#L308) |  |
| [309](#L309) | /\*\* |
| [310](#L310) | \* Retrieve a txt file of settings |
| [311](#L311) | \* @since 2.0 |
| [312](#L312) | \*/ |
| [313](#L313) | function import\_settings(){ |
| [314](#L314) |  |
| [315](#L315) | wpb\_admin\_access\_check( 'manage\_tools' ); |
| [316](#L316) |  |
| [317](#L317) | if ( isset( $\_FILES["import\_file"]["tmp\_name"] ) && ! $\_FILES["import\_file"]["error"] ) { |
| [318](#L318) | $str = file\_get\_contents( $\_FILES["import\_file"]["tmp\_name"] ); |
| [319](#L319) | $c = json\_decode( $str, true ); |
| [320](#L320) | // Check if this is a valid array and settings is there |
| [321](#L321) | if ( null === $c || !is\_array( $c ) || ! isset( $c['settings'] ) ) { |
| [322](#L322) | if ( ! isset( $c['settings'] ) ) { |
| [323](#L323) | $this->a->log( \_\_('Uploaded file is not a WP BASE Settings file.','wp-base') ); |
| [324](#L324) | } else { |
| [325](#L325) | $this->a->log( \_\_('Settings json file contents are empty or corrupted.','wp-base') ); |
| [326](#L326) | } |
| [327](#L327) |  |
| [328](#L328) | add\_action( 'admin\_notices', array( $this, 'import\_error' ) ); |
| [329](#L329) | } else { |
| [330](#L330) | $fail = false; |
| [331](#L331) |  |
| [332](#L332) | include\_once( WPBASE\_PLUGIN\_DIR . '/includes/constant-data.php' ); |
| [333](#L333) |  |
| [334](#L334) | if ( isset( $\_REQUEST['import\_templates\_check'] ) && isset( $\_REQUEST['import\_templates'] ) && 'yes' == $\_REQUEST['import\_templates'] ) |
| [335](#L335) | $new\_options = array\_merge( WpBConstant::defaults(), $c['settings'] ); |
| [336](#L336) | else { |
| [337](#L337) | $old\_templates = array\_intersect\_key( wpb\_setting( ), WpBConstant::defaults( 'only\_templates' ) ); |
| [338](#L338) | $new\_options = array\_merge( $c['settings'], $old\_templates ); |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | if ( !$this->a->update\_options( $new\_options ) ) { |
| [342](#L342) | $fail = true; |
| [343](#L343) | $this->a->log( \_\_( 'Settings could not be updated. Target and destination settings may already be identical.', 'wp-base' ) ); |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | if ( isset( $\_REQUEST['import\_custom\_texts\_check'] ) && isset( $\_REQUEST['import\_custom\_texts'] ) && 'yes' == $\_REQUEST['import\_custom\_texts'] ) { |
| [347](#L347) | if ( !update\_option( 'wp\_base\_texts', $c['custom\_texts'], false ) ) { |
| [348](#L348) | $fail = true; |
| [349](#L349) | if ( empty( $c['custom\_texts'] ) ) |
| [350](#L350) | $this->a->log( \_\_( 'There are no custom texts to import.', 'wp-base' ) ); |
| [351](#L351) | else |
| [352](#L352) | $this->a->log( \_\_( 'Customs texts could not be updated. Target and destination custom texts may already be identical.', 'wp-base' ) ); |
| [353](#L353) | } |
| [354](#L354) | } |
| [355](#L355) |  |
| [356](#L356) | if ( isset( $\_REQUEST['import\_translations\_check'] ) && isset( $\_REQUEST['import\_translations'] ) && 'yes' == $\_REQUEST['import\_translations'] ) { |
| [357](#L357) | if ( !update\_option( 'wp\_base\_multilang', $c['translations'], false ) ) { |
| [358](#L358) | $fail = true; |
| [359](#L359) | if ( empty( $c['translations'] ) ) |
| [360](#L360) | $this->a->log( \_\_( 'There are no translations to import.', 'wp-base' ) ); |
| [361](#L361) | else |
| [362](#L362) | $this->a->log( \_\_( 'Translations could not be updated. Target and destination translations may already be identical.', 'wp-base' ) ); |
| [363](#L363) | } |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | if ( $fail ) { |
| [367](#L367) | add\_action( 'admin\_notices', array( $this, 'import\_error' ) ); |
| [368](#L368) | } else { |
| [369](#L369) | add\_action( 'admin\_notices', array( $this, 'import\_success' ) ); |
| [370](#L370) |  |
| [371](#L371) | wpb\_rebuild\_menu(); |
| [372](#L372) | } |
| [373](#L373) | } |
| [374](#L374) | } else { |
| [375](#L375) | add\_action( 'admin\_notices', array( $this, 'import\_error' ) ); |
| [376](#L376) | } |
| [377](#L377) |  |
| [378](#L378) | } |
| [379](#L379) |  |
| [380](#L380) | /\*\* |
| [381](#L381) | \* Save an SQL file of db records |
| [382](#L382) | \* @param save: If true, file is saved to be attached to email. If false, pdf file is sent to browser. |
| [383](#L383) | \* @since 2.0 |
| [384](#L384) | \*/ |
| [385](#L385) | function export\_db( $save = false, $exclude\_transaction = false ){ |
| [386](#L386) |  |
| [387](#L387) | update\_option( 'wp\_base\_export\_source\_url', site\_url() ); |
| [388](#L388) |  |
| [389](#L389) | $file = fopen('php://temp/maxmemory:'. WPB\_EXPORT\_PHP\_MAXMEMORY, 'r+'); |
| [390](#L390) |  |
| [391](#L391) | /\* Get business options and Widgets. These are in WP options table \*/ |
| [392](#L392) | fwrite( $file, |
| [393](#L393) | "CREATE TEMPORARY TABLE `". self::prefix() . "base\_options` ( |
| [394](#L394) | `option\_id` bigint(20) unsigned NOT null AUTO\_INCREMENT, |
| [395](#L395) | `option\_name` varchar(191) NOT null DEFAULT '', |
| [396](#L396) | `option\_value` longtext NOT null, |
| [397](#L397) | `autoload` varchar(20) NOT null DEFAULT 'yes', |
| [398](#L398) | PRIMARY KEY (`option\_id`), |
| [399](#L399) | UNIQUE KEY `option\_name` (`option\_name`) |
| [400](#L400) | ) DEFAULT CHARSET=utf8;\n |
| [401](#L401) | "); |
| [402](#L402) |  |
| [403](#L403) | $entries = 'INSERT INTO `' . self::prefix() . "base\_options" . '` VALUES ('; |
| [404](#L404) | $result = $this->a->db->get\_results("SELECT \* FROM `". self::prefix() . 'options' ."` WHERE (option\_name LIKE 'wp\_base\_%' OR option\_name LIKE 'widget\_appointments\_%') AND option\_name <> 'wp\_base\_options' ", ARRAY\_A); |
| [405](#L405) |  |
| [406](#L406) | if ( $result ) { |
| [407](#L407) | foreach ( $result as $row ) { |
| [408](#L408) | if ( $row ) { |
| [409](#L409) | $values = array(); |
| [410](#L410) | foreach ( $row as $key => $value ) { |
| [411](#L411) | if ( null === $value ) { |
| [412](#L412) | $values[] = 'null'; |
| [413](#L413) | } else { |
| [414](#L414) | $values[] = "'" . esc\_sql( $value ) . "'"; |
| [415](#L415) | } |
| [416](#L416) | } |
| [417](#L417) | fwrite( $file, $entries . implode(', ', $values) . ');'. "\n" ); |
| [418](#L418) | } |
| [419](#L419) | } |
| [420](#L420) | } |
| [421](#L421) |  |
| [422](#L422) | /\* Get user data of clients and workers and add them to the file \*/ |
| [423](#L423) | $user\_ids = array(); |
| [424](#L424) |  |
| [425](#L425) | $workers = $this->a->get\_workers(); |
| [426](#L426) |  |
| [427](#L427) | if ( $workers ) { |
| [428](#L428) | foreach ( $workers as $worker ) { |
| [429](#L429) | $user\_ids[] = $worker->ID; |
| [430](#L430) | } |
| [431](#L431) | } |
| [432](#L432) |  |
| [433](#L433) | $apps = $this->a->db->get\_results( "SELECT \* FROM ". $this->a->app\_table. " " ); |
| [434](#L434) |  |
| [435](#L435) | if ( $apps ) { |
| [436](#L436) | foreach ( $apps as $app ) { |
| [437](#L437) | if ( $app->user ) { |
| [438](#L438) | $user\_ids[] = $app->user; |
| [439](#L439) | } |
| [440](#L440) | } |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) | $user\_ids = array\_unique( array\_filter( $user\_ids ) ); |
| [444](#L444) |  |
| [445](#L445) | if ( ! empty( $user\_ids ) ) { |
| [446](#L446) | sort( $user\_ids ); |
| [447](#L447) |  |
| [448](#L448) | fwrite( $file, |
| [449](#L449) | "CREATE TEMPORARY TABLE `". self::base\_prefix() . "base\_users` ( |
| [450](#L450) | `ID` bigint(20) unsigned NOT null AUTO\_INCREMENT, |
| [451](#L451) | `user\_login` varchar(60) NOT null DEFAULT '', |
| [452](#L452) | `user\_pass` varchar(64) NOT null DEFAULT '', |
| [453](#L453) | `user\_nicename` varchar(50) NOT null DEFAULT '', |
| [454](#L454) | `user\_email` varchar(100) NOT null DEFAULT '', |
| [455](#L455) | `user\_url` varchar(100) NOT null DEFAULT '', |
| [456](#L456) | `user\_registered` datetime NOT null DEFAULT '0000-00-00 00:00:00', |
| [457](#L457) | `user\_activation\_key` varchar(60) NOT null DEFAULT '', |
| [458](#L458) | `user\_status` int(11) NOT null DEFAULT '0', |
| [459](#L459) | `display\_name` varchar(250) NOT null DEFAULT '', |
| [460](#L460) | `spam` tinyint(2) NOT null DEFAULT '0', |
| [461](#L461) | `deleted` tinyint(2) NOT null DEFAULT '0', |
| [462](#L462) | PRIMARY KEY (`ID`), |
| [463](#L463) | KEY `user\_login\_key` (`user\_login`), |
| [464](#L464) | KEY `user\_nicename` (`user\_nicename`) |
| [465](#L465) | ) DEFAULT CHARSET=utf8;\n" |
| [466](#L466) | ); |
| [467](#L467) |  |
| [468](#L468) | fwrite( $file, |
| [469](#L469) | "CREATE TEMPORARY TABLE `". self::base\_prefix() . "base\_usermeta` ( |
| [470](#L470) | `umeta\_id` bigint(20) unsigned NOT null AUTO\_INCREMENT, |
| [471](#L471) | `user\_id` bigint(20) unsigned NOT null DEFAULT '0', |
| [472](#L472) | `meta\_key` varchar(255) DEFAULT null, |
| [473](#L473) | `meta\_value` longtext, |
| [474](#L474) | PRIMARY KEY (`umeta\_id`), |
| [475](#L475) | KEY `user\_id` (`user\_id`) |
| [476](#L476) | ) DEFAULT CHARSET=utf8;\n" |
| [477](#L477) | ); |
| [478](#L478) |  |
| [479](#L479) | $entries = 'INSERT INTO `' . self::base\_prefix() . 'base\_users` VALUES ('; |
| [480](#L480) | foreach( $user\_ids as $user\_id ) { |
| [481](#L481) | $result = $this->a->db->get\_results( $this->a->db->prepare( "SELECT \* FROM `". self::base\_prefix() . "users` WHERE ID=%d", $user\_id), ARRAY\_A); |
| [482](#L482) | if ( $result ) { |
| [483](#L483) | foreach ( $result as $row ) { |
| [484](#L484) | if ( $row ) { |
| [485](#L485) | $values = array(); |
| [486](#L486) | foreach ( $row as $key => $value ) { |
| [487](#L487) | if ( null === $value ) { |
| [488](#L488) | $values[] = 'null'; |
| [489](#L489) | } else { |
| [490](#L490) | $values[] = "'" . esc\_sql($value) . "'"; |
| [491](#L491) | } |
| [492](#L492) | } |
| [493](#L493) | // Add extra multisite columns when exporting from a solo wp |
| [494](#L494) | if ( ! isset( $row['spam'] ) ) |
| [495](#L495) | $values[] = 0; |
| [496](#L496) | if ( ! isset( $row['deleted'] ) ) |
| [497](#L497) | $values[] = 0; |
| [498](#L498) |  |
| [499](#L499) | fwrite($file, $entries . implode(', ', $values) . ');'. "\n"); |
| [500](#L500) | } |
| [501](#L501) | } |
| [502](#L502) | } |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | $entries = 'INSERT INTO `' . self::base\_prefix() . 'base\_usermeta` VALUES ('; |
| [506](#L506) | foreach( $user\_ids as $user\_id ) { |
| [507](#L507) | $result = $this->a->db->get\_results($this->a->db->prepare("SELECT \* FROM `". self::base\_prefix() . "usermeta` WHERE user\_id=%d", $user\_id), ARRAY\_A); |
| [508](#L508) | if ( $result ) { |
| [509](#L509) | foreach ( $result as $row ) { |
| [510](#L510) | if ( $row ) { |
| [511](#L511) | $values = array(); |
| [512](#L512) | foreach ( $row as $key => $value ) { |
| [513](#L513) | if ( null === $value ) { |
| [514](#L514) | $values[] = 'null'; |
| [515](#L515) | } else { |
| [516](#L516) | $values[] = "'" . esc\_sql($value) . "'"; |
| [517](#L517) | } |
| [518](#L518) | } |
| [519](#L519) |  |
| [520](#L520) | fwrite($file, $entries . implode(', ', $values) . ');'. "\n"); |
| [521](#L521) | } |
| [522](#L522) | } |
| [523](#L523) | } |
| [524](#L524) | } |
| [525](#L525) | } |
| [526](#L526) |  |
| [527](#L527) | /\* Get app related posts and add them to the file \*/ |
| [528](#L528) | if ( ! isset( $\_REQUEST['exclude\_posts'] ) || 'yes' != $\_REQUEST['exclude\_posts'] ) { |
| [529](#L529) | $post\_ids = array(); |
| [530](#L530) | $posts = get\_posts( array( 'post\_type' => 'any', 'posts\_per\_page'   => 10000 ) ); |
| [531](#L531) | foreach ( $posts as $\_post ) { |
| [532](#L532) | if ( is\_object( $\_post ) && $\_post->ID && 'revision' != $\_post->post\_type |
| [533](#L533) | && 'attachment' != $\_post->post\_type && strpos( $\_post->post\_content, "[app" ) !== false ) |
| [534](#L534) | $post\_ids[] = $\_post->ID; |
| [535](#L535) | } |
| [536](#L536) |  |
| [537](#L537) | // Also get description pages |
| [538](#L538) | foreach ( array( $this->a->locations\_table, $this->a->services\_table, $this->a->workers\_table ) as $table ) { |
| [539](#L539) | $results = $this->a->db->get\_results( "SELECT page FROM $table" ); |
| [540](#L540) | if ( $results ) { |
| [541](#L541) | foreach ( $results as $r ) { |
| [542](#L542) | $post\_ids[] = $r->page; |
| [543](#L543) | } |
| [544](#L544) | } |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | // Appointment cancelled page, PayPal return page |
| [548](#L548) | $post\_ids[] = wpb\_setting("cancel\_page"); |
| [549](#L549) | $post\_ids[] = wpb\_setting("return"); |
| [550](#L550) |  |
| [551](#L551) | $post\_ids = array\_unique( array\_filter( $post\_ids ) ); |
| [552](#L552) |  |
| [553](#L553) | if ( ! empty( $post\_ids ) ) { |
| [554](#L554) | sort( $post\_ids ); |
| [555](#L555) |  |
| [556](#L556) | fwrite( $file, |
| [557](#L557) | "CREATE TEMPORARY TABLE `". self::prefix() . "base\_posts` ( |
| [558](#L558) | `ID` bigint(20) unsigned NOT null AUTO\_INCREMENT, |
| [559](#L559) | `post\_author` bigint(20) unsigned NOT null DEFAULT '0', |
| [560](#L560) | `post\_date` datetime NOT null DEFAULT '0000-00-00 00:00:00', |
| [561](#L561) | `post\_date\_gmt` datetime NOT null DEFAULT '0000-00-00 00:00:00', |
| [562](#L562) | `post\_content` longtext NOT null, |
| [563](#L563) | `post\_title` text NOT null, |
| [564](#L564) | `post\_excerpt` text NOT null, |
| [565](#L565) | `post\_status` varchar(20) NOT null DEFAULT 'publish', |
| [566](#L566) | `comment\_status` varchar(20) NOT null DEFAULT 'open', |
| [567](#L567) | `ping\_status` varchar(20) NOT null DEFAULT 'open', |
| [568](#L568) | `post\_password` varchar(20) NOT null DEFAULT '', |
| [569](#L569) | `post\_name` varchar(200) NOT null DEFAULT '', |
| [570](#L570) | `to\_ping` text NOT null, |
| [571](#L571) | `pinged` text NOT null, |
| [572](#L572) | `post\_modified` datetime NOT null DEFAULT '0000-00-00 00:00:00', |
| [573](#L573) | `post\_modified\_gmt` datetime NOT null DEFAULT '0000-00-00 00:00:00', |
| [574](#L574) | `post\_content\_filtered` longtext NOT null, |
| [575](#L575) | `post\_parent` bigint(20) unsigned NOT null DEFAULT '0', |
| [576](#L576) | `guid` varchar(255) NOT null DEFAULT '', |
| [577](#L577) | `menu\_order` int(11) NOT null DEFAULT '0', |
| [578](#L578) | `post\_type` varchar(20) NOT null DEFAULT 'post', |
| [579](#L579) | `post\_mime\_type` varchar(100) NOT null DEFAULT '', |
| [580](#L580) | `comment\_count` bigint(20) NOT null DEFAULT '0', |
| [581](#L581) | PRIMARY KEY (`ID`), |
| [582](#L582) | KEY `post\_parent` (`post\_parent`), |
| [583](#L583) | KEY `post\_author` (`post\_author`) |
| [584](#L584) | ) DEFAULT CHARSET=utf8;\n" |
| [585](#L585) | ); |
| [586](#L586) | fwrite( $file, |
| [587](#L587) | "CREATE TEMPORARY TABLE `". self::prefix() . "base\_postmeta` ( |
| [588](#L588) | `meta\_id` bigint(20) unsigned NOT null AUTO\_INCREMENT, |
| [589](#L589) | `post\_id` bigint(20) unsigned NOT null DEFAULT '0', |
| [590](#L590) | `meta\_key` varchar(255) DEFAULT null, |
| [591](#L591) | `meta\_value` longtext, |
| [592](#L592) | PRIMARY KEY (`meta\_id`), |
| [593](#L593) | KEY `post\_id` (`post\_id`) |
| [594](#L594) | ) DEFAULT CHARSET=utf8;\n" |
| [595](#L595) | ); |
| [596](#L596) |  |
| [597](#L597) | $entries = 'INSERT INTO `' . self::prefix() . 'base\_posts` VALUES ('; |
| [598](#L598) | foreach( $post\_ids as $post\_id ) { |
| [599](#L599) |  |
| [600](#L600) | $result = $this->a->db->get\_results( $this->a->db->prepare( "SELECT \* FROM `". |
| [601](#L601) | self::prefix() . "posts` WHERE ID=%d", $post\_id ), ARRAY\_A); |
| [602](#L602) |  |
| [603](#L603) | if ( $result ) { |
| [604](#L604) | foreach ( $result as $row ) { |
| [605](#L605) | if ( $row ) { |
| [606](#L606) | $values = array(); |
| [607](#L607) | foreach ( $row as $key => $value ) { |
| [608](#L608) | if ( null === $value ) { |
| [609](#L609) | $values[] = 'null'; |
| [610](#L610) | } else { |
| [611](#L611) | $values[] = "'" . esc\_sql($value) . "'"; |
| [612](#L612) | } |
| [613](#L613) | } |
| [614](#L614) | fwrite($file, $entries . implode(', ', $values) . ');'. "\n"); |
| [615](#L615) | } |
| [616](#L616) | } |
| [617](#L617) | } |
| [618](#L618) | } |
| [619](#L619) |  |
| [620](#L620) | $entries = 'INSERT INTO `' . self::prefix() . 'base\_postmeta` VALUES ('; |
| [621](#L621) | foreach( $post\_ids as $post\_id ) { |
| [622](#L622) |  |
| [623](#L623) | $result = $this->a->db->get\_results( $this->a->db->prepare( "SELECT \* FROM `". |
| [624](#L624) | self::prefix() . "postmeta` WHERE post\_id=%d", $post\_id ), ARRAY\_A); |
| [625](#L625) |  |
| [626](#L626) | if ( $result ) { |
| [627](#L627) | foreach ( $result as $row ) { |
| [628](#L628) | if ( $row ) { |
| [629](#L629) | $values = array(); |
| [630](#L630) | foreach ( $row as $key => $value ) { |
| [631](#L631) | if ( null === $value ) { |
| [632](#L632) | $values[] = 'null'; |
| [633](#L633) | } else { |
| [634](#L634) | $values[] = "'" . esc\_sql($value) . "'"; |
| [635](#L635) | } |
| [636](#L636) | } |
| [637](#L637) | fwrite($file, $entries . implode(', ', $values) . ');'. "\n"); |
| [638](#L638) | } |
| [639](#L639) | } |
| [640](#L640) | } |
| [641](#L641) | } |
| [642](#L642) | } |
| [643](#L643) | } |
| [644](#L644) |  |
| [645](#L645) | /\* Booking tables \*/ |
| [646](#L646) | // Can be excluded from support email |
| [647](#L647) | if ( isset( $\_REQUEST['exclude\_tables'] ) && 'yes' == $\_REQUEST['exclude\_tables'] ) { |
| [648](#L648) | $ex = 'short\_'; |
| [649](#L649) | } else { |
| [650](#L650) | $tables = array( |
| [651](#L651) | $this->a->app\_table, |
| [652](#L652) | $this->a->meta\_table, |
| [653](#L653) | ); |
| [654](#L654) |  |
| [655](#L655) | foreach ( $tables as $table ) { |
| [656](#L656) | $table\_data = $this->a->db->get\_results( "SELECT \* FROM `". $table ."` ", ARRAY\_A); |
| [657](#L657) |  |
| [658](#L658) | if ( $table\_data ) { |
| [659](#L659) |  |
| [660](#L660) | $chunks = array\_chunk( $table\_data, WPB\_EXPORT\_CHUNK\_SIZE ); |
| [661](#L661) |  |
| [662](#L662) | foreach ( $chunks as $chunk ) { |
| [663](#L663) | $entries = 'INSERT INTO `' . $table . '` VALUES'; |
| [664](#L664) | foreach( $chunk as $row ) { |
| [665](#L665) | $entries .= ' ('; |
| [666](#L666) |  |
| [667](#L667) | $values = array(); |
| [668](#L668) | foreach ( $row as $key => $value ) { |
| [669](#L669) | $values[] = null === $value ? 'null' : "'" . esc\_sql( $value ) . "'"; |
| [670](#L670) | } |
| [671](#L671) |  |
| [672](#L672) | $entries .= implode( ', ', $values ) .'),'; |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) | $entries = rtrim( $entries, ',' ) . ';'. "\n"; |
| [676](#L676) | fwrite( $file, $entries ); |
| [677](#L677) | } |
| [678](#L678) | } |
| [679](#L679) | } |
| [680](#L680) | } |
| [681](#L681) |  |
| [682](#L682) | /\* Rest of WP BASE tables \*/ |
| [683](#L683) | $tables = array( |
| [684](#L684) | $this->a->locations\_table, |
| [685](#L685) | $this->a->services\_table, |
| [686](#L686) | $this->a->workers\_table, |
| [687](#L687) | $this->a->wh\_w\_table, |
| [688](#L688) | $this->a->wh\_s\_table, |
| [689](#L689) | $this->a->wh\_a\_table, |
| [690](#L690) | ); |
| [691](#L691) |  |
| [692](#L692) | if ( $exclude\_transaction ) {   // Can be excluded from support email |
| [693](#L693) | $ex = 'without\_transactions\_'; |
| [694](#L694) | } else { |
| [695](#L695) | $ex = ''; |
| [696](#L696) | $tables = array\_merge( array( $this->a->transaction\_table ), $tables ); |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | $tables = apply\_filters( 'app\_export\_tables', $tables ); |
| [700](#L700) |  |
| [701](#L701) | foreach ( $tables as $table ) { |
| [702](#L702) | $table\_data = $this->a->db->get\_results("SELECT \* FROM `". $table ."` ", ARRAY\_A); |
| [703](#L703) | $entries = 'INSERT INTO `' . $table . '` VALUES ('; |
| [704](#L704) |  |
| [705](#L705) | if ( $table\_data ) { |
| [706](#L706) | foreach( $table\_data as $row ) { |
| [707](#L707) |  |
| [708](#L708) | $values = array(); |
| [709](#L709) | foreach ( $row as $key => $value ) { |
| [710](#L710) |  |
| [711](#L711) | if ( null === $value ) |
| [712](#L712) | $values[] = 'null'; |
| [713](#L713) | else |
| [714](#L714) | $values[] = "'" . esc\_sql($value) . "'"; |
| [715](#L715) | } |
| [716](#L716) | fwrite($file, $entries . implode(', ', $values) . ');'. "\n"); |
| [717](#L717) | } |
| [718](#L718) | } |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | $blog\_name = sanitize\_file\_name( get\_bloginfo( 'name' ) ); |
| [722](#L722) |  |
| [723](#L723) | $filename = "wp\_base\_data\_". $blog\_name. "\_". $ex . date('h',$this->a->\_time)."\_".date('i',$this->a->\_time)."\_".date('a',$this->a->\_time)."\_".date('F',$this->a->\_time)."\_".date('d',$this->a->\_time)."\_".date('Y',$this->a->\_time).".sql"; |
| [724](#L724) |  |
| [725](#L725) | //serve the file |
| [726](#L726) | rewind($file); |
| [727](#L727) |  |
| [728](#L728) | if ( ob\_get\_length() ) { |
| [729](#L729) | ob\_end\_clean(); |
| [730](#L730) | } |
| [731](#L731) |  |
| [732](#L732) | # Save this file to uploads folder to be used as attachment |
| [733](#L733) | if ( $save ) { |
| [734](#L734) | $output = stream\_get\_contents($file); |
| [735](#L735) | $result = file\_put\_contents( $this->a->uploads\_dir . '/' . $filename, $output ); |
| [736](#L736) | if ( $result ) { |
| [737](#L737) | return $filename; |
| [738](#L738) | } else { |
| [739](#L739) | return false; |
| [740](#L740) | } |
| [741](#L741) | } else { |
| [742](#L742) | # Or, download |
| [743](#L743) | header('Content-Description: File Transfer'); |
| [744](#L744) | header('Content-Type: application/octet-stream'); |
| [745](#L745) | header('Content-Disposition: attachment; filename="'.$filename.'"'); |
| [746](#L746) | header('Content-Transfer-Encoding: binary'); |
| [747](#L747) | header('Expires: 0'); |
| [748](#L748) | header('Cache-Control: must-revalidate, post-check=0, pre-check=0'); |
| [749](#L749) | header('Pragma: public'); |
| [750](#L750) | $output = stream\_get\_contents($file); |
| [751](#L751) | header('Content-Length: ' . strlen($output)); |
| [752](#L752) | fclose($file); |
| [753](#L753) | die($output); |
| [754](#L754) | } |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | /\*\* |
| [758](#L758) | \* Prints upload error message on top of Admin page |
| [759](#L759) | \* @since 2.0 |
| [760](#L760) | \*/ |
| [761](#L761) | function import\_error( ) { |
| [762](#L762) | echo '<div class="error"><p><b>[WP BASE]</b> '. \_\_('An error occurred during import. Check log file to see if details of the error have been recorded.','wp-base').'</p></div>'; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | /\*\* |
| [766](#L766) | \* Prints upload success message on top of Admin page |
| [767](#L767) | \* @since 2.0 |
| [768](#L768) | \*/ |
| [769](#L769) | function import\_success( ) { |
| [770](#L770) | echo '<div class="updated fade"><p><b>[WP BASE]</b> '. \_\_('Import completed successfully. Now new settings/values are in effect. To see how many records are imported, please check log file.','wp-base').'</p></div>'; |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | /\*\* |
| [774](#L774) | \* Import an SQL file of db records |
| [775](#L775) | \* @since 2.0 |
| [776](#L776) | \*/ |
| [777](#L777) | function import\_db(){ |
| [778](#L778) |  |
| [779](#L779) | wpb\_admin\_access\_check( 'manage\_tools' ); |
| [780](#L780) |  |
| [781](#L781) | if ( ! $current\_user = wp\_get\_current\_user() ) { |
| [782](#L782) | return; |
| [783](#L783) | } |
| [784](#L784) |  |
| [785](#L785) | if ( ! isset( $\_FILES["import\_db\_file"]["tmp\_name"] ) || $\_FILES["import\_db\_file"]["error"] ) { |
| [786](#L786) | add\_action( 'admin\_notices', array( $this, 'import\_error' ) ); |
| [787](#L787) | return; |
| [788](#L788) | } |
| [789](#L789) |  |
| [790](#L790) | $c = file\_get\_contents( $\_FILES["import\_db\_file"]["tmp\_name"] ); |
| [791](#L791) | if ( false === $c ) { |
| [792](#L792) | add\_action( 'admin\_notices', array( $this, 'import\_error' ) ); |
| [793](#L793) | return; |
| [794](#L794) | } |
| [795](#L795) |  |
| [796](#L796) | // Check which tables will be added |
| [797](#L797) | $tables\_find =  array( |
| [798](#L798) | "base\_users", |
| [799](#L799) | "base\_usermeta", |
| [800](#L800) | "base\_options",         // Business options and widgets |
| [801](#L801) | "base\_meta", |
| [802](#L802) | "base\_locations", |
| [803](#L803) | "base\_services", |
| [804](#L804) | "base\_workers", |
| [805](#L805) | "base\_wh\_s", |
| [806](#L806) | "base\_wh\_w", |
| [807](#L807) | "base\_wh\_a", |
| [808](#L808) | ); |
| [809](#L809) | $skip = array(); |
| [810](#L810) | if ( isset( $\_REQUEST['import\_tables\_check'] ) && isset($\_REQUEST['import\_tables']) && 'yes' == $\_REQUEST['import\_tables'] ) { |
| [811](#L811) | $tables\_find =  array\_merge ( array("base\_bookings","base\_transactions"), $tables\_find ); |
| [812](#L812) | } else { |
| [813](#L813) | $skip = array\_merge ( array("base\_bookings","base\_transactions"), $skip ); |
| [814](#L814) | } |
| [815](#L815) |  |
| [816](#L816) | if ( isset( $\_REQUEST['import\_posts\_check'] ) && isset( $\_REQUEST['import\_posts'] ) && 'yes' == $\_REQUEST['import\_posts'] ) { |
| [817](#L817) | $tables\_find =  array\_merge ( array("base\_posts","base\_postmeta"), $tables\_find ); |
| [818](#L818) | } else { |
| [819](#L819) | $skip = array\_merge ( array("base\_posts","base\_postmeta"), $skip ); |
| [820](#L820) | } |
| [821](#L821) |  |
| [822](#L822) | $tables\_find = apply\_filters( 'app\_import\_tables\_find', $tables\_find ); |
| [823](#L823) |  |
| [824](#L824) | foreach ( $tables\_find as $table\_find ) { |
| [825](#L825) | $prefix = ("base\_users" == $table\_find || "base\_usermeta" == $table\_find  ) ? self::base\_prefix() : $this->a->db->prefix; |
| [826](#L826) | $replacement = "INSERT INTO `". $prefix. $table\_find."`"; |
| [827](#L827) | $c = preg\_replace( "/INSERT INTO `(.\*?)".$table\_find."`/", $replacement, $c ); |
| [828](#L828) | $replacement2 = "CREATE TEMPORARY TABLE `". $prefix. $table\_find."`"; |
| [829](#L829) | $c = preg\_replace( "/CREATE TEMPORARY TABLE `(.\*?)".$table\_find."`/", $replacement2, $c ); |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | $error = array(); |
| [833](#L833) | $this->records\_added = $this->users\_added = $this->posts\_added = 0; |
| [834](#L834) |  |
| [835](#L835) | // Check if we have insert statements to work on |
| [836](#L836) | if ( strpos( $c, 'INSERT INTO' ) === false ) { |
| [837](#L837) | $this->a->log( \_\_('Nothing to import: Selected tables can be empty and nothing to update in WP tables.', 'wp-base' ) ); |
| [838](#L838) | add\_action( 'admin\_notices', array( $this, 'import\_error' ) ); |
| [839](#L839) | return false; |
| [840](#L840) | } |
| [841](#L841) |  |
| [842](#L842) | # Supress errors, as we are already recording them |
| [843](#L843) | $this->old\_suppress\_state = $this->a->db->suppress\_errors( true ); |
| [844](#L844) |  |
| [845](#L845) | // First Truncate existing tables |
| [846](#L846) | foreach ( $tables\_find as $table\_find ) { |
| [847](#L847) | // Dont try to truncate temporary tables |
| [848](#L848) | if ( "base\_users" == $table\_find || "base\_usermeta" == $table\_find || "base\_posts" == $table\_find || "base\_postmeta" == $table\_find || "base\_options" == $table\_find ) |
| [849](#L849) | continue; |
| [850](#L850) | // Truncate tables having base\_ in the name |
| [851](#L851) | if ( strpos( $table\_find, 'base\_' ) !== false ) { |
| [852](#L852) | $query = 'TRUNCATE ' . $this->a->db->prefix . $table\_find; |
| [853](#L853) | $result = $this->a->db->query( $query ); |
| [854](#L854) | if ( !$result ) |
| [855](#L855) | $this->add\_error( sprintf( \_\_('Error truncating table: %s', 'wp-base'), $this->a->db->prefix . $table\_find ) ); |
| [856](#L856) | } |
| [857](#L857) | } |
| [858](#L858) |  |
| [859](#L859) | // Take each query and run one by one |
| [860](#L860) | $lines = explode( ";\n", $c ); |
| [861](#L861) | $this->wh\_queries = array(); |
| [862](#L862) |  |
| [863](#L863) | wpb\_raise\_memory\_limit(); |
| [864](#L864) |  |
| [865](#L865) | $chunks = array\_chunk( $lines, WPB\_IMPORT\_CHUNK\_SIZE ); |
| [866](#L866) |  |
| [867](#L867) | foreach ( $chunks as $i => $chunk ) { |
| [868](#L868) | foreach ( $chunk as $line ) { |
| [869](#L869) | if ( !trim( $line ) ) |
| [870](#L870) | continue; |
| [871](#L871) |  |
| [872](#L872) | if ( ! empty( $skip ) ) { |
| [873](#L873) | if ( preg\_match( "/INSERT INTO `(.\*?)(".implode("|", $skip) .")`/", $line ) ) |
| [874](#L874) | continue; |
| [875](#L875) | } |
| [876](#L876) |  |
| [877](#L877) | // Only allow Insert and Create Temporary Table queries only on the selected tables |
| [878](#L878) | if ( !preg\_match( "/(INSERT INTO|CREATE TEMPORARY TABLE) `(".$this->a->db->prefix."|".self::base\_prefix().")(".implode("|", $tables\_find) .")`/", $line ) ) |
| [879](#L879) | continue; |
| [880](#L880) |  |
| [881](#L881) | // Add Wh commands to another array. We will handle them later |
| [882](#L882) | if ( preg\_match( "/INSERT INTO `".$this->a->db->prefix."(base\_wh\_w|base\_wh\_s|base\_wh\_a)`/", $line ) ) { |
| [883](#L883) | $this->wh\_queries[] = $line; |
| [884](#L884) | continue; |
| [885](#L885) | } |
| [886](#L886) |  |
| [887](#L887) | $result = $this->a->db->query($line); |
| [888](#L888) | if ( $result ) |
| [889](#L889) | ++$this->records\_added; |
| [890](#L890) | else { |
| [891](#L891) | $this->add\_error( sprintf( \_\_('Error adding database record: %1$s . Reason: %2$s', 'wp-base'), $line, $this->db\_error() ) ); |
| [892](#L892) | } |
| [893](#L893) | } |
| [894](#L894) |  |
| [895](#L895) | unset( $chunks[$i] ); |
| [896](#L896) | gc\_collect\_cycles ( ); |
| [897](#L897) | $this->a->db->flush(); |
| [898](#L898) | } |
| [899](#L899) |  |
| [900](#L900) | /\* Regenerate options from newly created temporary table \*/ |
| [901](#L901) | $this->options\_added = 0; |
| [902](#L902) | $table\_data = $this->a->db->get\_results("SELECT \* FROM `". $this->a->db->prefix . "base\_options` ", ARRAY\_A); |
| [903](#L903) | if ( $table\_data ) { |
| [904](#L904) | foreach ( $table\_data as $row ) { |
| [905](#L905) | $value = 'wp\_base\_export\_source\_url' == $row['option\_name'] ? $row['option\_value'] : $this->match\_url( $row['option\_value'] ); |
| [906](#L906) | if ( update\_option( $row['option\_name'], maybe\_unserialize( $value ) ) ) |
| [907](#L907) | ++$this->options\_added; |
| [908](#L908) | } |
| [909](#L909) | } |
| [910](#L910) |  |
| [911](#L911) | /\* Regenerate clients and workers from newly created temporary tables \*/ |
| [912](#L912) | $this->\_import\_users(); |
| [913](#L913) |  |
| [914](#L914) | /\* Find workers to be replaced and update bookings \*/ |
| [915](#L915) | $this->\_update\_workers\_in\_bookings(); |
| [916](#L916) |  |
| [917](#L917) | /\* Regenerate posts from temporary tables \*/ |
| [918](#L918) | if ( isset( $\_REQUEST['import\_posts\_check'] ) && isset( $\_REQUEST['import\_posts'] ) ) { |
| [919](#L919) | $this->\_import\_pages(); |
| [920](#L920) | } |
| [921](#L921) |  |
| [922](#L922) | /\* Now we can create Wh tables and make replacements \*/ |
| [923](#L923) | if ( ! empty( $this->wh\_queries ) ) { |
| [924](#L924) | $this->\_import\_wh(); |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | /\* Create a report \*/ |
| [928](#L928) | $common\_message = sprintf( \_\_('%1$d WP BASE records imported by user %2$s. Additionally %3$d users and %4$d WP BASE related posts are added and %5$d booking records for workers are updated.','wp-base'), |
| [929](#L929) | $this->records\_added, |
| [930](#L930) | $current\_user->display\_name ?: $current\_user->user\_login, |
| [931](#L931) | $this->users\_added, |
| [932](#L932) | $this->posts\_added, |
| [933](#L933) | $this->app\_worker\_updated |
| [934](#L934) | ); |
| [935](#L935) | if ( empty( $this->error ) ) { |
| [936](#L936) | $this->a->log( $common\_message ); |
| [937](#L937) | add\_action( 'admin\_notices', array( $this, 'import\_success' ) ); |
| [938](#L938) | } else { |
| [939](#L939) | if ( $this->records\_added ) |
| [940](#L940) | $this->a->log( $common\_message . ' '. \_\_( 'However, there were some errors. Check following lines for error details.','wp-base') ); |
| [941](#L941) |  |
| [942](#L942) | $this->a->log( implode( chr(10). chr(13), $this->error ) ); |
| [943](#L943) |  |
| [944](#L944) | if ( $this->skip\_error\_recording ) |
| [945](#L945) | $this->a->log( sprintf( \_\_('Error recording after %d errors were skipped.','wp-base'), WPB\_IMPORT\_ERROR\_RECORD\_SIZE ) ); |
| [946](#L946) |  |
| [947](#L947) | add\_action( 'admin\_notices', array( $this, 'import\_error' ) ); |
| [948](#L948) | } |
| [949](#L949) |  |
| [950](#L950) | # Check and regenerate app menu |
| [951](#L951) | wpb\_rebuild\_menu(); |
| [952](#L952) |  |
| [953](#L953) | # Revert to previous DB error state |
| [954](#L954) | $this->a->db->suppress\_errors( $this->old\_suppress\_state ); |
| [955](#L955) |  |
| [956](#L956) | do\_action( 'app\_exim\_db\_imported', $this ); |
| [957](#L957) | } |
| [958](#L958) |  |
| [959](#L959) | /\*\* |
| [960](#L960) | \* Record errors limiting to a certain size |
| [961](#L961) | \*/ |
| [962](#L962) | function add\_error( $error ) { |
| [963](#L963) | if ( !$this->skip\_error\_recording ) |
| [964](#L964) | $this->error[] = $error; |
| [965](#L965) |  |
| [966](#L966) | if ( count( $this->error ) > WPB\_IMPORT\_ERROR\_RECORD\_SIZE ) |
| [967](#L967) | $this->skip\_error\_recording = true; |
| [968](#L968) | } |
| [969](#L969) |  |
| [970](#L970) | /\*\* |
| [971](#L971) | \* Truncate long DB error messages |
| [972](#L972) | \*/ |
| [973](#L973) | function db\_error( ) { |
| [974](#L974) | return wpb\_cut( $this->a->db->last\_error, 30, true ); |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) | /\*\* |
| [978](#L978) | \* Helper to import users |
| [979](#L979) | \*/ |
| [980](#L980) | function \_import\_users(){ |
| [981](#L981) |  |
| [982](#L982) | if ( $table\_data = $this->a->db->get\_results("SELECT \* FROM `". self::base\_prefix() . "base\_users` ", ARRAY\_A) ) { |
| [983](#L983) | $data = $this->users\_to\_replace = array(); |
| [984](#L984) |  |
| [985](#L985) | foreach ( $table\_data as $row ) { |
| [986](#L986) | $old\_user\_id = $row["ID"]; |
| [987](#L987) | $new\_user\_id = 0; |
| [988](#L988) | # Try to find user by email |
| [989](#L989) | if ( !$row["user\_email"] ) { |
| [990](#L990) | $this->error[] = sprintf( \_\_('Email does not exist for user %1$s with ID %2$d', 'wp-base'), $row["user\_login"], $old\_user\_id ); |
| [991](#L991) | } else if ( $user = get\_user\_by( 'email', $row["user\_email"] ) ) { |
| [992](#L992) | if ( get\_current\_user\_id() === $user->ID ) { |
| [993](#L993) | $new\_user\_id = false; # Current user should not be imported |
| [994](#L994) | wpb\_notice( \_\_( 'As current user, your records are found in WP user database table in the source file. To prevent you being logged out, import of your data has been skipped.', 'wp-base' ) ); |
| [995](#L995) | } else { |
| [996](#L996) | $new\_user\_id = $user->ID; # Found him, no need to create a record |
| [997](#L997) | } |
| [998](#L998) | } else { |
| [999](#L999) | $entries = 'INSERT INTO `' . self::base\_prefix() . 'users` VALUES ('; |
| [1000](#L1000) | // User is not registered, so insert to wp users table |
| [1001](#L1001) | // We must check if old user ids are allowed |
| [1002](#L1002) | $max = $this->a->db->get\_var( "SELECT MAX(ID) FROM " . self::base\_prefix() . "users " ); |
| [1003](#L1003) | $values = array(); |
| [1004](#L1004) | foreach ( $row as $key => $value ) { |
| [1005](#L1005) |  |
| [1006](#L1006) | if ( !is\_multisite() && ('spam' == $key || 'deleted' == $key) ) |
| [1007](#L1007) | continue; |
| [1008](#L1008) |  |
| [1009](#L1009) | if ( 'ID' == $key && $value <= $max ) |
| [1010](#L1010) | $value = 'null'; // Let mysql server gives an id |
| [1011](#L1011) |  |
| [1012](#L1012) | if ( null === $value ) |
| [1013](#L1013) | $values[] = 'null'; |
| [1014](#L1014) | else |
| [1015](#L1015) | $values[] = "'" . esc\_sql($value) . "'"; |
| [1016](#L1016) | } |
| [1017](#L1017) | $query = $entries . implode(', ', $values) . ')'; |
| [1018](#L1018) | $result = $this->a->db->query( $query ); |
| [1019](#L1019) |  |
| [1020](#L1020) | if ( false !== $result ) |
| [1021](#L1021) | ++$this->users\_added; |
| [1022](#L1022) | else |
| [1023](#L1023) | $this->add\_error( sprintf( \_\_('Error adding user to WP users table: %1$s. Reason: %2$s', 'wp-base'), $query, $this->db\_error( ) ) ); |
| [1024](#L1024) |  |
| [1025](#L1025) | $new\_user\_id = $this->a->db->insert\_id; |
| [1026](#L1026) | } |
| [1027](#L1027) |  |
| [1028](#L1028) | if ( $new\_user\_id ) { |
| [1029](#L1029) | // Update newly added app records with new user ID |
| [1030](#L1030) | if ( $new\_user\_id != $old\_user\_id ) { |
| [1031](#L1031) | $r = $this->a->db->update( $this->a->app\_table, array( 'user'=>$new\_user\_id ), array( 'user'=>$old\_user\_id ) ); |
| [1032](#L1032) | if ( false === $r ) |
| [1033](#L1033) | $this->error[] = sprintf( \_\_('Error updating appointments table record. Reason: %s', 'wp-base'), $this->db\_error( ) ); |
| [1034](#L1034) |  |
| [1035](#L1035) | $r = null; |
| [1036](#L1036) | $old\_data = isset( $data[$new\_user\_id] ) |
| [1037](#L1037) | ? $data[$new\_user\_id] |
| [1038](#L1038) | : $this->a->db->get\_row( $this->a->db->prepare( |
| [1039](#L1039) | "SELECT \* FROM ". $this->a->workers\_table . " WHERE ID=%d", $new\_user\_id ), ARRAY\_A ); |
| [1040](#L1040) | if ( $old\_data ) { |
| [1041](#L1041) | // Save old data, so we can swap |
| [1042](#L1042) | $data[$new\_user\_id] = $old\_data; |
| [1043](#L1043) | $new\_data = isset( $data[$old\_user\_id] ) |
| [1044](#L1044) | ? $data[$old\_user\_id] |
| [1045](#L1045) | : $this->a->db->get\_row( $this->a->db->prepare( |
| [1046](#L1046) | "SELECT \* FROM ". $this->a->workers\_table . " WHERE ID=%d", $old\_user\_id ), ARRAY\_A ); |
| [1047](#L1047) | $r = $this->a->db->update( $this->a->workers\_table, $new\_data, array( 'ID'=>$new\_user\_id ) ); |
| [1048](#L1048) | } else { |
| [1049](#L1049) | $r = $this->a->db->update( $this->a->workers\_table, array( 'ID'=>$new\_user\_id ), array( 'ID'=>$old\_user\_id ) ); |
| [1050](#L1050) | } |
| [1051](#L1051) |  |
| [1052](#L1052) | if ( false === $r ) |
| [1053](#L1053) | $this->add\_error( sprintf( \_\_('Error updating worker database table record. Reason: %s', 'wp-base'), $this->db\_error( ) ) ); |
| [1054](#L1054) | else { |
| [1055](#L1055) | $meta\_data = $this->a->db->get\_results( $this->a->db->prepare( |
| [1056](#L1056) | "SELECT \* FROM `". self::base\_prefix() . "base\_usermeta` ". |
| [1057](#L1057) | " WHERE user\_id=%d", $old\_user\_id ), ARRAY\_A ); |
| [1058](#L1058) | if ( $r ) |
| [1059](#L1059) | $this->users\_to\_replace[] = $old\_user\_id .'|'. $new\_user\_id; |
| [1060](#L1060) | } |
| [1061](#L1061) | } else { |
| [1062](#L1062) | $meta\_data = $this->a->db->get\_results( $this->a->db->prepare( |
| [1063](#L1063) | "SELECT \* FROM `". self::base\_prefix() . "base\_usermeta` ". |
| [1064](#L1064) | " WHERE user\_id=%d AND meta\_key LIKE 'app\_%' ", $old\_user\_id ), ARRAY\_A ); |
| [1065](#L1065) | } |
| [1066](#L1066) |  |
| [1067](#L1067) | // Add user metas |
| [1068](#L1068) | if ( $meta\_data ) { |
| [1069](#L1069) | foreach ( $meta\_data as $meta\_row ) { |
| [1070](#L1070) | $meta\_key = $meta\_row["meta\_key"]; |
| [1071](#L1071) | $meta\_value = $this->match\_url( maybe\_unserialize( wp\_unslash( $meta\_row["meta\_value"] ) ) ); |
| [1072](#L1072) | if ( !update\_user\_meta( $new\_user\_id, $meta\_key, $meta\_value ) ) { |
| [1073](#L1073) | // Maybe meta was already there, then do not mark it as error |
| [1074](#L1074) | if ( get\_user\_meta( $new\_user\_id, $meta\_key, true ) != $meta\_value ) |
| [1075](#L1075) | $this->add\_error( sprintf( \_\_('Error adding/updating user (ID:%1$d) meta %2$s with value: %3$s', |
| [1076](#L1076) | 'wp-base'), $new\_user\_id, $meta\_key, $meta\_value  ) ); |
| [1077](#L1077) | } |
| [1078](#L1078) | } |
| [1079](#L1079) | } |
| [1080](#L1080) |  |
| [1081](#L1081) | if ( is\_multisite() ) { |
| [1082](#L1082) | $blog\_id = get\_current\_blog\_id(); |
| [1083](#L1083) | if ( !is\_user\_member\_of\_blog( $new\_user\_id, $blog\_id ) ) |
| [1084](#L1084) | add\_user\_to\_blog( $blog\_id, $new\_user\_id, 'subscriber' ); |
| [1085](#L1085) | } |
| [1086](#L1086) | } |
| [1087](#L1087) | } |
| [1088](#L1088) | } |
| [1089](#L1089) | } |
| [1090](#L1090) |  |
| [1091](#L1091) | /\*\* |
| [1092](#L1092) | \* Find workers in new bookings and replace them with with their new IDs |
| [1093](#L1093) | \*/ |
| [1094](#L1094) | function \_update\_workers\_in\_bookings() { |
| [1095](#L1095) | if ( empty( $this->users\_to\_replace ) ) { |
| [1096](#L1096) | return; |
| [1097](#L1097) | } |
| [1098](#L1098) |  |
| [1099](#L1099) | foreach ( $this->users\_to\_replace as $u) { |
| [1100](#L1100) | list( $old\_user\_id, $new\_user\_id ) = explode( '|', $u ); |
| [1101](#L1101) | if ( ! $this->a->is\_worker( $new\_user\_id ) ) { |
| [1102](#L1102) | continue; |
| [1103](#L1103) | } |
| [1104](#L1104) |  |
| [1105](#L1105) | $result = $this->a->db->update( $this->a->app\_table, array( 'worker' => $new\_user\_id ), array( 'worker' => $old\_user\_id ) ); |
| [1106](#L1106) | if ( false === $result ) { |
| [1107](#L1107) | $this->add\_error( sprintf( |
| [1108](#L1108) | \_\_('Error updating old worker %1$d with new one %2$d', 'wp-base'), |
| [1109](#L1109) | $old\_user\_id, |
| [1110](#L1110) | $new\_user\_id |
| [1111](#L1111) | ) |
| [1112](#L1112) | ); |
| [1113](#L1113) | } else { |
| [1114](#L1114) | $this->app\_worker\_updated = $this->app\_worker\_updated + $result; |
| [1115](#L1115) | } |
| [1116](#L1116) | } |
| [1117](#L1117) | } |
| [1118](#L1118) |  |
| [1119](#L1119) | /\*\* |
| [1120](#L1120) | \* Helper to import work hours |
| [1121](#L1121) | \*/ |
| [1122](#L1122) | function \_import\_wh(){ |
| [1123](#L1123) | foreach( $this->wh\_queries as $line ) { |
| [1124](#L1124) | if ( $this->a->db->query($line) ) |
| [1125](#L1125) | ++$this->records\_added; |
| [1126](#L1126) | else |
| [1127](#L1127) | $this->add\_error( sprintf( \_\_('Error adding database record: %1$s . Reason: %2$s', 'wp-base'), $line, $this->db\_error( ) ) ); |
| [1128](#L1128) | } |
| [1129](#L1129) |  |
| [1130](#L1130) | if ( ! empty( $this->users\_to\_replace ) ) { |
| [1131](#L1131) | foreach( $this->users\_to\_replace as $u ) { |
| [1132](#L1132) | list( $old\_user\_id, $new\_user\_id ) = explode( '|', $u ); |
| [1133](#L1133) | if ( !$res = BASE('WH')->replace( $old\_user\_id, $new\_user\_id, 'worker' ) ) { |
| [1134](#L1134) | # Check if this worker has already WH settings |
| [1135](#L1135) | if ( ! BASE('WH')->get( $new\_user\_id, 'worker' ) ) |
| [1136](#L1136) | $this->add\_error( sprintf( \_\_('Working hours table of service provider %1$d could not been updated. Please check if any working hours slot has been defined for this provider in the source website as user ID %2$d.', 'wp-base'), $new\_user\_id, $old\_user\_id ) ); |
| [1137](#L1137) | else |
| [1138](#L1138) | wpb\_notice( sprintf( \_\_('Check if work hours of service provider %1$d correctly transferred. His/her ID in the source website is %2$d.', 'wp-base'), $new\_user\_id, $old\_user\_id ) ); |
| [1139](#L1139) | } |
| [1140](#L1140) | } |
| [1141](#L1141) | } |
| [1142](#L1142) | } |
| [1143](#L1143) |  |
| [1144](#L1144) | /\*\* |
| [1145](#L1145) | \* Helper to import pages |
| [1146](#L1146) | \*/ |
| [1147](#L1147) | function \_import\_pages() { |
| [1148](#L1148) | if ( $table\_data = $this->a->db->get\_results("SELECT \* FROM `". $this->a->db->prefix . "base\_posts` ", ARRAY\_A ) ) { |
| [1149](#L1149) | foreach ( $table\_data as $row ) { |
| [1150](#L1150) | $old\_post\_id = $row["ID"]; |
| [1151](#L1151) | $new\_post\_id = 0; |
| [1152](#L1152) | # Check if such a post content is already there |
| [1153](#L1153) | $existing\_post = $this->a->db->get\_row('SELECT \* FROM `'. $this->a->db->prefix . 'posts` '. |
| [1154](#L1154) | 'WHERE REPLACE(REPLACE(REPLACE(REPLACE(post\_content,"\\\",""),"\"",""),"]",""),"[","") = "'.str\_replace( array('"','[',']'),'',esc\_sql( $row["post\_content"]) ). '"'. |
| [1155](#L1155) | ' AND (post\_status="publish" OR post\_status="private" OR post\_status="future" OR post\_status="pending")', ARRAY\_A); |
| [1156](#L1156) | if ( $existing\_post ) { |
| [1157](#L1157) | $new\_post\_id = $existing\_post["ID"]; |
| [1158](#L1158) | } else { |
| [1159](#L1159) | $entries = 'INSERT INTO `' . $this->a->db->prefix . 'posts` VALUES ('; |
| [1160](#L1160) | // Post is not there so insert it. |
| [1161](#L1161) | // We must check if old post id is allowed |
| [1162](#L1162) | $max = $this->a->db->get\_var( "SELECT MAX(ID) FROM " . $this->a->db->prefix . "posts " ); |
| [1163](#L1163) | $values = array(); |
| [1164](#L1164) | foreach ( $row as $key => $value ) { |
| [1165](#L1165) |  |
| [1166](#L1166) | if ( 'ID' == $key && $value <= $max ) |
| [1167](#L1167) | $value = 'null'; // Old id is not usable. Let mysql server gives an id |
| [1168](#L1168) |  |
| [1169](#L1169) | if ( null === $value ) |
| [1170](#L1170) | $values[] = 'null'; |
| [1171](#L1171) | else |
| [1172](#L1172) | $values[] = "'" . esc\_sql( $this->match\_url( $value ) ) . "'"; |
| [1173](#L1173) | } |
| [1174](#L1174) | $query = $entries . implode(', ', $values) . ')'; |
| [1175](#L1175) | $result = $this->a->db->query( $query ); |
| [1176](#L1176) |  |
| [1177](#L1177) | if ( false !== $result ) |
| [1178](#L1178) | ++$this->posts\_added; |
| [1179](#L1179) | else |
| [1180](#L1180) | $this->add\_error( sprintf( \_\_('Error adding post to WP posts table: %1$s. Reason: %2$s', 'wp-base'), $query, $this->db\_error( ) ) ); |
| [1181](#L1181) |  |
| [1182](#L1182) | $new\_post\_id = $this->a->db->insert\_id; |
| [1183](#L1183) | } |
| [1184](#L1184) |  |
| [1185](#L1185) | if ( $new\_post\_id ) { |
| [1186](#L1186) | // Update newly added app records with new post ID |
| [1187](#L1187) | if ( $new\_post\_id != $old\_post\_id ) { |
| [1188](#L1188) | foreach ( array(        $this->a->locations\_table       => 'page', |
| [1189](#L1189) | $this->a->services\_table        => 'page', |
| [1190](#L1190) | $this->a->workers\_table         => 'page' ) as $app\_table => $uw ) { |
| [1191](#L1191) | $r = $this->a->db->update( $app\_table, array( $uw => $new\_post\_id ), array( $uw => $old\_post\_id ) ); |
| [1192](#L1192) | if ( false === $r ) { |
| [1193](#L1193) | $this->add\_error( |
| [1194](#L1194) | sprintf( |
| [1195](#L1195) | \_\_('Error updating %1$s database table record. Reason: %2$s', 'wp-base'), |
| [1196](#L1196) | $app\_table, |
| [1197](#L1197) | $this->db\_error( ) |
| [1198](#L1198) | ) |
| [1199](#L1199) | ); |
| [1200](#L1200) | } |
| [1201](#L1201) | } |
| [1202](#L1202) | } |
| [1203](#L1203) |  |
| [1204](#L1204) | // Add post metas |
| [1205](#L1205) | $meta\_data = $this->a->db->get\_results( $this->a->db->prepare( |
| [1206](#L1206) | "SELECT \* FROM `". $this->a->db->prefix . "base\_postmeta` WHERE post\_id=%d", $old\_post\_id ), ARRAY\_A); |
| [1207](#L1207) | if ( $meta\_data ) { |
| [1208](#L1208) | foreach ( $meta\_data as $meta\_row ) { |
| [1209](#L1209) | $val = $this->match\_url( maybe\_unserialize( wp\_unslash( $meta\_row["meta\_value"] ) ) ); |
| [1210](#L1210) | // Note: Update\_post\_meta can also add |
| [1211](#L1211) | if ( !update\_post\_meta( $new\_post\_id, $meta\_row["meta\_key"], $val ) ) { |
| [1212](#L1212) | // Maybe meta was already there, then do not mark it as error |
| [1213](#L1213) | if ( get\_post\_meta( $new\_post\_id, $meta\_row["meta\_key"], true ) != $val ) { |
| [1214](#L1214) | $this->add\_error( |
| [1215](#L1215) | sprintf( |
| [1216](#L1216) | \_\_('Error adding postmeta for page (ID:%1$d) meta %2$s with value: %3$s','wp-base'), |
| [1217](#L1217) | $new\_post\_id, |
| [1218](#L1218) | $meta\_row["meta\_key"], |
| [1219](#L1219) | $meta\_row["meta\_value"] |
| [1220](#L1220) | ) |
| [1221](#L1221) | ); |
| [1222](#L1222) | } |
| [1223](#L1223) | } |
| [1224](#L1224) | } |
| [1225](#L1225) | } |
| [1226](#L1226) | } |
| [1227](#L1227) | } |
| [1228](#L1228) | } |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | /\*\* |
| [1232](#L1232) | \* Better addslashes for SQL queries. |
| [1233](#L1233) | \* Taken from phpMyAdmin. |
| [1234](#L1234) | \*/ |
| [1235](#L1235) | function sql\_addslashes($a\_string = '', $is\_like = false) { |
| [1236](#L1236) | if ($is\_like) $a\_string = str\_replace('\\', '\\\\\\\\', $a\_string); |
| [1237](#L1237) | else $a\_string = str\_replace('\\', '\\\\', $a\_string); |
| [1238](#L1238) | return str\_replace('\'', '\\\'', $a\_string); |
| [1239](#L1239) | } |
| [1240](#L1240) |  |
| [1241](#L1241) | /\*\* |
| [1242](#L1242) | \* Add tabs to Tools |
| [1243](#L1243) | \* @uses appointments\_tools\_tabs filter |
| [1244](#L1244) | \* @return string |
| [1245](#L1245) | \*/ |
| [1246](#L1246) | function add\_tab( $tabs ) { |
| [1247](#L1247) | $tabs['impex'] = \_\_('Export / Import', 'wp-base'); |
| [1248](#L1248) | $tabs['import\_from\_a\_plus'] = \_\_('Import from A+', 'wp-base'); |
| [1249](#L1249) | return $tabs; |
| [1250](#L1250) | } |
| [1251](#L1251) |  |
| [1252](#L1252) | /\*\* |
| [1253](#L1253) | \* Replace old (source) url with new (target) url |
| [1254](#L1254) | \* @return string |
| [1255](#L1255) | \*/ |
| [1256](#L1256) | function match\_url( $text ) { |
| [1257](#L1257) | if ( is\_string( $text ) && $source\_url = get\_option( 'wp\_base\_export\_source\_url' ) ) |
| [1258](#L1258) | return str\_replace( site\_url(), $source\_url, $text ); |
| [1259](#L1259) | else |
| [1260](#L1260) | return $text; |
| [1261](#L1261) | } |
| [1262](#L1262) |  |
| [1263](#L1263) | /\*\* |
| [1264](#L1264) | \* Adds a settings link |
| [1265](#L1265) | \*/ |
| [1266](#L1266) | public static function settings\_link( $filename ) { |
| [1267](#L1267) |  |
| [1268](#L1268) | if ( $filename ==  pathinfo(\_\_FILE\_\_, PATHINFO\_FILENAME) ) |
| [1269](#L1269) | echo ' | <a href="'.admin\_url( 'admin.php?page=app\_tools&amp;tab=impex' ).'">'. \_\_('Settings', 'wp-base' ) . '</a>'; |
| [1270](#L1270) | } |
| [1271](#L1271) |  |
| [1272](#L1272) | /\*\* |
| [1273](#L1273) | \* Create HTML for CSV export |
| [1274](#L1274) | \*/ |
| [1275](#L1275) | function export\_csv\_html( $button\_text = '', $only\_own = 0 ) { |
| [1276](#L1276) | if ( ! did\_action( 'app\_export\_addon\_loaded' ) ) { |
| [1277](#L1277) | return; |
| [1278](#L1278) | } |
| [1279](#L1279) |  |
| [1280](#L1280) | $button\_text = $button\_text ?: \_\_('Export','wp-base'); |
| [1281](#L1281) | $referer = urlencode( wp\_unslash( $\_SERVER['REQUEST\_URI'] ) ); |
| [1282](#L1282) |  |
| [1283](#L1283) | ?> |
| [1284](#L1284) | <div class="app-csv-gprnt"> |
| [1285](#L1285) | <form action="<?php echo remove\_query\_arg( 'export-failed', admin\_url('admin-ajax.php?action=app\_export&only\_own='.$only\_own ).'&referer='.$referer.'&export\_csv\_nonce='.wp\_create\_nonce('export\_csv') ); ?>" method="post"> |
| [1286](#L1286) | <input type="hidden" name="action" value="app\_export" /> |
| [1287](#L1287) | <?php |
| [1288](#L1288) | // Export column selection checkboxes |
| [1289](#L1289) | $this->a->db->get\_row( "SELECT \* FROM " .$this->a->app\_table ); |
| [1290](#L1290) |  |
| [1291](#L1291) | $cols = apply\_filters( 'app\_export\_csv\_columns', $this->a->db->get\_col\_info(), 'html' ); |
| [1292](#L1292) |  |
| [1293](#L1293) | if ( ( $key = array\_search( 'manual\_payment', $cols ) ) !== false ) { |
| [1294](#L1294) | unset( $cols[$key] ); |
| [1295](#L1295) | } |
| [1296](#L1296) |  |
| [1297](#L1297) | $col\_data = apply\_filters( 'app\_export\_csv\_column\_names', array\_combine( $cols, $cols ), 'html' ); |
| [1298](#L1298) |  |
| [1299](#L1299) | $unchecked\_arr = get\_user\_meta( get\_current\_user\_id(), 'app\_export\_unchecked\_columns', true ); // Default is checked, so we are testing unchecked |
| [1300](#L1300) |  |
| [1301](#L1301) | if ( !is\_array( $unchecked\_arr ) ) { |
| [1302](#L1302) | $unchecked\_arr = array(); |
| [1303](#L1303) | } |
| [1304](#L1304) |  |
| [1305](#L1305) | ?> |
| [1306](#L1306) | <div class="app-csv-prnt"> |
| [1307](#L1307) | <div class="app-csv-dates"> |
| [1308](#L1308) | <input type="text" class="datepicker app-date-field-entry" name="start" placeholder="<?php  \_e( 'Choose start date', 'wp-base' )?>" autocomplete="off"> |
| [1309](#L1309) | <input type="text" class="datepicker app-date-field-entry" name="end" placeholder="<?php  \_e( 'Choose end date', 'wp-base' )?>" autocomplete="off"> |
| [1310](#L1310) | <?php do\_action( 'app\_export\_csv\_html\_controls', $only\_own ); ?> |
| [1311](#L1311) | <input type="submit" id="app\_export\_csv\_button"  class="app-csv-download-btn button-secondary" value="<?php echo $button\_text ?>" title="<?php \_e('If you click this button a CSV file containing ALL appointment records &#013;will be saved on your PC. You can export this file to Excel.','wp-base') ?>" /> |
| [1312](#L1312) | </div> |
| [1313](#L1313) | <?php |
| [1314](#L1314) | foreach ( $col\_data as $col => $name ) { |
| [1315](#L1315) | if ( strpos( $col, 'sent' ) !== false ) { |
| [1316](#L1316) | continue; |
| [1317](#L1317) | } |
| [1318](#L1318) |  |
| [1319](#L1319) | if ( ! class\_exists( 'WpBShoppingCart' ) && 'parent\_id' == $col ) { |
| [1320](#L1320) | continue; |
| [1321](#L1321) | } |
| [1322](#L1322) |  |
| [1323](#L1323) | if ( ! class\_exists( 'WpBGroupBookings' ) && 'seats' == $col ) { |
| [1324](#L1324) | continue; |
| [1325](#L1325) | } |
| [1326](#L1326) |  |
| [1327](#L1327) | if ( ! class\_exists( 'WpBGCal' ) && strpos( $col, 'gcal' ) !== false ) { |
| [1328](#L1328) | continue; |
| [1329](#L1329) | } |
| [1330](#L1330) |  |
| [1331](#L1331) | if ( ! class\_exists( 'WpBUDF' ) && 'udfs' == $col ) { |
| [1332](#L1332) | continue; |
| [1333](#L1333) | } |
| [1334](#L1334) |  |
| [1335](#L1335) | if ( in\_array( $col, $unchecked\_arr ) ) { |
| [1336](#L1336) | $c = ""; |
| [1337](#L1337) | } else { |
| [1338](#L1338) | $c = ' checked="checked"'; |
| [1339](#L1339) | } |
| [1340](#L1340) |  |
| [1341](#L1341) | $name = $this->a->get\_text( $col ) ?: ucfirst( str\_replace( "\_", " ", $name ) ); |
| [1342](#L1342) | echo '<div class="app-csv-wr"><label><input class="app-no-save-alert" type="checkbox" name="app\_csv\_'.$col.'" value="1" '.$c.'/>&nbsp;' . wpb\_cut( $name, 17 ) . '</label></div>'; |
| [1343](#L1343) | } |
| [1344](#L1344) | ?> |
| [1345](#L1345) | </div> |
| [1346](#L1346) | </form> |
| [1347](#L1347) | <div style="clear:both"></div> |
| [1348](#L1348) | </div> |
| [1349](#L1349) |  |
| [1350](#L1350) | <?php |
| [1351](#L1351) | } |
| [1352](#L1352) |  |
| [1353](#L1353) | /\*\* |
| [1354](#L1354) | \* Create HTML for impex tab |
| [1355](#L1355) | \*/ |
| [1356](#L1356) | function render\_tab() { |
| [1357](#L1357) | wpb\_admin\_access\_check( 'manage\_tools' ); |
| [1358](#L1358) |  |
| [1359](#L1359) | $wp\_nonce = wp\_create\_nonce( 'update\_app\_settings' ); |
| [1360](#L1360) |  |
| [1361](#L1361) | wpb\_desc\_infobox( 'impex' ); |
| [1362](#L1362) | ?> |
| [1363](#L1363) | <div class="postbox"> |
| [1364](#L1364) | <div class="inside"> |
| [1365](#L1365) | <table> |
| [1366](#L1366) | <tr class="app\_impex"> |
| [1367](#L1367) | <td class="app-b app-5col"><?php \_e('Export Bookings in CSV Format','wp-base') ?></td> |
| [1368](#L1368) |  |
| [1369](#L1369) | <td class="app\_d"> |
| [1370](#L1370) | <?php $this->export\_csv\_html() ?> |
| [1371](#L1371) | </td> |
| [1372](#L1372) | </tr> |
| [1373](#L1373) | </table> |
| [1374](#L1374) | </div> |
| [1375](#L1375) | </div> |
| [1376](#L1376) |  |
| [1377](#L1377) | <div class="postbox"> |
| [1378](#L1378) | <div class="inside"> |
| [1379](#L1379) | <table> |
| [1380](#L1380) | <thead> |
| [1381](#L1381) | <tr> |
| [1382](#L1382) | <th style="width:20%"></th> |
| [1383](#L1383) | <th style="width:30%"><?php \_e('Export','wp-base') ?></th> |
| [1384](#L1384) | <th style="width:43%"><?php \_e('Import','wp-base') ?></th> |
| [1385](#L1385) | </tr> |
| [1386](#L1386) | </thead> |
| [1387](#L1387) | <tbody> |
| [1388](#L1388) | <tr class="app\_impex"> |
| [1389](#L1389) | <td class="app-b"><?php \_e('Settings including Custom Texts in json format','wp-base') ?></td> |
| [1390](#L1390) | <td class="app-c"> |
| [1391](#L1391) | <form action="<?php echo admin\_url('admin-ajax.php?action=app\_export\_settings'); ?>" method="post"> |
| [1392](#L1392) | <input type="hidden" name="action" value="app\_export\_settings" /> |
| [1393](#L1393) | <input type="submit" class="button-secondary" value="<?php \_e('Export Settings','wp-base') ?>" title="<?php \_e('If you click this button a json file containing your settings will be saved on your PC. Database records (locations, services, service providers, working hours) are not included.','wp-base') ?>" /> |
| [1394](#L1394) | </form> |
| [1395](#L1395) | </td> |
| [1396](#L1396) |  |
| [1397](#L1397) | <td> |
| [1398](#L1398) | <form id="import\_settings\_form" method="post" enctype="multipart/form-data"> |
| [1399](#L1399) | <input type="hidden" name="app\_nonce" value="<?php echo $wp\_nonce?>" /> |
| [1400](#L1400) | <input type="hidden" name="import\_settings" value="import\_settings" /> |
| [1401](#L1401) | <input type="hidden" name="action\_app" value="import\_settings" /> |
| [1402](#L1402) | <input type="file" name="import\_file" id="import\_file" accept=".txt,text/plain,.json"> |
| [1403](#L1403) | <input type="submit" id="import\_settings\_button" class="button-secondary" value="<?php \_e('Import Settings') ?>" title="<?php \_e('Clicking this button let you import a settings json file') ?>" /> |
| [1404](#L1404) | <br /> |
| [1405](#L1405) |  |
| [1406](#L1406) | <input type="hidden" name="import\_templates\_check" value="yes" /> |
| [1407](#L1407) | <input type="checkbox" name="import\_templates" value="yes"/>&nbsp; |
| [1408](#L1408) | <span class="description app-btm"><?php  \_e('Include email and SMS Templates', 'wp-base' ) ?></span> |
| [1409](#L1409) | <br /> |
| [1410](#L1410) |  |
| [1411](#L1411) | <input type="hidden" name="import\_custom\_texts\_check" value="yes" /> |
| [1412](#L1412) | <input type="checkbox" name="import\_custom\_texts" value="yes"/>&nbsp; |
| [1413](#L1413) | <span class="description app-btm"><?php  \_e('Include Custom Texts', 'wp-base' ) ?></span> |
| [1414](#L1414) |  |
| [1415](#L1415) | <?php do\_action( 'app\_exim\_after\_custom\_texts' ) ?> |
| [1416](#L1416) |  |
| [1417](#L1417) | </form> |
| [1418](#L1418) | </td> |
| [1419](#L1419) |  |
| [1420](#L1420) | </tr> |
| [1421](#L1421) | <tr class="app\_impex"> |
| [1422](#L1422) | <td><span class="app-b"><?php \_e('Database Records in SQL format','wp-base') ?></span>&nbsp; |
| [1423](#L1423) | <span><?php \_e('(Bookings, transactions, services, providers, working hours, UDFs, business settings, users and posts related to WP BASE)','wp-base') ?></span> |
| [1424](#L1424) | </td> |
| [1425](#L1425) | <td class="app-c"> |
| [1426](#L1426) | <form action="<?php echo admin\_url('admin-ajax.php?action=app\_export\_db'); ?>" method="post"> |
| [1427](#L1427) | <input type="hidden" name="action" value="app\_export\_db" /> |
| [1428](#L1428) | <input type="submit" id="export\_db\_button" class="button-secondary" value="<?php \_e('Export Database Tables','wp-base') ?>" title="<?php \_e('If you click this button an SQL file containing your database records (locations, services, service providers, working hours) will be saved on your PC. ','wp-base') ?>" /> |
| [1429](#L1429) | </form> |
| [1430](#L1430) | </td> |
| [1431](#L1431) |  |
| [1432](#L1432) | <td> |
| [1433](#L1433) | <form id="import\_db\_form" method="post" enctype="multipart/form-data"> |
| [1434](#L1434) | <input type="hidden" name="app\_nonce" value="<?php echo $wp\_nonce?>" /> |
| [1435](#L1435) | <input type="hidden" name="import\_db" value="import\_db" /> |
| [1436](#L1436) | <input type="hidden" name="action\_app" value="import\_db" /> |
| [1437](#L1437) | <input type="file" name="import\_db\_file" id="import\_db\_file" accept=".sql,application/octet-stream"> |
| [1438](#L1438) | <input type="submit" id="import\_db\_button" class="button-secondary" value="<?php \_e('Import Database Tables') ?>" title="<?php \_e('Clicking this button let you import a database SQL file') ?>" /> |
| [1439](#L1439) | <br /> |
| [1440](#L1440) |  |
| [1441](#L1441) | <input type="hidden" name="import\_tables\_check" value="yes" /> |
| [1442](#L1442) | <input type="checkbox" name="import\_tables" value="yes" checked="checked"/>&nbsp; |
| [1443](#L1443) | <span class="description app-btm"><?php  \_e('Include Bookings and Transactions tables', 'wp-base' ) ?></span> |
| [1444](#L1444) | <br /> |
| [1445](#L1445) | <input type="hidden" name="import\_posts\_check" value="yes" /> |
| [1446](#L1446) | <input type="checkbox" name="import\_posts" value="yes" checked="checked"/>&nbsp; |
| [1447](#L1447) | <span class="description app-btm"><?php  \_e('Include posts and postmeta tables', 'wp-base' ) ?></span> |
| [1448](#L1448) |  |
| [1449](#L1449) | </form> |
| [1450](#L1450) | </td> |
| [1451](#L1451) | </tr> |
| [1452](#L1452) | </tbody> |
| [1453](#L1453) | </table> |
| [1454](#L1454) | </div> |
| [1455](#L1455) | </div> |
| [1456](#L1456) | <?php |
| [1457](#L1457) | } |
| [1458](#L1458) |  |
| [1459](#L1459) | /\*\* |
| [1460](#L1460) | \* Create HTML for Import from A+ |
| [1461](#L1461) | \*/ |
| [1462](#L1462) | function render\_tab\_a() { |
| [1463](#L1463) | wpb\_admin\_access\_check( 'manage\_tools' ); |
| [1464](#L1464) |  |
| [1465](#L1465) | $wp\_nonce = wp\_create\_nonce( 'update\_app\_settings' ); |
| [1466](#L1466) |  |
| [1467](#L1467) | wpb\_desc\_infobox( 'import\_a\_plus' ); |
| [1468](#L1468) |  |
| [1469](#L1469) | $passed = false; |
| [1470](#L1470) | $desc = '<span class="description app-btm app-ml10 app-error">'.\_\_('You are not authorised for import.', 'wp-base' ) .'</span>'; |
| [1471](#L1471) |  |
| [1472](#L1472) | if ( current\_user\_can(WPB\_ADMIN\_CAP) ) { |
| [1473](#L1473) |  |
| [1474](#L1474) | $test\_result = wpb\_import\_from\_a\_plus( true ); |
| [1475](#L1475) |  |
| [1476](#L1476) | if ( false === $test\_result ) { |
| [1477](#L1477) | $passed = false; |
| [1478](#L1478) | $desc = '<span class="description app-btm app-ml10 app-error">'.\_\_('No A+ tables are found!', 'wp-base' ) .'</span>'; |
| [1479](#L1479) | } else if ( 4 === count( $test\_result ) ) { |
| [1480](#L1480) | $passed = true; |
| [1481](#L1481) | $desc = '<span class="description app-btm app-ml10 app-success">'. sprintf( \_\_('All required A+ tables are found: Total %1$d records in %2$d tables.', 'wp-base'), array\_sum( array\_values($test\_result)), count($test\_result)) .'</span>'; |
| [1482](#L1482) | } else { |
| [1483](#L1483) | $passed = true; |
| [1484](#L1484) | $desc = '<span class="description app-btm app-ml10 app-b">'. sprintf( \_\_('Only %1$d A+ tables of 4 are found: %2$s. There are %3$d records in total. You can still continue with import.', 'wp-base'), count( $test\_result ), implode( ', ', array\_keys($test\_result)), array\_sum( array\_values($test\_result)) ) .'</span>'; |
| [1485](#L1485) | } |
| [1486](#L1486) | } |
| [1487](#L1487) | ?> |
| [1488](#L1488) | <div class="postbox"> |
| [1489](#L1489) | <div class="inside"> |
| [1490](#L1490) | <table> |
| [1491](#L1491) | <tr> |
| [1492](#L1492) | <td> |
| [1493](#L1493) | <form id="import\_a\_plus\_form" method="post"> |
| [1494](#L1494) | <input type="hidden" name="app\_nonce" value="<?php echo $wp\_nonce?>" /> |
| [1495](#L1495) | <input type="hidden" name="import\_a\_plus" value="import\_a\_plus" /> |
| [1496](#L1496) | <input type="hidden" name="action\_app" value="import\_a\_plus" /> |
| [1497](#L1497) | <input <?php echo $passed ? '': 'disabled="disabled"'; ?> type="submit" id="import\_a\_plus\_button" class="button-secondary" value="<?php \_e('Start Import from A+') ?>" title="<?php \_e('Clicking this button let you import a settings json file') ?>" /> |
| [1498](#L1498) | <?php echo $desc ?> |
| [1499](#L1499) | </form> |
| [1500](#L1500) | <p class="description"> |
| [1501](#L1501) | <?php |
| [1502](#L1502) | $result = get\_option( 'app\_imported\_from\_a\_plus' ); |
| [1503](#L1503) | if ( ! $result ) |
| [1504](#L1504) | \_e( 'No import from A+ was commenced or finished before.', 'wp-base' ); |
| [1505](#L1505) | else { |
| [1506](#L1506) | $time = date\_i18n( $this->a->dt\_format, $result['time'] ); |
| [1507](#L1507) | printf( \_\_( 'Latest import was on %1$s resulting %2$d imported record(s) and %3$d error(s). Check log file for details.', 'wp-base' ), $time, $result['imported'], $result['error'] ); |
| [1508](#L1508) | } |
| [1509](#L1509) | ?> |
| [1510](#L1510) | </p> |
| [1511](#L1511) | </td> |
| [1512](#L1512) | </tr> |
| [1513](#L1513) | </table> |
| [1514](#L1514) | </div> |
| [1515](#L1515) | </div> |
| [1516](#L1516) | <?php |
| [1517](#L1517) | } |
| [1518](#L1518) |  |
| [1519](#L1519) | /\*\* |
| [1520](#L1520) | \* Handle Plugin/Addon mode of operation and Instantiate |
| [1521](#L1521) | \*/ |
| [1522](#L1522) | public static function serve() { |
| [1523](#L1523) | $id = substr( \_\_CLASS\_\_, 3 ); |
| [1524](#L1524) |  |
| [1525](#L1525) | if ( function\_exists( 'wpb\_addon\_run' ) ) { |
| [1526](#L1526) | wpb\_addon\_run( $id, \_\_FILE\_\_ ); |
| [1527](#L1527) | } else { |
| [1528](#L1528) | add\_action( 'app\_loaded', function() use ( $id ){wpb\_addon\_run( $id, \_\_FILE\_\_ );}); |
| [1529](#L1529) | } |
| [1530](#L1530) | } |
| [1531](#L1531) |  |
| [1532](#L1532) | } |
| [1533](#L1533) |  |
| [1534](#L1534) | WpBEXIM::serve(); |
| [1535](#L1535) | } |
| [1536](#L1536) |  |
| [1537](#L1537) | if ( ! function\_exists( 'wpb\_import\_appointments\_from\_a\_plus' ) ) : |
| [1538](#L1538) | /\*\* |
| [1539](#L1539) | \* Helper for Importer from A+ |
| [1540](#L1540) | \* This is required to reduce RAM usage, letting PHP do garbage collection |
| [1541](#L1541) | \* @return array |
| [1542](#L1542) | \* @Since 3.0 |
| [1543](#L1543) | \*/ |
| [1544](#L1544) | function wpb\_import\_appointments\_from\_a\_plus( $apps, $cols, $skip ) { |
| [1545](#L1545) |  |
| [1546](#L1546) | $meta\_table     = BASE()->meta\_table; |
| [1547](#L1547) | $app\_table      = BASE()->app\_table; |
| [1548](#L1548) | $replaced = array(); |
| [1549](#L1549) | $error = $imported = 0; |
| [1550](#L1550) |  |
| [1551](#L1551) | foreach ( $apps as $j => $app ) { |
| [1552](#L1552) | $data = array(); |
| [1553](#L1553) | foreach ( $cols as $col ) { |
| [1554](#L1554) | if ( in\_array( $col, $skip ) ) |
| [1555](#L1555) | continue; |
| [1556](#L1556) |  |
| [1557](#L1557) | if ( 'ID' == $col ) { |
| [1558](#L1558) | $data[$col] = 'null'; |
| [1559](#L1559) | } else if ( 'user' == $col ) { |
| [1560](#L1560) | if ( $app['email'] && !$app['user'] && 'yes' == BASE()->get\_options('auto\_register\_client') && $maybe\_user\_id = BASE('User')->create\_user( $app, false ) ) { |
| [1561](#L1561) | $data['user'] = $maybe\_user\_id; |
| [1562](#L1562) | $users\_created[] = $maybe\_user\_id; |
| [1563](#L1563) | } else { |
| [1564](#L1564) | $data['user'] = $app['user']; |
| [1565](#L1565) | } |
| [1566](#L1566) | } else { |
| [1567](#L1567) | $data[$col] = $app[$col]; |
| [1568](#L1568) | } |
| [1569](#L1569) | } |
| [1570](#L1570) |  |
| [1571](#L1571) | if ( BASE()->db->insert( $app\_table, $data ) ) { |
| [1572](#L1572) | $imported++; |
| [1573](#L1573) | $id = BASE()->db->insert\_id; |
| [1574](#L1574) | $old\_id = $app['ID']; |
| [1575](#L1575) | if ( $id != $old\_id ) { |
| [1576](#L1576) | $replaced[$old\_id] = $id; |
| [1577](#L1577) | $apps\_inserted[] = $id; |
| [1578](#L1578) | } |
| [1579](#L1579) |  |
| [1580](#L1580) | foreach ( $to\_meta as $col ) { |
| [1581](#L1581) | if ( empty( $app[$col] ) ) |
| [1582](#L1582) | continue; |
| [1583](#L1583) |  |
| [1584](#L1584) | if ( 'udfs' == $col ) { |
| [1585](#L1585) | $udfs = maybe\_unserialize( $app[$col] ); |
| [1586](#L1586) | if ( is\_array( $udfs ) ) { |
| [1587](#L1587) | foreach ( $udfs as $udf\_id=>$udf\_val ) { |
| [1588](#L1588) | // We make direct insert instead of wpb\_add\_app\_meta to save resources |
| [1589](#L1589) | BASE()->db->insert( $meta\_table, array( |
| [1590](#L1590) | 'object\_id' => $id, |
| [1591](#L1591) | 'meta\_type' => 'app', |
| [1592](#L1592) | 'meta\_key' => 'udf\_'.$udf\_id, |
| [1593](#L1593) | 'meta\_value' => $udf\_val |
| [1594](#L1594) | ) ); |
| [1595](#L1595) | } |
| [1596](#L1596) | } |
| [1597](#L1597) | } else if ( ! empty( $app[$col] ) ) { |
| [1598](#L1598) | BASE()->db->insert( $meta\_table, array( |
| [1599](#L1599) | 'object\_id' => $id, |
| [1600](#L1600) | 'meta\_type' => 'app', |
| [1601](#L1601) | 'meta\_key' => $col, |
| [1602](#L1602) | 'meta\_value' => $app[$col] |
| [1603](#L1603) | ) ); |
| [1604](#L1604) | } |
| [1605](#L1605) | } |
| [1606](#L1606) |  |
| [1607](#L1607) | // The rest are the new app meta |
| [1608](#L1608) | foreach ( BASE('User')->get\_fields() as $f ) { |
| [1609](#L1609) | if ( ! empty( $app[$f] ) ) { |
| [1610](#L1610) | BASE()->db->insert( $meta\_table, array( |
| [1611](#L1611) | 'object\_id' => $id, |
| [1612](#L1612) | 'meta\_type' => 'app', |
| [1613](#L1613) | 'meta\_key' => $f, |
| [1614](#L1614) | 'meta\_value' => $app[$f] |
| [1615](#L1615) | ) ); |
| [1616](#L1616) | } |
| [1617](#L1617) | } |
| [1618](#L1618) | } else { |
| [1619](#L1619) | BASE()->log( sprintf( 'Bookings table record %d cannot be imported. Reason: %s', $app['ID'], BASE()->db->last\_error ) ); |
| [1620](#L1620) | $error++; |
| [1621](#L1621) | } |
| [1622](#L1622) | unset( $apps[$j] ); |
| [1623](#L1623) | BASE()->db->flush(); |
| [1624](#L1624) | } |
| [1625](#L1625) |  |
| [1626](#L1626) | return array( 'error' => $error, 'imported' => $imported ); |
| [1627](#L1627) | } |
| [1628](#L1628) | endif; |
| [1629](#L1629) |  |
| [1630](#L1630) | if ( ! function\_exists( 'wpb\_import\_from\_a\_plus' ) ) : |
| [1631](#L1631) | /\*\* |
| [1632](#L1632) | \* Importer from A+ |
| [1633](#L1633) | \* Also imports from ApB (Previous version  of WP BASE) |
| [1634](#L1634) | \* @param $check:       Check if required A+ tables exist. |
| [1635](#L1635) | \* @return mixed        false|array |
| [1636](#L1636) | \* @Since 3.0 |
| [1637](#L1637) | \*/ |
| [1638](#L1638) | function wpb\_import\_from\_a\_plus( $check = false ) { |
| [1639](#L1639) |  |
| [1640](#L1640) | $prefix = BASE()->db->prefix; |
| [1641](#L1641) | $table1 = $app\_table\_old                        = $prefix . "app\_appointments"; |
| [1642](#L1642) | $table2 = $tr\_table\_old                         = $prefix . "app\_transactions"; |
| [1643](#L1643) | $table3 = $services\_table\_old           = $prefix . "app\_services"; |
| [1644](#L1644) | $table4 = $workers\_table\_old            = $prefix . "app\_workers"; |
| [1645](#L1645) | $table5 = $wh\_table\_old\_w                       = $prefix . "app\_wh\_w"; |
| [1646](#L1646) | $table6 = $wh\_table\_old\_s                       = $prefix . "app\_wh\_s"; |
| [1647](#L1647) | $table7 = $wh\_table\_old\_a                       = $prefix . "app\_wh\_a"; |
| [1648](#L1648) |  |
| [1649](#L1649) | if ( $check ) { |
| [1650](#L1650) | $exists = array(); |
| [1651](#L1651) | foreach ( array(1,2,3,4) as $no ) { |
| [1652](#L1652) | if ( BASE()->db->query( "SHOW TABLES LIKE '" . ${'table'.$no} ."'" ) ) { |
| [1653](#L1653) | $name = str\_replace( $prefix . "app\_", "", ${'table'.$no} ); |
| [1654](#L1654) | $exists[ $name ] = BASE()->db->get\_var( "SELECT COUNT(\*) FROM " . ${'table'.$no} ."" ); |
| [1655](#L1655) | } |
| [1656](#L1656) | } |
| [1657](#L1657) | if ( count( $exists ) ) { |
| [1658](#L1658) | return $exists; |
| [1659](#L1659) | } else { |
| [1660](#L1660) | return false; |
| [1661](#L1661) | } |
| [1662](#L1662) | } |
| [1663](#L1663) | // End of Check // |
| [1664](#L1664) |  |
| [1665](#L1665) | $exec\_limit = @ini\_get('max\_execution\_time'); |
| [1666](#L1666) | if ( $exec\_limit < 120 ) { |
| [1667](#L1667) | @ini\_set('max\_execution\_time', 120); |
| [1668](#L1668) | } |
| [1669](#L1669) |  |
| [1670](#L1670) | wpb\_raise\_memory\_limit(); |
| [1671](#L1671) |  |
| [1672](#L1672) | $app\_table                              = BASE()->app\_table; |
| [1673](#L1673) | $tr\_table                               = BASE()->transaction\_table; |
| [1674](#L1674) | $services\_table                 = BASE()->services\_table; |
| [1675](#L1675) | $workers\_table                  = BASE()->workers\_table; |
| [1676](#L1676) | $wh\_table\_w                             = BASE()->wh\_w\_table; |
| [1677](#L1677) | $wh\_table\_s                             = BASE()->wh\_s\_table; |
| [1678](#L1678) | $wh\_table\_a                             = BASE()->wh\_a\_table; |
| [1679](#L1679) | $meta\_table                             = BASE()->meta\_table; |
| [1680](#L1680) |  |
| [1681](#L1681) | // Skipped |
| [1682](#L1682) | $locations\_old\_table    = $prefix . "app\_locations"; |
| [1683](#L1683) |  |
| [1684](#L1684) | $error = $imported = 0; |
| [1685](#L1685) |  |
| [1686](#L1686) | $text = ''; |
| [1687](#L1687) |  |
| [1688](#L1688) | /\* Bookings table \*/ |
| [1689](#L1689) | $users\_created  = $apps\_inserted = $replaced = array(); |
| [1690](#L1690) | $to\_meta                = array( 'sent','sent\_worker','sent\_dp','sent\_sms','sent\_sms\_worker','note','udfs' ); |
| [1691](#L1691) | $skip                   = array\_merge( BASE('User')->get\_fields(), $to\_meta, array('additional','manual\_payment') ); |
| [1692](#L1692) | $table\_exists   = BASE()->db->query( "SHOW TABLES LIKE '" . $app\_table\_old ."'" ) ? true : false; |
| [1693](#L1693) | $apps\_all               = $table\_exists ? BASE()->db->get\_results( "SELECT \* FROM " . $app\_table\_old . " ORDER BY ID", ARRAY\_A ) : false; |
| [1694](#L1694) | $cols                   = $table\_exists ? BASE()->db->get\_col\_info() : false; |
| [1695](#L1695) |  |
| [1696](#L1696) | if ( $apps\_all ) { |
| [1697](#L1697) | $chunks = array\_chunk( $apps\_all, 20, true ); |
| [1698](#L1698) | unset( $apps\_all ); |
| [1699](#L1699) | foreach ( $chunks as $i=>$apps ) { |
| [1700](#L1700) | $res = wpb\_import\_appointments\_from\_a\_plus( $apps, $cols, $skip ); |
| [1701](#L1701) | $error = $error + $res['error']; |
| [1702](#L1702) | $imported = $imported + $res['imported']; |
| [1703](#L1703) | unset( $chunks[$i] ); |
| [1704](#L1704) | BASE()->db->flush(); |
| [1705](#L1705) | } |
| [1706](#L1706) | } |
| [1707](#L1707) |  |
| [1708](#L1708) | /\* Transactions table \*/ |
| [1709](#L1709) | $table\_exists   = BASE()->db->query( "SHOW TABLES LIKE '" . $tr\_table\_old ."'" ) ? true : false; |
| [1710](#L1710) | $trs                    = $table\_exists ? BASE()->db->get\_results( "SELECT \* FROM " . $tr\_table\_old . " ORDER BY transaction\_ID", ARRAY\_A ) : false; |
| [1711](#L1711) | $cols                   = $table\_exists ? BASE()->db->get\_col\_info() : false; |
| [1712](#L1712) |  |
| [1713](#L1713) | if ( $trs ) { |
| [1714](#L1714) | foreach ( $trs as $tr ) { |
| [1715](#L1715) | $data = array(); |
| [1716](#L1716) | $aid = $tr['transaction\_app\_ID']; |
| [1717](#L1717) | foreach ( $cols as $col ) { |
| [1718](#L1718) | $data[$col] = $tr[$col]; |
| [1719](#L1719) | if ( 'transaction\_app\_ID' == $col && isset( $replaced[$aid] ) ) |
| [1720](#L1720) | $data['app\_ID'] = $replaced[$aid]; // App ID changed, so lets update it |
| [1721](#L1721) | } |
| [1722](#L1722) | $data['transaction\_ID'] = 'null'; |
| [1723](#L1723) | if ( BASE()->db->insert( $tr\_table, $data ) ) { |
| [1724](#L1724) | $imported++; |
| [1725](#L1725) | } else { |
| [1726](#L1726) | BASE()->log( sprintf( 'Transactions table record %1$d cannot be imported. Reason: %2$s', $tr['transaction\_ID'], BASE()->db->last\_error ) ); |
| [1727](#L1727) | $error++; |
| [1728](#L1728) | } |
| [1729](#L1729) | } |
| [1730](#L1730) | } |
| [1731](#L1731) |  |
| [1732](#L1732) | /\* Locations Table - Skipping: Not existing in A+, not practically used in ApB \*/ |
| [1733](#L1733) |  |
| [1734](#L1734) | /\* Services table \*/ |
| [1735](#L1735) | $table\_exists   = BASE()->db->query( "SHOW TABLES LIKE '" . $services\_table\_old ."'" ) ? true : false; |
| [1736](#L1736) | $services               = $table\_exists ? BASE()->db->get\_results( "SELECT \* FROM " . $services\_table\_old . " ORDER BY ID", ARRAY\_A ) : ''; |
| [1737](#L1737) | $cols                   = $table\_exists ? BASE()->db->get\_col\_info() : ''; |
| [1738](#L1738) |  |
| [1739](#L1739) | if ( $services ) { |
| [1740](#L1740) | $skip = array( 'start','end','book\_start','book\_end','additional' ); |
| [1741](#L1741) | BASE()->db->query( "TRUNCATE " . $services\_table ); // Remove sample service |
| [1742](#L1742) | foreach ( $services as $service ) { |
| [1743](#L1743) | $data = array(); |
| [1744](#L1744) | foreach ( $cols as $col ) { |
| [1745](#L1745) | if ( in\_array( $col, $skip ) ) |
| [1746](#L1746) | continue; |
| [1747](#L1747) |  |
| [1748](#L1748) | $data[$col] = $service[$col]; |
| [1749](#L1749) | } |
| [1750](#L1750) |  |
| [1751](#L1751) | if ( BASE()->db->insert( $services\_table, $data ) ) { |
| [1752](#L1752) | $imported++; |
| [1753](#L1753) | $id = BASE()->db->insert\_id; |
| [1754](#L1754) | if ( ! empty( $service['additional'] ) ) { |
| [1755](#L1755) | $adds = maybe\_unserialize( $service['additional'] ); |
| [1756](#L1756) | if ( is\_array( $adds ) ) { |
| [1757](#L1757) | $limits = array(); |
| [1758](#L1758) | $limits\_def = array('weekday\_leadtime','weekend\_leadtime','holiday\_leadtime','weekday\_upper','weekend\_upper','holiday\_upper', |
| [1759](#L1759) | 'weekday\_edittime','weekend\_edittime','holiday\_edittime','weekday\_canceltime','weekend\_canceltime','holiday\_canceltime',); |
| [1760](#L1760) | foreach ( $adds as $meta\_key => $meta\_value ) { |
| [1761](#L1761) | if ( ! empty( $meta\_value ) ) { |
| [1762](#L1762) | if ( 'additional' == $meta\_key ) |
| [1763](#L1763) | continue; |
| [1764](#L1764) |  |
| [1765](#L1765) | if ( in\_array( $meta\_key, $limits\_def ) ) |
| [1766](#L1766) | $limits[$meta\_key] = $meta\_value; |
| [1767](#L1767) | else |
| [1768](#L1768) | wpb\_add\_service\_meta( $id, $meta\_key, $meta\_value ); // e.g. quotas |
| [1769](#L1769) | } |
| [1770](#L1770) | } |
| [1771](#L1771) |  |
| [1772](#L1772) | if ( ! empty( $limits ) ) |
| [1773](#L1773) | wpb\_add\_service\_meta( $id, 'limits', $limits ); |
| [1774](#L1774) | } |
| [1775](#L1775) | } |
| [1776](#L1776) | } else { |
| [1777](#L1777) | BASE()->log( sprintf( 'Services table record for Service %1$d cannot be imported. Reason: %2$s', $service['ID'], BASE()->db->last\_error ) ); |
| [1778](#L1778) | $error++; |
| [1779](#L1779) | } |
| [1780](#L1780) | } |
| [1781](#L1781) | } |
| [1782](#L1782) |  |
| [1783](#L1783) | /\* Workers table \*/ |
| [1784](#L1784) | $table\_exists   = BASE()->db->query( "SHOW TABLES LIKE '" . $workers\_table\_old ."'" ) ? true : false; |
| [1785](#L1785) | $workers                = $table\_exists ? BASE()->db->get\_results( "SELECT \* FROM " . $workers\_table\_old . " ORDER BY ID", ARRAY\_A ) : ''; |
| [1786](#L1786) | $cols                   = $table\_exists ? BASE()->db->get\_col\_info() : ''; |
| [1787](#L1787) |  |
| [1788](#L1788) | if ( $workers ) { |
| [1789](#L1789) | foreach ( $workers as $worker ) { |
| [1790](#L1790) | $data = array(); |
| [1791](#L1791) | foreach ( $cols as $col ) { |
| [1792](#L1792) | if ( 'additional' == $col ) |
| [1793](#L1793) | continue; |
| [1794](#L1794) |  |
| [1795](#L1795) | $data[$col] = $worker[$col]; |
| [1796](#L1796) | } |
| [1797](#L1797) |  |
| [1798](#L1798) | if ( false !== BASE()->db->replace( $workers\_table, $data ) ) { |
| [1799](#L1799) | $imported++; |
| [1800](#L1800) | } else { |
| [1801](#L1801) | BASE()->log( sprintf( 'Service providers table record for worker %1$d cannot be replaced. Reason: %2$s', $worker['ID'], BASE()->db->last\_error ) ); |
| [1802](#L1802) | $error++; |
| [1803](#L1803) | } |
| [1804](#L1804) | } |
| [1805](#L1805) | } |
| [1806](#L1806) |  |
| [1807](#L1807) | /\* Wh tables - Not for A+. Only for ApB \*/ |
| [1808](#L1808) | $app\_db\_version = get\_option( 'app\_db\_version' ); |
| [1809](#L1809) | if ( version\_compare( $app\_db\_version, '2.0', '>=' ) && version\_compare( get\_option( 'wp\_base\_db\_version' ), '3100', '<=' ) ) { |
| [1810](#L1810) |  |
| [1811](#L1811) | foreach ( array('w','s','a') as $t ) { |
| [1812](#L1812) | $table                  = ${'wh\_table\_'.$t}; |
| [1813](#L1813) | $old\_table              = ${'wh\_table\_old\_'.$t}; |
| [1814](#L1814) | $table\_exists   = BASE()->db->query( "SHOW TABLES LIKE '" . $old\_table ."'" ) ? true : false; |
| [1815](#L1815) | $results                = $table\_exists ? BASE()->db->get\_results( "SELECT \* FROM " . $old\_table, ARRAY\_A ) : false; |
| [1816](#L1816) |  |
| [1817](#L1817) | if ( $results ) { |
| [1818](#L1818) | foreach ( $results as $result ) { |
| [1819](#L1819) | if( BASE()->db->replace( $table, $result ) ) { |
| [1820](#L1820) | $imported++; |
| [1821](#L1821) | } else { |
| [1822](#L1822) | BASE()->log( sprintf( 'Working hours table %1$s record %2$d cannot be imported. Reason: %3$s', $old\_table, $result['ID'], BASE()->db->last\_error ) ); |
| [1823](#L1823) | $error++; |
| [1824](#L1824) | } |
| [1825](#L1825) | } |
| [1826](#L1826) | } |
| [1827](#L1827) | } |
| [1828](#L1828) |  |
| [1829](#L1829) | /\* Copy business options, udfs and custom\_texts |
| [1830](#L1830) | \* Widgets are not copied - Nothing remarkable in A+ |
| [1831](#L1831) | \*/ |
| [1832](#L1832) | $app\_pre = 'appointments\_'; |
| [1833](#L1833) | $wpb\_pre = 'wp\_base\_'; |
| [1834](#L1834) | foreach ( array( 'business\_options', 'udfs', 'texts' ) as $option ) { |
| [1835](#L1835) | if ( $app\_option = get\_option( $app\_pre . $option ) ) { |
| [1836](#L1836) | if ( !get\_option( $wpb\_pre . $option ) ) { |
| [1837](#L1837) | if ( update\_option( $wpb\_pre . $option, $app\_option ) ) { |
| [1838](#L1838) | $text .= sprintf( \_\_( '%s have been imported.', 'wp-base' ), ucwords( str\_replace( '\_',' ', $app\_pre.$option ) ) ) .' '; |
| [1839](#L1839) | } |
| [1840](#L1840) | } |
| [1841](#L1841) | } |
| [1842](#L1842) | } |
| [1843](#L1843) | } |
| [1844](#L1844) |  |
| [1845](#L1845) | /\* Settings \*/ |
| [1846](#L1846) | $updated\_ops = 0; |
| [1847](#L1847) | if ( $app\_settings = get\_option( 'appointments\_options' ) ) { |
| [1848](#L1848) | if ( is\_array( $app\_settings ) ) { |
| [1849](#L1849) |  |
| [1850](#L1850) | if ( !$options = get\_option( 'wp\_base\_options' ) ) { |
| [1851](#L1851) | add\_option( 'wp\_base\_options', WpBConstant::defaults() ); |
| [1852](#L1852) | $options = WpBConstant::defaults(); |
| [1853](#L1853) | } |
| [1854](#L1854) |  |
| [1855](#L1855) | foreach ( $app\_settings as $k => $aset ) { |
| [1856](#L1856) | if ( isset( $options[$k] ) ) { |
| [1857](#L1857) | $options[$k] = $app\_settings[$k]; |
| [1858](#L1858) | $updated\_ops++; |
| [1859](#L1859) | } |
| [1860](#L1860) | } |
| [1861](#L1861) | if ( !update\_option( 'wp\_base\_options', $options ) ) |
| [1862](#L1862) | $updated\_ops = 0; |
| [1863](#L1863) | } |
| [1864](#L1864) | } |
| [1865](#L1865) |  |
| [1866](#L1866) | if ( $imported ) |
| [1867](#L1867) | $text .= sprintf( \_\_( '%d records have been imported.', 'wp-base' ), $imported ); |
| [1868](#L1868) | else |
| [1869](#L1869) | $text .= \_\_( 'No records have been imported.', 'wp-base' ); |
| [1870](#L1870) |  |
| [1871](#L1871) | $text .= ' '; |
| [1872](#L1872) | if ( $updated\_ops ) |
| [1873](#L1873) | $text .= sprintf( \_\_( '%d settings have been updated.', 'wp-base' ), $updated\_ops ); |
| [1874](#L1874) | else |
| [1875](#L1875) | $text .= \_\_( 'No settings have been updated.', 'wp-base' ); |
| [1876](#L1876) |  |
| [1877](#L1877) | if ( ! empty( $created\_users ) ) { |
| [1878](#L1878) | $names = ''; |
| [1879](#L1879) | $text .= ' '; |
| [1880](#L1880) | foreach ( $created\_users as $u ) { |
| [1881](#L1881) | $names .= '<a href="'. admin\_url("user-edit.php?user\_id="). $u . '" target="\_blank" title="ID:'.$u.'">'. BASE('User')->get\_name($u) . '</a>, '; |
| [1882](#L1882) | } |
| [1883](#L1883) | $names = rtrim( $names, ', ' ); |
| [1884](#L1884) | $text .= sprintf( \_\_( 'Following %1$d users are created: %2$s', 'wp-base' ), count( explode(',', $names) ), $names ); |
| [1885](#L1885) | } |
| [1886](#L1886) |  |
| [1887](#L1887) | if ( $imported || $updated\_ops || ! empty( $created\_users ) ) |
| [1888](#L1888) | BASE()->log( $text ); |
| [1889](#L1889) |  |
| [1890](#L1890) | if ( $error ) |
| [1891](#L1891) | $text .= ' '. \_\_( 'There were some errors during import. Check log file for details of the errors.', 'wp-base' ); |
| [1892](#L1892) |  |
| [1893](#L1893) | wpb\_notice( $text ); |
| [1894](#L1894) |  |
| [1895](#L1895) | if ( !$imported ) { |
| [1896](#L1896) | return false; |
| [1897](#L1897) | } else { |
| [1898](#L1898) | wpb\_rebuild\_menu(); |
| [1899](#L1899) | return array( 'time' => intval(current\_time('timestamp')), 'imported' => $imported, 'error' => $error ); |
| [1900](#L1900) | } |
| [1901](#L1901) | } |
| [1902](#L1902) |  |
| [1903](#L1903) | endif; |
| [1904](#L1904) |  |
| [1905](#L1905) | /\*\* |
| [1906](#L1906) | \* Suggest A+ Import |
| [1907](#L1907) | \* @return bool |
| [1908](#L1908) | \* @since 2.0 |
| [1909](#L1909) | \*/ |
| [1910](#L1910) | if ( !function\_exists( '\_wpb\_suggest\_a\_plus\_import' ) ) { |
| [1911](#L1911) | function \_wpb\_suggest\_a\_plus\_import() { |
| [1912](#L1912) | if ( ( function\_exists('is\_network\_admin') && is\_network\_admin() ) || isset( $\_GET['activate-multi'] ) || wpb\_is\_mobile() ) |
| [1913](#L1913) | return; |
| [1914](#L1914) |  |
| [1915](#L1915) | echo '<div class="updated"><p>' . |
| [1916](#L1916) | sprintf( \_\_('<b>[WP BASE]</b> It looks like you are already using Appointments+ or Appointments Lite. You can %s your existing data.', 'wp-base'), '<a href="'.admin\_url('admin.php?page=app\_tools&tab=import\_from\_a\_plus').'" title="'.\_\_('Click to access Import page','wp-base').'">'. \_\_('import','wp-base').'</a>') . |
| [1917](#L1917) | '</p></div>'; |
| [1918](#L1918) | } |
| [1919](#L1919) | } |
| [1920](#L1920) |  |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?format=txt)
* [Original Format](/export/3222508/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_f8f42c04_20250114_231107.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3210164%2Fwp-base-booking-of-appointments-services-and-events%2Ftags%2F5.0.0%2Fincludes%2Ffreeons%2Fexport-import.php%3Fold%3D3207827%26old_path%3Dwp-base-booking-of-appointments-services-and-events%252Ftags%252F4.9.2%252Fincludes%252Ffreeons%252Fexport-import.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3207827/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?old=3210164&old_path=%2Fwp-base-booking-of-appointments-services-and-events%2Ftags%2F5.0.0%2Fincludes%2Ffreeons%2Fexport-import.php)

---

# Changes from [wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827 "Show entry in browser") at [r3207827](/changeset/3207827 "Show full changeset") to [wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164 "Show entry in browser") at [r3210164](/changeset/3210164 "Show full changeset")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164 "Show entry in browser")
  (modified)
  ([11 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php](/changeset/3210164/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?old=3207827&old_path=wp-base-booking-of-appointments-services-and-events%2Ftags%2F4.9.2%2Fincludes%2Ffreeons%2Fexport-import.php "Show the [3207827:3210164] differences restricted to wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php")

  | [r3207827](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L7 "Show revision 3207827 of this file in browser") | [r3210164](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L7 "Show revision 3210164 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | \* Category: Free |
  | 8 | 8 | \* Author: Hakan Ozevin |
  | 9 |  | \* Version: 4.0.~~1~~ |
  |  | 9 | \* Version: 4.0.2 |
  | 10 | 10 | \* WPB requires: 4.0.0 |
  | 11 | 11 | \* |
  | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L69) | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L69) |  |
  | 69 | 69 | do\_action( 'app\_export\_addon\_loaded' ); |
  | 70 | 70 | } |
  | 71 |  |  |
  |  | 71 |  |
  | 72 | 72 | public static function prefix(){ |
  | 73 | 73 | return BASE()->db->prefix; |
  | 74 | 74 | } |
  | 75 |  |  |
  |  | 75 |  |
  | 76 | 76 | public static function base\_prefix(){ |
  | 77 | 77 | return BASE()->db->base\_prefix; |
  | 78 |  | } |
  |  | 78 | } |
  | 79 | 79 |  |
  | 80 | 80 | /\*\* |
  | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L134) | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L134) |  |
  | 134 | 134 | $end        = ! empty( $\_POST['end'] ) ? date( 'Y-m-d H:i:s', strtotime( $\_POST['end'] ) ) : '2040-01-01'; |
  | 135 | 135 | $only\_own\_q = apply\_filters( 'app\_export\_csv\_query', (! empty( $\_GET['only\_own'] ) ? $this->a->db->prepare( 'worker=%d', get\_current\_user\_id() ) : '1=1') ); |
  | 136 |  | $referer    = ! empty( $\_GET['referer'] ) ? ~~urldecode( $\_GET['referer']~~ ) : admin\_url( 'admin.php?page=app\_tools' ); |
  |  | 136 | $referer    = ! empty( $\_GET['referer'] ) ? sanitize\_url( urldecode( $\_GET['referer'] ) ) : admin\_url( 'admin.php?page=app\_tools' ); |
  | 137 | 137 |  |
  | 138 | 138 | $apps = $this->a->db->get\_results( $this->a->db->prepare( |
  | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L257) | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L257) |  |
  | 257 | 257 | /\*\* |
  | 258 | 258 | \* Save a txt file of settings |
  | 259 |  | \* @param ~~save: If true, file is saved to be attached to email. If false, pdf~~ file is sent to browser. |
  |  | 259 | \* @param $return   bool    If true, file is returned to be attached to email. If false, file is sent to browser. |
  | 260 | 260 | \* @since 2.0 |
  | 261 | 261 | \*/ |
  | 262 |  | function export\_settings( $save = false ){ |
  |  | 262 | public function export\_settings( $return = false ){ |
  |  | 263 |  |
  |  | 264 | if ( ! apply\_filters( 'app\_exim\_skip\_nonce\_check', false ) ) { |
  |  | 265 |  |
  |  | 266 | if ( empty( $\_POST['app\_export\_settings\_nonce'] ) ) { |
  |  | 267 | return; |
  |  | 268 | } |
  |  | 269 |  |
  |  | 270 | if ( ! wp\_verify\_nonce( $\_POST['app\_export\_settings\_nonce'], 'export-settings' ) ) { |
  |  | 271 | wp\_die( \_\_('You do not have sufficient permissions to access this page.','wp-base'), \_\_('Unauthorised','wp-base'), array( 'back\_link' => true ) ); |
  |  | 272 | } |
  |  | 273 | } |
  |  | 274 |  |
  |  | 275 | wpb\_admin\_access\_check( 'manage\_tools' ); |
  | 263 | 276 |  |
  | 264 | 277 | $file = fopen('php://temp/maxmemory:'. WPB\_EXPORT\_PHP\_MAXMEMORY, 'r+'); |
  | 265 | 278 |  |
  | 266 | 279 | fwrite( $file, wp\_json\_encode( |
  | 267 |  | array( |
  | 268 |  | 'settings'              => get\_option( 'wp\_base\_options' ), |
  | 269 |  | 'custom\_texts'          => get\_option( 'wp\_base\_texts' ), |
  | 270 |  | 'translations'          => get\_option( 'wp\_base\_multilang' ), |
  | 271 |  | ) |
  |  | 280 | array( |
  |  | 281 | 'settings'      => get\_option( 'wp\_base\_options' ), |
  |  | 282 | 'custom\_texts'  => get\_option( 'wp\_base\_texts' ), |
  |  | 283 | 'translations'  => get\_option( 'wp\_base\_multilang' ), |
  | 272 | 284 | ) |
  |  | 285 | ) |
  | 273 | 286 | ); |
  | 274 | 287 |  |
  | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L283) | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L296) |  |
  | 283 | 296 |  |
  | 284 | 297 | // Save this file to uploads folder to be used as attachment |
  | 285 |  | if ( $~~save~~ ) { |
  |  | 298 | if ( $return ) { |
  | 286 | 299 | $output = stream\_get\_contents($file); |
  | 287 | 300 | $result = file\_put\_contents( $this->a->uploads\_dir . '/' . $filename, $output ); |
  | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L380) | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L393) |  |
  | 380 | 393 | /\*\* |
  | 381 | 394 | \* Save an SQL file of db records |
  | 382 |  | \* @param ~~save: If true, file is saved to be attached to email. If false, pdf~~ file is sent to browser. |
  |  | 395 | \* @param $return   bool    If true, file is returned to be attached to email. If false, file is sent to browser. |
  | 383 | 396 | \* @since 2.0 |
  | 384 | 397 | \*/ |
  | 385 |  | function export\_db( $save = false, $exclude\_transaction = false ){ |
  |  | 398 | public function export\_db( $return = false, $exclude\_transaction = false ){ |
  |  | 399 |  |
  |  | 400 | if ( ! apply\_filters( 'app\_exim\_skip\_nonce\_check', false ) ) { |
  |  | 401 |  |
  |  | 402 | if ( empty( $\_POST['app\_export\_db\_nonce'] ) ) { |
  |  | 403 | return; |
  |  | 404 | } |
  |  | 405 |  |
  |  | 406 | if ( ! wp\_verify\_nonce( $\_POST['app\_export\_db\_nonce'], 'export-db' ) ) { |
  |  | 407 | wp\_die( \_\_('You do not have sufficient permissions to access this page.','wp-base'), \_\_('Unauthorised','wp-base'), array( 'back\_link' => true ) ); |
  |  | 408 | } |
  |  | 409 | } |
  |  | 410 |  |
  |  | 411 | wpb\_admin\_access\_check( 'manage\_tools' ); |
  | 386 | 412 |  |
  | 387 | 413 | update\_option( 'wp\_base\_export\_source\_url', site\_url() ); |
  | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L731) | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L757) |  |
  | 731 | 757 |  |
  | 732 | 758 | # Save this file to uploads folder to be used as attachment |
  | 733 |  | if ( $~~save~~ ) { |
  |  | 759 | if ( $return ) { |
  | 734 | 760 | $output = stream\_get\_contents($file); |
  | 735 | 761 | $result = file\_put\_contents( $this->a->uploads\_dir . '/' . $filename, $output ); |
  | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L1066) | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L1092) |  |
  | 1066 | 1092 |  |
  | 1067 | 1093 | // Add user metas |
  | 1068 |  | if ( ~~$meta\_data~~ ) { |
  |  | 1094 | if ( ! empty( $meta\_data ) ) { |
  | 1069 | 1095 | foreach ( $meta\_data as $meta\_row ) { |
  | 1070 | 1096 | $meta\_key = $meta\_row["meta\_key"]; |
  | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L1316) | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L1342) |  |
  | 1316 | 1342 | continue; |
  | 1317 | 1343 | } |
  | 1318 |  |  |
  |  | 1344 |  |
  | 1319 | 1345 | if ( ! class\_exists( 'WpBShoppingCart' ) && 'parent\_id' == $col ) { |
  | 1320 | 1346 | continue; |
  | 1321 | 1347 | } |
  | 1322 |  |  |
  |  | 1348 |  |
  | 1323 | 1349 | if ( ! class\_exists( 'WpBGroupBookings' ) && 'seats' == $col ) { |
  | 1324 | 1350 | continue; |
  | 1325 | 1351 | } |
  | 1326 |  |  |
  |  | 1352 |  |
  | 1327 | 1353 | if ( ! class\_exists( 'WpBGCal' ) && strpos( $col, 'gcal' ) !== false ) { |
  | 1328 | 1354 | continue; |
  | 1329 | 1355 | } |
  | 1330 |  |  |
  |  | 1356 |  |
  | 1331 | 1357 | if ( ! class\_exists( 'WpBUDF' ) && 'udfs' == $col ) { |
  | 1332 | 1358 | continue; |
  | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L1391) | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L1417) |  |
  | 1391 | 1417 | <form action="<?php echo admin\_url('admin-ajax.php?action=app\_export\_settings'); ?>" method="post"> |
  | 1392 | 1418 | <input type="hidden" name="action" value="app\_export\_settings" /> |
  |  | 1419 | <input type="hidden" name="app\_export\_settings\_nonce" value="<?php echo wp\_create\_nonce( 'export-settings' ) ?>" /> |
  | 1393 | 1420 | <input type="submit" class="button-secondary" value="<?php \_e('Export Settings','wp-base') ?>" title="<?php \_e('If you click this button a json file containing your settings will be saved on your PC. Database records (locations, services, service providers, working hours) are not included.','wp-base') ?>" /> |
  | 1394 | 1421 | </form> |
  | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/4.9.2/includes/freeons/export-import.php?rev=3207827#L1426) | […](/browser/wp-base-booking-of-appointments-services-and-events/tags/5.0.0/includes/freeons/export-import.php?rev=3210164#L1453) |  |
  | 1426 | 1453 | <form action="<?php echo admin\_url('admin-ajax.php?action=app\_export\_db'); ?>" method="post"> |
  | 1427 | 1454 | <input type="hidden" name="action" value="app\_export\_db" /> |
  |  | 1455 | <input type="hidden" name="app\_export\_db\_nonce" value="<?php echo wp\_create\_nonce( 'export-db' ) ?>" /> |
  | 1428 | 1456 | <input type="submit" id="export\_db\_button" class="button-secondary" value="<?php \_e('Export Database Tables','wp-base') ?>" title="<?php \_e('If you click this button an SQL file containing your database records (locations, services, service providers, working hours) will be saved on your PC. ','wp-base') ?>" /> |
  | 1429 | 1457 | </form> |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3210164&old=3207827&new_path=%2Fwp-base-booking-of-appointments-services-and-events%2Ftags%2F5.0.0%2Fincludes%2Ffreeons%2Fexport-import.php&old_path=%2Fwp-base-booking-of-appointments-services-and-events%2Ftags%2F4.9.2%2Fincludes%2Ffreeons%2Fexport-import.php)
* [Zip Archive](?format=zip&new=3210164&old=3207827&new_path=%2Fwp-base-booking-of-appointments-services-and-events%2Ftags%2F5.0.0%2Fincludes%2Ffreeons%2Fexport-import.php&old_path=%2Fwp-base-booking-of-appointments-services-and-events%2Ftags%2F4.9.2%2Fincludes%2Ffreeons%2Fexport-import.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


