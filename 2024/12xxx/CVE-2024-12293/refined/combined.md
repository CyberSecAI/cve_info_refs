=== Content from plugins.trac.wordpress.org_192e2cb9_20250114_203953.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fuser-role-editor%2Ftrunk%2Fincludes%2Fclasses%2Fgrant-roles.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/user-role-editor/trunk/includes/classes/grant-roles.php?rev=3201795 "Revision 3201795")
* Next Revision →
* [Blame](/browser/user-role-editor/trunk/includes/classes/grant-roles.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/user-role-editor/trunk/includes/classes/grant-roles.php)

---

# [source:](/browser?order=name "Go to repository root") [user-role-editor](/browser/user-role-editor?order=name "View user-role-editor")/[trunk](/browser/user-role-editor/trunk?order=name "View trunk")/[includes](/browser/user-role-editor/trunk/includes?order=name "View includes")/[classes](/browser/user-role-editor/trunk/includes/classes?order=name "View classes")/[grant-roles.php](/browser/user-role-editor/trunk/includes/classes/grant-roles.php?order=name "View grant-roles.php")

View diff against:

View revision:

| [Last change](/changeset/3208188/user-role-editor/trunk/includes/classes/grant-roles.php "View differences") on this file was [3208188](/changeset/3208188/ "View changeset 3208188"), checked in by shinephp, [4 weeks ago](/timeline?from=2024-12-15T13%3A30%3A35Z&precision=second "See timeline at 12/15/2024 01:30:35 PM") |
| --- |
| * Security Fix: Users - "Add Role", "Revoke Role" buttons: Cross-Site request forgery to privilege escalation was possible due to missed nonce validation. This issue was discovered and responsibly reported by vgo0. |
| **File size:** 19.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Project: User Role Editor plugin |
| [4](#L4) | \* Author: Vladimir Garagulya |
| [5](#L5) | \* Author email: support@role-editor.com |
| [6](#L6) | \* Author URI: https://www.role-editor.com |
| [7](#L7) | \* License: GPL v2+ |
| [8](#L8) | \* |
| [9](#L9) | \* Assign multiple roles to the list of selected users directly from the "Users" page |
| [10](#L10) | \* Grant/Revoke single role to/from selected users |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | class URE\_Grant\_Roles { |
| [14](#L14) |  |
| [15](#L15) | const NO\_ROLE\_FOR\_THIS\_SITE = 'no-role-for-this-site'; |
| [16](#L16) |  |
| [17](#L17) | private $lib = null; |
| [18](#L18) | private static $counter = 0; |
| [19](#L19) |  |
| [20](#L20) |  |
| [21](#L21) | public function \_\_construct() { |
| [22](#L22) |  |
| [23](#L23) | $this->lib = URE\_Lib::get\_instance(); |
| [24](#L24) |  |
| [25](#L25) | add\_action( 'load-users.php', array( $this, 'load' ) ); |
| [26](#L26) |  |
| [27](#L27) | } |
| [28](#L28) | // end of \_\_construct() |
| [29](#L29) |  |
| [30](#L30) |  |
| [31](#L31) | public function load() { |
| [32](#L32) |  |
| [33](#L33) | add\_action('restrict\_manage\_users', array($this, 'show\_roles\_manage\_html') ); |
| [34](#L34) | add\_action('admin\_head', array(User\_Role\_Editor::get\_instance(), 'add\_css\_to\_users\_page') ); |
| [35](#L35) | add\_action('admin\_enqueue\_scripts', array($this, 'load\_js') ); |
| [36](#L36) |  |
| [37](#L37) | } |
| [38](#L38) | // end of load() |
| [39](#L39) |  |
| [40](#L40) |  |
| [41](#L41) | private static function validate\_users($users) { |
| [42](#L42) |  |
| [43](#L43) | if (!is\_array($users)) { |
| [44](#L44) | return false; |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | foreach ($users as $user\_id) { |
| [48](#L48) | if (!is\_numeric($user\_id)) { |
| [49](#L49) | return false; |
| [50](#L50) | } |
| [51](#L51) | if ( !current\_user\_can( 'promote\_user', $user\_id ) ) { |
| [52](#L52) | return false; |
| [53](#L53) | } |
| [54](#L54) |  |
| [55](#L55) | if ( is\_multisite() && !is\_user\_member\_of\_blog( $user\_id ) ) { |
| [56](#L56) | return false; |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | } |
| [60](#L60) |  |
| [61](#L61) | return true; |
| [62](#L62) | } |
| [63](#L63) | // end of validate\_users() |
| [64](#L64) |  |
| [65](#L65) |  |
| [66](#L66) | public static function add\_role() { |
| [67](#L67) |  |
| [68](#L68) | if ( !current\_user\_can('promote\_users') ) { |
| [69](#L69) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Not enough permissions', 'user-role-editor') ); |
| [70](#L70) | return $answer; |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | if ( empty( $\_REQUEST['users'] ) ) { |
| [74](#L74) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Empty users list', 'user-role-editor') ); |
| [75](#L75) | return $answer; |
| [76](#L76) | } |
| [77](#L77) | $users = (array) $\_REQUEST['users']; |
| [78](#L78) | if ( !self::validate\_users( $users ) ) { |
| [79](#L79) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Can not edit user or invalid data at the users list', 'user-role-editor') ); |
| [80](#L80) | return $answer; |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | $lib = URE\_Lib::get\_instance(); |
| [84](#L84) | $role = $lib->get\_request\_var('role', 'post', 'string'); |
| [85](#L85) | if ( !self::validate\_roles( array($role=>$role) ) ) { |
| [86](#L86) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Invalid role', 'user-role-editor') ); |
| [87](#L87) | return $answer; |
| [88](#L88) | } |
| [89](#L89) |  |
| [90](#L90) | $quantity = 0; |
| [91](#L91) | foreach( $users as $user\_id ) { |
| [92](#L92) | $user = get\_user\_by( 'id', $user\_id ); |
| [93](#L93) | if (empty( $user ) ) { |
| [94](#L94) | continue; |
| [95](#L95) | } |
| [96](#L96) | if ( empty( $user->roles ) || !in\_array( $role, $user->roles ) ) { |
| [97](#L97) | $user->add\_role( $role ); |
| [98](#L98) | $quantity++; |
| [99](#L99) | } |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | if ( $quantity>0 ) { |
| [103](#L103) | // translators: template %d is a quantity of users to whom role was added |
| [104](#L104) | $message = sprintf( esc\_html\_\_('Role added to %d user(s).', 'user-role-editor'), $quantity ); |
| [105](#L105) | $answer = array('result'=>'success', 'message'=>$message ); |
| [106](#L106) | } else { |
| [107](#L107) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Error: Role not added', 'user-role-editor') ); |
| [108](#L108) | } |
| [109](#L109) |  |
| [110](#L110) | return $answer; |
| [111](#L111) | } |
| [112](#L112) | // end of add\_role() |
| [113](#L113) |  |
| [114](#L114) |  |
| [115](#L115) | private static function is\_try\_remove\_admin\_from\_himself( $user\_id, $role) { |
| [116](#L116) |  |
| [117](#L117) | $result = false; |
| [118](#L118) |  |
| [119](#L119) | $current\_user = wp\_get\_current\_user(); |
| [120](#L120) | $wp\_roles = wp\_roles(); |
| [121](#L121) | $role\_caps = array\_keys( $wp\_roles->roles[$role]['capabilities'] ); |
| [122](#L122) | $is\_current\_user = ( $user\_id == $current\_user->ID ); |
| [123](#L123) | $role\_can\_promote = in\_array('promote\_users', $role\_caps); |
| [124](#L124) | $can\_manage\_network = is\_multisite() && current\_user\_can( 'manage\_network\_users' ); |
| [125](#L125) |  |
| [126](#L126) | // If the removed role has the `promote\_users` cap and user is removing it from himself |
| [127](#L127) | if ( $is\_current\_user && $role\_can\_promote && !$can\_manage\_network ) { |
| [128](#L128) | $result = true; |
| [129](#L129) |  |
| [130](#L130) | // Loop through the current user's roles. |
| [131](#L131) | foreach ($current\_user->roles as $\_role) { |
| [132](#L132) | $\_role\_caps = array\_keys( $wp\_roles->roles[$\_role]['capabilities'] ); |
| [133](#L133) | // If the current user has another role that can promote users, it's safe to remove the role.  Else, the current user should to keep this role. |
| [134](#L134) | if ( ($role!==$\_role) && in\_array( 'promote\_users', $\_role\_caps ) ) { |
| [135](#L135) | $result = false; |
| [136](#L136) | break; |
| [137](#L137) | } |
| [138](#L138) | } |
| [139](#L139) |  |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | return $result; |
| [143](#L143) | } |
| [144](#L144) | // end of is\_try\_remove\_admin\_from\_himself() |
| [145](#L145) |  |
| [146](#L146) |  |
| [147](#L147) | public static function revoke\_role() { |
| [148](#L148) |  |
| [149](#L149) | if ( !current\_user\_can('promote\_users') ) { |
| [150](#L150) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Not enough permissions', 'user-role-editor') ); |
| [151](#L151) | return $answer; |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | if ( empty( $\_REQUEST['users'] ) ) { |
| [155](#L155) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Empty users list', 'user-role-editor') ); |
| [156](#L156) | return $answer; |
| [157](#L157) | } |
| [158](#L158) | $users = (array) $\_REQUEST['users']; |
| [159](#L159) | if ( !self::validate\_users( $users ) ) { |
| [160](#L160) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Can not edit user or invalid data at the users list', 'user-role-editor') ); |
| [161](#L161) | return $answer; |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | $lib = URE\_Lib::get\_instance(); |
| [165](#L165) | $role = $lib->get\_request\_var('role', 'post', 'string'); |
| [166](#L166) | if ( !self::validate\_roles( array($role=>$role) ) ) { |
| [167](#L167) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Invalid role', 'user-role-editor') ); |
| [168](#L168) | return $answer; |
| [169](#L169) | } |
| [170](#L170) |  |
| [171](#L171) | $quantity = 0; |
| [172](#L172) | foreach( $users as $user\_id ) { |
| [173](#L173) | $user = get\_user\_by( 'id', $user\_id ); |
| [174](#L174) | if ( empty( $user ) ) { |
| [175](#L175) | continue; |
| [176](#L176) | } |
| [177](#L177) | if ( self::is\_try\_remove\_admin\_from\_himself( $user\_id, $role ) ) { |
| [178](#L178) | continue; |
| [179](#L179) | } |
| [180](#L180) | if ( is\_array($user->roles) && in\_array( $role, $user->roles ) ) { |
| [181](#L181) | $user->remove\_role( $role ); |
| [182](#L182) | $quantity++; |
| [183](#L183) | } |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | if ( $quantity>0 ) { |
| [187](#L187) | // translators: template %d is a quantity of users to whom role was added |
| [188](#L188) | $message = sprintf( esc\_html\_\_('Role revoked from %d user(s).', 'user-role-editor'), $quantity ); |
| [189](#L189) | $answer = array('result'=>'success', 'message'=>$message ); |
| [190](#L190) | } else { |
| [191](#L191) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Error: Role not revoked', 'user-role-editor') ); |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | return $answer; |
| [195](#L195) | } |
| [196](#L196) | // end of revoke\_role() |
| [197](#L197) |  |
| [198](#L198) |  |
| [199](#L199) | private function update\_roles() { |
| [200](#L200) |  |
| [201](#L201) | if ( empty( $\_REQUEST['users'] ) ) { |
| [202](#L202) | return; |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | if ( !current\_user\_can('promote\_users') ) { |
| [206](#L206) | return; |
| [207](#L207) | } |
| [208](#L208) | $users = (array) $\_REQUEST['users']; |
| [209](#L209) | if ( !self::validate\_users( $users ) ) { |
| [210](#L210) | return; |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) | if ( ( !empty( $\_REQUEST['ure\_add\_role'] ) && !empty( $\_REQUEST['ure\_add\_role\_submit']) ) || |
| [214](#L214) | ( !empty( $\_REQUEST['ure\_add\_role\_2'] ) && !empty( $\_REQUEST['ure\_add\_role\_submit\_2'] ) ) ) { |
| [215](#L215) | $this->add\_role( $users ); |
| [216](#L216) | } else if ( ( !empty( $\_REQUEST['ure\_revoke\_role'] ) && !empty( $\_REQUEST['ure\_revoke\_role\_submit'] ) ) || |
| [217](#L217) | ( !empty( $\_REQUEST['ure\_revoke\_role\_2'] ) && !empty( $\_REQUEST['ure\_revoke\_role\_submit\_2'] ) ) ) { |
| [218](#L218) | $this->revoke\_role( $users ); |
| [219](#L219) | } |
| [220](#L220) | } |
| [221](#L221) | // end of update\_roles() |
| [222](#L222) |  |
| [223](#L223) |  |
| [224](#L224) | private static function validate\_roles( $roles ) { |
| [225](#L225) |  |
| [226](#L226) | if ( !is\_array( $roles ) ) { |
| [227](#L227) | return false; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | $lib = URE\_Lib::get\_instance(); |
| [231](#L231) | $editable\_roles = $lib->get\_all\_editable\_roles(); |
| [232](#L232) | $valid\_roles = array\_keys( $editable\_roles ); |
| [233](#L233) | foreach( $roles as $role ) { |
| [234](#L234) | if ( !in\_array( $role, $valid\_roles ) ) { |
| [235](#L235) | return false; |
| [236](#L236) | } |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | return true; |
| [240](#L240) | } |
| [241](#L241) | // end of validate\_roles() |
| [242](#L242) |  |
| [243](#L243) |  |
| [244](#L244) | private static function grant\_primary\_role\_to\_user($user\_id, $role) { |
| [245](#L245) |  |
| [246](#L246) | $user = get\_user\_by('id', $user\_id); |
| [247](#L247) | if (empty($user)) { |
| [248](#L248) | return; |
| [249](#L249) | } |
| [250](#L250) |  |
| [251](#L251) | if ($role===self::NO\_ROLE\_FOR\_THIS\_SITE) { |
| [252](#L252) | $role = ''; |
| [253](#L253) | } |
| [254](#L254) | $old\_roles = $user->roles;  // Save currently granted roles to restore from them the bbPress roles later if there are any... |
| [255](#L255) | $user->set\_role($role); |
| [256](#L256) |  |
| [257](#L257) | $lib = URE\_Lib::get\_instance(); |
| [258](#L258) | $bbpress = $lib->get('bbpress'); |
| [259](#L259) | if (empty($bbpress)) { |
| [260](#L260) | return; |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | $bbp\_roles = $bbpress->extract\_bbp\_roles($old\_roles); |
| [264](#L264) | if (count($bbp\_roles)>0) {  //  restore bbPress roles |
| [265](#L265) | foreach($bbp\_roles as $role) { |
| [266](#L266) | $user->add\_role($role); |
| [267](#L267) | } |
| [268](#L268) | } |
| [269](#L269) |  |
| [270](#L270) | } |
| [271](#L271) | // end of grant\_primary\_role\_to\_user() |
| [272](#L272) |  |
| [273](#L273) |  |
| [274](#L274) | private static function grant\_other\_roles\_to\_user($user\_id, $roles) { |
| [275](#L275) |  |
| [276](#L276) | $user = get\_user\_by('id', $user\_id); |
| [277](#L277) | if (empty($user)) { |
| [278](#L278) | return; |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | $roles\_list = array\_values( $user->roles ); |
| [282](#L282) | $primary\_role = array\_shift( $roles\_list );    // Get the 1st element from the roles array |
| [283](#L283) | $lib = URE\_Lib::get\_instance(); |
| [284](#L284) | $bbpress = $lib->get( 'bbpress' ); |
| [285](#L285) | if ( empty( $bbpress ) ) { |
| [286](#L286) | $bbp\_roles = array(); |
| [287](#L287) | } else { |
| [288](#L288) | $bbp\_roles = $bbpress->extract\_bbp\_roles( $user->roles ); |
| [289](#L289) | } |
| [290](#L290) | $user->remove\_all\_caps(); |
| [291](#L291) | $roles2 = ure\_array\_merge( array( $primary\_role ), $bbp\_roles, $roles ); |
| [292](#L292) | foreach( $roles2 as $role ) { |
| [293](#L293) | $user->add\_role( $role ); |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | } |
| [297](#L297) | // end of grant\_other\_roles\_to\_user() |
| [298](#L298) |  |
| [299](#L299) |  |
| [300](#L300) | /\*\* |
| [301](#L301) | \* Decide if primary role should be granted or left as it is |
| [302](#L302) | \* |
| [303](#L303) | \* @param string $primary\_role |
| [304](#L304) | \* @return boolean |
| [305](#L305) | \*/ |
| [306](#L306) | private static function is\_select\_primary\_role($primary\_role) { |
| [307](#L307) |  |
| [308](#L308) | if (empty($primary\_role)) { |
| [309](#L309) | return false;   // Primary role was not selected by user, leave an older one |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | $lib = URE\_Lib::get\_instance(); |
| [313](#L313) | if ($lib->is\_super\_admin()) { |
| [314](#L314) | $select\_primary\_role = true; |
| [315](#L315) | } else { |
| [316](#L316) | $select\_primary\_role = apply\_filters('ure\_users\_select\_primary\_role', true); |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | return $select\_primary\_role; |
| [320](#L320) | } |
| [321](#L321) | // end of is\_select\_primary\_role() |
| [322](#L322) |  |
| [323](#L323) |  |
| [324](#L324) | public static function grant\_roles() { |
| [325](#L325) |  |
| [326](#L326) | if ( !current\_user\_can('promote\_users') ) { |
| [327](#L327) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Not enough permissions', 'user-role-editor')); |
| [328](#L328) | return $answer; |
| [329](#L329) | } |
| [330](#L330) |  |
| [331](#L331) | $users = $\_POST['users']; |
| [332](#L332) | if ( !self::validate\_users( $users ) ) { |
| [333](#L333) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Can not edit user or invalid data at the users list', 'user-role-editor') ); |
| [334](#L334) | return $answer; |
| [335](#L335) | } |
| [336](#L336) |  |
| [337](#L337) | // Primary role |
| [338](#L338) | $primary\_role = $\_POST['primary\_role']; |
| [339](#L339) | if (!empty($primary\_role) && ($primary\_role!==self::NO\_ROLE\_FOR\_THIS\_SITE) && |
| [340](#L340) | !self::validate\_roles(array($primary\_role=>$primary\_role))) { |
| [341](#L341) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Invalid primary role', 'user-role-editor')); |
| [342](#L342) | return $answer; |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | if (self::is\_select\_primary\_role($primary\_role)) { |
| [346](#L346) | foreach ($users as $user\_id) { |
| [347](#L347) | self::grant\_primary\_role\_to\_user($user\_id, $primary\_role); |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | // Other roles |
| [352](#L352) | $other\_roles = isset($\_POST['other\_roles']) ? $\_POST['other\_roles'] : null; |
| [353](#L353) | if (!empty($other\_roles) && !self::validate\_roles($other\_roles)) { |
| [354](#L354) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Invalid data at the other roles list', 'user-role-editor')); |
| [355](#L355) | return $answer; |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | if (!empty($other\_roles)) { |
| [359](#L359) | foreach($users as $user\_id) { |
| [360](#L360) | self::grant\_other\_roles\_to\_user($user\_id, $other\_roles); |
| [361](#L361) | } |
| [362](#L362) | } |
| [363](#L363) | $answer = array('result'=>'success', 'message'=>esc\_html\_\_('Roles were granted to users successfully', 'user-role-editor')); |
| [364](#L364) |  |
| [365](#L365) | return $answer; |
| [366](#L366) | } |
| [367](#L367) | // end of grant\_roles() |
| [368](#L368) |  |
| [369](#L369) |  |
| [370](#L370) | public static function get\_user\_roles() { |
| [371](#L371) |  |
| [372](#L372) | if ( !current\_user\_can( 'promote\_users' ) ) { |
| [373](#L373) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Not enough permissions', 'user-role-editor')); |
| [374](#L374) | return $answer; |
| [375](#L375) | } |
| [376](#L376) |  |
| [377](#L377) | $lib = URE\_Lib::get\_instance(); |
| [378](#L378) | $user\_id = (int) $lib->get\_request\_var('user\_id', 'post', 'int'); |
| [379](#L379) | if (empty($user\_id)) { |
| [380](#L380) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Wrong request, valid user ID was missed', 'user-role-editor')); |
| [381](#L381) | return $answer; |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) | $user = get\_user\_by('id', $user\_id); |
| [385](#L385) | if (empty($user)) { |
| [386](#L386) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Requested user does not exist', 'user-role-editor')); |
| [387](#L387) | return $answer; |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | $other\_roles = array\_values($user->roles); |
| [391](#L391) | $primary\_role = array\_shift($other\_roles); |
| [392](#L392) |  |
| [393](#L393) | $answer = array('result'=>'success', 'primary\_role'=>$primary\_role, 'other\_roles'=>$other\_roles, 'message'=>'User roles were sent'); |
| [394](#L394) |  |
| [395](#L395) | return $answer; |
| [396](#L396) | } |
| [397](#L397) | // end of get\_user\_roles() |
| [398](#L398) |  |
| [399](#L399) |  |
| [400](#L400) |  |
| [401](#L401) | private function select\_primary\_role\_html() { |
| [402](#L402) |  |
| [403](#L403) | $select\_primary\_role = apply\_filters('ure\_users\_select\_primary\_role', true); |
| [404](#L404) | if (!$select\_primary\_role && !$this->lib->is\_super\_admin()) { |
| [405](#L405) | return; |
| [406](#L406) | } |
| [407](#L407) | ?> |
| [408](#L408) | <span style="font-weight: bold;"> |
| [409](#L409) | <?php esc\_html\_e('Primary Role: ', 'user-role-editor');?> |
| [410](#L410) | </span> |
| [411](#L411) | <select name="primary\_role" id="primary\_role"> |
| [412](#L412) | <?php |
| [413](#L413) | // print the full list of roles with the primary one selected. |
| [414](#L414) | wp\_dropdown\_roles(''); |
| [415](#L415) | echo '<option value="'. self::NO\_ROLE\_FOR\_THIS\_SITE .'">' . esc\_html\_\_('&mdash; No role for this site &mdash;', 'user-role-editor') . '</option>'. PHP\_EOL; |
| [416](#L416) | ?> |
| [417](#L417) | </select> |
| [418](#L418) | <hr/> |
| [419](#L419) | <?php |
| [420](#L420) | } |
| [421](#L421) | // end of select\_primary\_role\_html() |
| [422](#L422) |  |
| [423](#L423) |  |
| [424](#L424) | private function select\_other\_roles\_html() { |
| [425](#L425) | ?> |
| [426](#L426) | <div id="other\_roles\_container"> |
| [427](#L427) | <span style="font-weight: bold;"> |
| [428](#L428) | <?php |
| [429](#L429) | esc\_html\_e('Other Roles: ', 'user-role-editor'); |
| [430](#L430) | ?> |
| [431](#L431) | </span><br> |
| [432](#L432) | <?php |
| [433](#L433) | // Is PolyLang plugin active? |
| [434](#L434) | $use\_pll = function\_exists('pll\_\_'); |
| [435](#L435) |  |
| [436](#L436) | $show\_admin\_role = $this->lib->show\_admin\_role\_allowed(); |
| [437](#L437) | $roles = $this->lib->get\_all\_editable\_roles(); |
| [438](#L438) | foreach ($roles as $role\_id => $role) { |
| [439](#L439) | if (!$show\_admin\_role && $role\_id=='administrator') { |
| [440](#L440) | continue; |
| [441](#L441) | } |
| [442](#L442) | $role\_name = $use\_pll ? pll\_\_( $role['name'] ) : $role['name']; |
| [443](#L443) | echo '<label for="wp\_role\_' . $role\_id . '"><input type="checkbox"  id="wp\_role\_' . $role\_id . |
| [444](#L444) | '" name="ure\_roles[]" value="' . $role\_id . '" />&nbsp;' . |
| [445](#L445) | esc\_html( $role\_name ) .' ('. $role\_id .')</label><br />'. PHP\_EOL; |
| [446](#L446) | } |
| [447](#L447) | ?> |
| [448](#L448) | </div> |
| [449](#L449) | <?php |
| [450](#L450) | } |
| [451](#L451) | // end of select\_other\_roles\_html() |
| [452](#L452) |  |
| [453](#L453) |  |
| [454](#L454) | private function get\_roles\_options\_list() { |
| [455](#L455) |  |
| [456](#L456) | ob\_start(); |
| [457](#L457) | wp\_dropdown\_roles(); |
| [458](#L458) | $output = ob\_get\_clean(); |
| [459](#L459) |  |
| [460](#L460) | return $output; |
| [461](#L461) | } |
| [462](#L462) | // end of get\_roles\_options\_list() |
| [463](#L463) |  |
| [464](#L464) |  |
| [465](#L465) | public function show\_roles\_manage\_html() { |
| [466](#L466) |  |
| [467](#L467) | if ( !current\_user\_can( 'promote\_users' ) ) { |
| [468](#L468) | return; |
| [469](#L469) | } |
| [470](#L470) | $button\_number =  (self::$counter>0) ? '\_2': ''; |
| [471](#L471) | $roles\_options\_list = self::get\_roles\_options\_list(); |
| [472](#L472) | ?> |
| [473](#L473) | &nbsp;&nbsp; |
| [474](#L474) | <input type="button" name="ure\_grant\_roles<?php echo $button\_number;?>" id="ure\_grant\_roles<?php echo $button\_number;?>" class="button" |
| [475](#L475) | value="<?php esc\_html\_e('Grant Roles', 'user-role-editor');?>"> |
| [476](#L476) | &nbsp;&nbsp; |
| [477](#L477) | <label class="screen-reader-text" for="ure\_add\_role<?php echo $button\_number;?>"><?php esc\_html\_e( 'Add role&hellip;', 'user-role-editor' ); ?></label> |
| [478](#L478) | <select name="ure\_add\_role<?php echo $button\_number;?>" id="ure\_add\_role<?php echo $button\_number;?>" style="display: inline-block; float: none;"> |
| [479](#L479) | <option value=""><?php esc\_html\_e( 'Add role&hellip;', 'user-role-editor' ); ?></option> |
| [480](#L480) | <?php echo $roles\_options\_list; ?> |
| [481](#L481) | </select> |
| [482](#L482) | <input type="button" name="ure\_add\_role\_button<?php echo $button\_number;?>" id="ure\_add\_role\_button<?php echo $button\_number;?>" class="button" |
| [483](#L483) | value="<?php esc\_html\_e('Add', 'user-role-editor');?>"> |
| [484](#L484) | &nbsp;&nbsp; |
| [485](#L485) | <label class="screen-reader-text" for="ure\_revoke\_role<?php echo $button\_number;?>"><?php esc\_html\_e( 'Revoke role&hellip;', 'user-role-editor' ); ?></label> |
| [486](#L486) | <select name="ure\_revoke\_role<?php echo $button\_number;?>" id="ure\_revoke\_role<?php echo $button\_number;?>" style="display: inline-block; float: none;"> |
| [487](#L487) | <option value=""><?php esc\_html\_e( 'Revoke role&hellip;', 'user-role-editor' ); ?></option> |
| [488](#L488) | <?php echo $roles\_options\_list; ?> |
| [489](#L489) | </select> |
| [490](#L490) | <input type="button" name="ure\_revoke\_role\_button<?php echo $button\_number;?>" id="ure\_revoke\_role\_button<?php echo $button\_number;?>" class="button" |
| [491](#L491) | value="<?php esc\_html\_e('Revoke', 'user-role-editor');?>"> |
| [492](#L492) |  |
| [493](#L493) |  |
| [494](#L494) | <?php |
| [495](#L495) | if (self::$counter==0) { |
| [496](#L496) | ?> |
| [497](#L497) | <div id="ure\_grant\_roles\_dialog" class="ure-dialog"> |
| [498](#L498) | <div id="ure\_grant\_roles\_content"> |
| [499](#L499) | <?php |
| [500](#L500) | $this->select\_primary\_role\_html(); |
| [501](#L501) | $this->select\_other\_roles\_html(); |
| [502](#L502) | ?> |
| [503](#L503) | </div> |
| [504](#L504) | </div> |
| [505](#L505) | <?php |
| [506](#L506) | URE\_View::output\_task\_status\_div(); |
| [507](#L507) | self::$counter++; |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | } |
| [511](#L511) | // end of show\_grant\_roles\_html() |
| [512](#L512) |  |
| [513](#L513) |  |
| [514](#L514) | public function load\_js() { |
| [515](#L515) |  |
| [516](#L516) | $show\_wp\_change\_role = apply\_filters('ure\_users\_show\_wp\_change\_role', true); |
| [517](#L517) |  |
| [518](#L518) | wp\_enqueue\_script('jquery-ui-dialog', '', array('jquery-ui-core','jquery-ui-button', 'jquery'), false, true ); |
| [519](#L519) | wp\_register\_script('ure-users-grant-roles', plugins\_url('/js/users-grant-roles.js', URE\_PLUGIN\_FULL\_PATH ), array(), URE\_VERSION, true ); |
| [520](#L520) | wp\_enqueue\_script('ure-users-grant-roles'); |
| [521](#L521) | wp\_localize\_script('ure-users-grant-roles', 'ure\_users\_grant\_roles\_data', array( |
| [522](#L522) | 'wp\_nonce' => wp\_create\_nonce('user-role-editor'), |
| [523](#L523) | 'dialog\_title'=> esc\_html\_\_('Grant roles to selected users', 'user-role-editor'), |
| [524](#L524) | 'select\_users\_first' => esc\_html\_\_('Select users to which you wish to grant roles!', 'user-role-editor'), |
| [525](#L525) | 'select\_roles\_first' => esc\_html\_\_('Select role(s) which you wish to grant!', 'user-role-editor'), |
| [526](#L526) | 'select\_role\_first' => esc\_html\_\_('Select role first!', 'user-role-editor'), |
| [527](#L527) | 'select\_users\_to\_add\_role' => esc\_html\_\_('Select users to which you wish to add role!', 'user-role-editor'), |
| [528](#L528) | 'select\_users\_to\_revoke\_role' => esc\_html\_\_('Select users from which you wish revoke role!', 'user-role-editor'), |
| [529](#L529) | 'show\_wp\_change\_role' => $show\_wp\_change\_role ? 1: 0 |
| [530](#L530) | )); |
| [531](#L531) | } |
| [532](#L532) | // end of load\_js() |
| [533](#L533) |  |
| [534](#L534) | } |
| [535](#L535) | // end of URE\_Grant\_Roles class |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/user-role-editor/trunk/includes/classes/grant-roles.php?format=txt)
* [Original Format](/export/3222468/user-role-editor/trunk/includes/classes/grant-roles.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_1b3f0ea3_20250114_203952.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fuser-role-editor%2Ftrunk%2Fincludes%2Fclasses%2Fgrant-roles.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/user-role-editor/trunk/includes/classes/grant-roles.php?rev=3201795 "Revision 3201795")
* Next Revision →
* [Blame](/browser/user-role-editor/trunk/includes/classes/grant-roles.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/user-role-editor/trunk/includes/classes/grant-roles.php)

---

# [source:](/browser?order=name "Go to repository root") [user-role-editor](/browser/user-role-editor?order=name "View user-role-editor")/[trunk](/browser/user-role-editor/trunk?order=name "View trunk")/[includes](/browser/user-role-editor/trunk/includes?order=name "View includes")/[classes](/browser/user-role-editor/trunk/includes/classes?order=name "View classes")/[grant-roles.php](/browser/user-role-editor/trunk/includes/classes/grant-roles.php?order=name "View grant-roles.php")

View diff against:

View revision:

| [Last change](/changeset/3208188/user-role-editor/trunk/includes/classes/grant-roles.php "View differences") on this file was [3208188](/changeset/3208188/ "View changeset 3208188"), checked in by shinephp, [4 weeks ago](/timeline?from=2024-12-15T13%3A30%3A35Z&precision=second "See timeline at 12/15/2024 01:30:35 PM") |
| --- |
| * Security Fix: Users - "Add Role", "Revoke Role" buttons: Cross-Site request forgery to privilege escalation was possible due to missed nonce validation. This issue was discovered and responsibly reported by vgo0. |
| **File size:** 19.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Project: User Role Editor plugin |
| [4](#L4) | \* Author: Vladimir Garagulya |
| [5](#L5) | \* Author email: support@role-editor.com |
| [6](#L6) | \* Author URI: https://www.role-editor.com |
| [7](#L7) | \* License: GPL v2+ |
| [8](#L8) | \* |
| [9](#L9) | \* Assign multiple roles to the list of selected users directly from the "Users" page |
| [10](#L10) | \* Grant/Revoke single role to/from selected users |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | class URE\_Grant\_Roles { |
| [14](#L14) |  |
| [15](#L15) | const NO\_ROLE\_FOR\_THIS\_SITE = 'no-role-for-this-site'; |
| [16](#L16) |  |
| [17](#L17) | private $lib = null; |
| [18](#L18) | private static $counter = 0; |
| [19](#L19) |  |
| [20](#L20) |  |
| [21](#L21) | public function \_\_construct() { |
| [22](#L22) |  |
| [23](#L23) | $this->lib = URE\_Lib::get\_instance(); |
| [24](#L24) |  |
| [25](#L25) | add\_action( 'load-users.php', array( $this, 'load' ) ); |
| [26](#L26) |  |
| [27](#L27) | } |
| [28](#L28) | // end of \_\_construct() |
| [29](#L29) |  |
| [30](#L30) |  |
| [31](#L31) | public function load() { |
| [32](#L32) |  |
| [33](#L33) | add\_action('restrict\_manage\_users', array($this, 'show\_roles\_manage\_html') ); |
| [34](#L34) | add\_action('admin\_head', array(User\_Role\_Editor::get\_instance(), 'add\_css\_to\_users\_page') ); |
| [35](#L35) | add\_action('admin\_enqueue\_scripts', array($this, 'load\_js') ); |
| [36](#L36) |  |
| [37](#L37) | } |
| [38](#L38) | // end of load() |
| [39](#L39) |  |
| [40](#L40) |  |
| [41](#L41) | private static function validate\_users($users) { |
| [42](#L42) |  |
| [43](#L43) | if (!is\_array($users)) { |
| [44](#L44) | return false; |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | foreach ($users as $user\_id) { |
| [48](#L48) | if (!is\_numeric($user\_id)) { |
| [49](#L49) | return false; |
| [50](#L50) | } |
| [51](#L51) | if ( !current\_user\_can( 'promote\_user', $user\_id ) ) { |
| [52](#L52) | return false; |
| [53](#L53) | } |
| [54](#L54) |  |
| [55](#L55) | if ( is\_multisite() && !is\_user\_member\_of\_blog( $user\_id ) ) { |
| [56](#L56) | return false; |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | } |
| [60](#L60) |  |
| [61](#L61) | return true; |
| [62](#L62) | } |
| [63](#L63) | // end of validate\_users() |
| [64](#L64) |  |
| [65](#L65) |  |
| [66](#L66) | public static function add\_role() { |
| [67](#L67) |  |
| [68](#L68) | if ( !current\_user\_can('promote\_users') ) { |
| [69](#L69) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Not enough permissions', 'user-role-editor') ); |
| [70](#L70) | return $answer; |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | if ( empty( $\_REQUEST['users'] ) ) { |
| [74](#L74) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Empty users list', 'user-role-editor') ); |
| [75](#L75) | return $answer; |
| [76](#L76) | } |
| [77](#L77) | $users = (array) $\_REQUEST['users']; |
| [78](#L78) | if ( !self::validate\_users( $users ) ) { |
| [79](#L79) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Can not edit user or invalid data at the users list', 'user-role-editor') ); |
| [80](#L80) | return $answer; |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | $lib = URE\_Lib::get\_instance(); |
| [84](#L84) | $role = $lib->get\_request\_var('role', 'post', 'string'); |
| [85](#L85) | if ( !self::validate\_roles( array($role=>$role) ) ) { |
| [86](#L86) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Invalid role', 'user-role-editor') ); |
| [87](#L87) | return $answer; |
| [88](#L88) | } |
| [89](#L89) |  |
| [90](#L90) | $quantity = 0; |
| [91](#L91) | foreach( $users as $user\_id ) { |
| [92](#L92) | $user = get\_user\_by( 'id', $user\_id ); |
| [93](#L93) | if (empty( $user ) ) { |
| [94](#L94) | continue; |
| [95](#L95) | } |
| [96](#L96) | if ( empty( $user->roles ) || !in\_array( $role, $user->roles ) ) { |
| [97](#L97) | $user->add\_role( $role ); |
| [98](#L98) | $quantity++; |
| [99](#L99) | } |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | if ( $quantity>0 ) { |
| [103](#L103) | // translators: template %d is a quantity of users to whom role was added |
| [104](#L104) | $message = sprintf( esc\_html\_\_('Role added to %d user(s).', 'user-role-editor'), $quantity ); |
| [105](#L105) | $answer = array('result'=>'success', 'message'=>$message ); |
| [106](#L106) | } else { |
| [107](#L107) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Error: Role not added', 'user-role-editor') ); |
| [108](#L108) | } |
| [109](#L109) |  |
| [110](#L110) | return $answer; |
| [111](#L111) | } |
| [112](#L112) | // end of add\_role() |
| [113](#L113) |  |
| [114](#L114) |  |
| [115](#L115) | private static function is\_try\_remove\_admin\_from\_himself( $user\_id, $role) { |
| [116](#L116) |  |
| [117](#L117) | $result = false; |
| [118](#L118) |  |
| [119](#L119) | $current\_user = wp\_get\_current\_user(); |
| [120](#L120) | $wp\_roles = wp\_roles(); |
| [121](#L121) | $role\_caps = array\_keys( $wp\_roles->roles[$role]['capabilities'] ); |
| [122](#L122) | $is\_current\_user = ( $user\_id == $current\_user->ID ); |
| [123](#L123) | $role\_can\_promote = in\_array('promote\_users', $role\_caps); |
| [124](#L124) | $can\_manage\_network = is\_multisite() && current\_user\_can( 'manage\_network\_users' ); |
| [125](#L125) |  |
| [126](#L126) | // If the removed role has the `promote\_users` cap and user is removing it from himself |
| [127](#L127) | if ( $is\_current\_user && $role\_can\_promote && !$can\_manage\_network ) { |
| [128](#L128) | $result = true; |
| [129](#L129) |  |
| [130](#L130) | // Loop through the current user's roles. |
| [131](#L131) | foreach ($current\_user->roles as $\_role) { |
| [132](#L132) | $\_role\_caps = array\_keys( $wp\_roles->roles[$\_role]['capabilities'] ); |
| [133](#L133) | // If the current user has another role that can promote users, it's safe to remove the role.  Else, the current user should to keep this role. |
| [134](#L134) | if ( ($role!==$\_role) && in\_array( 'promote\_users', $\_role\_caps ) ) { |
| [135](#L135) | $result = false; |
| [136](#L136) | break; |
| [137](#L137) | } |
| [138](#L138) | } |
| [139](#L139) |  |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | return $result; |
| [143](#L143) | } |
| [144](#L144) | // end of is\_try\_remove\_admin\_from\_himself() |
| [145](#L145) |  |
| [146](#L146) |  |
| [147](#L147) | public static function revoke\_role() { |
| [148](#L148) |  |
| [149](#L149) | if ( !current\_user\_can('promote\_users') ) { |
| [150](#L150) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Not enough permissions', 'user-role-editor') ); |
| [151](#L151) | return $answer; |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | if ( empty( $\_REQUEST['users'] ) ) { |
| [155](#L155) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Empty users list', 'user-role-editor') ); |
| [156](#L156) | return $answer; |
| [157](#L157) | } |
| [158](#L158) | $users = (array) $\_REQUEST['users']; |
| [159](#L159) | if ( !self::validate\_users( $users ) ) { |
| [160](#L160) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Can not edit user or invalid data at the users list', 'user-role-editor') ); |
| [161](#L161) | return $answer; |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | $lib = URE\_Lib::get\_instance(); |
| [165](#L165) | $role = $lib->get\_request\_var('role', 'post', 'string'); |
| [166](#L166) | if ( !self::validate\_roles( array($role=>$role) ) ) { |
| [167](#L167) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Invalid role', 'user-role-editor') ); |
| [168](#L168) | return $answer; |
| [169](#L169) | } |
| [170](#L170) |  |
| [171](#L171) | $quantity = 0; |
| [172](#L172) | foreach( $users as $user\_id ) { |
| [173](#L173) | $user = get\_user\_by( 'id', $user\_id ); |
| [174](#L174) | if ( empty( $user ) ) { |
| [175](#L175) | continue; |
| [176](#L176) | } |
| [177](#L177) | if ( self::is\_try\_remove\_admin\_from\_himself( $user\_id, $role ) ) { |
| [178](#L178) | continue; |
| [179](#L179) | } |
| [180](#L180) | if ( is\_array($user->roles) && in\_array( $role, $user->roles ) ) { |
| [181](#L181) | $user->remove\_role( $role ); |
| [182](#L182) | $quantity++; |
| [183](#L183) | } |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | if ( $quantity>0 ) { |
| [187](#L187) | // translators: template %d is a quantity of users to whom role was added |
| [188](#L188) | $message = sprintf( esc\_html\_\_('Role revoked from %d user(s).', 'user-role-editor'), $quantity ); |
| [189](#L189) | $answer = array('result'=>'success', 'message'=>$message ); |
| [190](#L190) | } else { |
| [191](#L191) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Error: Role not revoked', 'user-role-editor') ); |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | return $answer; |
| [195](#L195) | } |
| [196](#L196) | // end of revoke\_role() |
| [197](#L197) |  |
| [198](#L198) |  |
| [199](#L199) | private function update\_roles() { |
| [200](#L200) |  |
| [201](#L201) | if ( empty( $\_REQUEST['users'] ) ) { |
| [202](#L202) | return; |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | if ( !current\_user\_can('promote\_users') ) { |
| [206](#L206) | return; |
| [207](#L207) | } |
| [208](#L208) | $users = (array) $\_REQUEST['users']; |
| [209](#L209) | if ( !self::validate\_users( $users ) ) { |
| [210](#L210) | return; |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) | if ( ( !empty( $\_REQUEST['ure\_add\_role'] ) && !empty( $\_REQUEST['ure\_add\_role\_submit']) ) || |
| [214](#L214) | ( !empty( $\_REQUEST['ure\_add\_role\_2'] ) && !empty( $\_REQUEST['ure\_add\_role\_submit\_2'] ) ) ) { |
| [215](#L215) | $this->add\_role( $users ); |
| [216](#L216) | } else if ( ( !empty( $\_REQUEST['ure\_revoke\_role'] ) && !empty( $\_REQUEST['ure\_revoke\_role\_submit'] ) ) || |
| [217](#L217) | ( !empty( $\_REQUEST['ure\_revoke\_role\_2'] ) && !empty( $\_REQUEST['ure\_revoke\_role\_submit\_2'] ) ) ) { |
| [218](#L218) | $this->revoke\_role( $users ); |
| [219](#L219) | } |
| [220](#L220) | } |
| [221](#L221) | // end of update\_roles() |
| [222](#L222) |  |
| [223](#L223) |  |
| [224](#L224) | private static function validate\_roles( $roles ) { |
| [225](#L225) |  |
| [226](#L226) | if ( !is\_array( $roles ) ) { |
| [227](#L227) | return false; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | $lib = URE\_Lib::get\_instance(); |
| [231](#L231) | $editable\_roles = $lib->get\_all\_editable\_roles(); |
| [232](#L232) | $valid\_roles = array\_keys( $editable\_roles ); |
| [233](#L233) | foreach( $roles as $role ) { |
| [234](#L234) | if ( !in\_array( $role, $valid\_roles ) ) { |
| [235](#L235) | return false; |
| [236](#L236) | } |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | return true; |
| [240](#L240) | } |
| [241](#L241) | // end of validate\_roles() |
| [242](#L242) |  |
| [243](#L243) |  |
| [244](#L244) | private static function grant\_primary\_role\_to\_user($user\_id, $role) { |
| [245](#L245) |  |
| [246](#L246) | $user = get\_user\_by('id', $user\_id); |
| [247](#L247) | if (empty($user)) { |
| [248](#L248) | return; |
| [249](#L249) | } |
| [250](#L250) |  |
| [251](#L251) | if ($role===self::NO\_ROLE\_FOR\_THIS\_SITE) { |
| [252](#L252) | $role = ''; |
| [253](#L253) | } |
| [254](#L254) | $old\_roles = $user->roles;  // Save currently granted roles to restore from them the bbPress roles later if there are any... |
| [255](#L255) | $user->set\_role($role); |
| [256](#L256) |  |
| [257](#L257) | $lib = URE\_Lib::get\_instance(); |
| [258](#L258) | $bbpress = $lib->get('bbpress'); |
| [259](#L259) | if (empty($bbpress)) { |
| [260](#L260) | return; |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | $bbp\_roles = $bbpress->extract\_bbp\_roles($old\_roles); |
| [264](#L264) | if (count($bbp\_roles)>0) {  //  restore bbPress roles |
| [265](#L265) | foreach($bbp\_roles as $role) { |
| [266](#L266) | $user->add\_role($role); |
| [267](#L267) | } |
| [268](#L268) | } |
| [269](#L269) |  |
| [270](#L270) | } |
| [271](#L271) | // end of grant\_primary\_role\_to\_user() |
| [272](#L272) |  |
| [273](#L273) |  |
| [274](#L274) | private static function grant\_other\_roles\_to\_user($user\_id, $roles) { |
| [275](#L275) |  |
| [276](#L276) | $user = get\_user\_by('id', $user\_id); |
| [277](#L277) | if (empty($user)) { |
| [278](#L278) | return; |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | $roles\_list = array\_values( $user->roles ); |
| [282](#L282) | $primary\_role = array\_shift( $roles\_list );    // Get the 1st element from the roles array |
| [283](#L283) | $lib = URE\_Lib::get\_instance(); |
| [284](#L284) | $bbpress = $lib->get( 'bbpress' ); |
| [285](#L285) | if ( empty( $bbpress ) ) { |
| [286](#L286) | $bbp\_roles = array(); |
| [287](#L287) | } else { |
| [288](#L288) | $bbp\_roles = $bbpress->extract\_bbp\_roles( $user->roles ); |
| [289](#L289) | } |
| [290](#L290) | $user->remove\_all\_caps(); |
| [291](#L291) | $roles2 = ure\_array\_merge( array( $primary\_role ), $bbp\_roles, $roles ); |
| [292](#L292) | foreach( $roles2 as $role ) { |
| [293](#L293) | $user->add\_role( $role ); |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | } |
| [297](#L297) | // end of grant\_other\_roles\_to\_user() |
| [298](#L298) |  |
| [299](#L299) |  |
| [300](#L300) | /\*\* |
| [301](#L301) | \* Decide if primary role should be granted or left as it is |
| [302](#L302) | \* |
| [303](#L303) | \* @param string $primary\_role |
| [304](#L304) | \* @return boolean |
| [305](#L305) | \*/ |
| [306](#L306) | private static function is\_select\_primary\_role($primary\_role) { |
| [307](#L307) |  |
| [308](#L308) | if (empty($primary\_role)) { |
| [309](#L309) | return false;   // Primary role was not selected by user, leave an older one |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | $lib = URE\_Lib::get\_instance(); |
| [313](#L313) | if ($lib->is\_super\_admin()) { |
| [314](#L314) | $select\_primary\_role = true; |
| [315](#L315) | } else { |
| [316](#L316) | $select\_primary\_role = apply\_filters('ure\_users\_select\_primary\_role', true); |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | return $select\_primary\_role; |
| [320](#L320) | } |
| [321](#L321) | // end of is\_select\_primary\_role() |
| [322](#L322) |  |
| [323](#L323) |  |
| [324](#L324) | public static function grant\_roles() { |
| [325](#L325) |  |
| [326](#L326) | if ( !current\_user\_can('promote\_users') ) { |
| [327](#L327) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Not enough permissions', 'user-role-editor')); |
| [328](#L328) | return $answer; |
| [329](#L329) | } |
| [330](#L330) |  |
| [331](#L331) | $users = $\_POST['users']; |
| [332](#L332) | if ( !self::validate\_users( $users ) ) { |
| [333](#L333) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Can not edit user or invalid data at the users list', 'user-role-editor') ); |
| [334](#L334) | return $answer; |
| [335](#L335) | } |
| [336](#L336) |  |
| [337](#L337) | // Primary role |
| [338](#L338) | $primary\_role = $\_POST['primary\_role']; |
| [339](#L339) | if (!empty($primary\_role) && ($primary\_role!==self::NO\_ROLE\_FOR\_THIS\_SITE) && |
| [340](#L340) | !self::validate\_roles(array($primary\_role=>$primary\_role))) { |
| [341](#L341) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Invalid primary role', 'user-role-editor')); |
| [342](#L342) | return $answer; |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | if (self::is\_select\_primary\_role($primary\_role)) { |
| [346](#L346) | foreach ($users as $user\_id) { |
| [347](#L347) | self::grant\_primary\_role\_to\_user($user\_id, $primary\_role); |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | // Other roles |
| [352](#L352) | $other\_roles = isset($\_POST['other\_roles']) ? $\_POST['other\_roles'] : null; |
| [353](#L353) | if (!empty($other\_roles) && !self::validate\_roles($other\_roles)) { |
| [354](#L354) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Invalid data at the other roles list', 'user-role-editor')); |
| [355](#L355) | return $answer; |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | if (!empty($other\_roles)) { |
| [359](#L359) | foreach($users as $user\_id) { |
| [360](#L360) | self::grant\_other\_roles\_to\_user($user\_id, $other\_roles); |
| [361](#L361) | } |
| [362](#L362) | } |
| [363](#L363) | $answer = array('result'=>'success', 'message'=>esc\_html\_\_('Roles were granted to users successfully', 'user-role-editor')); |
| [364](#L364) |  |
| [365](#L365) | return $answer; |
| [366](#L366) | } |
| [367](#L367) | // end of grant\_roles() |
| [368](#L368) |  |
| [369](#L369) |  |
| [370](#L370) | public static function get\_user\_roles() { |
| [371](#L371) |  |
| [372](#L372) | if ( !current\_user\_can( 'promote\_users' ) ) { |
| [373](#L373) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Not enough permissions', 'user-role-editor')); |
| [374](#L374) | return $answer; |
| [375](#L375) | } |
| [376](#L376) |  |
| [377](#L377) | $lib = URE\_Lib::get\_instance(); |
| [378](#L378) | $user\_id = (int) $lib->get\_request\_var('user\_id', 'post', 'int'); |
| [379](#L379) | if (empty($user\_id)) { |
| [380](#L380) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Wrong request, valid user ID was missed', 'user-role-editor')); |
| [381](#L381) | return $answer; |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) | $user = get\_user\_by('id', $user\_id); |
| [385](#L385) | if (empty($user)) { |
| [386](#L386) | $answer = array('result'=>'error', 'message'=>esc\_html\_\_('Requested user does not exist', 'user-role-editor')); |
| [387](#L387) | return $answer; |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | $other\_roles = array\_values($user->roles); |
| [391](#L391) | $primary\_role = array\_shift($other\_roles); |
| [392](#L392) |  |
| [393](#L393) | $answer = array('result'=>'success', 'primary\_role'=>$primary\_role, 'other\_roles'=>$other\_roles, 'message'=>'User roles were sent'); |
| [394](#L394) |  |
| [395](#L395) | return $answer; |
| [396](#L396) | } |
| [397](#L397) | // end of get\_user\_roles() |
| [398](#L398) |  |
| [399](#L399) |  |
| [400](#L400) |  |
| [401](#L401) | private function select\_primary\_role\_html() { |
| [402](#L402) |  |
| [403](#L403) | $select\_primary\_role = apply\_filters('ure\_users\_select\_primary\_role', true); |
| [404](#L404) | if (!$select\_primary\_role && !$this->lib->is\_super\_admin()) { |
| [405](#L405) | return; |
| [406](#L406) | } |
| [407](#L407) | ?> |
| [408](#L408) | <span style="font-weight: bold;"> |
| [409](#L409) | <?php esc\_html\_e('Primary Role: ', 'user-role-editor');?> |
| [410](#L410) | </span> |
| [411](#L411) | <select name="primary\_role" id="primary\_role"> |
| [412](#L412) | <?php |
| [413](#L413) | // print the full list of roles with the primary one selected. |
| [414](#L414) | wp\_dropdown\_roles(''); |
| [415](#L415) | echo '<option value="'. self::NO\_ROLE\_FOR\_THIS\_SITE .'">' . esc\_html\_\_('&mdash; No role for this site &mdash;', 'user-role-editor') . '</option>'. PHP\_EOL; |
| [416](#L416) | ?> |
| [417](#L417) | </select> |
| [418](#L418) | <hr/> |
| [419](#L419) | <?php |
| [420](#L420) | } |
| [421](#L421) | // end of select\_primary\_role\_html() |
| [422](#L422) |  |
| [423](#L423) |  |
| [424](#L424) | private function select\_other\_roles\_html() { |
| [425](#L425) | ?> |
| [426](#L426) | <div id="other\_roles\_container"> |
| [427](#L427) | <span style="font-weight: bold;"> |
| [428](#L428) | <?php |
| [429](#L429) | esc\_html\_e('Other Roles: ', 'user-role-editor'); |
| [430](#L430) | ?> |
| [431](#L431) | </span><br> |
| [432](#L432) | <?php |
| [433](#L433) | // Is PolyLang plugin active? |
| [434](#L434) | $use\_pll = function\_exists('pll\_\_'); |
| [435](#L435) |  |
| [436](#L436) | $show\_admin\_role = $this->lib->show\_admin\_role\_allowed(); |
| [437](#L437) | $roles = $this->lib->get\_all\_editable\_roles(); |
| [438](#L438) | foreach ($roles as $role\_id => $role) { |
| [439](#L439) | if (!$show\_admin\_role && $role\_id=='administrator') { |
| [440](#L440) | continue; |
| [441](#L441) | } |
| [442](#L442) | $role\_name = $use\_pll ? pll\_\_( $role['name'] ) : $role['name']; |
| [443](#L443) | echo '<label for="wp\_role\_' . $role\_id . '"><input type="checkbox"  id="wp\_role\_' . $role\_id . |
| [444](#L444) | '" name="ure\_roles[]" value="' . $role\_id . '" />&nbsp;' . |
| [445](#L445) | esc\_html( $role\_name ) .' ('. $role\_id .')</label><br />'. PHP\_EOL; |
| [446](#L446) | } |
| [447](#L447) | ?> |
| [448](#L448) | </div> |
| [449](#L449) | <?php |
| [450](#L450) | } |
| [451](#L451) | // end of select\_other\_roles\_html() |
| [452](#L452) |  |
| [453](#L453) |  |
| [454](#L454) | private function get\_roles\_options\_list() { |
| [455](#L455) |  |
| [456](#L456) | ob\_start(); |
| [457](#L457) | wp\_dropdown\_roles(); |
| [458](#L458) | $output = ob\_get\_clean(); |
| [459](#L459) |  |
| [460](#L460) | return $output; |
| [461](#L461) | } |
| [462](#L462) | // end of get\_roles\_options\_list() |
| [463](#L463) |  |
| [464](#L464) |  |
| [465](#L465) | public function show\_roles\_manage\_html() { |
| [466](#L466) |  |
| [467](#L467) | if ( !current\_user\_can( 'promote\_users' ) ) { |
| [468](#L468) | return; |
| [469](#L469) | } |
| [470](#L470) | $button\_number =  (self::$counter>0) ? '\_2': ''; |
| [471](#L471) | $roles\_options\_list = self::get\_roles\_options\_list(); |
| [472](#L472) | ?> |
| [473](#L473) | &nbsp;&nbsp; |
| [474](#L474) | <input type="button" name="ure\_grant\_roles<?php echo $button\_number;?>" id="ure\_grant\_roles<?php echo $button\_number;?>" class="button" |
| [475](#L475) | value="<?php esc\_html\_e('Grant Roles', 'user-role-editor');?>"> |
| [476](#L476) | &nbsp;&nbsp; |
| [477](#L477) | <label class="screen-reader-text" for="ure\_add\_role<?php echo $button\_number;?>"><?php esc\_html\_e( 'Add role&hellip;', 'user-role-editor' ); ?></label> |
| [478](#L478) | <select name="ure\_add\_role<?php echo $button\_number;?>" id="ure\_add\_role<?php echo $button\_number;?>" style="display: inline-block; float: none;"> |
| [479](#L479) | <option value=""><?php esc\_html\_e( 'Add role&hellip;', 'user-role-editor' ); ?></option> |
| [480](#L480) | <?php echo $roles\_options\_list; ?> |
| [481](#L481) | </select> |
| [482](#L482) | <input type="button" name="ure\_add\_role\_button<?php echo $button\_number;?>" id="ure\_add\_role\_button<?php echo $button\_number;?>" class="button" |
| [483](#L483) | value="<?php esc\_html\_e('Add', 'user-role-editor');?>"> |
| [484](#L484) | &nbsp;&nbsp; |
| [485](#L485) | <label class="screen-reader-text" for="ure\_revoke\_role<?php echo $button\_number;?>"><?php esc\_html\_e( 'Revoke role&hellip;', 'user-role-editor' ); ?></label> |
| [486](#L486) | <select name="ure\_revoke\_role<?php echo $button\_number;?>" id="ure\_revoke\_role<?php echo $button\_number;?>" style="display: inline-block; float: none;"> |
| [487](#L487) | <option value=""><?php esc\_html\_e( 'Revoke role&hellip;', 'user-role-editor' ); ?></option> |
| [488](#L488) | <?php echo $roles\_options\_list; ?> |
| [489](#L489) | </select> |
| [490](#L490) | <input type="button" name="ure\_revoke\_role\_button<?php echo $button\_number;?>" id="ure\_revoke\_role\_button<?php echo $button\_number;?>" class="button" |
| [491](#L491) | value="<?php esc\_html\_e('Revoke', 'user-role-editor');?>"> |
| [492](#L492) |  |
| [493](#L493) |  |
| [494](#L494) | <?php |
| [495](#L495) | if (self::$counter==0) { |
| [496](#L496) | ?> |
| [497](#L497) | <div id="ure\_grant\_roles\_dialog" class="ure-dialog"> |
| [498](#L498) | <div id="ure\_grant\_roles\_content"> |
| [499](#L499) | <?php |
| [500](#L500) | $this->select\_primary\_role\_html(); |
| [501](#L501) | $this->select\_other\_roles\_html(); |
| [502](#L502) | ?> |
| [503](#L503) | </div> |
| [504](#L504) | </div> |
| [505](#L505) | <?php |
| [506](#L506) | URE\_View::output\_task\_status\_div(); |
| [507](#L507) | self::$counter++; |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | } |
| [511](#L511) | // end of show\_grant\_roles\_html() |
| [512](#L512) |  |
| [513](#L513) |  |
| [514](#L514) | public function load\_js() { |
| [515](#L515) |  |
| [516](#L516) | $show\_wp\_change\_role = apply\_filters('ure\_users\_show\_wp\_change\_role', true); |
| [517](#L517) |  |
| [518](#L518) | wp\_enqueue\_script('jquery-ui-dialog', '', array('jquery-ui-core','jquery-ui-button', 'jquery'), false, true ); |
| [519](#L519) | wp\_register\_script('ure-users-grant-roles', plugins\_url('/js/users-grant-roles.js', URE\_PLUGIN\_FULL\_PATH ), array(), URE\_VERSION, true ); |
| [520](#L520) | wp\_enqueue\_script('ure-users-grant-roles'); |
| [521](#L521) | wp\_localize\_script('ure-users-grant-roles', 'ure\_users\_grant\_roles\_data', array( |
| [522](#L522) | 'wp\_nonce' => wp\_create\_nonce('user-role-editor'), |
| [523](#L523) | 'dialog\_title'=> esc\_html\_\_('Grant roles to selected users', 'user-role-editor'), |
| [524](#L524) | 'select\_users\_first' => esc\_html\_\_('Select users to which you wish to grant roles!', 'user-role-editor'), |
| [525](#L525) | 'select\_roles\_first' => esc\_html\_\_('Select role(s) which you wish to grant!', 'user-role-editor'), |
| [526](#L526) | 'select\_role\_first' => esc\_html\_\_('Select role first!', 'user-role-editor'), |
| [527](#L527) | 'select\_users\_to\_add\_role' => esc\_html\_\_('Select users to which you wish to add role!', 'user-role-editor'), |
| [528](#L528) | 'select\_users\_to\_revoke\_role' => esc\_html\_\_('Select users from which you wish revoke role!', 'user-role-editor'), |
| [529](#L529) | 'show\_wp\_change\_role' => $show\_wp\_change\_role ? 1: 0 |
| [530](#L530) | )); |
| [531](#L531) | } |
| [532](#L532) | // end of load\_js() |
| [533](#L533) |  |
| [534](#L534) | } |
| [535](#L535) | // end of URE\_Grant\_Roles class |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/user-role-editor/trunk/includes/classes/grant-roles.php?format=txt)
* [Original Format](/export/3222468/user-role-editor/trunk/includes/classes/grant-roles.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_46506db1_20250114_203957.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# User Role Editor <= 4.64.3 - Cross-Site Request Forgery to Privilege Escalation

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   User Role Editor <= 4.64.3 - Cross-Site Request Forgery to Privilege Escalation

8.8

**Cross-Site Request Forgery (CSRF)**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-12293](https://www.cve.org/CVERecord?id=CVE-2024-12293) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | December 16, 2024 |
| Last Updated | December 17, 2024 |
| Researcher | [vgo0](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/dale-mavers) |

### Description

The User Role Editor plugin for WordPress is vulnerable to Cross-Site Request Forgery in all versions up to, and including, 4.64.3. This is due to missing or incorrect nonce validation on the update\_roles() function. This makes it possible for unauthenticated attackers to add or remove roles for arbitrary users, including escalating their privileges to administrator, via a forged request granted they can trick a site administrator into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/user-role-editor/trunk/includes/classes/grant-roles.php#L184)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/user-role-editor/trunk/includes/classes/grant-roles.php#L187)
* [wordpress.org](https://wordpress.org/plugins/user-role-editor/#developers)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3208193/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fuser-role-editor%2Fuser-role-editor-4643-cross-site-request-forgery-to-privilege-escalation&t=User%20Role%20Editor%20%3C%3D%204.64.3%20-%20Cross-Site%20Request%20Forgery%20to%20Privilege%20Escalation "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fuser-role-editor%2Fuser-role-editor-4643-cross-site-request-forgery-to-privilege-escalation&text=User%20Role%20Editor%20%3C%3D%204.64.3%20-%20Cross-Site%20Request%20Forgery%20to%20Privilege%20Escalation "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fuser-role-editor%2Fuser-role-editor-4643-cross-site-request-forgery-to-privilege-escalation "LinkedIn")
Email

## Vulnerability Details for User Role Editor

#### [User Role Editor](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/user-role-editor)

| Software Type | Plugin |
| --- | --- |
| Software Slug | user-role-editor [(view on wordpress.org)](https://wordpress.org/plugins/user-role-editor) |
| Patched? | Yes |
| Remediation | Update to version 4.64.4, or a newer patched version |
| Affected Version | * <= 4.64.3 |
| Patched Version | * 4.64.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_e54454de_20250114_203953.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3208193)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3208192 "Changeset 3208192")
* [Next Changeset](/changeset/3208194 "Changeset 3208194") →

---

# Changeset 3208193

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
12/15/2024 01:40:58 PM
([4 weeks](/timeline?from=2024-12-15T13%3A40%3A58Z&precision=second "See timeline at 12/15/2024 01:40:58 PM") ago)

Author:
shinephp
Message:

set v. 4.64.4

File:

1 edited

* [user-role-editor/trunk/user-role-editor.php](/browser/user-role-editor/trunk/user-role-editor.php?rev=3208193 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [user-role-editor/trunk/user-role-editor.php](/changeset/3208193/user-role-editor/trunk/user-role-editor.php "Show the changeset 3208193 restricted to user-role-editor/trunk/user-role-editor.php")

  | [r3201795](/browser/user-role-editor/trunk/user-role-editor.php?rev=3201795#L4 "Show revision 3201795 of this file in browser") | [r3208193](/browser/user-role-editor/trunk/user-role-editor.php?rev=3208193#L4 "Show revision 3208193 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://www.role-editor.com |
  | 5 | 5 | Description: Change/add/delete WordPress user roles and capabilities. |
  | 6 |  | Version: 4.64.~~3~~ |
  |  | 6 | Version: 4.64.4 |
  | 7 | 7 | Author: Vladimir Garagulya |
  | 8 | 8 | Author URI: https://www.role-editor.com |
  | […](/browser/user-role-editor/trunk/user-role-editor.php?rev=3201795#L30) | […](/browser/user-role-editor/trunk/user-role-editor.php?rev=3208193#L30) |  |
  | 30 | 30 | } |
  | 31 | 31 |  |
  | 32 |  | define( 'URE\_VERSION', '4.64.~~3~~' ); |
  |  | 32 | define( 'URE\_VERSION', '4.64.4' ); |
  | 33 | 33 | define( 'URE\_PLUGIN\_URL', plugin\_dir\_url( \_\_FILE\_\_ ) ); |
  | 34 | 34 | define( 'URE\_PLUGIN\_DIR', plugin\_dir\_path( \_\_FILE\_\_ ) ); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3208193)
* [Zip Archive](?format=zip&new=3208193)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from wordpress.org_cc6f83a8_20250114_203955.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

User Role Editor

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fuser-role-editor&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fuser-role-editor&locale=en_US)

Search plugins

![](https://ps.w.org/user-role-editor/assets/banner-772x250.png?rev=1263116)
![](https://ps.w.org/user-role-editor/assets/icon-256x256.jpg?rev=1020390)
# User Role Editor

By [Vladimir Garagulya](https://www.role-editor.com)

[Download](https://downloads.wordpress.org/plugin/user-role-editor.4.64.4.zip)
[Live Preview](https://wordpress.org/plugins/user-role-editor/?preview=1)

* [Details](https://wordpress.org/plugins/user-role-editor/#description)
* [Reviews](https://wordpress.org/plugins/user-role-editor/#reviews)
* [Installation](https://wordpress.org/plugins/user-role-editor/#installation)
* [Development](https://wordpress.org/plugins/user-role-editor/#developers)

[Support](https://wordpress.org/support/plugin/user-role-editor/)

## Description

User Role Editor WordPress plugin allows you to change user roles and capabilities easy.

Just turn on check boxes of capabilities you wish to add to the selected role and click “Update” button to save your changes. That’s done.

Add new roles and customize its capabilities according to your needs, from scratch of as a copy of other existing role.

Unnecessary self-made role can be deleted if there are no users whom such role is assigned.

Role assigned every new created user by default may be changed too.

Capabilities could be assigned on per user basis. Multiple roles could be assigned to user simultaneously.

You can add new capabilities and remove unnecessary capabilities which could be left from uninstalled plugins.

Multi-site support is provided.

Try it out on your free TasteWP [test site](https://demo.tastewp.com/user-role-editor).

To read more about ‘User Role Editor’ visit [this page](http://www.shinephp.com/user-role-editor-wordpress-plugin/) at [shinephp.com](http://shinephp.com)

Do you need more functionality with quality support in a real time? Do you wish to remove advertisements from User Role Editor pages?

[Buy Pro version](https://www.role-editor.com).

[User Role Editor Pro](https://www.role-editor.com) includes extra modules:

* Block selected admin menu items for role.
* Hide selected front-end menu items for no logged-in visitors, logged-in users, roles.
* Block selected widgets under “Appearance” menu for role.
* Show widgets at front-end for selected roles.
* Block selected meta boxes (dashboard, posts, pages, custom post types) for role.
* “Export/Import” module. You can export user role to the local file and import it to any WordPress site or other sites of the multi-site WordPress network.
* Roles and Users permissions management via Network Admin for multisite configuration. One click Synchronization to the whole network.
* “Other roles access” module allows to define which other roles user with current role may see at WordPress: dropdown menus, e.g assign role to user editing user profile, etc.
* Manage user access to editing posts/pages/custom post type using posts/pages, authors, taxonomies ID list.
* Per plugin users access management for plugins activate/deactivate operations.
* Per form users access management for Gravity Forms plugin.
* Shortcode to show enclosed content to the users with selected roles only.
* Posts and pages view restrictions for selected roles.
* Admin back-end pages permissions viewer

Pro version is advertisement free. Premium support is included.

### Additional Documentation

You can find more information about “User Role Editor” plugin at [this page](http://www.shinephp.com/user-role-editor-wordpress-plugin/)

I am ready to answer on your questions about plugin usage. Use [plugin page comments](http://www.shinephp.com/user-role-editor-wordpress-plugin/) for that.

## Screenshots

* [![](https://ps.w.org/user-role-editor/trunk/screenshot-1.png?rev=3208200)](https://ps.w.org/user-role-editor/trunk/screenshot-1.png?rev=3208200)

  screenshot-1.png User Role Editor main form
* [![](https://ps.w.org/user-role-editor/trunk/screenshot-2.png?rev=3208200)](https://ps.w.org/user-role-editor/trunk/screenshot-2.png?rev=3208200)

  screenshot-2.png Add/Remove roles or capabilities
* [![](https://ps.w.org/user-role-editor/trunk/screenshot-3.png?rev=3208200)](https://ps.w.org/user-role-editor/trunk/screenshot-3.png?rev=3208200)

  screenshot-3.png User Capabilities link
* [![](https://ps.w.org/user-role-editor/trunk/screenshot-4.png?rev=3208200)](https://ps.w.org/user-role-editor/trunk/screenshot-4.png?rev=3208200)

  screenshot-4.png User Capabilities Editor
* [![](https://ps.w.org/user-role-editor/trunk/screenshot-5.png?rev=3208200)](https://ps.w.org/user-role-editor/trunk/screenshot-5.png?rev=3208200)

  screenshot-5.png Bulk change role for users without roles
* [![](https://ps.w.org/user-role-editor/trunk/screenshot-6.png?rev=3208200)](https://ps.w.org/user-role-editor/trunk/screenshot-6.png?rev=3208200)

  screenshot-6.png Assign multiple roles to the selected users

## Installation

Installation procedure:

1. Deactivate plugin if you have the previous version installed.
2. Extract “user-role-editor.zip” archive content to the “/wp-content/plugins/user-role-editor” directory.
3. Activate “User Role Editor” plugin via ‘Plugins’ menu in WordPress admin menu.
4. Go to the “Users”-“User Role Editor” menu item and change your WordPress standard roles capabilities according to your needs.

## FAQ

* Does it work with WordPress in multi-site environment?

  Yes, it works with WordPress multi-site. By default plugin works for every blog from your multi-site network as for locally installed blog.

  To update selected role globally for the Network you should turn on the “Apply to All Sites” checkbox. You should have superadmin privileges to use User Role Editor under WordPress multi-site.

  Pro version allows to manage roles of the whole network from the Netwok Admin.

To read full FAQ section visit [this page](http://www.shinephp.com/user-role-editor-wordpress-plugin/#faq) at <shinephp.com>.

## Reviews

![](https://secure.gravatar.com/avatar/b09e2979dec4a0c4df7d94f6af851014b597d26120ea2a977ec064300059071f?s=60&d=retro&r=g)
### [Plugin works great!](https://wordpress.org/support/topic/plugin-works-great-90/)

[LambrosHatzini](https://profiles.wordpress.org/lambroshatzini/ "Posts by LambrosHatzini")
November 6, 2024

I’ve tried two other plugins to no avail. This one works great!

![](https://secure.gravatar.com/avatar/6c233d3417c6ba598706df9037a02d626e33fabb9b67cae44f6e48a665f681c6?s=60&d=retro&r=g)
### [sadly give](https://wordpress.org/support/topic/sadly-give/)

[cicavizio](https://profiles.wordpress.org/cicavizio/ "Posts by cicavizio")
September 29, 2024

its set several user role randomly, and sadly the uninstall didnt fix

![](https://secure.gravatar.com/avatar/58bb8e49b57a1f2b9752ef738a565f9137016d0b04ee895d0d291069a1738dab?s=60&d=retro&r=g)
### [Broke my entire multisite](https://wordpress.org/support/topic/broke-my-entire-multisite/)

[RonnyDee](https://profiles.wordpress.org/ronnydee/ "Posts by RonnyDee")
September 25, 2024

Congratulations on this plugin. This destroyed my entire WP Multisite, so that the registration process could no longer assign the created websites to any user.
There was no way to fix this error. Really great. Maybe you should think about how you can better a) save changes and b) restore them BEFORE you make any changes at all.
A plugin like this should almost be banned!

![](https://secure.gravatar.com/avatar/d5d85d79f79baba4f5b9a619c51000a67c90c4a228473a9b3d30773859ec200e?s=60&d=retro&r=g)
### [Best user role editing plugin](https://wordpress.org/support/topic/best-user-role-editing-plugin/)

[skylabb](https://profiles.wordpress.org/skylabb/ "Posts by skylabb")
September 18, 2024

I like the simplicity of the UI making it easy to edit user roles.

![](https://secure.gravatar.com/avatar/d6f8fe5129239afab19f0fd83e2ff7f24552444eaaca73b16f05f235bb6d3cac?s=60&d=retro&r=g)
### [Works for me](https://wordpress.org/support/topic/works-for-me-476/)

[aaronlkh](https://profiles.wordpress.org/aaronlkh/ "Posts by aaronlkh")
September 18, 2024

Used the free version and worked well for me. Thanks developer!

![](https://secure.gravatar.com/avatar/6a2df0264db06347352c8e684c985048f284e997dce4e18ecaf2b4c079b04aad?s=60&d=retro&r=g)
### [Does not appear to copy role 100%](https://wordpress.org/support/topic/does-not-appear-to-copy-role-100/)

[Rowland](https://profiles.wordpress.org/jollyroger99/ "Posts by Rowland")
April 9, 2024
1 reply

If a user has shop manager rights, I use ure to copy the role to a new role name, the user with the new role does not have the same rights as shop manager. Moving the user back to shop manager restores their rights ?

[Read all 283 reviews](https://wordpress.org/support/plugin/user-role-editor/reviews/)
## Contributors & Developers

“User Role Editor” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/5885f2ba31c290757d4e756971436b971adde9b0c95aae93b27bd93ac2fa8407?s=32&d=mm&r=g) [Vladimir Garagulya](https://profiles.wordpress.org/shinephp/)

“User Role Editor” has been translated into 26 locales. Thank you to [the translators](https://translate.wordpress.org/projects/wp-plugins/user-role-editor/contributors) for their contributions.

[Translate “User Role Editor” into your language.](https://translate.wordpress.org/projects/wp-plugins/user-role-editor)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/user-role-editor/), check out the [SVN repository](https://plugins.svn.wordpress.org/user-role-editor/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/user-role-editor/) by [RSS](https://plugins.trac.wordpress.org/log/user-role-editor/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### [4.64.4] 15.12.2024

* Security Fix: Users – “Add Role”, “Revoke Role” buttons: Cross-Site request forgery to privilege escalation was possible due to missed nonce validation. This issue was discovered and responsibly reported by vgo0.

#### [4.64.3] 03.12.2024

* Update: Marked as compatible with WordPress 6.7.1
* Fix: PHP Notice: “Function \_load\_textdomain\_just\_in\_time was called incorrectly. Translation loading for the `user-role-editor` domain was triggered too early.” was fixed (shown only for those who used own .mo translation file installed).
* Fix: Miscellaneous translation functionality (l18n) usage enhancements were applied.

File changelog.txt contains the full list of changes.

## Meta

* Version **4.64.4**
* Last updated **1 month ago**
* Active installations **700,000+**
* WordPress version **4.4 or higher**
* Tested up to **6.7.1**
* PHP version **7.3 or higher**
* Languages
  See all 27

  Close

  [Arabic](https://ar.wordpress.org/plugins/user-role-editor/), [Chinese (China)](https://cn.wordpress.org/plugins/user-role-editor/), [Chinese (Taiwan)](https://tw.wordpress.org/plugins/user-role-editor/), [Czech](https://cs.wordpress.org/plugins/user-role-editor/), [Dutch](https://nl.wordpress.org/plugins/user-role-editor/), [Dutch (Belgium)](https://nl-be.wordpress.org/plugins/user-role-editor/), [English (Australia)](https://en-au.wordpress.org/plugins/user-role-editor/), [English (Canada)](https://en-ca.wordpress.org/plugins/user-role-editor/), [English (New Zealand)](https://en-nz.wordpress.org/plugins/user-role-editor/), [English (South Africa)](https://en-za.wordpress.org/plugins/user-role-editor/), [English (UK)](https://en-gb.wordpress.org/plugins/user-role-editor/), [English (US)](https://wordpress.org/plugins/user-role-editor/), [French (France)](https://fr.wordpress.org/plugins/user-role-editor/), [German](https://de.wordpress.org/plugins/user-role-editor/), [Hebrew](https://he.wordpress.org/plugins/user-role-editor/), [Italian](https://it.wordpress.org/plugins/user-role-editor/), [Japanese](https://ja.wordpress.org/plugins/user-role-editor/), [Korean](https://ko.wordpress.org/plugins/user-role-editor/), [Polish](https://pl.wordpress.org/plugins/user-role-editor/), [Russian](https://ru.wordpress.org/plugins/user-role-editor/), [Spanish (Chile)](https://cl.wordpress.org/plugins/user-role-editor/), [Spanish (Colombia)](https://es-co.wordpress.org/plugins/user-role-editor/), [Spanish (Mexico)](https://es-mx.wordpress.org/plugins/user-role-editor/), [Spanish (Spain)](https://es.wordpress.org/plugins/user-role-editor/), [Spanish (Venezuela)](https://ve.wordpress.org/plugins/user-role-editor/), [Swedish](https://sv.wordpress.org/plugins/user-role-editor/), and [Turkish](https://tr.wordpress.org/plugins/user-role-editor/).

  [Translate into your language](https://translate.wordpress.org/projects/wp-plugins/user-role-editor)
* Tags [access](https://wordpress.org/plugins/tags/access/)[editor](https://wordpress.org/plugins/tags/editor/)[role](https://wordpress.org/plugins/tags/role/)[security](https://wordpress.org/plugins/tags/security/)[user](https://wordpress.org/plugins/tags/user/)
* [Advanced View](https://wordpress.org/plugins/user-role-editor/advanced/)

## Ratings

4.6 out of 5 stars.

* [241 5-star reviews
  5 stars

  241](https://wordpress.org/support/plugin/user-role-editor/reviews/?filter=5)
* [10 4-star reviews
  4 stars

  10](https://wordpress.org/support/plugin/user-role-editor/reviews/?filter=4)
* [6 3-star reviews
  3 stars

  6](https://wordpress.org/support/plugin/user-role-editor/reviews/?filter=3)
* [3 2-star reviews
  2 stars

  3](https://wordpress.org/support/plugin/user-role-editor/reviews/?filter=2)
* [23 1-star reviews
  1 star

  23](https://wordpress.org/support/plugin/user-role-editor/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/user-role-editor/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/user-role-editor/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/5885f2ba31c290757d4e756971436b971adde9b0c95aae93b27bd93ac2fa8407?s=32&d=mm&r=g) [Vladimir Garagulya](https://profiles.wordpress.org/shinephp/)
## Support

Issues resolved in last two months:

2 out of 12

[View support forum](https://wordpress.org/support/plugin/user-role-editor/)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


