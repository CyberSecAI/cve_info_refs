=== Content from www.wordfence.com_40404af9_20250114_223039.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Peter’s Custom Anti-Spam <= 3.2.3 - Cross-Site Request Forgery via cas\_register\_post Function

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Peter’s Custom Anti-Spam <= 3.2.3 - Cross-Site Request Forgery via cas\_register\_post Function

5.4

**Cross-Site Request Forgery (CSRF)**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:L)

| CVE | [CVE-2024-12554](https://www.cve.org/CVERecord?id=CVE-2024-12554) |
| --- | --- |
| CVSS | 5.4 (Medium) |
| Publicly Published | December 17, 2024 |
| Last Updated | December 18, 2024 |
| Researcher | [SOPROBRO](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/soprobro-2) |

### Description

The Peter’s Custom Anti-Spam plugin for WordPress is vulnerable to Cross-Site Request Forgery in all versions up to, and including, 3.2.3. This is due to missing nonce validation on the cas\_register\_post() function. This makes it possible for unauthenticated attackers to blacklist emails via a forged request granted they can trick a site administrator into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php#L1081)
* [wordpress.org](https://wordpress.org/plugins/peters-custom-anti-spam-image/#developers)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3208894/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpeters-custom-anti-spam-image%2Fpeters-custom-anti-spam-323-cross-site-request-forgery-via-cas-register-post-function&t=Peter%E2%80%99s%20Custom%20Anti-Spam%20%3C%3D%203.2.3%20-%20Cross-Site%20Request%20Forgery%20via%20cas_register_post%20Function "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpeters-custom-anti-spam-image%2Fpeters-custom-anti-spam-323-cross-site-request-forgery-via-cas-register-post-function&text=Peter%E2%80%99s%20Custom%20Anti-Spam%20%3C%3D%203.2.3%20-%20Cross-Site%20Request%20Forgery%20via%20cas_register_post%20Function "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpeters-custom-anti-spam-image%2Fpeters-custom-anti-spam-323-cross-site-request-forgery-via-cas-register-post-function "LinkedIn")
Email

## Vulnerability Details for Peter’s Custom Anti-Spam

#### [Peter’s Custom Anti-Spam](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/peters-custom-anti-spam-image)

| Software Type | Plugin |
| --- | --- |
| Software Slug | peters-custom-anti-spam-image [(view on wordpress.org)](https://wordpress.org/plugins/peters-custom-anti-spam-image) |
| Patched? | Yes |
| Remediation | Update to version 3.2.4, or a newer patched version |
| Affected Version | * <= 3.2.3 |
| Patched Version | * 3.2.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from wordpress.org_1eb2923c_20250114_223038.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

Peter’s Custom Anti-Spam

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fpeters-custom-anti-spam-image&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fpeters-custom-anti-spam-image&locale=en_US)

Search plugins

This plugin **hasn’t been tested with the latest 3 major releases of WordPress**. It may no longer be maintained or supported and may have compatibility issues when used with more recent versions of WordPress.

![](https://s.w.org/plugins/geopattern-icon/peters-custom-anti-spam-image.svg)
# Peter’s Custom Anti-Spam

By [Peter Keung](https://www.theblog.ca/)

[Download](https://downloads.wordpress.org/plugin/peters-custom-anti-spam-image.zip)

* [Details](https://wordpress.org/plugins/peters-custom-anti-spam-image/#description)
* [Reviews](https://wordpress.org/plugins/peters-custom-anti-spam-image/#reviews)
* [Installation](https://wordpress.org/plugins/peters-custom-anti-spam-image/#installation)
* [Development](https://wordpress.org/plugins/peters-custom-anti-spam-image/#developers)

[Support](https://wordpress.org/support/plugin/peters-custom-anti-spam-image/)

## Description

Stop a lot of spambots from polluting your site by making visitors identify a random word displayed as an image before commenting and optionally before registering. You can customize the pool of words to display.

#### Features

* Toggle whether registered users need to enter the word
* Random font display
* No cookies required
* No JavaScript required
* Auto-generated audio for visually impaired users
* Easy-to-read
* No mapping of words from the code — words are used once or removed after 24 hours
* Reminder of what was entered if you get the word wrong
* Selective blocking of trackbacks, pingbacks
* Easy to translate
* Compatible with caching plugins

#### Negatives

* Purposely no obscuring techniques so that the anti-spam word is easy to read
* The more people who use this plugin, the more motivation for spambots to target it

#### Requirements

* GD Library and FreeType Library (There’s a diagnostic page to tell you whether you have them installed. If needed, just ask your web host to install them!)
* WordPress 3.2 or higher

#### Translations

* ru\_RU translation by koc
* sk\_SK translation by Patrik Žec (PATWIST) of http://patwist.com

## Installation

Unzip all files to the folder custom-anti-spam in your plugins directory, so that the path is wp-content/plugins/custom-anti-spam/. Then activate the plugin via your WordPress admin section. The plugin should work directly “out of the box”, but all settings can be customized in the Settings > Custom anti-spam page in your WordPress control panel. If you are upgrading from a previous release, de-activate that release first.

## FAQ

Please visit the plugin page at https://www.theblog.ca/anti-spam with any questions.

## Reviews

There are no reviews for this plugin.

## Contributors & Developers

“Peter’s Custom Anti-Spam” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/6e9bf97d706349b9904648649ffa224cf0c141262b42d1afe5d62ec75fcc87fa?s=32&d=mm&r=g)

[Translate “Peter’s Custom Anti-Spam” into your language.](https://translate.wordpress.org/projects/wp-plugins/peters-custom-anti-spam-image)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/peters-custom-anti-spam-image/), check out the [SVN repository](https://plugins.svn.wordpress.org/peters-custom-anti-spam-image/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/peters-custom-anti-spam-image/) by [RSS](https://plugins.trac.wordpress.org/log/peters-custom-anti-spam-image/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### 3.2.4

* 2024-12-16: Fix CSRF vulnerability on register

#### 3.2.3

* 2023-08-30: Fix back-end XSS vulnerability

#### 3.2.2

* 2014-02-08: Minor code cleanup (thanks koc!)

#### 3.2.1

* 2013-10-07: Support PHP 5 static function calls, bumping WordPress requirement to 3.2+.

#### 3.2.0

* 2013-03-30: Add dynamic anti-spam field name. Also: standardize translation and upgrade process.

## Meta

* Version **3.2.4**
* Last updated **4 weeks ago**
* Active installations **300+**
* WordPress version **3.2 or higher**
* Tested up to **6.3.5**
* Tags [anti-spam](https://wordpress.org/plugins/tags/anti-spam/)[captcha](https://wordpress.org/plugins/tags/captcha/)[comments](https://wordpress.org/plugins/tags/comments/)[spam](https://wordpress.org/plugins/tags/spam/)
* [Advanced View](https://wordpress.org/plugins/peters-custom-anti-spam-image/advanced/)

## Ratings

4 out of 5 stars.

* [0 5-star reviews
  5 stars

  0](https://wordpress.org/support/plugin/peters-custom-anti-spam-image/reviews/?filter=5)
* [1 4-star review
  4 stars

  1](https://wordpress.org/support/plugin/peters-custom-anti-spam-image/reviews/?filter=4)
* [0 3-star reviews
  3 stars

  0](https://wordpress.org/support/plugin/peters-custom-anti-spam-image/reviews/?filter=3)
* [0 2-star reviews
  2 stars

  0](https://wordpress.org/support/plugin/peters-custom-anti-spam-image/reviews/?filter=2)
* [0 1-star reviews
  1 star

  0](https://wordpress.org/support/plugin/peters-custom-anti-spam-image/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/peters-custom-anti-spam-image/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/peters-custom-anti-spam-image/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/6e9bf97d706349b9904648649ffa224cf0c141262b42d1afe5d62ec75fcc87fa?s=32&d=mm&r=g) [Peter](https://profiles.wordpress.org/pkthree/)
## Support

Got something to say? Need help?

[View support forum](https://wordpress.org/support/plugin/peters-custom-anti-spam-image/)

## Donate

Would you like to support the advancement of this plugin?

[Donate to this plugin](https://www.theblog.ca)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_318196ed_20250114_223035.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fpeters-custom-anti-spam-image%2Ftrunk%2Fcustom_anti_spam.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?rev=2960936 "Revision 2960936")
* Next Revision →
* [Blame](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/peters-custom-anti-spam-image/trunk/custom_anti_spam.php)

---

# [source:](/browser?order=name "Go to repository root") [peters-custom-anti-spam-image](/browser/peters-custom-anti-spam-image?order=name "View peters-custom-anti-spam-image")/[trunk](/browser/peters-custom-anti-spam-image/trunk?order=name "View trunk")/[custom\_anti\_spam.php](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?order=name "View custom_anti_spam.php")

View diff against:

View revision:

| [Last change](/changeset/3208894/peters-custom-anti-spam-image/trunk/custom_anti_spam.php "View differences") on this file was [3208894](/changeset/3208894/ "View changeset 3208894"), checked in by pkthree, [4 weeks ago](/timeline?from=2024-12-17T05%3A49%3A08Z&precision=second "See timeline at 12/17/2024 05:49:08 AM") |
| --- |
| Peter's Custom Anti-Spam Image Version 3.2.4 |
| **File size:** 59.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: Peter's Custom Anti-Spam |
| [4](#L4) | Plugin URI: https://www.theblog.ca/anti-spam |
| [5](#L5) | Description: Stop a lot of spambots from polluting your site by making visitors identify a random word displayed as an image before commenting. You can customize the pool of words to display. |
| [6](#L6) | Author: Peter Keung |
| [7](#L7) | Version: 3.2.4 |
| [8](#L8) | Author URI: https://www.theblog.ca/ |
| [9](#L9) | Change Log: |
| [10](#L10) | 2024-12-16  Version 3.2.4  Fix CSRF vulnerability on register |
| [11](#L11) | 2023-08-30  Version 3.2.3  Fix back-end XSS vulnerability |
| [12](#L12) | 2014-02-08  Version 3.2.2  Minor code cleanup (thanks koc!) |
| [13](#L13) | 2013-10-07  Version 3.2.1  Support PHP 5 static function calls, bumping WordPress requirement to 3.2+. |
| [14](#L14) | 2013-03-30  Version 3.2.0  Add dynamic anti-spam field name. Also: standardize translation and upgrade process. |
| [15](#L15) | 2010-08-02  Version 3.1.4  Minor code tweak for WordPress 3.0. |
| [16](#L16) | 2008-12-10  Version 3.1.3  Minor tweak to the automatic JavaScript positioning to account for labels for the comment textarea (thanks Midwestern City Boy!). |
| [17](#L17) | 2008-12-04  Version 3.1.2  The plugin will now bypass the anti-spam check if a comment is posted from within the WordPress back-end (thanks steveegg!). |
| [18](#L18) | 2008-11-16  Version 3.1.1  Added a setting for compatibility with various WordPress caching plugins. When the setting is enabled, the anti-spam URL is dynamically pulled via JavaScript (and is thus not cached). |
| [19](#L19) | 2008-11-05  Version 3.1.0  Implemented a user interface for modifying settings (see Settings > Custom anti-spam) so that almost all settings are now handled through the WordPress back-end interface. Modified JavaScript so that the anti-spam image attaches itself above the comment form for logged in users. |
| [20](#L20) | 2008-08-02  Version 3.0.7  Added a setting $cas\_wpconfig for the absolute path to wp-config.php for WordPress 2.6+ users who have moved either wp-config.php or the wp-content folder from the default locations. |
| [21](#L21) | 2008-05-31  Version 3.0.6  Fixed the registration form protection for WordPress 2.5. Pre-WordPress 2.5 users who want to use the registration form protection must use Version 3.0.5 of this plugin or lower. |
| [22](#L22) | 2008-05-24  Version 3.0.5  For efficiency reasons, image and audio generation is now run directly through this file. |
| [23](#L23) | 2008-05-05  Version 3.0.4  The list of anti-spam words is now in a separate file and manageable through the Manage > Custom anti-spam page. |
| [24](#L24) | 2008-04-03  Version 3.0.3  Made the folder name of fonts and sounds customizable. The plugin is now tested to be compatible with WordPress MU. See http://www.theblog.ca/anti-spam-mu (thanks Clay!). |
| [25](#L25) | 2008-03-13  Version 3.0.2  Minor code tweak to be compatible with WordPress 2.5. |
| [26](#L26) | 2008-02-10  Version 3.0.1  New option to disable random stretching of the wav files. Made the operation to stretch the wav files silent to the server(thanks Angelo!). Blocked indexing of audio file links by search engines (thanks Lucky!). |
| [27](#L27) | 2008-01-20  Version 3.0.0  Added registration form protection and a corresponding e-mail blacklist. To enable registration form protection, set $cas\_reg\_protection equal to "true". Also tweaked the audio file generation with wav files to be more robust against spambots. |
| [28](#L28) |  |
| [29](#L29) | View all previous change items at https://www.theblog.ca/anti-spam-history |
| [30](#L30) | \*/ |
| [31](#L31) |  |
| [32](#L32) | if( file\_exists( 'custom\_anti\_spam.php' ) && empty( $\_GET ) ) |
| [33](#L33) | { |
| [34](#L34) | die( 'nothing to see' ); |
| [35](#L35) | } |
| [36](#L36) |  |
| [37](#L37) | // Leave this as FALSE unless you have moved wp-config.php or the wp-content folder to a non-default location |
| [38](#L38) | // If so, change this to be the absolute or relative path to your wp-config.php file |
| [39](#L39) | $cas\_wpconfig = false; |
| [40](#L40) |  |
| [41](#L41) | // ------------------------------------------------- |
| [42](#L42) | // ALL WORDS AND SETTINGS ARE NOW CUSTOMIZED IN THE WORDPRESS ADMIN PANEL |
| [43](#L43) | // LOOK UNDER SETTINGS > CUSTOM ANTI-SPAM |
| [44](#L44) | // ------------------------------------------------- |
| [45](#L45) |  |
| [46](#L46) | // If you are calling the plugin file directly, include the file that contains important db functions |
| [47](#L47) | if ( ( isset($\_GET['antiselect']) || isset($\_GET['audioselect']) || isset($\_GET['antinew']) ) && file\_exists('custom\_anti\_spam.php')) { |
| [48](#L48) | if ($cas\_wpconfig) { |
| [49](#L49) | include\_once $cas\_wpconfig; |
| [50](#L50) | } |
| [51](#L51) | else { |
| [52](#L52) | include\_once '../../../wp-config.php'; |
| [53](#L53) | } |
| [54](#L54) | } |
| [55](#L55) |  |
| [56](#L56) |  |
| [57](#L57) | // Enable translations |
| [58](#L58) | function cas\_textdomain() |
| [59](#L59) | { |
| [60](#L60) | load\_plugin\_textdomain( 'peters\_custom\_anti\_spam', false, dirname( plugin\_basename(\_\_FILE\_\_) ) ); |
| [61](#L61) | } |
| [62](#L62) | add\_action( 'plugins\_loaded', 'cas\_textdomain' ); |
| [63](#L63) |  |
| [64](#L64) | global $wpdb; // Must be global for WordPress 2.5 |
| [65](#L65) |  |
| [66](#L66) | // Define the path to the plugin |
| [67](#L67) | $cas\_folder = str\_replace('\\', '/', dirname(\_\_FILE\_\_)); |
| [68](#L68) | $cas\_thisfolder = explode('/', $cas\_folder); |
| [69](#L69) |  |
| [70](#L70) | global $cas\_pluginpath; // Must be global for WordPress 2.5 |
| [71](#L71) | $cas\_pluginpath =  $cas\_folder. '/'; |
| [72](#L72) |  |
| [73](#L73) | // Folder that the fonts are held in, relative to this file. Include a trailing slash |
| [74](#L74) | $cas\_fontpath = 'fonts/'; |
| [75](#L75) |  |
| [76](#L76) | // Folder that the sounds are held in, relative to this file. Include a trailing slash. |
| [77](#L77) | $cas\_soundpath = 'sounds/'; |
| [78](#L78) |  |
| [79](#L79) | global $cas\_table; // Must be global for WordPress 2.5 |
| [80](#L80) | global $cas\_tablename; // Must be global for WordPress 2.5 |
| [81](#L81) | // Name of the table that holds all the anti-spam words |
| [82](#L82) | $cas\_tablename = 'cas\_image'; |
| [83](#L83) | $cas\_table = $wpdb->prefix . $cas\_tablename; |
| [84](#L84) |  |
| [85](#L85) | global $cas\_count; // Must be global for WordPress 2.5 |
| [86](#L86) | global $cas\_countname; // Must be global for WordPress 2.5 |
| [87](#L87) | // Name of the table that holds the count for the anti-spam words |
| [88](#L88) | $cas\_countname = 'cas\_count'; |
| [89](#L89) | $cas\_count = $wpdb->prefix . $cas\_countname; |
| [90](#L90) |  |
| [91](#L91) | global $cas\_version; |
| [92](#L92) | $cas\_version = '3.2.4'; |
| [93](#L93) |  |
| [94](#L94) | $cas\_text = casFunctionCollection::get\_settings( 'text' ); |
| [95](#L95) |  |
| [96](#L96) | // Determine how many words were entered |
| [97](#L97) | $cas\_textcount = count( $cas\_text ); |
| [98](#L98) | // Copy the first element to a new last element |
| [99](#L99) | $cas\_text[] = $cas\_text[0]; |
| [100](#L100) | // Set the first element to invalid |
| [101](#L101) | $cas\_text[0] = \_\_( '\* \* \* INVALID \* \* \*', 'peters\_custom\_anti\_spam' ); |
| [102](#L102) |  |
| [103](#L103) | // Output the antispam audio file |
| [104](#L104) | if( isset( $\_GET['audioselect'] ) ) |
| [105](#L105) | { |
| [106](#L106) | header( 'Cache-Control: max-age=0' ); |
| [107](#L107) | // Include the wav merging class |
| [108](#L108) | include $cas\_pluginpath . $cas\_soundpath . 'wav\_join.php'; |
| [109](#L109) |  |
| [110](#L110) | // Validate the input values |
| [111](#L111) | $cas\_audioselect = intval( $\_GET['audioselect'] ); |
| [112](#L112) |  |
| [113](#L113) | // Get the word from the database |
| [114](#L114) | $cas\_antispam = $wpdb->get\_var('SELECT word FROM ' . $cas\_table . ' WHERE id = ' . $cas\_audioselect); |
| [115](#L115) | if (is\_null($cas\_antispam)) |
| [116](#L116) | { |
| [117](#L117) | $cas\_string\_not\_valid = \_\_( 'That anti-spam number is no longer valid.', 'peters\_custom\_anti\_spam' ); |
| [118](#L118) | wp\_die( '<html><head><title>' . $cas\_string\_not\_valid . '</title><meta name="Robots" content="noindex,nofollow"></head><body>' . $cas\_string\_not\_valid . '</body></html>' ); |
| [119](#L119) | } |
| [120](#L120) |  |
| [121](#L121) | // Get the word |
| [122](#L122) | $petersword = strtolower($cas\_antispam); |
| [123](#L123) |  |
| [124](#L124) | // Strip out spaces and hyphens |
| [125](#L125) | $petersword = str\_replace(array('-',' '), array('',''), $petersword); |
| [126](#L126) |  |
| [127](#L127) | // Count the number of letters in the word |
| [128](#L128) | $word\_count = strlen($petersword); |
| [129](#L129) |  |
| [130](#L130) | // Write the function str\_split if it doesn't exist (in PHP 4) |
| [131](#L131) | if (!function\_exists('str\_split')) { |
| [132](#L132) | function str\_split($string) { |
| [133](#L133) | global $word\_count; |
| [134](#L134) | $letters = array(); |
| [135](#L135) | for ($i = 0; $i < $word\_count; ++$i) { |
| [136](#L136) | $letters[$i] = substr($string, $i, 1); |
| [137](#L137) | } |
| [138](#L138) | return $letters; |
| [139](#L139) | } |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | // Split the word into an array of individual letters |
| [143](#L143) | $cas\_wavs = str\_split($petersword); |
| [144](#L144) |  |
| [145](#L145) | // Merge the wav files for this word |
| [146](#L146) | $cas\_one\_wav = joinwavs($cas\_wavs); |
| [147](#L147) |  |
| [148](#L148) | // Create a temporary file for this word |
| [149](#L149) | $cas\_audioinput = tempnam($cas\_pluginpath, 'cas\_'); |
| [150](#L150) | $cas\_audiooutput = $cas\_audioinput . '1.wav'; |
| [151](#L151) | $cas\_handle=fopen($cas\_audioinput, "w"); |
| [152](#L152) | fwrite($cas\_handle, $cas\_one\_wav); |
| [153](#L153) | fclose($cas\_handle); |
| [154](#L154) |  |
| [155](#L155) | // Clear the variable out since the sound is now in a temporary file |
| [156](#L156) | unset($cas\_one\_wav); |
| [157](#L157) |  |
| [158](#L158) | $cas\_sox = casFunctionCollection::get\_settings( 'sox' ); |
| [159](#L159) | if( $cas\_sox ) |
| [160](#L160) | { |
| [161](#L161) | // Make use of the sox filter, if available, to make it hard for bots to crack the audio file |
| [162](#L162) |  |
| [163](#L163) | // This will determine a stretch factor with 20 different possibilities |
| [164](#L164) | $stretch\_random = sprintf("%02d", rand( 0, 20)); |
| [165](#L165) |  |
| [166](#L166) | // Stretch the audio file |
| [167](#L167) | @exec('sox ' . $cas\_audioinput . ' ' . $cas\_audiooutput . ' stretch 1.' . $stretch\_random . ' > /dev/null 2>&1'); |
| [168](#L168) | } |
| [169](#L169) |  |
| [170](#L170) | // If the sox filter was available, use the stretched file. Otherwise, use the original file |
| [171](#L171) | if (file\_exists($cas\_audiooutput)) { |
| [172](#L172) | $cas\_one\_wav = file\_get\_contents($cas\_audiooutput); |
| [173](#L173) | } |
| [174](#L174) | else { |
| [175](#L175) | $cas\_one\_wav = file\_get\_contents($cas\_audioinput); |
| [176](#L176) | } |
| [177](#L177) |  |
| [178](#L178) | // Spit it the file out to the browser |
| [179](#L179) | output('output.wav', $cas\_one\_wav); |
| [180](#L180) |  |
| [181](#L181) | // Delete the files |
| [182](#L182) | if (file\_exists($cas\_audioinput)) unlink($cas\_audioinput); |
| [183](#L183) | if (file\_exists($cas\_audiooutput)) unlink($cas\_audiooutput); |
| [184](#L184) |  |
| [185](#L185) | // Prevent any more display to the page |
| [186](#L186) | die(); |
| [187](#L187) | } |
| [188](#L188) |  |
| [189](#L189) | // Output the antispam image |
| [190](#L190) | elseif( isset( $\_GET['antiselect'] ) ) |
| [191](#L191) | { |
| [192](#L192) | header( 'Cache-Control: max-age=0' ); |
| [193](#L193) | // Pick a random font to use |
| [194](#L194) | $cas\_fontlist = casFunctionCollection::get\_settings( 'fontlist' ); |
| [195](#L195) | $cas\_font = $cas\_pluginpath . $cas\_fontpath . $cas\_fontlist[ rand( 0, count( $cas\_fontlist ) - 1 ) ]; |
| [196](#L196) |  |
| [197](#L197) | // Set the default colors for when random text colors are not selected |
| [198](#L198) | $cas\_bgcolorset = casFunctionCollection::get\_settings( 'bgcolorset' ); |
| [199](#L199) | if( $cas\_bgcolorset == 'white' ) |
| [200](#L200) | { |
| [201](#L201) | $cas\_textcolor = array( 0, 0, 255 ); // blue text |
| [202](#L202) | $cas\_bgcolor = array( 255, 255, 255); // white background |
| [203](#L203) | } |
| [204](#L204) | else |
| [205](#L205) | { |
| [206](#L206) | $cas\_textcolor = array( 255, 255, 255 ); // white text |
| [207](#L207) | $cas\_bgcolor = array( 0, 0, 0); // black background |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | // If selected, pick a random color for the antispam word text |
| [211](#L211) | $cas\_randomcolors = casFunctionCollection::get\_settings( 'randomcolors' ); |
| [212](#L212) | if( $cas\_randomcolors ) |
| [213](#L213) | { |
| [214](#L214) | $cas\_rand = rand( 0, 4 ); |
| [215](#L215) | switch( $cas\_bgcolorset ) |
| [216](#L216) | { |
| [217](#L217) | case "white": |
| [218](#L218) | $cas\_textcolorchoice[0] = array ( 0, 0, 255 ); // blue |
| [219](#L219) | $cas\_textcolorchoice[1] = array ( 0, 153, 0 ); // greenish |
| [220](#L220) | $cas\_textcolorchoice[2] = array ( 204, 0, 0 ); // reddish |
| [221](#L221) | $cas\_textcolorchoice[3] = array ( 203, 0, 154 ); // purplish |
| [222](#L222) | $cas\_textcolorchoice[4] = array ( 0, 0, 0 ); // black |
| [223](#L223) | $cas\_textcolor = $cas\_textcolorchoice[$cas\_rand]; |
| [224](#L224) | break; |
| [225](#L225) | default: |
| [226](#L226) | $cas\_textcolorchoice[0] = array ( 255, 255, 0 ); // yellow |
| [227](#L227) | $cas\_textcolorchoice[1] = array ( 0, 255, 255 ); // blueish |
| [228](#L228) | $cas\_textcolorchoice[2] = array ( 255, 153, 204 ); // pinkish |
| [229](#L229) | $cas\_textcolorchoice[3] = array ( 102, 255, 102 ); // greenish |
| [230](#L230) | $cas\_textcolorchoice[4] = array ( 255, 255, 255 ); // white |
| [231](#L231) | $cas\_textcolor = $cas\_textcolorchoice[$cas\_rand]; |
| [232](#L232) | break; |
| [233](#L233) | } |
| [234](#L234) | } |
| [235](#L235) |  |
| [236](#L236) | // Validate the input values |
| [237](#L237) | $cas\_antiselect = intval( $\_GET['antiselect'] ); |
| [238](#L238) |  |
| [239](#L239) | // Get the word from the database |
| [240](#L240) | $cas\_antispam = $wpdb->get\_var('SELECT word FROM ' . $cas\_table . ' WHERE id = ' . $cas\_antiselect); |
| [241](#L241) | if( is\_null( $cas\_antispam ) ) |
| [242](#L242) | { |
| [243](#L243) | $cas\_antispam = \_\_( '\* \* \* INVALID \* \* \*', 'peters\_custom\_anti\_spam' ); |
| [244](#L244) | } |
| [245](#L245) |  |
| [246](#L246) | // Start building the image |
| [247](#L247) | $cas\_imgwidth = casFunctionCollection::get\_settings( 'imgwidth' ); |
| [248](#L248) | $cas\_imgheight = casFunctionCollection::get\_settings( 'imgheight' ); |
| [249](#L249) | $cas\_image = @imagecreate( $cas\_imgwidth, $cas\_imgheight ) or die( \_\_( 'Cannot initialize new GD image stream', 'peters\_custom\_anti\_spam' ) ); |
| [250](#L250) | $cas\_bgcolor = imagecolorallocate( $cas\_image, $cas\_bgcolor[0], $cas\_bgcolor[1], $cas\_bgcolor[2] ); |
| [251](#L251) | $cas\_fontcolor = imagecolorallocate( $cas\_image, $cas\_textcolor[0], $cas\_textcolor[1], $cas\_textcolor[2] ); |
| [252](#L252) |  |
| [253](#L253) | // Check for freetype lib, if not found default to ugly built in capability using imagechar (Lee's mod) |
| [254](#L254) | // Also check that the chosen TrueType font is available |
| [255](#L255) | if( function\_exists( 'imagettftext' ) && file\_exists( $cas\_font ) ) |
| [256](#L256) | { |
| [257](#L257) | $cas\_angle = 4; // Degrees to tilt the text |
| [258](#L258) | $cas\_offset = 10; // Pixels to offset the text from the border |
| [259](#L259) | $cas\_fontsize = 28; // Default font size for the anti-spam image |
| [260](#L260) | $cas\_imagebox = imagettfbbox($cas\_fontsize, $cas\_angle, $cas\_font, $cas\_antispam); |
| [261](#L261) | $cas\_boxwidth = $cas\_imagebox[2] - $cas\_imagebox[0]; |
| [262](#L262) | $cas\_boxheight = $cas\_imagebox[1] - $cas\_imagebox[7]; |
| [263](#L263) |  |
| [264](#L264) | // if the text width is too big for the image, decrease the font size to a certain extent (best practice is of course not to use really long words! |
| [265](#L265) | while ($cas\_boxwidth > $cas\_imgwidth - $cas\_offset && $cas\_fontsize > 12) { |
| [266](#L266) | $cas\_fontsize = $cas\_fontsize - 3; |
| [267](#L267) | $cas\_imagebox = imagettfbbox($cas\_fontsize, $cas\_angle, $cas\_font, $cas\_antispam); |
| [268](#L268) | $cas\_boxwidth = $cas\_imagebox[2] - $cas\_imagebox[0]; |
| [269](#L269) | } |
| [270](#L270) |  |
| [271](#L271) | // if the text height too big for the image, decrease the font size to a certain extent (best practice is of course not to use really long words! |
| [272](#L272) | while ($cas\_boxheight > $cas\_imgheight - $cas\_offset && $cas\_fontsize > 12) { |
| [273](#L273) | $cas\_fontsize = $cas\_fontsize - 3; |
| [274](#L274) | $cas\_imagebox = imagettfbbox($cas\_fontsize, $cas\_angle, $cas\_font, $cas\_antispam); |
| [275](#L275) | $cas\_boxheight = $cas\_imagebox[1] - $cas\_imagebox[7]; |
| [276](#L276) | } |
| [277](#L277) |  |
| [278](#L278) | // Use png is available, since it produces clearer text images |
| [279](#L279) | $cas\_UsePngNotJpeg = casFunctionCollection::get\_settings( 'UsePngNotJpeg' ); |
| [280](#L280) | if( function\_exists( 'imagepng' ) && $cas\_UsePngNotJpeg ) |
| [281](#L281) | { |
| [282](#L282) | imagettftext( $cas\_image, $cas\_fontsize, $cas\_angle, $cas\_offset, $cas\_imgheight - $cas\_offset, $cas\_fontcolor, $cas\_font, $cas\_antispam ); |
| [283](#L283) | header( "Content-type: image/png" ); |
| [284](#L284) | imagepng( $cas\_image ); |
| [285](#L285) | } else { |
| [286](#L286) | imagettftext( $cas\_image, $cas\_fontsize, $cas\_angle, $cas\_offset, $cas\_imgheight - $cas\_offset, $cas\_fontcolor, $cas\_font, $cas\_antispam ); |
| [287](#L287) | header( "Content-type: image/jpeg" ); |
| [288](#L288) | imagejpeg( $cas\_image ); |
| [289](#L289) | } |
| [290](#L290) | } else { |
| [291](#L291) | $cas\_fontsize = 5; // 1, 2, 3, 4 or 5 (higher numbers correspond to larger font sizes) |
| [292](#L292) | $tmp\_len = strlen( $cas\_antispam ); |
| [293](#L293) | for( $tmp\_count = 0; $tmp\_count < $tmp\_len; $tmp\_count++ ) |
| [294](#L294) | { |
| [295](#L295) | $tmp\_xpos = $tmp\_count \* imagefontwidth( $cas\_fontsize ) + 20; |
| [296](#L296) | $tmp\_ypos = 10; |
| [297](#L297) | imagechar( $cas\_image, $cas\_fontsize, $tmp\_xpos, $tmp\_ypos, $cas\_antispam, $cas\_fontcolor ); |
| [298](#L298) | $cas\_antispam = substr( $cas\_antispam, 1); |
| [299](#L299) | } |
| [300](#L300) | header("Content-Type: image/gif"); |
| [301](#L301) | imagegif( $cas\_image ); |
| [302](#L302) | } // end if |
| [303](#L303) | imagedestroy( $cas\_image ); |
| [304](#L304) | die(); |
| [305](#L305) | } |
| [306](#L306) |  |
| [307](#L307) | // Generate a new anti-spam image when called by the user |
| [308](#L308) | elseif ( isset( $\_GET['antinew'] ) && casFunctionCollection::get\_settings( 'js\_generate' ) ) { |
| [309](#L309) |  |
| [310](#L310) | header( 'Cache-Control: max-age=0' ); |
| [311](#L311) |  |
| [312](#L312) | // Pick a random number |
| [313](#L313) | $cas\_antiselect = rand( 1, $cas\_textcount ); // 0 is for invalid, so don't select it |
| [314](#L314) |  |
| [315](#L315) | // Generate a new word |
| [316](#L316) | $cas\_antiword = $cas\_text[$cas\_antiselect]; |
| [317](#L317) |  |
| [318](#L318) | // Insert a row into the count database to generate an auto\_increment number |
| [319](#L319) | $wpdb->query('INSERT INTO ' . $cas\_count . ' (id) VALUES (NULL)'); |
| [320](#L320) |  |
| [321](#L321) | // Get the id of the inserted count to feed to the word table and image generator |
| [322](#L322) | $cas\_rowid = $wpdb->get\_var('SELECT last\_insert\_id()'); |
| [323](#L323) |  |
| [324](#L324) | $cas\_fieldname = md5( rand() ); |
| [325](#L325) |  |
| [326](#L326) | // Put the random word into the database |
| [327](#L327) | $wpdb->query('INSERT INTO ' . $cas\_table . ' (id, createtime, word, fieldname) VALUES (' . $cas\_rowid . ', ' . time() . ', \'' . $cas\_antiword . '\', \'' . $cas\_fieldname . '\')'); |
| [328](#L328) |  |
| [329](#L329) | // Delete the row from the count table |
| [330](#L330) | $wpdb->query('DELETE FROM ' . $cas\_count . ' WHERE id = ' . $cas\_rowid); |
| [331](#L331) |  |
| [332](#L332) | // Do some table admin while we can :D |
| [333](#L333) | if (strlen($cas\_rowid) == 10) { |
| [334](#L334) |  |
| [335](#L335) | // Delete all rows from the count table |
| [336](#L336) | $wpdb->query('DELETE FROM ' . $cas\_count); |
| [337](#L337) |  |
| [338](#L338) | // Reset the table's auto increment if it's getting too huge |
| [339](#L339) | $wpdb->query('ALTER TABLE ' . $cas\_count . ' AUTO\_INCREMENT=1'); |
| [340](#L340) |  |
| [341](#L341) | // Delete any anti-spam words more than a day old |
| [342](#L342) | $wpdb->query('DELETE FROM ' . $cas\_table . ' WHERE ' . time() . ' > createtime + 86400'); |
| [343](#L343) | } |
| [344](#L344) | // Output the number to send back to the user display |
| [345](#L345) | die( $cas\_rowid . '-' . $cas\_fieldname ); |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) |  |
| [349](#L349) | else { |
| [350](#L350) |  |
| [351](#L351) | // Determine the blog url to this script |
| [352](#L352) | $cas\_message = '<small>' . \_\_( "To prove you're a person (not a spam script), type the security word shown in the picture.", 'peters\_custom\_anti\_spam' ); |
| [353](#L353) | if( casFunctionCollection::get\_settings( 'wav' ) ) |
| [354](#L354) | { |
| [355](#L355) | $cas\_message .= ' ' . \_\_( 'Click on the picture to hear an audio file of the word.', 'peters\_custom\_anti\_spam' ); |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | $cas\_message .= '</small>'; |
| [359](#L359) | $cas\_myurl = get\_option( 'siteurl' ); |
| [360](#L360) |  |
| [361](#L361) | class PeterAntiSpam |
| [362](#L362) | { |
| [363](#L363) | function \_\_construct() |
| [364](#L364) | { |
| [365](#L365) | $cas\_manualinsert = casFunctionCollection::get\_settings( 'manualinsert' ); |
| [366](#L366) | add\_action( 'secure\_image', array( $this, 'comment\_form' ) );    // add image and input field to comment form |
| [367](#L367) | if( !$cas\_manualinsert ) |
| [368](#L368) | { |
| [369](#L369) | add\_action( 'comment\_form', array( $this, 'comment\_form' ) );    // add image and input field to comment form |
| [370](#L370) | } |
| [371](#L371) | add\_filter( 'preprocess\_comment', array( $this, 'comment\_post') );    // add post comment post security code check |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | static function comment\_form() |
| [375](#L375) | { |
| [376](#L376) | global $user\_ID, $cas\_textcount, $cas\_myurl, $cas\_thisfolder, $cas\_message, $cas\_table, $cas\_count, $wpdb; |
| [377](#L377) | foreach( array( 'forcereg', 'text', 'imgheight', 'imgwidth', 'borderclr', 'manualinsert', 'js\_generate', 'wav' ) as $setting\_name ) |
| [378](#L378) | { |
| [379](#L379) | $variable\_name = 'cas\_' . $setting\_name; |
| [380](#L380) | $$variable\_name = casFunctionCollection::get\_settings( $setting\_name ); |
| [381](#L381) | } |
| [382](#L382) | // If the user is logged in, don't prompt for code |
| [383](#L383) | if( ! $cas\_forcereg && intval( $user\_ID ) > 0 ) |
| [384](#L384) | { |
| [385](#L385) | return false; |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | // Generate a random field name |
| [389](#L389) | $cas\_fieldname = md5( rand() ); |
| [390](#L390) |  |
| [391](#L391) | if( !$cas\_js\_generate ) |
| [392](#L392) | { |
| [393](#L393) |  |
| [394](#L394) | // Insert a row into the count database to generate an auto\_increment number |
| [395](#L395) | $wpdb->query('INSERT INTO ' . $cas\_count . ' (id) VALUES (NULL)'); |
| [396](#L396) |  |
| [397](#L397) | // Get the id of the inserted count to feed to the word table and image generator |
| [398](#L398) | $cas\_rowid = $wpdb->get\_var('SELECT last\_insert\_id()'); |
| [399](#L399) |  |
| [400](#L400) | // Pick a random number |
| [401](#L401) | $cas\_antiselect = rand( 1, $cas\_textcount ); // 0 is for invalid, so don't select it |
| [402](#L402) |  |
| [403](#L403) | // Put the word corresponding to the random number into the database |
| [404](#L404) | $wpdb->query('INSERT INTO ' . $cas\_table . ' (id, createtime, word, fieldname) VALUES (' . $cas\_rowid . ', ' . time() . ', \'' . $cas\_text[$cas\_antiselect] . '\', \'' . $cas\_fieldname . '\')'); |
| [405](#L405) |  |
| [406](#L406) | // Delete the row from the count table |
| [407](#L407) | $wpdb->query('DELETE FROM ' . $cas\_count . ' WHERE id = ' . $cas\_rowid); |
| [408](#L408) |  |
| [409](#L409) | // Do some table admin while we can :D |
| [410](#L410) | if( strlen( $cas\_rowid ) == 10 ) |
| [411](#L411) | { |
| [412](#L412) | // Delete all rows from the count table |
| [413](#L413) | $wpdb->query('DELETE FROM ' . $cas\_count); |
| [414](#L414) |  |
| [415](#L415) | // Reset the table's auto increment if it's getting too huge |
| [416](#L416) | $wpdb->query('ALTER TABLE ' . $cas\_count . ' AUTO\_INCREMENT=1'); |
| [417](#L417) |  |
| [418](#L418) | // Delete any anti-spam words more than a day old |
| [419](#L419) | $wpdb->query('DELETE FROM ' . $cas\_table . ' WHERE ' . time() . ' > createtime + 86400'); |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | echo( "\t\t\t".'<div style="display:block;" id="secureimgdiv">'."\n\t\t\t\t" ); |
| [424](#L424) | echo( "<p><label for=\"cas\_fieldname\">" . \_\_( 'Anti-spam word: (Required)', 'peters\_custom\_anti\_spam' ) . "</label><span style=\"color:#FF0000;\">\*</span><br />\n\t\t\t\t" ); |
| [425](#L425) | echo( $cas\_message . "<br />\n\t\t\t\t" ); |
| [426](#L426) | echo( '<input type="text" name="' . $cas\_fieldname. '" id="cas\_fieldname" size="30" />'."\n\t\t\t\t" ); |
| [427](#L427) | echo( '<input id="cas\_match" type="hidden" name="matchthis" value="' ); |
| [428](#L428) | if (!$cas\_js\_generate) { |
| [429](#L429) | echo $cas\_rowid; |
| [430](#L430) | } |
| [431](#L431) | echo "\" />\n\t\t\t\t"; |
| [432](#L432) | if ($cas\_wav) |
| [433](#L433) | { |
| [434](#L434) | echo( '<a id="cas\_link" href="' ); |
| [435](#L435) | if (!$cas\_js\_generate) { |
| [436](#L436) | echo $cas\_myurl . '/wp-content/plugins/' . end($cas\_thisfolder) . '/custom\_anti\_spam.php?audioselect=' . $cas\_rowid; |
| [437](#L437) | } |
| [438](#L438) | echo ( '" rel="nofollow" title="' . \_\_( 'Click to hear an audio file of the anti-spam word', 'peters\_custom\_anti\_spam' ) . '">' . "\n\t\t\t\t" ); |
| [439](#L439) | } |
| [440](#L440) | echo '<img id="cas\_image" src="' . $cas\_myurl . '/wp-content/plugins/' . end( $cas\_thisfolder ); |
| [441](#L441) | if( !$cas\_js\_generate ) |
| [442](#L442) | { |
| [443](#L443) | echo '/custom\_anti\_spam.php?antiselect=' . $cas\_rowid; |
| [444](#L444) | } |
| [445](#L445) | else |
| [446](#L446) | { |
| [447](#L447) | echo '/pixel.gif'; |
| [448](#L448) | } |
| [449](#L449) | echo '" '; |
| [450](#L450) | echo( 'alt="' . \_\_( 'Anti-spam image', 'peters\_custom\_anti\_spam' ) . '" ' ); |
| [451](#L451) | echo( 'style="border:1px solid ' . $cas\_borderclr . ';vertical-align:top;' ); |
| [452](#L452) | echo( 'height:' . $cas\_imgheight .'px;width:' . $cas\_imgwidth . 'px;" />' ); |
| [453](#L453) | if( $cas\_wav ) |
| [454](#L454) | { |
| [455](#L455) | echo( '</a>'); |
| [456](#L456) | } |
| [457](#L457) | echo( "</p>\n\t\t\t" ); |
| [458](#L458) | echo( "</div>\n\t\t\t" ); |
| [459](#L459) | if( !$cas\_manualinsert ) |
| [460](#L460) | { |
| [461](#L461) | echo "<script type='text/javascript'> |
| [462](#L462) | <!-- |
| [463](#L463) | var commentinput = document.getElementById(\"comment\").parentNode; |
| [464](#L464) | var submitp = commentinput.parentNode; |
| [465](#L465) | var substitution2 = document.getElementById(\"secureimgdiv\"); |
| [466](#L466) | submitp.insertBefore(substitution2, commentinput); |
| [467](#L467) | // --> |
| [468](#L468) | </script>\n"; |
| [469](#L469) | } |
| [470](#L470) |  |
| [471](#L471) | if( $cas\_js\_generate ) |
| [472](#L472) | { |
| [473](#L473) | // The JavaScript that updates the anti-spam image |
| [474](#L474) |  |
| [475](#L475) | print '<script type="text/javascript">' . "\n"; |
| [476](#L476) | print '// Code modified from Peter\'s ajax date script at http://www.theblog.ca/php-unix-timestamp-generator-with-ajax' . "\n"; |
| [477](#L477) | print '// The date script modified code from a tutorial here: http://www.webpasties.com/xmlHttpRequest/xmlHttpRequest\_tutorial\_1.html' . "\n\n"; |
| [478](#L478) | print 'var casTime = new Date();'; |
| [479](#L479) | print "// Update the code that displays the anti-spam image |
| [480](#L480) | var url = \"" . $cas\_myurl . '/wp-content/plugins/' . end($cas\_thisfolder) . "/custom\_anti\_spam.php?antinew&\" + casTime.getTime(); // The server-side script |
| [481](#L481) | function handleHttpResponse() { |
| [482](#L482) | if (http.readyState == 4) { |
| [483](#L483) | if (http.responseText.indexOf('invalid') == -1) { |
| [484](#L484) | results = http.responseText.split( '-' ); |
| [485](#L485) | document.getElementById('cas\_match').value = results[0]; |
| [486](#L486) | document.getElementById('cas\_fieldname').name = results[1]; |
| [487](#L487) | document.getElementById('cas\_image').src = '" . $cas\_myurl . '/wp-content/plugins/' . end($cas\_thisfolder) . "/custom\_anti\_spam.php?antiselect=' + results[0];"; |
| [488](#L488) | if ($cas\_wav) |
| [489](#L489) | { |
| [490](#L490) | print " |
| [491](#L491) | document.getElementById('cas\_link').href = '" . $cas\_myurl . '/wp-content/plugins/' . end($cas\_thisfolder) . "/custom\_anti\_spam.php?audioselect=' + results[0];"; |
| [492](#L492) | } |
| [493](#L493) | print " |
| [494](#L494) | isWorking = false; |
| [495](#L495) | } |
| [496](#L496) | } |
| [497](#L497) | } |
| [498](#L498) |  |
| [499](#L499) | var isWorking = false;\n\n"; |
| [500](#L500) | print "// Call up the script that generates the new id\n |
| [501](#L501) | function newAntiSpam() { |
| [502](#L502) | if (!isWorking && http) { |
| [503](#L503) | http.open(\"GET\", url, true); |
| [504](#L504) | http.onreadystatechange = handleHttpResponse; |
| [505](#L505) | isWorking = true; |
| [506](#L506) | http.send(null); |
| [507](#L507) | } |
| [508](#L508) | }"; |
| [509](#L509) | print "function getHTTPObject() { |
| [510](#L510) | var xmlhttp; |
| [511](#L511) | /\*@cc\_on |
| [512](#L512) | @if (@\_jscript\_version >= 5) |
| [513](#L513) | try { xmlhttp = new ActiveXObject(\"Msxml2.XMLHTTP\"); } |
| [514](#L514) | catch (e) { |
| [515](#L515) | try { xmlhttp = new ActiveXObject(\"Microsoft.XMLHTTP\"); } |
| [516](#L516) | catch (E) { xmlhttp = false; } } |
| [517](#L517) | @else xmlhttp = false; |
| [518](#L518) | @end @\*/ |
| [519](#L519) | if (!xmlhttp && typeof XMLHttpRequest != 'undefined') { |
| [520](#L520) | try { xmlhttp = new XMLHttpRequest(); } |
| [521](#L521) | catch (e) { xmlhttp = false; } } |
| [522](#L522) | return xmlhttp; |
| [523](#L523) | } |
| [524](#L524) | var http = getHTTPObject(); // We create the HTTP Object" . "\n"; |
| [525](#L525) | print "newAntiSpam();\n\n"; |
| [526](#L526) | print "</script>\n"; |
| [527](#L527) | } |
| [528](#L528) | return false; |
| [529](#L529) | } |
| [530](#L530) |  |
| [531](#L531) | static function comment\_post( $incoming\_comment ) |
| [532](#L532) | { |
| [533](#L533) | global $cas\_textcount, $user\_ID, $cas\_table, $wpdb; |
| [534](#L534) |  |
| [535](#L535) | foreach( array( 'forcereg', 'allowtrack', 'allowping', 'modtrack', 'modping' ) as $setting\_name ) |
| [536](#L536) | { |
| [537](#L537) | $variable\_name = 'cas\_' . $setting\_name; |
| [538](#L538) | $$variable\_name = casFunctionCollection::get\_settings( $setting\_name ); |
| [539](#L539) | } |
| [540](#L540) |  |
| [541](#L541) | if( isset( $\_POST['matchthis'] ) ) |
| [542](#L542) | { |
| [543](#L543) | $matchnum = intval( $\_POST['matchthis'] ); |
| [544](#L544) | } |
| [545](#L545) | else |
| [546](#L546) | { |
| [547](#L547) | $matchnum = 0; |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | // If the user is not logged in check the security code |
| [551](#L551) | if( ( $cas\_forcereg || 0 == intval( $user\_ID ) ) && !is\_admin() ) |
| [552](#L552) | { |
| [553](#L553) | $istrackping = $incoming\_comment['comment\_type']; |
| [554](#L554) | $commentbody = $incoming\_comment['comment\_content']; |
| [555](#L555) | if ( $istrackping == 'pingback' && $cas\_allowping ) |
| [556](#L556) | { |
| [557](#L557) |  |
| [558](#L558) | // Send all pingbacks to a moderation queue? |
| [559](#L559) | if ($cas\_modping) add\_filter('pre\_comment\_approved', create\_function('$mod\_ping', 'return \'0\';')); |
| [560](#L560) | } |
| [561](#L561) | elseif ( $istrackping == 'trackback' && $cas\_allowtrack ) |
| [562](#L562) | { |
| [563](#L563) |  |
| [564](#L564) | // Send all trackbacks to a moderation queue? |
| [565](#L565) | if ($cas\_modtrack) |
| [566](#L566) | { |
| [567](#L567) | add\_filter('pre\_comment\_approved', create\_function('$mod\_track', 'return \'0\';')); |
| [568](#L568) | } |
| [569](#L569) | } |
| [570](#L570) | else |
| [571](#L571) | { |
| [572](#L572) | // Get the anti-spam word from the database |
| [573](#L573) | $matchthis = $wpdb->get\_row('SELECT word, fieldname FROM ' . $cas\_table . ' WHERE id = ' . $matchnum); |
| [574](#L574) |  |
| [575](#L575) | // If this row doesn't exist, say something |
| [576](#L576) | if( is\_null( $matchthis ) ) |
| [577](#L577) | { |
| [578](#L578) | wp\_die( '<p>' . \_\_( 'Error: The anti-spam word is invalid. Please report this error to the webmaster. Go back and refresh the page to re-submit your comment.', 'peters\_custom\_anti\_spam' ) . "</p>\n<p>" . $cas\_string\_copy\_field . "</p>\n<textarea cols=\"100%\" rows=\"10\" onclick=\"this.select();\" readonly=\"true\">$commentbody</textarea>" ); |
| [579](#L579) | } |
| [580](#L580) |  |
| [581](#L581) | $cas\_string\_copy\_field = \_\_( 'Copy your comment in case this site forces a page reload whenever you press the Back button:', 'peters\_custom\_anti\_spam' ); |
| [582](#L582) |  |
| [583](#L583) | // Validate the form input values |
| [584](#L584) | if( isset( $\_POST[ $matchthis->fieldname ] ) && '' != $\_POST[ $matchthis->fieldname ] ) |
| [585](#L585) | { |
| [586](#L586) | // Consider only the first 50 characters in the posted word |
| [587](#L587) | $securitycode = substr( $\_POST[ $matchthis->fieldname ], 0, 50 ); |
| [588](#L588) |  |
| [589](#L589) | // Remove all spaces and hyphens to give the commenter a break! |
| [590](#L590) | $securitycode = str\_replace(' ', '', $securitycode); |
| [591](#L591) | $securitycode = str\_replace('-', '', $securitycode); |
| [592](#L592) | } |
| [593](#L593) | else |
| [594](#L594) | { |
| [595](#L595) | wp\_die( '<p>' . \_\_( 'Error: Please enter the anti-spam word.', 'peters\_custom\_anti\_spam' ) . "</p>\n<p>" . $cas\_string\_copy\_field . "</p>\n<textarea cols=\"100%\" rows=\"10\" onclick=\"this.select();\" readonly=\"true\">$commentbody</textarea>" ); |
| [596](#L596) | } |
| [597](#L597) | // Remove all spaces and hyphens, since we removed them from what the commenter entered |
| [598](#L598) | $matchthis\_word = str\_replace(' ', '', $matchthis->word); |
| [599](#L599) | $matchthis\_word = str\_replace('-', '', $matchthis\_word); |
| [600](#L600) |  |
| [601](#L601) | if( strtolower( $matchthis\_word ) != strtolower( $securitycode ) ) |
| [602](#L602) | { |
| [603](#L603) | wp\_die( '<p>' . \_\_( 'Error: Please enter the correct anti-spam word. Press the back button and try again.', 'peters\_custom\_anti\_spam' ) . "</p>\n<p>" . $cas\_string\_copy\_field . "</p>\n<textarea cols=\"100%\" rows=\"10\" onclick=\"this.select();\" readonly=\"true\">$commentbody</textarea>" ); |
| [604](#L604) | } |
| [605](#L605) | else |
| [606](#L606) | { |
| [607](#L607) | // The word matched, so delete the row for the anti-spam word so that it cannot be used again |
| [608](#L608) | $wpdb->query('DELETE FROM ' . $cas\_table . ' WHERE id = ' . $matchnum); |
| [609](#L609) | unset( $matchthis ); |
| [610](#L610) |  |
| [611](#L611) | // Do some more table admin while we can :D |
| [612](#L612) | // Delete any anti-spam words more than a day old |
| [613](#L613) | $wpdb->query('DELETE FROM ' . $cas\_table . ' WHERE ' . time() . ' > createtime + 86400'); |
| [614](#L614) | } |
| [615](#L615) | } |
| [616](#L616) | } |
| [617](#L617) | return( $incoming\_comment ); |
| [618](#L618) | } |
| [619](#L619) | } |
| [620](#L620) | new PeterAntiSpam(); |
| [621](#L621) |  |
| [622](#L622) | // Add some troubleshooting to the Manage tab |
| [623](#L623) |  |
| [624](#L624) | // These functions are only needed in the back-end |
| [625](#L625) | if (is\_admin()) { |
| [626](#L626) |  |
| [627](#L627) | function cas\_manage() |
| [628](#L628) | { |
| [629](#L629) | global $cas\_pluginpath, $wpdb; |
| [630](#L630) |  |
| [631](#L631) | // Run upgrade check here in case the plugin is manually updated |
| [632](#L632) | cas\_upgrade(); |
| [633](#L633) |  |
| [634](#L634) | $cas\_settings = casFunctionCollection::get\_settings(); |
| [635](#L635) | if( isset( $\_POST['submit'] ) ) |
| [636](#L636) | { |
| [637](#L637) | // Take care of dropdown list settings |
| [638](#L638) | $cas\_dropdown\_settings = array( 'forcereg', 'allowtrack', 'modtrack', 'allowping', 'modping', |
| [639](#L639) | 'randomcolors', 'UsePngNotJpeg', 'manualinsert', 'wav', |
| [640](#L640) | 'sox', 'reg\_protection', 'js\_generate' ); |
| [641](#L641) |  |
| [642](#L642) | foreach($cas\_dropdown\_settings as $cas\_dropdown\_setting) |
| [643](#L643) | { |
| [644](#L644) | if( isset( $\_POST['cas\_' . $cas\_dropdown\_setting] ) ) |
| [645](#L645) | { |
| [646](#L646) | $cas\_settings[$cas\_dropdown\_setting] = intval( $\_POST['cas\_' . $cas\_dropdown\_setting] ); |
| [647](#L647) | } |
| [648](#L648) | } |
| [649](#L649) |  |
| [650](#L650) | // Take care of text area settings |
| [651](#L651) | $cas\_textarea\_settings = array( 'text', 'fontlist', 'reg\_blacklist' ); |
| [652](#L652) | foreach( $cas\_textarea\_settings as $cas\_textarea\_setting ) |
| [653](#L653) | { |
| [654](#L654) | $cas\_list = htmlentities( $\_POST['cas\_' . $cas\_textarea\_setting], ENT\_QUOTES ); |
| [655](#L655) | // Get rid of all trailing lines |
| [656](#L656) | $cas\_list = trim($cas\_list); |
| [657](#L657) | // Convert to an array |
| [658](#L658) | $cas\_list = explode("\r\n", $cas\_list); |
| [659](#L659) | $cas\_settings[$cas\_textarea\_setting] = $cas\_list; |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | // Take care of number settings |
| [663](#L663) | $cas\_number\_settings = array('imgwidth', 'imgheight'); |
| [664](#L664) | foreach( $cas\_number\_settings as $cas\_number\_setting ) |
| [665](#L665) | { |
| [666](#L666) | if( isset( $\_POST['cas\_' . $cas\_number\_setting] ) ) |
| [667](#L667) | { |
| [668](#L668) | $cas\_settings[$cas\_number\_setting] = intval( $\_POST['cas\_' . $cas\_number\_setting] ); |
| [669](#L669) | } |
| [670](#L670) | } |
| [671](#L671) |  |
| [672](#L672) | // Take care of text field settings |
| [673](#L673) | $cas\_textfield\_settings = array('bgcolorset', 'borderclr'); |
| [674](#L674) |  |
| [675](#L675) | foreach($cas\_textfield\_settings as $cas\_textfield\_setting) |
| [676](#L676) | { |
| [677](#L677) | if( isset( $\_POST['cas\_' . $cas\_textfield\_setting] ) ) |
| [678](#L678) | { |
| [679](#L679) | $cas\_settings[$cas\_textfield\_setting] = trim( htmlentities( $\_POST['cas\_' . $cas\_textfield\_setting], ENT\_QUOTES ) ); |
| [680](#L680) | } |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) | update\_option( 'cas\_settings', $cas\_settings ); |
| [684](#L684) |  |
| [685](#L685) | // Logic to update |
| [686](#L686) | print '<div id="message" class="updated fade"><p><strong>'.\_\_('Settings updated.').'</strong></p></div>' . "\n"; |
| [687](#L687) | } |
| [688](#L688) |  |
| [689](#L689) | print "<div class=\"wrap\">\n"; |
| [690](#L690) | print "<h2>Peter's Custom Anti-Spam</h2>\n"; |
| [691](#L691) |  |
| [692](#L692) | ?> |
| [693](#L693) | <h3>Customize words</h3> |
| [694](#L694) | <p>Enter the anti-spam words below, one per line.</p> |
| [695](#L695) | <p>If you want some words to be used more often, enter them multiple times.</p> |
| [696](#L696) | <p>It is best to use words that are eight letters or less.</p> |
| [697](#L697) | <form name="cas\_current\_settings" method="post" action="<?php print '?page=' . basename(\_\_FILE\_\_); ?>"> |
| [698](#L698) | <p><textarea name="cas\_text" cols="60" rows="15"><?php |
| [699](#L699) | print implode("\r\n", $cas\_settings['text']); |
| [700](#L700) | ?></textarea></p> |
| [701](#L701) | <p class="submit"><input name="submit" type="submit" value="Update" /></p> |
| [702](#L702) | <h3>Customize settings</h3> |
| [703](#L703) | <table class="widefat"> |
| [704](#L704) | <tr> |
| [705](#L705) | <td width="40%"> |
| [706](#L706) | <p><strong>Force registered users to enter the anti-spam word</strong></p> |
| [707](#L707) | </td> |
| [708](#L708) | <td width="60%"> |
| [709](#L709) | <select name="cas\_forcereg"> |
| [710](#L710) | <option value="0"<?php if (!$cas\_settings['forcereg']) print ' selected="selected"'; ?>>No</option> |
| [711](#L711) | <option value="1"<?php if ($cas\_settings['forcereg']) print ' selected="selected"'; ?>>Yes</option> |
| [712](#L712) | </select> |
| [713](#L713) | </td> |
| [714](#L714) | </tr> |
| [715](#L715) | <tr> |
| [716](#L716) | <td> |
| [717](#L717) | <p><strong>Allow trackbacks (but be vulnerable to trackback spam)</strong></p> |
| [718](#L718) | </td> |
| [719](#L719) | <td> |
| [720](#L720) | <select name="cas\_allowtrack"> |
| [721](#L721) | <option value="1"<?php if ($cas\_settings['allowtrack']) print ' selected="selected"'; ?>>Yes</option> |
| [722](#L722) | <option value="0"<?php if (!$cas\_settings['allowtrack']) print ' selected="selected"'; ?>>No</option> |
| [723](#L723) | </select> |
| [724](#L724) | </td> |
| [725](#L725) | </tr> |
| [726](#L726) | <tr> |
| [727](#L727) | <td> |
| [728](#L728) | <p><strong>Send all trackbacks to the moderation queue (only works if you allow trackbacks)</strong></p> |
| [729](#L729) | </td> |
| [730](#L730) | <td> |
| [731](#L731) | <select name="cas\_modtrack"> |
| [732](#L732) | <option value="0"<?php if (!$cas\_settings['modtrack']) print ' selected="selected"'; ?>>No</option> |
| [733](#L733) | <option value="1"<?php if ($cas\_settings['modtrack']) print ' selected="selected"'; ?>>Yes</option> |
| [734](#L734) | </select> |
| [735](#L735) | </td> |
| [736](#L736) | </tr> |
| [737](#L737) | <tr> |
| [738](#L738) | <td> |
| [739](#L739) | <p><strong>Allow pingbacks (but be vulnerable to pingback spam)</strong></p> |
| [740](#L740) | </td> |
| [741](#L741) | <td> |
| [742](#L742) | <select name="cas\_allowping"> |
| [743](#L743) | <option value="1"<?php if ($cas\_settings['allowping']) print ' selected="selected"'; ?>>Yes</option> |
| [744](#L744) | <option value="0"<?php if (!$cas\_settings['allowping']) print ' selected="selected"'; ?>>No</option> |
| [745](#L745) | </select> |
| [746](#L746) | </td> |
| [747](#L747) | </tr> |
| [748](#L748) | <tr> |
| [749](#L749) | <td> |
| [750](#L750) | <p><strong>Send all pingbacks to the moderation queue (only works if you allow pingbacks)</strong></p> |
| [751](#L751) | </td> |
| [752](#L752) | <td> |
| [753](#L753) | <select name="cas\_modping"> |
| [754](#L754) | <option value="0"<?php if (!$cas\_settings['modping']) print ' selected="selected"'; ?>>No</option> |
| [755](#L755) | <option value="1"<?php if ($cas\_settings['modping']) print ' selected="selected"'; ?>>Yes</option> |
| [756](#L756) | </select> |
| [757](#L757) | </td> |
| [758](#L758) | </tr> |
| [759](#L759) | <tr> |
| [760](#L760) | <td> |
| [761](#L761) | <p><strong>Font list</strong></p> |
| [762](#L762) | <p>List as many TrueType font(s) as you like, one per line. Drop your own font files into this plugin's "fonts" sub-directory.</p> |
| [763](#L763) | <p>If you are using your own fonts, make sure all fonts used are about the same default size.</p> |
| [764](#L764) | <p>If you want some fonts to be used more frequently, enter them multiple times.</p> |
| [765](#L765) | <p>Default freeware fonts are from fonts101.com</p> |
| [766](#L766) | </td> |
| [767](#L767) | <td> |
| [768](#L768) | <textarea name="cas\_fontlist" cols="35" rows="10"><?php print implode("\r\n", $cas\_settings['fontlist']); ?></textarea> |
| [769](#L769) | </td> |
| [770](#L770) | </tr> |
| [771](#L771) | <tr> |
| [772](#L772) | <td> |
| [773](#L773) | <p><strong>Anti-spam image width</strong></p> |
| [774](#L774) | </td> |
| [775](#L775) | <td> |
| [776](#L776) | <input type="text" name="cas\_imgwidth" size="4" maxlength="4" value="<?php print $cas\_settings['imgwidth']; ?>" /> |
| [777](#L777) | </td> |
| [778](#L778) | </tr> |
| [779](#L779) | <tr> |
| [780](#L780) | <td> |
| [781](#L781) | <p><strong>Anti-spam image height</strong></p> |
| [782](#L782) | </td> |
| [783](#L783) | <td> |
| [784](#L784) | <input type="text" name="cas\_imgheight" size="4" maxlength="4" value="<?php print $cas\_settings['imgheight']; ?>" /> |
| [785](#L785) | </td> |
| [786](#L786) | </tr> |
| [787](#L787) | <tr> |
| [788](#L788) | <td> |
| [789](#L789) | <p><strong>Use random text colours</strong></p> |
| [790](#L790) | <p>If random colors are not selected, blue text will appear on a white background, and white text will appear on black background (as decided in the next option).</p> |
| [791](#L791) | </td> |
| [792](#L792) | <td> |
| [793](#L793) | <select name="cas\_randomcolors"> |
| [794](#L794) | <option value="1"<?php if ($cas\_settings['randomcolors']) print ' selected="selected"'; ?>>Yes</option> |
| [795](#L795) | <option value="0"<?php if (!$cas\_settings['randomcolors']) print ' selected="selected"'; ?>>No</option> |
| [796](#L796) | </select> |
| [797](#L797) | </td> |
| [798](#L798) | </tr> |
| [799](#L799) | <tr> |
| [800](#L800) | <td> |
| [801](#L801) | <p><strong>Background colour for the anti-spam image</strong></p> |
| [802](#L802) | </td> |
| [803](#L803) | <td> |
| [804](#L804) | <select name="cas\_bgcolorset"> |
| [805](#L805) | <option value="white"<?php if ($cas\_settings['bgcolorset'] == 'white') print ' selected="selected"'; ?>>White</option> |
| [806](#L806) | <option value="black"<?php if ($cas\_settings['bgcolorset'] == 'black') print ' selected="selected"'; ?>>Black</option> |
| [807](#L807) | </select> |
| [808](#L808) | </td> |
| [809](#L809) | </tr> |
| [810](#L810) | <tr> |
| [811](#L811) | <td> |
| [812](#L812) | <p><strong>Border colour for the anti-spam image</strong></p> |
| [813](#L813) | <p>Write either major colours (red, green, blue, etc.) or enter the HTML colour code (such as #C0C0C0).</p> |
| [814](#L814) | </td> |
| [815](#L815) | <td> |
| [816](#L816) | <input type="text" name="cas\_borderclr" size="10" maxlength="10" value="<?php print $cas\_settings['borderclr']; ?>"/> |
| [817](#L817) | </td> |
| [818](#L818) | </tr> |
| [819](#L819) | <tr> |
| [820](#L820) | <td> |
| [821](#L821) | <p><strong>Use PNG graphics</strong></p> |
| [822](#L822) | <p>PNG provides better quality text, while JPEG is more compatible with older browsers.</p> |
| [823](#L823) | </td> |
| [824](#L824) | <td> |
| [825](#L825) | <select name="cas\_UsePngNotJpeg"> |
| [826](#L826) | <option value="0"<?php if (!$cas\_settings['UsePngNotJpeg']) print ' selected="selected"'; ?>>No</option> |
| [827](#L827) | <option value="1"<?php if ($cas\_settings['UsePngNotJpeg']) print ' selected="selected"'; ?>>Yes</option> |
| [828](#L828) | </select> |
| [829](#L829) | </td> |
| [830](#L830) | </tr> |
| [831](#L831) | <tr> |
| [832](#L832) | <td> |
| [833](#L833) | <p><strong>Manually insert anti-spam code</strong></p> |
| [834](#L834) | <p>By default, the code is automatically inserted using JavaScript.</p> |
| [835](#L835) | <p>If you choose to manually insert it, you can place the code <strong>do\_action('secure\_image', $post->ID);</strong> into your comments template file.</p> |
| [836](#L836) | </td> |
| [837](#L837) | <td> |
| [838](#L838) | <select name="cas\_manualinsert"> |
| [839](#L839) | <option value="0"<?php if (!$cas\_settings['manualinsert']) print ' selected="selected"'; ?>>No</option> |
| [840](#L840) | <option value="1"<?php if ($cas\_settings['manualinsert']) print ' selected="selected"'; ?>>Yes</option> |
| [841](#L841) | </select> |
| [842](#L842) | </td> |
| [843](#L843) | </tr> |
| [844](#L844) | <tr> |
| [845](#L845) | <td> |
| [846](#L846) | <p><strong>Use JavaScript to generate anti-spam code</strong></p> |
| [847](#L847) | <p>Most WordPress caching systems don't allow parts of the page to be exempt from caching.</p> |
| [848](#L848) | <p>This setting gets around this problem by dynamically generating the anti-spam content with JavaScript.</p> |
| [849](#L849) | </td> |
| [850](#L850) | <td> |
| [851](#L851) | <select name="cas\_js\_generate"> |
| [852](#L852) | <option value="0"<?php if (!$cas\_settings['js\_generate']) print ' selected="selected"'; ?>>No</option> |
| [853](#L853) | <option value="1"<?php if ($cas\_settings['js\_generate']) print ' selected="selected"'; ?>>Yes</option> |
| [854](#L854) | </select> |
| [855](#L855) | </td> |
| [856](#L856) | </tr> |
| [857](#L857) | <tr> |
| [858](#L858) | <td> |
| [859](#L859) | <p><strong>Enable sound</strong></p> |
| [860](#L860) | <p>Enable wav files of the anti-spam words so that visually enabled users can comment.</p> |
| [861](#L861) | </td> |
| [862](#L862) | <td> |
| [863](#L863) | <select name="cas\_wav"> |
| [864](#L864) | <option value="1"<?php if ($cas\_settings['wav']) print ' selected="selected"'; ?>>Yes</option> |
| [865](#L865) | <option value="0"<?php if (!$cas\_settings['wav']) print ' selected="selected"'; ?>>No</option> |
| [866](#L866) | </select> |
| [867](#L867) | </td> |
| [868](#L868) | </tr> |
| [869](#L869) | <tr> |
| [870](#L870) | <td> |
| [871](#L871) | <p><strong>Use "sox" filter</strong></p> |
| [872](#L872) | <p>The "sox" filter stretches the audio files by a variable rate (so that they are harder to crack by spambots.</p> |
| [873](#L873) | <p>Turn this off if you don't want this feature or if you know that your server does not have this filter.</p> |
| [874](#L874) | </td> |
| [875](#L875) | <td> |
| [876](#L876) | <select name="cas\_sox"> |
| [877](#L877) | <option value="1"<?php if ($cas\_settings['sox']) print ' selected="selected"'; ?>>Yes</option> |
| [878](#L878) | <option value="0"<?php if (!$cas\_settings['sox']) print ' selected="selected"'; ?>>No</option> |
| [879](#L879) | </select> |
| [880](#L880) | </td> |
| [881](#L881) | </tr> |
| [882](#L882) | <tr> |
| [883](#L883) | <td> |
| [884](#L884) | <p><strong>Registration form anti-spam</strong></p> |
| [885](#L885) | </td> |
| [886](#L886) | <td> |
| [887](#L887) | <select name="cas\_reg\_protection"> |
| [888](#L888) | <option value="0"<?php if (!$cas\_settings['reg\_protection']) print ' selected="selected"'; ?>>No</option> |
| [889](#L889) | <option value="1"<?php if ($cas\_settings['reg\_protection']) print ' selected="selected"'; ?>>Yes</option> |
| [890](#L890) | </select> |
| [891](#L891) | </td> |
| [892](#L892) | </tr> |
| [893](#L893) | <tr> |
| [894](#L894) | <td> |
| [895](#L895) | <p><strong>Registration blacklist</strong></p> |
| [896](#L896) | <p>Enter either e-mail address or domains (like "theblog.ca") of e-mail addresses you don't want to allow, one per line.</p> |
| [897](#L897) | <p>Be careful, because if you enter "theblog.ca", and an e-mail address contains that string anywhere, it will be blocked.</p> |
| [898](#L898) | <p>This only works if you enable registration form anti-spam.</p> |
| [899](#L899) | </td> |
| [900](#L900) | <td> |
| [901](#L901) | <textarea name="cas\_reg\_blacklist" cols="35" rows="10"><?php print implode("\r\n", $cas\_settings['reg\_blacklist']); ?></textarea> |
| [902](#L902) | </td> |
| [903](#L903) | </tr> |
| [904](#L904) | </table> |
| [905](#L905) | <p class="submit"><input name="submit" type="submit" value="Update" /></p> |
| [906](#L906) | </form> |
| [907](#L907) | <h3>Server diagnosis</h3> |
| [908](#L908) | <?php |
| [909](#L909) | print "<p>This section will diagnose your server setup to see how it relates to the performance of this plugin.</p>\n"; |
| [910](#L910) | print "<hr />\n"; |
| [911](#L911) | print "<p>Can't see the anti-spam image when you're viewing a comment form? Remember to log out of WordPress first -- by default, the image doesn't show to registered users (although you can edit that option in the plugin file).</p>\n"; |
| [912](#L912) | print "<hr />\n"; |
| [913](#L913) |  |
| [914](#L914) | print "<p><strong>GD library</strong><br />\n"; |
| [915](#L915) | if( function\_exists( 'imagejpeg' ) ) |
| [916](#L916) | { |
| [917](#L917) | print "Yay! The GD library is installed. This is the most important thing to be able to use this plugin. You might still need to do some tweaking to the settings of course.</p>\n"; |
| [918](#L918) | } |
| [919](#L919) | else |
| [920](#L920) | { |
| [921](#L921) | print "<font color=\"red\">The GD library is not installed. This plugin will not work without it. Ask your webhost to install this library (or install it if you manage your own server).</font></p>\n"; |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | print "<p><strong>FreeType</strong><br />\n"; |
| [925](#L925) | if(function\_exists( 'imagettftext' ) ) |
| [926](#L926) | { |
| [927](#L927) | print "Yay! The FreeType library is installed. The anti-spam image should display using the uploaded fonts.</p>\n"; |
| [928](#L928) | } |
| [929](#L929) | else |
| [930](#L930) | { |
| [931](#L931) | print "<font color=\"red\">The FreeType library is not installed. The anti-spam image should still display, but with only a plain font. Ask your webhost to install this library (or install it if you manage your own server) if you want to be able to use the uploaded fonts.</font></p>\n"; |
| [932](#L932) | } |
| [933](#L933) |  |
| [934](#L934) | print "<hr />\n"; |
| [935](#L935) | print "<p>Need more help? Post a comment on the <a href=\"https://www.theblog.ca/anti-spam\" title=\"Where all information is posted about the plugin\">Peter's Custom Anti-Spam page</a>.</p>\n"; |
| [936](#L936) | print "</div>\n"; |
| [937](#L937) | } |
| [938](#L938) |  |
| [939](#L939) | function cas\_adminmenu() |
| [940](#L940) | { |
| [941](#L941) | add\_options\_page( 'Custom anti-spam', 'Custom anti-spam', 'manage\_categories', 'custom\_anti\_spam.php', 'cas\_manage' ); |
| [942](#L942) | } |
| [943](#L943) |  |
| [944](#L944) | add\_action('admin\_menu','cas\_adminmenu',1); |
| [945](#L945) |  |
| [946](#L946) | // Install the anti-spam word database table upon plugin activation |
| [947](#L947) |  |
| [948](#L948) | function cas\_install() |
| [949](#L949) | { |
| [950](#L950) | global $wpdb, $cas\_tablename, $cas\_countname, $cas\_version; |
| [951](#L951) | $cas\_thistable = $wpdb->prefix . $cas\_tablename; |
| [952](#L952) | $cas\_thiscount = $wpdb->prefix . $cas\_countname; |
| [953](#L953) |  |
| [954](#L954) | // Add the table to hold the anti-spam words |
| [955](#L955) | if($wpdb->get\_var("SHOW TABLES LIKE '$cas\_thistable'") != $cas\_thistable) { |
| [956](#L956) | $sql = "CREATE TABLE " . $cas\_thistable . " ( |
| [957](#L957) | id int(10) NOT NULL, |
| [958](#L958) | createtime int(10) NOT NULL, |
| [959](#L959) | word VARCHAR(20) NOT NULL, |
| [960](#L960) | fieldname VARCHAR(32) NOT NULL, |
| [961](#L961) | UNIQUE KEY id (id) |
| [962](#L962) | );"; |
| [963](#L963) | $wpdb->query($sql); |
| [964](#L964) | } |
| [965](#L965) |  |
| [966](#L966) | // Add the table to hold the count for the anti-spam words |
| [967](#L967) | if($wpdb->get\_var("SHOW TABLES LIKE '$cas\_thiscount'") != $cas\_thiscount) { |
| [968](#L968) | $sql = "CREATE TABLE " . $cas\_thiscount . " ( |
| [969](#L969) | id int(10) NOT NULL AUTO\_INCREMENT, |
| [970](#L970) | UNIQUE KEY id (id) |
| [971](#L971) | );"; |
| [972](#L972) | $wpdb->query($sql); |
| [973](#L973) | } |
| [974](#L974) | // Set the version number in the database |
| [975](#L975) | add\_option( 'cas\_version', $cas\_version, '', 'no' ); |
| [976](#L976) | cas\_upgrade(); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | // Perform upgrade functions |
| [980](#L980) | function cas\_upgrade() |
| [981](#L981) | { |
| [982](#L982) | global $wpdb, $cas\_version, $cas\_tablename; |
| [983](#L983) |  |
| [984](#L984) | $cas\_thistable = $wpdb->prefix . $cas\_tablename; |
| [985](#L985) |  |
| [986](#L986) | // Turn version into an integer for comparisons |
| [987](#L987) | $current\_version = intval( str\_replace( '.', '', get\_option( 'cas\_version' ) ) ); |
| [988](#L988) |  |
| [989](#L989) | if( $current\_version < 320 ) |
| [990](#L990) | { |
| [991](#L991) | // Allow NULL values for non-essential fields |
| [992](#L992) | $wpdb->query( "ALTER TABLE `$cas\_thistable` ADD `fieldname` VARCHAR(32) NOT NULL default '' AFTER `word`" ); |
| [993](#L993) | } |
| [994](#L994) |  |
| [995](#L995) | if( $current\_version != intval( str\_replace( '.', '', $cas\_version ) ) ) |
| [996](#L996) | { |
| [997](#L997) | // Add the version number to the database |
| [998](#L998) | delete\_option( 'cas\_version' ); |
| [999](#L999) | add\_option( 'cas\_version', $cas\_version, '', 'no' ); |
| [1000](#L1000) | } |
| [1001](#L1001) | } |
| [1002](#L1002) |  |
| [1003](#L1003) | // Remove the anti-spam word database table upon plugin de-activation |
| [1004](#L1004) |  |
| [1005](#L1005) | function cas\_uninstall () { |
| [1006](#L1006) | global $wpdb, $cas\_tablename, $cas\_countname; |
| [1007](#L1007) | $cas\_thistable = $wpdb->prefix . $cas\_tablename; |
| [1008](#L1008) | $cas\_thiscount = $wpdb->prefix . $cas\_countname; |
| [1009](#L1009) |  |
| [1010](#L1010) | if($wpdb->get\_var("SHOW TABLES LIKE '$cas\_thistable'") == $cas\_thistable) { |
| [1011](#L1011) | $sql = "DROP TABLE " . $cas\_thistable; |
| [1012](#L1012) | $wpdb->query($sql); |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | if($wpdb->get\_var("SHOW TABLES LIKE '$cas\_thiscount'") == $cas\_thiscount) { |
| [1016](#L1016) | $sql = "DROP TABLE " . $cas\_thiscount; |
| [1017](#L1017) | $wpdb->query($sql); |
| [1018](#L1018) | } |
| [1019](#L1019) | delete\_option( 'cas\_version' ); |
| [1020](#L1020) | delete\_option( 'cas\_settings' ); |
| [1021](#L1021) | } |
| [1022](#L1022) |  |
| [1023](#L1023) | register\_activation\_hook( \_\_FILE\_\_, 'cas\_install' ); |
| [1024](#L1024) | register\_uninstall\_hook( \_\_FILE\_\_, 'cas\_uninstall' ); |
| [1025](#L1025) | } // Close the back-end check |
| [1026](#L1026) |  |
| [1027](#L1027) | function cas\_register\_form() |
| [1028](#L1028) | { |
| [1029](#L1029) | global $cas\_text, $cas\_textcount, $cas\_myurl, $cas\_thisfolder, $cas\_message, $cas\_table, $cas\_count, $wpdb; |
| [1030](#L1030) |  |
| [1031](#L1031) | foreach( array( 'imgheight', 'imgwidth', 'borderclr', 'wav' ) as $setting\_name ) |
| [1032](#L1032) | { |
| [1033](#L1033) | $variable\_name = 'cas\_' . $setting\_name; |
| [1034](#L1034) | $$variable\_name = casFunctionCollection::get\_settings( $setting\_name ); |
| [1035](#L1035) | } |
| [1036](#L1036) | // Insert a row into the count database to generate an auto\_increment number |
| [1037](#L1037) | $wpdb->query('INSERT INTO ' . $cas\_count . ' (id) VALUES (NULL)'); |
| [1038](#L1038) |  |
| [1039](#L1039) | // Get the id of the inserted count to feed to the word table and image generator |
| [1040](#L1040) | $cas\_rowid = $wpdb->get\_var('SELECT last\_insert\_id()'); |
| [1041](#L1041) |  |
| [1042](#L1042) | // Pick a random number |
| [1043](#L1043) | $cas\_antiselect = rand( 1, $cas\_textcount ); // 0 is for invalid, so don't select it |
| [1044](#L1044) |  |
| [1045](#L1045) | // Put the word corresponding to the random number into the database |
| [1046](#L1046) | $wpdb->query('INSERT INTO ' . $cas\_table . ' (id, createtime, word) VALUES (' . $cas\_rowid . ', ' . time() . ', \'' . $cas\_text[$cas\_antiselect] . '\')'); |
| [1047](#L1047) |  |
| [1048](#L1048) | // Delete the row from the count table |
| [1049](#L1049) | $wpdb->query('DELETE FROM ' . $cas\_count . ' WHERE id = ' . $cas\_rowid); |
| [1050](#L1050) |  |
| [1051](#L1051) | // Do some table admin while we can :D |
| [1052](#L1052) | if (strlen($cas\_rowid) == 10) { |
| [1053](#L1053) |  |
| [1054](#L1054) | // Delete all rows from the count table |
| [1055](#L1055) | $wpdb->query('DELETE FROM ' . $cas\_count); |
| [1056](#L1056) |  |
| [1057](#L1057) | // Reset the table's auto increment if it's getting too huge |
| [1058](#L1058) | $wpdb->query('ALTER TABLE ' . $cas\_count . ' AUTO\_INCREMENT=1'); |
| [1059](#L1059) |  |
| [1060](#L1060) | // Delete any anti-spam words more than a day old |
| [1061](#L1061) | $wpdb->query('DELETE FROM ' . $cas\_table . ' WHERE ' . time() . ' > createtime + 86400'); |
| [1062](#L1062) | } |
| [1063](#L1063) |  |
| [1064](#L1064) | echo( "\t\t\t".'<div style="display:block;" id="secureimgdiv">'."\n\t\t\t\t" ); |
| [1065](#L1065) | echo( "<p><label for=\"securitycode\">" . \_\_( 'Anti-spam image', 'peters\_custom\_anti\_spam' ) . "</label><span style=\"color:#FF0000;\">\*</span><br />\n\t\t\t\t" ); |
| [1066](#L1066) | echo( $cas\_message . "<br />\n\t\t\t\t" ); |
| [1067](#L1067) | echo( '<input type="text" name="securitycode" id="securitycode" size="30" />'."\n\t\t\t\t" ); |
| [1068](#L1068) | echo( '<input type="hidden" name="matchthis" value="' . $cas\_rowid . "\" />\n\t\t\t\t" ); |
| [1069](#L1069) | wp\_nonce\_field( 'cas\_register\_form' ); |
| [1070](#L1070) | if( $cas\_wav ) |
| [1071](#L1071) | { |
| [1072](#L1072) | echo( '<a href="' . $cas\_myurl . '/wp-content/plugins/' . end($cas\_thisfolder) . '/custom\_anti\_spam.php?audioselect=' . $cas\_rowid . '" title="' .  \_\_( 'Click to hear an audio file of the anti-spam word', 'peters\_custom\_anti\_spam' ) . '">' ); |
| [1073](#L1073) | } |
| [1074](#L1074) | echo( '<img src="' . $cas\_myurl . '/wp-content/plugins/' . end($cas\_thisfolder) . '/custom\_anti\_spam.php?antiselect=' . $cas\_rowid . "\"\n\t\t\t\t" ); |
| [1075](#L1075) | echo( 'alt="' . \_\_( 'Anti-spam image', 'peters\_custom\_anti\_spam' ) . '" ' ); |
| [1076](#L1076) | echo( 'style="border:1px solid ' . $cas\_borderclr . ';vertical-align:top;' ); |
| [1077](#L1077) | echo( 'height:' . $cas\_imgheight .'px;width:' . $cas\_imgwidth . 'px;" />' ); |
| [1078](#L1078) | if ($cas\_wav) echo( '</a>'); |
| [1079](#L1079) | echo( "</p>\n\t\t\t" ); |
| [1080](#L1080) | echo( "</div>\n\t\t\t" ); |
| [1081](#L1081) | } |
| [1082](#L1082) |  |
| [1083](#L1083) | function cas\_register\_post( $errors ) |
| [1084](#L1084) | { |
| [1085](#L1085) | global $cas\_textcount, $cas\_table, $wpdb; |
| [1086](#L1086) |  |
| [1087](#L1087) | $cas\_text = casFunctionCollection::get\_settings( 'text' ); |
| [1088](#L1088) | $cas\_reg\_blacklist = casFunctionCollection::get\_settings( 'reg\_blacklist' ); |
| [1089](#L1089) |  |
| [1090](#L1090) | // Validate the form input values |
| [1091](#L1091) | check\_admin\_referer( 'cas\_register\_form' ); |
| [1092](#L1092) | if( isset( $\_POST['securitycode'] ) ) |
| [1093](#L1093) | { |
| [1094](#L1094) | // Consider only the first 50 characters in the posted word |
| [1095](#L1095) | $securitycode = substr( strval( $\_POST['securitycode'] ), 0, 50 ); |
| [1096](#L1096) |  |
| [1097](#L1097) | // Remove all spaces and hyphens to give the commenter a break! |
| [1098](#L1098) | $securitycode = str\_replace(' ', '', $securitycode); |
| [1099](#L1099) | $securitycode = str\_replace('-', '', $securitycode); |
| [1100](#L1100) |  |
| [1101](#L1101) | } else { |
| [1102](#L1102) | $securitycode = ''; |
| [1103](#L1103) | } |
| [1104](#L1104) | if( isset( $\_POST['matchthis'] ) ) |
| [1105](#L1105) | { |
| [1106](#L1106) | $matchnum = intval( $\_POST['matchthis'] ); |
| [1107](#L1107) | } else { |
| [1108](#L1108) | $matchnum = 0; |
| [1109](#L1109) | } |
| [1110](#L1110) |  |
| [1111](#L1111) | if ( $securitycode == '' ) |
| [1112](#L1112) | { |
| [1113](#L1113) | $errors->add( 'cas\_register', \_\_( 'Error: Please enter the anti-spam word.', 'peters\_custom\_anti\_spam' ) ); |
| [1114](#L1114) | return $errors; |
| [1115](#L1115) | } |
| [1116](#L1116) | else { |
| [1117](#L1117) | // Get the anti-spam word from the database |
| [1118](#L1118) | $matchthis = $wpdb->get\_var('SELECT word FROM ' . $cas\_table . ' WHERE id = ' . $matchnum); |
| [1119](#L1119) |  |
| [1120](#L1120) | // If this row doesn't exist, say something |
| [1121](#L1121) | if( is\_null( $matchthis ) ) |
| [1122](#L1122) | { |
| [1123](#L1123) | $errors->add( 'cas\_register', \_\_( 'ERROR: The anti-spam word is no longer valid.', 'peters\_custom\_anti\_spam' ) ); |
| [1124](#L1124) | return $errors; |
| [1125](#L1125) | } |
| [1126](#L1126) |  |
| [1127](#L1127) | else |
| [1128](#L1128) | { |
| [1129](#L1129) |  |
| [1130](#L1130) | // Remove all spaces and hyphens, since we removed them from what the commenter entered |
| [1131](#L1131) | $matchthis = str\_replace(' ', '', $matchthis); |
| [1132](#L1132) | $matchthis = str\_replace('-', '', $matchthis); |
| [1133](#L1133) |  |
| [1134](#L1134) | // Check what was entered against what the code should be |
| [1135](#L1135) | if ( strtolower( $matchthis ) != strtolower( $securitycode ) ) |
| [1136](#L1136) | { |
| [1137](#L1137) | $errors->add( 'cas\_register', \_\_( 'ERROR: Please enter the correct anti-spam word.', 'peters\_custom\_anti\_spam' ) ); |
| [1138](#L1138) | return $errors; |
| [1139](#L1139) | } |
| [1140](#L1140) |  |
| [1141](#L1141) | else { |
| [1142](#L1142) | // The word matched, so delete the row for the anti-spam word so that it cannot be used again |
| [1143](#L1143) | $wpdb->query('DELETE FROM ' . $cas\_table . ' WHERE id = ' . $matchnum); |
| [1144](#L1144) | unset( $matchthis ); |
| [1145](#L1145) |  |
| [1146](#L1146) | // Do some more table admin while we can :D |
| [1147](#L1147) | // Delete any anti-spam words more than a day old |
| [1148](#L1148) | $wpdb->query('DELETE FROM ' . $cas\_table . ' WHERE ' . time() . ' > createtime + 86400'); |
| [1149](#L1149) | } |
| [1150](#L1150) | } |
| [1151](#L1151) | } |
| [1152](#L1152) | foreach( $cas\_reg\_blacklist as $cas\_blacklist ) |
| [1153](#L1153) | { |
| [1154](#L1154) | if( stristr( $\_POST['user\_email'], $cas\_blacklist ) ) |
| [1155](#L1155) | { |
| [1156](#L1156) | $errors->add( 'cas\_register', \_\_( 'ERROR: That e-mail address has been blocked.', 'peters\_custom\_anti\_spam' ) ); |
| [1157](#L1157) | return $errors; |
| [1158](#L1158) | } |
| [1159](#L1159) | } |
| [1160](#L1160) | return $errors; |
| [1161](#L1161) | } |
| [1162](#L1162) |  |
| [1163](#L1163) | // Add registration protection to the appropriate hooks only if it has been enabled in this plugin's settings |
| [1164](#L1164) | if( casFunctionCollection::get\_settings( 'reg\_protection' ) ) |
| [1165](#L1165) | { |
| [1166](#L1166) | add\_action('register\_form', 'cas\_register\_form'); |
| [1167](#L1167) | add\_action('registration\_errors', 'cas\_register\_post', 1, 1); |
| [1168](#L1168) | } |
| [1169](#L1169) | } |
| [1170](#L1170) |  |
| [1171](#L1171) | // Some helper functions, all "public static" in PHP5 land |
| [1172](#L1172) | class casFunctionCollection |
| [1173](#L1173) | { |
| [1174](#L1174) | /\* |
| [1175](#L1175) | Grabs settings from the database as of version 3.2.0 of this plugin. |
| [1176](#L1176) | Defaults are defined here, but the settings values should be edited in the WordPress admin panel. |
| [1177](#L1177) | If no setting is asked for, then it returns an array of all settings; otherwise it returns a specific setting |
| [1178](#L1178) | \*/ |
| [1179](#L1179) | static function get\_settings( $setting=false ) |
| [1180](#L1180) | { |
| [1181](#L1181) | $cas\_settings = array(); |
| [1182](#L1182) |  |
| [1183](#L1183) | $cas\_settings['text'] = array( 'dan', 'broad', 'way', 'toast', 'micro', 'wave', 'ikea', 'rent', 'move', 'van', 'connect' ); |
| [1184](#L1184) |  |
| [1185](#L1185) | // Set this to equal TRUE if you want to force registered users to enter the anti-spam word as well. |
| [1186](#L1186) | $cas\_settings['forcereg'] = true; |
| [1187](#L1187) |  |
| [1188](#L1188) | // Set this to equal TRUE if you want to allow trackbacks (but be vulnerable to trackback spam) |
| [1189](#L1189) | $cas\_settings['allowtrack'] = true; |
| [1190](#L1190) |  |
| [1191](#L1191) | // Set this to equal TRUE if you want to send all trackbacks to the moderation queue (only works if the above setting is TRUE) |
| [1192](#L1192) | $cas\_settings['modtrack'] = false; |
| [1193](#L1193) |  |
| [1194](#L1194) | // Set this to equal TRUE if you want to allow pingbacks (but be vulnerable to pingback spam) |
| [1195](#L1195) | $cas\_settings['allowping'] = true; |
| [1196](#L1196) |  |
| [1197](#L1197) | // Set this to equal TRUE if you want to send all pingbacks to the moderation queue (only works if the above setting is TRUE) |
| [1198](#L1198) | $cas\_settings['modping'] = false; |
| [1199](#L1199) |  |
| [1200](#L1200) | $cas\_settings['fontlist'] = array(); |
| [1201](#L1201) | // List as many TrueType font(s) as you like, one per line. Drop your own font files into this plugin's directory. |
| [1202](#L1202) | // If you are using your own fonts, make sure all fonts used are about the same default size. |
| [1203](#L1203) | // If you want some fonts to be used more frequently, enter them multiple times. |
| [1204](#L1204) | // Default freeware fonts from fonts101.com |
| [1205](#L1205) | $cas\_settings['fontlist'][] = "04b03.ttf"; |
| [1206](#L1206) | $cas\_settings['fontlist'][] = "atkinsoutlinemedium-regular.ttf"; |
| [1207](#L1207) | $cas\_settings['fontlist'][] = "decorative-stylisticblackout-regular.ttf"; |
| [1208](#L1208) | $cas\_settings['fontlist'][] = "okrienhmk.ttf"; |
| [1209](#L1209) | $cas\_settings['fontlist'][] = "ttstepha.ttf"; |
| [1210](#L1210) | $cas\_settings['fontlist'][] = "vtckomixationhand.ttf"; |
| [1211](#L1211) |  |
| [1212](#L1212) | // Set the anti-spam image width and height. |
| [1213](#L1213) | // You may need to increase these sizes for longer words and/or bigger fonts. |
| [1214](#L1214) | $cas\_settings['imgwidth'] = 160; |
| [1215](#L1215) | $cas\_settings['imgheight'] = 50; |
| [1216](#L1216) |  |
| [1217](#L1217) | // Set this to TRUE if you want to use random text colors. |
| [1218](#L1218) | // If random colors are not selected, blue text will appear on a white background, and white text will appear on black background (as decided in the next option) |
| [1219](#L1219) | $cas\_settings['randomcolors'] = true; |
| [1220](#L1220) |  |
| [1221](#L1221) | // Set the background color for the anti-spam image. |
| [1222](#L1222) | // Choose either "black" or "white" |
| [1223](#L1223) | $cas\_settings['bgcolorset'] = 'white'; |
| [1224](#L1224) |  |
| [1225](#L1225) | // Set the border color for the anti-spam image. |
| [1226](#L1226) | // Write either major colors (red, green, blue, etc.) or enter the HTML color code (such as #C0C0C0) |
| [1227](#L1227) | $cas\_settings['borderclr'] = 'black'; |
| [1228](#L1228) |  |
| [1229](#L1229) | // Set this to TRUE if you prefer PNG graphics (better quality text) |
| [1230](#L1230) | // Set this to FALSE if you prefer more compatable graphics (PNG crashes IE 4; JPEG does not) |
| [1231](#L1231) | $cas\_settings['UsePngNotJpeg'] = false; |
| [1232](#L1232) |  |
| [1233](#L1233) | // Set this to TRUE if you will be editing your comments file (add this php line wherever you want the anti-spam image inserted in the comments.php file: do\_action('secure\_image', $post->ID); ) |
| [1234](#L1234) | // Set this to FALSE if you want to use the default JavaScript positioning |
| [1235](#L1235) | $cas\_settings['manualinsert'] = false; |
| [1236](#L1236) |  |
| [1237](#L1237) | // Set this to TRUE if you are using a caching plugin that doesn't allow parts of pages to be exempt from caching. |
| [1238](#L1238) | // When this is set to TRUE, the plugin will use JavaScript to generate the image |
| [1239](#L1239) | $cas\_settings['js\_generate'] = false; |
| [1240](#L1240) |  |
| [1241](#L1241) | // Set this to TRUE to enable wav files of the anti-spam words so that visually enabled users can comment |
| [1242](#L1242) | $cas\_settings['wav'] = true; |
| [1243](#L1243) |  |
| [1244](#L1244) | // Set this to FALSE if you know that your server doesn't have the sox filter or if you do not want to stretch the audio files by a variable rate |
| [1245](#L1245) | $cas\_settings['sox'] = true; |
| [1246](#L1246) |  |
| [1247](#L1247) | // Set this to TRUE to insert anti-spam protection to the registration form |
| [1248](#L1248) | $cas\_settings['reg\_protection'] = false; |
| [1249](#L1249) |  |
| [1250](#L1250) | $cas\_settings['reg\_blacklist'] = array(); |
| [1251](#L1251) | // Registration blacklist. Enter either e-mail address or domains (like 'theblog.ca') of e-mail addresses you don't want to allow |
| [1252](#L1252) | // Be careful, because if you enter 'theblog.ca' if an e-mail address contains that string anywhere, it will be blocked |
| [1253](#L1253) | $cas\_settings['reg\_blacklist'][] = 'exampleaddressthatwontmatch.bc.ca'; |
| [1254](#L1254) |  |
| [1255](#L1255) | $cas\_settings\_from\_options\_table = casFunctionCollection::get\_settings\_from\_options\_table(); |
| [1256](#L1256) |  |
| [1257](#L1257) | // Merge the default settings with the settings form the database |
| [1258](#L1258) | // Limit the settings in case there are ones from the database that are old |
| [1259](#L1259) | foreach( $cas\_settings as $setting\_name => $setting\_value ) |
| [1260](#L1260) | { |
| [1261](#L1261) | if( isset( $cas\_settings\_from\_options\_table[$setting\_name] ) ) |
| [1262](#L1262) | { |
| [1263](#L1263) | $cas\_settings[$setting\_name] = $cas\_settings\_from\_options\_table[$setting\_name]; |
| [1264](#L1264) | } |
| [1265](#L1265) | } |
| [1266](#L1266) | if( !$setting ) |
| [1267](#L1267) | { |
| [1268](#L1268) | return $cas\_settings; |
| [1269](#L1269) | } |
| [1270](#L1270) | elseif( $setting && isset( $cas\_settings[$setting] ) ) |
| [1271](#L1271) | { |
| [1272](#L1272) | return $cas\_settings[$setting]; |
| [1273](#L1273) | } |
| [1274](#L1274) | else |
| [1275](#L1275) | { |
| [1276](#L1276) | return false; |
| [1277](#L1277) | } |
| [1278](#L1278) | } |
| [1279](#L1279) | static function get\_settings\_from\_options\_table() |
| [1280](#L1280) | { |
| [1281](#L1281) | return get\_option( 'cas\_settings', array() ); |
| [1282](#L1282) | } |
| [1283](#L1283) | static function set\_setting( $setting = false, $value = false ) |
| [1284](#L1284) | { |
| [1285](#L1285) | if( $setting ) |
| [1286](#L1286) | { |
| [1287](#L1287) | $current\_settings = casFunctionCollection::get\_settings(); |
| [1288](#L1288) | if( $current\_settings ) |
| [1289](#L1289) | { |
| [1290](#L1290) | $current\_settings[$setting] = $value; |
| [1291](#L1291) | update\_option( 'cas\_settings', $current\_settings ); |
| [1292](#L1292) | } |
| [1293](#L1293) | } |
| [1294](#L1294) | } |
| [1295](#L1295) | } |
| [1296](#L1296) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?format=txt)
* [Original Format](/export/3222495/peters-custom-anti-spam-image/trunk/custom_anti_spam.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_f34c7f21_20250114_223037.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3208894)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3208893 "Changeset 3208893")
* [Next Changeset](/changeset/3208895 "Changeset 3208895") →

---

# Changeset 3208894

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
12/17/2024 05:49:08 AM
([4 weeks](/timeline?from=2024-12-17T05%3A49%3A08Z&precision=second "See timeline at 12/17/2024 05:49:08 AM") ago)

Author:
pkthree
Message:

Peter's Custom Anti-Spam Image Version 3.2.4

Location:
[peters-custom-anti-spam-image/trunk](/browser/peters-custom-anti-spam-image/trunk?rev=3208894)
Files:

2 edited

* [custom\_anti\_spam.php](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?rev=3208894 "Show entry in browser")
  (modified)
  ([4 diffs](#file0 "Show differences"))
* [readme.txt](/browser/peters-custom-anti-spam-image/trunk/readme.txt?rev=3208894 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [peters-custom-anti-spam-image/trunk/custom\_anti\_spam.php](/changeset/3208894/peters-custom-anti-spam-image/trunk/custom_anti_spam.php "Show the changeset 3208894 restricted to peters-custom-anti-spam-image/trunk/custom_anti_spam.php")

  | [r2960936](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?rev=2960936#L5 "Show revision 2960936 of this file in browser") | [r3208894](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?rev=3208894#L5 "Show revision 3208894 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Description: Stop a lot of spambots from polluting your site by making visitors identify a random word displayed as an image before commenting. You can customize the pool of words to display. |
  | 6 | 6 | Author: Peter Keung |
  | 7 |  | Version: 3.2.~~3~~ |
  |  | 7 | Version: 3.2.4 |
  | 8 | 8 | Author URI: https://www.theblog.ca/ |
  | 9 | 9 | Change Log: |
  |  | 10 | 2024-12-16  Version 3.2.4  Fix CSRF vulnerability on register |
  | 10 | 11 | 2023-08-30  Version 3.2.3  Fix back-end XSS vulnerability |
  | 11 | 12 | 2014-02-08  Version 3.2.2  Minor code cleanup (thanks koc!) |
  | […](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?rev=2960936#L89) | […](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?rev=3208894#L90) |  |
  | 89 | 90 |  |
  | 90 | 91 | global $cas\_version; |
  | 91 |  | $cas\_version = '3.2.~~2~~'; |
  |  | 92 | $cas\_version = '3.2.4'; |
  | 92 | 93 |  |
  | 93 | 94 | $cas\_text = casFunctionCollection::get\_settings( 'text' ); |
  | […](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?rev=2960936#L1066) | […](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?rev=3208894#L1067) |  |
  | 1066 | 1067 | echo( '<input type="text" name="securitycode" id="securitycode" size="30" />'."\n\t\t\t\t" ); |
  | 1067 | 1068 | echo( '<input type="hidden" name="matchthis" value="' . $cas\_rowid . "\" />\n\t\t\t\t" ); |
  |  | 1069 | wp\_nonce\_field( 'cas\_register\_form' ); |
  | 1068 | 1070 | if( $cas\_wav ) |
  | 1069 | 1071 | { |
  | […](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?rev=2960936#L1087) | […](/browser/peters-custom-anti-spam-image/trunk/custom_anti_spam.php?rev=3208894#L1089) |  |
  | 1087 | 1089 |  |
  | 1088 | 1090 | // Validate the form input values |
  |  | 1091 | check\_admin\_referer( 'cas\_register\_form' ); |
  | 1089 | 1092 | if( isset( $\_POST['securitycode'] ) ) |
  | 1090 | 1093 | { |
* ## [peters-custom-anti-spam-image/trunk/readme.txt](/changeset/3208894/peters-custom-anti-spam-image/trunk/readme.txt "Show the changeset 3208894 restricted to peters-custom-anti-spam-image/trunk/readme.txt")

  | [r2960936](/browser/peters-custom-anti-spam-image/trunk/readme.txt?rev=2960936#L64 "Show revision 2960936 of this file in browser") | [r3208894](/browser/peters-custom-anti-spam-image/trunk/readme.txt?rev=3208894#L64 "Show revision 3208894 of this file in browser") |  |
  | --- | --- | --- |
  | 64 | 64 | == Changelog == |
  | 65 | 65 |  |
  |  | 66 | = 3.2.4 = |
  |  | 67 | \* 2024-12-16: Fix CSRF vulnerability on register |
  |  | 68 |  |
  | 66 | 69 | = 3.2.3 = |
  | 67 | 70 | \* 2023-08-30: Fix back-end XSS vulnerability |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3208894)
* [Zip Archive](?format=zip&new=3208894)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


