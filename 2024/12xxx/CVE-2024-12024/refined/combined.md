=== Content from www.wordfence.com_219118a7_20250114_200735.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# EventPrime – Events Calendar, Bookings and Tickets <= 4.0.5.3 - Unauthenticated Stored Cross-Site Scripting via Ticket Category and Ticket Type Name

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   EventPrime – Events Calendar, Bookings and Tickets <= 4.0.5.3 - Unauthenticated Stored Cross-Site Scripting via Ticket Category and Ticket Type Name

7.2

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-12024](https://www.cve.org/CVERecord?id=CVE-2024-12024) |
| --- | --- |
| CVSS | 7.2 (High) |
| Publicly Published | December 16, 2024 |
| Last Updated | December 17, 2024 |
| Researcher | [zer0gh0st](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/zer0gh0st) |

### Description

The EventPrime – Events Calendar, Bookings and Tickets plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the em\_ticket\_category\_data and em\_ticket\_individual\_data parameters in all versions up to, and including, 4.0.5.3 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that will execute whenever an administrative user accesses an injected page.
Note: this vulnerability requires the "Guest Submissions" setting to be enabled. It is disabled by default.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php#L971)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php#L1245)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-eventprime-sanitizer.php#L122)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php#L216)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php#L264)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Feventprime-event-calendar-management%2Feventprime-events-calendar-bookings-and-tickets-4053-unauthenticated-stored-cross-site-scripting-via-ticket-category-and-ticket-type-name&t=EventPrime%20%E2%80%93%20Events%20Calendar%2C%20Bookings%20and%20Tickets%20%3C%3D%204.0.5.3%20-%20Unauthenticated%20Stored%20Cross-Site%20Scripting%20via%20Ticket%20Category%20and%20Ticket%20Type%20Name "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Feventprime-event-calendar-management%2Feventprime-events-calendar-bookings-and-tickets-4053-unauthenticated-stored-cross-site-scripting-via-ticket-category-and-ticket-type-name&text=EventPrime%20%E2%80%93%20Events%20Calendar%2C%20Bookings%20and%20Tickets%20%3C%3D%204.0.5.3%20-%20Unauthenticated%20Stored%20Cross-Site%20Scripting%20via%20Ticket%20Category%20and%20Ticket%20Type%20Name "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Feventprime-event-calendar-management%2Feventprime-events-calendar-bookings-and-tickets-4053-unauthenticated-stored-cross-site-scripting-via-ticket-category-and-ticket-type-name "LinkedIn")
Email

## Vulnerability Details for EventPrime – Events Calendar, Bookings and Tickets

#### [EventPrime – Events Calendar, Bookings and Tickets](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/eventprime-event-calendar-management)

| Software Type | Plugin |
| --- | --- |
| Software Slug | eventprime-event-calendar-management [(view on wordpress.org)](https://wordpress.org/plugins/eventprime-event-calendar-management) |
| Patched? | Yes |
| Remediation | Update to version 4.0.6.0, or a newer patched version |
| Affected Version | * <= 4.0.5.3 |
| Patched Version | * 4.0.6.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_96a675e0_20250114_200729.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Feventprime-event-calendar-management%2Ftags%2F4.0.5.3%2Fincludes%2Fclass-ep-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [eventprime-event-calendar-management](/browser/eventprime-event-calendar-management?order=name "View eventprime-event-calendar-management")/[tags](/browser/eventprime-event-calendar-management/tags?order=name "View tags")/[4.0.5.3](/browser/eventprime-event-calendar-management/tags/4.0.5.3?order=name "View 4.0.5.3")/[includes](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes?order=name "View includes")/[class-ep-ajax.php](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php?order=name "View class-ep-ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3199413/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php "View differences") on this file was [3199413](/changeset/3199413/ "View changeset 3199413"), checked in by metagauss, [7 weeks ago](/timeline?from=2024-11-29T11%3A51%3A04Z&precision=second "See timeline at 11/29/2024 11:51:04 AM") |
| --- |
| Tag 4.0.5.3 |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 169.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* EventPrime Ajax Event Handler Class. |
| [4](#L4) | \*/ |
| [5](#L5) | defined( 'ABSPATH' ) || exit; |
| [6](#L6) |  |
| [7](#L7) | class EventM\_Ajax\_Service { |
| [8](#L8) |  |
| [9](#L9) | public function cancel\_current\_booking\_process() { |
| [10](#L10) | // Add security checks |
| [11](#L11) | if( wp\_verify\_nonce( $\_POST['security'], 'event-registration-form-nonce' ) ) { |
| [12](#L12) | $event\_id = absint( $\_POST['event\_id'] ); |
| [13](#L13) | $ticket\_data = json\_decode( stripslashes( $\_POST['ticket\_data'] ) ); |
| [14](#L14) |  |
| [15](#L15) | $event\_seat\_data = get\_post\_meta( $event\_id, 'em\_seat\_data', true ); |
| [16](#L16) | if( ! empty( $event\_seat\_data ) ) { |
| [17](#L17) | // wp\_send\_json\_success('seated event'); |
| [18](#L18) |  |
| [19](#L19) | if ( class\_exists( 'EventM\_Live\_Seating\_List\_Controller' ) ) { |
| [20](#L20) | $seating\_controller = new EventM\_Live\_Seating\_List\_Controller; |
| [21](#L21) | } |
| [22](#L22) | $em\_ls\_seat\_plan\_id = get\_post\_meta( $event\_id, 'em\_ls\_seat\_plan', true ); |
| [23](#L23) | $plan\_color\_data = $seating\_controller->get\_plan\_colors\_data( $em\_ls\_seat\_plan\_id ); |
| [24](#L24) |  |
| [25](#L25) | $event\_seat\_data = maybe\_unserialize( $event\_seat\_data ); |
| [26](#L26) | foreach( $ticket\_data as $tickets ) { |
| [27](#L27) | if( ! empty( $tickets->seats ) ) { |
| [28](#L28) | $ticket\_seats = $tickets->seats; |
| [29](#L29) | foreach( $ticket\_seats as $seats\_data ) { |
| [30](#L30) | $ticket\_area\_id = $seats\_data->area\_id; |
| [31](#L31) | if( $event\_seat\_data->{$ticket\_area\_id} ) { |
| [32](#L32) | $ticket\_seat\_data = $seats\_data->seat\_data; |
| [33](#L33) | if( ! empty( $ticket\_seat\_data ) ) { |
| [34](#L34) | foreach( $ticket\_seat\_data as $tsd ) { |
| [35](#L35) | if( ! empty( $tsd->uid ) ) { |
| [36](#L36) | $seat\_uid = $tsd->uid; |
| [37](#L37) | $seat\_uid = explode( '-', $seat\_uid ); |
| [38](#L38) | $row\_index = $seat\_uid[0]; |
| [39](#L39) | $col\_index = $seat\_uid[1]; |
| [40](#L40) | if( ! empty( $event\_seat\_data->{$ticket\_area\_id}->seats[$row\_index] ) ) { |
| [41](#L41) |  |
| [42](#L42) | foreach ( $event\_seat\_data->{$ticket\_area\_id}->seats[$row\_index] as $key => $seat ) { |
| [43](#L43) | if ( $seat->col == $col\_index ) { |
| [44](#L44) | if( $seat->type == 'hold' ) { |
| [45](#L45) | $seat->type = 'general'; |
| [46](#L46) | $seat->hold\_time = ''; |
| [47](#L47) | $seat\_available\_color = $plan\_color\_data['seat\_available\_color']; |
| [48](#L48) | $seat->seatColor = $seat\_available\_color; |
| [49](#L49) |  |
| [50](#L50) | $event\_seat\_data->{$ticket\_area\_id}->seats[$row\_index][$key]  = $seat; |
| [51](#L51) | } |
| [52](#L52) | } |
| [53](#L53) | } |
| [54](#L54) |  |
| [55](#L55) | } |
| [56](#L56) | } |
| [57](#L57) | } |
| [58](#L58) | } |
| [59](#L59) | } |
| [60](#L60) | } |
| [61](#L61) | } |
| [62](#L62) | } |
| [63](#L63) |  |
| [64](#L64) | $update =  update\_post\_meta( $event\_id, 'em\_seat\_data', maybe\_serialize( $event\_seat\_data ) ); |
| [65](#L65) | wp\_send\_json\_success($update); |
| [66](#L66) |  |
| [67](#L67) | } else { |
| [68](#L68) | wp\_send\_json\_success('not a seated event'); |
| [69](#L69) | } |
| [70](#L70) | } else { |
| [71](#L71) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-seating' ) ) ); |
| [72](#L72) | } |
| [73](#L73) |  |
| [74](#L74) |  |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | /\*\* |
| [78](#L78) | \* save checkout field |
| [79](#L79) | \*/ |
| [80](#L80) | public function save\_checkout\_field() { |
| [81](#L81) | check\_ajax\_referer( 'save-checkout-fields', 'security' ); |
| [82](#L82) |  |
| [83](#L83) | $response = array(); |
| [84](#L84) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [85](#L85) | if( ! isset( $data['em\_checkout\_field\_label'] ) || empty( $data['em\_checkout\_field\_label'] ) ) { |
| [86](#L86) | $response['message'] = esc\_html\_\_( 'Label should not be empty', 'eventprime-event-calendar-management' ); |
| [87](#L87) | wp\_send\_json\_error($response); |
| [88](#L88) | } |
| [89](#L89) | if( ! isset( $data['em\_checkout\_field\_type'] ) || empty( $data['em\_checkout\_field\_type'] ) ) { |
| [90](#L90) | $response['message'] = esc\_html\_\_( 'Type should not be empty', 'eventprime-event-calendar-management' ); |
| [91](#L91) | wp\_send\_json\_error( $response ); |
| [92](#L92) | } |
| [93](#L93) | try{ |
| [94](#L94) |  |
| [95](#L95) | $dbhandler = new EP\_DBhandler; |
| [96](#L96) | $table\_name = 'CHECKOUT\_FIELDS'; |
| [97](#L97) | $save\_data = array(); |
| [98](#L98) | $save\_data['label'] = sanitize\_text\_field( $data['em\_checkout\_field\_label'] ); |
| [99](#L99) | $save\_data['type'] = sanitize\_text\_field( $data['em\_checkout\_field\_type'] ); |
| [100](#L100) | // for option data |
| [101](#L101) | $save\_data['option\_data'] = ''; |
| [102](#L102) | $option\_data = ( ! empty( $data['ep\_checkout\_field\_option\_value'] ) ? $data['ep\_checkout\_field\_option\_value'] : '' ); |
| [103](#L103) | // set selected value |
| [104](#L104) | if( ! empty( $data['ep\_checkout\_field\_option\_value\_selected'] ) ) { |
| [105](#L105) | $option\_index = $data['ep\_checkout\_field\_option\_value\_selected']; |
| [106](#L106) | $option\_data[$option\_index]['selected'] = 1; |
| [107](#L107) | } |
| [108](#L108) | if( ! empty( $option\_data ) ) { |
| [109](#L109) | $save\_data['option\_data'] = maybe\_serialize( $option\_data ); |
| [110](#L110) | } |
| [111](#L111) | if( empty( $data['em\_checkout\_field\_id'] ) ) { |
| [112](#L112) | $save\_data['priority'] = 1; |
| [113](#L113) | $save\_data['status'] = 1; |
| [114](#L114) | $save\_data['created\_by'] = get\_current\_user\_id(); |
| [115](#L115) | $save\_data['created\_at'] = date\_i18n( "Y-m-d H:i:s", time() ); |
| [116](#L116) | $field\_id = $dbhandler->insert\_row($table\_name, $save\_data); |
| [117](#L117) | $response['message'] = esc\_html\_\_( 'Field Saved Successfully.', 'eventprime-event-calendar-management' ); |
| [118](#L118) | } else{ |
| [119](#L119) | $field\_id = absint( $data['em\_checkout\_field\_id'] ); |
| [120](#L120) | $save\_data['updated\_at'] = date\_i18n( "Y-m-d H:i:s", time() ); |
| [121](#L121) | $save\_data['last\_updated\_by'] = get\_current\_user\_id(); |
| [122](#L122) | $result = $dbhandler->update\_row($table\_name,'id', $field\_id, $save\_data); |
| [123](#L123) | $response['message'] = esc\_html\_\_( 'Field Updated Successfully.', 'eventprime-event-calendar-management' ); |
| [124](#L124) | } |
| [125](#L125) | $save\_data['field\_id'] = $field\_id; |
| [126](#L126) | $response['field\_data'] = $save\_data; |
| [127](#L127) | } catch( Exception $e ) { |
| [128](#L128) | wp\_send\_json\_error( array( 'error' => $e->getMessage() ) ); |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | wp\_send\_json\_success( $response ); |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) | // delete the checkout field |
| [135](#L135) | public function delete\_checkout\_field(){ |
| [136](#L136) | check\_ajax\_referer( 'delete-checkout-fields', 'security' ); |
| [137](#L137) |  |
| [138](#L138) | $response = array(); |
| [139](#L139) | if( isset( $\_POST['field\_id'] ) && ! empty( $\_POST['field\_id'] ) ) { |
| [140](#L140) | $id = $\_POST['field\_id']; |
| [141](#L141) | $dbhandler = new EP\_DBhandler; |
| [142](#L142) | $table\_name = 'CHECKOUT\_FIELDS'; |
| [143](#L143) | $get\_field\_data = $dbhandler->get\_all\_result($table\_name,'\*',array('id'=>$id)); |
| [144](#L144) | if( ! empty( $get\_field\_data ) && count( $get\_field\_data ) > 0 ) { |
| [145](#L145) | $dbhandler->remove\_row($table\_name,'id',$id); |
| [146](#L146) | $response['message'] = esc\_html\_\_( 'Field Deleted Successfully.', 'eventprime-event-calendar-management' ); |
| [147](#L147) | } else{ |
| [148](#L148) | $response['message'] = esc\_html\_\_( 'No Record Found.', 'eventprime-event-calendar-management' ); |
| [149](#L149) | wp\_send\_json\_error( $response ); |
| [150](#L150) | } |
| [151](#L151) | } else{ |
| [152](#L152) | $response['message'] = esc\_html\_\_( 'Some Data Missing.', 'eventprime-event-calendar-management' ); |
| [153](#L153) | wp\_send\_json\_error( $response ); |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | wp\_send\_json\_success( $response ); |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) | public function submit\_payment\_setting(){ |
| [160](#L160) | $payment\_gateway = apply\_filters( 'ep\_payments\_gateways\_list', array() ); |
| [161](#L161) | $global\_settings = new Eventprime\_Global\_Settings; |
| [162](#L162) | $global\_settings\_data = $global\_settings->ep\_get\_settings(); |
| [163](#L163) | $form\_data = $\_POST; |
| [164](#L164) | if( isset( $form\_data ) && isset( $form\_data['em\_payment\_type'] ) ) { |
| [165](#L165) | if( $form\_data['em\_payment\_type'] == 'basic' ) { |
| [166](#L166) | $payment\_method = isset( $form\_data['payment\_method'] ) && ! empty( $form\_data['payment\_method'] ) ? sanitize\_text\_field( $form\_data['payment\_method'] ) : ''; |
| [167](#L167) | $method\_status = $form\_data['method\_status']; |
| [168](#L168) | $nonce = wp\_create\_nonce('ep\_settings\_tab'); |
| [169](#L169) | if( ! empty( $method\_status ) ) { |
| [170](#L170) | if( $payment\_method == 'paypal\_processor' ) { |
| [171](#L171) | if( empty( $global\_settings\_data->paypal\_client\_id ) && $method\_status == 1 ) { |
| [172](#L172) | $url = add\_query\_arg( array( 'settings-updated' => false, 'tab'=> 'payments', 'section'=> 'paypal','tab\_nonce'=>$nonce ), admin\_url().'edit.php?post\_type=em\_event&page=ep-settings' ); |
| [173](#L173) | wp\_send\_json\_success( array( 'url' => $url ) ); |
| [174](#L174) | } |
| [175](#L175) | } |
| [176](#L176) | if( $payment\_method == 'stripe\_processor' ) { |
| [177](#L177) | if( ( empty( $global\_settings\_data->stripe\_api\_key ) || empty( $global\_settings\_data->stripe\_pub\_key ) ) && $method\_status == 1 ) { |
| [178](#L178) | $url = add\_query\_arg( array( 'settings-updated' => false, 'tab'=> 'payments', 'section'=> 'stripe','tab\_nonce'=>$nonce ), admin\_url().'edit.php?post\_type=em\_event&page=ep-settings' ); |
| [179](#L179) | wp\_send\_json\_success( array( 'url' => $url ) ); |
| [180](#L180) | } |
| [181](#L181) | } |
| [182](#L182) | } |
| [183](#L183) | if( ! empty( $payment\_method ) ) { |
| [184](#L184) | $global\_settings\_data->$payment\_method = $method\_status; |
| [185](#L185) | } |
| [186](#L186) | } |
| [187](#L187) | $global\_settings->ep\_save\_settings( $global\_settings\_data ); |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) | $method = ucfirst( explode( '\_', $payment\_method )[0] ); |
| [191](#L191) |  |
| [192](#L192) | $message = $method . ' ' . esc\_html\_\_( 'is activated.', 'eventprime-event-calendar-management' ); |
| [193](#L193) | if( $method\_status == 0 ) { |
| [194](#L194) | $message = $method . ' ' . esc\_html\_\_( 'is deactivated.', 'eventprime-event-calendar-management' ); |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | wp\_send\_json\_success( array( 'url' => '', 'message' => $message ) ); |
| [198](#L198) | die(); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | public function submit\_login\_form(){ |
| [202](#L202) | $user\_controller = new EventM\_User\_Controller(); |
| [203](#L203) | $response = $user\_controller->ep\_handle\_login(); |
| [204](#L204) | wp\_send\_json\_success($response); |
| [205](#L205) | die(); |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) | public function submit\_register\_form(){ |
| [209](#L209) | $user\_controller = new EventM\_User\_Controller(); |
| [210](#L210) | $response = $user\_controller->ep\_handle\_registration(); |
| [211](#L211) | wp\_send\_json\_success($response); |
| [212](#L212) | die(); |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) | /\* |
| [216](#L216) | \* Load more Event Types |
| [217](#L217) | \*/ |
| [218](#L218) | public function load\_more\_event\_types(){ |
| [219](#L219) | $controller = new Eventprime\_Basic\_Functions; |
| [220](#L220) | $response = $controller->get\_event\_types\_loadmore(); |
| [221](#L221) | wp\_send\_json\_success($response); |
| [222](#L222) | die(); |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) | /\* |
| [226](#L226) | \* Load More Event Performer |
| [227](#L227) | \*/ |
| [228](#L228) | public function load\_more\_event\_performer(){ |
| [229](#L229) | $controller = new Eventprime\_Basic\_Functions; |
| [230](#L230) | $response = $controller->get\_event\_performer\_loadmore(); |
| [231](#L231) | wp\_send\_json\_success($response); |
| [232](#L232) | die(); |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | /\* |
| [236](#L236) | \* Load More Event Venue |
| [237](#L237) | \*/ |
| [238](#L238) | public function load\_more\_event\_venue(){ |
| [239](#L239) | $controller = new Eventprime\_Basic\_Functions; |
| [240](#L240) | $response = $controller->get\_event\_venue\_loadmore(); |
| [241](#L241) | wp\_send\_json\_success($response); |
| [242](#L242) | die(); |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) | /\* |
| [246](#L246) | \* Load More Event Organizers |
| [247](#L247) | \*/ |
| [248](#L248) | public function load\_more\_event\_organizer(){ |
| [249](#L249) | $controller = new Eventprime\_Basic\_Functions; |
| [250](#L250) | $response = $controller->get\_event\_organizer\_loadmore(); |
| [251](#L251) | wp\_send\_json\_success($response); |
| [252](#L252) | die(); |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) | /\* |
| [256](#L256) | \* Load More Events |
| [257](#L257) | \*/ |
| [258](#L258) | public function load\_more\_events(){ |
| [259](#L259) | $controller = new Eventprime\_Basic\_Functions; |
| [260](#L260) | $response = $controller->get\_events\_loadmore(); |
| [261](#L261) | wp\_send\_json\_success($response); |
| [262](#L262) | die(); |
| [263](#L263) | } |
| [264](#L264) | /\*\* |
| [265](#L265) | \* Load single event page on chenge of child event date |
| [266](#L266) | \*/ |
| [267](#L267) | public function load\_event\_single\_page() { |
| [268](#L268) | check\_ajax\_referer( 'single-event-data-nonce', 'security' ); |
| [269](#L269) |  |
| [270](#L270) | if( isset( $\_POST['event\_id'] ) && ! empty( $\_POST['event\_id'] ) ) { |
| [271](#L271) | $event\_id = absint( $\_POST['event\_id'] ); |
| [272](#L272) | $event\_controller = new Eventprime\_Basic\_Functions; |
| [273](#L273) | $single\_event = $event\_controller->ep\_load\_other\_date\_event\_detail( $event\_id ); |
| [274](#L274) | //$single\_event->venue\_other\_events = EventM\_Factory\_Service::get\_upcoming\_event\_by\_venue\_id( $single\_event->em\_venue, array( $single\_event->id ) ); |
| [275](#L275) | if( ! empty( $single\_event ) ) { |
| [276](#L276) | wp\_send\_json\_success( $single\_event ); |
| [277](#L277) | } else{ |
| [278](#L278) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Data Not Found', 'eventprime-event-calendar-management' ) ) ); |
| [279](#L279) | } |
| [280](#L280) | wp\_die(); |
| [281](#L281) | } |
| [282](#L282) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Data Not Found', 'eventprime-event-calendar-management' ) ) ); |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | /\*\* |
| [286](#L286) | \* Save event booking |
| [287](#L287) | \*/ |
| [288](#L288) | public function save\_event\_booking() { |
| [289](#L289) | if( ! empty( $\_POST['data'] ) ) { |
| [290](#L290) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [291](#L291) | $sanitizer = new EventPrime\_sanitizer; |
| [292](#L292) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [293](#L293) | if(isset($\_POST['offer\_data'])) |
| [294](#L294) | { |
| [295](#L295) | $offer\_data = json\_decode( wp\_unslash( $\_POST['offer\_data'] )); |
| [296](#L296) | } |
| [297](#L297) | else |
| [298](#L298) | { |
| [299](#L299) | $offer\_data = array(); |
| [300](#L300) | } |
| [301](#L301) | $result = array( 'success' => 1, 'msg' => '' ); |
| [302](#L302) | $checkpoint = apply\_filters('ep\_handle\_checkout\_additional\_check',$result, $data); |
| [303](#L303) | if(isset($checkpoint['success']) && empty($checkpoint['success'])){ |
| [304](#L304) | wp\_send\_json\_error( array( 'error' =>  $checkpoint['msg']) ); |
| [305](#L305) | die(); |
| [306](#L306) | } |
| [307](#L307) | if( wp\_verify\_nonce( $data['ep\_save\_event\_booking\_nonce'], 'ep\_save\_event\_booking' ) ) { |
| [308](#L308) |  |
| [309](#L309) | if(isset($data['ep\_event\_booking\_ticket\_data'])) |
| [310](#L310) | { |
| [311](#L311) | $ticket\_data = json\_decode( $data['ep\_event\_booking\_ticket\_data'] ); |
| [312](#L312) | if(isset($ticket\_data[0]->id)) |
| [313](#L313) | { |
| [314](#L314) | $ticket\_data\_object = $ep\_functions->ep\_get\_ticket\_data($ticket\_data[0]->id); |
| [315](#L315) | if(empty($ticket\_data\_object)) |
| [316](#L316) | { |
| [317](#L317) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Something went wrong.', 'eventprime-event-calendar-management' ) ) ); |
| [318](#L318) | die; |
| [319](#L319) | } |
| [320](#L320) | } |
| [321](#L321) | else |
| [322](#L322) | { |
| [323](#L323) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Something went wrong.', 'eventprime-event-calendar-management' ) ) ); |
| [324](#L324) | die; |
| [325](#L325) | } |
| [326](#L326) | } |
| [327](#L327) | else |
| [328](#L328) | { |
| [329](#L329) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Something went wrong.', 'eventprime-event-calendar-management' ) ) ); |
| [330](#L330) | die; |
| [331](#L331) | } |
| [332](#L332) | if(!isset($data['ep\_event\_booking\_event\_fixed\_price'])) |
| [333](#L333) | { |
| [334](#L334) | $data['ep\_event\_booking\_event\_fixed\_price'] = 0; |
| [335](#L335) | } |
| [336](#L336) | $current\_user = wp\_get\_current\_user(); |
| [337](#L337) | if( class\_exists("Eventprime\_Admin\_Attendee\_Booking")){ |
| [338](#L338) | if(empty( get\_option( 'ep\_set\_admin\_aab\_'.$current\_user->ID ))) |
| [339](#L339) | { |
| [340](#L340) | $data = $ep\_functions->ep\_recalculate\_and\_verify\_the\_cart\_data($data,$offer\_data); |
| [341](#L341) | } |
| [342](#L342) |  |
| [343](#L343) | } |
| [344](#L344) | else |
| [345](#L345) | { |
| [346](#L346) | $data = $ep\_functions->ep\_recalculate\_and\_verify\_the\_cart\_data($data,$offer\_data); |
| [347](#L347) | } |
| [348](#L348) | // If Seated Venue then verify if seats in the ticekt data are sold or not. |
| [349](#L349) | // Check it after ep\_recalculate\_and\_verify\_the\_cart\_data() as $data is set false later. (Refractor it!!!) |
| [350](#L350) | $incoming\_ticket\_data = json\_decode( $data['ep\_event\_booking\_ticket\_data'] ); |
| [351](#L351) | //$ep\_functions->epd($incoming\_ticket\_data); |
| [352](#L352) | $event\_seats\_current\_details = maybe\_unserialize( get\_post\_meta( absint( $data['ep\_event\_booking\_event\_id'] ), 'em\_seat\_data', true  ) ); |
| [353](#L353) | foreach ( $incoming\_ticket\_data as $single\_ticket\_type ) { |
| [354](#L354) | $single\_ticket\_type\_id = $single\_ticket\_type->id; |
| [355](#L355) | if(isset($single\_ticket\_type->seats) && !empty($single\_ticket\_type->seats)) |
| [356](#L356) | { |
| [357](#L357) | $single\_ticket\_type\_seats\_data = $single\_ticket\_type->seats; |
| [358](#L358) | foreach ( $single\_ticket\_type\_seats\_data as $ticket\_area\_data ) { |
| [359](#L359) | $area\_id = $ticket\_area\_data->area\_id; |
| [360](#L360) | foreach ( $ticket\_area\_data->seat\_data as $ticket\_seat ) { |
| [361](#L361) |  |
| [362](#L362) | if( ! empty( $ticket\_seat->uid ) ) { |
| [363](#L363) | $ticket\_seat\_uid = $ticket\_seat->uid; |
| [364](#L364) |  |
| [365](#L365) | // If seat has been sold then throw error. \*\*\*\*\* |
| [366](#L366) | foreach ( $event\_seats\_current\_details->{$area\_id}->seats as $event\_seats\_data ) { |
| [367](#L367) | foreach ( $event\_seats\_data as $event\_seats\_row ) { |
| [368](#L368) | if ( ($event\_seats\_row->uniqueIndex == $ticket\_seat\_uid) && ($event\_seats\_row->type == 'sold') ) { |
| [369](#L369) | $data = false; |
| [370](#L370) | } |
| [371](#L371) | } |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | } |
| [375](#L375) | } |
| [376](#L376) |  |
| [377](#L377) | } |
| [378](#L378) | } |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | if($data===false) |
| [382](#L382) | { |
| [383](#L383) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Something went wrong.', 'eventprime-event-calendar-management' ) ) ); |
| [384](#L384) | die; |
| [385](#L385) | } |
| [386](#L386) | $event\_id       = absint( $data['ep\_event\_booking\_event\_id'] ); |
| [387](#L387) | $event\_name     = get\_the\_title( $event\_id ); |
| [388](#L388) | $user\_id        = absint( $data['ep\_event\_booking\_user\_id'] ); |
| [389](#L389) | $payment\_method = ! empty( $data['payment\_processor'] ) ? sanitize\_text\_field( $data['payment\_processor'] ) : 'paypal'; |
| [390](#L390) | if( ! isset( $data['ep\_event\_booking\_total\_price'] ) || empty( $data['ep\_event\_booking\_total\_price'] ) ) { |
| [391](#L391) | $payment\_method = 'none'; |
| [392](#L392) | } |
| [393](#L393) |  |
| [394](#L394) | $post\_status = 'pending'; |
| [395](#L395) |  |
| [396](#L396) | if ( class\_exists("Eventprime\_Admin\_Attendee\_Booking") && !empty( get\_option( 'ep\_set\_admin\_aab\_'.$current\_user->ID )) ) { |
| [397](#L397) | $post\_status = 'completed'; |
| [398](#L398) | delete\_option( 'ep\_set\_admin\_aab\_'.$current\_user->ID ); |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | if( isset( $data['ep\_rg\_field\_email'] ) && ! empty( $data['ep\_rg\_field\_email'] ) ) { |
| [402](#L402) | if( isset($data['ep\_rg\_field\_user\_name'] ) && ! empty( $data['ep\_rg\_field\_user\_name'] ) ) { |
| [403](#L403) | $user\_controller = new EventM\_User\_Controller(); |
| [404](#L404) | $user\_data = new stdClass(); |
| [405](#L405) | $user\_data->email = sanitize\_text\_field($data['ep\_rg\_field\_email']); |
| [406](#L406) | $user\_data->username = sanitize\_text\_field($data['ep\_rg\_field\_user\_name']); |
| [407](#L407) | $user\_data->fname = isset($data['ep\_rg\_field\_first\_name']) ? sanitize\_text\_field($data['ep\_rg\_field\_first\_name']) : ''; |
| [408](#L408) | $user\_data->lname = isset($data['ep\_rg\_field\_last\_name']) ? sanitize\_text\_field($data['ep\_rg\_field\_last\_name']) : ''; |
| [409](#L409) | $user\_data->password = sanitize\_text\_field($data['ep\_rg\_field\_password']); |
| [410](#L410) | $user = get\_user\_by( 'email', $user\_data->email ); |
| [411](#L411) | if(!empty($user)){ |
| [412](#L412) | $user\_id = $user->ID; |
| [413](#L413) | }else{ |
| [414](#L414) | $user\_id = $user\_controller->ep\_checkout\_registration($user\_data); |
| [415](#L415) | } |
| [416](#L416) | } |
| [417](#L417) | } |
| [418](#L418) | // add new booking |
| [419](#L419) | $new\_post = array( |
| [420](#L420) | 'post\_title'  => $event\_name, |
| [421](#L421) | 'post\_status' => $post\_status, |
| [422](#L422) | 'post\_type'   => 'em\_booking', |
| [423](#L423) | 'post\_author' => $user\_id, |
| [424](#L424) | ); |
| [425](#L425) | $new\_post\_id = wp\_insert\_post( $new\_post ); // new post id |
| [426](#L426) |  |
| [427](#L427) | update\_post\_meta( $new\_post\_id, 'em\_id', $new\_post\_id ); |
| [428](#L428) | update\_post\_meta( $new\_post\_id, 'em\_event', $event\_id ); |
| [429](#L429) | update\_post\_meta( $new\_post\_id, 'em\_date', current\_time( 'timestamp' ) ); |
| [430](#L430) | update\_post\_meta( $new\_post\_id, 'em\_user', $user\_id ); |
| [431](#L431) | update\_post\_meta( $new\_post\_id, 'em\_name', $event\_name ); |
| [432](#L432) | update\_post\_meta( $new\_post\_id, 'em\_status', $post\_status ); |
| [433](#L433) | update\_post\_meta( $new\_post\_id, 'em\_payment\_method', $payment\_method ); |
| [434](#L434) | if( isset( $\_POST['rid'] ) && ! empty( $\_POST['rid'] ) ) { |
| [435](#L435) | update\_post\_meta( $new\_post\_id, 'em\_random\_order\_id', sanitize\_text\_field( $\_POST['rid'] ) ); |
| [436](#L436) | } |
| [437](#L437) | // order info |
| [438](#L438) | $order\_info = array(); |
| [439](#L439) | $order\_info['tickets']           = json\_decode( $data['ep\_event\_booking\_ticket\_data'] ); |
| [440](#L440) | $order\_info['event\_fixed\_price'] = ( ! empty( $data['ep\_event\_booking\_event\_fixed\_price'] ) ? $data['ep\_event\_booking\_event\_fixed\_price'] : 0.00 ); |
| [441](#L441) | $order\_info['booking\_total']     = ( ! empty( $data['ep\_event\_booking\_total\_price'] ) ? $data['ep\_event\_booking\_total\_price'] : 0.00 ); |
| [442](#L442) | $order\_info = apply\_filters('ep\_update\_booking\_order\_info', $order\_info, $data); |
| [443](#L443) | update\_post\_meta( $new\_post\_id, 'em\_order\_info', $order\_info ); |
| [444](#L444) | update\_post\_meta( $new\_post\_id, 'em\_notes', array() ); |
| [445](#L445) | update\_post\_meta( $new\_post\_id, 'em\_payment\_log', array() ); |
| [446](#L446) | update\_post\_meta( $new\_post\_id, 'em\_booked\_seats', array() ); |
| [447](#L447) | $ep\_booking\_attendee\_fields =(isset($data['ep\_booking\_attendee\_fields']))?$sanitizer->sanitize($data['ep\_booking\_attendee\_fields']):array(); |
| [448](#L448) | update\_post\_meta( $new\_post\_id, 'em\_attendee\_names', $ep\_booking\_attendee\_fields ); |
| [449](#L449) | // check for booking fields data |
| [450](#L450) | $em\_booking\_fields\_data = array(); |
| [451](#L451) | if( ! empty( $data['ep\_booking\_booking\_fields'] ) ) { |
| [452](#L452) | $em\_booking\_fields\_data = $data['ep\_booking\_booking\_fields']; |
| [453](#L453) | } |
| [454](#L454) | update\_post\_meta( $new\_post\_id, 'em\_booking\_fields\_data', $em\_booking\_fields\_data ); |
| [455](#L455) | $order\_key = $ep\_functions->ep\_encrypt\_decrypt\_pass('encrypt', 'ep\_order\_'.$new\_post\_id); |
| [456](#L456) | update\_post\_meta( $new\_post\_id, 'ep\_order\_key', $order\_key ); |
| [457](#L457) |  |
| [458](#L458) | do\_action( 'ep\_after\_booking\_created', $new\_post\_id, $data ); |
| [459](#L459) |  |
| [460](#L460) | // if booking total is 0 then confirm booking |
| [461](#L461) | if( $payment\_method == 'none' && empty( $order\_info['booking\_total'] ) ){ |
| [462](#L462) | $data['payment\_gateway'] = 'none'; |
| [463](#L463) | $data['payment\_status']  = 'completed'; |
| [464](#L464) | $data['total\_amount']    = $order\_info['booking\_total']; |
| [465](#L465) | $booking\_controller      = new EventPrime\_Bookings; |
| [466](#L466) | $booking\_controller->confirm\_booking( $new\_post\_id, $data ); |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | $response                 = new stdClass(); |
| [470](#L470) | $response->order\_id       = $new\_post\_id; |
| [471](#L471) | $response->payment\_method = $payment\_method; |
| [472](#L472) | $response->post\_status    = $post\_status; |
| [473](#L473) | $response->booking\_total  = $data['ep\_event\_booking\_total\_price']; |
| [474](#L474) | $response->item\_total     = $data['ep\_event\_booking\_total\_tickets']; |
| [475](#L475) | $response->discount\_total = (isset($data['ep\_event\_booking\_total\_discount']))?$data['ep\_event\_booking\_total\_discount']:''; |
| [476](#L476) | // $redirect                 = esc\_url( add\_query\_arg( array( 'order\_id' => $new\_post\_id ), get\_permalink( ep\_get\_global\_settings( 'booking\_details\_page' ) ) ) ); |
| [477](#L477) | $redirect                 = add\_query\_arg( array( 'order\_id' => $new\_post\_id ), esc\_url( get\_permalink( $ep\_functions->ep\_get\_global\_settings( 'booking\_details\_page' ) ) ) ); |
| [478](#L478) | $response->redirect       = apply\_filters( 'ep\_booking\_redirection\_url', $redirect, $new\_post\_id ); |
| [479](#L479) | wp\_send\_json\_success( $response ); |
| [480](#L480) | } else{ |
| [481](#L481) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [482](#L482) | } |
| [483](#L483) | } else{ |
| [484](#L484) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Data Not Found', 'eventprime-event-calendar-management' ) ) ); |
| [485](#L485) | } |
| [486](#L486) | } |
| [487](#L487) |  |
| [488](#L488) | /\*\* |
| [489](#L489) | \* Delete booking timer data from option table |
| [490](#L490) | \*/ |
| [491](#L491) | public function booking\_timer\_complete() { |
| [492](#L492) | check\_ajax\_referer( 'flush\_event\_booking\_timer\_nonce', 'security' ); |
| [493](#L493) | delete\_option( 'ep\_event\_booking\_timer\_start' ); |
| [494](#L494) | $booking\_data = json\_decode( stripslashes( $\_POST['booking\_data'] ) ); |
| [495](#L495) |  |
| [496](#L496) | do\_action( 'ep\_event\_booking\_timer\_finished', $booking\_data ); |
| [497](#L497) | wp\_send\_json\_success(true); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | /\*\* |
| [501](#L501) | \* Method call from paypal approval |
| [502](#L502) | \*/ |
| [503](#L503) | public function paypal\_sbpr() { |
| [504](#L504) | if( isset( $\_POST ) && ! empty( $\_POST ) ) { |
| [505](#L505) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [506](#L506) | $data       = $ep\_functions->ep\_sanitize\_input($\_POST['data']); |
| [507](#L507) | $booking\_id = absint( $\_POST['order\_id'] ); |
| [508](#L508) | $order\_info = maybe\_unserialize(get\_post\_meta($booking\_id,'em\_order\_info',true)); |
| [509](#L509) |  |
| [510](#L510) | if( ! empty( $booking\_id ) && ! empty( $data ) && $order\_info['booking\_total'] == $data['purchase\_units'][0]['amount']['value']) { |
| [511](#L511) | $data['payment\_gateway'] = 'paypal'; |
| [512](#L512) | $data['payment\_status']  = strtolower( $data['status'] ); |
| [513](#L513) | $data['total\_amount']    = $data['purchase\_units'][0]['amount']['value']; |
| [514](#L514) | $data['currency']        = $ep\_functions->ep\_get\_global\_settings('currency'); |
| [515](#L515) | $booking\_controller = new EventPrime\_Bookings; |
| [516](#L516) | $booking\_controller->confirm\_booking( $booking\_id, $data ); |
| [517](#L517) | //$return\_url = esc\_url( add\_query\_arg( array( 'order\_id' => $booking\_id ), get\_permalink( ep\_get\_global\_settings( 'booking\_details\_page' ) ) ) ); |
| [518](#L518) | $redirect        = add\_query\_arg( array( 'order\_id' => $booking\_id ), esc\_url( get\_permalink( $ep\_functions->ep\_get\_global\_settings( 'booking\_details\_page' ) ) ) ); |
| [519](#L519) | $return\_url       = apply\_filters( 'ep\_booking\_redirection\_url', $redirect, $booking\_id ); |
| [520](#L520) |  |
| [521](#L521) | $response = array( 'status' => 'success', 'redirect' => $return\_url ); |
| [522](#L522) | wp\_send\_json\_success($response); |
| [523](#L523) | } |
| [524](#L524) | } |
| [525](#L525) | } |
| [526](#L526) |  |
| [527](#L527) | /\*\* |
| [528](#L528) | \* Booking cancellation action |
| [529](#L529) | \*/ |
| [530](#L530) | public function event\_booking\_cancel() { |
| [531](#L531) | if( wp\_verify\_nonce( $\_POST['security'], 'event-booking-cancellation-nonce' ) ) { |
| [532](#L532) | if( isset( $\_POST['booking\_id'] ) ) { |
| [533](#L533) | $booking\_id = absint( $\_POST['booking\_id'] ); |
| [534](#L534) | if( ! empty( $booking\_id ) ) { |
| [535](#L535) | if (is\_user\_logged\_in()) { |
| [536](#L536) | $current\_user\_id = get\_current\_user\_id(); |
| [537](#L537) | $booking\_controller = new EventPrime\_Bookings; |
| [538](#L538) | $notification = new EventM\_Notification\_Service(); |
| [539](#L539) | $booking = $booking\_controller->load\_booking\_detail( $booking\_id ); |
| [540](#L540) | if( ! empty( $booking ) && $booking->em\_user==$current\_user\_id) { |
| [541](#L541) | if ( $booking->em\_status == 'cancelled' ) { |
| [542](#L542) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'The booking is already cancelled', 'eventprime-event-calendar-management' ) ) ); |
| [543](#L543) | } |
| [544](#L544) | if( $booking->em\_status == 'refunded' ) { |
| [545](#L545) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'The booking can not be cancelled. The amount is already refunded', 'eventprime-event-calendar-management' ) ) ); |
| [546](#L546) | } |
| [547](#L547) | if( ! empty( $booking->em\_user ) && get\_current\_user\_id() != $booking->em\_user ) { |
| [548](#L548) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'You are not allowed to cancel this booking', 'eventprime-event-calendar-management' ) ) ); |
| [549](#L549) | } |
| [550](#L550) |  |
| [551](#L551) | // cancel the booking |
| [552](#L552) | update\_post\_meta( $booking->em\_id, 'em\_status', 'cancelled' ); |
| [553](#L553) |  |
| [554](#L554) | $booking\_controller->update\_status( $booking\_id, 'cancelled' ); |
| [555](#L555) |  |
| [556](#L556) | // send cancellation mail |
| [557](#L557) | $notification->booking\_cancel( $booking\_id ); |
| [558](#L558) |  |
| [559](#L559) | do\_action( 'ep\_after\_booking\_cancelled', $booking ); |
| [560](#L560) |  |
| [561](#L561) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Booking Cancelled Successfully', 'eventprime-event-calendar-management' ) ) ); |
| [562](#L562) | } else{ |
| [563](#L563) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Invalid Data', 'eventprime-event-calendar-management' ) ) ); |
| [564](#L564) | } |
| [565](#L565) | } else{ |
| [566](#L566) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'You are not allowed to cancel this booking', 'eventprime-event-calendar-management' ) ) ); |
| [567](#L567) | } |
| [568](#L568) | } |
| [569](#L569) | } |
| [570](#L570) | } else{ |
| [571](#L571) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [572](#L572) | } |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | /\* |
| [576](#L576) | \* Add booking Notes |
| [577](#L577) | \*/ |
| [578](#L578) | public function booking\_add\_notes(){ |
| [579](#L579) | if( isset( $\_POST['booking\_id'] ) && isset($\_POST['note']) && !empty(trim($\_POST['note']))) { |
| [580](#L580) | $booking\_id = absint( $\_POST['booking\_id'] ); |
| [581](#L581) | $note = sanitize\_text\_field($\_POST['note']); |
| [582](#L582) | $booking\_controller = new EventPrime\_Bookings(); |
| [583](#L583) | $response = $booking\_controller->add\_notes( $booking\_id, $note); |
| [584](#L584) | wp\_send\_json\_success( $response ); |
| [585](#L585) | }else{ |
| [586](#L586) | wp\_send\_json\_error(); |
| [587](#L587) | } |
| [588](#L588) | } |
| [589](#L589) |  |
| [590](#L590) | /\*\* |
| [591](#L591) | \* Event wishlist action |
| [592](#L592) | \*/ |
| [593](#L593) | public function event\_wishlist\_action() { |
| [594](#L594) | if( isset($\_POST['security']) && wp\_verify\_nonce( $\_POST['security'], 'event-wishlist-action-nonce' ) ){ |
| [595](#L595) | if( isset( $\_POST['event\_id'] ) && ! empty( $\_POST['event\_id'] ) ) { |
| [596](#L596) | $event\_id = absint( $\_POST['event\_id'] ); |
| [597](#L597) | $user\_id = get\_current\_user\_id(); |
| [598](#L598) | if( empty( $user\_id ) ) { |
| [599](#L599) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'You need to login to add event to wishlist', 'eventprime-event-calendar-management' ) ) ); |
| [600](#L600) | } |
| [601](#L601) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [602](#L602) | $single\_event = $ep\_functions->get\_single\_event( $event\_id ); |
| [603](#L603) | if( empty( $single\_event ) ) { |
| [604](#L604) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Event Not Found', 'eventprime-event-calendar-management' ) ) ); |
| [605](#L605) | } |
| [606](#L606) | // get user wishlist meta |
| [607](#L607) | $wishlist\_meta = get\_user\_meta( $user\_id, 'ep\_wishlist\_event', true ); |
| [608](#L608) | if( empty( $wishlist\_meta ) ) { // if empty the add event id |
| [609](#L609) | $wishlist\_array = array( $event\_id => 1 ); |
| [610](#L610) | update\_user\_meta( $user\_id, 'ep\_wishlist\_event', $wishlist\_array ); |
| [611](#L611) | wp\_send\_json\_success( array( 'action' => 'add', 'title'=> $ep\_functions->ep\_global\_settings\_button\_title( 'Remove From Wishlist' ), 'message' => esc\_html\_\_( 'Event added successfully into wishlist', 'eventprime-event-calendar-management' ) ) ); |
| [612](#L612) | } else{ |
| [613](#L613) | // if already added then remove the event from wishlist |
| [614](#L614) | if( array\_key\_exists( $event\_id, $wishlist\_meta ) ) { |
| [615](#L615) | unset( $wishlist\_meta[$event\_id] ); |
| [616](#L616) | update\_user\_meta( $user\_id, 'ep\_wishlist\_event', $wishlist\_meta ); |
| [617](#L617) | wp\_send\_json\_success( array( 'action' => 'remove', 'title'=> $ep\_functions->ep\_global\_settings\_button\_title( 'Add To Wishlist' ), 'message' => esc\_html\_\_( 'Event removed successfully from wishlist', 'eventprime-event-calendar-management' ) ) ); |
| [618](#L618) | } else{ |
| [619](#L619) | $wishlist\_meta[$event\_id] = 1; |
| [620](#L620) | update\_user\_meta( $user\_id, 'ep\_wishlist\_event', $wishlist\_meta ); |
| [621](#L621) | wp\_send\_json\_success( array( 'action' => 'add', 'title'=> $ep\_functions->ep\_global\_settings\_button\_title( 'Remove From Wishlist' ), 'message' => esc\_html\_\_( 'Event added successfully into wishlist', 'eventprime-event-calendar-management' ) ) ); |
| [622](#L622) | } |
| [623](#L623) | } |
| [624](#L624) | } else{ |
| [625](#L625) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Wrong data.', 'eventprime-event-calendar-management' ) ) ); |
| [626](#L626) | } |
| [627](#L627) | } else{ |
| [628](#L628) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [629](#L629) | } |
| [630](#L630) | } |
| [631](#L631) |  |
| [632](#L632) | /\*\* |
| [633](#L633) | \* Submit the frontend event submission form |
| [634](#L634) | \*/ |
| [635](#L635) | public function save\_frontend\_event\_submission() { |
| [636](#L636) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-frontend-event-submission-nonce' ) ) { |
| [637](#L637) | global $wpdb; |
| [638](#L638) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [639](#L639) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [640](#L640) | $notifications = new EventM\_Notification\_Service; |
| [641](#L641) | $sanitizer = new EventPrime\_sanitizer; |
| [642](#L642) | $em\_name = htmlspecialchars\_decode( sanitize\_text\_field( $data['em\_name'] ) ); |
| [643](#L643) |  |
| [644](#L644) | $result = array( 'success' => 1, 'msg' => '' ); |
| [645](#L645) | $checkpoint = apply\_filters('ep\_handle\_frontend\_submission\_additional\_check',$result, $data); |
| [646](#L646) | if(isset($checkpoint['success']) && empty($checkpoint['success'])){ |
| [647](#L647) | wp\_send\_json\_error( array( 'error' =>  $checkpoint['msg']) ); |
| [648](#L648) | die(); |
| [649](#L649) | } |
| [650](#L650) | if( empty( $em\_name ) ) { |
| [651](#L651) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Event Name cannot be empty.', 'eventprime-event-calendar-management' ) ) ); |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | $guest\_submission = $ep\_functions->ep\_get\_global\_settings('allow\_submission\_by\_anonymous\_user'); |
| [655](#L655) | if( empty( $guest\_submission ) && empty( get\_current\_user\_id() ) ) { |
| [656](#L656) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'User login required to submit event.', 'eventprime-event-calendar-management' ) ) ); |
| [657](#L657) | } |
| [658](#L658) |  |
| [659](#L659) | if(empty($guest\_submission)){ |
| [660](#L660) | $hasUserRestriction = 0; |
| [661](#L661) | $frontend\_submission\_roles = (array) $ep\_functions->ep\_get\_global\_settings( 'frontend\_submission\_roles' ); |
| [662](#L662) | if( ! empty( $frontend\_submission\_roles ) ) { |
| [663](#L663) | $user = wp\_get\_current\_user(); |
| [664](#L664) | foreach ( $user->roles as $key => $value ) { |
| [665](#L665) | if( in\_array( $value, $frontend\_submission\_roles ) ) { |
| [666](#L666) | $hasUserRestriction = 1; |
| [667](#L667) | break; |
| [668](#L668) | } |
| [669](#L669) | } |
| [670](#L670) | }else{ |
| [671](#L671) | $hasUserRestriction = 1; |
| [672](#L672) | } |
| [673](#L673) | if(empty($hasUserRestriction)){ |
| [674](#L674) | wp\_send\_json\_error( array( 'error' => $ep\_functions->ep\_get\_global\_settings('ues\_restricted\_submission\_message') ) ); |
| [675](#L675) | } |
| [676](#L676) | } |
| [677](#L677) |  |
| [678](#L678) |  |
| [679](#L679) |  |
| [680](#L680) | $post\_status = $ep\_functions->ep\_get\_global\_settings( 'ues\_default\_status' ); |
| [681](#L681) | if( empty( $post\_status ) ) { |
| [682](#L682) | $post\_status = 'draft'; |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | $event\_description = wp\_kses\_post( stripslashes( $data['em\_descriptions'] ) ); |
| [686](#L686) |  |
| [687](#L687) | if( isset( $data['event\_id'] ) && ! empty( $data['event\_id'] ) ) { |
| [688](#L688) | $post\_id = $data['event\_id']; |
| [689](#L689) | if(empty(get\_post($post\_id)) || get\_post\_type($post\_id) != 'em\_event' ){ |
| [690](#L690) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'There is some issue with event. Please try later.', 'eventprime-event-calendar-management' ) ) ); |
| [691](#L691) | } |
| [692](#L692) | if(!empty($guest\_submission) && get\_post\_meta($post\_id, 'em\_user\_submitted', true) != get\_current\_user\_id()){ |
| [693](#L693) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Event does not belong to you.', 'eventprime-event-calendar-management' ) ) ); |
| [694](#L694) |  |
| [695](#L695) | } |
| [696](#L696) | $post\_update = array( |
| [697](#L697) | 'ID'         => $post\_id, |
| [698](#L698) | 'post\_title' => $em\_name, |
| [699](#L699) | 'post\_content' => $event\_description, |
| [700](#L700) | ); |
| [701](#L701) | wp\_update\_post( $post\_update ); |
| [702](#L702) | }else{ |
| [703](#L703) | $post\_id = wp\_insert\_post(array ( |
| [704](#L704) | 'post\_type' => 'em\_event', |
| [705](#L705) | 'post\_title' => $em\_name, |
| [706](#L706) | 'post\_content' => $event\_description, |
| [707](#L707) | 'post\_status' => $post\_status, |
| [708](#L708) | 'post\_author' => get\_current\_user\_id(), |
| [709](#L709) | )); |
| [710](#L710) | } |
| [711](#L711) |  |
| [712](#L712) | update\_post\_meta( $post\_id, 'em\_frontend\_submission', 1 ); |
| [713](#L713) | update\_post\_meta( $post\_id, 'em\_user\_submitted', 1 ); |
| [714](#L714) | update\_post\_meta( $post\_id, 'em\_user', get\_current\_user\_id() ); |
| [715](#L715) |  |
| [716](#L716) | update\_post\_meta( $post\_id, 'em\_id', $post\_id ); |
| [717](#L717) | update\_post\_meta( $post\_id, 'em\_name', $em\_name ); |
| [718](#L718) |  |
| [719](#L719) | $event\_data = new stdClass(); |
| [720](#L720) | $thumbnail\_id = isset( $data['attachment\_id'] ) ? $data['attachment\_id'] : ''; |
| [721](#L721) | set\_post\_thumbnail( $post\_id, $thumbnail\_id ); |
| [722](#L722) |  |
| [723](#L723) | $em\_start\_date = isset( $data['em\_start\_date'] ) ? $ep\_functions->ep\_date\_to\_timestamp( sanitize\_text\_field( $data['em\_start\_date'] ) ) : ''; |
| [724](#L724) | update\_post\_meta($post\_id, 'em\_start\_date', $em\_start\_date); |
| [725](#L725) |  |
| [726](#L726) | $em\_start\_time = isset( $data['em\_start\_time'] ) ? sanitize\_text\_field( $data['em\_start\_time'] ) : ''; |
| [727](#L727) | update\_post\_meta($post\_id, 'em\_start\_time', $em\_start\_time); |
| [728](#L728) |  |
| [729](#L729) | $em\_hide\_event\_start\_time = isset( $data['em\_hide\_event\_start\_time'] ) && !empty($data['em\_hide\_event\_start\_time'] ) ? 1 : 0; |
| [730](#L730) | update\_post\_meta( $post\_id, 'em\_hide\_event\_start\_time', $em\_hide\_event\_start\_time ); |
| [731](#L731) |  |
| [732](#L732) | $em\_hide\_event\_start\_date = isset( $data['em\_hide\_event\_start\_date'] ) && !empty( $data['em\_hide\_event\_start\_date'] ) ? 1 : 0; |
| [733](#L733) | update\_post\_meta( $post\_id, 'em\_hide\_event\_start\_date', $em\_hide\_event\_start\_date ); |
| [734](#L734) |  |
| [735](#L735) | $em\_end\_date = isset( $data['em\_end\_date'] ) ? $ep\_functions->ep\_date\_to\_timestamp( sanitize\_text\_field( $data['em\_end\_date'] ) ) : $em\_start\_date; |
| [736](#L736) | update\_post\_meta($post\_id, 'em\_end\_date', $em\_end\_date); |
| [737](#L737) |  |
| [738](#L738) | $em\_end\_time = isset( $data['em\_end\_time'] ) ? sanitize\_text\_field( $data['em\_end\_time'] ) : ''; |
| [739](#L739) | update\_post\_meta($post\_id, 'em\_end\_time', $em\_end\_time); |
| [740](#L740) |  |
| [741](#L741) | $em\_hide\_event\_end\_time = isset( $data['em\_hide\_event\_end\_time'] ) && !empty($data['em\_hide\_event\_end\_time']) ? 1 : 0; |
| [742](#L742) | update\_post\_meta( $post\_id, 'em\_hide\_event\_end\_time', $em\_hide\_event\_end\_time ); |
| [743](#L743) |  |
| [744](#L744) | $em\_hide\_end\_date = isset( $data['em\_hide\_end\_date'] ) && !empty( $data['em\_hide\_end\_date'] )? 1 : 0; |
| [745](#L745) | update\_post\_meta( $post\_id, 'em\_hide\_end\_date', $em\_hide\_end\_date ); |
| [746](#L746) |  |
| [747](#L747) | $em\_all\_day = isset( $data['em\_all\_day'] ) ? 1 : 0; |
| [748](#L748) | update\_post\_meta( $post\_id, 'em\_all\_day', $em\_all\_day ); |
| [749](#L749) | // if event is all day then end date will be same as start date |
| [750](#L750) | if( $em\_all\_day == 1 ) { |
| [751](#L751) | $em\_end\_date = $em\_start\_date; |
| [752](#L752) | update\_post\_meta( $post\_id, 'em\_end\_date', $em\_end\_date ); |
| [753](#L753) | $em\_start\_time = '12:00 AM'; $em\_end\_time = '11:59 PM'; |
| [754](#L754) | update\_post\_meta( $post\_id, 'em\_start\_time', $em\_start\_time ); |
| [755](#L755) | update\_post\_meta( $post\_id, 'em\_end\_time', $em\_end\_time ); |
| [756](#L756) | } |
| [757](#L757) | // update start and end datetime meta |
| [758](#L758) | $ep\_date\_time\_format = 'Y-m-d'; |
| [759](#L759) | $start\_date = get\_post\_meta( $post\_id, 'em\_start\_date', true ); |
| [760](#L760) | $start\_time = get\_post\_meta( $post\_id, 'em\_start\_time', true ); |
| [761](#L761) | $merge\_start\_date\_time = $ep\_functions->ep\_datetime\_to\_timestamp( $ep\_functions->ep\_timestamp\_to\_date( $start\_date, 'Y-m-d', 1 ) . ' ' . $start\_time, $ep\_date\_time\_format, '', 0, 1 ); |
| [762](#L762) | if( ! empty( $merge\_start\_date\_time ) ) { |
| [763](#L763) | update\_post\_meta( $post\_id, 'em\_start\_date\_time', $merge\_start\_date\_time ); |
| [764](#L764) | } |
| [765](#L765) | $end\_date = get\_post\_meta( $post\_id, 'em\_end\_date', true ); |
| [766](#L766) | $end\_time = get\_post\_meta( $post\_id, 'em\_end\_time', true ); |
| [767](#L767) | $merge\_end\_date\_time = $ep\_functions->ep\_datetime\_to\_timestamp( $ep\_functions->ep\_timestamp\_to\_date( $end\_date, 'Y-m-d', 1 ) . ' ' . $end\_time, $ep\_date\_time\_format, '', 0, 1 ); |
| [768](#L768) | if( ! empty( $merge\_end\_date\_time ) ) { |
| [769](#L769) | update\_post\_meta( $post\_id, 'em\_end\_date\_time', $merge\_end\_date\_time ); |
| [770](#L770) | } |
| [771](#L771) |  |
| [772](#L772) | $em\_event\_date\_placeholder = isset( $data['em\_event\_date\_placeholder'] ) ? sanitize\_text\_field( $data['em\_event\_date\_placeholder'] ) : ''; |
| [773](#L773) | update\_post\_meta( $post\_id, 'em\_event\_date\_placeholder', $em\_event\_date\_placeholder ); |
| [774](#L774) | $em\_event\_date\_placeholder\_custom\_note = ''; |
| [775](#L775) | if( ! empty( $em\_event\_date\_placeholder ) && $em\_event\_date\_placeholder == 'custom\_note' ) { |
| [776](#L776) | $em\_event\_date\_placeholder\_custom\_note = sanitize\_text\_field( $data['em\_event\_date\_placeholder\_custom\_note'] ); |
| [777](#L777) | } |
| [778](#L778) | update\_post\_meta( $post\_id, 'em\_event\_date\_placeholder\_custom\_note', $em\_event\_date\_placeholder\_custom\_note ); |
| [779](#L779) |  |
| [780](#L780) | // add event more dates |
| [781](#L781) | $em\_event\_more\_dates = isset( $data['em\_event\_more\_dates'] ) ? 1 : 0; |
| [782](#L782) | update\_post\_meta( $post\_id, 'em\_event\_more\_dates', $em\_event\_more\_dates ); |
| [783](#L783) | $event\_more\_dates = array(); |
| [784](#L784) | if( isset( $data['em\_event\_more\_dates'] ) && !empty( $data['em\_event\_more\_dates'] ) ) { |
| [785](#L785) | if( isset( $data['em\_event\_add\_more\_dates'] ) && count( $data['em\_event\_add\_more\_dates'] ) > 0 ) { |
| [786](#L786) | foreach( $data['em\_event\_add\_more\_dates'] as $key => $more\_dates ) { |
| [787](#L787) | $new\_date = array(); |
| [788](#L788) | $new\_date['uid']    = absint( $more\_dates['uid'] ); |
| [789](#L789) | $new\_date['date']   = $ep\_functions->ep\_date\_to\_timestamp( sanitize\_text\_field( $more\_dates['date'] ) ); |
| [790](#L790) | $new\_date['time']   = sanitize\_text\_field( $more\_dates['time'] ); |
| [791](#L791) | $new\_date['label']  = sanitize\_text\_field( $more\_dates['label'] ); |
| [792](#L792) | $event\_more\_dates[] = $new\_date; |
| [793](#L793) | } |
| [794](#L794) | } |
| [795](#L795) | } |
| [796](#L796) | update\_post\_meta( $post\_id, 'em\_event\_add\_more\_dates', $event\_more\_dates ); |
| [797](#L797) |  |
| [798](#L798) | // booking & tickets |
| [799](#L799) | $em\_enable\_booking = isset( $data['em\_enable\_booking'] ) ? sanitize\_text\_field( $data['em\_enable\_booking'] ) : 'bookings\_off'; |
| [800](#L800) | update\_post\_meta( $post\_id, 'em\_enable\_booking', $em\_enable\_booking ); |
| [801](#L801) | // check for external booking |
| [802](#L802) | if( ! empty( $em\_enable\_booking ) && $em\_enable\_booking == 'external\_bookings' ) { |
| [803](#L803) | $em\_custom\_link = isset( $data['em\_custom\_link'] ) && ! empty( $data['em\_custom\_link'] ) ? sanitize\_url( $data['em\_custom\_link'] ) : ''; |
| [804](#L804) | update\_post\_meta( $post\_id, 'em\_custom\_link', $em\_custom\_link ); |
| [805](#L805) | // open in new browser |
| [806](#L806) | $em\_custom\_link\_new\_browser = isset( $data['em\_custom\_link\_new\_browser'] ) ? 1 : 0; |
| [807](#L807) | update\_post\_meta( $post\_id, 'em\_custom\_link\_new\_browser', $em\_custom\_link\_new\_browser ); |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | // One time event fee |
| [811](#L811) | $em\_fixed\_event\_price = isset( $data['em\_fixed\_event\_price'] ) && ! empty( $data['em\_fixed\_event\_price'] ) ? sanitize\_text\_field( $data['em\_fixed\_event\_price'] ) : ''; |
| [812](#L812) | update\_post\_meta( $post\_id, 'em\_fixed\_event\_price', $em\_fixed\_event\_price ); |
| [813](#L813) | // hide booking status |
| [814](#L814) | $em\_hide\_booking\_status = isset( $data['em\_hide\_booking\_status'] ) ? 1 : 0; |
| [815](#L815) | update\_post\_meta( $post\_id, 'em\_hide\_booking\_status', $em\_hide\_booking\_status ); |
| [816](#L816) | // allow cancellation option |
| [817](#L817) | $em\_allow\_cancellations = isset( $data['em\_allow\_cancellations'] ) ? 1 : 0; |
| [818](#L818) | update\_post\_meta( $post\_id, 'em\_allow\_cancellations', $em\_allow\_cancellations ); |
| [819](#L819) |  |
| [820](#L820) | // event type |
| [821](#L821) | if( isset( $data['em\_event\_type'] ) && ! empty( $data['em\_event\_type'] ) ) { |
| [822](#L822) | $em\_event\_type\_id = absint( $data['em\_event\_type'] ); |
| [823](#L823) | update\_post\_meta( $post\_id, 'em\_event\_type', $em\_event\_type\_id ); |
| [824](#L824) | wp\_set\_object\_terms( $post\_id, intval( $em\_event\_type\_id ), 'em\_event\_type' ); |
| [825](#L825) | if( $data['em\_event\_type'] == 'new\_event\_type' ) { |
| [826](#L826) | $type\_data = new stdClass(); |
| [827](#L827) | $type\_data->name = isset( $data['new\_event\_type\_name'] ) ? sanitize\_text\_field( $data['new\_event\_type\_name'] ) : ''; |
| [828](#L828) | if( ! empty( trim( $type\_data->name ) ) ) { |
| [829](#L829) | $eventType = $type\_data->name; |
| [830](#L830) | $type\_term = get\_term\_by( 'name', $eventType, 'em\_event\_type' ); |
| [831](#L831) | if( empty( $type\_term ) ) { |
| [832](#L832) | $type\_data->em\_color = isset($data['new\_event\_type\_background\_color']) ? sanitize\_text\_field($data['new\_event\_type\_background\_color']) : '#FF5599'; |
| [833](#L833) | $type\_data->em\_type\_text\_color = isset($data['new\_event\_type\_text\_color']) ? sanitize\_text\_field($data['new\_event\_type\_text\_color']) : '#43CDFF'; |
| [834](#L834) | $type\_data->em\_age\_group = isset($data['ep\_new\_event\_type\_age\_group']) ? sanitize\_text\_field($data['ep\_new\_event\_type\_age\_group']) : 'all'; |
| [835](#L835) | $type\_data->custom\_age = isset($data['ep-new\_event\_type\_custom\_group']) ? sanitize\_text\_field($data['ep-new\_event\_type\_custom\_group']) : ''; |
| [836](#L836) | $type\_data->description = isset($data['new\_event\_type\_description']) ? $data['new\_event\_type\_description'] : ''; |
| [837](#L837) | $type\_data->em\_image\_id = isset($data['event\_type\_image\_id']) ? $data['event\_type\_image\_id'] : ''; |
| [838](#L838) | $em\_event\_type\_id = $ep\_functions->create\_event\_types((array)$type\_data); |
| [839](#L839) | } else{ |
| [840](#L840) | $em\_event\_type\_id = $type\_term->term\_id; |
| [841](#L841) | } |
| [842](#L842) | update\_post\_meta( $post\_id, 'em\_event\_type', $em\_event\_type\_id ); |
| [843](#L843) | wp\_set\_object\_terms( $post\_id, intval( $em\_event\_type\_id ), 'em\_event\_type' ); |
| [844](#L844) | } |
| [845](#L845) | } |
| [846](#L846) | } |
| [847](#L847) |  |
| [848](#L848) | // venues |
| [849](#L849) | if( isset( $data['em\_venue'] ) && ! empty( $data['em\_venue'] ) ) { |
| [850](#L850) | $em\_venue\_id = absint( $data['em\_venue'] ); |
| [851](#L851) | update\_post\_meta( $post\_id, 'em\_venue', $em\_venue\_id ); |
| [852](#L852) | wp\_set\_object\_terms( $post\_id, intval( $em\_venue\_id ), 'em\_venue' ); |
| [853](#L853) | if( $data['em\_venue'] == 'new\_venue' ) { |
| [854](#L854) | $venue\_data = new stdClass(); |
| [855](#L855) | $venue\_data->name = isset($data['new\_venue']) ? sanitize\_text\_field($data['new\_venue']) : ''; |
| [856](#L856) | if( ! empty( trim( $venue\_data->name ) ) ) { |
| [857](#L857) | $location\_name = $venue\_data->name; |
| [858](#L858) | $location\_term = get\_term\_by( 'name', $location\_name, 'em\_venue' ); |
| [859](#L859) | if( empty( $location\_term ) ) { |
| [860](#L860) | $venue\_data->em\_type = 'standings'; |
| [861](#L861) | $venue\_data->em\_address = isset( $data['em\_address'] ) ? sanitize\_text\_field( $data['em\_address'] ) : ''; |
| [862](#L862) | if( empty( $venue\_data->em\_address ) ) { |
| [863](#L863) | $venue\_data->em\_address = sanitize\_text\_field( $venue\_data->name ); |
| [864](#L864) | } |
| [865](#L865) | $venue\_data->em\_type = isset($data['seating\_type']) ? sanitize\_text\_field($data['seating\_type']) : ''; |
| [866](#L866) | $venue\_data->em\_lng = isset($data['em\_lng']) ? sanitize\_text\_field($data['em\_lng']) : ''; |
| [867](#L867) | $venue\_data->em\_lat = isset($data['em\_lat']) ? sanitize\_text\_field($data['em\_lat']) : ''; |
| [868](#L868) | $venue\_data->em\_state = isset($data['em\_state']) ? sanitize\_text\_field($data['em\_state']) : ''; |
| [869](#L869) | $venue\_data->em\_country = isset($data['em\_country']) ? sanitize\_text\_field($data['em\_country']) : ''; |
| [870](#L870) | $venue\_data->em\_postal\_code = isset($data['em\_postal\_code']) ? sanitize\_text\_field($data['em\_postal\_code']) : ''; |
| [871](#L871) | $venue\_data->em\_zoom\_level = isset($data['em\_zoom\_level']) ? sanitize\_text\_field($data['em\_zoom\_level']) : ''; |
| [872](#L872) | $venue\_data->em\_display\_address\_on\_frontend = isset($data['em\_display\_address\_on\_frontend']) & !empty($data['em\_display\_address\_on\_frontend']) ? 1: 0; |
| [873](#L873) | $venue\_data->em\_established = isset($data['em\_established']) ? sanitize\_text\_field($data['em\_established']) : ''; |
| [874](#L874) | $venue\_data->standing\_capacity = isset($data['standing\_capacity']) ? sanitize\_text\_field($data['standing\_capacity']) : ''; |
| [875](#L875) | $venue\_data->em\_seating\_organizer = isset($data['em\_seating\_organizer']) ? sanitize\_text\_field($data['em\_seating\_organizer']) : ''; |
| [876](#L876) | $venue\_data->em\_facebook\_page = isset($data['em\_facebook\_page']) ? sanitize\_text\_field($data['em\_facebook\_page']) : ''; |
| [877](#L877) | $venue\_data->em\_instagram\_page = isset($data['em\_instagram\_page']) ? sanitize\_text\_field($data['em\_instagram\_page']) : ''; |
| [878](#L878) | $venue\_data->em\_image\_id = isset($data['venue\_attachment\_id']) ? sanitize\_text\_field($data['venue\_attachment\_id']) : ''; |
| [879](#L879) | $em\_venue\_id = $ep\_functions->create\_venue((array)$venue\_data); |
| [880](#L880) | } else{ |
| [881](#L881) | $em\_venue\_id = $location\_term->term\_id; |
| [882](#L882) | } |
| [883](#L883) | update\_post\_meta( $post\_id, 'em\_venue', $em\_venue\_id ); |
| [884](#L884) | wp\_set\_object\_terms( $post\_id, intval( $em\_venue\_id ), 'em\_venue' ); |
| [885](#L885) | } |
| [886](#L886) | } |
| [887](#L887) | } |
| [888](#L888) |  |
| [889](#L889) | // organizer |
| [890](#L890) | $org = array(); |
| [891](#L891) | if( isset( $data['em\_organizer'] ) && !empty( $data['em\_organizer'] ) ) { |
| [892](#L892) | $org = $data['em\_organizer']; |
| [893](#L893) | update\_post\_meta( $post\_id, 'em\_organizer', $org ); |
| [894](#L894) | } |
| [895](#L895) | if( isset( $data['new\_organizer'] ) && $data['new\_organizer'] == 1 ) { |
| [896](#L896) | $organizer\_name = isset( $data['new\_organizer\_name'] ) ? $data['new\_organizer\_name'] : ''; |
| [897](#L897) | if( ! empty( $organizer\_name ) ) { |
| [898](#L898) | $organizer = get\_term\_by( 'name', $organizer\_name, 'em\_event\_organizer' ); |
| [899](#L899) | if( ! empty( $organizer ) ) { |
| [900](#L900) | $org[] = $organizer->term\_id; |
| [901](#L901) | } else{ |
| [902](#L902) | $org\_data = new stdClass(); |
| [903](#L903) | $org\_data->name = $organizer\_name; |
| [904](#L904) |  |
| [905](#L905) | if( isset( $data['em\_organizer\_phones'] ) && ! empty( $data['em\_organizer\_phones'] ) ) { |
| [906](#L906) | $org\_data->em\_organizer\_phones = $data['em\_organizer\_phones']; |
| [907](#L907) | } |
| [908](#L908) | if( isset( $data['em\_organizer\_emails'] ) && ! empty( $data['em\_organizer\_emails'] ) ) { |
| [909](#L909) | $org\_data->em\_organizer\_emails = $data['em\_organizer\_emails']; |
| [910](#L910) | } |
| [911](#L911) | if( isset( $data['em\_organizer\_websites'] ) && ! empty( $data['em\_organizer\_websites'] ) ) { |
| [912](#L912) | $org\_data->em\_organizer\_websites = $data['em\_organizer\_websites']; |
| [913](#L913) | } |
| [914](#L914) | $org\_data->description = isset( $data['new\_event\_organizer\_description'] ) ? $data['new\_event\_organizer\_description'] : ''; |
| [915](#L915) | $org\_data->em\_image\_id = isset( $data['org\_attachment\_id'] ) ? $data['org\_attachment\_id'] : ''; |
| [916](#L916) | $org\_data->em\_social\_links = isset( $data['em\_per\_social\_links'] ) ? $data['em\_per\_social\_links'] : ''; |
| [917](#L917) | $org[] = $ep\_functions->create\_organizer( (array)$org\_data ); |
| [918](#L918) | } |
| [919](#L919) | } |
| [920](#L920) | update\_post\_meta( $post\_id, 'em\_organizer', $org ); |
| [921](#L921) | } |
| [922](#L922) | if( ! empty( $org ) ) { |
| [923](#L923) | foreach( $org as $organizer ) { |
| [924](#L924) | if( ! empty( $organizer ) ) { |
| [925](#L925) | wp\_set\_object\_terms( $post\_id, intval( $organizer ), 'em\_organizer' ); |
| [926](#L926) | } |
| [927](#L927) | } |
| [928](#L928) | } |
| [929](#L929) |  |
| [930](#L930) | $performers = array(); |
| [931](#L931) | if( isset( $data['em\_performer'] ) && !empty( $data['em\_performer'] )) { |
| [932](#L932) | $performers = $data['em\_performer']; |
| [933](#L933) | update\_post\_meta( $post\_id, 'em\_performer', $performers ); |
| [934](#L934) | } |
| [935](#L935) | if( isset( $data['new\_performer'] ) && $data['new\_performer'] == 1 ) { |
| [936](#L936) | $performer\_name = isset( $data['new\_performer\_name'] ) ? $data['new\_performer\_name'] : ''; |
| [937](#L937) | if( ! empty( $performer\_name ) ) { |
| [938](#L938) | $performer\_data = new stdClass(); |
| [939](#L939) | $performer\_data->name = $performer\_name; |
| [940](#L940) | $performer\_data->em\_type = isset( $data['new\_performer\_type'] ) ? sanitize\_text\_field( $data['new\_performer\_type'] ) : 'person'; |
| [941](#L941) | $performer\_data->em\_role = isset( $data['new\_performer\_role'] ) ? sanitize\_text\_field( $data['new\_performer\_role'] ) : ''; |
| [942](#L942) |  |
| [943](#L943) | if(isset($data['em\_performer\_phones']) && !empty($data['em\_performer\_phones'])){ |
| [944](#L944) | $performer\_data->em\_performer\_phones = $data['em\_performer\_phones']; |
| [945](#L945) | } |
| [946](#L946) | if(isset($data['em\_performer\_emails']) && !empty($data['em\_performer\_emails'])){ |
| [947](#L947) | $performer\_data->em\_performer\_emails = $data['em\_performer\_emails']; |
| [948](#L948) | } |
| [949](#L949) | if(isset($data['em\_performer\_websites']) && !empty($data['em\_performer\_websites'])){ |
| [950](#L950) | $performer\_data->em\_performer\_websites = $data['em\_performer\_websites']; |
| [951](#L951) | } |
| [952](#L952) | $performer\_data->description = isset($data['qt\_new\_performer\_description']) ? $data['qt\_new\_performer\_description'] : ''; |
| [953](#L953) | $performer\_data->thumbnail = isset($data['performer\_attachment\_id']) ? $data['performer\_attachment\_id'] : ''; |
| [954](#L954) | $performer\_data->em\_social\_links = isset($data['em\_social\_links']) ? $data['em\_social\_links'] : ''; |
| [955](#L955) | $performers[] = $ep\_functions->insert\_performer\_post\_data((array)$performer\_data); |
| [956](#L956) | } |
| [957](#L957) | update\_post\_meta( $post\_id, 'em\_performer', $performers ); |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) |  |
| [961](#L961) | // save category |
| [962](#L962) | $dbhandler = new EP\_DBhandler; |
| [963](#L963) | $cat\_table\_name = 'TICKET\_CATEGORIES'; |
| [964](#L964) | $price\_options\_table = 'TICKET'; |
| [965](#L965) | if( isset( $data['em\_ticket\_category\_data'] ) && ! empty( $data['em\_ticket\_category\_data'] ) ) { |
| [966](#L966) | $em\_ticket\_category\_data = json\_decode( stripslashes( $data['em\_ticket\_category\_data'] ), true) ; |
| [967](#L967) | } |
| [968](#L968) | if( ! empty( $em\_ticket\_category\_data ) ) { |
| [969](#L969) | $cat\_priority = 1; |
| [970](#L970) | foreach( $em\_ticket\_category\_data as $cat ) { |
| [971](#L971) | $cat = $sanitizer->sanitize($cat); |
| [972](#L972) | $cat\_id = $cat['id']; |
| [973](#L973) | $get\_field\_data = ''; |
| [974](#L974) | if( !empty( $cat\_id ) ) { |
| [975](#L975) | $get\_field\_data = $dbhandler->get\_all\_result($cat\_table\_name,'\*',array('event\_id'=>$post\_id,'id'=>$cat\_id)); |
| [976](#L976) | } |
| [977](#L977) | if( empty( $get\_field\_data ) ) { |
| [978](#L978) | $save\_data                               = array(); |
| [979](#L979) | $save\_data['event\_id']   = $post\_id; |
| [980](#L980) | $save\_data['name']           = $cat['name']; |
| [981](#L981) | $save\_data['capacity']   = $cat['capacity']; |
| [982](#L982) | $save\_data['priority']   = 1; |
| [983](#L983) | $save\_data['status']     = 1; |
| [984](#L984) | $save\_data['created\_by'] = get\_current\_user\_id(); |
| [985](#L985) | $save\_data['created\_at'] = date\_i18n( "Y-m-d H:i:s", time() ); |
| [986](#L986) | $cat\_id = $dbhandler->insert\_row($cat\_table\_name, $save\_data); |
| [987](#L987) | } else{ |
| [988](#L988) | $update\_data =  array( |
| [989](#L989) | 'name'                    => $cat['name'], |
| [990](#L990) | 'capacity'                => $cat['capacity'], |
| [991](#L991) | 'priority'                => $cat\_priority, |
| [992](#L992) | 'last\_updated\_by' => get\_current\_user\_id(), |
| [993](#L993) | 'updated\_at'      => date\_i18n("Y-m-d H:i:s", time()) |
| [994](#L994) | ); |
| [995](#L995) | $dbhandler->update\_row($cat\_table\_name,'id', $cat\_id, $update\_data); |
| [996](#L996) |  |
| [997](#L997) | } |
| [998](#L998) | $cat\_priority++; |
| [999](#L999) | //save tickets |
| [1000](#L1000) | if( isset( $cat['tickets'] ) && ! empty( $cat['tickets'] ) ) { |
| [1001](#L1001) | $cat\_ticket\_priority = 1; |
| [1002](#L1002) | foreach( $cat['tickets'] as $ticket ) { |
| [1003](#L1003) | $ticket = $sanitizer->sanitize($ticket); |
| [1004](#L1004) | $ticket\_data = array(); |
| [1005](#L1005) | if( isset( $ticket['id'] ) && ! empty( $ticket['id'] && is\_int( $ticket['id'] ) ) ) { |
| [1006](#L1006) | $ticket\_id = $ticket['id']; |
| [1007](#L1007) | $get\_ticket\_data = $dbhandler->get\_all\_result($price\_options\_table,'\*',array('id'=>$ticket\_id)); |
| [1008](#L1008) | if( ! empty( $get\_ticket\_data ) ) { |
| [1009](#L1009) | $ticket\_data['name']                                   = addslashes( $ticket['name'] ); |
| [1010](#L1010) | $ticket\_data['description']                    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1011](#L1011) | $ticket\_data['price']                                  = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1012](#L1012) | $ticket\_data['capacity']                       = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1013](#L1013) | $ticket\_data['icon']                                   = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1014](#L1014) | $ticket\_data['priority']                       = $cat\_ticket\_priority; |
| [1015](#L1015) | $ticket\_data['updated\_at']                     = date\_i18n("Y-m-d H:i:s", time()); |
| [1016](#L1016) | $ticket\_data['additional\_fees']        = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1017](#L1017) | $ticket\_data['allow\_cancellation']     = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1018](#L1018) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1019](#L1019) | // date |
| [1020](#L1020) | $start\_date = []; |
| [1021](#L1021) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1022](#L1022) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1023](#L1023) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1024](#L1024) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1025](#L1025) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1026](#L1026) | } |
| [1027](#L1027) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1028](#L1028) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1029](#L1029) | } |
| [1030](#L1030) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1031](#L1031) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1032](#L1032) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1033](#L1033) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1034](#L1034) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1035](#L1035) | } |
| [1036](#L1036) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1037](#L1037) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1038](#L1038) | } |
| [1039](#L1039) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1040](#L1040) | } |
| [1041](#L1041) | } |
| [1042](#L1042) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1043](#L1043) | // end date |
| [1044](#L1044) | $end\_date = []; |
| [1045](#L1045) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1046](#L1046) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1047](#L1047) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1048](#L1048) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1049](#L1049) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1050](#L1050) | } |
| [1051](#L1051) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1052](#L1052) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1053](#L1053) | } |
| [1054](#L1054) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1055](#L1055) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1056](#L1056) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'relative\_date' ) { |
| [1057](#L1057) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1058](#L1058) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1059](#L1059) | } |
| [1060](#L1060) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1061](#L1061) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1062](#L1062) | } |
| [1063](#L1063) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1064](#L1064) | } |
| [1065](#L1065) | } |
| [1066](#L1066) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1067](#L1067) |  |
| [1068](#L1068) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1069](#L1069) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1070](#L1070) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1071](#L1071) | $dbhandler->update\_row($price\_options\_table,'id',$ticket\_id, $ticket\_data); |
| [1072](#L1072) |  |
| [1073](#L1073) | } else{ |
| [1074](#L1074) | $ticket\_data['category\_id']    = $cat\_id; |
| [1075](#L1075) | $ticket\_data['event\_id']       = $post\_id; |
| [1076](#L1076) | $ticket\_data['name']                   = addslashes( $ticket['name'] ); |
| [1077](#L1077) | $ticket\_data['description']    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1078](#L1078) | $ticket\_data['price']                  = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1079](#L1079) | $ticket\_data['special\_price']  = ''; |
| [1080](#L1080) | $ticket\_data['capacity']       = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1081](#L1081) | $ticket\_data['is\_default']     = 1; |
| [1082](#L1082) | $ticket\_data['is\_event\_price'] = 0; |
| [1083](#L1083) | $ticket\_data['icon']                   = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1084](#L1084) | $ticket\_data['priority']       = $cat\_ticket\_priority; |
| [1085](#L1085) | $ticket\_data['status']                 = 1; |
| [1086](#L1086) | $ticket\_data['created\_at']     = date\_i18n("Y-m-d H:i:s", time()); |
| [1087](#L1087) |  |
| [1088](#L1088) | // new |
| [1089](#L1089) | $ticket\_data['additional\_fees']    = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1090](#L1090) | $ticket\_data['allow\_cancellation'] = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1091](#L1091) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1092](#L1092) | // date |
| [1093](#L1093) | $start\_date = []; |
| [1094](#L1094) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1095](#L1095) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1096](#L1096) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1097](#L1097) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1098](#L1098) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1099](#L1099) | } |
| [1100](#L1100) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1101](#L1101) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1102](#L1102) | } |
| [1103](#L1103) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1104](#L1104) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1105](#L1105) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1106](#L1106) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1107](#L1107) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1108](#L1108) | } |
| [1109](#L1109) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1110](#L1110) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1111](#L1111) | } |
| [1112](#L1112) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1113](#L1113) | } |
| [1114](#L1114) | } |
| [1115](#L1115) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1116](#L1116) | // end date |
| [1117](#L1117) | $end\_date = []; |
| [1118](#L1118) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1119](#L1119) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1120](#L1120) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1121](#L1121) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1122](#L1122) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1123](#L1123) | } |
| [1124](#L1124) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1125](#L1125) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1126](#L1126) | } |
| [1127](#L1127) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1128](#L1128) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1129](#L1129) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_ends' ) { |
| [1130](#L1130) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1131](#L1131) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1132](#L1132) | } |
| [1133](#L1133) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1134](#L1134) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1135](#L1135) | } |
| [1136](#L1136) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1137](#L1137) | } |
| [1138](#L1138) | } |
| [1139](#L1139) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1140](#L1140) |  |
| [1141](#L1141) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1142](#L1142) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1143](#L1143) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1144](#L1144) | $result = $dbhandler->insert\_row($price\_options\_table, $ticket\_data); |
| [1145](#L1145) |  |
| [1146](#L1146) | } |
| [1147](#L1147) | } else{ |
| [1148](#L1148) | $ticket\_data['category\_id']    = $cat\_id; |
| [1149](#L1149) | $ticket\_data['event\_id']           = $post\_id; |
| [1150](#L1150) | $ticket\_data['name']               = addslashes( $ticket['name'] ); |
| [1151](#L1151) | $ticket\_data['description']    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1152](#L1152) | $ticket\_data['price']              = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1153](#L1153) | $ticket\_data['special\_price']  = ''; |
| [1154](#L1154) | $ticket\_data['capacity']           = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1155](#L1155) | $ticket\_data['is\_default']     = 1; |
| [1156](#L1156) | $ticket\_data['is\_event\_price'] = 0; |
| [1157](#L1157) | $ticket\_data['icon']               = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1158](#L1158) | $ticket\_data['priority']           = $cat\_ticket\_priority; |
| [1159](#L1159) | $ticket\_data['status']             = 1; |
| [1160](#L1160) | $ticket\_data['created\_at']         = date\_i18n("Y-m-d H:i:s", time()); |
| [1161](#L1161) |  |
| [1162](#L1162) | // new |
| [1163](#L1163) | $ticket\_data['additional\_fees']    = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1164](#L1164) | $ticket\_data['allow\_cancellation'] = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1165](#L1165) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1166](#L1166) | // date |
| [1167](#L1167) | $start\_date = []; |
| [1168](#L1168) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1169](#L1169) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1170](#L1170) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1171](#L1171) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1172](#L1172) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1173](#L1173) | } |
| [1174](#L1174) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1175](#L1175) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1176](#L1176) | } |
| [1177](#L1177) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1178](#L1178) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1179](#L1179) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1180](#L1180) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1181](#L1181) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1182](#L1182) | } |
| [1183](#L1183) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1184](#L1184) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1185](#L1185) | } |
| [1186](#L1186) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1187](#L1187) | } |
| [1188](#L1188) | } |
| [1189](#L1189) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1190](#L1190) | // end date |
| [1191](#L1191) | $end\_date = []; |
| [1192](#L1192) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1193](#L1193) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1194](#L1194) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1195](#L1195) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1196](#L1196) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1197](#L1197) | } |
| [1198](#L1198) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1199](#L1199) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1200](#L1200) | } |
| [1201](#L1201) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1202](#L1202) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1203](#L1203) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_ends' ) { |
| [1204](#L1204) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1205](#L1205) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1206](#L1206) | } |
| [1207](#L1207) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1208](#L1208) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1209](#L1209) | } |
| [1210](#L1210) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1211](#L1211) | } |
| [1212](#L1212) | } |
| [1213](#L1213) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1214](#L1214) |  |
| [1215](#L1215) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1216](#L1216) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1217](#L1217) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1218](#L1218) | $result = $dbhandler->insert\_row($price\_options\_table, $ticket\_data); |
| [1219](#L1219) |  |
| [1220](#L1220) | } |
| [1221](#L1221) | $cat\_ticket\_priority++; |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | update\_post\_meta( $post\_id, 'em\_enable\_booking', 'bookings\_on' ); |
| [1225](#L1225) | } |
| [1226](#L1226) | } |
| [1227](#L1227) | } |
| [1228](#L1228) |  |
| [1229](#L1229) | // delete category |
| [1230](#L1230) | if( isset( $data['em\_ticket\_category\_delete\_ids'] ) && !empty( $data['em\_ticket\_category\_delete\_ids'] ) ) { |
| [1231](#L1231) | $em\_ticket\_category\_delete\_ids = $data['em\_ticket\_category\_delete\_ids']; |
| [1232](#L1232) | $del\_ids = json\_decode( stripslashes( $em\_ticket\_category\_delete\_ids ) ); |
| [1233](#L1233) | if( is\_string( $em\_ticket\_category\_delete\_ids ) && is\_array( json\_decode( stripslashes( $em\_ticket\_category\_delete\_ids ) ) ) &&  json\_last\_error() == JSON\_ERROR\_NONE ) { |
| [1234](#L1234) | foreach( $del\_ids as $id ) { |
| [1235](#L1235) | $dbhandler->remove\_row($cat\_table\_name,'id', $id); |
| [1236](#L1236) | } |
| [1237](#L1237) | } |
| [1238](#L1238) | } |
| [1239](#L1239) |  |
| [1240](#L1240) | // save tickets |
| [1241](#L1241) | if( isset( $data['em\_ticket\_individual\_data'] ) && ! empty( $data['em\_ticket\_individual\_data'] ) ) { |
| [1242](#L1242) | $em\_ticket\_individual\_data = json\_decode( stripslashes( $data['em\_ticket\_individual\_data'] ), true) ; |
| [1243](#L1243) | if( isset( $em\_ticket\_individual\_data ) && ! empty( $em\_ticket\_individual\_data ) ) { |
| [1244](#L1244) | foreach( $em\_ticket\_individual\_data as $ticket ) { |
| [1245](#L1245) | $ticket = $sanitizer->sanitize($ticket); |
| [1246](#L1246) | if( isset( $ticket['id'] ) && ! empty( $ticket['id'] ) && is\_int( $ticket['id'] ) ) { |
| [1247](#L1247) | $ticket\_id = $ticket['id']; |
| [1248](#L1248) | $get\_ticket\_data = $dbhandler->get\_all\_result($price\_options\_table,'\*',array('id'=>$ticket\_id)); |
| [1249](#L1249) | if( ! empty( $get\_ticket\_data ) ) { |
| [1250](#L1250) | $ticket\_data                               = array(); |
| [1251](#L1251) | $ticket\_data['name']               = addslashes( $ticket['name'] ); |
| [1252](#L1252) | $ticket\_data['description']    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1253](#L1253) | $ticket\_data['price']              = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1254](#L1254) | $ticket\_data['capacity']           = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1255](#L1255) | $ticket\_data['icon']               = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1256](#L1256) | $ticket\_data['updated\_at']         = date\_i18n("Y-m-d H:i:s", time()); |
| [1257](#L1257) | $ticket\_data['additional\_fees']    = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1258](#L1258) | $ticket\_data['allow\_cancellation'] = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1259](#L1259) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1260](#L1260) | // date |
| [1261](#L1261) | $start\_date = []; |
| [1262](#L1262) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1263](#L1263) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1264](#L1264) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1265](#L1265) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1266](#L1266) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1267](#L1267) | } |
| [1268](#L1268) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1269](#L1269) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1270](#L1270) | } |
| [1271](#L1271) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1272](#L1272) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1273](#L1273) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1274](#L1274) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1275](#L1275) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1276](#L1276) | } |
| [1277](#L1277) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1278](#L1278) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1279](#L1279) | } |
| [1280](#L1280) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1281](#L1281) | } |
| [1282](#L1282) | } |
| [1283](#L1283) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1284](#L1284) | // end date |
| [1285](#L1285) | $end\_date = []; |
| [1286](#L1286) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1287](#L1287) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1288](#L1288) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1289](#L1289) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1290](#L1290) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1291](#L1291) | } |
| [1292](#L1292) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1293](#L1293) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1294](#L1294) | } |
| [1295](#L1295) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1296](#L1296) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1297](#L1297) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'relative\_date' ) { |
| [1298](#L1298) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1299](#L1299) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1300](#L1300) | } |
| [1301](#L1301) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1302](#L1302) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1303](#L1303) | } |
| [1304](#L1304) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1305](#L1305) | } |
| [1306](#L1306) | } |
| [1307](#L1307) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1308](#L1308) |  |
| [1309](#L1309) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1310](#L1310) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1311](#L1311) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1312](#L1312) | $dbhandler->update\_row($price\_options\_table,'id', $ticket\_id, $ticket\_data); |
| [1313](#L1313) |  |
| [1314](#L1314) | } else{ |
| [1315](#L1315) | $ticket\_data                               = array(); |
| [1316](#L1316) | $ticket\_data['category\_id']    = 0; |
| [1317](#L1317) | $ticket\_data['event\_id']           = $post\_id; |
| [1318](#L1318) | $ticket\_data['name']               = addslashes( $ticket['name'] ); |
| [1319](#L1319) | $ticket\_data['description']    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1320](#L1320) | $ticket\_data['price']              = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1321](#L1321) | $ticket\_data['special\_price']  = ''; |
| [1322](#L1322) | $ticket\_data['capacity']           = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1323](#L1323) | $ticket\_data['is\_default']     = 1; |
| [1324](#L1324) | $ticket\_data['is\_event\_price'] = 0; |
| [1325](#L1325) | $ticket\_data['icon']               = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1326](#L1326) | $ticket\_data['priority']           = 1; |
| [1327](#L1327) | $ticket\_data['status']             = 1; |
| [1328](#L1328) | $ticket\_data['created\_at']         = date\_i18n("Y-m-d H:i:s", time()); |
| [1329](#L1329) |  |
| [1330](#L1330) | // new |
| [1331](#L1331) | $ticket\_data['additional\_fees']    = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1332](#L1332) | $ticket\_data['allow\_cancellation'] = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1333](#L1333) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1334](#L1334) | // date |
| [1335](#L1335) | $start\_date = []; |
| [1336](#L1336) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1337](#L1337) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1338](#L1338) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1339](#L1339) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1340](#L1340) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1341](#L1341) | } |
| [1342](#L1342) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1343](#L1343) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1344](#L1344) | } |
| [1345](#L1345) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1346](#L1346) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1347](#L1347) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1348](#L1348) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1349](#L1349) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1350](#L1350) | } |
| [1351](#L1351) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1352](#L1352) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1353](#L1353) | } |
| [1354](#L1354) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1355](#L1355) | } |
| [1356](#L1356) | } |
| [1357](#L1357) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1358](#L1358) | // end date |
| [1359](#L1359) | $end\_date = []; |
| [1360](#L1360) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1361](#L1361) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1362](#L1362) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1363](#L1363) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1364](#L1364) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1365](#L1365) | } |
| [1366](#L1366) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1367](#L1367) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1368](#L1368) | } |
| [1369](#L1369) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1370](#L1370) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1371](#L1371) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'relative\_date' ) { |
| [1372](#L1372) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1373](#L1373) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1374](#L1374) | } |
| [1375](#L1375) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1376](#L1376) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1377](#L1377) | } |
| [1378](#L1378) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1379](#L1379) | } |
| [1380](#L1380) | } |
| [1381](#L1381) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1382](#L1382) |  |
| [1383](#L1383) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1384](#L1384) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1385](#L1385) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1386](#L1386) | $result = $dbhandler->insert\_row($price\_options\_table, $ticket\_data); |
| [1387](#L1387) |  |
| [1388](#L1388) | } |
| [1389](#L1389) | } else{ |
| [1390](#L1390) | $ticket\_data                                   = array(); |
| [1391](#L1391) | $ticket\_data['category\_id']    = 0; |
| [1392](#L1392) | $ticket\_data['event\_id']       = $post\_id; |
| [1393](#L1393) | $ticket\_data['name']                   = addslashes( $ticket['name'] ); |
| [1394](#L1394) | $ticket\_data['description']    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1395](#L1395) | $ticket\_data['price']                  = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1396](#L1396) | $ticket\_data['special\_price']  = ''; |
| [1397](#L1397) | $ticket\_data['capacity']       = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1398](#L1398) | $ticket\_data['is\_default']     = 1; |
| [1399](#L1399) | $ticket\_data['is\_event\_price'] = 0; |
| [1400](#L1400) | $ticket\_data['icon']                   = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1401](#L1401) | $ticket\_data['priority']       = 1; |
| [1402](#L1402) | $ticket\_data['status']                 = 1; |
| [1403](#L1403) | $ticket\_data['created\_at']     = date\_i18n("Y-m-d H:i:s", time()); |
| [1404](#L1404) |  |
| [1405](#L1405) | // new |
| [1406](#L1406) | $ticket\_data['additional\_fees']    = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1407](#L1407) | $ticket\_data['allow\_cancellation'] = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1408](#L1408) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1409](#L1409) | // date |
| [1410](#L1410) | $start\_date = []; |
| [1411](#L1411) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1412](#L1412) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1413](#L1413) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1414](#L1414) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1415](#L1415) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1416](#L1416) | } |
| [1417](#L1417) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1418](#L1418) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1419](#L1419) | } |
| [1420](#L1420) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1421](#L1421) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1422](#L1422) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1423](#L1423) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1424](#L1424) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1425](#L1425) | } |
| [1426](#L1426) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1427](#L1427) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1428](#L1428) | } |
| [1429](#L1429) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1430](#L1430) | } |
| [1431](#L1431) | } |
| [1432](#L1432) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1433](#L1433) | // end date |
| [1434](#L1434) | $end\_date = []; |
| [1435](#L1435) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1436](#L1436) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1437](#L1437) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1438](#L1438) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1439](#L1439) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1440](#L1440) | } |
| [1441](#L1441) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1442](#L1442) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1443](#L1443) | } |
| [1444](#L1444) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1445](#L1445) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1446](#L1446) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'relative\_date' ) { |
| [1447](#L1447) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1448](#L1448) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1449](#L1449) | } |
| [1450](#L1450) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1451](#L1451) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1452](#L1452) | } |
| [1453](#L1453) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1454](#L1454) | } |
| [1455](#L1455) | } |
| [1456](#L1456) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1457](#L1457) |  |
| [1458](#L1458) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1459](#L1459) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1460](#L1460) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1461](#L1461) | $result = $dbhandler->insert\_row($price\_options\_table, $ticket\_data); |
| [1462](#L1462) |  |
| [1463](#L1463) | } |
| [1464](#L1464) | } |
| [1465](#L1465) |  |
| [1466](#L1466) | update\_post\_meta( $post\_id, 'em\_enable\_booking', 'bookings\_on' ); |
| [1467](#L1467) | } |
| [1468](#L1468) | } |
| [1469](#L1469) |  |
| [1470](#L1470) | // delete tickets |
| [1471](#L1471) | if( isset( $data['em\_ticket\_individual\_delete\_ids'] ) && !empty( $data['em\_ticket\_individual\_delete\_ids'] ) ) { |
| [1472](#L1472) | $em\_ticket\_individual\_delete\_ids = $data['em\_ticket\_individual\_delete\_ids']; |
| [1473](#L1473) | $del\_ids = json\_decode( stripslashes( $em\_ticket\_individual\_delete\_ids ) ); |
| [1474](#L1474) | if( is\_string( $em\_ticket\_individual\_delete\_ids ) && is\_array( json\_decode( stripslashes( $em\_ticket\_individual\_delete\_ids ) ) ) &&  json\_last\_error() == JSON\_ERROR\_NONE ) { |
| [1475](#L1475) | foreach( $del\_ids as $id ) { |
| [1476](#L1476) | $dbhandler->remove\_row($price\_options\_table,'id', $id); |
| [1477](#L1477) | } |
| [1478](#L1478) | } |
| [1479](#L1479) | } |
| [1480](#L1480) |  |
| [1481](#L1481) | /\* $frontend\_event\_controller = EventM\_Factory\_Service::ep\_get\_instance( 'EventM\_Event\_Controller\_Frontend\_Submission'); |
| [1482](#L1482) | $response = $frontend\_event\_controller->insert\_frontend\_event\_post\_data((array)$event\_data); \*/ |
| [1483](#L1483) | do\_action( 'ep\_after\_save\_front\_end\_event', $post\_id ); |
| [1484](#L1484) | $notifications->event\_submitted( $post\_id ); |
| [1485](#L1485) | $submit\_message = esc\_html\_\_( 'Thank you for submitting your event. We will review and publish it soon.', 'eventprime-event-calendar-management' ); |
| [1486](#L1486) | if( $post\_status == 'draft' ) { |
| [1487](#L1487) | $ues\_confirm\_message = $ep\_functions->ep\_get\_global\_settings( 'ues\_confirm\_message' ); |
| [1488](#L1488) | if( ! empty( $ues\_confirm\_message ) ) { |
| [1489](#L1489) | $submit\_message = $ues\_confirm\_message; |
| [1490](#L1490) | } |
| [1491](#L1491) | } else{ |
| [1492](#L1492) | if( ! empty( $data['event\_id'] ) ) { |
| [1493](#L1493) | $submit\_message = esc\_html\_\_( 'Event Updated Successfully.', 'eventprime-event-calendar-management' ); |
| [1494](#L1494) | } else{ |
| [1495](#L1495) | $submit\_message = esc\_html\_\_( 'Event Saved Successfully.', 'eventprime-event-calendar-management' ); |
| [1496](#L1496) | } |
| [1497](#L1497) | } |
| [1498](#L1498) |  |
| [1499](#L1499) | $data\_send = array( 'message' => $submit\_message, 'redirect' => null ); |
| [1500](#L1500) | $data\_send = apply\_filters( 'ep\_front\_end\_event\_send\_additional\_data', $data\_send ); |
| [1501](#L1501) | wp\_send\_json\_success( $data\_send ); |
| [1502](#L1502) |  |
| [1503](#L1503) | // wp\_send\_json\_success( array( 'message' => $submit\_message ) ); |
| [1504](#L1504) |  |
| [1505](#L1505) | } else{ |
| [1506](#L1506) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [1507](#L1507) | } |
| [1508](#L1508) | } |
| [1509](#L1509) |  |
| [1510](#L1510) |  |
| [1511](#L1511) | public function upload\_file\_media(){ |
| [1512](#L1512) | if(isset($\_FILES["file"]) && !empty($\_FILES["file"])){ |
| [1513](#L1513) | $extension = pathinfo( $\_FILES["file"]["name"], PATHINFO\_EXTENSION ); |
| [1514](#L1514) | if( $extension != 'jpg' && $extension != 'jpeg' && $extension != 'png' && $extension != 'gif' ) { |
| [1515](#L1515) | wp\_send\_json\_error( array( 'errors' => array( 'Only Image File Allowed.' ) ) ); |
| [1516](#L1516) | } |
| [1517](#L1517) | $file = $\_FILES['file']; |
| [1518](#L1518) | $filename = $file['name']; |
| [1519](#L1519) | $tmp\_name = $file['tmp\_name']; |
| [1520](#L1520) | $upload\_dir = wp\_upload\_dir(); |
| [1521](#L1521) | if (move\_uploaded\_file($file["tmp\_name"], $upload\_dir['path'] . "/" . $filename)) { |
| [1522](#L1522) | $uploaded\_file['file\_name'] = $filename; |
| [1523](#L1523) | $uploaded\_file['upload\_url'] = $upload\_dir['url'] . "/" . $filename; |
| [1524](#L1524) | $wp\_filetype = wp\_check\_filetype($filename, null ); |
| [1525](#L1525) | $attachment = array( |
| [1526](#L1526) | 'guid'           => $uploaded\_file['upload\_url'], |
| [1527](#L1527) | 'post\_mime\_type' => $wp\_filetype['type'], |
| [1528](#L1528) | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', $filename ), |
| [1529](#L1529) | 'post\_content'   => '', |
| [1530](#L1530) | 'post\_status'    => 'inherit' |
| [1531](#L1531) | ); |
| [1532](#L1532) | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_dir['path'] . "/" . $filename ); |
| [1533](#L1533) | if ( ! is\_wp\_error( $attachment\_id ) ) { |
| [1534](#L1534) | require\_once(ABSPATH . "wp-admin" . '/includes/file.php'); |
| [1535](#L1535) | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_dir['path'] . "/" . $filename ); |
| [1536](#L1536) | wp\_update\_attachment\_metadata( $attachment\_id,  $attachment\_data ); |
| [1537](#L1537) | $returnData['success'] = array( 'attachment\_id' => $attachment\_id ); |
| [1538](#L1538) | } |
| [1539](#L1539) | } |
| [1540](#L1540) | else{ |
| [1541](#L1541) | $returnData['errors'] = \_\_($upload\_file['error']); |
| [1542](#L1542) | } |
| [1543](#L1543) | } |
| [1544](#L1544) | if( isset( $returnData['success'] ) ) { |
| [1545](#L1545) | wp\_send\_json\_success( $returnData['success'] ); |
| [1546](#L1546) | }else{ |
| [1547](#L1547) | wp\_send\_json\_success( $returnData ); |
| [1548](#L1548) | } |
| [1549](#L1549) | } |
| [1550](#L1550) |  |
| [1551](#L1551) |  |
| [1552](#L1552) | public function booking\_update\_status(){ |
| [1553](#L1553) | // Check if nonce is valid |
| [1554](#L1554) |  |
| [1555](#L1555) | if (!isset($\_POST['security']) || !wp\_verify\_nonce($\_POST['security'], 'ep\_booking\_nonce')) { |
| [1556](#L1556) | wp\_die('Security check failed'); |
| [1557](#L1557) | } |
| [1558](#L1558) |  |
| [1559](#L1559) | if( isset( $\_POST['booking\_id'] ) && isset($\_POST['status']) && !empty(trim($\_POST['status'])) && current\_user\_can('manage\_options')) { |
| [1560](#L1560) | $booking\_id = absint( $\_POST['booking\_id'] ); |
| [1561](#L1561) | $status = sanitize\_text\_field($\_POST['status']); |
| [1562](#L1562) | $booking\_controller = new EventPrime\_Bookings; |
| [1563](#L1563) | $response = $booking\_controller->update\_status( $booking\_id, $status); |
| [1564](#L1564) | wp\_send\_json\_success( $response ); |
| [1565](#L1565) | }else{ |
| [1566](#L1566) | wp\_send\_json\_error(); |
| [1567](#L1567) | } |
| [1568](#L1568) | } |
| [1569](#L1569) |  |
| [1570](#L1570) | public function load\_event\_dates() { |
| [1571](#L1571) | // Get all the events dates |
| [1572](#L1572) | $data = new stdClass(); |
| [1573](#L1573) | $data->start\_dates = array(); |
| [1574](#L1574) | $data->event\_ids = array(); |
| [1575](#L1575) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1576](#L1576) | $query = array('meta\_query'  => array( 'relation' => 'AND', |
| [1577](#L1577) | array( |
| [1578](#L1578) | array( |
| [1579](#L1579) | 'key'     => 'em\_start\_date', |
| [1580](#L1580) | 'value'   =>  current\_time( 'timestamp' ), |
| [1581](#L1581) | 'compare' => '>', |
| [1582](#L1582) | 'type'=>'NUMERIC' |
| [1583](#L1583) | ) |
| [1584](#L1584) | ) |
| [1585](#L1585) | ) |
| [1586](#L1586) | ); |
| [1587](#L1587) | $events = $ep\_functions->get\_events\_post\_data($query); |
| [1588](#L1588) | if($events->posts){ |
| [1589](#L1589) | foreach ($events->posts as $event){ |
| [1590](#L1590) | $start\_date = date('Y-m-d', get\_post\_meta($event->id, 'em\_start\_date', true)); |
| [1591](#L1591) | $end\_date = date('Y-m-d', get\_post\_meta($event->id, 'em\_end\_date', true)); |
| [1592](#L1592) |  |
| [1593](#L1593) | if (!empty($start\_date)){ |
| [1594](#L1594) | preg\_match('/[0-9]{4}\-[0-9]{1,2}-[0-9]{1,2}/', $start\_date, $matches); |
| [1595](#L1595) | if (count($matches) > 0 && !empty($matches[0])) { |
| [1596](#L1596) | //epd($matches); |
| [1597](#L1597) | if ( strtotime($matches[0]) <= strtotime(date('Y-m-d') ) && strtotime( $end\_date ) >= strtotime( date('Y-m-d') ) ) { |
| [1598](#L1598) | $data->start\_dates[] = date($ep\_functions->ep\_get\_datepicker\_format()); |
| [1599](#L1599) | } else{ |
| [1600](#L1600) | $data->start\_dates[] = date($ep\_functions->ep\_get\_datepicker\_format(), strtotime($matches[0]) ); |
| [1601](#L1601) | } |
| [1602](#L1602) | $data->event\_ids[] = $event->id; |
| [1603](#L1603) | } |
| [1604](#L1604) | } |
| [1605](#L1605) | } |
| [1606](#L1606) | } |
| [1607](#L1607) |  |
| [1608](#L1608) | echo json\_encode($data); |
| [1609](#L1609) | die; |
| [1610](#L1610) | } |
| [1611](#L1611) |  |
| [1612](#L1612) | /\* |
| [1613](#L1613) | \* Load more upcoming events |
| [1614](#L1614) | \*/ |
| [1615](#L1615) | public function load\_more\_upcomingevent\_performer(){ |
| [1616](#L1616) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1617](#L1617) | $response = $ep\_functions->get\_eventupcoming\_performer\_loadmore(); |
| [1618](#L1618) | wp\_send\_json\_success($response); |
| [1619](#L1619) | die(); |
| [1620](#L1620) | } |
| [1621](#L1621) | public function load\_more\_upcomingevent\_venue(){ |
| [1622](#L1622) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1623](#L1623) | $response = $ep\_functions->get\_eventupcoming\_venue\_loadmore(); |
| [1624](#L1624) | wp\_send\_json\_success($response); |
| [1625](#L1625) | die(); |
| [1626](#L1626) | } |
| [1627](#L1627) | public function load\_more\_upcomingevent\_organizer(){ |
| [1628](#L1628) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1629](#L1629) | $response = $ep\_functions->get\_eventupcoming\_organizer\_loadmore(); |
| [1630](#L1630) | wp\_send\_json\_success($response); |
| [1631](#L1631) | die(); |
| [1632](#L1632) | } |
| [1633](#L1633) | public function load\_more\_upcomingevent\_eventtype(){ |
| [1634](#L1634) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1635](#L1635) | $response = $ep\_functions->get\_eventupcoming\_eventtype\_loadmore(); |
| [1636](#L1636) | wp\_send\_json\_success($response); |
| [1637](#L1637) | die(); |
| [1638](#L1638) | } |
| [1639](#L1639) |  |
| [1640](#L1640) | /\*\* |
| [1641](#L1641) | \* Filter event data |
| [1642](#L1642) | \* |
| [1643](#L1643) | \* @return Event Html. |
| [1644](#L1644) | \*/ |
| [1645](#L1645) | public function filter\_event\_data() { |
| [1646](#L1646) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1647](#L1647) | $response = $ep\_functions->get\_filtered\_event\_content(); |
| [1648](#L1648) | wp\_send\_json\_success( $response ); |
| [1649](#L1649) | die(); |
| [1650](#L1650) | } |
| [1651](#L1651) |  |
| [1652](#L1652) | /\*\* |
| [1653](#L1653) | \* Get all offers date of an event |
| [1654](#L1654) | \*/ |
| [1655](#L1655) | public function load\_event\_offers\_date() { |
| [1656](#L1656) |  |
| [1657](#L1657) | check\_ajax\_referer( 'single-event-data-nonce', 'security' ); |
| [1658](#L1658) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1659](#L1659) | $offer\_data = $event\_data = $offer\_dates = array(); |
| [1660](#L1660) | if( isset( $\_POST['offer\_data'] ) && ! empty( $\_POST['offer\_data'] ) ) { |
| [1661](#L1661) | $offer\_data = json\_decode( stripslashes( $\_POST['offer\_data'] ) ); |
| [1662](#L1662) |  |
| [1663](#L1663) | /\* $event\_controller = EventM\_Factory\_Service::ep\_get\_instance( 'EventM\_Event\_Controller\_List' ); |
| [1664](#L1664) | $single\_event = $event\_controller->get\_single\_event( $event\_id ); |
| [1665](#L1665) | $single\_event->venue\_other\_events = EventM\_Factory\_Service::get\_upcoming\_event\_by\_venue\_id( $single\_event->em\_venue, array( $single\_event->id ) ); |
| [1666](#L1666) | wp\_send\_json\_success( $single\_event ); \*/ |
| [1667](#L1667) | } |
| [1668](#L1668) | if( isset( $\_POST['event\_data'] ) && ! empty( $\_POST['event\_data'] ) ) { |
| [1669](#L1669) | $event\_data = $\_POST['event\_data']; |
| [1670](#L1670) | } |
| [1671](#L1671) | if( ! empty( $offer\_data ) && ! empty( $event\_data ) ) { |
| [1672](#L1672) | foreach( $offer\_data as $offer ) { |
| [1673](#L1673) | $offer\_date = $ep\_functions->get\_offer\_date( $offer, $event\_data ); |
| [1674](#L1674) | if( ! empty( $offer\_date ) ) { |
| [1675](#L1675) | $offer\_dates[ $offer->uid ] = $offer\_date; |
| [1676](#L1676) | } |
| [1677](#L1677) | } |
| [1678](#L1678) | wp\_send\_json\_success( $offer\_dates ); |
| [1679](#L1679) | } else{ |
| [1680](#L1680) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Data Not Found', 'eventprime-event-calendar-management' ) ) ); |
| [1681](#L1681) | } |
| [1682](#L1682) | } |
| [1683](#L1683) |  |
| [1684](#L1684) | /\*\* |
| [1685](#L1685) | \* Update user's timezone |
| [1686](#L1686) | \*/ |
| [1687](#L1687) | public function update\_user\_timezone() { |
| [1688](#L1688) | check\_ajax\_referer( 'ep-frontend-nonce', 'security' ); |
| [1689](#L1689) | if( isset( $\_POST['time\_zone'] ) && ! empty( $\_POST['time\_zone'] ) ) { |
| [1690](#L1690) | $time\_zone = $\_POST['time\_zone']; |
| [1691](#L1691) | $user\_id = get\_current\_user\_id(); |
| [1692](#L1692) | if( ! empty( $user\_id ) ) { |
| [1693](#L1693) | // get tizone string from offset |
| [1694](#L1694) | /\* if( strpos( $time\_zone, 'UTC-' ) !== false ) { |
| [1695](#L1695) | $offset = explode( 'UTC-', $time\_zone )[1]; |
| [1696](#L1696) | if( ! empty( $offset ) ) { |
| [1697](#L1697) | $time\_zone = get\_site\_timezone\_from\_offset( $offset ); |
| [1698](#L1698) | } |
| [1699](#L1699) | } elseif( strpos( $time\_zone, 'UTC+' ) !== false ) { |
| [1700](#L1700) | $offset = explode( 'UTC+', $time\_zone )[1]; |
| [1701](#L1701) | if( ! empty( $offset ) ) { |
| [1702](#L1702) | $time\_zone = get\_site\_timezone\_from\_offset( $offset ); |
| [1703](#L1703) | } |
| [1704](#L1704) | } \*/ |
| [1705](#L1705) |  |
| [1706](#L1706) | update\_user\_meta( $user\_id, 'ep\_user\_timezone\_meta', $time\_zone ); |
| [1707](#L1707) |  |
| [1708](#L1708) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Timezone updated successfully', 'eventprime-event-calendar-management' ) ) ); |
| [1709](#L1709) | } else{ |
| [1710](#L1710) | //wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Unauthorized access. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [1711](#L1711) | setcookie( 'ep\_user\_timezone\_meta', $time\_zone, time() + (86400 \* 30), "/"); |
| [1712](#L1712) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Timezone updated successfully', 'eventprime-event-calendar-management' ) ) ); |
| [1713](#L1713) | } |
| [1714](#L1714) | } else{ |
| [1715](#L1715) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Please select timezone and save.', 'eventprime-event-calendar-management' ) ) ); |
| [1716](#L1716) | } |
| [1717](#L1717) | } |
| [1718](#L1718) |  |
| [1719](#L1719) | /\* |
| [1720](#L1720) | \* Validate Create account details on checkout page |
| [1721](#L1721) | \*/ |
| [1722](#L1722) | public function validate\_user\_details\_booking(){ |
| [1723](#L1723) | $response\_code = 1; |
| [1724](#L1724) | $response = ''; |
| [1725](#L1725) | $rule = sanitize\_text\_field($\_POST['rules']); |
| [1726](#L1726) | //Validate Username |
| [1727](#L1727) | if($rule == 'username'){ |
| [1728](#L1728) | $username = sanitize\_text\_field($\_POST['username']); |
| [1729](#L1729) | if(!empty($username)){ |
| [1730](#L1730) | if(validate\_username($username)){ |
| [1731](#L1731) | if(username\_exists($username)){ |
| [1732](#L1732) | $response\_code = 0; |
| [1733](#L1733) | $response = esc\_html\_\_('Username already exists.','eventprime-event-calendar-management'); |
| [1734](#L1734) | }else{ |
| [1735](#L1735) | $response\_code = 1; |
| [1736](#L1736) | $response = esc\_html\_\_('Valid Username.','eventprime-event-calendar-management'); |
| [1737](#L1737) | } |
| [1738](#L1738) | }else{ |
| [1739](#L1739) | $response\_code = 0; |
| [1740](#L1740) | $response = esc\_html\_\_('Invalid Username.','eventprime-event-calendar-management'); |
| [1741](#L1741) | } |
| [1742](#L1742) | }else{ |
| [1743](#L1743) | $response\_code = 0; |
| [1744](#L1744) | $response = esc\_html\_\_('Username is required.','eventprime-event-calendar-management'); |
| [1745](#L1745) | } |
| [1746](#L1746) | }elseif($rule =='email'){ |
| [1747](#L1747) | $email = sanitize\_text\_field($\_POST['email']); |
| [1748](#L1748) | if(!empty($email)){ |
| [1749](#L1749) | if(email\_exists($email)){ |
| [1750](#L1750) | $response\_code = 0; |
| [1751](#L1751) | $response = esc\_html\_\_('Email already exists.','eventprime-event-calendar-management'); |
| [1752](#L1752) | }else{ |
| [1753](#L1753) | $response\_code = 1; |
| [1754](#L1754) | $response = esc\_html\_\_('Valid Email.','eventprime-event-calendar-management'); |
| [1755](#L1755) | } |
| [1756](#L1756) |  |
| [1757](#L1757) | }else{ |
| [1758](#L1758) | $response\_code = 0; |
| [1759](#L1759) | $response = esc\_html\_\_('Email is required.','eventprime-event-calendar-management'); |
| [1760](#L1760) | } |
| [1761](#L1761) | } |
| [1762](#L1762) | wp\_send\_json\_success(array('status'=>$response\_code,'message'=>$response)); |
| [1763](#L1763) | wp\_die(); |
| [1764](#L1764) | } |
| [1765](#L1765) |  |
| [1766](#L1766) | public function get\_attendees\_email\_by\_event\_id(){ |
| [1767](#L1767) | if(!isset($\_POST['\_wpnonce']) || !wp\_verify\_nonce( $\_POST['\_wpnonce'], 'ep\_email\_attendies' )){ |
| [1768](#L1768) | wp\_send\_json\_error( array( 'success'=> false, 'errors' => esc\_html\_\_( 'Security check failed.', 'eventprime-event-calendar-management' ) ) ); |
| [1769](#L1769) | } |
| [1770](#L1770) | if(empty(get\_current\_user\_id()) || !current\_user\_can( 'manage\_options' ) || !current\_user\_can( 'edit\_posts' )){ |
| [1771](#L1771) | wp\_send\_json\_error( array( 'success'=> false, 'errors' => esc\_html\_\_( 'You do not have permission.', 'eventprime-event-calendar-management' ) ) ); |
| [1772](#L1772) | } |
| [1773](#L1773) | $data = $\_POST; |
| [1774](#L1774) | $emails = array(); |
| [1775](#L1775) | $event\_id = absint($data['ep\_event\_id']); |
| [1776](#L1776) | if(!empty($event\_id)){ |
| [1777](#L1777) | $booking\_controller = new EventPrime\_Bookings; |
| [1778](#L1778) | $bookings = $booking\_controller->get\_event\_bookings\_by\_event\_id( $event\_id ); |
| [1779](#L1779) | if(!empty($bookings)){ |
| [1780](#L1780) | foreach($bookings as $booking){ |
| [1781](#L1781) | $user\_id = isset($booking->em\_user) ? (int) $booking->em\_user : 0; |
| [1782](#L1782) | if($user\_id){ |
| [1783](#L1783) | $user = get\_userdata($user\_id); |
| [1784](#L1784) | $emails[] = $user->user\_email; |
| [1785](#L1785) | }else{ |
| [1786](#L1786) | $order\_info = $booking->em\_order\_info; |
| [1787](#L1787) | if( ! empty( $order\_info ) && ! empty( $order\_info['user\_email'] ) ) { |
| [1788](#L1788) | $emails[] = esc\_html( $order\_info['user\_email'] ); |
| [1789](#L1789) | } |
| [1790](#L1790) | } |
| [1791](#L1791) | } |
| [1792](#L1792) | } |
| [1793](#L1793) | } |
| [1794](#L1794) | if( !empty( $emails ) && count( $emails ) > 0 ) { |
| [1795](#L1795) | $emails = array\_unique( $emails ); |
| [1796](#L1796) | wp\_send\_json\_success( array('status'=> true, 'emails'=> implode(',',$emails) )); |
| [1797](#L1797) | } |
| [1798](#L1798) | else{ |
| [1799](#L1799) | wp\_send\_json\_error( array( 'status'=> false, 'errors' => esc\_html\_\_( 'No Attendee Found', 'eventprime-event-calendar-management' ) ) ); |
| [1800](#L1800) | } |
| [1801](#L1801) |  |
| [1802](#L1802) | } |
| [1803](#L1803) |  |
| [1804](#L1804) | public function send\_attendees\_email(){ |
| [1805](#L1805) | if(!isset($\_POST['\_wpnonce']) || !wp\_verify\_nonce( $\_POST['\_wpnonce'], 'ep\_email\_attendies' )){ |
| [1806](#L1806) | wp\_send\_json\_error( array( 'success'=> false, 'message' => esc\_html\_\_( 'Security check failed.', 'eventprime-event-calendar-management' ) ) ); |
| [1807](#L1807) | } |
| [1808](#L1808) | if(empty(get\_current\_user\_id()) || !current\_user\_can( 'manage\_options' ) || !current\_user\_can( 'edit\_posts' )){ |
| [1809](#L1809) | wp\_send\_json\_error( array( 'success'=> false, 'message' => esc\_html\_\_( 'You do not have permission.', 'eventprime-event-calendar-management' ) ) ); |
| [1810](#L1810) | } |
| [1811](#L1811) | $data = $\_POST; |
| [1812](#L1812) | $email\_address = isset($data['email\_address']) && !empty($data['email\_address']) ? explode(',', $data['email\_address']) : array(); |
| [1813](#L1813) | $email\_subject = isset($data['email\_subject']) && !empty($data['email\_subject']) ? sanitize\_text\_field($data['email\_subject']) : get\_bloginfo(); |
| [1814](#L1814) | $content = isset($data['content\_html']) ? $data['content\_html'] : ''; |
| [1815](#L1815) | $cc\_email\_address = isset($data['cc\_email\_address']) && !empty($data['cc\_email\_address']) ? explode(',', $data['cc\_email\_address']) : array(); |
| [1816](#L1816) |  |
| [1817](#L1817) | $headers = array( 'Content-Type: text/html; charset=UTF-8' ); |
| [1818](#L1818) | if( ! empty( $cc\_email\_address ) ) { |
| [1819](#L1819) | foreach($cc\_email\_address as $cc){ |
| [1820](#L1820) | if ( filter\_var( $cc, FILTER\_VALIDATE\_EMAIL ) ) { |
| [1821](#L1821) | array\_push( $headers , "cc: $cc" ); |
| [1822](#L1822) | } |
| [1823](#L1823) | } |
| [1824](#L1824) | } |
| [1825](#L1825) | $sent = 0; |
| [1826](#L1826) | if( count( $email\_address ) > 0 ) { |
| [1827](#L1827) | foreach( $email\_address as $email ) { |
| [1828](#L1828) | $email\_sent = wp\_mail( $email, $email\_subject, $content, $headers ); |
| [1829](#L1829) | if(empty($sent)){ |
| [1830](#L1830) | $sent =  $email\_sent; |
| [1831](#L1831) | } |
| [1832](#L1832) | } |
| [1833](#L1833) | } |
| [1834](#L1834) | if(!empty($sent)){ |
| [1835](#L1835) | wp\_send\_json\_success( array( 'success' => true, "message" => esc\_html\_\_( 'Email send successfully', 'eventprime-event-calendar-management' ) ) ); |
| [1836](#L1836) | }else{ |
| [1837](#L1837) | wp\_send\_json\_error( array( 'success'=> false, 'message' => esc\_html\_\_( 'Email not send', 'eventprime-event-calendar-management' ) ) ); |
| [1838](#L1838) | } |
| [1839](#L1839) | } |
| [1840](#L1840) |  |
| [1841](#L1841) | /\*\* |
| [1842](#L1842) | \* Check if user name already exist |
| [1843](#L1843) | \*/ |
| [1844](#L1844) | public function rg\_check\_user\_name() { |
| [1845](#L1845) | if( wp\_verify\_nonce( $\_POST['security'], 'event-registration-form-nonce' ) ) { |
| [1846](#L1846) | if( ! empty( $\_POST['user\_name'] ) ) { |
| [1847](#L1847) | $user\_name = sanitize\_text\_field( $\_POST['user\_name'] ); |
| [1848](#L1848) | if ( username\_exists( $user\_name ) ) { |
| [1849](#L1849) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'User name already exist.', 'eventprime-event-calendar-management' ) ) ); |
| [1850](#L1850) | } else{ |
| [1851](#L1851) | wp\_send\_json\_success(); |
| [1852](#L1852) | } |
| [1853](#L1853) | } else{ |
| [1854](#L1854) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'User name is required.', 'eventprime-event-calendar-management' ) ) ); |
| [1855](#L1855) | } |
| [1856](#L1856) | } else{ |
| [1857](#L1857) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [1858](#L1858) | } |
| [1859](#L1859) | } |
| [1860](#L1860) |  |
| [1861](#L1861) | /\*\* |
| [1862](#L1862) | \* Check if email already exist |
| [1863](#L1863) | \*/ |
| [1864](#L1864) | public function rg\_check\_email() { |
| [1865](#L1865) | if( wp\_verify\_nonce( $\_POST['security'], 'event-registration-form-nonce' ) ) { |
| [1866](#L1866) | if( ! empty( $\_POST['email'] ) ) { |
| [1867](#L1867) | $email = sanitize\_text\_field( $\_POST['email'] ); |
| [1868](#L1868) | if ( email\_exists( $email ) ) { |
| [1869](#L1869) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Email already exist.', 'eventprime-event-calendar-management' ) ) ); |
| [1870](#L1870) | } else{ |
| [1871](#L1871) | wp\_send\_json\_success(); |
| [1872](#L1872) | } |
| [1873](#L1873) | } else{ |
| [1874](#L1874) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Email is required.', 'eventprime-event-calendar-management' ) ) ); |
| [1875](#L1875) | } |
| [1876](#L1876) | } else{ |
| [1877](#L1877) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [1878](#L1878) | } |
| [1879](#L1879) | } |
| [1880](#L1880) |  |
| [1881](#L1881) | /\*\* |
| [1882](#L1882) | \* Download attendees |
| [1883](#L1883) | \*/ |
| [1884](#L1884) | public function export\_submittion\_attendees(){ |
| [1885](#L1885) | check\_ajax\_referer( 'ep-frontend-nonce', 'security' ); |
| [1886](#L1886) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1887](#L1887) | if( isset( $\_POST['event\_id'] ) && ! empty( $\_POST['event\_id'] ) ) { |
| [1888](#L1888) | $event\_id = $\_POST['event\_id']; |
| [1889](#L1889) | $bookings = array(); |
| [1890](#L1890) | $data = new stdClass(); |
| [1891](#L1891) | $booking\_args = array( |
| [1892](#L1892) | 'numberposts' => -1, |
| [1893](#L1893) | 'post\_status' => 'completed', |
| [1894](#L1894) | 'post\_type'   => 'em\_booking', |
| [1895](#L1895) | 'meta\_key'    => 'em\_event', |
| [1896](#L1896) | 'meta\_value'  => $event\_id |
| [1897](#L1897) | ); |
| [1898](#L1898) | $booking\_posts = get\_posts( $booking\_args ); |
| [1899](#L1899) | $booking\_controller = new EventPrime\_Bookings; |
| [1900](#L1900) | foreach ( $booking\_posts as $post ) { |
| [1901](#L1901) | array\_push( $bookings, $booking\_controller->load\_booking\_detail( $post->ID ) ); |
| [1902](#L1902) | } |
| [1903](#L1903) | //epd($bookings); |
| [1904](#L1904) | $csv = new stdClass(); |
| [1905](#L1905) | foreach ( $bookings as $booking ) { |
| [1906](#L1906) | $user = get\_user\_by( 'id', $booking->em\_user ); |
| [1907](#L1907) | $csv = new stdClass(); |
| [1908](#L1908) | $csv->ID = $booking->em\_id; |
| [1909](#L1909) | $csv->user\_display\_name = $user->display\_name; |
| [1910](#L1910) | $csv->user\_email = $user->user\_email; |
| [1911](#L1911) | $other\_order\_info = $booking->em\_order\_info; |
| [1912](#L1912) | $ticket\_sub\_total = 0; |
| [1913](#L1913) | $ticket\_qty = 0; |
| [1914](#L1914) | foreach( $other\_order\_info['tickets'] as $ticket ){ |
| [1915](#L1915) | $ticket\_sub\_total = $ticket\_sub\_total + $ticket->subtotal; |
| [1916](#L1916) | $ticket\_qty = $ticket\_qty + $ticket->qty; |
| [1917](#L1917) | } |
| [1918](#L1918) | $csv->price =  $ticket\_sub\_total + $other\_order\_info['event\_fixed\_price']; |
| [1919](#L1919) | $csv->no\_tickets =  $ticket\_qty; |
| [1920](#L1920) | $csv->amount\_total =  $other\_order\_info['booking\_total']; |
| [1921](#L1921) | $event = $ep\_functions->get\_single\_event( $booking->em\_event ); |
| [1922](#L1922) | if( ! empty( $event->id ) ){ |
| [1923](#L1923) | $csv->event\_name = $event->name; |
| [1924](#L1924) | } |
| [1925](#L1925) | else{ |
| [1926](#L1926) | $csv->event\_name = \_\_( 'Event deleted', 'eventprime-event-calendar-management' ); |
| [1927](#L1927) | } |
| [1928](#L1928) | $csv->event\_type\_name = ''; |
| [1929](#L1929) | if( ! empty( $event->em\_event\_type ) ){ |
| [1930](#L1930) | $event\_type = $ep\_functions->get\_single\_event\_type( $event->em\_event\_type ); |
| [1931](#L1931) | if( ! empty( $event\_type ) ){ |
| [1932](#L1932) | $csv->event\_type\_name = $event\_type->name; |
| [1933](#L1933) | } |
| [1934](#L1934) | } |
| [1935](#L1935) | $csv->venue = ''; |
| [1936](#L1936) | $csv->seating\_type = ''; |
| [1937](#L1937) | if( ! empty( $event->em\_venue ) ){ |
| [1938](#L1938) | $event\_venue = $ep\_functions->get\_single\_venue( $event->em\_venue ); |
| [1939](#L1939) | if( ! empty( $event\_venue ) ){ |
| [1940](#L1940) | $csv->venue = $event\_venue->name; |
| [1941](#L1941) | $csv->seating\_type = $event\_venue->em\_type; |
| [1942](#L1942) | } |
| [1943](#L1943) | } |
| [1944](#L1944) | $i = 1; |
| [1945](#L1945) | $attendee\_name\_data = ''; |
| [1946](#L1946) | foreach( $booking->em\_attendee\_names as $ticket\_id => $attendee\_data ) { |
| [1947](#L1947) | $booking\_attendees\_field\_labels = $ep\_functions->ep\_get\_booking\_attendee\_field\_labels( $attendee\_data[1] ); |
| [1948](#L1948) | foreach( $attendee\_data as $booking\_attendees ) { |
| [1949](#L1949) | $attendee\_name\_data .= esc\_html\_\_( 'Attendees '.$i.' ', 'eventprime-event-calendar-management' ); |
| [1950](#L1950) | $booking\_attendees\_val = array\_values( $booking\_attendees ); |
| [1951](#L1951) | foreach( $booking\_attendees\_field\_labels as $labels ){ |
| [1952](#L1952) | $formated\_val = str\_replace( ' ', '\_', strtolower( $labels ) ); |
| [1953](#L1953) | $at\_val = '---'; |
| [1954](#L1954) | foreach( $booking\_attendees\_val as $baval ) { |
| [1955](#L1955) | if( isset( $baval[$formated\_val] ) && ! empty( $baval[$formated\_val] ) ) { |
| [1956](#L1956) | $at\_val = $baval[$formated\_val]; |
| [1957](#L1957) | break; |
| [1958](#L1958) | } |
| [1959](#L1959) | } |
| [1960](#L1960) | $attendee\_name\_data .= esc\_html\_\_( $labels, 'eventprime-event-calendar-management' ) .' : '. $at\_val.', '; |
| [1961](#L1961) | } |
| [1962](#L1962) |  |
| [1963](#L1963) | $i++; |
| [1964](#L1964) | } |
| [1965](#L1965) | } |
| [1966](#L1966) | $csv->attendee\_name = $attendee\_name\_data; |
| [1967](#L1967) | $csv->seat\_sequences = ''; |
| [1968](#L1968) | // if( isset( $other\_order\_info['seat\_sequences'] ) && ! empty( $other\_order\_info['seat\_sequences'] ) ){ |
| [1969](#L1969) | //     $csv->seat\_sequences = implode( ',', $other\_order\_info['seat\_sequences'] ); |
| [1970](#L1970) | // } |
| [1971](#L1971) | $csv->status= $booking->em\_status; |
| [1972](#L1972) | $data->posts[] = $csv; |
| [1973](#L1973) | } |
| [1974](#L1974) |  |
| [1975](#L1975) | header('Content-Type: text/csv'); |
| [1976](#L1976) | header('Content-Disposition: attachment;filename="attendees.csv"'); |
| [1977](#L1977) | header('Cache-Control: max-age=0'); |
| [1978](#L1978) | $csv\_name = 'em\_Attendees' . time() . mt\_rand(10, 1000000); |
| [1979](#L1979) | $csv\_path = get\_temp\_dir() . $csv\_name . '.csv'; |
| [1980](#L1980) | $csv = fopen('php://output', "w"); |
| [1981](#L1981) | if ( ! $csv ) { |
| [1982](#L1982) | return false; |
| [1983](#L1983) | } |
| [1984](#L1984) | //Add UTF-8 header for proper encoding of the file |
| [1985](#L1985) | fputs($csv, chr(0xEF) . chr(0xBB) . chr(0xBF)); |
| [1986](#L1986) | $csv\_fields = array(); |
| [1987](#L1987) | $csv\_fields[] = \_\_('Booking ID', 'eventprime-event-calendar-management'); |
| [1988](#L1988) | $csv\_fields[] = \_\_('User Name', 'eventprime-event-calendar-management'); |
| [1989](#L1989) | $csv\_fields[] = \_\_('Email', 'eventprime-event-calendar-management'); |
| [1990](#L1990) | $csv\_fields[] = \_\_('Price', 'eventprime-event-calendar-management'); |
| [1991](#L1991) | $csv\_fields[] = \_\_('Ticket Count', 'eventprime-event-calendar-management'); |
| [1992](#L1992) | $csv\_fields[] = \_\_('Total Amount', 'eventprime-event-calendar-management'); |
| [1993](#L1993) | $csv\_fields[] = \_\_('Event Name', 'eventprime-event-calendar-management'); |
| [1994](#L1994) | $csv\_fields[] = \_\_('Event Type', 'eventprime-event-calendar-management'); |
| [1995](#L1995) | $csv\_fields[] = \_\_('Venue', 'eventprime-event-calendar-management'); |
| [1996](#L1996) | $csv\_fields[] = \_\_('Seating Type', 'eventprime-event-calendar-management'); |
| [1997](#L1997) | $csv\_fields[] = \_\_('Attendees', 'eventprime-event-calendar-management'); |
| [1998](#L1998) | $csv\_fields[] = \_\_('Seat No.', 'eventprime-event-calendar-management'); |
| [1999](#L1999) | $csv\_fields[] = \_\_('Status', 'eventprime-event-calendar-management'); |
| [2000](#L2000) | fputcsv( $csv, $csv\_fields ); |
| [2001](#L2001) | foreach ( $data->posts as $a ) { |
| [2002](#L2002) | if ( ! fputcsv( $csv, array\_values((array) $a ) ) ) |
| [2003](#L2003) | return false; |
| [2004](#L2004) | } |
| [2005](#L2005) |  |
| [2006](#L2006) | fclose( $csv ); |
| [2007](#L2007) | wp\_die(); |
| [2008](#L2008) | } |
| [2009](#L2009) | } |
| [2010](#L2010) |  |
| [2011](#L2011) | /\*\* |
| [2012](#L2012) | \* Run migration process for < 3.0.0 installation |
| [2013](#L2013) | \*/ |
| [2014](#L2014) | public function eventprime\_run\_migration() { |
| [2015](#L2015) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-migration-nonce' ) ) { |
| [2016](#L2016) | // check if already migrated |
| [2017](#L2017) | if( empty( get\_option( 'ep\_db\_need\_to\_run\_migration' ) ) ) { |
| [2018](#L2018) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'EventPrime already migrated with the latest version.', 'eventprime-event-calendar-management' ) ) ); |
| [2019](#L2019) | } |
| [2020](#L2020) | // check if user has capability |
| [2021](#L2021) | if( ! current\_user\_can( 'manage\_options' ) ) { |
| [2022](#L2022) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'You are not authorised user for this action. Please contact with your administrator.', 'eventprime-event-calendar-management' ) ) ); |
| [2023](#L2023) | } |
| [2024](#L2024) |  |
| [2025](#L2025) | update\_option( 'ep\_db\_need\_to\_run\_migration', 0 ); |
| [2026](#L2026) |  |
| [2027](#L2027) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Migration Complete!', 'eventprime-event-calendar-management' ) ) ); |
| [2028](#L2028) | } else{ |
| [2029](#L2029) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2030](#L2030) | } |
| [2031](#L2031) | } |
| [2032](#L2032) |  |
| [2033](#L2033) | /\*\* |
| [2034](#L2034) | \* Cancel the migration process |
| [2035](#L2035) | \*/ |
| [2036](#L2036) | public function eventprime\_cancel\_migration() { |
| [2037](#L2037) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-migration-nonce' ) ) { |
| [2038](#L2038) | /\* $ep\_deactivate\_extensions\_on\_migration = get\_option( 'ep\_deactivate\_extensions\_on\_migration '); |
| [2039](#L2039) | if( ! empty( $ep\_deactivate\_extensions\_on\_migration ) ) { |
| [2040](#L2040) | foreach( $ep\_deactivate\_extensions\_on\_migration as $ext\_list ) { |
| [2041](#L2041) | activate\_plugin( $ext\_list ); |
| [2042](#L2042) | } |
| [2043](#L2043) | } |
| [2044](#L2044) | deactivate\_plugins( plugin\_basename( EP\_PLUGIN\_FILE ) ); \*/ |
| [2045](#L2045) |  |
| [2046](#L2046) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Migration Cancelled! Redirecting you to the plugins page.', 'eventprime-event-calendar-management' ) ) ); |
| [2047](#L2047) | } else{ |
| [2048](#L2048) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2049](#L2049) | } |
| [2050](#L2050) | } |
| [2051](#L2051) |  |
| [2052](#L2052) | /\*\* |
| [2053](#L2053) | \* Reload user sectionon the checkout page |
| [2054](#L2054) | \*/ |
| [2055](#L2055) | public function reload\_checkout\_user\_section() { |
| [2056](#L2056) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2057](#L2057) | if( ! empty( $\_POST['userId'] ) ) { |
| [2058](#L2058) | $user\_id = $\_POST['userId']; |
| [2059](#L2059) | $user\_data = get\_user\_by( 'id', $user\_id ); |
| [2060](#L2060) | if( ! empty( $user\_data ) ) { |
| [2061](#L2061) | if( get\_current\_user\_id() == $user\_id ) { |
| [2062](#L2062) | $user\_html = ''; |
| [2063](#L2063) | $user\_html .= '<div class="ep-logged-user ep-py-3 ep-border ep-rounded">'; |
| [2064](#L2064) | $user\_html .= '<div class="ep-box-row">'; |
| [2065](#L2065) | $user\_html .= '<div class="ep-box-col-12 ep-d-flex ep-align-items-center ">'; |
| [2066](#L2066) | $user\_html .= '<div class="ep-d-inline-flex ep-mx-3">'; |
| [2067](#L2067) | $user\_html .= '<img class="ep-rounded-circle" src="'. esc\_url( get\_avatar\_url( $user\_id ) ) .'" style="height: 32px;">'; |
| [2068](#L2068) | $user\_html .= '</div>'; |
| [2069](#L2069) | $user\_html .= '<div class="ep-d-inline-flex">'; |
| [2070](#L2070) | $user\_html .= '<span class="ep-mr-1"> '. esc\_html\_\_( 'Logged in as', 'eventprime-event-calendar-management' ) .'</span>'; |
| [2071](#L2071) | $user\_html .= '<span class="ep-fw-bold">'. esc\_html( $ep\_functions->ep\_get\_current\_user\_profile\_name() ) .'</span>'; |
| [2072](#L2072) | $user\_html .= '</div>'; |
| [2073](#L2073) | $user\_html .= '</div>'; |
| [2074](#L2074) | $user\_html .= '</div>'; |
| [2075](#L2075) | $user\_html .= '</div>'; |
| [2076](#L2076) |  |
| [2077](#L2077) | wp\_send\_json\_success( array( 'user\_html' => $user\_html ) ); |
| [2078](#L2078) | } |
| [2079](#L2079) | } else{ |
| [2080](#L2080) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Wrong information.', 'eventprime-event-calendar-management' ) ) ); |
| [2081](#L2081) | } |
| [2082](#L2082) | } else{ |
| [2083](#L2083) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Wrong information.', 'eventprime-event-calendar-management' ) ) ); |
| [2084](#L2084) | } |
| [2085](#L2085) | } |
| [2086](#L2086) |  |
| [2087](#L2087) | public function eventprime\_reports\_filter(){ |
| [2088](#L2088) | $report\_controller = new EventM\_Report\_Controller\_List; |
| [2089](#L2089) | $filter\_data = $report\_controller->eventprime\_report\_filters(); |
| [2090](#L2090) | wp\_send\_json\_success($filter\_data); |
| [2091](#L2091) | } |
| [2092](#L2092) |  |
| [2093](#L2093) | public function set\_default\_payment\_processor(){ |
| [2094](#L2094) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-default-payment-processor' ) ) { |
| [2095](#L2095) | $global\_settings = new Eventprime\_Global\_Settings; |
| [2096](#L2096) | $global\_settings\_data = $global\_settings->ep\_get\_settings(); |
| [2097](#L2097) | $form\_data = $\_POST; |
| [2098](#L2098) | if( isset( $form\_data ) && isset( $form\_data['ep\_default\_payment\_processor'] ) && ! empty( $form\_data['ep\_default\_payment\_processor'] ) ){ |
| [2099](#L2099) | $global\_settings\_data->default\_payment\_processor = $form\_data['ep\_default\_payment\_processor']; |
| [2100](#L2100) | $global\_settings->ep\_save\_settings( $global\_settings\_data ); |
| [2101](#L2101) | } |
| [2102](#L2102) | wp\_send\_json\_success(); |
| [2103](#L2103) | } else{ |
| [2104](#L2104) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2105](#L2105) | } |
| [2106](#L2106) | } |
| [2107](#L2107) |  |
| [2108](#L2108) | public function booking\_export\_all(){ |
| [2109](#L2109) | $data = $\_POST; |
| [2110](#L2110) | if(!empty($data)){ |
| [2111](#L2111) | if(is\_user\_logged\_in() && (current\_user\_can('edit\_em\_event') || current\_user\_can('edit\_posts'))){ |
| [2112](#L2112) | $booking\_controller = new EventPrime\_Bookings; |
| [2113](#L2113) | echo $booking\_controller->export\_bookings\_all($data); |
| [2114](#L2114) | } |
| [2115](#L2115) | } |
| [2116](#L2116) | die; |
| [2117](#L2117) | } |
| [2118](#L2118) |  |
| [2119](#L2119) | public function calendar\_event\_create(){ |
| [2120](#L2120) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [2121](#L2121) | if(isset($data['\_wpnonce']) && wp\_verify\_nonce(sanitize\_text\_field($data['\_wpnonce']), 'ep\_calendar\_create\_events' ) ){ |
| [2122](#L2122) | if(current\_user\_can('manage\_options') || current\_user\_can('publish\_em\_events')) { |
| [2123](#L2123) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2124](#L2124) | $response = $ep\_functions->ep\_calendar\_events\_create(); |
| [2125](#L2125) | } |
| [2126](#L2126) | else{ |
| [2127](#L2127) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2128](#L2128) | } |
| [2129](#L2129) | } |
| [2130](#L2130) | else |
| [2131](#L2131) | { |
| [2132](#L2132) | $response = array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ); |
| [2133](#L2133) | } |
| [2134](#L2134) | wp\_send\_json\_success($response); |
| [2135](#L2135) | die(); |
| [2136](#L2136) | } |
| [2137](#L2137) |  |
| [2138](#L2138) | public function calendar\_events\_drag\_event\_date(){ |
| [2139](#L2139) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2140](#L2140) | if( isset( $\_POST['id'] ) && ! empty( $\_POST['id'] ) ) { |
| [2141](#L2141) | if( !empty( get\_post( $\_POST['id'] ) ) && get\_post\_type( $\_POST['id'] ) == 'em\_event' ){ |
| [2142](#L2142) |  |
| [2143](#L2143) | if ( current\_user\_can( 'edit\_em\_event', $\_POST['id'] ) && current\_user\_can('manage\_options') ) { |
| [2144](#L2144) | $response = $ep\_functions->ep\_calendar\_events\_drag\_event\_date($\_POST); |
| [2145](#L2145) | } else { |
| [2146](#L2146) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2147](#L2147) | } |
| [2148](#L2148) | } else { |
| [2149](#L2149) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2150](#L2150) | } |
| [2151](#L2151) | } else { |
| [2152](#L2152) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2153](#L2153) | } |
| [2154](#L2154) | wp\_send\_json\_success($response); |
| [2155](#L2155) |  |
| [2156](#L2156) | } |
| [2157](#L2157) | public function calendar\_events\_delete(){ |
| [2158](#L2158) | if( !wp\_verify\_nonce( '\_wpnonce', 'ep-admin-calendar-action' ) ) { |
| [2159](#L2159) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2160](#L2160) | } |
| [2161](#L2161) | if(current\_user\_can('manage\_options') && isset( $\_POST['event\_id'] ) && ! empty( $\_POST['event\_id'] ) ) { |
| [2162](#L2162) | $event\_id = abs( sanitize\_text\_field( $\_POST['event\_id'] ) ); |
| [2163](#L2163) | $current\_user = wp\_get\_current\_user(); |
| [2164](#L2164) | if(!empty($event\_id)){ |
| [2165](#L2165) | if(!empty(get\_post($event\_id)) && get\_post\_type($event\_id) == 'em\_event' && ( user\_can( $current\_user->ID, 'edit\_em\_event', $event\_id ) && current\_user\_can('manage\_options') )){ |
| [2166](#L2166) | wp\_delete\_post( $event\_id ); |
| [2167](#L2167) | $response = array( 'post\_id' => $event\_id, 'status' => true ); |
| [2168](#L2168) | }else{ |
| [2169](#L2169) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2170](#L2170) |  |
| [2171](#L2171) | } |
| [2172](#L2172) | } |
| [2173](#L2173) |  |
| [2174](#L2174) | } else{ |
| [2175](#L2175) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2176](#L2176) | } |
| [2177](#L2177) | wp\_send\_json\_success($response); |
| [2178](#L2178) | } |
| [2179](#L2179) |  |
| [2180](#L2180) | public function eventprime\_activate\_license() |
| [2181](#L2181) | { |
| [2182](#L2182) | $retrieved\_nonce = filter\_input( INPUT\_POST, 'nonce' ); |
| [2183](#L2183) |  |
| [2184](#L2184) | if ( !wp\_verify\_nonce( $retrieved\_nonce, 'ep-license-nonce' ) ) { |
| [2185](#L2185) | die( esc\_html\_\_( 'Failed security check', 'eventprime-event-calendar-management' ) ); |
| [2186](#L2186) | } |
| [2187](#L2187) | $ep\_license\_activate = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_license\_activate' )); |
| [2188](#L2188) | $license\_key = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_license' )); |
| [2189](#L2189) | $item\_id = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_item\_id' )); |
| [2190](#L2190) | $item\_key = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_item\_key' )); |
| [2191](#L2191) | update\_option( $item\_key.'\_license\_key', $license\_key ); |
| [2192](#L2192) | update\_option( $item\_key.'\_license\_id', $item\_id ); |
| [2193](#L2193) |  |
| [2194](#L2194) |  |
| [2195](#L2195) | $response = array(); |
| [2196](#L2196) | if( isset( $ep\_license\_activate ) && ! empty( $ep\_license\_activate ) ){ |
| [2197](#L2197) | $license = new EventPrime\_License(); |
| [2198](#L2198) | $response = $license->ep\_activate\_license($license\_key,$item\_id,$item\_key); |
| [2199](#L2199) | wp\_send\_json\_success( $response ); |
| [2200](#L2200) | } |
| [2201](#L2201) | else |
| [2202](#L2202) | { |
| [2203](#L2203) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2204](#L2204) | } |
| [2205](#L2205) |  |
| [2206](#L2206) | } |
| [2207](#L2207) |  |
| [2208](#L2208) | public function eventprime\_deactivate\_license(){ |
| [2209](#L2209) |  |
| [2210](#L2210) | $retrieved\_nonce = filter\_input( INPUT\_POST, 'nonce' ); |
| [2211](#L2211) | if ( !wp\_verify\_nonce( $retrieved\_nonce, 'ep-license-nonce' ) ) { |
| [2212](#L2212) | die( esc\_html\_\_( 'Failed security check', 'eventprime-event-calendar-management' ) ); |
| [2213](#L2213) | } |
| [2214](#L2214) | $ep\_license\_deactivate = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_license\_deactivate' )); |
| [2215](#L2215) | $license\_key = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_license' )); |
| [2216](#L2216) | $item\_id = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_item\_id' )); |
| [2217](#L2217) | $item\_key = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_item\_key' )); |
| [2218](#L2218) | update\_option( $item\_key.'\_license\_key', $license\_key ); |
| [2219](#L2219) | update\_option( $item\_key.'\_license\_id', $item\_id ); |
| [2220](#L2220) | $response = array(); |
| [2221](#L2221) | if( isset( $ep\_license\_deactivate ) && ! empty( $ep\_license\_deactivate ) ){ |
| [2222](#L2222) | $license = new EventPrime\_License(); |
| [2223](#L2223) | $response = $license->ep\_deactivate\_license($license\_key,$item\_id,$item\_key); |
| [2224](#L2224) | wp\_send\_json\_success( $response ); |
| [2225](#L2225) | } |
| [2226](#L2226) | else |
| [2227](#L2227) | { |
| [2228](#L2228) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2229](#L2229) | } |
| [2230](#L2230) |  |
| [2231](#L2231) | } |
| [2232](#L2232) |  |
| [2233](#L2233) | /\*\* |
| [2234](#L2234) | \* Update booking action |
| [2235](#L2235) | \*/ |
| [2236](#L2236) | public function update\_event\_booking\_action() { |
| [2237](#L2237) | $sanitizer = new EventPrime\_sanitizer; |
| [2238](#L2238) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [2239](#L2239) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2240](#L2240) | if( wp\_verify\_nonce( $data['ep\_update\_event\_booking\_nonce'], 'ep\_update\_event\_booking' ) ) { |
| [2241](#L2241) | $ep\_event\_booking\_id = ( ! empty( $data['ep\_event\_booking\_id'] ) ? $data['ep\_event\_booking\_id'] : '' ); |
| [2242](#L2242) | if( ! empty( $ep\_event\_booking\_id ) ) { |
| [2243](#L2243) | $booking\_controller = new EventPrime\_Bookings; |
| [2244](#L2244) | $single\_booking = $booking\_controller->load\_booking\_detail( $ep\_event\_booking\_id ); |
| [2245](#L2245) | if( ! empty( $single\_booking ) ) { |
| [2246](#L2246) | if( ! empty( $data['ep\_booking\_attendee\_fields'] ) ) { |
| [2247](#L2247) | $ep\_booking\_attendde\_field = $sanitizer->sanitize($data['ep\_booking\_attendee\_fields']); |
| [2248](#L2248) | update\_post\_meta( $ep\_event\_booking\_id, 'em\_attendee\_names', $ep\_booking\_attendde\_field ); |
| [2249](#L2249) | } |
| [2250](#L2250) | } |
| [2251](#L2251) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Booking Updated Successfully.', 'eventprime-event-calendar-management' ), 'redirect\_url' => esc\_url( $ep\_functions->ep\_get\_custom\_page\_url( 'profile\_page' ) ) ) ); |
| [2252](#L2252) | } else{ |
| [2253](#L2253) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Booking id can\'t be null. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2254](#L2254) | } |
| [2255](#L2255) | } else{ |
| [2256](#L2256) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2257](#L2257) | } |
| [2258](#L2258) | } |
| [2259](#L2259) |  |
| [2260](#L2260) | // Print all attendees of an event |
| [2261](#L2261) | public function event\_print\_all\_attendees() { |
| [2262](#L2262) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2263](#L2263) | if( wp\_verify\_nonce( $\_POST['security'], 'ep\_print\_event\_attendees' ) ) { |
| [2264](#L2264) | $event\_id = ( ! empty( $\_POST['event\_id'] ) ? absint( $\_POST['event\_id'] ) : '' ); |
| [2265](#L2265) | if( ! empty( $event\_id ) ) { |
| [2266](#L2266) | $em\_event\_checkout\_attendee\_fields = get\_post\_meta( $event\_id, 'em\_event\_checkout\_attendee\_fields', true ); |
| [2267](#L2267) | $attendee\_fileds\_data = ( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_fields\_data'] ) ? $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_fields\_data'] : array() ); |
| [2268](#L2268) | $bookings\_data = array(); |
| [2269](#L2269) | $bookings\_data[0]['id']   = esc\_html\_\_( 'Booking ID', 'eventprime-event-calendar-management' ); |
| [2270](#L2270) | $bookings\_data[0]['event'] = esc\_html\_\_( 'Event', 'eventprime-event-calendar-management' ); |
| [2271](#L2271) | if( empty( $attendee\_fileds\_data ) ) { |
| [2272](#L2272) | $bookings\_data[0]['first\_name'] = esc\_html\_\_( 'First Name', 'eventprime-event-calendar-management' ); |
| [2273](#L2273) | $bookings\_data[0]['last\_name']  = esc\_html\_\_( 'Last Name', 'eventprime-event-calendar-management' ); |
| [2274](#L2274) | } else{ |
| [2275](#L2275) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name'] ) ) { |
| [2276](#L2276) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_first\_name'] ) ) { |
| [2277](#L2277) | $bookings\_data[0]['first\_name'] = esc\_html\_\_( 'First Name', 'eventprime-event-calendar-management' ); |
| [2278](#L2278) | } |
| [2279](#L2279) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_middle\_name'] ) ) { |
| [2280](#L2280) | $bookings\_data[0]['middle\_name'] = esc\_html\_\_( 'Middle Name', 'eventprime-event-calendar-management' ); |
| [2281](#L2281) | } |
| [2282](#L2282) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_last\_name'] ) ) { |
| [2283](#L2283) | $bookings\_data[0]['last\_name'] = esc\_html\_\_( 'Last Name', 'eventprime-event-calendar-management' ); |
| [2284](#L2284) | } |
| [2285](#L2285) | } |
| [2286](#L2286) | foreach( $attendee\_fileds\_data as $fields ) { |
| [2287](#L2287) | $label = $ep\_functions->get\_checkout\_field\_label\_by\_id( $fields ); |
| [2288](#L2288) | $bookings\_data[0][$label->label] = esc\_html( $label->label ); |
| [2289](#L2289) | } |
| [2290](#L2290) | } |
| [2291](#L2291) | $bookings\_data[0]['user\_email']  = esc\_html\_\_( 'Email', 'eventprime-event-calendar-management' ); |
| [2292](#L2292) | $bookings\_data[0]['ticket\_name'] = esc\_html\_\_( 'Ticket', 'eventprime-event-calendar-management' ); |
| [2293](#L2293) | $bookings\_data[0]['booked\_on']   = esc\_html\_\_( 'Booked On', 'eventprime-event-calendar-management' ); |
| [2294](#L2294) |  |
| [2295](#L2295) | $booking\_controller = new EventPrime\_Bookings; |
| [2296](#L2296) | $event\_bookings = $booking\_controller->get\_event\_bookings\_by\_event\_id( $event\_id ); |
| [2297](#L2297) | if( ! empty( $event\_bookings ) ) { |
| [2298](#L2298) | $row = 1; |
| [2299](#L2299) | foreach( $event\_bookings as $booking ) { |
| [2300](#L2300) | $booking\_id = $booking->ID; |
| [2301](#L2301) | $em\_attendee\_names = get\_post\_meta( $booking\_id, 'em\_attendee\_names', true ); |
| [2302](#L2302) | if( ! empty( $em\_attendee\_names ) ) { |
| [2303](#L2303) | $ticket\_name = ''; |
| [2304](#L2304) | foreach( $em\_attendee\_names as $ticket\_id => $ticket\_attendees ) { |
| [2305](#L2305) | $ticket\_name = $ep\_functions->get\_ticket\_name\_by\_id( $ticket\_id ); |
| [2306](#L2306) | if( ! empty( $ticket\_attendees ) && count( $ticket\_attendees ) > 0 ) { |
| [2307](#L2307) | foreach( $ticket\_attendees as $attendee\_data ) { |
| [2308](#L2308) | //$bookings\_data[$row]['id'] = $bookings\_data[$row]['event'] = $bookings\_data[$row]['user\_email'] = $bookings\_data[$row]['booked\_on'] = ''; |
| [2309](#L2309) | $bookings\_data[$row]['id'] = $booking\_id; |
| [2310](#L2310) | $bookings\_data[$row]['event'] = get\_the\_title( $event\_id ); |
| [2311](#L2311) | if( empty( $attendee\_fileds\_data ) ) { |
| [2312](#L2312) | $bookings\_data[$row]['first\_name'] = $attendee\_data['name']['first\_name']; |
| [2313](#L2313) | $bookings\_data[$row]['last\_name']  = $attendee\_data['name']['last\_name']; |
| [2314](#L2314) | } else{ |
| [2315](#L2315) | if( isset( $attendee\_data['name'] ) ) { |
| [2316](#L2316) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_first\_name'] ) ) { |
| [2317](#L2317) | $bookings\_data[$row]['first\_name']  = $attendee\_data['name']['first\_name']; |
| [2318](#L2318) | } |
| [2319](#L2319) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_middle\_name'] ) ) { |
| [2320](#L2320) | $bookings\_data[$row]['middle\_name'] = $attendee\_data['name']['middle\_name']; |
| [2321](#L2321) | } |
| [2322](#L2322) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_last\_name'] ) ) { |
| [2323](#L2323) | $bookings\_data[$row]['last\_name']   = $attendee\_data['name']['last\_name']; |
| [2324](#L2324) | } |
| [2325](#L2325) | } |
| [2326](#L2326) | foreach( $attendee\_fileds\_data as $fields ) { |
| [2327](#L2327) | $checkout\_field\_val = ''; |
| [2328](#L2328) | if( ! empty( $attendee\_data[$fields] ) ) { |
| [2329](#L2329) | $label\_val = $attendee\_data[$fields]['label']; |
| [2330](#L2330) | $input\_name = $ep\_functions->ep\_get\_slug\_from\_string( $label\_val ); |
| [2331](#L2331) | if( ! empty( $attendee\_data[$fields][$input\_name] ) ) { |
| [2332](#L2332) | $input\_val = $attendee\_data[$fields][$input\_name]; |
| [2333](#L2333) | if( is\_array( $input\_val ) ) { |
| [2334](#L2334) | $checkout\_field\_val = esc\_html( implode( ', ', $input\_val ) ); |
| [2335](#L2335) | } else{ |
| [2336](#L2336) | $checkout\_field\_val = esc\_html( $attendee\_data[$fields][$input\_name] ); |
| [2337](#L2337) | } |
| [2338](#L2338) | } |
| [2339](#L2339) | } |
| [2340](#L2340) | $bookings\_data[$row][$label\_val] = $checkout\_field\_val; |
| [2341](#L2341) | } |
| [2342](#L2342) | } |
| [2343](#L2343) |  |
| [2344](#L2344) | $user\_id = get\_post\_meta( $booking\_id, 'em\_user', true ); |
| [2345](#L2345) | if( ! empty( $user\_id ) ) { |
| [2346](#L2346) | $user = get\_user\_by( 'id', $user\_id ); |
| [2347](#L2347) | if( ! empty( $user ) ) { |
| [2348](#L2348) | $booking\_user\_email = esc\_html( $user->user\_email ); |
| [2349](#L2349) | } else{ |
| [2350](#L2350) | $booking\_user\_email = '----'; |
| [2351](#L2351) | } |
| [2352](#L2352) | } else{ |
| [2353](#L2353) | $is\_guest\_booking = get\_post\_meta( $booking\_id, 'em\_guest\_booking', true ); |
| [2354](#L2354) | if( ! empty( $is\_guest\_booking ) ) { |
| [2355](#L2355) | $em\_order\_info = get\_post\_meta( $booking\_id, 'em\_order\_info', true ); |
| [2356](#L2356) | if( ! empty( $em\_order\_info ) && ! empty( $em\_order\_info['user\_email'] ) ) { |
| [2357](#L2357) | $booking\_user\_email = esc\_html( $em\_order\_info['user\_email'] ); |
| [2358](#L2358) | } |
| [2359](#L2359) | } |
| [2360](#L2360) | } |
| [2361](#L2361) | $bookings\_data[$row]['user\_email'] = $booking\_user\_email; |
| [2362](#L2362) | $bookings\_data[$row]['ticket\_name'] = $ticket\_name; |
| [2363](#L2363) | $em\_date = get\_post\_meta( $booking\_id, 'em\_date', true ); |
| [2364](#L2364) | if( ! empty( $em\_date ) ) { |
| [2365](#L2365) | $bookings\_data[$row]['booked\_on'] = esc\_html( $ep\_functions->ep\_timestamp\_to\_date( $em\_date, 'd M, Y' ) ); |
| [2366](#L2366) | } |
| [2367](#L2367) | $row++; |
| [2368](#L2368) | } |
| [2369](#L2369) | } |
| [2370](#L2370) | } |
| [2371](#L2371) | } else{ |
| [2372](#L2372) | $tickets\_info = ( ! empty( $booking->em\_order\_info['tickets'] ) ? $booking->em\_order\_info['tickets'] : array() ); |
| [2373](#L2373) | if( ! empty( $tickets\_info ) && count( $tickets\_info ) > 0 ) { |
| [2374](#L2374) | for( $con = 0; $con < count( $tickets\_info ); $con++ ) { |
| [2375](#L2375) | $bookings\_data[$row]['id'] = $booking\_id; |
| [2376](#L2376) | $bookings\_data[$row]['event'] = get\_the\_title( $event\_id ); |
| [2377](#L2377) | $ticket\_id = ( ! empty( $tickets\_info[$con] ) && ! empty( $tickets\_info[$con]->id ) ) ? $tickets\_info[$con]->id : ''; |
| [2378](#L2378) | $ticket\_name = ( ! empty( $ticket\_id ) ? $ep\_functions->get\_ticket\_name\_by\_id( $ticket\_id ) : '----' ); |
| [2379](#L2379) | if( empty( $attendee\_fileds\_data ) ) { |
| [2380](#L2380) | $bookings\_data[$row]['first\_name'] = '----'; |
| [2381](#L2381) | $bookings\_data[$row]['last\_name']  = '----'; |
| [2382](#L2382) | } else{ |
| [2383](#L2383) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name'] ) ) { |
| [2384](#L2384) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_first\_name'] ) ) { |
| [2385](#L2385) | $bookings\_data[$row]['first\_name'] = '----'; |
| [2386](#L2386) | } |
| [2387](#L2387) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_middle\_name'] ) ) { |
| [2388](#L2388) | $bookings\_data[$row]['middle\_name'] = '----'; |
| [2389](#L2389) | } |
| [2390](#L2390) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_last\_name'] ) ) { |
| [2391](#L2391) | $bookings\_data[$row]['last\_name'] = '----'; |
| [2392](#L2392) | } |
| [2393](#L2393) | } |
| [2394](#L2394) | foreach( $attendee\_fileds\_data as $fields ) { |
| [2395](#L2395) | $label = $ep\_functions->get\_checkout\_field\_label\_by\_id( $fields ); |
| [2396](#L2396) | $bookings\_data[$row][$label->label] = '----'; |
| [2397](#L2397) | } |
| [2398](#L2398) | } |
| [2399](#L2399) | $user\_id = get\_post\_meta( $booking\_id, 'em\_user', true ); |
| [2400](#L2400) | if( ! empty( $user\_id ) ) { |
| [2401](#L2401) | $user = get\_user\_by( 'id', $user\_id ); |
| [2402](#L2402) | if( ! empty( $user ) ) { |
| [2403](#L2403) | $booking\_user\_email = esc\_html( $user->user\_email ); |
| [2404](#L2404) | } else{ |
| [2405](#L2405) | $booking\_user\_email = '----'; |
| [2406](#L2406) | } |
| [2407](#L2407) | } else{ |
| [2408](#L2408) | $is\_guest\_booking = get\_post\_meta( $booking\_id, 'em\_guest\_booking', true ); |
| [2409](#L2409) | if( ! empty( $is\_guest\_booking ) ) { |
| [2410](#L2410) | $em\_order\_info = get\_post\_meta( $booking\_id, 'em\_order\_info', true ); |
| [2411](#L2411) | if( ! empty( $em\_order\_info ) && ! empty( $em\_order\_info['user\_email'] ) ) { |
| [2412](#L2412) | $booking\_user\_email = esc\_html( $em\_order\_info['user\_email'] ); |
| [2413](#L2413) | } |
| [2414](#L2414) | } |
| [2415](#L2415) | } |
| [2416](#L2416) | $bookings\_data[$row]['user\_email'] = $booking\_user\_email; |
| [2417](#L2417) | $bookings\_data[$row]['ticket\_name'] = $ticket\_name; |
| [2418](#L2418) | $em\_date = get\_post\_meta( $booking\_id, 'em\_date', true ); |
| [2419](#L2419) | if( ! empty( $em\_date ) ) { |
| [2420](#L2420) | $bookings\_data[$row]['booked\_on'] = esc\_html( $ep\_functions->ep\_timestamp\_to\_date( $em\_date, 'd M, Y' ) ); |
| [2421](#L2421) | } |
| [2422](#L2422) | $row++; |
| [2423](#L2423) | } |
| [2424](#L2424) | } |
| [2425](#L2425) | } |
| [2426](#L2426) | } |
| [2427](#L2427) | } |
| [2428](#L2428) |  |
| [2429](#L2429) | header('Content-Type: text/csv; charset=utf-8'); |
| [2430](#L2430) | header('Content-Disposition: attachment; filename="ep-bookings-'.md5(time().mt\_rand(100, 999)).'.csv"'); |
| [2431](#L2431) | $f = fopen('php://output', 'w'); |
| [2432](#L2432) | foreach ( $bookings\_data as $line ) { |
| [2433](#L2433) | fputcsv( $f, $line ); |
| [2434](#L2434) | } |
| [2435](#L2435) | die; |
| [2436](#L2436) | } else{ |
| [2437](#L2437) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Event id can\'t be null. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2438](#L2438) | } |
| [2439](#L2439) | } else{ |
| [2440](#L2440) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2441](#L2441) | } |
| [2442](#L2442) | } |
| [2443](#L2443) |  |
| [2444](#L2444) | // load attendee fields html for edit booking |
| [2445](#L2445) | public function load\_edit\_booking\_attendee\_data() { |
| [2446](#L2446) | $response = new stdClass(); |
| [2447](#L2447) | if( wp\_verify\_nonce( $\_POST['security'], 'ep\_booking\_attendee\_data' ) ) { |
| [2448](#L2448) | $event\_id = ( ! empty( $\_POST['event\_id'] ) ? absint( $\_POST['event\_id'] ) : '' ); |
| [2449](#L2449) | $booking\_id = ( ! empty( $\_POST['booking\_id'] ) ? absint( $\_POST['booking\_id'] ) : '' ); |
| [2450](#L2450) | $ticket\_id = ( ! empty( $\_POST['ticket\_id'] ) ? absint( $\_POST['ticket\_id'] ) : '' ); |
| [2451](#L2451) | if( ! empty( $event\_id ) && ! empty( $booking\_id ) && ! empty( $ticket\_id )) { |
| [2452](#L2452) | $booking\_controller = new EventPrime\_Bookings; |
| [2453](#L2453) | $booking = $booking\_controller->load\_booking\_detail( $booking\_id ); |
| [2454](#L2454) | if(!empty($booking)){ |
| [2455](#L2455) | echo $booking\_controller->ep\_get\_admin\_edit\_attendees\_html($booking); |
| [2456](#L2456) |  |
| [2457](#L2457) |  |
| [2458](#L2458) | }else{ |
| [2459](#L2459) | esc\_html\_e('No booking found','eventprime-event-calendar-management'); |
| [2460](#L2460) | } |
| [2461](#L2461) |  |
| [2462](#L2462) | } else{ |
| [2463](#L2463) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Some data is missing. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2464](#L2464) | } |
| [2465](#L2465) | } |
| [2466](#L2466) | die(); |
| [2467](#L2467) | } |
| [2468](#L2468) |  |
| [2469](#L2469) |  |
| [2470](#L2470) | // sanitize input field data |
| [2471](#L2471) | public function sanitize\_input\_field\_data() { |
| [2472](#L2472) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-frontend-nonce' ) ) { |
| [2473](#L2473) | if( isset( $\_POST['input\_val'] ) && ! empty( $\_POST['input\_val'] ) ) { |
| [2474](#L2474) | $input\_val = sanitize\_text\_field( $\_POST['input\_val'] ); |
| [2475](#L2475) | wp\_send\_json\_success( $input\_val ); |
| [2476](#L2476) | } else{ |
| [2477](#L2477) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Value is missing.', 'eventprime-event-calendar-management' ) ) ); |
| [2478](#L2478) | } |
| [2479](#L2479) | } else{ |
| [2480](#L2480) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2481](#L2481) | } |
| [2482](#L2482) | } |
| [2483](#L2483) |  |
| [2484](#L2484) | // send feedback |
| [2485](#L2485) | public function send\_plugin\_deactivation\_feedback() { |
| [2486](#L2486) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-plugin-deactivation-nonce' ) ) { |
| [2487](#L2487) | if( isset( $\_POST['feedback'] ) && ! empty( $\_POST['feedback'] ) ) { |
| [2488](#L2488) | $feedback = sanitize\_text\_field( $\_POST['feedback'] ); |
| [2489](#L2489) | $message = sanitize\_text\_field( $\_POST['message'] ); |
| [2490](#L2490) | $email\_message = ''; |
| [2491](#L2491) | if( ! empty( $\_POST['ep\_user\_support\_email'] ) ){ |
| [2492](#L2492) | $ep\_user\_support\_email = sanitize\_email( $\_POST['ep\_user\_support\_email'] ); |
| [2493](#L2493) | $from\_email\_address = '<' . $ep\_user\_support\_email . '>'; |
| [2494](#L2494) | }else{ |
| [2495](#L2495) | $from\_email\_address = '<' . get\_option('admin\_email') . '>'; |
| [2496](#L2496) | } |
| [2497](#L2497) |  |
| [2498](#L2498) | switch( $feedback ) { |
| [2499](#L2499) | case 'feature\_not\_available': $body='Feature not available: '; break; |
| [2500](#L2500) | case 'feature\_not\_working': $body='Feature not working: '; break; |
| [2501](#L2501) | case 'plugin\_difficult-to-use': $body='Plugin is difficult or confusing to use: '; break; |
| [2502](#L2502) | case 'plugin\_broke\_site': $body='Plugin broke my site'; break; |
| [2503](#L2503) | case 'plugin\_has\_design\_issue': $body='Plugin has design issue'; break; |
| [2504](#L2504) | case 'temporary\_deactivation': $body = "It's a temporary deactivation"; break; |
| [2505](#L2505) | case 'plugin\_missing-documentation': $body = "Plugin is missing documentation"; break; |
| [2506](#L2506) | case 'other': $body='Other: '; break; |
| [2507](#L2507) | default: return; |
| [2508](#L2508) | } |
| [2509](#L2509) | if( ! empty( $feedback ) ) { |
| [2510](#L2510) | $email\_message .= $body."\n\r"; |
| [2511](#L2511) | if( ! empty( $message ) ) { |
| [2512](#L2512) | $email\_message .= "<br><u>User Feedback Message</u> - "; |
| [2513](#L2513) | // $email\_message .= $message."\n\r"; |
| [2514](#L2514) | $email\_message .= $message."<br>"; |
| [2515](#L2515) | } |
| [2516](#L2516) | $email\_message .= "\n\r EventPrime Version - ".EVENTPRIME\_VERSION; |
| [2517](#L2517) | $headers = "MIME-Version: 1.0\r\n"; |
| [2518](#L2518) | $headers .= "Content-type:text/html;charset=UTF-8\r\n"; |
| [2519](#L2519) | $headers .= 'From:'.$from\_email\_address."\r\n"; |
| [2520](#L2520) | if ( wp\_mail( 'feedback@theeventprime.com', 'EventPrime Uninstallation Feedback', $email\_message, $headers ) ){ |
| [2521](#L2521) | if( isset( $\_POST['ep\_inform\_email'] ) && ! empty( $\_POST['ep\_inform\_email'] ) ){ |
| [2522](#L2522) | wp\_mail( 'support@theeventprime.com', 'EventPrime Uninstallation Feedback', $email\_message, $headers ); |
| [2523](#L2523) | } |
| [2524](#L2524) | wp\_send\_json\_success(); |
| [2525](#L2525) | }else{ |
| [2526](#L2526) | wp\_send\_json\_error(); |
| [2527](#L2527) | } |
| [2528](#L2528) | } |
| [2529](#L2529) | } else{ |
| [2530](#L2530) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Feedback is missing.', 'eventprime-event-calendar-management' ) ) ); |
| [2531](#L2531) | } |
| [2532](#L2532) | } else{ |
| [2533](#L2533) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2534](#L2534) | } |
| [2535](#L2535) | } |
| [2536](#L2536) |  |
| [2537](#L2537) | // delete fes event from user profile |
| [2538](#L2538) | public function delete\_user\_fes\_event() { |
| [2539](#L2539) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-frontend-nonce' ) ) { |
| [2540](#L2540) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2541](#L2541) | $dbhandler = new EP\_DBhandler; |
| [2542](#L2542) | if( isset( $\_POST['fes\_event\_id'] ) && ! empty( $\_POST['fes\_event\_id'] ) ) { |
| [2543](#L2543) | global $wpdb; |
| [2544](#L2544) | $fes\_event\_id = absint( $\_POST['fes\_event\_id'] ); |
| [2545](#L2545) | $current\_user\_id = get\_current\_user\_id(); |
| [2546](#L2546) | $single\_event = $ep\_functions->get\_single\_event( $fes\_event\_id ); |
| [2547](#L2547) | if( empty( $single\_event ) ) { |
| [2548](#L2548) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Event does not found.', 'eventprime-event-calendar-management' ) ) ); |
| [2549](#L2549) | } |
| [2550](#L2550) | if( empty( $single\_event->em\_frontend\_submission ) ) { |
| [2551](#L2551) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Event can\'t be deleted.', 'eventprime-event-calendar-management' ) ) ); |
| [2552](#L2552) | } |
| [2553](#L2553) | // check if the logged user is same |
| [2554](#L2554) | $event\_user = $single\_event->em\_user; |
| [2555](#L2555) | if( $event\_user != $current\_user\_id ) { |
| [2556](#L2556) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'You are not authorised to delete this event.', 'eventprime-event-calendar-management' ) ) ); |
| [2557](#L2557) | } |
| [2558](#L2558) | // start event deletion |
| [2559](#L2559) | // first check for recurring events |
| [2560](#L2560) | $booking\_controllers = new EventPrime\_Bookings; |
| [2561](#L2561) | $metaboxes\_controllers = new EP\_DBhandler; |
| [2562](#L2562) | $metaboxes\_controllers->ep\_delete\_child\_events( $fes\_event\_id ); |
| [2563](#L2563) | // check category and tickets and delete them |
| [2564](#L2564) | $cat\_table\_name = 'TICKET\_CATEGORIES'; |
| [2565](#L2565) | $price\_options\_table = 'TICKET'; |
| [2566](#L2566) | // delete all ticket categories |
| [2567](#L2567) | if( ! empty( $single\_event->ticket\_categories ) ) { |
| [2568](#L2568) | foreach( $single\_event->ticket\_categories as $category ) { |
| [2569](#L2569) | if( ! empty( $category->id ) ) { |
| [2570](#L2570) | $dbhandler->remove\_row($cat\_table\_name,'id', $category->id); |
| [2571](#L2571) | } |
| [2572](#L2572) | } |
| [2573](#L2573) | } |
| [2574](#L2574) | // delete all tickets |
| [2575](#L2575) | if( ! empty( $single\_event->all\_tickets\_data ) ) { |
| [2576](#L2576) | foreach( $single\_event->all\_tickets\_data as $ticket ) { |
| [2577](#L2577) | if( ! empty( $ticket->id ) ) { |
| [2578](#L2578) | $dbhandler->remove\_row($price\_options\_table,'id', $ticket->id); |
| [2579](#L2579) | } |
| [2580](#L2580) | } |
| [2581](#L2581) | } |
| [2582](#L2582) | // delete booking of this event |
| [2583](#L2583) | $event\_bookings = $booking\_controllers->get\_event\_bookings\_by\_event\_id( $fes\_event\_id ); |
| [2584](#L2584) | if( ! empty( $event\_bookings ) ) { |
| [2585](#L2585) | foreach( $event\_bookings as $booking ) { |
| [2586](#L2586) | // delete booking |
| [2587](#L2587) | wp\_delete\_post( $booking->ID, true ); |
| [2588](#L2588) | } |
| [2589](#L2589) | } |
| [2590](#L2590) | // delete terms relationships |
| [2591](#L2591) | wp\_delete\_object\_term\_relationships( $fes\_event\_id, array( 'em\_venue', 'em\_event\_type', 'em\_event\_organizer' ) ); |
| [2592](#L2592) |  |
| [2593](#L2593) | // delete ext data |
| [2594](#L2594) | do\_action( 'ep\_delete\_event\_data', $fes\_event\_id ); |
| [2595](#L2595) |  |
| [2596](#L2596) | wp\_delete\_post( $fes\_event\_id, true ); |
| [2597](#L2597) |  |
| [2598](#L2598) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Event Deleted Successfully', 'eventprime-event-calendar-management' ) ) ); |
| [2599](#L2599) | } else{ |
| [2600](#L2600) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Event Id Is Missing.', 'eventprime-event-calendar-management' ) ) ); |
| [2601](#L2601) | } |
| [2602](#L2602) | } else{ |
| [2603](#L2603) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2604](#L2604) | } |
| [2605](#L2605) | } |
| [2606](#L2606) |  |
| [2607](#L2607) | public function edit\_booking\_attendee\_data\_save(){ |
| [2608](#L2608) | $sanitizer = new EventPrime\_sanitizer; |
| [2609](#L2609) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [2610](#L2610) |  |
| [2611](#L2611) | if( wp\_verify\_nonce( $\_POST['security'], 'ep\_booking\_attendee\_data' ) ) { |
| [2612](#L2612) | $attendees\_names = isset($data['ep\_booking\_attendee\_fields']) ? $sanitizer->sanitize($data['ep\_booking\_attendee\_fields']) : array(); |
| [2613](#L2613) | if(is\_array($attendees\_names)){ |
| [2614](#L2614) | update\_post\_meta( $\_POST['booking\_id'], 'em\_attendee\_names', $attendees\_names ); |
| [2615](#L2615) | } |
| [2616](#L2616) |  |
| [2617](#L2617) | } |
| [2618](#L2618) | die(); |
| [2619](#L2619) | } |
| [2620](#L2620) |  |
| [2621](#L2621) | public function get\_calendar\_event() |
| [2622](#L2622) | { |
| [2623](#L2623) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2624](#L2624) | // Create a DateTime object from the string |
| [2625](#L2625) | $startdate = new DateTime($\_POST['start']); |
| [2626](#L2626) | $format = $ep\_functions->ep\_get\_datepicker\_format(); |
| [2627](#L2627) | $formattedstartDate = $startdate->format($format); |
| [2628](#L2628) |  |
| [2629](#L2629) | $enddate = new DateTime($\_POST['end']); |
| [2630](#L2630) | $formattedendDate = $enddate->format($format); |
| [2631](#L2631) |  |
| [2632](#L2632) | $start = $formattedstartDate; |
| [2633](#L2633) | $end = $formattedendDate; |
| [2634](#L2634) |  |
| [2635](#L2635) | $is\_admin = (isset($\_POST['is\_dashboard']))?true:false; |
| [2636](#L2636) |  |
| [2637](#L2637) | $dateInfo = array( |
| [2638](#L2638) | array( |
| [2639](#L2639) | 'label' => 'From', |
| [2640](#L2640) | 'key' => 'date\_from', |
| [2641](#L2641) | 'value' => $start, |
| [2642](#L2642) | 'text' => $start |
| [2643](#L2643) | ), |
| [2644](#L2644) | array( |
| [2645](#L2645) | 'label' => 'To', |
| [2646](#L2646) | 'key' => 'date\_to', |
| [2647](#L2647) | 'value' => $end, |
| [2648](#L2648) | 'text' => $end |
| [2649](#L2649) | ), |
| [2650](#L2650) | array( |
| [2651](#L2651) | 'label' => 'Days', |
| [2652](#L2652) | 'key' => 'days', |
| [2653](#L2653) | 'value' => 'all', |
| [2654](#L2654) | 'text' => 'All Days' |
| [2655](#L2655) | ) |
| [2656](#L2656) | ); |
| [2657](#L2657) |  |
| [2658](#L2658) |  |
| [2659](#L2659) | $params = array |
| [2660](#L2660) | ( |
| [2661](#L2661) | 'meta\_key' => 'em\_start\_date\_time', |
| [2662](#L2662) | 'orderby' => 'meta\_value\_num', |
| [2663](#L2663) | 'posts\_per\_page' => -1, |
| [2664](#L2664) | 'offset' => 0, |
| [2665](#L2665) | 'paged' => 1, |
| [2666](#L2666) | 'meta\_query' => array |
| [2667](#L2667) | ( |
| [2668](#L2668) | 'relation' => 'AND' |
| [2669](#L2669) | ), |
| [2670](#L2670) |  |
| [2671](#L2671) | 'order' => 'ASC' |
| [2672](#L2672) | ); |
| [2673](#L2673) |  |
| [2674](#L2674) | $params = $ep\_functions->create\_filter\_query($dateInfo,$params); |
| [2675](#L2675) |  |
| [2676](#L2676) | $event\_search\_params = array(); |
| [2677](#L2677) | if( isset( $\_POST['search\_param'] ) && ! empty( $\_POST['search\_param'] ) ) { |
| [2678](#L2678) | $event\_search\_params = json\_decode( stripslashes( $\_POST['search\_param'] ), true ); |
| [2679](#L2679) | if( ! empty( $event\_search\_params ) && count( $event\_search\_params ) > 0 ) { |
| [2680](#L2680) | $params = $ep\_functions->create\_filter\_query($event\_search\_params, $params); |
| [2681](#L2681) | } |
| [2682](#L2682) | } |
| [2683](#L2683) |  |
| [2684](#L2684) |  |
| [2685](#L2685) | // if(isset($\_POST['args'])) |
| [2686](#L2686) | // { |
| [2687](#L2687) | $atts = isset($\_POST['args']) ? json\_decode( stripslashes( $\_POST['args'] ), true ) : array(); //$\_POST['args']; |
| [2688](#L2688) |  |
| [2689](#L2689) | // shortcode limit |
| [2690](#L2690) | if( isset( $atts['show'] ) && ! empty( $atts['show'] ) ){ |
| [2691](#L2691) | $events\_data['limit'] = $atts['show']; |
| [2692](#L2692) | $params = array( |
| [2693](#L2693) | 'meta\_key'       => 'em\_start\_date\_time', |
| [2694](#L2694) | 'orderby'        => 'meta\_value\_num', |
| [2695](#L2695) | 'posts\_per\_page' => $events\_data['limit'], |
| [2696](#L2696) | 'meta\_query'     => array( 'relation' => 'AND' ), |
| [2697](#L2697) | //'order'          => 'DESC' |
| [2698](#L2698) | ); |
| [2699](#L2699) | } |
| [2700](#L2700) |  |
| [2701](#L2701) | // condition for hide upcoming events |
| [2702](#L2702) | $hide\_upcoming\_events = 0; |
| [2703](#L2703) | if( $ep\_functions->ep\_get\_global\_settings('shortcode\_hide\_upcoming\_events') == 1 ) { |
| [2704](#L2704) | $hide\_upcoming\_events = 1; |
| [2705](#L2705) | } |
| [2706](#L2706) | if( isset( $atts['upcoming'] ) && $atts['upcoming'] == 0 ) { |
| [2707](#L2707) | $hide\_upcoming\_events = 1; |
| [2708](#L2708) | } |
| [2709](#L2709) | if( $hide\_upcoming\_events == 1 ) { |
| [2710](#L2710) | array\_push( $params['meta\_query'], array( |
| [2711](#L2711) | 'key'     => 'em\_start\_date', |
| [2712](#L2712) | 'value'   => $ep\_functions->ep\_get\_current\_timestamp(), |
| [2713](#L2713) | 'compare' => '<=' |
| [2714](#L2714) | ) ); |
| [2715](#L2715) | } |
| [2716](#L2716) |  |
| [2717](#L2717) | // condition for hide past events |
| [2718](#L2718) | $hide\_past\_events = 0; |
| [2719](#L2719) | // from settings |
| [2720](#L2720) | if( $ep\_functions->ep\_get\_global\_settings( 'hide\_past\_events' ) == 1 ) { |
| [2721](#L2721) | $hide\_past\_events = 1; |
| [2722](#L2722) | } |
| [2723](#L2723) | // from shortcode |
| [2724](#L2724) | if( isset( $atts['upcoming'] ) && $atts['upcoming'] == 1 ) { |
| [2725](#L2725) | $hide\_past\_events = 1; |
| [2726](#L2726) | } |
| [2727](#L2727) | if( $hide\_past\_events == 1 ) { |
| [2728](#L2728) | array\_push( $params['meta\_query'], array( |
| [2729](#L2729) | 'key'     => 'em\_end\_date', |
| [2730](#L2730) | 'value'   => strtotime( 'today' ), |
| [2731](#L2731) | 'compare' => '>=' |
| [2732](#L2732) | ) ); |
| [2733](#L2733) | } |
| [2734](#L2734) |  |
| [2735](#L2735) | // shortcode event types |
| [2736](#L2736) | $type\_ids = array(); |
| [2737](#L2737) | if( isset( $atts['types'] ) && ! empty( $atts['types'] ) ) { |
| [2738](#L2738) | $type\_ids = explode( ',', $atts['types'] ); |
| [2739](#L2739) | } |
| [2740](#L2740) | if ( ! empty( $type\_ids ) ) { |
| [2741](#L2741) | array\_push( $params['meta\_query'], array( |
| [2742](#L2742) | 'key'     => 'em\_event\_type', |
| [2743](#L2743) | 'value'   => $type\_ids, |
| [2744](#L2744) | 'compare' => 'IN', |
| [2745](#L2745) | 'type'    =>'NUMERIC' |
| [2746](#L2746) | ) ); |
| [2747](#L2747) | } |
| [2748](#L2748) | // shortcode event venues |
| [2749](#L2749) | $venue\_ids = array(); |
| [2750](#L2750) | if( isset( $atts['sites'] ) && ! empty( $atts['sites'] ) ) { |
| [2751](#L2751) | $venue\_ids = explode( ',', $atts['sites'] ); |
| [2752](#L2752) | } |
| [2753](#L2753) | if ( ! empty( $venue\_ids ) ) { |
| [2754](#L2754) | $filter\_venues\_ids = array('relation'     => 'OR'); |
| [2755](#L2755) | foreach ($venue\_ids as $venue\_id){ |
| [2756](#L2756) | $filter\_venues\_ids[]= array( |
| [2757](#L2757) | 'key'     => 'em\_venue', |
| [2758](#L2758) | 'value'   =>  serialize( array($venue\_id) ), |
| [2759](#L2759) | 'compare' => '=' |
| [2760](#L2760) | ); |
| [2761](#L2761) | } |
| [2762](#L2762) | $params['meta\_query'][] = $filter\_venues\_ids; |
| [2763](#L2763) | } |
| [2764](#L2764) |  |
| [2765](#L2765) | $params = apply\_filters( 'ep\_events\_render\_attribute\_data', $params, $atts ); |
| [2766](#L2766) | // } |
| [2767](#L2767) |  |
| [2768](#L2768) | $events = $ep\_functions->get\_multiple\_events\_post\_data($params); |
| [2769](#L2769) |  |
| [2770](#L2770) | if(isset($events->posts)) |
| [2771](#L2771) | { |
| [2772](#L2772) | wp\_send\_json\_success($ep\_functions->get\_front\_calendar\_view\_event( $events->posts,$is\_admin )); |
| [2773](#L2773) | } |
| [2774](#L2774) | die; |
| [2775](#L2775) | } |
| [2776](#L2776) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php?format=txt)
* [Original Format](/export/3222464/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_d2350800_20250114_200733.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Feventprime-event-calendar-management%2Ftags%2F4.0.5.3%2Fincludes%2Fclass-eventprime-sanitizer.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-eventprime-sanitizer.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-eventprime-sanitizer.php)

---

# [source:](/browser?order=name "Go to repository root") [eventprime-event-calendar-management](/browser/eventprime-event-calendar-management?order=name "View eventprime-event-calendar-management")/[tags](/browser/eventprime-event-calendar-management/tags?order=name "View tags")/[4.0.5.3](/browser/eventprime-event-calendar-management/tags/4.0.5.3?order=name "View 4.0.5.3")/[includes](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes?order=name "View includes")/[class-eventprime-sanitizer.php](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-eventprime-sanitizer.php?order=name "View class-eventprime-sanitizer.php")

View diff against:

View revision:

| [Last change](/changeset/3199413/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-eventprime-sanitizer.php "View differences") on this file was [3199413](/changeset/3199413/ "View changeset 3199413"), checked in by metagauss, [7 weeks ago](/timeline?from=2024-11-29T11%3A51%3A04Z&precision=second "See timeline at 11/29/2024 11:51:04 AM") |
| --- |
| Tag 4.0.5.3 |
| **File size:** 8.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | class EventPrime\_sanitizer { |
| [3](#L3) |  |
| [4](#L4) | public function sanitize\_request( $post, $identifier, $exclude = array() ) { |
| [5](#L5) |  |
| [6](#L6) | $post = $this->remove\_magic\_quotes( $post ); |
| [7](#L7) |  |
| [8](#L8) | foreach ( $post as $key => $value ) { |
| [9](#L9) | if ( ! in\_array( $key, $exclude ) ) { |
| [10](#L10) | if ( ! is\_array( $value ) ) { |
| [11](#L11) | $data[ $key ] = $this->get\_sanitized\_fields( $identifier, $key, $value ); |
| [12](#L12) | } else { |
| [13](#L13) |  |
| [14](#L14) | $data[ $key ] = maybe\_serialize( $this->sanitize\_request\_array( $value, $identifier ) ); |
| [15](#L15) |  |
| [16](#L16) | } |
| [17](#L17) | } |
| [18](#L18) | } |
| [19](#L19) |  |
| [20](#L20) | if ( isset( $data ) ) { |
| [21](#L21) | return $data; } else { |
| [22](#L22) | return null; } |
| [23](#L23) | } |
| [24](#L24) |  |
| [25](#L25) | public function sanitize\_request\_array( $post, $identifier ) { |
| [26](#L26) |  |
| [27](#L27) | foreach ( $post as $key => $value ) { |
| [28](#L28) | if ( is\_array( $value ) ) { |
| [29](#L29) | $data[ $key ] = $this->sanitize\_request\_array( $value, $identifier ); |
| [30](#L30) | } else { |
| [31](#L31) | $data[ $key ] = $this->get\_sanitized\_fields( $identifier, $key, $value ); |
| [32](#L32) | } |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | if ( isset( $data ) ) { |
| [36](#L36) | return $data; } else { |
| [37](#L37) | return null; } |
| [38](#L38) | } |
| [39](#L39) |  |
| [40](#L40) |  |
| [41](#L41) |  |
| [42](#L42) | public function get\_sanitized\_fields( $identifier, $field, $value ) { |
| [43](#L43) | $sanitize\_method = 'get\_sanitized\_' . strtolower( $identifier ) . '\_field'; |
| [44](#L44) |  |
| [45](#L45) | if ( method\_exists( $this, $sanitize\_method ) ) { |
| [46](#L46) | $sanitized\_value = $this->$sanitize\_method( $field, $value ); |
| [47](#L47) | } else { |
| [48](#L48) | $classname = "EP\_Helper\_$identifier"; |
| [49](#L49) | } |
| [50](#L50) |  |
| [51](#L51) | if ( isset( $classname ) && class\_exists( $classname ) ) { |
| [52](#L52) | $externalclass   = new $classname(); |
| [53](#L53) | $sanitized\_value = $externalclass->get\_sanitized\_fields( $identifier, $field, $value ); |
| [54](#L54) | } |
| [55](#L55) |  |
| [56](#L56) | return $sanitized\_value; |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | public function get\_sanitized\_checkout\_fields\_field( $field, $value ) { |
| [60](#L60) | switch ( $field ) { |
| [61](#L61) | case 'id': |
| [62](#L62) | $value = sanitize\_text\_field( $value ); |
| [63](#L63) | break; |
| [64](#L64) | case 'option\_data': |
| [65](#L65) | $value = wp\_kses\_post( $value ); |
| [66](#L66) | break; |
| [67](#L67) | default: |
| [68](#L68) | $value = sanitize\_text\_field( $value ); |
| [69](#L69) |  |
| [70](#L70) | } |
| [71](#L71) | return $value; |
| [72](#L72) | } |
| [73](#L73) |  |
| [74](#L74) | public function get\_sanitized\_ticket\_categories\_field( $field, $value ) { |
| [75](#L75) | switch ( $field ) { |
| [76](#L76) | case 'id': |
| [77](#L77) | $value = sanitize\_text\_field( $value ); |
| [78](#L78) | break; |
| [79](#L79) | default: |
| [80](#L80) | $value = sanitize\_text\_field( $value ); |
| [81](#L81) |  |
| [82](#L82) | } |
| [83](#L83) | return $value; |
| [84](#L84) | } |
| [85](#L85) |  |
| [86](#L86) | public function get\_sanitized\_ticket\_field( $field, $value ) { |
| [87](#L87) | switch ( $field ) { |
| [88](#L88) | case 'description': |
| [89](#L89) | $value = wp\_kses\_post( $value ); |
| [90](#L90) | break; |
| [91](#L91) | case 'visibility': |
| [92](#L92) | $value = wp\_kses\_post( $value ); |
| [93](#L93) | break; |
| [94](#L94) | case 'offers': |
| [95](#L95) | $value = wp\_kses\_post( $value ); |
| [96](#L96) | break; |
| [97](#L97) | case 'booking\_starts': |
| [98](#L98) | $value = wp\_kses\_post( $value ); |
| [99](#L99) | break; |
| [100](#L100) | case 'booking\_ends': |
| [101](#L101) | $value = wp\_kses\_post( $value ); |
| [102](#L102) | break; |
| [103](#L103) | default: |
| [104](#L104) | $value = sanitize\_text\_field( $value ); |
| [105](#L105) |  |
| [106](#L106) | } |
| [107](#L107) | return $value; |
| [108](#L108) | } |
| [109](#L109) |  |
| [110](#L110) |  |
| [111](#L111) | public function remove\_magic\_quotes( $input ) { |
| [112](#L112) | foreach ( $input as $key => $value ) { |
| [113](#L113) | if ( is\_array( $value ) ) { |
| [114](#L114) | $input[ $key ] = $this->remove\_magic\_quotes( $value ); |
| [115](#L115) | } elseif ( is\_string( $value ) ) { |
| [116](#L116) | $input[ $key ] = stripslashes( $value ); |
| [117](#L117) | } |
| [118](#L118) | } |
| [119](#L119) | return $input; |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | public function sanitize( $input ) { |
| [123](#L123) | // Initialize the new array or object that will hold the sanitized values |
| [124](#L124) | if (is\_array($input)) { |
| [125](#L125) | $new\_input = array(); |
| [126](#L126) | } elseif (is\_object($input)) { |
| [127](#L127) | $new\_input = new stdClass(); |
| [128](#L128) | } else { |
| [129](#L129) | return $input; // If it's not an array or object, return the input as is |
| [130](#L130) | } |
| [131](#L131) | $email\_field\_array = $this->email\_field\_keys\_array(); |
| [132](#L132) | // Loop through the input and sanitize each of the values |
| [133](#L133) | foreach ( $input as $key => $val ) { |
| [134](#L134) | if (empty($val)) { |
| [135](#L135) | if (is\_array($new\_input)) { |
| [136](#L136) | $new\_input[ $key ] = $val; |
| [137](#L137) | } else { |
| [138](#L138) | $new\_input->{$key} = $val; |
| [139](#L139) | } |
| [140](#L140) | continue; |
| [141](#L141) | } |
| [142](#L142) |  |
| [143](#L143) | if ( is\_array( $val ) || is\_object( $val ) ) { |
| [144](#L144) | // Recursively sanitize arrays or objects |
| [145](#L145) | if (is\_array($new\_input)) { |
| [146](#L146) | $new\_input[ $key ] = $this->sanitize( $val ); |
| [147](#L147) | } else { |
| [148](#L148) | $new\_input->{$key} = $this->sanitize( $val ); |
| [149](#L149) | } |
| [150](#L150) | } else { |
| [151](#L151) | // Sanitize scalar values based on the key |
| [152](#L152) | switch ( $key ) { |
| [153](#L153) | case 'login': |
| [154](#L154) | case 'uname': |
| [155](#L155) | $sanitized\_value = sanitize\_user( $val ); |
| [156](#L156) | break; |
| [157](#L157) | case 'user\_email': |
| [158](#L158) | $sanitized\_value = sanitize\_email( $val ); |
| [159](#L159) | break; |
| [160](#L160) | case 'key': |
| [161](#L161) | $sanitized\_value = sanitize\_text\_field( $val ); |
| [162](#L162) | break; |
| [163](#L163) | case 'nonce': |
| [164](#L164) | case '\_wpnonce': |
| [165](#L165) | case 'security': |
| [166](#L166) | $sanitized\_value = sanitize\_key( $val ); |
| [167](#L167) | break; |
| [168](#L168) | case 'user\_login': |
| [169](#L169) | case 'userdata': |
| [170](#L170) | if ( is\_email( $val ) ) { |
| [171](#L171) | $sanitized\_value = sanitize\_email( $val ); |
| [172](#L172) | } else { |
| [173](#L173) | $sanitized\_value = sanitize\_user( $val ); |
| [174](#L174) | } |
| [175](#L175) | break; |
| [176](#L176) | default: |
| [177](#L177) | if ( is\_email( $val ) ) { |
| [178](#L178) | $sanitized\_value = sanitize\_email( $val ); |
| [179](#L179) | } |
| [180](#L180) | elseif(in\_array($key,$email\_field\_array)) |
| [181](#L181) | { |
| [182](#L182) | $sanitized\_value = wp\_kses\_post( $val ); |
| [183](#L183) | } |
| [184](#L184) | else |
| [185](#L185) | { |
| [186](#L186) |  |
| [187](#L187) | $sanitized\_value = sanitize\_text\_field( $val ); |
| [188](#L188) | } |
| [189](#L189) | break; |
| [190](#L190) | } |
| [191](#L191) |  |
| [192](#L192) | // Assign sanitized value back to the new input array or object |
| [193](#L193) | if (is\_array($new\_input)) { |
| [194](#L194) | $new\_input[ $key ] = $sanitized\_value; |
| [195](#L195) | } else { |
| [196](#L196) | $new\_input->{$key} = $sanitized\_value; |
| [197](#L197) | } |
| [198](#L198) | } |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | return $new\_input; |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | public function email\_field\_keys\_array() |
| [205](#L205) | { |
| [206](#L206) | $fields = array( |
| [207](#L207) | 'send\_booking\_cancellation\_email', |
| [208](#L208) | 'booking\_cancelation\_email\_subject', |
| [209](#L209) | 'booking\_cancelation\_email', |
| [210](#L210) | 'booking\_cancelation\_email\_cc', |
| [211](#L211) | 'send\_booking\_confirm\_email', |
| [212](#L212) | 'booking\_confirm\_email\_subject', |
| [213](#L213) | 'booking\_confirmed\_email', |
| [214](#L214) | 'send\_admin\_booking\_confirm\_email', |
| [215](#L215) | 'admin\_booking\_confirmed\_email\_subject', |
| [216](#L216) | 'admin\_booking\_confirmed\_email', |
| [217](#L217) | 'admin\_booking\_confirmed\_email\_cc', |
| [218](#L218) | 'admin\_booking\_confirm\_email\_attendees', |
| [219](#L219) | 'send\_booking\_pending\_email', |
| [220](#L220) | 'booking\_pending\_email\_subject', |
| [221](#L221) | 'booking\_pending\_email', |
| [222](#L222) | 'booking\_pending\_email\_cc', |
| [223](#L223) | 'send\_booking\_refund\_email', |
| [224](#L224) | 'booking\_refund\_email\_subject', |
| [225](#L225) | 'booking\_refund\_email', |
| [226](#L226) | 'booking\_refund\_email\_cc', |
| [227](#L227) | 'send\_event\_approved\_email', |
| [228](#L228) | 'event\_approved\_email\_subject', |
| [229](#L229) | 'event\_approved\_email', |
| [230](#L230) | 'send\_event\_submitted\_email', |
| [231](#L231) | 'event\_submitted\_email\_subject', |
| [232](#L232) | 'event\_submitted\_email', |
| [233](#L233) | 'event\_submitted\_email\_cc', |
| [234](#L234) | 'registration\_email\_subject', |
| [235](#L235) | 'registration\_email\_content', |
| [236](#L236) | 'reset\_password\_mail\_subject', |
| [237](#L237) | 'reset\_password\_mail', |
| [238](#L238) | 'send\_certificate\_event\_invitation', |
| [239](#L239) | 'certificate\_event\_invitation\_subject', |
| [240](#L240) | 'certificate\_event\_invitation\_email', |
| [241](#L241) | 'send\_rsvp\_event\_invitation', |
| [242](#L242) | 'rsvp\_event\_invitation\_subject', |
| [243](#L243) | 'rsvp\_event\_invitation\_email', |
| [244](#L244) | 'send\_event\_wt\_booking\_mail', |
| [245](#L245) | 'event\_wt\_booking\_mail\_subject', |
| [246](#L246) | 'event\_wt\_booking\_mail\_email', |
| [247](#L247) | 'send\_event\_wt\_reg\_mail', |
| [248](#L248) | 'event\_wt\_reg\_mail\_subject', |
| [249](#L249) | 'event\_wt\_reg\_mail\_email' |
| [250](#L250) | ); |
| [251](#L251) |  |
| [252](#L252) | return $fields; |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) |  |
| [256](#L256) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-eventprime-sanitizer.php?format=txt)
* [Original Format](/export/3222464/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-eventprime-sanitizer.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_673c84bb_20250114_200708.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Feventprime-event-calendar-management%2Ftags%2F4.0.5.3%2Fadmin%2Fpartials%2Fmetaboxes%2Fmeta-box-tickets-panel-html.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php)

---

# [source:](/browser?order=name "Go to repository root") [eventprime-event-calendar-management](/browser/eventprime-event-calendar-management?order=name "View eventprime-event-calendar-management")/[tags](/browser/eventprime-event-calendar-management/tags?order=name "View tags")/[4.0.5.3](/browser/eventprime-event-calendar-management/tags/4.0.5.3?order=name "View 4.0.5.3")/[admin](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin?order=name "View admin")/[partials](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials?order=name "View partials")/[metaboxes](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes?order=name "View metaboxes")/[meta-box-tickets-panel-html.php](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php?order=name "View meta-box-tickets-panel-html.php")

View diff against:

View revision:

| [Last change](/changeset/3199413/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php "View differences") on this file was [3199413](/changeset/3199413/ "View changeset 3199413"), checked in by metagauss, [7 weeks ago](/timeline?from=2024-11-29T11%3A51%3A04Z&precision=second "See timeline at 11/29/2024 11:51:04 AM") |
| --- |
| Tag 4.0.5.3 |
| **File size:** 73.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Event tickets panel html |
| [4](#L4) | \*/ |
| [5](#L5) | defined( 'ABSPATH' ) || exit; |
| [6](#L6) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [7](#L7) | $em\_enable\_booking = get\_post\_meta( $post->ID, 'em\_enable\_booking', true ); |
| [8](#L8) | $extensions = $ep\_functions->ep\_get\_activate\_extensions(); |
| [9](#L9) | $show\_tickets = $show\_message = ''; |
| [10](#L10) | $event\_has\_ticket = 0; |
| [11](#L11) | $is\_event\_expired = $ep\_functions->check\_event\_has\_expired( $single\_event\_data );?> |
| [12](#L12) | <div id="ep\_event\_ticket\_data" class="panel ep\_event\_options\_panel"> |
| [13](#L13) | <div class="ep-box-wrap"> |
| [14](#L14) | <?php if( $is\_event\_expired ) { |
| [15](#L15) | $show\_tickets = '';$show\_message = 1;?> |
| [16](#L16) | <div class="ep-box-row ep-p-3" id="ep\_show\_event\_expire\_warning"> |
| [17](#L17) | <div class="ep-alert ep-alert-warning ep-mt-3 ep-py-2"> |
| [18](#L18) | <strong><?php esc\_html\_e( 'This event has ended.', 'eventprime-event-calendar-management' ); ?></strong> |
| [19](#L19) | </div> |
| [20](#L20) | </div><?php |
| [21](#L21) | } |
| [22](#L22) | if( empty( $single\_event\_data->em\_enable\_booking ) || $single\_event\_data->em\_enable\_booking !== 'bookings\_on' ) { |
| [23](#L23) | $show\_tickets = '';$show\_message = 1;?> |
| [24](#L24) | <div class="ep-box-row ep-p-3" id="ep\_event\_booking\_not\_enabled\_warning"> |
| [25](#L25) | <div class="ep-alert ep-alert-warning ep-mt-3 ep-py-2"> |
| [26](#L26) | <strong><?php esc\_html\_e( 'The event booking is not enabled.', 'eventprime-event-calendar-management' ); ?></strong> |
| [27](#L27) | </div> |
| [28](#L28) | </div><?php |
| [29](#L29) | } |
| [30](#L30) | if( empty( $show\_tickets ) ) { |
| [31](#L31) | $show\_tickets = 'style=display:none;'; |
| [32](#L32) | }?> |
| [33](#L33) |  |
| [34](#L34) | <!-- Ticket Options Buttons Area --> |
| [35](#L35) | <div id="ep-event-tickets-options" <?php echo esc\_attr( $show\_tickets );?>> |
| [36](#L36) | <div class="ep-box-row ep-p-3"> |
| [37](#L37) | <div class="ep-box-col-12 ep-d-flex ep-content-center"> |
| [38](#L38) | <button type="button" class="button button-large ep-m-3 ep-open-modal"  data-id="ep-ticket-category-modal" id="ep\_event\_open\_category\_modal" title="<?php esc\_html\_e( 'Add Tickets Category', 'eventprime-event-calendar-management' );?>"> |
| [39](#L39) | <?php esc\_html\_e( 'Add Tickets Category', 'eventprime-event-calendar-management' );?> |
| [40](#L40) | </button> |
| [41](#L41) | <button type="button" class="button button-large ep-m-3 ep-open-modal" data-id="ep\_event\_ticket\_tier\_modal" id="ep\_event\_open\_ticket\_modal" title="<?php esc\_html\_e( 'Add Tickets', 'eventprime-event-calendar-management' );?>"> |
| [42](#L42) | <?php esc\_html\_e( 'Add Ticket Type', 'eventprime-event-calendar-management' );?> |
| [43](#L43) | </button> |
| [44](#L44) | </div> |
| [45](#L45) | <!--Existing Tickets--> |
| [46](#L46) | <div id="ep\_existing\_tickets\_category\_list" class="ep\_existing\_tickets\_category\_list ep-box-col-12"> |
| [47](#L47) | <?php |
| [48](#L48) | $existing\_cat\_data = $ep\_functions->get\_existing\_category\_lists( $post->ID ); |
| [49](#L49) | $ep\_ticket\_category\_data = ( ! empty( $existing\_cat\_data ) ? wp\_json\_encode($existing\_cat\_data) : '' );?> |
| [50](#L50) | <input type="hidden" name="em\_ticket\_category\_data" id="ep\_ticket\_category\_data" value="<?php echo esc\_attr( $ep\_ticket\_category\_data );?>" /> |
| [51](#L51) | <input type="hidden" name="em\_ticket\_category\_delete\_ids" id="ep\_ticket\_category\_delete\_ids" value="" /> |
| [52](#L52) |  |
| [53](#L53) | <div class="ep-box-row ep-p-3" id="ep\_existing\_tickets\_list"> |
| [54](#L54) | <?php if( !empty( $existing\_cat\_data ) && count( $existing\_cat\_data ) > 0 ) { |
| [55](#L55) | foreach( $existing\_cat\_data as $key => $cat\_data ) { |
| [56](#L56) | $cat\_row\_data = wp\_json\_encode($cat\_data); |
| [57](#L57) | $row\_key = $key + 1; |
| [58](#L58) | $cat\_row\_id = 'ep\_ticket\_cat\_section'. $row\_key; ?> |
| [59](#L59) | <div class="ep-box-col-12 ep-p-3 ep-border ep-rounded ep-mb-3 ep-bg-white ep-shadow-sm ui-state-default ep-cat-list-class" id="<?php echo esc\_attr( $cat\_row\_id );?>" data-cat\_row\_data="<?php echo esc\_attr( $cat\_row\_data );?>"> |
| [60](#L60) | <div class="ep-box-row ep-mb-3 ep-items-center"> |
| [61](#L61) | <div class="ep-box-col-1"> |
| [62](#L62) | <span class="ep-ticket-cat-sort material-icons ep-cursor-move text-muted" data-parent\_id="<?php echo esc\_attr( $cat\_row\_id );?>" >drag\_indicator</span> |
| [63](#L63) | </div> |
| [64](#L64) | <div class="ep-box-col-5"> |
| [65](#L65) | <h4 class="ep-cat-name"><?php echo esc\_html( $cat\_data->name );?></h4> |
| [66](#L66) | </div> |
| [67](#L67) | <div class="ep-box-col-4"> |
| [68](#L68) | <h4 class="ep-cat-capacity"> |
| [69](#L69) | <?php echo esc\_html\_\_( 'Capacity', 'eventprime-event-calendar-management' ) . ': '. esc\_html( $cat\_data->capacity );?> |
| [70](#L70) | </h4> |
| [71](#L71) | </div> |
| [72](#L72) | <div class="ep-box-col-1"> |
| [73](#L73) | <a href="javascript:void(0)" class="ep-ticket-cat-edit ep-text-primary" data-parent\_id="<?php echo esc\_attr( $cat\_row\_id );?>" title="<?php esc\_html\_e( 'Edit Category', 'eventprime-event-calendar-management' );?>"><?php esc\_html\_e( 'Edit', 'eventprime-event-calendar-management' );?></a> |
| [74](#L74) | </div> |
| [75](#L75) | <div class="ep-box-col-1"> |
| [76](#L76) | <a href="javascript:void(0)" class="ep-ticket-cat-delete ep-item-delete" data-parent\_id="<?php echo esc\_attr( $cat\_row\_id );?>" title="<?php esc\_html\_e( 'Delete Category', 'eventprime-event-calendar-management' );?>"><?php esc\_html\_e( 'Delete', 'eventprime-event-calendar-management' );?></a> |
| [77](#L77) | </div> |
| [78](#L78) | </div> |
| [79](#L79) |  |
| [80](#L80) | <div class="ep-ticket-category-section" data-parent\_category\_id="<?php echo esc\_attr( $row\_key );?>"> |
| [81](#L81) | <?php |
| [82](#L82) | $existing\_cat\_ticket\_data = $ep\_functions->get\_existing\_category\_ticket\_lists( $post->ID, $cat\_data->id ); |
| [83](#L83) | if( !empty( $existing\_cat\_ticket\_data ) ) { |
| [84](#L84) | $tic\_row = 1;$event\_has\_ticket = 1; |
| [85](#L85) | foreach( $existing\_cat\_ticket\_data as $ticket ) { |
| [86](#L86) | $icon\_url = ''; |
| [87](#L87) | if( ! empty( $ticket->icon ) ) { |
| [88](#L88) | $icon\_url = wp\_get\_attachment\_url( $ticket->icon ); |
| [89](#L89) | } |
| [90](#L90) | $ticket->icon\_url = $icon\_url; |
| [91](#L91) | $ticket\_row\_data = wp\_json\_encode( $ticket ); |
| [92](#L92) | $ticket\_row\_id = ''; |
| [93](#L93) | $ticket\_row\_id = 'ep\_cat\_' . $row\_key . '\_ticket' . $tic\_row;?> |
| [94](#L94) | <div class="ep-box-row ep-tickets-cate-ticket-row" id="<?php echo esc\_attr( $ticket\_row\_id );?>" data-ticket\_row\_data="<?php echo esc\_attr( $ticket\_row\_data );?>"> |
| [95](#L95) | <div class="ep-box-col-12"> |
| [96](#L96) | <div class="ep-box-row ep-border ep-rounded ep-ml-2 ep-my-1 ep-mr-2 ep-bg-white ep-items-center ui-state-default"> |
| [97](#L97) | <div class="ep-box-col-1 ep-p-3"> |
| [98](#L98) | <span class="ep-ticket-row-sort material-icons ep-cursor-move ep-text-muted" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>">drag\_indicator</span> |
| [99](#L99) | </div> |
| [100](#L100) | <div class="ep-box-col-3 ep-p-3"> |
| [101](#L101) | <?php echo esc\_html( $ticket->name );?> |
| [102](#L102) | </div> |
| [103](#L103) | <div class="ep-box-col-2 ep-p-3"> |
| [104](#L104) | <span><?php echo esc\_html( $ep\_functions->ep\_price\_with\_position( $ticket->price ) );?></span> |
| [105](#L105) | </div> |
| [106](#L106) | <div class="ep-box-col-3 ep-p-3"> |
| [107](#L107) | <span> |
| [108](#L108) | <?php echo esc\_html\_\_( 'Capacity', 'eventprime-event-calendar-management' ) . ' ' . esc\_html( $ticket->capacity ) . '/' . esc\_html( $cat\_data->capacity );?> |
| [109](#L109) | </span> |
| [110](#L110) | </div> |
| [111](#L111) | <?php do\_action( 'ep\_event\_tickets\_action\_icons', $post->ID, $ticket->id );?> |
| [112](#L112) | <div class="ep-box-col-1 ep-p-3"> |
| [113](#L113) | <a href="javascript:void(0)" class="ep-ticket-row-edit ep-text-primary ep-cursor" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>" data-parent\_category\_id="<?php echo esc\_attr( $cat\_row\_id );?>" title="<?php esc\_html\_e( 'Edit Ticket', 'eventprime-event-calendar-management' );?>">Edit</a> |
| [114](#L114) | </div> |
| [115](#L115) | <div class="ep-box-col-1 ep-p-3"> |
| [116](#L116) | <span class="ep-ticket-row-delete ep-text-danger ep-cursor" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>" title="<?php esc\_html\_e( 'Delete Ticket', 'eventprime-event-calendar-management' );?>">Delete</span> |
| [117](#L117) | </div> |
| [118](#L118) | </div> |
| [119](#L119) | </div> |
| [120](#L120) | </div><?php |
| [121](#L121) | $tic\_row++; |
| [122](#L122) | } |
| [123](#L123) | }?> |
| [124](#L124) | </div><?php |
| [125](#L125) | $total\_caps = $ep\_functions->get\_category\_tickets\_capacity( $existing\_cat\_ticket\_data ); |
| [126](#L126) | if( $total\_caps < $cat\_data->capacity ){?> |
| [127](#L127) | <div class="ep\_category\_add\_tickets\_button" id="ep\_category\_add\_tickets\_button\_<?php echo esc\_attr( $cat\_row\_id );?>"> |
| [128](#L128) | <button type="button" class="button button-large ep-m-3 ep-open-category-ticket-modal" data-id="ep\_event\_ticket\_tier\_modal" data-parent\_id="<?php echo esc\_attr( $cat\_row\_id );?>"><?php esc\_html\_e( 'Add Tickets', 'eventprime-event-calendar-management' );?></button> |
| [129](#L129) | </div><?php |
| [130](#L130) | }?> |
| [131](#L131) | </div><?php |
| [132](#L132) | } |
| [133](#L133) | }?> |
| [134](#L134) | </div> |
| [135](#L135) | </div> |
| [136](#L136) | <div id="ep\_existing\_individual\_tickets\_list"> |
| [137](#L137) | <input type="hidden" name="ep\_ticket\_order\_arr" id="ep\_ticket\_order\_arr" value="" /> |
| [138](#L138) | <?php $get\_existing\_individual\_ticket\_lists = $ep\_functions->get\_existing\_individual\_ticket\_lists( $post->ID ); |
| [139](#L139) | $ep\_ticket\_data = ( ! empty( $get\_existing\_individual\_ticket\_lists ) ? $get\_existing\_individual\_ticket\_lists : array() ); |
| [140](#L140) | //$em\_ticket\_individual\_data = ( ! empty( $get\_existing\_individual\_ticket\_lists ) ? wp\_json\_encode( $get\_existing\_individual\_ticket\_lists ) : '' );?> |
| [141](#L141) | <input type="hidden" name="em\_ticket\_individual\_data" id="ep\_ticket\_individual\_data" value="" /> |
| [142](#L142) | <input type="hidden" name="em\_ticket\_individual\_delete\_ids" id="ep\_ticket\_individual\_delete\_ids" value="" /> |
| [143](#L143) | <?php |
| [144](#L144) | do\_action('ep\_ticket\_additional\_hidden\_fields'); |
| [145](#L145) | do\_action('ep\_ticket\_additional\_hidden\_fields\_data',$post->ID); |
| [146](#L146) | ?> |
| [147](#L147) | <div class="ep-ticket-category-section"> |
| [148](#L148) | <?php if( !empty( $ep\_ticket\_data ) ) { |
| [149](#L149) |  |
| [150](#L150) | if ( isset( get\_post\_meta( $post->ID )["ep\_ticket\_order\_arr"] ) && !empty( get\_post\_meta( $post->ID )["ep\_ticket\_order\_arr"] ) ) { |
| [151](#L151) | $ep\_ticket\_order\_arr = maybe\_unserialize( get\_post\_meta( $post->ID )["ep\_ticket\_order\_arr"][0] ); |
| [152](#L152) | if ( is\_array( $ep\_ticket\_order\_arr ) ) { |
| [153](#L153) | $ids\_fliped\_for\_ep\_ticket\_order\_arr = array\_flip($ep\_ticket\_order\_arr); |
| [154](#L154) | usort($ep\_ticket\_data, function($a, $b) use ($ids\_fliped\_for\_ep\_ticket\_order\_arr) { |
| [155](#L155) | if ( isset( $ids\_fliped\_for\_ep\_ticket\_order\_arr[$a->id] ) && isset( $ids\_fliped\_for\_ep\_ticket\_order\_arr[$b->id] ) ) { |
| [156](#L156) | $posA = $ids\_fliped\_for\_ep\_ticket\_order\_arr[$a->id]; |
| [157](#L157) | $posB = $ids\_fliped\_for\_ep\_ticket\_order\_arr[$b->id]; |
| [158](#L158) | return $posA - $posB; |
| [159](#L159) | } |
| [160](#L160) | }); |
| [161](#L161) | } |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | $tic\_row = 1;$event\_has\_ticket = 1; |
| [165](#L165) | foreach( $ep\_ticket\_data as $ticket ) { |
| [166](#L166) | $icon\_url = ''; |
| [167](#L167) | if( ! empty( $ticket->icon ) ) { |
| [168](#L168) | $icon\_url = wp\_get\_attachment\_url( $ticket->icon ); |
| [169](#L169) | } |
| [170](#L170) | $ticket->icon\_url = $icon\_url; |
| [171](#L171) | $ticket\_row\_data = wp\_json\_encode( $ticket ); |
| [172](#L172) | $ticket\_row\_id = 'ep\_event\_ticket\_row' . $tic\_row;?> |
| [173](#L173) | <div class="ep-box-row ep-tickets-indi-ticket-row" id="<?php echo esc\_attr( $ticket\_row\_id );?>" data-ticket\_row\_data="<?php echo esc\_attr( $ticket\_row\_data );?>"> |
| [174](#L174) | <div class="ep-box-col-12"> |
| [175](#L175) | <div class="ep-box-row ep-border ep-rounded ep-ml-2 ep-my-1 ep-mr-2 ep-bg-white ep-items-center ui-state-default"> |
| [176](#L176) | <div class="ep-box-col-1 ep-p-3"> |
| [177](#L177) | <span class="ep-ticket-row-sort material-icons ep-cursor-move ep-text-muted" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>">drag\_indicator</span> |
| [178](#L178) | </div> |
| [179](#L179) | <div class="ep-box-col-3 ep-p-3"> |
| [180](#L180) | <?php echo esc\_html( $ticket->name );?> |
| [181](#L181) | </div> |
| [182](#L182) | <div class="ep-box-col-2 ep-p-3"> |
| [183](#L183) | <span><?php echo esc\_html( $ep\_functions->ep\_price\_with\_position( $ticket->price ) );?></span> |
| [184](#L184) | </div> |
| [185](#L185) | <div class="ep-box-col-3 ep-p-3"> |
| [186](#L186) | <span> |
| [187](#L187) | <?php echo esc\_html\_\_( 'Capacity', 'eventprime-event-calendar-management' ) . ' ' . esc\_html( $ticket->capacity );?> |
| [188](#L188) | </span> |
| [189](#L189) | </div> |
| [190](#L190) | <?php do\_action( 'ep\_event\_tickets\_action\_icons', $post->ID, $ticket->id );?> |
| [191](#L191) | <div class="ep-box-col-1 ep-p-3"> |
| [192](#L192) | <a href="javascript:void(0)" class="ep-ticket-row-edit ep-text-primary ep-cursor" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>" title="<?php esc\_html\_e( 'Edit Ticket', 'eventprime-event-calendar-management' );?>">Edit</a> |
| [193](#L193) | </div> |
| [194](#L194) | <div class="ep-box-col-1 ep-p-3"> |
| [195](#L195) | <a href="javascript:void(0)" class="ep-ticket-row-delete  ep-text-danger ep-cursor" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>" title="<?php esc\_html\_e( 'Delete Ticket', 'eventprime-event-calendar-management' );?>">Delete</a> |
| [196](#L196) | </div> |
| [197](#L197) | </div> |
| [198](#L198) | </div> |
| [199](#L199) | </div><?php |
| [200](#L200) | $tic\_row++; |
| [201](#L201) | } |
| [202](#L202) | }?> |
| [203](#L203) | </div> |
| [204](#L204) | </div> |
| [205](#L205) | <!--Existing Tickets Ends--> |
| [206](#L206) | </div> |
| [207](#L207) | </div> |
| [208](#L208) |  |
| [209](#L209) | <!--Add Ticket Category Modal--> |
| [210](#L210) | <div id="ep-ticket-category-modal" class="ep-modal-view" style="display: none;"> |
| [211](#L211) | <div class="ep-modal-overlay ep-modal-overlay-fade-in"></div> |
| [212](#L212) | <div class="popup-content ep-modal-wrap ep-modal-sm ep-modal-out"> |
| [213](#L213) | <div class="ep-modal-body"> |
| [214](#L214) | <div class="ep-modal-titlebar ep-d-flex ep-items-center"> |
| [215](#L215) | <h3 class="ep-modal-title ep-px-3 "> |
| [216](#L216) | <?php esc\_html\_e('Add Tickets Category', 'eventprime-event-calendar-management'); ?> |
| [217](#L217) | </h3> |
| [218](#L218) | <a href="#" class="ep-modal-close close-popup" data-id="ep-ticket-category-modal">&times;</a> |
| [219](#L219) | </div> |
| [220](#L220) | <div class="ep-modal-content-wrapep-box-wrap"> |
| [221](#L221) | <div class="ep-box-row ep-p-3 ep-box-w-75"> |
| [222](#L222) | <div class="ep-box-col-12"> |
| [223](#L223) | <label class="ep-form-label"> |
| [224](#L224) | <?php esc\_html\_e('Tickets Category', 'eventprime-event-calendar-management'); ?> |
| [225](#L225) | </label> |
| [226](#L226) | <input type="text" class="ep-form-control" name="em\_ticket\_category\_name" id="ep\_ticket\_category\_name"> |
| [227](#L227) | <div class="ep-text-muted ep-text-small"> |
| [228](#L228) | <?php esc\_html\_e('Category name will be visible to users while selecting tickets.', 'eventprime-event-calendar-management'); ?> |
| [229](#L229) | </div> |
| [230](#L230) | <div id="ep\_ticket\_category\_name\_error" class="ep-error-message"></div> |
| [231](#L231) | </div> |
| [232](#L232) |  |
| [233](#L233) | <div class="ep-box-col-12 ep-mt-3"> |
| [234](#L234) | <label class="ep-form-label"> |
| [235](#L235) | <?php esc\_html\_e('Total Quantity/Inventory', 'eventprime-event-calendar-management'); ?> |
| [236](#L236) | </label> |
| [237](#L237) | <input type="number" class="ep-form-control" name="em\_ticket\_category\_capacity" min="1" id="ep\_ticket\_category\_capacity"> |
| [238](#L238) | <div class="ep-text-muted ep-text-small"> |
| [239](#L239) | <?php esc\_html\_e('Combined capacity or inventory of the tickets you wish to include in this tickets category should not exceed this number.', 'eventprime-event-calendar-management'); ?> |
| [240](#L240) | </div> |
| [241](#L241) | <div id="ep\_ticket\_category\_capacity\_error" class="ep-error-message"></div> |
| [242](#L242) | </div> |
| [243](#L243) | </div> |
| [244](#L244) |  |
| [245](#L245) | <div class="ep-modal-footer ep-mt-3 ep-d-flex ep-items-end ep-content-right"> |
| [246](#L246) | <button type="button" class="button ep-mr-3 ep-modal-close close-popup" data-id="ep-ticket-category-modal"><?php esc\_html\_e('Close', 'eventprime-event-calendar-management'); ?></button> |
| [247](#L247) | <button type="button" class="button button-primary button-large" id="ep\_save\_ticket\_category"><?php esc\_html\_e('Add', 'eventprime-event-calendar-management'); ?></button> |
| [248](#L248) | </div> |
| [249](#L249) | </div> |
| [250](#L250) | </div> |
| [251](#L251) | </div> |
| [252](#L252) | </div> |
| [253](#L253) | <!--Add Ticket Category Modal--> |
| [254](#L254) |  |
| [255](#L255) | <!-- Add  Ticket Tier Modal --> |
| [256](#L256) | <div id="ep\_event\_ticket\_tier\_modal" class="ep-modal-view" style="display: none;"> |
| [257](#L257) | <input type="hidden" name="em\_ticket\_category\_id" value="" /> |
| [258](#L258) | <input type="hidden" name="em\_ticket\_id" value="" /> |
| [259](#L259) | <input type="hidden" name="em\_ticket\_parent\_div\_id" value="" /> |
| [260](#L260) | <div class="ep-modal-overlay ep-modal-overlay-fade-in"></div> |
| [261](#L261) | <div class="popup-content ep-modal-wrap ep-modal-lg ep-modal-out"> |
| [262](#L262) | <div class="ep-modal-body"> |
| [263](#L263) | <div class="ep-modal-titlebar ep-d-flex ep-items-center"> |
| [264](#L264) | <h3 class="ep-modal-title ep-px-3"><?php esc\_html\_e( 'Add Ticket Type', 'eventprime-event-calendar-management' );?></h3> |
| [265](#L265) | <a href="#" class="ep-modal-close close-popup" data-id="ep\_event\_ticket\_tier\_modal">&times;</a> |
| [266](#L266) | </div> |
| [267](#L267) | <div class="ep-modal-content-wrap ep-box-wrap"> |
| [268](#L268) | <div class="ep-box-row ep-p-3 ep-box-w-75"> |
| [269](#L269) | <div class="ep-box-col-12"> |
| [270](#L270) | <label class="ep-form-label"> |
| [271](#L271) | <?php esc\_html\_e( 'Name', 'eventprime-event-calendar-management' );?> |
| [272](#L272) | </label> |
| [273](#L273) | <input type="text" class="ep-form-control" name="name" id="ep\_event\_ticke\_name"> |
| [274](#L274) | <div class="ep-text-muted ep-text-small"> |
| [275](#L275) | <?php esc\_html\_e('Ticket names are visible to the user on the frontend.', 'eventprime-event-calendar-management'); ?> |
| [276](#L276) | </div> |
| [277](#L277) | <div class="ep-error-message" id="ep\_event\_ticket\_name\_error"></div> |
| [278](#L278) | </div> |
| [279](#L279) |  |
| [280](#L280) | <div class="ep-box-col-12 ep-mt-3"> |
| [281](#L281) | <label class="ep-form-label"> |
| [282](#L282) | <?php esc\_html\_e( 'Description', 'eventprime-event-calendar-management' );?> |
| [283](#L283) | </label> |
| [284](#L284) | <textarea class="ep-form-control" name="description" id="ep\_event\_ticke\_description"></textarea> |
| [285](#L285) | <div class="ep-text-muted ep-text-small"> |
| [286](#L286) | <?php esc\_html\_e('Ticket description are visible to the user on the frontend during ticket selection.', 'eventprime-event-calendar-management'); ?> |
| [287](#L287) | </div> |
| [288](#L288) | </div> |
| [289](#L289) |  |
| [290](#L290) | <div class="ep-box-col-12 ep-mt-3"> |
| [291](#L291) | <label class="ep-form-label"> |
| [292](#L292) | <!--<?php esc\_html\_e( 'Icon', 'eventprime-event-calendar-management' );?> --> |
| [293](#L293) | </label> |
| [294](#L294) | <input type="hidden" name="icon" id="ep\_event\_ticket\_icon"> |
| [295](#L295) | <button type="button" class="upload\_offer\_icon\_button button"> |
| [296](#L296) | <?php esc\_html\_e( 'Upload Icon', 'eventprime-event-calendar-management' );?> |
| [297](#L297) | </button> |
| [298](#L298) | <div class="ep-text-muted ep-text-small"> |
| [299](#L299) | <?php esc\_html\_e('A small icon or an image representative of the ticket type.', 'eventprime-event-calendar-management'); ?> |
| [300](#L300) | </div> |
| [301](#L301) | <div id="ep\_event\_ticket\_icon\_image"></div> |
| [302](#L302) | </div> |
| [303](#L303) |  |
| [304](#L304) | <div class="ep-box-col-5 ep-mt-3"> |
| [305](#L305) | <label class="ep-form-label"> |
| [306](#L306) | <?php esc\_html\_e( 'Quantity/ Inventory', 'eventprime-event-calendar-management' );?> |
| [307](#L307) | </label> |
| [308](#L308) | <input type="number" class="ep-form-control" min="0" name="capacity" id="ep\_event\_ticket\_qty"> |
| [309](#L309) | <div class="ep-error-message" id="ep\_event\_ticket\_qty\_error"></div> |
| [310](#L310) | <span id="ep\_ticket\_remaining\_capacity" data-max\_ticket\_label="<?php esc\_html\_e( 'Remaining Seats', 'eventprime-event-calendar-management' );?>"></span> |
| [311](#L311) | </div> |
| [312](#L312) |  |
| [313](#L313) | <div class="ep-box-col-5 ep-mt-3"> |
| [314](#L314) | <label class="ep-form-label"> |
| [315](#L315) | <?php esc\_html\_e( 'Price ( per ticket )', 'eventprime-event-calendar-management' );?> |
| [316](#L316) | </label> |
| [317](#L317) | <input type="number" class="ep-form-control" name="price" id="ep\_event\_ticket\_price" min="0.00" step="0.01"> |
| [318](#L318) | </div> |
| [319](#L319) |  |
| [320](#L320) | <div class="ep-box-col-2 ep-mt-3 ep-d-flex ep-items-end ep-pb-2"> |
| [321](#L321) | <span class="ep-fw-bold"><?php |
| [322](#L322) | $selected\_currency = $ep\_functions->ep\_get\_global\_settings( 'currency' ); |
| [323](#L323) | if( empty( $selected\_currency ) ) { |
| [324](#L324) | $selected\_currency = 'USD'; |
| [325](#L325) | } |
| [326](#L326) | echo esc\_html( $selected\_currency ); |
| [327](#L327) | ?></span> |
| [328](#L328) | <span class="ep-color-primary ep-border-bottom ep-border-opacity-50 ep-ml-2 ep-text-small"><a target="\_blank" href="<?php echo esc\_url(add\_query\_arg(array('tab' => 'payments'), admin\_url().'edit.php?post\_type=em\_event&page=ep-settings'));?>"><?php esc\_html\_e( 'change?', 'eventprime-event-calendar-management' );?></a></span> |
| [329](#L329) | </div> |
| [330](#L330) |  |
| [331](#L331) | <div class="ep-box-col-12 ep-mt-3"> |
| [332](#L332) | <button type="button" class="button button-primary button-large" id="add\_more\_additional\_ticket\_fee"><?php esc\_html\_e( 'Add Additional Fee', 'eventprime-event-calendar-management' );?></button> |
| [333](#L333) | </div> |
| [334](#L334) |  |
| [335](#L335) | <div class="ep-additional-ticket-fee-wrapper ep-box-w-100" id="ep\_additional\_ticket\_fee\_wrapper"></div> |
| [336](#L336) |  |
| [337](#L337) | <div class="ep-box-col-12 ep-mt-2"> |
| [338](#L338) | <div class="ep-form-check"> |
| [339](#L339) | <input class="ep-form-check-input" type="checkbox" name="show\_remaining\_tickets" value="1" id="ep\_show\_remaining\_tickets"> |
| [340](#L340) | <label class="ep-form-check-label" for="ep\_show\_remaining\_tickets"> |
| [341](#L341) | <?php esc\_html\_e( 'Show tickets remaining to the users', 'eventprime-event-calendar-management' );?> |
| [342](#L342) | </label> |
| [343](#L343) | </div> |
| [344](#L344) | </div> |
| [345](#L345) |  |
| [346](#L346) | <div class="ep-box-col-6 ep-mt-3"> |
| [347](#L347) | <div class="ep-box-row"> |
| [348](#L348) | <div class="ep-box-col-12"> |
| [349](#L349) | <label class="ep-form-label"> |
| [350](#L350) | <?php esc\_html\_e( 'Tickets Available From', 'eventprime-event-calendar-management' );?> |
| [351](#L351) | </label> |
| [352](#L352) | <select class="ep-form-control ep\_ticket\_start\_booking\_type" id="ep\_ticket\_start\_booking\_type" name="em\_ticket\_start\_booking\_type"> |
| [353](#L353) | <option value="custom\_date"><?php esc\_html\_e( 'Custom Date', 'eventprime-event-calendar-management' );?></option> |
| [354](#L354) | <option value="event\_date"><?php esc\_html\_e( 'Event Date', 'eventprime-event-calendar-management' );?></option> |
| [355](#L355) | <option value="relative\_date"><?php esc\_html\_e( 'Relative Date', 'eventprime-event-calendar-management' );?></option> |
| [356](#L356) | </select> |
| [357](#L357) | </div> |
| [358](#L358) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_start\_booking\_options ep\_ticket\_start\_booking\_custom\_date"> |
| [359](#L359) | <label class="ep-form-label"> |
| [360](#L360) | <?php esc\_html\_e( 'Choose Date', 'eventprime-event-calendar-management' );?> |
| [361](#L361) | </label> |
| [362](#L362) | <input type="text" class="ep-form-control ep\_metabox\_custom\_date\_picker" name="em\_ticket\_start\_booking\_date" id="ep\_ticket\_start\_booking\_date" data-start="today" data-end="event\_end"> |
| [363](#L363) | </div> |
| [364](#L364) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_start\_booking\_options ep\_ticket\_start\_booking\_custom\_date"> |
| [365](#L365) | <label class="ep-form-label"> |
| [366](#L366) | <?php esc\_html\_e( 'Choose Time', 'eventprime-event-calendar-management' );?> |
| [367](#L367) | </label> |
| [368](#L368) | <input type="text" class="ep-form-control epTimePicker" name="em\_ticket\_start\_booking\_time" id="ep\_ticket\_start\_booking\_time"> |
| [369](#L369) | </div> |
| [370](#L370) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_start\_booking\_options ep\_ticket\_start\_booking\_relative\_date" style="display:none;"> |
| [371](#L371) | <label class="ep-form-label"> |
| [372](#L372) | <?php esc\_html\_e( 'Enter Days', 'eventprime-event-calendar-management' );?> |
| [373](#L373) | </label> |
| [374](#L374) | <input type="number" class="ep-form-control" name="em\_ticket\_start\_booking\_days" id="ep\_ticket\_start\_booking\_days" min="0"> |
| [375](#L375) | </div> |
| [376](#L376) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_start\_booking\_options ep\_ticket\_start\_booking\_relative\_date" style="display:none;"> |
| [377](#L377) | <label class="ep-form-label"> |
| [378](#L378) | <?php esc\_html\_e( 'Days Option', 'eventprime-event-calendar-management' );?> |
| [379](#L379) | </label> |
| [380](#L380) | <select class="ep-form-control" name="em\_ticket\_start\_booking\_days\_option" id="ep\_ticket\_start\_booking\_days\_option"> |
| [381](#L381) | <option value="before"><?php esc\_html\_e( 'Days Before', 'eventprime-event-calendar-management');?></option> |
| [382](#L382) | <option value="after"><?php esc\_html\_e( 'Days After', 'eventprime-event-calendar-management');?></option> |
| [383](#L383) | </select> |
| [384](#L384) | </div> |
| [385](#L385) | <div class="ep-box-col-12 ep-mt-3 ep\_ticket\_start\_booking\_options ep\_ticket\_start\_booking\_event\_date ep\_ticket\_start\_booking\_relative\_date" style="display:none;"> |
| [386](#L386) | <label class="ep-form-label"> |
| [387](#L387) | <?php esc\_html\_e( 'Event Option', 'eventprime-event-calendar-management' );?> |
| [388](#L388) | </label> |
| [389](#L389) | <select class="ep-form-control" name="em\_ticket\_start\_booking\_event\_option" id="ep\_ticket\_start\_booking\_event\_option"> |
| [390](#L390) | <?php $existing\_cat\_data = $ep\_functions->get\_ticket\_booking\_event\_date\_options( $post->ID ); |
| [391](#L391) | if( ! empty( $existing\_cat\_data ) ) { |
| [392](#L392) | foreach( $existing\_cat\_data as $key => $option ) {?> |
| [393](#L393) | <option value="<?php echo esc\_attr( $key );?>"><?php echo esc\_html( $option );?></option><?php |
| [394](#L394) | } |
| [395](#L395) | }?> |
| [396](#L396) | </select> |
| [397](#L397) | <div class="ep-error-message" id="em\_ticket\_start\_booking\_event\_option\_error"></div> |
| [398](#L398) | </div> |
| [399](#L399) | </div> |
| [400](#L400) | </div> |
| [401](#L401) | <div class="ep-box-col-6 ep-mt-3"> |
| [402](#L402) | <div class="ep-box-row"> |
| [403](#L403) | <div class="ep-box-col-12"> |
| [404](#L404) | <label class="ep-form-label"> |
| [405](#L405) | <?php esc\_html\_e( 'Tickets Available Till', 'eventprime-event-calendar-management' );?> |
| [406](#L406) | </label> |
| [407](#L407) | <select class="ep-form-control ep\_ticket\_ends\_booking\_type" id="ep\_ticket\_ends\_booking\_type" name="em\_ticket\_ends\_booking\_type"> |
| [408](#L408) | <option value="custom\_date"><?php esc\_html\_e( 'Custom Date', 'eventprime-event-calendar-management' );?></option> |
| [409](#L409) | <option value="event\_date"><?php esc\_html\_e( 'Event Date', 'eventprime-event-calendar-management' );?></option> |
| [410](#L410) | <option value="relative\_date"><?php esc\_html\_e( 'Relative Date', 'eventprime-event-calendar-management' );?></option> |
| [411](#L411) | </select> |
| [412](#L412) | </div> |
| [413](#L413) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_ends\_booking\_options ep\_ticket\_ends\_booking\_custom\_date"> |
| [414](#L414) | <label class="ep-form-label"> |
| [415](#L415) | <?php esc\_html\_e( 'Choose Date', 'eventprime-event-calendar-management' );?> |
| [416](#L416) | </label> |
| [417](#L417) | <input type="text" class="ep-form-control ep\_metabox\_custom\_date\_picker" name="em\_ticket\_ends\_booking\_date" id="ep\_ticket\_ends\_booking\_date" data-start="today" data-end="event\_end"> |
| [418](#L418) | </div> |
| [419](#L419) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_ends\_booking\_options ep\_ticket\_ends\_booking\_custom\_date"> |
| [420](#L420) | <label class="ep-form-label"> |
| [421](#L421) | <?php esc\_html\_e( 'Choose Time', 'eventprime-event-calendar-management' );?> |
| [422](#L422) | </label> |
| [423](#L423) | <input type="text" class="ep-form-control epTimePicker" name="em\_ticket\_ends\_booking\_time" id="ep\_ticket\_ends\_booking\_time"> |
| [424](#L424) | </div> |
| [425](#L425) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_ends\_booking\_options ep\_ticket\_ends\_booking\_relative\_date" style="display:none;"> |
| [426](#L426) | <label class="ep-form-label"> |
| [427](#L427) | <?php esc\_html\_e( 'Enter Days', 'eventprime-event-calendar-management' );?> |
| [428](#L428) | </label> |
| [429](#L429) | <input type="number" class="ep-form-control" name="em\_ticket\_ends\_booking\_days" id="ep\_ticket\_ends\_booking\_days" min="0"> |
| [430](#L430) | </div> |
| [431](#L431) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_ends\_booking\_options ep\_ticket\_ends\_booking\_relative\_date" style="display:none;"> |
| [432](#L432) | <label class="ep-form-label"> |
| [433](#L433) | <?php esc\_html\_e( 'Days Option', 'eventprime-event-calendar-management' );?> |
| [434](#L434) | </label> |
| [435](#L435) | <select class="ep-form-control" name="em\_ticket\_ends\_booking\_days\_option" id="ep\_ticket\_ends\_booking\_days\_option"> |
| [436](#L436) | <option value="before"><?php esc\_html\_e( 'Days Before', 'eventprime-event-calendar-management');?></option> |
| [437](#L437) | <option value="after"><?php esc\_html\_e( 'Days After', 'eventprime-event-calendar-management');?></option> |
| [438](#L438) | </select> |
| [439](#L439) | </div> |
| [440](#L440) | <div class="ep-box-col-12 ep-mt-3 ep\_ticket\_ends\_booking\_options ep\_ticket\_ends\_booking\_event\_date ep\_ticket\_ends\_booking\_relative\_date" style="display:none;"> |
| [441](#L441) | <label class="ep-form-label"> |
| [442](#L442) | <?php esc\_html\_e( 'Event Option', 'eventprime-event-calendar-management' );?> |
| [443](#L443) | </label> |
| [444](#L444) | <select class="ep-form-control" name="em\_ticket\_ends\_booking\_event\_option" id="ep\_ticket\_ends\_booking\_event\_option"> |
| [445](#L445) | <?php $existing\_cat\_data = $ep\_functions->get\_ticket\_booking\_event\_date\_options( $post->ID ); |
| [446](#L446) | if( ! empty( $existing\_cat\_data ) ) { |
| [447](#L447) | foreach( $existing\_cat\_data as $key => $option ) {?> |
| [448](#L448) | <option value="<?php echo esc\_attr( $key );?>"><?php echo esc\_html( $option );?></option><?php |
| [449](#L449) | } |
| [450](#L450) | }?> |
| [451](#L451) | </select> |
| [452](#L452) | </div> |
| [453](#L453) | </div> |
| [454](#L454) | </div> |
| [455](#L455) |  |
| [456](#L456) | <div class="ep-box-col-12 ep-mt-3"> |
| [457](#L457) | <div class="ep-form-check"> |
| [458](#L458) | <input class="ep-form-check-input" type="checkbox" name="show\_ticket\_booking\_dates" value="1" id="ep\_show\_ticket\_booking\_dates"> |
| [459](#L459) | <label class="ep-form-check-label" for="ep\_show\_ticket\_booking\_dates"> |
| [460](#L460) | <?php esc\_html\_e( 'Show tickets availability dates on the frontend', 'eventprime-event-calendar-management');?> |
| [461](#L461) | </label> |
| [462](#L462) | </div> |
| [463](#L463) | </div> |
| [464](#L464) |  |
| [465](#L465) | <div class="ep-box-col-6 ep-mt-3"> |
| [466](#L466) | <label class="ep-form-check-label" for="ep\_min\_ticket\_no"> |
| [467](#L467) | <?php esc\_html\_e( 'Minimum Tickets Per Order', 'eventprime-event-calendar-management');?> |
| [468](#L468) | </label> |
| [469](#L469) | <input type="number" id="ep\_min\_ticket\_no" class="ep-form-control" min="0" name="min\_ticket\_no"> |
| [470](#L470) | <div class="ep-error-message" id="ep\_event\_ticket\_min\_ticket\_error"></div> |
| [471](#L471) | </div> |
| [472](#L472) |  |
| [473](#L473) | <div class="ep-box-col-6 ep-mt-3"> |
| [474](#L474) | <label class="ep-form-check-label" for="ep\_max\_ticket\_no"> |
| [475](#L475) | <?php esc\_html\_e( 'Maximum Tickets Per Order', 'eventprime-event-calendar-management');?> |
| [476](#L476) | </label> |
| [477](#L477) | <input type="number" id="ep\_max\_ticket\_no" class="ep-form-control" min="0" name="max\_ticket\_no"> |
| [478](#L478) | <div class="ep-error-message" id="ep\_event\_ticket\_max\_ticket\_error"></div> |
| [479](#L479) | </div> |
| [480](#L480) |  |
| [481](#L481) | <div class="ep-box-col-12 ep-mt-3"> |
| [482](#L482) | <label class="ep-form-check-label" for="ep-ticket-template"> |
| [483](#L483) | <?php esc\_html\_e( 'Tickets Template', 'eventprime-event-calendar-management');?> |
| [484](#L484) | </label> |
| [485](#L485) | <select id="ep-event-ticket-template" class="ep-form-control" name="em\_ticket\_template" disabled> |
| [486](#L486) | <?php do\_action( 'ep\_event\_get\_ticket\_template\_options' );?> |
| [487](#L487) | </select> |
| [488](#L488) | <div class="ep-text-muted ep-text-small"> |
| [489](#L489) | <?php esc\_html\_e( 'Templates allow you to design custom ticket styles which are sent to the users as PDF for printing.', 'eventprime-event-calendar-management'); |
| [490](#L490) | if( ! in\_array( 'Eventprime\_Event\_Tickets', $extensions ) ) { |
| [491](#L491) | echo '<br>'; |
| [492](#L492) | esc\_html\_e( 'To use ticket templates, please install', 'eventprime-event-calendar-management' );?> |
| [493](#L493) | <a href="<?php echo esc\_url( admin\_url('edit.php?post\_type=em\_event&page=ep-extensions') );?>" target="\_blank"><?php echo esc\_html( 'Event Tickets extension' );?></a><?php |
| [494](#L494) | }?> |
| [495](#L495) | </div> |
| [496](#L496) | </div> |
| [497](#L497) | <?php do\_action('em\_ticket\_additional\_fields');?> |
| [498](#L498) | </div> |
| [499](#L499) |  |
| [500](#L500) | <!-- Tabs --> |
| [501](#L501) | <div class="ep-box-row ep-p-3"> |
| [502](#L502) | <div class="ep-box-col-12 ep-mt-3"> |
| [503](#L503) | <div id="accordion" class="ep-accordion-wrap"> |
| [504](#L504) | <h3 class="ep-accordion-header-item"><?php esc\_html\_e( 'Visibility', 'eventprime-event-calendar-management');?></h3> |
| [505](#L505) | <div> |
| [506](#L506) | <div class="ep-box-row"> |
| [507](#L507) | <div class="ep-box-col-12 ep-mt-3"> |
| [508](#L508) | <label class="ep-form-label"><?php esc\_html\_e( 'Visible To', 'eventprime-event-calendar-management');?></label> |
| [509](#L509) | <select class="ep-form-control" name="em\_tickets\_user\_visibility" id="ep\_tickets\_user\_visibility"> |
| [510](#L510) | <option value="public"><?php esc\_html\_e( 'Everyone', 'eventprime-event-calendar-management');?></option> |
| [511](#L511) | <option value="all\_login"><?php esc\_html\_e( 'Logged In Users', 'eventprime-event-calendar-management');?></option> |
| [512](#L512) | <option value="user\_roles"><?php esc\_html\_e( 'Specific User Roles', 'eventprime-event-calendar-management');?></option> |
| [513](#L513) | <!-- <option value="user-groups">Logged In Users -> Group Members</option> --> |
| [514](#L514) | <?php do\_action("ep\_extend\_tic\_visibility\_option"); ?> |
| [515](#L515) | </select> |
| [516](#L516) | </div> |
| [517](#L517) |  |
| [518](#L518) | <div class="ep-box-col-12 ep-mt-3" id="ep\_ticket\_visibility\_user\_roles\_select" style="display:none;"> |
| [519](#L519) | <!-- <label class="ep-form-label"><?php esc\_html\_e( 'Roles', 'eventprime-event-calendar-management');?></label> --> |
| [520](#L520) | <select name="em\_ticket\_visibility\_user\_roles[]" id="ep\_ticket\_visibility\_user\_roles" multiple="multiple" class="ep-form-control ep\_user\_roles\_options"> |
| [521](#L521) | <?php foreach( $ep\_functions->ep\_get\_all\_user\_roles() as $key => $role ){?> |
| [522](#L522) | <option value="<?php echo esc\_attr( $key );?>"> |
| [523](#L523) | <?php echo esc\_html($role);?> |
| [524](#L524) | </option><?php |
| [525](#L525) | }?> |
| [526](#L526) | </select> |
| [527](#L527) | </div> |
| [528](#L528) |  |
| [529](#L529) | <?php do\_action("ep\_extend\_tic\_visibility\_sub\_option"); ?> |
| [530](#L530) |  |
| [531](#L531) | <div class="ep-box-col-12 ep-mt-3"> |
| [532](#L532) | <label><?php esc\_html\_e( 'For Ineligible Users', 'eventprime-event-calendar-management');?></label> |
| [533](#L533) | <div class="ep-form-check ep-mt-2"> |
| [534](#L534) | <input class="ep-form-check-input" type="radio" name="em\_ticket\_for\_invalid\_user" value="hidden" id="ep\_ticket\_for\_hidden\_user"> |
| [535](#L535) | <label class="ep-form-check-label" for="ep\_ticket\_for\_hidden\_user"> |
| [536](#L536) | <?php esc\_html\_e( 'Hide Tickets', 'eventprime-event-calendar-management');?> |
| [537](#L537) | </label> |
| [538](#L538) | </div> |
| [539](#L539) |  |
| [540](#L540) | <div class="ep-form-check"> |
| [541](#L541) | <input class="ep-form-check-input" type="radio" name="em\_ticket\_for\_invalid\_user" value="disabled" id="ep\_ticket\_for\_disabled\_user" checked> |
| [542](#L542) | <label class="ep-form-check-label" for="ep\_ticket\_for\_disabled\_user"> |
| [543](#L543) | <?php esc\_html\_e( 'Show Tickets as Disabled/ Greyed Out', 'eventprime-event-calendar-management');?> |
| [544](#L544) | </label> |
| [545](#L545) | </div> |
| [546](#L546) | </div> |
| [547](#L547) |  |
| [548](#L548) | </div> |
| [549](#L549) | </div> |
| [550](#L550) |  |
| [551](#L551) | <h3 class="ep-accordion-header-item"><?php esc\_html\_e( 'Offers', 'eventprime-event-calendar-management');?></h3> |
| [552](#L552) | <div> |
| [553](#L553) | <div class="ep-box-col-12 ep-my-3 ep-px-2"> |
| [554](#L554) | <strong><?php esc\_html\_e( 'Add New Offer', 'eventprime-event-calendar-management');?></strong> |
| [555](#L555) | </div> |
| [556](#L556) |  |
| [557](#L557) | <div class="ep-box-row ep-border ep-rounded ep-p-3 ep-m-2 ep-bg-light" id="ep\_event\_ticket\_offer\_wrapper"> |
| [558](#L558) | <div class="ep-box-col-12"> |
| [559](#L559) | <label class="ep-form-label"><?php esc\_html\_e( 'Name', 'eventprime-event-calendar-management');?></label> |
| [560](#L560) | <input type="text" class="ep-form-control" name="em\_ticket\_offer\_name" id="ep\_ticket\_offer\_name"> |
| [561](#L561) | <div class="ep-text-muted ep-text-small"> |
| [562](#L562) | <?php esc\_html\_e('Examples: Weekend Offer, Early-bird Discount etc. Offer name is visible on the frontend.', 'eventprime-event-calendar-management'); ?> |
| [563](#L563) | </div> |
| [564](#L564) | <div class="ep-error-message" id="ep\_event\_offer\_name\_error"></div> |
| [565](#L565) | </div> |
| [566](#L566) |  |
| [567](#L567) | <div class="ep-box-col-12 ep-mt-3"> |
| [568](#L568) | <label class="ep-form-label"><?php esc\_html\_e( 'Description', 'eventprime-event-calendar-management');?></label> |
| [569](#L569) | <textarea class="ep-form-control" name="em\_ticket\_offer\_description"></textarea> |
| [570](#L570) | <div class="ep-text-muted ep-text-small"> |
| [571](#L571) | <?php esc\_html\_e('Offer Description is visible on the frontend.', 'eventprime-event-calendar-management'); ?> |
| [572](#L572) | </div> |
| [573](#L573) | </div> |
| [574](#L574) |  |
| [575](#L575) | <div class="ep-box-col-12 ep-mt-3"> |
| [576](#L576) | <div class="ep-form-check ep-form-check-inline"> |
| [577](#L577) | <input class="ep-form-check-input" type="checkbox" name="em\_ticket\_show\_offer\_detail" value="1" id="show-offer-details"> |
| [578](#L578) | <label class="ep-form-check-label" for="show-offer-details"> |
| [579](#L579) | <?php esc\_html\_e( 'Show this offer in the offers section of the event', 'eventprime-event-calendar-management');?> |
| [580](#L580) | </label> |
| [581](#L581) | </div> |
| [582](#L582) | </div> |
| [583](#L583) |  |
| [584](#L584) | <div class="ep-box-col-6 ep-mt-3"> |
| [585](#L585) | <div class="ep-box-row" > |
| [586](#L586) | <div class="ep-box-col-12"> |
| [587](#L587) | <label class="ep-form-label"> |
| [588](#L588) | <?php esc\_html\_e( 'Offer Start', 'eventprime-event-calendar-management' );?> |
| [589](#L589) | </label> |
| [590](#L590) | <select class="ep-form-control ep\_offer\_start\_booking\_type" name="em\_offer\_start\_booking\_type"> |
| [591](#L591) | <option value="custom\_date"><?php esc\_html\_e( 'Custom Date', 'eventprime-event-calendar-management' );?></option> |
| [592](#L592) | <option value="event\_date"><?php esc\_html\_e( 'Event Date', 'eventprime-event-calendar-management' );?></option> |
| [593](#L593) | <option value="relative\_date"><?php esc\_html\_e( 'Relative Date', 'eventprime-event-calendar-management' );?></option> |
| [594](#L594) | </select> |
| [595](#L595) | </div> |
| [596](#L596) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_start\_booking\_options ep\_offer\_start\_booking\_custom\_date"> |
| [597](#L597) | <label class="ep-form-label"> |
| [598](#L598) | <?php esc\_html\_e( 'Choose Date', 'eventprime-event-calendar-management' );?> |
| [599](#L599) | </label> |
| [600](#L600) | <input type="text" class="ep-form-control ep\_metabox\_custom\_date\_picker" name="em\_offer\_start\_booking\_date" id="ep\_offer\_start\_booking\_date" data-start="booking\_start" data-end="booking\_end"> |
| [601](#L601) | </div> |
| [602](#L602) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_start\_booking\_options ep\_offer\_start\_booking\_custom\_date"> |
| [603](#L603) | <label class="ep-form-label"> |
| [604](#L604) | <?php esc\_html\_e( 'Choose Time', 'eventprime-event-calendar-management' );?> |
| [605](#L605) | </label> |
| [606](#L606) | <input type="text" class="ep-form-control epTimePicker" name="em\_offer\_start\_booking\_time" id="ep\_offer\_start\_booking\_time"> |
| [607](#L607) | </div> |
| [608](#L608) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_start\_booking\_options ep\_offer\_start\_booking\_relative\_date" style="display:none;"> |
| [609](#L609) | <label class="ep-form-label"> |
| [610](#L610) | <?php esc\_html\_e( 'Enter Days', 'eventprime-event-calendar-management' );?> |
| [611](#L611) | </label> |
| [612](#L612) | <input type="number" class="ep-form-control" name="em\_offer\_start\_booking\_days" min="0"> |
| [613](#L613) | </div> |
| [614](#L614) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_start\_booking\_options ep\_offer\_start\_booking\_relative\_date" style="display:none;"> |
| [615](#L615) | <label class="ep-form-label"> |
| [616](#L616) | <?php esc\_html\_e( 'Days Option', 'eventprime-event-calendar-management' );?> |
| [617](#L617) | </label> |
| [618](#L618) | <select class="ep-form-control" name="em\_offer\_start\_booking\_days\_option"> |
| [619](#L619) | <option value="before"><?php esc\_html\_e( 'Days Before', 'eventprime-event-calendar-management');?></option> |
| [620](#L620) | <option value="after"><?php esc\_html\_e( 'Days After', 'eventprime-event-calendar-management');?></option> |
| [621](#L621) | </select> |
| [622](#L622) | </div> |
| [623](#L623) | <div class="ep-box-col-12 ep-mt-3 ep\_offer\_start\_booking\_options ep\_offer\_start\_booking\_event\_date ep\_offer\_start\_booking\_relative\_date" style="display:none;"> |
| [624](#L624) | <label class="ep-form-label"> |
| [625](#L625) | <?php esc\_html\_e( 'Event Option', 'eventprime-event-calendar-management' );?> |
| [626](#L626) | </label> |
| [627](#L627) | <select class="ep-form-control" name="em\_offer\_start\_booking\_event\_option"> |
| [628](#L628) | <?php $existing\_cat\_data = $ep\_functions->get\_ticket\_booking\_event\_date\_options( $post->ID ); |
| [629](#L629) | if( ! empty( $existing\_cat\_data ) ) { |
| [630](#L630) | foreach( $existing\_cat\_data as $key => $option ) {?> |
| [631](#L631) | <option value="<?php echo esc\_attr( $key );?>"><?php echo esc\_html( $option );?></option><?php |
| [632](#L632) | } |
| [633](#L633) | }?> |
| [634](#L634) | </select> |
| [635](#L635) | </div> |
| [636](#L636) | </div> |
| [637](#L637) | </div> |
| [638](#L638) | <div class="ep-box-col-6 ep-mt-3"> |
| [639](#L639) | <div class="ep-box-row"> |
| [640](#L640) | <div class="ep-box-col-12"> |
| [641](#L641) | <label class="ep-form-label"> |
| [642](#L642) | <?php esc\_html\_e( 'Offer Ends', 'eventprime-event-calendar-management' );?> |
| [643](#L643) | </label> |
| [644](#L644) | <select class="ep-form-control ep\_offer\_ends\_booking\_type" name="em\_offer\_ends\_booking\_type"> |
| [645](#L645) | <option value="custom\_date"><?php esc\_html\_e( 'Custom Date', 'eventprime-event-calendar-management' );?></option> |
| [646](#L646) | <option value="event\_date"><?php esc\_html\_e( 'Event Date', 'eventprime-event-calendar-management' );?></option> |
| [647](#L647) | <option value="relative\_date"><?php esc\_html\_e( 'Relative Date', 'eventprime-event-calendar-management' );?></option> |
| [648](#L648) | </select> |
| [649](#L649) | </div> |
| [650](#L650) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_ends\_booking\_options ep\_offer\_ends\_booking\_custom\_date"> |
| [651](#L651) | <label class="ep-form-label"> |
| [652](#L652) | <?php esc\_html\_e( 'Choose Date', 'eventprime-event-calendar-management' );?> |
| [653](#L653) | </label> |
| [654](#L654) | <input type="text" class="ep-form-control ep\_metabox\_custom\_date\_picker" name="em\_offer\_ends\_booking\_date" id="ep\_offer\_ends\_booking\_date" data-start="booking\_start" data-end="booking\_end"> |
| [655](#L655) | </div> |
| [656](#L656) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_ends\_booking\_options ep\_offer\_ends\_booking\_custom\_date"> |
| [657](#L657) | <label class="ep-form-label"> |
| [658](#L658) | <?php esc\_html\_e( 'Choose Time', 'eventprime-event-calendar-management' );?> |
| [659](#L659) | </label> |
| [660](#L660) | <input type="text" class="ep-form-control epTimePicker" name="em\_offer\_ends\_booking\_time" id="ep\_offer\_ends\_booking\_time"> |
| [661](#L661) | </div> |
| [662](#L662) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_ends\_booking\_options ep\_offer\_ends\_booking\_relative\_date" style="display:none;"> |
| [663](#L663) | <label class="ep-form-label"> |
| [664](#L664) | <?php esc\_html\_e( 'Enter Days', 'eventprime-event-calendar-management' );?> |
| [665](#L665) | </label> |
| [666](#L666) | <input type="number" class="ep-form-control" name="em\_offer\_ends\_booking\_days" min="0"> |
| [667](#L667) | </div> |
| [668](#L668) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_ends\_booking\_options ep\_offer\_ends\_booking\_relative\_date" style="display:none;"> |
| [669](#L669) | <label class="ep-form-label"> |
| [670](#L670) | <?php esc\_html\_e( 'Days Option', 'eventprime-event-calendar-management' );?> |
| [671](#L671) | </label> |
| [672](#L672) | <select class="ep-form-control" name="em\_offer\_ends\_booking\_days\_option"> |
| [673](#L673) | <option value="before"><?php esc\_html\_e( 'Days Before', 'eventprime-event-calendar-management');?></option> |
| [674](#L674) | <option value="after"><?php esc\_html\_e( 'Days After', 'eventprime-event-calendar-management');?></option> |
| [675](#L675) | </select> |
| [676](#L676) | </div> |
| [677](#L677) | <div class="ep-box-col-12 ep-mt-3 ep\_offer\_ends\_booking\_options ep\_offer\_ends\_booking\_event\_date ep\_offer\_ends\_booking\_relative\_date" style="display:none;"> |
| [678](#L678) | <label class="ep-form-label"> |
| [679](#L679) | <?php esc\_html\_e( 'Event Option', 'eventprime-event-calendar-management' );?> |
| [680](#L680) | </label> |
| [681](#L681) | <select class="ep-form-control" name="em\_offer\_ends\_booking\_event\_option"> |
| [682](#L682) | <?php $existing\_cat\_data = $ep\_functions->get\_ticket\_booking\_event\_date\_options( $post->ID ); |
| [683](#L683) | if( ! empty( $existing\_cat\_data ) ) { |
| [684](#L684) | foreach( $existing\_cat\_data as $key => $option ) {?> |
| [685](#L685) | <option value="<?php echo esc\_attr( $key );?>"><?php echo esc\_html( $option );?></option><?php |
| [686](#L686) | } |
| [687](#L687) | }?> |
| [688](#L688) | </select> |
| [689](#L689) | </div> |
| [690](#L690) | </div> |
| [691](#L691) | </div> |
| [692](#L692) |  |
| [693](#L693) | <div class="ep-box-col-6 ep-mt-3"> |
| [694](#L694) | <label class="ep-form-label"><?php esc\_html\_e( 'Offer Type', 'eventprime-event-calendar-management');?></label> |
| [695](#L695) | <select id="ep\_ticket\_offer\_type" class="ep-form-control" name="em\_ticket\_offer\_type"> |
| [696](#L696) | <option value="seat\_based"><?php esc\_html\_e( 'Admittance Based', 'eventprime-event-calendar-management');?></option> |
| [697](#L697) | <option value="role\_based"><?php esc\_html\_e( 'User Role Based', 'eventprime-event-calendar-management');?></option> |
| [698](#L698) | <option value="volume\_based"><?php esc\_html\_e( 'Volume Based', 'eventprime-event-calendar-management');?></option> |
| [699](#L699) | <?php do\_action("ep\_extend\_tic\_offer\_option"); ?> |
| [700](#L700) | </select> |
| [701](#L701) | </div> |
| [702](#L702) |  |
| [703](#L703) | <div class="ep-box-col-6 ep-mt-3"> |
| [704](#L704) | <div class="ep-box-row"> |
| [705](#L705) | <div class="ep-box-col-12 offer-fields ep-seat-based-offer-wrapper" id="ep\_ticket\_offer\_seat\_based"> |
| [706](#L706) | <div class="ep-box-row"> |
| [707](#L707) | <div class="ep-box-col-6"> |
| [708](#L708) | <label class="ep-form-label"><?php esc\_html\_e( 'Select Admittance Order', 'eventprime-event-calendar-management');?></label> |
| [709](#L709) | <select class="ep-form-control" name="em\_ticket\_offer\_seat\_option"> |
| [710](#L710) | <option value=""><?php esc\_html\_e( 'Select Option', 'eventprime-event-calendar-management');?></option> |
| [711](#L711) | <option value="first"><?php esc\_html\_e( 'First', 'eventprime-event-calendar-management');?></option> |
| [712](#L712) | <option value="last"><?php esc\_html\_e( 'Last', 'eventprime-event-calendar-management');?></option> |
| [713](#L713) | </select> |
| [714](#L714) | </div> |
| [715](#L715) | <div class="ep-box-col-6"> |
| [716](#L716) | <label class="ep-form-label"><?php esc\_html\_e( 'Enter Number', 'eventprime-event-calendar-management');?></label> |
| [717](#L717) | <input type="number" min="0" class="ep-form-control" name="em\_ticket\_offer\_seat\_number" placeholder="<?php esc\_html\_e( 'Count', 'eventprime-event-calendar-management');?>"> |
| [718](#L718) | </div> |
| [719](#L719) |  |
| [720](#L720) | </div> |
| [721](#L721) | </div> |
| [722](#L722) |  |
| [723](#L723) | <div class="offer-fields ep-box-col-12" id="ep\_ticket\_offer\_role\_based" style="display: none;"> |
| [724](#L724) | <label class="ep-form-label"><?php esc\_html\_e( 'Select Roles', 'eventprime-event-calendar-management');?></label> |
| [725](#L725) | <select name="em\_ticket\_offer\_user\_roles" id="em\_ticket\_offer\_user\_roles" multiple="multiple" class="ep-form-control ep\_user\_roles\_options"> |
| [726](#L726) | <?php foreach( $ep\_functions->ep\_get\_all\_user\_roles() as $key => $role ){?> |
| [727](#L727) | <option value="<?php echo esc\_attr( $key );?>"> |
| [728](#L728) | <?php echo esc\_html($role);?> |
| [729](#L729) | </option><?php |
| [730](#L730) | }?> |
| [731](#L731) | </select> |
| [732](#L732) | </div> |
| [733](#L733) |  |
| [734](#L734) | <div class="offer-fields ep-box-col-12" id="ep\_ticket\_offer\_volume\_based" style="display: none;"> |
| [735](#L735) | <label class="ep-form-label"><?php esc\_html\_e( 'Enter Number', 'eventprime-event-calendar-management');?></label> |
| [736](#L736) | <input type="number" class="ep-form-control" name="em\_ticket\_offer\_volumn\_count" placeholder="<?php esc\_html\_e( 'Minimum Number of Tickets', 'eventprime-event-calendar-management');?>"> |
| [737](#L737) | </div> |
| [738](#L738) |  |
| [739](#L739) | <?php do\_action("ep\_extend\_tic\_offer\_sub\_option"); ?> |
| [740](#L740) |  |
| [741](#L741) | </div> |
| [742](#L742) | </div> |
| [743](#L743) |  |
| [744](#L744) | <div class="ep-box-col-6 ep-mt-3" id="ep\_offer\_discount\_type"> |
| [745](#L745) | <label class="ep-form-label"> |
| [746](#L746) | <?php esc\_html\_e( 'Select Discount Type', 'eventprime-event-calendar-management' );?> |
| [747](#L747) | </label> |
| [748](#L748) | <select class="ep-form-control" name="em\_ticket\_offer\_discount\_type" id="ep\_ticket\_offer\_discount\_type"> |
| [749](#L749) | <option value=""><?php esc\_html\_e( 'Select Discount Type', 'eventprime-event-calendar-management');?></option> |
| [750](#L750) | <option value="flat"><?php esc\_html\_e( 'Flat Discount', 'eventprime-event-calendar-management');?></option> |
| [751](#L751) | <option value="percentage"><?php esc\_html\_e( 'Percentage', 'eventprime-event-calendar-management');?></option> |
| [752](#L752) | </select> |
| [753](#L753) | <div class="ep-error-message" id="ep\_ticket\_offer\_discount\_type\_error"></div> |
| [754](#L754) | </div> |
| [755](#L755) |  |
| [756](#L756) | <div class="ep-box-col-6 ep-mt-3" id="ep\_offer\_discount"> |
| [757](#L757) | <label class="ep-form-label"> |
| [758](#L758) | <?php esc\_html\_e( 'Enter Discount', 'eventprime-event-calendar-management' );?> |
| [759](#L759) | </label> |
| [760](#L760) | <input type="number" min="0" class="ep-form-control" name="em\_ticket\_offer\_discount" id="ep\_ticket\_offer\_discount" placeholder="<?php esc\_html\_e( 'Enter Discount', 'eventprime-event-calendar-management');?>"> |
| [761](#L761) | <div class="ep-error-message" id="ep\_ticket\_offer\_discount\_error"></div> |
| [762](#L762) | </div> |
| [763](#L763) |  |
| [764](#L764) | <div class="ep-box-col-12 ep-mt-3"> |
| [765](#L765) | <button type="button" class="button button-primary button-large" id="ep\_ticket\_add\_offer"><?php esc\_html\_e( 'Add Offer', 'eventprime-event-calendar-management');?></button> |
| [766](#L766) | <div class="ep-error-message ep-lh-lg ep-mt-3" id="ep\_ticket\_offer\_not\_save\_error"></div> |
| [767](#L767) | </div> |
| [768](#L768) |  |
| [769](#L769) | </div> |
| [770](#L770) |  |
| [771](#L771) | <div class="ep-box-row ep-my-4 ep-mx-0"> |
| [772](#L772) | <div class="ep-box-col-6"> |
| [773](#L773) | <label class="ep-form-label"><?php esc\_html\_e( 'How to Handle Multiple Offers?', 'eventprime-event-calendar-management');?></label> |
| [774](#L774) | <select class="ep-form-control" name="multiple\_offers\_option" id="em\_multiple\_offers\_option"> |
| [775](#L775) | <option value="stack\_offers"><?php esc\_html\_e( 'Stack offers', 'eventprime-event-calendar-management');?></option> |
| [776](#L776) | <option value="first\_offer"><?php esc\_html\_e( 'First one that applies', 'eventprime-event-calendar-management');?></option> |
| [777](#L777) | </select> |
| [778](#L778) | </div> |
| [779](#L779) | <div class="ep-box-col-6"> |
| [780](#L780) | <label class="form-label"><?php esc\_html\_e( 'Max Cumulative Discount', 'eventprime-event-calendar-management');?></label> |
| [781](#L781) | <input type="number" min="0" class="ep-form-control" name="multiple\_offers\_max\_discount" id="em\_multiple\_offers\_max\_discount"> |
| [782](#L782) | </div> |
| [783](#L783) | </div> |
| [784](#L784) |  |
| [785](#L785) | <div class="ep-box-row ep-mt-4" id="ep\_ticket\_offers\_wrapper" style="display: none;"> |
| [786](#L786) | <div class="ep-box-col-12 ep-my-3"> |
| [787](#L787) | <strong><?php esc\_html\_e( 'Added Offers', 'eventprime-event-calendar-management');?></strong> |
| [788](#L788) | </div> |
| [789](#L789) | <input type="hidden" name="offers" id="ep\_event\_ticket\_offers" value="" /> |
| [790](#L790) | <div class="ep-box-col-12" id="ep\_existing\_offers\_list"></div> |
| [791](#L791) | </div> |
| [792](#L792) | </div> |
| [793](#L793) | </div> |
| [794](#L794) | </div> |
| [795](#L795) | </div> |
| [796](#L796) |  |
| [797](#L797) | <!-- Modal Wrap  End --> |
| [798](#L798) | <div class="ep-modal-footer ep-mt-3 ep-d-flex ep-items-end ep-content-right"> |
| [799](#L799) | <button type="button" class="button ep-mr-3 ep-modal-close close-popup" data-id="ep\_event\_ticket\_tier\_modal"><?php esc\_html\_e( 'Close', 'eventprime-event-calendar-management');?></button> |
| [800](#L800) | <button type="button" class="button button-primary button-large" id="ep\_save\_ticket\_tier"><?php esc\_html\_e( 'Save changes', 'eventprime-event-calendar-management');?></button> |
| [801](#L801) | </div> |
| [802](#L802) | </div> |
| [803](#L803) | </div> |
| [804](#L804) | </div> |
| [805](#L805) | </div> |
| [806](#L806) | <!-- Add  Ticket Tier Modal End --> |
| [807](#L807) | <input type="hidden" name="ep\_event\_has\_ticket" id="ep\_event\_has\_ticket" value="<?php echo absint( $event\_has\_ticket );?>" > |
| [808](#L808) |  |
| [809](#L809) | <?php do\_action( 'ep\_event\_after\_admin\_tickets\_section' );?> |
| [810](#L810) | <?php if( empty( $show\_message ) ) {?> |
| [811](#L811) | <div class="ep-box-row ep-p-3" id="ep\_event\_booking\_disabled\_warning" style="display: none;"> |
| [812](#L812) | <div class="ep-alert ep-alert-warning ep-mt-3 ep-py-2"> |
| [813](#L813) | <strong><?php esc\_html\_e( 'The event booking is not enabled.', 'eventprime-event-calendar-management' ); ?></strong> |
| [814](#L814) | </div> |
| [815](#L815) | </div><?php |
| [816](#L816) | }?> |
| [817](#L817) | </div> |
| [818](#L818) | </div> |
| [819](#L819) |  |
| [820](#L820) | <div id="ep\_event\_booking\_turn\_off\_modal" class="ep-modal-view" style="display: none;"> |
| [821](#L821) | <div class="ep-modal-overlay ep-modal-overlay-fade-in close-popup" data-id="ep\_event\_booking\_turn\_off\_modal"></div> |
| [822](#L822) | <div class="popup-content ep-modal-wrap ep-modal-sm ep-modal-out"> |
| [823](#L823) | <div class="ep-modal-body"> |
| [824](#L824) | <div class="ep-modal-titlebar ep-d-flex ep-items-center"> |
| [825](#L825) | <h3 class="ep-modal-title ep-px-3"> |
| [826](#L826) | <?php esc\_html\_e( 'No ticket found', 'eventprime-event-calendar-management' ); ?> |
| [827](#L827) | </h3> |
| [828](#L828) | <a href="#" class="ep-modal-close close-popup" data-id="ep\_event\_booking\_turn\_off\_modal">&times;</a> |
| [829](#L829) | </div> |
| [830](#L830) | <div class="ep-modal-content-wrap"> |
| [831](#L831) | <div class="ep-box-wrap"> |
| [832](#L832) | <div class="ep-box-row ep-p-3 ep-box-w-75 ep-event-booking-field-manager"> |
| [833](#L833) | <div class="ep-box-col-12 form-field"> |
| [834](#L834) | <?php esc\_html\_e( 'You have not added any tickets for this event. Therefore, bookings for this event will be turned off.', 'eventprime-event-calendar-management' );?> |
| [835](#L835) | </div> |
| [836](#L836) | </div> |
| [837](#L837) | </div> |
| [838](#L838) | <div class="ep-modal-footer ep-mt-3 ep-d-flex ep-items-end ep-content-right" id="ep\_modal\_buttonset"> |
| [839](#L839) | <span class="spinner ep-mr-2 ep-mb-2 ep-text-end" id="ep\_event\_booking\_turn\_off\_loader"></span> |
| [840](#L840) | <button type="button" class="button ep-mr-3 ep-modal-close close-popup" data-id="ep\_event\_booking\_turn\_off\_modal" id="ep\_event\_booking\_turn\_off\_cancel" title="<?php echo esc\_attr( 'Cancel', 'eventprime-event-calendar-management' ); ?>"><?php esc\_html\_e('Cancel', 'eventprime-event-calendar-management'); ?></button> |
| [841](#L841) | <button type="button" class="button button-primary button-large" id="ep\_event\_booking\_turn\_off\_continue" title="<?php echo esc\_attr( 'Turn Off Booking', 'eventprime-event-calendar-management' ); ?>"><?php esc\_html\_e('Turn Off Booking', 'eventprime-event-calendar-management'); ?></button> |
| [842](#L842) | </div> |
| [843](#L843) | </div> |
| [844](#L844) | </div> |
| [845](#L845) | </div> |
| [846](#L846) | </div> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php?format=txt)
* [Original Format](/export/3222464/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_29860a7a_20250114_200705.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Feventprime-event-calendar-management%2Ftags%2F4.0.5.3%2Fadmin%2Fpartials%2Fmetaboxes%2Fmeta-box-tickets-panel-html.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php)

---

# [source:](/browser?order=name "Go to repository root") [eventprime-event-calendar-management](/browser/eventprime-event-calendar-management?order=name "View eventprime-event-calendar-management")/[tags](/browser/eventprime-event-calendar-management/tags?order=name "View tags")/[4.0.5.3](/browser/eventprime-event-calendar-management/tags/4.0.5.3?order=name "View 4.0.5.3")/[admin](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin?order=name "View admin")/[partials](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials?order=name "View partials")/[metaboxes](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes?order=name "View metaboxes")/[meta-box-tickets-panel-html.php](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php?order=name "View meta-box-tickets-panel-html.php")

View diff against:

View revision:

| [Last change](/changeset/3199413/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php "View differences") on this file was [3199413](/changeset/3199413/ "View changeset 3199413"), checked in by metagauss, [7 weeks ago](/timeline?from=2024-11-29T11%3A51%3A04Z&precision=second "See timeline at 11/29/2024 11:51:04 AM") |
| --- |
| Tag 4.0.5.3 |
| **File size:** 73.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Event tickets panel html |
| [4](#L4) | \*/ |
| [5](#L5) | defined( 'ABSPATH' ) || exit; |
| [6](#L6) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [7](#L7) | $em\_enable\_booking = get\_post\_meta( $post->ID, 'em\_enable\_booking', true ); |
| [8](#L8) | $extensions = $ep\_functions->ep\_get\_activate\_extensions(); |
| [9](#L9) | $show\_tickets = $show\_message = ''; |
| [10](#L10) | $event\_has\_ticket = 0; |
| [11](#L11) | $is\_event\_expired = $ep\_functions->check\_event\_has\_expired( $single\_event\_data );?> |
| [12](#L12) | <div id="ep\_event\_ticket\_data" class="panel ep\_event\_options\_panel"> |
| [13](#L13) | <div class="ep-box-wrap"> |
| [14](#L14) | <?php if( $is\_event\_expired ) { |
| [15](#L15) | $show\_tickets = '';$show\_message = 1;?> |
| [16](#L16) | <div class="ep-box-row ep-p-3" id="ep\_show\_event\_expire\_warning"> |
| [17](#L17) | <div class="ep-alert ep-alert-warning ep-mt-3 ep-py-2"> |
| [18](#L18) | <strong><?php esc\_html\_e( 'This event has ended.', 'eventprime-event-calendar-management' ); ?></strong> |
| [19](#L19) | </div> |
| [20](#L20) | </div><?php |
| [21](#L21) | } |
| [22](#L22) | if( empty( $single\_event\_data->em\_enable\_booking ) || $single\_event\_data->em\_enable\_booking !== 'bookings\_on' ) { |
| [23](#L23) | $show\_tickets = '';$show\_message = 1;?> |
| [24](#L24) | <div class="ep-box-row ep-p-3" id="ep\_event\_booking\_not\_enabled\_warning"> |
| [25](#L25) | <div class="ep-alert ep-alert-warning ep-mt-3 ep-py-2"> |
| [26](#L26) | <strong><?php esc\_html\_e( 'The event booking is not enabled.', 'eventprime-event-calendar-management' ); ?></strong> |
| [27](#L27) | </div> |
| [28](#L28) | </div><?php |
| [29](#L29) | } |
| [30](#L30) | if( empty( $show\_tickets ) ) { |
| [31](#L31) | $show\_tickets = 'style=display:none;'; |
| [32](#L32) | }?> |
| [33](#L33) |  |
| [34](#L34) | <!-- Ticket Options Buttons Area --> |
| [35](#L35) | <div id="ep-event-tickets-options" <?php echo esc\_attr( $show\_tickets );?>> |
| [36](#L36) | <div class="ep-box-row ep-p-3"> |
| [37](#L37) | <div class="ep-box-col-12 ep-d-flex ep-content-center"> |
| [38](#L38) | <button type="button" class="button button-large ep-m-3 ep-open-modal"  data-id="ep-ticket-category-modal" id="ep\_event\_open\_category\_modal" title="<?php esc\_html\_e( 'Add Tickets Category', 'eventprime-event-calendar-management' );?>"> |
| [39](#L39) | <?php esc\_html\_e( 'Add Tickets Category', 'eventprime-event-calendar-management' );?> |
| [40](#L40) | </button> |
| [41](#L41) | <button type="button" class="button button-large ep-m-3 ep-open-modal" data-id="ep\_event\_ticket\_tier\_modal" id="ep\_event\_open\_ticket\_modal" title="<?php esc\_html\_e( 'Add Tickets', 'eventprime-event-calendar-management' );?>"> |
| [42](#L42) | <?php esc\_html\_e( 'Add Ticket Type', 'eventprime-event-calendar-management' );?> |
| [43](#L43) | </button> |
| [44](#L44) | </div> |
| [45](#L45) | <!--Existing Tickets--> |
| [46](#L46) | <div id="ep\_existing\_tickets\_category\_list" class="ep\_existing\_tickets\_category\_list ep-box-col-12"> |
| [47](#L47) | <?php |
| [48](#L48) | $existing\_cat\_data = $ep\_functions->get\_existing\_category\_lists( $post->ID ); |
| [49](#L49) | $ep\_ticket\_category\_data = ( ! empty( $existing\_cat\_data ) ? wp\_json\_encode($existing\_cat\_data) : '' );?> |
| [50](#L50) | <input type="hidden" name="em\_ticket\_category\_data" id="ep\_ticket\_category\_data" value="<?php echo esc\_attr( $ep\_ticket\_category\_data );?>" /> |
| [51](#L51) | <input type="hidden" name="em\_ticket\_category\_delete\_ids" id="ep\_ticket\_category\_delete\_ids" value="" /> |
| [52](#L52) |  |
| [53](#L53) | <div class="ep-box-row ep-p-3" id="ep\_existing\_tickets\_list"> |
| [54](#L54) | <?php if( !empty( $existing\_cat\_data ) && count( $existing\_cat\_data ) > 0 ) { |
| [55](#L55) | foreach( $existing\_cat\_data as $key => $cat\_data ) { |
| [56](#L56) | $cat\_row\_data = wp\_json\_encode($cat\_data); |
| [57](#L57) | $row\_key = $key + 1; |
| [58](#L58) | $cat\_row\_id = 'ep\_ticket\_cat\_section'. $row\_key; ?> |
| [59](#L59) | <div class="ep-box-col-12 ep-p-3 ep-border ep-rounded ep-mb-3 ep-bg-white ep-shadow-sm ui-state-default ep-cat-list-class" id="<?php echo esc\_attr( $cat\_row\_id );?>" data-cat\_row\_data="<?php echo esc\_attr( $cat\_row\_data );?>"> |
| [60](#L60) | <div class="ep-box-row ep-mb-3 ep-items-center"> |
| [61](#L61) | <div class="ep-box-col-1"> |
| [62](#L62) | <span class="ep-ticket-cat-sort material-icons ep-cursor-move text-muted" data-parent\_id="<?php echo esc\_attr( $cat\_row\_id );?>" >drag\_indicator</span> |
| [63](#L63) | </div> |
| [64](#L64) | <div class="ep-box-col-5"> |
| [65](#L65) | <h4 class="ep-cat-name"><?php echo esc\_html( $cat\_data->name );?></h4> |
| [66](#L66) | </div> |
| [67](#L67) | <div class="ep-box-col-4"> |
| [68](#L68) | <h4 class="ep-cat-capacity"> |
| [69](#L69) | <?php echo esc\_html\_\_( 'Capacity', 'eventprime-event-calendar-management' ) . ': '. esc\_html( $cat\_data->capacity );?> |
| [70](#L70) | </h4> |
| [71](#L71) | </div> |
| [72](#L72) | <div class="ep-box-col-1"> |
| [73](#L73) | <a href="javascript:void(0)" class="ep-ticket-cat-edit ep-text-primary" data-parent\_id="<?php echo esc\_attr( $cat\_row\_id );?>" title="<?php esc\_html\_e( 'Edit Category', 'eventprime-event-calendar-management' );?>"><?php esc\_html\_e( 'Edit', 'eventprime-event-calendar-management' );?></a> |
| [74](#L74) | </div> |
| [75](#L75) | <div class="ep-box-col-1"> |
| [76](#L76) | <a href="javascript:void(0)" class="ep-ticket-cat-delete ep-item-delete" data-parent\_id="<?php echo esc\_attr( $cat\_row\_id );?>" title="<?php esc\_html\_e( 'Delete Category', 'eventprime-event-calendar-management' );?>"><?php esc\_html\_e( 'Delete', 'eventprime-event-calendar-management' );?></a> |
| [77](#L77) | </div> |
| [78](#L78) | </div> |
| [79](#L79) |  |
| [80](#L80) | <div class="ep-ticket-category-section" data-parent\_category\_id="<?php echo esc\_attr( $row\_key );?>"> |
| [81](#L81) | <?php |
| [82](#L82) | $existing\_cat\_ticket\_data = $ep\_functions->get\_existing\_category\_ticket\_lists( $post->ID, $cat\_data->id ); |
| [83](#L83) | if( !empty( $existing\_cat\_ticket\_data ) ) { |
| [84](#L84) | $tic\_row = 1;$event\_has\_ticket = 1; |
| [85](#L85) | foreach( $existing\_cat\_ticket\_data as $ticket ) { |
| [86](#L86) | $icon\_url = ''; |
| [87](#L87) | if( ! empty( $ticket->icon ) ) { |
| [88](#L88) | $icon\_url = wp\_get\_attachment\_url( $ticket->icon ); |
| [89](#L89) | } |
| [90](#L90) | $ticket->icon\_url = $icon\_url; |
| [91](#L91) | $ticket\_row\_data = wp\_json\_encode( $ticket ); |
| [92](#L92) | $ticket\_row\_id = ''; |
| [93](#L93) | $ticket\_row\_id = 'ep\_cat\_' . $row\_key . '\_ticket' . $tic\_row;?> |
| [94](#L94) | <div class="ep-box-row ep-tickets-cate-ticket-row" id="<?php echo esc\_attr( $ticket\_row\_id );?>" data-ticket\_row\_data="<?php echo esc\_attr( $ticket\_row\_data );?>"> |
| [95](#L95) | <div class="ep-box-col-12"> |
| [96](#L96) | <div class="ep-box-row ep-border ep-rounded ep-ml-2 ep-my-1 ep-mr-2 ep-bg-white ep-items-center ui-state-default"> |
| [97](#L97) | <div class="ep-box-col-1 ep-p-3"> |
| [98](#L98) | <span class="ep-ticket-row-sort material-icons ep-cursor-move ep-text-muted" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>">drag\_indicator</span> |
| [99](#L99) | </div> |
| [100](#L100) | <div class="ep-box-col-3 ep-p-3"> |
| [101](#L101) | <?php echo esc\_html( $ticket->name );?> |
| [102](#L102) | </div> |
| [103](#L103) | <div class="ep-box-col-2 ep-p-3"> |
| [104](#L104) | <span><?php echo esc\_html( $ep\_functions->ep\_price\_with\_position( $ticket->price ) );?></span> |
| [105](#L105) | </div> |
| [106](#L106) | <div class="ep-box-col-3 ep-p-3"> |
| [107](#L107) | <span> |
| [108](#L108) | <?php echo esc\_html\_\_( 'Capacity', 'eventprime-event-calendar-management' ) . ' ' . esc\_html( $ticket->capacity ) . '/' . esc\_html( $cat\_data->capacity );?> |
| [109](#L109) | </span> |
| [110](#L110) | </div> |
| [111](#L111) | <?php do\_action( 'ep\_event\_tickets\_action\_icons', $post->ID, $ticket->id );?> |
| [112](#L112) | <div class="ep-box-col-1 ep-p-3"> |
| [113](#L113) | <a href="javascript:void(0)" class="ep-ticket-row-edit ep-text-primary ep-cursor" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>" data-parent\_category\_id="<?php echo esc\_attr( $cat\_row\_id );?>" title="<?php esc\_html\_e( 'Edit Ticket', 'eventprime-event-calendar-management' );?>">Edit</a> |
| [114](#L114) | </div> |
| [115](#L115) | <div class="ep-box-col-1 ep-p-3"> |
| [116](#L116) | <span class="ep-ticket-row-delete ep-text-danger ep-cursor" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>" title="<?php esc\_html\_e( 'Delete Ticket', 'eventprime-event-calendar-management' );?>">Delete</span> |
| [117](#L117) | </div> |
| [118](#L118) | </div> |
| [119](#L119) | </div> |
| [120](#L120) | </div><?php |
| [121](#L121) | $tic\_row++; |
| [122](#L122) | } |
| [123](#L123) | }?> |
| [124](#L124) | </div><?php |
| [125](#L125) | $total\_caps = $ep\_functions->get\_category\_tickets\_capacity( $existing\_cat\_ticket\_data ); |
| [126](#L126) | if( $total\_caps < $cat\_data->capacity ){?> |
| [127](#L127) | <div class="ep\_category\_add\_tickets\_button" id="ep\_category\_add\_tickets\_button\_<?php echo esc\_attr( $cat\_row\_id );?>"> |
| [128](#L128) | <button type="button" class="button button-large ep-m-3 ep-open-category-ticket-modal" data-id="ep\_event\_ticket\_tier\_modal" data-parent\_id="<?php echo esc\_attr( $cat\_row\_id );?>"><?php esc\_html\_e( 'Add Tickets', 'eventprime-event-calendar-management' );?></button> |
| [129](#L129) | </div><?php |
| [130](#L130) | }?> |
| [131](#L131) | </div><?php |
| [132](#L132) | } |
| [133](#L133) | }?> |
| [134](#L134) | </div> |
| [135](#L135) | </div> |
| [136](#L136) | <div id="ep\_existing\_individual\_tickets\_list"> |
| [137](#L137) | <input type="hidden" name="ep\_ticket\_order\_arr" id="ep\_ticket\_order\_arr" value="" /> |
| [138](#L138) | <?php $get\_existing\_individual\_ticket\_lists = $ep\_functions->get\_existing\_individual\_ticket\_lists( $post->ID ); |
| [139](#L139) | $ep\_ticket\_data = ( ! empty( $get\_existing\_individual\_ticket\_lists ) ? $get\_existing\_individual\_ticket\_lists : array() ); |
| [140](#L140) | //$em\_ticket\_individual\_data = ( ! empty( $get\_existing\_individual\_ticket\_lists ) ? wp\_json\_encode( $get\_existing\_individual\_ticket\_lists ) : '' );?> |
| [141](#L141) | <input type="hidden" name="em\_ticket\_individual\_data" id="ep\_ticket\_individual\_data" value="" /> |
| [142](#L142) | <input type="hidden" name="em\_ticket\_individual\_delete\_ids" id="ep\_ticket\_individual\_delete\_ids" value="" /> |
| [143](#L143) | <?php |
| [144](#L144) | do\_action('ep\_ticket\_additional\_hidden\_fields'); |
| [145](#L145) | do\_action('ep\_ticket\_additional\_hidden\_fields\_data',$post->ID); |
| [146](#L146) | ?> |
| [147](#L147) | <div class="ep-ticket-category-section"> |
| [148](#L148) | <?php if( !empty( $ep\_ticket\_data ) ) { |
| [149](#L149) |  |
| [150](#L150) | if ( isset( get\_post\_meta( $post->ID )["ep\_ticket\_order\_arr"] ) && !empty( get\_post\_meta( $post->ID )["ep\_ticket\_order\_arr"] ) ) { |
| [151](#L151) | $ep\_ticket\_order\_arr = maybe\_unserialize( get\_post\_meta( $post->ID )["ep\_ticket\_order\_arr"][0] ); |
| [152](#L152) | if ( is\_array( $ep\_ticket\_order\_arr ) ) { |
| [153](#L153) | $ids\_fliped\_for\_ep\_ticket\_order\_arr = array\_flip($ep\_ticket\_order\_arr); |
| [154](#L154) | usort($ep\_ticket\_data, function($a, $b) use ($ids\_fliped\_for\_ep\_ticket\_order\_arr) { |
| [155](#L155) | if ( isset( $ids\_fliped\_for\_ep\_ticket\_order\_arr[$a->id] ) && isset( $ids\_fliped\_for\_ep\_ticket\_order\_arr[$b->id] ) ) { |
| [156](#L156) | $posA = $ids\_fliped\_for\_ep\_ticket\_order\_arr[$a->id]; |
| [157](#L157) | $posB = $ids\_fliped\_for\_ep\_ticket\_order\_arr[$b->id]; |
| [158](#L158) | return $posA - $posB; |
| [159](#L159) | } |
| [160](#L160) | }); |
| [161](#L161) | } |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | $tic\_row = 1;$event\_has\_ticket = 1; |
| [165](#L165) | foreach( $ep\_ticket\_data as $ticket ) { |
| [166](#L166) | $icon\_url = ''; |
| [167](#L167) | if( ! empty( $ticket->icon ) ) { |
| [168](#L168) | $icon\_url = wp\_get\_attachment\_url( $ticket->icon ); |
| [169](#L169) | } |
| [170](#L170) | $ticket->icon\_url = $icon\_url; |
| [171](#L171) | $ticket\_row\_data = wp\_json\_encode( $ticket ); |
| [172](#L172) | $ticket\_row\_id = 'ep\_event\_ticket\_row' . $tic\_row;?> |
| [173](#L173) | <div class="ep-box-row ep-tickets-indi-ticket-row" id="<?php echo esc\_attr( $ticket\_row\_id );?>" data-ticket\_row\_data="<?php echo esc\_attr( $ticket\_row\_data );?>"> |
| [174](#L174) | <div class="ep-box-col-12"> |
| [175](#L175) | <div class="ep-box-row ep-border ep-rounded ep-ml-2 ep-my-1 ep-mr-2 ep-bg-white ep-items-center ui-state-default"> |
| [176](#L176) | <div class="ep-box-col-1 ep-p-3"> |
| [177](#L177) | <span class="ep-ticket-row-sort material-icons ep-cursor-move ep-text-muted" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>">drag\_indicator</span> |
| [178](#L178) | </div> |
| [179](#L179) | <div class="ep-box-col-3 ep-p-3"> |
| [180](#L180) | <?php echo esc\_html( $ticket->name );?> |
| [181](#L181) | </div> |
| [182](#L182) | <div class="ep-box-col-2 ep-p-3"> |
| [183](#L183) | <span><?php echo esc\_html( $ep\_functions->ep\_price\_with\_position( $ticket->price ) );?></span> |
| [184](#L184) | </div> |
| [185](#L185) | <div class="ep-box-col-3 ep-p-3"> |
| [186](#L186) | <span> |
| [187](#L187) | <?php echo esc\_html\_\_( 'Capacity', 'eventprime-event-calendar-management' ) . ' ' . esc\_html( $ticket->capacity );?> |
| [188](#L188) | </span> |
| [189](#L189) | </div> |
| [190](#L190) | <?php do\_action( 'ep\_event\_tickets\_action\_icons', $post->ID, $ticket->id );?> |
| [191](#L191) | <div class="ep-box-col-1 ep-p-3"> |
| [192](#L192) | <a href="javascript:void(0)" class="ep-ticket-row-edit ep-text-primary ep-cursor" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>" title="<?php esc\_html\_e( 'Edit Ticket', 'eventprime-event-calendar-management' );?>">Edit</a> |
| [193](#L193) | </div> |
| [194](#L194) | <div class="ep-box-col-1 ep-p-3"> |
| [195](#L195) | <a href="javascript:void(0)" class="ep-ticket-row-delete  ep-text-danger ep-cursor" data-parent\_id="<?php echo esc\_attr( $ticket\_row\_id );?>" title="<?php esc\_html\_e( 'Delete Ticket', 'eventprime-event-calendar-management' );?>">Delete</a> |
| [196](#L196) | </div> |
| [197](#L197) | </div> |
| [198](#L198) | </div> |
| [199](#L199) | </div><?php |
| [200](#L200) | $tic\_row++; |
| [201](#L201) | } |
| [202](#L202) | }?> |
| [203](#L203) | </div> |
| [204](#L204) | </div> |
| [205](#L205) | <!--Existing Tickets Ends--> |
| [206](#L206) | </div> |
| [207](#L207) | </div> |
| [208](#L208) |  |
| [209](#L209) | <!--Add Ticket Category Modal--> |
| [210](#L210) | <div id="ep-ticket-category-modal" class="ep-modal-view" style="display: none;"> |
| [211](#L211) | <div class="ep-modal-overlay ep-modal-overlay-fade-in"></div> |
| [212](#L212) | <div class="popup-content ep-modal-wrap ep-modal-sm ep-modal-out"> |
| [213](#L213) | <div class="ep-modal-body"> |
| [214](#L214) | <div class="ep-modal-titlebar ep-d-flex ep-items-center"> |
| [215](#L215) | <h3 class="ep-modal-title ep-px-3 "> |
| [216](#L216) | <?php esc\_html\_e('Add Tickets Category', 'eventprime-event-calendar-management'); ?> |
| [217](#L217) | </h3> |
| [218](#L218) | <a href="#" class="ep-modal-close close-popup" data-id="ep-ticket-category-modal">&times;</a> |
| [219](#L219) | </div> |
| [220](#L220) | <div class="ep-modal-content-wrapep-box-wrap"> |
| [221](#L221) | <div class="ep-box-row ep-p-3 ep-box-w-75"> |
| [222](#L222) | <div class="ep-box-col-12"> |
| [223](#L223) | <label class="ep-form-label"> |
| [224](#L224) | <?php esc\_html\_e('Tickets Category', 'eventprime-event-calendar-management'); ?> |
| [225](#L225) | </label> |
| [226](#L226) | <input type="text" class="ep-form-control" name="em\_ticket\_category\_name" id="ep\_ticket\_category\_name"> |
| [227](#L227) | <div class="ep-text-muted ep-text-small"> |
| [228](#L228) | <?php esc\_html\_e('Category name will be visible to users while selecting tickets.', 'eventprime-event-calendar-management'); ?> |
| [229](#L229) | </div> |
| [230](#L230) | <div id="ep\_ticket\_category\_name\_error" class="ep-error-message"></div> |
| [231](#L231) | </div> |
| [232](#L232) |  |
| [233](#L233) | <div class="ep-box-col-12 ep-mt-3"> |
| [234](#L234) | <label class="ep-form-label"> |
| [235](#L235) | <?php esc\_html\_e('Total Quantity/Inventory', 'eventprime-event-calendar-management'); ?> |
| [236](#L236) | </label> |
| [237](#L237) | <input type="number" class="ep-form-control" name="em\_ticket\_category\_capacity" min="1" id="ep\_ticket\_category\_capacity"> |
| [238](#L238) | <div class="ep-text-muted ep-text-small"> |
| [239](#L239) | <?php esc\_html\_e('Combined capacity or inventory of the tickets you wish to include in this tickets category should not exceed this number.', 'eventprime-event-calendar-management'); ?> |
| [240](#L240) | </div> |
| [241](#L241) | <div id="ep\_ticket\_category\_capacity\_error" class="ep-error-message"></div> |
| [242](#L242) | </div> |
| [243](#L243) | </div> |
| [244](#L244) |  |
| [245](#L245) | <div class="ep-modal-footer ep-mt-3 ep-d-flex ep-items-end ep-content-right"> |
| [246](#L246) | <button type="button" class="button ep-mr-3 ep-modal-close close-popup" data-id="ep-ticket-category-modal"><?php esc\_html\_e('Close', 'eventprime-event-calendar-management'); ?></button> |
| [247](#L247) | <button type="button" class="button button-primary button-large" id="ep\_save\_ticket\_category"><?php esc\_html\_e('Add', 'eventprime-event-calendar-management'); ?></button> |
| [248](#L248) | </div> |
| [249](#L249) | </div> |
| [250](#L250) | </div> |
| [251](#L251) | </div> |
| [252](#L252) | </div> |
| [253](#L253) | <!--Add Ticket Category Modal--> |
| [254](#L254) |  |
| [255](#L255) | <!-- Add  Ticket Tier Modal --> |
| [256](#L256) | <div id="ep\_event\_ticket\_tier\_modal" class="ep-modal-view" style="display: none;"> |
| [257](#L257) | <input type="hidden" name="em\_ticket\_category\_id" value="" /> |
| [258](#L258) | <input type="hidden" name="em\_ticket\_id" value="" /> |
| [259](#L259) | <input type="hidden" name="em\_ticket\_parent\_div\_id" value="" /> |
| [260](#L260) | <div class="ep-modal-overlay ep-modal-overlay-fade-in"></div> |
| [261](#L261) | <div class="popup-content ep-modal-wrap ep-modal-lg ep-modal-out"> |
| [262](#L262) | <div class="ep-modal-body"> |
| [263](#L263) | <div class="ep-modal-titlebar ep-d-flex ep-items-center"> |
| [264](#L264) | <h3 class="ep-modal-title ep-px-3"><?php esc\_html\_e( 'Add Ticket Type', 'eventprime-event-calendar-management' );?></h3> |
| [265](#L265) | <a href="#" class="ep-modal-close close-popup" data-id="ep\_event\_ticket\_tier\_modal">&times;</a> |
| [266](#L266) | </div> |
| [267](#L267) | <div class="ep-modal-content-wrap ep-box-wrap"> |
| [268](#L268) | <div class="ep-box-row ep-p-3 ep-box-w-75"> |
| [269](#L269) | <div class="ep-box-col-12"> |
| [270](#L270) | <label class="ep-form-label"> |
| [271](#L271) | <?php esc\_html\_e( 'Name', 'eventprime-event-calendar-management' );?> |
| [272](#L272) | </label> |
| [273](#L273) | <input type="text" class="ep-form-control" name="name" id="ep\_event\_ticke\_name"> |
| [274](#L274) | <div class="ep-text-muted ep-text-small"> |
| [275](#L275) | <?php esc\_html\_e('Ticket names are visible to the user on the frontend.', 'eventprime-event-calendar-management'); ?> |
| [276](#L276) | </div> |
| [277](#L277) | <div class="ep-error-message" id="ep\_event\_ticket\_name\_error"></div> |
| [278](#L278) | </div> |
| [279](#L279) |  |
| [280](#L280) | <div class="ep-box-col-12 ep-mt-3"> |
| [281](#L281) | <label class="ep-form-label"> |
| [282](#L282) | <?php esc\_html\_e( 'Description', 'eventprime-event-calendar-management' );?> |
| [283](#L283) | </label> |
| [284](#L284) | <textarea class="ep-form-control" name="description" id="ep\_event\_ticke\_description"></textarea> |
| [285](#L285) | <div class="ep-text-muted ep-text-small"> |
| [286](#L286) | <?php esc\_html\_e('Ticket description are visible to the user on the frontend during ticket selection.', 'eventprime-event-calendar-management'); ?> |
| [287](#L287) | </div> |
| [288](#L288) | </div> |
| [289](#L289) |  |
| [290](#L290) | <div class="ep-box-col-12 ep-mt-3"> |
| [291](#L291) | <label class="ep-form-label"> |
| [292](#L292) | <!--<?php esc\_html\_e( 'Icon', 'eventprime-event-calendar-management' );?> --> |
| [293](#L293) | </label> |
| [294](#L294) | <input type="hidden" name="icon" id="ep\_event\_ticket\_icon"> |
| [295](#L295) | <button type="button" class="upload\_offer\_icon\_button button"> |
| [296](#L296) | <?php esc\_html\_e( 'Upload Icon', 'eventprime-event-calendar-management' );?> |
| [297](#L297) | </button> |
| [298](#L298) | <div class="ep-text-muted ep-text-small"> |
| [299](#L299) | <?php esc\_html\_e('A small icon or an image representative of the ticket type.', 'eventprime-event-calendar-management'); ?> |
| [300](#L300) | </div> |
| [301](#L301) | <div id="ep\_event\_ticket\_icon\_image"></div> |
| [302](#L302) | </div> |
| [303](#L303) |  |
| [304](#L304) | <div class="ep-box-col-5 ep-mt-3"> |
| [305](#L305) | <label class="ep-form-label"> |
| [306](#L306) | <?php esc\_html\_e( 'Quantity/ Inventory', 'eventprime-event-calendar-management' );?> |
| [307](#L307) | </label> |
| [308](#L308) | <input type="number" class="ep-form-control" min="0" name="capacity" id="ep\_event\_ticket\_qty"> |
| [309](#L309) | <div class="ep-error-message" id="ep\_event\_ticket\_qty\_error"></div> |
| [310](#L310) | <span id="ep\_ticket\_remaining\_capacity" data-max\_ticket\_label="<?php esc\_html\_e( 'Remaining Seats', 'eventprime-event-calendar-management' );?>"></span> |
| [311](#L311) | </div> |
| [312](#L312) |  |
| [313](#L313) | <div class="ep-box-col-5 ep-mt-3"> |
| [314](#L314) | <label class="ep-form-label"> |
| [315](#L315) | <?php esc\_html\_e( 'Price ( per ticket )', 'eventprime-event-calendar-management' );?> |
| [316](#L316) | </label> |
| [317](#L317) | <input type="number" class="ep-form-control" name="price" id="ep\_event\_ticket\_price" min="0.00" step="0.01"> |
| [318](#L318) | </div> |
| [319](#L319) |  |
| [320](#L320) | <div class="ep-box-col-2 ep-mt-3 ep-d-flex ep-items-end ep-pb-2"> |
| [321](#L321) | <span class="ep-fw-bold"><?php |
| [322](#L322) | $selected\_currency = $ep\_functions->ep\_get\_global\_settings( 'currency' ); |
| [323](#L323) | if( empty( $selected\_currency ) ) { |
| [324](#L324) | $selected\_currency = 'USD'; |
| [325](#L325) | } |
| [326](#L326) | echo esc\_html( $selected\_currency ); |
| [327](#L327) | ?></span> |
| [328](#L328) | <span class="ep-color-primary ep-border-bottom ep-border-opacity-50 ep-ml-2 ep-text-small"><a target="\_blank" href="<?php echo esc\_url(add\_query\_arg(array('tab' => 'payments'), admin\_url().'edit.php?post\_type=em\_event&page=ep-settings'));?>"><?php esc\_html\_e( 'change?', 'eventprime-event-calendar-management' );?></a></span> |
| [329](#L329) | </div> |
| [330](#L330) |  |
| [331](#L331) | <div class="ep-box-col-12 ep-mt-3"> |
| [332](#L332) | <button type="button" class="button button-primary button-large" id="add\_more\_additional\_ticket\_fee"><?php esc\_html\_e( 'Add Additional Fee', 'eventprime-event-calendar-management' );?></button> |
| [333](#L333) | </div> |
| [334](#L334) |  |
| [335](#L335) | <div class="ep-additional-ticket-fee-wrapper ep-box-w-100" id="ep\_additional\_ticket\_fee\_wrapper"></div> |
| [336](#L336) |  |
| [337](#L337) | <div class="ep-box-col-12 ep-mt-2"> |
| [338](#L338) | <div class="ep-form-check"> |
| [339](#L339) | <input class="ep-form-check-input" type="checkbox" name="show\_remaining\_tickets" value="1" id="ep\_show\_remaining\_tickets"> |
| [340](#L340) | <label class="ep-form-check-label" for="ep\_show\_remaining\_tickets"> |
| [341](#L341) | <?php esc\_html\_e( 'Show tickets remaining to the users', 'eventprime-event-calendar-management' );?> |
| [342](#L342) | </label> |
| [343](#L343) | </div> |
| [344](#L344) | </div> |
| [345](#L345) |  |
| [346](#L346) | <div class="ep-box-col-6 ep-mt-3"> |
| [347](#L347) | <div class="ep-box-row"> |
| [348](#L348) | <div class="ep-box-col-12"> |
| [349](#L349) | <label class="ep-form-label"> |
| [350](#L350) | <?php esc\_html\_e( 'Tickets Available From', 'eventprime-event-calendar-management' );?> |
| [351](#L351) | </label> |
| [352](#L352) | <select class="ep-form-control ep\_ticket\_start\_booking\_type" id="ep\_ticket\_start\_booking\_type" name="em\_ticket\_start\_booking\_type"> |
| [353](#L353) | <option value="custom\_date"><?php esc\_html\_e( 'Custom Date', 'eventprime-event-calendar-management' );?></option> |
| [354](#L354) | <option value="event\_date"><?php esc\_html\_e( 'Event Date', 'eventprime-event-calendar-management' );?></option> |
| [355](#L355) | <option value="relative\_date"><?php esc\_html\_e( 'Relative Date', 'eventprime-event-calendar-management' );?></option> |
| [356](#L356) | </select> |
| [357](#L357) | </div> |
| [358](#L358) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_start\_booking\_options ep\_ticket\_start\_booking\_custom\_date"> |
| [359](#L359) | <label class="ep-form-label"> |
| [360](#L360) | <?php esc\_html\_e( 'Choose Date', 'eventprime-event-calendar-management' );?> |
| [361](#L361) | </label> |
| [362](#L362) | <input type="text" class="ep-form-control ep\_metabox\_custom\_date\_picker" name="em\_ticket\_start\_booking\_date" id="ep\_ticket\_start\_booking\_date" data-start="today" data-end="event\_end"> |
| [363](#L363) | </div> |
| [364](#L364) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_start\_booking\_options ep\_ticket\_start\_booking\_custom\_date"> |
| [365](#L365) | <label class="ep-form-label"> |
| [366](#L366) | <?php esc\_html\_e( 'Choose Time', 'eventprime-event-calendar-management' );?> |
| [367](#L367) | </label> |
| [368](#L368) | <input type="text" class="ep-form-control epTimePicker" name="em\_ticket\_start\_booking\_time" id="ep\_ticket\_start\_booking\_time"> |
| [369](#L369) | </div> |
| [370](#L370) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_start\_booking\_options ep\_ticket\_start\_booking\_relative\_date" style="display:none;"> |
| [371](#L371) | <label class="ep-form-label"> |
| [372](#L372) | <?php esc\_html\_e( 'Enter Days', 'eventprime-event-calendar-management' );?> |
| [373](#L373) | </label> |
| [374](#L374) | <input type="number" class="ep-form-control" name="em\_ticket\_start\_booking\_days" id="ep\_ticket\_start\_booking\_days" min="0"> |
| [375](#L375) | </div> |
| [376](#L376) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_start\_booking\_options ep\_ticket\_start\_booking\_relative\_date" style="display:none;"> |
| [377](#L377) | <label class="ep-form-label"> |
| [378](#L378) | <?php esc\_html\_e( 'Days Option', 'eventprime-event-calendar-management' );?> |
| [379](#L379) | </label> |
| [380](#L380) | <select class="ep-form-control" name="em\_ticket\_start\_booking\_days\_option" id="ep\_ticket\_start\_booking\_days\_option"> |
| [381](#L381) | <option value="before"><?php esc\_html\_e( 'Days Before', 'eventprime-event-calendar-management');?></option> |
| [382](#L382) | <option value="after"><?php esc\_html\_e( 'Days After', 'eventprime-event-calendar-management');?></option> |
| [383](#L383) | </select> |
| [384](#L384) | </div> |
| [385](#L385) | <div class="ep-box-col-12 ep-mt-3 ep\_ticket\_start\_booking\_options ep\_ticket\_start\_booking\_event\_date ep\_ticket\_start\_booking\_relative\_date" style="display:none;"> |
| [386](#L386) | <label class="ep-form-label"> |
| [387](#L387) | <?php esc\_html\_e( 'Event Option', 'eventprime-event-calendar-management' );?> |
| [388](#L388) | </label> |
| [389](#L389) | <select class="ep-form-control" name="em\_ticket\_start\_booking\_event\_option" id="ep\_ticket\_start\_booking\_event\_option"> |
| [390](#L390) | <?php $existing\_cat\_data = $ep\_functions->get\_ticket\_booking\_event\_date\_options( $post->ID ); |
| [391](#L391) | if( ! empty( $existing\_cat\_data ) ) { |
| [392](#L392) | foreach( $existing\_cat\_data as $key => $option ) {?> |
| [393](#L393) | <option value="<?php echo esc\_attr( $key );?>"><?php echo esc\_html( $option );?></option><?php |
| [394](#L394) | } |
| [395](#L395) | }?> |
| [396](#L396) | </select> |
| [397](#L397) | <div class="ep-error-message" id="em\_ticket\_start\_booking\_event\_option\_error"></div> |
| [398](#L398) | </div> |
| [399](#L399) | </div> |
| [400](#L400) | </div> |
| [401](#L401) | <div class="ep-box-col-6 ep-mt-3"> |
| [402](#L402) | <div class="ep-box-row"> |
| [403](#L403) | <div class="ep-box-col-12"> |
| [404](#L404) | <label class="ep-form-label"> |
| [405](#L405) | <?php esc\_html\_e( 'Tickets Available Till', 'eventprime-event-calendar-management' );?> |
| [406](#L406) | </label> |
| [407](#L407) | <select class="ep-form-control ep\_ticket\_ends\_booking\_type" id="ep\_ticket\_ends\_booking\_type" name="em\_ticket\_ends\_booking\_type"> |
| [408](#L408) | <option value="custom\_date"><?php esc\_html\_e( 'Custom Date', 'eventprime-event-calendar-management' );?></option> |
| [409](#L409) | <option value="event\_date"><?php esc\_html\_e( 'Event Date', 'eventprime-event-calendar-management' );?></option> |
| [410](#L410) | <option value="relative\_date"><?php esc\_html\_e( 'Relative Date', 'eventprime-event-calendar-management' );?></option> |
| [411](#L411) | </select> |
| [412](#L412) | </div> |
| [413](#L413) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_ends\_booking\_options ep\_ticket\_ends\_booking\_custom\_date"> |
| [414](#L414) | <label class="ep-form-label"> |
| [415](#L415) | <?php esc\_html\_e( 'Choose Date', 'eventprime-event-calendar-management' );?> |
| [416](#L416) | </label> |
| [417](#L417) | <input type="text" class="ep-form-control ep\_metabox\_custom\_date\_picker" name="em\_ticket\_ends\_booking\_date" id="ep\_ticket\_ends\_booking\_date" data-start="today" data-end="event\_end"> |
| [418](#L418) | </div> |
| [419](#L419) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_ends\_booking\_options ep\_ticket\_ends\_booking\_custom\_date"> |
| [420](#L420) | <label class="ep-form-label"> |
| [421](#L421) | <?php esc\_html\_e( 'Choose Time', 'eventprime-event-calendar-management' );?> |
| [422](#L422) | </label> |
| [423](#L423) | <input type="text" class="ep-form-control epTimePicker" name="em\_ticket\_ends\_booking\_time" id="ep\_ticket\_ends\_booking\_time"> |
| [424](#L424) | </div> |
| [425](#L425) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_ends\_booking\_options ep\_ticket\_ends\_booking\_relative\_date" style="display:none;"> |
| [426](#L426) | <label class="ep-form-label"> |
| [427](#L427) | <?php esc\_html\_e( 'Enter Days', 'eventprime-event-calendar-management' );?> |
| [428](#L428) | </label> |
| [429](#L429) | <input type="number" class="ep-form-control" name="em\_ticket\_ends\_booking\_days" id="ep\_ticket\_ends\_booking\_days" min="0"> |
| [430](#L430) | </div> |
| [431](#L431) | <div class="ep-box-col-6 ep-mt-3 ep\_ticket\_ends\_booking\_options ep\_ticket\_ends\_booking\_relative\_date" style="display:none;"> |
| [432](#L432) | <label class="ep-form-label"> |
| [433](#L433) | <?php esc\_html\_e( 'Days Option', 'eventprime-event-calendar-management' );?> |
| [434](#L434) | </label> |
| [435](#L435) | <select class="ep-form-control" name="em\_ticket\_ends\_booking\_days\_option" id="ep\_ticket\_ends\_booking\_days\_option"> |
| [436](#L436) | <option value="before"><?php esc\_html\_e( 'Days Before', 'eventprime-event-calendar-management');?></option> |
| [437](#L437) | <option value="after"><?php esc\_html\_e( 'Days After', 'eventprime-event-calendar-management');?></option> |
| [438](#L438) | </select> |
| [439](#L439) | </div> |
| [440](#L440) | <div class="ep-box-col-12 ep-mt-3 ep\_ticket\_ends\_booking\_options ep\_ticket\_ends\_booking\_event\_date ep\_ticket\_ends\_booking\_relative\_date" style="display:none;"> |
| [441](#L441) | <label class="ep-form-label"> |
| [442](#L442) | <?php esc\_html\_e( 'Event Option', 'eventprime-event-calendar-management' );?> |
| [443](#L443) | </label> |
| [444](#L444) | <select class="ep-form-control" name="em\_ticket\_ends\_booking\_event\_option" id="ep\_ticket\_ends\_booking\_event\_option"> |
| [445](#L445) | <?php $existing\_cat\_data = $ep\_functions->get\_ticket\_booking\_event\_date\_options( $post->ID ); |
| [446](#L446) | if( ! empty( $existing\_cat\_data ) ) { |
| [447](#L447) | foreach( $existing\_cat\_data as $key => $option ) {?> |
| [448](#L448) | <option value="<?php echo esc\_attr( $key );?>"><?php echo esc\_html( $option );?></option><?php |
| [449](#L449) | } |
| [450](#L450) | }?> |
| [451](#L451) | </select> |
| [452](#L452) | </div> |
| [453](#L453) | </div> |
| [454](#L454) | </div> |
| [455](#L455) |  |
| [456](#L456) | <div class="ep-box-col-12 ep-mt-3"> |
| [457](#L457) | <div class="ep-form-check"> |
| [458](#L458) | <input class="ep-form-check-input" type="checkbox" name="show\_ticket\_booking\_dates" value="1" id="ep\_show\_ticket\_booking\_dates"> |
| [459](#L459) | <label class="ep-form-check-label" for="ep\_show\_ticket\_booking\_dates"> |
| [460](#L460) | <?php esc\_html\_e( 'Show tickets availability dates on the frontend', 'eventprime-event-calendar-management');?> |
| [461](#L461) | </label> |
| [462](#L462) | </div> |
| [463](#L463) | </div> |
| [464](#L464) |  |
| [465](#L465) | <div class="ep-box-col-6 ep-mt-3"> |
| [466](#L466) | <label class="ep-form-check-label" for="ep\_min\_ticket\_no"> |
| [467](#L467) | <?php esc\_html\_e( 'Minimum Tickets Per Order', 'eventprime-event-calendar-management');?> |
| [468](#L468) | </label> |
| [469](#L469) | <input type="number" id="ep\_min\_ticket\_no" class="ep-form-control" min="0" name="min\_ticket\_no"> |
| [470](#L470) | <div class="ep-error-message" id="ep\_event\_ticket\_min\_ticket\_error"></div> |
| [471](#L471) | </div> |
| [472](#L472) |  |
| [473](#L473) | <div class="ep-box-col-6 ep-mt-3"> |
| [474](#L474) | <label class="ep-form-check-label" for="ep\_max\_ticket\_no"> |
| [475](#L475) | <?php esc\_html\_e( 'Maximum Tickets Per Order', 'eventprime-event-calendar-management');?> |
| [476](#L476) | </label> |
| [477](#L477) | <input type="number" id="ep\_max\_ticket\_no" class="ep-form-control" min="0" name="max\_ticket\_no"> |
| [478](#L478) | <div class="ep-error-message" id="ep\_event\_ticket\_max\_ticket\_error"></div> |
| [479](#L479) | </div> |
| [480](#L480) |  |
| [481](#L481) | <div class="ep-box-col-12 ep-mt-3"> |
| [482](#L482) | <label class="ep-form-check-label" for="ep-ticket-template"> |
| [483](#L483) | <?php esc\_html\_e( 'Tickets Template', 'eventprime-event-calendar-management');?> |
| [484](#L484) | </label> |
| [485](#L485) | <select id="ep-event-ticket-template" class="ep-form-control" name="em\_ticket\_template" disabled> |
| [486](#L486) | <?php do\_action( 'ep\_event\_get\_ticket\_template\_options' );?> |
| [487](#L487) | </select> |
| [488](#L488) | <div class="ep-text-muted ep-text-small"> |
| [489](#L489) | <?php esc\_html\_e( 'Templates allow you to design custom ticket styles which are sent to the users as PDF for printing.', 'eventprime-event-calendar-management'); |
| [490](#L490) | if( ! in\_array( 'Eventprime\_Event\_Tickets', $extensions ) ) { |
| [491](#L491) | echo '<br>'; |
| [492](#L492) | esc\_html\_e( 'To use ticket templates, please install', 'eventprime-event-calendar-management' );?> |
| [493](#L493) | <a href="<?php echo esc\_url( admin\_url('edit.php?post\_type=em\_event&page=ep-extensions') );?>" target="\_blank"><?php echo esc\_html( 'Event Tickets extension' );?></a><?php |
| [494](#L494) | }?> |
| [495](#L495) | </div> |
| [496](#L496) | </div> |
| [497](#L497) | <?php do\_action('em\_ticket\_additional\_fields');?> |
| [498](#L498) | </div> |
| [499](#L499) |  |
| [500](#L500) | <!-- Tabs --> |
| [501](#L501) | <div class="ep-box-row ep-p-3"> |
| [502](#L502) | <div class="ep-box-col-12 ep-mt-3"> |
| [503](#L503) | <div id="accordion" class="ep-accordion-wrap"> |
| [504](#L504) | <h3 class="ep-accordion-header-item"><?php esc\_html\_e( 'Visibility', 'eventprime-event-calendar-management');?></h3> |
| [505](#L505) | <div> |
| [506](#L506) | <div class="ep-box-row"> |
| [507](#L507) | <div class="ep-box-col-12 ep-mt-3"> |
| [508](#L508) | <label class="ep-form-label"><?php esc\_html\_e( 'Visible To', 'eventprime-event-calendar-management');?></label> |
| [509](#L509) | <select class="ep-form-control" name="em\_tickets\_user\_visibility" id="ep\_tickets\_user\_visibility"> |
| [510](#L510) | <option value="public"><?php esc\_html\_e( 'Everyone', 'eventprime-event-calendar-management');?></option> |
| [511](#L511) | <option value="all\_login"><?php esc\_html\_e( 'Logged In Users', 'eventprime-event-calendar-management');?></option> |
| [512](#L512) | <option value="user\_roles"><?php esc\_html\_e( 'Specific User Roles', 'eventprime-event-calendar-management');?></option> |
| [513](#L513) | <!-- <option value="user-groups">Logged In Users -> Group Members</option> --> |
| [514](#L514) | <?php do\_action("ep\_extend\_tic\_visibility\_option"); ?> |
| [515](#L515) | </select> |
| [516](#L516) | </div> |
| [517](#L517) |  |
| [518](#L518) | <div class="ep-box-col-12 ep-mt-3" id="ep\_ticket\_visibility\_user\_roles\_select" style="display:none;"> |
| [519](#L519) | <!-- <label class="ep-form-label"><?php esc\_html\_e( 'Roles', 'eventprime-event-calendar-management');?></label> --> |
| [520](#L520) | <select name="em\_ticket\_visibility\_user\_roles[]" id="ep\_ticket\_visibility\_user\_roles" multiple="multiple" class="ep-form-control ep\_user\_roles\_options"> |
| [521](#L521) | <?php foreach( $ep\_functions->ep\_get\_all\_user\_roles() as $key => $role ){?> |
| [522](#L522) | <option value="<?php echo esc\_attr( $key );?>"> |
| [523](#L523) | <?php echo esc\_html($role);?> |
| [524](#L524) | </option><?php |
| [525](#L525) | }?> |
| [526](#L526) | </select> |
| [527](#L527) | </div> |
| [528](#L528) |  |
| [529](#L529) | <?php do\_action("ep\_extend\_tic\_visibility\_sub\_option"); ?> |
| [530](#L530) |  |
| [531](#L531) | <div class="ep-box-col-12 ep-mt-3"> |
| [532](#L532) | <label><?php esc\_html\_e( 'For Ineligible Users', 'eventprime-event-calendar-management');?></label> |
| [533](#L533) | <div class="ep-form-check ep-mt-2"> |
| [534](#L534) | <input class="ep-form-check-input" type="radio" name="em\_ticket\_for\_invalid\_user" value="hidden" id="ep\_ticket\_for\_hidden\_user"> |
| [535](#L535) | <label class="ep-form-check-label" for="ep\_ticket\_for\_hidden\_user"> |
| [536](#L536) | <?php esc\_html\_e( 'Hide Tickets', 'eventprime-event-calendar-management');?> |
| [537](#L537) | </label> |
| [538](#L538) | </div> |
| [539](#L539) |  |
| [540](#L540) | <div class="ep-form-check"> |
| [541](#L541) | <input class="ep-form-check-input" type="radio" name="em\_ticket\_for\_invalid\_user" value="disabled" id="ep\_ticket\_for\_disabled\_user" checked> |
| [542](#L542) | <label class="ep-form-check-label" for="ep\_ticket\_for\_disabled\_user"> |
| [543](#L543) | <?php esc\_html\_e( 'Show Tickets as Disabled/ Greyed Out', 'eventprime-event-calendar-management');?> |
| [544](#L544) | </label> |
| [545](#L545) | </div> |
| [546](#L546) | </div> |
| [547](#L547) |  |
| [548](#L548) | </div> |
| [549](#L549) | </div> |
| [550](#L550) |  |
| [551](#L551) | <h3 class="ep-accordion-header-item"><?php esc\_html\_e( 'Offers', 'eventprime-event-calendar-management');?></h3> |
| [552](#L552) | <div> |
| [553](#L553) | <div class="ep-box-col-12 ep-my-3 ep-px-2"> |
| [554](#L554) | <strong><?php esc\_html\_e( 'Add New Offer', 'eventprime-event-calendar-management');?></strong> |
| [555](#L555) | </div> |
| [556](#L556) |  |
| [557](#L557) | <div class="ep-box-row ep-border ep-rounded ep-p-3 ep-m-2 ep-bg-light" id="ep\_event\_ticket\_offer\_wrapper"> |
| [558](#L558) | <div class="ep-box-col-12"> |
| [559](#L559) | <label class="ep-form-label"><?php esc\_html\_e( 'Name', 'eventprime-event-calendar-management');?></label> |
| [560](#L560) | <input type="text" class="ep-form-control" name="em\_ticket\_offer\_name" id="ep\_ticket\_offer\_name"> |
| [561](#L561) | <div class="ep-text-muted ep-text-small"> |
| [562](#L562) | <?php esc\_html\_e('Examples: Weekend Offer, Early-bird Discount etc. Offer name is visible on the frontend.', 'eventprime-event-calendar-management'); ?> |
| [563](#L563) | </div> |
| [564](#L564) | <div class="ep-error-message" id="ep\_event\_offer\_name\_error"></div> |
| [565](#L565) | </div> |
| [566](#L566) |  |
| [567](#L567) | <div class="ep-box-col-12 ep-mt-3"> |
| [568](#L568) | <label class="ep-form-label"><?php esc\_html\_e( 'Description', 'eventprime-event-calendar-management');?></label> |
| [569](#L569) | <textarea class="ep-form-control" name="em\_ticket\_offer\_description"></textarea> |
| [570](#L570) | <div class="ep-text-muted ep-text-small"> |
| [571](#L571) | <?php esc\_html\_e('Offer Description is visible on the frontend.', 'eventprime-event-calendar-management'); ?> |
| [572](#L572) | </div> |
| [573](#L573) | </div> |
| [574](#L574) |  |
| [575](#L575) | <div class="ep-box-col-12 ep-mt-3"> |
| [576](#L576) | <div class="ep-form-check ep-form-check-inline"> |
| [577](#L577) | <input class="ep-form-check-input" type="checkbox" name="em\_ticket\_show\_offer\_detail" value="1" id="show-offer-details"> |
| [578](#L578) | <label class="ep-form-check-label" for="show-offer-details"> |
| [579](#L579) | <?php esc\_html\_e( 'Show this offer in the offers section of the event', 'eventprime-event-calendar-management');?> |
| [580](#L580) | </label> |
| [581](#L581) | </div> |
| [582](#L582) | </div> |
| [583](#L583) |  |
| [584](#L584) | <div class="ep-box-col-6 ep-mt-3"> |
| [585](#L585) | <div class="ep-box-row" > |
| [586](#L586) | <div class="ep-box-col-12"> |
| [587](#L587) | <label class="ep-form-label"> |
| [588](#L588) | <?php esc\_html\_e( 'Offer Start', 'eventprime-event-calendar-management' );?> |
| [589](#L589) | </label> |
| [590](#L590) | <select class="ep-form-control ep\_offer\_start\_booking\_type" name="em\_offer\_start\_booking\_type"> |
| [591](#L591) | <option value="custom\_date"><?php esc\_html\_e( 'Custom Date', 'eventprime-event-calendar-management' );?></option> |
| [592](#L592) | <option value="event\_date"><?php esc\_html\_e( 'Event Date', 'eventprime-event-calendar-management' );?></option> |
| [593](#L593) | <option value="relative\_date"><?php esc\_html\_e( 'Relative Date', 'eventprime-event-calendar-management' );?></option> |
| [594](#L594) | </select> |
| [595](#L595) | </div> |
| [596](#L596) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_start\_booking\_options ep\_offer\_start\_booking\_custom\_date"> |
| [597](#L597) | <label class="ep-form-label"> |
| [598](#L598) | <?php esc\_html\_e( 'Choose Date', 'eventprime-event-calendar-management' );?> |
| [599](#L599) | </label> |
| [600](#L600) | <input type="text" class="ep-form-control ep\_metabox\_custom\_date\_picker" name="em\_offer\_start\_booking\_date" id="ep\_offer\_start\_booking\_date" data-start="booking\_start" data-end="booking\_end"> |
| [601](#L601) | </div> |
| [602](#L602) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_start\_booking\_options ep\_offer\_start\_booking\_custom\_date"> |
| [603](#L603) | <label class="ep-form-label"> |
| [604](#L604) | <?php esc\_html\_e( 'Choose Time', 'eventprime-event-calendar-management' );?> |
| [605](#L605) | </label> |
| [606](#L606) | <input type="text" class="ep-form-control epTimePicker" name="em\_offer\_start\_booking\_time" id="ep\_offer\_start\_booking\_time"> |
| [607](#L607) | </div> |
| [608](#L608) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_start\_booking\_options ep\_offer\_start\_booking\_relative\_date" style="display:none;"> |
| [609](#L609) | <label class="ep-form-label"> |
| [610](#L610) | <?php esc\_html\_e( 'Enter Days', 'eventprime-event-calendar-management' );?> |
| [611](#L611) | </label> |
| [612](#L612) | <input type="number" class="ep-form-control" name="em\_offer\_start\_booking\_days" min="0"> |
| [613](#L613) | </div> |
| [614](#L614) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_start\_booking\_options ep\_offer\_start\_booking\_relative\_date" style="display:none;"> |
| [615](#L615) | <label class="ep-form-label"> |
| [616](#L616) | <?php esc\_html\_e( 'Days Option', 'eventprime-event-calendar-management' );?> |
| [617](#L617) | </label> |
| [618](#L618) | <select class="ep-form-control" name="em\_offer\_start\_booking\_days\_option"> |
| [619](#L619) | <option value="before"><?php esc\_html\_e( 'Days Before', 'eventprime-event-calendar-management');?></option> |
| [620](#L620) | <option value="after"><?php esc\_html\_e( 'Days After', 'eventprime-event-calendar-management');?></option> |
| [621](#L621) | </select> |
| [622](#L622) | </div> |
| [623](#L623) | <div class="ep-box-col-12 ep-mt-3 ep\_offer\_start\_booking\_options ep\_offer\_start\_booking\_event\_date ep\_offer\_start\_booking\_relative\_date" style="display:none;"> |
| [624](#L624) | <label class="ep-form-label"> |
| [625](#L625) | <?php esc\_html\_e( 'Event Option', 'eventprime-event-calendar-management' );?> |
| [626](#L626) | </label> |
| [627](#L627) | <select class="ep-form-control" name="em\_offer\_start\_booking\_event\_option"> |
| [628](#L628) | <?php $existing\_cat\_data = $ep\_functions->get\_ticket\_booking\_event\_date\_options( $post->ID ); |
| [629](#L629) | if( ! empty( $existing\_cat\_data ) ) { |
| [630](#L630) | foreach( $existing\_cat\_data as $key => $option ) {?> |
| [631](#L631) | <option value="<?php echo esc\_attr( $key );?>"><?php echo esc\_html( $option );?></option><?php |
| [632](#L632) | } |
| [633](#L633) | }?> |
| [634](#L634) | </select> |
| [635](#L635) | </div> |
| [636](#L636) | </div> |
| [637](#L637) | </div> |
| [638](#L638) | <div class="ep-box-col-6 ep-mt-3"> |
| [639](#L639) | <div class="ep-box-row"> |
| [640](#L640) | <div class="ep-box-col-12"> |
| [641](#L641) | <label class="ep-form-label"> |
| [642](#L642) | <?php esc\_html\_e( 'Offer Ends', 'eventprime-event-calendar-management' );?> |
| [643](#L643) | </label> |
| [644](#L644) | <select class="ep-form-control ep\_offer\_ends\_booking\_type" name="em\_offer\_ends\_booking\_type"> |
| [645](#L645) | <option value="custom\_date"><?php esc\_html\_e( 'Custom Date', 'eventprime-event-calendar-management' );?></option> |
| [646](#L646) | <option value="event\_date"><?php esc\_html\_e( 'Event Date', 'eventprime-event-calendar-management' );?></option> |
| [647](#L647) | <option value="relative\_date"><?php esc\_html\_e( 'Relative Date', 'eventprime-event-calendar-management' );?></option> |
| [648](#L648) | </select> |
| [649](#L649) | </div> |
| [650](#L650) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_ends\_booking\_options ep\_offer\_ends\_booking\_custom\_date"> |
| [651](#L651) | <label class="ep-form-label"> |
| [652](#L652) | <?php esc\_html\_e( 'Choose Date', 'eventprime-event-calendar-management' );?> |
| [653](#L653) | </label> |
| [654](#L654) | <input type="text" class="ep-form-control ep\_metabox\_custom\_date\_picker" name="em\_offer\_ends\_booking\_date" id="ep\_offer\_ends\_booking\_date" data-start="booking\_start" data-end="booking\_end"> |
| [655](#L655) | </div> |
| [656](#L656) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_ends\_booking\_options ep\_offer\_ends\_booking\_custom\_date"> |
| [657](#L657) | <label class="ep-form-label"> |
| [658](#L658) | <?php esc\_html\_e( 'Choose Time', 'eventprime-event-calendar-management' );?> |
| [659](#L659) | </label> |
| [660](#L660) | <input type="text" class="ep-form-control epTimePicker" name="em\_offer\_ends\_booking\_time" id="ep\_offer\_ends\_booking\_time"> |
| [661](#L661) | </div> |
| [662](#L662) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_ends\_booking\_options ep\_offer\_ends\_booking\_relative\_date" style="display:none;"> |
| [663](#L663) | <label class="ep-form-label"> |
| [664](#L664) | <?php esc\_html\_e( 'Enter Days', 'eventprime-event-calendar-management' );?> |
| [665](#L665) | </label> |
| [666](#L666) | <input type="number" class="ep-form-control" name="em\_offer\_ends\_booking\_days" min="0"> |
| [667](#L667) | </div> |
| [668](#L668) | <div class="ep-box-col-6 ep-mt-3 ep\_offer\_ends\_booking\_options ep\_offer\_ends\_booking\_relative\_date" style="display:none;"> |
| [669](#L669) | <label class="ep-form-label"> |
| [670](#L670) | <?php esc\_html\_e( 'Days Option', 'eventprime-event-calendar-management' );?> |
| [671](#L671) | </label> |
| [672](#L672) | <select class="ep-form-control" name="em\_offer\_ends\_booking\_days\_option"> |
| [673](#L673) | <option value="before"><?php esc\_html\_e( 'Days Before', 'eventprime-event-calendar-management');?></option> |
| [674](#L674) | <option value="after"><?php esc\_html\_e( 'Days After', 'eventprime-event-calendar-management');?></option> |
| [675](#L675) | </select> |
| [676](#L676) | </div> |
| [677](#L677) | <div class="ep-box-col-12 ep-mt-3 ep\_offer\_ends\_booking\_options ep\_offer\_ends\_booking\_event\_date ep\_offer\_ends\_booking\_relative\_date" style="display:none;"> |
| [678](#L678) | <label class="ep-form-label"> |
| [679](#L679) | <?php esc\_html\_e( 'Event Option', 'eventprime-event-calendar-management' );?> |
| [680](#L680) | </label> |
| [681](#L681) | <select class="ep-form-control" name="em\_offer\_ends\_booking\_event\_option"> |
| [682](#L682) | <?php $existing\_cat\_data = $ep\_functions->get\_ticket\_booking\_event\_date\_options( $post->ID ); |
| [683](#L683) | if( ! empty( $existing\_cat\_data ) ) { |
| [684](#L684) | foreach( $existing\_cat\_data as $key => $option ) {?> |
| [685](#L685) | <option value="<?php echo esc\_attr( $key );?>"><?php echo esc\_html( $option );?></option><?php |
| [686](#L686) | } |
| [687](#L687) | }?> |
| [688](#L688) | </select> |
| [689](#L689) | </div> |
| [690](#L690) | </div> |
| [691](#L691) | </div> |
| [692](#L692) |  |
| [693](#L693) | <div class="ep-box-col-6 ep-mt-3"> |
| [694](#L694) | <label class="ep-form-label"><?php esc\_html\_e( 'Offer Type', 'eventprime-event-calendar-management');?></label> |
| [695](#L695) | <select id="ep\_ticket\_offer\_type" class="ep-form-control" name="em\_ticket\_offer\_type"> |
| [696](#L696) | <option value="seat\_based"><?php esc\_html\_e( 'Admittance Based', 'eventprime-event-calendar-management');?></option> |
| [697](#L697) | <option value="role\_based"><?php esc\_html\_e( 'User Role Based', 'eventprime-event-calendar-management');?></option> |
| [698](#L698) | <option value="volume\_based"><?php esc\_html\_e( 'Volume Based', 'eventprime-event-calendar-management');?></option> |
| [699](#L699) | <?php do\_action("ep\_extend\_tic\_offer\_option"); ?> |
| [700](#L700) | </select> |
| [701](#L701) | </div> |
| [702](#L702) |  |
| [703](#L703) | <div class="ep-box-col-6 ep-mt-3"> |
| [704](#L704) | <div class="ep-box-row"> |
| [705](#L705) | <div class="ep-box-col-12 offer-fields ep-seat-based-offer-wrapper" id="ep\_ticket\_offer\_seat\_based"> |
| [706](#L706) | <div class="ep-box-row"> |
| [707](#L707) | <div class="ep-box-col-6"> |
| [708](#L708) | <label class="ep-form-label"><?php esc\_html\_e( 'Select Admittance Order', 'eventprime-event-calendar-management');?></label> |
| [709](#L709) | <select class="ep-form-control" name="em\_ticket\_offer\_seat\_option"> |
| [710](#L710) | <option value=""><?php esc\_html\_e( 'Select Option', 'eventprime-event-calendar-management');?></option> |
| [711](#L711) | <option value="first"><?php esc\_html\_e( 'First', 'eventprime-event-calendar-management');?></option> |
| [712](#L712) | <option value="last"><?php esc\_html\_e( 'Last', 'eventprime-event-calendar-management');?></option> |
| [713](#L713) | </select> |
| [714](#L714) | </div> |
| [715](#L715) | <div class="ep-box-col-6"> |
| [716](#L716) | <label class="ep-form-label"><?php esc\_html\_e( 'Enter Number', 'eventprime-event-calendar-management');?></label> |
| [717](#L717) | <input type="number" min="0" class="ep-form-control" name="em\_ticket\_offer\_seat\_number" placeholder="<?php esc\_html\_e( 'Count', 'eventprime-event-calendar-management');?>"> |
| [718](#L718) | </div> |
| [719](#L719) |  |
| [720](#L720) | </div> |
| [721](#L721) | </div> |
| [722](#L722) |  |
| [723](#L723) | <div class="offer-fields ep-box-col-12" id="ep\_ticket\_offer\_role\_based" style="display: none;"> |
| [724](#L724) | <label class="ep-form-label"><?php esc\_html\_e( 'Select Roles', 'eventprime-event-calendar-management');?></label> |
| [725](#L725) | <select name="em\_ticket\_offer\_user\_roles" id="em\_ticket\_offer\_user\_roles" multiple="multiple" class="ep-form-control ep\_user\_roles\_options"> |
| [726](#L726) | <?php foreach( $ep\_functions->ep\_get\_all\_user\_roles() as $key => $role ){?> |
| [727](#L727) | <option value="<?php echo esc\_attr( $key );?>"> |
| [728](#L728) | <?php echo esc\_html($role);?> |
| [729](#L729) | </option><?php |
| [730](#L730) | }?> |
| [731](#L731) | </select> |
| [732](#L732) | </div> |
| [733](#L733) |  |
| [734](#L734) | <div class="offer-fields ep-box-col-12" id="ep\_ticket\_offer\_volume\_based" style="display: none;"> |
| [735](#L735) | <label class="ep-form-label"><?php esc\_html\_e( 'Enter Number', 'eventprime-event-calendar-management');?></label> |
| [736](#L736) | <input type="number" class="ep-form-control" name="em\_ticket\_offer\_volumn\_count" placeholder="<?php esc\_html\_e( 'Minimum Number of Tickets', 'eventprime-event-calendar-management');?>"> |
| [737](#L737) | </div> |
| [738](#L738) |  |
| [739](#L739) | <?php do\_action("ep\_extend\_tic\_offer\_sub\_option"); ?> |
| [740](#L740) |  |
| [741](#L741) | </div> |
| [742](#L742) | </div> |
| [743](#L743) |  |
| [744](#L744) | <div class="ep-box-col-6 ep-mt-3" id="ep\_offer\_discount\_type"> |
| [745](#L745) | <label class="ep-form-label"> |
| [746](#L746) | <?php esc\_html\_e( 'Select Discount Type', 'eventprime-event-calendar-management' );?> |
| [747](#L747) | </label> |
| [748](#L748) | <select class="ep-form-control" name="em\_ticket\_offer\_discount\_type" id="ep\_ticket\_offer\_discount\_type"> |
| [749](#L749) | <option value=""><?php esc\_html\_e( 'Select Discount Type', 'eventprime-event-calendar-management');?></option> |
| [750](#L750) | <option value="flat"><?php esc\_html\_e( 'Flat Discount', 'eventprime-event-calendar-management');?></option> |
| [751](#L751) | <option value="percentage"><?php esc\_html\_e( 'Percentage', 'eventprime-event-calendar-management');?></option> |
| [752](#L752) | </select> |
| [753](#L753) | <div class="ep-error-message" id="ep\_ticket\_offer\_discount\_type\_error"></div> |
| [754](#L754) | </div> |
| [755](#L755) |  |
| [756](#L756) | <div class="ep-box-col-6 ep-mt-3" id="ep\_offer\_discount"> |
| [757](#L757) | <label class="ep-form-label"> |
| [758](#L758) | <?php esc\_html\_e( 'Enter Discount', 'eventprime-event-calendar-management' );?> |
| [759](#L759) | </label> |
| [760](#L760) | <input type="number" min="0" class="ep-form-control" name="em\_ticket\_offer\_discount" id="ep\_ticket\_offer\_discount" placeholder="<?php esc\_html\_e( 'Enter Discount', 'eventprime-event-calendar-management');?>"> |
| [761](#L761) | <div class="ep-error-message" id="ep\_ticket\_offer\_discount\_error"></div> |
| [762](#L762) | </div> |
| [763](#L763) |  |
| [764](#L764) | <div class="ep-box-col-12 ep-mt-3"> |
| [765](#L765) | <button type="button" class="button button-primary button-large" id="ep\_ticket\_add\_offer"><?php esc\_html\_e( 'Add Offer', 'eventprime-event-calendar-management');?></button> |
| [766](#L766) | <div class="ep-error-message ep-lh-lg ep-mt-3" id="ep\_ticket\_offer\_not\_save\_error"></div> |
| [767](#L767) | </div> |
| [768](#L768) |  |
| [769](#L769) | </div> |
| [770](#L770) |  |
| [771](#L771) | <div class="ep-box-row ep-my-4 ep-mx-0"> |
| [772](#L772) | <div class="ep-box-col-6"> |
| [773](#L773) | <label class="ep-form-label"><?php esc\_html\_e( 'How to Handle Multiple Offers?', 'eventprime-event-calendar-management');?></label> |
| [774](#L774) | <select class="ep-form-control" name="multiple\_offers\_option" id="em\_multiple\_offers\_option"> |
| [775](#L775) | <option value="stack\_offers"><?php esc\_html\_e( 'Stack offers', 'eventprime-event-calendar-management');?></option> |
| [776](#L776) | <option value="first\_offer"><?php esc\_html\_e( 'First one that applies', 'eventprime-event-calendar-management');?></option> |
| [777](#L777) | </select> |
| [778](#L778) | </div> |
| [779](#L779) | <div class="ep-box-col-6"> |
| [780](#L780) | <label class="form-label"><?php esc\_html\_e( 'Max Cumulative Discount', 'eventprime-event-calendar-management');?></label> |
| [781](#L781) | <input type="number" min="0" class="ep-form-control" name="multiple\_offers\_max\_discount" id="em\_multiple\_offers\_max\_discount"> |
| [782](#L782) | </div> |
| [783](#L783) | </div> |
| [784](#L784) |  |
| [785](#L785) | <div class="ep-box-row ep-mt-4" id="ep\_ticket\_offers\_wrapper" style="display: none;"> |
| [786](#L786) | <div class="ep-box-col-12 ep-my-3"> |
| [787](#L787) | <strong><?php esc\_html\_e( 'Added Offers', 'eventprime-event-calendar-management');?></strong> |
| [788](#L788) | </div> |
| [789](#L789) | <input type="hidden" name="offers" id="ep\_event\_ticket\_offers" value="" /> |
| [790](#L790) | <div class="ep-box-col-12" id="ep\_existing\_offers\_list"></div> |
| [791](#L791) | </div> |
| [792](#L792) | </div> |
| [793](#L793) | </div> |
| [794](#L794) | </div> |
| [795](#L795) | </div> |
| [796](#L796) |  |
| [797](#L797) | <!-- Modal Wrap  End --> |
| [798](#L798) | <div class="ep-modal-footer ep-mt-3 ep-d-flex ep-items-end ep-content-right"> |
| [799](#L799) | <button type="button" class="button ep-mr-3 ep-modal-close close-popup" data-id="ep\_event\_ticket\_tier\_modal"><?php esc\_html\_e( 'Close', 'eventprime-event-calendar-management');?></button> |
| [800](#L800) | <button type="button" class="button button-primary button-large" id="ep\_save\_ticket\_tier"><?php esc\_html\_e( 'Save changes', 'eventprime-event-calendar-management');?></button> |
| [801](#L801) | </div> |
| [802](#L802) | </div> |
| [803](#L803) | </div> |
| [804](#L804) | </div> |
| [805](#L805) | </div> |
| [806](#L806) | <!-- Add  Ticket Tier Modal End --> |
| [807](#L807) | <input type="hidden" name="ep\_event\_has\_ticket" id="ep\_event\_has\_ticket" value="<?php echo absint( $event\_has\_ticket );?>" > |
| [808](#L808) |  |
| [809](#L809) | <?php do\_action( 'ep\_event\_after\_admin\_tickets\_section' );?> |
| [810](#L810) | <?php if( empty( $show\_message ) ) {?> |
| [811](#L811) | <div class="ep-box-row ep-p-3" id="ep\_event\_booking\_disabled\_warning" style="display: none;"> |
| [812](#L812) | <div class="ep-alert ep-alert-warning ep-mt-3 ep-py-2"> |
| [813](#L813) | <strong><?php esc\_html\_e( 'The event booking is not enabled.', 'eventprime-event-calendar-management' ); ?></strong> |
| [814](#L814) | </div> |
| [815](#L815) | </div><?php |
| [816](#L816) | }?> |
| [817](#L817) | </div> |
| [818](#L818) | </div> |
| [819](#L819) |  |
| [820](#L820) | <div id="ep\_event\_booking\_turn\_off\_modal" class="ep-modal-view" style="display: none;"> |
| [821](#L821) | <div class="ep-modal-overlay ep-modal-overlay-fade-in close-popup" data-id="ep\_event\_booking\_turn\_off\_modal"></div> |
| [822](#L822) | <div class="popup-content ep-modal-wrap ep-modal-sm ep-modal-out"> |
| [823](#L823) | <div class="ep-modal-body"> |
| [824](#L824) | <div class="ep-modal-titlebar ep-d-flex ep-items-center"> |
| [825](#L825) | <h3 class="ep-modal-title ep-px-3"> |
| [826](#L826) | <?php esc\_html\_e( 'No ticket found', 'eventprime-event-calendar-management' ); ?> |
| [827](#L827) | </h3> |
| [828](#L828) | <a href="#" class="ep-modal-close close-popup" data-id="ep\_event\_booking\_turn\_off\_modal">&times;</a> |
| [829](#L829) | </div> |
| [830](#L830) | <div class="ep-modal-content-wrap"> |
| [831](#L831) | <div class="ep-box-wrap"> |
| [832](#L832) | <div class="ep-box-row ep-p-3 ep-box-w-75 ep-event-booking-field-manager"> |
| [833](#L833) | <div class="ep-box-col-12 form-field"> |
| [834](#L834) | <?php esc\_html\_e( 'You have not added any tickets for this event. Therefore, bookings for this event will be turned off.', 'eventprime-event-calendar-management' );?> |
| [835](#L835) | </div> |
| [836](#L836) | </div> |
| [837](#L837) | </div> |
| [838](#L838) | <div class="ep-modal-footer ep-mt-3 ep-d-flex ep-items-end ep-content-right" id="ep\_modal\_buttonset"> |
| [839](#L839) | <span class="spinner ep-mr-2 ep-mb-2 ep-text-end" id="ep\_event\_booking\_turn\_off\_loader"></span> |
| [840](#L840) | <button type="button" class="button ep-mr-3 ep-modal-close close-popup" data-id="ep\_event\_booking\_turn\_off\_modal" id="ep\_event\_booking\_turn\_off\_cancel" title="<?php echo esc\_attr( 'Cancel', 'eventprime-event-calendar-management' ); ?>"><?php esc\_html\_e('Cancel', 'eventprime-event-calendar-management'); ?></button> |
| [841](#L841) | <button type="button" class="button button-primary button-large" id="ep\_event\_booking\_turn\_off\_continue" title="<?php echo esc\_attr( 'Turn Off Booking', 'eventprime-event-calendar-management' ); ?>"><?php esc\_html\_e('Turn Off Booking', 'eventprime-event-calendar-management'); ?></button> |
| [842](#L842) | </div> |
| [843](#L843) | </div> |
| [844](#L844) | </div> |
| [845](#L845) | </div> |
| [846](#L846) | </div> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php?format=txt)
* [Original Format](/export/3222464/eventprime-event-calendar-management/tags/4.0.5.3/admin/partials/metaboxes/meta-box-tickets-panel-html.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_fe998967_20250114_200722.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Feventprime-event-calendar-management%2Ftags%2F4.0.5.3%2Fincludes%2Fclass-ep-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [eventprime-event-calendar-management](/browser/eventprime-event-calendar-management?order=name "View eventprime-event-calendar-management")/[tags](/browser/eventprime-event-calendar-management/tags?order=name "View tags")/[4.0.5.3](/browser/eventprime-event-calendar-management/tags/4.0.5.3?order=name "View 4.0.5.3")/[includes](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes?order=name "View includes")/[class-ep-ajax.php](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php?order=name "View class-ep-ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3199413/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php "View differences") on this file was [3199413](/changeset/3199413/ "View changeset 3199413"), checked in by metagauss, [7 weeks ago](/timeline?from=2024-11-29T11%3A51%3A04Z&precision=second "See timeline at 11/29/2024 11:51:04 AM") |
| --- |
| Tag 4.0.5.3 |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 169.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* EventPrime Ajax Event Handler Class. |
| [4](#L4) | \*/ |
| [5](#L5) | defined( 'ABSPATH' ) || exit; |
| [6](#L6) |  |
| [7](#L7) | class EventM\_Ajax\_Service { |
| [8](#L8) |  |
| [9](#L9) | public function cancel\_current\_booking\_process() { |
| [10](#L10) | // Add security checks |
| [11](#L11) | if( wp\_verify\_nonce( $\_POST['security'], 'event-registration-form-nonce' ) ) { |
| [12](#L12) | $event\_id = absint( $\_POST['event\_id'] ); |
| [13](#L13) | $ticket\_data = json\_decode( stripslashes( $\_POST['ticket\_data'] ) ); |
| [14](#L14) |  |
| [15](#L15) | $event\_seat\_data = get\_post\_meta( $event\_id, 'em\_seat\_data', true ); |
| [16](#L16) | if( ! empty( $event\_seat\_data ) ) { |
| [17](#L17) | // wp\_send\_json\_success('seated event'); |
| [18](#L18) |  |
| [19](#L19) | if ( class\_exists( 'EventM\_Live\_Seating\_List\_Controller' ) ) { |
| [20](#L20) | $seating\_controller = new EventM\_Live\_Seating\_List\_Controller; |
| [21](#L21) | } |
| [22](#L22) | $em\_ls\_seat\_plan\_id = get\_post\_meta( $event\_id, 'em\_ls\_seat\_plan', true ); |
| [23](#L23) | $plan\_color\_data = $seating\_controller->get\_plan\_colors\_data( $em\_ls\_seat\_plan\_id ); |
| [24](#L24) |  |
| [25](#L25) | $event\_seat\_data = maybe\_unserialize( $event\_seat\_data ); |
| [26](#L26) | foreach( $ticket\_data as $tickets ) { |
| [27](#L27) | if( ! empty( $tickets->seats ) ) { |
| [28](#L28) | $ticket\_seats = $tickets->seats; |
| [29](#L29) | foreach( $ticket\_seats as $seats\_data ) { |
| [30](#L30) | $ticket\_area\_id = $seats\_data->area\_id; |
| [31](#L31) | if( $event\_seat\_data->{$ticket\_area\_id} ) { |
| [32](#L32) | $ticket\_seat\_data = $seats\_data->seat\_data; |
| [33](#L33) | if( ! empty( $ticket\_seat\_data ) ) { |
| [34](#L34) | foreach( $ticket\_seat\_data as $tsd ) { |
| [35](#L35) | if( ! empty( $tsd->uid ) ) { |
| [36](#L36) | $seat\_uid = $tsd->uid; |
| [37](#L37) | $seat\_uid = explode( '-', $seat\_uid ); |
| [38](#L38) | $row\_index = $seat\_uid[0]; |
| [39](#L39) | $col\_index = $seat\_uid[1]; |
| [40](#L40) | if( ! empty( $event\_seat\_data->{$ticket\_area\_id}->seats[$row\_index] ) ) { |
| [41](#L41) |  |
| [42](#L42) | foreach ( $event\_seat\_data->{$ticket\_area\_id}->seats[$row\_index] as $key => $seat ) { |
| [43](#L43) | if ( $seat->col == $col\_index ) { |
| [44](#L44) | if( $seat->type == 'hold' ) { |
| [45](#L45) | $seat->type = 'general'; |
| [46](#L46) | $seat->hold\_time = ''; |
| [47](#L47) | $seat\_available\_color = $plan\_color\_data['seat\_available\_color']; |
| [48](#L48) | $seat->seatColor = $seat\_available\_color; |
| [49](#L49) |  |
| [50](#L50) | $event\_seat\_data->{$ticket\_area\_id}->seats[$row\_index][$key]  = $seat; |
| [51](#L51) | } |
| [52](#L52) | } |
| [53](#L53) | } |
| [54](#L54) |  |
| [55](#L55) | } |
| [56](#L56) | } |
| [57](#L57) | } |
| [58](#L58) | } |
| [59](#L59) | } |
| [60](#L60) | } |
| [61](#L61) | } |
| [62](#L62) | } |
| [63](#L63) |  |
| [64](#L64) | $update =  update\_post\_meta( $event\_id, 'em\_seat\_data', maybe\_serialize( $event\_seat\_data ) ); |
| [65](#L65) | wp\_send\_json\_success($update); |
| [66](#L66) |  |
| [67](#L67) | } else { |
| [68](#L68) | wp\_send\_json\_success('not a seated event'); |
| [69](#L69) | } |
| [70](#L70) | } else { |
| [71](#L71) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-seating' ) ) ); |
| [72](#L72) | } |
| [73](#L73) |  |
| [74](#L74) |  |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | /\*\* |
| [78](#L78) | \* save checkout field |
| [79](#L79) | \*/ |
| [80](#L80) | public function save\_checkout\_field() { |
| [81](#L81) | check\_ajax\_referer( 'save-checkout-fields', 'security' ); |
| [82](#L82) |  |
| [83](#L83) | $response = array(); |
| [84](#L84) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [85](#L85) | if( ! isset( $data['em\_checkout\_field\_label'] ) || empty( $data['em\_checkout\_field\_label'] ) ) { |
| [86](#L86) | $response['message'] = esc\_html\_\_( 'Label should not be empty', 'eventprime-event-calendar-management' ); |
| [87](#L87) | wp\_send\_json\_error($response); |
| [88](#L88) | } |
| [89](#L89) | if( ! isset( $data['em\_checkout\_field\_type'] ) || empty( $data['em\_checkout\_field\_type'] ) ) { |
| [90](#L90) | $response['message'] = esc\_html\_\_( 'Type should not be empty', 'eventprime-event-calendar-management' ); |
| [91](#L91) | wp\_send\_json\_error( $response ); |
| [92](#L92) | } |
| [93](#L93) | try{ |
| [94](#L94) |  |
| [95](#L95) | $dbhandler = new EP\_DBhandler; |
| [96](#L96) | $table\_name = 'CHECKOUT\_FIELDS'; |
| [97](#L97) | $save\_data = array(); |
| [98](#L98) | $save\_data['label'] = sanitize\_text\_field( $data['em\_checkout\_field\_label'] ); |
| [99](#L99) | $save\_data['type'] = sanitize\_text\_field( $data['em\_checkout\_field\_type'] ); |
| [100](#L100) | // for option data |
| [101](#L101) | $save\_data['option\_data'] = ''; |
| [102](#L102) | $option\_data = ( ! empty( $data['ep\_checkout\_field\_option\_value'] ) ? $data['ep\_checkout\_field\_option\_value'] : '' ); |
| [103](#L103) | // set selected value |
| [104](#L104) | if( ! empty( $data['ep\_checkout\_field\_option\_value\_selected'] ) ) { |
| [105](#L105) | $option\_index = $data['ep\_checkout\_field\_option\_value\_selected']; |
| [106](#L106) | $option\_data[$option\_index]['selected'] = 1; |
| [107](#L107) | } |
| [108](#L108) | if( ! empty( $option\_data ) ) { |
| [109](#L109) | $save\_data['option\_data'] = maybe\_serialize( $option\_data ); |
| [110](#L110) | } |
| [111](#L111) | if( empty( $data['em\_checkout\_field\_id'] ) ) { |
| [112](#L112) | $save\_data['priority'] = 1; |
| [113](#L113) | $save\_data['status'] = 1; |
| [114](#L114) | $save\_data['created\_by'] = get\_current\_user\_id(); |
| [115](#L115) | $save\_data['created\_at'] = date\_i18n( "Y-m-d H:i:s", time() ); |
| [116](#L116) | $field\_id = $dbhandler->insert\_row($table\_name, $save\_data); |
| [117](#L117) | $response['message'] = esc\_html\_\_( 'Field Saved Successfully.', 'eventprime-event-calendar-management' ); |
| [118](#L118) | } else{ |
| [119](#L119) | $field\_id = absint( $data['em\_checkout\_field\_id'] ); |
| [120](#L120) | $save\_data['updated\_at'] = date\_i18n( "Y-m-d H:i:s", time() ); |
| [121](#L121) | $save\_data['last\_updated\_by'] = get\_current\_user\_id(); |
| [122](#L122) | $result = $dbhandler->update\_row($table\_name,'id', $field\_id, $save\_data); |
| [123](#L123) | $response['message'] = esc\_html\_\_( 'Field Updated Successfully.', 'eventprime-event-calendar-management' ); |
| [124](#L124) | } |
| [125](#L125) | $save\_data['field\_id'] = $field\_id; |
| [126](#L126) | $response['field\_data'] = $save\_data; |
| [127](#L127) | } catch( Exception $e ) { |
| [128](#L128) | wp\_send\_json\_error( array( 'error' => $e->getMessage() ) ); |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | wp\_send\_json\_success( $response ); |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) | // delete the checkout field |
| [135](#L135) | public function delete\_checkout\_field(){ |
| [136](#L136) | check\_ajax\_referer( 'delete-checkout-fields', 'security' ); |
| [137](#L137) |  |
| [138](#L138) | $response = array(); |
| [139](#L139) | if( isset( $\_POST['field\_id'] ) && ! empty( $\_POST['field\_id'] ) ) { |
| [140](#L140) | $id = $\_POST['field\_id']; |
| [141](#L141) | $dbhandler = new EP\_DBhandler; |
| [142](#L142) | $table\_name = 'CHECKOUT\_FIELDS'; |
| [143](#L143) | $get\_field\_data = $dbhandler->get\_all\_result($table\_name,'\*',array('id'=>$id)); |
| [144](#L144) | if( ! empty( $get\_field\_data ) && count( $get\_field\_data ) > 0 ) { |
| [145](#L145) | $dbhandler->remove\_row($table\_name,'id',$id); |
| [146](#L146) | $response['message'] = esc\_html\_\_( 'Field Deleted Successfully.', 'eventprime-event-calendar-management' ); |
| [147](#L147) | } else{ |
| [148](#L148) | $response['message'] = esc\_html\_\_( 'No Record Found.', 'eventprime-event-calendar-management' ); |
| [149](#L149) | wp\_send\_json\_error( $response ); |
| [150](#L150) | } |
| [151](#L151) | } else{ |
| [152](#L152) | $response['message'] = esc\_html\_\_( 'Some Data Missing.', 'eventprime-event-calendar-management' ); |
| [153](#L153) | wp\_send\_json\_error( $response ); |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | wp\_send\_json\_success( $response ); |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) | public function submit\_payment\_setting(){ |
| [160](#L160) | $payment\_gateway = apply\_filters( 'ep\_payments\_gateways\_list', array() ); |
| [161](#L161) | $global\_settings = new Eventprime\_Global\_Settings; |
| [162](#L162) | $global\_settings\_data = $global\_settings->ep\_get\_settings(); |
| [163](#L163) | $form\_data = $\_POST; |
| [164](#L164) | if( isset( $form\_data ) && isset( $form\_data['em\_payment\_type'] ) ) { |
| [165](#L165) | if( $form\_data['em\_payment\_type'] == 'basic' ) { |
| [166](#L166) | $payment\_method = isset( $form\_data['payment\_method'] ) && ! empty( $form\_data['payment\_method'] ) ? sanitize\_text\_field( $form\_data['payment\_method'] ) : ''; |
| [167](#L167) | $method\_status = $form\_data['method\_status']; |
| [168](#L168) | $nonce = wp\_create\_nonce('ep\_settings\_tab'); |
| [169](#L169) | if( ! empty( $method\_status ) ) { |
| [170](#L170) | if( $payment\_method == 'paypal\_processor' ) { |
| [171](#L171) | if( empty( $global\_settings\_data->paypal\_client\_id ) && $method\_status == 1 ) { |
| [172](#L172) | $url = add\_query\_arg( array( 'settings-updated' => false, 'tab'=> 'payments', 'section'=> 'paypal','tab\_nonce'=>$nonce ), admin\_url().'edit.php?post\_type=em\_event&page=ep-settings' ); |
| [173](#L173) | wp\_send\_json\_success( array( 'url' => $url ) ); |
| [174](#L174) | } |
| [175](#L175) | } |
| [176](#L176) | if( $payment\_method == 'stripe\_processor' ) { |
| [177](#L177) | if( ( empty( $global\_settings\_data->stripe\_api\_key ) || empty( $global\_settings\_data->stripe\_pub\_key ) ) && $method\_status == 1 ) { |
| [178](#L178) | $url = add\_query\_arg( array( 'settings-updated' => false, 'tab'=> 'payments', 'section'=> 'stripe','tab\_nonce'=>$nonce ), admin\_url().'edit.php?post\_type=em\_event&page=ep-settings' ); |
| [179](#L179) | wp\_send\_json\_success( array( 'url' => $url ) ); |
| [180](#L180) | } |
| [181](#L181) | } |
| [182](#L182) | } |
| [183](#L183) | if( ! empty( $payment\_method ) ) { |
| [184](#L184) | $global\_settings\_data->$payment\_method = $method\_status; |
| [185](#L185) | } |
| [186](#L186) | } |
| [187](#L187) | $global\_settings->ep\_save\_settings( $global\_settings\_data ); |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) | $method = ucfirst( explode( '\_', $payment\_method )[0] ); |
| [191](#L191) |  |
| [192](#L192) | $message = $method . ' ' . esc\_html\_\_( 'is activated.', 'eventprime-event-calendar-management' ); |
| [193](#L193) | if( $method\_status == 0 ) { |
| [194](#L194) | $message = $method . ' ' . esc\_html\_\_( 'is deactivated.', 'eventprime-event-calendar-management' ); |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | wp\_send\_json\_success( array( 'url' => '', 'message' => $message ) ); |
| [198](#L198) | die(); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | public function submit\_login\_form(){ |
| [202](#L202) | $user\_controller = new EventM\_User\_Controller(); |
| [203](#L203) | $response = $user\_controller->ep\_handle\_login(); |
| [204](#L204) | wp\_send\_json\_success($response); |
| [205](#L205) | die(); |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) | public function submit\_register\_form(){ |
| [209](#L209) | $user\_controller = new EventM\_User\_Controller(); |
| [210](#L210) | $response = $user\_controller->ep\_handle\_registration(); |
| [211](#L211) | wp\_send\_json\_success($response); |
| [212](#L212) | die(); |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) | /\* |
| [216](#L216) | \* Load more Event Types |
| [217](#L217) | \*/ |
| [218](#L218) | public function load\_more\_event\_types(){ |
| [219](#L219) | $controller = new Eventprime\_Basic\_Functions; |
| [220](#L220) | $response = $controller->get\_event\_types\_loadmore(); |
| [221](#L221) | wp\_send\_json\_success($response); |
| [222](#L222) | die(); |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) | /\* |
| [226](#L226) | \* Load More Event Performer |
| [227](#L227) | \*/ |
| [228](#L228) | public function load\_more\_event\_performer(){ |
| [229](#L229) | $controller = new Eventprime\_Basic\_Functions; |
| [230](#L230) | $response = $controller->get\_event\_performer\_loadmore(); |
| [231](#L231) | wp\_send\_json\_success($response); |
| [232](#L232) | die(); |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | /\* |
| [236](#L236) | \* Load More Event Venue |
| [237](#L237) | \*/ |
| [238](#L238) | public function load\_more\_event\_venue(){ |
| [239](#L239) | $controller = new Eventprime\_Basic\_Functions; |
| [240](#L240) | $response = $controller->get\_event\_venue\_loadmore(); |
| [241](#L241) | wp\_send\_json\_success($response); |
| [242](#L242) | die(); |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) | /\* |
| [246](#L246) | \* Load More Event Organizers |
| [247](#L247) | \*/ |
| [248](#L248) | public function load\_more\_event\_organizer(){ |
| [249](#L249) | $controller = new Eventprime\_Basic\_Functions; |
| [250](#L250) | $response = $controller->get\_event\_organizer\_loadmore(); |
| [251](#L251) | wp\_send\_json\_success($response); |
| [252](#L252) | die(); |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) | /\* |
| [256](#L256) | \* Load More Events |
| [257](#L257) | \*/ |
| [258](#L258) | public function load\_more\_events(){ |
| [259](#L259) | $controller = new Eventprime\_Basic\_Functions; |
| [260](#L260) | $response = $controller->get\_events\_loadmore(); |
| [261](#L261) | wp\_send\_json\_success($response); |
| [262](#L262) | die(); |
| [263](#L263) | } |
| [264](#L264) | /\*\* |
| [265](#L265) | \* Load single event page on chenge of child event date |
| [266](#L266) | \*/ |
| [267](#L267) | public function load\_event\_single\_page() { |
| [268](#L268) | check\_ajax\_referer( 'single-event-data-nonce', 'security' ); |
| [269](#L269) |  |
| [270](#L270) | if( isset( $\_POST['event\_id'] ) && ! empty( $\_POST['event\_id'] ) ) { |
| [271](#L271) | $event\_id = absint( $\_POST['event\_id'] ); |
| [272](#L272) | $event\_controller = new Eventprime\_Basic\_Functions; |
| [273](#L273) | $single\_event = $event\_controller->ep\_load\_other\_date\_event\_detail( $event\_id ); |
| [274](#L274) | //$single\_event->venue\_other\_events = EventM\_Factory\_Service::get\_upcoming\_event\_by\_venue\_id( $single\_event->em\_venue, array( $single\_event->id ) ); |
| [275](#L275) | if( ! empty( $single\_event ) ) { |
| [276](#L276) | wp\_send\_json\_success( $single\_event ); |
| [277](#L277) | } else{ |
| [278](#L278) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Data Not Found', 'eventprime-event-calendar-management' ) ) ); |
| [279](#L279) | } |
| [280](#L280) | wp\_die(); |
| [281](#L281) | } |
| [282](#L282) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Data Not Found', 'eventprime-event-calendar-management' ) ) ); |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | /\*\* |
| [286](#L286) | \* Save event booking |
| [287](#L287) | \*/ |
| [288](#L288) | public function save\_event\_booking() { |
| [289](#L289) | if( ! empty( $\_POST['data'] ) ) { |
| [290](#L290) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [291](#L291) | $sanitizer = new EventPrime\_sanitizer; |
| [292](#L292) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [293](#L293) | if(isset($\_POST['offer\_data'])) |
| [294](#L294) | { |
| [295](#L295) | $offer\_data = json\_decode( wp\_unslash( $\_POST['offer\_data'] )); |
| [296](#L296) | } |
| [297](#L297) | else |
| [298](#L298) | { |
| [299](#L299) | $offer\_data = array(); |
| [300](#L300) | } |
| [301](#L301) | $result = array( 'success' => 1, 'msg' => '' ); |
| [302](#L302) | $checkpoint = apply\_filters('ep\_handle\_checkout\_additional\_check',$result, $data); |
| [303](#L303) | if(isset($checkpoint['success']) && empty($checkpoint['success'])){ |
| [304](#L304) | wp\_send\_json\_error( array( 'error' =>  $checkpoint['msg']) ); |
| [305](#L305) | die(); |
| [306](#L306) | } |
| [307](#L307) | if( wp\_verify\_nonce( $data['ep\_save\_event\_booking\_nonce'], 'ep\_save\_event\_booking' ) ) { |
| [308](#L308) |  |
| [309](#L309) | if(isset($data['ep\_event\_booking\_ticket\_data'])) |
| [310](#L310) | { |
| [311](#L311) | $ticket\_data = json\_decode( $data['ep\_event\_booking\_ticket\_data'] ); |
| [312](#L312) | if(isset($ticket\_data[0]->id)) |
| [313](#L313) | { |
| [314](#L314) | $ticket\_data\_object = $ep\_functions->ep\_get\_ticket\_data($ticket\_data[0]->id); |
| [315](#L315) | if(empty($ticket\_data\_object)) |
| [316](#L316) | { |
| [317](#L317) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Something went wrong.', 'eventprime-event-calendar-management' ) ) ); |
| [318](#L318) | die; |
| [319](#L319) | } |
| [320](#L320) | } |
| [321](#L321) | else |
| [322](#L322) | { |
| [323](#L323) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Something went wrong.', 'eventprime-event-calendar-management' ) ) ); |
| [324](#L324) | die; |
| [325](#L325) | } |
| [326](#L326) | } |
| [327](#L327) | else |
| [328](#L328) | { |
| [329](#L329) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Something went wrong.', 'eventprime-event-calendar-management' ) ) ); |
| [330](#L330) | die; |
| [331](#L331) | } |
| [332](#L332) | if(!isset($data['ep\_event\_booking\_event\_fixed\_price'])) |
| [333](#L333) | { |
| [334](#L334) | $data['ep\_event\_booking\_event\_fixed\_price'] = 0; |
| [335](#L335) | } |
| [336](#L336) | $current\_user = wp\_get\_current\_user(); |
| [337](#L337) | if( class\_exists("Eventprime\_Admin\_Attendee\_Booking")){ |
| [338](#L338) | if(empty( get\_option( 'ep\_set\_admin\_aab\_'.$current\_user->ID ))) |
| [339](#L339) | { |
| [340](#L340) | $data = $ep\_functions->ep\_recalculate\_and\_verify\_the\_cart\_data($data,$offer\_data); |
| [341](#L341) | } |
| [342](#L342) |  |
| [343](#L343) | } |
| [344](#L344) | else |
| [345](#L345) | { |
| [346](#L346) | $data = $ep\_functions->ep\_recalculate\_and\_verify\_the\_cart\_data($data,$offer\_data); |
| [347](#L347) | } |
| [348](#L348) | // If Seated Venue then verify if seats in the ticekt data are sold or not. |
| [349](#L349) | // Check it after ep\_recalculate\_and\_verify\_the\_cart\_data() as $data is set false later. (Refractor it!!!) |
| [350](#L350) | $incoming\_ticket\_data = json\_decode( $data['ep\_event\_booking\_ticket\_data'] ); |
| [351](#L351) | //$ep\_functions->epd($incoming\_ticket\_data); |
| [352](#L352) | $event\_seats\_current\_details = maybe\_unserialize( get\_post\_meta( absint( $data['ep\_event\_booking\_event\_id'] ), 'em\_seat\_data', true  ) ); |
| [353](#L353) | foreach ( $incoming\_ticket\_data as $single\_ticket\_type ) { |
| [354](#L354) | $single\_ticket\_type\_id = $single\_ticket\_type->id; |
| [355](#L355) | if(isset($single\_ticket\_type->seats) && !empty($single\_ticket\_type->seats)) |
| [356](#L356) | { |
| [357](#L357) | $single\_ticket\_type\_seats\_data = $single\_ticket\_type->seats; |
| [358](#L358) | foreach ( $single\_ticket\_type\_seats\_data as $ticket\_area\_data ) { |
| [359](#L359) | $area\_id = $ticket\_area\_data->area\_id; |
| [360](#L360) | foreach ( $ticket\_area\_data->seat\_data as $ticket\_seat ) { |
| [361](#L361) |  |
| [362](#L362) | if( ! empty( $ticket\_seat->uid ) ) { |
| [363](#L363) | $ticket\_seat\_uid = $ticket\_seat->uid; |
| [364](#L364) |  |
| [365](#L365) | // If seat has been sold then throw error. \*\*\*\*\* |
| [366](#L366) | foreach ( $event\_seats\_current\_details->{$area\_id}->seats as $event\_seats\_data ) { |
| [367](#L367) | foreach ( $event\_seats\_data as $event\_seats\_row ) { |
| [368](#L368) | if ( ($event\_seats\_row->uniqueIndex == $ticket\_seat\_uid) && ($event\_seats\_row->type == 'sold') ) { |
| [369](#L369) | $data = false; |
| [370](#L370) | } |
| [371](#L371) | } |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | } |
| [375](#L375) | } |
| [376](#L376) |  |
| [377](#L377) | } |
| [378](#L378) | } |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | if($data===false) |
| [382](#L382) | { |
| [383](#L383) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Something went wrong.', 'eventprime-event-calendar-management' ) ) ); |
| [384](#L384) | die; |
| [385](#L385) | } |
| [386](#L386) | $event\_id       = absint( $data['ep\_event\_booking\_event\_id'] ); |
| [387](#L387) | $event\_name     = get\_the\_title( $event\_id ); |
| [388](#L388) | $user\_id        = absint( $data['ep\_event\_booking\_user\_id'] ); |
| [389](#L389) | $payment\_method = ! empty( $data['payment\_processor'] ) ? sanitize\_text\_field( $data['payment\_processor'] ) : 'paypal'; |
| [390](#L390) | if( ! isset( $data['ep\_event\_booking\_total\_price'] ) || empty( $data['ep\_event\_booking\_total\_price'] ) ) { |
| [391](#L391) | $payment\_method = 'none'; |
| [392](#L392) | } |
| [393](#L393) |  |
| [394](#L394) | $post\_status = 'pending'; |
| [395](#L395) |  |
| [396](#L396) | if ( class\_exists("Eventprime\_Admin\_Attendee\_Booking") && !empty( get\_option( 'ep\_set\_admin\_aab\_'.$current\_user->ID )) ) { |
| [397](#L397) | $post\_status = 'completed'; |
| [398](#L398) | delete\_option( 'ep\_set\_admin\_aab\_'.$current\_user->ID ); |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | if( isset( $data['ep\_rg\_field\_email'] ) && ! empty( $data['ep\_rg\_field\_email'] ) ) { |
| [402](#L402) | if( isset($data['ep\_rg\_field\_user\_name'] ) && ! empty( $data['ep\_rg\_field\_user\_name'] ) ) { |
| [403](#L403) | $user\_controller = new EventM\_User\_Controller(); |
| [404](#L404) | $user\_data = new stdClass(); |
| [405](#L405) | $user\_data->email = sanitize\_text\_field($data['ep\_rg\_field\_email']); |
| [406](#L406) | $user\_data->username = sanitize\_text\_field($data['ep\_rg\_field\_user\_name']); |
| [407](#L407) | $user\_data->fname = isset($data['ep\_rg\_field\_first\_name']) ? sanitize\_text\_field($data['ep\_rg\_field\_first\_name']) : ''; |
| [408](#L408) | $user\_data->lname = isset($data['ep\_rg\_field\_last\_name']) ? sanitize\_text\_field($data['ep\_rg\_field\_last\_name']) : ''; |
| [409](#L409) | $user\_data->password = sanitize\_text\_field($data['ep\_rg\_field\_password']); |
| [410](#L410) | $user = get\_user\_by( 'email', $user\_data->email ); |
| [411](#L411) | if(!empty($user)){ |
| [412](#L412) | $user\_id = $user->ID; |
| [413](#L413) | }else{ |
| [414](#L414) | $user\_id = $user\_controller->ep\_checkout\_registration($user\_data); |
| [415](#L415) | } |
| [416](#L416) | } |
| [417](#L417) | } |
| [418](#L418) | // add new booking |
| [419](#L419) | $new\_post = array( |
| [420](#L420) | 'post\_title'  => $event\_name, |
| [421](#L421) | 'post\_status' => $post\_status, |
| [422](#L422) | 'post\_type'   => 'em\_booking', |
| [423](#L423) | 'post\_author' => $user\_id, |
| [424](#L424) | ); |
| [425](#L425) | $new\_post\_id = wp\_insert\_post( $new\_post ); // new post id |
| [426](#L426) |  |
| [427](#L427) | update\_post\_meta( $new\_post\_id, 'em\_id', $new\_post\_id ); |
| [428](#L428) | update\_post\_meta( $new\_post\_id, 'em\_event', $event\_id ); |
| [429](#L429) | update\_post\_meta( $new\_post\_id, 'em\_date', current\_time( 'timestamp' ) ); |
| [430](#L430) | update\_post\_meta( $new\_post\_id, 'em\_user', $user\_id ); |
| [431](#L431) | update\_post\_meta( $new\_post\_id, 'em\_name', $event\_name ); |
| [432](#L432) | update\_post\_meta( $new\_post\_id, 'em\_status', $post\_status ); |
| [433](#L433) | update\_post\_meta( $new\_post\_id, 'em\_payment\_method', $payment\_method ); |
| [434](#L434) | if( isset( $\_POST['rid'] ) && ! empty( $\_POST['rid'] ) ) { |
| [435](#L435) | update\_post\_meta( $new\_post\_id, 'em\_random\_order\_id', sanitize\_text\_field( $\_POST['rid'] ) ); |
| [436](#L436) | } |
| [437](#L437) | // order info |
| [438](#L438) | $order\_info = array(); |
| [439](#L439) | $order\_info['tickets']           = json\_decode( $data['ep\_event\_booking\_ticket\_data'] ); |
| [440](#L440) | $order\_info['event\_fixed\_price'] = ( ! empty( $data['ep\_event\_booking\_event\_fixed\_price'] ) ? $data['ep\_event\_booking\_event\_fixed\_price'] : 0.00 ); |
| [441](#L441) | $order\_info['booking\_total']     = ( ! empty( $data['ep\_event\_booking\_total\_price'] ) ? $data['ep\_event\_booking\_total\_price'] : 0.00 ); |
| [442](#L442) | $order\_info = apply\_filters('ep\_update\_booking\_order\_info', $order\_info, $data); |
| [443](#L443) | update\_post\_meta( $new\_post\_id, 'em\_order\_info', $order\_info ); |
| [444](#L444) | update\_post\_meta( $new\_post\_id, 'em\_notes', array() ); |
| [445](#L445) | update\_post\_meta( $new\_post\_id, 'em\_payment\_log', array() ); |
| [446](#L446) | update\_post\_meta( $new\_post\_id, 'em\_booked\_seats', array() ); |
| [447](#L447) | $ep\_booking\_attendee\_fields =(isset($data['ep\_booking\_attendee\_fields']))?$sanitizer->sanitize($data['ep\_booking\_attendee\_fields']):array(); |
| [448](#L448) | update\_post\_meta( $new\_post\_id, 'em\_attendee\_names', $ep\_booking\_attendee\_fields ); |
| [449](#L449) | // check for booking fields data |
| [450](#L450) | $em\_booking\_fields\_data = array(); |
| [451](#L451) | if( ! empty( $data['ep\_booking\_booking\_fields'] ) ) { |
| [452](#L452) | $em\_booking\_fields\_data = $data['ep\_booking\_booking\_fields']; |
| [453](#L453) | } |
| [454](#L454) | update\_post\_meta( $new\_post\_id, 'em\_booking\_fields\_data', $em\_booking\_fields\_data ); |
| [455](#L455) | $order\_key = $ep\_functions->ep\_encrypt\_decrypt\_pass('encrypt', 'ep\_order\_'.$new\_post\_id); |
| [456](#L456) | update\_post\_meta( $new\_post\_id, 'ep\_order\_key', $order\_key ); |
| [457](#L457) |  |
| [458](#L458) | do\_action( 'ep\_after\_booking\_created', $new\_post\_id, $data ); |
| [459](#L459) |  |
| [460](#L460) | // if booking total is 0 then confirm booking |
| [461](#L461) | if( $payment\_method == 'none' && empty( $order\_info['booking\_total'] ) ){ |
| [462](#L462) | $data['payment\_gateway'] = 'none'; |
| [463](#L463) | $data['payment\_status']  = 'completed'; |
| [464](#L464) | $data['total\_amount']    = $order\_info['booking\_total']; |
| [465](#L465) | $booking\_controller      = new EventPrime\_Bookings; |
| [466](#L466) | $booking\_controller->confirm\_booking( $new\_post\_id, $data ); |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | $response                 = new stdClass(); |
| [470](#L470) | $response->order\_id       = $new\_post\_id; |
| [471](#L471) | $response->payment\_method = $payment\_method; |
| [472](#L472) | $response->post\_status    = $post\_status; |
| [473](#L473) | $response->booking\_total  = $data['ep\_event\_booking\_total\_price']; |
| [474](#L474) | $response->item\_total     = $data['ep\_event\_booking\_total\_tickets']; |
| [475](#L475) | $response->discount\_total = (isset($data['ep\_event\_booking\_total\_discount']))?$data['ep\_event\_booking\_total\_discount']:''; |
| [476](#L476) | // $redirect                 = esc\_url( add\_query\_arg( array( 'order\_id' => $new\_post\_id ), get\_permalink( ep\_get\_global\_settings( 'booking\_details\_page' ) ) ) ); |
| [477](#L477) | $redirect                 = add\_query\_arg( array( 'order\_id' => $new\_post\_id ), esc\_url( get\_permalink( $ep\_functions->ep\_get\_global\_settings( 'booking\_details\_page' ) ) ) ); |
| [478](#L478) | $response->redirect       = apply\_filters( 'ep\_booking\_redirection\_url', $redirect, $new\_post\_id ); |
| [479](#L479) | wp\_send\_json\_success( $response ); |
| [480](#L480) | } else{ |
| [481](#L481) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [482](#L482) | } |
| [483](#L483) | } else{ |
| [484](#L484) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Data Not Found', 'eventprime-event-calendar-management' ) ) ); |
| [485](#L485) | } |
| [486](#L486) | } |
| [487](#L487) |  |
| [488](#L488) | /\*\* |
| [489](#L489) | \* Delete booking timer data from option table |
| [490](#L490) | \*/ |
| [491](#L491) | public function booking\_timer\_complete() { |
| [492](#L492) | check\_ajax\_referer( 'flush\_event\_booking\_timer\_nonce', 'security' ); |
| [493](#L493) | delete\_option( 'ep\_event\_booking\_timer\_start' ); |
| [494](#L494) | $booking\_data = json\_decode( stripslashes( $\_POST['booking\_data'] ) ); |
| [495](#L495) |  |
| [496](#L496) | do\_action( 'ep\_event\_booking\_timer\_finished', $booking\_data ); |
| [497](#L497) | wp\_send\_json\_success(true); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | /\*\* |
| [501](#L501) | \* Method call from paypal approval |
| [502](#L502) | \*/ |
| [503](#L503) | public function paypal\_sbpr() { |
| [504](#L504) | if( isset( $\_POST ) && ! empty( $\_POST ) ) { |
| [505](#L505) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [506](#L506) | $data       = $ep\_functions->ep\_sanitize\_input($\_POST['data']); |
| [507](#L507) | $booking\_id = absint( $\_POST['order\_id'] ); |
| [508](#L508) | $order\_info = maybe\_unserialize(get\_post\_meta($booking\_id,'em\_order\_info',true)); |
| [509](#L509) |  |
| [510](#L510) | if( ! empty( $booking\_id ) && ! empty( $data ) && $order\_info['booking\_total'] == $data['purchase\_units'][0]['amount']['value']) { |
| [511](#L511) | $data['payment\_gateway'] = 'paypal'; |
| [512](#L512) | $data['payment\_status']  = strtolower( $data['status'] ); |
| [513](#L513) | $data['total\_amount']    = $data['purchase\_units'][0]['amount']['value']; |
| [514](#L514) | $data['currency']        = $ep\_functions->ep\_get\_global\_settings('currency'); |
| [515](#L515) | $booking\_controller = new EventPrime\_Bookings; |
| [516](#L516) | $booking\_controller->confirm\_booking( $booking\_id, $data ); |
| [517](#L517) | //$return\_url = esc\_url( add\_query\_arg( array( 'order\_id' => $booking\_id ), get\_permalink( ep\_get\_global\_settings( 'booking\_details\_page' ) ) ) ); |
| [518](#L518) | $redirect        = add\_query\_arg( array( 'order\_id' => $booking\_id ), esc\_url( get\_permalink( $ep\_functions->ep\_get\_global\_settings( 'booking\_details\_page' ) ) ) ); |
| [519](#L519) | $return\_url       = apply\_filters( 'ep\_booking\_redirection\_url', $redirect, $booking\_id ); |
| [520](#L520) |  |
| [521](#L521) | $response = array( 'status' => 'success', 'redirect' => $return\_url ); |
| [522](#L522) | wp\_send\_json\_success($response); |
| [523](#L523) | } |
| [524](#L524) | } |
| [525](#L525) | } |
| [526](#L526) |  |
| [527](#L527) | /\*\* |
| [528](#L528) | \* Booking cancellation action |
| [529](#L529) | \*/ |
| [530](#L530) | public function event\_booking\_cancel() { |
| [531](#L531) | if( wp\_verify\_nonce( $\_POST['security'], 'event-booking-cancellation-nonce' ) ) { |
| [532](#L532) | if( isset( $\_POST['booking\_id'] ) ) { |
| [533](#L533) | $booking\_id = absint( $\_POST['booking\_id'] ); |
| [534](#L534) | if( ! empty( $booking\_id ) ) { |
| [535](#L535) | if (is\_user\_logged\_in()) { |
| [536](#L536) | $current\_user\_id = get\_current\_user\_id(); |
| [537](#L537) | $booking\_controller = new EventPrime\_Bookings; |
| [538](#L538) | $notification = new EventM\_Notification\_Service(); |
| [539](#L539) | $booking = $booking\_controller->load\_booking\_detail( $booking\_id ); |
| [540](#L540) | if( ! empty( $booking ) && $booking->em\_user==$current\_user\_id) { |
| [541](#L541) | if ( $booking->em\_status == 'cancelled' ) { |
| [542](#L542) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'The booking is already cancelled', 'eventprime-event-calendar-management' ) ) ); |
| [543](#L543) | } |
| [544](#L544) | if( $booking->em\_status == 'refunded' ) { |
| [545](#L545) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'The booking can not be cancelled. The amount is already refunded', 'eventprime-event-calendar-management' ) ) ); |
| [546](#L546) | } |
| [547](#L547) | if( ! empty( $booking->em\_user ) && get\_current\_user\_id() != $booking->em\_user ) { |
| [548](#L548) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'You are not allowed to cancel this booking', 'eventprime-event-calendar-management' ) ) ); |
| [549](#L549) | } |
| [550](#L550) |  |
| [551](#L551) | // cancel the booking |
| [552](#L552) | update\_post\_meta( $booking->em\_id, 'em\_status', 'cancelled' ); |
| [553](#L553) |  |
| [554](#L554) | $booking\_controller->update\_status( $booking\_id, 'cancelled' ); |
| [555](#L555) |  |
| [556](#L556) | // send cancellation mail |
| [557](#L557) | $notification->booking\_cancel( $booking\_id ); |
| [558](#L558) |  |
| [559](#L559) | do\_action( 'ep\_after\_booking\_cancelled', $booking ); |
| [560](#L560) |  |
| [561](#L561) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Booking Cancelled Successfully', 'eventprime-event-calendar-management' ) ) ); |
| [562](#L562) | } else{ |
| [563](#L563) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Invalid Data', 'eventprime-event-calendar-management' ) ) ); |
| [564](#L564) | } |
| [565](#L565) | } else{ |
| [566](#L566) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'You are not allowed to cancel this booking', 'eventprime-event-calendar-management' ) ) ); |
| [567](#L567) | } |
| [568](#L568) | } |
| [569](#L569) | } |
| [570](#L570) | } else{ |
| [571](#L571) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [572](#L572) | } |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | /\* |
| [576](#L576) | \* Add booking Notes |
| [577](#L577) | \*/ |
| [578](#L578) | public function booking\_add\_notes(){ |
| [579](#L579) | if( isset( $\_POST['booking\_id'] ) && isset($\_POST['note']) && !empty(trim($\_POST['note']))) { |
| [580](#L580) | $booking\_id = absint( $\_POST['booking\_id'] ); |
| [581](#L581) | $note = sanitize\_text\_field($\_POST['note']); |
| [582](#L582) | $booking\_controller = new EventPrime\_Bookings(); |
| [583](#L583) | $response = $booking\_controller->add\_notes( $booking\_id, $note); |
| [584](#L584) | wp\_send\_json\_success( $response ); |
| [585](#L585) | }else{ |
| [586](#L586) | wp\_send\_json\_error(); |
| [587](#L587) | } |
| [588](#L588) | } |
| [589](#L589) |  |
| [590](#L590) | /\*\* |
| [591](#L591) | \* Event wishlist action |
| [592](#L592) | \*/ |
| [593](#L593) | public function event\_wishlist\_action() { |
| [594](#L594) | if( isset($\_POST['security']) && wp\_verify\_nonce( $\_POST['security'], 'event-wishlist-action-nonce' ) ){ |
| [595](#L595) | if( isset( $\_POST['event\_id'] ) && ! empty( $\_POST['event\_id'] ) ) { |
| [596](#L596) | $event\_id = absint( $\_POST['event\_id'] ); |
| [597](#L597) | $user\_id = get\_current\_user\_id(); |
| [598](#L598) | if( empty( $user\_id ) ) { |
| [599](#L599) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'You need to login to add event to wishlist', 'eventprime-event-calendar-management' ) ) ); |
| [600](#L600) | } |
| [601](#L601) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [602](#L602) | $single\_event = $ep\_functions->get\_single\_event( $event\_id ); |
| [603](#L603) | if( empty( $single\_event ) ) { |
| [604](#L604) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Event Not Found', 'eventprime-event-calendar-management' ) ) ); |
| [605](#L605) | } |
| [606](#L606) | // get user wishlist meta |
| [607](#L607) | $wishlist\_meta = get\_user\_meta( $user\_id, 'ep\_wishlist\_event', true ); |
| [608](#L608) | if( empty( $wishlist\_meta ) ) { // if empty the add event id |
| [609](#L609) | $wishlist\_array = array( $event\_id => 1 ); |
| [610](#L610) | update\_user\_meta( $user\_id, 'ep\_wishlist\_event', $wishlist\_array ); |
| [611](#L611) | wp\_send\_json\_success( array( 'action' => 'add', 'title'=> $ep\_functions->ep\_global\_settings\_button\_title( 'Remove From Wishlist' ), 'message' => esc\_html\_\_( 'Event added successfully into wishlist', 'eventprime-event-calendar-management' ) ) ); |
| [612](#L612) | } else{ |
| [613](#L613) | // if already added then remove the event from wishlist |
| [614](#L614) | if( array\_key\_exists( $event\_id, $wishlist\_meta ) ) { |
| [615](#L615) | unset( $wishlist\_meta[$event\_id] ); |
| [616](#L616) | update\_user\_meta( $user\_id, 'ep\_wishlist\_event', $wishlist\_meta ); |
| [617](#L617) | wp\_send\_json\_success( array( 'action' => 'remove', 'title'=> $ep\_functions->ep\_global\_settings\_button\_title( 'Add To Wishlist' ), 'message' => esc\_html\_\_( 'Event removed successfully from wishlist', 'eventprime-event-calendar-management' ) ) ); |
| [618](#L618) | } else{ |
| [619](#L619) | $wishlist\_meta[$event\_id] = 1; |
| [620](#L620) | update\_user\_meta( $user\_id, 'ep\_wishlist\_event', $wishlist\_meta ); |
| [621](#L621) | wp\_send\_json\_success( array( 'action' => 'add', 'title'=> $ep\_functions->ep\_global\_settings\_button\_title( 'Remove From Wishlist' ), 'message' => esc\_html\_\_( 'Event added successfully into wishlist', 'eventprime-event-calendar-management' ) ) ); |
| [622](#L622) | } |
| [623](#L623) | } |
| [624](#L624) | } else{ |
| [625](#L625) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Wrong data.', 'eventprime-event-calendar-management' ) ) ); |
| [626](#L626) | } |
| [627](#L627) | } else{ |
| [628](#L628) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [629](#L629) | } |
| [630](#L630) | } |
| [631](#L631) |  |
| [632](#L632) | /\*\* |
| [633](#L633) | \* Submit the frontend event submission form |
| [634](#L634) | \*/ |
| [635](#L635) | public function save\_frontend\_event\_submission() { |
| [636](#L636) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-frontend-event-submission-nonce' ) ) { |
| [637](#L637) | global $wpdb; |
| [638](#L638) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [639](#L639) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [640](#L640) | $notifications = new EventM\_Notification\_Service; |
| [641](#L641) | $sanitizer = new EventPrime\_sanitizer; |
| [642](#L642) | $em\_name = htmlspecialchars\_decode( sanitize\_text\_field( $data['em\_name'] ) ); |
| [643](#L643) |  |
| [644](#L644) | $result = array( 'success' => 1, 'msg' => '' ); |
| [645](#L645) | $checkpoint = apply\_filters('ep\_handle\_frontend\_submission\_additional\_check',$result, $data); |
| [646](#L646) | if(isset($checkpoint['success']) && empty($checkpoint['success'])){ |
| [647](#L647) | wp\_send\_json\_error( array( 'error' =>  $checkpoint['msg']) ); |
| [648](#L648) | die(); |
| [649](#L649) | } |
| [650](#L650) | if( empty( $em\_name ) ) { |
| [651](#L651) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Event Name cannot be empty.', 'eventprime-event-calendar-management' ) ) ); |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | $guest\_submission = $ep\_functions->ep\_get\_global\_settings('allow\_submission\_by\_anonymous\_user'); |
| [655](#L655) | if( empty( $guest\_submission ) && empty( get\_current\_user\_id() ) ) { |
| [656](#L656) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'User login required to submit event.', 'eventprime-event-calendar-management' ) ) ); |
| [657](#L657) | } |
| [658](#L658) |  |
| [659](#L659) | if(empty($guest\_submission)){ |
| [660](#L660) | $hasUserRestriction = 0; |
| [661](#L661) | $frontend\_submission\_roles = (array) $ep\_functions->ep\_get\_global\_settings( 'frontend\_submission\_roles' ); |
| [662](#L662) | if( ! empty( $frontend\_submission\_roles ) ) { |
| [663](#L663) | $user = wp\_get\_current\_user(); |
| [664](#L664) | foreach ( $user->roles as $key => $value ) { |
| [665](#L665) | if( in\_array( $value, $frontend\_submission\_roles ) ) { |
| [666](#L666) | $hasUserRestriction = 1; |
| [667](#L667) | break; |
| [668](#L668) | } |
| [669](#L669) | } |
| [670](#L670) | }else{ |
| [671](#L671) | $hasUserRestriction = 1; |
| [672](#L672) | } |
| [673](#L673) | if(empty($hasUserRestriction)){ |
| [674](#L674) | wp\_send\_json\_error( array( 'error' => $ep\_functions->ep\_get\_global\_settings('ues\_restricted\_submission\_message') ) ); |
| [675](#L675) | } |
| [676](#L676) | } |
| [677](#L677) |  |
| [678](#L678) |  |
| [679](#L679) |  |
| [680](#L680) | $post\_status = $ep\_functions->ep\_get\_global\_settings( 'ues\_default\_status' ); |
| [681](#L681) | if( empty( $post\_status ) ) { |
| [682](#L682) | $post\_status = 'draft'; |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | $event\_description = wp\_kses\_post( stripslashes( $data['em\_descriptions'] ) ); |
| [686](#L686) |  |
| [687](#L687) | if( isset( $data['event\_id'] ) && ! empty( $data['event\_id'] ) ) { |
| [688](#L688) | $post\_id = $data['event\_id']; |
| [689](#L689) | if(empty(get\_post($post\_id)) || get\_post\_type($post\_id) != 'em\_event' ){ |
| [690](#L690) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'There is some issue with event. Please try later.', 'eventprime-event-calendar-management' ) ) ); |
| [691](#L691) | } |
| [692](#L692) | if(!empty($guest\_submission) && get\_post\_meta($post\_id, 'em\_user\_submitted', true) != get\_current\_user\_id()){ |
| [693](#L693) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Event does not belong to you.', 'eventprime-event-calendar-management' ) ) ); |
| [694](#L694) |  |
| [695](#L695) | } |
| [696](#L696) | $post\_update = array( |
| [697](#L697) | 'ID'         => $post\_id, |
| [698](#L698) | 'post\_title' => $em\_name, |
| [699](#L699) | 'post\_content' => $event\_description, |
| [700](#L700) | ); |
| [701](#L701) | wp\_update\_post( $post\_update ); |
| [702](#L702) | }else{ |
| [703](#L703) | $post\_id = wp\_insert\_post(array ( |
| [704](#L704) | 'post\_type' => 'em\_event', |
| [705](#L705) | 'post\_title' => $em\_name, |
| [706](#L706) | 'post\_content' => $event\_description, |
| [707](#L707) | 'post\_status' => $post\_status, |
| [708](#L708) | 'post\_author' => get\_current\_user\_id(), |
| [709](#L709) | )); |
| [710](#L710) | } |
| [711](#L711) |  |
| [712](#L712) | update\_post\_meta( $post\_id, 'em\_frontend\_submission', 1 ); |
| [713](#L713) | update\_post\_meta( $post\_id, 'em\_user\_submitted', 1 ); |
| [714](#L714) | update\_post\_meta( $post\_id, 'em\_user', get\_current\_user\_id() ); |
| [715](#L715) |  |
| [716](#L716) | update\_post\_meta( $post\_id, 'em\_id', $post\_id ); |
| [717](#L717) | update\_post\_meta( $post\_id, 'em\_name', $em\_name ); |
| [718](#L718) |  |
| [719](#L719) | $event\_data = new stdClass(); |
| [720](#L720) | $thumbnail\_id = isset( $data['attachment\_id'] ) ? $data['attachment\_id'] : ''; |
| [721](#L721) | set\_post\_thumbnail( $post\_id, $thumbnail\_id ); |
| [722](#L722) |  |
| [723](#L723) | $em\_start\_date = isset( $data['em\_start\_date'] ) ? $ep\_functions->ep\_date\_to\_timestamp( sanitize\_text\_field( $data['em\_start\_date'] ) ) : ''; |
| [724](#L724) | update\_post\_meta($post\_id, 'em\_start\_date', $em\_start\_date); |
| [725](#L725) |  |
| [726](#L726) | $em\_start\_time = isset( $data['em\_start\_time'] ) ? sanitize\_text\_field( $data['em\_start\_time'] ) : ''; |
| [727](#L727) | update\_post\_meta($post\_id, 'em\_start\_time', $em\_start\_time); |
| [728](#L728) |  |
| [729](#L729) | $em\_hide\_event\_start\_time = isset( $data['em\_hide\_event\_start\_time'] ) && !empty($data['em\_hide\_event\_start\_time'] ) ? 1 : 0; |
| [730](#L730) | update\_post\_meta( $post\_id, 'em\_hide\_event\_start\_time', $em\_hide\_event\_start\_time ); |
| [731](#L731) |  |
| [732](#L732) | $em\_hide\_event\_start\_date = isset( $data['em\_hide\_event\_start\_date'] ) && !empty( $data['em\_hide\_event\_start\_date'] ) ? 1 : 0; |
| [733](#L733) | update\_post\_meta( $post\_id, 'em\_hide\_event\_start\_date', $em\_hide\_event\_start\_date ); |
| [734](#L734) |  |
| [735](#L735) | $em\_end\_date = isset( $data['em\_end\_date'] ) ? $ep\_functions->ep\_date\_to\_timestamp( sanitize\_text\_field( $data['em\_end\_date'] ) ) : $em\_start\_date; |
| [736](#L736) | update\_post\_meta($post\_id, 'em\_end\_date', $em\_end\_date); |
| [737](#L737) |  |
| [738](#L738) | $em\_end\_time = isset( $data['em\_end\_time'] ) ? sanitize\_text\_field( $data['em\_end\_time'] ) : ''; |
| [739](#L739) | update\_post\_meta($post\_id, 'em\_end\_time', $em\_end\_time); |
| [740](#L740) |  |
| [741](#L741) | $em\_hide\_event\_end\_time = isset( $data['em\_hide\_event\_end\_time'] ) && !empty($data['em\_hide\_event\_end\_time']) ? 1 : 0; |
| [742](#L742) | update\_post\_meta( $post\_id, 'em\_hide\_event\_end\_time', $em\_hide\_event\_end\_time ); |
| [743](#L743) |  |
| [744](#L744) | $em\_hide\_end\_date = isset( $data['em\_hide\_end\_date'] ) && !empty( $data['em\_hide\_end\_date'] )? 1 : 0; |
| [745](#L745) | update\_post\_meta( $post\_id, 'em\_hide\_end\_date', $em\_hide\_end\_date ); |
| [746](#L746) |  |
| [747](#L747) | $em\_all\_day = isset( $data['em\_all\_day'] ) ? 1 : 0; |
| [748](#L748) | update\_post\_meta( $post\_id, 'em\_all\_day', $em\_all\_day ); |
| [749](#L749) | // if event is all day then end date will be same as start date |
| [750](#L750) | if( $em\_all\_day == 1 ) { |
| [751](#L751) | $em\_end\_date = $em\_start\_date; |
| [752](#L752) | update\_post\_meta( $post\_id, 'em\_end\_date', $em\_end\_date ); |
| [753](#L753) | $em\_start\_time = '12:00 AM'; $em\_end\_time = '11:59 PM'; |
| [754](#L754) | update\_post\_meta( $post\_id, 'em\_start\_time', $em\_start\_time ); |
| [755](#L755) | update\_post\_meta( $post\_id, 'em\_end\_time', $em\_end\_time ); |
| [756](#L756) | } |
| [757](#L757) | // update start and end datetime meta |
| [758](#L758) | $ep\_date\_time\_format = 'Y-m-d'; |
| [759](#L759) | $start\_date = get\_post\_meta( $post\_id, 'em\_start\_date', true ); |
| [760](#L760) | $start\_time = get\_post\_meta( $post\_id, 'em\_start\_time', true ); |
| [761](#L761) | $merge\_start\_date\_time = $ep\_functions->ep\_datetime\_to\_timestamp( $ep\_functions->ep\_timestamp\_to\_date( $start\_date, 'Y-m-d', 1 ) . ' ' . $start\_time, $ep\_date\_time\_format, '', 0, 1 ); |
| [762](#L762) | if( ! empty( $merge\_start\_date\_time ) ) { |
| [763](#L763) | update\_post\_meta( $post\_id, 'em\_start\_date\_time', $merge\_start\_date\_time ); |
| [764](#L764) | } |
| [765](#L765) | $end\_date = get\_post\_meta( $post\_id, 'em\_end\_date', true ); |
| [766](#L766) | $end\_time = get\_post\_meta( $post\_id, 'em\_end\_time', true ); |
| [767](#L767) | $merge\_end\_date\_time = $ep\_functions->ep\_datetime\_to\_timestamp( $ep\_functions->ep\_timestamp\_to\_date( $end\_date, 'Y-m-d', 1 ) . ' ' . $end\_time, $ep\_date\_time\_format, '', 0, 1 ); |
| [768](#L768) | if( ! empty( $merge\_end\_date\_time ) ) { |
| [769](#L769) | update\_post\_meta( $post\_id, 'em\_end\_date\_time', $merge\_end\_date\_time ); |
| [770](#L770) | } |
| [771](#L771) |  |
| [772](#L772) | $em\_event\_date\_placeholder = isset( $data['em\_event\_date\_placeholder'] ) ? sanitize\_text\_field( $data['em\_event\_date\_placeholder'] ) : ''; |
| [773](#L773) | update\_post\_meta( $post\_id, 'em\_event\_date\_placeholder', $em\_event\_date\_placeholder ); |
| [774](#L774) | $em\_event\_date\_placeholder\_custom\_note = ''; |
| [775](#L775) | if( ! empty( $em\_event\_date\_placeholder ) && $em\_event\_date\_placeholder == 'custom\_note' ) { |
| [776](#L776) | $em\_event\_date\_placeholder\_custom\_note = sanitize\_text\_field( $data['em\_event\_date\_placeholder\_custom\_note'] ); |
| [777](#L777) | } |
| [778](#L778) | update\_post\_meta( $post\_id, 'em\_event\_date\_placeholder\_custom\_note', $em\_event\_date\_placeholder\_custom\_note ); |
| [779](#L779) |  |
| [780](#L780) | // add event more dates |
| [781](#L781) | $em\_event\_more\_dates = isset( $data['em\_event\_more\_dates'] ) ? 1 : 0; |
| [782](#L782) | update\_post\_meta( $post\_id, 'em\_event\_more\_dates', $em\_event\_more\_dates ); |
| [783](#L783) | $event\_more\_dates = array(); |
| [784](#L784) | if( isset( $data['em\_event\_more\_dates'] ) && !empty( $data['em\_event\_more\_dates'] ) ) { |
| [785](#L785) | if( isset( $data['em\_event\_add\_more\_dates'] ) && count( $data['em\_event\_add\_more\_dates'] ) > 0 ) { |
| [786](#L786) | foreach( $data['em\_event\_add\_more\_dates'] as $key => $more\_dates ) { |
| [787](#L787) | $new\_date = array(); |
| [788](#L788) | $new\_date['uid']    = absint( $more\_dates['uid'] ); |
| [789](#L789) | $new\_date['date']   = $ep\_functions->ep\_date\_to\_timestamp( sanitize\_text\_field( $more\_dates['date'] ) ); |
| [790](#L790) | $new\_date['time']   = sanitize\_text\_field( $more\_dates['time'] ); |
| [791](#L791) | $new\_date['label']  = sanitize\_text\_field( $more\_dates['label'] ); |
| [792](#L792) | $event\_more\_dates[] = $new\_date; |
| [793](#L793) | } |
| [794](#L794) | } |
| [795](#L795) | } |
| [796](#L796) | update\_post\_meta( $post\_id, 'em\_event\_add\_more\_dates', $event\_more\_dates ); |
| [797](#L797) |  |
| [798](#L798) | // booking & tickets |
| [799](#L799) | $em\_enable\_booking = isset( $data['em\_enable\_booking'] ) ? sanitize\_text\_field( $data['em\_enable\_booking'] ) : 'bookings\_off'; |
| [800](#L800) | update\_post\_meta( $post\_id, 'em\_enable\_booking', $em\_enable\_booking ); |
| [801](#L801) | // check for external booking |
| [802](#L802) | if( ! empty( $em\_enable\_booking ) && $em\_enable\_booking == 'external\_bookings' ) { |
| [803](#L803) | $em\_custom\_link = isset( $data['em\_custom\_link'] ) && ! empty( $data['em\_custom\_link'] ) ? sanitize\_url( $data['em\_custom\_link'] ) : ''; |
| [804](#L804) | update\_post\_meta( $post\_id, 'em\_custom\_link', $em\_custom\_link ); |
| [805](#L805) | // open in new browser |
| [806](#L806) | $em\_custom\_link\_new\_browser = isset( $data['em\_custom\_link\_new\_browser'] ) ? 1 : 0; |
| [807](#L807) | update\_post\_meta( $post\_id, 'em\_custom\_link\_new\_browser', $em\_custom\_link\_new\_browser ); |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | // One time event fee |
| [811](#L811) | $em\_fixed\_event\_price = isset( $data['em\_fixed\_event\_price'] ) && ! empty( $data['em\_fixed\_event\_price'] ) ? sanitize\_text\_field( $data['em\_fixed\_event\_price'] ) : ''; |
| [812](#L812) | update\_post\_meta( $post\_id, 'em\_fixed\_event\_price', $em\_fixed\_event\_price ); |
| [813](#L813) | // hide booking status |
| [814](#L814) | $em\_hide\_booking\_status = isset( $data['em\_hide\_booking\_status'] ) ? 1 : 0; |
| [815](#L815) | update\_post\_meta( $post\_id, 'em\_hide\_booking\_status', $em\_hide\_booking\_status ); |
| [816](#L816) | // allow cancellation option |
| [817](#L817) | $em\_allow\_cancellations = isset( $data['em\_allow\_cancellations'] ) ? 1 : 0; |
| [818](#L818) | update\_post\_meta( $post\_id, 'em\_allow\_cancellations', $em\_allow\_cancellations ); |
| [819](#L819) |  |
| [820](#L820) | // event type |
| [821](#L821) | if( isset( $data['em\_event\_type'] ) && ! empty( $data['em\_event\_type'] ) ) { |
| [822](#L822) | $em\_event\_type\_id = absint( $data['em\_event\_type'] ); |
| [823](#L823) | update\_post\_meta( $post\_id, 'em\_event\_type', $em\_event\_type\_id ); |
| [824](#L824) | wp\_set\_object\_terms( $post\_id, intval( $em\_event\_type\_id ), 'em\_event\_type' ); |
| [825](#L825) | if( $data['em\_event\_type'] == 'new\_event\_type' ) { |
| [826](#L826) | $type\_data = new stdClass(); |
| [827](#L827) | $type\_data->name = isset( $data['new\_event\_type\_name'] ) ? sanitize\_text\_field( $data['new\_event\_type\_name'] ) : ''; |
| [828](#L828) | if( ! empty( trim( $type\_data->name ) ) ) { |
| [829](#L829) | $eventType = $type\_data->name; |
| [830](#L830) | $type\_term = get\_term\_by( 'name', $eventType, 'em\_event\_type' ); |
| [831](#L831) | if( empty( $type\_term ) ) { |
| [832](#L832) | $type\_data->em\_color = isset($data['new\_event\_type\_background\_color']) ? sanitize\_text\_field($data['new\_event\_type\_background\_color']) : '#FF5599'; |
| [833](#L833) | $type\_data->em\_type\_text\_color = isset($data['new\_event\_type\_text\_color']) ? sanitize\_text\_field($data['new\_event\_type\_text\_color']) : '#43CDFF'; |
| [834](#L834) | $type\_data->em\_age\_group = isset($data['ep\_new\_event\_type\_age\_group']) ? sanitize\_text\_field($data['ep\_new\_event\_type\_age\_group']) : 'all'; |
| [835](#L835) | $type\_data->custom\_age = isset($data['ep-new\_event\_type\_custom\_group']) ? sanitize\_text\_field($data['ep-new\_event\_type\_custom\_group']) : ''; |
| [836](#L836) | $type\_data->description = isset($data['new\_event\_type\_description']) ? $data['new\_event\_type\_description'] : ''; |
| [837](#L837) | $type\_data->em\_image\_id = isset($data['event\_type\_image\_id']) ? $data['event\_type\_image\_id'] : ''; |
| [838](#L838) | $em\_event\_type\_id = $ep\_functions->create\_event\_types((array)$type\_data); |
| [839](#L839) | } else{ |
| [840](#L840) | $em\_event\_type\_id = $type\_term->term\_id; |
| [841](#L841) | } |
| [842](#L842) | update\_post\_meta( $post\_id, 'em\_event\_type', $em\_event\_type\_id ); |
| [843](#L843) | wp\_set\_object\_terms( $post\_id, intval( $em\_event\_type\_id ), 'em\_event\_type' ); |
| [844](#L844) | } |
| [845](#L845) | } |
| [846](#L846) | } |
| [847](#L847) |  |
| [848](#L848) | // venues |
| [849](#L849) | if( isset( $data['em\_venue'] ) && ! empty( $data['em\_venue'] ) ) { |
| [850](#L850) | $em\_venue\_id = absint( $data['em\_venue'] ); |
| [851](#L851) | update\_post\_meta( $post\_id, 'em\_venue', $em\_venue\_id ); |
| [852](#L852) | wp\_set\_object\_terms( $post\_id, intval( $em\_venue\_id ), 'em\_venue' ); |
| [853](#L853) | if( $data['em\_venue'] == 'new\_venue' ) { |
| [854](#L854) | $venue\_data = new stdClass(); |
| [855](#L855) | $venue\_data->name = isset($data['new\_venue']) ? sanitize\_text\_field($data['new\_venue']) : ''; |
| [856](#L856) | if( ! empty( trim( $venue\_data->name ) ) ) { |
| [857](#L857) | $location\_name = $venue\_data->name; |
| [858](#L858) | $location\_term = get\_term\_by( 'name', $location\_name, 'em\_venue' ); |
| [859](#L859) | if( empty( $location\_term ) ) { |
| [860](#L860) | $venue\_data->em\_type = 'standings'; |
| [861](#L861) | $venue\_data->em\_address = isset( $data['em\_address'] ) ? sanitize\_text\_field( $data['em\_address'] ) : ''; |
| [862](#L862) | if( empty( $venue\_data->em\_address ) ) { |
| [863](#L863) | $venue\_data->em\_address = sanitize\_text\_field( $venue\_data->name ); |
| [864](#L864) | } |
| [865](#L865) | $venue\_data->em\_type = isset($data['seating\_type']) ? sanitize\_text\_field($data['seating\_type']) : ''; |
| [866](#L866) | $venue\_data->em\_lng = isset($data['em\_lng']) ? sanitize\_text\_field($data['em\_lng']) : ''; |
| [867](#L867) | $venue\_data->em\_lat = isset($data['em\_lat']) ? sanitize\_text\_field($data['em\_lat']) : ''; |
| [868](#L868) | $venue\_data->em\_state = isset($data['em\_state']) ? sanitize\_text\_field($data['em\_state']) : ''; |
| [869](#L869) | $venue\_data->em\_country = isset($data['em\_country']) ? sanitize\_text\_field($data['em\_country']) : ''; |
| [870](#L870) | $venue\_data->em\_postal\_code = isset($data['em\_postal\_code']) ? sanitize\_text\_field($data['em\_postal\_code']) : ''; |
| [871](#L871) | $venue\_data->em\_zoom\_level = isset($data['em\_zoom\_level']) ? sanitize\_text\_field($data['em\_zoom\_level']) : ''; |
| [872](#L872) | $venue\_data->em\_display\_address\_on\_frontend = isset($data['em\_display\_address\_on\_frontend']) & !empty($data['em\_display\_address\_on\_frontend']) ? 1: 0; |
| [873](#L873) | $venue\_data->em\_established = isset($data['em\_established']) ? sanitize\_text\_field($data['em\_established']) : ''; |
| [874](#L874) | $venue\_data->standing\_capacity = isset($data['standing\_capacity']) ? sanitize\_text\_field($data['standing\_capacity']) : ''; |
| [875](#L875) | $venue\_data->em\_seating\_organizer = isset($data['em\_seating\_organizer']) ? sanitize\_text\_field($data['em\_seating\_organizer']) : ''; |
| [876](#L876) | $venue\_data->em\_facebook\_page = isset($data['em\_facebook\_page']) ? sanitize\_text\_field($data['em\_facebook\_page']) : ''; |
| [877](#L877) | $venue\_data->em\_instagram\_page = isset($data['em\_instagram\_page']) ? sanitize\_text\_field($data['em\_instagram\_page']) : ''; |
| [878](#L878) | $venue\_data->em\_image\_id = isset($data['venue\_attachment\_id']) ? sanitize\_text\_field($data['venue\_attachment\_id']) : ''; |
| [879](#L879) | $em\_venue\_id = $ep\_functions->create\_venue((array)$venue\_data); |
| [880](#L880) | } else{ |
| [881](#L881) | $em\_venue\_id = $location\_term->term\_id; |
| [882](#L882) | } |
| [883](#L883) | update\_post\_meta( $post\_id, 'em\_venue', $em\_venue\_id ); |
| [884](#L884) | wp\_set\_object\_terms( $post\_id, intval( $em\_venue\_id ), 'em\_venue' ); |
| [885](#L885) | } |
| [886](#L886) | } |
| [887](#L887) | } |
| [888](#L888) |  |
| [889](#L889) | // organizer |
| [890](#L890) | $org = array(); |
| [891](#L891) | if( isset( $data['em\_organizer'] ) && !empty( $data['em\_organizer'] ) ) { |
| [892](#L892) | $org = $data['em\_organizer']; |
| [893](#L893) | update\_post\_meta( $post\_id, 'em\_organizer', $org ); |
| [894](#L894) | } |
| [895](#L895) | if( isset( $data['new\_organizer'] ) && $data['new\_organizer'] == 1 ) { |
| [896](#L896) | $organizer\_name = isset( $data['new\_organizer\_name'] ) ? $data['new\_organizer\_name'] : ''; |
| [897](#L897) | if( ! empty( $organizer\_name ) ) { |
| [898](#L898) | $organizer = get\_term\_by( 'name', $organizer\_name, 'em\_event\_organizer' ); |
| [899](#L899) | if( ! empty( $organizer ) ) { |
| [900](#L900) | $org[] = $organizer->term\_id; |
| [901](#L901) | } else{ |
| [902](#L902) | $org\_data = new stdClass(); |
| [903](#L903) | $org\_data->name = $organizer\_name; |
| [904](#L904) |  |
| [905](#L905) | if( isset( $data['em\_organizer\_phones'] ) && ! empty( $data['em\_organizer\_phones'] ) ) { |
| [906](#L906) | $org\_data->em\_organizer\_phones = $data['em\_organizer\_phones']; |
| [907](#L907) | } |
| [908](#L908) | if( isset( $data['em\_organizer\_emails'] ) && ! empty( $data['em\_organizer\_emails'] ) ) { |
| [909](#L909) | $org\_data->em\_organizer\_emails = $data['em\_organizer\_emails']; |
| [910](#L910) | } |
| [911](#L911) | if( isset( $data['em\_organizer\_websites'] ) && ! empty( $data['em\_organizer\_websites'] ) ) { |
| [912](#L912) | $org\_data->em\_organizer\_websites = $data['em\_organizer\_websites']; |
| [913](#L913) | } |
| [914](#L914) | $org\_data->description = isset( $data['new\_event\_organizer\_description'] ) ? $data['new\_event\_organizer\_description'] : ''; |
| [915](#L915) | $org\_data->em\_image\_id = isset( $data['org\_attachment\_id'] ) ? $data['org\_attachment\_id'] : ''; |
| [916](#L916) | $org\_data->em\_social\_links = isset( $data['em\_per\_social\_links'] ) ? $data['em\_per\_social\_links'] : ''; |
| [917](#L917) | $org[] = $ep\_functions->create\_organizer( (array)$org\_data ); |
| [918](#L918) | } |
| [919](#L919) | } |
| [920](#L920) | update\_post\_meta( $post\_id, 'em\_organizer', $org ); |
| [921](#L921) | } |
| [922](#L922) | if( ! empty( $org ) ) { |
| [923](#L923) | foreach( $org as $organizer ) { |
| [924](#L924) | if( ! empty( $organizer ) ) { |
| [925](#L925) | wp\_set\_object\_terms( $post\_id, intval( $organizer ), 'em\_organizer' ); |
| [926](#L926) | } |
| [927](#L927) | } |
| [928](#L928) | } |
| [929](#L929) |  |
| [930](#L930) | $performers = array(); |
| [931](#L931) | if( isset( $data['em\_performer'] ) && !empty( $data['em\_performer'] )) { |
| [932](#L932) | $performers = $data['em\_performer']; |
| [933](#L933) | update\_post\_meta( $post\_id, 'em\_performer', $performers ); |
| [934](#L934) | } |
| [935](#L935) | if( isset( $data['new\_performer'] ) && $data['new\_performer'] == 1 ) { |
| [936](#L936) | $performer\_name = isset( $data['new\_performer\_name'] ) ? $data['new\_performer\_name'] : ''; |
| [937](#L937) | if( ! empty( $performer\_name ) ) { |
| [938](#L938) | $performer\_data = new stdClass(); |
| [939](#L939) | $performer\_data->name = $performer\_name; |
| [940](#L940) | $performer\_data->em\_type = isset( $data['new\_performer\_type'] ) ? sanitize\_text\_field( $data['new\_performer\_type'] ) : 'person'; |
| [941](#L941) | $performer\_data->em\_role = isset( $data['new\_performer\_role'] ) ? sanitize\_text\_field( $data['new\_performer\_role'] ) : ''; |
| [942](#L942) |  |
| [943](#L943) | if(isset($data['em\_performer\_phones']) && !empty($data['em\_performer\_phones'])){ |
| [944](#L944) | $performer\_data->em\_performer\_phones = $data['em\_performer\_phones']; |
| [945](#L945) | } |
| [946](#L946) | if(isset($data['em\_performer\_emails']) && !empty($data['em\_performer\_emails'])){ |
| [947](#L947) | $performer\_data->em\_performer\_emails = $data['em\_performer\_emails']; |
| [948](#L948) | } |
| [949](#L949) | if(isset($data['em\_performer\_websites']) && !empty($data['em\_performer\_websites'])){ |
| [950](#L950) | $performer\_data->em\_performer\_websites = $data['em\_performer\_websites']; |
| [951](#L951) | } |
| [952](#L952) | $performer\_data->description = isset($data['qt\_new\_performer\_description']) ? $data['qt\_new\_performer\_description'] : ''; |
| [953](#L953) | $performer\_data->thumbnail = isset($data['performer\_attachment\_id']) ? $data['performer\_attachment\_id'] : ''; |
| [954](#L954) | $performer\_data->em\_social\_links = isset($data['em\_social\_links']) ? $data['em\_social\_links'] : ''; |
| [955](#L955) | $performers[] = $ep\_functions->insert\_performer\_post\_data((array)$performer\_data); |
| [956](#L956) | } |
| [957](#L957) | update\_post\_meta( $post\_id, 'em\_performer', $performers ); |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) |  |
| [961](#L961) | // save category |
| [962](#L962) | $dbhandler = new EP\_DBhandler; |
| [963](#L963) | $cat\_table\_name = 'TICKET\_CATEGORIES'; |
| [964](#L964) | $price\_options\_table = 'TICKET'; |
| [965](#L965) | if( isset( $data['em\_ticket\_category\_data'] ) && ! empty( $data['em\_ticket\_category\_data'] ) ) { |
| [966](#L966) | $em\_ticket\_category\_data = json\_decode( stripslashes( $data['em\_ticket\_category\_data'] ), true) ; |
| [967](#L967) | } |
| [968](#L968) | if( ! empty( $em\_ticket\_category\_data ) ) { |
| [969](#L969) | $cat\_priority = 1; |
| [970](#L970) | foreach( $em\_ticket\_category\_data as $cat ) { |
| [971](#L971) | $cat = $sanitizer->sanitize($cat); |
| [972](#L972) | $cat\_id = $cat['id']; |
| [973](#L973) | $get\_field\_data = ''; |
| [974](#L974) | if( !empty( $cat\_id ) ) { |
| [975](#L975) | $get\_field\_data = $dbhandler->get\_all\_result($cat\_table\_name,'\*',array('event\_id'=>$post\_id,'id'=>$cat\_id)); |
| [976](#L976) | } |
| [977](#L977) | if( empty( $get\_field\_data ) ) { |
| [978](#L978) | $save\_data                               = array(); |
| [979](#L979) | $save\_data['event\_id']   = $post\_id; |
| [980](#L980) | $save\_data['name']           = $cat['name']; |
| [981](#L981) | $save\_data['capacity']   = $cat['capacity']; |
| [982](#L982) | $save\_data['priority']   = 1; |
| [983](#L983) | $save\_data['status']     = 1; |
| [984](#L984) | $save\_data['created\_by'] = get\_current\_user\_id(); |
| [985](#L985) | $save\_data['created\_at'] = date\_i18n( "Y-m-d H:i:s", time() ); |
| [986](#L986) | $cat\_id = $dbhandler->insert\_row($cat\_table\_name, $save\_data); |
| [987](#L987) | } else{ |
| [988](#L988) | $update\_data =  array( |
| [989](#L989) | 'name'                    => $cat['name'], |
| [990](#L990) | 'capacity'                => $cat['capacity'], |
| [991](#L991) | 'priority'                => $cat\_priority, |
| [992](#L992) | 'last\_updated\_by' => get\_current\_user\_id(), |
| [993](#L993) | 'updated\_at'      => date\_i18n("Y-m-d H:i:s", time()) |
| [994](#L994) | ); |
| [995](#L995) | $dbhandler->update\_row($cat\_table\_name,'id', $cat\_id, $update\_data); |
| [996](#L996) |  |
| [997](#L997) | } |
| [998](#L998) | $cat\_priority++; |
| [999](#L999) | //save tickets |
| [1000](#L1000) | if( isset( $cat['tickets'] ) && ! empty( $cat['tickets'] ) ) { |
| [1001](#L1001) | $cat\_ticket\_priority = 1; |
| [1002](#L1002) | foreach( $cat['tickets'] as $ticket ) { |
| [1003](#L1003) | $ticket = $sanitizer->sanitize($ticket); |
| [1004](#L1004) | $ticket\_data = array(); |
| [1005](#L1005) | if( isset( $ticket['id'] ) && ! empty( $ticket['id'] && is\_int( $ticket['id'] ) ) ) { |
| [1006](#L1006) | $ticket\_id = $ticket['id']; |
| [1007](#L1007) | $get\_ticket\_data = $dbhandler->get\_all\_result($price\_options\_table,'\*',array('id'=>$ticket\_id)); |
| [1008](#L1008) | if( ! empty( $get\_ticket\_data ) ) { |
| [1009](#L1009) | $ticket\_data['name']                                   = addslashes( $ticket['name'] ); |
| [1010](#L1010) | $ticket\_data['description']                    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1011](#L1011) | $ticket\_data['price']                                  = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1012](#L1012) | $ticket\_data['capacity']                       = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1013](#L1013) | $ticket\_data['icon']                                   = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1014](#L1014) | $ticket\_data['priority']                       = $cat\_ticket\_priority; |
| [1015](#L1015) | $ticket\_data['updated\_at']                     = date\_i18n("Y-m-d H:i:s", time()); |
| [1016](#L1016) | $ticket\_data['additional\_fees']        = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1017](#L1017) | $ticket\_data['allow\_cancellation']     = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1018](#L1018) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1019](#L1019) | // date |
| [1020](#L1020) | $start\_date = []; |
| [1021](#L1021) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1022](#L1022) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1023](#L1023) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1024](#L1024) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1025](#L1025) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1026](#L1026) | } |
| [1027](#L1027) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1028](#L1028) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1029](#L1029) | } |
| [1030](#L1030) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1031](#L1031) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1032](#L1032) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1033](#L1033) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1034](#L1034) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1035](#L1035) | } |
| [1036](#L1036) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1037](#L1037) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1038](#L1038) | } |
| [1039](#L1039) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1040](#L1040) | } |
| [1041](#L1041) | } |
| [1042](#L1042) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1043](#L1043) | // end date |
| [1044](#L1044) | $end\_date = []; |
| [1045](#L1045) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1046](#L1046) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1047](#L1047) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1048](#L1048) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1049](#L1049) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1050](#L1050) | } |
| [1051](#L1051) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1052](#L1052) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1053](#L1053) | } |
| [1054](#L1054) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1055](#L1055) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1056](#L1056) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'relative\_date' ) { |
| [1057](#L1057) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1058](#L1058) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1059](#L1059) | } |
| [1060](#L1060) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1061](#L1061) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1062](#L1062) | } |
| [1063](#L1063) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1064](#L1064) | } |
| [1065](#L1065) | } |
| [1066](#L1066) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1067](#L1067) |  |
| [1068](#L1068) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1069](#L1069) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1070](#L1070) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1071](#L1071) | $dbhandler->update\_row($price\_options\_table,'id',$ticket\_id, $ticket\_data); |
| [1072](#L1072) |  |
| [1073](#L1073) | } else{ |
| [1074](#L1074) | $ticket\_data['category\_id']    = $cat\_id; |
| [1075](#L1075) | $ticket\_data['event\_id']       = $post\_id; |
| [1076](#L1076) | $ticket\_data['name']                   = addslashes( $ticket['name'] ); |
| [1077](#L1077) | $ticket\_data['description']    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1078](#L1078) | $ticket\_data['price']                  = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1079](#L1079) | $ticket\_data['special\_price']  = ''; |
| [1080](#L1080) | $ticket\_data['capacity']       = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1081](#L1081) | $ticket\_data['is\_default']     = 1; |
| [1082](#L1082) | $ticket\_data['is\_event\_price'] = 0; |
| [1083](#L1083) | $ticket\_data['icon']                   = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1084](#L1084) | $ticket\_data['priority']       = $cat\_ticket\_priority; |
| [1085](#L1085) | $ticket\_data['status']                 = 1; |
| [1086](#L1086) | $ticket\_data['created\_at']     = date\_i18n("Y-m-d H:i:s", time()); |
| [1087](#L1087) |  |
| [1088](#L1088) | // new |
| [1089](#L1089) | $ticket\_data['additional\_fees']    = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1090](#L1090) | $ticket\_data['allow\_cancellation'] = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1091](#L1091) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1092](#L1092) | // date |
| [1093](#L1093) | $start\_date = []; |
| [1094](#L1094) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1095](#L1095) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1096](#L1096) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1097](#L1097) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1098](#L1098) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1099](#L1099) | } |
| [1100](#L1100) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1101](#L1101) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1102](#L1102) | } |
| [1103](#L1103) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1104](#L1104) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1105](#L1105) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1106](#L1106) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1107](#L1107) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1108](#L1108) | } |
| [1109](#L1109) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1110](#L1110) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1111](#L1111) | } |
| [1112](#L1112) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1113](#L1113) | } |
| [1114](#L1114) | } |
| [1115](#L1115) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1116](#L1116) | // end date |
| [1117](#L1117) | $end\_date = []; |
| [1118](#L1118) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1119](#L1119) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1120](#L1120) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1121](#L1121) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1122](#L1122) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1123](#L1123) | } |
| [1124](#L1124) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1125](#L1125) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1126](#L1126) | } |
| [1127](#L1127) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1128](#L1128) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1129](#L1129) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_ends' ) { |
| [1130](#L1130) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1131](#L1131) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1132](#L1132) | } |
| [1133](#L1133) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1134](#L1134) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1135](#L1135) | } |
| [1136](#L1136) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1137](#L1137) | } |
| [1138](#L1138) | } |
| [1139](#L1139) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1140](#L1140) |  |
| [1141](#L1141) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1142](#L1142) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1143](#L1143) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1144](#L1144) | $result = $dbhandler->insert\_row($price\_options\_table, $ticket\_data); |
| [1145](#L1145) |  |
| [1146](#L1146) | } |
| [1147](#L1147) | } else{ |
| [1148](#L1148) | $ticket\_data['category\_id']    = $cat\_id; |
| [1149](#L1149) | $ticket\_data['event\_id']           = $post\_id; |
| [1150](#L1150) | $ticket\_data['name']               = addslashes( $ticket['name'] ); |
| [1151](#L1151) | $ticket\_data['description']    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1152](#L1152) | $ticket\_data['price']              = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1153](#L1153) | $ticket\_data['special\_price']  = ''; |
| [1154](#L1154) | $ticket\_data['capacity']           = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1155](#L1155) | $ticket\_data['is\_default']     = 1; |
| [1156](#L1156) | $ticket\_data['is\_event\_price'] = 0; |
| [1157](#L1157) | $ticket\_data['icon']               = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1158](#L1158) | $ticket\_data['priority']           = $cat\_ticket\_priority; |
| [1159](#L1159) | $ticket\_data['status']             = 1; |
| [1160](#L1160) | $ticket\_data['created\_at']         = date\_i18n("Y-m-d H:i:s", time()); |
| [1161](#L1161) |  |
| [1162](#L1162) | // new |
| [1163](#L1163) | $ticket\_data['additional\_fees']    = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1164](#L1164) | $ticket\_data['allow\_cancellation'] = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1165](#L1165) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1166](#L1166) | // date |
| [1167](#L1167) | $start\_date = []; |
| [1168](#L1168) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1169](#L1169) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1170](#L1170) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1171](#L1171) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1172](#L1172) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1173](#L1173) | } |
| [1174](#L1174) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1175](#L1175) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1176](#L1176) | } |
| [1177](#L1177) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1178](#L1178) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1179](#L1179) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1180](#L1180) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1181](#L1181) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1182](#L1182) | } |
| [1183](#L1183) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1184](#L1184) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1185](#L1185) | } |
| [1186](#L1186) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1187](#L1187) | } |
| [1188](#L1188) | } |
| [1189](#L1189) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1190](#L1190) | // end date |
| [1191](#L1191) | $end\_date = []; |
| [1192](#L1192) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1193](#L1193) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1194](#L1194) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1195](#L1195) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1196](#L1196) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1197](#L1197) | } |
| [1198](#L1198) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1199](#L1199) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1200](#L1200) | } |
| [1201](#L1201) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1202](#L1202) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1203](#L1203) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_ends' ) { |
| [1204](#L1204) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1205](#L1205) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1206](#L1206) | } |
| [1207](#L1207) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1208](#L1208) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1209](#L1209) | } |
| [1210](#L1210) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1211](#L1211) | } |
| [1212](#L1212) | } |
| [1213](#L1213) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1214](#L1214) |  |
| [1215](#L1215) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1216](#L1216) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1217](#L1217) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1218](#L1218) | $result = $dbhandler->insert\_row($price\_options\_table, $ticket\_data); |
| [1219](#L1219) |  |
| [1220](#L1220) | } |
| [1221](#L1221) | $cat\_ticket\_priority++; |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | update\_post\_meta( $post\_id, 'em\_enable\_booking', 'bookings\_on' ); |
| [1225](#L1225) | } |
| [1226](#L1226) | } |
| [1227](#L1227) | } |
| [1228](#L1228) |  |
| [1229](#L1229) | // delete category |
| [1230](#L1230) | if( isset( $data['em\_ticket\_category\_delete\_ids'] ) && !empty( $data['em\_ticket\_category\_delete\_ids'] ) ) { |
| [1231](#L1231) | $em\_ticket\_category\_delete\_ids = $data['em\_ticket\_category\_delete\_ids']; |
| [1232](#L1232) | $del\_ids = json\_decode( stripslashes( $em\_ticket\_category\_delete\_ids ) ); |
| [1233](#L1233) | if( is\_string( $em\_ticket\_category\_delete\_ids ) && is\_array( json\_decode( stripslashes( $em\_ticket\_category\_delete\_ids ) ) ) &&  json\_last\_error() == JSON\_ERROR\_NONE ) { |
| [1234](#L1234) | foreach( $del\_ids as $id ) { |
| [1235](#L1235) | $dbhandler->remove\_row($cat\_table\_name,'id', $id); |
| [1236](#L1236) | } |
| [1237](#L1237) | } |
| [1238](#L1238) | } |
| [1239](#L1239) |  |
| [1240](#L1240) | // save tickets |
| [1241](#L1241) | if( isset( $data['em\_ticket\_individual\_data'] ) && ! empty( $data['em\_ticket\_individual\_data'] ) ) { |
| [1242](#L1242) | $em\_ticket\_individual\_data = json\_decode( stripslashes( $data['em\_ticket\_individual\_data'] ), true) ; |
| [1243](#L1243) | if( isset( $em\_ticket\_individual\_data ) && ! empty( $em\_ticket\_individual\_data ) ) { |
| [1244](#L1244) | foreach( $em\_ticket\_individual\_data as $ticket ) { |
| [1245](#L1245) | $ticket = $sanitizer->sanitize($ticket); |
| [1246](#L1246) | if( isset( $ticket['id'] ) && ! empty( $ticket['id'] ) && is\_int( $ticket['id'] ) ) { |
| [1247](#L1247) | $ticket\_id = $ticket['id']; |
| [1248](#L1248) | $get\_ticket\_data = $dbhandler->get\_all\_result($price\_options\_table,'\*',array('id'=>$ticket\_id)); |
| [1249](#L1249) | if( ! empty( $get\_ticket\_data ) ) { |
| [1250](#L1250) | $ticket\_data                               = array(); |
| [1251](#L1251) | $ticket\_data['name']               = addslashes( $ticket['name'] ); |
| [1252](#L1252) | $ticket\_data['description']    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1253](#L1253) | $ticket\_data['price']              = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1254](#L1254) | $ticket\_data['capacity']           = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1255](#L1255) | $ticket\_data['icon']               = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1256](#L1256) | $ticket\_data['updated\_at']         = date\_i18n("Y-m-d H:i:s", time()); |
| [1257](#L1257) | $ticket\_data['additional\_fees']    = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1258](#L1258) | $ticket\_data['allow\_cancellation'] = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1259](#L1259) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1260](#L1260) | // date |
| [1261](#L1261) | $start\_date = []; |
| [1262](#L1262) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1263](#L1263) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1264](#L1264) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1265](#L1265) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1266](#L1266) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1267](#L1267) | } |
| [1268](#L1268) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1269](#L1269) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1270](#L1270) | } |
| [1271](#L1271) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1272](#L1272) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1273](#L1273) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1274](#L1274) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1275](#L1275) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1276](#L1276) | } |
| [1277](#L1277) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1278](#L1278) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1279](#L1279) | } |
| [1280](#L1280) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1281](#L1281) | } |
| [1282](#L1282) | } |
| [1283](#L1283) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1284](#L1284) | // end date |
| [1285](#L1285) | $end\_date = []; |
| [1286](#L1286) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1287](#L1287) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1288](#L1288) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1289](#L1289) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1290](#L1290) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1291](#L1291) | } |
| [1292](#L1292) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1293](#L1293) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1294](#L1294) | } |
| [1295](#L1295) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1296](#L1296) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1297](#L1297) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'relative\_date' ) { |
| [1298](#L1298) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1299](#L1299) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1300](#L1300) | } |
| [1301](#L1301) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1302](#L1302) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1303](#L1303) | } |
| [1304](#L1304) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1305](#L1305) | } |
| [1306](#L1306) | } |
| [1307](#L1307) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1308](#L1308) |  |
| [1309](#L1309) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1310](#L1310) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1311](#L1311) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1312](#L1312) | $dbhandler->update\_row($price\_options\_table,'id', $ticket\_id, $ticket\_data); |
| [1313](#L1313) |  |
| [1314](#L1314) | } else{ |
| [1315](#L1315) | $ticket\_data                               = array(); |
| [1316](#L1316) | $ticket\_data['category\_id']    = 0; |
| [1317](#L1317) | $ticket\_data['event\_id']           = $post\_id; |
| [1318](#L1318) | $ticket\_data['name']               = addslashes( $ticket['name'] ); |
| [1319](#L1319) | $ticket\_data['description']    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1320](#L1320) | $ticket\_data['price']              = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1321](#L1321) | $ticket\_data['special\_price']  = ''; |
| [1322](#L1322) | $ticket\_data['capacity']           = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1323](#L1323) | $ticket\_data['is\_default']     = 1; |
| [1324](#L1324) | $ticket\_data['is\_event\_price'] = 0; |
| [1325](#L1325) | $ticket\_data['icon']               = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1326](#L1326) | $ticket\_data['priority']           = 1; |
| [1327](#L1327) | $ticket\_data['status']             = 1; |
| [1328](#L1328) | $ticket\_data['created\_at']         = date\_i18n("Y-m-d H:i:s", time()); |
| [1329](#L1329) |  |
| [1330](#L1330) | // new |
| [1331](#L1331) | $ticket\_data['additional\_fees']    = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1332](#L1332) | $ticket\_data['allow\_cancellation'] = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1333](#L1333) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1334](#L1334) | // date |
| [1335](#L1335) | $start\_date = []; |
| [1336](#L1336) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1337](#L1337) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1338](#L1338) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1339](#L1339) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1340](#L1340) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1341](#L1341) | } |
| [1342](#L1342) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1343](#L1343) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1344](#L1344) | } |
| [1345](#L1345) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1346](#L1346) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1347](#L1347) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1348](#L1348) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1349](#L1349) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1350](#L1350) | } |
| [1351](#L1351) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1352](#L1352) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1353](#L1353) | } |
| [1354](#L1354) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1355](#L1355) | } |
| [1356](#L1356) | } |
| [1357](#L1357) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1358](#L1358) | // end date |
| [1359](#L1359) | $end\_date = []; |
| [1360](#L1360) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1361](#L1361) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1362](#L1362) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1363](#L1363) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1364](#L1364) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1365](#L1365) | } |
| [1366](#L1366) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1367](#L1367) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1368](#L1368) | } |
| [1369](#L1369) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1370](#L1370) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1371](#L1371) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'relative\_date' ) { |
| [1372](#L1372) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1373](#L1373) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1374](#L1374) | } |
| [1375](#L1375) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1376](#L1376) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1377](#L1377) | } |
| [1378](#L1378) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1379](#L1379) | } |
| [1380](#L1380) | } |
| [1381](#L1381) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1382](#L1382) |  |
| [1383](#L1383) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1384](#L1384) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1385](#L1385) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1386](#L1386) | $result = $dbhandler->insert\_row($price\_options\_table, $ticket\_data); |
| [1387](#L1387) |  |
| [1388](#L1388) | } |
| [1389](#L1389) | } else{ |
| [1390](#L1390) | $ticket\_data                                   = array(); |
| [1391](#L1391) | $ticket\_data['category\_id']    = 0; |
| [1392](#L1392) | $ticket\_data['event\_id']       = $post\_id; |
| [1393](#L1393) | $ticket\_data['name']                   = addslashes( $ticket['name'] ); |
| [1394](#L1394) | $ticket\_data['description']    = isset( $ticket['description'] ) ? addslashes( $ticket['description'] ) : ''; |
| [1395](#L1395) | $ticket\_data['price']                  = isset( $ticket['price'] ) ? $ticket['price'] : 0; |
| [1396](#L1396) | $ticket\_data['special\_price']  = ''; |
| [1397](#L1397) | $ticket\_data['capacity']       = isset( $ticket['capacity'] ) ? absint( $ticket['capacity'] ) : 0; |
| [1398](#L1398) | $ticket\_data['is\_default']     = 1; |
| [1399](#L1399) | $ticket\_data['is\_event\_price'] = 0; |
| [1400](#L1400) | $ticket\_data['icon']                   = isset( $ticket['icon'] ) ? absint( $ticket['icon'] ) : ''; |
| [1401](#L1401) | $ticket\_data['priority']       = 1; |
| [1402](#L1402) | $ticket\_data['status']                 = 1; |
| [1403](#L1403) | $ticket\_data['created\_at']     = date\_i18n("Y-m-d H:i:s", time()); |
| [1404](#L1404) |  |
| [1405](#L1405) | // new |
| [1406](#L1406) | $ticket\_data['additional\_fees']    = ( isset( $ticket['ep\_additional\_ticket\_fee\_data'] ) && !empty( $ticket['ep\_additional\_ticket\_fee\_data'] ) ) ? json\_encode( $ticket['ep\_additional\_ticket\_fee\_data'] ) : ''; |
| [1407](#L1407) | $ticket\_data['allow\_cancellation'] = isset( $ticket['allow\_cancellation'] ) ? absint( $ticket['allow\_cancellation'] ) : 0; |
| [1408](#L1408) | $ticket\_data['show\_remaining\_tickets'] = isset( $ticket['show\_remaining\_tickets'] ) ? absint( $ticket['show\_remaining\_tickets'] ) : 0; |
| [1409](#L1409) | // date |
| [1410](#L1410) | $start\_date = []; |
| [1411](#L1411) | if( isset( $ticket['em\_ticket\_start\_booking\_type'] ) && !empty( $ticket['em\_ticket\_start\_booking\_type'] ) ) { |
| [1412](#L1412) | $start\_date['booking\_type'] = $ticket['em\_ticket\_start\_booking\_type']; |
| [1413](#L1413) | if( $ticket['em\_ticket\_start\_booking\_type'] == 'custom\_date' ) { |
| [1414](#L1414) | if( isset( $ticket['em\_ticket\_start\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_date'] ) ) { |
| [1415](#L1415) | $start\_date['start\_date'] = $ticket['em\_ticket\_start\_booking\_date']; |
| [1416](#L1416) | } |
| [1417](#L1417) | if( isset( $ticket['em\_ticket\_start\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_time'] ) ) { |
| [1418](#L1418) | $start\_date['start\_time'] = $ticket['em\_ticket\_start\_booking\_time']; |
| [1419](#L1419) | } |
| [1420](#L1420) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'event\_date' ) { |
| [1421](#L1421) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1422](#L1422) | } elseif( $ticket['em\_ticket\_start\_booking\_type'] == 'relative\_date' ) { |
| [1423](#L1423) | if( isset( $ticket['em\_ticket\_start\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days'] ) ) { |
| [1424](#L1424) | $start\_date['days'] = $ticket['em\_ticket\_start\_booking\_days']; |
| [1425](#L1425) | } |
| [1426](#L1426) | if( isset( $ticket['em\_ticket\_start\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_start\_booking\_days\_option'] ) ) { |
| [1427](#L1427) | $start\_date['days\_option'] = $ticket['em\_ticket\_start\_booking\_days\_option']; |
| [1428](#L1428) | } |
| [1429](#L1429) | $start\_date['event\_option'] = $ticket['em\_ticket\_start\_booking\_event\_option']; |
| [1430](#L1430) | } |
| [1431](#L1431) | } |
| [1432](#L1432) | $ticket\_data['booking\_starts'] = json\_encode( $start\_date ); |
| [1433](#L1433) | // end date |
| [1434](#L1434) | $end\_date = []; |
| [1435](#L1435) | if( isset( $ticket['em\_ticket\_ends\_booking\_type'] ) && !empty( $ticket['em\_ticket\_ends\_booking\_type'] ) ) { |
| [1436](#L1436) | $end\_date['booking\_type'] = $ticket['em\_ticket\_ends\_booking\_type']; |
| [1437](#L1437) | if( $ticket['em\_ticket\_ends\_booking\_type'] == 'custom\_date' ) { |
| [1438](#L1438) | if( isset( $ticket['em\_ticket\_ends\_booking\_date'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_date'] ) ) { |
| [1439](#L1439) | $end\_date['end\_date'] = $ticket['em\_ticket\_ends\_booking\_date']; |
| [1440](#L1440) | } |
| [1441](#L1441) | if( isset( $ticket['em\_ticket\_ends\_booking\_time'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_time'] ) ) { |
| [1442](#L1442) | $end\_date['end\_time'] = $ticket['em\_ticket\_ends\_booking\_time']; |
| [1443](#L1443) | } |
| [1444](#L1444) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'event\_date' ) { |
| [1445](#L1445) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1446](#L1446) | } elseif( $ticket['em\_ticket\_ends\_booking\_type'] == 'relative\_date' ) { |
| [1447](#L1447) | if( isset( $ticket['em\_ticket\_ends\_booking\_days'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days'] ) ) { |
| [1448](#L1448) | $end\_date['days'] = $ticket['em\_ticket\_ends\_booking\_days']; |
| [1449](#L1449) | } |
| [1450](#L1450) | if( isset( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) && ! empty( $ticket['em\_ticket\_ends\_booking\_days\_option'] ) ) { |
| [1451](#L1451) | $end\_date['days\_option'] = $ticket['em\_ticket\_ends\_booking\_days\_option']; |
| [1452](#L1452) | } |
| [1453](#L1453) | $end\_date['event\_option'] = $ticket['em\_ticket\_ends\_booking\_event\_option']; |
| [1454](#L1454) | } |
| [1455](#L1455) | } |
| [1456](#L1456) | $ticket\_data['booking\_ends'] = json\_encode( $end\_date ); |
| [1457](#L1457) |  |
| [1458](#L1458) | $ticket\_data['show\_ticket\_booking\_dates'] = (isset( $ticket['show\_ticket\_booking\_dates'] ) ) ? 1 : 0; |
| [1459](#L1459) | $ticket\_data['min\_ticket\_no'] = isset( $ticket['min\_ticket\_no'] ) ? $ticket['min\_ticket\_no'] : 0; |
| [1460](#L1460) | $ticket\_data['max\_ticket\_no'] = isset( $ticket['max\_ticket\_no'] ) ? $ticket['max\_ticket\_no'] : 0; |
| [1461](#L1461) | $result = $dbhandler->insert\_row($price\_options\_table, $ticket\_data); |
| [1462](#L1462) |  |
| [1463](#L1463) | } |
| [1464](#L1464) | } |
| [1465](#L1465) |  |
| [1466](#L1466) | update\_post\_meta( $post\_id, 'em\_enable\_booking', 'bookings\_on' ); |
| [1467](#L1467) | } |
| [1468](#L1468) | } |
| [1469](#L1469) |  |
| [1470](#L1470) | // delete tickets |
| [1471](#L1471) | if( isset( $data['em\_ticket\_individual\_delete\_ids'] ) && !empty( $data['em\_ticket\_individual\_delete\_ids'] ) ) { |
| [1472](#L1472) | $em\_ticket\_individual\_delete\_ids = $data['em\_ticket\_individual\_delete\_ids']; |
| [1473](#L1473) | $del\_ids = json\_decode( stripslashes( $em\_ticket\_individual\_delete\_ids ) ); |
| [1474](#L1474) | if( is\_string( $em\_ticket\_individual\_delete\_ids ) && is\_array( json\_decode( stripslashes( $em\_ticket\_individual\_delete\_ids ) ) ) &&  json\_last\_error() == JSON\_ERROR\_NONE ) { |
| [1475](#L1475) | foreach( $del\_ids as $id ) { |
| [1476](#L1476) | $dbhandler->remove\_row($price\_options\_table,'id', $id); |
| [1477](#L1477) | } |
| [1478](#L1478) | } |
| [1479](#L1479) | } |
| [1480](#L1480) |  |
| [1481](#L1481) | /\* $frontend\_event\_controller = EventM\_Factory\_Service::ep\_get\_instance( 'EventM\_Event\_Controller\_Frontend\_Submission'); |
| [1482](#L1482) | $response = $frontend\_event\_controller->insert\_frontend\_event\_post\_data((array)$event\_data); \*/ |
| [1483](#L1483) | do\_action( 'ep\_after\_save\_front\_end\_event', $post\_id ); |
| [1484](#L1484) | $notifications->event\_submitted( $post\_id ); |
| [1485](#L1485) | $submit\_message = esc\_html\_\_( 'Thank you for submitting your event. We will review and publish it soon.', 'eventprime-event-calendar-management' ); |
| [1486](#L1486) | if( $post\_status == 'draft' ) { |
| [1487](#L1487) | $ues\_confirm\_message = $ep\_functions->ep\_get\_global\_settings( 'ues\_confirm\_message' ); |
| [1488](#L1488) | if( ! empty( $ues\_confirm\_message ) ) { |
| [1489](#L1489) | $submit\_message = $ues\_confirm\_message; |
| [1490](#L1490) | } |
| [1491](#L1491) | } else{ |
| [1492](#L1492) | if( ! empty( $data['event\_id'] ) ) { |
| [1493](#L1493) | $submit\_message = esc\_html\_\_( 'Event Updated Successfully.', 'eventprime-event-calendar-management' ); |
| [1494](#L1494) | } else{ |
| [1495](#L1495) | $submit\_message = esc\_html\_\_( 'Event Saved Successfully.', 'eventprime-event-calendar-management' ); |
| [1496](#L1496) | } |
| [1497](#L1497) | } |
| [1498](#L1498) |  |
| [1499](#L1499) | $data\_send = array( 'message' => $submit\_message, 'redirect' => null ); |
| [1500](#L1500) | $data\_send = apply\_filters( 'ep\_front\_end\_event\_send\_additional\_data', $data\_send ); |
| [1501](#L1501) | wp\_send\_json\_success( $data\_send ); |
| [1502](#L1502) |  |
| [1503](#L1503) | // wp\_send\_json\_success( array( 'message' => $submit\_message ) ); |
| [1504](#L1504) |  |
| [1505](#L1505) | } else{ |
| [1506](#L1506) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [1507](#L1507) | } |
| [1508](#L1508) | } |
| [1509](#L1509) |  |
| [1510](#L1510) |  |
| [1511](#L1511) | public function upload\_file\_media(){ |
| [1512](#L1512) | if(isset($\_FILES["file"]) && !empty($\_FILES["file"])){ |
| [1513](#L1513) | $extension = pathinfo( $\_FILES["file"]["name"], PATHINFO\_EXTENSION ); |
| [1514](#L1514) | if( $extension != 'jpg' && $extension != 'jpeg' && $extension != 'png' && $extension != 'gif' ) { |
| [1515](#L1515) | wp\_send\_json\_error( array( 'errors' => array( 'Only Image File Allowed.' ) ) ); |
| [1516](#L1516) | } |
| [1517](#L1517) | $file = $\_FILES['file']; |
| [1518](#L1518) | $filename = $file['name']; |
| [1519](#L1519) | $tmp\_name = $file['tmp\_name']; |
| [1520](#L1520) | $upload\_dir = wp\_upload\_dir(); |
| [1521](#L1521) | if (move\_uploaded\_file($file["tmp\_name"], $upload\_dir['path'] . "/" . $filename)) { |
| [1522](#L1522) | $uploaded\_file['file\_name'] = $filename; |
| [1523](#L1523) | $uploaded\_file['upload\_url'] = $upload\_dir['url'] . "/" . $filename; |
| [1524](#L1524) | $wp\_filetype = wp\_check\_filetype($filename, null ); |
| [1525](#L1525) | $attachment = array( |
| [1526](#L1526) | 'guid'           => $uploaded\_file['upload\_url'], |
| [1527](#L1527) | 'post\_mime\_type' => $wp\_filetype['type'], |
| [1528](#L1528) | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', $filename ), |
| [1529](#L1529) | 'post\_content'   => '', |
| [1530](#L1530) | 'post\_status'    => 'inherit' |
| [1531](#L1531) | ); |
| [1532](#L1532) | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_dir['path'] . "/" . $filename ); |
| [1533](#L1533) | if ( ! is\_wp\_error( $attachment\_id ) ) { |
| [1534](#L1534) | require\_once(ABSPATH . "wp-admin" . '/includes/file.php'); |
| [1535](#L1535) | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_dir['path'] . "/" . $filename ); |
| [1536](#L1536) | wp\_update\_attachment\_metadata( $attachment\_id,  $attachment\_data ); |
| [1537](#L1537) | $returnData['success'] = array( 'attachment\_id' => $attachment\_id ); |
| [1538](#L1538) | } |
| [1539](#L1539) | } |
| [1540](#L1540) | else{ |
| [1541](#L1541) | $returnData['errors'] = \_\_($upload\_file['error']); |
| [1542](#L1542) | } |
| [1543](#L1543) | } |
| [1544](#L1544) | if( isset( $returnData['success'] ) ) { |
| [1545](#L1545) | wp\_send\_json\_success( $returnData['success'] ); |
| [1546](#L1546) | }else{ |
| [1547](#L1547) | wp\_send\_json\_success( $returnData ); |
| [1548](#L1548) | } |
| [1549](#L1549) | } |
| [1550](#L1550) |  |
| [1551](#L1551) |  |
| [1552](#L1552) | public function booking\_update\_status(){ |
| [1553](#L1553) | // Check if nonce is valid |
| [1554](#L1554) |  |
| [1555](#L1555) | if (!isset($\_POST['security']) || !wp\_verify\_nonce($\_POST['security'], 'ep\_booking\_nonce')) { |
| [1556](#L1556) | wp\_die('Security check failed'); |
| [1557](#L1557) | } |
| [1558](#L1558) |  |
| [1559](#L1559) | if( isset( $\_POST['booking\_id'] ) && isset($\_POST['status']) && !empty(trim($\_POST['status'])) && current\_user\_can('manage\_options')) { |
| [1560](#L1560) | $booking\_id = absint( $\_POST['booking\_id'] ); |
| [1561](#L1561) | $status = sanitize\_text\_field($\_POST['status']); |
| [1562](#L1562) | $booking\_controller = new EventPrime\_Bookings; |
| [1563](#L1563) | $response = $booking\_controller->update\_status( $booking\_id, $status); |
| [1564](#L1564) | wp\_send\_json\_success( $response ); |
| [1565](#L1565) | }else{ |
| [1566](#L1566) | wp\_send\_json\_error(); |
| [1567](#L1567) | } |
| [1568](#L1568) | } |
| [1569](#L1569) |  |
| [1570](#L1570) | public function load\_event\_dates() { |
| [1571](#L1571) | // Get all the events dates |
| [1572](#L1572) | $data = new stdClass(); |
| [1573](#L1573) | $data->start\_dates = array(); |
| [1574](#L1574) | $data->event\_ids = array(); |
| [1575](#L1575) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1576](#L1576) | $query = array('meta\_query'  => array( 'relation' => 'AND', |
| [1577](#L1577) | array( |
| [1578](#L1578) | array( |
| [1579](#L1579) | 'key'     => 'em\_start\_date', |
| [1580](#L1580) | 'value'   =>  current\_time( 'timestamp' ), |
| [1581](#L1581) | 'compare' => '>', |
| [1582](#L1582) | 'type'=>'NUMERIC' |
| [1583](#L1583) | ) |
| [1584](#L1584) | ) |
| [1585](#L1585) | ) |
| [1586](#L1586) | ); |
| [1587](#L1587) | $events = $ep\_functions->get\_events\_post\_data($query); |
| [1588](#L1588) | if($events->posts){ |
| [1589](#L1589) | foreach ($events->posts as $event){ |
| [1590](#L1590) | $start\_date = date('Y-m-d', get\_post\_meta($event->id, 'em\_start\_date', true)); |
| [1591](#L1591) | $end\_date = date('Y-m-d', get\_post\_meta($event->id, 'em\_end\_date', true)); |
| [1592](#L1592) |  |
| [1593](#L1593) | if (!empty($start\_date)){ |
| [1594](#L1594) | preg\_match('/[0-9]{4}\-[0-9]{1,2}-[0-9]{1,2}/', $start\_date, $matches); |
| [1595](#L1595) | if (count($matches) > 0 && !empty($matches[0])) { |
| [1596](#L1596) | //epd($matches); |
| [1597](#L1597) | if ( strtotime($matches[0]) <= strtotime(date('Y-m-d') ) && strtotime( $end\_date ) >= strtotime( date('Y-m-d') ) ) { |
| [1598](#L1598) | $data->start\_dates[] = date($ep\_functions->ep\_get\_datepicker\_format()); |
| [1599](#L1599) | } else{ |
| [1600](#L1600) | $data->start\_dates[] = date($ep\_functions->ep\_get\_datepicker\_format(), strtotime($matches[0]) ); |
| [1601](#L1601) | } |
| [1602](#L1602) | $data->event\_ids[] = $event->id; |
| [1603](#L1603) | } |
| [1604](#L1604) | } |
| [1605](#L1605) | } |
| [1606](#L1606) | } |
| [1607](#L1607) |  |
| [1608](#L1608) | echo json\_encode($data); |
| [1609](#L1609) | die; |
| [1610](#L1610) | } |
| [1611](#L1611) |  |
| [1612](#L1612) | /\* |
| [1613](#L1613) | \* Load more upcoming events |
| [1614](#L1614) | \*/ |
| [1615](#L1615) | public function load\_more\_upcomingevent\_performer(){ |
| [1616](#L1616) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1617](#L1617) | $response = $ep\_functions->get\_eventupcoming\_performer\_loadmore(); |
| [1618](#L1618) | wp\_send\_json\_success($response); |
| [1619](#L1619) | die(); |
| [1620](#L1620) | } |
| [1621](#L1621) | public function load\_more\_upcomingevent\_venue(){ |
| [1622](#L1622) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1623](#L1623) | $response = $ep\_functions->get\_eventupcoming\_venue\_loadmore(); |
| [1624](#L1624) | wp\_send\_json\_success($response); |
| [1625](#L1625) | die(); |
| [1626](#L1626) | } |
| [1627](#L1627) | public function load\_more\_upcomingevent\_organizer(){ |
| [1628](#L1628) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1629](#L1629) | $response = $ep\_functions->get\_eventupcoming\_organizer\_loadmore(); |
| [1630](#L1630) | wp\_send\_json\_success($response); |
| [1631](#L1631) | die(); |
| [1632](#L1632) | } |
| [1633](#L1633) | public function load\_more\_upcomingevent\_eventtype(){ |
| [1634](#L1634) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1635](#L1635) | $response = $ep\_functions->get\_eventupcoming\_eventtype\_loadmore(); |
| [1636](#L1636) | wp\_send\_json\_success($response); |
| [1637](#L1637) | die(); |
| [1638](#L1638) | } |
| [1639](#L1639) |  |
| [1640](#L1640) | /\*\* |
| [1641](#L1641) | \* Filter event data |
| [1642](#L1642) | \* |
| [1643](#L1643) | \* @return Event Html. |
| [1644](#L1644) | \*/ |
| [1645](#L1645) | public function filter\_event\_data() { |
| [1646](#L1646) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1647](#L1647) | $response = $ep\_functions->get\_filtered\_event\_content(); |
| [1648](#L1648) | wp\_send\_json\_success( $response ); |
| [1649](#L1649) | die(); |
| [1650](#L1650) | } |
| [1651](#L1651) |  |
| [1652](#L1652) | /\*\* |
| [1653](#L1653) | \* Get all offers date of an event |
| [1654](#L1654) | \*/ |
| [1655](#L1655) | public function load\_event\_offers\_date() { |
| [1656](#L1656) |  |
| [1657](#L1657) | check\_ajax\_referer( 'single-event-data-nonce', 'security' ); |
| [1658](#L1658) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1659](#L1659) | $offer\_data = $event\_data = $offer\_dates = array(); |
| [1660](#L1660) | if( isset( $\_POST['offer\_data'] ) && ! empty( $\_POST['offer\_data'] ) ) { |
| [1661](#L1661) | $offer\_data = json\_decode( stripslashes( $\_POST['offer\_data'] ) ); |
| [1662](#L1662) |  |
| [1663](#L1663) | /\* $event\_controller = EventM\_Factory\_Service::ep\_get\_instance( 'EventM\_Event\_Controller\_List' ); |
| [1664](#L1664) | $single\_event = $event\_controller->get\_single\_event( $event\_id ); |
| [1665](#L1665) | $single\_event->venue\_other\_events = EventM\_Factory\_Service::get\_upcoming\_event\_by\_venue\_id( $single\_event->em\_venue, array( $single\_event->id ) ); |
| [1666](#L1666) | wp\_send\_json\_success( $single\_event ); \*/ |
| [1667](#L1667) | } |
| [1668](#L1668) | if( isset( $\_POST['event\_data'] ) && ! empty( $\_POST['event\_data'] ) ) { |
| [1669](#L1669) | $event\_data = $\_POST['event\_data']; |
| [1670](#L1670) | } |
| [1671](#L1671) | if( ! empty( $offer\_data ) && ! empty( $event\_data ) ) { |
| [1672](#L1672) | foreach( $offer\_data as $offer ) { |
| [1673](#L1673) | $offer\_date = $ep\_functions->get\_offer\_date( $offer, $event\_data ); |
| [1674](#L1674) | if( ! empty( $offer\_date ) ) { |
| [1675](#L1675) | $offer\_dates[ $offer->uid ] = $offer\_date; |
| [1676](#L1676) | } |
| [1677](#L1677) | } |
| [1678](#L1678) | wp\_send\_json\_success( $offer\_dates ); |
| [1679](#L1679) | } else{ |
| [1680](#L1680) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Data Not Found', 'eventprime-event-calendar-management' ) ) ); |
| [1681](#L1681) | } |
| [1682](#L1682) | } |
| [1683](#L1683) |  |
| [1684](#L1684) | /\*\* |
| [1685](#L1685) | \* Update user's timezone |
| [1686](#L1686) | \*/ |
| [1687](#L1687) | public function update\_user\_timezone() { |
| [1688](#L1688) | check\_ajax\_referer( 'ep-frontend-nonce', 'security' ); |
| [1689](#L1689) | if( isset( $\_POST['time\_zone'] ) && ! empty( $\_POST['time\_zone'] ) ) { |
| [1690](#L1690) | $time\_zone = $\_POST['time\_zone']; |
| [1691](#L1691) | $user\_id = get\_current\_user\_id(); |
| [1692](#L1692) | if( ! empty( $user\_id ) ) { |
| [1693](#L1693) | // get tizone string from offset |
| [1694](#L1694) | /\* if( strpos( $time\_zone, 'UTC-' ) !== false ) { |
| [1695](#L1695) | $offset = explode( 'UTC-', $time\_zone )[1]; |
| [1696](#L1696) | if( ! empty( $offset ) ) { |
| [1697](#L1697) | $time\_zone = get\_site\_timezone\_from\_offset( $offset ); |
| [1698](#L1698) | } |
| [1699](#L1699) | } elseif( strpos( $time\_zone, 'UTC+' ) !== false ) { |
| [1700](#L1700) | $offset = explode( 'UTC+', $time\_zone )[1]; |
| [1701](#L1701) | if( ! empty( $offset ) ) { |
| [1702](#L1702) | $time\_zone = get\_site\_timezone\_from\_offset( $offset ); |
| [1703](#L1703) | } |
| [1704](#L1704) | } \*/ |
| [1705](#L1705) |  |
| [1706](#L1706) | update\_user\_meta( $user\_id, 'ep\_user\_timezone\_meta', $time\_zone ); |
| [1707](#L1707) |  |
| [1708](#L1708) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Timezone updated successfully', 'eventprime-event-calendar-management' ) ) ); |
| [1709](#L1709) | } else{ |
| [1710](#L1710) | //wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Unauthorized access. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [1711](#L1711) | setcookie( 'ep\_user\_timezone\_meta', $time\_zone, time() + (86400 \* 30), "/"); |
| [1712](#L1712) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Timezone updated successfully', 'eventprime-event-calendar-management' ) ) ); |
| [1713](#L1713) | } |
| [1714](#L1714) | } else{ |
| [1715](#L1715) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Please select timezone and save.', 'eventprime-event-calendar-management' ) ) ); |
| [1716](#L1716) | } |
| [1717](#L1717) | } |
| [1718](#L1718) |  |
| [1719](#L1719) | /\* |
| [1720](#L1720) | \* Validate Create account details on checkout page |
| [1721](#L1721) | \*/ |
| [1722](#L1722) | public function validate\_user\_details\_booking(){ |
| [1723](#L1723) | $response\_code = 1; |
| [1724](#L1724) | $response = ''; |
| [1725](#L1725) | $rule = sanitize\_text\_field($\_POST['rules']); |
| [1726](#L1726) | //Validate Username |
| [1727](#L1727) | if($rule == 'username'){ |
| [1728](#L1728) | $username = sanitize\_text\_field($\_POST['username']); |
| [1729](#L1729) | if(!empty($username)){ |
| [1730](#L1730) | if(validate\_username($username)){ |
| [1731](#L1731) | if(username\_exists($username)){ |
| [1732](#L1732) | $response\_code = 0; |
| [1733](#L1733) | $response = esc\_html\_\_('Username already exists.','eventprime-event-calendar-management'); |
| [1734](#L1734) | }else{ |
| [1735](#L1735) | $response\_code = 1; |
| [1736](#L1736) | $response = esc\_html\_\_('Valid Username.','eventprime-event-calendar-management'); |
| [1737](#L1737) | } |
| [1738](#L1738) | }else{ |
| [1739](#L1739) | $response\_code = 0; |
| [1740](#L1740) | $response = esc\_html\_\_('Invalid Username.','eventprime-event-calendar-management'); |
| [1741](#L1741) | } |
| [1742](#L1742) | }else{ |
| [1743](#L1743) | $response\_code = 0; |
| [1744](#L1744) | $response = esc\_html\_\_('Username is required.','eventprime-event-calendar-management'); |
| [1745](#L1745) | } |
| [1746](#L1746) | }elseif($rule =='email'){ |
| [1747](#L1747) | $email = sanitize\_text\_field($\_POST['email']); |
| [1748](#L1748) | if(!empty($email)){ |
| [1749](#L1749) | if(email\_exists($email)){ |
| [1750](#L1750) | $response\_code = 0; |
| [1751](#L1751) | $response = esc\_html\_\_('Email already exists.','eventprime-event-calendar-management'); |
| [1752](#L1752) | }else{ |
| [1753](#L1753) | $response\_code = 1; |
| [1754](#L1754) | $response = esc\_html\_\_('Valid Email.','eventprime-event-calendar-management'); |
| [1755](#L1755) | } |
| [1756](#L1756) |  |
| [1757](#L1757) | }else{ |
| [1758](#L1758) | $response\_code = 0; |
| [1759](#L1759) | $response = esc\_html\_\_('Email is required.','eventprime-event-calendar-management'); |
| [1760](#L1760) | } |
| [1761](#L1761) | } |
| [1762](#L1762) | wp\_send\_json\_success(array('status'=>$response\_code,'message'=>$response)); |
| [1763](#L1763) | wp\_die(); |
| [1764](#L1764) | } |
| [1765](#L1765) |  |
| [1766](#L1766) | public function get\_attendees\_email\_by\_event\_id(){ |
| [1767](#L1767) | if(!isset($\_POST['\_wpnonce']) || !wp\_verify\_nonce( $\_POST['\_wpnonce'], 'ep\_email\_attendies' )){ |
| [1768](#L1768) | wp\_send\_json\_error( array( 'success'=> false, 'errors' => esc\_html\_\_( 'Security check failed.', 'eventprime-event-calendar-management' ) ) ); |
| [1769](#L1769) | } |
| [1770](#L1770) | if(empty(get\_current\_user\_id()) || !current\_user\_can( 'manage\_options' ) || !current\_user\_can( 'edit\_posts' )){ |
| [1771](#L1771) | wp\_send\_json\_error( array( 'success'=> false, 'errors' => esc\_html\_\_( 'You do not have permission.', 'eventprime-event-calendar-management' ) ) ); |
| [1772](#L1772) | } |
| [1773](#L1773) | $data = $\_POST; |
| [1774](#L1774) | $emails = array(); |
| [1775](#L1775) | $event\_id = absint($data['ep\_event\_id']); |
| [1776](#L1776) | if(!empty($event\_id)){ |
| [1777](#L1777) | $booking\_controller = new EventPrime\_Bookings; |
| [1778](#L1778) | $bookings = $booking\_controller->get\_event\_bookings\_by\_event\_id( $event\_id ); |
| [1779](#L1779) | if(!empty($bookings)){ |
| [1780](#L1780) | foreach($bookings as $booking){ |
| [1781](#L1781) | $user\_id = isset($booking->em\_user) ? (int) $booking->em\_user : 0; |
| [1782](#L1782) | if($user\_id){ |
| [1783](#L1783) | $user = get\_userdata($user\_id); |
| [1784](#L1784) | $emails[] = $user->user\_email; |
| [1785](#L1785) | }else{ |
| [1786](#L1786) | $order\_info = $booking->em\_order\_info; |
| [1787](#L1787) | if( ! empty( $order\_info ) && ! empty( $order\_info['user\_email'] ) ) { |
| [1788](#L1788) | $emails[] = esc\_html( $order\_info['user\_email'] ); |
| [1789](#L1789) | } |
| [1790](#L1790) | } |
| [1791](#L1791) | } |
| [1792](#L1792) | } |
| [1793](#L1793) | } |
| [1794](#L1794) | if( !empty( $emails ) && count( $emails ) > 0 ) { |
| [1795](#L1795) | $emails = array\_unique( $emails ); |
| [1796](#L1796) | wp\_send\_json\_success( array('status'=> true, 'emails'=> implode(',',$emails) )); |
| [1797](#L1797) | } |
| [1798](#L1798) | else{ |
| [1799](#L1799) | wp\_send\_json\_error( array( 'status'=> false, 'errors' => esc\_html\_\_( 'No Attendee Found', 'eventprime-event-calendar-management' ) ) ); |
| [1800](#L1800) | } |
| [1801](#L1801) |  |
| [1802](#L1802) | } |
| [1803](#L1803) |  |
| [1804](#L1804) | public function send\_attendees\_email(){ |
| [1805](#L1805) | if(!isset($\_POST['\_wpnonce']) || !wp\_verify\_nonce( $\_POST['\_wpnonce'], 'ep\_email\_attendies' )){ |
| [1806](#L1806) | wp\_send\_json\_error( array( 'success'=> false, 'message' => esc\_html\_\_( 'Security check failed.', 'eventprime-event-calendar-management' ) ) ); |
| [1807](#L1807) | } |
| [1808](#L1808) | if(empty(get\_current\_user\_id()) || !current\_user\_can( 'manage\_options' ) || !current\_user\_can( 'edit\_posts' )){ |
| [1809](#L1809) | wp\_send\_json\_error( array( 'success'=> false, 'message' => esc\_html\_\_( 'You do not have permission.', 'eventprime-event-calendar-management' ) ) ); |
| [1810](#L1810) | } |
| [1811](#L1811) | $data = $\_POST; |
| [1812](#L1812) | $email\_address = isset($data['email\_address']) && !empty($data['email\_address']) ? explode(',', $data['email\_address']) : array(); |
| [1813](#L1813) | $email\_subject = isset($data['email\_subject']) && !empty($data['email\_subject']) ? sanitize\_text\_field($data['email\_subject']) : get\_bloginfo(); |
| [1814](#L1814) | $content = isset($data['content\_html']) ? $data['content\_html'] : ''; |
| [1815](#L1815) | $cc\_email\_address = isset($data['cc\_email\_address']) && !empty($data['cc\_email\_address']) ? explode(',', $data['cc\_email\_address']) : array(); |
| [1816](#L1816) |  |
| [1817](#L1817) | $headers = array( 'Content-Type: text/html; charset=UTF-8' ); |
| [1818](#L1818) | if( ! empty( $cc\_email\_address ) ) { |
| [1819](#L1819) | foreach($cc\_email\_address as $cc){ |
| [1820](#L1820) | if ( filter\_var( $cc, FILTER\_VALIDATE\_EMAIL ) ) { |
| [1821](#L1821) | array\_push( $headers , "cc: $cc" ); |
| [1822](#L1822) | } |
| [1823](#L1823) | } |
| [1824](#L1824) | } |
| [1825](#L1825) | $sent = 0; |
| [1826](#L1826) | if( count( $email\_address ) > 0 ) { |
| [1827](#L1827) | foreach( $email\_address as $email ) { |
| [1828](#L1828) | $email\_sent = wp\_mail( $email, $email\_subject, $content, $headers ); |
| [1829](#L1829) | if(empty($sent)){ |
| [1830](#L1830) | $sent =  $email\_sent; |
| [1831](#L1831) | } |
| [1832](#L1832) | } |
| [1833](#L1833) | } |
| [1834](#L1834) | if(!empty($sent)){ |
| [1835](#L1835) | wp\_send\_json\_success( array( 'success' => true, "message" => esc\_html\_\_( 'Email send successfully', 'eventprime-event-calendar-management' ) ) ); |
| [1836](#L1836) | }else{ |
| [1837](#L1837) | wp\_send\_json\_error( array( 'success'=> false, 'message' => esc\_html\_\_( 'Email not send', 'eventprime-event-calendar-management' ) ) ); |
| [1838](#L1838) | } |
| [1839](#L1839) | } |
| [1840](#L1840) |  |
| [1841](#L1841) | /\*\* |
| [1842](#L1842) | \* Check if user name already exist |
| [1843](#L1843) | \*/ |
| [1844](#L1844) | public function rg\_check\_user\_name() { |
| [1845](#L1845) | if( wp\_verify\_nonce( $\_POST['security'], 'event-registration-form-nonce' ) ) { |
| [1846](#L1846) | if( ! empty( $\_POST['user\_name'] ) ) { |
| [1847](#L1847) | $user\_name = sanitize\_text\_field( $\_POST['user\_name'] ); |
| [1848](#L1848) | if ( username\_exists( $user\_name ) ) { |
| [1849](#L1849) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'User name already exist.', 'eventprime-event-calendar-management' ) ) ); |
| [1850](#L1850) | } else{ |
| [1851](#L1851) | wp\_send\_json\_success(); |
| [1852](#L1852) | } |
| [1853](#L1853) | } else{ |
| [1854](#L1854) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'User name is required.', 'eventprime-event-calendar-management' ) ) ); |
| [1855](#L1855) | } |
| [1856](#L1856) | } else{ |
| [1857](#L1857) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [1858](#L1858) | } |
| [1859](#L1859) | } |
| [1860](#L1860) |  |
| [1861](#L1861) | /\*\* |
| [1862](#L1862) | \* Check if email already exist |
| [1863](#L1863) | \*/ |
| [1864](#L1864) | public function rg\_check\_email() { |
| [1865](#L1865) | if( wp\_verify\_nonce( $\_POST['security'], 'event-registration-form-nonce' ) ) { |
| [1866](#L1866) | if( ! empty( $\_POST['email'] ) ) { |
| [1867](#L1867) | $email = sanitize\_text\_field( $\_POST['email'] ); |
| [1868](#L1868) | if ( email\_exists( $email ) ) { |
| [1869](#L1869) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Email already exist.', 'eventprime-event-calendar-management' ) ) ); |
| [1870](#L1870) | } else{ |
| [1871](#L1871) | wp\_send\_json\_success(); |
| [1872](#L1872) | } |
| [1873](#L1873) | } else{ |
| [1874](#L1874) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Email is required.', 'eventprime-event-calendar-management' ) ) ); |
| [1875](#L1875) | } |
| [1876](#L1876) | } else{ |
| [1877](#L1877) | wp\_send\_json\_error( array( 'error' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [1878](#L1878) | } |
| [1879](#L1879) | } |
| [1880](#L1880) |  |
| [1881](#L1881) | /\*\* |
| [1882](#L1882) | \* Download attendees |
| [1883](#L1883) | \*/ |
| [1884](#L1884) | public function export\_submittion\_attendees(){ |
| [1885](#L1885) | check\_ajax\_referer( 'ep-frontend-nonce', 'security' ); |
| [1886](#L1886) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [1887](#L1887) | if( isset( $\_POST['event\_id'] ) && ! empty( $\_POST['event\_id'] ) ) { |
| [1888](#L1888) | $event\_id = $\_POST['event\_id']; |
| [1889](#L1889) | $bookings = array(); |
| [1890](#L1890) | $data = new stdClass(); |
| [1891](#L1891) | $booking\_args = array( |
| [1892](#L1892) | 'numberposts' => -1, |
| [1893](#L1893) | 'post\_status' => 'completed', |
| [1894](#L1894) | 'post\_type'   => 'em\_booking', |
| [1895](#L1895) | 'meta\_key'    => 'em\_event', |
| [1896](#L1896) | 'meta\_value'  => $event\_id |
| [1897](#L1897) | ); |
| [1898](#L1898) | $booking\_posts = get\_posts( $booking\_args ); |
| [1899](#L1899) | $booking\_controller = new EventPrime\_Bookings; |
| [1900](#L1900) | foreach ( $booking\_posts as $post ) { |
| [1901](#L1901) | array\_push( $bookings, $booking\_controller->load\_booking\_detail( $post->ID ) ); |
| [1902](#L1902) | } |
| [1903](#L1903) | //epd($bookings); |
| [1904](#L1904) | $csv = new stdClass(); |
| [1905](#L1905) | foreach ( $bookings as $booking ) { |
| [1906](#L1906) | $user = get\_user\_by( 'id', $booking->em\_user ); |
| [1907](#L1907) | $csv = new stdClass(); |
| [1908](#L1908) | $csv->ID = $booking->em\_id; |
| [1909](#L1909) | $csv->user\_display\_name = $user->display\_name; |
| [1910](#L1910) | $csv->user\_email = $user->user\_email; |
| [1911](#L1911) | $other\_order\_info = $booking->em\_order\_info; |
| [1912](#L1912) | $ticket\_sub\_total = 0; |
| [1913](#L1913) | $ticket\_qty = 0; |
| [1914](#L1914) | foreach( $other\_order\_info['tickets'] as $ticket ){ |
| [1915](#L1915) | $ticket\_sub\_total = $ticket\_sub\_total + $ticket->subtotal; |
| [1916](#L1916) | $ticket\_qty = $ticket\_qty + $ticket->qty; |
| [1917](#L1917) | } |
| [1918](#L1918) | $csv->price =  $ticket\_sub\_total + $other\_order\_info['event\_fixed\_price']; |
| [1919](#L1919) | $csv->no\_tickets =  $ticket\_qty; |
| [1920](#L1920) | $csv->amount\_total =  $other\_order\_info['booking\_total']; |
| [1921](#L1921) | $event = $ep\_functions->get\_single\_event( $booking->em\_event ); |
| [1922](#L1922) | if( ! empty( $event->id ) ){ |
| [1923](#L1923) | $csv->event\_name = $event->name; |
| [1924](#L1924) | } |
| [1925](#L1925) | else{ |
| [1926](#L1926) | $csv->event\_name = \_\_( 'Event deleted', 'eventprime-event-calendar-management' ); |
| [1927](#L1927) | } |
| [1928](#L1928) | $csv->event\_type\_name = ''; |
| [1929](#L1929) | if( ! empty( $event->em\_event\_type ) ){ |
| [1930](#L1930) | $event\_type = $ep\_functions->get\_single\_event\_type( $event->em\_event\_type ); |
| [1931](#L1931) | if( ! empty( $event\_type ) ){ |
| [1932](#L1932) | $csv->event\_type\_name = $event\_type->name; |
| [1933](#L1933) | } |
| [1934](#L1934) | } |
| [1935](#L1935) | $csv->venue = ''; |
| [1936](#L1936) | $csv->seating\_type = ''; |
| [1937](#L1937) | if( ! empty( $event->em\_venue ) ){ |
| [1938](#L1938) | $event\_venue = $ep\_functions->get\_single\_venue( $event->em\_venue ); |
| [1939](#L1939) | if( ! empty( $event\_venue ) ){ |
| [1940](#L1940) | $csv->venue = $event\_venue->name; |
| [1941](#L1941) | $csv->seating\_type = $event\_venue->em\_type; |
| [1942](#L1942) | } |
| [1943](#L1943) | } |
| [1944](#L1944) | $i = 1; |
| [1945](#L1945) | $attendee\_name\_data = ''; |
| [1946](#L1946) | foreach( $booking->em\_attendee\_names as $ticket\_id => $attendee\_data ) { |
| [1947](#L1947) | $booking\_attendees\_field\_labels = $ep\_functions->ep\_get\_booking\_attendee\_field\_labels( $attendee\_data[1] ); |
| [1948](#L1948) | foreach( $attendee\_data as $booking\_attendees ) { |
| [1949](#L1949) | $attendee\_name\_data .= esc\_html\_\_( 'Attendees '.$i.' ', 'eventprime-event-calendar-management' ); |
| [1950](#L1950) | $booking\_attendees\_val = array\_values( $booking\_attendees ); |
| [1951](#L1951) | foreach( $booking\_attendees\_field\_labels as $labels ){ |
| [1952](#L1952) | $formated\_val = str\_replace( ' ', '\_', strtolower( $labels ) ); |
| [1953](#L1953) | $at\_val = '---'; |
| [1954](#L1954) | foreach( $booking\_attendees\_val as $baval ) { |
| [1955](#L1955) | if( isset( $baval[$formated\_val] ) && ! empty( $baval[$formated\_val] ) ) { |
| [1956](#L1956) | $at\_val = $baval[$formated\_val]; |
| [1957](#L1957) | break; |
| [1958](#L1958) | } |
| [1959](#L1959) | } |
| [1960](#L1960) | $attendee\_name\_data .= esc\_html\_\_( $labels, 'eventprime-event-calendar-management' ) .' : '. $at\_val.', '; |
| [1961](#L1961) | } |
| [1962](#L1962) |  |
| [1963](#L1963) | $i++; |
| [1964](#L1964) | } |
| [1965](#L1965) | } |
| [1966](#L1966) | $csv->attendee\_name = $attendee\_name\_data; |
| [1967](#L1967) | $csv->seat\_sequences = ''; |
| [1968](#L1968) | // if( isset( $other\_order\_info['seat\_sequences'] ) && ! empty( $other\_order\_info['seat\_sequences'] ) ){ |
| [1969](#L1969) | //     $csv->seat\_sequences = implode( ',', $other\_order\_info['seat\_sequences'] ); |
| [1970](#L1970) | // } |
| [1971](#L1971) | $csv->status= $booking->em\_status; |
| [1972](#L1972) | $data->posts[] = $csv; |
| [1973](#L1973) | } |
| [1974](#L1974) |  |
| [1975](#L1975) | header('Content-Type: text/csv'); |
| [1976](#L1976) | header('Content-Disposition: attachment;filename="attendees.csv"'); |
| [1977](#L1977) | header('Cache-Control: max-age=0'); |
| [1978](#L1978) | $csv\_name = 'em\_Attendees' . time() . mt\_rand(10, 1000000); |
| [1979](#L1979) | $csv\_path = get\_temp\_dir() . $csv\_name . '.csv'; |
| [1980](#L1980) | $csv = fopen('php://output', "w"); |
| [1981](#L1981) | if ( ! $csv ) { |
| [1982](#L1982) | return false; |
| [1983](#L1983) | } |
| [1984](#L1984) | //Add UTF-8 header for proper encoding of the file |
| [1985](#L1985) | fputs($csv, chr(0xEF) . chr(0xBB) . chr(0xBF)); |
| [1986](#L1986) | $csv\_fields = array(); |
| [1987](#L1987) | $csv\_fields[] = \_\_('Booking ID', 'eventprime-event-calendar-management'); |
| [1988](#L1988) | $csv\_fields[] = \_\_('User Name', 'eventprime-event-calendar-management'); |
| [1989](#L1989) | $csv\_fields[] = \_\_('Email', 'eventprime-event-calendar-management'); |
| [1990](#L1990) | $csv\_fields[] = \_\_('Price', 'eventprime-event-calendar-management'); |
| [1991](#L1991) | $csv\_fields[] = \_\_('Ticket Count', 'eventprime-event-calendar-management'); |
| [1992](#L1992) | $csv\_fields[] = \_\_('Total Amount', 'eventprime-event-calendar-management'); |
| [1993](#L1993) | $csv\_fields[] = \_\_('Event Name', 'eventprime-event-calendar-management'); |
| [1994](#L1994) | $csv\_fields[] = \_\_('Event Type', 'eventprime-event-calendar-management'); |
| [1995](#L1995) | $csv\_fields[] = \_\_('Venue', 'eventprime-event-calendar-management'); |
| [1996](#L1996) | $csv\_fields[] = \_\_('Seating Type', 'eventprime-event-calendar-management'); |
| [1997](#L1997) | $csv\_fields[] = \_\_('Attendees', 'eventprime-event-calendar-management'); |
| [1998](#L1998) | $csv\_fields[] = \_\_('Seat No.', 'eventprime-event-calendar-management'); |
| [1999](#L1999) | $csv\_fields[] = \_\_('Status', 'eventprime-event-calendar-management'); |
| [2000](#L2000) | fputcsv( $csv, $csv\_fields ); |
| [2001](#L2001) | foreach ( $data->posts as $a ) { |
| [2002](#L2002) | if ( ! fputcsv( $csv, array\_values((array) $a ) ) ) |
| [2003](#L2003) | return false; |
| [2004](#L2004) | } |
| [2005](#L2005) |  |
| [2006](#L2006) | fclose( $csv ); |
| [2007](#L2007) | wp\_die(); |
| [2008](#L2008) | } |
| [2009](#L2009) | } |
| [2010](#L2010) |  |
| [2011](#L2011) | /\*\* |
| [2012](#L2012) | \* Run migration process for < 3.0.0 installation |
| [2013](#L2013) | \*/ |
| [2014](#L2014) | public function eventprime\_run\_migration() { |
| [2015](#L2015) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-migration-nonce' ) ) { |
| [2016](#L2016) | // check if already migrated |
| [2017](#L2017) | if( empty( get\_option( 'ep\_db\_need\_to\_run\_migration' ) ) ) { |
| [2018](#L2018) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'EventPrime already migrated with the latest version.', 'eventprime-event-calendar-management' ) ) ); |
| [2019](#L2019) | } |
| [2020](#L2020) | // check if user has capability |
| [2021](#L2021) | if( ! current\_user\_can( 'manage\_options' ) ) { |
| [2022](#L2022) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'You are not authorised user for this action. Please contact with your administrator.', 'eventprime-event-calendar-management' ) ) ); |
| [2023](#L2023) | } |
| [2024](#L2024) |  |
| [2025](#L2025) | update\_option( 'ep\_db\_need\_to\_run\_migration', 0 ); |
| [2026](#L2026) |  |
| [2027](#L2027) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Migration Complete!', 'eventprime-event-calendar-management' ) ) ); |
| [2028](#L2028) | } else{ |
| [2029](#L2029) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2030](#L2030) | } |
| [2031](#L2031) | } |
| [2032](#L2032) |  |
| [2033](#L2033) | /\*\* |
| [2034](#L2034) | \* Cancel the migration process |
| [2035](#L2035) | \*/ |
| [2036](#L2036) | public function eventprime\_cancel\_migration() { |
| [2037](#L2037) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-migration-nonce' ) ) { |
| [2038](#L2038) | /\* $ep\_deactivate\_extensions\_on\_migration = get\_option( 'ep\_deactivate\_extensions\_on\_migration '); |
| [2039](#L2039) | if( ! empty( $ep\_deactivate\_extensions\_on\_migration ) ) { |
| [2040](#L2040) | foreach( $ep\_deactivate\_extensions\_on\_migration as $ext\_list ) { |
| [2041](#L2041) | activate\_plugin( $ext\_list ); |
| [2042](#L2042) | } |
| [2043](#L2043) | } |
| [2044](#L2044) | deactivate\_plugins( plugin\_basename( EP\_PLUGIN\_FILE ) ); \*/ |
| [2045](#L2045) |  |
| [2046](#L2046) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Migration Cancelled! Redirecting you to the plugins page.', 'eventprime-event-calendar-management' ) ) ); |
| [2047](#L2047) | } else{ |
| [2048](#L2048) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2049](#L2049) | } |
| [2050](#L2050) | } |
| [2051](#L2051) |  |
| [2052](#L2052) | /\*\* |
| [2053](#L2053) | \* Reload user sectionon the checkout page |
| [2054](#L2054) | \*/ |
| [2055](#L2055) | public function reload\_checkout\_user\_section() { |
| [2056](#L2056) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2057](#L2057) | if( ! empty( $\_POST['userId'] ) ) { |
| [2058](#L2058) | $user\_id = $\_POST['userId']; |
| [2059](#L2059) | $user\_data = get\_user\_by( 'id', $user\_id ); |
| [2060](#L2060) | if( ! empty( $user\_data ) ) { |
| [2061](#L2061) | if( get\_current\_user\_id() == $user\_id ) { |
| [2062](#L2062) | $user\_html = ''; |
| [2063](#L2063) | $user\_html .= '<div class="ep-logged-user ep-py-3 ep-border ep-rounded">'; |
| [2064](#L2064) | $user\_html .= '<div class="ep-box-row">'; |
| [2065](#L2065) | $user\_html .= '<div class="ep-box-col-12 ep-d-flex ep-align-items-center ">'; |
| [2066](#L2066) | $user\_html .= '<div class="ep-d-inline-flex ep-mx-3">'; |
| [2067](#L2067) | $user\_html .= '<img class="ep-rounded-circle" src="'. esc\_url( get\_avatar\_url( $user\_id ) ) .'" style="height: 32px;">'; |
| [2068](#L2068) | $user\_html .= '</div>'; |
| [2069](#L2069) | $user\_html .= '<div class="ep-d-inline-flex">'; |
| [2070](#L2070) | $user\_html .= '<span class="ep-mr-1"> '. esc\_html\_\_( 'Logged in as', 'eventprime-event-calendar-management' ) .'</span>'; |
| [2071](#L2071) | $user\_html .= '<span class="ep-fw-bold">'. esc\_html( $ep\_functions->ep\_get\_current\_user\_profile\_name() ) .'</span>'; |
| [2072](#L2072) | $user\_html .= '</div>'; |
| [2073](#L2073) | $user\_html .= '</div>'; |
| [2074](#L2074) | $user\_html .= '</div>'; |
| [2075](#L2075) | $user\_html .= '</div>'; |
| [2076](#L2076) |  |
| [2077](#L2077) | wp\_send\_json\_success( array( 'user\_html' => $user\_html ) ); |
| [2078](#L2078) | } |
| [2079](#L2079) | } else{ |
| [2080](#L2080) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Wrong information.', 'eventprime-event-calendar-management' ) ) ); |
| [2081](#L2081) | } |
| [2082](#L2082) | } else{ |
| [2083](#L2083) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Wrong information.', 'eventprime-event-calendar-management' ) ) ); |
| [2084](#L2084) | } |
| [2085](#L2085) | } |
| [2086](#L2086) |  |
| [2087](#L2087) | public function eventprime\_reports\_filter(){ |
| [2088](#L2088) | $report\_controller = new EventM\_Report\_Controller\_List; |
| [2089](#L2089) | $filter\_data = $report\_controller->eventprime\_report\_filters(); |
| [2090](#L2090) | wp\_send\_json\_success($filter\_data); |
| [2091](#L2091) | } |
| [2092](#L2092) |  |
| [2093](#L2093) | public function set\_default\_payment\_processor(){ |
| [2094](#L2094) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-default-payment-processor' ) ) { |
| [2095](#L2095) | $global\_settings = new Eventprime\_Global\_Settings; |
| [2096](#L2096) | $global\_settings\_data = $global\_settings->ep\_get\_settings(); |
| [2097](#L2097) | $form\_data = $\_POST; |
| [2098](#L2098) | if( isset( $form\_data ) && isset( $form\_data['ep\_default\_payment\_processor'] ) && ! empty( $form\_data['ep\_default\_payment\_processor'] ) ){ |
| [2099](#L2099) | $global\_settings\_data->default\_payment\_processor = $form\_data['ep\_default\_payment\_processor']; |
| [2100](#L2100) | $global\_settings->ep\_save\_settings( $global\_settings\_data ); |
| [2101](#L2101) | } |
| [2102](#L2102) | wp\_send\_json\_success(); |
| [2103](#L2103) | } else{ |
| [2104](#L2104) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2105](#L2105) | } |
| [2106](#L2106) | } |
| [2107](#L2107) |  |
| [2108](#L2108) | public function booking\_export\_all(){ |
| [2109](#L2109) | $data = $\_POST; |
| [2110](#L2110) | if(!empty($data)){ |
| [2111](#L2111) | if(is\_user\_logged\_in() && (current\_user\_can('edit\_em\_event') || current\_user\_can('edit\_posts'))){ |
| [2112](#L2112) | $booking\_controller = new EventPrime\_Bookings; |
| [2113](#L2113) | echo $booking\_controller->export\_bookings\_all($data); |
| [2114](#L2114) | } |
| [2115](#L2115) | } |
| [2116](#L2116) | die; |
| [2117](#L2117) | } |
| [2118](#L2118) |  |
| [2119](#L2119) | public function calendar\_event\_create(){ |
| [2120](#L2120) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [2121](#L2121) | if(isset($data['\_wpnonce']) && wp\_verify\_nonce(sanitize\_text\_field($data['\_wpnonce']), 'ep\_calendar\_create\_events' ) ){ |
| [2122](#L2122) | if(current\_user\_can('manage\_options') || current\_user\_can('publish\_em\_events')) { |
| [2123](#L2123) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2124](#L2124) | $response = $ep\_functions->ep\_calendar\_events\_create(); |
| [2125](#L2125) | } |
| [2126](#L2126) | else{ |
| [2127](#L2127) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2128](#L2128) | } |
| [2129](#L2129) | } |
| [2130](#L2130) | else |
| [2131](#L2131) | { |
| [2132](#L2132) | $response = array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ); |
| [2133](#L2133) | } |
| [2134](#L2134) | wp\_send\_json\_success($response); |
| [2135](#L2135) | die(); |
| [2136](#L2136) | } |
| [2137](#L2137) |  |
| [2138](#L2138) | public function calendar\_events\_drag\_event\_date(){ |
| [2139](#L2139) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2140](#L2140) | if( isset( $\_POST['id'] ) && ! empty( $\_POST['id'] ) ) { |
| [2141](#L2141) | if( !empty( get\_post( $\_POST['id'] ) ) && get\_post\_type( $\_POST['id'] ) == 'em\_event' ){ |
| [2142](#L2142) |  |
| [2143](#L2143) | if ( current\_user\_can( 'edit\_em\_event', $\_POST['id'] ) && current\_user\_can('manage\_options') ) { |
| [2144](#L2144) | $response = $ep\_functions->ep\_calendar\_events\_drag\_event\_date($\_POST); |
| [2145](#L2145) | } else { |
| [2146](#L2146) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2147](#L2147) | } |
| [2148](#L2148) | } else { |
| [2149](#L2149) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2150](#L2150) | } |
| [2151](#L2151) | } else { |
| [2152](#L2152) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2153](#L2153) | } |
| [2154](#L2154) | wp\_send\_json\_success($response); |
| [2155](#L2155) |  |
| [2156](#L2156) | } |
| [2157](#L2157) | public function calendar\_events\_delete(){ |
| [2158](#L2158) | if( !wp\_verify\_nonce( '\_wpnonce', 'ep-admin-calendar-action' ) ) { |
| [2159](#L2159) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2160](#L2160) | } |
| [2161](#L2161) | if(current\_user\_can('manage\_options') && isset( $\_POST['event\_id'] ) && ! empty( $\_POST['event\_id'] ) ) { |
| [2162](#L2162) | $event\_id = abs( sanitize\_text\_field( $\_POST['event\_id'] ) ); |
| [2163](#L2163) | $current\_user = wp\_get\_current\_user(); |
| [2164](#L2164) | if(!empty($event\_id)){ |
| [2165](#L2165) | if(!empty(get\_post($event\_id)) && get\_post\_type($event\_id) == 'em\_event' && ( user\_can( $current\_user->ID, 'edit\_em\_event', $event\_id ) && current\_user\_can('manage\_options') )){ |
| [2166](#L2166) | wp\_delete\_post( $event\_id ); |
| [2167](#L2167) | $response = array( 'post\_id' => $event\_id, 'status' => true ); |
| [2168](#L2168) | }else{ |
| [2169](#L2169) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2170](#L2170) |  |
| [2171](#L2171) | } |
| [2172](#L2172) | } |
| [2173](#L2173) |  |
| [2174](#L2174) | } else{ |
| [2175](#L2175) | $response = array( 'post\_id' =>'', 'status' => false, 'message' => esc\_html( 'Something went wrong.', 'eventprime-event-calendar-management' ) ); |
| [2176](#L2176) | } |
| [2177](#L2177) | wp\_send\_json\_success($response); |
| [2178](#L2178) | } |
| [2179](#L2179) |  |
| [2180](#L2180) | public function eventprime\_activate\_license() |
| [2181](#L2181) | { |
| [2182](#L2182) | $retrieved\_nonce = filter\_input( INPUT\_POST, 'nonce' ); |
| [2183](#L2183) |  |
| [2184](#L2184) | if ( !wp\_verify\_nonce( $retrieved\_nonce, 'ep-license-nonce' ) ) { |
| [2185](#L2185) | die( esc\_html\_\_( 'Failed security check', 'eventprime-event-calendar-management' ) ); |
| [2186](#L2186) | } |
| [2187](#L2187) | $ep\_license\_activate = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_license\_activate' )); |
| [2188](#L2188) | $license\_key = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_license' )); |
| [2189](#L2189) | $item\_id = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_item\_id' )); |
| [2190](#L2190) | $item\_key = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_item\_key' )); |
| [2191](#L2191) | update\_option( $item\_key.'\_license\_key', $license\_key ); |
| [2192](#L2192) | update\_option( $item\_key.'\_license\_id', $item\_id ); |
| [2193](#L2193) |  |
| [2194](#L2194) |  |
| [2195](#L2195) | $response = array(); |
| [2196](#L2196) | if( isset( $ep\_license\_activate ) && ! empty( $ep\_license\_activate ) ){ |
| [2197](#L2197) | $license = new EventPrime\_License(); |
| [2198](#L2198) | $response = $license->ep\_activate\_license($license\_key,$item\_id,$item\_key); |
| [2199](#L2199) | wp\_send\_json\_success( $response ); |
| [2200](#L2200) | } |
| [2201](#L2201) | else |
| [2202](#L2202) | { |
| [2203](#L2203) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2204](#L2204) | } |
| [2205](#L2205) |  |
| [2206](#L2206) | } |
| [2207](#L2207) |  |
| [2208](#L2208) | public function eventprime\_deactivate\_license(){ |
| [2209](#L2209) |  |
| [2210](#L2210) | $retrieved\_nonce = filter\_input( INPUT\_POST, 'nonce' ); |
| [2211](#L2211) | if ( !wp\_verify\_nonce( $retrieved\_nonce, 'ep-license-nonce' ) ) { |
| [2212](#L2212) | die( esc\_html\_\_( 'Failed security check', 'eventprime-event-calendar-management' ) ); |
| [2213](#L2213) | } |
| [2214](#L2214) | $ep\_license\_deactivate = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_license\_deactivate' )); |
| [2215](#L2215) | $license\_key = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_license' )); |
| [2216](#L2216) | $item\_id = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_item\_id' )); |
| [2217](#L2217) | $item\_key = sanitize\_text\_field(filter\_input( INPUT\_POST, 'ep\_item\_key' )); |
| [2218](#L2218) | update\_option( $item\_key.'\_license\_key', $license\_key ); |
| [2219](#L2219) | update\_option( $item\_key.'\_license\_id', $item\_id ); |
| [2220](#L2220) | $response = array(); |
| [2221](#L2221) | if( isset( $ep\_license\_deactivate ) && ! empty( $ep\_license\_deactivate ) ){ |
| [2222](#L2222) | $license = new EventPrime\_License(); |
| [2223](#L2223) | $response = $license->ep\_deactivate\_license($license\_key,$item\_id,$item\_key); |
| [2224](#L2224) | wp\_send\_json\_success( $response ); |
| [2225](#L2225) | } |
| [2226](#L2226) | else |
| [2227](#L2227) | { |
| [2228](#L2228) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2229](#L2229) | } |
| [2230](#L2230) |  |
| [2231](#L2231) | } |
| [2232](#L2232) |  |
| [2233](#L2233) | /\*\* |
| [2234](#L2234) | \* Update booking action |
| [2235](#L2235) | \*/ |
| [2236](#L2236) | public function update\_event\_booking\_action() { |
| [2237](#L2237) | $sanitizer = new EventPrime\_sanitizer; |
| [2238](#L2238) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [2239](#L2239) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2240](#L2240) | if( wp\_verify\_nonce( $data['ep\_update\_event\_booking\_nonce'], 'ep\_update\_event\_booking' ) ) { |
| [2241](#L2241) | $ep\_event\_booking\_id = ( ! empty( $data['ep\_event\_booking\_id'] ) ? $data['ep\_event\_booking\_id'] : '' ); |
| [2242](#L2242) | if( ! empty( $ep\_event\_booking\_id ) ) { |
| [2243](#L2243) | $booking\_controller = new EventPrime\_Bookings; |
| [2244](#L2244) | $single\_booking = $booking\_controller->load\_booking\_detail( $ep\_event\_booking\_id ); |
| [2245](#L2245) | if( ! empty( $single\_booking ) ) { |
| [2246](#L2246) | if( ! empty( $data['ep\_booking\_attendee\_fields'] ) ) { |
| [2247](#L2247) | $ep\_booking\_attendde\_field = $sanitizer->sanitize($data['ep\_booking\_attendee\_fields']); |
| [2248](#L2248) | update\_post\_meta( $ep\_event\_booking\_id, 'em\_attendee\_names', $ep\_booking\_attendde\_field ); |
| [2249](#L2249) | } |
| [2250](#L2250) | } |
| [2251](#L2251) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Booking Updated Successfully.', 'eventprime-event-calendar-management' ), 'redirect\_url' => esc\_url( $ep\_functions->ep\_get\_custom\_page\_url( 'profile\_page' ) ) ) ); |
| [2252](#L2252) | } else{ |
| [2253](#L2253) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Booking id can\'t be null. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2254](#L2254) | } |
| [2255](#L2255) | } else{ |
| [2256](#L2256) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2257](#L2257) | } |
| [2258](#L2258) | } |
| [2259](#L2259) |  |
| [2260](#L2260) | // Print all attendees of an event |
| [2261](#L2261) | public function event\_print\_all\_attendees() { |
| [2262](#L2262) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2263](#L2263) | if( wp\_verify\_nonce( $\_POST['security'], 'ep\_print\_event\_attendees' ) ) { |
| [2264](#L2264) | $event\_id = ( ! empty( $\_POST['event\_id'] ) ? absint( $\_POST['event\_id'] ) : '' ); |
| [2265](#L2265) | if( ! empty( $event\_id ) ) { |
| [2266](#L2266) | $em\_event\_checkout\_attendee\_fields = get\_post\_meta( $event\_id, 'em\_event\_checkout\_attendee\_fields', true ); |
| [2267](#L2267) | $attendee\_fileds\_data = ( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_fields\_data'] ) ? $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_fields\_data'] : array() ); |
| [2268](#L2268) | $bookings\_data = array(); |
| [2269](#L2269) | $bookings\_data[0]['id']   = esc\_html\_\_( 'Booking ID', 'eventprime-event-calendar-management' ); |
| [2270](#L2270) | $bookings\_data[0]['event'] = esc\_html\_\_( 'Event', 'eventprime-event-calendar-management' ); |
| [2271](#L2271) | if( empty( $attendee\_fileds\_data ) ) { |
| [2272](#L2272) | $bookings\_data[0]['first\_name'] = esc\_html\_\_( 'First Name', 'eventprime-event-calendar-management' ); |
| [2273](#L2273) | $bookings\_data[0]['last\_name']  = esc\_html\_\_( 'Last Name', 'eventprime-event-calendar-management' ); |
| [2274](#L2274) | } else{ |
| [2275](#L2275) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name'] ) ) { |
| [2276](#L2276) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_first\_name'] ) ) { |
| [2277](#L2277) | $bookings\_data[0]['first\_name'] = esc\_html\_\_( 'First Name', 'eventprime-event-calendar-management' ); |
| [2278](#L2278) | } |
| [2279](#L2279) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_middle\_name'] ) ) { |
| [2280](#L2280) | $bookings\_data[0]['middle\_name'] = esc\_html\_\_( 'Middle Name', 'eventprime-event-calendar-management' ); |
| [2281](#L2281) | } |
| [2282](#L2282) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_last\_name'] ) ) { |
| [2283](#L2283) | $bookings\_data[0]['last\_name'] = esc\_html\_\_( 'Last Name', 'eventprime-event-calendar-management' ); |
| [2284](#L2284) | } |
| [2285](#L2285) | } |
| [2286](#L2286) | foreach( $attendee\_fileds\_data as $fields ) { |
| [2287](#L2287) | $label = $ep\_functions->get\_checkout\_field\_label\_by\_id( $fields ); |
| [2288](#L2288) | $bookings\_data[0][$label->label] = esc\_html( $label->label ); |
| [2289](#L2289) | } |
| [2290](#L2290) | } |
| [2291](#L2291) | $bookings\_data[0]['user\_email']  = esc\_html\_\_( 'Email', 'eventprime-event-calendar-management' ); |
| [2292](#L2292) | $bookings\_data[0]['ticket\_name'] = esc\_html\_\_( 'Ticket', 'eventprime-event-calendar-management' ); |
| [2293](#L2293) | $bookings\_data[0]['booked\_on']   = esc\_html\_\_( 'Booked On', 'eventprime-event-calendar-management' ); |
| [2294](#L2294) |  |
| [2295](#L2295) | $booking\_controller = new EventPrime\_Bookings; |
| [2296](#L2296) | $event\_bookings = $booking\_controller->get\_event\_bookings\_by\_event\_id( $event\_id ); |
| [2297](#L2297) | if( ! empty( $event\_bookings ) ) { |
| [2298](#L2298) | $row = 1; |
| [2299](#L2299) | foreach( $event\_bookings as $booking ) { |
| [2300](#L2300) | $booking\_id = $booking->ID; |
| [2301](#L2301) | $em\_attendee\_names = get\_post\_meta( $booking\_id, 'em\_attendee\_names', true ); |
| [2302](#L2302) | if( ! empty( $em\_attendee\_names ) ) { |
| [2303](#L2303) | $ticket\_name = ''; |
| [2304](#L2304) | foreach( $em\_attendee\_names as $ticket\_id => $ticket\_attendees ) { |
| [2305](#L2305) | $ticket\_name = $ep\_functions->get\_ticket\_name\_by\_id( $ticket\_id ); |
| [2306](#L2306) | if( ! empty( $ticket\_attendees ) && count( $ticket\_attendees ) > 0 ) { |
| [2307](#L2307) | foreach( $ticket\_attendees as $attendee\_data ) { |
| [2308](#L2308) | //$bookings\_data[$row]['id'] = $bookings\_data[$row]['event'] = $bookings\_data[$row]['user\_email'] = $bookings\_data[$row]['booked\_on'] = ''; |
| [2309](#L2309) | $bookings\_data[$row]['id'] = $booking\_id; |
| [2310](#L2310) | $bookings\_data[$row]['event'] = get\_the\_title( $event\_id ); |
| [2311](#L2311) | if( empty( $attendee\_fileds\_data ) ) { |
| [2312](#L2312) | $bookings\_data[$row]['first\_name'] = $attendee\_data['name']['first\_name']; |
| [2313](#L2313) | $bookings\_data[$row]['last\_name']  = $attendee\_data['name']['last\_name']; |
| [2314](#L2314) | } else{ |
| [2315](#L2315) | if( isset( $attendee\_data['name'] ) ) { |
| [2316](#L2316) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_first\_name'] ) ) { |
| [2317](#L2317) | $bookings\_data[$row]['first\_name']  = $attendee\_data['name']['first\_name']; |
| [2318](#L2318) | } |
| [2319](#L2319) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_middle\_name'] ) ) { |
| [2320](#L2320) | $bookings\_data[$row]['middle\_name'] = $attendee\_data['name']['middle\_name']; |
| [2321](#L2321) | } |
| [2322](#L2322) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_last\_name'] ) ) { |
| [2323](#L2323) | $bookings\_data[$row]['last\_name']   = $attendee\_data['name']['last\_name']; |
| [2324](#L2324) | } |
| [2325](#L2325) | } |
| [2326](#L2326) | foreach( $attendee\_fileds\_data as $fields ) { |
| [2327](#L2327) | $checkout\_field\_val = ''; |
| [2328](#L2328) | if( ! empty( $attendee\_data[$fields] ) ) { |
| [2329](#L2329) | $label\_val = $attendee\_data[$fields]['label']; |
| [2330](#L2330) | $input\_name = $ep\_functions->ep\_get\_slug\_from\_string( $label\_val ); |
| [2331](#L2331) | if( ! empty( $attendee\_data[$fields][$input\_name] ) ) { |
| [2332](#L2332) | $input\_val = $attendee\_data[$fields][$input\_name]; |
| [2333](#L2333) | if( is\_array( $input\_val ) ) { |
| [2334](#L2334) | $checkout\_field\_val = esc\_html( implode( ', ', $input\_val ) ); |
| [2335](#L2335) | } else{ |
| [2336](#L2336) | $checkout\_field\_val = esc\_html( $attendee\_data[$fields][$input\_name] ); |
| [2337](#L2337) | } |
| [2338](#L2338) | } |
| [2339](#L2339) | } |
| [2340](#L2340) | $bookings\_data[$row][$label\_val] = $checkout\_field\_val; |
| [2341](#L2341) | } |
| [2342](#L2342) | } |
| [2343](#L2343) |  |
| [2344](#L2344) | $user\_id = get\_post\_meta( $booking\_id, 'em\_user', true ); |
| [2345](#L2345) | if( ! empty( $user\_id ) ) { |
| [2346](#L2346) | $user = get\_user\_by( 'id', $user\_id ); |
| [2347](#L2347) | if( ! empty( $user ) ) { |
| [2348](#L2348) | $booking\_user\_email = esc\_html( $user->user\_email ); |
| [2349](#L2349) | } else{ |
| [2350](#L2350) | $booking\_user\_email = '----'; |
| [2351](#L2351) | } |
| [2352](#L2352) | } else{ |
| [2353](#L2353) | $is\_guest\_booking = get\_post\_meta( $booking\_id, 'em\_guest\_booking', true ); |
| [2354](#L2354) | if( ! empty( $is\_guest\_booking ) ) { |
| [2355](#L2355) | $em\_order\_info = get\_post\_meta( $booking\_id, 'em\_order\_info', true ); |
| [2356](#L2356) | if( ! empty( $em\_order\_info ) && ! empty( $em\_order\_info['user\_email'] ) ) { |
| [2357](#L2357) | $booking\_user\_email = esc\_html( $em\_order\_info['user\_email'] ); |
| [2358](#L2358) | } |
| [2359](#L2359) | } |
| [2360](#L2360) | } |
| [2361](#L2361) | $bookings\_data[$row]['user\_email'] = $booking\_user\_email; |
| [2362](#L2362) | $bookings\_data[$row]['ticket\_name'] = $ticket\_name; |
| [2363](#L2363) | $em\_date = get\_post\_meta( $booking\_id, 'em\_date', true ); |
| [2364](#L2364) | if( ! empty( $em\_date ) ) { |
| [2365](#L2365) | $bookings\_data[$row]['booked\_on'] = esc\_html( $ep\_functions->ep\_timestamp\_to\_date( $em\_date, 'd M, Y' ) ); |
| [2366](#L2366) | } |
| [2367](#L2367) | $row++; |
| [2368](#L2368) | } |
| [2369](#L2369) | } |
| [2370](#L2370) | } |
| [2371](#L2371) | } else{ |
| [2372](#L2372) | $tickets\_info = ( ! empty( $booking->em\_order\_info['tickets'] ) ? $booking->em\_order\_info['tickets'] : array() ); |
| [2373](#L2373) | if( ! empty( $tickets\_info ) && count( $tickets\_info ) > 0 ) { |
| [2374](#L2374) | for( $con = 0; $con < count( $tickets\_info ); $con++ ) { |
| [2375](#L2375) | $bookings\_data[$row]['id'] = $booking\_id; |
| [2376](#L2376) | $bookings\_data[$row]['event'] = get\_the\_title( $event\_id ); |
| [2377](#L2377) | $ticket\_id = ( ! empty( $tickets\_info[$con] ) && ! empty( $tickets\_info[$con]->id ) ) ? $tickets\_info[$con]->id : ''; |
| [2378](#L2378) | $ticket\_name = ( ! empty( $ticket\_id ) ? $ep\_functions->get\_ticket\_name\_by\_id( $ticket\_id ) : '----' ); |
| [2379](#L2379) | if( empty( $attendee\_fileds\_data ) ) { |
| [2380](#L2380) | $bookings\_data[$row]['first\_name'] = '----'; |
| [2381](#L2381) | $bookings\_data[$row]['last\_name']  = '----'; |
| [2382](#L2382) | } else{ |
| [2383](#L2383) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name'] ) ) { |
| [2384](#L2384) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_first\_name'] ) ) { |
| [2385](#L2385) | $bookings\_data[$row]['first\_name'] = '----'; |
| [2386](#L2386) | } |
| [2387](#L2387) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_middle\_name'] ) ) { |
| [2388](#L2388) | $bookings\_data[$row]['middle\_name'] = '----'; |
| [2389](#L2389) | } |
| [2390](#L2390) | if( ! empty( $em\_event\_checkout\_attendee\_fields['em\_event\_checkout\_name\_last\_name'] ) ) { |
| [2391](#L2391) | $bookings\_data[$row]['last\_name'] = '----'; |
| [2392](#L2392) | } |
| [2393](#L2393) | } |
| [2394](#L2394) | foreach( $attendee\_fileds\_data as $fields ) { |
| [2395](#L2395) | $label = $ep\_functions->get\_checkout\_field\_label\_by\_id( $fields ); |
| [2396](#L2396) | $bookings\_data[$row][$label->label] = '----'; |
| [2397](#L2397) | } |
| [2398](#L2398) | } |
| [2399](#L2399) | $user\_id = get\_post\_meta( $booking\_id, 'em\_user', true ); |
| [2400](#L2400) | if( ! empty( $user\_id ) ) { |
| [2401](#L2401) | $user = get\_user\_by( 'id', $user\_id ); |
| [2402](#L2402) | if( ! empty( $user ) ) { |
| [2403](#L2403) | $booking\_user\_email = esc\_html( $user->user\_email ); |
| [2404](#L2404) | } else{ |
| [2405](#L2405) | $booking\_user\_email = '----'; |
| [2406](#L2406) | } |
| [2407](#L2407) | } else{ |
| [2408](#L2408) | $is\_guest\_booking = get\_post\_meta( $booking\_id, 'em\_guest\_booking', true ); |
| [2409](#L2409) | if( ! empty( $is\_guest\_booking ) ) { |
| [2410](#L2410) | $em\_order\_info = get\_post\_meta( $booking\_id, 'em\_order\_info', true ); |
| [2411](#L2411) | if( ! empty( $em\_order\_info ) && ! empty( $em\_order\_info['user\_email'] ) ) { |
| [2412](#L2412) | $booking\_user\_email = esc\_html( $em\_order\_info['user\_email'] ); |
| [2413](#L2413) | } |
| [2414](#L2414) | } |
| [2415](#L2415) | } |
| [2416](#L2416) | $bookings\_data[$row]['user\_email'] = $booking\_user\_email; |
| [2417](#L2417) | $bookings\_data[$row]['ticket\_name'] = $ticket\_name; |
| [2418](#L2418) | $em\_date = get\_post\_meta( $booking\_id, 'em\_date', true ); |
| [2419](#L2419) | if( ! empty( $em\_date ) ) { |
| [2420](#L2420) | $bookings\_data[$row]['booked\_on'] = esc\_html( $ep\_functions->ep\_timestamp\_to\_date( $em\_date, 'd M, Y' ) ); |
| [2421](#L2421) | } |
| [2422](#L2422) | $row++; |
| [2423](#L2423) | } |
| [2424](#L2424) | } |
| [2425](#L2425) | } |
| [2426](#L2426) | } |
| [2427](#L2427) | } |
| [2428](#L2428) |  |
| [2429](#L2429) | header('Content-Type: text/csv; charset=utf-8'); |
| [2430](#L2430) | header('Content-Disposition: attachment; filename="ep-bookings-'.md5(time().mt\_rand(100, 999)).'.csv"'); |
| [2431](#L2431) | $f = fopen('php://output', 'w'); |
| [2432](#L2432) | foreach ( $bookings\_data as $line ) { |
| [2433](#L2433) | fputcsv( $f, $line ); |
| [2434](#L2434) | } |
| [2435](#L2435) | die; |
| [2436](#L2436) | } else{ |
| [2437](#L2437) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Event id can\'t be null. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2438](#L2438) | } |
| [2439](#L2439) | } else{ |
| [2440](#L2440) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2441](#L2441) | } |
| [2442](#L2442) | } |
| [2443](#L2443) |  |
| [2444](#L2444) | // load attendee fields html for edit booking |
| [2445](#L2445) | public function load\_edit\_booking\_attendee\_data() { |
| [2446](#L2446) | $response = new stdClass(); |
| [2447](#L2447) | if( wp\_verify\_nonce( $\_POST['security'], 'ep\_booking\_attendee\_data' ) ) { |
| [2448](#L2448) | $event\_id = ( ! empty( $\_POST['event\_id'] ) ? absint( $\_POST['event\_id'] ) : '' ); |
| [2449](#L2449) | $booking\_id = ( ! empty( $\_POST['booking\_id'] ) ? absint( $\_POST['booking\_id'] ) : '' ); |
| [2450](#L2450) | $ticket\_id = ( ! empty( $\_POST['ticket\_id'] ) ? absint( $\_POST['ticket\_id'] ) : '' ); |
| [2451](#L2451) | if( ! empty( $event\_id ) && ! empty( $booking\_id ) && ! empty( $ticket\_id )) { |
| [2452](#L2452) | $booking\_controller = new EventPrime\_Bookings; |
| [2453](#L2453) | $booking = $booking\_controller->load\_booking\_detail( $booking\_id ); |
| [2454](#L2454) | if(!empty($booking)){ |
| [2455](#L2455) | echo $booking\_controller->ep\_get\_admin\_edit\_attendees\_html($booking); |
| [2456](#L2456) |  |
| [2457](#L2457) |  |
| [2458](#L2458) | }else{ |
| [2459](#L2459) | esc\_html\_e('No booking found','eventprime-event-calendar-management'); |
| [2460](#L2460) | } |
| [2461](#L2461) |  |
| [2462](#L2462) | } else{ |
| [2463](#L2463) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Some data is missing. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2464](#L2464) | } |
| [2465](#L2465) | } |
| [2466](#L2466) | die(); |
| [2467](#L2467) | } |
| [2468](#L2468) |  |
| [2469](#L2469) |  |
| [2470](#L2470) | // sanitize input field data |
| [2471](#L2471) | public function sanitize\_input\_field\_data() { |
| [2472](#L2472) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-frontend-nonce' ) ) { |
| [2473](#L2473) | if( isset( $\_POST['input\_val'] ) && ! empty( $\_POST['input\_val'] ) ) { |
| [2474](#L2474) | $input\_val = sanitize\_text\_field( $\_POST['input\_val'] ); |
| [2475](#L2475) | wp\_send\_json\_success( $input\_val ); |
| [2476](#L2476) | } else{ |
| [2477](#L2477) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Value is missing.', 'eventprime-event-calendar-management' ) ) ); |
| [2478](#L2478) | } |
| [2479](#L2479) | } else{ |
| [2480](#L2480) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2481](#L2481) | } |
| [2482](#L2482) | } |
| [2483](#L2483) |  |
| [2484](#L2484) | // send feedback |
| [2485](#L2485) | public function send\_plugin\_deactivation\_feedback() { |
| [2486](#L2486) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-plugin-deactivation-nonce' ) ) { |
| [2487](#L2487) | if( isset( $\_POST['feedback'] ) && ! empty( $\_POST['feedback'] ) ) { |
| [2488](#L2488) | $feedback = sanitize\_text\_field( $\_POST['feedback'] ); |
| [2489](#L2489) | $message = sanitize\_text\_field( $\_POST['message'] ); |
| [2490](#L2490) | $email\_message = ''; |
| [2491](#L2491) | if( ! empty( $\_POST['ep\_user\_support\_email'] ) ){ |
| [2492](#L2492) | $ep\_user\_support\_email = sanitize\_email( $\_POST['ep\_user\_support\_email'] ); |
| [2493](#L2493) | $from\_email\_address = '<' . $ep\_user\_support\_email . '>'; |
| [2494](#L2494) | }else{ |
| [2495](#L2495) | $from\_email\_address = '<' . get\_option('admin\_email') . '>'; |
| [2496](#L2496) | } |
| [2497](#L2497) |  |
| [2498](#L2498) | switch( $feedback ) { |
| [2499](#L2499) | case 'feature\_not\_available': $body='Feature not available: '; break; |
| [2500](#L2500) | case 'feature\_not\_working': $body='Feature not working: '; break; |
| [2501](#L2501) | case 'plugin\_difficult-to-use': $body='Plugin is difficult or confusing to use: '; break; |
| [2502](#L2502) | case 'plugin\_broke\_site': $body='Plugin broke my site'; break; |
| [2503](#L2503) | case 'plugin\_has\_design\_issue': $body='Plugin has design issue'; break; |
| [2504](#L2504) | case 'temporary\_deactivation': $body = "It's a temporary deactivation"; break; |
| [2505](#L2505) | case 'plugin\_missing-documentation': $body = "Plugin is missing documentation"; break; |
| [2506](#L2506) | case 'other': $body='Other: '; break; |
| [2507](#L2507) | default: return; |
| [2508](#L2508) | } |
| [2509](#L2509) | if( ! empty( $feedback ) ) { |
| [2510](#L2510) | $email\_message .= $body."\n\r"; |
| [2511](#L2511) | if( ! empty( $message ) ) { |
| [2512](#L2512) | $email\_message .= "<br><u>User Feedback Message</u> - "; |
| [2513](#L2513) | // $email\_message .= $message."\n\r"; |
| [2514](#L2514) | $email\_message .= $message."<br>"; |
| [2515](#L2515) | } |
| [2516](#L2516) | $email\_message .= "\n\r EventPrime Version - ".EVENTPRIME\_VERSION; |
| [2517](#L2517) | $headers = "MIME-Version: 1.0\r\n"; |
| [2518](#L2518) | $headers .= "Content-type:text/html;charset=UTF-8\r\n"; |
| [2519](#L2519) | $headers .= 'From:'.$from\_email\_address."\r\n"; |
| [2520](#L2520) | if ( wp\_mail( 'feedback@theeventprime.com', 'EventPrime Uninstallation Feedback', $email\_message, $headers ) ){ |
| [2521](#L2521) | if( isset( $\_POST['ep\_inform\_email'] ) && ! empty( $\_POST['ep\_inform\_email'] ) ){ |
| [2522](#L2522) | wp\_mail( 'support@theeventprime.com', 'EventPrime Uninstallation Feedback', $email\_message, $headers ); |
| [2523](#L2523) | } |
| [2524](#L2524) | wp\_send\_json\_success(); |
| [2525](#L2525) | }else{ |
| [2526](#L2526) | wp\_send\_json\_error(); |
| [2527](#L2527) | } |
| [2528](#L2528) | } |
| [2529](#L2529) | } else{ |
| [2530](#L2530) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Feedback is missing.', 'eventprime-event-calendar-management' ) ) ); |
| [2531](#L2531) | } |
| [2532](#L2532) | } else{ |
| [2533](#L2533) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2534](#L2534) | } |
| [2535](#L2535) | } |
| [2536](#L2536) |  |
| [2537](#L2537) | // delete fes event from user profile |
| [2538](#L2538) | public function delete\_user\_fes\_event() { |
| [2539](#L2539) | if( wp\_verify\_nonce( $\_POST['security'], 'ep-frontend-nonce' ) ) { |
| [2540](#L2540) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2541](#L2541) | $dbhandler = new EP\_DBhandler; |
| [2542](#L2542) | if( isset( $\_POST['fes\_event\_id'] ) && ! empty( $\_POST['fes\_event\_id'] ) ) { |
| [2543](#L2543) | global $wpdb; |
| [2544](#L2544) | $fes\_event\_id = absint( $\_POST['fes\_event\_id'] ); |
| [2545](#L2545) | $current\_user\_id = get\_current\_user\_id(); |
| [2546](#L2546) | $single\_event = $ep\_functions->get\_single\_event( $fes\_event\_id ); |
| [2547](#L2547) | if( empty( $single\_event ) ) { |
| [2548](#L2548) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Event does not found.', 'eventprime-event-calendar-management' ) ) ); |
| [2549](#L2549) | } |
| [2550](#L2550) | if( empty( $single\_event->em\_frontend\_submission ) ) { |
| [2551](#L2551) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Event can\'t be deleted.', 'eventprime-event-calendar-management' ) ) ); |
| [2552](#L2552) | } |
| [2553](#L2553) | // check if the logged user is same |
| [2554](#L2554) | $event\_user = $single\_event->em\_user; |
| [2555](#L2555) | if( $event\_user != $current\_user\_id ) { |
| [2556](#L2556) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'You are not authorised to delete this event.', 'eventprime-event-calendar-management' ) ) ); |
| [2557](#L2557) | } |
| [2558](#L2558) | // start event deletion |
| [2559](#L2559) | // first check for recurring events |
| [2560](#L2560) | $booking\_controllers = new EventPrime\_Bookings; |
| [2561](#L2561) | $metaboxes\_controllers = new EP\_DBhandler; |
| [2562](#L2562) | $metaboxes\_controllers->ep\_delete\_child\_events( $fes\_event\_id ); |
| [2563](#L2563) | // check category and tickets and delete them |
| [2564](#L2564) | $cat\_table\_name = 'TICKET\_CATEGORIES'; |
| [2565](#L2565) | $price\_options\_table = 'TICKET'; |
| [2566](#L2566) | // delete all ticket categories |
| [2567](#L2567) | if( ! empty( $single\_event->ticket\_categories ) ) { |
| [2568](#L2568) | foreach( $single\_event->ticket\_categories as $category ) { |
| [2569](#L2569) | if( ! empty( $category->id ) ) { |
| [2570](#L2570) | $dbhandler->remove\_row($cat\_table\_name,'id', $category->id); |
| [2571](#L2571) | } |
| [2572](#L2572) | } |
| [2573](#L2573) | } |
| [2574](#L2574) | // delete all tickets |
| [2575](#L2575) | if( ! empty( $single\_event->all\_tickets\_data ) ) { |
| [2576](#L2576) | foreach( $single\_event->all\_tickets\_data as $ticket ) { |
| [2577](#L2577) | if( ! empty( $ticket->id ) ) { |
| [2578](#L2578) | $dbhandler->remove\_row($price\_options\_table,'id', $ticket->id); |
| [2579](#L2579) | } |
| [2580](#L2580) | } |
| [2581](#L2581) | } |
| [2582](#L2582) | // delete booking of this event |
| [2583](#L2583) | $event\_bookings = $booking\_controllers->get\_event\_bookings\_by\_event\_id( $fes\_event\_id ); |
| [2584](#L2584) | if( ! empty( $event\_bookings ) ) { |
| [2585](#L2585) | foreach( $event\_bookings as $booking ) { |
| [2586](#L2586) | // delete booking |
| [2587](#L2587) | wp\_delete\_post( $booking->ID, true ); |
| [2588](#L2588) | } |
| [2589](#L2589) | } |
| [2590](#L2590) | // delete terms relationships |
| [2591](#L2591) | wp\_delete\_object\_term\_relationships( $fes\_event\_id, array( 'em\_venue', 'em\_event\_type', 'em\_event\_organizer' ) ); |
| [2592](#L2592) |  |
| [2593](#L2593) | // delete ext data |
| [2594](#L2594) | do\_action( 'ep\_delete\_event\_data', $fes\_event\_id ); |
| [2595](#L2595) |  |
| [2596](#L2596) | wp\_delete\_post( $fes\_event\_id, true ); |
| [2597](#L2597) |  |
| [2598](#L2598) | wp\_send\_json\_success( array( 'message' => esc\_html\_\_( 'Event Deleted Successfully', 'eventprime-event-calendar-management' ) ) ); |
| [2599](#L2599) | } else{ |
| [2600](#L2600) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Event Id Is Missing.', 'eventprime-event-calendar-management' ) ) ); |
| [2601](#L2601) | } |
| [2602](#L2602) | } else{ |
| [2603](#L2603) | wp\_send\_json\_error( array( 'message' => esc\_html\_\_( 'Security check failed. Please refresh the page and try again later.', 'eventprime-event-calendar-management' ) ) ); |
| [2604](#L2604) | } |
| [2605](#L2605) | } |
| [2606](#L2606) |  |
| [2607](#L2607) | public function edit\_booking\_attendee\_data\_save(){ |
| [2608](#L2608) | $sanitizer = new EventPrime\_sanitizer; |
| [2609](#L2609) | parse\_str( wp\_unslash( $\_POST['data'] ), $data ); |
| [2610](#L2610) |  |
| [2611](#L2611) | if( wp\_verify\_nonce( $\_POST['security'], 'ep\_booking\_attendee\_data' ) ) { |
| [2612](#L2612) | $attendees\_names = isset($data['ep\_booking\_attendee\_fields']) ? $sanitizer->sanitize($data['ep\_booking\_attendee\_fields']) : array(); |
| [2613](#L2613) | if(is\_array($attendees\_names)){ |
| [2614](#L2614) | update\_post\_meta( $\_POST['booking\_id'], 'em\_attendee\_names', $attendees\_names ); |
| [2615](#L2615) | } |
| [2616](#L2616) |  |
| [2617](#L2617) | } |
| [2618](#L2618) | die(); |
| [2619](#L2619) | } |
| [2620](#L2620) |  |
| [2621](#L2621) | public function get\_calendar\_event() |
| [2622](#L2622) | { |
| [2623](#L2623) | $ep\_functions = new Eventprime\_Basic\_Functions; |
| [2624](#L2624) | // Create a DateTime object from the string |
| [2625](#L2625) | $startdate = new DateTime($\_POST['start']); |
| [2626](#L2626) | $format = $ep\_functions->ep\_get\_datepicker\_format(); |
| [2627](#L2627) | $formattedstartDate = $startdate->format($format); |
| [2628](#L2628) |  |
| [2629](#L2629) | $enddate = new DateTime($\_POST['end']); |
| [2630](#L2630) | $formattedendDate = $enddate->format($format); |
| [2631](#L2631) |  |
| [2632](#L2632) | $start = $formattedstartDate; |
| [2633](#L2633) | $end = $formattedendDate; |
| [2634](#L2634) |  |
| [2635](#L2635) | $is\_admin = (isset($\_POST['is\_dashboard']))?true:false; |
| [2636](#L2636) |  |
| [2637](#L2637) | $dateInfo = array( |
| [2638](#L2638) | array( |
| [2639](#L2639) | 'label' => 'From', |
| [2640](#L2640) | 'key' => 'date\_from', |
| [2641](#L2641) | 'value' => $start, |
| [2642](#L2642) | 'text' => $start |
| [2643](#L2643) | ), |
| [2644](#L2644) | array( |
| [2645](#L2645) | 'label' => 'To', |
| [2646](#L2646) | 'key' => 'date\_to', |
| [2647](#L2647) | 'value' => $end, |
| [2648](#L2648) | 'text' => $end |
| [2649](#L2649) | ), |
| [2650](#L2650) | array( |
| [2651](#L2651) | 'label' => 'Days', |
| [2652](#L2652) | 'key' => 'days', |
| [2653](#L2653) | 'value' => 'all', |
| [2654](#L2654) | 'text' => 'All Days' |
| [2655](#L2655) | ) |
| [2656](#L2656) | ); |
| [2657](#L2657) |  |
| [2658](#L2658) |  |
| [2659](#L2659) | $params = array |
| [2660](#L2660) | ( |
| [2661](#L2661) | 'meta\_key' => 'em\_start\_date\_time', |
| [2662](#L2662) | 'orderby' => 'meta\_value\_num', |
| [2663](#L2663) | 'posts\_per\_page' => -1, |
| [2664](#L2664) | 'offset' => 0, |
| [2665](#L2665) | 'paged' => 1, |
| [2666](#L2666) | 'meta\_query' => array |
| [2667](#L2667) | ( |
| [2668](#L2668) | 'relation' => 'AND' |
| [2669](#L2669) | ), |
| [2670](#L2670) |  |
| [2671](#L2671) | 'order' => 'ASC' |
| [2672](#L2672) | ); |
| [2673](#L2673) |  |
| [2674](#L2674) | $params = $ep\_functions->create\_filter\_query($dateInfo,$params); |
| [2675](#L2675) |  |
| [2676](#L2676) | $event\_search\_params = array(); |
| [2677](#L2677) | if( isset( $\_POST['search\_param'] ) && ! empty( $\_POST['search\_param'] ) ) { |
| [2678](#L2678) | $event\_search\_params = json\_decode( stripslashes( $\_POST['search\_param'] ), true ); |
| [2679](#L2679) | if( ! empty( $event\_search\_params ) && count( $event\_search\_params ) > 0 ) { |
| [2680](#L2680) | $params = $ep\_functions->create\_filter\_query($event\_search\_params, $params); |
| [2681](#L2681) | } |
| [2682](#L2682) | } |
| [2683](#L2683) |  |
| [2684](#L2684) |  |
| [2685](#L2685) | // if(isset($\_POST['args'])) |
| [2686](#L2686) | // { |
| [2687](#L2687) | $atts = isset($\_POST['args']) ? json\_decode( stripslashes( $\_POST['args'] ), true ) : array(); //$\_POST['args']; |
| [2688](#L2688) |  |
| [2689](#L2689) | // shortcode limit |
| [2690](#L2690) | if( isset( $atts['show'] ) && ! empty( $atts['show'] ) ){ |
| [2691](#L2691) | $events\_data['limit'] = $atts['show']; |
| [2692](#L2692) | $params = array( |
| [2693](#L2693) | 'meta\_key'       => 'em\_start\_date\_time', |
| [2694](#L2694) | 'orderby'        => 'meta\_value\_num', |
| [2695](#L2695) | 'posts\_per\_page' => $events\_data['limit'], |
| [2696](#L2696) | 'meta\_query'     => array( 'relation' => 'AND' ), |
| [2697](#L2697) | //'order'          => 'DESC' |
| [2698](#L2698) | ); |
| [2699](#L2699) | } |
| [2700](#L2700) |  |
| [2701](#L2701) | // condition for hide upcoming events |
| [2702](#L2702) | $hide\_upcoming\_events = 0; |
| [2703](#L2703) | if( $ep\_functions->ep\_get\_global\_settings('shortcode\_hide\_upcoming\_events') == 1 ) { |
| [2704](#L2704) | $hide\_upcoming\_events = 1; |
| [2705](#L2705) | } |
| [2706](#L2706) | if( isset( $atts['upcoming'] ) && $atts['upcoming'] == 0 ) { |
| [2707](#L2707) | $hide\_upcoming\_events = 1; |
| [2708](#L2708) | } |
| [2709](#L2709) | if( $hide\_upcoming\_events == 1 ) { |
| [2710](#L2710) | array\_push( $params['meta\_query'], array( |
| [2711](#L2711) | 'key'     => 'em\_start\_date', |
| [2712](#L2712) | 'value'   => $ep\_functions->ep\_get\_current\_timestamp(), |
| [2713](#L2713) | 'compare' => '<=' |
| [2714](#L2714) | ) ); |
| [2715](#L2715) | } |
| [2716](#L2716) |  |
| [2717](#L2717) | // condition for hide past events |
| [2718](#L2718) | $hide\_past\_events = 0; |
| [2719](#L2719) | // from settings |
| [2720](#L2720) | if( $ep\_functions->ep\_get\_global\_settings( 'hide\_past\_events' ) == 1 ) { |
| [2721](#L2721) | $hide\_past\_events = 1; |
| [2722](#L2722) | } |
| [2723](#L2723) | // from shortcode |
| [2724](#L2724) | if( isset( $atts['upcoming'] ) && $atts['upcoming'] == 1 ) { |
| [2725](#L2725) | $hide\_past\_events = 1; |
| [2726](#L2726) | } |
| [2727](#L2727) | if( $hide\_past\_events == 1 ) { |
| [2728](#L2728) | array\_push( $params['meta\_query'], array( |
| [2729](#L2729) | 'key'     => 'em\_end\_date', |
| [2730](#L2730) | 'value'   => strtotime( 'today' ), |
| [2731](#L2731) | 'compare' => '>=' |
| [2732](#L2732) | ) ); |
| [2733](#L2733) | } |
| [2734](#L2734) |  |
| [2735](#L2735) | // shortcode event types |
| [2736](#L2736) | $type\_ids = array(); |
| [2737](#L2737) | if( isset( $atts['types'] ) && ! empty( $atts['types'] ) ) { |
| [2738](#L2738) | $type\_ids = explode( ',', $atts['types'] ); |
| [2739](#L2739) | } |
| [2740](#L2740) | if ( ! empty( $type\_ids ) ) { |
| [2741](#L2741) | array\_push( $params['meta\_query'], array( |
| [2742](#L2742) | 'key'     => 'em\_event\_type', |
| [2743](#L2743) | 'value'   => $type\_ids, |
| [2744](#L2744) | 'compare' => 'IN', |
| [2745](#L2745) | 'type'    =>'NUMERIC' |
| [2746](#L2746) | ) ); |
| [2747](#L2747) | } |
| [2748](#L2748) | // shortcode event venues |
| [2749](#L2749) | $venue\_ids = array(); |
| [2750](#L2750) | if( isset( $atts['sites'] ) && ! empty( $atts['sites'] ) ) { |
| [2751](#L2751) | $venue\_ids = explode( ',', $atts['sites'] ); |
| [2752](#L2752) | } |
| [2753](#L2753) | if ( ! empty( $venue\_ids ) ) { |
| [2754](#L2754) | $filter\_venues\_ids = array('relation'     => 'OR'); |
| [2755](#L2755) | foreach ($venue\_ids as $venue\_id){ |
| [2756](#L2756) | $filter\_venues\_ids[]= array( |
| [2757](#L2757) | 'key'     => 'em\_venue', |
| [2758](#L2758) | 'value'   =>  serialize( array($venue\_id) ), |
| [2759](#L2759) | 'compare' => '=' |
| [2760](#L2760) | ); |
| [2761](#L2761) | } |
| [2762](#L2762) | $params['meta\_query'][] = $filter\_venues\_ids; |
| [2763](#L2763) | } |
| [2764](#L2764) |  |
| [2765](#L2765) | $params = apply\_filters( 'ep\_events\_render\_attribute\_data', $params, $atts ); |
| [2766](#L2766) | // } |
| [2767](#L2767) |  |
| [2768](#L2768) | $events = $ep\_functions->get\_multiple\_events\_post\_data($params); |
| [2769](#L2769) |  |
| [2770](#L2770) | if(isset($events->posts)) |
| [2771](#L2771) | { |
| [2772](#L2772) | wp\_send\_json\_success($ep\_functions->get\_front\_calendar\_view\_event( $events->posts,$is\_admin )); |
| [2773](#L2773) | } |
| [2774](#L2774) | die; |
| [2775](#L2775) | } |
| [2776](#L2776) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php?format=txt)
* [Original Format](/export/3222464/eventprime-event-calendar-management/tags/4.0.5.3/includes/class-ep-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


