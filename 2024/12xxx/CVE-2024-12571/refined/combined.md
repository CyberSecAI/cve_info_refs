=== Content from www.wordfence.com_d5a27344_20250115_093430.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Store Locator <= 3.98.10 - Unauthenticated Local File Inclusion

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Store Locator <= 3.98.10 - Unauthenticated Local File Inclusion

9.8

**Improper Control of Filename for Include/Require Statement in PHP Program ('PHP Remote File Inclusion')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-12571](https://www.cve.org/CVERecord?id=CVE-2024-12571) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | December 19, 2024 |
| Last Updated | December 20, 2024 |
| Researcher | [Jay Nguyen](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/jay-nguyen) |

### Description

The Store Locator for WordPress with Google Maps – LotsOfLocales plugin for WordPress is vulnerable to Local File Inclusion in version 3.98.9 via the 'sl\_engine' parameter. This makes it possible for unauthenticated attackers to include and execute arbitrary files on the server, allowing the execution of any PHP code in those files. This can be used to bypass access controls, obtain sensitive data, or achieve code execution in cases where images and other “safe” file types can be uploaded and included.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/store-locator/trunk/sl-functions.php#L1919)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fstore-locator%2Fstore-locator-39810-unauthenticated-local-file-inclusion&t=Store%20Locator%20%3C%3D%203.98.10%20-%20Unauthenticated%20Local%20File%20Inclusion "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fstore-locator%2Fstore-locator-39810-unauthenticated-local-file-inclusion&text=Store%20Locator%20%3C%3D%203.98.10%20-%20Unauthenticated%20Local%20File%20Inclusion "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fstore-locator%2Fstore-locator-39810-unauthenticated-local-file-inclusion "LinkedIn")
Email

## Vulnerability Details for Store Locator for WordPress with Google Maps – LotsOfLocales

#### [Store Locator for WordPress with Google Maps – LotsOfLocales](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/store-locator)

| Software Type | Plugin |
| --- | --- |
| Software Slug | store-locator [(view on wordpress.org)](https://wordpress.org/plugins/store-locator) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * 3.98.9 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_2ed7b86f_20250115_093428.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fstore-locator%2Ftrunk%2Fsl-functions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/store-locator/trunk/sl-functions.php?rev=2880552 "Revision 2880552")
* Next Revision →
* [Blame](/browser/store-locator/trunk/sl-functions.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/store-locator/trunk/sl-functions.php)

---

# [source:](/browser?order=name "Go to repository root") [store-locator](/browser/store-locator?order=name "View store-locator")/[trunk](/browser/store-locator/trunk?order=name "View trunk")/[sl-functions.php](/browser/store-locator/trunk/sl-functions.php?order=name "View sl-functions.php")

View diff against:

View revision:

| [Last change](/changeset/3015648/store-locator/trunk/sl-functions.php "View differences") on this file was [3015648](/changeset/3015648/ "View changeset 3015648"), checked in by viadat, [13 months ago](/timeline?from=2023-12-30T00%3A14%3A56Z&precision=second "See timeline at 12/30/2023 12:14:56 AM") |
| --- |
| 3.98.9 - update |
| **File size:** 109.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if ( ! defined( 'ABSPATH' ) ) exit; // Exit if accessed directly |
| [3](#L3) |  |
| [4](#L4) | function sl\_move\_upload\_directories() { |
| [5](#L5) | global $sl\_uploads\_path, $sl\_path; |
| [6](#L6) |  |
| [7](#L7) | $sl\_uploads\_arr=wp\_upload\_dir(); |
| [8](#L8) | if (!is\_dir($sl\_uploads\_arr['baseurl'])) { |
| [9](#L9) | mkdir($sl\_uploads\_arr['baseurl'], 0755, true); |
| [10](#L10) | } |
| [11](#L11) | if (!is\_dir(SL\_UPLOADS\_PATH)) { |
| [12](#L12) | mkdir(SL\_UPLOADS\_PATH, 0755, true); |
| [13](#L13) | } |
| [14](#L14) | if (is\_dir(SL\_ADDONS\_PATH\_ORIGINAL) && !is\_dir(SL\_ADDONS\_PATH)) { |
| [15](#L15) | sl\_copyr(SL\_ADDONS\_PATH\_ORIGINAL, SL\_ADDONS\_PATH); |
| [16](#L16) | chmod(SL\_ADDONS\_PATH, 0755); |
| [17](#L17) | } |
| [18](#L18) | if (is\_dir(SL\_THEMES\_PATH\_ORIGINAL) && !is\_dir(SL\_THEMES\_PATH)) { |
| [19](#L19) | sl\_copyr(SL\_THEMES\_PATH\_ORIGINAL, SL\_THEMES\_PATH); |
| [20](#L20) | chmod(SL\_THEMES\_PATH, 0755); |
| [21](#L21) | } |
| [22](#L22) | if (is\_dir(SL\_LANGUAGES\_PATH\_ORIGINAL) && !is\_dir(SL\_LANGUAGES\_PATH)) { |
| [23](#L23) | sl\_copyr(SL\_LANGUAGES\_PATH\_ORIGINAL, SL\_LANGUAGES\_PATH); |
| [24](#L24) | chmod(SL\_LANGUAGES\_PATH, 0755); |
| [25](#L25) | } |
| [26](#L26) | if (is\_dir(SL\_IMAGES\_PATH\_ORIGINAL) && !is\_dir(SL\_IMAGES\_PATH)) { |
| [27](#L27) | sl\_copyr(SL\_IMAGES\_PATH\_ORIGINAL, SL\_IMAGES\_PATH); |
| [28](#L28) | chmod(SL\_IMAGES\_PATH, 0755); |
| [29](#L29) | } |
| [30](#L30) | if (!is\_dir(SL\_CUSTOM\_ICONS\_PATH)) { |
| [31](#L31) | mkdir(SL\_CUSTOM\_ICONS\_PATH, 0755, true); |
| [32](#L32) | } |
| [33](#L33) | if (!is\_dir(SL\_CUSTOM\_CSS\_PATH)) { |
| [34](#L34) | mkdir(SL\_CUSTOM\_CSS\_PATH, 0755, true); |
| [35](#L35) | } |
| [36](#L36) | if (!is\_dir(SL\_CACHE\_PATH)) { |
| [37](#L37) | mkdir(SL\_CACHE\_PATH, 0755, true); |
| [38](#L38) | } |
| [39](#L39) | sl\_ht(SL\_CACHE\_PATH, 'ht'); |
| [40](#L40) | sl\_ht(SL\_ADDONS\_PATH); |
| [41](#L41) | sl\_ht(SL\_UPLOADS\_PATH); |
| [42](#L42) | } |
| [43](#L43) | function sl\_ht($path, $type='index'){ |
| [44](#L44) | if(is\_dir($path) && !is\_file($path."/.htaccess") && !is\_file($path."/index.php")) { |
| [45](#L45) | if ($type == 'ht') { |
| [46](#L46) | $htaccess = ' |
| [47](#L47) | <FilesMatch "\.(php|gif|jpe?g|png|css|js|csv|xml|json)$"> |
| [48](#L48) | Allow from all |
| [49](#L49) | </FilesMatch> |
| [50](#L50) | order deny,allow |
| [51](#L51) | deny from all |
| [52](#L52) | allow from none |
| [53](#L53) | Options All -Indexes |
| [54](#L54) | '; #<- v3.98.5 - heredoc to single quotes |
| [55](#L55) | $filename = $path."/.htaccess"; |
| [56](#L56) | $file\_handle = @ fopen($filename, 'w+'); |
| [57](#L57) | @fwrite($file\_handle, $htaccess); |
| [58](#L58) | @fclose($file\_handle); |
| [59](#L59) | @chmod($file\_handle, 0644); |
| [60](#L60) | } elseif ($type == 'index') { |
| [61](#L61) | $index ='<?php /\*empty; prevents directory browsing\*/ ?>'; |
| [62](#L62) | $filename = $path."/index.php"; |
| [63](#L63) | $file\_handle = @ fopen($filename, 'w+'); |
| [64](#L64) | @fwrite($file\_handle, $index); |
| [65](#L65) | @fclose($file\_handle); |
| [66](#L66) | @chmod($file\_handle, 0644); |
| [67](#L67) | } |
| [68](#L68) | } elseif (is\_dir($path) && is\_file($path."/.htaccess") && $type == 'index') { |
| [69](#L69) | //switching from .htaccess to blank index.php (.htaccess causing issues on some hosts) |
| [70](#L70) | @unlink($path."/.htaccess"); |
| [71](#L71) | $index ='<?php /\*empty; prevents directory browsing\*/ ?>'; |
| [72](#L72) | $filename = $path."/index.php"; |
| [73](#L73) | $file\_handle = @ fopen($filename, 'w+'); |
| [74](#L74) | @fwrite($file\_handle, $index); |
| [75](#L75) | @fclose($file\_handle); |
| [76](#L76) | @chmod($file\_handle, 0644); |
| [77](#L77) | } |
| [78](#L78) | } |
| [79](#L79) | /\* -----------------\*/ |
| [80](#L80) | function sl\_parseToXML($htmlStr) |
| [81](#L81) | { |
| [82](#L82) | $xmlStr=str\_replace('<','&lt;',$htmlStr); |
| [83](#L83) | $xmlStr=str\_replace('>','&gt;',$xmlStr); |
| [84](#L84) | $xmlStr=str\_replace('"','&quot;',$xmlStr); |
| [85](#L85) | $xmlStr=str\_replace("'",'&#39;',$xmlStr); |
| [86](#L86) | $xmlStr=str\_replace("&",'&amp;',$xmlStr); |
| [87](#L87) | $xmlStr=str\_replace("," ,"&#44;" ,$xmlStr); |
| [88](#L88) | $xmlStr=sanitize\_text\_field($xmlStr); //v3.98.5 - 4/23/22 4:31p -- possibly redudant, but a WP requested update | ref: https://developer.wordpress.org/reference/functions/esc\_attr/ |
| [89](#L89) | $xmlStr=str\_replace(array("\r\n", "\n", "\r"), "||sl-nl||", $xmlStr); //v3.76 - done 8/7/15 11:10a |
| [90](#L90) | return $xmlStr; |
| [91](#L91) | } |
| [92](#L92) | if (!function\_exists('parseToXML')){ |
| [93](#L93) | //12/4/18 6:22pm - v3.98.3 |
| [94](#L94) | function parseToXML($htmlStr) { |
| [95](#L95) | return sl\_parseToXML($htmlStr); |
| [96](#L96) | } |
| [97](#L97) | } |
| [98](#L98) | /\*-----------------\*/ |
| [99](#L99) | function filter\_sl\_mdo($the\_arr) { |
| [100](#L100) | $input\_zone\_clause = ( !isset($the\_arr['input\_zone']) || !isset($GLOBALS['input\_zone\_type']) || ($the\_arr['input\_zone'] == $GLOBALS['input\_zone\_type']) ); |
| [101](#L101) |  |
| [102](#L102) | $output\_zone\_clause = ( !isset($the\_arr['output\_zone']) || !isset($GLOBALS['output\_zone\_type']) || (!is\_array($the\_arr['output\_zone']) && $the\_arr['output\_zone'] == $GLOBALS['output\_zone\_type']) ||  (is\_array($the\_arr['output\_zone']) && in\_array($GLOBALS['output\_zone\_type'], $the\_arr['output\_zone']) ) ); |
| [103](#L103) |  |
| [104](#L104) | return ($input\_zone\_clause && $output\_zone\_clause); |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | function sl\_md\_initialize(&$sl\_vars) { |
| [108](#L108) | //global $sl\_vars; |
| [109](#L109) | include(SL\_INCLUDES\_PATH."/mapdesigner-options.php"); |
| [110](#L110) |  |
| [111](#L111) | foreach ($sl\_mdo as $value) { |
| [112](#L112) | //if (isset($value['input\_template'])) { unset($value['input\_template']); } |
| [113](#L113) | //var\_dump($value['field\_name']); |
| [114](#L114) |  |
| [115](#L115) | if (isset($value['field\_name']) && !is\_array($value['field\_name']) ) { |
| [116](#L116) | $value['default'] = (!isset($value['default']))? "" : $value['default']; |
| [117](#L117) |  |
| [118](#L118) | $default\_not\_set = !isset($sl\_vars[$value['field\_name']]); |
| [119](#L119) | $default\_set\_but\_value\_set\_to\_blank = (isset($sl\_vars[$value['field\_name']]) && strlen(trim($sl\_vars[$value['field\_name']])) == 0); |
| [120](#L120) |  |
| [121](#L121) | if ( ($default\_not\_set || $default\_set\_but\_value\_set\_to\_blank) ) { |
| [122](#L122) | //If default value isn't set yet in $sl\_vars, and field\_name definition isn't an array |
| [123](#L123) | $sl\_vars[$value['field\_name']] = $value['default']; |
| [124](#L124) | } |
| [125](#L125) |  |
| [126](#L126) | $varname = "sl\_".$value['field\_name'];  //e.g. "$varname = sl\_icon" |
| [127](#L127) | global ${$varname}; |
| [128](#L128) | $$varname = $sl\_vars[$value['field\_name']]; //e.g "$sl\_icon = $sl\_vars['sl\_icon']" |
| [129](#L129) |  |
| [130](#L130) | } elseif (isset($value['field\_name']) && is\_array($value['field\_name']) ) { |
| [131](#L131) |  |
| [132](#L132) | $value['default'] = (!isset($value['default']))? array\_fill(0, count($value['field\_name']), "") : $value['default']; |
| [133](#L133) |  |
| [134](#L134) | //If default value isn't set yet in $sl\_vars, and field\_name definition is an array of fields |
| [135](#L135) | $ctr = 0; |
| [136](#L136) | foreach ($value['default'] as $the\_default) { |
| [137](#L137) |  |
| [138](#L138) | $the\_field = $value['field\_name'][$ctr]; |
| [139](#L139) | $d\_n\_s = !isset($sl\_vars[$the\_field]); |
| [140](#L140) | $d\_s\_b\_v\_s\_t\_b = (isset($sl\_vars[$the\_field]) && strlen(trim($sl\_vars[$the\_field])) == 0); |
| [141](#L141) |  |
| [142](#L142) | if ( ($d\_n\_s || $d\_s\_b\_v\_s\_t\_b) ) { |
| [143](#L143) | $sl\_vars[$the\_field] = $the\_default; |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | $varname = "sl\_".$the\_field;  //e.g. "$varname = sl\_icon" |
| [147](#L147) | global ${$varname}; |
| [148](#L148) | $$varname = $sl\_vars[$the\_field]; |
| [149](#L149) | $ctr++; |
| [150](#L150) | } |
| [151](#L151) |  |
| [152](#L152) | } |
| [153](#L153) | } |
| [154](#L154) | //sl\_data('sl\_vars', 'add', $sl\_vars); |
| [155](#L155) | } |
| [156](#L156) |  |
| [157](#L157) | function sl\_md\_save($data) { |
| [158](#L158) | global $sl\_vars; |
| [159](#L159) |  |
| [160](#L160) | //MapDesigner header inputs & Geolocate true/false (based on Auto-locate value) |
| [161](#L161) | $sl\_vars['map\_language']=sanitize\_text\_field($\_POST['sl\_map\_language']); |
| [162](#L162) |  |
| [163](#L163) | $sl\_map\_region\_arr=explode(":", $\_POST['map\_region']); |
| [164](#L164) | $sl\_vars['google\_map\_country']=sanitize\_text\_field($sl\_map\_region\_arr[0]); |
| [165](#L165) | $sl\_vars['google\_map\_domain']=sanitize\_text\_field($sl\_map\_region\_arr[1]); |
| [166](#L166) | $sl\_vars['map\_region']=sanitize\_text\_field($sl\_map\_region\_arr[2]); |
| [167](#L167) | $sl\_vars['api\_key']=sanitize\_text\_field($\_POST['sl\_api\_key']); |
| [168](#L168) |  |
| [169](#L169) | $sl\_vars['sensor']=(empty($\_POST['sl\_geolocate']))? "false" : "true"; |
| [170](#L170) | //end |
| [171](#L171) |  |
| [172](#L172) | foreach ($data as $value) { |
| [173](#L173) |  |
| [174](#L174) | if (!empty($value['field\_name'])) { |
| [175](#L175) | $fname = $value['field\_name']; |
| [176](#L176) |  |
| [177](#L177) | if (!empty($value['field\_type']) && $value['field\_type'] == "checkbox") { |
| [178](#L178) | //checkbox submissions need to save unchecked (empty) $\_POST values as zero |
| [179](#L179) | if (is\_array($fname)) { |
| [180](#L180) | foreach ($fname as $the\_field) { |
| [181](#L181) | $sl\_vars[$the\_field] = (empty($\_POST["sl\_".$the\_field]))? 0 : sanitize\_text\_field($\_POST["sl\_".$the\_field]) ; |
| [182](#L182) | } |
| [183](#L183) | } else { |
| [184](#L184) | $sl\_vars[$fname] = (empty($\_POST["sl\_".$fname]))? 0 : sanitize\_text\_field($\_POST["sl\_".$fname]) ; |
| [185](#L185) | } |
| [186](#L186) | } else { |
| [187](#L187) | if (is\_array($fname)) { |
| [188](#L188) | $fctr = 0; |
| [189](#L189) | foreach ($fname as $the\_field) { |
| [190](#L190) | $post\_data = (isset($\_POST["sl\_".$the\_field]))? sanitize\_text\_field($\_POST["sl\_".$the\_field]) : sanitize\_text\_field($\_POST[$the\_field]) ; |
| [191](#L191) | $post\_data = (!empty($value['stripslashes'][$fctr]) && $value['stripslashes'][$fctr] == 1)? stripslashes($post\_data) : $post\_data; |
| [192](#L192) | $post\_data = (!empty($value['numbers\_only'][$fctr]) && $value['numbers\_only'][$fctr] == 1)? preg\_replace("@[^0-9]@", "", $post\_data) : $post\_data; |
| [193](#L193) | $sl\_vars[$the\_field] = sanitize\_text\_field($post\_data); |
| [194](#L194) | $fctr++; |
| [195](#L195) | } |
| [196](#L196) | } else { |
| [197](#L197) | $post\_data = (isset($\_POST["sl\_".$fname]))? sanitize\_text\_field($\_POST["sl\_".$fname]) : sanitize\_text\_field($\_POST[$fname]) ; |
| [198](#L198) | $post\_data = (!empty($value['stripslashes']) && $value['stripslashes'] == 1)? stripslashes($post\_data) : $post\_data; |
| [199](#L199) | $post\_data = (!empty($value['numbers\_only']) && $value['numbers\_only'] == 1)? preg\_replace("@[^0-9]@", "", $post\_data) : $post\_data; |
| [200](#L200) | $sl\_vars[$fname] = sanitize\_text\_field($post\_data); |
| [201](#L201) | } |
| [202](#L202) | } |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | sl\_data('sl\_vars', 'update', $sl\_vars); |
| [208](#L208) |  |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) | function sl\_md\_display($data, $input\_zone, $template, $additional\_classes = "") { |
| [212](#L212) | global $sl\_vars; |
| [213](#L213) |  |
| [214](#L214) | print "<table class='mapdesigner\_section {$additional\_classes}'>"; |
| [215](#L215) |  |
| [216](#L216) | $GLOBALS['input\_zone\_type'] = $input\_zone; |
| [217](#L217) | $filtered\_data = array\_filter($data, "filter\_sl\_mdo"); |
| [218](#L218) | unset($GLOBALS['input\_zone\_type']); |
| [219](#L219) |  |
| [220](#L220) | $labels\_ctr = 0; |
| [221](#L221) | foreach ($filtered\_data as $key => $value) { |
| [222](#L222) |  |
| [223](#L223) | //if ($value['input\_zone'] == $input\_zone) { |
| [224](#L224) |  |
| [225](#L225) | if ($template == 1) { |
| [226](#L226) | //foreach ($data as $key => $value) { |
| [227](#L227) | $the\_row\_id = (!empty($value["row\_id"]))? " id = '$value[row\_id]' " : ""; |
| [228](#L228) | $hide\_row = (!empty($value['hide\_row']) && $value['hide\_row'] == true)? "style='display:none' " : "" ; |
| [229](#L229) | $colspan = (!empty($value['colspan']) && $value['colspan'] > 1)? "colspan = '$value[colspan]'" : "" ; |
| [230](#L230) |  |
| [231](#L231) | print "<tr {$the\_row\_id} {$hide\_row}> |
| [232](#L232) | <td {$colspan}>".$value['label']; |
| [233](#L233) | if (!empty($value['more\_info\_label'])) { |
| [234](#L234) | print "&nbsp;(<a href='#$value[more\_info\_label]' rel='sl\_pop'>?</a>)&nbsp;"; |
| [235](#L235) | } |
| [236](#L236) | print "</td>"; |
| [237](#L237) | if (empty($value['colspan']) || $value['colspan'] < 2) { |
| [238](#L238) | if (!empty($value['field\_type']) && $value['field\_type'] == 'checkbox') { |
| [239](#L239) | if (!is\_array($value['field\_name'])){ |
| [240](#L240) | //need to add checked='checked' if value is checked |
| [241](#L241) | $value['input\_template'] = (isset($sl\_vars[$value['field\_name']]) && $sl\_vars[$value['field\_name']] == 1)? preg\_replace("@>@", " checked='checked'>", $value['input\_template']) : $value['input\_template'] ; |
| [242](#L242) | } /\*else { |
| [243](#L243) | foreach ($value['field\_name'] as $fname) { |
| [244](#L244) | $value[''] |
| [245](#L245) | } |
| [246](#L246) | }\*/ |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | print "<td>".$value['input\_template']; |
| [250](#L250) | if (!empty($value['more\_info'])) { |
| [251](#L251) | print "<div style='display:none;' id='$value[more\_info\_label]'>"; |
| [252](#L252) | print $value['more\_info']; |
| [253](#L253) | print "</div>"; |
| [254](#L254) | } |
| [255](#L255) | print "</td>"; |
| [256](#L256) | } |
| [257](#L257) | print "</tr>"; |
| [258](#L258) | //} |
| [259](#L259) | } elseif ($template == 2) { |
| [260](#L260) |  |
| [261](#L261) | //foreach ($data as $key => $value) { |
| [262](#L262) | if ($labels\_ctr % 3 == 0) { |
| [263](#L263) | $the\_row\_id = (!empty($value["row\_id"]))? " id = '$value[row\_id]' " : ""; |
| [264](#L264) | print "<tr {$the\_row\_id}>"; |
| [265](#L265) | } |
| [266](#L266) | $the\_more\_info\_label = (!empty($value['more\_info\_label']))? "&nbsp;(<a href='#$value[more\_info\_label]' rel='sl\_pop'>?</a>)&nbsp;" : "" ; |
| [267](#L267) |  |
| [268](#L268) | print "<td>".$value['input\_template']."<br><span style='font-size:80%'>".$value['label']."{$the\_more\_info\_label}</span>"; |
| [269](#L269) |  |
| [270](#L270) | if (!empty($value['more\_info'])) { |
| [271](#L271) | print "<div style='display:none;' id='$value[more\_info\_label]'>"; |
| [272](#L272) | print $value['more\_info']; |
| [273](#L273) | print "</div>"; |
| [274](#L274) | } |
| [275](#L275) | print "</td>"; |
| [276](#L276) | if (($labels\_ctr+1) % 3 == 0) { |
| [277](#L277) | print "</tr>"; |
| [278](#L278) | } |
| [279](#L279) | $labels\_ctr++; |
| [280](#L280) | //} |
| [281](#L281) | } |
| [282](#L282) |  |
| [283](#L283) | //} |
| [284](#L284) |  |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | print "</table>"; |
| [288](#L288) | } |
| [289](#L289) | /\*-----------------\*/ |
| [290](#L290) | function sl\_initialize\_variables() { |
| [291](#L291) |  |
| [292](#L292) | global $sl\_height, $sl\_width, $sl\_width\_units, $sl\_height\_units, $sl\_radii; |
| [293](#L293) | global $sl\_icon, $sl\_icon2, $sl\_google\_map\_domain, $sl\_google\_map\_country, $sl\_theme, $sl\_base, $sl\_uploads\_base, $sl\_location\_table\_view; |
| [294](#L294) | global $sl\_search\_label, $sl\_zoom\_level, $sl\_use\_city\_search, $sl\_use\_name\_search, $sl\_name; |
| [295](#L295) | global $sl\_radius\_label, $sl\_website\_label, $sl\_directions\_label, $sl\_num\_initial\_displayed, $sl\_load\_locations\_default; |
| [296](#L296) | global $sl\_distance\_unit, $sl\_map\_overview\_control, $sl\_admin\_locations\_per\_page, $sl\_instruction\_message; |
| [297](#L297) | global $sl\_map\_character\_encoding, $sl\_start, $sl\_map\_language, $sl\_map\_region, $sl\_sensor, $sl\_geolocate; |
| [298](#L298) | global $sl\_map\_type, $sl\_remove\_credits, $sl\_api\_key, $sl\_location\_not\_found\_message, $sl\_no\_results\_found\_message; |
| [299](#L299) | global $sl\_load\_results\_with\_locations\_default, $sl\_vars, $sl\_city\_dropdown\_label, $sl\_scripts\_load, $sl\_scripts\_load\_home, $sl\_scripts\_load\_archives\_404; |
| [300](#L300) | global $sl\_hours\_label, $sl\_phone\_label, $sl\_fax\_label, $sl\_email\_label; |
| [301](#L301) |  |
| [302](#L302) | $sl\_vars=sl\_data('sl\_vars'); //important, otherwise may reset vars to default (?) - 11/13/13 |
| [303](#L303) | //$sl\_google\_map\_domain=sl\_data('sl\_google\_map\_domain'); |
| [304](#L304) | if (empty($sl\_vars)){ |
| [305](#L305) | //transition from individual variables to single array of variables |
| [306](#L306) | $sl\_vars['height']=sl\_data('sl\_map\_height'); $sl\_vars['width']=sl\_data('sl\_map\_width'); $sl\_vars['width\_units']=sl\_data('sl\_map\_width\_units'); $sl\_vars['height\_units']=sl\_data('sl\_map\_height\_units'); $sl\_vars['radii']=sl\_data('sl\_map\_radii'); $sl\_vars['icon']=sl\_data('sl\_map\_home\_icon'); $sl\_vars['icon2']=sl\_data('sl\_map\_end\_icon2'); $sl\_vars['google\_map\_domain']=sl\_data('sl\_google\_map\_domain'); $sl\_vars['google\_map\_country']=sl\_data('sl\_google\_map\_country'); $sl\_vars['theme']=sl\_data('sl\_map\_theme'); $sl\_vars['location\_table\_view']=sl\_data('sl\_location\_table\_view'); $sl\_vars['search\_label']=sl\_data('sl\_search\_label'); $sl\_vars['zoom\_level']=sl\_data('sl\_zoom\_level'); $sl\_vars['use\_city\_search']=sl\_data('sl\_use\_city\_search'); $sl\_vars['use\_name\_search']=sl\_data('sl\_use\_name\_search'); $sl\_vars['name']=sl\_data('sl\_name'); $sl\_vars['radius\_label']=sl\_data('sl\_radius\_label'); $sl\_vars['website\_label']=sl\_data('sl\_website\_label'); $sl\_vars['directions\_label']=sl\_data('sl\_directions\_label'); $sl\_vars['num\_initial\_displayed']=sl\_data('sl\_num\_initial\_displayed'); $sl\_vars['load\_locations\_default']=sl\_data('sl\_load\_locations\_default'); $sl\_vars['distance\_unit']=sl\_data('sl\_distance\_unit'); $sl\_vars['map\_overview\_control']=sl\_data('sl\_map\_overview\_control'); $sl\_vars['admin\_locations\_per\_page']=sl\_data('sl\_admin\_locations\_per\_page'); $sl\_vars['instruction\_message']=sl\_data('sl\_instruction\_message'); $sl\_vars['map\_character\_encoding']=sl\_data('sl\_map\_character\_encoding'); $sl\_vars['start']=sl\_data('sl\_start'); $sl\_vars['map\_language']=sl\_data('sl\_map\_language'); $sl\_vars['map\_region']=sl\_data('sl\_map\_region'); $sl\_vars['sensor']=sl\_data('sl\_sensor'); $sl\_vars['geolocate']=sl\_data('sl\_geolocate'); $sl\_vars['map\_type']=sl\_data('sl\_map\_type'); $sl\_vars['remove\_credits']=sl\_data('sl\_remove\_credits'); $sl\_vars['api\_key']=sl\_data('store\_locator\_api\_key'); $sl\_vars['load\_results\_with\_locations\_default']=sl\_data('sl\_load\_results\_with\_locations\_default'); $sl\_vars['city\_dropdown\_label']=sl\_data('sl\_city\_dropdown\_label'); |
| [307](#L307) | } |
| [308](#L308) |  |
| [309](#L309) | ### From MapDesigner Options |
| [310](#L310) | sl\_md\_initialize($sl\_vars); |
| [311](#L311) |  |
| [312](#L312) | ### Dependent Variables |
| [313](#L313) | if (strlen(trim($sl\_vars['sensor'])) == 0) {    $sl\_vars['sensor'] = ($sl\_vars['geolocate'] == '1')? "true" : "false";  } |
| [314](#L314) | $sl\_sensor=$sl\_vars['sensor']; |
| [315](#L315) |  |
| [316](#L316) | ### MapDesigner header row inputs |
| [317](#L317) | if ($sl\_vars['api\_key'] === NULL) {     $sl\_vars['api\_key']=""; } |
| [318](#L318) | $sl\_api\_key=$sl\_vars['api\_key']; |
| [319](#L319) |  |
| [320](#L320) | if (strlen(trim($sl\_vars['google\_map\_country'])) == 0) {        $sl\_vars['google\_map\_country']="United States";} |
| [321](#L321) | $sl\_google\_map\_country=$sl\_vars['google\_map\_country']; |
| [322](#L322) |  |
| [323](#L323) | if (strlen(trim($sl\_vars['google\_map\_domain'])) == 0) { $sl\_vars['google\_map\_domain']="maps.google.com";} |
| [324](#L324) | $sl\_google\_map\_domain=$sl\_vars['google\_map\_domain']; |
| [325](#L325) |  |
| [326](#L326) | if ($sl\_vars['map\_region'] === NULL) {  $sl\_vars['map\_region']="";      } |
| [327](#L327) | $sl\_map\_region=$sl\_vars['map\_region']; |
| [328](#L328) |  |
| [329](#L329) | if (strlen(trim($sl\_vars['map\_language'])) == 0) {      $sl\_vars['map\_language']="en";  } |
| [330](#L330) | $sl\_map\_language=$sl\_vars['map\_language']; |
| [331](#L331) |  |
| [332](#L332) | if ($sl\_vars['map\_character\_encoding'] === NULL) {      $sl\_vars['map\_character\_encoding']="";          } |
| [333](#L333) | $sl\_map\_character\_encoding=$sl\_vars['map\_character\_encoding']; |
| [334](#L334) |  |
| [335](#L335) | ### Meta |
| [336](#L336) | if (strlen(trim($sl\_vars['start'])) == 0) {     $sl\_vars['start']=date("Y-m-d H:i:s");  } |
| [337](#L337) | $sl\_start=$sl\_vars['start']; |
| [338](#L338) |  |
| [339](#L339) | if (strlen(trim($sl\_vars['name'])) == 0) {      $sl\_vars['name']="LotsOfLocales";       } |
| [340](#L340) | $sl\_name=$sl\_vars['name']; |
| [341](#L341) |  |
| [342](#L342) | ### Location Management Page View Control |
| [343](#L343) | if (strlen(trim($sl\_vars['admin\_locations\_per\_page'])) == 0) {  $sl\_vars['admin\_locations\_per\_page']="100";     } |
| [344](#L344) | $sl\_admin\_locations\_per\_page=$sl\_vars['admin\_locations\_per\_page']; |
| [345](#L345) |  |
| [346](#L346) | if (strlen(trim($sl\_vars['location\_table\_view'])) == 0) {       $sl\_vars['location\_table\_view']="Normal";       } |
| [347](#L347) | $sl\_location\_table\_view=$sl\_vars['location\_table\_view']; |
| [348](#L348) |  |
| [349](#L349) | ### Maps V2 -> V3 Transition |
| [350](#L350) | if (strlen(trim($sl\_vars['map\_type'])) == 0) {  $sl\_vars['map\_type']="google.maps.MapTypeId.ROADMAP";} |
| [351](#L351) | elseif ($sl\_vars['map\_type']=="G\_NORMAL\_MAP"){  $sl\_vars['map\_type']='google.maps.MapTypeId.ROADMAP';} |
| [352](#L352) | elseif ($sl\_vars['map\_type']=="G\_SATELLITE\_MAP"){       $sl\_vars['map\_type']='google.maps.MapTypeId.SATELLITE';} |
| [353](#L353) | elseif ($sl\_vars['map\_type']=="G\_HYBRID\_MAP"){  $sl\_vars['map\_type']='google.maps.MapTypeId.HYBRID';} |
| [354](#L354) | elseif ($sl\_vars['map\_type']=="G\_PHYSICAL\_MAP"){        $sl\_vars['map\_type']='google.maps.MapTypeId.TERRAIN';} |
| [355](#L355) | $sl\_map\_type=$sl\_vars['map\_type']; |
| [356](#L356) |  |
| [357](#L357) | /\*if (strlen(trim($sl\_vars['use\_name\_search'])) == 0) { $sl\_vars['use\_name\_search']="0";        } |
| [358](#L358) | $sl\_use\_name\_search=$sl\_vars['use\_name\_search'];\*/ |
| [359](#L359) |  |
| [360](#L360) | sl\_data('sl\_vars', 'add', $sl\_vars); |
| [361](#L361) | } |
| [362](#L362) | /\*--------------------------\*/ |
| [363](#L363) | function sl\_choose\_units($unit, $input\_name) { |
| [364](#L364) | $unit\_arr[]="%";$unit\_arr[]="px";$unit\_arr[]="em";$unit\_arr[]="pt"; |
| [365](#L365) | $select\_field="<select name='$input\_name'>"; |
| [366](#L366) |  |
| [367](#L367) | //global $height\_units, $width\_units; |
| [368](#L368) |  |
| [369](#L369) | foreach ($unit\_arr as $value) { |
| [370](#L370) | $selected=($value=="$unit")? " selected='selected' " : "" ; |
| [371](#L371) | if (!($input\_name=="height\_units" && $value=="%")) { //v3.90.1 - should be $value=="%", not $unit=="%" -  it's causing error if % selected |
| [372](#L372) | $select\_field.="\n<option value='$value' $selected>$value</option>"; |
| [373](#L373) | } |
| [374](#L374) | } |
| [375](#L375) | $select\_field.="</select>"; |
| [376](#L376) | return $select\_field; |
| [377](#L377) | } |
| [378](#L378) | /\*----------------------------\*/ |
| [379](#L379) | function sl\_install\_tables() { |
| [380](#L380) | global $wpdb, $sl\_db\_version, $sl\_path, $sl\_uploads\_path, $sl\_hook; |
| [381](#L381) |  |
| [382](#L382) | if (!defined("SL\_TABLE") || !defined("SL\_TAG\_TABLE") || !defined("SL\_SETTING\_TABLE")){ |
| [383](#L383) | //add\_option("sl\_db\_prefix", $wpdb->prefix); $sl\_db\_prefix = get\_option('sl\_db\_prefix'); |
| [384](#L384) | $sl\_db\_prefix = $wpdb->prefix; //better this way, in case prefix changes vs storing option - 1/29/15 |
| [385](#L385) | } |
| [386](#L386) | if (!defined("SL\_TABLE")){ define("SL\_TABLE", $sl\_db\_prefix."store\_locator");} |
| [387](#L387) | if (!defined("SL\_TAG\_TABLE")){ define("SL\_TAG\_TABLE", $sl\_db\_prefix."sl\_tag"); } |
| [388](#L388) | if (!defined("SL\_SETTING\_TABLE")){ define("SL\_SETTING\_TABLE", $sl\_db\_prefix."sl\_setting"); } |
| [389](#L389) |  |
| [390](#L390) | $table\_name = SL\_TABLE; |
| [391](#L391) | $sql = "CREATE TABLE " . $table\_name . " ( |
| [392](#L392) | sl\_id mediumint(8) unsigned NOT NULL auto\_increment, |
| [393](#L393) | sl\_store varchar(255) NULL, |
| [394](#L394) | sl\_address varchar(255) NULL, |
| [395](#L395) | sl\_address2 varchar(255) NULL, |
| [396](#L396) | sl\_city varchar(255) NULL, |
| [397](#L397) | sl\_state varchar(255) NULL, |
| [398](#L398) | sl\_country varchar(255) NULL, |
| [399](#L399) | sl\_zip varchar(255) NULL, |
| [400](#L400) | sl\_latitude varchar(255) NULL, |
| [401](#L401) | sl\_longitude varchar(255) NULL, |
| [402](#L402) | sl\_tags mediumtext NULL, |
| [403](#L403) | sl\_description mediumtext NULL, |
| [404](#L404) | sl\_url varchar(255) NULL, |
| [405](#L405) | sl\_hours varchar(255) NULL, |
| [406](#L406) | sl\_phone varchar(255) NULL, |
| [407](#L407) | sl\_fax varchar(255) NULL, |
| [408](#L408) | sl\_email varchar(255) NULL, |
| [409](#L409) | sl\_image varchar(255) NULL, |
| [410](#L410) | sl\_private varchar(1) NULL, |
| [411](#L411) | sl\_neat\_title varchar(255) NULL, |
| [412](#L412) | PRIMARY KEY  (sl\_id) |
| [413](#L413) | ) ENGINE=innoDB  DEFAULT CHARACTER SET=utf8  DEFAULT COLLATE=utf8\_unicode\_ci;"; |
| [414](#L414) |  |
| [415](#L415) | $table\_name\_2 = SL\_TAG\_TABLE; |
| [416](#L416) | $sql .= "CREATE TABLE " . $table\_name\_2 . " ( |
| [417](#L417) | sl\_tag\_id bigint(20) unsigned NOT NULL auto\_increment, |
| [418](#L418) | sl\_tag\_name varchar(255) NULL, |
| [419](#L419) | sl\_tag\_slug varchar(255) NULL, |
| [420](#L420) | sl\_id mediumint(8) NULL, |
| [421](#L421) | PRIMARY KEY  (sl\_tag\_id) |
| [422](#L422) | ) ENGINE=innoDB  DEFAULT CHARACTER SET=utf8  DEFAULT COLLATE=utf8\_unicode\_ci;"; |
| [423](#L423) |  |
| [424](#L424) | $table\_name\_3 = SL\_SETTING\_TABLE; |
| [425](#L425) | $sql .= "CREATE TABLE " . $table\_name\_3 . " ( |
| [426](#L426) | sl\_setting\_id bigint(20) unsigned NOT NULL auto\_increment, |
| [427](#L427) | sl\_setting\_name varchar(255) NULL, |
| [428](#L428) | sl\_setting\_value longtext NULL, |
| [429](#L429) | PRIMARY KEY  (sl\_setting\_id) |
| [430](#L430) | ) ENGINE=innoDB  DEFAULT CHARACTER SET=utf8  DEFAULT COLLATE=utf8\_unicode\_ci;"; |
| [431](#L431) | //$sql .= "INSERT INTO " . $table\_name\_3 . " (sl\_setting\_name, sl\_setting\_value) VALUES ('sl\_db\_prefix', '" . $wpdb->prefix . "');"; |
| [432](#L432) |  |
| [433](#L433) | if($wpdb->get\_var($wpdb->prepare("SHOW TABLES LIKE %s", $table\_name)) != $table\_name || $wpdb->get\_var($wpdb->prepare("SHOW TABLES LIKE %s", $table\_name\_2)) != $table\_name\_2 || $wpdb->get\_var($wpdb->prepare("SHOW TABLES LIKE %s", $table\_name\_3)) != $table\_name\_3) { |
| [434](#L434) | require\_once(ABSPATH . 'wp-admin/includes/upgrade.php'); |
| [435](#L435) | dbDelta($sql); |
| [436](#L436) | sl\_data("sl\_db\_version", 'add', $sl\_db\_version); |
| [437](#L437) | } |
| [438](#L438) |  |
| [439](#L439) | $installed\_ver = sl\_data("sl\_db\_version"); |
| [440](#L440) | if( $installed\_ver != $sl\_db\_version ) { |
| [441](#L441) | require\_once(ABSPATH . 'wp-admin/includes/upgrade.php'); |
| [442](#L442) | dbDelta($sql); |
| [443](#L443) | sl\_data("sl\_db\_version", 'update', $sl\_db\_version); |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | if (sl\_data("sl\_db\_prefix")===""){ |
| [447](#L447) | sl\_data('sl\_db\_prefix', 'update', $sl\_db\_prefix); |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | sl\_move\_upload\_directories(); |
| [451](#L451) | } |
| [452](#L452) | /\*-------------------------------\*/ |
| [453](#L453) | function is\_on\_sl\_page() { |
| [454](#L454) | global $sl\_dir, $sl\_base, $sl\_uploads\_base, $sl\_path, $sl\_uploads\_path, $wpdb, $pagename, $sl\_map\_language, $post, $sl\_vars; |
| [455](#L455) |  |
| [456](#L456) | if (!is\_admin()) { //v3.88 - moved "!is\_admin()" clause into function, instead of wrapping around action hook |
| [457](#L457) | $on\_sl\_page=""; $sl\_code\_is\_used\_in\_posts=""; $post\_ids\_array=""; $the\_p = ""; $the\_page\_id = ""; |
| [458](#L458) | $post\_ids\_array=array(); |
| [459](#L459) | if (empty($sl\_vars['scripts\_load']) || $sl\_vars['scripts\_load'] != 'all') { |
| [460](#L460) | //Check if currently on page with shortcode |
| [461](#L461) | if (!empty($\_GET['p'])){ $the\_p = sanitize\_text\_field($\_GET['p']); } if (!empty($\_GET['page\_id'])){ $the\_page\_id = sanitize\_text\_field($\_GET['page\_id']); } |
| [462](#L462) | $query = $wpdb->prepare("SELECT post\_name, post\_content FROM ".SL\_DB\_PREFIX."posts WHERE LOWER(post\_content) LIKE '%%[store-locator%%' AND (post\_name=%s OR ID=%d OR ID=%d)", $pagename, $the\_p, $the\_page\_id); |
| [463](#L463) | $on\_sl\_page=$wpdb->get\_results($query, ARRAY\_A); |
| [464](#L464) | //Checking if code used in posts |
| [465](#L465) | $sl\_code\_is\_used\_in\_posts=$wpdb->get\_results("SELECT post\_name, ID FROM ".SL\_DB\_PREFIX."posts WHERE LOWER(post\_content) LIKE '%[store-locator%' AND post\_type='post'", ARRAY\_A); |
| [466](#L466) | //If shortcode used in posts, put post IDs into array of numbers |
| [467](#L467) | if ($sl\_code\_is\_used\_in\_posts) { |
| [468](#L468) | $sl\_post\_ids=$sl\_code\_is\_used\_in\_posts; |
| [469](#L469) | foreach ($sl\_post\_ids as $val) { $post\_ids\_array[]=$val['ID'];} |
| [470](#L470) | } else { |
| [471](#L471) | $post\_ids\_array=array(pow(10,15)); //post number that'll never be reached |
| [472](#L472) | } |
| [473](#L473) | //print\_r($post\_ids\_array); |
| [474](#L474) | } |
| [475](#L475) |  |
| [476](#L476) | //If loading on all pages is selected (via MapDesigner), on page with store locator shortcode, on an archive, search, or 404 page while shortcode has been used in a post, on the front page, or a specific post with shortcode, is a custom post type of some kind, or is a using a page template, display code, otherwise, don't |
| [477](#L477) | $show\_on\_all\_pages = ( !empty($sl\_vars['scripts\_load']) && $sl\_vars['scripts\_load'] == 'all' ); |
| [478](#L478) | $show\_on\_front\_page = ( is\_front\_page() && (!isset($sl\_vars['scripts\_load\_home']) || $sl\_vars['scripts\_load\_home']==1) ); |
| [479](#L479) | $show\_on\_archive\_404\_pages = ( (is\_archive() || is\_404()) && $sl\_code\_is\_used\_in\_posts && (!isset($sl\_vars['scripts\_load\_archives\_404']) || $sl\_vars['scripts\_load\_archives\_404']==1) ); |
| [480](#L480) | $show\_on\_custom\_post\_types = ( is\_singular() && !is\_singular(array('page', 'attachment', 'post')) && !is\_front\_page() && !(is\_archive() || is\_404()) ); |
| [481](#L481) | $show\_on\_page\_templates = ( is\_page\_template() && !is\_front\_page() && !(is\_archive() || is\_404()) ); |
| [482](#L482) | $on\_sl\_post = is\_single($post\_ids\_array); |
| [483](#L483) | $sl\_scripts\_function\_exists = ( function\_exists('show\_sl\_scripts') && !is\_front\_page() && !(is\_archive() || is\_404()) ); //empty sl\_scripts() function can be created to force loading of scripts |
| [484](#L484) |  |
| [485](#L485) | if ($show\_on\_all\_pages || $on\_sl\_page || is\_search() || $show\_on\_archive\_404\_pages || $show\_on\_front\_page || $on\_sl\_post || $show\_on\_custom\_post\_types || $sl\_scripts\_function\_exists || $show\_on\_page\_templates) { |
| [486](#L486) | $GLOBALS['is\_on\_sl\_page'] = 1; |
| [487](#L487) | } else { |
| [488](#L488) | $GLOBALS['is\_on\_sl\_page'] = 0; |
| [489](#L489) | } |
| [490](#L490) | } |
| [491](#L491) | } |
| [492](#L492) | add\_action('wp', 'is\_on\_sl\_page'); |
| [493](#L493) |  |
| [494](#L494) | function sl\_head\_scripts() { |
| [495](#L495) | global $sl\_dir, $sl\_base, $sl\_uploads\_base, $sl\_path, $sl\_uploads\_path, $wpdb, $pagename, $sl\_map\_language, $post, $sl\_vars; |
| [496](#L496) |  |
| [497](#L497) | print "\n<!-- ========= WordPress Store Locator (v".SL\_VERSION.") | http://" . SL\_HOME\_URL . "/store-locator/ ========== -->\n"; |
| [498](#L498) |  |
| [499](#L499) | if (isset($GLOBALS['is\_on\_sl\_page']) && $GLOBALS['is\_on\_sl\_page'] == 1) { |
| [500](#L500) | //v3.88 added 'isset' clause above |
| [501](#L501) | $google\_map\_domain=($sl\_vars['google\_map\_domain']!="")? $sl\_vars['google\_map\_domain'] : "maps.google.com"; |
| [502](#L502) |  |
| [503](#L503) | //print "<meta name='viewport' content='initial-scale=1.0, user-scalable=no' />\n"; |
| [504](#L504) | //$sens=(!empty($sl\_vars['sensor']) && ($sl\_vars['sensor'] === "true" || $sl\_vars['sensor'] === "false" ))? "&amp;sensor=".$sl\_vars['sensor'] : "&amp;sensor=false" ; |
| [505](#L505) | $sens = ""; // - v3.84 - 11/25/15 - no longer required |
| [506](#L506) | $lang\_loc=(!empty($sl\_vars['map\_language']))? "&amp;language=".$sl\_vars['map\_language'] : "" ; |
| [507](#L507) | $region\_loc=(!empty($sl\_vars['map\_region']))? "&amp;region=".$sl\_vars['map\_region'] : "" ; |
| [508](#L508) | $key=(!empty($sl\_vars['api\_key']))? "&amp;key=".$sl\_vars['api\_key'] : "" ; |
| [509](#L509) | wp\_enqueue\_script("sl\_gmaps\_api", "https://maps.googleapis.com/maps/api/js?v=3" . esc\_attr($sens) . esc\_attr($lang\_loc) . esc\_attr($region\_loc) . esc\_attr($key) );  //v3.96; id='store-locator' prevents removal by sl\_remove\_gmaps() on sites not observing action hook priorities |
| [510](#L510) | //print "<script src='//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>\n"; |
| [511](#L511) |  |
| [512](#L512) | if (empty($\_POST) && 1==1) { //skip, for now always (1==2), dynamic file always causes trouble for some //1==1 - v3.98 |
| [513](#L513) | $nm=(!empty($post->post\_name))? $post->post\_name : $pagename ; |
| [514](#L514) | $p=(!empty($post->ID))? $post->ID : esc\_sql($\_GET['p']) ; |
| [515](#L515) | //$pg=(!empty($post->page\_ID))? $post->post\_ID : esc\_sql($\_GET['page\_id']) ; |
| [516](#L516) | wp\_enqueue\_script("sl\_dyn\_js", SL\_SITEURL."/?sl\_engine=js\_store-locator-js&v=".SL\_VERSION."&nm=$nm&p=$p"); |
| [517](#L517) | } else { |
| [518](#L518) | //sl\_dyn\_js($on\_sl\_page[0]['post\_content']); |
| [519](#L519) | wp\_add\_inline\_script("sl\_gmaps\_api", "sl\_dyn\_js();", 'after'); //https://developer.wordpress.org/reference/functions/wp\_add\_inline\_script/ |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | //if store-locator.css exists in custom-css/ folder in uploads/ dir it takes precedence over, store-locator.css in store-locator plugin directory to allow for css customizations to be preserved after updates |
| [523](#L523) | $has\_custom\_css=(file\_exists(SL\_CUSTOM\_CSS\_PATH."/store-locator.css"))? SL\_CUSTOM\_CSS\_BASE : SL\_CSS\_BASE; |
| [524](#L524) | wp\_enqueue\_style("sl\_main\_css", esc\_url($has\_custom\_css)."/store-locator.css?v=".SL\_VERSION); |
| [525](#L525) | $theme=$sl\_vars['theme']; |
| [526](#L526) | if ($theme!="") {wp\_enqueue\_style("sl\_theme\_css", SL\_THEMES\_BASE."/". esc\_attr($theme) ."/style.css?v=".SL\_VERSION); } |
| [527](#L527) | if (function\_exists("do\_sl\_hook")){do\_sl\_hook('sl\_addon\_head\_styles');} |
| [528](#L528) | //print "<style></style>"; |
| [529](#L529) | sl\_move\_upload\_directories(); |
| [530](#L530) | } else { |
| [531](#L531) | print "<!-- No store locator on this page, so no unnecessary scripts for better site performance. -->\n"; |
| [532](#L532) | } |
| [533](#L533) | print "<!-- ========= End WordPress Store Locator ("; |
| [534](#L534) | $sl\_page\_ids=$wpdb->get\_results("SELECT ID FROM ".SL\_DB\_PREFIX."posts WHERE LOWER(post\_content) LIKE '%[store-locator%' AND post\_status='publish'", ARRAY\_A); |
| [535](#L535) | if (!empty($sl\_page\_ids)) { |
| [536](#L536) | foreach ($sl\_page\_ids as $value) { print "$value[ID],";} |
| [537](#L537) | } |
| [538](#L538) | print ") ========== -->\n\n"; |
| [539](#L539) | } |
| [540](#L540) | function sl\_footer\_scripts(){ |
| [541](#L541) | if (!did\_action('wp\_head')){ sl\_head\_scripts();} //if wp\_head missing |
| [542](#L542) | } |
| [543](#L543) | add\_action('wp\_print\_footer\_scripts', 'sl\_footer\_scripts'); |
| [544](#L544) |  |
| [545](#L545) | function sl\_jq() { |
| [546](#L546) | wp\_enqueue\_script( 'jquery'); |
| [547](#L547) | } |
| [548](#L548) | add\_action('wp\_enqueue\_scripts', 'sl\_jq'); |
| [549](#L549) |  |
| [550](#L550) | function sl\_remove\_gmaps(){ |
| [551](#L551) | global $wp\_scripts; |
| [552](#L552) | if (isset($GLOBALS['is\_on\_sl\_page']) && $GLOBALS['is\_on\_sl\_page'] == 1) { |
| [553](#L553) | // Removing other Google Maps API instances |
| [554](#L554) | // Attempt - 11/25/15 - no luck - 2:19a - wp\_print\_scripts must actually be happening before wp\_head since the 'is\_on\_sl\_page' is NULL |
| [555](#L555) | // Attempt #2 - 11/30/15 - 12:37a - v3.85 |
| [556](#L556) |  |
| [557](#L557) | if (false != $wp\_scripts->queue) { |
| [558](#L558) | //var\_dump($wp\_scripts); |
| [559](#L559) | foreach ($wp\_scripts->queue as $script) { |
| [560](#L560) | if (isset($wp\_scripts->registered[$script]) && preg\_match("@maps\.google@", $wp\_scripts->registered[$script]->src) ) { |
| [561](#L561) | //$wp\_scripts->registered[$script]->deps = array(); |
| [562](#L562) | $the\_handle = $wp\_scripts->registered[$script]->handle; |
| [563](#L563) | //unset($wp\_scripts->queue[$the\_handle]); |
| [564](#L564) | if ($the\_handle != "sl\_gmaps\_api") { |
| [565](#L565) | wp\_dequeue\_script($the\_handle); |
| [566](#L566) | print "<!-- ========= Duplicate Google Maps API JavaScript - Removed by WordPress Store Locator to Avoid Errors. Script Details:\n".str\_replace("\\", "", json\_encode($wp\_scripts->registered[$script]))."\n========= -->\n"; |
| [567](#L567) | } |
| [568](#L568) | } |
| [569](#L569) | } |
| [570](#L570) | } |
| [571](#L571) | } |
| [572](#L572) | } |
| [573](#L573) | add\_action('wp\_print\_scripts', 'sl\_remove\_gmaps'); |
| [574](#L574) |  |
| [575](#L575) | // Removing other Google Maps API instances from wp\_head & wp\_footer, if present on Store Locator page - v3.91 |
| [576](#L576) | // Priorities of '..ob\_end\_flush' hooks must be less than priority of add\_action('wp\_head', 'sl\_head\_scripts') in store-locator.php; |
| [577](#L577) | function sl\_remove\_gmaps\_ob\_start() { |
| [578](#L578) | if (isset($GLOBALS['is\_on\_sl\_page']) && $GLOBALS['is\_on\_sl\_page'] == 1) { |
| [579](#L579) | ob\_start('sl\_remove\_gmaps\_header\_footer'); |
| [580](#L580) | } |
| [581](#L581) | } |
| [582](#L582) | function sl\_remove\_gmaps\_ob\_end\_flush() { |
| [583](#L583) | if (isset($GLOBALS['is\_on\_sl\_page']) && $GLOBALS['is\_on\_sl\_page'] == 1) { |
| [584](#L584) | ob\_end\_flush(); |
| [585](#L585) | } |
| [586](#L586) | } |
| [587](#L587) | function sl\_remove\_gmaps\_header\_footer($output) { |
| [588](#L588) | if (isset($GLOBALS['is\_on\_sl\_page']) && $GLOBALS['is\_on\_sl\_page'] == 1) { |
| [589](#L589) | if (preg\_match("@<script(?!.\*id='sl\_gmaps\_api-js')[^>]+maps.google[^>]+>[^<]\*<\/script>@", $output)) { |
| [590](#L590) | #ref: Negative lookahead: (?!.\*id='sl\_gmaps\_api-js') -- http://stackoverflow.com/a/1240365 - v3.96 |
| [591](#L591) | $output = preg\_replace\_callback("@<script(?!.\*id='sl\_gmaps\_api-js')[^>]+maps.google[^>]+>[^<]\*<\/script>@", |
| [592](#L592) | function($matches) { return "<!-- ========= Duplicate Google Maps API JavaScript - Removed by WordPress Store Locator to Avoid Errors. Script HTML:  \n$matches[0] \n========= -->\n"; }, |
| [593](#L593) | $output); |
| [594](#L594) | } |
| [595](#L595) | return $output; |
| [596](#L596) | } |
| [597](#L597) | } |
| [598](#L598) | add\_action('get\_header', 'sl\_remove\_gmaps\_ob\_start'); |
| [599](#L599) | add\_action('wp\_head', 'sl\_remove\_gmaps\_ob\_end\_flush', 1000); |
| [600](#L600) | add\_action('get\_footer', 'sl\_remove\_gmaps\_ob\_start'); |
| [601](#L601) | add\_action('wp\_footer', 'sl\_remove\_gmaps\_ob\_end\_flush', 1000); |
| [602](#L602) |  |
| [603](#L603) | /\*function sl\_jq\_missing\_wp\_head($content){ |
| [604](#L604) | $sl\_jq\_scripts = ""; |
| [605](#L605) | if (!did\_action('wp\_head')) { |
| [606](#L606) | global $wp\_scripts; |
| [607](#L607) | wp\_enqueue\_script( 'jquery'); //false, array(), false, true); |
| [608](#L608) | ob\_start(); |
| [609](#L609) | $wp\_scripts->print\_scripts(); |
| [610](#L610) | $sl\_jq\_scripts = ob\_get\_contents(); |
| [611](#L611) | ob\_end\_clean(); |
| [612](#L612) | } |
| [613](#L613) | return $sl\_jq\_scripts.$content; |
| [614](#L614) | } |
| [615](#L615) | add\_action('the\_content', 'sl\_jq\_missing\_wp\_head', 1000000); \*/ |
| [616](#L616) | /\*large to make sure not overwritten, even if higher priority hook overwrites content\*/ |
| [617](#L617) | /\*commented out - 11/7/14 - causing errors with some themes' jQuery / image porfolios (Jupiter); not critical function\*/ |
| [618](#L618) | /\*-----------------------------------\*/ |
| [619](#L619) | function sl\_menu\_position($start, $increment = 0.0001) { |
| [620](#L620) | #http://stackoverflow.com/a/22382858 |
| [621](#L621) | $menus\_positions = array\_keys($GLOBALS['menu']); |
| [622](#L622) | if (!in\_array($start, $menus\_positions)) return $start; |
| [623](#L623) | /\* the position is already reserved find the closest one \*/ |
| [624](#L624) | while (in\_array($start, $menus\_positions)) { |
| [625](#L625) | $start += $increment; |
| [626](#L626) | } |
| [627](#L627) | return $start; |
| [628](#L628) | } |
| [629](#L629) | function sl\_add\_options\_page() { |
| [630](#L630) | global $sl\_dir, $sl\_base, $sl\_uploads\_base, $text\_domain, $sl\_top\_nav\_links, $sl\_vars, $sl\_version; |
| [631](#L631) | $parent\_url = SL\_PARENT\_URL; //SL\_PAGES\_DIR.'/information.php'; |
| [632](#L632) | $warning\_count = 0; |
| [633](#L633) | $warning\_title = \_\_("Update(s) currently available for Store Locator", "store-locator") . ":"; |
| [634](#L634) |  |
| [635](#L635) | ####Base Plugin Update Notification in WP Menu ============= |
| [636](#L636) | // if (function\_exists("plugins\_api")) { |
| [637](#L637) | $sl\_vars['sl\_latest\_version\_check\_time'] = (empty($sl\_vars['sl\_latest\_version\_check\_time']))? date("Y-m-d H:i:s") : $sl\_vars['sl\_latest\_version\_check\_time']; |
| [638](#L638) | if (empty($sl\_vars['sl\_latest\_version']) || (time() - strtotime($sl\_vars['sl\_latest\_version\_check\_time']))/60>=(60\*12)){ //2-hr db caching of version info |
| [639](#L639) | /\*if (!function\_exists("plugins\_api")) { |
| [640](#L640) | $plugin\_install\_url = ABSPATH."wp-admin/includes/plugin-install.php"; //die($plugin\_install\_url); |
| [641](#L641) | include\_once($plugin\_install\_url); |
| [642](#L642) | }\*/ // Causing fatal errors in some installs -- so must assume it's available to all already -- 2/23/15 |
| [643](#L643) | //$sl\_api = plugins\_api('plugin\_information', array('slug' => 'store-locator', 'fields' => array('sections' => false) ) ); |
| [644](#L644) | $sl\_api = @sl\_remote\_data(array( |
| [645](#L645) | 'host' => 'api.wordpress.org', |
| [646](#L646) | 'url' => '/plugins/info/1.0/store-locator', |
| [647](#L647) | 'ua' => 'none'), 'serial'); |
| [648](#L648) |  |
| [649](#L649) | /\*need 'true' if trying to include changelog info in future\*/ |
| [650](#L650) | //var\_dump($sl\_api); die(); |
| [651](#L651) | $sl\_latest\_version = @$sl\_api->version; //'@': v3.97.1 //$sl\_version="2.6"; |
| [652](#L652) | //$sl\_latest\_changelog = $sl\_api->sections['changelog']; //var\_dump($sl\_latest\_changelog); die(); |
| [653](#L653) | //preg\_match\_all("@<ul>(.\*)</ul>@", $sl\_latest\_changelog, $sl\_version\_matches); var\_dump($sl\_version\_matches); die(); |
| [654](#L654) |  |
| [655](#L655) | $sl\_vars['sl\_latest\_version\_check\_time'] = date("Y-m-d H:i:s"); |
| [656](#L656) | $sl\_vars['sl\_latest\_version'] = $sl\_latest\_version; |
| [657](#L657) | } else { |
| [658](#L658) | $sl\_latest\_version = $sl\_vars['sl\_latest\_version']; |
| [659](#L659) | } |
| [660](#L660) | //$sl\_version = 2.6; //testing purposes |
| [661](#L661) | if (version\_compare($sl\_latest\_version, $sl\_version) > 0) { |
| [662](#L662) | $warning\_title .= "\n- Store Locator v{$sl\_latest\_version} " . \_\_("is available, you are using", "store-locator"). " v{$sl\_version}"; |
| [663](#L663) | $warning\_count++; |
| [664](#L664) |  |
| [665](#L665) | $sl\_plugin = SL\_DIR . "/store-locator.php"; |
| [666](#L666) | $sl\_update\_link = admin\_url('update.php?action=upgrade-plugin&plugin=' . $sl\_plugin); |
| [667](#L667) | $sl\_update\_link\_nonce = wp\_nonce\_url($sl\_update\_link, 'upgrade-plugin\_' . $sl\_plugin); |
| [668](#L668) | $sl\_update\_msg = "&nbsp;&gt;&nbsp;<a href='$sl\_update\_link\_nonce' style='color:#900; font-weight:bold;' onclick='confirmClick(\"".\_\_("You will now be updating to Store Locator", "store-locator")." v$sl\_latest\_version, ".\_\_("click OK or Confirm to continue", "store-locator").".\", this.href); return false;'>".\_\_("Update to", "store-locator")." $sl\_latest\_version</a>"; |
| [669](#L669) | } else { |
| [670](#L670) | $sl\_update\_msg = ""; |
| [671](#L671) | } |
| [672](#L672) | //   } |
| [673](#L673) |  |
| [674](#L674) | $notify = ($warning\_count > 0)?  " <span class='update-plugins count-$warning\_count' title='$warning\_title'><span class='update-count'>" . $warning\_count . "</span></span>" : "" ; |
| [675](#L675) |  |
| [676](#L676) | $sl\_menu\_pages['main'] = array('title' => \_\_("Store Locator", "store-locator")."$notify", 'capability' => 'administrator', 'page\_url' =>  $parent\_url, 'icon' => SL\_BASE.'/images/logo.ico.png', 'menu\_position' => '21.000723'); |
| [677](#L677) | $sl\_menu\_pages['sub']['information'] = array('parent\_url' => $parent\_url, 'title' => \_\_("News & Upgrades", "store-locator"), 'capability' => 'administrator', 'page\_url' => $parent\_url); |
| [678](#L678) | $sl\_menu\_pages['sub']['locations'] = array('parent\_url' => $parent\_url, 'title' => \_\_("Locations", "store-locator"), 'capability' => 'administrator', 'page\_url' => SL\_PAGES\_DIR.'/locations.php'); |
| [679](#L679) | $sl\_menu\_pages['sub']['mapdesigner'] = array('parent\_url' => $parent\_url, 'title' => \_\_("MapDesigner", "store-locator"), 'capability' => 'administrator', 'page\_url' => SL\_PAGES\_DIR.'/mapdesigner.php'); |
| [680](#L680) |  |
| [681](#L681) | /\*if (!function\_exists("do\_sl\_hook") && (empty($sl\_vars['sl\_pt\_data\_status']) || $sl\_vars['sl\_pt\_data\_status'] != 'inactive')) { |
| [682](#L682) | $sl\_apn = array("Addons", "Upgrade", "Go Premium"); |
| [683](#L683) | $sl\_vars['sl\_addons\_page\_name'] = (empty($sl\_vars['sl\_addons\_page\_name']))? $sl\_apn[mt\_rand(0,2)] : $sl\_vars['sl\_addons\_page\_name']; |
| [684](#L684) | $sl\_menu\_pages['sub']['addons'] = array('parent\_url' => $parent\_url, 'title' => sprintf(\_\_("%s", "store-locator"), $sl\_vars['sl\_addons\_page\_name']), 'capability' => 'administrator', 'page\_url' => SL\_PAGES\_DIR.'/addons.php'); |
| [685](#L685) | }\*/ //v3.98.7 |
| [686](#L686) |  |
| [687](#L687) | sl\_menu\_pages\_filter($sl\_menu\_pages); |
| [688](#L688) | //var\_dump($GLOBALS['menu']); |
| [689](#L689) | /\* |
| [690](#L690) | add\_menu\_page(\_\_("Store Locator", "store-locator"), \_\_("Store Locator", "store-locator"), 'administrator', SL\_PAGES\_DIR.'/locations.php', '', SL\_BASE.'/images/logo.ico.png', 25.1); |
| [691](#L691) | $sl\_pg\_loc = add\_submenu\_page(SL\_PAGES\_DIR.'/locations.php', \_\_("Locations", "store-locator"), \_\_("Locations", "store-locator"), 'administrator', SL\_PAGES\_DIR.'/locations.php'); |
| [692](#L692) | $sl\_pg\_md = add\_submenu\_page(SL\_PAGES\_DIR.'/locations.php', \_\_("MapDesigner", "store-locator"), \_\_("MapDesigner", "store-locator"), 'administrator', SL\_PAGES\_DIR.'/mapdesigner.php');\*/ |
| [693](#L693) |  |
| [694](#L694) | //} |
| [695](#L695) | } |
| [696](#L696) |  |
| [697](#L697) | function sl\_menu\_pages\_filter($sl\_menu\_pages) { |
| [698](#L698) | if (function\_exists('do\_sl\_hook')){do\_sl\_hook('sl\_menu\_pages\_filter', '', array(&$sl\_menu\_pages), "", "", "", false);} |
| [699](#L699) |  |
| [700](#L700) | foreach ($sl\_menu\_pages as $menu\_type => $value) { |
| [701](#L701) | if ($menu\_type == 'main') { |
| [702](#L702) | add\_menu\_page ($value['title'], $value['title'], $value['capability'], $value['page\_url'], '', $value['icon'], $value['menu\_position']); |
| [703](#L703) | } |
| [704](#L704) | if ($menu\_type == 'sub'){ |
| [705](#L705) | foreach ($value as $sub\_value) { |
| [706](#L706) | add\_submenu\_page($sub\_value['parent\_url'], $sub\_value['title'], $sub\_value['title'], $sub\_value['capability'], $sub\_value['page\_url']); |
| [707](#L707) | } |
| [708](#L708) | } |
| [709](#L709) | } |
| [710](#L710) | } |
| [711](#L711) | /\*---------------------------------------------------\*/ |
| [712](#L712) | function sl\_add\_admin\_javascript() { |
| [713](#L713) | global $sl\_base, $sl\_uploads\_base, $sl\_dir, $google\_map\_domain, $sl\_path, $sl\_uploads\_path, $sl\_map\_language, $sl\_vars; |
| [714](#L714) |  |
| [715](#L715) | wp\_enqueue\_script( 'prettyPhoto', SL\_JS\_BASE."/jquery.prettyPhoto.js", "jQuery"); |
| [716](#L716) | wp\_enqueue\_script( 'sl\_func', SL\_SITEURL."/?sl\_engine=js\_store-locator-js&admin=1", "jQuery"); |
| [717](#L717) |  |
| [718](#L718) | $admin\_js = " |
| [719](#L719) | var sl\_dir='".$sl\_dir."'; |
| [720](#L720) | var sl\_google\_map\_country='".$sl\_vars['google\_map\_country']."'; |
| [721](#L721) | var sl\_base='".SL\_BASE."'; |
| [722](#L722) | var sl\_uploads\_base='".SL\_UPLOADS\_BASE."'; |
| [723](#L723) | var sl\_addons\_base=sl\_uploads\_base+'".str\_replace(SL\_UPLOADS\_BASE, '', SL\_ADDONS\_BASE)."'; |
| [724](#L724) | var sl\_includes\_base=sl\_base+'".str\_replace(SL\_BASE, '', SL\_INCLUDES\_BASE)."'; |
| [725](#L725) | var sl\_cache\_base=sl\_uploads\_base+'".str\_replace(SL\_UPLOADS\_BASE, '', SL\_CACHE\_BASE)."'; |
| [726](#L726) | var sl\_pages\_base=sl\_base+'".str\_replace(SL\_BASE, '', SL\_PAGES\_BASE)."'; |
| [727](#L727) | var sl\_images\_base=sl\_uploads\_base+'".str\_replace(SL\_UPLOADS\_BASE, '', SL\_IMAGES\_BASE)."' |
| [728](#L728) | var sl\_images\_base\_original=sl\_base+'".str\_replace(SL\_BASE, '', SL\_IMAGES\_BASE\_ORIGINAL)."'"; |
| [729](#L729) | $admin\_js = preg\_replace("@[\\\]@", "\\\\\\", $admin\_js); //Windows-based server path backslash escape fix |
| [730](#L730) | wp\_add\_inline\_script("sl\_func", $admin\_js, 'before'); |
| [731](#L731) |  |
| [732](#L732) | if (preg\_match("@add-locations\.php|locations\.php@", $\_SERVER['REQUEST\_URI'])) { |
| [733](#L733) | if (!file\_exists(SL\_ADDONS\_PATH."/point-click-add/point-click-add.js")) { |
| [734](#L734) | $sens=(!empty($sl\_vars['sensor']))? "sensor=".$sl\_vars['sensor'] : "sensor=false" ; |
| [735](#L735) | $lang\_loc=(!empty($sl\_vars['map\_language']))? "&amp;language=".$sl\_vars['map\_language'] : "" ; |
| [736](#L736) | $region\_loc=(!empty($sl\_vars['map\_region']))? "&amp;region=".$sl\_vars['map\_region'] : "" ; |
| [737](#L737) | $key=(!empty($sl\_vars['api\_key']))? "&amp;key=".$sl\_vars['api\_key'] : "" ; |
| [738](#L738) | //print "<script src='http://maps.googleapis.com/maps/api/js?{$sens}{$lang\_loc}{$region\_loc}{$key}' type='text/javascript'></script>\n"; |
| [739](#L739) | } |
| [740](#L740) | /\*if (file\_exists(SL\_ADDONS\_PATH."/point-click-add/point-click-add.js")) { |
| [741](#L741) | //$sens=(!empty($sl\_vars['sensor']))? "sensor=".$sl\_vars['sensor'] : "sensor=false" ; |
| [742](#L742) | $sens=""; //- v3.84 - 11/25/15 - no longer required |
| [743](#L743) | $char\_enc='&amp;oe='.$sl\_vars['map\_character\_encoding']; |
| [744](#L744) | $google\_map\_domain=(!empty($sl\_vars['google\_map\_domain']))? $sl\_vars['google\_map\_domain'] : "maps.google.com"; |
| [745](#L745) | $api=sl\_data('store\_locator\_api\_key'); |
| [746](#L746) | print "<script src='https://$google\_map\_domain/maps?file=api&amp;v=2&amp;key=$api&amp;{$sens}{$char\_enc}' type='text/javascript'></script>\n"; |
| [747](#L747) | print "<script src='".SL\_ADDONS\_BASE."/point-click-add/point-click-add.js'></script>\n"; |
| [748](#L748) | } \*/ #3.98.5 -- long-retired addon |
| [749](#L749) | } |
| [750](#L750) | if (function\_exists('do\_sl\_hook')){do\_sl\_hook('sl\_addon\_admin\_scripts');} |
| [751](#L751) | } |
| [752](#L752) |  |
| [753](#L753) | function sl\_remove\_conflicting\_scripts(){ |
| [754](#L754) | if (preg\_match("@".SL\_DIR."@", $\_SERVER['REQUEST\_URI'])){ |
| [755](#L755) | wp\_dequeue\_script('ui-tabs'); //Firefox-only conflict with 'ui-tabs' (jquery.tabs.pack.js) from wp-shopping-cart |
| [756](#L756) | } |
| [757](#L757) | } |
| [758](#L758) | add\_action('admin\_enqueue\_scripts', 'sl\_remove\_conflicting\_scripts'); |
| [759](#L759) |  |
| [760](#L760) | function sl\_add\_admin\_stylesheet() { |
| [761](#L761) | global $sl\_base; |
| [762](#L762) | wp\_enqueue\_style("sl\_admin\_css", SL\_CSS\_BASE."/admin.css?v=".SL\_VERSION); |
| [763](#L763) | wp\_enqueue\_style("sl\_pop\_css", SL\_CSS\_BASE."/sl-pop.css?v=".SL\_VERSION); |
| [764](#L764) | } |
| [765](#L765) | /\*---------------------------------\*/ |
| [766](#L766) | function sl\_set\_query\_defaults() { |
| [767](#L767) | global $where, $o, $d, $sl\_searchable\_columns, $wpdb; |
| [768](#L768) | $extra=""; $the\_q="";  //var\_dump($sl\_searchable\_columns); die(); |
| [769](#L769) | $the\_q = (!empty($\_GET['q']))? sanitize\_text\_field($\_GET['q']) : $the\_q; |
| [770](#L770) | if (function\_exists("do\_sl\_hook") && !empty($sl\_searchable\_columns) && !empty($\_GET['q'])) { |
| [771](#L771) | foreach ($sl\_searchable\_columns as $value) { |
| [772](#L772) | $extra .= $wpdb->prepare(" OR $value LIKE '%%%s%%'", $the\_q); |
| [773](#L773) | } |
| [774](#L774) | } |
| [775](#L775) |  |
| [776](#L776) | $where=(!empty($\_GET['q']))? $wpdb->prepare(" WHERE sl\_store LIKE '%%%s%%' OR sl\_address LIKE '%%%s%%' OR sl\_city LIKE '%%%s%%' OR sl\_state LIKE '%%%s%%' OR sl\_zip LIKE '%%%s%%' OR sl\_tags LIKE '%%%s%%'", $the\_q, $the\_q, $the\_q, $the\_q, $the\_q, $the\_q)." ".$extra : "" ; //die($where); |
| [777](#L777) | //$where = (trim($where)!="")? $where." AND sl\_private<>'1' " : " WHERE sl\_private<>'1' "; |
| [778](#L778) | $o=(!empty($\_GET['o']))? sanitize\_text\_field($\_GET['o']) : "sl\_store"; |
| [779](#L779) | $d=(empty($\_GET['d']) || $\_GET['d']=="DESC")? "ASC" : "DESC"; |
| [780](#L780) | } |
| [781](#L781) | if (!function\_exists('set\_query\_defaults')){ |
| [782](#L782) | //2/26/19 - v3.98.4 - check |
| [783](#L783) | function set\_query\_defaults() {sl\_set\_query\_defaults();} |
| [784](#L784) | } |
| [785](#L785) | /\*--------------------------------------------------------------\*/ |
| [786](#L786) | function sl\_do\_hyperlink(&$text, $target="'\_blank'", $type="both"){ |
| [787](#L787) | if ($type=="both" || $type=="protocol") { |
| [788](#L788) | // match protocol://address/path/ |
| [789](#L789) | $text = preg\_replace("@[a-zA-Z]+://([.]?[a-zA-Z0-9\_/?&amp;%20,=\-\+\-\#])+@s", "<a href=\"\\0\" target=$target>\\0</a>", $text); |
| [790](#L790) | } |
| [791](#L791) | if ($type=="both" || $type=="noprotocol") { |
| [792](#L792) | // match www.something |
| [793](#L793) | $text = preg\_replace("@(^| )(www([.]?[a-zA-Z0-9\_/=-\+-\#])\*)@s", "\\1<a href=\"http://\\2\" target=$target>\\2</a>", $text); |
| [794](#L794) | } |
| [795](#L795) | return $text; |
| [796](#L796) | } |
| [797](#L797) | if (!function\_exists('do\_hyperlink')){ |
| [798](#L798) | //12/4/18 6:19pm - v3.98.3 |
| [799](#L799) | function do\_hyperlink(&$text, $target="'\_blank'", $type="both") { |
| [800](#L800) | return sl\_do\_hyperlink($text, $target, $type); |
| [801](#L801) | } |
| [802](#L802) | } |
| [803](#L803) | /\*-------------------------------------------------------------\*/ |
| [804](#L804) | function sl\_comma($a) { |
| [805](#L805) | $a=str\_replace('"', "&quot;", $a); |
| [806](#L806) | $a=str\_replace("'", "&#39;", $a); |
| [807](#L807) | $a=str\_replace(">", "&gt;", $a); |
| [808](#L808) | $a=str\_replace("<", "&lt;", $a); |
| [809](#L809) | $a=str\_replace(" & ", " &amp; ", $a); |
| [810](#L810) | $a=str\_replace("," ,"&#44;", $a); |
| [811](#L811) | $a=sanitize\_text\_field($a); //v3.98.5 - 4/23/22 4:55p -- possibly redudant, but a WP requested update | ref: https://developer.wordpress.org/reference/functions/esc\_attr/ |
| [812](#L812) | return $a; |
| [813](#L813) | } |
| [814](#L814) | if (!function\_exists('comma')){ |
| [815](#L815) | //2/26/19 - v3.98.4 |
| [816](#L816) | function comma($a) { |
| [817](#L817) | return sl\_comma($a); |
| [818](#L818) | } |
| [819](#L819) | } |
| [820](#L820) | /\*------------------------------------------------------------\*/ |
| [821](#L821) | function sl\_addon\_activation\_message($url\_of\_upgrade="") { |
| [822](#L822) | global $sl\_dir, $text\_domain; |
| [823](#L823) | print "<div style='background-color:#eee; border:solid silver 1px; padding:7px; color:black; display:block;'>".\_\_("You haven't activated this upgrade yet", "store-locator").". "; |
| [824](#L824) | if (function\_exists('do\_sl\_hook') && !preg\_match("/addons\-platform/", $url\_of\_upgrade) ){ |
| [825](#L825) | print "<a href='".SL\_ADDONS\_PAGE."'>".\_\_("Activate", "store-locator")."</a></div><br>"; |
| [826](#L826) | } else { |
| [827](#L827) | print \_\_("Go to pull-out Dashboard, and activate under 'Activation Keys' section.", "store-locator")."</div><br>"; |
| [828](#L828) | } |
| [829](#L829) | } |
| [830](#L830) | if (!function\_exists('addon\_activation\_message')){ |
| [831](#L831) | //2/26/19 - v3.98.4 |
| [832](#L832) | function addon\_activation\_message($url\_of\_upgrade="") { |
| [833](#L833) | global $sl\_dir, $text\_domain; |
| [834](#L834) | sl\_addon\_activation\_message($url\_of\_upgrade); |
| [835](#L835) | } |
| [836](#L836) | } |
| [837](#L837) | /\*-----------------------------------------------------------\*/ |
| [838](#L838) | function sl\_url\_test($url){ |
| [839](#L839) | if (!empty($url) && preg\_match("@^https?://@i", $url)) { |
| [840](#L840) | return TRUE; |
| [841](#L841) | } else { |
| [842](#L842) | return FALSE; |
| [843](#L843) | } |
| [844](#L844) | } |
| [845](#L845) | if (!function\_exists('url\_test')){ |
| [846](#L846) | //2/26/19 - v3.98.4 |
| [847](#L847) | function url\_test($url) { |
| [848](#L848) | return sl\_url\_test($url); |
| [849](#L849) | } |
| [850](#L850) | } |
| [851](#L851) | /\*---------------------------------------------------------------\*/ |
| [852](#L852) | function sl\_neat\_title($ttl,$separator="\_") { |
| [853](#L853) | /\*$ttl=preg\_replace("/@+/", "$separator", preg\_replace("/[^[:alnum:]]/", "@", trim(preg\_replace("/[^[:alnum:]]/", " ", str\_replace("'", "", sl\_truncate(trim(strtolower(html\_entity\_decode(str\_replace("&#39;","'",$ttl)))), 100)))))); |
| [854](#L854) | return $ttl;\*/ |
| [855](#L855) |  |
| [856](#L856) | //Now also converts foreign chars to un-accented equiv character - 11/7/14; |
| [857](#L857) |  |
| [858](#L858) | $normalizeChars = array( |
| [859](#L859) | 'Š'=>'S', 'š'=>'s', 'Ð'=>'Dj','Ž'=>'Z', 'ž'=>'z', 'À'=>'A', 'Á'=>'A', 'Â'=>'A', 'Ã'=>'A', 'Ä'=>'A', |
| [860](#L860) | 'Å'=>'A', 'Æ'=>'A', 'Ç'=>'C', 'È'=>'E', 'É'=>'E', 'Ê'=>'E', 'Ë'=>'E', 'Ì'=>'I', 'Í'=>'I', 'Î'=>'I', |
| [861](#L861) | 'Ï'=>'I', 'Ñ'=>'N', 'Ò'=>'O', 'Ó'=>'O', 'Ô'=>'O', 'Õ'=>'O', 'Ö'=>'O', 'Ø'=>'O', 'Ù'=>'U', 'Ú'=>'U', |
| [862](#L862) | 'Û'=>'U', 'Ü'=>'U', 'Ý'=>'Y', 'Þ'=>'B', 'ß'=>'Ss','à'=>'a', 'á'=>'a', 'â'=>'a', 'ã'=>'a', 'ä'=>'a', |
| [863](#L863) | 'å'=>'a', 'æ'=>'a', 'ç'=>'c', 'è'=>'e', 'é'=>'e', 'ê'=>'e', 'ë'=>'e', 'ì'=>'i', 'í'=>'i', 'î'=>'i', |
| [864](#L864) | 'ï'=>'i', 'ð'=>'o', 'ñ'=>'n', 'ò'=>'o', 'ó'=>'o', 'ô'=>'o', 'õ'=>'o', 'ö'=>'o', 'ø'=>'o', 'ù'=>'u', |
| [865](#L865) | 'ú'=>'u', 'û'=>'u', 'ü'=>'u', 'ý'=>'y', 'ý'=>'y', 'þ'=>'b', 'ÿ'=>'y', 'ƒ'=>'f', |
| [866](#L866) | 'ă'=>'a', 'î'=>'i', 'â'=>'a', 'ș'=>'s', 'ț'=>'t', 'Ă'=>'A', 'Î'=>'I', 'Â'=>'A', 'Ș'=>'S', 'Ț'=>'T'); |
| [867](#L867) | $ttl = strtr($ttl, $normalizeChars); |
| [868](#L868) | $ttl = html\_entity\_decode( str\_replace("&#39;","'",$ttl) ); |
| [869](#L869) |  |
| [870](#L870) | $ttl = preg\_replace("/@+/", "$separator", |
| [871](#L871) | preg\_replace("/[^[:alnum:]]/", "@", |
| [872](#L872) | trim( |
| [873](#L873) | preg\_replace("/[^[:alnum:]]/", " ", |
| [874](#L874) | str\_replace("'", "", |
| [875](#L875) | sl\_truncate( |
| [876](#L876) | trim( |
| [877](#L877) | strtolower($ttl) |
| [878](#L878) | ), |
| [879](#L879) | 100) |
| [880](#L880) | ) |
| [881](#L881) | ) |
| [882](#L882) | ) |
| [883](#L883) | ) |
| [884](#L884) | ); |
| [885](#L885) | return $ttl; |
| [886](#L886) | } |
| [887](#L887) | /\*-------------------------------\*/ |
| [888](#L888) | function sl\_truncate($var,$length=50,$mode="return", $type=1) { |
| [889](#L889) |  |
| [890](#L890) | if (strlen($var)>$length) { |
| [891](#L891) | if ($type==1) { //avoids cutting words in half |
| [892](#L892) | $var=substr($var,0,$length); |
| [893](#L893) | $var=preg\_replace("@[[:space:]]{1}.{1,10}$@s", "", $var); //making sure it doesn't cut word in half |
| [894](#L894) | $var=$var."..."; |
| [895](#L895) | } |
| [896](#L896) | elseif ($type==2) { //provides display "more" & "less" link |
| [897](#L897) | $r\_num=mt\_rand(); |
| [898](#L898) | $r\_num2=$r\_num."\_2"; |
| [899](#L899) | $var1=substr($var,0,$length); |
| [900](#L900) | $var2=substr($var,$length, strlen($var)-$length); |
| [901](#L901) | $var="<span id='$r\_num'>$var1</span><span id='$r\_num2' style='display:none'>".$var1.$var2."</span><a href='#' onclick=\"show('$r\_num');show('$r\_num2');this.innerHTML=(this.innerHTML.indexOf('more')!=-1)?'(...less)':'(more...)';return false;\">(more...)</a>"; |
| [902](#L902) | } |
| [903](#L903) | elseif ($type==3) { //exact length truncation |
| [904](#L904) | $var=substr($var,0,$length); |
| [905](#L905) | $var=$var."..."; |
| [906](#L906) | } |
| [907](#L907) | } |
| [908](#L908) | if ($mode!="print") { |
| [909](#L909) | return $var; |
| [910](#L910) | } |
| [911](#L911) | else { |
| [912](#L912) | print $var; |
| [913](#L913) | } |
| [914](#L914) | } |
| [915](#L915) | /\*-----------------------------------------------------------\*/ |
| [916](#L916) | function sl\_process\_tags($tag\_string, $db\_action="insert", $sl\_id="") { |
| [917](#L917) | //v3.94 - commented out - originally meant for Categorizer tags filtering, but no longer needed - 2/22/16 |
| [918](#L918) | /\* |
| [919](#L919) | global $wpdb; |
| [920](#L920) | $id\_string=""; |
| [921](#L921) |  |
| [922](#L922) | if (!is\_array($sl\_id) && preg\_match("@,@", $sl\_id)) { |
| [923](#L923) | $id\_string=$sl\_id; |
| [924](#L924) | $sl\_id=explode(",",$id\_string); |
| [925](#L925) | $rplc\_arr=array\_fill(0, count($sl\_id), "%d"); //var\_dump($rplc\_arr); //die(); |
| [926](#L926) | $id\_string=implode(",", array\_map(array($wpdb, "prepare"), $rplc\_arr, $sl\_id)); |
| [927](#L927) | } elseif (is\_array($sl\_id)) { |
| [928](#L928) | $rplc\_arr=array\_fill(0, count($sl\_id), "%d"); //var\_dump($rplc\_arr); //die(); |
| [929](#L929) | $id\_string=implode(",", array\_map(array($wpdb, "prepare"), $rplc\_arr, $sl\_id)); |
| [930](#L930) | } else { |
| [931](#L931) | $id\_string=$wpdb->prepare("%d", $sl\_id); |
| [932](#L932) | } |
| [933](#L933) |  |
| [934](#L934) | //creating array of tags |
| [935](#L935) | if (preg\_match("@,@", $tag\_string)) { |
| [936](#L936) | $tag\_string=preg\_replace('/[^A-Za-z0-9\_\-, ]/', '', $tag\_string); |
| [937](#L937) | $sl\_tag\_array=array\_map('trim',explode(",",trim($tag\_string))); |
| [938](#L938) | $sl\_tag\_array=array\_map('strtolower', $sl\_tag\_array); |
| [939](#L939) | } else { |
| [940](#L940) | $tag\_string=preg\_replace('/[^A-Za-z0-9\_\-, ]/', '', $tag\_string); |
| [941](#L941) | $sl\_tag\_array[]=strtolower(trim($tag\_string)); |
| [942](#L942) | } |
| [943](#L943) |  |
| [944](#L944) | if ($db\_action=="insert") { |
| [945](#L945) | $wpdb->query("DELETE FROM ".SL\_TAG\_TABLE." WHERE sl\_id IN ($id\_string)");  //clear current tags for locations being modified |
| [946](#L946) | //build insert query |
| [947](#L947) | $query="INSERT INTO ".SL\_TAG\_TABLE." (sl\_tag\_slug, sl\_id) VALUES "; |
| [948](#L948) | if (!is\_array($sl\_id)) { |
| [949](#L949) | $main\_sl\_id=($sl\_id==="")? $wpdb->insert\_id : $sl\_id ; |
| [950](#L950) | foreach ($sl\_tag\_array as $value)  { |
| [951](#L951) | if (trim($value)!="") { |
| [952](#L952) | $query.="('$value', '$main\_sl\_id'),"; |
| [953](#L953) | } |
| [954](#L954) | } |
| [955](#L955) | } elseif (is\_array($sl\_id)) { |
| [956](#L956) | foreach ($sl\_id as $value2) { |
| [957](#L957) | $main\_sl\_id=$value2; |
| [958](#L958) | foreach ($sl\_tag\_array as $value)  { |
| [959](#L959) | if (trim($value)!="") { |
| [960](#L960) | $query.="('$value', '$main\_sl\_id'),"; |
| [961](#L961) | } |
| [962](#L962) | } |
| [963](#L963) | } |
| [964](#L964) | } |
| [965](#L965) | $query=substr($query, 0, strlen($query)-1); // remove last comma |
| [966](#L966) | //print($query); |
| [967](#L967) | } elseif ($db\_action=="delete") { |
| [968](#L968) | if (trim($tag\_string)==="") { |
| [969](#L969) | $query="DELETE FROM ".SL\_TAG\_TABLE." WHERE sl\_id IN ($id\_string)"; |
| [970](#L970) | } else { |
| [971](#L971) | $t\_string=implode("','", $sl\_tag\_array); //die($t\_string); |
| [972](#L972) | $query="DELETE FROM ".SL\_TAG\_TABLE." WHERE sl\_id IN ($id\_string) AND sl\_tag\_slug IN ('".trim($t\_string)."')"; |
| [973](#L973) | //die($query."\n"); |
| [974](#L974) | } |
| [975](#L975) | } |
| [976](#L976) | $wpdb->query($query); |
| [977](#L977) | \*/ |
| [978](#L978) | } |
| [979](#L979) | /\*-----------------------------------------------------------\*/ |
| [980](#L980) | function sl\_admin\_init\_ty() { |
| [981](#L981) | global $wpdb, $sl\_vars; |
| [982](#L982) |  |
| [983](#L983) | $sl\_time\_length = ((time() - strtotime($sl\_vars["start"]))/60/60/24>=14)? "week" : "a few days"; |
| [984](#L984) | $sl\_time\_length = ((time() - strtotime($sl\_vars["start"]))/60/60/24>=30)? "month" : $sl\_time\_length; |
| [985](#L985) | $sl\_time\_length = ((time() - strtotime($sl\_vars["start"]))/60/60/24>=90)? "three months" : $sl\_time\_length; |
| [986](#L986) | $sl\_time\_length = ((time() - strtotime($sl\_vars["start"]))/60/60/24>=183)? "six months" : $sl\_time\_length; |
| [987](#L987) | $sl\_time\_length = ((time() - strtotime($sl\_vars["start"]))/60/60/24>=365)? "year" : $sl\_time\_length; |
| [988](#L988) | define("SL\_THANKS\_TIME\_LENGTH", $sl\_time\_length); |
| [989](#L989) |  |
| [990](#L990) | $sl\_num\_locs\_query = $wpdb->get\_var("SELECT COUNT(sl\_id) from ".SL\_DB\_PREFIX."store\_locator WHERE sl\_latitude<>'' AND sl\_latitude <>0 AND sl\_latitude IS NOT NULL"); |
| [991](#L991) |  |
| [992](#L992) | $sl\_num\_locs = ($sl\_num\_locs\_query >= 50)? "50": $sl\_num\_locs\_query; |
| [993](#L993) | $sl\_num\_locs = ($sl\_num\_locs\_query >= 100)? "100": $sl\_num\_locs; |
| [994](#L994) | $sl\_num\_locs = ($sl\_num\_locs\_query >= 200)? "200": $sl\_num\_locs; |
| [995](#L995) | $sl\_num\_locs = ($sl\_num\_locs\_query >= 500)? "500": $sl\_num\_locs; |
| [996](#L996) | $sl\_num\_locs = ($sl\_num\_locs\_query >= 1000)? "1000": $sl\_num\_locs; |
| [997](#L997) | define("SL\_THANKS\_NUM\_LOCS", $sl\_num\_locs); |
| [998](#L998) | } |
| [999](#L999) | add\_action('admin\_init', 'sl\_admin\_init\_ty'); |
| [1000](#L1000) |  |
| [1001](#L1001) | function sl\_ty($file){ |
| [1002](#L1002) | global $sl\_vars, $wpdb; |
| [1003](#L1003) | $ty['http'] = (!empty($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] == 'on') ? 'https://':'http://'; |
| [1004](#L1004) | $ty['url']      = urlencode("http://locl.es/Lcatr"); //urlencode("http://locl.es/Lcatr"); - 9/9/15 - domain needs update |
| [1005](#L1005) | $ty['text'] = urlencode(\_\_("Love it! I've made my site more user-friendly with", "store-locator")." LotsOfLocales #WP #WordPress #StoreLocator #GoogleMaps"); |
| [1006](#L1006) | $ty['text2'] = urlencode(\_\_("Great! I can now easily display my locations using", "store-locator")." LotsOfLocales #GoogleMaps #StoreLocator #WordPress #WP"); |
| [1007](#L1007) | //$ty['is\_included']=(basename($file) != basename($\_SERVER['SCRIPT\_FILENAME']) )? true : false; |
| [1008](#L1008) | $ty['is\_included']=(empty($\_GET['ajax']) || $\_GET['ajax'] != 'true')? true : false; /\*v3.98.3 | 12/4/18 4:44p -- needed update due to new URL structure of loading module (it would've always been true for $is\_included)\*/ |
| [1009](#L1009) |  |
| [1010](#L1010) | if (!$ty['is\_included']) { |
| [1011](#L1011) |  |
| [1012](#L1012) | sl\_admin\_init\_ty(); |
| [1013](#L1013) |  |
| [1014](#L1014) | $ty['thanks\_msg'] = sprintf(\_\_("Hey, noticed you've now successfully added %s+ locations over the past %s or more – fantastic!  Could you do a huge favor and give a rating on WordPress? It will keep our motivation high to continue providing more great features and updates for you. |
| [1015](#L1015) | <br><br>~ Viadat Creations", "store-locator")."<br><br>", SL\_THANKS\_NUM\_LOCS, SL\_THANKS\_TIME\_LENGTH); |
| [1016](#L1016) | $ty['thanks\_msg\_style'] = "style='line-height:20px; font-familty:helvetica; text-align:left; font-size:15px'"; |
| [1017](#L1017) | $ty['thanks\_heading'] = "<br>".\_\_("My Views", "store-locator")."<br><br>"; |
| [1018](#L1018) | $ty['action\_call'] =  \_\_("Buttons to Spread the Word!", "store-locator"); |
| [1019](#L1019) | $ty['action\_call\_style'] = "style='font-size:20px; text-align:left; display:block;  font-family:Georgia;'"; |
| [1020](#L1020) | $ty['action\_buttons\_style'] = "style='text-align:left; padding-top:11px; padding-left:0px;font-weight:normal;font-size:15px'"; |
| [1021](#L1021) | } else { |
| [1022](#L1022) | $ty['thanks\_msg'] = \_\_("<b>Liking Store Locator? Share your voice:</b><br><a href='#' class='star\_button'>Give my review now</a><br><br><b>Any problems? View:</b><br><a href='http://docs.viadat.com/' target='\_blank'>Documentation</a> / <a href='http://www.viadat.com/contact/' target='\_blank'>Contact us</a>", "store-locator")."<br><br>"; |
| [1023](#L1023) | $ty['thanks\_msg\_style'] = ""; |
| [1024](#L1024) | $ty['thanks\_heading'] =""; |
| [1025](#L1025) | $ty['action\_call'] =""; |
| [1026](#L1026) | $ty['action\_call\_style'] = ""; |
| [1027](#L1027) | $ty['action\_buttons\_style'] = ""; |
| [1028](#L1028) | } |
| [1029](#L1029) | $ty['done\_msg'] = \_\_("I've already rated it", "store-locator"); |
| [1030](#L1030) | $ty['noshow\_msg'] = \_\_("No, check with me later", "store-locator"); |
| [1031](#L1031) | return $ty; |
| [1032](#L1032) | } |
| [1033](#L1033) |  |
| [1034](#L1034) | function sl\_foot\_ty($text) { |
| [1035](#L1035) | global $wpdb, $sl\_vars; |
| [1036](#L1036) |  |
| [1037](#L1037) | if (preg\_match("@".SL\_DIR."@", $\_SERVER['REQUEST\_URI']) && (empty($sl\_vars['thanks']) || $sl\_vars['thanks'] != "true") && mt\_rand(1,2) == 2 && defined("SL\_THANKS\_TIME\_LENGTH") && SL\_THANKS\_TIME\_LENGTH != "a few days" && SL\_THANKS\_NUM\_LOCS >= 100) { |
| [1038](#L1038) | $text = sprintf(\_\_("You've successfully added %s+ locations!  Could you do a huge favor and %sgive a WP rating%s?", "store-locator"), SL\_THANKS\_NUM\_LOCS, "<a href='https://wordpress.org/support/view/plugin-reviews/store-locator?filter=5#postform' target='\_blank'>", "</a>"); |
| [1039](#L1039) | //$text = "<div class='sl\_admin\_success' style='width:55%; position:relative; top:35px;'>".$text."</div>"; |
| [1040](#L1040) | $text = "<i>$text</i>"; |
| [1041](#L1041) | } |
| [1042](#L1042) | //$text = SL\_THANKS\_TIME\_LENGTH ."  " . SL\_THANKS\_NUM\_LOCS; |
| [1043](#L1043) | return $text; |
| [1044](#L1044) | } |
| [1045](#L1045) | add\_filter( 'admin\_footer\_text', 'sl\_foot\_ty', 1 ); |
| [1046](#L1046) | /\*-----------------------------------------------------------\*/ |
| [1047](#L1047) | function sl\_prepare\_tag\_string($sl\_tags) { |
| [1048](#L1048) | //$sl\_tags=preg\_replace('/[ ]\*\&\#44\;[ ]\*/', ', ', $sl\_tags); |
| [1049](#L1049) | $sl\_tags=preg\_replace('/\,+/', ', ', $sl\_tags); |
| [1050](#L1050) | $sl\_tags=preg\_replace('/(&#44;)+/', ', ', $sl\_tags); |
| [1051](#L1051) | $sl\_tags=preg\_replace('/[^A-Za-z0-9\_\-,]/', '', $sl\_tags); |
| [1052](#L1052) | if (substr($sl\_tags, 0, 1) == ",") { |
| [1053](#L1053) | $sl\_tags=substr($sl\_tags, 1, strlen($sl\_tags)); |
| [1054](#L1054) | } |
| [1055](#L1055) | if (substr($sl\_tags, strlen($sl\_tags)-1, 1) != "," && trim($sl\_tags)!="") { |
| [1056](#L1056) | $sl\_tags.=","; |
| [1057](#L1057) | } |
| [1058](#L1058) | $sl\_tags=preg\_replace('/\,+/', ', ', $sl\_tags); |
| [1059](#L1059) | $sl\_tags=preg\_replace('/(&#44;)+/', ', ', $sl\_tags); |
| [1060](#L1060) | $sl\_tags=preg\_replace('/[ ]\*,[ ]\*/', ', ', $sl\_tags); |
| [1061](#L1061) | //$sl\_tags=preg\_replace('/[ ]\*,[ ]\*/', ', ', $sl\_tags); |
| [1062](#L1062) | $sl\_tags=trim($sl\_tags); |
| [1063](#L1063) | return $sl\_tags; |
| [1064](#L1064) | } |
| [1065](#L1065) | /\*-----------------------------------------------------------\*/ |
| [1066](#L1066) | function sl\_data($setting\_name, $i\_u\_d\_s="select", $setting\_value="") { |
| [1067](#L1067) | global $wpdb; |
| [1068](#L1068) | //$$addon\_slug[trim($setting[0])] = trim($setting[1]); |
| [1069](#L1069) | if ($i\_u\_d\_s == "insert" || $i\_u\_d\_s == "add" || $i\_u\_d\_s == "update") { |
| [1070](#L1070) | //$setting = explode("=", $setting); |
| [1071](#L1071) | $setting\_value = (is\_array($setting\_value))? serialize($setting\_value) : $setting\_value; |
| [1072](#L1072) | $exists = $wpdb->get\_var($wpdb->prepare("SELECT sl\_setting\_id FROM ".SL\_SETTING\_TABLE." WHERE sl\_setting\_name = %s", $setting\_name)); |
| [1073](#L1073) | if (!$exists) { |
| [1074](#L1074) | $q = $wpdb->prepare("INSERT INTO ".SL\_SETTING\_TABLE." (sl\_setting\_name, sl\_setting\_value) VALUES (%s, %s)", $setting\_name, $setting\_value); |
| [1075](#L1075) | } else { |
| [1076](#L1076) | $q = $wpdb->prepare("UPDATE ".SL\_SETTING\_TABLE." SET sl\_setting\_value = %s WHERE sl\_setting\_name = %s", $setting\_value, $setting\_name); |
| [1077](#L1077) | } |
| [1078](#L1078) | $wpdb->query($q); |
| [1079](#L1079) | } elseif ($i\_u\_d\_s == "delete") { |
| [1080](#L1080) | $q = $wpdb->prepare("DELETE FROM ".SL\_SETTING\_TABLE." WHERE sl\_setting\_name = %s", $setting\_name); |
| [1081](#L1081) | $wpdb->query($q); |
| [1082](#L1082) | } elseif ($i\_u\_d\_s == "select" || $i\_u\_d\_s == "get") { |
| [1083](#L1083) | $q = $wpdb->prepare("SELECT sl\_setting\_value FROM ".SL\_SETTING\_TABLE." WHERE sl\_setting\_name = %s", $setting\_name); |
| [1084](#L1084) | $r = $wpdb->get\_var($q); |
| [1085](#L1085) | $r = (@unserialize($r) !== false || $r === 'b:0;')? unserialize($r) : $r;  //checking if stored in serialized form |
| [1086](#L1086) | /\*if (function\_exists("apply\_filters")) { |
| [1087](#L1087) | return apply\_filters( 'option\_' . $setting\_name, $r);  //Compability for WPML or any plugin that uses option\_(option\_name) hooks |
| [1088](#L1088) | } else {\*/ |
| [1089](#L1089) | return $r; |
| [1090](#L1090) | //} |
| [1091](#L1091) | } |
| [1092](#L1092) | } |
| [1093](#L1093) | /\*----------------------------------------------------------------\*/ |
| [1094](#L1094) | function sl\_md\_output($output\_zone) { |
| [1095](#L1095) | include(SL\_INCLUDES\_PATH."/mapdesigner-options.php"); |
| [1096](#L1096) |  |
| [1097](#L1097) | $GLOBALS['output\_zone\_type'] = $output\_zone; |
| [1098](#L1098) | $output\_arr = array\_filter($sl\_mdo, "filter\_sl\_mdo"); |
| [1099](#L1099) | unset($GLOBALS['output\_zone\_type']); |
| [1100](#L1100) | unset($sl\_mdo); |
| [1101](#L1101) |  |
| [1102](#L1102) | if ($output\_zone == 'sl\_dyn\_js') { |
| [1103](#L1103) | foreach ($output\_arr as $value) { |
| [1104](#L1104) | if (!is\_array($value['output\_zone'])) { |
| [1105](#L1105) | $the\_field = $value['field\_name']; |
| [1106](#L1106) | $$the\_field = (trim($sl\_vars[$the\_field]) != "")? sl\_parseToXML($sl\_vars[$the\_field]) : $value['default']; |
| [1107](#L1107) | } else { |
| [1108](#L1108) | $position\_arr = array\_keys($value['output\_zone'], $output\_zone); //array position of this sl\_dyn\_js output\_zone, if an array |
| [1109](#L1109) | foreach ($position\_arr as $pos\_value) { |
| [1110](#L1110) | $the\_field = $value['field\_name'][$pos\_value]; |
| [1111](#L1111) | $$the\_field = (trim($sl\_vars[$the\_field]) != "")? sl\_parseToXML($sl\_vars[$the\_field]) : $value['default'][$pos\_value]; |
| [1112](#L1112) | } |
| [1113](#L1113) | } |
| [1114](#L1114) | } |
| [1115](#L1115) | } |
| [1116](#L1116) | } |
| [1117](#L1117) | function sl\_dyn\_js($post\_content=""){ |
| [1118](#L1118) | global $sl\_dir, $sl\_base, $sl\_uploads\_base, $sl\_path, $sl\_uploads\_path, $wpdb, $sl\_version, $pagename, $sl\_map\_language, $post, $sl\_vars; |
| [1119](#L1119) | print "<script type=\"text/javascript\">\n/\*<![CDATA[\*/\nvar sl\_siteurl='".SL\_SITEURL."';\nvar sl\_base='".SL\_BASE."';\n".$sl\_vars['jfxn']; |
| [1120](#L1120) | if (!empty($\_GET['admin']) && $\_GET['admin']==1){ print "\n/\*]]>\*/\n</script>\n"; return; } |
| [1121](#L1121) |  |
| [1122](#L1122) | include(SL\_INCLUDES\_PATH."/mapdesigner-options.php"); |
| [1123](#L1123) |  |
| [1124](#L1124) | $GLOBALS['output\_zone\_type'] = 'sl\_dyn\_js'; |
| [1125](#L1125) | $output\_arr = array\_filter($sl\_mdo, "filter\_sl\_mdo"); |
| [1126](#L1126) | unset($GLOBALS['output\_zone\_type']); |
| [1127](#L1127) | unset($sl\_mdo); |
| [1128](#L1128) |  |
| [1129](#L1129) | //var\_dump($output\_arr); die(); |
| [1130](#L1130) |  |
| [1131](#L1131) | foreach ($output\_arr as $value) { |
| [1132](#L1132) | if (isset($value['output\_zone'])) { |
| [1133](#L1133) | if (!is\_array($value['output\_zone'])) { |
| [1134](#L1134) | $the\_field = $value['field\_name']; |
| [1135](#L1135) | $$the\_field = (trim($sl\_vars[$the\_field]) != "")? $sl\_vars[$the\_field] : $value['default']; |
| [1136](#L1136) | //print "//Field: ".$the\_field; |
| [1137](#L1137) | //print " | label?: ".preg\_match("@\\_label$@", $the\_field); |
| [1138](#L1138) | //print " | message?: ".preg\_match("@\\_message$@", $the\_field)."\n"; |
| [1139](#L1139) | if (preg\_match("@\\_label$@", $the\_field)) { |
| [1140](#L1140) | $$the\_field = addslashes($$the\_field); //originally parseToXML(); now stripslashes is applied in MD (since v3.56.2) |
| [1141](#L1141) | } elseif (preg\_match("@\\_message$@", $the\_field)) { |
| [1142](#L1142) | $$the\_field = addslashes($$the\_field); |
| [1143](#L1143) | } |
| [1144](#L1144) | } else { |
| [1145](#L1145) | $position\_arr = array\_keys($value['output\_zone'], 'sl\_dyn\_js'); //array position of this sl\_dyn\_js output\_zone, if an array |
| [1146](#L1146) | foreach ($position\_arr as $pos\_value) { |
| [1147](#L1147) | $the\_field = $value['field\_name'][$pos\_value]; |
| [1148](#L1148) | $$the\_field = (trim($sl\_vars[$the\_field]) != "")? $sl\_vars[$the\_field] : $value['default'][$pos\_value]; |
| [1149](#L1149) | if (preg\_match("@\\_label$@", $the\_field)) { |
| [1150](#L1150) | $$the\_field = addslashes($$the\_field); |
| [1151](#L1151) | } elseif (preg\_match("@\\_message$@", $the\_field)) { |
| [1152](#L1152) | $$the\_field = addslashes($$the\_field); |
| [1153](#L1153) | } |
| [1154](#L1154) | } |
| [1155](#L1155) | } |
| [1156](#L1156) | } |
| [1157](#L1157) | } |
| [1158](#L1158) |  |
| [1159](#L1159) | ## MapDesigner header row inputs |
| [1160](#L1160) | $gmc=(trim($sl\_vars['google\_map\_country'])!="")? sl\_parseToXML($sl\_vars['google\_map\_country']) : "United States" ; |
| [1161](#L1161) | $gmd=(trim($sl\_vars['google\_map\_domain'])!="")? $sl\_vars['google\_map\_domain'] : "maps.google.com" ; |
| [1162](#L1162) |  |
| [1163](#L1163) |  |
| [1164](#L1164) | //WPML Display Integration |
| [1165](#L1165) | //if (function\_exists('icl\_t')) { |
| [1166](#L1166) | ob\_start(); |
| [1167](#L1167) | include(SL\_INCLUDES\_PATH."/mapdesigner-options.php"); |
| [1168](#L1168) | ob\_end\_clean(); //elimating any output that could disrupt dynamic js |
| [1169](#L1169) | $GLOBALS['input\_zone\_type'] = 'labels'; |
| [1170](#L1170) | $GLOBALS['output\_zone\_type'] = 'sl\_dyn\_js'; |
| [1171](#L1171) |  |
| [1172](#L1172) | $labels\_arr = array\_filter($sl\_mdo, "filter\_sl\_mdo"); |
| [1173](#L1173) | unset($GLOBALS['input\_zone\_type']); unset($GLOBALS['output\_zone\_type']); |
| [1174](#L1174) | unset($sl\_mdo); |
| [1175](#L1175) | //var\_dump($labels\_arr); die(); |
| [1176](#L1176) |  |
| [1177](#L1177) | foreach ($labels\_arr as $value) { |
| [1178](#L1178) | $the\_field = $value['field\_name']; |
| [1179](#L1179) | $$the\_field = addslashes(apply\_filters("wpml\_translate\_single\_string", $$the\_field, SL\_DIR, $value['label'])); |
| [1180](#L1180) | } |
| [1181](#L1181) | //} |
| [1182](#L1182) | //End WPML |
| [1183](#L1183) |  |
| [1184](#L1184) | //Polylang Display Integration |
| [1185](#L1185) | if (function\_exists('pll\_\_')) { |
| [1186](#L1186) | //ob\_start(); |
| [1187](#L1187) | //include(SL\_INCLUDES\_PATH."/mapdesigner-options.php"); |
| [1188](#L1188) | //ob\_end\_clean(); //elimating any output that could disrupt dynamic js |
| [1189](#L1189) | //$GLOBALS['input\_zone\_type'] = 'labels'; |
| [1190](#L1190) | //$GLOBALS['output\_zone\_type'] = 'sl\_dyn\_js'; |
| [1191](#L1191) |  |
| [1192](#L1192) | //$labels\_arr = array\_filter($sl\_mdo, "filter\_sl\_mdo"); |
| [1193](#L1193) | //unset($GLOBALS['input\_zone\_type']); unset($GLOBALS['output\_zone\_type']); |
| [1194](#L1194) | //unset($sl\_mdo); |
| [1195](#L1195) | //var\_dump($labels\_arr); die(); |
| [1196](#L1196) |  |
| [1197](#L1197) | foreach ($labels\_arr as $value) { |
| [1198](#L1198) | $the\_field = $value['field\_name']; |
| [1199](#L1199) | $$the\_field = addslashes(pll\_\_($$the\_field)); |
| [1200](#L1200) | } |
| [1201](#L1201) | } |
| [1202](#L1202) | //End Polylang |
| [1203](#L1203) |  |
| [1204](#L1204) | print |
| [1205](#L1205) | "\nvar sl\_base='".SL\_BASE."'; |
| [1206](#L1206) | var sl\_uploads\_base='".SL\_UPLOADS\_BASE."'; |
| [1207](#L1207) | var sl\_addons\_base=sl\_uploads\_base+'".str\_replace(SL\_UPLOADS\_BASE, '', SL\_ADDONS\_BASE)."'; |
| [1208](#L1208) | var sl\_includes\_base=sl\_base+'".str\_replace(SL\_BASE, '', SL\_INCLUDES\_BASE)."'; |
| [1209](#L1209) | var sl\_google\_map\_country='".esc\_attr($gmc)."'; |
| [1210](#L1210) | var sl\_google\_map\_domain='".esc\_attr($gmd)."';\n"; |
| [1211](#L1211) |  |
| [1212](#L1212) | $icon\_array = array('icon' => 'map\_home\_icon', 'icon2' => 'map\_end\_icon'); |
| [1213](#L1213) | $without\_quotes = array('map\_type', 'zoom\_level'); //Google map type, zoom level can't have quotes around theme |
| [1214](#L1214) |  |
| [1215](#L1215) | foreach ($output\_arr as $value) { |
| [1216](#L1216) | if (isset($value['output\_zone'])) { |
| [1217](#L1217) | if (!is\_array($value['output\_zone'])) { |
| [1218](#L1218) | $the\_field = $value['field\_name']; |
| [1219](#L1219) | $$the\_field = (!in\_array($the\_field, $without\_quotes))? "'{$$the\_field}'" : $$the\_field ; |
| [1220](#L1220) | if ( in\_array($the\_field, array\_keys($icon\_array)) ) { //if-else needed due to inconsistency between 'icon'/'map\_home\_icon', etc labels |
| [1221](#L1221) | $the\_field\_converted = $icon\_array[$the\_field]; |
| [1222](#L1222) | print "var sl\_{$the\_field\_converted}=". $$the\_field .";\n"; |
| [1223](#L1223) | } elseif (is\_array($$the\_field) && $the\_field == "map\_type") { #v3.98.9 - 12/29/23 - new clause since 'map\_type' var is an array |
| [1224](#L1224) | //var\_dump($$the\_field); |
| [1225](#L1225) | print "var sl\_{$the\_field}=". $sl\_vars[$the\_field] .";\n"; |
| [1226](#L1226) | } else { |
| [1227](#L1227) | print "var sl\_{$the\_field}=". $$the\_field .";\n"; |
| [1228](#L1228) | } |
| [1229](#L1229) | } else { |
| [1230](#L1230) | $position\_arr = array\_keys($value['output\_zone'], 'sl\_dyn\_js'); //array position of this sl\_dyn\_js output\_zone, if an array |
| [1231](#L1231) | foreach ($position\_arr as $pos\_value) { |
| [1232](#L1232) | $the\_field = $value['field\_name'][$pos\_value]; |
| [1233](#L1233) | $$the\_field = (!in\_array($the\_field, $without\_quotes))? "'{$$the\_field}'" : $$the\_field ; |
| [1234](#L1234) | if ( in\_array($the\_field, array\_keys($icon\_array)) ) { |
| [1235](#L1235) | $the\_field\_converted = $icon\_array[$the\_field]; |
| [1236](#L1236) | print "var sl\_{$the\_field\_converted}=". $$the\_field .";\n"; |
| [1237](#L1237) | } else { |
| [1238](#L1238) | print "var sl\_{$the\_field}=". $$the\_field .";\n"; |
| [1239](#L1239) | } |
| [1240](#L1240) | } |
| [1241](#L1241) | } |
| [1242](#L1242) | } |
| [1243](#L1243) | } |
| [1244](#L1244) |  |
| [1245](#L1245) | print ((!function\_exists("do\_sl\_hook"))?$sl\_vars['jsl']:"")."\n/\*]]>\*/\n</script>\n"; |
| [1246](#L1246) | if (function\_exists("do\_sl\_hook")){do\_sl\_hook('sl\_addon\_head\_scripts'); } |
| [1247](#L1247) | if (function\_exists("do\_sl\_hook")){ |
| [1248](#L1248) | print "<script>\n/\*<![CDATA[\*/\n"; |
| [1249](#L1249) | sl\_js\_hooks(); |
| [1250](#L1250) | print "\n".$sl\_vars['jsl']."\n/\*]]>\*/\n</script>\n"; |
| [1251](#L1251) | } |
| [1252](#L1252) | } |
| [1253](#L1253) |  |
| [1254](#L1254) | function sl\_js\_out($buff) { |
| [1255](#L1255) | preg\_match("@\/\\*sl\-dyn\-js\-start\\*\/.\*\/\\*sl\-dyn\-js\-end\\*\/@s", $buff, $the\_js); |
| [1256](#L1256) | $the\_js[0]=preg\_replace("@<script([^>]\*)?src=('|\")?([A-Za-z0-9\.\ \\_\:\/-]\*)('|\")?([^>]\*)?>(\r)?(\n)?@s", "jQuery.getScript(\"\\3\");\n", $the\_js[0]); |
| [1257](#L1257) | $the\_js[0]=preg\_replace("@<\/script>(\r)?(\n)?@s", "", $the\_js[0]); |
| [1258](#L1258) | $the\_js[0]=preg\_replace("@<script[^>]\*>(\r)?(\n)?@s", "", $the\_js[0]); |
| [1259](#L1259) | $the\_js[0]=preg\_replace("@\/\\*[^(\\*\/)]\*\\*\/@s", "", $the\_js[0]); |
| [1260](#L1260) | //$the\_js[0]=preg\_replace("@[^http(s)?:]\/\/[^(\r|\n)]\*@s", "", $the\_js[0]); |
| [1261](#L1261) | foreach (token\_get\_all($the\_js[0]) as $token ) { |
| [1262](#L1262) | if ($token[0] != T\_COMMENT || preg\_match("@\/\/[A-Za-z]+[ ]\*\)@",$token[1]) ) { |
| [1263](#L1263) | //not a comment or not a js regex match with modifier using '//i', for example |
| [1264](#L1264) | continue; |
| [1265](#L1265) | } |
| [1266](#L1266) | //print\_r($token); |
| [1267](#L1267) | $the\_js[0] = str\_replace($token[1], '', $the\_js[0]); |
| [1268](#L1268) | } |
| [1269](#L1269) | $the\_js[0]=str\_replace(")\n", ");\n", $the\_js[0]); |
| [1270](#L1270) | $the\_js[0]=(!empty($\_GET['debug']) && $\_GET['debug']==1)? $the\_js[0] : preg\_replace("@\r|\n|\t|[[:space:]]{2,}@s","",$the\_js[0]); #v3.98.9: empty clause; #v3.98.9 - 12/29/23 reversed empty clause to check that debug is not empty + '&&' operator, instead of whether debug was empty + '||' operator -- helped avoid 'debug undefined' warning msgs |
| [1271](#L1271) | $the\_js[0]=preg\_replace("@\(\)([a-z])@s","();\\1",$the\_js[0]); |
| [1272](#L1272) | $the\_js[0]=preg\_replace("@\<\?php@", "", $the\_js[0]); |
| [1273](#L1273) | $the\_js[0]=preg\_replace("@\?\>@", "", $the\_js[0]); |
| [1274](#L1274) | return $the\_js[0]; |
| [1275](#L1275) | } |
| [1276](#L1276) | if (!function\_exists('js\_out')){ |
| [1277](#L1277) | //2/26/19 - v3.98.4 |
| [1278](#L1278) | function js\_out($buff) { |
| [1279](#L1279) | return sl\_js\_out($buff); |
| [1280](#L1280) | } |
| [1281](#L1281) | } |
| [1282](#L1282) | /\*---------------------------------------\*/ |
| [1283](#L1283) | function sl\_location\_form($mode="add", $pre\_html="", $post\_html=""){ |
| [1284](#L1284) | $html="<form name='manualAddForm' method='post'> |
| [1285](#L1285) | $pre\_html |
| [1286](#L1286) | <table cellpadding='0' class='widefat'> |
| [1287](#L1287) | <thead><tr><th>".\_\_("Type&nbsp;Address", "store-locator")."</th></tr></thead> |
| [1288](#L1288) | <tr> |
| [1289](#L1289) | <td> |
| [1290](#L1290) | <div style='display:inline; width:50%'> |
| [1291](#L1291) | <b>".\_\_("The General Address Format", "store-locator").": </b>(<a href=\"#\" onclick=\"show('format'); return false;\">".\_\_("show/hide", "store-locator")."</a>) |
| [1292](#L1292) | <span id='format' style='display:none'><br><i>".\_\_("Name of Location", "store-locator")."<br> |
| [1293](#L1293) | ".\_\_("Address (Street - Line1)", "store-locator")."<br> |
| [1294](#L1294) | ".\_\_("Address (Street - Line2 - optional)", "store-locator")."<br> |
| [1295](#L1295) | ".\_\_("City, State Zip", "store-locator")."</i></span><br><hr> |
| [1296](#L1296) | ".\_\_("Name of Location", "store-locator")."<br><input name='sl\_store' size=45><br><br> |
| [1297](#L1297) | ".\_\_("Address", "store-locator")."<br><input name='sl\_address' size=21>&nbsp;<small>(".\_\_("Street - Line1", "store-locator").")</small><br> |
| [1298](#L1298) | <input name='sl\_address2' size=21>&nbsp;<small>(".\_\_("Street - Line 2 - optional", "store-locator").")</small><br> |
| [1299](#L1299) | <table cellpadding='0px' cellspacing='0px' style='width:200px'><tr><td style='padding-left:0px' class='nobottom'><input name='sl\_city' size='21'><br><small>".\_\_("City", "store-locator")."</small></td> |
| [1300](#L1300) | <td><input name='sl\_state' size='7'><br><small>".\_\_("State", "store-locator")."</small></td> |
| [1301](#L1301) | <td><input name='sl\_zip' size='10'><br><small>".\_\_("Zip", "store-locator")."</small></td></tr></table><br> |
| [1302](#L1302) | </div><div style='display:inline; width:50%'> |
| [1303](#L1303) | ".\_\_("Additional Information", "store-locator")."<br> |
| [1304](#L1304) | <textarea name='sl\_description' rows='5' cols='18'></textarea>&nbsp;&nbsp;<small>".\_\_("Description", "store-locator")."</small><br> |
| [1305](#L1305) | <input name='sl\_tags'>&nbsp;<small>".\_\_("Tags (seperate with commas)", "store-locator")."</small><br> |
| [1306](#L1306) | <input name='sl\_url'>&nbsp;<small>".\_\_("URL", "store-locator")."</small><br> |
| [1307](#L1307) | <textarea name='sl\_hours' rows='1' cols='18'></textarea>&nbsp;&nbsp;<small>".\_\_("Hours", "store-locator")."</small><br> |
| [1308](#L1308) | <input name='sl\_phone'>&nbsp;<small>".\_\_("Phone", "store-locator")."</small><br> |
| [1309](#L1309) | <input name='sl\_fax'>&nbsp;<small>".\_\_("Fax", "store-locator")."</small><br> |
| [1310](#L1310) | <input name='sl\_email'>&nbsp;<small>".\_\_("Email", "store-locator")."</small><br> |
| [1311](#L1311) | <input name='sl\_image'>&nbsp;<small>".\_\_("Image URL (shown with location)", "store-locator")."</small>"; |
| [1312](#L1312) |  |
| [1313](#L1313) | $html.=(function\_exists("do\_sl\_hook"))? do\_sl\_hook("sl\_add\_location\_fields",  "append-return") : "" ; |
| [1314](#L1314) | $html.=wp\_nonce\_field("add-location\_single", "\_wpnonce", true, false); |
| [1315](#L1315) | $html.="<br><br> |
| [1316](#L1316) | <input type='submit' value='".\_\_("Add Location", "store-locator")."' class='button-primary'> |
| [1317](#L1317) | </div> |
| [1318](#L1318) | </td> |
| [1319](#L1319) | </tr> |
| [1320](#L1320) | </table> |
| [1321](#L1321) | $post\_html |
| [1322](#L1322) | </form>"; |
| [1323](#L1323) | return $html; |
| [1324](#L1324) | } |
| [1325](#L1325) | function sl\_add\_location() { |
| [1326](#L1326) | global $wpdb; |
| [1327](#L1327) | $fieldList=""; $valueList=""; |
| [1328](#L1328) | foreach ($\_POST as $key=>$value) { |
| [1329](#L1329) | if (preg\_match("@sl\_@", $key)) { |
| [1330](#L1330) | if ($key=="sl\_tags") { |
| [1331](#L1331) | $value=sl\_prepare\_tag\_string($value); |
| [1332](#L1332) | } |
| [1333](#L1333) | $fieldList.="$key,"; |
| [1334](#L1334) |  |
| [1335](#L1335) | if (is\_array($value)){ |
| [1336](#L1336) | $value=serialize($value); //for arrays being submitted |
| [1337](#L1337) | $valueList.="'$value',"; |
| [1338](#L1338) | //$field\_value\_str.=$key."='$value',"; |
| [1339](#L1339) | } else { |
| [1340](#L1340) | $valueList.=$wpdb->prepare("%s", sl\_comma(stripslashes($value))).","; |
| [1341](#L1341) | //$field\_value\_str.=$key."=".$wpdb->prepare("%s", trim(sl\_comma(stripslashes($value)))).", "; |
| [1342](#L1342) | } |
| [1343](#L1343) | } |
| [1344](#L1344) | } |
| [1345](#L1345) | $fieldList=substr($fieldList, 0, strlen($fieldList)-1); |
| [1346](#L1346) | $valueList=substr($valueList, 0, strlen($valueList)-1); |
| [1347](#L1347) | $wpdb->query("INSERT INTO ".SL\_TABLE." ($fieldList) VALUES ($valueList)"); |
| [1348](#L1348) | $new\_loc\_id=$wpdb->insert\_id; |
| [1349](#L1349) | $address=sanitize\_text\_field("$\_POST[sl\_address], $\_POST[sl\_address2], $\_POST[sl\_city], $\_POST[sl\_state] $\_POST[sl\_zip]"); |
| [1350](#L1350) | sl\_do\_geocoding($address); |
| [1351](#L1351) | if (!empty($\_POST['sl\_tags'])){ |
| [1352](#L1352) | sl\_process\_tags(sanitize\_text\_field($\_POST['sl\_tags']), "insert", $new\_loc\_id); |
| [1353](#L1353) | } |
| [1354](#L1354) | } |
| [1355](#L1355) | /\*--------------------------------------------------\*/ |
| [1356](#L1356) | function sl\_define\_db\_tables() { |
| [1357](#L1357) | //since it can't use sl\_data() in the sl-define.php, placed here |
| [1358](#L1358) | //$sl\_db\_prefix = get\_option('sl\_db\_prefix'); |
| [1359](#L1359) | global $wpdb; |
| [1360](#L1360) | $sl\_db\_prefix = $wpdb->prefix; //better this way, in case prefix changes vs storing option - 1/29/15 |
| [1361](#L1361) | if (!defined('SL\_DB\_PREFIX')){ define('SL\_DB\_PREFIX', $sl\_db\_prefix); } |
| [1362](#L1362) | if (!empty($sl\_db\_prefix)) { |
| [1363](#L1363) | if (!defined('SL\_TABLE')){ define('SL\_TABLE', SL\_DB\_PREFIX."store\_locator"); } |
| [1364](#L1364) | if (!defined('SL\_TAG\_TABLE')){ define('SL\_TAG\_TABLE', SL\_DB\_PREFIX."sl\_tag"); } |
| [1365](#L1365) | if (!defined('SL\_SETTING\_TABLE')){ define('SL\_SETTING\_TABLE', SL\_DB\_PREFIX."sl\_setting"); } |
| [1366](#L1366) | } |
| [1367](#L1367) | } |
| [1368](#L1368) | sl\_define\_db\_tables(); |
| [1369](#L1369) | /\*----------------------------------------------------\*/ |
| [1370](#L1370) | function sl\_single\_location\_info($value, $colspan, $bgcol\_class) { |
| [1371](#L1371) | global $sl\_hooks; |
| [1372](#L1372) | $\_GET['edit'] = $value['sl\_id']; //die("edit: ".var\_dump($\_GET)); die(); |
| [1373](#L1373) |  |
| [1374](#L1374) | print "<tr class='$bgcol\_class' id='sl\_tr\_data-$value[sl\_id]'>"; |
| [1375](#L1375) |  |
| [1376](#L1376) | print "<td colspan='$colspan'><form name='manualAddForm' method='post'> |
| [1377](#L1377) | <a name='a$value[sl\_id]'></a> |
| [1378](#L1378) | <table cellpadding='0' class='manual\_update\_table'> |
| [1379](#L1379) | <tr> |
| [1380](#L1380) | <td style='vertical-align:top !important; width:20%'><b>".\_\_("Name of Location", "store-locator")."</b><br><input name='sl\_store-$value[sl\_id]' id='sl\_store-$value[sl\_id]' value='$value[sl\_store]' size=30><br><br> |
| [1381](#L1381) | <b>".\_\_("Address", "store-locator")."</b><br><input name='sl\_address-$value[sl\_id]' id='sl\_address-$value[sl\_id]' value='$value[sl\_address]' size='13'>&nbsp;<small>(".\_\_("Street - Line1", "store-locator").")</small><br> |
| [1382](#L1382) | <input name='sl\_address2-$value[sl\_id]' id='sl\_address2-$value[sl\_id]' value='$value[sl\_address2]' size='13'>&nbsp;<small>(".\_\_("Street - Line 2 - optional", "store-locator").")</small><br> |
| [1383](#L1383) | <table cellpadding='0px' cellspacing='0px' style='width:200px'><tr><td style='padding-left:0px' class='nobottom'><input name='sl\_city-$value[sl\_id]' id='sl\_city-$value[sl\_id]' value='$value[sl\_city]' size='13'><br><small>".\_\_("City", "store-locator")."</small></td> |
| [1384](#L1384) | <td><input name='sl\_state-$value[sl\_id]' id='sl\_state-$value[sl\_id]' value='$value[sl\_state]' size='4'><br><small>".\_\_("State", "store-locator")."</small></td> |
| [1385](#L1385) | <td><input name='sl\_zip-$value[sl\_id]' id='sl\_zip-$value[sl\_id]' value='$value[sl\_zip]' size='6'><br><small>".\_\_("Zip", "store-locator")."</small></td></tr></table>"; |
| [1386](#L1386) |  |
| [1387](#L1387) | if (function\_exists("do\_sl\_hook")) { |
| [1388](#L1388) | sl\_show\_custom\_fields(); |
| [1389](#L1389) | } |
| [1390](#L1390) |  |
| [1391](#L1391) | $cancel\_onclick = "location.href=\"".wp\_sanitize\_redirect(str\_replace("&edit=$\_GET[edit]", "",$\_SERVER['REQUEST\_URI']))."\""; |
| [1392](#L1392) | print "<br><br> |
| [1393](#L1393) | <nobr><input type='submit' value='".\_\_("Update", "store-locator")."' class='button-primary'><input type='button' class='button' value='".\_\_("Cancel", "store-locator")."' onclick='$cancel\_onclick'></nobr> |
| [1394](#L1394) | </td><td style='width:40%; vertical-align:top !important;'> |
| [1395](#L1395) | <b>".\_\_("Additional Information", "store-locator")."</b><br> |
| [1396](#L1396) | <textarea name='sl\_description-$value[sl\_id]' id='sl\_description-$value[sl\_id]' rows='5' cols='18'>$value[sl\_description]</textarea>&nbsp;&nbsp;<small>".\_\_("Description", "store-locator")."</small><br> |
| [1397](#L1397) | <input name='sl\_tags-$value[sl\_id]' id='sl\_tags-$value[sl\_id]' value='$value[sl\_tags]' >&nbsp;<small>".\_\_("Tags (seperate with commas)", "store-locator")."</small><br> |
| [1398](#L1398) | <input name='sl\_url-$value[sl\_id]' id='sl\_url-$value[sl\_id]' value='$value[sl\_url]' >&nbsp;<small>".\_\_("URL", "store-locator")."</small><br> |
| [1399](#L1399) | <textarea name='sl\_hours-$value[sl\_id]' id='sl\_hours-$value[sl\_id]' rows='1' cols='18'>$value[sl\_hours]</textarea>&nbsp;&nbsp;<small>".\_\_("Hours", "store-locator")."</small><br> |
| [1400](#L1400) | <input name='sl\_phone-$value[sl\_id]' id='sl\_phone-$value[sl\_id]' value='$value[sl\_phone]' >&nbsp;<small>".\_\_("Phone", "store-locator")."</small><br> |
| [1401](#L1401) | <input name='sl\_fax-$value[sl\_id]' id='sl\_fax-$value[sl\_id]' value='$value[sl\_fax]' >&nbsp;<small>".\_\_("Fax", "store-locator")."</small><br> |
| [1402](#L1402) | <input name='sl\_email-$value[sl\_id]' id='sl\_email-$value[sl\_id]' value='$value[sl\_email]' >&nbsp;<small>".\_\_("Email", "store-locator")."</small><br> |
| [1403](#L1403) | <input name='sl\_image-$value[sl\_id]' id='sl\_image-$value[sl\_id]' value='$value[sl\_image]' >&nbsp;<small>".\_\_("Image URL (shown with location)", "store-locator")."</small>"; |
| [1404](#L1404) |  |
| [1405](#L1405) | print "</td><td style='vertical-align:top !important; width:40%'>"; |
| [1406](#L1406) | if (function\_exists("do\_sl\_hook")) {do\_sl\_hook("sl\_single\_location\_edit", "select-top");} |
| [1407](#L1407) | print "</td></tr> |
| [1408](#L1408) | </table> |
| [1409](#L1409) | </form></td>"; |
| [1410](#L1410) |  |
| [1411](#L1411) | print "</tr>"; |
| [1412](#L1412) | } |
| [1413](#L1413) | /\*-------------------------------------------\*/ |
| [1414](#L1414) | function sl\_module($mod\_name, $mod\_heading="", $height="") { |
| [1415](#L1415) | global $sl\_vars, $wpdb; |
| [1416](#L1416) | if (file\_exists(SL\_INCLUDES\_PATH."/module-{$mod\_name}.php")) { |
| [1417](#L1417) | $css=(!empty($height))? "height:$height;" : "" ; |
| [1418](#L1418) | print "<table class='widefat' style='background-color:transparent; border:0px; padding:4px; {$css}'>"; |
| [1419](#L1419) | if ($mod\_heading){ |
| [1420](#L1420) | print "<thead><tr><th style='font-weight:bold; height:22px;'>$mod\_heading</th></tr></thead>"; |
| [1421](#L1421) | } |
| [1422](#L1422) | print "<tbody style='background-color:transparent; border:0px;'><tr><td style='background-color:transparent; border:0px;'>"; |
| [1423](#L1423) | include(SL\_INCLUDES\_PATH."/module-{$mod\_name}.php"); |
| [1424](#L1424) | print "</td></tr></tbody></table><br>"; |
| [1425](#L1425) | } |
| [1426](#L1426) | } |
| [1427](#L1427) | /\*--------------------------------------------\*/ |
| [1428](#L1428) | function sl\_env\_var\_filt($arr\_val) { |
| [1429](#L1429) | return !is\_array($arr\_val) && !(preg\_match("@time|start|function|hide|weeks?|months?|".SL\_VERSION."@", $arr\_val) || preg\_match("/^(((\d{4})(-)(0[13578]|10|12)(-)(0[1-9]|[12][0-9]|3[01]))|((\d{4})(-)(0[469]|1‌​1)(-)([0][1-9]|[12][0-9]|30))|((\d{4})(-)(02)(-)(0[1-9]|1[0-9]|2[0-8]))|(([02468]‌​[048]00)(-)(02)(-)(29))|(([13579][26]00)(-)(02)(-)(29))|(([0-9][0-9][0][48])(-)(0‌​2)(-)(29))|(([0-9][0-9][2468][048])(-)(02)(-)(29))|(([0-9][0-9][13579][26])(-)(02‌​)(-)(29)))(\s([0-1][0-9]|2[0-4]):([0-5][0-9]):([0-5][0-9]))$/", $arr\_val)); |
| [1430](#L1430) | //4/15/17 - added "!is\_array($array\_val)" clause since storing wp api json array data, but preg\_match doesn't take arrays |
| [1431](#L1431) | } |
| [1432](#L1432) |  |
| [1433](#L1433) | function sl\_readme\_parse($path\_to\_readme, $path\_to\_env=""){ |
| [1434](#L1434) | //include($path\_to\_env); |
| [1435](#L1435) | //print "<span style='font-size:14px; font-family:Helvetica'>"; |
| [1436](#L1436) | ob\_start(); |
| [1437](#L1437) | include($path\_to\_readme); |
| [1438](#L1438) | $txt=ob\_get\_contents(); |
| [1439](#L1439) | ob\_clean(); |
| [1440](#L1440) |  |
| [1441](#L1441) | //TOC pt.1 |
| [1442](#L1442) | $toc=$txt; |
| [1443](#L1443) | preg\_match\_all("@\=\=\=[ ]([^\=\=\=]+)[ ]\=\=\=@", $toc, $toc\_match\_0); |
| [1444](#L1444) | preg\_match\_all("@\=\=[ ]([^\=\=]+)[ ]\=\=@", $toc, $toc\_match\_1); //var\_dump($toc\_match\_1); die(); |
| [1445](#L1445) | preg\_match\_all("@\=[ ]([^\=]+)[ ]\=@", $toc, $toc\_match\_2); //var\_dump($toc\_match\_2); die(); |
| [1446](#L1446) | $toc\_cont=""; |
| [1447](#L1447) | foreach ($toc\_match\_2[1] as $heading) { |
| [1448](#L1448) | if (!in\_array($heading, $toc\_match\_1[1]) && !in\_array($heading, $toc\_match\_0[1]) && !preg\_match("@^[0-9]+\.[0-9]+@", $heading)) { |
| [1449](#L1449) | $toc\_cont.="<li style='margin-left:30px; list-style-type:circle'><a href='#".sl\_comma($heading)."' style='text-decoration:none'>$heading</a></li></li>"; |
| [1450](#L1450) | } elseif (!in\_array($heading, $toc\_match\_0[1]) && !preg\_match("@^[0-9]+\.[0-9]+@", $heading)) { |
| [1451](#L1451) | //!preg\_match("@^[0-9]+\.[0-9]+@", $heading) prevents changelog numbers from showing up |
| [1452](#L1452) | $toc\_cont.="<li style='margin-left:15px; list-style-type:disc'><b><a href='#".sl\_comma($heading)."' style='text-decoration:none'>$heading</a></b></li>"; |
| [1453](#L1453) | } |
| [1454](#L1454) | } |
| [1455](#L1455) |  |
| [1456](#L1456) | //parsing |
| [1457](#L1457) | $th\_start="<th style='font-size:125%; font-weight:bold;'>"; |
| [1458](#L1458) | $h2\_start="<h2 style='font-family:Georgia; margin-bottom:0.05em;'>"; |
| [1459](#L1459) | $h3\_start="<h3 style='font-family:Georgia; margin-bottom:0.05em; margin-top:0.3em'>"; |
| [1460](#L1460) | $txt=str\_replace("=== ", "$h2\_start", $txt); |
| [1461](#L1461) | $txt=str\_replace(" ===", "</h2>", $txt); |
| [1462](#L1462) | //$txt=str\_replace("== ", "<div id='wphead' style='color:black; background: -moz-linear-gradient(center bottom, #D7D7D7, #E4E4E4) repeat scroll 0 0 transparent'><h1 id='site-heading'><span id='site-title'>", $txt); |
| [1463](#L1463) | $txt=str\_replace("== ", "<table class='widefat' ><thead>$th\_start", $txt); |
| [1464](#L1464) | $txt=str\_replace(" ==", "</th></thead></table><!--a style='float:right' href='#readme\_toc'>Table of Contents</a-->", $txt); |
| [1465](#L1465) | $txt=str\_replace("= ", "$h3\_start", $txt); |
| [1466](#L1466) | $txt=str\_replace(" =", "</h3><a style='float:right; position:relative; top:-1.5em; font-size:10px' href='#readme\_toc'>".\_\_("table of contents", "store-locator")."</a>", $txt); |
| [1467](#L1467) | $txt=preg\_replace("@Tags:[ ]?[^\r\n]+\r\n@", "", $txt); |
| [1468](#L1468) |  |
| [1469](#L1469) | //TOC pt. 2 |
| [1470](#L1470) | $txt=str\_replace("</h2>", "</h2><a name='readme\_toc'></a><div style='float:right;  width:500px; border-radius:1em; border:solid silver 1px; padding:7px; padding-top:0px; margin:10px; margin-right:0px;'><h3>".\_\_("Table of Contents", "store-locator")."</h2>$toc\_cont</div>", $txt); |
| [1471](#L1471) | $txt=preg\_replace\_callback("@$h2\_start<u>([^<.]\*)</u></h1>@s", function($matches) { |
| [1472](#L1472) | return "<h2 style='font-family:Georgia; margin-bottom:0.05em;'><a name='".sl\_comma($matches[1])."'></a>$matches[1]</u></h1>"; }, $txt); |
| [1473](#L1473) | $txt=preg\_replace\_callback("@$th\_start([^<.]\*)</th>@s", function($matches) { |
| [1474](#L1474) | return "<th style='font-size:125%; font-weight:bold;'><a name='".sl\_comma($matches[1])."'></a>$matches[1]</th>"; }, $txt); |
| [1475](#L1475) | $txt=preg\_replace\_callback("@$h3\_start( )\*([^<.]\*)( )\*</h3>@s", function($matches) { |
| [1476](#L1476) | return "<h3 style='font-family:Georgia; margin-bottom:0.05em; margin-top:0.3em'><a name=\"".sl\_comma($matches[2])."\"></a>{$matches[1]}$matches[2]</h3>"; }, $txt); |
| [1477](#L1477) |  |
| [1478](#L1478) | //creating hyperlinks on top of labeled URLs (ones preceded w/a label in brackets) |
| [1479](#L1479) | $txt=preg\_replace("@\[([a-zA-Z0-9\_/?&amp;\&\ \.%20,=\-\+\-\']+)\*\]\(([a-zA-Z]+://)(([.]?[a-zA-Z0-9\_/?&amp;%20,=\-\+\-\#]+)\*)\)@s", "<a onclick=\"window.parent.open('\\2'+'\\3');return false;\" href=\"#\">\\1</a>", $txt); |
| [1480](#L1480) |  |
| [1481](#L1481) | //converting asterisked lines into HTML list items |
| [1482](#L1482) | /\*$txt=preg\_replace("@\\*[ ]?[ ]?([a-zA-Z0-9\_/?&amp;\&\ \.%20,=\-\+\-\(\)\{\}\`\'\<\>\"\#\:]+)\*(\r\n)?@s", "<li style='margin-left:15px; margin-bottom:0px;'>\\1</li>", $txt);\*/ |
| [1483](#L1483) | $txt=preg\_replace("@\\*[ ]?[ ]?([^\r\n]+)\*(\r\n)?@s", "<li style='margin-left:15px; margin-bottom:0px;'>\\1</li>", $txt); |
| [1484](#L1484) |  |
| [1485](#L1485) | //additional formatting |
| [1486](#L1486) | $txt=preg\_replace("@`([^`]+)\*`@", "<strong class='sl\_code code' style='padding:2px; border:0px'>\\1</strong>", $txt); |
| [1487](#L1487) | $txt=preg\_replace("@\_\_([^\_\_]+)\_\_@", "<strong>\\1</strong>", $txt); |
| [1488](#L1488) | $txt=preg\_replace("@\r\n([0-9]\.)@", "\r\n&nbsp;&nbsp;&nbsp;\\1", $txt); |
| [1489](#L1489) | $txt=preg\_replace("@([A-Za-z-0-9\/\\&;# ]+): @", "<strong>\\1: </strong>", $txt); |
| [1490](#L1490) |  |
| [1491](#L1491) | //$txt=preg\_replace("@\[(.\*)\]\(([a-zA-Z]+\://[.]?[a-zA-Z0-9\_/?&amp;%20,=-\+-])\*\)@s", "<a href=\"\\2\" target=\_blank>\\1</a>", $txt); |
| [1492](#L1492) |  |
| [1493](#L1493) | //creating hyperlinks out of text URLs (which have 'http:' in the front) |
| [1494](#L1494) | $txt=sl\_do\_hyperlink($txt, "'\_blank'", "protocol"); |
| [1495](#L1495) |  |
| [1496](#L1496) | print nl2br($txt); |
| [1497](#L1497) | //print "</span>"; |
| [1498](#L1498) |  |
| [1499](#L1499) | } |
| [1500](#L1500) | /\*---------------------------------------------------------------\*/ |
| [1501](#L1501) | function sl\_translate\_stamp($dateVar="",$mode="return", $date\_only=0, $abbreviate\_month=0) { |
| [1502](#L1502) | if ($dateVar!="") { |
| [1503](#L1503) | $mm=substr($dateVar,4,2); |
| [1504](#L1504) | $dd=substr($dateVar,6,2); |
| [1505](#L1505) | if ($dd<10) {$dd=str\_replace("0","",$dd); }             $yyyy=substr($dateVar,0,4); |
| [1506](#L1506) | if (strlen($yyyy)==2 && $yyyy>=50) { |
| [1507](#L1507) | $yyyy="19".$yyyy; |
| [1508](#L1508) | } |
| [1509](#L1509) | elseif (strlen($yyyy)==2 && $yyyy>=00 && $yyyy<50) { |
| [1510](#L1510) | $yyyy="20".$yyyy; |
| [1511](#L1511) | } |
| [1512](#L1512) | } |
| [1513](#L1513) | $months=array("January","February","March","April","May","June","July","August","September","October","November","December"); |
| [1514](#L1514) | $dt=""; |
| [1515](#L1515) | if (!empty($mm)) { |
| [1516](#L1516) | $dt=$months[$mm-1]; |
| [1517](#L1517) |  |
| [1518](#L1518) | if ($abbreviate\_month!=0) |
| [1519](#L1519) | $dt=substr($dt,0,3)."."; |
| [1520](#L1520) |  |
| [1521](#L1521) | if ($dd!="" && $yyyy!="") |
| [1522](#L1522) | $dt.=" $dd, $yyyy"; |
| [1523](#L1523) | } |
| [1524](#L1524) |  |
| [1525](#L1525) | if ($date\_only==0) { |
| [1526](#L1526) |  |
| [1527](#L1527) | $hr=substr($dateVar,8,2); |
| [1528](#L1528) | $min=substr($dateVar,10,2); |
| [1529](#L1529) | $sec=substr($dateVar,12,2); |
| [1530](#L1530) |  |
| [1531](#L1531) | if ($hr<12) {$hr=str\_replace("0","",$hr); } |
| [1532](#L1532) | if ($hr>12) {$hr=$hr-12; $suffix="pm";} else {$suffix="am";} |
| [1533](#L1533) | if ($hr==12) {$suffix="pm";} |
| [1534](#L1534) | if ($hr==0) {$hr=12;} |
| [1535](#L1535) |  |
| [1536](#L1536) | $dt.=" $hr:$min:$sec $suffix"; |
| [1537](#L1537) |  |
| [1538](#L1538) | } |
| [1539](#L1539) |  |
| [1540](#L1540) | if ($mode!="print") |
| [1541](#L1541) | return $dt; |
| [1542](#L1542) | elseif ($mode=="print") |
| [1543](#L1543) | print $dt; |
| [1544](#L1544) |  |
| [1545](#L1545) | } |
| [1546](#L1546) | /\*---------------------------------------------------------------\*/ |
| [1547](#L1547) | function sl\_translate\_date($dateVar="",$mode="return") { |
| [1548](#L1548) | if ($dateVar!="") { |
| [1549](#L1549) | $parts=explode("/",$dateVar); |
| [1550](#L1550) | $mm=trim($parts[0]); |
| [1551](#L1551) | $dd=trim($parts[1]); |
| [1552](#L1552) | if ($dd<10) {$dd=str\_replace("0","",$dd); }             $yyyy=trim($parts[2]); |
| [1553](#L1553) | if (strlen($yyyy)==2 && $yyyy>=50) { |
| [1554](#L1554) | $yyyy="19".$yyyy; |
| [1555](#L1555) | } |
| [1556](#L1556) | elseif (strlen($yyyy)==2 && $yyyy>=00 && $yyyy<50) { |
| [1557](#L1557) | $yyyy="20".$yyyy; |
| [1558](#L1558) | } |
| [1559](#L1559) | } |
| [1560](#L1560) | $months=array("January","February","March","April","May","June","July","August","September","October","November","December"); |
| [1561](#L1561) |  |
| [1562](#L1562) | if ($mm!="") { |
| [1563](#L1563) | $dt=$months[$mm-1]; |
| [1564](#L1564) |  |
| [1565](#L1565) | if ($dd!="" && $yyyy!="") |
| [1566](#L1566) | $dt.="&nbsp;$dd,&nbsp;$yyyy"; |
| [1567](#L1567) | } |
| [1568](#L1568) |  |
| [1569](#L1569) | if ($mode=="return") |
| [1570](#L1570) | return $dt; |
| [1571](#L1571) | elseif ($mode=="print") |
| [1572](#L1572) | print $dt; |
| [1573](#L1573) |  |
| [1574](#L1574) | } |
| [1575](#L1575) | /\*-----------------------------------------------\*/ |
| [1576](#L1576) | add\_action('admin\_bar\_menu', 'sl\_admin\_toolbar', 183); |
| [1577](#L1577) | function sl\_admin\_toolbar($admin\_bar){ |
| [1578](#L1578) | if (!current\_user\_can("create\_users")) { //limiting viewing of admin toolbar to admins - v3.87 |
| [1579](#L1579) | return; |
| [1580](#L1580) | } |
| [1581](#L1581) |  |
| [1582](#L1582) | $sl\_admin\_toolbar\_array[] = array( |
| [1583](#L1583) | 'id'    => 'sl-menu', |
| [1584](#L1584) | 'title' => \_\_('Store Locator', "store-locator"), |
| [1585](#L1585) | 'href'  => preg\_replace('@wp-admin\/[^\.]+\.php|index\.php@', 'wp-admin/admin.php', SL\_INFORMATION\_PAGE), |
| [1586](#L1586) | 'meta'  => array( |
| [1587](#L1587) | 'title' => 'LotsOfLocales&trade; - WordPress Store Locator', |
| [1588](#L1588) | ), |
| [1589](#L1589) | ); |
| [1590](#L1590) | $sl\_admin\_toolbar\_array[] = array( |
| [1591](#L1591) | 'id'    => 'sl-menu-news-upgrades', |
| [1592](#L1592) | 'parent' => 'sl-menu', |
| [1593](#L1593) | 'title' => \_\_('News & Upgrades', "store-locator"), |
| [1594](#L1594) | 'href'  => preg\_replace('@wp-admin\/[^\.]+\.php|index\.php@', 'wp-admin/admin.php', SL\_INFORMATION\_PAGE), |
| [1595](#L1595) | 'meta'  => array( |
| [1596](#L1596) | 'title' => \_\_('News & Upgrades', "store-locator"), |
| [1597](#L1597) | 'target' => '\_self', |
| [1598](#L1598) | 'class' => 'sl\_menu\_class' |
| [1599](#L1599) | ), |
| [1600](#L1600) | ); |
| [1601](#L1601) | $sl\_admin\_toolbar\_array[] = array( |
| [1602](#L1602) | 'id'    => 'sl-menu-locations', |
| [1603](#L1603) | 'parent' => 'sl-menu', |
| [1604](#L1604) | 'title' => \_\_('Locations', "store-locator"), |
| [1605](#L1605) | 'href'  => preg\_replace('@wp-admin\/[^\.]+\.php|index\.php@', 'wp-admin/admin.php', SL\_MANAGE\_LOCATIONS\_PAGE), |
| [1606](#L1606) | 'meta'  => array( |
| [1607](#L1607) | 'title' => \_\_('Locations', "store-locator"), |
| [1608](#L1608) | 'target' => '\_self', |
| [1609](#L1609) | 'class' => 'sl\_menu\_class' |
| [1610](#L1610) | ), |
| [1611](#L1611) | ); |
| [1612](#L1612) | $sl\_admin\_toolbar\_array[] = array( |
| [1613](#L1613) | 'id'    => 'sl-menu-mapdesigner', |
| [1614](#L1614) | 'parent' => 'sl-menu', |
| [1615](#L1615) | 'title' => \_\_('Settings', "store-locator"), |
| [1616](#L1616) | 'href'  => preg\_replace('@wp-admin\/[^\.]+\.php|index\.php@', 'wp-admin/admin.php', SL\_MAPDESIGNER\_PAGE), |
| [1617](#L1617) | 'meta'  => array( |
| [1618](#L1618) | 'title' => "MapDesigner ".\_\_('Settings', "store-locator"), |
| [1619](#L1619) | 'target' => '\_self', |
| [1620](#L1620) | 'class' => 'sl\_menu\_class' |
| [1621](#L1621) | ), |
| [1622](#L1622) | ); |
| [1623](#L1623) |  |
| [1624](#L1624) | if (function\_exists('do\_sl\_hook')){ do\_sl\_hook('sl\_admin\_toolbar\_filter', '', array(&$sl\_admin\_toolbar\_array)); } |
| [1625](#L1625) |  |
| [1626](#L1626) | foreach ($sl\_admin\_toolbar\_array as $toolbar\_page) { |
| [1627](#L1627) | $admin\_bar -> add\_menu($toolbar\_page); |
| [1628](#L1628) | } |
| [1629](#L1629) |  |
| [1630](#L1630) | } |
| [1631](#L1631) | /\*---------------------------------------------------------------\*/ |
| [1632](#L1632) | function sl\_permissions\_check() { |
| [1633](#L1633) | global $sl\_vars, $sl\_uploads; |
| [1634](#L1634) |  |
| [1635](#L1635) | if (!empty($\_POST['sl\_folder\_permission'])) { |
| [1636](#L1636) | @array\_map("chmod", sanitize\_text\_field($\_POST['sl\_folder\_permission']), array\_fill(0, count(sanitize\_text\_field($\_POST['sl\_folder\_permission'])), 0755) ); |
| [1637](#L1637) | } |
| [1638](#L1638) | if (!empty($\_POST['sl\_file\_permission'])) { |
| [1639](#L1639) | //var\_dump($\_POST['sl\_file\_permission']); die(); |
| [1640](#L1640) | @array\_map("chmod", sanitize\_text\_field($\_POST['sl\_file\_permission']), array\_fill(0, count(sanitize\_text\_field($\_POST['sl\_file\_permission'])), 0644) ); |
| [1641](#L1641) | } |
| [1642](#L1642) |  |
| [1643](#L1643) | //checks permissions of files & folders |
| [1644](#L1644) | $f\_to\_check = array(SL\_ADDONS\_PATH, SL\_THEMES\_PATH); |
| [1645](#L1645) |  |
| [1646](#L1646) | clearstatcache(); |
| [1647](#L1647) | $needs=0; |
| [1648](#L1648) |  |
| [1649](#L1649) | foreach ($f\_to\_check as $slf) { |
| [1650](#L1650) | $dir\_iterator = new RecursiveDirectoryIterator($slf); |
| [1651](#L1651) | $iterator = new RecursiveIteratorIterator($dir\_iterator, RecursiveIteratorIterator::SELF\_FIRST); |
| [1652](#L1652) | $files = new RegexIterator($iterator, "/\.(php|gif|jpe?g|png|css|js|csv|xml|json|txt)/"); |
| [1653](#L1653) | // could use CHILD\_FIRST if you so wish |
| [1654](#L1654) | //foreach ($files as $file) { |
| [1655](#L1655) | //      $all\_sl\_files[]=$file; |
| [1656](#L1656) | //} |
| [1657](#L1657) |  |
| [1658](#L1658) | foreach($iterator as $value) { |
| [1659](#L1659) | //print $value."<br>"; |
| [1660](#L1660) | if (is\_dir($value) && 0755 !== (@fileperms($value) & 0777)) { |
| [1661](#L1661) | $needs\_update["folder"][] = "$value - <b>".@decoct(@fileperms($value) & 0777)."</b>"; |
| [1662](#L1662) | $needs++; |
| [1663](#L1663) | } |
| [1664](#L1664) | } |
| [1665](#L1665) |  |
| [1666](#L1666) | foreach($files as $value) { |
| [1667](#L1667) | if (!is\_dir($value) && 0644 !== (@fileperms($value) & 0777) && !preg\_match("@(index|dummy)\.php$@", $value) ) { |
| [1668](#L1668) | //&& !preg\_match("@(index|dummy)\.php@", $value) - v3.89.4 - was constantly showing index.php or dummy.php too much |
| [1669](#L1669) | $needs\_update["file"][] = "$value - <b>".@decoct(@fileperms($value) & 0777)."</b>"; |
| [1670](#L1670) | $needs++; |
| [1671](#L1671) | } |
| [1672](#L1672) | } |
| [1673](#L1673) |  |
| [1674](#L1674) | } |
| [1675](#L1675) | //v3.89 - checking folder permissions of WP's 'uploads', 'plugins' & SL's 'store-Locator', 'sl-uploads' folders too now |
| [1676](#L1676) | $extra\_folders = array($sl\_uploads['basedir'], WP\_CONTENT\_DIR."/plugins", SL\_PATH, SL\_UPLOADS\_PATH); |
| [1677](#L1677) | foreach($extra\_folders as $value) { |
| [1678](#L1678) | if (is\_dir($value) && 0755 !== (@fileperms($value) & 0777)) { |
| [1679](#L1679) | $needs\_update["folder"][] = "$value - <b>".@decoct(@fileperms($value) & 0777)."</b>"; |
| [1680](#L1680) | $needs++; |
| [1681](#L1681) | } |
| [1682](#L1682) | } |
| [1683](#L1683) | //end - v3.89 |
| [1684](#L1684) |  |
| [1685](#L1685) | $button\_note = \_\_("Note: Clicking this button should update permissions, however, if it doesn\'t, you may need to update permissions by using an FTP program.  Click &quot;OK&quot; or &quot;Confirm&quot; to continue ...", "store-locator"); |
| [1686](#L1686) |  |
| [1687](#L1687) | if ($needs > 0){ |
| [1688](#L1688) | $output = ""; |
| [1689](#L1689) | print "<br><div class='sl\_admin\_warning' style='width:97%'><b>".\_\_("Important Note", "store-locator").":</b><br>".\_\_("Some of your folders / files may need updating to the proper permissions (folders: 755 / files: 644), otherwise, all functionality may not work as intended.  View folders / files below", "store-locator")." - <a href='#' onclick='show(\"file\_perm\_table\"); return false;'>".\_\_("display / hide list of folders & files", "store-locator")."</a>:<br> |
| [1690](#L1690) | <div style='float:right'>(<a href='".$\_SERVER['REQUEST\_URI']."&file\_perm\_msg=1'>".\_\_("Hide This Notice Permanently", "store-locator")."</a>)</div><br><br><table cellpadding='7px' id='file\_perm\_table' style='display:none;'><tr>"; |
| [1691](#L1691) | } |
| [1692](#L1692) | if (!empty($needs\_update["folder"])) { |
| [1693](#L1693) | $output .= "<td style='vertical-align: top; width:50%'><form method='post' onsubmit=\"return confirm('".$button\_note."');\"><strong>".\_\_("Folders", "store-locator").":</strong><br><input type='submit' class='button-primary' value=\"".\_\_("Update Checked Folders' Permissions", "store-locator")."\"><br><br>"; |
| [1694](#L1694) | foreach ($needs\_update["folder"] as $value) { |
| [1695](#L1695) | $output .= "\n<input name='sl\_folder\_permission[]' checked='checked' type='checkbox' value='".substr($value, 0, -13)."'>&nbsp;/".str\_replace(ABSPATH, '', $value)."<br>"; // "-13", removes 13 chars: " - <b> 777 </b>" at end of value |
| [1696](#L1696) | } |
| [1697](#L1697) | $output .= "</form></td>"; |
| [1698](#L1698) | } |
| [1699](#L1699) | if (!empty($needs\_update["file"])) { |
| [1700](#L1700) | $output .= "<td style='vertical-align: top; style: 50%;'><form method='post' onsubmit=\"return confirm('".$button\_note."');\"><strong>".\_\_("Files", "store-locator").":</strong><br><input type='submit' class='button-primary' value=\"".\_\_("Update Checked Files' Permissions", "store-locator")."\"><br><br>"; |
| [1701](#L1701) | foreach ($needs\_update["file"] as $value) { |
| [1702](#L1702) | $output .= "\n<input name='sl\_file\_permission[]' checked='checked' type='checkbox' value='".substr($value, 0, -13)."'>&nbsp;/".str\_replace(ABSPATH, '', $value)."<br>"; |
| [1703](#L1703) | } |
| [1704](#L1704) | $output .= "</form></td>"; |
| [1705](#L1705) | } |
| [1706](#L1706) | if ($needs > 0){ |
| [1707](#L1707) | //print sl\_truncate($output, 500, "return", 2); |
| [1708](#L1708) | print $output."</tr></table></div>"; |
| [1709](#L1709) | $sl\_vars['perms\_need\_update'] = 1; |
| [1710](#L1710) | } |
| [1711](#L1711) |  |
| [1712](#L1712) | if ($needs == 0) { |
| [1713](#L1713) | $sl\_vars['perms\_need\_update'] = 0; |
| [1714](#L1714) | } |
| [1715](#L1715) |  |
| [1716](#L1716) | } |
| [1717](#L1717) | /\*---------------------------------------------------------------\*/ |
| [1718](#L1718) | function sl\_remote\_data($val\_arr, $decode\_mode = 'json') { |
| [1719](#L1719) | $pagetype = (!empty($val\_arr['pagetype']))? $val\_arr['pagetype'] : "none" ; |
| [1720](#L1720) | $dir = (!empty($val\_arr['dir']))? $val\_arr['dir'] : "none" ; |
| [1721](#L1721) | $key = (!empty($val\_arr['key']))? "\_\_".$val\_arr['key'] : "" ; |
| [1722](#L1722) | $start = (!empty($val\_arr['start']))? $val\_arr['start'] : 0 ; |
| [1723](#L1723) | $val\_host = (!empty($val\_arr['host']))? $val\_arr['host'] : SL\_HOME\_URL; |
| [1724](#L1724) | $val\_url = (!empty($val\_arr['url']))? $val\_arr['url'] : "/show-data/". $pagetype ."/". $dir ."$key" ."/". $start ; |
| [1725](#L1725) | $useragent = (!empty($val\_arr['ua']))? $val\_arr['ua'] : "LotsOfLocales Store Locator Plugin" ; |
| [1726](#L1726) |  |
| [1727](#L1727) | $target = "http://" . $val\_host . $val\_url; |
| [1728](#L1728) | //exit($target); |
| [1729](#L1729) | $remote\_access\_fail = false; |
| [1730](#L1730) | $request = wp\_remote\_get( $target, |
| [1731](#L1731) | array( |
| [1732](#L1732) | 'timeout' => 10, |
| [1733](#L1733) | 'user-agent' => $useragent |
| [1734](#L1734) | ) |
| [1735](#L1735) | ); |
| [1736](#L1736) | $returned\_value = wp\_remote\_retrieve\_body($request); |
| [1737](#L1737) | //die($val\_url); |
| [1738](#L1738) | //var\_dump(json\_decode($returned\_value, true)); |
| [1739](#L1739) |  |
| [1740](#L1740) | if (!empty($returned\_value)) { |
| [1741](#L1741) | if ($decode\_mode == "none") { |
| [1742](#L1742) | $the\_data = $returned\_value; |
| [1743](#L1743) | } elseif ($decode\_mode == "serial") { |
| [1744](#L1744) | $the\_data = unserialize($returned\_value); |
| [1745](#L1745) | } else { |
| [1746](#L1746) | $the\_data = json\_decode($returned\_value, true); |
| [1747](#L1747) | } |
| [1748](#L1748) | return $the\_data; |
| [1749](#L1749) | } else { |
| [1750](#L1750) | return false; |
| [1751](#L1751) | } |
| [1752](#L1752) | } |
| [1753](#L1753) | /\*-----------------------------------\*/ |
| [1754](#L1754) | function sl\_pricing\_tables() { |
| [1755](#L1755) | global $sl\_vars, $sl\_version; |
| [1756](#L1756) |  |
| [1757](#L1757) | $from = "From cache<br>" . (time() - strtotime($sl\_vars['sl\_pt\_data\_time']))/60; |
| [1758](#L1758) |  |
| [1759](#L1759) | $sl\_vars['sl\_pt\_data\_time'] = (empty($sl\_vars['sl\_pt\_data\_time']))? date("Y-m-d H:i:s") : $sl\_vars['sl\_pt\_data\_time']; |
| [1760](#L1760) | if (empty($sl\_vars['sl\_pt\_data']) || ((time() - strtotime($sl\_vars['sl\_pt\_data\_time']))/60)>=60\*6) { //60\*6 = 6-hr cache |
| [1761](#L1761) | //if (false === ($sl\_pt\_data = get\_transient('sl\_pt\_data'))) { |
| [1762](#L1762) |  |
| [1763](#L1763) | $sl\_vars['sl\_pt\_data'] = @sl\_remote\_data(array( |
| [1764](#L1764) | 'host' => SL\_HOME\_URL, |
| [1765](#L1765) | 'url' => '/wp-json/wp/v2/pages/3561?fields=sl\_pt\_post\_meta', |
| [1766](#L1766) | 'ua' => 'none')); |
| [1767](#L1767) |  |
| [1768](#L1768) | if (!empty($sl\_vars['sl\_pt\_data']['status']) && $sl\_vars['sl\_pt\_data']['status'] == 'inactive') { |
| [1769](#L1769) | $sl\_vars['sl\_pt\_data\_status'] = 'inactive'; |
| [1770](#L1770) | } elseif ((empty($sl\_vars['sl\_pt\_data']) || is\_null($sl\_vars['sl\_pt\_data'])) && $sl\_vars['sl\_pt\_data\_status'] == 'inactive') { |
| [1771](#L1771) | $sl\_vars['sl\_pt\_data\_status'] = 'inactive'; |
| [1772](#L1772) | } else { |
| [1773](#L1773) | $sl\_vars['sl\_pt\_data\_status'] = 'active'; |
| [1774](#L1774) | } |
| [1775](#L1775) |  |
| [1776](#L1776) | //if ( is\_wp\_error( $response ) ) { |
| [1777](#L1777) | if (empty($sl\_vars['sl\_pt\_data']) || is\_null($sl\_vars['sl\_pt\_data'])) { |
| [1778](#L1778) | //unset($sl\_vars['sl\_pt\_data\_time']); |
| [1779](#L1779) | //unset($sl\_vars['sl\_pt\_data']); |
| [1780](#L1780) | //sl\_data('sl\_pt\_data\_time', 'delete'); sl\_data('sl\_pt\_data', 'delete'); |
| [1781](#L1781) | } else { |
| [1782](#L1782) | //if ( isset( $response[ 'body' ] ) && strlen( $response[ 'body' ] ) > 0 ) { |
| [1783](#L1783) | //      $sl\_pt\_data = json\_decode( wp\_remote\_retrieve\_body( $response ), true ); |
| [1784](#L1784) | $from = "From json data<br>" . (time() - strtotime($sl\_vars['sl\_pt\_data\_time']))/60; |
| [1785](#L1785) | //} |
| [1786](#L1786) |  |
| [1787](#L1787) | //$expiration = empty( $sl\_pt\_data ) ? MINUTE\_IN\_SECONDS : 1\* MINUTE\_IN\_SECONDS; |
| [1788](#L1788) | //set\_transient('sl\_pt\_data', $sl\_pt\_data, $expiration); |
| [1789](#L1789) |  |
| [1790](#L1790) | $sl\_vars['sl\_pt\_data\_time'] = date("Y-m-d H:i:s"); |
| [1791](#L1791) | } |
| [1792](#L1792) | } |
| [1793](#L1793) |  |
| [1794](#L1794) | sl\_data('sl\_vars', 'update', $sl\_vars); //needs to be outside below if statement for case when unsetting values above - 4/15/17 2:04 PM |
| [1795](#L1795) |  |
| [1796](#L1796) | if ( !empty($sl\_vars['sl\_pt\_data']) && is\_array($sl\_vars['sl\_pt\_data']) && (empty($sl\_vars['sl\_pt\_data\_status']) || $sl\_vars['sl\_pt\_data\_status'] != 'inactive') ) { |
| [1797](#L1797) | foreach ($sl\_vars['sl\_pt\_data']['sl\_pt\_post\_meta'] as $value) { |
| [1798](#L1798) | $value = str\_replace("<i class=\"fa fa-times-circle red\"></i>", "<b style='color: red'>X</b>",  $value); |
| [1799](#L1799) | } |
| [1800](#L1800) | $css\_news\_upgrades = ' |
| [1801](#L1801) | <style> |
| [1802](#L1802) | .ptp-dg6-col { |
| [1803](#L1803) | display: inline-block; |
| [1804](#L1804) | margin-bottom: 20px !important; |
| [1805](#L1805) | margin-top: 10px !important; |
| [1806](#L1806) | padding-left: 5px !important; |
| [1807](#L1807) | padding-right: 5px !important; |
| [1808](#L1808) | padding-top: 10px !important; |
| [1809](#L1809) | vertical-align: top; |
| [1810](#L1810) | width: 46%; |
| [1811](#L1811) | } |
| [1812](#L1812) | #ptp-3837 .cd-pricing-list .ptp-dg6-col .ptp-dg6-price { |
| [1813](#L1813) | font-size: 30px; |
| [1814](#L1814) | } |
| [1815](#L1815) | .ptp-dg6-button.ptp-checkout-button { |
| [1816](#L1816) | /\*display: block;\*/ |
| [1817](#L1817) | padding: 10px; |
| [1818](#L1818) | text-align: center; |
| [1819](#L1819) | text-decoration: none; |
| [1820](#L1820) | /\*width: 60%;\*/ |
| [1821](#L1821) | } |
| [1822](#L1822) | .ptp-dg6-pricing-header > h2 { |
| [1823](#L1823) | font-size: 30px !important; |
| [1824](#L1824) | padding-bottom: 10px; |
| [1825](#L1825) | } |
| [1826](#L1826) | .ptp-dg6-col { |
| [1827](#L1827) | padding: 10px; |
| [1828](#L1828) | } |
| [1829](#L1829) | </style> |
| [1830](#L1830) | '; #<- v3.98.5 - heredoc to single quotes |
| [1831](#L1831) | $css\_addons = ' |
| [1832](#L1832) | <style> |
| [1833](#L1833) | .ptp-dg6-col { |
| [1834](#L1834) | display: inline-block; |
| [1835](#L1835) | font-size: 8px; |
| [1836](#L1836) | padding: 10px 5px 0; |
| [1837](#L1837) | vertical-align: top; |
| [1838](#L1838) | width: 22.5%; |
| [1839](#L1839) | } |
| [1840](#L1840) | #ptp-3837 .cd-pricing-list .ptp-dg6-col .ptp-dg6-price { |
| [1841](#L1841) | font-size: 30px; |
| [1842](#L1842) | } |
| [1843](#L1843) | .ptp-dg6-button.ptp-checkout-button { |
| [1844](#L1844) | display: block; |
| [1845](#L1845) | padding: 10px; |
| [1846](#L1846) | text-align: center; |
| [1847](#L1847) | text-decoration: none; |
| [1848](#L1848) | width: 60%; |
| [1849](#L1849) | } |
| [1850](#L1850) | .ptp-dg6-pricing-header > h2 { |
| [1851](#L1851) | font-size: 30px !important; |
| [1852](#L1852) | padding-bottom: 10px; |
| [1853](#L1853) | } |
| [1854](#L1854) | </style> |
| [1855](#L1855) | '; #<- v3.98.5 - heredoc to single quotes |
| [1856](#L1856) |  |
| [1857](#L1857) | $css\_both = ' |
| [1858](#L1858) | <style> |
| [1859](#L1859) | .has-tip { |
| [1860](#L1860) | color: #009 !important; /\*#e97d68 !important;\*/ |
| [1861](#L1861) | border-bottom: 1px dotted #ccc; |
| [1862](#L1862) | cursor: help; |
| [1863](#L1863) | } |
| [1864](#L1864) | .ptp-dg6-pay-duration::before { |
| [1865](#L1865) | content: "/"; |
| [1866](#L1866) | margin-right: 2px; |
| [1867](#L1867) | } |
| [1868](#L1868) | .ptp-dg6-pricing-header h2, .ptp-dg6-pricing-header .cd-price { |
| [1869](#L1869) | font-family:  \'Trajan Pro\',Georgia,serif; |
| [1870](#L1870) | font-variant: small-caps; |
| [1871](#L1871) | text-align: center; |
| [1872](#L1872) | } |
| [1873](#L1873) | #ptp-3837 .ptp-dg6-bullet-item { |
| [1874](#L1874) | font-size: 12px !important; |
| [1875](#L1875) | padding: 6px 3px !important; |
| [1876](#L1876) | } |
| [1877](#L1877) | .sl\_pt\_info { |
| [1878](#L1878) | text-align: center; |
| [1879](#L1879) | background-color: lightYellow; |
| [1880](#L1880) | margin: 7px; |
| [1881](#L1881) | margin-left: 0px; margin-top: 0px; |
| [1882](#L1882) | padding: 6px |
| [1883](#L1883) | } |
| [1884](#L1884) | </style> |
| [1885](#L1885) | <script> |
| [1886](#L1886) | jQuery(document).ready(function(){ |
| [1887](#L1887) | jQuery(\'.has-tip\').each(function() { |
| [1888](#L1888) | tip\_html=jQuery(this).attr(\'title\', jQuery(this).attr(\'title\').replace(/<br>/gi, \' \')); |
| [1889](#L1889) | /\*console.log(tip\_html.attr(\'title\'));\*/ |
| [1890](#L1890) | jQuery(this).attr(\'data-tooltip\', tip\_html.attr(\'title\')); |
| [1891](#L1891) | jQuery(this).removeAttr(\'title\'); |
| [1892](#L1892) | }); |
| [1893](#L1893) | jQuery("a[href\*=\'edd\_action\']").each(function() { |
| [1894](#L1894) | jQuery(this).attr(\'href\', jQuery(this).attr(\'href\') + \'&utm\_source=wp-admin&utm\_medium=plugin&utm\_campaign=' . $sl\_version . '&utm\_term=' . $sl\_vars['sl\_addons\_page\_name']. '\'); |
| [1895](#L1895) | }); |
| [1896](#L1896) | }); |
| [1897](#L1897) | </script> |
| [1898](#L1898) | '; #<- v3.98.5 - heredoc to single quotes |
| [1899](#L1899) | $styling = (preg\_match("@addons\.php@", $\_SERVER["REQUEST\_URI"]) )? $css\_addons : $css\_news\_upgrades; |
| [1900](#L1900) | $from = "<span style='display:none'>$from</span>"; //debug info |
| [1901](#L1901) | return $from.$styling.$css\_both.$value; |
| [1902](#L1902) | } else { |
| [1903](#L1903) | if (empty($\_GET['prem\_refresh']) && preg\_match("@addons\.php@", $\_SERVER["REQUEST\_URI"]) ){ |
| [1904](#L1904) | print "<script>location.replace('".$\_SERVER['REQUEST\_URI']."&prem\_refresh=1')</script>"; |
| [1905](#L1905) | } |
| [1906](#L1906) | return false; |
| [1907](#L1907) | } |
| [1908](#L1908) | } |
| [1909](#L1909) | function do\_sl\_premium\_pricing() { |
| [1910](#L1910) | print sl\_pricing\_tables(); |
| [1911](#L1911) | } |
| [1912](#L1912) | /\*-----------------------------------------------\*/ |
| [1913](#L1913) | ### Ref: ottopress.com/2010/dont-include-wp-load-please/ -- 4/11/18 ### |
| [1914](#L1914) | add\_filter('query\_vars','sl\_plugin\_add\_trigger'); |
| [1915](#L1915) | function sl\_plugin\_add\_trigger($vars) { |
| [1916](#L1916) | $vars[] = 'sl\_engine'; |
| [1917](#L1917) | return $vars; |
| [1918](#L1918) | } |
| [1919](#L1919) | add\_action('template\_redirect', 'sl\_plugin\_trigger\_check'); |
| [1920](#L1920) | function sl\_plugin\_trigger\_check() { |
| [1921](#L1921) | global $wpdb, $sl\_xml\_columns, $sl\_vars; |
| [1922](#L1922) | if ( !empty(get\_query\_var('sl\_engine') ) ) { |
| [1923](#L1923) | $translate = preg\_replace("@\_@", "/", "/" . get\_query\_var('sl\_engine') . ".php"); |
| [1924](#L1924) | if (file\_exists(SL\_PATH . $translate)) { |
| [1925](#L1925) | include(SL\_PATH . $translate); |
| [1926](#L1926) | } |
| [1927](#L1927) | exit; |
| [1928](#L1928) | } |
| [1929](#L1929) | } |
| [1930](#L1930) | /\*-----------------------------------------------\*/ |
| [1931](#L1931) | ### Loading SL Variables ### |
| [1932](#L1932) | $sl\_vars=sl\_data('sl\_vars'); |
| [1933](#L1933) |  |
| [1934](#L1934) | if (!is\_array($sl\_vars)) { |
| [1935](#L1935) | //print($sl\_vars."<br><br>"); |
| [1936](#L1936) | function sl\_fix\_corrupted\_serialized\_string($string) { |
| [1937](#L1937) | $tmp = explode(':"', $string); |
| [1938](#L1938) | $length = count($tmp); |
| [1939](#L1939) | for($i = 1; $i < $length; $i++) { |
| [1940](#L1940) | list($string) = explode('"', $tmp[$i]); |
| [1941](#L1941) | $str\_length = strlen($string); |
| [1942](#L1942) | $tmp2 = explode(':', $tmp[$i-1]); |
| [1943](#L1943) | $last = count($tmp2) - 1; |
| [1944](#L1944) | $tmp2[$last] = $str\_length; |
| [1945](#L1945) | $tmp[$i-1] = join(':', $tmp2); |
| [1946](#L1946) | } |
| [1947](#L1947) | return join(':"', $tmp); |
| [1948](#L1948) | } |
| [1949](#L1949) | $sl\_vars = sl\_fix\_corrupted\_serialized\_string($sl\_vars); //die($sl\_vars); |
| [1950](#L1950) | sl\_data('sl\_vars', 'update', $sl\_vars); |
| [1951](#L1951) | $sl\_vars = unserialize($sl\_vars); //var\_dump($sl\_vars); |
| [1952](#L1952) | //die($sl\_vars); |
| [1953](#L1953) | } |
| [1954](#L1954) |  |
| [1955](#L1955) | function sl\_ap\_load() { |
| [1956](#L1956) | global $wpdb; //needed if AP loaded inside of function - 4/28/17 |
| [1957](#L1957) | ### Addons Platform Load ### |
| [1958](#L1958) | if (defined('SL\_ADDONS\_PLATFORM\_FILE') && file\_exists(SL\_ADDONS\_PLATFORM\_FILE) && !function\_exists('do\_sl\_hook') ) { |
| [1959](#L1959) | // && (preg\_match("@$sl\_dir@", $\_SERVER['REQUEST\_URI']) || preg\_match('@widgets@', $\_SERVER['REQUEST\_URI']) || !preg\_match('@wp-admin@', $\_SERVER['REQUEST\_URI']))) { |
| [1960](#L1960) | include\_once(SL\_ADDONS\_PLATFORM\_FILE); |
| [1961](#L1961) | sl\_initialize\_variables(); // needed |
| [1962](#L1962) | } |
| [1963](#L1963) | ###### |
| [1964](#L1964) | } |
| [1965](#L1965) | add\_action('plugins\_loaded', 'sl\_ap\_load', '0.0000001'); //very early priority -- need to happen before any other addons |
| [1966](#L1966) | /\*-------------------------------\*/ |
| [1967](#L1967) | function sl\_second\_pass\_script() { |
| [1968](#L1968) | global $sl\_vars, $wpdb; |
| [1969](#L1969) | #v3.98.5 - seperated from sl\_second\_pass function for script enqueuing; used in sl\_do\_geocoding() function |
| [1970](#L1970) | #4/24/22 - printing now, called too late (after page has fully loaded) to actually use the 'admin\_enqueue\_scripts' action |
| [1971](#L1971) | //if (empty($GLOBALS['sp\_first\_fun']) || $GLOBALS['sp\_first\_fun'] == 0) { |
| [1972](#L1972) | //$sens=(!empty($sl\_vars['sensor']) && ($sl\_vars['sensor'] === "true" || $sl\_vars['sensor'] === "false" ))? "&amp;sensor=".$sl\_vars['sensor'] : "&amp;sensor=false" ; |
| [1973](#L1973) | $sens=""; //- v3.84 - 11/25/15 - no longer required |
| [1974](#L1974) | $lang\_loc=(!empty($sl\_vars['map\_language']))? "&amp;language=".$sl\_vars['map\_language'] : "" ; |
| [1975](#L1975) | $region\_loc=(!empty($sl\_vars['map\_region']))? "&amp;region=".$sl\_vars['map\_region'] : "" ; |
| [1976](#L1976) | $key=(!empty($sl\_vars['api\_key']))? "&amp;key=".$sl\_vars['api\_key'] : "" ; |
| [1977](#L1977) |  |
| [1978](#L1978) | print "<script src='https://maps.googleapis.com/maps/api/js?v=3{$sens}{$lang\_loc}{$region\_loc}{$key}' type='text/javascript'></script>\n"; |
| [1979](#L1979) | #wp\_enqueue\_script("sl\_second\_pass", "https://maps.googleapis.com/maps/api/js?v=3" . esc\_attr($sens) . esc\_attr($lang\_loc) . esc\_attr($region\_loc) . esc\_attr($key) ); -- switched back to printing - #4/24/22 |
| [1980](#L1980) | //} |
| [1981](#L1981) |  |
| [1982](#L1982) | } |
| [1983](#L1983) | function sl\_second\_pass($address, $sl\_id) { |
| [1984](#L1984) | global $sl\_vars, $wpdb; |
| [1985](#L1985) |  |
| [1986](#L1986) | $the\_sl\_id = ($sl\_id==="")? $wpdb->insert\_id : $sl\_id; |
| [1987](#L1987) | $the\_edit = (!empty($\_GET['edit']))? sanitize\_text\_field($\_GET['edit']) : "" ; |
| [1988](#L1988) |  |
| [1989](#L1989) | print "<br><b>Second Attempt ...</b> <span id='sl\_second\_pass\_status-$the\_sl\_id'></span><br><br>"; |
| [1990](#L1990) |  |
| [1991](#L1991) | #sl\_second\_pass\_script() -- v3.98.5 |
| [1992](#L1992) |  |
| [1993](#L1993) | print "<script type='text/javascript'> |
| [1994](#L1994) | jQuery(document).ready(function() { |
| [1995](#L1995) | sl\_geocoder = new google.maps.Geocoder(); |
| [1996](#L1996) | sl\_geocoder.geocode( {'address': \"".trim($address)."\"}, function(results, status) { |
| [1997](#L1997) | //alert(status); |
| [1998](#L1998) | if (status == google.maps.GeocoderStatus.OK) { |
| [1999](#L1999) | center = results[0].geometry.location; |
| [2000](#L2000) |  |
| [2001](#L2001) | jQuery.get('".SL\_SITEURL."/?sl\_engine=sl-inc\_includes\_sl-geo&sl\_id=".$the\_sl\_id."&lat=' + center.lat() + '&lng=' + center.lng() + '&\_wpnonce=".wp\_create\_nonce('second-pass-geo\_'.$the\_sl\_id)."', function() { |
| [2002](#L2002) | document.getElementById('sl\_second\_pass\_status-{$the\_sl\_id}').innerHTML = \"<font color='DarkGreen'>Success!</font>\"; "; |
| [2003](#L2003) |  |
| [2004](#L2004) | if (!empty($\_GET['edit'])) { |
| [2005](#L2005) | print "document.getElementById('sl\_second\_pass\_status-{$the\_sl\_id}').innerHTML += \"<br><br>This page will refresh this in <span id='time\_left\_span'>5</span> secs ...\"; |
| [2006](#L2006) | setTimeout(function(){location.replace('".esc\_url\_raw(str\_replace("&edit={$the\_edit}", "", $\_SERVER['REQUEST\_URI']))."#a".$the\_edit."');}, 5000);"; |
| [2007](#L2007) | } |
| [2008](#L2008) |  |
| [2009](#L2009) | print "}); |
| [2010](#L2010) |  |
| [2011](#L2011) | } else { |
| [2012](#L2012) | document.getElementById('sl\_second\_pass\_status-{$the\_sl\_id}').innerHTML = \"<font color='red'>Failed again</font>, with status \" + status + \". Check <a href='https://".$sl\_vars['google\_map\_domain']."?q=".urlencode(trim($address))."' target='\_blank'>Google search</a> to make sure address is valid.\";"; |
| [2013](#L2013) | /\*if (!empty($\_GET['edit'])) { |
| [2014](#L2014) | print "document.getElementById('sl\_second\_pass\_status-{$the\_sl\_id}').innerHTML += \"<br><br>This page will refresh this in <span id='time\_left\_span'>10</span> secs ...\"; |
| [2015](#L2015) | setTimeout(function(){location.replace('".str\_replace("&edit={$the\_edit}", "", $\_SERVER['REQUEST\_URI'])."#a".$the\_edit."');}, 10000);"; |
| [2016](#L2016) | }\*/ |
| [2017](#L2017) |  |
| [2018](#L2018) | print "} |
| [2019](#L2019) | }); |
| [2020](#L2020) | }); |
| [2021](#L2021) | </script>"; |
| [2022](#L2022) | //$GLOBALS['sp\_first\_run'] = 1; |
| [2023](#L2023) | } |
| [2024](#L2024) | /\*------------------------------------\*/ |
| [2025](#L2025) | ## Overridable ## |
| [2026](#L2026) | /\*Needs !SL\_PLUGIN\_ACTIVATING check because any addon w/overriding functions that is being activated will load after 'plugins\_loaded' hook, thus giving 'Fatal error: Cannot redeclare {function}' error.  Only 'activated\_plugin' & 'shutdown' hooks happen after plugin activation. Ref: https://codex.wordpress.org/Function\_Reference/register\_activation\_hook#Process\_Flow \*/ |
| [2027](#L2027) | if (!SL\_PLUGIN\_ACTIVATING) {     add\_action('plugins\_loaded', 'sl\_set\_default\_functions', "100000000"); } //late priority to allow all addons to be loaded |
| [2028](#L2028) | function sl\_set\_default\_functions() { |
| [2029](#L2029) | #ref: http://stackoverflow.com/a/20594790 -- creates overridable functions if not already created by an addon |
| [2030](#L2030) |  |
| [2031](#L2031) | if (!function\_exists("sl\_do\_geocoding")){ |
| [2032](#L2032) | function sl\_do\_geocoding($address, $sl\_id="") { |
| [2033](#L2033) | if (empty($\_POST['no\_geocode']) || $\_POST['no\_geocode']!=1){ |
| [2034](#L2034) | global $wpdb, $text\_domain, $sl\_vars; |
| [2035](#L2035) |  |
| [2036](#L2036) | // Initialize delay in geocode speed |
| [2037](#L2037) | $delay = 100000; $ccTLD=$sl\_vars['map\_region']; $sensor=$sl\_vars['sensor']; |
| [2038](#L2038) | $base\_url = "https://maps.googleapis.com/maps/api/geocode/json?"; |
| [2039](#L2039) |  |
| [2040](#L2040) | //if ($sensor!="" && !empty($sensor) && ($sensor === "true" || $sensor === "false" )) {$base\_url .= "sensor=".$sensor;} else {$base\_url .= "sensor=false";}  - v3.84 - 11/25/15 - no longer required |
| [2041](#L2041) |  |
| [2042](#L2042) | //Adding ccTLD (Top Level Domain) to help perform more accurate geocoding according to selected Google Maps Domain - 12/16/09 |
| [2043](#L2043) | if ($ccTLD!="") { |
| [2044](#L2044) | $base\_url .= "&region=".$ccTLD; |
| [2045](#L2045) | //die($base\_url); |
| [2046](#L2046) | } |
| [2047](#L2047) |  |
| [2048](#L2048) | //Map Character Encoding |
| [2049](#L2049) | if (!empty($sl\_vars['map\_language'])) { |
| [2050](#L2050) | $base\_url .= "&language=".$sl\_vars['map\_language']; |
| [2051](#L2051) | } |
| [2052](#L2052) |  |
| [2053](#L2053) | //API Key |
| [2054](#L2054) | if (!empty($sl\_vars['api\_key'])) { |
| [2055](#L2055) | $base\_url .= "&key=".$sl\_vars['api\_key']; |
| [2056](#L2056) | } |
| [2057](#L2057) |  |
| [2058](#L2058) | // Iterate through the rows, geocoding each address |
| [2059](#L2059) | $request\_url = $base\_url . "&address=" . urlencode(trim($address)); //print($request\_url ); |
| [2060](#L2060) |  |
| [2061](#L2061) | //Updated to WP HTTP API - 12/4/18 4:49p |
| [2062](#L2062) | $request = wp\_remote\_get( $request\_url, |
| [2063](#L2063) | array( |
| [2064](#L2064) | 'timeout' => 10 |
| [2065](#L2065) | ) |
| [2066](#L2066) | ); |
| [2067](#L2067) | $resp\_json = wp\_remote\_retrieve\_body($request); |
| [2068](#L2068) | //End of new code |
| [2069](#L2069) |  |
| [2070](#L2070) | $resp = json\_decode($resp\_json, true); //var\_dump($resp); |
| [2071](#L2071) | $status = $resp['status']; //$status = ""; |
| [2072](#L2072) | $lat = (!empty($resp['results'][0]['geometry']['location']['lat']))? $resp['results'][0]['geometry']['location']['lat'] : "" ; |
| [2073](#L2073) | $lng = (!empty($resp['results'][0]['geometry']['location']['lng']))? $resp['results'][0]['geometry']['location']['lng'] : "" ; |
| [2074](#L2074) | //die("<br>compare: ".strcmp($status, "OK")."<br>status: $status<br>"); |
| [2075](#L2075) | if (strcmp($status, "OK") == 0) { |
| [2076](#L2076) | // successful geocode |
| [2077](#L2077) | $geocode\_pending = false; |
| [2078](#L2078) | $lat = $resp['results'][0]['geometry']['location']['lat']; |
| [2079](#L2079) | $lng = $resp['results'][0]['geometry']['location']['lng']; |
| [2080](#L2080) |  |
| [2081](#L2081) | $GLOBALS['sdg\_reply'] = '1st\_attempt'; //message to control refreshing of page after successful geocode in processLocationData.php |
| [2082](#L2082) |  |
| [2083](#L2083) | if ($sl\_id==="") { |
| [2084](#L2084) | $query = $wpdb->prepare("UPDATE ".SL\_TABLE." SET sl\_latitude = %s, sl\_longitude = %s WHERE sl\_id = %s LIMIT 1;", esc\_sql($lat), esc\_sql($lng), esc\_sql($wpdb->insert\_id)); //die($query); |
| [2085](#L2085) | } else { |
| [2086](#L2086) | $query = $wpdb->prepare("UPDATE ".SL\_TABLE." SET sl\_latitude = %s, sl\_longitude = %s WHERE sl\_id = %s LIMIT 1;", esc\_sql($lat), esc\_sql($lng), esc\_sql($sl\_id)); |
| [2087](#L2087) | } |
| [2088](#L2088) | $update\_result = $wpdb->query($query); |
| [2089](#L2089) | if ($update\_result === FALSE) { |
| [2090](#L2090) | die("Invalid query: " . $wpdb->last\_error); |
| [2091](#L2091) | } |
| [2092](#L2092) | } else if (strcmp($status, "OVER\_QUERY\_LIMIT") == 0) { |
| [2093](#L2093) | // sent geocodes too fast |
| [2094](#L2094) | $delay += 100000; |
| [2095](#L2095) | } else { |
| [2096](#L2096) | // failure to geocode |
| [2097](#L2097) | $geocode\_pending = false; |
| [2098](#L2098) | echo \_\_("Address ", "store-locator") . esc\_attr($address) . \_\_(" <font color=red>failed to geocode</font>. ", "store-locator"); |
| [2099](#L2099) | //if (!empty($status)) { |
| [2100](#L2100) | echo \_\_("Received status ", "store-locator") . esc\_attr($status) ."\n<br>"; |
| [2101](#L2101) | /\*} else { |
| [2102](#L2102) | echo \_\_("No status received from Google", "store-locator")."\n<br>"; |
| [2103](#L2103) | }\*/ |
| [2104](#L2104) | //var\_dump($\_POST); |
| [2105](#L2105) | if (!isset($\_POST['total\_entries']) && (empty($\_POST['sl\_id']) || !is\_array($\_POST['sl\_id']) || (is\_array($\_POST['sl\_id']) && (empty($\_POST['act']) || $\_POST['act'] != 'regeocode'))) ) { |
| [2106](#L2106) | //add\_action("admin\_print\_scripts", "sl\_second\_pass\_script"); #v3.98.5 -- doesn't work. Occurs too late / after page, scripts have loaded, thus needs to be printed directly within sl\_second\_pass() - 4/24/22 3:06a |
| [2107](#L2107) | sl\_second\_pass\_script(); |
| [2108](#L2108) | sl\_second\_pass($address, $sl\_id); |
| [2109](#L2109) | } |
| [2110](#L2110) | //|| (is\_array($\_POST['sl\_id']) && count($\_POST['sl\_id']) == 1) - removed for now |
| [2111](#L2111) | } |
| [2112](#L2112) | usleep($delay); |
| [2113](#L2113) | } else { |
| [2114](#L2114) | //print \_\_("Geocoding bypassed ", "store-locator"); |
| [2115](#L2115) | } @ob\_flush(); flush(); |
| [2116](#L2116) | } |
| [2117](#L2117) | } |
| [2118](#L2118) | /\*-------------------------------\*/ |
| [2119](#L2119) | if (!function\_exists("sl\_template")){ |
| [2120](#L2120) | function sl\_template($content) { |
| [2121](#L2121) |  |
| [2122](#L2122) | global $sl\_dir, $sl\_base, $sl\_uploads\_base, $sl\_path, $sl\_uploads\_path, $text\_domain, $wpdb, $sl\_vars; |
| [2123](#L2123) | if(! preg\_match('|\[store-locator|i', $content)) { |
| [2124](#L2124) | return $content; |
| [2125](#L2125) | } |
| [2126](#L2126) | else { |
| [2127](#L2127) | $height=($sl\_vars['height'])? $sl\_vars['height'] : "500" ; |
| [2128](#L2128) | $width=($sl\_vars['width'])? $sl\_vars['width'] : "100" ; |
| [2129](#L2129) | $radii=($sl\_vars['radii'])? $sl\_vars['radii'] : "1,5,10,(25),50,100,200,500" ; |
| [2130](#L2130) | $r\_array=explode(",", $radii); |
| [2131](#L2131) | $height\_units=($sl\_vars['height\_units'])? $sl\_vars['height\_units'] : "px"; |
| [2132](#L2132) | $width\_units=($sl\_vars['width\_units'])? $sl\_vars['width\_units'] : "%"; |
| [2133](#L2133) |  |
| [2134](#L2134) | $sl\_instruction\_message=($sl\_vars['instruction\_message'])? $sl\_vars['instruction\_message'] : "Enter Your Address or Zip Code Above."; |
| [2135](#L2135) | $sl\_radius\_label=$sl\_vars['radius\_label']; |
| [2136](#L2136) | $sl\_search\_label=($sl\_vars['search\_label'])? $sl\_vars['search\_label'] : "Address" ; |
| [2137](#L2137) | $sl\_city\_dropdown\_label=$sl\_vars['city\_dropdown\_label']; |
| [2138](#L2138) |  |
| [2139](#L2139) | $sl\_search\_button = "search\_button.png"; |
| [2140](#L2140) | $sl\_search\_button\_down = "search\_button\_down.png"; |
| [2141](#L2141) | $sl\_search\_button\_over = "search\_button\_over.png"; |
| [2142](#L2142) |  |
| [2143](#L2143) | //WPML Display Integration |
| [2144](#L2144) | //if (function\_exists('icl\_t')) { |
| [2145](#L2145) | include(SL\_INCLUDES\_PATH."/mapdesigner-options.php"); |
| [2146](#L2146) | $GLOBALS['input\_zone\_type'] = 'labels'; |
| [2147](#L2147) | $GLOBALS['output\_zone\_type'] = 'sl\_template'; |
| [2148](#L2148) |  |
| [2149](#L2149) | $labels\_arr = array\_filter($sl\_mdo, "filter\_sl\_mdo"); |
| [2150](#L2150) | unset($GLOBALS['input\_zone\_type']); unset($GLOBALS['output\_zone\_type']); |
| [2151](#L2151) | //var\_dump($labels\_arr); die(); |
| [2152](#L2152) |  |
| [2153](#L2153) | foreach ($labels\_arr as $value) { |
| [2154](#L2154) | $the\_field = $value['field\_name']; |
| [2155](#L2155) | $varname = "sl\_".$the\_field; |
| [2156](#L2156) |  |
| [2157](#L2157) | $$varname = apply\_filters("wpml\_translate\_single\_string", $$varname, SL\_DIR, $value['label']); |
| [2158](#L2158) | } |
| [2159](#L2159) |  |
| [2160](#L2160) | ### Search Button States |
| [2161](#L2161) | $sl\_search\_button = apply\_filters("wpml\_translate\_single\_string", $sl\_search\_button, SL\_DIR,"Search Button Filename"); |
| [2162](#L2162) | $sl\_search\_button\_down = apply\_filters("wpml\_translate\_single\_string", $sl\_search\_button\_down, SL\_DIR,"Search Button Filename (Down State)"); |
| [2163](#L2163) | $sl\_search\_button\_over = apply\_filters("wpml\_translate\_single\_string", $sl\_search\_button\_over, SL\_DIR,"Search Button Filename (Over State)"); |
| [2164](#L2164) | //} |
| [2165](#L2165) | //End WPML |
| [2166](#L2166) |  |
| [2167](#L2167) | //Polylang Display Integration |
| [2168](#L2168) | if (function\_exists('pll\_\_')) { |
| [2169](#L2169) | //include(SL\_INCLUDES\_PATH."/mapdesigner-options.php"); |
| [2170](#L2170) | //$GLOBALS['input\_zone\_type'] = 'labels'; |
| [2171](#L2171) | //$GLOBALS['output\_zone\_type'] = 'sl\_template'; |
| [2172](#L2172) |  |
| [2173](#L2173) | //$labels\_arr = array\_filter($sl\_mdo, "filter\_sl\_mdo"); |
| [2174](#L2174) | //unset($GLOBALS['input\_zone\_type']); unset($GLOBALS['output\_zone\_type']); |
| [2175](#L2175) | //var\_dump($labels\_arr); die(); |
| [2176](#L2176) |  |
| [2177](#L2177) | foreach ($labels\_arr as $value) { |
| [2178](#L2178) | $the\_field = $value['field\_name']; |
| [2179](#L2179) | $varname = "sl\_".$the\_field; |
| [2180](#L2180) |  |
| [2181](#L2181) | $$varname = pll\_\_($$varname); |
| [2182](#L2182) | } |
| [2183](#L2183) |  |
| [2184](#L2184) | ### Search Button States |
| [2185](#L2185) | $sl\_search\_button =  pll\_\_($sl\_search\_button); |
| [2186](#L2186) | $sl\_search\_button\_down =  pll\_\_($sl\_search\_button\_down); |
| [2187](#L2187) | $sl\_search\_button\_over =  pll\_\_($sl\_search\_button\_over); |
| [2188](#L2188) | } |
| [2189](#L2189) | //End Polylang |
| [2190](#L2190) |  |
| [2191](#L2191) | $unit\_display=($sl\_vars['distance\_unit']=="km")? "km" : "mi"; |
| [2192](#L2192) | $r\_options=""; |
| [2193](#L2193) | foreach ($r\_array as $value) { |
| [2194](#L2194) | $s=(preg\_match("@\(.\*\)@", $value))? " selected='selected' " : "" ; |
| [2195](#L2195) | $value=preg\_replace("@[^0-9]@", "", $value); |
| [2196](#L2196) | $r\_options.="<option value='$value' $s>$value $unit\_display</option>"; |
| [2197](#L2197) | } |
| [2198](#L2198) |  |
| [2199](#L2199) | if ($sl\_vars['use\_city\_search']==1) { |
| [2200](#L2200) | $cs\_array=$wpdb->get\_results("SELECT CONCAT(TRIM(sl\_city), ', ', TRIM(sl\_state)) as city\_state FROM ".SL\_TABLE." WHERE sl\_city<>'' AND sl\_state<>'' AND sl\_latitude<>'' AND sl\_longitude<>'' GROUP BY city\_state ORDER BY city\_state ASC", ARRAY\_A); |
| [2201](#L2201) | //var\_dump($cs\_array); die(); |
| [2202](#L2202) | $cs\_options=""; |
| [2203](#L2203) | if (!empty($cs\_array)) { |
| [2204](#L2204) | foreach($cs\_array as $value) { |
| [2205](#L2205) | $cs\_options.="<option value='$value[city\_state]'>$value[city\_state]</option>"; |
| [2206](#L2206) | } |
| [2207](#L2207) | } else { |
| [2208](#L2208) | $sl\_vars['use\_city\_search']=0; // if no full city-state combos to populate dropdown, turn off - 2/4/15 - v.3.32 |
| [2209](#L2209) | } |
| [2210](#L2210) | } |
| [2211](#L2211) | /\*if ($sl\_vars['use\_name\_search']==1) { |
| [2212](#L2212) | $name\_array=$wpdb->get\_results("SELECT sl\_store FROM ".SL\_TABLE." WHERE sl\_store<>'' ORDER BY sl\_store ASC", ARRAY\_A); |
| [2213](#L2213) | //var\_dump($cs\_array); die(); |
| [2214](#L2214) | if ($name\_array) { |
| [2215](#L2215) | foreach($name\_array as $value) { |
| [2216](#L2216) | $name\_options.="<option value='".sl\_comma($value[sl\_store])."'>".sl\_comma($value[sl\_store])."</option>"; |
| [2217](#L2217) | } |
| [2218](#L2218) | } |
| [2219](#L2219) | }\*/ |
| [2220](#L2220) |  |
| [2221](#L2221) | if ($sl\_vars['theme']!="") { |
| [2222](#L2222) | $theme\_base=SL\_UPLOADS\_BASE."/themes/".$sl\_vars['theme']; |
| [2223](#L2223) | $theme\_path=SL\_UPLOADS\_PATH."/themes/".$sl\_vars['theme']; |
| [2224](#L2224) | } |
| [2225](#L2225) | else { |
| [2226](#L2226) | $theme\_base=SL\_UPLOADS\_BASE."/images"; |
| [2227](#L2227) | $theme\_path=SL\_UPLOADS\_PATH."/images"; |
| [2228](#L2228) | } |
| [2229](#L2229) |  |
| [2230](#L2230) | if (!file\_exists($theme\_path."/".$sl\_search\_button)) { |
| [2231](#L2231) | $theme\_base=SL\_BASE."/images"; |
| [2232](#L2232) | $theme\_path=SL\_PATH."/images"; |
| [2233](#L2233) | } |
| [2234](#L2234) | $submit\_img=$theme\_base."/".$sl\_search\_button; |
| [2235](#L2235) | $loading\_img=(file\_exists(SL\_UPLOADS\_PATH."/images/loading.gif"))? SL\_UPLOADS\_BASE."/images/loading.gif" : SL\_BASE."/images/loading.gif"; //for loading/processing gif image |
| [2236](#L2236) | $mousedown=(file\_exists($theme\_path."/".$sl\_search\_button\_down))? "onmousedown=\"this.src='$theme\_base/".$sl\_search\_button\_down."'\" onmouseup=\"this.src='$theme\_base/".$sl\_search\_button."'\"" : ""; |
| [2237](#L2237) | $mouseover=(file\_exists($theme\_path."/".$sl\_search\_button\_over))? "onmouseover=\"this.src='$theme\_base/".$sl\_search\_button\_over."'\" onmouseout=\"this.src='$theme\_base/".$sl\_search\_button."'\"" : ""; |
| [2238](#L2238) | $button\_style=(file\_exists($theme\_path."/".$sl\_search\_button))? "type='image' src='$submit\_img' $mousedown $mouseover" : "type='submit'"; |
| [2239](#L2239) | $button\_style.=" onclick=\"showLoadImg('show', 'loadImg');\""; //added 3/30/12 for loading/processing gif image |
| [2240](#L2240) | //print "$submit\_img | ".SL\_UPLOADS\_PATH."/themes/".$sl\_vars['theme']."/search\_button.png"; |
| [2241](#L2241) | $hide=($sl\_vars['remove\_credits']==1)? "display:none;" : ""; |
| [2242](#L2242) |  |
| [2243](#L2243) | $form=" |
| [2244](#L2244) | <div id='sl\_div'> |
| [2245](#L2245) | <form onsubmit='searchLocations(); return false;' id='searchForm' action=''> |
| [2246](#L2246) | <table border='0' cellpadding='3px' class='sl\_header' style='width:$width$width\_units;'><tr> |
| [2247](#L2247) | <td valign='top' id='search\_label'>$sl\_search\_label&nbsp;</td> |
| [2248](#L2248) | <td "; |
| [2249](#L2249) |  |
| [2250](#L2250) | if ($sl\_vars['use\_city\_search']!=1) {$form.=" colspan='4' ";} |
| [2251](#L2251) |  |
| [2252](#L2252) | $form.=" valign='top'><input type='text' id='addressInput' size='50' /></td> |
| [2253](#L2253) | "; |
| [2254](#L2254) |  |
| [2255](#L2255) | if (!empty($cs\_array) && $sl\_vars['use\_city\_search']==1) { |
| [2256](#L2256) | $form.="<td valign='top'></td>"; |
| [2257](#L2257) | } |
| [2258](#L2258) |  |
| [2259](#L2259) | if (!empty($cs\_array) && $sl\_vars['use\_city\_search']==1) { |
| [2260](#L2260) | $form.="<td id='addressInput2\_container' colspan='2'>"; |
| [2261](#L2261) | $form.="<select id='addressInput2' onchange='aI=document.getElementById(\"searchForm\").addressInput;if(this.value!=\"\"){oldvalue=aI.value;aI.value=this.value;}else{aI.value=oldvalue;}'>"; |
| [2262](#L2262) | if (!empty($sl\_city\_dropdown\_label)) { |
| [2263](#L2263) | $form.="<option value=''>".$sl\_city\_dropdown\_label."</option>"; |
| [2264](#L2264) | } |
| [2265](#L2265) | $form.="$cs\_options</select></td>"; |
| [2266](#L2266) | } |
| [2267](#L2267) |  |
| [2268](#L2268) | /\*if ($name\_array && $sl\_vars['use\_name\_search']==1) { |
| [2269](#L2269) | $form.="<td valign='top'><nobr>&nbsp;<b>OR</b>&nbsp;</nobr></td>"; |
| [2270](#L2270) | } |
| [2271](#L2271) |  |
| [2272](#L2272) | if ($name\_array && $sl\_vars['use\_name\_search']==1) { |
| [2273](#L2273) | $form.=" |
| [2274](#L2274) | <td valign='top'>"; |
| [2275](#L2275) | $form.="<select id='addressInput3' onchange='aI=document.getElementById(\"searchForm\").addressInput;if(this.value!=\"\"){oldvalue=aI.value;aI.value=this.value;}else{aI.value=oldvalue;}'> |
| [2276](#L2276) | <option value=''>--Search By Name--</option> |
| [2277](#L2277) | $name\_options |
| [2278](#L2278) | </select>"; |
| [2279](#L2279) |  |
| [2280](#L2280) | //$form.="<input name='addressInput3'><input type='hidden' value='1' name='name\_search'></td>"; |
| [2281](#L2281) | }\*/ |
| [2282](#L2282) |  |
| [2283](#L2283) |  |
| [2284](#L2284) | $form.=" |
| [2285](#L2285) | </tr><tr> |
| [2286](#L2286) | <td id='radius\_label'>$sl\_radius\_label</td> |
| [2287](#L2287) | <td id='radiusSelect\_td' "; |
| [2288](#L2288) |  |
| [2289](#L2289) | if ($sl\_vars['use\_city\_search']==1) {$form.="colspan='2'";} |
| [2290](#L2290) |  |
| [2291](#L2291) | $form.="><select id='radiusSelect'>$r\_options</select> |
| [2292](#L2292) | </td> |
| [2293](#L2293) | <td valign='top' "; |
| [2294](#L2294) |  |
| [2295](#L2295) | if ($sl\_vars['use\_city\_search']!=1) {$form.="colspan='2'";} |
| [2296](#L2296) |  |
| [2297](#L2297) | $form.=" ><input $button\_style value='Search Locations' id='addressSubmit'/></td> |
| [2298](#L2298) | <td><img src='$loading\_img' id='loadImg' style='opacity:0; filter:alpha(opacity=0); height:28px; vertical-align:bottom; position:relative; '></td> |
| [2299](#L2299) | </tr></table>"; |
| [2300](#L2300) | $form.=(function\_exists("do\_sl\_hook"))? do\_sl\_header() : "" ; |
| [2301](#L2301) | $form.="<table style='width:100%;/\*border:solid silver 1px\*/' cellspacing='0px' cellpadding='0px' > |
| [2302](#L2302) | <tr> |
| [2303](#L2303) | <td style='width:100%' valign='top' id='map\_td'> <div id='sl\_map' style='width:$width$width\_units; height:$height$height\_units'></div><table cellpadding='0px' class='sl\_footer' style='width:$width$width\_units;{$hide}' ><tr><td class='sl\_footer\_left\_column'><a href='http://www.viadat.com/store-locator' target='\_blank' title='WordPress Store Locator -- LotsOfLocales&trade;'>WordPress Store Locator</a></td><td class='sl\_footer\_right\_column'> <a href='http://www.viadat.com' target='\_blank' title='Map Maker for Creating Store Locators or Any Address Maps Using WordPress & Google Maps'>Viadat Creations</a></td></tr></table> |
| [2304](#L2304) | </td> |
| [2305](#L2305) | </tr> |
| [2306](#L2306) | <tr id='cm\_mapTR'> |
| [2307](#L2307) | <td width='' valign='top' style='/\*display:hidden; border-right:solid silver 1px\*/' id='map\_sidebar\_td'> <div id='map\_sidebar' style='width:$width$width\_units;/\* $height$height\_units; \*/'> <div class='text\_below\_map'>$sl\_instruction\_message</div></div> |
| [2308](#L2308) | </td></tr> |
| [2309](#L2309) | </table></form> |
| [2310](#L2310) | </div>"; |
| [2311](#L2311) |  |
| [2312](#L2312) | //preg\_match("@\[STORE-LOCATOR [tag=\"(.\*)\"]?\]@", $matched); |
| [2313](#L2313) | //global $map\_tag=$matched[1]; |
| [2314](#L2314) |  |
| [2315](#L2315) | return preg\_replace("@\[store-locator(.\*)?\]@i", $form, $content); |
| [2316](#L2316) | } |
| [2317](#L2317) | } |
| [2318](#L2318) | } |
| [2319](#L2319) | } |
| [2320](#L2320) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/store-locator/trunk/sl-functions.php?format=txt)
* [Original Format](/export/3222722/store-locator/trunk/sl-functions.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


