=== Content from git.kernel.org_b7080637_20250115_085059.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ebf47215d46992caea660ec01cd618005d9e687a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ebf47215d46992caea660ec01cd618005d9e687a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebf47215d46992caea660ec01cd618005d9e687a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebf47215d46992caea660ec01cd618005d9e687a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-24 09:55:20 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:54 +0100 |
| commit | [ebf47215d46992caea660ec01cd618005d9e687a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebf47215d46992caea660ec01cd618005d9e687a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ebf47215d46992caea660ec01cd618005d9e687a)) | |
| tree | [c16c9f9e87defe6d3d6b542c6278aa7b881910ef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ebf47215d46992caea660ec01cd618005d9e687a) | |
| parent | [2e4854599200f4d021df8ae17e69221d7c149f3e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e4854599200f4d021df8ae17e69221d7c149f3e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebf47215d46992caea660ec01cd618005d9e687a&id2=2e4854599200f4d021df8ae17e69221d7c149f3e)) | |
| download | [linux-ebf47215d46992caea660ec01cd618005d9e687a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ebf47215d46992caea660ec01cd618005d9e687a.tar.gz) | |

svcrdma: fix miss destroy percpu\_counter in svc\_rdma\_proc\_init()[ Upstream commit ce89e742a4c12b20f09a43fec1b21db33f2166cd ]
There's issue as follows:
RPC: Registered rdma transport module.
RPC: Registered rdma backchannel transport module.
RPC: Unregistered rdma transport module.
RPC: Unregistered rdma backchannel transport module.
BUG: unable to handle page fault for address: fffffbfff80c609a
PGD 123fee067 P4D 123fee067 PUD 123fea067 PMD 10c624067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
RIP: 0010:percpu\_counter\_destroy\_many+0xf7/0x2a0
Call Trace:
<TASK>
\_\_die+0x1f/0x70
page\_fault\_oops+0x2cd/0x860
spurious\_kernel\_fault+0x36/0x450
do\_kern\_addr\_fault+0xca/0x100
exc\_page\_fault+0x128/0x150
asm\_exc\_page\_fault+0x26/0x30
percpu\_counter\_destroy\_many+0xf7/0x2a0
mmdrop+0x209/0x350
finish\_task\_switch.isra.0+0x481/0x840
schedule\_tail+0xe/0xd0
ret\_from\_fork+0x23/0x80
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
If register\_sysctl() return NULL, then svc\_rdma\_proc\_cleanup() will not
destroy the percpu counters which init in svc\_rdma\_proc\_init().
If CONFIG\_HOTPLUG\_CPU is enabled, residual nodes may be in the
'percpu\_counters' list. The above issue may occur once the module is
removed. If the CONFIG\_HOTPLUG\_CPU configuration is not enabled, memory
leakage occurs.
To solve above issue just destroy all percpu counters when
register\_sysctl() return NULL.
Fixes: 1e7e55731628 ("svcrdma: Restore read and write stats")
Fixes: 22df5a22462e ("svcrdma: Convert rdma\_stat\_sq\_starve to a per-CPU counter")
Fixes: df971cd853c0 ("svcrdma: Convert rdma\_stat\_recv to a per-CPU counter")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebf47215d46992caea660ec01cd618005d9e687a)

| -rw-r--r-- | [net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtrdma/svc_rdma.c?id=ebf47215d46992caea660ec01cd618005d9e687a) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 5 deletions

| diff --git a/net/sunrpc/xprtrdma/svc\_rdma.c b/net/sunrpc/xprtrdma/svc\_rdma.cindex 58ae6ec4f25b4f..415c0310101f0d 100644--- a/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=2e4854599200f4d021df8ae17e69221d7c149f3e)+++ b/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=ebf47215d46992caea660ec01cd618005d9e687a)@@ -233,25 +233,34 @@ static int svc\_rdma\_proc\_init(void)  rc = percpu\_counter\_init(&svcrdma\_stat\_read, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err; rc = percpu\_counter\_init(&svcrdma\_stat\_recv, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_read; rc = percpu\_counter\_init(&svcrdma\_stat\_sq\_starve, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_recv; rc = percpu\_counter\_init(&svcrdma\_stat\_write, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_sq;  svcrdma\_table\_header = register\_sysctl("sunrpc/svc\_rdma", svcrdma\_parm\_table);+ if (!svcrdma\_table\_header)+ goto err\_write;+ return 0; -out\_err:+err\_write:+ rc = -ENOMEM;+ percpu\_counter\_destroy(&svcrdma\_stat\_write);+err\_sq: percpu\_counter\_destroy(&svcrdma\_stat\_sq\_starve);+err\_recv: percpu\_counter\_destroy(&svcrdma\_stat\_recv);+err\_read: percpu\_counter\_destroy(&svcrdma\_stat\_read);+err: return rc; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:49:36 +0000



=== Content from git.kernel.org_923bb4c3_20250115_085058.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-24 09:55:20 +0800 |
| --- | --- | --- |
| committer | Chuck Lever <chuck.lever@oracle.com> | 2024-11-18 20:23:07 -0500 |
| commit | [ce89e742a4c12b20f09a43fec1b21db33f2166cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd)) | |
| tree | [2c2d9742edefa1c170f96cbd0f9850799b3eb226](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd) | |
| parent | [573954a996c0056b25eda4638edfee8c010e27f7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=573954a996c0056b25eda4638edfee8c010e27f7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd&id2=573954a996c0056b25eda4638edfee8c010e27f7)) | |
| download | [linux-ce89e742a4c12b20f09a43fec1b21db33f2166cd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ce89e742a4c12b20f09a43fec1b21db33f2166cd.tar.gz) | |

svcrdma: fix miss destroy percpu\_counter in svc\_rdma\_proc\_init()There's issue as follows:
RPC: Registered rdma transport module.
RPC: Registered rdma backchannel transport module.
RPC: Unregistered rdma transport module.
RPC: Unregistered rdma backchannel transport module.
BUG: unable to handle page fault for address: fffffbfff80c609a
PGD 123fee067 P4D 123fee067 PUD 123fea067 PMD 10c624067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
RIP: 0010:percpu\_counter\_destroy\_many+0xf7/0x2a0
Call Trace:
<TASK>
\_\_die+0x1f/0x70
page\_fault\_oops+0x2cd/0x860
spurious\_kernel\_fault+0x36/0x450
do\_kern\_addr\_fault+0xca/0x100
exc\_page\_fault+0x128/0x150
asm\_exc\_page\_fault+0x26/0x30
percpu\_counter\_destroy\_many+0xf7/0x2a0
mmdrop+0x209/0x350
finish\_task\_switch.isra.0+0x481/0x840
schedule\_tail+0xe/0xd0
ret\_from\_fork+0x23/0x80
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
If register\_sysctl() return NULL, then svc\_rdma\_proc\_cleanup() will not
destroy the percpu counters which init in svc\_rdma\_proc\_init().
If CONFIG\_HOTPLUG\_CPU is enabled, residual nodes may be in the
'percpu\_counters' list. The above issue may occur once the module is
removed. If the CONFIG\_HOTPLUG\_CPU configuration is not enabled, memory
leakage occurs.
To solve above issue just destroy all percpu counters when
register\_sysctl() return NULL.
Fixes: 1e7e55731628 ("svcrdma: Restore read and write stats")
Fixes: 22df5a22462e ("svcrdma: Convert rdma\_stat\_sq\_starve to a per-CPU counter")
Fixes: df971cd853c0 ("svcrdma: Convert rdma\_stat\_recv to a per-CPU counter")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd)

| -rw-r--r-- | [net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtrdma/svc_rdma.c?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 5 deletions

| diff --git a/net/sunrpc/xprtrdma/svc\_rdma.c b/net/sunrpc/xprtrdma/svc\_rdma.cindex 58ae6ec4f25b4f..415c0310101f0d 100644--- a/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=573954a996c0056b25eda4638edfee8c010e27f7)+++ b/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=ce89e742a4c12b20f09a43fec1b21db33f2166cd)@@ -233,25 +233,34 @@ static int svc\_rdma\_proc\_init(void)  rc = percpu\_counter\_init(&svcrdma\_stat\_read, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err; rc = percpu\_counter\_init(&svcrdma\_stat\_recv, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_read; rc = percpu\_counter\_init(&svcrdma\_stat\_sq\_starve, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_recv; rc = percpu\_counter\_init(&svcrdma\_stat\_write, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_sq;  svcrdma\_table\_header = register\_sysctl("sunrpc/svc\_rdma", svcrdma\_parm\_table);+ if (!svcrdma\_table\_header)+ goto err\_write;+ return 0; -out\_err:+err\_write:+ rc = -ENOMEM;+ percpu\_counter\_destroy(&svcrdma\_stat\_write);+err\_sq: percpu\_counter\_destroy(&svcrdma\_stat\_sq\_starve);+err\_recv: percpu\_counter\_destroy(&svcrdma\_stat\_recv);+err\_read: percpu\_counter\_destroy(&svcrdma\_stat\_read);+err: return rc; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:49:34 +0000



=== Content from git.kernel.org_ce0fadfc_20250115_085053.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-24 09:55:20 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:30 +0100 |
| commit | [1c9a99c89e45b22eb556fd2f3f729f2683f247d5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5)) | |
| tree | [f0201c4b119abd2f8e9a9d89d6d3b44f318ea161](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5) | |
| parent | [bd8524148dd8c123334b066faa90590ba2ef8e6f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd8524148dd8c123334b066faa90590ba2ef8e6f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5&id2=bd8524148dd8c123334b066faa90590ba2ef8e6f)) | |
| download | [linux-1c9a99c89e45b22eb556fd2f3f729f2683f247d5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c9a99c89e45b22eb556fd2f3f729f2683f247d5.tar.gz) | |

svcrdma: fix miss destroy percpu\_counter in svc\_rdma\_proc\_init()[ Upstream commit ce89e742a4c12b20f09a43fec1b21db33f2166cd ]
There's issue as follows:
RPC: Registered rdma transport module.
RPC: Registered rdma backchannel transport module.
RPC: Unregistered rdma transport module.
RPC: Unregistered rdma backchannel transport module.
BUG: unable to handle page fault for address: fffffbfff80c609a
PGD 123fee067 P4D 123fee067 PUD 123fea067 PMD 10c624067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
RIP: 0010:percpu\_counter\_destroy\_many+0xf7/0x2a0
Call Trace:
<TASK>
\_\_die+0x1f/0x70
page\_fault\_oops+0x2cd/0x860
spurious\_kernel\_fault+0x36/0x450
do\_kern\_addr\_fault+0xca/0x100
exc\_page\_fault+0x128/0x150
asm\_exc\_page\_fault+0x26/0x30
percpu\_counter\_destroy\_many+0xf7/0x2a0
mmdrop+0x209/0x350
finish\_task\_switch.isra.0+0x481/0x840
schedule\_tail+0xe/0xd0
ret\_from\_fork+0x23/0x80
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
If register\_sysctl() return NULL, then svc\_rdma\_proc\_cleanup() will not
destroy the percpu counters which init in svc\_rdma\_proc\_init().
If CONFIG\_HOTPLUG\_CPU is enabled, residual nodes may be in the
'percpu\_counters' list. The above issue may occur once the module is
removed. If the CONFIG\_HOTPLUG\_CPU configuration is not enabled, memory
leakage occurs.
To solve above issue just destroy all percpu counters when
register\_sysctl() return NULL.
Fixes: 1e7e55731628 ("svcrdma: Restore read and write stats")
Fixes: 22df5a22462e ("svcrdma: Convert rdma\_stat\_sq\_starve to a per-CPU counter")
Fixes: df971cd853c0 ("svcrdma: Convert rdma\_stat\_recv to a per-CPU counter")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5)

| -rw-r--r-- | [net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtrdma/svc_rdma.c?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 5 deletions

| diff --git a/net/sunrpc/xprtrdma/svc\_rdma.c b/net/sunrpc/xprtrdma/svc\_rdma.cindex f0d5eeed4c886f..e1d4e426b21fa9 100644--- a/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=bd8524148dd8c123334b066faa90590ba2ef8e6f)+++ b/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=1c9a99c89e45b22eb556fd2f3f729f2683f247d5)@@ -234,25 +234,34 @@ static int svc\_rdma\_proc\_init(void)  rc = percpu\_counter\_init(&svcrdma\_stat\_read, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err; rc = percpu\_counter\_init(&svcrdma\_stat\_recv, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_read; rc = percpu\_counter\_init(&svcrdma\_stat\_sq\_starve, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_recv; rc = percpu\_counter\_init(&svcrdma\_stat\_write, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_sq;  svcrdma\_table\_header = register\_sysctl("sunrpc/svc\_rdma", svcrdma\_parm\_table);+ if (!svcrdma\_table\_header)+ goto err\_write;+ return 0; -out\_err:+err\_write:+ rc = -ENOMEM;+ percpu\_counter\_destroy(&svcrdma\_stat\_write);+err\_sq: percpu\_counter\_destroy(&svcrdma\_stat\_sq\_starve);+err\_recv: percpu\_counter\_destroy(&svcrdma\_stat\_recv);+err\_read: percpu\_counter\_destroy(&svcrdma\_stat\_read);+err: return rc; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:49:29 +0000



=== Content from git.kernel.org_72bafe1f_20250115_085054.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=20322edcbad82a60321a8615a99ca73a9611115f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20322edcbad82a60321a8615a99ca73a9611115f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20322edcbad82a60321a8615a99ca73a9611115f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20322edcbad82a60321a8615a99ca73a9611115f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-24 09:55:20 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:26 +0100 |
| commit | [20322edcbad82a60321a8615a99ca73a9611115f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20322edcbad82a60321a8615a99ca73a9611115f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=20322edcbad82a60321a8615a99ca73a9611115f)) | |
| tree | [6fffb5669fd33e36d014ae7d13ba6d8fa80f6d3b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20322edcbad82a60321a8615a99ca73a9611115f) | |
| parent | [ad4363a24a5746b257c0beb5d8cc68f9b62c173f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad4363a24a5746b257c0beb5d8cc68f9b62c173f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20322edcbad82a60321a8615a99ca73a9611115f&id2=ad4363a24a5746b257c0beb5d8cc68f9b62c173f)) | |
| download | [linux-20322edcbad82a60321a8615a99ca73a9611115f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-20322edcbad82a60321a8615a99ca73a9611115f.tar.gz) | |

svcrdma: fix miss destroy percpu\_counter in svc\_rdma\_proc\_init()[ Upstream commit ce89e742a4c12b20f09a43fec1b21db33f2166cd ]
There's issue as follows:
RPC: Registered rdma transport module.
RPC: Registered rdma backchannel transport module.
RPC: Unregistered rdma transport module.
RPC: Unregistered rdma backchannel transport module.
BUG: unable to handle page fault for address: fffffbfff80c609a
PGD 123fee067 P4D 123fee067 PUD 123fea067 PMD 10c624067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
RIP: 0010:percpu\_counter\_destroy\_many+0xf7/0x2a0
Call Trace:
<TASK>
\_\_die+0x1f/0x70
page\_fault\_oops+0x2cd/0x860
spurious\_kernel\_fault+0x36/0x450
do\_kern\_addr\_fault+0xca/0x100
exc\_page\_fault+0x128/0x150
asm\_exc\_page\_fault+0x26/0x30
percpu\_counter\_destroy\_many+0xf7/0x2a0
mmdrop+0x209/0x350
finish\_task\_switch.isra.0+0x481/0x840
schedule\_tail+0xe/0xd0
ret\_from\_fork+0x23/0x80
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
If register\_sysctl() return NULL, then svc\_rdma\_proc\_cleanup() will not
destroy the percpu counters which init in svc\_rdma\_proc\_init().
If CONFIG\_HOTPLUG\_CPU is enabled, residual nodes may be in the
'percpu\_counters' list. The above issue may occur once the module is
removed. If the CONFIG\_HOTPLUG\_CPU configuration is not enabled, memory
leakage occurs.
To solve above issue just destroy all percpu counters when
register\_sysctl() return NULL.
Fixes: 1e7e55731628 ("svcrdma: Restore read and write stats")
Fixes: 22df5a22462e ("svcrdma: Convert rdma\_stat\_sq\_starve to a per-CPU counter")
Fixes: df971cd853c0 ("svcrdma: Convert rdma\_stat\_recv to a per-CPU counter")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20322edcbad82a60321a8615a99ca73a9611115f)

| -rw-r--r-- | [net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtrdma/svc_rdma.c?id=20322edcbad82a60321a8615a99ca73a9611115f) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 5 deletions

| diff --git a/net/sunrpc/xprtrdma/svc\_rdma.c b/net/sunrpc/xprtrdma/svc\_rdma.cindex 58ae6ec4f25b4f..415c0310101f0d 100644--- a/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=ad4363a24a5746b257c0beb5d8cc68f9b62c173f)+++ b/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=20322edcbad82a60321a8615a99ca73a9611115f)@@ -233,25 +233,34 @@ static int svc\_rdma\_proc\_init(void)  rc = percpu\_counter\_init(&svcrdma\_stat\_read, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err; rc = percpu\_counter\_init(&svcrdma\_stat\_recv, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_read; rc = percpu\_counter\_init(&svcrdma\_stat\_sq\_starve, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_recv; rc = percpu\_counter\_init(&svcrdma\_stat\_write, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_sq;  svcrdma\_table\_header = register\_sysctl("sunrpc/svc\_rdma", svcrdma\_parm\_table);+ if (!svcrdma\_table\_header)+ goto err\_write;+ return 0; -out\_err:+err\_write:+ rc = -ENOMEM;+ percpu\_counter\_destroy(&svcrdma\_stat\_write);+err\_sq: percpu\_counter\_destroy(&svcrdma\_stat\_sq\_starve);+err\_recv: percpu\_counter\_destroy(&svcrdma\_stat\_recv);+err\_read: percpu\_counter\_destroy(&svcrdma\_stat\_read);+err: return rc; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:49:30 +0000



=== Content from git.kernel.org_341bab67_20250115_085056.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-24 09:55:20 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:07 +0100 |
| commit | [a12c897adf40b6e2b4a56e6912380c31bd7b2479](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479)) | |
| tree | [eb5417952b456de03f61b627356b17e5430f8661](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479) | |
| parent | [57dee363185bb49bbc088229b879e39fedc9f4a2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57dee363185bb49bbc088229b879e39fedc9f4a2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479&id2=57dee363185bb49bbc088229b879e39fedc9f4a2)) | |
| download | [linux-a12c897adf40b6e2b4a56e6912380c31bd7b2479.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a12c897adf40b6e2b4a56e6912380c31bd7b2479.tar.gz) | |

svcrdma: fix miss destroy percpu\_counter in svc\_rdma\_proc\_init()[ Upstream commit ce89e742a4c12b20f09a43fec1b21db33f2166cd ]
There's issue as follows:
RPC: Registered rdma transport module.
RPC: Registered rdma backchannel transport module.
RPC: Unregistered rdma transport module.
RPC: Unregistered rdma backchannel transport module.
BUG: unable to handle page fault for address: fffffbfff80c609a
PGD 123fee067 P4D 123fee067 PUD 123fea067 PMD 10c624067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
RIP: 0010:percpu\_counter\_destroy\_many+0xf7/0x2a0
Call Trace:
<TASK>
\_\_die+0x1f/0x70
page\_fault\_oops+0x2cd/0x860
spurious\_kernel\_fault+0x36/0x450
do\_kern\_addr\_fault+0xca/0x100
exc\_page\_fault+0x128/0x150
asm\_exc\_page\_fault+0x26/0x30
percpu\_counter\_destroy\_many+0xf7/0x2a0
mmdrop+0x209/0x350
finish\_task\_switch.isra.0+0x481/0x840
schedule\_tail+0xe/0xd0
ret\_from\_fork+0x23/0x80
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
If register\_sysctl() return NULL, then svc\_rdma\_proc\_cleanup() will not
destroy the percpu counters which init in svc\_rdma\_proc\_init().
If CONFIG\_HOTPLUG\_CPU is enabled, residual nodes may be in the
'percpu\_counters' list. The above issue may occur once the module is
removed. If the CONFIG\_HOTPLUG\_CPU configuration is not enabled, memory
leakage occurs.
To solve above issue just destroy all percpu counters when
register\_sysctl() return NULL.
Fixes: 1e7e55731628 ("svcrdma: Restore read and write stats")
Fixes: 22df5a22462e ("svcrdma: Convert rdma\_stat\_sq\_starve to a per-CPU counter")
Fixes: df971cd853c0 ("svcrdma: Convert rdma\_stat\_recv to a per-CPU counter")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479)

| -rw-r--r-- | [net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtrdma/svc_rdma.c?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 5 deletions

| diff --git a/net/sunrpc/xprtrdma/svc\_rdma.c b/net/sunrpc/xprtrdma/svc\_rdma.cindex f0d5eeed4c886f..e1d4e426b21fa9 100644--- a/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=57dee363185bb49bbc088229b879e39fedc9f4a2)+++ b/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=a12c897adf40b6e2b4a56e6912380c31bd7b2479)@@ -234,25 +234,34 @@ static int svc\_rdma\_proc\_init(void)  rc = percpu\_counter\_init(&svcrdma\_stat\_read, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err; rc = percpu\_counter\_init(&svcrdma\_stat\_recv, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_read; rc = percpu\_counter\_init(&svcrdma\_stat\_sq\_starve, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_recv; rc = percpu\_counter\_init(&svcrdma\_stat\_write, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_sq;  svcrdma\_table\_header = register\_sysctl("sunrpc/svc\_rdma", svcrdma\_parm\_table);+ if (!svcrdma\_table\_header)+ goto err\_write;+ return 0; -out\_err:+err\_write:+ rc = -ENOMEM;+ percpu\_counter\_destroy(&svcrdma\_stat\_write);+err\_sq: percpu\_counter\_destroy(&svcrdma\_stat\_sq\_starve);+err\_recv: percpu\_counter\_destroy(&svcrdma\_stat\_recv);+err\_read: percpu\_counter\_destroy(&svcrdma\_stat\_read);+err: return rc; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:49:33 +0000



=== Content from git.kernel.org_6b37c0ef_20250115_085055.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=94d2d6d398706ab7218a26d61e12919c4b498e09)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=94d2d6d398706ab7218a26d61e12919c4b498e09)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94d2d6d398706ab7218a26d61e12919c4b498e09)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94d2d6d398706ab7218a26d61e12919c4b498e09)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-24 09:55:20 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:47 +0100 |
| commit | [94d2d6d398706ab7218a26d61e12919c4b498e09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94d2d6d398706ab7218a26d61e12919c4b498e09) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=94d2d6d398706ab7218a26d61e12919c4b498e09)) | |
| tree | [90458e13fa264828ade4822af0edd13f71076d3d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=94d2d6d398706ab7218a26d61e12919c4b498e09) | |
| parent | [f143df272cc15187ab91b5c62c57b0da75099ab6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f143df272cc15187ab91b5c62c57b0da75099ab6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94d2d6d398706ab7218a26d61e12919c4b498e09&id2=f143df272cc15187ab91b5c62c57b0da75099ab6)) | |
| download | [linux-94d2d6d398706ab7218a26d61e12919c4b498e09.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-94d2d6d398706ab7218a26d61e12919c4b498e09.tar.gz) | |

svcrdma: fix miss destroy percpu\_counter in svc\_rdma\_proc\_init()[ Upstream commit ce89e742a4c12b20f09a43fec1b21db33f2166cd ]
There's issue as follows:
RPC: Registered rdma transport module.
RPC: Registered rdma backchannel transport module.
RPC: Unregistered rdma transport module.
RPC: Unregistered rdma backchannel transport module.
BUG: unable to handle page fault for address: fffffbfff80c609a
PGD 123fee067 P4D 123fee067 PUD 123fea067 PMD 10c624067 PTE 0
Oops: Oops: 0000 [#1] PREEMPT SMP KASAN NOPTI
RIP: 0010:percpu\_counter\_destroy\_many+0xf7/0x2a0
Call Trace:
<TASK>
\_\_die+0x1f/0x70
page\_fault\_oops+0x2cd/0x860
spurious\_kernel\_fault+0x36/0x450
do\_kern\_addr\_fault+0xca/0x100
exc\_page\_fault+0x128/0x150
asm\_exc\_page\_fault+0x26/0x30
percpu\_counter\_destroy\_many+0xf7/0x2a0
mmdrop+0x209/0x350
finish\_task\_switch.isra.0+0x481/0x840
schedule\_tail+0xe/0xd0
ret\_from\_fork+0x23/0x80
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
If register\_sysctl() return NULL, then svc\_rdma\_proc\_cleanup() will not
destroy the percpu counters which init in svc\_rdma\_proc\_init().
If CONFIG\_HOTPLUG\_CPU is enabled, residual nodes may be in the
'percpu\_counters' list. The above issue may occur once the module is
removed. If the CONFIG\_HOTPLUG\_CPU configuration is not enabled, memory
leakage occurs.
To solve above issue just destroy all percpu counters when
register\_sysctl() return NULL.
Fixes: 1e7e55731628 ("svcrdma: Restore read and write stats")
Fixes: 22df5a22462e ("svcrdma: Convert rdma\_stat\_sq\_starve to a per-CPU counter")
Fixes: df971cd853c0 ("svcrdma: Convert rdma\_stat\_recv to a per-CPU counter")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94d2d6d398706ab7218a26d61e12919c4b498e09)

| -rw-r--r-- | [net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtrdma/svc_rdma.c?id=94d2d6d398706ab7218a26d61e12919c4b498e09) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 5 deletions

| diff --git a/net/sunrpc/xprtrdma/svc\_rdma.c b/net/sunrpc/xprtrdma/svc\_rdma.cindex f0d5eeed4c886f..e1d4e426b21fa9 100644--- a/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=f143df272cc15187ab91b5c62c57b0da75099ab6)+++ b/[net/sunrpc/xprtrdma/svc\_rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtrdma/svc_rdma.c?id=94d2d6d398706ab7218a26d61e12919c4b498e09)@@ -234,25 +234,34 @@ static int svc\_rdma\_proc\_init(void)  rc = percpu\_counter\_init(&svcrdma\_stat\_read, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err; rc = percpu\_counter\_init(&svcrdma\_stat\_recv, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_read; rc = percpu\_counter\_init(&svcrdma\_stat\_sq\_starve, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_recv; rc = percpu\_counter\_init(&svcrdma\_stat\_write, 0, GFP\_KERNEL); if (rc)- goto out\_err;+ goto err\_sq;  svcrdma\_table\_header = register\_sysctl("sunrpc/svc\_rdma", svcrdma\_parm\_table);+ if (!svcrdma\_table\_header)+ goto err\_write;+ return 0; -out\_err:+err\_write:+ rc = -ENOMEM;+ percpu\_counter\_destroy(&svcrdma\_stat\_write);+err\_sq: percpu\_counter\_destroy(&svcrdma\_stat\_sq\_starve);+err\_recv: percpu\_counter\_destroy(&svcrdma\_stat\_recv);+err\_read: percpu\_counter\_destroy(&svcrdma\_stat\_read);+err: return rc; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:49:31 +0000


