=== Content from git.kernel.org_4790a0af_20250114_230235.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-11-25 17:17:23 -0300 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-11-25 14:49:55 -0600 |
| commit | [4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2)) | |
| tree | [d3e25ac2e3fdb069f2e8537d9e1a489d4cb88811](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2) | |
| parent | [ab02d8774181b2834247e913f61e471af149979e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab02d8774181b2834247e913f61e471af149979e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2&id2=ab02d8774181b2834247e913f61e471af149979e)) | |
| download | [linux-4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2.tar.gz) | |

smb: client: fix NULL ptr deref in crypto\_aead\_setkey()Neither SMB3.0 or SMB3.02 supports encryption negotiate context, so
when SMB2\_GLOBAL\_CAP\_ENCRYPTION flag is set in the negotiate response,
the client uses AES-128-CCM as the default cipher. See MS-SMB2
3.3.5.4.
Commit b0abcd65ec54 ("smb: client: fix UAF in async decryption") added
a @server->cipher\_type check to conditionally call
smb3\_crypto\_aead\_allocate(), but that check would always be false as
@server->cipher\_type is unset for SMB3.02.
Fix the following KASAN splat by setting @server->cipher\_type for
SMB3.02 as well.
mount.cifs //srv/share /mnt -o vers=3.02,seal,...
BUG: KASAN: null-ptr-deref in crypto\_aead\_setkey+0x2c/0x130
Read of size 8 at addr 0000000000000020 by task mount.cifs/1095
CPU: 1 UID: 0 PID: 1095 Comm: mount.cifs Not tainted 6.12.0 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-3.fc41
04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? crypto\_aead\_setkey+0x2c/0x130
kasan\_report+0xda/0x110
? crypto\_aead\_setkey+0x2c/0x130
crypto\_aead\_setkey+0x2c/0x130
crypt\_message+0x258/0xec0 [cifs]
? \_\_asan\_memset+0x23/0x50
? \_\_pfx\_crypt\_message+0x10/0x10 [cifs]
? mark\_lock+0xb0/0x6a0
? hlock\_class+0x32/0xb0
? mark\_lock+0xb0/0x6a0
smb3\_init\_transform\_rq+0x352/0x3f0 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
smb\_send\_rqst+0x144/0x230 [cifs]
? \_\_pfx\_smb\_send\_rqst+0x10/0x10 [cifs]
? hlock\_class+0x32/0xb0
? smb2\_setup\_request+0x225/0x3a0 [cifs]
? \_\_pfx\_cifs\_compound\_last\_callback+0x10/0x10 [cifs]
compound\_send\_recv+0x59b/0x1140 [cifs]
? \_\_pfx\_compound\_send\_recv+0x10/0x10 [cifs]
? \_\_create\_object+0x5e/0x90
? hlock\_class+0x32/0xb0
? do\_raw\_spin\_unlock+0x9a/0xf0
cifs\_send\_recv+0x23/0x30 [cifs]
SMB2\_tcon+0x3ec/0xb30 [cifs]
? \_\_pfx\_SMB2\_tcon+0x10/0x10 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
? \_\_pfx\_lock\_release+0x10/0x10
? do\_raw\_spin\_trylock+0xc6/0x120
? lock\_acquire+0x3f/0x90
? \_get\_xid+0x16/0xd0 [cifs]
? \_\_pfx\_SMB2\_tcon+0x10/0x10 [cifs]
? cifs\_get\_smb\_ses+0xcdd/0x10a0 [cifs]
cifs\_get\_smb\_ses+0xcdd/0x10a0 [cifs]
? \_\_pfx\_cifs\_get\_smb\_ses+0x10/0x10 [cifs]
? cifs\_get\_tcp\_session+0xaa0/0xca0 [cifs]
cifs\_mount\_get\_session+0x8a/0x210 [cifs]
dfs\_mount\_share+0x1b0/0x11d0 [cifs]
? \_\_pfx\_\_\_lock\_acquire+0x10/0x10
? \_\_pfx\_dfs\_mount\_share+0x10/0x10 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
? find\_held\_lock+0x8a/0xa0
? hlock\_class+0x32/0xb0
? lock\_release+0x203/0x5d0
cifs\_mount+0xb3/0x3d0 [cifs]
? do\_raw\_spin\_trylock+0xc6/0x120
? \_\_pfx\_cifs\_mount+0x10/0x10 [cifs]
? lock\_acquire+0x3f/0x90
? find\_nls+0x16/0xa0
? smb3\_update\_mnt\_flags+0x372/0x3b0 [cifs]
cifs\_smb3\_do\_mount+0x1e2/0xc80 [cifs]
? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
? \_\_pfx\_cifs\_smb3\_do\_mount+0x10/0x10 [cifs]
smb3\_get\_tree+0x1bf/0x330 [cifs]
vfs\_get\_tree+0x4a/0x160
path\_mount+0x3c1/0xfb0
? kasan\_quarantine\_put+0xc7/0x1d0
? \_\_pfx\_path\_mount+0x10/0x10
? kmem\_cache\_free+0x118/0x3e0
? user\_path\_at+0x74/0xa0
\_\_x64\_sys\_mount+0x1a6/0x1e0
? \_\_pfx\_\_\_x64\_sys\_mount+0x10/0x10
? mark\_held\_locks+0x1a/0x90
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Cc: Tom Talpey <tom@talpey.com>
Reported-by: Jianhong Yin <jiyin@redhat.com>
Cc: stable@vger.kernel.org # v6.12
Fixes: b0abcd65ec54 ("smb: client: fix UAF in async decryption")
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2)

| -rw-r--r-- | [fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2pdu.c?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/smb/client/smb2pdu.c b/fs/smb/client/smb2pdu.cindex 0552368355370a..6d4c48b33701b0 100644--- a/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=ab02d8774181b2834247e913f61e471af149979e)+++ b/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2)@@ -1231,7 +1231,9 @@ SMB2\_negotiate(const unsigned int xid, \* SMB3.0 supports only 1 cipher and doesn't have a encryption neg context \* Set the cipher type manually. \*/- if (server->dialect == SMB30\_PROT\_ID && (server->capabilities & SMB2\_GLOBAL\_CAP\_ENCRYPTION))+ if ((server->dialect == SMB30\_PROT\_ID ||+ server->dialect == SMB302\_PROT\_ID) &&+ (server->capabilities & SMB2\_GLOBAL\_CAP\_ENCRYPTION)) server->cipher\_type = SMB2\_ENCRYPTION\_AES128\_CCM;  security\_blob = smb2\_get\_data\_area\_len(&blob\_offset, &blob\_length, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:01:11 +0000



=== Content from git.kernel.org_ddfcd4fe_20250114_230232.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=22127c1dc04364cda3da812161e70921e6c3c0af)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22127c1dc04364cda3da812161e70921e6c3c0af)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22127c1dc04364cda3da812161e70921e6c3c0af)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22127c1dc04364cda3da812161e70921e6c3c0af)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-11-25 17:17:23 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:18 +0100 |
| commit | [22127c1dc04364cda3da812161e70921e6c3c0af](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22127c1dc04364cda3da812161e70921e6c3c0af) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=22127c1dc04364cda3da812161e70921e6c3c0af)) | |
| tree | [2faf245789c31ce393a938b8f325b09b6ddbf625](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22127c1dc04364cda3da812161e70921e6c3c0af) | |
| parent | [f20b77f7897e6aab9ce5527e6016ad2be5d70a33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f20b77f7897e6aab9ce5527e6016ad2be5d70a33) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22127c1dc04364cda3da812161e70921e6c3c0af&id2=f20b77f7897e6aab9ce5527e6016ad2be5d70a33)) | |
| download | [linux-22127c1dc04364cda3da812161e70921e6c3c0af.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-22127c1dc04364cda3da812161e70921e6c3c0af.tar.gz) | |

smb: client: fix NULL ptr deref in crypto\_aead\_setkey()commit 4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2 upstream.
Neither SMB3.0 or SMB3.02 supports encryption negotiate context, so
when SMB2\_GLOBAL\_CAP\_ENCRYPTION flag is set in the negotiate response,
the client uses AES-128-CCM as the default cipher. See MS-SMB2
3.3.5.4.
Commit b0abcd65ec54 ("smb: client: fix UAF in async decryption") added
a @server->cipher\_type check to conditionally call
smb3\_crypto\_aead\_allocate(), but that check would always be false as
@server->cipher\_type is unset for SMB3.02.
Fix the following KASAN splat by setting @server->cipher\_type for
SMB3.02 as well.
mount.cifs //srv/share /mnt -o vers=3.02,seal,...
BUG: KASAN: null-ptr-deref in crypto\_aead\_setkey+0x2c/0x130
Read of size 8 at addr 0000000000000020 by task mount.cifs/1095
CPU: 1 UID: 0 PID: 1095 Comm: mount.cifs Not tainted 6.12.0 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-3.fc41
04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? crypto\_aead\_setkey+0x2c/0x130
kasan\_report+0xda/0x110
? crypto\_aead\_setkey+0x2c/0x130
crypto\_aead\_setkey+0x2c/0x130
crypt\_message+0x258/0xec0 [cifs]
? \_\_asan\_memset+0x23/0x50
? \_\_pfx\_crypt\_message+0x10/0x10 [cifs]
? mark\_lock+0xb0/0x6a0
? hlock\_class+0x32/0xb0
? mark\_lock+0xb0/0x6a0
smb3\_init\_transform\_rq+0x352/0x3f0 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
smb\_send\_rqst+0x144/0x230 [cifs]
? \_\_pfx\_smb\_send\_rqst+0x10/0x10 [cifs]
? hlock\_class+0x32/0xb0
? smb2\_setup\_request+0x225/0x3a0 [cifs]
? \_\_pfx\_cifs\_compound\_last\_callback+0x10/0x10 [cifs]
compound\_send\_recv+0x59b/0x1140 [cifs]
? \_\_pfx\_compound\_send\_recv+0x10/0x10 [cifs]
? \_\_create\_object+0x5e/0x90
? hlock\_class+0x32/0xb0
? do\_raw\_spin\_unlock+0x9a/0xf0
cifs\_send\_recv+0x23/0x30 [cifs]
SMB2\_tcon+0x3ec/0xb30 [cifs]
? \_\_pfx\_SMB2\_tcon+0x10/0x10 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
? \_\_pfx\_lock\_release+0x10/0x10
? do\_raw\_spin\_trylock+0xc6/0x120
? lock\_acquire+0x3f/0x90
? \_get\_xid+0x16/0xd0 [cifs]
? \_\_pfx\_SMB2\_tcon+0x10/0x10 [cifs]
? cifs\_get\_smb\_ses+0xcdd/0x10a0 [cifs]
cifs\_get\_smb\_ses+0xcdd/0x10a0 [cifs]
? \_\_pfx\_cifs\_get\_smb\_ses+0x10/0x10 [cifs]
? cifs\_get\_tcp\_session+0xaa0/0xca0 [cifs]
cifs\_mount\_get\_session+0x8a/0x210 [cifs]
dfs\_mount\_share+0x1b0/0x11d0 [cifs]
? \_\_pfx\_\_\_lock\_acquire+0x10/0x10
? \_\_pfx\_dfs\_mount\_share+0x10/0x10 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
? find\_held\_lock+0x8a/0xa0
? hlock\_class+0x32/0xb0
? lock\_release+0x203/0x5d0
cifs\_mount+0xb3/0x3d0 [cifs]
? do\_raw\_spin\_trylock+0xc6/0x120
? \_\_pfx\_cifs\_mount+0x10/0x10 [cifs]
? lock\_acquire+0x3f/0x90
? find\_nls+0x16/0xa0
? smb3\_update\_mnt\_flags+0x372/0x3b0 [cifs]
cifs\_smb3\_do\_mount+0x1e2/0xc80 [cifs]
? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
? \_\_pfx\_cifs\_smb3\_do\_mount+0x10/0x10 [cifs]
smb3\_get\_tree+0x1bf/0x330 [cifs]
vfs\_get\_tree+0x4a/0x160
path\_mount+0x3c1/0xfb0
? kasan\_quarantine\_put+0xc7/0x1d0
? \_\_pfx\_path\_mount+0x10/0x10
? kmem\_cache\_free+0x118/0x3e0
? user\_path\_at+0x74/0xa0
\_\_x64\_sys\_mount+0x1a6/0x1e0
? \_\_pfx\_\_\_x64\_sys\_mount+0x10/0x10
? mark\_held\_locks+0x1a/0x90
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Cc: Tom Talpey <tom@talpey.com>
Reported-by: Jianhong Yin <jiyin@redhat.com>
Cc: stable@vger.kernel.org # v6.12
Fixes: b0abcd65ec54 ("smb: client: fix UAF in async decryption")
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22127c1dc04364cda3da812161e70921e6c3c0af)

| -rw-r--r-- | [fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2pdu.c?id=22127c1dc04364cda3da812161e70921e6c3c0af) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/smb/client/smb2pdu.c b/fs/smb/client/smb2pdu.cindex 194a4262d57a09..30565f7ef308f8 100644--- a/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=f20b77f7897e6aab9ce5527e6016ad2be5d70a33)+++ b/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=22127c1dc04364cda3da812161e70921e6c3c0af)@@ -1230,7 +1230,9 @@ SMB2\_negotiate(const unsigned int xid, \* SMB3.0 supports only 1 cipher and doesn't have a encryption neg context \* Set the cipher type manually. \*/- if (server->dialect == SMB30\_PROT\_ID && (server->capabilities & SMB2\_GLOBAL\_CAP\_ENCRYPTION))+ if ((server->dialect == SMB30\_PROT\_ID ||+ server->dialect == SMB302\_PROT\_ID) &&+ (server->capabilities & SMB2\_GLOBAL\_CAP\_ENCRYPTION)) server->cipher\_type = SMB2\_ENCRYPTION\_AES128\_CCM;  security\_blob = smb2\_get\_data\_area\_len(&blob\_offset, &blob\_length, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:01:09 +0000



=== Content from git.kernel.org_34717396_20250114_230236.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-11-25 17:17:23 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:52 +0100 |
| commit | [9b8904b53b5ace0519c74cd89fc3ca763f3856d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4)) | |
| tree | [05219680b6684abf7ecb32d7604205fe3be7ba4f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4) | |
| parent | [96261adb998a3b513468b6ce17dbec76be5507d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96261adb998a3b513468b6ce17dbec76be5507d4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4&id2=96261adb998a3b513468b6ce17dbec76be5507d4)) | |
| download | [linux-9b8904b53b5ace0519c74cd89fc3ca763f3856d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9b8904b53b5ace0519c74cd89fc3ca763f3856d4.tar.gz) | |

smb: client: fix NULL ptr deref in crypto\_aead\_setkey()commit 4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2 upstream.
Neither SMB3.0 or SMB3.02 supports encryption negotiate context, so
when SMB2\_GLOBAL\_CAP\_ENCRYPTION flag is set in the negotiate response,
the client uses AES-128-CCM as the default cipher. See MS-SMB2
3.3.5.4.
Commit b0abcd65ec54 ("smb: client: fix UAF in async decryption") added
a @server->cipher\_type check to conditionally call
smb3\_crypto\_aead\_allocate(), but that check would always be false as
@server->cipher\_type is unset for SMB3.02.
Fix the following KASAN splat by setting @server->cipher\_type for
SMB3.02 as well.
mount.cifs //srv/share /mnt -o vers=3.02,seal,...
BUG: KASAN: null-ptr-deref in crypto\_aead\_setkey+0x2c/0x130
Read of size 8 at addr 0000000000000020 by task mount.cifs/1095
CPU: 1 UID: 0 PID: 1095 Comm: mount.cifs Not tainted 6.12.0 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-3.fc41
04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? crypto\_aead\_setkey+0x2c/0x130
kasan\_report+0xda/0x110
? crypto\_aead\_setkey+0x2c/0x130
crypto\_aead\_setkey+0x2c/0x130
crypt\_message+0x258/0xec0 [cifs]
? \_\_asan\_memset+0x23/0x50
? \_\_pfx\_crypt\_message+0x10/0x10 [cifs]
? mark\_lock+0xb0/0x6a0
? hlock\_class+0x32/0xb0
? mark\_lock+0xb0/0x6a0
smb3\_init\_transform\_rq+0x352/0x3f0 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
smb\_send\_rqst+0x144/0x230 [cifs]
? \_\_pfx\_smb\_send\_rqst+0x10/0x10 [cifs]
? hlock\_class+0x32/0xb0
? smb2\_setup\_request+0x225/0x3a0 [cifs]
? \_\_pfx\_cifs\_compound\_last\_callback+0x10/0x10 [cifs]
compound\_send\_recv+0x59b/0x1140 [cifs]
? \_\_pfx\_compound\_send\_recv+0x10/0x10 [cifs]
? \_\_create\_object+0x5e/0x90
? hlock\_class+0x32/0xb0
? do\_raw\_spin\_unlock+0x9a/0xf0
cifs\_send\_recv+0x23/0x30 [cifs]
SMB2\_tcon+0x3ec/0xb30 [cifs]
? \_\_pfx\_SMB2\_tcon+0x10/0x10 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
? \_\_pfx\_lock\_release+0x10/0x10
? do\_raw\_spin\_trylock+0xc6/0x120
? lock\_acquire+0x3f/0x90
? \_get\_xid+0x16/0xd0 [cifs]
? \_\_pfx\_SMB2\_tcon+0x10/0x10 [cifs]
? cifs\_get\_smb\_ses+0xcdd/0x10a0 [cifs]
cifs\_get\_smb\_ses+0xcdd/0x10a0 [cifs]
? \_\_pfx\_cifs\_get\_smb\_ses+0x10/0x10 [cifs]
? cifs\_get\_tcp\_session+0xaa0/0xca0 [cifs]
cifs\_mount\_get\_session+0x8a/0x210 [cifs]
dfs\_mount\_share+0x1b0/0x11d0 [cifs]
? \_\_pfx\_\_\_lock\_acquire+0x10/0x10
? \_\_pfx\_dfs\_mount\_share+0x10/0x10 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
? find\_held\_lock+0x8a/0xa0
? hlock\_class+0x32/0xb0
? lock\_release+0x203/0x5d0
cifs\_mount+0xb3/0x3d0 [cifs]
? do\_raw\_spin\_trylock+0xc6/0x120
? \_\_pfx\_cifs\_mount+0x10/0x10 [cifs]
? lock\_acquire+0x3f/0x90
? find\_nls+0x16/0xa0
? smb3\_update\_mnt\_flags+0x372/0x3b0 [cifs]
cifs\_smb3\_do\_mount+0x1e2/0xc80 [cifs]
? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
? \_\_pfx\_cifs\_smb3\_do\_mount+0x10/0x10 [cifs]
smb3\_get\_tree+0x1bf/0x330 [cifs]
vfs\_get\_tree+0x4a/0x160
path\_mount+0x3c1/0xfb0
? kasan\_quarantine\_put+0xc7/0x1d0
? \_\_pfx\_path\_mount+0x10/0x10
? kmem\_cache\_free+0x118/0x3e0
? user\_path\_at+0x74/0xa0
\_\_x64\_sys\_mount+0x1a6/0x1e0
? \_\_pfx\_\_\_x64\_sys\_mount+0x10/0x10
? mark\_held\_locks+0x1a/0x90
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Cc: Tom Talpey <tom@talpey.com>
Reported-by: Jianhong Yin <jiyin@redhat.com>
Cc: stable@vger.kernel.org # v6.12
Fixes: b0abcd65ec54 ("smb: client: fix UAF in async decryption")
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4)

| -rw-r--r-- | [fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2pdu.c?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/smb/client/smb2pdu.c b/fs/smb/client/smb2pdu.cindex 6584b5cddc280a..9bc555c3f1c7e9 100644--- a/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=96261adb998a3b513468b6ce17dbec76be5507d4)+++ b/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=9b8904b53b5ace0519c74cd89fc3ca763f3856d4)@@ -1231,7 +1231,9 @@ SMB2\_negotiate(const unsigned int xid, \* SMB3.0 supports only 1 cipher and doesn't have a encryption neg context \* Set the cipher type manually. \*/- if (server->dialect == SMB30\_PROT\_ID && (server->capabilities & SMB2\_GLOBAL\_CAP\_ENCRYPTION))+ if ((server->dialect == SMB30\_PROT\_ID ||+ server->dialect == SMB302\_PROT\_ID) &&+ (server->capabilities & SMB2\_GLOBAL\_CAP\_ENCRYPTION)) server->cipher\_type = SMB2\_ENCRYPTION\_AES128\_CCM;  security\_blob = smb2\_get\_data\_area\_len(&blob\_offset, &blob\_length, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:01:13 +0000



=== Content from git.kernel.org_36092e17_20250114_230234.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-11-25 17:17:23 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:48 +0100 |
| commit | [46f8e25926817272ec8d5bfbd003569bdeb9a8c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8)) | |
| tree | [e113e604c08c10269742ed3503bfcb8abca55de0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8) | |
| parent | [a96f9eb7add30ba0fafcfe7b7aca090978196800](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a96f9eb7add30ba0fafcfe7b7aca090978196800) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8&id2=a96f9eb7add30ba0fafcfe7b7aca090978196800)) | |
| download | [linux-46f8e25926817272ec8d5bfbd003569bdeb9a8c8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-46f8e25926817272ec8d5bfbd003569bdeb9a8c8.tar.gz) | |

smb: client: fix NULL ptr deref in crypto\_aead\_setkey()commit 4bdec0d1f658f7c98749bd2c5a486e6cfa8565d2 upstream.
Neither SMB3.0 or SMB3.02 supports encryption negotiate context, so
when SMB2\_GLOBAL\_CAP\_ENCRYPTION flag is set in the negotiate response,
the client uses AES-128-CCM as the default cipher. See MS-SMB2
3.3.5.4.
Commit b0abcd65ec54 ("smb: client: fix UAF in async decryption") added
a @server->cipher\_type check to conditionally call
smb3\_crypto\_aead\_allocate(), but that check would always be false as
@server->cipher\_type is unset for SMB3.02.
Fix the following KASAN splat by setting @server->cipher\_type for
SMB3.02 as well.
mount.cifs //srv/share /mnt -o vers=3.02,seal,...
BUG: KASAN: null-ptr-deref in crypto\_aead\_setkey+0x2c/0x130
Read of size 8 at addr 0000000000000020 by task mount.cifs/1095
CPU: 1 UID: 0 PID: 1095 Comm: mount.cifs Not tainted 6.12.0 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-3.fc41
04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? crypto\_aead\_setkey+0x2c/0x130
kasan\_report+0xda/0x110
? crypto\_aead\_setkey+0x2c/0x130
crypto\_aead\_setkey+0x2c/0x130
crypt\_message+0x258/0xec0 [cifs]
? \_\_asan\_memset+0x23/0x50
? \_\_pfx\_crypt\_message+0x10/0x10 [cifs]
? mark\_lock+0xb0/0x6a0
? hlock\_class+0x32/0xb0
? mark\_lock+0xb0/0x6a0
smb3\_init\_transform\_rq+0x352/0x3f0 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
smb\_send\_rqst+0x144/0x230 [cifs]
? \_\_pfx\_smb\_send\_rqst+0x10/0x10 [cifs]
? hlock\_class+0x32/0xb0
? smb2\_setup\_request+0x225/0x3a0 [cifs]
? \_\_pfx\_cifs\_compound\_last\_callback+0x10/0x10 [cifs]
compound\_send\_recv+0x59b/0x1140 [cifs]
? \_\_pfx\_compound\_send\_recv+0x10/0x10 [cifs]
? \_\_create\_object+0x5e/0x90
? hlock\_class+0x32/0xb0
? do\_raw\_spin\_unlock+0x9a/0xf0
cifs\_send\_recv+0x23/0x30 [cifs]
SMB2\_tcon+0x3ec/0xb30 [cifs]
? \_\_pfx\_SMB2\_tcon+0x10/0x10 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
? \_\_pfx\_lock\_release+0x10/0x10
? do\_raw\_spin\_trylock+0xc6/0x120
? lock\_acquire+0x3f/0x90
? \_get\_xid+0x16/0xd0 [cifs]
? \_\_pfx\_SMB2\_tcon+0x10/0x10 [cifs]
? cifs\_get\_smb\_ses+0xcdd/0x10a0 [cifs]
cifs\_get\_smb\_ses+0xcdd/0x10a0 [cifs]
? \_\_pfx\_cifs\_get\_smb\_ses+0x10/0x10 [cifs]
? cifs\_get\_tcp\_session+0xaa0/0xca0 [cifs]
cifs\_mount\_get\_session+0x8a/0x210 [cifs]
dfs\_mount\_share+0x1b0/0x11d0 [cifs]
? \_\_pfx\_\_\_lock\_acquire+0x10/0x10
? \_\_pfx\_dfs\_mount\_share+0x10/0x10 [cifs]
? lock\_acquire.part.0+0xf4/0x2a0
? find\_held\_lock+0x8a/0xa0
? hlock\_class+0x32/0xb0
? lock\_release+0x203/0x5d0
cifs\_mount+0xb3/0x3d0 [cifs]
? do\_raw\_spin\_trylock+0xc6/0x120
? \_\_pfx\_cifs\_mount+0x10/0x10 [cifs]
? lock\_acquire+0x3f/0x90
? find\_nls+0x16/0xa0
? smb3\_update\_mnt\_flags+0x372/0x3b0 [cifs]
cifs\_smb3\_do\_mount+0x1e2/0xc80 [cifs]
? \_\_pfx\_vfs\_parse\_fs\_string+0x10/0x10
? \_\_pfx\_cifs\_smb3\_do\_mount+0x10/0x10 [cifs]
smb3\_get\_tree+0x1bf/0x330 [cifs]
vfs\_get\_tree+0x4a/0x160
path\_mount+0x3c1/0xfb0
? kasan\_quarantine\_put+0xc7/0x1d0
? \_\_pfx\_path\_mount+0x10/0x10
? kmem\_cache\_free+0x118/0x3e0
? user\_path\_at+0x74/0xa0
\_\_x64\_sys\_mount+0x1a6/0x1e0
? \_\_pfx\_\_\_x64\_sys\_mount+0x10/0x10
? mark\_held\_locks+0x1a/0x90
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Cc: Tom Talpey <tom@talpey.com>
Reported-by: Jianhong Yin <jiyin@redhat.com>
Cc: stable@vger.kernel.org # v6.12
Fixes: b0abcd65ec54 ("smb: client: fix UAF in async decryption")
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8)

| -rw-r--r-- | [fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2pdu.c?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/smb/client/smb2pdu.c b/fs/smb/client/smb2pdu.cindex a86a3fbfb5a49c..38b26468eb0c53 100644--- a/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=a96f9eb7add30ba0fafcfe7b7aca090978196800)+++ b/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=46f8e25926817272ec8d5bfbd003569bdeb9a8c8)@@ -1228,7 +1228,9 @@ SMB2\_negotiate(const unsigned int xid, \* SMB3.0 supports only 1 cipher and doesn't have a encryption neg context \* Set the cipher type manually. \*/- if (server->dialect == SMB30\_PROT\_ID && (server->capabilities & SMB2\_GLOBAL\_CAP\_ENCRYPTION))+ if ((server->dialect == SMB30\_PROT\_ID ||+ server->dialect == SMB302\_PROT\_ID) &&+ (server->capabilities & SMB2\_GLOBAL\_CAP\_ENCRYPTION)) server->cipher\_type = SMB2\_ENCRYPTION\_AES128\_CCM;  security\_blob = smb2\_get\_data\_area\_len(&blob\_offset, &blob\_length, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:01:11 +0000


