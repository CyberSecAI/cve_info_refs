=== Content from git.kernel.org_9b71d3b2_20250114_194814.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jinjiang Tu <tujinjiang@huawei.com> | 2024-11-13 16:32:35 +0800 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-11-14 22:43:48 -0800 |
| commit | [8ce41b0f9d77cca074df25afd39b86e2ee3aa68e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e)) | |
| tree | [77707f691d8546ed2d3306793e6f272722709279](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e) | |
| parent | [0740e54304dcd11cf2a8edb6764423eb2fed1c61](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0740e54304dcd11cf2a8edb6764423eb2fed1c61) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e&id2=0740e54304dcd11cf2a8edb6764423eb2fed1c61)) | |
| download | [linux-8ce41b0f9d77cca074df25afd39b86e2ee3aa68e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8ce41b0f9d77cca074df25afd39b86e2ee3aa68e.tar.gz) | |

mm: fix NULL pointer dereference in alloc\_pages\_bulk\_noprofWe triggered a NULL pointer dereference for ac.preferred\_zoneref->zone in
alloc\_pages\_bulk\_noprof() when the task is migrated between cpusets.
When cpuset is enabled, in prepare\_alloc\_pages(), ac->nodemask may be
&current->mems\_allowed. when first\_zones\_zonelist() is called to find
preferred\_zoneref, the ac->nodemask may be modified concurrently if the
task is migrated between different cpusets. Assuming we have 2 NUMA Node,
when traversing Node1 in ac->zonelist, the nodemask is 2, and when
traversing Node2 in ac->zonelist, the nodemask is 1. As a result, the
ac->preferred\_zoneref points to NULL zone.
In alloc\_pages\_bulk\_noprof(), for\_each\_zone\_zonelist\_nodemask() finds a
allowable zone and calls zonelist\_node\_idx(ac.preferred\_zoneref), leading
to NULL pointer dereference.
\_\_alloc\_pages\_noprof() fixes this issue by checking NULL pointer in commit
ea57485af8f4 ("mm, page\_alloc: fix check for NULL preferred\_zone") and
commit df76cee6bbeb ("mm, page\_alloc: remove redundant checks from alloc
fastpath").
To fix it, check NULL pointer for preferred\_zoneref->zone.
Link: [https://lkml.kernel.org/r/20241113083235.166798-1-tujinjiang@huawei.com](https://lkml.kernel.org/r/20241113083235.166798-1-tujinjiang%40huawei.com)
Fixes: 387ba26fb1cb ("mm/page\_alloc: add a bulk page allocator")
Signed-off-by: Jinjiang Tu <tujinjiang@huawei.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Cc: Alexander Lobakin <alobakin@pm.me>
Cc: David Hildenbrand <david@redhat.com>
Cc: Kefeng Wang <wangkefeng.wang@huawei.com>
Cc: Mel Gorman <mgorman@techsingularity.net>
Cc: Nanyong Sun <sunnanyong@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e)

| -rw-r--r-- | [mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page_alloc.c?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/mm/page\_alloc.c b/mm/page\_alloc.cindex 216fbbfbedcf91..b6958333054d06 100644--- a/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=0740e54304dcd11cf2a8edb6764423eb2fed1c61)+++ b/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=8ce41b0f9d77cca074df25afd39b86e2ee3aa68e)@@ -4607,7 +4607,8 @@ unsigned long alloc\_pages\_bulk\_noprof(gfp\_t gfp, int preferred\_nid, gfp = alloc\_gfp;  /\* Find an allowed local zone that meets the low watermark. \*/- for\_each\_zone\_zonelist\_nodemask(zone, z, ac.zonelist, ac.highest\_zoneidx, ac.nodemask) {+ z = ac.preferred\_zoneref;+ for\_next\_zone\_zonelist\_nodemask(zone, z, ac.highest\_zoneidx, ac.nodemask) { unsigned long mark;  if (cpusets\_enabled() && (alloc\_flags & ALLOC\_CPUSET) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:20:39 +0000



=== Content from git.kernel.org_7397fa3d_20250114_194813.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jinjiang Tu <tujinjiang@huawei.com> | 2024-11-13 16:32:35 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:39:50 +0100 |
| commit | [31502374627ba9ec3e710dbd0bb00457cc6d2c19](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19)) | |
| tree | [e7e9ec5ca5188e04ec43ed8ad3e01cb1d9d71b1a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19) | |
| parent | [45aaa1daa01a2e7dbac307ad75a1dd3f80d1db23](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=45aaa1daa01a2e7dbac307ad75a1dd3f80d1db23) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19&id2=45aaa1daa01a2e7dbac307ad75a1dd3f80d1db23)) | |
| download | [linux-31502374627ba9ec3e710dbd0bb00457cc6d2c19.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-31502374627ba9ec3e710dbd0bb00457cc6d2c19.tar.gz) | |

mm: fix NULL pointer dereference in alloc\_pages\_bulk\_noprofcommit 8ce41b0f9d77cca074df25afd39b86e2ee3aa68e upstream.
We triggered a NULL pointer dereference for ac.preferred\_zoneref->zone in
alloc\_pages\_bulk\_noprof() when the task is migrated between cpusets.
When cpuset is enabled, in prepare\_alloc\_pages(), ac->nodemask may be
&current->mems\_allowed. when first\_zones\_zonelist() is called to find
preferred\_zoneref, the ac->nodemask may be modified concurrently if the
task is migrated between different cpusets. Assuming we have 2 NUMA Node,
when traversing Node1 in ac->zonelist, the nodemask is 2, and when
traversing Node2 in ac->zonelist, the nodemask is 1. As a result, the
ac->preferred\_zoneref points to NULL zone.
In alloc\_pages\_bulk\_noprof(), for\_each\_zone\_zonelist\_nodemask() finds a
allowable zone and calls zonelist\_node\_idx(ac.preferred\_zoneref), leading
to NULL pointer dereference.
\_\_alloc\_pages\_noprof() fixes this issue by checking NULL pointer in commit
ea57485af8f4 ("mm, page\_alloc: fix check for NULL preferred\_zone") and
commit df76cee6bbeb ("mm, page\_alloc: remove redundant checks from alloc
fastpath").
To fix it, check NULL pointer for preferred\_zoneref->zone.
Link: [https://lkml.kernel.org/r/20241113083235.166798-1-tujinjiang@huawei.com](https://lkml.kernel.org/r/20241113083235.166798-1-tujinjiang%40huawei.com)
Fixes: 387ba26fb1cb ("mm/page\_alloc: add a bulk page allocator")
Signed-off-by: Jinjiang Tu <tujinjiang@huawei.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Cc: Alexander Lobakin <alobakin@pm.me>
Cc: David Hildenbrand <david@redhat.com>
Cc: Kefeng Wang <wangkefeng.wang@huawei.com>
Cc: Mel Gorman <mgorman@techsingularity.net>
Cc: Nanyong Sun <sunnanyong@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19)

| -rw-r--r-- | [mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page_alloc.c?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/mm/page\_alloc.c b/mm/page\_alloc.cindex f9111356d1047b..ab53d0e51a8225 100644--- a/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=45aaa1daa01a2e7dbac307ad75a1dd3f80d1db23)+++ b/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=31502374627ba9ec3e710dbd0bb00457cc6d2c19)@@ -4569,7 +4569,8 @@ unsigned long alloc\_pages\_bulk\_noprof(gfp\_t gfp, int preferred\_nid, gfp = alloc\_gfp;  /\* Find an allowed local zone that meets the low watermark. \*/- for\_each\_zone\_zonelist\_nodemask(zone, z, ac.zonelist, ac.highest\_zoneidx, ac.nodemask) {+ z = ac.preferred\_zoneref;+ for\_next\_zone\_zonelist\_nodemask(zone, z, ac.highest\_zoneidx, ac.nodemask) { unsigned long mark;  if (cpusets\_enabled() && (alloc\_flags & ALLOC\_CPUSET) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:46:50 +0000



=== Content from git.kernel.org_e987455b_20250114_194813.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jinjiang Tu <tujinjiang@huawei.com> | 2024-11-13 16:32:35 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:37:30 +0100 |
| commit | [6addb2d9501ec866d7b3a3b4e665307c437e9be2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2)) | |
| tree | [19ca5db3a5f3c45d51f8dffd3dbe1d0e39ec3fb6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2) | |
| parent | [69556613d99ba5d848a5fba5d04355a061de5219](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69556613d99ba5d848a5fba5d04355a061de5219) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2&id2=69556613d99ba5d848a5fba5d04355a061de5219)) | |
| download | [linux-6addb2d9501ec866d7b3a3b4e665307c437e9be2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6addb2d9501ec866d7b3a3b4e665307c437e9be2.tar.gz) | |

mm: fix NULL pointer dereference in alloc\_pages\_bulk\_noprofcommit 8ce41b0f9d77cca074df25afd39b86e2ee3aa68e upstream.
We triggered a NULL pointer dereference for ac.preferred\_zoneref->zone in
alloc\_pages\_bulk\_noprof() when the task is migrated between cpusets.
When cpuset is enabled, in prepare\_alloc\_pages(), ac->nodemask may be
&current->mems\_allowed. when first\_zones\_zonelist() is called to find
preferred\_zoneref, the ac->nodemask may be modified concurrently if the
task is migrated between different cpusets. Assuming we have 2 NUMA Node,
when traversing Node1 in ac->zonelist, the nodemask is 2, and when
traversing Node2 in ac->zonelist, the nodemask is 1. As a result, the
ac->preferred\_zoneref points to NULL zone.
In alloc\_pages\_bulk\_noprof(), for\_each\_zone\_zonelist\_nodemask() finds a
allowable zone and calls zonelist\_node\_idx(ac.preferred\_zoneref), leading
to NULL pointer dereference.
\_\_alloc\_pages\_noprof() fixes this issue by checking NULL pointer in commit
ea57485af8f4 ("mm, page\_alloc: fix check for NULL preferred\_zone") and
commit df76cee6bbeb ("mm, page\_alloc: remove redundant checks from alloc
fastpath").
To fix it, check NULL pointer for preferred\_zoneref->zone.
Link: [https://lkml.kernel.org/r/20241113083235.166798-1-tujinjiang@huawei.com](https://lkml.kernel.org/r/20241113083235.166798-1-tujinjiang%40huawei.com)
Fixes: 387ba26fb1cb ("mm/page\_alloc: add a bulk page allocator")
Signed-off-by: Jinjiang Tu <tujinjiang@huawei.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Cc: Alexander Lobakin <alobakin@pm.me>
Cc: David Hildenbrand <david@redhat.com>
Cc: Kefeng Wang <wangkefeng.wang@huawei.com>
Cc: Mel Gorman <mgorman@techsingularity.net>
Cc: Nanyong Sun <sunnanyong@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2)

| -rw-r--r-- | [mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page_alloc.c?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/mm/page\_alloc.c b/mm/page\_alloc.cindex b87b350b2f4059..58a3f70eb39bbd 100644--- a/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=69556613d99ba5d848a5fba5d04355a061de5219)+++ b/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=6addb2d9501ec866d7b3a3b4e665307c437e9be2)@@ -5457,7 +5457,8 @@ unsigned long \_\_alloc\_pages\_bulk(gfp\_t gfp, int preferred\_nid, gfp = alloc\_gfp;  /\* Find an allowed local zone that meets the low watermark. \*/- for\_each\_zone\_zonelist\_nodemask(zone, z, ac.zonelist, ac.highest\_zoneidx, ac.nodemask) {+ z = ac.preferred\_zoneref;+ for\_next\_zone\_zonelist\_nodemask(zone, z, ac.highest\_zoneidx, ac.nodemask) { unsigned long mark;  if (cpusets\_enabled() && (alloc\_flags & ALLOC\_CPUSET) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:20:39 +0000



=== Content from git.kernel.org_910aa1e4_20250114_194815.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jinjiang Tu <tujinjiang@huawei.com> | 2024-11-13 16:32:35 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:35 +0100 |
| commit | [903d896448c2e50e8652aaba529a30d4d1eaa0e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5)) | |
| tree | [3a7af81161c65af6a04fe50808182ec941199e23](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5) | |
| parent | [6ec06379b8de01698b1e8a3b84b2cfa24518336a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ec06379b8de01698b1e8a3b84b2cfa24518336a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5&id2=6ec06379b8de01698b1e8a3b84b2cfa24518336a)) | |
| download | [linux-903d896448c2e50e8652aaba529a30d4d1eaa0e5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-903d896448c2e50e8652aaba529a30d4d1eaa0e5.tar.gz) | |

mm: fix NULL pointer dereference in alloc\_pages\_bulk\_noprofcommit 8ce41b0f9d77cca074df25afd39b86e2ee3aa68e upstream.
We triggered a NULL pointer dereference for ac.preferred\_zoneref->zone in
alloc\_pages\_bulk\_noprof() when the task is migrated between cpusets.
When cpuset is enabled, in prepare\_alloc\_pages(), ac->nodemask may be
&current->mems\_allowed. when first\_zones\_zonelist() is called to find
preferred\_zoneref, the ac->nodemask may be modified concurrently if the
task is migrated between different cpusets. Assuming we have 2 NUMA Node,
when traversing Node1 in ac->zonelist, the nodemask is 2, and when
traversing Node2 in ac->zonelist, the nodemask is 1. As a result, the
ac->preferred\_zoneref points to NULL zone.
In alloc\_pages\_bulk\_noprof(), for\_each\_zone\_zonelist\_nodemask() finds a
allowable zone and calls zonelist\_node\_idx(ac.preferred\_zoneref), leading
to NULL pointer dereference.
\_\_alloc\_pages\_noprof() fixes this issue by checking NULL pointer in commit
ea57485af8f4 ("mm, page\_alloc: fix check for NULL preferred\_zone") and
commit df76cee6bbeb ("mm, page\_alloc: remove redundant checks from alloc
fastpath").
To fix it, check NULL pointer for preferred\_zoneref->zone.
Link: [https://lkml.kernel.org/r/20241113083235.166798-1-tujinjiang@huawei.com](https://lkml.kernel.org/r/20241113083235.166798-1-tujinjiang%40huawei.com)
Fixes: 387ba26fb1cb ("mm/page\_alloc: add a bulk page allocator")
Signed-off-by: Jinjiang Tu <tujinjiang@huawei.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Cc: Alexander Lobakin <alobakin@pm.me>
Cc: David Hildenbrand <david@redhat.com>
Cc: Kefeng Wang <wangkefeng.wang@huawei.com>
Cc: Mel Gorman <mgorman@techsingularity.net>
Cc: Nanyong Sun <sunnanyong@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5)

| -rw-r--r-- | [mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page_alloc.c?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/mm/page\_alloc.c b/mm/page\_alloc.cindex 6a64a751848886..f0accb740cda2c 100644--- a/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=6ec06379b8de01698b1e8a3b84b2cfa24518336a)+++ b/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=903d896448c2e50e8652aaba529a30d4d1eaa0e5)@@ -5336,7 +5336,8 @@ unsigned long \_\_alloc\_pages\_bulk(gfp\_t gfp, int preferred\_nid, gfp = alloc\_gfp;  /\* Find an allowed local zone that meets the low watermark. \*/- for\_each\_zone\_zonelist\_nodemask(zone, z, ac.zonelist, ac.highest\_zoneidx, ac.nodemask) {+ z = ac.preferred\_zoneref;+ for\_next\_zone\_zonelist\_nodemask(zone, z, ac.highest\_zoneidx, ac.nodemask) { unsigned long mark;  if (cpusets\_enabled() && (alloc\_flags & ALLOC\_CPUSET) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:46:52 +0000



=== Content from git.kernel.org_3d45ac5a_20250114_194815.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d0f16cec79774c3132df006cf771eddd89d08f58)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0f16cec79774c3132df006cf771eddd89d08f58)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0f16cec79774c3132df006cf771eddd89d08f58)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0f16cec79774c3132df006cf771eddd89d08f58)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jinjiang Tu <tujinjiang@huawei.com> | 2024-11-13 16:32:35 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:38:33 +0100 |
| commit | [d0f16cec79774c3132df006cf771eddd89d08f58](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0f16cec79774c3132df006cf771eddd89d08f58) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d0f16cec79774c3132df006cf771eddd89d08f58)) | |
| tree | [dbf2b6b80dd95d0821983a3ebaaba3fd1e325b2b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0f16cec79774c3132df006cf771eddd89d08f58) | |
| parent | [3414fc6a788800145f91d3e7d7321695d9b7137c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3414fc6a788800145f91d3e7d7321695d9b7137c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0f16cec79774c3132df006cf771eddd89d08f58&id2=3414fc6a788800145f91d3e7d7321695d9b7137c)) | |
| download | [linux-d0f16cec79774c3132df006cf771eddd89d08f58.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d0f16cec79774c3132df006cf771eddd89d08f58.tar.gz) | |

mm: fix NULL pointer dereference in alloc\_pages\_bulk\_noprofcommit 8ce41b0f9d77cca074df25afd39b86e2ee3aa68e upstream.
We triggered a NULL pointer dereference for ac.preferred\_zoneref->zone in
alloc\_pages\_bulk\_noprof() when the task is migrated between cpusets.
When cpuset is enabled, in prepare\_alloc\_pages(), ac->nodemask may be
&current->mems\_allowed. when first\_zones\_zonelist() is called to find
preferred\_zoneref, the ac->nodemask may be modified concurrently if the
task is migrated between different cpusets. Assuming we have 2 NUMA Node,
when traversing Node1 in ac->zonelist, the nodemask is 2, and when
traversing Node2 in ac->zonelist, the nodemask is 1. As a result, the
ac->preferred\_zoneref points to NULL zone.
In alloc\_pages\_bulk\_noprof(), for\_each\_zone\_zonelist\_nodemask() finds a
allowable zone and calls zonelist\_node\_idx(ac.preferred\_zoneref), leading
to NULL pointer dereference.
\_\_alloc\_pages\_noprof() fixes this issue by checking NULL pointer in commit
ea57485af8f4 ("mm, page\_alloc: fix check for NULL preferred\_zone") and
commit df76cee6bbeb ("mm, page\_alloc: remove redundant checks from alloc
fastpath").
To fix it, check NULL pointer for preferred\_zoneref->zone.
Link: [https://lkml.kernel.org/r/20241113083235.166798-1-tujinjiang@huawei.com](https://lkml.kernel.org/r/20241113083235.166798-1-tujinjiang%40huawei.com)
Fixes: 387ba26fb1cb ("mm/page\_alloc: add a bulk page allocator")
Signed-off-by: Jinjiang Tu <tujinjiang@huawei.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Cc: Alexander Lobakin <alobakin@pm.me>
Cc: David Hildenbrand <david@redhat.com>
Cc: Kefeng Wang <wangkefeng.wang@huawei.com>
Cc: Mel Gorman <mgorman@techsingularity.net>
Cc: Nanyong Sun <sunnanyong@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0f16cec79774c3132df006cf771eddd89d08f58)

| -rw-r--r-- | [mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page_alloc.c?id=d0f16cec79774c3132df006cf771eddd89d08f58) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/mm/page\_alloc.c b/mm/page\_alloc.cindex 7272a922b83831..3bda3f4570a234 100644--- a/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=3414fc6a788800145f91d3e7d7321695d9b7137c)+++ b/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=d0f16cec79774c3132df006cf771eddd89d08f58)@@ -4301,7 +4301,8 @@ unsigned long \_\_alloc\_pages\_bulk(gfp\_t gfp, int preferred\_nid, gfp = alloc\_gfp;  /\* Find an allowed local zone that meets the low watermark. \*/- for\_each\_zone\_zonelist\_nodemask(zone, z, ac.zonelist, ac.highest\_zoneidx, ac.nodemask) {+ z = ac.preferred\_zoneref;+ for\_next\_zone\_zonelist\_nodemask(zone, z, ac.highest\_zoneidx, ac.nodemask) { unsigned long mark;  if (cpusets\_enabled() && (alloc\_flags & ALLOC\_CPUSET) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:46:52 +0000


