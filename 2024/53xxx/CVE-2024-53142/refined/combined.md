=== Content from git.kernel.org_718b2829_20250114_211253.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Disseldorp <ddiss@suse.de> | 2024-10-30 03:55:10 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:31:44 +0100 |
| commit | [1a423bbbeaf9e3e20c4686501efd9b661fe834db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db)) | |
| tree | [098f978933923224fb69b0773ced5a78dab61b89](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db) | |
| parent | [372042443be4855e6fd3bc274a54a3a37e67005b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=372042443be4855e6fd3bc274a54a3a37e67005b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db&id2=372042443be4855e6fd3bc274a54a3a37e67005b)) | |
| download | [linux-1a423bbbeaf9e3e20c4686501efd9b661fe834db.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1a423bbbeaf9e3e20c4686501efd9b661fe834db.tar.gz) | |

initramfs: avoid filename buffer overrun[ Upstream commit e017671f534dd3f568db9e47b0583e853d2da9b5 ]
The initramfs filename field is defined in
Documentation/driver-api/early-userspace/buffer-format.rst as:
37 cpio\_file := ALGN(4) + cpio\_header + filename + "\0" + ALGN(4) + data
...
55 ============= ================== =========================
56 Field name Field size Meaning
57 ============= ================== =========================
...
70 c\_namesize 8 bytes Length of filename, including final \0
When extracting an initramfs cpio archive, the kernel's do\_name() path
handler assumes a zero-terminated path at @collected, passing it
directly to filp\_open() / init\_mkdir() / init\_mknod().
If a specially crafted cpio entry carries a non-zero-terminated filename
and is followed by uninitialized memory, then a file may be created with
trailing characters that represent the uninitialized memory. The ability
to create an initramfs entry would imply already having full control of
the system, so the buffer overrun shouldn't be considered a security
vulnerability.
Append the output of the following bash script to an existing initramfs
and observe any created /initramfs\_test\_fname\_overrunAA\* path. E.g.
./reproducer.sh | gzip >> /myinitramfs
It's easiest to observe non-zero uninitialized memory when the output is
gzipped, as it'll overflow the heap allocated @out\_buf in \_\_gunzip(),
rather than the initrd\_start+initrd\_size block.
---- reproducer.sh ----
nilchar="A" # change to "\0" to properly zero terminate / pad
magic="070701"
ino=1
mode=$(( 0100777 ))
uid=0
gid=0
nlink=1
mtime=1
filesize=0
devmajor=0
devminor=1
rdevmajor=0
rdevminor=0
csum=0
fname="initramfs\_test\_fname\_overrun"
namelen=$(( ${#fname} + 1 )) # plus one to account for terminator
printf "%s%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%s" \
$magic $ino $mode $uid $gid $nlink $mtime $filesize \
$devmajor $devminor $rdevmajor $rdevminor $namelen $csum $fname
termpadlen=$(( 1 + ((4 - ((110 + $namelen) & 3)) % 4) ))
printf "%.s${nilchar}" $(seq 1 $termpadlen)
---- reproducer.sh ----
Symlink filename fields handled in do\_symlink() won't overrun past the
data segment, due to the explicit zero-termination of the symlink
target.
Fix filename buffer overrun by aborting the initramfs FSM if any cpio
entry doesn't carry a zero-terminator at the expected (name\_len - 1)
offset.
Fixes: 1da177e4c3f41 ("Linux-2.6.12-rc2")
Signed-off-by: David Disseldorp <ddiss@suse.de>
Link: [https://lore.kernel.org/r/20241030035509.20194-2-ddiss@suse.de](https://lore.kernel.org/r/20241030035509.20194-2-ddiss%40suse.de)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db)

| -rw-r--r-- | [init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/init/initramfs.c?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 0 deletions

| diff --git a/init/initramfs.c b/init/initramfs.cindex efc477b905a482..148988bd8ab277 100644--- a/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=372042443be4855e6fd3bc274a54a3a37e67005b)+++ b/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=1a423bbbeaf9e3e20c4686501efd9b661fe834db)@@ -358,6 +358,15 @@ static int \_\_init do\_name(void) { state = SkipIt; next\_state = Reset;++ /\* name\_len > 0 && name\_len <= PATH\_MAX checked in do\_header \*/+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs name without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ }+ if (strcmp(collected, "TRAILER!!!") == 0) { free\_hash(); return 0;@@ -422,6 +431,12 @@ static int \_\_init do\_copy(void)  static int \_\_init do\_symlink(void) {+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs symlink without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ } collected[N\_ALIGN(name\_len) + body\_len] = '\0'; clean\_path(collected, 0); init\_symlink(collected + N\_ALIGN(name\_len), collected); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:11:31 +0000



=== Content from git.kernel.org_4fca2a19_20250114_211255.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6983b8ac787b3add5571cda563574932a59a99bb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6983b8ac787b3add5571cda563574932a59a99bb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6983b8ac787b3add5571cda563574932a59a99bb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6983b8ac787b3add5571cda563574932a59a99bb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Disseldorp <ddiss@suse.de> | 2024-10-30 03:55:10 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:42 +0100 |
| commit | [6983b8ac787b3add5571cda563574932a59a99bb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6983b8ac787b3add5571cda563574932a59a99bb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6983b8ac787b3add5571cda563574932a59a99bb)) | |
| tree | [34e448be225607b761a61b6ee53ff12d5dcc6bfd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6983b8ac787b3add5571cda563574932a59a99bb) | |
| parent | [2be0ca62b8e2c0d20d2691b7519db5dcb1cd27bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2be0ca62b8e2c0d20d2691b7519db5dcb1cd27bf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6983b8ac787b3add5571cda563574932a59a99bb&id2=2be0ca62b8e2c0d20d2691b7519db5dcb1cd27bf)) | |
| download | [linux-6983b8ac787b3add5571cda563574932a59a99bb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6983b8ac787b3add5571cda563574932a59a99bb.tar.gz) | |

initramfs: avoid filename buffer overrun[ Upstream commit e017671f534dd3f568db9e47b0583e853d2da9b5 ]
The initramfs filename field is defined in
Documentation/driver-api/early-userspace/buffer-format.rst as:
37 cpio\_file := ALGN(4) + cpio\_header + filename + "\0" + ALGN(4) + data
...
55 ============= ================== =========================
56 Field name Field size Meaning
57 ============= ================== =========================
...
70 c\_namesize 8 bytes Length of filename, including final \0
When extracting an initramfs cpio archive, the kernel's do\_name() path
handler assumes a zero-terminated path at @collected, passing it
directly to filp\_open() / init\_mkdir() / init\_mknod().
If a specially crafted cpio entry carries a non-zero-terminated filename
and is followed by uninitialized memory, then a file may be created with
trailing characters that represent the uninitialized memory. The ability
to create an initramfs entry would imply already having full control of
the system, so the buffer overrun shouldn't be considered a security
vulnerability.
Append the output of the following bash script to an existing initramfs
and observe any created /initramfs\_test\_fname\_overrunAA\* path. E.g.
./reproducer.sh | gzip >> /myinitramfs
It's easiest to observe non-zero uninitialized memory when the output is
gzipped, as it'll overflow the heap allocated @out\_buf in \_\_gunzip(),
rather than the initrd\_start+initrd\_size block.
---- reproducer.sh ----
nilchar="A" # change to "\0" to properly zero terminate / pad
magic="070701"
ino=1
mode=$(( 0100777 ))
uid=0
gid=0
nlink=1
mtime=1
filesize=0
devmajor=0
devminor=1
rdevmajor=0
rdevminor=0
csum=0
fname="initramfs\_test\_fname\_overrun"
namelen=$(( ${#fname} + 1 )) # plus one to account for terminator
printf "%s%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%s" \
$magic $ino $mode $uid $gid $nlink $mtime $filesize \
$devmajor $devminor $rdevmajor $rdevminor $namelen $csum $fname
termpadlen=$(( 1 + ((4 - ((110 + $namelen) & 3)) % 4) ))
printf "%.s${nilchar}" $(seq 1 $termpadlen)
---- reproducer.sh ----
Symlink filename fields handled in do\_symlink() won't overrun past the
data segment, due to the explicit zero-termination of the symlink
target.
Fix filename buffer overrun by aborting the initramfs FSM if any cpio
entry doesn't carry a zero-terminator at the expected (name\_len - 1)
offset.
Fixes: 1da177e4c3f41 ("Linux-2.6.12-rc2")
Signed-off-by: David Disseldorp <ddiss@suse.de>
Link: [https://lore.kernel.org/r/20241030035509.20194-2-ddiss@suse.de](https://lore.kernel.org/r/20241030035509.20194-2-ddiss%40suse.de)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6983b8ac787b3add5571cda563574932a59a99bb)

| -rw-r--r-- | [init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/init/initramfs.c?id=6983b8ac787b3add5571cda563574932a59a99bb) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 0 deletions

| diff --git a/init/initramfs.c b/init/initramfs.cindex f153fb505781b2..4e92cff3e86654 100644--- a/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=2be0ca62b8e2c0d20d2691b7519db5dcb1cd27bf)+++ b/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=6983b8ac787b3add5571cda563574932a59a99bb)@@ -338,6 +338,15 @@ static int \_\_init do\_name(void) { state = SkipIt; next\_state = Reset;++ /\* name\_len > 0 && name\_len <= PATH\_MAX checked in do\_header \*/+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs name without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ }+ if (strcmp(collected, "TRAILER!!!") == 0) { free\_hash(); return 0;@@ -403,6 +412,12 @@ static int \_\_init do\_copy(void)  static int \_\_init do\_symlink(void) {+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs symlink without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ } collected[N\_ALIGN(name\_len) + body\_len] = '\0'; clean\_path(collected, 0); init\_symlink(collected + N\_ALIGN(name\_len), collected); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:11:32 +0000



=== Content from git.kernel.org_4ec27d91_20250114_211256.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Disseldorp <ddiss@suse.de> | 2024-10-30 03:55:10 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:30 +0100 |
| commit | [bb7ac96670ab1d8d681015f9d66e45dad579af4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d)) | |
| tree | [416456df109186d12130b04e47ace430681239aa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d) | |
| parent | [28202c1d05990561605efd756e91260625546d3d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28202c1d05990561605efd756e91260625546d3d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d&id2=28202c1d05990561605efd756e91260625546d3d)) | |
| download | [linux-bb7ac96670ab1d8d681015f9d66e45dad579af4d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bb7ac96670ab1d8d681015f9d66e45dad579af4d.tar.gz) | |

initramfs: avoid filename buffer overrun[ Upstream commit e017671f534dd3f568db9e47b0583e853d2da9b5 ]
The initramfs filename field is defined in
Documentation/driver-api/early-userspace/buffer-format.rst as:
37 cpio\_file := ALGN(4) + cpio\_header + filename + "\0" + ALGN(4) + data
...
55 ============= ================== =========================
56 Field name Field size Meaning
57 ============= ================== =========================
...
70 c\_namesize 8 bytes Length of filename, including final \0
When extracting an initramfs cpio archive, the kernel's do\_name() path
handler assumes a zero-terminated path at @collected, passing it
directly to filp\_open() / init\_mkdir() / init\_mknod().
If a specially crafted cpio entry carries a non-zero-terminated filename
and is followed by uninitialized memory, then a file may be created with
trailing characters that represent the uninitialized memory. The ability
to create an initramfs entry would imply already having full control of
the system, so the buffer overrun shouldn't be considered a security
vulnerability.
Append the output of the following bash script to an existing initramfs
and observe any created /initramfs\_test\_fname\_overrunAA\* path. E.g.
./reproducer.sh | gzip >> /myinitramfs
It's easiest to observe non-zero uninitialized memory when the output is
gzipped, as it'll overflow the heap allocated @out\_buf in \_\_gunzip(),
rather than the initrd\_start+initrd\_size block.
---- reproducer.sh ----
nilchar="A" # change to "\0" to properly zero terminate / pad
magic="070701"
ino=1
mode=$(( 0100777 ))
uid=0
gid=0
nlink=1
mtime=1
filesize=0
devmajor=0
devminor=1
rdevmajor=0
rdevminor=0
csum=0
fname="initramfs\_test\_fname\_overrun"
namelen=$(( ${#fname} + 1 )) # plus one to account for terminator
printf "%s%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%s" \
$magic $ino $mode $uid $gid $nlink $mtime $filesize \
$devmajor $devminor $rdevmajor $rdevminor $namelen $csum $fname
termpadlen=$(( 1 + ((4 - ((110 + $namelen) & 3)) % 4) ))
printf "%.s${nilchar}" $(seq 1 $termpadlen)
---- reproducer.sh ----
Symlink filename fields handled in do\_symlink() won't overrun past the
data segment, due to the explicit zero-termination of the symlink
target.
Fix filename buffer overrun by aborting the initramfs FSM if any cpio
entry doesn't carry a zero-terminator at the expected (name\_len - 1)
offset.
Fixes: 1da177e4c3f41 ("Linux-2.6.12-rc2")
Signed-off-by: David Disseldorp <ddiss@suse.de>
Link: [https://lore.kernel.org/r/20241030035509.20194-2-ddiss@suse.de](https://lore.kernel.org/r/20241030035509.20194-2-ddiss%40suse.de)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d)

| -rw-r--r-- | [init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/init/initramfs.c?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 0 deletions

| diff --git a/init/initramfs.c b/init/initramfs.cindex fceede4cff6e47..59901e51977751 100644--- a/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=28202c1d05990561605efd756e91260625546d3d)+++ b/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=bb7ac96670ab1d8d681015f9d66e45dad579af4d)@@ -323,6 +323,15 @@ static int \_\_init do\_name(void) { state = SkipIt; next\_state = Reset;++ /\* name\_len > 0 && name\_len <= PATH\_MAX checked in do\_header \*/+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs name without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ }+ if (strcmp(collected, "TRAILER!!!") == 0) { free\_hash(); return 0;@@ -385,6 +394,12 @@ static int \_\_init do\_copy(void)  static int \_\_init do\_symlink(void) {+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs symlink without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ } collected[N\_ALIGN(name\_len) + body\_len] = '\0'; clean\_path(collected, 0); ksys\_symlink(collected + N\_ALIGN(name\_len), collected); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:11:33 +0000



=== Content from git.kernel.org_00428cb3_20250114_211258.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d3df9f26cff97beaa5643e551031795d5d5cddbe)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3df9f26cff97beaa5643e551031795d5d5cddbe)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3df9f26cff97beaa5643e551031795d5d5cddbe)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3df9f26cff97beaa5643e551031795d5d5cddbe)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Disseldorp <ddiss@suse.de> | 2024-10-30 03:55:10 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:43 +0100 |
| commit | [d3df9f26cff97beaa5643e551031795d5d5cddbe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3df9f26cff97beaa5643e551031795d5d5cddbe) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d3df9f26cff97beaa5643e551031795d5d5cddbe)) | |
| tree | [f1d492b00f3b651f70ab961c6b10e157b2d014ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3df9f26cff97beaa5643e551031795d5d5cddbe) | |
| parent | [17f35a6c9391176ce1b008fd7cfed8c96283df90](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17f35a6c9391176ce1b008fd7cfed8c96283df90) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3df9f26cff97beaa5643e551031795d5d5cddbe&id2=17f35a6c9391176ce1b008fd7cfed8c96283df90)) | |
| download | [linux-d3df9f26cff97beaa5643e551031795d5d5cddbe.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d3df9f26cff97beaa5643e551031795d5d5cddbe.tar.gz) | |

initramfs: avoid filename buffer overrun[ Upstream commit e017671f534dd3f568db9e47b0583e853d2da9b5 ]
The initramfs filename field is defined in
Documentation/driver-api/early-userspace/buffer-format.rst as:
37 cpio\_file := ALGN(4) + cpio\_header + filename + "\0" + ALGN(4) + data
...
55 ============= ================== =========================
56 Field name Field size Meaning
57 ============= ================== =========================
...
70 c\_namesize 8 bytes Length of filename, including final \0
When extracting an initramfs cpio archive, the kernel's do\_name() path
handler assumes a zero-terminated path at @collected, passing it
directly to filp\_open() / init\_mkdir() / init\_mknod().
If a specially crafted cpio entry carries a non-zero-terminated filename
and is followed by uninitialized memory, then a file may be created with
trailing characters that represent the uninitialized memory. The ability
to create an initramfs entry would imply already having full control of
the system, so the buffer overrun shouldn't be considered a security
vulnerability.
Append the output of the following bash script to an existing initramfs
and observe any created /initramfs\_test\_fname\_overrunAA\* path. E.g.
./reproducer.sh | gzip >> /myinitramfs
It's easiest to observe non-zero uninitialized memory when the output is
gzipped, as it'll overflow the heap allocated @out\_buf in \_\_gunzip(),
rather than the initrd\_start+initrd\_size block.
---- reproducer.sh ----
nilchar="A" # change to "\0" to properly zero terminate / pad
magic="070701"
ino=1
mode=$(( 0100777 ))
uid=0
gid=0
nlink=1
mtime=1
filesize=0
devmajor=0
devminor=1
rdevmajor=0
rdevminor=0
csum=0
fname="initramfs\_test\_fname\_overrun"
namelen=$(( ${#fname} + 1 )) # plus one to account for terminator
printf "%s%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%s" \
$magic $ino $mode $uid $gid $nlink $mtime $filesize \
$devmajor $devminor $rdevmajor $rdevminor $namelen $csum $fname
termpadlen=$(( 1 + ((4 - ((110 + $namelen) & 3)) % 4) ))
printf "%.s${nilchar}" $(seq 1 $termpadlen)
---- reproducer.sh ----
Symlink filename fields handled in do\_symlink() won't overrun past the
data segment, due to the explicit zero-termination of the symlink
target.
Fix filename buffer overrun by aborting the initramfs FSM if any cpio
entry doesn't carry a zero-terminator at the expected (name\_len - 1)
offset.
Fixes: 1da177e4c3f41 ("Linux-2.6.12-rc2")
Signed-off-by: David Disseldorp <ddiss@suse.de>
Link: [https://lore.kernel.org/r/20241030035509.20194-2-ddiss@suse.de](https://lore.kernel.org/r/20241030035509.20194-2-ddiss%40suse.de)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3df9f26cff97beaa5643e551031795d5d5cddbe)

| -rw-r--r-- | [init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/init/initramfs.c?id=d3df9f26cff97beaa5643e551031795d5d5cddbe) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 0 deletions

| diff --git a/init/initramfs.c b/init/initramfs.cindex ff09460727237a..a56fc491c276da 100644--- a/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=17f35a6c9391176ce1b008fd7cfed8c96283df90)+++ b/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=d3df9f26cff97beaa5643e551031795d5d5cddbe)@@ -325,6 +325,15 @@ static int \_\_init do\_name(void) { state = SkipIt; next\_state = Reset;++ /\* name\_len > 0 && name\_len <= PATH\_MAX checked in do\_header \*/+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs name without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ }+ if (strcmp(collected, "TRAILER!!!") == 0) { free\_hash(); return 0;@@ -390,6 +399,12 @@ static int \_\_init do\_copy(void)  static int \_\_init do\_symlink(void) {+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs symlink without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ } collected[N\_ALIGN(name\_len) + body\_len] = '\0'; clean\_path(collected, 0); init\_symlink(collected + N\_ALIGN(name\_len), collected); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:11:35 +0000



=== Content from git.kernel.org_d80ba0f0_20250114_211257.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c509b1acbd867d9e09580fe059a924cb5825afb1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c509b1acbd867d9e09580fe059a924cb5825afb1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c509b1acbd867d9e09580fe059a924cb5825afb1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c509b1acbd867d9e09580fe059a924cb5825afb1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Disseldorp <ddiss@suse.de> | 2024-10-30 03:55:10 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:21 +0100 |
| commit | [c509b1acbd867d9e09580fe059a924cb5825afb1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c509b1acbd867d9e09580fe059a924cb5825afb1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c509b1acbd867d9e09580fe059a924cb5825afb1)) | |
| tree | [1915cb7a2a63d275522b504c81076f397f6388c2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c509b1acbd867d9e09580fe059a924cb5825afb1) | |
| parent | [30608827e812b408343b61d8755fa069d3b98297](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30608827e812b408343b61d8755fa069d3b98297) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c509b1acbd867d9e09580fe059a924cb5825afb1&id2=30608827e812b408343b61d8755fa069d3b98297)) | |
| download | [linux-c509b1acbd867d9e09580fe059a924cb5825afb1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c509b1acbd867d9e09580fe059a924cb5825afb1.tar.gz) | |

initramfs: avoid filename buffer overrun[ Upstream commit e017671f534dd3f568db9e47b0583e853d2da9b5 ]
The initramfs filename field is defined in
Documentation/driver-api/early-userspace/buffer-format.rst as:
37 cpio\_file := ALGN(4) + cpio\_header + filename + "\0" + ALGN(4) + data
...
55 ============= ================== =========================
56 Field name Field size Meaning
57 ============= ================== =========================
...
70 c\_namesize 8 bytes Length of filename, including final \0
When extracting an initramfs cpio archive, the kernel's do\_name() path
handler assumes a zero-terminated path at @collected, passing it
directly to filp\_open() / init\_mkdir() / init\_mknod().
If a specially crafted cpio entry carries a non-zero-terminated filename
and is followed by uninitialized memory, then a file may be created with
trailing characters that represent the uninitialized memory. The ability
to create an initramfs entry would imply already having full control of
the system, so the buffer overrun shouldn't be considered a security
vulnerability.
Append the output of the following bash script to an existing initramfs
and observe any created /initramfs\_test\_fname\_overrunAA\* path. E.g.
./reproducer.sh | gzip >> /myinitramfs
It's easiest to observe non-zero uninitialized memory when the output is
gzipped, as it'll overflow the heap allocated @out\_buf in \_\_gunzip(),
rather than the initrd\_start+initrd\_size block.
---- reproducer.sh ----
nilchar="A" # change to "\0" to properly zero terminate / pad
magic="070701"
ino=1
mode=$(( 0100777 ))
uid=0
gid=0
nlink=1
mtime=1
filesize=0
devmajor=0
devminor=1
rdevmajor=0
rdevminor=0
csum=0
fname="initramfs\_test\_fname\_overrun"
namelen=$(( ${#fname} + 1 )) # plus one to account for terminator
printf "%s%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%s" \
$magic $ino $mode $uid $gid $nlink $mtime $filesize \
$devmajor $devminor $rdevmajor $rdevminor $namelen $csum $fname
termpadlen=$(( 1 + ((4 - ((110 + $namelen) & 3)) % 4) ))
printf "%.s${nilchar}" $(seq 1 $termpadlen)
---- reproducer.sh ----
Symlink filename fields handled in do\_symlink() won't overrun past the
data segment, due to the explicit zero-termination of the symlink
target.
Fix filename buffer overrun by aborting the initramfs FSM if any cpio
entry doesn't carry a zero-terminator at the expected (name\_len - 1)
offset.
Fixes: 1da177e4c3f41 ("Linux-2.6.12-rc2")
Signed-off-by: David Disseldorp <ddiss@suse.de>
Link: [https://lore.kernel.org/r/20241030035509.20194-2-ddiss@suse.de](https://lore.kernel.org/r/20241030035509.20194-2-ddiss%40suse.de)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c509b1acbd867d9e09580fe059a924cb5825afb1)

| -rw-r--r-- | [init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/init/initramfs.c?id=c509b1acbd867d9e09580fe059a924cb5825afb1) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 0 deletions

| diff --git a/init/initramfs.c b/init/initramfs.cindex b362b57c047d5f..71ca68f4039939 100644--- a/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=30608827e812b408343b61d8755fa069d3b98297)+++ b/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=c509b1acbd867d9e09580fe059a924cb5825afb1)@@ -323,6 +323,15 @@ static int \_\_init do\_name(void) { state = SkipIt; next\_state = Reset;++ /\* name\_len > 0 && name\_len <= PATH\_MAX checked in do\_header \*/+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs name without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ }+ if (strcmp(collected, "TRAILER!!!") == 0) { free\_hash(); return 0;@@ -385,6 +394,12 @@ static int \_\_init do\_copy(void)  static int \_\_init do\_symlink(void) {+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs symlink without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ } collected[N\_ALIGN(name\_len) + body\_len] = '\0'; clean\_path(collected, 0); ksys\_symlink(collected + N\_ALIGN(name\_len), collected); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:11:34 +0000



=== Content from git.kernel.org_b90499b3_20250114_211302.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Disseldorp <ddiss@suse.de> | 2024-10-30 03:55:10 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:12 +0100 |
| commit | [fb83b093f75806333b6f4ae29b158d2e0e3ec971](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971)) | |
| tree | [86fdc10e65feda9eb8374a5e754a75d67de038c5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971) | |
| parent | [4b3bdfa89635db6a53e02955548bd07bebcae233](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b3bdfa89635db6a53e02955548bd07bebcae233) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971&id2=4b3bdfa89635db6a53e02955548bd07bebcae233)) | |
| download | [linux-fb83b093f75806333b6f4ae29b158d2e0e3ec971.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fb83b093f75806333b6f4ae29b158d2e0e3ec971.tar.gz) | |

initramfs: avoid filename buffer overrun[ Upstream commit e017671f534dd3f568db9e47b0583e853d2da9b5 ]
The initramfs filename field is defined in
Documentation/driver-api/early-userspace/buffer-format.rst as:
37 cpio\_file := ALGN(4) + cpio\_header + filename + "\0" + ALGN(4) + data
...
55 ============= ================== =========================
56 Field name Field size Meaning
57 ============= ================== =========================
...
70 c\_namesize 8 bytes Length of filename, including final \0
When extracting an initramfs cpio archive, the kernel's do\_name() path
handler assumes a zero-terminated path at @collected, passing it
directly to filp\_open() / init\_mkdir() / init\_mknod().
If a specially crafted cpio entry carries a non-zero-terminated filename
and is followed by uninitialized memory, then a file may be created with
trailing characters that represent the uninitialized memory. The ability
to create an initramfs entry would imply already having full control of
the system, so the buffer overrun shouldn't be considered a security
vulnerability.
Append the output of the following bash script to an existing initramfs
and observe any created /initramfs\_test\_fname\_overrunAA\* path. E.g.
./reproducer.sh | gzip >> /myinitramfs
It's easiest to observe non-zero uninitialized memory when the output is
gzipped, as it'll overflow the heap allocated @out\_buf in \_\_gunzip(),
rather than the initrd\_start+initrd\_size block.
---- reproducer.sh ----
nilchar="A" # change to "\0" to properly zero terminate / pad
magic="070701"
ino=1
mode=$(( 0100777 ))
uid=0
gid=0
nlink=1
mtime=1
filesize=0
devmajor=0
devminor=1
rdevmajor=0
rdevminor=0
csum=0
fname="initramfs\_test\_fname\_overrun"
namelen=$(( ${#fname} + 1 )) # plus one to account for terminator
printf "%s%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%s" \
$magic $ino $mode $uid $gid $nlink $mtime $filesize \
$devmajor $devminor $rdevmajor $rdevminor $namelen $csum $fname
termpadlen=$(( 1 + ((4 - ((110 + $namelen) & 3)) % 4) ))
printf "%.s${nilchar}" $(seq 1 $termpadlen)
---- reproducer.sh ----
Symlink filename fields handled in do\_symlink() won't overrun past the
data segment, due to the explicit zero-termination of the symlink
target.
Fix filename buffer overrun by aborting the initramfs FSM if any cpio
entry doesn't carry a zero-terminator at the expected (name\_len - 1)
offset.
Fixes: 1da177e4c3f41 ("Linux-2.6.12-rc2")
Signed-off-by: David Disseldorp <ddiss@suse.de>
Link: [https://lore.kernel.org/r/20241030035509.20194-2-ddiss@suse.de](https://lore.kernel.org/r/20241030035509.20194-2-ddiss%40suse.de)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971)

| -rw-r--r-- | [init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/init/initramfs.c?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 0 deletions

| diff --git a/init/initramfs.c b/init/initramfs.cindex bc911e466d5bbb..b2f7583bb1f5c2 100644--- a/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=4b3bdfa89635db6a53e02955548bd07bebcae233)+++ b/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=fb83b093f75806333b6f4ae29b158d2e0e3ec971)@@ -360,6 +360,15 @@ static int \_\_init do\_name(void) { state = SkipIt; next\_state = Reset;++ /\* name\_len > 0 && name\_len <= PATH\_MAX checked in do\_header \*/+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs name without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ }+ if (strcmp(collected, "TRAILER!!!") == 0) { free\_hash(); return 0;@@ -424,6 +433,12 @@ static int \_\_init do\_copy(void)  static int \_\_init do\_symlink(void) {+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs symlink without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ } collected[N\_ALIGN(name\_len) + body\_len] = '\0'; clean\_path(collected, 0); init\_symlink(collected + N\_ALIGN(name\_len), collected); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:11:39 +0000



=== Content from git.kernel.org_22e8a2b0_20250114_211254.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=49d01e736c3045319e030d1e75fb983011abaca7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=49d01e736c3045319e030d1e75fb983011abaca7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49d01e736c3045319e030d1e75fb983011abaca7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49d01e736c3045319e030d1e75fb983011abaca7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Disseldorp <ddiss@suse.de> | 2024-10-30 03:55:10 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:52:45 +0100 |
| commit | [49d01e736c3045319e030d1e75fb983011abaca7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49d01e736c3045319e030d1e75fb983011abaca7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=49d01e736c3045319e030d1e75fb983011abaca7)) | |
| tree | [17aa24f8283eac922f798a459982f71c7533e5df](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=49d01e736c3045319e030d1e75fb983011abaca7) | |
| parent | [916d8c0b579f6e78d568b7c8a83ca761de45b11a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=916d8c0b579f6e78d568b7c8a83ca761de45b11a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49d01e736c3045319e030d1e75fb983011abaca7&id2=916d8c0b579f6e78d568b7c8a83ca761de45b11a)) | |
| download | [linux-49d01e736c3045319e030d1e75fb983011abaca7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-49d01e736c3045319e030d1e75fb983011abaca7.tar.gz) | |

initramfs: avoid filename buffer overrun[ Upstream commit e017671f534dd3f568db9e47b0583e853d2da9b5 ]
The initramfs filename field is defined in
Documentation/driver-api/early-userspace/buffer-format.rst as:
37 cpio\_file := ALGN(4) + cpio\_header + filename + "\0" + ALGN(4) + data
...
55 ============= ================== =========================
56 Field name Field size Meaning
57 ============= ================== =========================
...
70 c\_namesize 8 bytes Length of filename, including final \0
When extracting an initramfs cpio archive, the kernel's do\_name() path
handler assumes a zero-terminated path at @collected, passing it
directly to filp\_open() / init\_mkdir() / init\_mknod().
If a specially crafted cpio entry carries a non-zero-terminated filename
and is followed by uninitialized memory, then a file may be created with
trailing characters that represent the uninitialized memory. The ability
to create an initramfs entry would imply already having full control of
the system, so the buffer overrun shouldn't be considered a security
vulnerability.
Append the output of the following bash script to an existing initramfs
and observe any created /initramfs\_test\_fname\_overrunAA\* path. E.g.
./reproducer.sh | gzip >> /myinitramfs
It's easiest to observe non-zero uninitialized memory when the output is
gzipped, as it'll overflow the heap allocated @out\_buf in \_\_gunzip(),
rather than the initrd\_start+initrd\_size block.
---- reproducer.sh ----
nilchar="A" # change to "\0" to properly zero terminate / pad
magic="070701"
ino=1
mode=$(( 0100777 ))
uid=0
gid=0
nlink=1
mtime=1
filesize=0
devmajor=0
devminor=1
rdevmajor=0
rdevminor=0
csum=0
fname="initramfs\_test\_fname\_overrun"
namelen=$(( ${#fname} + 1 )) # plus one to account for terminator
printf "%s%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%s" \
$magic $ino $mode $uid $gid $nlink $mtime $filesize \
$devmajor $devminor $rdevmajor $rdevminor $namelen $csum $fname
termpadlen=$(( 1 + ((4 - ((110 + $namelen) & 3)) % 4) ))
printf "%.s${nilchar}" $(seq 1 $termpadlen)
---- reproducer.sh ----
Symlink filename fields handled in do\_symlink() won't overrun past the
data segment, due to the explicit zero-termination of the symlink
target.
Fix filename buffer overrun by aborting the initramfs FSM if any cpio
entry doesn't carry a zero-terminator at the expected (name\_len - 1)
offset.
Fixes: 1da177e4c3f41 ("Linux-2.6.12-rc2")
Signed-off-by: David Disseldorp <ddiss@suse.de>
Link: [https://lore.kernel.org/r/20241030035509.20194-2-ddiss@suse.de](https://lore.kernel.org/r/20241030035509.20194-2-ddiss%40suse.de)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49d01e736c3045319e030d1e75fb983011abaca7)

| -rw-r--r-- | [init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/init/initramfs.c?id=49d01e736c3045319e030d1e75fb983011abaca7) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 0 deletions

| diff --git a/init/initramfs.c b/init/initramfs.cindex 814241b648274f..04e0990f451cf9 100644--- a/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=916d8c0b579f6e78d568b7c8a83ca761de45b11a)+++ b/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=49d01e736c3045319e030d1e75fb983011abaca7)@@ -359,6 +359,15 @@ static int \_\_init do\_name(void) { state = SkipIt; next\_state = Reset;++ /\* name\_len > 0 && name\_len <= PATH\_MAX checked in do\_header \*/+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs name without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ }+ if (strcmp(collected, "TRAILER!!!") == 0) { free\_hash(); return 0;@@ -423,6 +432,12 @@ static int \_\_init do\_copy(void)  static int \_\_init do\_symlink(void) {+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs symlink without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ } collected[N\_ALIGN(name\_len) + body\_len] = '\0'; clean\_path(collected, 0); init\_symlink(collected + N\_ALIGN(name\_len), collected); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:11:31 +0000



=== Content from git.kernel.org_f257bc73_20250114_211259.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e017671f534dd3f568db9e47b0583e853d2da9b5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e017671f534dd3f568db9e47b0583e853d2da9b5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e017671f534dd3f568db9e47b0583e853d2da9b5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e017671f534dd3f568db9e47b0583e853d2da9b5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Disseldorp <ddiss@suse.de> | 2024-10-30 03:55:10 +0000 |
| --- | --- | --- |
| committer | Christian Brauner <brauner@kernel.org> | 2024-10-31 13:05:38 +0100 |
| commit | [e017671f534dd3f568db9e47b0583e853d2da9b5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e017671f534dd3f568db9e47b0583e853d2da9b5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e017671f534dd3f568db9e47b0583e853d2da9b5)) | |
| tree | [daba13f5ebdc58b38c9721633b70199ae1e6333d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e017671f534dd3f568db9e47b0583e853d2da9b5) | |
| parent | [30dac24e14b52e1787572d1d4e06eeabe8a63630](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30dac24e14b52e1787572d1d4e06eeabe8a63630) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e017671f534dd3f568db9e47b0583e853d2da9b5&id2=30dac24e14b52e1787572d1d4e06eeabe8a63630)) | |
| download | [linux-e017671f534dd3f568db9e47b0583e853d2da9b5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e017671f534dd3f568db9e47b0583e853d2da9b5.tar.gz) | |

initramfs: avoid filename buffer overrunThe initramfs filename field is defined in
Documentation/driver-api/early-userspace/buffer-format.rst as:
37 cpio\_file := ALGN(4) + cpio\_header + filename + "\0" + ALGN(4) + data
...
55 ============= ================== =========================
56 Field name Field size Meaning
57 ============= ================== =========================
...
70 c\_namesize 8 bytes Length of filename, including final \0
When extracting an initramfs cpio archive, the kernel's do\_name() path
handler assumes a zero-terminated path at @collected, passing it
directly to filp\_open() / init\_mkdir() / init\_mknod().
If a specially crafted cpio entry carries a non-zero-terminated filename
and is followed by uninitialized memory, then a file may be created with
trailing characters that represent the uninitialized memory. The ability
to create an initramfs entry would imply already having full control of
the system, so the buffer overrun shouldn't be considered a security
vulnerability.
Append the output of the following bash script to an existing initramfs
and observe any created /initramfs\_test\_fname\_overrunAA\* path. E.g.
./reproducer.sh | gzip >> /myinitramfs
It's easiest to observe non-zero uninitialized memory when the output is
gzipped, as it'll overflow the heap allocated @out\_buf in \_\_gunzip(),
rather than the initrd\_start+initrd\_size block.
---- reproducer.sh ----
nilchar="A" # change to "\0" to properly zero terminate / pad
magic="070701"
ino=1
mode=$(( 0100777 ))
uid=0
gid=0
nlink=1
mtime=1
filesize=0
devmajor=0
devminor=1
rdevmajor=0
rdevminor=0
csum=0
fname="initramfs\_test\_fname\_overrun"
namelen=$(( ${#fname} + 1 )) # plus one to account for terminator
printf "%s%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%s" \
$magic $ino $mode $uid $gid $nlink $mtime $filesize \
$devmajor $devminor $rdevmajor $rdevminor $namelen $csum $fname
termpadlen=$(( 1 + ((4 - ((110 + $namelen) & 3)) % 4) ))
printf "%.s${nilchar}" $(seq 1 $termpadlen)
---- reproducer.sh ----
Symlink filename fields handled in do\_symlink() won't overrun past the
data segment, due to the explicit zero-termination of the symlink
target.
Fix filename buffer overrun by aborting the initramfs FSM if any cpio
entry doesn't carry a zero-terminator at the expected (name\_len - 1)
offset.
Fixes: 1da177e4c3f41 ("Linux-2.6.12-rc2")
Signed-off-by: David Disseldorp <ddiss@suse.de>
Link: [https://lore.kernel.org/r/20241030035509.20194-2-ddiss@suse.de](https://lore.kernel.org/r/20241030035509.20194-2-ddiss%40suse.de)
Signed-off-by: Christian Brauner <brauner@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e017671f534dd3f568db9e47b0583e853d2da9b5)

| -rw-r--r-- | [init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/init/initramfs.c?id=e017671f534dd3f568db9e47b0583e853d2da9b5) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 0 deletions

| diff --git a/init/initramfs.c b/init/initramfs.cindex bc911e466d5bbb..b2f7583bb1f5c2 100644--- a/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=30dac24e14b52e1787572d1d4e06eeabe8a63630)+++ b/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=e017671f534dd3f568db9e47b0583e853d2da9b5)@@ -360,6 +360,15 @@ static int \_\_init do\_name(void) { state = SkipIt; next\_state = Reset;++ /\* name\_len > 0 && name\_len <= PATH\_MAX checked in do\_header \*/+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs name without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ }+ if (strcmp(collected, "TRAILER!!!") == 0) { free\_hash(); return 0;@@ -424,6 +433,12 @@ static int \_\_init do\_copy(void)  static int \_\_init do\_symlink(void) {+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs symlink without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ } collected[N\_ALIGN(name\_len) + body\_len] = '\0'; clean\_path(collected, 0); init\_symlink(collected + N\_ALIGN(name\_len), collected); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:11:36 +0000



=== Content from git.kernel.org_a40ccef9_20250114_211301.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Disseldorp <ddiss@suse.de> | 2024-10-30 03:55:10 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:14 +0100 |
| commit | [f892ddcf9f645380c358e73653cb0900f6bc9eb8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8)) | |
| tree | [fc7794f1aa13d56e8bf5356e3c2203937d9f224a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8) | |
| parent | [7961d460eceb1f35d0a9bcf6a4f8630869d6b236](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7961d460eceb1f35d0a9bcf6a4f8630869d6b236) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8&id2=7961d460eceb1f35d0a9bcf6a4f8630869d6b236)) | |
| download | [linux-f892ddcf9f645380c358e73653cb0900f6bc9eb8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f892ddcf9f645380c358e73653cb0900f6bc9eb8.tar.gz) | |

initramfs: avoid filename buffer overrun[ Upstream commit e017671f534dd3f568db9e47b0583e853d2da9b5 ]
The initramfs filename field is defined in
Documentation/driver-api/early-userspace/buffer-format.rst as:
37 cpio\_file := ALGN(4) + cpio\_header + filename + "\0" + ALGN(4) + data
...
55 ============= ================== =========================
56 Field name Field size Meaning
57 ============= ================== =========================
...
70 c\_namesize 8 bytes Length of filename, including final \0
When extracting an initramfs cpio archive, the kernel's do\_name() path
handler assumes a zero-terminated path at @collected, passing it
directly to filp\_open() / init\_mkdir() / init\_mknod().
If a specially crafted cpio entry carries a non-zero-terminated filename
and is followed by uninitialized memory, then a file may be created with
trailing characters that represent the uninitialized memory. The ability
to create an initramfs entry would imply already having full control of
the system, so the buffer overrun shouldn't be considered a security
vulnerability.
Append the output of the following bash script to an existing initramfs
and observe any created /initramfs\_test\_fname\_overrunAA\* path. E.g.
./reproducer.sh | gzip >> /myinitramfs
It's easiest to observe non-zero uninitialized memory when the output is
gzipped, as it'll overflow the heap allocated @out\_buf in \_\_gunzip(),
rather than the initrd\_start+initrd\_size block.
---- reproducer.sh ----
nilchar="A" # change to "\0" to properly zero terminate / pad
magic="070701"
ino=1
mode=$(( 0100777 ))
uid=0
gid=0
nlink=1
mtime=1
filesize=0
devmajor=0
devminor=1
rdevmajor=0
rdevminor=0
csum=0
fname="initramfs\_test\_fname\_overrun"
namelen=$(( ${#fname} + 1 )) # plus one to account for terminator
printf "%s%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%08x%s" \
$magic $ino $mode $uid $gid $nlink $mtime $filesize \
$devmajor $devminor $rdevmajor $rdevminor $namelen $csum $fname
termpadlen=$(( 1 + ((4 - ((110 + $namelen) & 3)) % 4) ))
printf "%.s${nilchar}" $(seq 1 $termpadlen)
---- reproducer.sh ----
Symlink filename fields handled in do\_symlink() won't overrun past the
data segment, due to the explicit zero-termination of the symlink
target.
Fix filename buffer overrun by aborting the initramfs FSM if any cpio
entry doesn't carry a zero-terminator at the expected (name\_len - 1)
offset.
Fixes: 1da177e4c3f41 ("Linux-2.6.12-rc2")
Signed-off-by: David Disseldorp <ddiss@suse.de>
Link: [https://lore.kernel.org/r/20241030035509.20194-2-ddiss@suse.de](https://lore.kernel.org/r/20241030035509.20194-2-ddiss%40suse.de)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8)

| -rw-r--r-- | [init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/init/initramfs.c?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 0 deletions

| diff --git a/init/initramfs.c b/init/initramfs.cindex 7b915170789da8..3eab7fccb106f1 100644--- a/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=7961d460eceb1f35d0a9bcf6a4f8630869d6b236)+++ b/[init/initramfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/init/initramfs.c?id=f892ddcf9f645380c358e73653cb0900f6bc9eb8)@@ -364,6 +364,15 @@ static int \_\_init do\_name(void) { state = SkipIt; next\_state = Reset;++ /\* name\_len > 0 && name\_len <= PATH\_MAX checked in do\_header \*/+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs name without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ }+ if (strcmp(collected, "TRAILER!!!") == 0) { free\_hash(); return 0;@@ -428,6 +437,12 @@ static int \_\_init do\_copy(void)  static int \_\_init do\_symlink(void) {+ if (collected[name\_len - 1] != '\0') {+ pr\_err("initramfs symlink without nulterm: %.\*s\n",+ (int)name\_len, collected);+ error("malformed archive");+ return 1;+ } collected[N\_ALIGN(name\_len) + body\_len] = '\0'; clean\_path(collected, 0); init\_symlink(collected + N\_ALIGN(name\_len), collected); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:11:38 +0000


