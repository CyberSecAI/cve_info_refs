=== Content from git.kernel.org_4a6707c1_20250114_232604.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=54c814c8b23bc7617be3d46abdb896937695dbfa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=54c814c8b23bc7617be3d46abdb896937695dbfa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54c814c8b23bc7617be3d46abdb896937695dbfa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=54c814c8b23bc7617be3d46abdb896937695dbfa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bart Van Assche <bvanassche@acm.org> | 2024-10-31 14:26:24 -0700 |
| --- | --- | --- |
| committer | Martin K. Petersen <martin.petersen@oracle.com> | 2024-11-04 20:56:59 -0500 |
| commit | [54c814c8b23bc7617be3d46abdb896937695dbfa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54c814c8b23bc7617be3d46abdb896937695dbfa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=54c814c8b23bc7617be3d46abdb896937695dbfa)) | |
| tree | [68119322b10e9369cc7494b35ae1e884c0eaa0f4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=54c814c8b23bc7617be3d46abdb896937695dbfa) | |
| parent | [7ce3e6107103214d354a16729a472f588be60572](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ce3e6107103214d354a16729a472f588be60572) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=54c814c8b23bc7617be3d46abdb896937695dbfa&id2=7ce3e6107103214d354a16729a472f588be60572)) | |
| download | [linux-54c814c8b23bc7617be3d46abdb896937695dbfa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-54c814c8b23bc7617be3d46abdb896937695dbfa.tar.gz) | |

scsi: ufs: core: Start the RTC update work laterThe RTC update work involves runtime resuming the UFS controller. Hence,
only start the RTC update work after runtime power management in the UFS
driver has been fully initialized. This patch fixes the following kernel
crash:
Internal error: Oops: 0000000096000006 [#1] PREEMPT SMP
Workqueue: events ufshcd\_rtc\_work
Call trace:
\_raw\_spin\_lock\_irqsave+0x34/0x8c (P)
pm\_runtime\_get\_if\_active+0x24/0x9c (L)
pm\_runtime\_get\_if\_active+0x24/0x9c
ufshcd\_rtc\_work+0x138/0x1b4
process\_one\_work+0x148/0x288
worker\_thread+0x2cc/0x3d4
kthread+0x110/0x114
ret\_from\_fork+0x10/0x20
Reported-by: Neil Armstrong <neil.armstrong@linaro.org>
Closes: https://lore.kernel.org/linux-scsi/0c0bc528-fdc2-4106-bc99-f23ae377f6f5@linaro.org/
Fixes: 6bf999e0eb41 ("scsi: ufs: core: Add UFS RTC support")
Cc: Bean Huo <beanhuo@micron.com>
Cc: stable@vger.kernel.org
Signed-off-by: Bart Van Assche <bvanassche@acm.org>
Link: [https://lore.kernel.org/r/20241031212632.2799127-1-bvanassche@acm.org](https://lore.kernel.org/r/20241031212632.2799127-1-bvanassche%40acm.org)
Reviewed-by: Peter Wang <peter.wang@mediatek.com>
Reviewed-by: Bean Huo <beanhuo@micron.com>
Tested-by: Neil Armstrong <neil.armstrong@linaro.org> # on SM8650-HDK
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=54c814c8b23bc7617be3d46abdb896937695dbfa)

| -rw-r--r-- | [drivers/ufs/core/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ufs/core/ufshcd.c?id=54c814c8b23bc7617be3d46abdb896937695dbfa) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/drivers/ufs/core/ufshcd.c b/drivers/ufs/core/ufshcd.cindex 0e22bbb7823910..3b32803b7a682a 100644--- a/[drivers/ufs/core/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ufs/core/ufshcd.c?id=7ce3e6107103214d354a16729a472f588be60572)+++ b/[drivers/ufs/core/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ufs/core/ufshcd.c?id=54c814c8b23bc7617be3d46abdb896937695dbfa)@@ -8636,6 +8636,14 @@ static int ufshcd\_add\_lus(struct ufs\_hba \*hba) ufshcd\_init\_clk\_scaling\_sysfs(hba); } + /\*+ \* The RTC update code accesses the hba->ufs\_device\_wlun->sdev\_gendev+ \* pointer and hence must only be started after the WLUN pointer has+ \* been initialized by ufshcd\_scsi\_add\_wlus().+ \*/+ schedule\_delayed\_work(&hba->ufs\_rtc\_update\_work,+ msecs\_to\_jiffies(UFS\_RTC\_UPDATE\_INTERVAL\_MS));+ ufs\_bsg\_probe(hba); scsi\_scan\_host(hba->host); @@ -8795,8 +8803,6 @@ static int ufshcd\_device\_init(struct ufs\_hba \*hba, bool init\_dev\_params) ufshcd\_force\_reset\_auto\_bkops(hba);  ufshcd\_set\_timestamp\_attr(hba);- schedule\_delayed\_work(&hba->ufs\_rtc\_update\_work,- msecs\_to\_jiffies(UFS\_RTC\_UPDATE\_INTERVAL\_MS));  /\* Gear up to HS gear if supported \*/ if (hba->max\_pwr\_info.is\_valid) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:24:41 +0000



=== Content from git.kernel.org_5dbc6535_20250114_232603.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4c25f784fba81227e0437337f962d34380d1c250)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c25f784fba81227e0437337f962d34380d1c250)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c25f784fba81227e0437337f962d34380d1c250)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c25f784fba81227e0437337f962d34380d1c250)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bart Van Assche <bvanassche@acm.org> | 2024-10-31 14:26:24 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:08 +0100 |
| commit | [4c25f784fba81227e0437337f962d34380d1c250](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c25f784fba81227e0437337f962d34380d1c250) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4c25f784fba81227e0437337f962d34380d1c250)) | |
| tree | [b0f8f72030f1a5f411e009af1a53224f051676f3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c25f784fba81227e0437337f962d34380d1c250) | |
| parent | [15bc37a6c9d62931e7d03c896139a9d08d9e5b33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15bc37a6c9d62931e7d03c896139a9d08d9e5b33) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c25f784fba81227e0437337f962d34380d1c250&id2=15bc37a6c9d62931e7d03c896139a9d08d9e5b33)) | |
| download | [linux-4c25f784fba81227e0437337f962d34380d1c250.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4c25f784fba81227e0437337f962d34380d1c250.tar.gz) | |

scsi: ufs: core: Start the RTC update work latercommit 54c814c8b23bc7617be3d46abdb896937695dbfa upstream.
The RTC update work involves runtime resuming the UFS controller. Hence,
only start the RTC update work after runtime power management in the UFS
driver has been fully initialized. This patch fixes the following kernel
crash:
Internal error: Oops: 0000000096000006 [#1] PREEMPT SMP
Workqueue: events ufshcd\_rtc\_work
Call trace:
\_raw\_spin\_lock\_irqsave+0x34/0x8c (P)
pm\_runtime\_get\_if\_active+0x24/0x9c (L)
pm\_runtime\_get\_if\_active+0x24/0x9c
ufshcd\_rtc\_work+0x138/0x1b4
process\_one\_work+0x148/0x288
worker\_thread+0x2cc/0x3d4
kthread+0x110/0x114
ret\_from\_fork+0x10/0x20
Reported-by: Neil Armstrong <neil.armstrong@linaro.org>
Closes: https://lore.kernel.org/linux-scsi/0c0bc528-fdc2-4106-bc99-f23ae377f6f5@linaro.org/
Fixes: 6bf999e0eb41 ("scsi: ufs: core: Add UFS RTC support")
Cc: Bean Huo <beanhuo@micron.com>
Cc: stable@vger.kernel.org
Signed-off-by: Bart Van Assche <bvanassche@acm.org>
Link: [https://lore.kernel.org/r/20241031212632.2799127-1-bvanassche@acm.org](https://lore.kernel.org/r/20241031212632.2799127-1-bvanassche%40acm.org)
Reviewed-by: Peter Wang <peter.wang@mediatek.com>
Reviewed-by: Bean Huo <beanhuo@micron.com>
Tested-by: Neil Armstrong <neil.armstrong@linaro.org> # on SM8650-HDK
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c25f784fba81227e0437337f962d34380d1c250)

| -rw-r--r-- | [drivers/ufs/core/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ufs/core/ufshcd.c?id=4c25f784fba81227e0437337f962d34380d1c250) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/drivers/ufs/core/ufshcd.c b/drivers/ufs/core/ufshcd.cindex 83567388a7b58e..03490f062d63aa 100644--- a/[drivers/ufs/core/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ufs/core/ufshcd.c?id=15bc37a6c9d62931e7d03c896139a9d08d9e5b33)+++ b/[drivers/ufs/core/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ufs/core/ufshcd.c?id=4c25f784fba81227e0437337f962d34380d1c250)@@ -8641,6 +8641,14 @@ static int ufshcd\_add\_lus(struct ufs\_hba \*hba) ufshcd\_init\_clk\_scaling\_sysfs(hba); } + /\*+ \* The RTC update code accesses the hba->ufs\_device\_wlun->sdev\_gendev+ \* pointer and hence must only be started after the WLUN pointer has+ \* been initialized by ufshcd\_scsi\_add\_wlus().+ \*/+ schedule\_delayed\_work(&hba->ufs\_rtc\_update\_work,+ msecs\_to\_jiffies(UFS\_RTC\_UPDATE\_INTERVAL\_MS));+ ufs\_bsg\_probe(hba); scsi\_scan\_host(hba->host); @@ -8800,8 +8808,6 @@ static int ufshcd\_device\_init(struct ufs\_hba \*hba, bool init\_dev\_params) ufshcd\_force\_reset\_auto\_bkops(hba);  ufshcd\_set\_timestamp\_attr(hba);- schedule\_delayed\_work(&hba->ufs\_rtc\_update\_work,- msecs\_to\_jiffies(UFS\_RTC\_UPDATE\_INTERVAL\_MS));  /\* Gear up to HS gear if supported \*/ if (hba->max\_pwr\_info.is\_valid) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:24:39 +0000


