=== Content from git.kernel.org_107e4237_20250114_183553.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0f67ca2a80acf8b207240405b7f72d660665d3df)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f67ca2a80acf8b207240405b7f72d660665d3df)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f67ca2a80acf8b207240405b7f72d660665d3df)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f67ca2a80acf8b207240405b7f72d660665d3df)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-11-01 14:44:10 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:34 +0100 |
| commit | [0f67ca2a80acf8b207240405b7f72d660665d3df](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f67ca2a80acf8b207240405b7f72d660665d3df) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0f67ca2a80acf8b207240405b7f72d660665d3df)) | |
| tree | [94f4194f20afa7207723e75310d6286fd1916c88](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f67ca2a80acf8b207240405b7f72d660665d3df) | |
| parent | [ea8cc56db659cf0ae57073e32a4735ead7bd7ee3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea8cc56db659cf0ae57073e32a4735ead7bd7ee3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f67ca2a80acf8b207240405b7f72d660665d3df&id2=ea8cc56db659cf0ae57073e32a4735ead7bd7ee3)) | |
| download | [linux-0f67ca2a80acf8b207240405b7f72d660665d3df.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0f67ca2a80acf8b207240405b7f72d660665d3df.tar.gz) | |

Bluetooth: fix use-after-free in device\_for\_each\_child()[ Upstream commit 27aabf27fd014ae037cc179c61b0bee7cff55b3d ]
Syzbot has reported the following KASAN splat:
BUG: KASAN: slab-use-after-free in device\_for\_each\_child+0x18f/0x1a0
Read of size 8 at addr ffff88801f605308 by task kbnepd bnep0/4980
CPU: 0 UID: 0 PID: 4980 Comm: kbnepd bnep0 Not tainted 6.12.0-rc4-00161-gae90f6a6170d #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x100/0x190
? device\_for\_each\_child+0x18f/0x1a0
print\_report+0x13a/0x4cb
? \_\_virt\_addr\_valid+0x5e/0x590
? \_\_phys\_addr+0xc6/0x150
? device\_for\_each\_child+0x18f/0x1a0
kasan\_report+0xda/0x110
? device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_dev\_memalloc\_noio+0x10/0x10
device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_device\_for\_each\_child+0x10/0x10
pm\_runtime\_set\_memalloc\_noio+0xf2/0x180
netdev\_unregister\_kobject+0x1ed/0x270
unregister\_netdevice\_many\_notify+0x123c/0x1d80
? \_\_mutex\_trylock\_common+0xde/0x250
? \_\_pfx\_unregister\_netdevice\_many\_notify+0x10/0x10
? trace\_contention\_end+0xe6/0x140
? \_\_mutex\_lock+0x4e7/0x8f0
? \_\_pfx\_lock\_acquire.part.0+0x10/0x10
? rcu\_is\_watching+0x12/0xc0
? unregister\_netdev+0x12/0x30
unregister\_netdevice\_queue+0x30d/0x3f0
? \_\_pfx\_unregister\_netdevice\_queue+0x10/0x10
? \_\_pfx\_down\_write+0x10/0x10
unregister\_netdev+0x1c/0x30
bnep\_session+0x1fb3/0x2ab0
? \_\_pfx\_bnep\_session+0x10/0x10
? \_\_pfx\_lock\_release+0x10/0x10
? \_\_pfx\_woken\_wake\_function+0x10/0x10
? \_\_kthread\_parkme+0x132/0x200
? \_\_pfx\_bnep\_session+0x10/0x10
? kthread+0x13a/0x370
? \_\_pfx\_bnep\_session+0x10/0x10
kthread+0x2b7/0x370
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x48/0x80
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 4974:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
\_\_kmalloc\_noprof+0x1d1/0x440
hci\_alloc\_dev\_priv+0x1d/0x2820
\_\_vhci\_create\_device+0xef/0x7d0
vhci\_write+0x2c7/0x480
vfs\_write+0x6a0/0xfc0
ksys\_write+0x12f/0x260
do\_syscall\_64+0xc7/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 4979:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x4f/0x70
kfree+0x141/0x490
hci\_release\_dev+0x4d9/0x600
bt\_host\_release+0x6a/0xb0
device\_release+0xa4/0x240
kobject\_put+0x1ec/0x5a0
put\_device+0x1f/0x30
vhci\_release+0x81/0xf0
\_\_fput+0x3f6/0xb30
task\_work\_run+0x151/0x250
do\_exit+0xa79/0x2c30
do\_group\_exit+0xd5/0x2a0
get\_signal+0x1fcd/0x2210
arch\_do\_signal\_or\_restart+0x93/0x780
syscall\_exit\_to\_user\_mode+0x140/0x290
do\_syscall\_64+0xd4/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
In 'hci\_conn\_del\_sysfs()', 'device\_unregister()' may be called when
an underlying (kobject) reference counter is greater than 1. This
means that reparenting (happened when the device is actually freed)
is delayed and, during that delay, parent controller device (hciX)
may be deleted. Since the latter may create a dangling pointer to
freed parent, avoid that scenario by reparenting to NULL explicitly.
Reported-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Tested-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=6cf5652d3df49fae2e3f
Fixes: a85fb91e3d72 ("Bluetooth: Fix double free in hci\_conn\_cleanup")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f67ca2a80acf8b207240405b7f72d660665d3df)

| -rw-r--r-- | [net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sysfs.c?id=0f67ca2a80acf8b207240405b7f72d660665d3df) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 11 deletions

| diff --git a/net/bluetooth/hci\_sysfs.c b/net/bluetooth/hci\_sysfs.cindex 633b82d5427283..cc7d4a8ed8ce24 100644--- a/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=ea8cc56db659cf0ae57073e32a4735ead7bd7ee3)+++ b/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=0f67ca2a80acf8b207240405b7f72d660665d3df)@@ -19,16 +19,6 @@ static const struct device\_type bt\_link = { .release = bt\_link\_release, }; -/\*- \* The rfcomm tty device will possibly retain even when conn- \* is down, and sysfs doesn't support move zombie device,- \* so we should move the device before conn device is destroyed.- \*/-static int \_\_match\_tty(struct device \*dev, void \*data)-{- return !strncmp(dev\_name(dev), "rfcomm", 6);-}- void hci\_conn\_init\_sysfs(struct hci\_conn \*conn) { struct hci\_dev \*hdev = conn->hdev;@@ -71,10 +61,13 @@ void hci\_conn\_del\_sysfs(struct hci\_conn \*conn) return; } + /\* If there are devices using the connection as parent reset it to NULL+ \* before unregistering the device.+ \*/ while (1) { struct device \*dev; - dev = device\_find\_child(&conn->dev, NULL, \_\_match\_tty);+ dev = device\_find\_any\_child(&conn->dev); if (!dev) break; device\_move(dev, NULL, DPM\_ORDER\_DEV\_LAST); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:28:20 +0000



=== Content from git.kernel.org_57339eed_20250114_183556.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7b277bd569bb6a2777f0014f84b4344f444fd49d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b277bd569bb6a2777f0014f84b4344f444fd49d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b277bd569bb6a2777f0014f84b4344f444fd49d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b277bd569bb6a2777f0014f84b4344f444fd49d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-11-01 14:44:10 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:59 +0100 |
| commit | [7b277bd569bb6a2777f0014f84b4344f444fd49d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b277bd569bb6a2777f0014f84b4344f444fd49d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7b277bd569bb6a2777f0014f84b4344f444fd49d)) | |
| tree | [a6ef01ad67daca4383f585135408919bdfc8dc4e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b277bd569bb6a2777f0014f84b4344f444fd49d) | |
| parent | [1360e5b6ce63d63d23223a659ca2bbafa30a53aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1360e5b6ce63d63d23223a659ca2bbafa30a53aa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b277bd569bb6a2777f0014f84b4344f444fd49d&id2=1360e5b6ce63d63d23223a659ca2bbafa30a53aa)) | |
| download | [linux-7b277bd569bb6a2777f0014f84b4344f444fd49d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7b277bd569bb6a2777f0014f84b4344f444fd49d.tar.gz) | |

Bluetooth: fix use-after-free in device\_for\_each\_child()[ Upstream commit 27aabf27fd014ae037cc179c61b0bee7cff55b3d ]
Syzbot has reported the following KASAN splat:
BUG: KASAN: slab-use-after-free in device\_for\_each\_child+0x18f/0x1a0
Read of size 8 at addr ffff88801f605308 by task kbnepd bnep0/4980
CPU: 0 UID: 0 PID: 4980 Comm: kbnepd bnep0 Not tainted 6.12.0-rc4-00161-gae90f6a6170d #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x100/0x190
? device\_for\_each\_child+0x18f/0x1a0
print\_report+0x13a/0x4cb
? \_\_virt\_addr\_valid+0x5e/0x590
? \_\_phys\_addr+0xc6/0x150
? device\_for\_each\_child+0x18f/0x1a0
kasan\_report+0xda/0x110
? device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_dev\_memalloc\_noio+0x10/0x10
device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_device\_for\_each\_child+0x10/0x10
pm\_runtime\_set\_memalloc\_noio+0xf2/0x180
netdev\_unregister\_kobject+0x1ed/0x270
unregister\_netdevice\_many\_notify+0x123c/0x1d80
? \_\_mutex\_trylock\_common+0xde/0x250
? \_\_pfx\_unregister\_netdevice\_many\_notify+0x10/0x10
? trace\_contention\_end+0xe6/0x140
? \_\_mutex\_lock+0x4e7/0x8f0
? \_\_pfx\_lock\_acquire.part.0+0x10/0x10
? rcu\_is\_watching+0x12/0xc0
? unregister\_netdev+0x12/0x30
unregister\_netdevice\_queue+0x30d/0x3f0
? \_\_pfx\_unregister\_netdevice\_queue+0x10/0x10
? \_\_pfx\_down\_write+0x10/0x10
unregister\_netdev+0x1c/0x30
bnep\_session+0x1fb3/0x2ab0
? \_\_pfx\_bnep\_session+0x10/0x10
? \_\_pfx\_lock\_release+0x10/0x10
? \_\_pfx\_woken\_wake\_function+0x10/0x10
? \_\_kthread\_parkme+0x132/0x200
? \_\_pfx\_bnep\_session+0x10/0x10
? kthread+0x13a/0x370
? \_\_pfx\_bnep\_session+0x10/0x10
kthread+0x2b7/0x370
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x48/0x80
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 4974:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
\_\_kmalloc\_noprof+0x1d1/0x440
hci\_alloc\_dev\_priv+0x1d/0x2820
\_\_vhci\_create\_device+0xef/0x7d0
vhci\_write+0x2c7/0x480
vfs\_write+0x6a0/0xfc0
ksys\_write+0x12f/0x260
do\_syscall\_64+0xc7/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 4979:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x4f/0x70
kfree+0x141/0x490
hci\_release\_dev+0x4d9/0x600
bt\_host\_release+0x6a/0xb0
device\_release+0xa4/0x240
kobject\_put+0x1ec/0x5a0
put\_device+0x1f/0x30
vhci\_release+0x81/0xf0
\_\_fput+0x3f6/0xb30
task\_work\_run+0x151/0x250
do\_exit+0xa79/0x2c30
do\_group\_exit+0xd5/0x2a0
get\_signal+0x1fcd/0x2210
arch\_do\_signal\_or\_restart+0x93/0x780
syscall\_exit\_to\_user\_mode+0x140/0x290
do\_syscall\_64+0xd4/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
In 'hci\_conn\_del\_sysfs()', 'device\_unregister()' may be called when
an underlying (kobject) reference counter is greater than 1. This
means that reparenting (happened when the device is actually freed)
is delayed and, during that delay, parent controller device (hciX)
may be deleted. Since the latter may create a dangling pointer to
freed parent, avoid that scenario by reparenting to NULL explicitly.
Reported-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Tested-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=6cf5652d3df49fae2e3f
Fixes: a85fb91e3d72 ("Bluetooth: Fix double free in hci\_conn\_cleanup")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b277bd569bb6a2777f0014f84b4344f444fd49d)

| -rw-r--r-- | [net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sysfs.c?id=7b277bd569bb6a2777f0014f84b4344f444fd49d) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 11 deletions

| diff --git a/net/bluetooth/hci\_sysfs.c b/net/bluetooth/hci\_sysfs.cindex 367e32fe30eb84..4b54dbbf0729a3 100644--- a/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=1360e5b6ce63d63d23223a659ca2bbafa30a53aa)+++ b/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=7b277bd569bb6a2777f0014f84b4344f444fd49d)@@ -21,16 +21,6 @@ static const struct device\_type bt\_link = { .release = bt\_link\_release, }; -/\*- \* The rfcomm tty device will possibly retain even when conn- \* is down, and sysfs doesn't support move zombie device,- \* so we should move the device before conn device is destroyed.- \*/-static int \_\_match\_tty(struct device \*dev, void \*data)-{- return !strncmp(dev\_name(dev), "rfcomm", 6);-}- void hci\_conn\_init\_sysfs(struct hci\_conn \*conn) { struct hci\_dev \*hdev = conn->hdev;@@ -73,10 +63,13 @@ void hci\_conn\_del\_sysfs(struct hci\_conn \*conn) return; } + /\* If there are devices using the connection as parent reset it to NULL+ \* before unregistering the device.+ \*/ while (1) { struct device \*dev; - dev = device\_find\_child(&conn->dev, NULL, \_\_match\_tty);+ dev = device\_find\_any\_child(&conn->dev); if (!dev) break; device\_move(dev, NULL, DPM\_ORDER\_DEV\_LAST); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:28:47 +0000



=== Content from git.kernel.org_d58f82e2_20250114_183557.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=91e2a2e4d1336333804cd31162984f01ad8cc70f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=91e2a2e4d1336333804cd31162984f01ad8cc70f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91e2a2e4d1336333804cd31162984f01ad8cc70f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=91e2a2e4d1336333804cd31162984f01ad8cc70f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-11-01 14:44:10 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:27 +0100 |
| commit | [91e2a2e4d1336333804cd31162984f01ad8cc70f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91e2a2e4d1336333804cd31162984f01ad8cc70f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=91e2a2e4d1336333804cd31162984f01ad8cc70f)) | |
| tree | [75550246fe0012eaae55222e49ba72ee69feb50d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=91e2a2e4d1336333804cd31162984f01ad8cc70f) | |
| parent | [bfec1e55314896bf4a4cfdb3a9ad4872be9f06ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfec1e55314896bf4a4cfdb3a9ad4872be9f06ed) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=91e2a2e4d1336333804cd31162984f01ad8cc70f&id2=bfec1e55314896bf4a4cfdb3a9ad4872be9f06ed)) | |
| download | [linux-91e2a2e4d1336333804cd31162984f01ad8cc70f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-91e2a2e4d1336333804cd31162984f01ad8cc70f.tar.gz) | |

Bluetooth: fix use-after-free in device\_for\_each\_child()[ Upstream commit 27aabf27fd014ae037cc179c61b0bee7cff55b3d ]
Syzbot has reported the following KASAN splat:
BUG: KASAN: slab-use-after-free in device\_for\_each\_child+0x18f/0x1a0
Read of size 8 at addr ffff88801f605308 by task kbnepd bnep0/4980
CPU: 0 UID: 0 PID: 4980 Comm: kbnepd bnep0 Not tainted 6.12.0-rc4-00161-gae90f6a6170d #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x100/0x190
? device\_for\_each\_child+0x18f/0x1a0
print\_report+0x13a/0x4cb
? \_\_virt\_addr\_valid+0x5e/0x590
? \_\_phys\_addr+0xc6/0x150
? device\_for\_each\_child+0x18f/0x1a0
kasan\_report+0xda/0x110
? device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_dev\_memalloc\_noio+0x10/0x10
device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_device\_for\_each\_child+0x10/0x10
pm\_runtime\_set\_memalloc\_noio+0xf2/0x180
netdev\_unregister\_kobject+0x1ed/0x270
unregister\_netdevice\_many\_notify+0x123c/0x1d80
? \_\_mutex\_trylock\_common+0xde/0x250
? \_\_pfx\_unregister\_netdevice\_many\_notify+0x10/0x10
? trace\_contention\_end+0xe6/0x140
? \_\_mutex\_lock+0x4e7/0x8f0
? \_\_pfx\_lock\_acquire.part.0+0x10/0x10
? rcu\_is\_watching+0x12/0xc0
? unregister\_netdev+0x12/0x30
unregister\_netdevice\_queue+0x30d/0x3f0
? \_\_pfx\_unregister\_netdevice\_queue+0x10/0x10
? \_\_pfx\_down\_write+0x10/0x10
unregister\_netdev+0x1c/0x30
bnep\_session+0x1fb3/0x2ab0
? \_\_pfx\_bnep\_session+0x10/0x10
? \_\_pfx\_lock\_release+0x10/0x10
? \_\_pfx\_woken\_wake\_function+0x10/0x10
? \_\_kthread\_parkme+0x132/0x200
? \_\_pfx\_bnep\_session+0x10/0x10
? kthread+0x13a/0x370
? \_\_pfx\_bnep\_session+0x10/0x10
kthread+0x2b7/0x370
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x48/0x80
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 4974:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
\_\_kmalloc\_noprof+0x1d1/0x440
hci\_alloc\_dev\_priv+0x1d/0x2820
\_\_vhci\_create\_device+0xef/0x7d0
vhci\_write+0x2c7/0x480
vfs\_write+0x6a0/0xfc0
ksys\_write+0x12f/0x260
do\_syscall\_64+0xc7/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 4979:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x4f/0x70
kfree+0x141/0x490
hci\_release\_dev+0x4d9/0x600
bt\_host\_release+0x6a/0xb0
device\_release+0xa4/0x240
kobject\_put+0x1ec/0x5a0
put\_device+0x1f/0x30
vhci\_release+0x81/0xf0
\_\_fput+0x3f6/0xb30
task\_work\_run+0x151/0x250
do\_exit+0xa79/0x2c30
do\_group\_exit+0xd5/0x2a0
get\_signal+0x1fcd/0x2210
arch\_do\_signal\_or\_restart+0x93/0x780
syscall\_exit\_to\_user\_mode+0x140/0x290
do\_syscall\_64+0xd4/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
In 'hci\_conn\_del\_sysfs()', 'device\_unregister()' may be called when
an underlying (kobject) reference counter is greater than 1. This
means that reparenting (happened when the device is actually freed)
is delayed and, during that delay, parent controller device (hciX)
may be deleted. Since the latter may create a dangling pointer to
freed parent, avoid that scenario by reparenting to NULL explicitly.
Reported-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Tested-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=6cf5652d3df49fae2e3f
Fixes: a85fb91e3d72 ("Bluetooth: Fix double free in hci\_conn\_cleanup")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=91e2a2e4d1336333804cd31162984f01ad8cc70f)

| -rw-r--r-- | [net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sysfs.c?id=91e2a2e4d1336333804cd31162984f01ad8cc70f) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 11 deletions

| diff --git a/net/bluetooth/hci\_sysfs.c b/net/bluetooth/hci\_sysfs.cindex 367e32fe30eb84..4b54dbbf0729a3 100644--- a/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=bfec1e55314896bf4a4cfdb3a9ad4872be9f06ed)+++ b/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=91e2a2e4d1336333804cd31162984f01ad8cc70f)@@ -21,16 +21,6 @@ static const struct device\_type bt\_link = { .release = bt\_link\_release, }; -/\*- \* The rfcomm tty device will possibly retain even when conn- \* is down, and sysfs doesn't support move zombie device,- \* so we should move the device before conn device is destroyed.- \*/-static int \_\_match\_tty(struct device \*dev, void \*data)-{- return !strncmp(dev\_name(dev), "rfcomm", 6);-}- void hci\_conn\_init\_sysfs(struct hci\_conn \*conn) { struct hci\_dev \*hdev = conn->hdev;@@ -73,10 +63,13 @@ void hci\_conn\_del\_sysfs(struct hci\_conn \*conn) return; } + /\* If there are devices using the connection as parent reset it to NULL+ \* before unregistering the device.+ \*/ while (1) { struct device \*dev; - dev = device\_find\_child(&conn->dev, NULL, \_\_match\_tty);+ dev = device\_find\_any\_child(&conn->dev); if (!dev) break; device\_move(dev, NULL, DPM\_ORDER\_DEV\_LAST); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:29:01 +0000



=== Content from git.kernel.org_231e624c_20250114_183600.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-11-01 14:44:10 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:56 +0100 |
| commit | [fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5)) | |
| tree | [d3d089bca09d69aeafb413a444d7856ee4662a0f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5) | |
| parent | [49de4ac804275fadd93b0b58e73e7491ef833bcd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49de4ac804275fadd93b0b58e73e7491ef833bcd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5&id2=49de4ac804275fadd93b0b58e73e7491ef833bcd)) | |
| download | [linux-fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5.tar.gz) | |

Bluetooth: fix use-after-free in device\_for\_each\_child()[ Upstream commit 27aabf27fd014ae037cc179c61b0bee7cff55b3d ]
Syzbot has reported the following KASAN splat:
BUG: KASAN: slab-use-after-free in device\_for\_each\_child+0x18f/0x1a0
Read of size 8 at addr ffff88801f605308 by task kbnepd bnep0/4980
CPU: 0 UID: 0 PID: 4980 Comm: kbnepd bnep0 Not tainted 6.12.0-rc4-00161-gae90f6a6170d #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x100/0x190
? device\_for\_each\_child+0x18f/0x1a0
print\_report+0x13a/0x4cb
? \_\_virt\_addr\_valid+0x5e/0x590
? \_\_phys\_addr+0xc6/0x150
? device\_for\_each\_child+0x18f/0x1a0
kasan\_report+0xda/0x110
? device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_dev\_memalloc\_noio+0x10/0x10
device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_device\_for\_each\_child+0x10/0x10
pm\_runtime\_set\_memalloc\_noio+0xf2/0x180
netdev\_unregister\_kobject+0x1ed/0x270
unregister\_netdevice\_many\_notify+0x123c/0x1d80
? \_\_mutex\_trylock\_common+0xde/0x250
? \_\_pfx\_unregister\_netdevice\_many\_notify+0x10/0x10
? trace\_contention\_end+0xe6/0x140
? \_\_mutex\_lock+0x4e7/0x8f0
? \_\_pfx\_lock\_acquire.part.0+0x10/0x10
? rcu\_is\_watching+0x12/0xc0
? unregister\_netdev+0x12/0x30
unregister\_netdevice\_queue+0x30d/0x3f0
? \_\_pfx\_unregister\_netdevice\_queue+0x10/0x10
? \_\_pfx\_down\_write+0x10/0x10
unregister\_netdev+0x1c/0x30
bnep\_session+0x1fb3/0x2ab0
? \_\_pfx\_bnep\_session+0x10/0x10
? \_\_pfx\_lock\_release+0x10/0x10
? \_\_pfx\_woken\_wake\_function+0x10/0x10
? \_\_kthread\_parkme+0x132/0x200
? \_\_pfx\_bnep\_session+0x10/0x10
? kthread+0x13a/0x370
? \_\_pfx\_bnep\_session+0x10/0x10
kthread+0x2b7/0x370
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x48/0x80
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 4974:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
\_\_kmalloc\_noprof+0x1d1/0x440
hci\_alloc\_dev\_priv+0x1d/0x2820
\_\_vhci\_create\_device+0xef/0x7d0
vhci\_write+0x2c7/0x480
vfs\_write+0x6a0/0xfc0
ksys\_write+0x12f/0x260
do\_syscall\_64+0xc7/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 4979:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x4f/0x70
kfree+0x141/0x490
hci\_release\_dev+0x4d9/0x600
bt\_host\_release+0x6a/0xb0
device\_release+0xa4/0x240
kobject\_put+0x1ec/0x5a0
put\_device+0x1f/0x30
vhci\_release+0x81/0xf0
\_\_fput+0x3f6/0xb30
task\_work\_run+0x151/0x250
do\_exit+0xa79/0x2c30
do\_group\_exit+0xd5/0x2a0
get\_signal+0x1fcd/0x2210
arch\_do\_signal\_or\_restart+0x93/0x780
syscall\_exit\_to\_user\_mode+0x140/0x290
do\_syscall\_64+0xd4/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
In 'hci\_conn\_del\_sysfs()', 'device\_unregister()' may be called when
an underlying (kobject) reference counter is greater than 1. This
means that reparenting (happened when the device is actually freed)
is delayed and, during that delay, parent controller device (hciX)
may be deleted. Since the latter may create a dangling pointer to
freed parent, avoid that scenario by reparenting to NULL explicitly.
Reported-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Tested-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=6cf5652d3df49fae2e3f
Fixes: a85fb91e3d72 ("Bluetooth: Fix double free in hci\_conn\_cleanup")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5)

| -rw-r--r-- | [net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sysfs.c?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 11 deletions

| diff --git a/net/bluetooth/hci\_sysfs.c b/net/bluetooth/hci\_sysfs.cindex 266112c960ee80..1b4d81ffb4b5ef 100644--- a/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=49de4ac804275fadd93b0b58e73e7491ef833bcd)+++ b/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=fb91ce37dc9a37ea23cf32b6d7b667004e93d4c5)@@ -19,16 +19,6 @@ static const struct device\_type bt\_link = { .release = bt\_link\_release, }; -/\*- \* The rfcomm tty device will possibly retain even when conn- \* is down, and sysfs doesn't support move zombie device,- \* so we should move the device before conn device is destroyed.- \*/-static int \_\_match\_tty(struct device \*dev, void \*data)-{- return !strncmp(dev\_name(dev), "rfcomm", 6);-}- void hci\_conn\_init\_sysfs(struct hci\_conn \*conn) { struct hci\_dev \*hdev = conn->hdev;@@ -71,10 +61,13 @@ void hci\_conn\_del\_sysfs(struct hci\_conn \*conn) return; } + /\* If there are devices using the connection as parent reset it to NULL+ \* before unregistering the device.+ \*/ while (1) { struct device \*dev; - dev = device\_find\_child(&conn->dev, NULL, \_\_match\_tty);+ dev = device\_find\_any\_child(&conn->dev); if (!dev) break; device\_move(dev, NULL, DPM\_ORDER\_DEV\_LAST); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:29:42 +0000



=== Content from git.kernel.org_64cb7987_20250114_183558.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=de5a44f351ca7efd9add9851b218f5353e2224b7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de5a44f351ca7efd9add9851b218f5353e2224b7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de5a44f351ca7efd9add9851b218f5353e2224b7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de5a44f351ca7efd9add9851b218f5353e2224b7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-11-01 14:44:10 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:11 +0100 |
| commit | [de5a44f351ca7efd9add9851b218f5353e2224b7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de5a44f351ca7efd9add9851b218f5353e2224b7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=de5a44f351ca7efd9add9851b218f5353e2224b7)) | |
| tree | [9e25543fa90c31eb2c53a6d7c21c250b95024365](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de5a44f351ca7efd9add9851b218f5353e2224b7) | |
| parent | [b754e831a94f82f2593af806741392903f359168](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b754e831a94f82f2593af806741392903f359168) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de5a44f351ca7efd9add9851b218f5353e2224b7&id2=b754e831a94f82f2593af806741392903f359168)) | |
| download | [linux-de5a44f351ca7efd9add9851b218f5353e2224b7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-de5a44f351ca7efd9add9851b218f5353e2224b7.tar.gz) | |

Bluetooth: fix use-after-free in device\_for\_each\_child()[ Upstream commit 27aabf27fd014ae037cc179c61b0bee7cff55b3d ]
Syzbot has reported the following KASAN splat:
BUG: KASAN: slab-use-after-free in device\_for\_each\_child+0x18f/0x1a0
Read of size 8 at addr ffff88801f605308 by task kbnepd bnep0/4980
CPU: 0 UID: 0 PID: 4980 Comm: kbnepd bnep0 Not tainted 6.12.0-rc4-00161-gae90f6a6170d #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x100/0x190
? device\_for\_each\_child+0x18f/0x1a0
print\_report+0x13a/0x4cb
? \_\_virt\_addr\_valid+0x5e/0x590
? \_\_phys\_addr+0xc6/0x150
? device\_for\_each\_child+0x18f/0x1a0
kasan\_report+0xda/0x110
? device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_dev\_memalloc\_noio+0x10/0x10
device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_device\_for\_each\_child+0x10/0x10
pm\_runtime\_set\_memalloc\_noio+0xf2/0x180
netdev\_unregister\_kobject+0x1ed/0x270
unregister\_netdevice\_many\_notify+0x123c/0x1d80
? \_\_mutex\_trylock\_common+0xde/0x250
? \_\_pfx\_unregister\_netdevice\_many\_notify+0x10/0x10
? trace\_contention\_end+0xe6/0x140
? \_\_mutex\_lock+0x4e7/0x8f0
? \_\_pfx\_lock\_acquire.part.0+0x10/0x10
? rcu\_is\_watching+0x12/0xc0
? unregister\_netdev+0x12/0x30
unregister\_netdevice\_queue+0x30d/0x3f0
? \_\_pfx\_unregister\_netdevice\_queue+0x10/0x10
? \_\_pfx\_down\_write+0x10/0x10
unregister\_netdev+0x1c/0x30
bnep\_session+0x1fb3/0x2ab0
? \_\_pfx\_bnep\_session+0x10/0x10
? \_\_pfx\_lock\_release+0x10/0x10
? \_\_pfx\_woken\_wake\_function+0x10/0x10
? \_\_kthread\_parkme+0x132/0x200
? \_\_pfx\_bnep\_session+0x10/0x10
? kthread+0x13a/0x370
? \_\_pfx\_bnep\_session+0x10/0x10
kthread+0x2b7/0x370
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x48/0x80
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 4974:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
\_\_kmalloc\_noprof+0x1d1/0x440
hci\_alloc\_dev\_priv+0x1d/0x2820
\_\_vhci\_create\_device+0xef/0x7d0
vhci\_write+0x2c7/0x480
vfs\_write+0x6a0/0xfc0
ksys\_write+0x12f/0x260
do\_syscall\_64+0xc7/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 4979:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x4f/0x70
kfree+0x141/0x490
hci\_release\_dev+0x4d9/0x600
bt\_host\_release+0x6a/0xb0
device\_release+0xa4/0x240
kobject\_put+0x1ec/0x5a0
put\_device+0x1f/0x30
vhci\_release+0x81/0xf0
\_\_fput+0x3f6/0xb30
task\_work\_run+0x151/0x250
do\_exit+0xa79/0x2c30
do\_group\_exit+0xd5/0x2a0
get\_signal+0x1fcd/0x2210
arch\_do\_signal\_or\_restart+0x93/0x780
syscall\_exit\_to\_user\_mode+0x140/0x290
do\_syscall\_64+0xd4/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
In 'hci\_conn\_del\_sysfs()', 'device\_unregister()' may be called when
an underlying (kobject) reference counter is greater than 1. This
means that reparenting (happened when the device is actually freed)
is delayed and, during that delay, parent controller device (hciX)
may be deleted. Since the latter may create a dangling pointer to
freed parent, avoid that scenario by reparenting to NULL explicitly.
Reported-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Tested-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=6cf5652d3df49fae2e3f
Fixes: a85fb91e3d72 ("Bluetooth: Fix double free in hci\_conn\_cleanup")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de5a44f351ca7efd9add9851b218f5353e2224b7)

| -rw-r--r-- | [net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sysfs.c?id=de5a44f351ca7efd9add9851b218f5353e2224b7) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 11 deletions

| diff --git a/net/bluetooth/hci\_sysfs.c b/net/bluetooth/hci\_sysfs.cindex 367e32fe30eb84..4b54dbbf0729a3 100644--- a/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=b754e831a94f82f2593af806741392903f359168)+++ b/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=de5a44f351ca7efd9add9851b218f5353e2224b7)@@ -21,16 +21,6 @@ static const struct device\_type bt\_link = { .release = bt\_link\_release, }; -/\*- \* The rfcomm tty device will possibly retain even when conn- \* is down, and sysfs doesn't support move zombie device,- \* so we should move the device before conn device is destroyed.- \*/-static int \_\_match\_tty(struct device \*dev, void \*data)-{- return !strncmp(dev\_name(dev), "rfcomm", 6);-}- void hci\_conn\_init\_sysfs(struct hci\_conn \*conn) { struct hci\_dev \*hdev = conn->hdev;@@ -73,10 +63,13 @@ void hci\_conn\_del\_sysfs(struct hci\_conn \*conn) return; } + /\* If there are devices using the connection as parent reset it to NULL+ \* before unregistering the device.+ \*/ while (1) { struct device \*dev; - dev = device\_find\_child(&conn->dev, NULL, \_\_match\_tty);+ dev = device\_find\_any\_child(&conn->dev); if (!dev) break; device\_move(dev, NULL, DPM\_ORDER\_DEV\_LAST); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:29:28 +0000



=== Content from git.kernel.org_de183689_20250114_183554.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-11-01 14:44:10 +0300 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-11-14 15:41:13 -0500 |
| commit | [27aabf27fd014ae037cc179c61b0bee7cff55b3d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d)) | |
| tree | [9157d8a257e5b56c6b4b01fb84856e50731e45a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d) | |
| parent | [acece9d1ca9283154cc4fcc778579059119ccb90](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acece9d1ca9283154cc4fcc778579059119ccb90) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d&id2=acece9d1ca9283154cc4fcc778579059119ccb90)) | |
| download | [linux-27aabf27fd014ae037cc179c61b0bee7cff55b3d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-27aabf27fd014ae037cc179c61b0bee7cff55b3d.tar.gz) | |

Bluetooth: fix use-after-free in device\_for\_each\_child()Syzbot has reported the following KASAN splat:
BUG: KASAN: slab-use-after-free in device\_for\_each\_child+0x18f/0x1a0
Read of size 8 at addr ffff88801f605308 by task kbnepd bnep0/4980
CPU: 0 UID: 0 PID: 4980 Comm: kbnepd bnep0 Not tainted 6.12.0-rc4-00161-gae90f6a6170d #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x100/0x190
? device\_for\_each\_child+0x18f/0x1a0
print\_report+0x13a/0x4cb
? \_\_virt\_addr\_valid+0x5e/0x590
? \_\_phys\_addr+0xc6/0x150
? device\_for\_each\_child+0x18f/0x1a0
kasan\_report+0xda/0x110
? device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_dev\_memalloc\_noio+0x10/0x10
device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_device\_for\_each\_child+0x10/0x10
pm\_runtime\_set\_memalloc\_noio+0xf2/0x180
netdev\_unregister\_kobject+0x1ed/0x270
unregister\_netdevice\_many\_notify+0x123c/0x1d80
? \_\_mutex\_trylock\_common+0xde/0x250
? \_\_pfx\_unregister\_netdevice\_many\_notify+0x10/0x10
? trace\_contention\_end+0xe6/0x140
? \_\_mutex\_lock+0x4e7/0x8f0
? \_\_pfx\_lock\_acquire.part.0+0x10/0x10
? rcu\_is\_watching+0x12/0xc0
? unregister\_netdev+0x12/0x30
unregister\_netdevice\_queue+0x30d/0x3f0
? \_\_pfx\_unregister\_netdevice\_queue+0x10/0x10
? \_\_pfx\_down\_write+0x10/0x10
unregister\_netdev+0x1c/0x30
bnep\_session+0x1fb3/0x2ab0
? \_\_pfx\_bnep\_session+0x10/0x10
? \_\_pfx\_lock\_release+0x10/0x10
? \_\_pfx\_woken\_wake\_function+0x10/0x10
? \_\_kthread\_parkme+0x132/0x200
? \_\_pfx\_bnep\_session+0x10/0x10
? kthread+0x13a/0x370
? \_\_pfx\_bnep\_session+0x10/0x10
kthread+0x2b7/0x370
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x48/0x80
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 4974:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
\_\_kmalloc\_noprof+0x1d1/0x440
hci\_alloc\_dev\_priv+0x1d/0x2820
\_\_vhci\_create\_device+0xef/0x7d0
vhci\_write+0x2c7/0x480
vfs\_write+0x6a0/0xfc0
ksys\_write+0x12f/0x260
do\_syscall\_64+0xc7/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 4979:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x4f/0x70
kfree+0x141/0x490
hci\_release\_dev+0x4d9/0x600
bt\_host\_release+0x6a/0xb0
device\_release+0xa4/0x240
kobject\_put+0x1ec/0x5a0
put\_device+0x1f/0x30
vhci\_release+0x81/0xf0
\_\_fput+0x3f6/0xb30
task\_work\_run+0x151/0x250
do\_exit+0xa79/0x2c30
do\_group\_exit+0xd5/0x2a0
get\_signal+0x1fcd/0x2210
arch\_do\_signal\_or\_restart+0x93/0x780
syscall\_exit\_to\_user\_mode+0x140/0x290
do\_syscall\_64+0xd4/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
In 'hci\_conn\_del\_sysfs()', 'device\_unregister()' may be called when
an underlying (kobject) reference counter is greater than 1. This
means that reparenting (happened when the device is actually freed)
is delayed and, during that delay, parent controller device (hciX)
may be deleted. Since the latter may create a dangling pointer to
freed parent, avoid that scenario by reparenting to NULL explicitly.
Reported-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Tested-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=6cf5652d3df49fae2e3f
Fixes: a85fb91e3d72 ("Bluetooth: Fix double free in hci\_conn\_cleanup")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d)

| -rw-r--r-- | [net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sysfs.c?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 11 deletions

| diff --git a/net/bluetooth/hci\_sysfs.c b/net/bluetooth/hci\_sysfs.cindex 367e32fe30eb84..4b54dbbf0729a3 100644--- a/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=acece9d1ca9283154cc4fcc778579059119ccb90)+++ b/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=27aabf27fd014ae037cc179c61b0bee7cff55b3d)@@ -21,16 +21,6 @@ static const struct device\_type bt\_link = { .release = bt\_link\_release, }; -/\*- \* The rfcomm tty device will possibly retain even when conn- \* is down, and sysfs doesn't support move zombie device,- \* so we should move the device before conn device is destroyed.- \*/-static int \_\_match\_tty(struct device \*dev, void \*data)-{- return !strncmp(dev\_name(dev), "rfcomm", 6);-}- void hci\_conn\_init\_sysfs(struct hci\_conn \*conn) { struct hci\_dev \*hdev = conn->hdev;@@ -73,10 +63,13 @@ void hci\_conn\_del\_sysfs(struct hci\_conn \*conn) return; } + /\* If there are devices using the connection as parent reset it to NULL+ \* before unregistering the device.+ \*/ while (1) { struct device \*dev; - dev = device\_find\_child(&conn->dev, NULL, \_\_match\_tty);+ dev = device\_find\_any\_child(&conn->dev); if (!dev) break; device\_move(dev, NULL, DPM\_ORDER\_DEV\_LAST); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:28:34 +0000



=== Content from git.kernel.org_9c8be58f_20250114_183557.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a9584c897d1cba6265c78010bbb45ca5722c88bc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a9584c897d1cba6265c78010bbb45ca5722c88bc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9584c897d1cba6265c78010bbb45ca5722c88bc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9584c897d1cba6265c78010bbb45ca5722c88bc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-11-01 14:44:10 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:59 +0100 |
| commit | [a9584c897d1cba6265c78010bbb45ca5722c88bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9584c897d1cba6265c78010bbb45ca5722c88bc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a9584c897d1cba6265c78010bbb45ca5722c88bc)) | |
| tree | [054bfda2449dfd6c845e6af3843ca1ef7df70b62](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a9584c897d1cba6265c78010bbb45ca5722c88bc) | |
| parent | [86bd0ba393a307c85396bb7309fb29f0d288ace6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86bd0ba393a307c85396bb7309fb29f0d288ace6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9584c897d1cba6265c78010bbb45ca5722c88bc&id2=86bd0ba393a307c85396bb7309fb29f0d288ace6)) | |
| download | [linux-a9584c897d1cba6265c78010bbb45ca5722c88bc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a9584c897d1cba6265c78010bbb45ca5722c88bc.tar.gz) | |

Bluetooth: fix use-after-free in device\_for\_each\_child()[ Upstream commit 27aabf27fd014ae037cc179c61b0bee7cff55b3d ]
Syzbot has reported the following KASAN splat:
BUG: KASAN: slab-use-after-free in device\_for\_each\_child+0x18f/0x1a0
Read of size 8 at addr ffff88801f605308 by task kbnepd bnep0/4980
CPU: 0 UID: 0 PID: 4980 Comm: kbnepd bnep0 Not tainted 6.12.0-rc4-00161-gae90f6a6170d #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x100/0x190
? device\_for\_each\_child+0x18f/0x1a0
print\_report+0x13a/0x4cb
? \_\_virt\_addr\_valid+0x5e/0x590
? \_\_phys\_addr+0xc6/0x150
? device\_for\_each\_child+0x18f/0x1a0
kasan\_report+0xda/0x110
? device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_dev\_memalloc\_noio+0x10/0x10
device\_for\_each\_child+0x18f/0x1a0
? \_\_pfx\_device\_for\_each\_child+0x10/0x10
pm\_runtime\_set\_memalloc\_noio+0xf2/0x180
netdev\_unregister\_kobject+0x1ed/0x270
unregister\_netdevice\_many\_notify+0x123c/0x1d80
? \_\_mutex\_trylock\_common+0xde/0x250
? \_\_pfx\_unregister\_netdevice\_many\_notify+0x10/0x10
? trace\_contention\_end+0xe6/0x140
? \_\_mutex\_lock+0x4e7/0x8f0
? \_\_pfx\_lock\_acquire.part.0+0x10/0x10
? rcu\_is\_watching+0x12/0xc0
? unregister\_netdev+0x12/0x30
unregister\_netdevice\_queue+0x30d/0x3f0
? \_\_pfx\_unregister\_netdevice\_queue+0x10/0x10
? \_\_pfx\_down\_write+0x10/0x10
unregister\_netdev+0x1c/0x30
bnep\_session+0x1fb3/0x2ab0
? \_\_pfx\_bnep\_session+0x10/0x10
? \_\_pfx\_lock\_release+0x10/0x10
? \_\_pfx\_woken\_wake\_function+0x10/0x10
? \_\_kthread\_parkme+0x132/0x200
? \_\_pfx\_bnep\_session+0x10/0x10
? kthread+0x13a/0x370
? \_\_pfx\_bnep\_session+0x10/0x10
kthread+0x2b7/0x370
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x48/0x80
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 4974:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
\_\_kmalloc\_noprof+0x1d1/0x440
hci\_alloc\_dev\_priv+0x1d/0x2820
\_\_vhci\_create\_device+0xef/0x7d0
vhci\_write+0x2c7/0x480
vfs\_write+0x6a0/0xfc0
ksys\_write+0x12f/0x260
do\_syscall\_64+0xc7/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 4979:
kasan\_save\_stack+0x30/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x4f/0x70
kfree+0x141/0x490
hci\_release\_dev+0x4d9/0x600
bt\_host\_release+0x6a/0xb0
device\_release+0xa4/0x240
kobject\_put+0x1ec/0x5a0
put\_device+0x1f/0x30
vhci\_release+0x81/0xf0
\_\_fput+0x3f6/0xb30
task\_work\_run+0x151/0x250
do\_exit+0xa79/0x2c30
do\_group\_exit+0xd5/0x2a0
get\_signal+0x1fcd/0x2210
arch\_do\_signal\_or\_restart+0x93/0x780
syscall\_exit\_to\_user\_mode+0x140/0x290
do\_syscall\_64+0xd4/0x250
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
In 'hci\_conn\_del\_sysfs()', 'device\_unregister()' may be called when
an underlying (kobject) reference counter is greater than 1. This
means that reparenting (happened when the device is actually freed)
is delayed and, during that delay, parent controller device (hciX)
may be deleted. Since the latter may create a dangling pointer to
freed parent, avoid that scenario by reparenting to NULL explicitly.
Reported-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Tested-by: syzbot+6cf5652d3df49fae2e3f@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=6cf5652d3df49fae2e3f
Fixes: a85fb91e3d72 ("Bluetooth: Fix double free in hci\_conn\_cleanup")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9584c897d1cba6265c78010bbb45ca5722c88bc)

| -rw-r--r-- | [net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sysfs.c?id=a9584c897d1cba6265c78010bbb45ca5722c88bc) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 11 deletions

| diff --git a/net/bluetooth/hci\_sysfs.c b/net/bluetooth/hci\_sysfs.cindex 633b82d5427283..cc7d4a8ed8ce24 100644--- a/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=86bd0ba393a307c85396bb7309fb29f0d288ace6)+++ b/[net/bluetooth/hci\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sysfs.c?id=a9584c897d1cba6265c78010bbb45ca5722c88bc)@@ -19,16 +19,6 @@ static const struct device\_type bt\_link = { .release = bt\_link\_release, }; -/\*- \* The rfcomm tty device will possibly retain even when conn- \* is down, and sysfs doesn't support move zombie device,- \* so we should move the device before conn device is destroyed.- \*/-static int \_\_match\_tty(struct device \*dev, void \*data)-{- return !strncmp(dev\_name(dev), "rfcomm", 6);-}- void hci\_conn\_init\_sysfs(struct hci\_conn \*conn) { struct hci\_dev \*hdev = conn->hdev;@@ -71,10 +61,13 @@ void hci\_conn\_del\_sysfs(struct hci\_conn \*conn) return; } + /\* If there are devices using the connection as parent reset it to NULL+ \* before unregistering the device.+ \*/ while (1) { struct device \*dev; - dev = device\_find\_child(&conn->dev, NULL, \_\_match\_tty);+ dev = device\_find\_any\_child(&conn->dev); if (!dev) break; device\_move(dev, NULL, DPM\_ORDER\_DEV\_LAST); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:34:35 +0000


