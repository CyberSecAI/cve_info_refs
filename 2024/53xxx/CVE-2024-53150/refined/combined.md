=== Content from git.kernel.org_f86c990e_20250114_221345.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ea0fa76f61cf8e932d1d26e6193513230816e11d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea0fa76f61cf8e932d1d26e6193513230816e11d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea0fa76f61cf8e932d1d26e6193513230816e11d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea0fa76f61cf8e932d1d26e6193513230816e11d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-25 15:46:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:06 +0100 |
| commit | [ea0fa76f61cf8e932d1d26e6193513230816e11d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea0fa76f61cf8e932d1d26e6193513230816e11d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ea0fa76f61cf8e932d1d26e6193513230816e11d)) | |
| tree | [8a199aaac29873d913849c353fb0a051e888337c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea0fa76f61cf8e932d1d26e6193513230816e11d) | |
| parent | [379d3b9799d9da953391e973b934764f01e03960](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=379d3b9799d9da953391e973b934764f01e03960) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea0fa76f61cf8e932d1d26e6193513230816e11d&id2=379d3b9799d9da953391e973b934764f01e03960)) | |
| download | [linux-ea0fa76f61cf8e932d1d26e6193513230816e11d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ea0fa76f61cf8e932d1d26e6193513230816e11d.tar.gz) | |

ALSA: usb-audio: Fix out of bounds reads when finding clock sourcescommit a3dd4d63eeb452cfb064a13862fb376ab108f6a6 upstream.
The current USB-audio driver code doesn't check bLength of each
descriptor at traversing for clock descriptors. That is, when a
device provides a bogus descriptor with a shorter bLength, the driver
might hit out-of-bounds reads.
For addressing it, this patch adds sanity checks to the validator
functions for the clock descriptor traversal. When the descriptor
length is shorter than expected, it's skipped in the loop.
For the clock source and clock multiplier descriptors, we can just
check bLength against the sizeof() of each descriptor type.
OTOH, the clock selector descriptor of UAC2 and UAC3 has an array
of bNrInPins elements and two more fields at its tail, hence those
have to be checked in addition to the sizeof() check.
Reported-by: Benoît Sevens <bsevens@google.com>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/20241121140613.3651-1-bsevens@google.com](https://lore.kernel.org/20241121140613.3651-1-bsevens%40google.com)
Link: [https://patch.msgid.link/20241125144629.20757-1-tiwai@suse.de](https://patch.msgid.link/20241125144629.20757-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea0fa76f61cf8e932d1d26e6193513230816e11d)

| -rw-r--r-- | [sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/clock.c?id=ea0fa76f61cf8e932d1d26e6193513230816e11d) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 1 deletions

| diff --git a/sound/usb/clock.c b/sound/usb/clock.cindex 60fcb872a80b6c..5c3edb69b373d8 100644--- a/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=379d3b9799d9da953391e973b934764f01e03960)+++ b/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=ea0fa76f61cf8e932d1d26e6193513230816e11d)@@ -36,6 +36,12 @@ union uac23\_clock\_multiplier\_desc { struct uac\_clock\_multiplier\_descriptor v3; }; +/\* check whether the descriptor bLength has the minimal length \*/+#define DESC\_LENGTH\_CHECK(p, proto) \+ ((proto) == UAC\_VERSION\_3 ? \+ ((p)->v3.bLength >= sizeof((p)->v3)) : \+ ((p)->v2.bLength >= sizeof((p)->v2)))+ #define GET\_VAL(p, proto, field) \ ((proto) == UAC\_VERSION\_3 ? (p)->v3.field : (p)->v2.field) @@ -58,6 +64,8 @@ static bool validate\_clock\_source(void \*p, int id, int proto) { union uac23\_clock\_source\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } @@ -65,13 +73,27 @@ static bool validate\_clock\_selector(void \*p, int id, int proto) { union uac23\_clock\_selector\_desc \*cs = p; - return GET\_VAL(cs, proto, bClockID) == id;+ if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false;+ if (GET\_VAL(cs, proto, bClockID) != id)+ return false;+ /\* additional length check for baCSourceID array (in bNrInPins size)+ \* and two more fields (which sizes depend on the protocol)+ \*/+ if (proto == UAC\_VERSION\_3)+ return cs->v3.bLength >= sizeof(cs->v3) + cs->v3.bNrInPins ++ 4 /\* bmControls \*/ + 2 /\* wCSelectorDescrStr \*/;+ else+ return cs->v2.bLength >= sizeof(cs->v2) + cs->v2.bNrInPins ++ 1 /\* bmControls \*/ + 1 /\* iClockSelector \*/; }  static bool validate\_clock\_multiplier(void \*p, int id, int proto) { union uac23\_clock\_multiplier\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:12:22 +0000



=== Content from git.kernel.org_2523c5eb_20250114_221340.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=74cb86e1006c5437b1d90084d22018da30fddc77)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=74cb86e1006c5437b1d90084d22018da30fddc77)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74cb86e1006c5437b1d90084d22018da30fddc77)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74cb86e1006c5437b1d90084d22018da30fddc77)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-25 15:46:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:39 +0100 |
| commit | [74cb86e1006c5437b1d90084d22018da30fddc77](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74cb86e1006c5437b1d90084d22018da30fddc77) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=74cb86e1006c5437b1d90084d22018da30fddc77)) | |
| tree | [34137132e22d9388be7e73f23089486e0c455728](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=74cb86e1006c5437b1d90084d22018da30fddc77) | |
| parent | [804b96f8d0a02fa10b92f28b2e042f9128ed3ffc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=804b96f8d0a02fa10b92f28b2e042f9128ed3ffc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74cb86e1006c5437b1d90084d22018da30fddc77&id2=804b96f8d0a02fa10b92f28b2e042f9128ed3ffc)) | |
| download | [linux-74cb86e1006c5437b1d90084d22018da30fddc77.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-74cb86e1006c5437b1d90084d22018da30fddc77.tar.gz) | |

ALSA: usb-audio: Fix out of bounds reads when finding clock sourcescommit a3dd4d63eeb452cfb064a13862fb376ab108f6a6 upstream.
The current USB-audio driver code doesn't check bLength of each
descriptor at traversing for clock descriptors. That is, when a
device provides a bogus descriptor with a shorter bLength, the driver
might hit out-of-bounds reads.
For addressing it, this patch adds sanity checks to the validator
functions for the clock descriptor traversal. When the descriptor
length is shorter than expected, it's skipped in the loop.
For the clock source and clock multiplier descriptors, we can just
check bLength against the sizeof() of each descriptor type.
OTOH, the clock selector descriptor of UAC2 and UAC3 has an array
of bNrInPins elements and two more fields at its tail, hence those
have to be checked in addition to the sizeof() check.
Reported-by: Benoît Sevens <bsevens@google.com>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/20241121140613.3651-1-bsevens@google.com](https://lore.kernel.org/20241121140613.3651-1-bsevens%40google.com)
Link: [https://patch.msgid.link/20241125144629.20757-1-tiwai@suse.de](https://patch.msgid.link/20241125144629.20757-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74cb86e1006c5437b1d90084d22018da30fddc77)

| -rw-r--r-- | [sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/clock.c?id=74cb86e1006c5437b1d90084d22018da30fddc77) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 1 deletions

| diff --git a/sound/usb/clock.c b/sound/usb/clock.cindex a676ad093d1897..f0f1e445cc5676 100644--- a/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=804b96f8d0a02fa10b92f28b2e042f9128ed3ffc)+++ b/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=74cb86e1006c5437b1d90084d22018da30fddc77)@@ -36,6 +36,12 @@ union uac23\_clock\_multiplier\_desc { struct uac\_clock\_multiplier\_descriptor v3; }; +/\* check whether the descriptor bLength has the minimal length \*/+#define DESC\_LENGTH\_CHECK(p, proto) \+ ((proto) == UAC\_VERSION\_3 ? \+ ((p)->v3.bLength >= sizeof((p)->v3)) : \+ ((p)->v2.bLength >= sizeof((p)->v2)))+ #define GET\_VAL(p, proto, field) \ ((proto) == UAC\_VERSION\_3 ? (p)->v3.field : (p)->v2.field) @@ -58,6 +64,8 @@ static bool validate\_clock\_source(void \*p, int id, int proto) { union uac23\_clock\_source\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } @@ -65,13 +73,27 @@ static bool validate\_clock\_selector(void \*p, int id, int proto) { union uac23\_clock\_selector\_desc \*cs = p; - return GET\_VAL(cs, proto, bClockID) == id;+ if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false;+ if (GET\_VAL(cs, proto, bClockID) != id)+ return false;+ /\* additional length check for baCSourceID array (in bNrInPins size)+ \* and two more fields (which sizes depend on the protocol)+ \*/+ if (proto == UAC\_VERSION\_3)+ return cs->v3.bLength >= sizeof(cs->v3) + cs->v3.bNrInPins ++ 4 /\* bmControls \*/ + 2 /\* wCSelectorDescrStr \*/;+ else+ return cs->v2.bLength >= sizeof(cs->v2) + cs->v2.bNrInPins ++ 1 /\* bmControls \*/ + 1 /\* iClockSelector \*/; }  static bool validate\_clock\_multiplier(void \*p, int id, int proto) { union uac23\_clock\_multiplier\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:12:17 +0000



=== Content from git.kernel.org_dfa58c92_20250114_221343.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-25 15:46:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:11 +0100 |
| commit | [ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9)) | |
| tree | [d9a840e70048bf72db7146c34896b367bee617f3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9) | |
| parent | [e8823e6ff313465910edea07581627d85e68d9fd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8823e6ff313465910edea07581627d85e68d9fd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9&id2=e8823e6ff313465910edea07581627d85e68d9fd)) | |
| download | [linux-ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9.tar.gz) | |

ALSA: usb-audio: Fix out of bounds reads when finding clock sourcescommit a3dd4d63eeb452cfb064a13862fb376ab108f6a6 upstream.
The current USB-audio driver code doesn't check bLength of each
descriptor at traversing for clock descriptors. That is, when a
device provides a bogus descriptor with a shorter bLength, the driver
might hit out-of-bounds reads.
For addressing it, this patch adds sanity checks to the validator
functions for the clock descriptor traversal. When the descriptor
length is shorter than expected, it's skipped in the loop.
For the clock source and clock multiplier descriptors, we can just
check bLength against the sizeof() of each descriptor type.
OTOH, the clock selector descriptor of UAC2 and UAC3 has an array
of bNrInPins elements and two more fields at its tail, hence those
have to be checked in addition to the sizeof() check.
Reported-by: Benoît Sevens <bsevens@google.com>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/20241121140613.3651-1-bsevens@google.com](https://lore.kernel.org/20241121140613.3651-1-bsevens%40google.com)
Link: [https://patch.msgid.link/20241125144629.20757-1-tiwai@suse.de](https://patch.msgid.link/20241125144629.20757-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9)

| -rw-r--r-- | [sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/clock.c?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 1 deletions

| diff --git a/sound/usb/clock.c b/sound/usb/clock.cindex 970e14ff54d145..5cc6ac3b0dd2ae 100644--- a/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=e8823e6ff313465910edea07581627d85e68d9fd)+++ b/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=ab011f7439d9bbfd34fd3b9cef4b2d6d952c9bb9)@@ -36,6 +36,12 @@ union uac23\_clock\_multiplier\_desc { struct uac\_clock\_multiplier\_descriptor v3; }; +/\* check whether the descriptor bLength has the minimal length \*/+#define DESC\_LENGTH\_CHECK(p, proto) \+ ((proto) == UAC\_VERSION\_3 ? \+ ((p)->v3.bLength >= sizeof((p)->v3)) : \+ ((p)->v2.bLength >= sizeof((p)->v2)))+ #define GET\_VAL(p, proto, field) \ ((proto) == UAC\_VERSION\_3 ? (p)->v3.field : (p)->v2.field) @@ -58,6 +64,8 @@ static bool validate\_clock\_source(void \*p, int id, int proto) { union uac23\_clock\_source\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } @@ -65,13 +73,27 @@ static bool validate\_clock\_selector(void \*p, int id, int proto) { union uac23\_clock\_selector\_desc \*cs = p; - return GET\_VAL(cs, proto, bClockID) == id;+ if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false;+ if (GET\_VAL(cs, proto, bClockID) != id)+ return false;+ /\* additional length check for baCSourceID array (in bNrInPins size)+ \* and two more fields (which sizes depend on the protocol)+ \*/+ if (proto == UAC\_VERSION\_3)+ return cs->v3.bLength >= sizeof(cs->v3) + cs->v3.bNrInPins ++ 4 /\* bmControls \*/ + 2 /\* wCSelectorDescrStr \*/;+ else+ return cs->v2.bLength >= sizeof(cs->v2) + cs->v2.bNrInPins ++ 1 /\* bmControls \*/ + 1 /\* iClockSelector \*/; }  static bool validate\_clock\_multiplier(void \*p, int id, int proto) { union uac23\_clock\_multiplier\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:12:20 +0000



=== Content from git.kernel.org_7aac52ae_20250114_221339.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-25 15:46:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:35 +0100 |
| commit | [45a92cbc88e4013bfed7fd2ccab3ade45f8e896b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b)) | |
| tree | [3d3b85aa763f510d7f0d2ed98265d1531b4379f8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b) | |
| parent | [3fc53e46fdc85989aaa573755595afb827dbaf4f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3fc53e46fdc85989aaa573755595afb827dbaf4f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b&id2=3fc53e46fdc85989aaa573755595afb827dbaf4f)) | |
| download | [linux-45a92cbc88e4013bfed7fd2ccab3ade45f8e896b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-45a92cbc88e4013bfed7fd2ccab3ade45f8e896b.tar.gz) | |

ALSA: usb-audio: Fix out of bounds reads when finding clock sourcescommit a3dd4d63eeb452cfb064a13862fb376ab108f6a6 upstream.
The current USB-audio driver code doesn't check bLength of each
descriptor at traversing for clock descriptors. That is, when a
device provides a bogus descriptor with a shorter bLength, the driver
might hit out-of-bounds reads.
For addressing it, this patch adds sanity checks to the validator
functions for the clock descriptor traversal. When the descriptor
length is shorter than expected, it's skipped in the loop.
For the clock source and clock multiplier descriptors, we can just
check bLength against the sizeof() of each descriptor type.
OTOH, the clock selector descriptor of UAC2 and UAC3 has an array
of bNrInPins elements and two more fields at its tail, hence those
have to be checked in addition to the sizeof() check.
Reported-by: Benoît Sevens <bsevens@google.com>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/20241121140613.3651-1-bsevens@google.com](https://lore.kernel.org/20241121140613.3651-1-bsevens%40google.com)
Link: [https://patch.msgid.link/20241125144629.20757-1-tiwai@suse.de](https://patch.msgid.link/20241125144629.20757-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Benoît Sevens <bsevens@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b)

| -rw-r--r-- | [sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/clock.c?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 2 deletions

| diff --git a/sound/usb/clock.c b/sound/usb/clock.cindex 514d18a3e07a60..197a6b7d8ad6f9 100644--- a/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=3fc53e46fdc85989aaa573755595afb827dbaf4f)+++ b/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=45a92cbc88e4013bfed7fd2ccab3ade45f8e896b)@@ -21,6 +21,10 @@ #include "clock.h" #include "quirks.h" +/\* check whether the descriptor bLength has the minimal length \*/+#define DESC\_LENGTH\_CHECK(p) \+ (p->bLength >= sizeof(\*p))+ static void \*find\_uac\_clock\_desc(struct usb\_host\_interface \*iface, int id, bool (\*validator)(void \*, int), u8 type) {@@ -38,36 +42,60 @@ static void \*find\_uac\_clock\_desc(struct usb\_host\_interface \*iface, int id, static bool validate\_clock\_source\_v2(void \*p, int id) { struct uac\_clock\_source\_descriptor \*cs = p;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false; return cs->bClockID == id; }  static bool validate\_clock\_source\_v3(void \*p, int id) { struct uac3\_clock\_source\_descriptor \*cs = p;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false; return cs->bClockID == id; }  static bool validate\_clock\_selector\_v2(void \*p, int id) { struct uac\_clock\_selector\_descriptor \*cs = p;- return cs->bClockID == id;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false;+ if (cs->bClockID != id)+ return false;+ /\* additional length check for baCSourceID array (in bNrInPins size)+ \* and two more fields (which sizes depend on the protocol)+ \*/+ return cs->bLength >= sizeof(\*cs) + cs->bNrInPins ++ 1 /\* bmControls \*/ + 1 /\* iClockSelector \*/; }  static bool validate\_clock\_selector\_v3(void \*p, int id) { struct uac3\_clock\_selector\_descriptor \*cs = p;- return cs->bClockID == id;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false;+ if (cs->bClockID != id)+ return false;+ /\* additional length check for baCSourceID array (in bNrInPins size)+ \* and two more fields (which sizes depend on the protocol)+ \*/+ return cs->bLength >= sizeof(\*cs) + cs->bNrInPins ++ 4 /\* bmControls \*/ + 2 /\* wCSelectorDescrStr \*/; }  static bool validate\_clock\_multiplier\_v2(void \*p, int id) { struct uac\_clock\_multiplier\_descriptor \*cs = p;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false; return cs->bClockID == id; }  static bool validate\_clock\_multiplier\_v3(void \*p, int id) { struct uac3\_clock\_multiplier\_descriptor \*cs = p;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false; return cs->bClockID == id; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:12:16 +0000



=== Content from git.kernel.org_46dcde8b_20250114_221341.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-25 15:46:16 +0100 |
| --- | --- | --- |
| committer | Takashi Iwai <tiwai@suse.de> | 2024-11-25 15:48:22 +0100 |
| commit | [a3dd4d63eeb452cfb064a13862fb376ab108f6a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6)) | |
| tree | [fb5f1a2441713467f747aecf214f2e3419ec904b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6) | |
| parent | [20c0c49720dc4e205d4c1d64add56a5043c5ec5f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20c0c49720dc4e205d4c1d64add56a5043c5ec5f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6&id2=20c0c49720dc4e205d4c1d64add56a5043c5ec5f)) | |
| download | [linux-a3dd4d63eeb452cfb064a13862fb376ab108f6a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a3dd4d63eeb452cfb064a13862fb376ab108f6a6.tar.gz) | |

ALSA: usb-audio: Fix out of bounds reads when finding clock sourcesThe current USB-audio driver code doesn't check bLength of each
descriptor at traversing for clock descriptors. That is, when a
device provides a bogus descriptor with a shorter bLength, the driver
might hit out-of-bounds reads.
For addressing it, this patch adds sanity checks to the validator
functions for the clock descriptor traversal. When the descriptor
length is shorter than expected, it's skipped in the loop.
For the clock source and clock multiplier descriptors, we can just
check bLength against the sizeof() of each descriptor type.
OTOH, the clock selector descriptor of UAC2 and UAC3 has an array
of bNrInPins elements and two more fields at its tail, hence those
have to be checked in addition to the sizeof() check.
Reported-by: Benoît Sevens <bsevens@google.com>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/20241121140613.3651-1-bsevens@google.com](https://lore.kernel.org/20241121140613.3651-1-bsevens%40google.com)
Link: [https://patch.msgid.link/20241125144629.20757-1-tiwai@suse.de](https://patch.msgid.link/20241125144629.20757-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6)

| -rw-r--r-- | [sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/clock.c?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 1 deletions

| diff --git a/sound/usb/clock.c b/sound/usb/clock.cindex 8f85200292f3ff..842ba5b801eae8 100644--- a/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=20c0c49720dc4e205d4c1d64add56a5043c5ec5f)+++ b/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=a3dd4d63eeb452cfb064a13862fb376ab108f6a6)@@ -36,6 +36,12 @@ union uac23\_clock\_multiplier\_desc { struct uac\_clock\_multiplier\_descriptor v3; }; +/\* check whether the descriptor bLength has the minimal length \*/+#define DESC\_LENGTH\_CHECK(p, proto) \+ ((proto) == UAC\_VERSION\_3 ? \+ ((p)->v3.bLength >= sizeof((p)->v3)) : \+ ((p)->v2.bLength >= sizeof((p)->v2)))+ #define GET\_VAL(p, proto, field) \ ((proto) == UAC\_VERSION\_3 ? (p)->v3.field : (p)->v2.field) @@ -58,6 +64,8 @@ static bool validate\_clock\_source(void \*p, int id, int proto) { union uac23\_clock\_source\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } @@ -65,13 +73,27 @@ static bool validate\_clock\_selector(void \*p, int id, int proto) { union uac23\_clock\_selector\_desc \*cs = p; - return GET\_VAL(cs, proto, bClockID) == id;+ if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false;+ if (GET\_VAL(cs, proto, bClockID) != id)+ return false;+ /\* additional length check for baCSourceID array (in bNrInPins size)+ \* and two more fields (which sizes depend on the protocol)+ \*/+ if (proto == UAC\_VERSION\_3)+ return cs->v3.bLength >= sizeof(cs->v3) + cs->v3.bNrInPins ++ 4 /\* bmControls \*/ + 2 /\* wCSelectorDescrStr \*/;+ else+ return cs->v2.bLength >= sizeof(cs->v2) + cs->v2.bNrInPins ++ 1 /\* bmControls \*/ + 1 /\* iClockSelector \*/; }  static bool validate\_clock\_multiplier(void \*p, int id, int proto) { union uac23\_clock\_multiplier\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:12:18 +0000



=== Content from git.kernel.org_cb5ee5ac_20250114_221342.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a632bdcb359fd8145e86486ff8612da98e239acd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a632bdcb359fd8145e86486ff8612da98e239acd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a632bdcb359fd8145e86486ff8612da98e239acd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a632bdcb359fd8145e86486ff8612da98e239acd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-25 15:46:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:56 +0100 |
| commit | [a632bdcb359fd8145e86486ff8612da98e239acd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a632bdcb359fd8145e86486ff8612da98e239acd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a632bdcb359fd8145e86486ff8612da98e239acd)) | |
| tree | [7adc7d366efed930242d6426d5d64c29013e787f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a632bdcb359fd8145e86486ff8612da98e239acd) | |
| parent | [4fed24bf454c762896cedaa98b7727107102282f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4fed24bf454c762896cedaa98b7727107102282f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a632bdcb359fd8145e86486ff8612da98e239acd&id2=4fed24bf454c762896cedaa98b7727107102282f)) | |
| download | [linux-a632bdcb359fd8145e86486ff8612da98e239acd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a632bdcb359fd8145e86486ff8612da98e239acd.tar.gz) | |

ALSA: usb-audio: Fix out of bounds reads when finding clock sourcescommit a3dd4d63eeb452cfb064a13862fb376ab108f6a6 upstream.
The current USB-audio driver code doesn't check bLength of each
descriptor at traversing for clock descriptors. That is, when a
device provides a bogus descriptor with a shorter bLength, the driver
might hit out-of-bounds reads.
For addressing it, this patch adds sanity checks to the validator
functions for the clock descriptor traversal. When the descriptor
length is shorter than expected, it's skipped in the loop.
For the clock source and clock multiplier descriptors, we can just
check bLength against the sizeof() of each descriptor type.
OTOH, the clock selector descriptor of UAC2 and UAC3 has an array
of bNrInPins elements and two more fields at its tail, hence those
have to be checked in addition to the sizeof() check.
Reported-by: Benoît Sevens <bsevens@google.com>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/20241121140613.3651-1-bsevens@google.com](https://lore.kernel.org/20241121140613.3651-1-bsevens%40google.com)
Link: [https://patch.msgid.link/20241125144629.20757-1-tiwai@suse.de](https://patch.msgid.link/20241125144629.20757-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Benoît Sevens <bsevens@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a632bdcb359fd8145e86486ff8612da98e239acd)

| -rw-r--r-- | [sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/clock.c?id=a632bdcb359fd8145e86486ff8612da98e239acd) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 2 deletions

| diff --git a/sound/usb/clock.c b/sound/usb/clock.cindex 3d1c0ec117536a..58902275c8152b 100644--- a/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=4fed24bf454c762896cedaa98b7727107102282f)+++ b/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=a632bdcb359fd8145e86486ff8612da98e239acd)@@ -21,6 +21,10 @@ #include "clock.h" #include "quirks.h" +/\* check whether the descriptor bLength has the minimal length \*/+#define DESC\_LENGTH\_CHECK(p) \+ (p->bLength >= sizeof(\*p))+ static void \*find\_uac\_clock\_desc(struct usb\_host\_interface \*iface, int id, bool (\*validator)(void \*, int), u8 type) {@@ -38,36 +42,60 @@ static void \*find\_uac\_clock\_desc(struct usb\_host\_interface \*iface, int id, static bool validate\_clock\_source\_v2(void \*p, int id) { struct uac\_clock\_source\_descriptor \*cs = p;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false; return cs->bClockID == id; }  static bool validate\_clock\_source\_v3(void \*p, int id) { struct uac3\_clock\_source\_descriptor \*cs = p;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false; return cs->bClockID == id; }  static bool validate\_clock\_selector\_v2(void \*p, int id) { struct uac\_clock\_selector\_descriptor \*cs = p;- return cs->bClockID == id;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false;+ if (cs->bClockID != id)+ return false;+ /\* additional length check for baCSourceID array (in bNrInPins size)+ \* and two more fields (which sizes depend on the protocol)+ \*/+ return cs->bLength >= sizeof(\*cs) + cs->bNrInPins ++ 1 /\* bmControls \*/ + 1 /\* iClockSelector \*/; }  static bool validate\_clock\_selector\_v3(void \*p, int id) { struct uac3\_clock\_selector\_descriptor \*cs = p;- return cs->bClockID == id;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false;+ if (cs->bClockID != id)+ return false;+ /\* additional length check for baCSourceID array (in bNrInPins size)+ \* and two more fields (which sizes depend on the protocol)+ \*/+ return cs->bLength >= sizeof(\*cs) + cs->bNrInPins ++ 4 /\* bmControls \*/ + 2 /\* wCSelectorDescrStr \*/; }  static bool validate\_clock\_multiplier\_v2(void \*p, int id) { struct uac\_clock\_multiplier\_descriptor \*cs = p;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false; return cs->bClockID == id; }  static bool validate\_clock\_multiplier\_v3(void \*p, int id) { struct uac3\_clock\_multiplier\_descriptor \*cs = p;+ if (!DESC\_LENGTH\_CHECK(cs))+ return false; return cs->bClockID == id; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:12:19 +0000



=== Content from git.kernel.org_b8404689_20250114_221344.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=da13ade87a12dd58829278bc816a61bea06a56a9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da13ade87a12dd58829278bc816a61bea06a56a9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da13ade87a12dd58829278bc816a61bea06a56a9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da13ade87a12dd58829278bc816a61bea06a56a9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-25 15:46:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:54 +0100 |
| commit | [da13ade87a12dd58829278bc816a61bea06a56a9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da13ade87a12dd58829278bc816a61bea06a56a9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=da13ade87a12dd58829278bc816a61bea06a56a9)) | |
| tree | [16a8ebd7049223a741aab2a7f7c6aceb39a7f59e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da13ade87a12dd58829278bc816a61bea06a56a9) | |
| parent | [3fc0996d2fefe61219375fd650601724b8cf2d30](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3fc0996d2fefe61219375fd650601724b8cf2d30) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da13ade87a12dd58829278bc816a61bea06a56a9&id2=3fc0996d2fefe61219375fd650601724b8cf2d30)) | |
| download | [linux-da13ade87a12dd58829278bc816a61bea06a56a9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-da13ade87a12dd58829278bc816a61bea06a56a9.tar.gz) | |

ALSA: usb-audio: Fix out of bounds reads when finding clock sourcescommit a3dd4d63eeb452cfb064a13862fb376ab108f6a6 upstream.
The current USB-audio driver code doesn't check bLength of each
descriptor at traversing for clock descriptors. That is, when a
device provides a bogus descriptor with a shorter bLength, the driver
might hit out-of-bounds reads.
For addressing it, this patch adds sanity checks to the validator
functions for the clock descriptor traversal. When the descriptor
length is shorter than expected, it's skipped in the loop.
For the clock source and clock multiplier descriptors, we can just
check bLength against the sizeof() of each descriptor type.
OTOH, the clock selector descriptor of UAC2 and UAC3 has an array
of bNrInPins elements and two more fields at its tail, hence those
have to be checked in addition to the sizeof() check.
Reported-by: Benoît Sevens <bsevens@google.com>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/20241121140613.3651-1-bsevens@google.com](https://lore.kernel.org/20241121140613.3651-1-bsevens%40google.com)
Link: [https://patch.msgid.link/20241125144629.20757-1-tiwai@suse.de](https://patch.msgid.link/20241125144629.20757-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da13ade87a12dd58829278bc816a61bea06a56a9)

| -rw-r--r-- | [sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/clock.c?id=da13ade87a12dd58829278bc816a61bea06a56a9) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 1 deletions

| diff --git a/sound/usb/clock.c b/sound/usb/clock.cindex a676ad093d1897..f0f1e445cc5676 100644--- a/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=3fc0996d2fefe61219375fd650601724b8cf2d30)+++ b/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=da13ade87a12dd58829278bc816a61bea06a56a9)@@ -36,6 +36,12 @@ union uac23\_clock\_multiplier\_desc { struct uac\_clock\_multiplier\_descriptor v3; }; +/\* check whether the descriptor bLength has the minimal length \*/+#define DESC\_LENGTH\_CHECK(p, proto) \+ ((proto) == UAC\_VERSION\_3 ? \+ ((p)->v3.bLength >= sizeof((p)->v3)) : \+ ((p)->v2.bLength >= sizeof((p)->v2)))+ #define GET\_VAL(p, proto, field) \ ((proto) == UAC\_VERSION\_3 ? (p)->v3.field : (p)->v2.field) @@ -58,6 +64,8 @@ static bool validate\_clock\_source(void \*p, int id, int proto) { union uac23\_clock\_source\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } @@ -65,13 +73,27 @@ static bool validate\_clock\_selector(void \*p, int id, int proto) { union uac23\_clock\_selector\_desc \*cs = p; - return GET\_VAL(cs, proto, bClockID) == id;+ if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false;+ if (GET\_VAL(cs, proto, bClockID) != id)+ return false;+ /\* additional length check for baCSourceID array (in bNrInPins size)+ \* and two more fields (which sizes depend on the protocol)+ \*/+ if (proto == UAC\_VERSION\_3)+ return cs->v3.bLength >= sizeof(cs->v3) + cs->v3.bNrInPins ++ 4 /\* bmControls \*/ + 2 /\* wCSelectorDescrStr \*/;+ else+ return cs->v2.bLength >= sizeof(cs->v2) + cs->v2.bNrInPins ++ 1 /\* bmControls \*/ + 1 /\* iClockSelector \*/; }  static bool validate\_clock\_multiplier(void \*p, int id, int proto) { union uac23\_clock\_multiplier\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:12:21 +0000



=== Content from git.kernel.org_8ae515e5_20250114_221339.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=096bb5b43edf755bc4477e64004fa3a20539ec2f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=096bb5b43edf755bc4477e64004fa3a20539ec2f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=096bb5b43edf755bc4477e64004fa3a20539ec2f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=096bb5b43edf755bc4477e64004fa3a20539ec2f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2024-11-25 15:46:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:41 +0100 |
| commit | [096bb5b43edf755bc4477e64004fa3a20539ec2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=096bb5b43edf755bc4477e64004fa3a20539ec2f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=096bb5b43edf755bc4477e64004fa3a20539ec2f)) | |
| tree | [1dbfcbd58988c39a0780c17f170e5310ed6df635](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=096bb5b43edf755bc4477e64004fa3a20539ec2f) | |
| parent | [b521b53ac6eb04e41c03f46f7fe452e4d8e9bcca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b521b53ac6eb04e41c03f46f7fe452e4d8e9bcca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=096bb5b43edf755bc4477e64004fa3a20539ec2f&id2=b521b53ac6eb04e41c03f46f7fe452e4d8e9bcca)) | |
| download | [linux-096bb5b43edf755bc4477e64004fa3a20539ec2f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-096bb5b43edf755bc4477e64004fa3a20539ec2f.tar.gz) | |

ALSA: usb-audio: Fix out of bounds reads when finding clock sourcescommit a3dd4d63eeb452cfb064a13862fb376ab108f6a6 upstream.
The current USB-audio driver code doesn't check bLength of each
descriptor at traversing for clock descriptors. That is, when a
device provides a bogus descriptor with a shorter bLength, the driver
might hit out-of-bounds reads.
For addressing it, this patch adds sanity checks to the validator
functions for the clock descriptor traversal. When the descriptor
length is shorter than expected, it's skipped in the loop.
For the clock source and clock multiplier descriptors, we can just
check bLength against the sizeof() of each descriptor type.
OTOH, the clock selector descriptor of UAC2 and UAC3 has an array
of bNrInPins elements and two more fields at its tail, hence those
have to be checked in addition to the sizeof() check.
Reported-by: Benoît Sevens <bsevens@google.com>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/20241121140613.3651-1-bsevens@google.com](https://lore.kernel.org/20241121140613.3651-1-bsevens%40google.com)
Link: [https://patch.msgid.link/20241125144629.20757-1-tiwai@suse.de](https://patch.msgid.link/20241125144629.20757-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=096bb5b43edf755bc4477e64004fa3a20539ec2f)

| -rw-r--r-- | [sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/usb/clock.c?id=096bb5b43edf755bc4477e64004fa3a20539ec2f) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 1 deletions

| diff --git a/sound/usb/clock.c b/sound/usb/clock.cindex 8f85200292f3ff..842ba5b801eae8 100644--- a/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=b521b53ac6eb04e41c03f46f7fe452e4d8e9bcca)+++ b/[sound/usb/clock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/usb/clock.c?id=096bb5b43edf755bc4477e64004fa3a20539ec2f)@@ -36,6 +36,12 @@ union uac23\_clock\_multiplier\_desc { struct uac\_clock\_multiplier\_descriptor v3; }; +/\* check whether the descriptor bLength has the minimal length \*/+#define DESC\_LENGTH\_CHECK(p, proto) \+ ((proto) == UAC\_VERSION\_3 ? \+ ((p)->v3.bLength >= sizeof((p)->v3)) : \+ ((p)->v2.bLength >= sizeof((p)->v2)))+ #define GET\_VAL(p, proto, field) \ ((proto) == UAC\_VERSION\_3 ? (p)->v3.field : (p)->v2.field) @@ -58,6 +64,8 @@ static bool validate\_clock\_source(void \*p, int id, int proto) { union uac23\_clock\_source\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } @@ -65,13 +73,27 @@ static bool validate\_clock\_selector(void \*p, int id, int proto) { union uac23\_clock\_selector\_desc \*cs = p; - return GET\_VAL(cs, proto, bClockID) == id;+ if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false;+ if (GET\_VAL(cs, proto, bClockID) != id)+ return false;+ /\* additional length check for baCSourceID array (in bNrInPins size)+ \* and two more fields (which sizes depend on the protocol)+ \*/+ if (proto == UAC\_VERSION\_3)+ return cs->v3.bLength >= sizeof(cs->v3) + cs->v3.bNrInPins ++ 4 /\* bmControls \*/ + 2 /\* wCSelectorDescrStr \*/;+ else+ return cs->v2.bLength >= sizeof(cs->v2) + cs->v2.bNrInPins ++ 1 /\* bmControls \*/ + 1 /\* iClockSelector \*/; }  static bool validate\_clock\_multiplier(void \*p, int id, int proto) { union uac23\_clock\_multiplier\_desc \*cs = p; + if (!DESC\_LENGTH\_CHECK(cs, proto))+ return false; return GET\_VAL(cs, proto, bClockID) == id; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:12:15 +0000


