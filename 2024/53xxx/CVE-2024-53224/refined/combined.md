=== Content from git.kernel.org_dd611be1_20250114_223229.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Patrisious Haddad <phaddad@nvidia.com> | 2024-11-13 13:23:19 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:22 +0100 |
| commit | [921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad)) | |
| tree | [fac45554238ff6b0f91dd8baee58931541235d30](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad) | |
| parent | [b6334d2356fc0922ed01457960f74923058a353a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6334d2356fc0922ed01457960f74923058a353a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad&id2=b6334d2356fc0922ed01457960f74923058a353a)) | |
| download | [linux-921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad.tar.gz) | |

RDMA/mlx5: Move events notifier registration to be after device registration[ Upstream commit ede132a5cf559f3ab35a4c28bac4f4a6c20334d8 ]
Move pkey change work initialization and cleanup from device resources
stage to notifier stage, since this is the stage which handles this work
events.
Fix a race between the device deregistration and pkey change work by moving
MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER to be after MLX5\_IB\_STAGE\_IB\_REG in order to
ensure that the notifier is deregistered before the device during cleanup.
Which ensures there are no works that are being executed after the
device has already unregistered which can cause the panic below.
BUG: kernel NULL pointer dereference, address: 0000000000000000
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 630071 Comm: kworker/1:2 Kdump: loaded Tainted: G W OE --------- --- 5.14.0-162.6.1.el9\_1.x86\_64 #1
Hardware name: Microsoft Corporation Virtual Machine/Virtual Machine, BIOS 090008 02/27/2023
Workqueue: events pkey\_change\_handler [mlx5\_ib]
RIP: 0010:setup\_qp+0x38/0x1f0 [mlx5\_ib]
Code: ee 41 54 45 31 e4 55 89 f5 53 48 89 fb 48 83 ec 20 8b 77 08 65 48 8b 04 25 28 00 00 00 48 89 44 24 18 48 8b 07 48 8d 4c 24 16 <4c> 8b 38 49 8b 87 80 0b 00 00 4c 89 ff 48 8b 80 08 05 00 00 8b 40
RSP: 0018:ffffbcc54068be20 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffff954054494128 RCX: ffffbcc54068be36
RDX: ffff954004934000 RSI: 0000000000000001 RDI: ffff954054494128
RBP: 0000000000000023 R08: ffff954001be2c20 R09: 0000000000000001
R10: ffff954001be2c20 R11: ffff9540260133c0 R12: 0000000000000000
R13: 0000000000000023 R14: 0000000000000000 R15: ffff9540ffcb0905
FS: 0000000000000000(0000) GS:ffff9540ffc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 000000010625c001 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
mlx5\_ib\_gsi\_pkey\_change+0x20/0x40 [mlx5\_ib]
process\_one\_work+0x1e8/0x3c0
worker\_thread+0x50/0x3b0
? rescuer\_thread+0x380/0x380
kthread+0x149/0x170
? set\_kthread\_struct+0x50/0x50
ret\_from\_fork+0x22/0x30
Modules linked in: rdma\_ucm(OE) rdma\_cm(OE) iw\_cm(OE) ib\_ipoib(OE) ib\_cm(OE) ib\_umad(OE) mlx5\_ib(OE) mlx5\_fwctl(OE) fwctl(OE) ib\_uverbs(OE) mlx5\_core(OE) mlxdevm(OE) ib\_core(OE) mlx\_compat(OE) psample mlxfw(OE) tls knem(OE) netconsole nfsv3 nfs\_acl nfs lockd grace fscache netfs qrtr rfkill sunrpc intel\_rapl\_msr intel\_rapl\_common rapl hv\_balloon hv\_utils i2c\_piix4 pcspkr joydev fuse ext4 mbcache jbd2 sr\_mod sd\_mod cdrom t10\_pi sg ata\_generic pci\_hyperv pci\_hyperv\_intf hyperv\_drm drm\_shmem\_helper drm\_kms\_helper hv\_storvsc syscopyarea hv\_netvsc sysfillrect sysimgblt hid\_hyperv fb\_sys\_fops scsi\_transport\_fc hyperv\_keyboard drm ata\_piix crct10dif\_pclmul crc32\_pclmul crc32c\_intel libata ghash\_clmulni\_intel hv\_vmbus serio\_raw [last unloaded: ib\_core]
CR2: 0000000000000000
---[ end trace f6f8be4eae12f7bc ]---
Fixes: 7722f47e71e5 ("IB/mlx5: Create GSI transmission QPs when P\_Key table is changed")
Signed-off-by: Patrisious Haddad <phaddad@nvidia.com>
Reviewed-by: Michael Guralnik <michaelgur@nvidia.com>
Link: [https://patch.msgid.link/d271ceeff0c08431b3cbbbb3e2d416f09b6d1621.1731496944.git.leon@kernel.org](https://patch.msgid.link/d271ceeff0c08431b3cbbbb3e2d416f09b6d1621.1731496944.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad)

| -rw-r--r-- | [drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/main.c?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad) | 40 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 20 insertions, 22 deletions

| diff --git a/drivers/infiniband/hw/mlx5/main.c b/drivers/infiniband/hw/mlx5/main.cindex bc38af6cda6ee7..c510484e024b1a 100644--- a/[drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/main.c?id=b6334d2356fc0922ed01457960f74923058a353a)+++ b/[drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/main.c?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad)@@ -2899,7 +2899,6 @@ unlock: static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) { struct mlx5\_ib\_resources \*devr = &dev->devr;- int port; int ret;  if (!MLX5\_CAP\_GEN(dev->mdev, xrc))@@ -2915,10 +2914,6 @@ static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) return ret; } - for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)- INIT\_WORK(&devr->ports[port].pkey\_change\_work,- pkey\_change\_handler);- mutex\_init(&devr->cq\_lock); mutex\_init(&devr->srq\_lock); @@ -2928,16 +2923,6 @@ static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) static void mlx5\_ib\_dev\_res\_cleanup(struct mlx5\_ib\_dev \*dev) { struct mlx5\_ib\_resources \*devr = &dev->devr;- int port;-- /\*- \* Make sure no change P\_Key work items are still executing.- \*- \* At this stage, the mlx5\_ib\_event should be unregistered- \* and it ensures that no new works are added.- \*/- for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)- cancel\_work\_sync(&devr->ports[port].pkey\_change\_work);  /\* After s0/s1 init, they are not unset during the device lifetime. \*/ if (devr->s1) {@@ -4201,6 +4186,13 @@ static void mlx5\_ib\_stage\_delay\_drop\_cleanup(struct mlx5\_ib\_dev \*dev)  static int mlx5\_ib\_stage\_dev\_notifier\_init(struct mlx5\_ib\_dev \*dev) {+ struct mlx5\_ib\_resources \*devr = &dev->devr;+ int port;++ for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)+ INIT\_WORK(&devr->ports[port].pkey\_change\_work,+ pkey\_change\_handler);+ dev->mdev\_events.notifier\_call = mlx5\_ib\_event; mlx5\_notifier\_register(dev->mdev, &dev->mdev\_events); @@ -4211,8 +4203,14 @@ static int mlx5\_ib\_stage\_dev\_notifier\_init(struct mlx5\_ib\_dev \*dev)  static void mlx5\_ib\_stage\_dev\_notifier\_cleanup(struct mlx5\_ib\_dev \*dev) {+ struct mlx5\_ib\_resources \*devr = &dev->devr;+ int port;+ mlx5r\_macsec\_event\_unregister(dev); mlx5\_notifier\_unregister(dev->mdev, &dev->mdev\_events);++ for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)+ cancel\_work\_sync(&devr->ports[port].pkey\_change\_work); }  void \_\_mlx5\_ib\_remove(struct mlx5\_ib\_dev \*dev,@@ -4286,9 +4284,6 @@ static const struct mlx5\_ib\_profile pf\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_RESOURCES, mlx5\_ib\_dev\_res\_init, mlx5\_ib\_dev\_res\_cleanup),- STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,- mlx5\_ib\_stage\_dev\_notifier\_init,- mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_ODP, mlx5\_ib\_odp\_init\_one, mlx5\_ib\_odp\_cleanup\_one),@@ -4313,6 +4308,9 @@ static const struct mlx5\_ib\_profile pf\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_IB\_REG, mlx5\_ib\_stage\_ib\_reg\_init, mlx5\_ib\_stage\_ib\_reg\_cleanup),+ STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,+ mlx5\_ib\_stage\_dev\_notifier\_init,+ mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, mlx5\_ib\_stage\_post\_ib\_reg\_umr\_init, NULL),@@ -4349,9 +4347,6 @@ const struct mlx5\_ib\_profile raw\_eth\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_RESOURCES, mlx5\_ib\_dev\_res\_init, mlx5\_ib\_dev\_res\_cleanup),- STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,- mlx5\_ib\_stage\_dev\_notifier\_init,- mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_COUNTERS, mlx5\_ib\_counters\_init, mlx5\_ib\_counters\_cleanup),@@ -4373,6 +4368,9 @@ const struct mlx5\_ib\_profile raw\_eth\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_IB\_REG, mlx5\_ib\_stage\_ib\_reg\_init, mlx5\_ib\_stage\_ib\_reg\_cleanup),+ STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,+ mlx5\_ib\_stage\_dev\_notifier\_init,+ mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, mlx5\_ib\_stage\_post\_ib\_reg\_umr\_init, NULL),diff --git a/drivers/infiniband/hw/mlx5/mlx5\_ib.h b/drivers/infiniband/hw/mlx5/mlx5\_ib.hindex 1c83d132197f52..94678e5c59dd59 100644--- a/[drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=b6334d2356fc0922ed01457960f74923058a353a)+++ b/[drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=921fcf2971a1e8d3b904ba2c2905b96f4ec3d4ad)@@ -954,7 +954,6 @@ enum mlx5\_ib\_stages { MLX5\_IB\_STAGE\_QP, MLX5\_IB\_STAGE\_SRQ, MLX5\_IB\_STAGE\_DEVICE\_RESOURCES,- MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER, MLX5\_IB\_STAGE\_ODP, MLX5\_IB\_STAGE\_COUNTERS, MLX5\_IB\_STAGE\_CONG\_DEBUGFS,@@ -963,6 +962,7 @@ enum mlx5\_ib\_stages { MLX5\_IB\_STAGE\_PRE\_IB\_REG\_UMR, MLX5\_IB\_STAGE\_WHITELIST\_UID, MLX5\_IB\_STAGE\_IB\_REG,+ MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER, MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, MLX5\_IB\_STAGE\_DELAY\_DROP, MLX5\_IB\_STAGE\_RESTRACK, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:31:06 +0000



=== Content from git.kernel.org_0ebf64b7_20250114_223227.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Patrisious Haddad <phaddad@nvidia.com> | 2024-11-13 13:23:19 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:42 +0100 |
| commit | [542bd62b7a7f37182c9ef192c2bd25d118c144e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4)) | |
| tree | [9fc2110411c1a008edefc4f0a18edeb50286f6ca](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4) | |
| parent | [d10cd53e5a7fb3b7c6f83d4d9a5ea1d97a3ed9a5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d10cd53e5a7fb3b7c6f83d4d9a5ea1d97a3ed9a5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4&id2=d10cd53e5a7fb3b7c6f83d4d9a5ea1d97a3ed9a5)) | |
| download | [linux-542bd62b7a7f37182c9ef192c2bd25d118c144e4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-542bd62b7a7f37182c9ef192c2bd25d118c144e4.tar.gz) | |

RDMA/mlx5: Move events notifier registration to be after device registration[ Upstream commit ede132a5cf559f3ab35a4c28bac4f4a6c20334d8 ]
Move pkey change work initialization and cleanup from device resources
stage to notifier stage, since this is the stage which handles this work
events.
Fix a race between the device deregistration and pkey change work by moving
MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER to be after MLX5\_IB\_STAGE\_IB\_REG in order to
ensure that the notifier is deregistered before the device during cleanup.
Which ensures there are no works that are being executed after the
device has already unregistered which can cause the panic below.
BUG: kernel NULL pointer dereference, address: 0000000000000000
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 630071 Comm: kworker/1:2 Kdump: loaded Tainted: G W OE --------- --- 5.14.0-162.6.1.el9\_1.x86\_64 #1
Hardware name: Microsoft Corporation Virtual Machine/Virtual Machine, BIOS 090008 02/27/2023
Workqueue: events pkey\_change\_handler [mlx5\_ib]
RIP: 0010:setup\_qp+0x38/0x1f0 [mlx5\_ib]
Code: ee 41 54 45 31 e4 55 89 f5 53 48 89 fb 48 83 ec 20 8b 77 08 65 48 8b 04 25 28 00 00 00 48 89 44 24 18 48 8b 07 48 8d 4c 24 16 <4c> 8b 38 49 8b 87 80 0b 00 00 4c 89 ff 48 8b 80 08 05 00 00 8b 40
RSP: 0018:ffffbcc54068be20 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffff954054494128 RCX: ffffbcc54068be36
RDX: ffff954004934000 RSI: 0000000000000001 RDI: ffff954054494128
RBP: 0000000000000023 R08: ffff954001be2c20 R09: 0000000000000001
R10: ffff954001be2c20 R11: ffff9540260133c0 R12: 0000000000000000
R13: 0000000000000023 R14: 0000000000000000 R15: ffff9540ffcb0905
FS: 0000000000000000(0000) GS:ffff9540ffc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 000000010625c001 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
mlx5\_ib\_gsi\_pkey\_change+0x20/0x40 [mlx5\_ib]
process\_one\_work+0x1e8/0x3c0
worker\_thread+0x50/0x3b0
? rescuer\_thread+0x380/0x380
kthread+0x149/0x170
? set\_kthread\_struct+0x50/0x50
ret\_from\_fork+0x22/0x30
Modules linked in: rdma\_ucm(OE) rdma\_cm(OE) iw\_cm(OE) ib\_ipoib(OE) ib\_cm(OE) ib\_umad(OE) mlx5\_ib(OE) mlx5\_fwctl(OE) fwctl(OE) ib\_uverbs(OE) mlx5\_core(OE) mlxdevm(OE) ib\_core(OE) mlx\_compat(OE) psample mlxfw(OE) tls knem(OE) netconsole nfsv3 nfs\_acl nfs lockd grace fscache netfs qrtr rfkill sunrpc intel\_rapl\_msr intel\_rapl\_common rapl hv\_balloon hv\_utils i2c\_piix4 pcspkr joydev fuse ext4 mbcache jbd2 sr\_mod sd\_mod cdrom t10\_pi sg ata\_generic pci\_hyperv pci\_hyperv\_intf hyperv\_drm drm\_shmem\_helper drm\_kms\_helper hv\_storvsc syscopyarea hv\_netvsc sysfillrect sysimgblt hid\_hyperv fb\_sys\_fops scsi\_transport\_fc hyperv\_keyboard drm ata\_piix crct10dif\_pclmul crc32\_pclmul crc32c\_intel libata ghash\_clmulni\_intel hv\_vmbus serio\_raw [last unloaded: ib\_core]
CR2: 0000000000000000
---[ end trace f6f8be4eae12f7bc ]---
Fixes: 7722f47e71e5 ("IB/mlx5: Create GSI transmission QPs when P\_Key table is changed")
Signed-off-by: Patrisious Haddad <phaddad@nvidia.com>
Reviewed-by: Michael Guralnik <michaelgur@nvidia.com>
Link: [https://patch.msgid.link/d271ceeff0c08431b3cbbbb3e2d416f09b6d1621.1731496944.git.leon@kernel.org](https://patch.msgid.link/d271ceeff0c08431b3cbbbb3e2d416f09b6d1621.1731496944.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4)

| -rw-r--r-- | [drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/main.c?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4) | 40 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 20 insertions, 22 deletions

| diff --git a/drivers/infiniband/hw/mlx5/main.c b/drivers/infiniband/hw/mlx5/main.cindex 5926fd07a60212..a7e5daeaacc7e6 100644--- a/[drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/main.c?id=d10cd53e5a7fb3b7c6f83d4d9a5ea1d97a3ed9a5)+++ b/[drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/main.c?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4)@@ -2968,7 +2968,6 @@ unlock: static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) { struct mlx5\_ib\_resources \*devr = &dev->devr;- int port; int ret;  if (!MLX5\_CAP\_GEN(dev->mdev, xrc))@@ -2984,10 +2983,6 @@ static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) return ret; } - for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)- INIT\_WORK(&devr->ports[port].pkey\_change\_work,- pkey\_change\_handler);- mutex\_init(&devr->cq\_lock); mutex\_init(&devr->srq\_lock); @@ -2997,16 +2992,6 @@ static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) static void mlx5\_ib\_dev\_res\_cleanup(struct mlx5\_ib\_dev \*dev) { struct mlx5\_ib\_resources \*devr = &dev->devr;- int port;-- /\*- \* Make sure no change P\_Key work items are still executing.- \*- \* At this stage, the mlx5\_ib\_event should be unregistered- \* and it ensures that no new works are added.- \*/- for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)- cancel\_work\_sync(&devr->ports[port].pkey\_change\_work);  /\* After s0/s1 init, they are not unset during the device lifetime. \*/ if (devr->s1) {@@ -4279,6 +4264,13 @@ static void mlx5\_ib\_stage\_delay\_drop\_cleanup(struct mlx5\_ib\_dev \*dev)  static int mlx5\_ib\_stage\_dev\_notifier\_init(struct mlx5\_ib\_dev \*dev) {+ struct mlx5\_ib\_resources \*devr = &dev->devr;+ int port;++ for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)+ INIT\_WORK(&devr->ports[port].pkey\_change\_work,+ pkey\_change\_handler);+ dev->mdev\_events.notifier\_call = mlx5\_ib\_event; mlx5\_notifier\_register(dev->mdev, &dev->mdev\_events); @@ -4289,8 +4281,14 @@ static int mlx5\_ib\_stage\_dev\_notifier\_init(struct mlx5\_ib\_dev \*dev)  static void mlx5\_ib\_stage\_dev\_notifier\_cleanup(struct mlx5\_ib\_dev \*dev) {+ struct mlx5\_ib\_resources \*devr = &dev->devr;+ int port;+ mlx5r\_macsec\_event\_unregister(dev); mlx5\_notifier\_unregister(dev->mdev, &dev->mdev\_events);++ for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)+ cancel\_work\_sync(&devr->ports[port].pkey\_change\_work); }  void \_\_mlx5\_ib\_remove(struct mlx5\_ib\_dev \*dev,@@ -4364,9 +4362,6 @@ static const struct mlx5\_ib\_profile pf\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_RESOURCES, mlx5\_ib\_dev\_res\_init, mlx5\_ib\_dev\_res\_cleanup),- STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,- mlx5\_ib\_stage\_dev\_notifier\_init,- mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_ODP, mlx5\_ib\_odp\_init\_one, mlx5\_ib\_odp\_cleanup\_one),@@ -4391,6 +4386,9 @@ static const struct mlx5\_ib\_profile pf\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_IB\_REG, mlx5\_ib\_stage\_ib\_reg\_init, mlx5\_ib\_stage\_ib\_reg\_cleanup),+ STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,+ mlx5\_ib\_stage\_dev\_notifier\_init,+ mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, mlx5\_ib\_stage\_post\_ib\_reg\_umr\_init, NULL),@@ -4427,9 +4425,6 @@ const struct mlx5\_ib\_profile raw\_eth\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_RESOURCES, mlx5\_ib\_dev\_res\_init, mlx5\_ib\_dev\_res\_cleanup),- STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,- mlx5\_ib\_stage\_dev\_notifier\_init,- mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_COUNTERS, mlx5\_ib\_counters\_init, mlx5\_ib\_counters\_cleanup),@@ -4451,6 +4446,9 @@ const struct mlx5\_ib\_profile raw\_eth\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_IB\_REG, mlx5\_ib\_stage\_ib\_reg\_init, mlx5\_ib\_stage\_ib\_reg\_cleanup),+ STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,+ mlx5\_ib\_stage\_dev\_notifier\_init,+ mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, mlx5\_ib\_stage\_post\_ib\_reg\_umr\_init, NULL),diff --git a/drivers/infiniband/hw/mlx5/mlx5\_ib.h b/drivers/infiniband/hw/mlx5/mlx5\_ib.hindex 85118b7cb63dbb..8e25afe36390a8 100644--- a/[drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=d10cd53e5a7fb3b7c6f83d4d9a5ea1d97a3ed9a5)+++ b/[drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=542bd62b7a7f37182c9ef192c2bd25d118c144e4)@@ -971,7 +971,6 @@ enum mlx5\_ib\_stages { MLX5\_IB\_STAGE\_QP, MLX5\_IB\_STAGE\_SRQ, MLX5\_IB\_STAGE\_DEVICE\_RESOURCES,- MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER, MLX5\_IB\_STAGE\_ODP, MLX5\_IB\_STAGE\_COUNTERS, MLX5\_IB\_STAGE\_CONG\_DEBUGFS,@@ -980,6 +979,7 @@ enum mlx5\_ib\_stages { MLX5\_IB\_STAGE\_PRE\_IB\_REG\_UMR, MLX5\_IB\_STAGE\_WHITELIST\_UID, MLX5\_IB\_STAGE\_IB\_REG,+ MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER, MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, MLX5\_IB\_STAGE\_DELAY\_DROP, MLX5\_IB\_STAGE\_RESTRACK, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:31:04 +0000



=== Content from git.kernel.org_ff9fe61e_20250114_223228.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Patrisious Haddad <phaddad@nvidia.com> | 2024-11-13 13:23:19 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:14 +0100 |
| commit | [6b0acf6a94c31efa43fce4edc22413a3390f9c05](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05)) | |
| tree | [0b69e97e6e9df20801541a64ca5c41fa1dcc25e4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05) | |
| parent | [bad37309c8b8bf1cfc893750df0951a804009ca0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bad37309c8b8bf1cfc893750df0951a804009ca0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05&id2=bad37309c8b8bf1cfc893750df0951a804009ca0)) | |
| download | [linux-6b0acf6a94c31efa43fce4edc22413a3390f9c05.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b0acf6a94c31efa43fce4edc22413a3390f9c05.tar.gz) | |

RDMA/mlx5: Move events notifier registration to be after device registration[ Upstream commit ede132a5cf559f3ab35a4c28bac4f4a6c20334d8 ]
Move pkey change work initialization and cleanup from device resources
stage to notifier stage, since this is the stage which handles this work
events.
Fix a race between the device deregistration and pkey change work by moving
MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER to be after MLX5\_IB\_STAGE\_IB\_REG in order to
ensure that the notifier is deregistered before the device during cleanup.
Which ensures there are no works that are being executed after the
device has already unregistered which can cause the panic below.
BUG: kernel NULL pointer dereference, address: 0000000000000000
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 630071 Comm: kworker/1:2 Kdump: loaded Tainted: G W OE --------- --- 5.14.0-162.6.1.el9\_1.x86\_64 #1
Hardware name: Microsoft Corporation Virtual Machine/Virtual Machine, BIOS 090008 02/27/2023
Workqueue: events pkey\_change\_handler [mlx5\_ib]
RIP: 0010:setup\_qp+0x38/0x1f0 [mlx5\_ib]
Code: ee 41 54 45 31 e4 55 89 f5 53 48 89 fb 48 83 ec 20 8b 77 08 65 48 8b 04 25 28 00 00 00 48 89 44 24 18 48 8b 07 48 8d 4c 24 16 <4c> 8b 38 49 8b 87 80 0b 00 00 4c 89 ff 48 8b 80 08 05 00 00 8b 40
RSP: 0018:ffffbcc54068be20 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffff954054494128 RCX: ffffbcc54068be36
RDX: ffff954004934000 RSI: 0000000000000001 RDI: ffff954054494128
RBP: 0000000000000023 R08: ffff954001be2c20 R09: 0000000000000001
R10: ffff954001be2c20 R11: ffff9540260133c0 R12: 0000000000000000
R13: 0000000000000023 R14: 0000000000000000 R15: ffff9540ffcb0905
FS: 0000000000000000(0000) GS:ffff9540ffc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 000000010625c001 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
mlx5\_ib\_gsi\_pkey\_change+0x20/0x40 [mlx5\_ib]
process\_one\_work+0x1e8/0x3c0
worker\_thread+0x50/0x3b0
? rescuer\_thread+0x380/0x380
kthread+0x149/0x170
? set\_kthread\_struct+0x50/0x50
ret\_from\_fork+0x22/0x30
Modules linked in: rdma\_ucm(OE) rdma\_cm(OE) iw\_cm(OE) ib\_ipoib(OE) ib\_cm(OE) ib\_umad(OE) mlx5\_ib(OE) mlx5\_fwctl(OE) fwctl(OE) ib\_uverbs(OE) mlx5\_core(OE) mlxdevm(OE) ib\_core(OE) mlx\_compat(OE) psample mlxfw(OE) tls knem(OE) netconsole nfsv3 nfs\_acl nfs lockd grace fscache netfs qrtr rfkill sunrpc intel\_rapl\_msr intel\_rapl\_common rapl hv\_balloon hv\_utils i2c\_piix4 pcspkr joydev fuse ext4 mbcache jbd2 sr\_mod sd\_mod cdrom t10\_pi sg ata\_generic pci\_hyperv pci\_hyperv\_intf hyperv\_drm drm\_shmem\_helper drm\_kms\_helper hv\_storvsc syscopyarea hv\_netvsc sysfillrect sysimgblt hid\_hyperv fb\_sys\_fops scsi\_transport\_fc hyperv\_keyboard drm ata\_piix crct10dif\_pclmul crc32\_pclmul crc32c\_intel libata ghash\_clmulni\_intel hv\_vmbus serio\_raw [last unloaded: ib\_core]
CR2: 0000000000000000
---[ end trace f6f8be4eae12f7bc ]---
Fixes: 7722f47e71e5 ("IB/mlx5: Create GSI transmission QPs when P\_Key table is changed")
Signed-off-by: Patrisious Haddad <phaddad@nvidia.com>
Reviewed-by: Michael Guralnik <michaelgur@nvidia.com>
Link: [https://patch.msgid.link/d271ceeff0c08431b3cbbbb3e2d416f09b6d1621.1731496944.git.leon@kernel.org](https://patch.msgid.link/d271ceeff0c08431b3cbbbb3e2d416f09b6d1621.1731496944.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05)

| -rw-r--r-- | [drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/main.c?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05) | 40 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 20 insertions, 22 deletions

| diff --git a/drivers/infiniband/hw/mlx5/main.c b/drivers/infiniband/hw/mlx5/main.cindex 5fef9288699c64..ac20ab3bbabf47 100644--- a/[drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/main.c?id=bad37309c8b8bf1cfc893750df0951a804009ca0)+++ b/[drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/main.c?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05)@@ -2997,7 +2997,6 @@ unlock: static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) { struct mlx5\_ib\_resources \*devr = &dev->devr;- int port; int ret;  if (!MLX5\_CAP\_GEN(dev->mdev, xrc))@@ -3013,10 +3012,6 @@ static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) return ret; } - for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)- INIT\_WORK(&devr->ports[port].pkey\_change\_work,- pkey\_change\_handler);- mutex\_init(&devr->cq\_lock); mutex\_init(&devr->srq\_lock); @@ -3026,16 +3021,6 @@ static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) static void mlx5\_ib\_dev\_res\_cleanup(struct mlx5\_ib\_dev \*dev) { struct mlx5\_ib\_resources \*devr = &dev->devr;- int port;-- /\*- \* Make sure no change P\_Key work items are still executing.- \*- \* At this stage, the mlx5\_ib\_event should be unregistered- \* and it ensures that no new works are added.- \*/- for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)- cancel\_work\_sync(&devr->ports[port].pkey\_change\_work);  /\* After s0/s1 init, they are not unset during the device lifetime. \*/ if (devr->s1) {@@ -4471,6 +4456,13 @@ static void mlx5\_ib\_stage\_delay\_drop\_cleanup(struct mlx5\_ib\_dev \*dev)  static int mlx5\_ib\_stage\_dev\_notifier\_init(struct mlx5\_ib\_dev \*dev) {+ struct mlx5\_ib\_resources \*devr = &dev->devr;+ int port;++ for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)+ INIT\_WORK(&devr->ports[port].pkey\_change\_work,+ pkey\_change\_handler);+ dev->mdev\_events.notifier\_call = mlx5\_ib\_event; mlx5\_notifier\_register(dev->mdev, &dev->mdev\_events); @@ -4481,8 +4473,14 @@ static int mlx5\_ib\_stage\_dev\_notifier\_init(struct mlx5\_ib\_dev \*dev)  static void mlx5\_ib\_stage\_dev\_notifier\_cleanup(struct mlx5\_ib\_dev \*dev) {+ struct mlx5\_ib\_resources \*devr = &dev->devr;+ int port;+ mlx5r\_macsec\_event\_unregister(dev); mlx5\_notifier\_unregister(dev->mdev, &dev->mdev\_events);++ for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)+ cancel\_work\_sync(&devr->ports[port].pkey\_change\_work); }  void mlx5\_ib\_data\_direct\_bind(struct mlx5\_ib\_dev \*ibdev,@@ -4572,9 +4570,6 @@ static const struct mlx5\_ib\_profile pf\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_RESOURCES, mlx5\_ib\_dev\_res\_init, mlx5\_ib\_dev\_res\_cleanup),- STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,- mlx5\_ib\_stage\_dev\_notifier\_init,- mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_ODP, mlx5\_ib\_odp\_init\_one, mlx5\_ib\_odp\_cleanup\_one),@@ -4599,6 +4594,9 @@ static const struct mlx5\_ib\_profile pf\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_IB\_REG, mlx5\_ib\_stage\_ib\_reg\_init, mlx5\_ib\_stage\_ib\_reg\_cleanup),+ STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,+ mlx5\_ib\_stage\_dev\_notifier\_init,+ mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, mlx5\_ib\_stage\_post\_ib\_reg\_umr\_init, NULL),@@ -4635,9 +4633,6 @@ const struct mlx5\_ib\_profile raw\_eth\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_RESOURCES, mlx5\_ib\_dev\_res\_init, mlx5\_ib\_dev\_res\_cleanup),- STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,- mlx5\_ib\_stage\_dev\_notifier\_init,- mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_COUNTERS, mlx5\_ib\_counters\_init, mlx5\_ib\_counters\_cleanup),@@ -4659,6 +4654,9 @@ const struct mlx5\_ib\_profile raw\_eth\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_IB\_REG, mlx5\_ib\_stage\_ib\_reg\_init, mlx5\_ib\_stage\_ib\_reg\_cleanup),+ STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,+ mlx5\_ib\_stage\_dev\_notifier\_init,+ mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, mlx5\_ib\_stage\_post\_ib\_reg\_umr\_init, NULL),diff --git a/drivers/infiniband/hw/mlx5/mlx5\_ib.h b/drivers/infiniband/hw/mlx5/mlx5\_ib.hindex 23fd72f7f63df9..29bde64ea1eac9 100644--- a/[drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=bad37309c8b8bf1cfc893750df0951a804009ca0)+++ b/[drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=6b0acf6a94c31efa43fce4edc22413a3390f9c05)@@ -972,7 +972,6 @@ enum mlx5\_ib\_stages { MLX5\_IB\_STAGE\_QP, MLX5\_IB\_STAGE\_SRQ, MLX5\_IB\_STAGE\_DEVICE\_RESOURCES,- MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER, MLX5\_IB\_STAGE\_ODP, MLX5\_IB\_STAGE\_COUNTERS, MLX5\_IB\_STAGE\_CONG\_DEBUGFS,@@ -981,6 +980,7 @@ enum mlx5\_ib\_stages { MLX5\_IB\_STAGE\_PRE\_IB\_REG\_UMR, MLX5\_IB\_STAGE\_WHITELIST\_UID, MLX5\_IB\_STAGE\_IB\_REG,+ MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER, MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, MLX5\_IB\_STAGE\_DELAY\_DROP, MLX5\_IB\_STAGE\_RESTRACK, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:31:05 +0000



=== Content from git.kernel.org_22138a05_20250114_223229.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Patrisious Haddad <phaddad@nvidia.com> | 2024-11-13 13:23:19 +0200 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2024-11-14 09:53:53 -0500 |
| commit | [ede132a5cf559f3ab35a4c28bac4f4a6c20334d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8)) | |
| tree | [eaeb693272a04d6970f24a28509102628d9b8e2b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8) | |
| parent | [31bad59805c388f92f3a13174a149c2228301c15](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31bad59805c388f92f3a13174a149c2228301c15) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8&id2=31bad59805c388f92f3a13174a149c2228301c15)) | |
| download | [linux-ede132a5cf559f3ab35a4c28bac4f4a6c20334d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ede132a5cf559f3ab35a4c28bac4f4a6c20334d8.tar.gz) | |

RDMA/mlx5: Move events notifier registration to be after device registrationMove pkey change work initialization and cleanup from device resources
stage to notifier stage, since this is the stage which handles this work
events.
Fix a race between the device deregistration and pkey change work by moving
MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER to be after MLX5\_IB\_STAGE\_IB\_REG in order to
ensure that the notifier is deregistered before the device during cleanup.
Which ensures there are no works that are being executed after the
device has already unregistered which can cause the panic below.
BUG: kernel NULL pointer dereference, address: 0000000000000000
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 630071 Comm: kworker/1:2 Kdump: loaded Tainted: G W OE --------- --- 5.14.0-162.6.1.el9\_1.x86\_64 #1
Hardware name: Microsoft Corporation Virtual Machine/Virtual Machine, BIOS 090008 02/27/2023
Workqueue: events pkey\_change\_handler [mlx5\_ib]
RIP: 0010:setup\_qp+0x38/0x1f0 [mlx5\_ib]
Code: ee 41 54 45 31 e4 55 89 f5 53 48 89 fb 48 83 ec 20 8b 77 08 65 48 8b 04 25 28 00 00 00 48 89 44 24 18 48 8b 07 48 8d 4c 24 16 <4c> 8b 38 49 8b 87 80 0b 00 00 4c 89 ff 48 8b 80 08 05 00 00 8b 40
RSP: 0018:ffffbcc54068be20 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffff954054494128 RCX: ffffbcc54068be36
RDX: ffff954004934000 RSI: 0000000000000001 RDI: ffff954054494128
RBP: 0000000000000023 R08: ffff954001be2c20 R09: 0000000000000001
R10: ffff954001be2c20 R11: ffff9540260133c0 R12: 0000000000000000
R13: 0000000000000023 R14: 0000000000000000 R15: ffff9540ffcb0905
FS: 0000000000000000(0000) GS:ffff9540ffc80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 000000010625c001 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
mlx5\_ib\_gsi\_pkey\_change+0x20/0x40 [mlx5\_ib]
process\_one\_work+0x1e8/0x3c0
worker\_thread+0x50/0x3b0
? rescuer\_thread+0x380/0x380
kthread+0x149/0x170
? set\_kthread\_struct+0x50/0x50
ret\_from\_fork+0x22/0x30
Modules linked in: rdma\_ucm(OE) rdma\_cm(OE) iw\_cm(OE) ib\_ipoib(OE) ib\_cm(OE) ib\_umad(OE) mlx5\_ib(OE) mlx5\_fwctl(OE) fwctl(OE) ib\_uverbs(OE) mlx5\_core(OE) mlxdevm(OE) ib\_core(OE) mlx\_compat(OE) psample mlxfw(OE) tls knem(OE) netconsole nfsv3 nfs\_acl nfs lockd grace fscache netfs qrtr rfkill sunrpc intel\_rapl\_msr intel\_rapl\_common rapl hv\_balloon hv\_utils i2c\_piix4 pcspkr joydev fuse ext4 mbcache jbd2 sr\_mod sd\_mod cdrom t10\_pi sg ata\_generic pci\_hyperv pci\_hyperv\_intf hyperv\_drm drm\_shmem\_helper drm\_kms\_helper hv\_storvsc syscopyarea hv\_netvsc sysfillrect sysimgblt hid\_hyperv fb\_sys\_fops scsi\_transport\_fc hyperv\_keyboard drm ata\_piix crct10dif\_pclmul crc32\_pclmul crc32c\_intel libata ghash\_clmulni\_intel hv\_vmbus serio\_raw [last unloaded: ib\_core]
CR2: 0000000000000000
---[ end trace f6f8be4eae12f7bc ]---
Fixes: 7722f47e71e5 ("IB/mlx5: Create GSI transmission QPs when P\_Key table is changed")
Signed-off-by: Patrisious Haddad <phaddad@nvidia.com>
Reviewed-by: Michael Guralnik <michaelgur@nvidia.com>
Link: [https://patch.msgid.link/d271ceeff0c08431b3cbbbb3e2d416f09b6d1621.1731496944.git.leon@kernel.org](https://patch.msgid.link/d271ceeff0c08431b3cbbbb3e2d416f09b6d1621.1731496944.git.leon%40kernel.org)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8)

| -rw-r--r-- | [drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/main.c?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8) | 40 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 20 insertions, 22 deletions

| diff --git a/drivers/infiniband/hw/mlx5/main.c b/drivers/infiniband/hw/mlx5/main.cindex 65da5df05d0217..bc7930d0c5647d 100644--- a/[drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/main.c?id=31bad59805c388f92f3a13174a149c2228301c15)+++ b/[drivers/infiniband/hw/mlx5/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/main.c?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8)@@ -3005,7 +3005,6 @@ unlock: static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) { struct mlx5\_ib\_resources \*devr = &dev->devr;- int port; int ret;  if (!MLX5\_CAP\_GEN(dev->mdev, xrc))@@ -3021,10 +3020,6 @@ static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) return ret; } - for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)- INIT\_WORK(&devr->ports[port].pkey\_change\_work,- pkey\_change\_handler);- mutex\_init(&devr->cq\_lock); mutex\_init(&devr->srq\_lock); @@ -3034,16 +3029,6 @@ static int mlx5\_ib\_dev\_res\_init(struct mlx5\_ib\_dev \*dev) static void mlx5\_ib\_dev\_res\_cleanup(struct mlx5\_ib\_dev \*dev) { struct mlx5\_ib\_resources \*devr = &dev->devr;- int port;-- /\*- \* Make sure no change P\_Key work items are still executing.- \*- \* At this stage, the mlx5\_ib\_event should be unregistered- \* and it ensures that no new works are added.- \*/- for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)- cancel\_work\_sync(&devr->ports[port].pkey\_change\_work);  /\* After s0/s1 init, they are not unset during the device lifetime. \*/ if (devr->s1) {@@ -4480,6 +4465,13 @@ static void mlx5\_ib\_stage\_delay\_drop\_cleanup(struct mlx5\_ib\_dev \*dev)  static int mlx5\_ib\_stage\_dev\_notifier\_init(struct mlx5\_ib\_dev \*dev) {+ struct mlx5\_ib\_resources \*devr = &dev->devr;+ int port;++ for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)+ INIT\_WORK(&devr->ports[port].pkey\_change\_work,+ pkey\_change\_handler);+ dev->mdev\_events.notifier\_call = mlx5\_ib\_event; mlx5\_notifier\_register(dev->mdev, &dev->mdev\_events); @@ -4490,8 +4482,14 @@ static int mlx5\_ib\_stage\_dev\_notifier\_init(struct mlx5\_ib\_dev \*dev)  static void mlx5\_ib\_stage\_dev\_notifier\_cleanup(struct mlx5\_ib\_dev \*dev) {+ struct mlx5\_ib\_resources \*devr = &dev->devr;+ int port;+ mlx5r\_macsec\_event\_unregister(dev); mlx5\_notifier\_unregister(dev->mdev, &dev->mdev\_events);++ for (port = 0; port < ARRAY\_SIZE(devr->ports); ++port)+ cancel\_work\_sync(&devr->ports[port].pkey\_change\_work); }  void mlx5\_ib\_data\_direct\_bind(struct mlx5\_ib\_dev \*ibdev,@@ -4581,9 +4579,6 @@ static const struct mlx5\_ib\_profile pf\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_RESOURCES, mlx5\_ib\_dev\_res\_init, mlx5\_ib\_dev\_res\_cleanup),- STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,- mlx5\_ib\_stage\_dev\_notifier\_init,- mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_ODP, mlx5\_ib\_odp\_init\_one, mlx5\_ib\_odp\_cleanup\_one),@@ -4608,6 +4603,9 @@ static const struct mlx5\_ib\_profile pf\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_IB\_REG, mlx5\_ib\_stage\_ib\_reg\_init, mlx5\_ib\_stage\_ib\_reg\_cleanup),+ STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,+ mlx5\_ib\_stage\_dev\_notifier\_init,+ mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, mlx5\_ib\_stage\_post\_ib\_reg\_umr\_init, NULL),@@ -4644,9 +4642,6 @@ const struct mlx5\_ib\_profile raw\_eth\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_RESOURCES, mlx5\_ib\_dev\_res\_init, mlx5\_ib\_dev\_res\_cleanup),- STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,- mlx5\_ib\_stage\_dev\_notifier\_init,- mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_COUNTERS, mlx5\_ib\_counters\_init, mlx5\_ib\_counters\_cleanup),@@ -4668,6 +4663,9 @@ const struct mlx5\_ib\_profile raw\_eth\_profile = { STAGE\_CREATE(MLX5\_IB\_STAGE\_IB\_REG, mlx5\_ib\_stage\_ib\_reg\_init, mlx5\_ib\_stage\_ib\_reg\_cleanup),+ STAGE\_CREATE(MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER,+ mlx5\_ib\_stage\_dev\_notifier\_init,+ mlx5\_ib\_stage\_dev\_notifier\_cleanup), STAGE\_CREATE(MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, mlx5\_ib\_stage\_post\_ib\_reg\_umr\_init, NULL),diff --git a/drivers/infiniband/hw/mlx5/mlx5\_ib.h b/drivers/infiniband/hw/mlx5/mlx5\_ib.hindex ed4eaaa7ac71e7..a01b592aa7168d 100644--- a/[drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=31bad59805c388f92f3a13174a149c2228301c15)+++ b/[drivers/infiniband/hw/mlx5/mlx5\_ib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/mlx5_ib.h?id=ede132a5cf559f3ab35a4c28bac4f4a6c20334d8)@@ -973,7 +973,6 @@ enum mlx5\_ib\_stages { MLX5\_IB\_STAGE\_QP, MLX5\_IB\_STAGE\_SRQ, MLX5\_IB\_STAGE\_DEVICE\_RESOURCES,- MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER, MLX5\_IB\_STAGE\_ODP, MLX5\_IB\_STAGE\_COUNTERS, MLX5\_IB\_STAGE\_CONG\_DEBUGFS,@@ -982,6 +981,7 @@ enum mlx5\_ib\_stages { MLX5\_IB\_STAGE\_PRE\_IB\_REG\_UMR, MLX5\_IB\_STAGE\_WHITELIST\_UID, MLX5\_IB\_STAGE\_IB\_REG,+ MLX5\_IB\_STAGE\_DEVICE\_NOTIFIER, MLX5\_IB\_STAGE\_POST\_IB\_REG\_UMR, MLX5\_IB\_STAGE\_DELAY\_DROP, MLX5\_IB\_STAGE\_RESTRACK, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:31:06 +0000


