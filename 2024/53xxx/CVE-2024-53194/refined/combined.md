=== Content from git.kernel.org_a55eafcf_20250114_225039.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=20502f0b3f3acd6bee300257556c27a867f80c8b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20502f0b3f3acd6bee300257556c27a867f80c8b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20502f0b3f3acd6bee300257556c27a867f80c8b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20502f0b3f3acd6bee300257556c27a867f80c8b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2024-10-10 19:10:34 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:59 +0100 |
| commit | [20502f0b3f3acd6bee300257556c27a867f80c8b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20502f0b3f3acd6bee300257556c27a867f80c8b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=20502f0b3f3acd6bee300257556c27a867f80c8b)) | |
| tree | [3b61f46dcb5c5be64e37e56467e5e1636e446c6e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20502f0b3f3acd6bee300257556c27a867f80c8b) | |
| parent | [147c97ea836016470156832a5658587c8501c725](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=147c97ea836016470156832a5658587c8501c725) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20502f0b3f3acd6bee300257556c27a867f80c8b&id2=147c97ea836016470156832a5658587c8501c725)) | |
| download | [linux-20502f0b3f3acd6bee300257556c27a867f80c8b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-20502f0b3f3acd6bee300257556c27a867f80c8b.tar.gz) | |

PCI: Fix use-after-free of slot->bus on hot removecommit c7acef99642b763ba585f4a43af999fcdbcc3dc4 upstream.
Dennis reports a boot crash on recent Lenovo laptops with a USB4 dock.
Since commit 0fc70886569c ("thunderbolt: Reset USB4 v2 host router") and
commit 59a54c5f3dbd ("thunderbolt: Reset topology created by the boot
firmware"), USB4 v2 and v1 Host Routers are reset on probe of the
thunderbolt driver.
The reset clears the Presence Detect State and Data Link Layer Link Active
bits at the USB4 Host Router's Root Port and thus causes hot removal of the
dock.
The crash occurs when pciehp is unbound from one of the dock's Downstream
Ports: pciehp creates a pci\_slot on bind and destroys it on unbind. The
pci\_slot contains a pointer to the pci\_bus below the Downstream Port, but
a reference on that pci\_bus is never acquired. The pci\_bus is destroyed
before the pci\_slot, so a use-after-free ensues when pci\_slot\_release()
accesses slot->bus.
In principle this should not happen because pci\_stop\_bus\_device() unbinds
pciehp (and therefore destroys the pci\_slot) before the pci\_bus is
destroyed by pci\_remove\_bus\_device().
However the stacktrace provided by Dennis shows that pciehp is unbound from
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). To understand
the significance of this, one needs to know that the PCI core uses a two
step process to remove a portion of the hierarchy: It first unbinds all
drivers in the sub-hierarchy in pci\_stop\_bus\_device() and then actually
removes the devices in pci\_remove\_bus\_device(). There is no precaution to
prevent driver binding in-between pci\_stop\_bus\_device() and
pci\_remove\_bus\_device().
In Dennis' case, it seems removal of the hierarchy by pciehp races with
driver binding by pci\_bus\_add\_devices(). pciehp is bound to the
Downstream Port after pci\_stop\_bus\_device() has run, so it is unbound by
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). Because the
pci\_bus has already been destroyed at that point, accesses to it result in
a use-after-free.
One might conclude that driver binding needs to be prevented after
pci\_stop\_bus\_device() has run. However it seems risky that pci\_slot points
to pci\_bus without holding a reference. Solely relying on correct ordering
of driver unbind versus pci\_bus destruction is certainly not defensive
programming.
If pci\_slot has a need to access data in pci\_bus, it ought to acquire a
reference. Amend pci\_create\_slot() accordingly. Dennis reports that the
crash is not reproducible with this change.
Abridged stacktrace:
pcieport 0000:00:07.0: PME: Signaling with IRQ 156
pcieport 0000:00:07.0: pciehp: Slot #12 AttnBtn- PwrCtrl- MRL- AttnInd- PwrInd- HotPlug+ Surprise+ Interlock- NoCompl+ IbPresDis- LLActRep+
pci\_bus 0000:20: dev 00, created physical slot 12
pcieport 0000:00:07.0: pciehp: Slot(12): Card not present
...
pcieport 0000:21:02.0: pciehp: pcie\_disable\_notification: SLOTCTRL d8 write cmd 0
Oops: general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b6b: 0000 [#1] PREEMPT SMP NOPTI
CPU: 13 UID: 0 PID: 134 Comm: irq/156-pciehp Not tainted 6.11.0-devel+ #1
RIP: 0010:dev\_driver\_string+0x12/0x40
pci\_destroy\_slot
pciehp\_remove
pcie\_port\_remove\_service
device\_release\_driver\_internal
bus\_remove\_device
device\_del
device\_unregister
remove\_iter
device\_for\_each\_child
pcie\_portdrv\_remove
pci\_device\_remove
device\_release\_driver\_internal
bus\_remove\_device
device\_del
pci\_remove\_bus\_device (recursive invocation)
pci\_remove\_bus\_device
pciehp\_unconfigure\_device
pciehp\_disable\_slot
pciehp\_handle\_presence\_or\_link\_change
pciehp\_ist
Link: [https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas@wunner.de](https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas%40wunner.de)
Reported-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Closes: https://lore.kernel.org/r/6de4b45ff2b32dd91a805ec02ec8ec73ef411bf6.camel@secunet.com/
Tested-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20502f0b3f3acd6bee300257556c27a867f80c8b)

| -rw-r--r-- | [drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/slot.c?id=20502f0b3f3acd6bee300257556c27a867f80c8b) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/pci/slot.c b/drivers/pci/slot.cindex a0c67191a8b926..7f4bcf359b9174 100644--- a/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=147c97ea836016470156832a5658587c8501c725)+++ b/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=20502f0b3f3acd6bee300257556c27a867f80c8b)@@ -79,6 +79,7 @@ static void pci\_slot\_release(struct kobject \*kobj) up\_read(&pci\_bus\_sem);  list\_del(&slot->list);+ pci\_bus\_put(slot->bus);  kfree(slot); }@@ -261,7 +262,7 @@ placeholder: goto err; } - slot->bus = parent;+ slot->bus = pci\_bus\_get(parent); slot->number = slot\_nr;  slot->kobj.kset = pci\_slots\_kset;@@ -269,6 +270,7 @@ placeholder: slot\_name = make\_slot\_name(name); if (!slot\_name) { err = -ENOMEM;+ pci\_bus\_put(slot->bus); kfree(slot); goto err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:49:16 +0000



=== Content from git.kernel.org_4fb09996_20250114_225048.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2024-10-10 19:10:34 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:08 +0100 |
| commit | [da6e6ff1f6c57f16e07af955e0e997fc90dd1e75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75)) | |
| tree | [792eea19879463a0d493f1403005bf159fe0ccb9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75) | |
| parent | [5442dbd3342a9069790c9edf68a6859557a6855b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5442dbd3342a9069790c9edf68a6859557a6855b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75&id2=5442dbd3342a9069790c9edf68a6859557a6855b)) | |
| download | [linux-da6e6ff1f6c57f16e07af955e0e997fc90dd1e75.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-da6e6ff1f6c57f16e07af955e0e997fc90dd1e75.tar.gz) | |

PCI: Fix use-after-free of slot->bus on hot removecommit c7acef99642b763ba585f4a43af999fcdbcc3dc4 upstream.
Dennis reports a boot crash on recent Lenovo laptops with a USB4 dock.
Since commit 0fc70886569c ("thunderbolt: Reset USB4 v2 host router") and
commit 59a54c5f3dbd ("thunderbolt: Reset topology created by the boot
firmware"), USB4 v2 and v1 Host Routers are reset on probe of the
thunderbolt driver.
The reset clears the Presence Detect State and Data Link Layer Link Active
bits at the USB4 Host Router's Root Port and thus causes hot removal of the
dock.
The crash occurs when pciehp is unbound from one of the dock's Downstream
Ports: pciehp creates a pci\_slot on bind and destroys it on unbind. The
pci\_slot contains a pointer to the pci\_bus below the Downstream Port, but
a reference on that pci\_bus is never acquired. The pci\_bus is destroyed
before the pci\_slot, so a use-after-free ensues when pci\_slot\_release()
accesses slot->bus.
In principle this should not happen because pci\_stop\_bus\_device() unbinds
pciehp (and therefore destroys the pci\_slot) before the pci\_bus is
destroyed by pci\_remove\_bus\_device().
However the stacktrace provided by Dennis shows that pciehp is unbound from
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). To understand
the significance of this, one needs to know that the PCI core uses a two
step process to remove a portion of the hierarchy: It first unbinds all
drivers in the sub-hierarchy in pci\_stop\_bus\_device() and then actually
removes the devices in pci\_remove\_bus\_device(). There is no precaution to
prevent driver binding in-between pci\_stop\_bus\_device() and
pci\_remove\_bus\_device().
In Dennis' case, it seems removal of the hierarchy by pciehp races with
driver binding by pci\_bus\_add\_devices(). pciehp is bound to the
Downstream Port after pci\_stop\_bus\_device() has run, so it is unbound by
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). Because the
pci\_bus has already been destroyed at that point, accesses to it result in
a use-after-free.
One might conclude that driver binding needs to be prevented after
pci\_stop\_bus\_device() has run. However it seems risky that pci\_slot points
to pci\_bus without holding a reference. Solely relying on correct ordering
of driver unbind versus pci\_bus destruction is certainly not defensive
programming.
If pci\_slot has a need to access data in pci\_bus, it ought to acquire a
reference. Amend pci\_create\_slot() accordingly. Dennis reports that the
crash is not reproducible with this change.
Abridged stacktrace:
pcieport 0000:00:07.0: PME: Signaling with IRQ 156
pcieport 0000:00:07.0: pciehp: Slot #12 AttnBtn- PwrCtrl- MRL- AttnInd- PwrInd- HotPlug+ Surprise+ Interlock- NoCompl+ IbPresDis- LLActRep+
pci\_bus 0000:20: dev 00, created physical slot 12
pcieport 0000:00:07.0: pciehp: Slot(12): Card not present
...
pcieport 0000:21:02.0: pciehp: pcie\_disable\_notification: SLOTCTRL d8 write cmd 0
Oops: general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b6b: 0000 [#1] PREEMPT SMP NOPTI
CPU: 13 UID: 0 PID: 134 Comm: irq/156-pciehp Not tainted 6.11.0-devel+ #1
RIP: 0010:dev\_driver\_string+0x12/0x40
pci\_destroy\_slot
pciehp\_remove
pcie\_port\_remove\_service
device\_release\_driver\_internal
bus\_remove\_device
device\_del
device\_unregister
remove\_iter
device\_for\_each\_child
pcie\_portdrv\_remove
pci\_device\_remove
device\_release\_driver\_internal
bus\_remove\_device
device\_del
pci\_remove\_bus\_device (recursive invocation)
pci\_remove\_bus\_device
pciehp\_unconfigure\_device
pciehp\_disable\_slot
pciehp\_handle\_presence\_or\_link\_change
pciehp\_ist
Link: [https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas@wunner.de](https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas%40wunner.de)
Reported-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Closes: https://lore.kernel.org/r/6de4b45ff2b32dd91a805ec02ec8ec73ef411bf6.camel@secunet.com/
Tested-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75)

| -rw-r--r-- | [drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/slot.c?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/pci/slot.c b/drivers/pci/slot.cindex ed2077e7470aef..a42e2cf774fd89 100644--- a/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=5442dbd3342a9069790c9edf68a6859557a6855b)+++ b/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=da6e6ff1f6c57f16e07af955e0e997fc90dd1e75)@@ -79,6 +79,7 @@ static void pci\_slot\_release(struct kobject \*kobj) up\_read(&pci\_bus\_sem);  list\_del(&slot->list);+ pci\_bus\_put(slot->bus);  kfree(slot); }@@ -260,7 +261,7 @@ placeholder: goto err; } - slot->bus = parent;+ slot->bus = pci\_bus\_get(parent); slot->number = slot\_nr;  slot->kobj.kset = pci\_slots\_kset;@@ -268,6 +269,7 @@ placeholder: slot\_name = make\_slot\_name(name); if (!slot\_name) { err = -ENOMEM;+ pci\_bus\_put(slot->bus); kfree(slot); goto err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:49:25 +0000



=== Content from git.kernel.org_01719e37_20250114_225047.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d0ddd2c92b75a19a37c887154223372b600fed37)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0ddd2c92b75a19a37c887154223372b600fed37)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0ddd2c92b75a19a37c887154223372b600fed37)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0ddd2c92b75a19a37c887154223372b600fed37)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2024-10-10 19:10:34 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:36 +0100 |
| commit | [d0ddd2c92b75a19a37c887154223372b600fed37](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0ddd2c92b75a19a37c887154223372b600fed37) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d0ddd2c92b75a19a37c887154223372b600fed37)) | |
| tree | [1d94d30527912788454457dea9dab07bf3a71165](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0ddd2c92b75a19a37c887154223372b600fed37) | |
| parent | [02ca7b602784f0dbf55a4ba365a285f48f3f3ca8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02ca7b602784f0dbf55a4ba365a285f48f3f3ca8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0ddd2c92b75a19a37c887154223372b600fed37&id2=02ca7b602784f0dbf55a4ba365a285f48f3f3ca8)) | |
| download | [linux-d0ddd2c92b75a19a37c887154223372b600fed37.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d0ddd2c92b75a19a37c887154223372b600fed37.tar.gz) | |

PCI: Fix use-after-free of slot->bus on hot removecommit c7acef99642b763ba585f4a43af999fcdbcc3dc4 upstream.
Dennis reports a boot crash on recent Lenovo laptops with a USB4 dock.
Since commit 0fc70886569c ("thunderbolt: Reset USB4 v2 host router") and
commit 59a54c5f3dbd ("thunderbolt: Reset topology created by the boot
firmware"), USB4 v2 and v1 Host Routers are reset on probe of the
thunderbolt driver.
The reset clears the Presence Detect State and Data Link Layer Link Active
bits at the USB4 Host Router's Root Port and thus causes hot removal of the
dock.
The crash occurs when pciehp is unbound from one of the dock's Downstream
Ports: pciehp creates a pci\_slot on bind and destroys it on unbind. The
pci\_slot contains a pointer to the pci\_bus below the Downstream Port, but
a reference on that pci\_bus is never acquired. The pci\_bus is destroyed
before the pci\_slot, so a use-after-free ensues when pci\_slot\_release()
accesses slot->bus.
In principle this should not happen because pci\_stop\_bus\_device() unbinds
pciehp (and therefore destroys the pci\_slot) before the pci\_bus is
destroyed by pci\_remove\_bus\_device().
However the stacktrace provided by Dennis shows that pciehp is unbound from
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). To understand
the significance of this, one needs to know that the PCI core uses a two
step process to remove a portion of the hierarchy: It first unbinds all
drivers in the sub-hierarchy in pci\_stop\_bus\_device() and then actually
removes the devices in pci\_remove\_bus\_device(). There is no precaution to
prevent driver binding in-between pci\_stop\_bus\_device() and
pci\_remove\_bus\_device().
In Dennis' case, it seems removal of the hierarchy by pciehp races with
driver binding by pci\_bus\_add\_devices(). pciehp is bound to the
Downstream Port after pci\_stop\_bus\_device() has run, so it is unbound by
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). Because the
pci\_bus has already been destroyed at that point, accesses to it result in
a use-after-free.
One might conclude that driver binding needs to be prevented after
pci\_stop\_bus\_device() has run. However it seems risky that pci\_slot points
to pci\_bus without holding a reference. Solely relying on correct ordering
of driver unbind versus pci\_bus destruction is certainly not defensive
programming.
If pci\_slot has a need to access data in pci\_bus, it ought to acquire a
reference. Amend pci\_create\_slot() accordingly. Dennis reports that the
crash is not reproducible with this change.
Abridged stacktrace:
pcieport 0000:00:07.0: PME: Signaling with IRQ 156
pcieport 0000:00:07.0: pciehp: Slot #12 AttnBtn- PwrCtrl- MRL- AttnInd- PwrInd- HotPlug+ Surprise+ Interlock- NoCompl+ IbPresDis- LLActRep+
pci\_bus 0000:20: dev 00, created physical slot 12
pcieport 0000:00:07.0: pciehp: Slot(12): Card not present
...
pcieport 0000:21:02.0: pciehp: pcie\_disable\_notification: SLOTCTRL d8 write cmd 0
Oops: general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b6b: 0000 [#1] PREEMPT SMP NOPTI
CPU: 13 UID: 0 PID: 134 Comm: irq/156-pciehp Not tainted 6.11.0-devel+ #1
RIP: 0010:dev\_driver\_string+0x12/0x40
pci\_destroy\_slot
pciehp\_remove
pcie\_port\_remove\_service
device\_release\_driver\_internal
bus\_remove\_device
device\_del
device\_unregister
remove\_iter
device\_for\_each\_child
pcie\_portdrv\_remove
pci\_device\_remove
device\_release\_driver\_internal
bus\_remove\_device
device\_del
pci\_remove\_bus\_device (recursive invocation)
pci\_remove\_bus\_device
pciehp\_unconfigure\_device
pciehp\_disable\_slot
pciehp\_handle\_presence\_or\_link\_change
pciehp\_ist
Link: [https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas@wunner.de](https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas%40wunner.de)
Reported-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Closes: https://lore.kernel.org/r/6de4b45ff2b32dd91a805ec02ec8ec73ef411bf6.camel@secunet.com/
Tested-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0ddd2c92b75a19a37c887154223372b600fed37)

| -rw-r--r-- | [drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/slot.c?id=d0ddd2c92b75a19a37c887154223372b600fed37) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/pci/slot.c b/drivers/pci/slot.cindex 1e3ed6ec0a4af0..3d7b9196da3e27 100644--- a/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=02ca7b602784f0dbf55a4ba365a285f48f3f3ca8)+++ b/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=d0ddd2c92b75a19a37c887154223372b600fed37)@@ -115,6 +115,7 @@ static void pci\_slot\_release(struct kobject \*kobj) up\_read(&pci\_bus\_sem);  list\_del(&slot->list);+ pci\_bus\_put(slot->bus);  kfree(slot); }@@ -296,7 +297,7 @@ placeholder: goto err; } - slot->bus = parent;+ slot->bus = pci\_bus\_get(parent); slot->number = slot\_nr;  slot->kobj.kset = pci\_slots\_kset;@@ -304,6 +305,7 @@ placeholder: slot\_name = make\_slot\_name(name); if (!slot\_name) { err = -ENOMEM;+ pci\_bus\_put(slot->bus); kfree(slot); goto err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:49:23 +0000



=== Content from git.kernel.org_a7df9c43_20250114_225040.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2024-10-10 19:10:34 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:13 +0100 |
| commit | [41bbb1eb996be1435815aa1fbcc9ffc45b84cc12](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12)) | |
| tree | [d27497ab4036feb76065f87a21aeadef4a005985](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12) | |
| parent | [227fde8a27f71a874963312fe854c807c13c27af](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=227fde8a27f71a874963312fe854c807c13c27af) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12&id2=227fde8a27f71a874963312fe854c807c13c27af)) | |
| download | [linux-41bbb1eb996be1435815aa1fbcc9ffc45b84cc12.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-41bbb1eb996be1435815aa1fbcc9ffc45b84cc12.tar.gz) | |

PCI: Fix use-after-free of slot->bus on hot removecommit c7acef99642b763ba585f4a43af999fcdbcc3dc4 upstream.
Dennis reports a boot crash on recent Lenovo laptops with a USB4 dock.
Since commit 0fc70886569c ("thunderbolt: Reset USB4 v2 host router") and
commit 59a54c5f3dbd ("thunderbolt: Reset topology created by the boot
firmware"), USB4 v2 and v1 Host Routers are reset on probe of the
thunderbolt driver.
The reset clears the Presence Detect State and Data Link Layer Link Active
bits at the USB4 Host Router's Root Port and thus causes hot removal of the
dock.
The crash occurs when pciehp is unbound from one of the dock's Downstream
Ports: pciehp creates a pci\_slot on bind and destroys it on unbind. The
pci\_slot contains a pointer to the pci\_bus below the Downstream Port, but
a reference on that pci\_bus is never acquired. The pci\_bus is destroyed
before the pci\_slot, so a use-after-free ensues when pci\_slot\_release()
accesses slot->bus.
In principle this should not happen because pci\_stop\_bus\_device() unbinds
pciehp (and therefore destroys the pci\_slot) before the pci\_bus is
destroyed by pci\_remove\_bus\_device().
However the stacktrace provided by Dennis shows that pciehp is unbound from
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). To understand
the significance of this, one needs to know that the PCI core uses a two
step process to remove a portion of the hierarchy: It first unbinds all
drivers in the sub-hierarchy in pci\_stop\_bus\_device() and then actually
removes the devices in pci\_remove\_bus\_device(). There is no precaution to
prevent driver binding in-between pci\_stop\_bus\_device() and
pci\_remove\_bus\_device().
In Dennis' case, it seems removal of the hierarchy by pciehp races with
driver binding by pci\_bus\_add\_devices(). pciehp is bound to the
Downstream Port after pci\_stop\_bus\_device() has run, so it is unbound by
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). Because the
pci\_bus has already been destroyed at that point, accesses to it result in
a use-after-free.
One might conclude that driver binding needs to be prevented after
pci\_stop\_bus\_device() has run. However it seems risky that pci\_slot points
to pci\_bus without holding a reference. Solely relying on correct ordering
of driver unbind versus pci\_bus destruction is certainly not defensive
programming.
If pci\_slot has a need to access data in pci\_bus, it ought to acquire a
reference. Amend pci\_create\_slot() accordingly. Dennis reports that the
crash is not reproducible with this change.
Abridged stacktrace:
pcieport 0000:00:07.0: PME: Signaling with IRQ 156
pcieport 0000:00:07.0: pciehp: Slot #12 AttnBtn- PwrCtrl- MRL- AttnInd- PwrInd- HotPlug+ Surprise+ Interlock- NoCompl+ IbPresDis- LLActRep+
pci\_bus 0000:20: dev 00, created physical slot 12
pcieport 0000:00:07.0: pciehp: Slot(12): Card not present
...
pcieport 0000:21:02.0: pciehp: pcie\_disable\_notification: SLOTCTRL d8 write cmd 0
Oops: general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b6b: 0000 [#1] PREEMPT SMP NOPTI
CPU: 13 UID: 0 PID: 134 Comm: irq/156-pciehp Not tainted 6.11.0-devel+ #1
RIP: 0010:dev\_driver\_string+0x12/0x40
pci\_destroy\_slot
pciehp\_remove
pcie\_port\_remove\_service
device\_release\_driver\_internal
bus\_remove\_device
device\_del
device\_unregister
remove\_iter
device\_for\_each\_child
pcie\_portdrv\_remove
pci\_device\_remove
device\_release\_driver\_internal
bus\_remove\_device
device\_del
pci\_remove\_bus\_device (recursive invocation)
pci\_remove\_bus\_device
pciehp\_unconfigure\_device
pciehp\_disable\_slot
pciehp\_handle\_presence\_or\_link\_change
pciehp\_ist
Link: [https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas@wunner.de](https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas%40wunner.de)
Reported-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Closes: https://lore.kernel.org/r/6de4b45ff2b32dd91a805ec02ec8ec73ef411bf6.camel@secunet.com/
Tested-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12)

| -rw-r--r-- | [drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/slot.c?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/pci/slot.c b/drivers/pci/slot.cindex 751a26668e3a4f..0e7c412c524784 100644--- a/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=227fde8a27f71a874963312fe854c807c13c27af)+++ b/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=41bbb1eb996be1435815aa1fbcc9ffc45b84cc12)@@ -79,6 +79,7 @@ static void pci\_slot\_release(struct kobject \*kobj) up\_read(&pci\_bus\_sem);  list\_del(&slot->list);+ pci\_bus\_put(slot->bus);  kfree(slot); }@@ -260,7 +261,7 @@ placeholder: goto err; } - slot->bus = parent;+ slot->bus = pci\_bus\_get(parent); slot->number = slot\_nr;  slot->kobj.kset = pci\_slots\_kset;@@ -268,6 +269,7 @@ placeholder: slot\_name = make\_slot\_name(name); if (!slot\_name) { err = -ENOMEM;+ pci\_bus\_put(slot->bus); kfree(slot); goto err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:49:17 +0000



=== Content from git.kernel.org_9cfc9d86_20250114_225045.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2024-10-10 19:10:34 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:10 +0100 |
| commit | [c8266ab8e7ccd1d1f5a9c8b29eb2020175048134](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134)) | |
| tree | [c2a25afbf5a9c17b5c7f3f2626dcf1b3cca7b8e4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134) | |
| parent | [c446afcef5f195764347e7c559e36fcf8a0187d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c446afcef5f195764347e7c559e36fcf8a0187d6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134&id2=c446afcef5f195764347e7c559e36fcf8a0187d6)) | |
| download | [linux-c8266ab8e7ccd1d1f5a9c8b29eb2020175048134.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c8266ab8e7ccd1d1f5a9c8b29eb2020175048134.tar.gz) | |

PCI: Fix use-after-free of slot->bus on hot removecommit c7acef99642b763ba585f4a43af999fcdbcc3dc4 upstream.
Dennis reports a boot crash on recent Lenovo laptops with a USB4 dock.
Since commit 0fc70886569c ("thunderbolt: Reset USB4 v2 host router") and
commit 59a54c5f3dbd ("thunderbolt: Reset topology created by the boot
firmware"), USB4 v2 and v1 Host Routers are reset on probe of the
thunderbolt driver.
The reset clears the Presence Detect State and Data Link Layer Link Active
bits at the USB4 Host Router's Root Port and thus causes hot removal of the
dock.
The crash occurs when pciehp is unbound from one of the dock's Downstream
Ports: pciehp creates a pci\_slot on bind and destroys it on unbind. The
pci\_slot contains a pointer to the pci\_bus below the Downstream Port, but
a reference on that pci\_bus is never acquired. The pci\_bus is destroyed
before the pci\_slot, so a use-after-free ensues when pci\_slot\_release()
accesses slot->bus.
In principle this should not happen because pci\_stop\_bus\_device() unbinds
pciehp (and therefore destroys the pci\_slot) before the pci\_bus is
destroyed by pci\_remove\_bus\_device().
However the stacktrace provided by Dennis shows that pciehp is unbound from
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). To understand
the significance of this, one needs to know that the PCI core uses a two
step process to remove a portion of the hierarchy: It first unbinds all
drivers in the sub-hierarchy in pci\_stop\_bus\_device() and then actually
removes the devices in pci\_remove\_bus\_device(). There is no precaution to
prevent driver binding in-between pci\_stop\_bus\_device() and
pci\_remove\_bus\_device().
In Dennis' case, it seems removal of the hierarchy by pciehp races with
driver binding by pci\_bus\_add\_devices(). pciehp is bound to the
Downstream Port after pci\_stop\_bus\_device() has run, so it is unbound by
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). Because the
pci\_bus has already been destroyed at that point, accesses to it result in
a use-after-free.
One might conclude that driver binding needs to be prevented after
pci\_stop\_bus\_device() has run. However it seems risky that pci\_slot points
to pci\_bus without holding a reference. Solely relying on correct ordering
of driver unbind versus pci\_bus destruction is certainly not defensive
programming.
If pci\_slot has a need to access data in pci\_bus, it ought to acquire a
reference. Amend pci\_create\_slot() accordingly. Dennis reports that the
crash is not reproducible with this change.
Abridged stacktrace:
pcieport 0000:00:07.0: PME: Signaling with IRQ 156
pcieport 0000:00:07.0: pciehp: Slot #12 AttnBtn- PwrCtrl- MRL- AttnInd- PwrInd- HotPlug+ Surprise+ Interlock- NoCompl+ IbPresDis- LLActRep+
pci\_bus 0000:20: dev 00, created physical slot 12
pcieport 0000:00:07.0: pciehp: Slot(12): Card not present
...
pcieport 0000:21:02.0: pciehp: pcie\_disable\_notification: SLOTCTRL d8 write cmd 0
Oops: general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b6b: 0000 [#1] PREEMPT SMP NOPTI
CPU: 13 UID: 0 PID: 134 Comm: irq/156-pciehp Not tainted 6.11.0-devel+ #1
RIP: 0010:dev\_driver\_string+0x12/0x40
pci\_destroy\_slot
pciehp\_remove
pcie\_port\_remove\_service
device\_release\_driver\_internal
bus\_remove\_device
device\_del
device\_unregister
remove\_iter
device\_for\_each\_child
pcie\_portdrv\_remove
pci\_device\_remove
device\_release\_driver\_internal
bus\_remove\_device
device\_del
pci\_remove\_bus\_device (recursive invocation)
pci\_remove\_bus\_device
pciehp\_unconfigure\_device
pciehp\_disable\_slot
pciehp\_handle\_presence\_or\_link\_change
pciehp\_ist
Link: [https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas@wunner.de](https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas%40wunner.de)
Reported-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Closes: https://lore.kernel.org/r/6de4b45ff2b32dd91a805ec02ec8ec73ef411bf6.camel@secunet.com/
Tested-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134)

| -rw-r--r-- | [drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/slot.c?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/pci/slot.c b/drivers/pci/slot.cindex 0f87cade10f74b..ed645c7a4e4b41 100644--- a/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=c446afcef5f195764347e7c559e36fcf8a0187d6)+++ b/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=c8266ab8e7ccd1d1f5a9c8b29eb2020175048134)@@ -79,6 +79,7 @@ static void pci\_slot\_release(struct kobject \*kobj) up\_read(&pci\_bus\_sem);  list\_del(&slot->list);+ pci\_bus\_put(slot->bus);  kfree(slot); }@@ -261,7 +262,7 @@ placeholder: goto err; } - slot->bus = parent;+ slot->bus = pci\_bus\_get(parent); slot->number = slot\_nr;  slot->kobj.kset = pci\_slots\_kset;@@ -269,6 +270,7 @@ placeholder: slot\_name = make\_slot\_name(name); if (!slot\_name) { err = -ENOMEM;+ pci\_bus\_put(slot->bus); kfree(slot); goto err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:49:22 +0000



=== Content from git.kernel.org_69857753_20250114_225050.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2024-10-10 19:10:34 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:44 +0100 |
| commit | [e5d5c04aac71bf1476dc44b56f2206a4c2facca8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8)) | |
| tree | [11c80855f7213b1b4d1fd02c456e4719b86d4372](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8) | |
| parent | [7484289822c5e705273c0a8c7fe611cea2a42583](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7484289822c5e705273c0a8c7fe611cea2a42583) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8&id2=7484289822c5e705273c0a8c7fe611cea2a42583)) | |
| download | [linux-e5d5c04aac71bf1476dc44b56f2206a4c2facca8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e5d5c04aac71bf1476dc44b56f2206a4c2facca8.tar.gz) | |

PCI: Fix use-after-free of slot->bus on hot removecommit c7acef99642b763ba585f4a43af999fcdbcc3dc4 upstream.
Dennis reports a boot crash on recent Lenovo laptops with a USB4 dock.
Since commit 0fc70886569c ("thunderbolt: Reset USB4 v2 host router") and
commit 59a54c5f3dbd ("thunderbolt: Reset topology created by the boot
firmware"), USB4 v2 and v1 Host Routers are reset on probe of the
thunderbolt driver.
The reset clears the Presence Detect State and Data Link Layer Link Active
bits at the USB4 Host Router's Root Port and thus causes hot removal of the
dock.
The crash occurs when pciehp is unbound from one of the dock's Downstream
Ports: pciehp creates a pci\_slot on bind and destroys it on unbind. The
pci\_slot contains a pointer to the pci\_bus below the Downstream Port, but
a reference on that pci\_bus is never acquired. The pci\_bus is destroyed
before the pci\_slot, so a use-after-free ensues when pci\_slot\_release()
accesses slot->bus.
In principle this should not happen because pci\_stop\_bus\_device() unbinds
pciehp (and therefore destroys the pci\_slot) before the pci\_bus is
destroyed by pci\_remove\_bus\_device().
However the stacktrace provided by Dennis shows that pciehp is unbound from
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). To understand
the significance of this, one needs to know that the PCI core uses a two
step process to remove a portion of the hierarchy: It first unbinds all
drivers in the sub-hierarchy in pci\_stop\_bus\_device() and then actually
removes the devices in pci\_remove\_bus\_device(). There is no precaution to
prevent driver binding in-between pci\_stop\_bus\_device() and
pci\_remove\_bus\_device().
In Dennis' case, it seems removal of the hierarchy by pciehp races with
driver binding by pci\_bus\_add\_devices(). pciehp is bound to the
Downstream Port after pci\_stop\_bus\_device() has run, so it is unbound by
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). Because the
pci\_bus has already been destroyed at that point, accesses to it result in
a use-after-free.
One might conclude that driver binding needs to be prevented after
pci\_stop\_bus\_device() has run. However it seems risky that pci\_slot points
to pci\_bus without holding a reference. Solely relying on correct ordering
of driver unbind versus pci\_bus destruction is certainly not defensive
programming.
If pci\_slot has a need to access data in pci\_bus, it ought to acquire a
reference. Amend pci\_create\_slot() accordingly. Dennis reports that the
crash is not reproducible with this change.
Abridged stacktrace:
pcieport 0000:00:07.0: PME: Signaling with IRQ 156
pcieport 0000:00:07.0: pciehp: Slot #12 AttnBtn- PwrCtrl- MRL- AttnInd- PwrInd- HotPlug+ Surprise+ Interlock- NoCompl+ IbPresDis- LLActRep+
pci\_bus 0000:20: dev 00, created physical slot 12
pcieport 0000:00:07.0: pciehp: Slot(12): Card not present
...
pcieport 0000:21:02.0: pciehp: pcie\_disable\_notification: SLOTCTRL d8 write cmd 0
Oops: general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b6b: 0000 [#1] PREEMPT SMP NOPTI
CPU: 13 UID: 0 PID: 134 Comm: irq/156-pciehp Not tainted 6.11.0-devel+ #1
RIP: 0010:dev\_driver\_string+0x12/0x40
pci\_destroy\_slot
pciehp\_remove
pcie\_port\_remove\_service
device\_release\_driver\_internal
bus\_remove\_device
device\_del
device\_unregister
remove\_iter
device\_for\_each\_child
pcie\_portdrv\_remove
pci\_device\_remove
device\_release\_driver\_internal
bus\_remove\_device
device\_del
pci\_remove\_bus\_device (recursive invocation)
pci\_remove\_bus\_device
pciehp\_unconfigure\_device
pciehp\_disable\_slot
pciehp\_handle\_presence\_or\_link\_change
pciehp\_ist
Link: [https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas@wunner.de](https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas%40wunner.de)
Reported-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Closes: https://lore.kernel.org/r/6de4b45ff2b32dd91a805ec02ec8ec73ef411bf6.camel@secunet.com/
Tested-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8)

| -rw-r--r-- | [drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/slot.c?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/pci/slot.c b/drivers/pci/slot.cindex 0f87cade10f74b..ed645c7a4e4b41 100644--- a/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=7484289822c5e705273c0a8c7fe611cea2a42583)+++ b/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=e5d5c04aac71bf1476dc44b56f2206a4c2facca8)@@ -79,6 +79,7 @@ static void pci\_slot\_release(struct kobject \*kobj) up\_read(&pci\_bus\_sem);  list\_del(&slot->list);+ pci\_bus\_put(slot->bus);  kfree(slot); }@@ -261,7 +262,7 @@ placeholder: goto err; } - slot->bus = parent;+ slot->bus = pci\_bus\_get(parent); slot->number = slot\_nr;  slot->kobj.kset = pci\_slots\_kset;@@ -269,6 +270,7 @@ placeholder: slot\_name = make\_slot\_name(name); if (!slot\_name) { err = -ENOMEM;+ pci\_bus\_put(slot->bus); kfree(slot); goto err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:49:27 +0000



=== Content from git.kernel.org_63656cb3_20250114_225043.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2024-10-10 19:10:34 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:45 +0100 |
| commit | [69d2ceac11acf8579d58d55c9c5b65fb658f916e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e)) | |
| tree | [fe3b20adb135565bf15497756ceb9b2747b9b92b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e) | |
| parent | [e46d4caa776f08a9129a513c1dacbb930409755a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e46d4caa776f08a9129a513c1dacbb930409755a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e&id2=e46d4caa776f08a9129a513c1dacbb930409755a)) | |
| download | [linux-69d2ceac11acf8579d58d55c9c5b65fb658f916e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-69d2ceac11acf8579d58d55c9c5b65fb658f916e.tar.gz) | |

PCI: Fix use-after-free of slot->bus on hot removecommit c7acef99642b763ba585f4a43af999fcdbcc3dc4 upstream.
Dennis reports a boot crash on recent Lenovo laptops with a USB4 dock.
Since commit 0fc70886569c ("thunderbolt: Reset USB4 v2 host router") and
commit 59a54c5f3dbd ("thunderbolt: Reset topology created by the boot
firmware"), USB4 v2 and v1 Host Routers are reset on probe of the
thunderbolt driver.
The reset clears the Presence Detect State and Data Link Layer Link Active
bits at the USB4 Host Router's Root Port and thus causes hot removal of the
dock.
The crash occurs when pciehp is unbound from one of the dock's Downstream
Ports: pciehp creates a pci\_slot on bind and destroys it on unbind. The
pci\_slot contains a pointer to the pci\_bus below the Downstream Port, but
a reference on that pci\_bus is never acquired. The pci\_bus is destroyed
before the pci\_slot, so a use-after-free ensues when pci\_slot\_release()
accesses slot->bus.
In principle this should not happen because pci\_stop\_bus\_device() unbinds
pciehp (and therefore destroys the pci\_slot) before the pci\_bus is
destroyed by pci\_remove\_bus\_device().
However the stacktrace provided by Dennis shows that pciehp is unbound from
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). To understand
the significance of this, one needs to know that the PCI core uses a two
step process to remove a portion of the hierarchy: It first unbinds all
drivers in the sub-hierarchy in pci\_stop\_bus\_device() and then actually
removes the devices in pci\_remove\_bus\_device(). There is no precaution to
prevent driver binding in-between pci\_stop\_bus\_device() and
pci\_remove\_bus\_device().
In Dennis' case, it seems removal of the hierarchy by pciehp races with
driver binding by pci\_bus\_add\_devices(). pciehp is bound to the
Downstream Port after pci\_stop\_bus\_device() has run, so it is unbound by
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). Because the
pci\_bus has already been destroyed at that point, accesses to it result in
a use-after-free.
One might conclude that driver binding needs to be prevented after
pci\_stop\_bus\_device() has run. However it seems risky that pci\_slot points
to pci\_bus without holding a reference. Solely relying on correct ordering
of driver unbind versus pci\_bus destruction is certainly not defensive
programming.
If pci\_slot has a need to access data in pci\_bus, it ought to acquire a
reference. Amend pci\_create\_slot() accordingly. Dennis reports that the
crash is not reproducible with this change.
Abridged stacktrace:
pcieport 0000:00:07.0: PME: Signaling with IRQ 156
pcieport 0000:00:07.0: pciehp: Slot #12 AttnBtn- PwrCtrl- MRL- AttnInd- PwrInd- HotPlug+ Surprise+ Interlock- NoCompl+ IbPresDis- LLActRep+
pci\_bus 0000:20: dev 00, created physical slot 12
pcieport 0000:00:07.0: pciehp: Slot(12): Card not present
...
pcieport 0000:21:02.0: pciehp: pcie\_disable\_notification: SLOTCTRL d8 write cmd 0
Oops: general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b6b: 0000 [#1] PREEMPT SMP NOPTI
CPU: 13 UID: 0 PID: 134 Comm: irq/156-pciehp Not tainted 6.11.0-devel+ #1
RIP: 0010:dev\_driver\_string+0x12/0x40
pci\_destroy\_slot
pciehp\_remove
pcie\_port\_remove\_service
device\_release\_driver\_internal
bus\_remove\_device
device\_del
device\_unregister
remove\_iter
device\_for\_each\_child
pcie\_portdrv\_remove
pci\_device\_remove
device\_release\_driver\_internal
bus\_remove\_device
device\_del
pci\_remove\_bus\_device (recursive invocation)
pci\_remove\_bus\_device
pciehp\_unconfigure\_device
pciehp\_disable\_slot
pciehp\_handle\_presence\_or\_link\_change
pciehp\_ist
Link: [https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas@wunner.de](https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas%40wunner.de)
Reported-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Closes: https://lore.kernel.org/r/6de4b45ff2b32dd91a805ec02ec8ec73ef411bf6.camel@secunet.com/
Tested-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e)

| -rw-r--r-- | [drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/slot.c?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/pci/slot.c b/drivers/pci/slot.cindex 0f87cade10f74b..ed645c7a4e4b41 100644--- a/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=e46d4caa776f08a9129a513c1dacbb930409755a)+++ b/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=69d2ceac11acf8579d58d55c9c5b65fb658f916e)@@ -79,6 +79,7 @@ static void pci\_slot\_release(struct kobject \*kobj) up\_read(&pci\_bus\_sem);  list\_del(&slot->list);+ pci\_bus\_put(slot->bus);  kfree(slot); }@@ -261,7 +262,7 @@ placeholder: goto err; } - slot->bus = parent;+ slot->bus = pci\_bus\_get(parent); slot->number = slot\_nr;  slot->kobj.kset = pci\_slots\_kset;@@ -269,6 +270,7 @@ placeholder: slot\_name = make\_slot\_name(name); if (!slot\_name) { err = -ENOMEM;+ pci\_bus\_put(slot->bus); kfree(slot); goto err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:49:20 +0000



=== Content from git.kernel.org_5a2cdc41_20250114_225042.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=50473dd3b2a08601a078f852ea05572de9b1f86c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50473dd3b2a08601a078f852ea05572de9b1f86c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50473dd3b2a08601a078f852ea05572de9b1f86c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50473dd3b2a08601a078f852ea05572de9b1f86c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2024-10-10 19:10:34 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:39 +0100 |
| commit | [50473dd3b2a08601a078f852ea05572de9b1f86c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50473dd3b2a08601a078f852ea05572de9b1f86c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=50473dd3b2a08601a078f852ea05572de9b1f86c)) | |
| tree | [1aa5c2e2c35c282cc42d6c9d700922f24af3aa1f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50473dd3b2a08601a078f852ea05572de9b1f86c) | |
| parent | [4c41ea1f8d00b80f9d0ae4d9fa05f4c136770cfd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c41ea1f8d00b80f9d0ae4d9fa05f4c136770cfd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50473dd3b2a08601a078f852ea05572de9b1f86c&id2=4c41ea1f8d00b80f9d0ae4d9fa05f4c136770cfd)) | |
| download | [linux-50473dd3b2a08601a078f852ea05572de9b1f86c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-50473dd3b2a08601a078f852ea05572de9b1f86c.tar.gz) | |

PCI: Fix use-after-free of slot->bus on hot removecommit c7acef99642b763ba585f4a43af999fcdbcc3dc4 upstream.
Dennis reports a boot crash on recent Lenovo laptops with a USB4 dock.
Since commit 0fc70886569c ("thunderbolt: Reset USB4 v2 host router") and
commit 59a54c5f3dbd ("thunderbolt: Reset topology created by the boot
firmware"), USB4 v2 and v1 Host Routers are reset on probe of the
thunderbolt driver.
The reset clears the Presence Detect State and Data Link Layer Link Active
bits at the USB4 Host Router's Root Port and thus causes hot removal of the
dock.
The crash occurs when pciehp is unbound from one of the dock's Downstream
Ports: pciehp creates a pci\_slot on bind and destroys it on unbind. The
pci\_slot contains a pointer to the pci\_bus below the Downstream Port, but
a reference on that pci\_bus is never acquired. The pci\_bus is destroyed
before the pci\_slot, so a use-after-free ensues when pci\_slot\_release()
accesses slot->bus.
In principle this should not happen because pci\_stop\_bus\_device() unbinds
pciehp (and therefore destroys the pci\_slot) before the pci\_bus is
destroyed by pci\_remove\_bus\_device().
However the stacktrace provided by Dennis shows that pciehp is unbound from
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). To understand
the significance of this, one needs to know that the PCI core uses a two
step process to remove a portion of the hierarchy: It first unbinds all
drivers in the sub-hierarchy in pci\_stop\_bus\_device() and then actually
removes the devices in pci\_remove\_bus\_device(). There is no precaution to
prevent driver binding in-between pci\_stop\_bus\_device() and
pci\_remove\_bus\_device().
In Dennis' case, it seems removal of the hierarchy by pciehp races with
driver binding by pci\_bus\_add\_devices(). pciehp is bound to the
Downstream Port after pci\_stop\_bus\_device() has run, so it is unbound by
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). Because the
pci\_bus has already been destroyed at that point, accesses to it result in
a use-after-free.
One might conclude that driver binding needs to be prevented after
pci\_stop\_bus\_device() has run. However it seems risky that pci\_slot points
to pci\_bus without holding a reference. Solely relying on correct ordering
of driver unbind versus pci\_bus destruction is certainly not defensive
programming.
If pci\_slot has a need to access data in pci\_bus, it ought to acquire a
reference. Amend pci\_create\_slot() accordingly. Dennis reports that the
crash is not reproducible with this change.
Abridged stacktrace:
pcieport 0000:00:07.0: PME: Signaling with IRQ 156
pcieport 0000:00:07.0: pciehp: Slot #12 AttnBtn- PwrCtrl- MRL- AttnInd- PwrInd- HotPlug+ Surprise+ Interlock- NoCompl+ IbPresDis- LLActRep+
pci\_bus 0000:20: dev 00, created physical slot 12
pcieport 0000:00:07.0: pciehp: Slot(12): Card not present
...
pcieport 0000:21:02.0: pciehp: pcie\_disable\_notification: SLOTCTRL d8 write cmd 0
Oops: general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b6b: 0000 [#1] PREEMPT SMP NOPTI
CPU: 13 UID: 0 PID: 134 Comm: irq/156-pciehp Not tainted 6.11.0-devel+ #1
RIP: 0010:dev\_driver\_string+0x12/0x40
pci\_destroy\_slot
pciehp\_remove
pcie\_port\_remove\_service
device\_release\_driver\_internal
bus\_remove\_device
device\_del
device\_unregister
remove\_iter
device\_for\_each\_child
pcie\_portdrv\_remove
pci\_device\_remove
device\_release\_driver\_internal
bus\_remove\_device
device\_del
pci\_remove\_bus\_device (recursive invocation)
pci\_remove\_bus\_device
pciehp\_unconfigure\_device
pciehp\_disable\_slot
pciehp\_handle\_presence\_or\_link\_change
pciehp\_ist
Link: [https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas@wunner.de](https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas%40wunner.de)
Reported-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Closes: https://lore.kernel.org/r/6de4b45ff2b32dd91a805ec02ec8ec73ef411bf6.camel@secunet.com/
Tested-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50473dd3b2a08601a078f852ea05572de9b1f86c)

| -rw-r--r-- | [drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/slot.c?id=50473dd3b2a08601a078f852ea05572de9b1f86c) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/pci/slot.c b/drivers/pci/slot.cindex d575583e49c2cb..98f23eddc126c4 100644--- a/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=4c41ea1f8d00b80f9d0ae4d9fa05f4c136770cfd)+++ b/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=50473dd3b2a08601a078f852ea05572de9b1f86c)@@ -115,6 +115,7 @@ static void pci\_slot\_release(struct kobject \*kobj) up\_read(&pci\_bus\_sem);  list\_del(&slot->list);+ pci\_bus\_put(slot->bus);  kfree(slot); }@@ -296,7 +297,7 @@ placeholder: goto err; } - slot->bus = parent;+ slot->bus = pci\_bus\_get(parent); slot->number = slot\_nr;  slot->kobj.kset = pci\_slots\_kset;@@ -304,6 +305,7 @@ placeholder: slot\_name = make\_slot\_name(name); if (!slot\_name) { err = -ENOMEM;+ pci\_bus\_put(slot->bus); kfree(slot); goto err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:49:19 +0000



=== Content from git.kernel.org_561e67fb_20250114_225044.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2024-10-10 19:10:34 +0200 |
| --- | --- | --- |
| committer | Bjorn Helgaas <bhelgaas@google.com> | 2024-10-30 16:33:33 -0500 |
| commit | [c7acef99642b763ba585f4a43af999fcdbcc3dc4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4)) | |
| tree | [2d68794e9639f013717c9e8ace43f78e779e5842](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4) | |
| parent | [5a02413a4586a7cfa10b7380377138e66db9df4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5a02413a4586a7cfa10b7380377138e66db9df4b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4&id2=5a02413a4586a7cfa10b7380377138e66db9df4b)) | |
| download | [linux-c7acef99642b763ba585f4a43af999fcdbcc3dc4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c7acef99642b763ba585f4a43af999fcdbcc3dc4.tar.gz) | |

PCI: Fix use-after-free of slot->bus on hot removeDennis reports a boot crash on recent Lenovo laptops with a USB4 dock.
Since commit 0fc70886569c ("thunderbolt: Reset USB4 v2 host router") and
commit 59a54c5f3dbd ("thunderbolt: Reset topology created by the boot
firmware"), USB4 v2 and v1 Host Routers are reset on probe of the
thunderbolt driver.
The reset clears the Presence Detect State and Data Link Layer Link Active
bits at the USB4 Host Router's Root Port and thus causes hot removal of the
dock.
The crash occurs when pciehp is unbound from one of the dock's Downstream
Ports: pciehp creates a pci\_slot on bind and destroys it on unbind. The
pci\_slot contains a pointer to the pci\_bus below the Downstream Port, but
a reference on that pci\_bus is never acquired. The pci\_bus is destroyed
before the pci\_slot, so a use-after-free ensues when pci\_slot\_release()
accesses slot->bus.
In principle this should not happen because pci\_stop\_bus\_device() unbinds
pciehp (and therefore destroys the pci\_slot) before the pci\_bus is
destroyed by pci\_remove\_bus\_device().
However the stacktrace provided by Dennis shows that pciehp is unbound from
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). To understand
the significance of this, one needs to know that the PCI core uses a two
step process to remove a portion of the hierarchy: It first unbinds all
drivers in the sub-hierarchy in pci\_stop\_bus\_device() and then actually
removes the devices in pci\_remove\_bus\_device(). There is no precaution to
prevent driver binding in-between pci\_stop\_bus\_device() and
pci\_remove\_bus\_device().
In Dennis' case, it seems removal of the hierarchy by pciehp races with
driver binding by pci\_bus\_add\_devices(). pciehp is bound to the
Downstream Port after pci\_stop\_bus\_device() has run, so it is unbound by
pci\_remove\_bus\_device() instead of pci\_stop\_bus\_device(). Because the
pci\_bus has already been destroyed at that point, accesses to it result in
a use-after-free.
One might conclude that driver binding needs to be prevented after
pci\_stop\_bus\_device() has run. However it seems risky that pci\_slot points
to pci\_bus without holding a reference. Solely relying on correct ordering
of driver unbind versus pci\_bus destruction is certainly not defensive
programming.
If pci\_slot has a need to access data in pci\_bus, it ought to acquire a
reference. Amend pci\_create\_slot() accordingly. Dennis reports that the
crash is not reproducible with this change.
Abridged stacktrace:
pcieport 0000:00:07.0: PME: Signaling with IRQ 156
pcieport 0000:00:07.0: pciehp: Slot #12 AttnBtn- PwrCtrl- MRL- AttnInd- PwrInd- HotPlug+ Surprise+ Interlock- NoCompl+ IbPresDis- LLActRep+
pci\_bus 0000:20: dev 00, created physical slot 12
pcieport 0000:00:07.0: pciehp: Slot(12): Card not present
...
pcieport 0000:21:02.0: pciehp: pcie\_disable\_notification: SLOTCTRL d8 write cmd 0
Oops: general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b6b: 0000 [#1] PREEMPT SMP NOPTI
CPU: 13 UID: 0 PID: 134 Comm: irq/156-pciehp Not tainted 6.11.0-devel+ #1
RIP: 0010:dev\_driver\_string+0x12/0x40
pci\_destroy\_slot
pciehp\_remove
pcie\_port\_remove\_service
device\_release\_driver\_internal
bus\_remove\_device
device\_del
device\_unregister
remove\_iter
device\_for\_each\_child
pcie\_portdrv\_remove
pci\_device\_remove
device\_release\_driver\_internal
bus\_remove\_device
device\_del
pci\_remove\_bus\_device (recursive invocation)
pci\_remove\_bus\_device
pciehp\_unconfigure\_device
pciehp\_disable\_slot
pciehp\_handle\_presence\_or\_link\_change
pciehp\_ist
Link: [https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas@wunner.de](https://lore.kernel.org/r/4bfd4c0e976c1776cd08e76603903b338cf25729.1728579288.git.lukas%40wunner.de)
Reported-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Closes: https://lore.kernel.org/r/6de4b45ff2b32dd91a805ec02ec8ec73ef411bf6.camel@secunet.com/
Tested-by: Dennis Wassenberg <Dennis.Wassenberg@secunet.com>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Cc: stable@vger.kernel.org
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4)

| -rw-r--r-- | [drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/slot.c?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/pci/slot.c b/drivers/pci/slot.cindex 0f87cade10f74b..ed645c7a4e4b41 100644--- a/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=5a02413a4586a7cfa10b7380377138e66db9df4b)+++ b/[drivers/pci/slot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/slot.c?id=c7acef99642b763ba585f4a43af999fcdbcc3dc4)@@ -79,6 +79,7 @@ static void pci\_slot\_release(struct kobject \*kobj) up\_read(&pci\_bus\_sem);  list\_del(&slot->list);+ pci\_bus\_put(slot->bus);  kfree(slot); }@@ -261,7 +262,7 @@ placeholder: goto err; } - slot->bus = parent;+ slot->bus = pci\_bus\_get(parent); slot->number = slot\_nr;  slot->kobj.kset = pci\_slots\_kset;@@ -269,6 +270,7 @@ placeholder: slot\_name = make\_slot\_name(name); if (!slot\_name) { err = -ENOMEM;+ pci\_bus\_put(slot->bus); kfree(slot); goto err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:49:21 +0000


