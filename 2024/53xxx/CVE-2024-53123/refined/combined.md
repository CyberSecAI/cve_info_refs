=== Content from git.kernel.org_7d887dd5_20250114_185309.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=955388e1d5d222c4101c596b536d41b91a8b212e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=955388e1d5d222c4101c596b536d41b91a8b212e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=955388e1d5d222c4101c596b536d41b91a8b212e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=955388e1d5d222c4101c596b536d41b91a8b212e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-11-08 11:58:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:39:47 +0100 |
| commit | [955388e1d5d222c4101c596b536d41b91a8b212e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=955388e1d5d222c4101c596b536d41b91a8b212e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=955388e1d5d222c4101c596b536d41b91a8b212e)) | |
| tree | [25cd1416785f35cea1f54c274762630f87e9fdb0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=955388e1d5d222c4101c596b536d41b91a8b212e) | |
| parent | [d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=955388e1d5d222c4101c596b536d41b91a8b212e&id2=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6)) | |
| download | [linux-955388e1d5d222c4101c596b536d41b91a8b212e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-955388e1d5d222c4101c596b536d41b91a8b212e.tar.gz) | |

mptcp: error out earlier on disconnect[ Upstream commit 581302298524e9d77c4c44ff5156a6cd112227ae ]
Eric reported a division by zero splat in the MPTCP protocol:
Oops: divide error: 0000 [#1] PREEMPT SMP KASAN PTI
CPU: 1 UID: 0 PID: 6094 Comm: syz-executor317 Not tainted
6.12.0-rc5-syzkaller-00291-g05b92660cdfe #0
Hardware name: Google Google Compute Engine/Google Compute Engine,
BIOS Google 09/13/2024
RIP: 0010:\_\_tcp\_select\_window+0x5b4/0x1310 net/ipv4/tcp\_output.c:3163
Code: f6 44 01 e3 89 df e8 9b 75 09 f8 44 39 f3 0f 8d 11 ff ff ff e8
0d 74 09 f8 45 89 f4 e9 04 ff ff ff e8 00 74 09 f8 44 89 f0 99 <f7> 7c
24 14 41 29 d6 45 89 f4 e9 ec fe ff ff e8 e8 73 09 f8 48 89
RSP: 0018:ffffc900041f7930 EFLAGS: 00010293
RAX: 0000000000017e67 RBX: 0000000000017e67 RCX: ffffffff8983314b
RDX: 0000000000000000 RSI: ffffffff898331b0 RDI: 0000000000000004
RBP: 00000000005d6000 R08: 0000000000000004 R09: 0000000000017e67
R10: 0000000000003e80 R11: 0000000000000000 R12: 0000000000003e80
R13: ffff888031d9b440 R14: 0000000000017e67 R15: 00000000002eb000
FS: 00007feb5d7f16c0(0000) GS:ffff8880b8700000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007feb5d8adbb8 CR3: 0000000074e4c000 CR4: 00000000003526f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
\_\_tcp\_cleanup\_rbuf+0x3e7/0x4b0 net/ipv4/tcp.c:1493
mptcp\_rcv\_space\_adjust net/mptcp/protocol.c:2085 [inline]
mptcp\_recvmsg+0x2156/0x2600 net/mptcp/protocol.c:2289
inet\_recvmsg+0x469/0x6a0 net/ipv4/af\_inet.c:885
sock\_recvmsg\_nosec net/socket.c:1051 [inline]
sock\_recvmsg+0x1b2/0x250 net/socket.c:1073
\_\_sys\_recvfrom+0x1a5/0x2e0 net/socket.c:2265
\_\_do\_sys\_recvfrom net/socket.c:2283 [inline]
\_\_se\_sys\_recvfrom net/socket.c:2279 [inline]
\_\_x64\_sys\_recvfrom+0xe0/0x1c0 net/socket.c:2279
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xcd/0x250 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7feb5d857559
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 51 18 00 00 90 48 89 f8 48
89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d
01 f0 ff ff 73 01 c3 48 c7 c1 b0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007feb5d7f1208 EFLAGS: 00000246 ORIG\_RAX: 000000000000002d
RAX: ffffffffffffffda RBX: 00007feb5d8e1318 RCX: 00007feb5d857559
RDX: 000000800000000e RSI: 0000000000000000 RDI: 0000000000000003
RBP: 00007feb5d8e1310 R08: 0000000000000000 R09: ffffffff81000000
R10: 0000000000000100 R11: 0000000000000246 R12: 00007feb5d8e131c
R13: 00007feb5d8ae074 R14: 000000800000000e R15: 00000000fffffdef
and provided a nice reproducer.
The root cause is the current bad handling of racing disconnect.
After the blamed commit below, sk\_wait\_data() can return (with
error) with the underlying socket disconnected and a zero rcv\_mss.
Catch the error and return without performing any additional
operations on the current socket.
Reported-by: Eric Dumazet <edumazet@google.com>
Fixes: 419ce133ab92 ("tcp: allow again tcp\_disconnect() when threads are waiting")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/8c82ecf71662ecbc47bf390f9905de70884c9f2d.1731060874.git.pabeni@redhat.com](https://patch.msgid.link/8c82ecf71662ecbc47bf390f9905de70884c9f2d.1731060874.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=955388e1d5d222c4101c596b536d41b91a8b212e)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=955388e1d5d222c4101c596b536d41b91a8b212e) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex ec87b36f0d451a..f3e54c836ba565 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=955388e1d5d222c4101c596b536d41b91a8b212e)@@ -2205,7 +2205,7 @@ static int mptcp\_recvmsg(struct sock \*sk, struct msghdr \*msg, size\_t len, cmsg\_flags = MPTCP\_CMSG\_INQ;  while (copied < len) {- int bytes\_read;+ int err, bytes\_read;  bytes\_read = \_\_mptcp\_recvmsg\_mskq(msk, msg, len - copied, flags, &tss, &cmsg\_flags); if (unlikely(bytes\_read < 0)) {@@ -2267,9 +2267,16 @@ static int mptcp\_recvmsg(struct sock \*sk, struct msghdr \*msg, size\_t len, }  pr\_debug("block timeout %ld\n", timeo);- sk\_wait\_data(sk, &timeo, NULL);+ mptcp\_rcv\_space\_adjust(msk, copied);+ err = sk\_wait\_data(sk, &timeo, NULL);+ if (err < 0) {+ err = copied ? : err;+ goto out\_err;+ } } + mptcp\_rcv\_space\_adjust(msk, copied);+ out\_err: if (cmsg\_flags && copied >= 0) { if (cmsg\_flags & MPTCP\_CMSG\_TS)@@ -2285,8 +2292,6 @@ out\_err: pr\_debug("msk=%p rx queue empty=%d:%d copied=%d\n", msk, skb\_queue\_empty\_lockless(&sk->sk\_receive\_queue), skb\_queue\_empty(&msk->receive\_queue), copied);- if (!(flags & MSG\_PEEK))- mptcp\_rcv\_space\_adjust(msk, copied);  release\_sock(sk); return copied; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:51:46 +0000



=== Content from git.kernel.org_6c187696_20250114_185311.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a749b23059b43a9b1787eb36c5d9d44150a34238)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a749b23059b43a9b1787eb36c5d9d44150a34238)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a749b23059b43a9b1787eb36c5d9d44150a34238)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a749b23059b43a9b1787eb36c5d9d44150a34238)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-11-08 11:58:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:37:29 +0100 |
| commit | [a749b23059b43a9b1787eb36c5d9d44150a34238](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a749b23059b43a9b1787eb36c5d9d44150a34238) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a749b23059b43a9b1787eb36c5d9d44150a34238)) | |
| tree | [d234b5b13d0627ddb9acf9e3f8ff09c716bfbfb6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a749b23059b43a9b1787eb36c5d9d44150a34238) | |
| parent | [656dbd1c21c2c088c70059cdd43ec83e7d54ec4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=656dbd1c21c2c088c70059cdd43ec83e7d54ec4d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a749b23059b43a9b1787eb36c5d9d44150a34238&id2=656dbd1c21c2c088c70059cdd43ec83e7d54ec4d)) | |
| download | [linux-a749b23059b43a9b1787eb36c5d9d44150a34238.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a749b23059b43a9b1787eb36c5d9d44150a34238.tar.gz) | |

mptcp: error out earlier on disconnect[ Upstream commit 581302298524e9d77c4c44ff5156a6cd112227ae ]
Eric reported a division by zero splat in the MPTCP protocol:
Oops: divide error: 0000 [#1] PREEMPT SMP KASAN PTI
CPU: 1 UID: 0 PID: 6094 Comm: syz-executor317 Not tainted
6.12.0-rc5-syzkaller-00291-g05b92660cdfe #0
Hardware name: Google Google Compute Engine/Google Compute Engine,
BIOS Google 09/13/2024
RIP: 0010:\_\_tcp\_select\_window+0x5b4/0x1310 net/ipv4/tcp\_output.c:3163
Code: f6 44 01 e3 89 df e8 9b 75 09 f8 44 39 f3 0f 8d 11 ff ff ff e8
0d 74 09 f8 45 89 f4 e9 04 ff ff ff e8 00 74 09 f8 44 89 f0 99 <f7> 7c
24 14 41 29 d6 45 89 f4 e9 ec fe ff ff e8 e8 73 09 f8 48 89
RSP: 0018:ffffc900041f7930 EFLAGS: 00010293
RAX: 0000000000017e67 RBX: 0000000000017e67 RCX: ffffffff8983314b
RDX: 0000000000000000 RSI: ffffffff898331b0 RDI: 0000000000000004
RBP: 00000000005d6000 R08: 0000000000000004 R09: 0000000000017e67
R10: 0000000000003e80 R11: 0000000000000000 R12: 0000000000003e80
R13: ffff888031d9b440 R14: 0000000000017e67 R15: 00000000002eb000
FS: 00007feb5d7f16c0(0000) GS:ffff8880b8700000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007feb5d8adbb8 CR3: 0000000074e4c000 CR4: 00000000003526f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
\_\_tcp\_cleanup\_rbuf+0x3e7/0x4b0 net/ipv4/tcp.c:1493
mptcp\_rcv\_space\_adjust net/mptcp/protocol.c:2085 [inline]
mptcp\_recvmsg+0x2156/0x2600 net/mptcp/protocol.c:2289
inet\_recvmsg+0x469/0x6a0 net/ipv4/af\_inet.c:885
sock\_recvmsg\_nosec net/socket.c:1051 [inline]
sock\_recvmsg+0x1b2/0x250 net/socket.c:1073
\_\_sys\_recvfrom+0x1a5/0x2e0 net/socket.c:2265
\_\_do\_sys\_recvfrom net/socket.c:2283 [inline]
\_\_se\_sys\_recvfrom net/socket.c:2279 [inline]
\_\_x64\_sys\_recvfrom+0xe0/0x1c0 net/socket.c:2279
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xcd/0x250 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7feb5d857559
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 51 18 00 00 90 48 89 f8 48
89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d
01 f0 ff ff 73 01 c3 48 c7 c1 b0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007feb5d7f1208 EFLAGS: 00000246 ORIG\_RAX: 000000000000002d
RAX: ffffffffffffffda RBX: 00007feb5d8e1318 RCX: 00007feb5d857559
RDX: 000000800000000e RSI: 0000000000000000 RDI: 0000000000000003
RBP: 00007feb5d8e1310 R08: 0000000000000000 R09: ffffffff81000000
R10: 0000000000000100 R11: 0000000000000246 R12: 00007feb5d8e131c
R13: 00007feb5d8ae074 R14: 000000800000000e R15: 00000000fffffdef
and provided a nice reproducer.
The root cause is the current bad handling of racing disconnect.
After the blamed commit below, sk\_wait\_data() can return (with
error) with the underlying socket disconnected and a zero rcv\_mss.
Catch the error and return without performing any additional
operations on the current socket.
Reported-by: Eric Dumazet <edumazet@google.com>
Fixes: 419ce133ab92 ("tcp: allow again tcp\_disconnect() when threads are waiting")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/8c82ecf71662ecbc47bf390f9905de70884c9f2d.1731060874.git.pabeni@redhat.com](https://patch.msgid.link/8c82ecf71662ecbc47bf390f9905de70884c9f2d.1731060874.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a749b23059b43a9b1787eb36c5d9d44150a34238)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=a749b23059b43a9b1787eb36c5d9d44150a34238) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex d68e93dab88c3e..78ac5c538e139f 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=656dbd1c21c2c088c70059cdd43ec83e7d54ec4d)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=a749b23059b43a9b1787eb36c5d9d44150a34238)@@ -2180,7 +2180,7 @@ static int mptcp\_recvmsg(struct sock \*sk, struct msghdr \*msg, size\_t len, cmsg\_flags = MPTCP\_CMSG\_INQ;  while (copied < len) {- int bytes\_read;+ int err, bytes\_read;  bytes\_read = \_\_mptcp\_recvmsg\_mskq(msk, msg, len - copied, flags, &tss, &cmsg\_flags); if (unlikely(bytes\_read < 0)) {@@ -2245,9 +2245,16 @@ static int mptcp\_recvmsg(struct sock \*sk, struct msghdr \*msg, size\_t len, }  pr\_debug("block timeout %ld\n", timeo);- sk\_wait\_data(sk, &timeo, NULL);+ mptcp\_rcv\_space\_adjust(msk, copied);+ err = sk\_wait\_data(sk, &timeo, NULL);+ if (err < 0) {+ err = copied ? : err;+ goto out\_err;+ } } + mptcp\_rcv\_space\_adjust(msk, copied);+ out\_err: if (cmsg\_flags && copied >= 0) { if (cmsg\_flags & MPTCP\_CMSG\_TS)@@ -2263,8 +2270,6 @@ out\_err: pr\_debug("msk=%p rx queue empty=%d:%d copied=%d\n", msk, skb\_queue\_empty\_lockless(&sk->sk\_receive\_queue), skb\_queue\_empty(&msk->receive\_queue), copied);- if (!(flags & MSG\_PEEK))- mptcp\_rcv\_space\_adjust(msk, copied);  release\_sock(sk); return copied; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:51:48 +0000



=== Content from git.kernel.org_e14c0784_20250114_185308.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=581302298524e9d77c4c44ff5156a6cd112227ae)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=581302298524e9d77c4c44ff5156a6cd112227ae)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=581302298524e9d77c4c44ff5156a6cd112227ae)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=581302298524e9d77c4c44ff5156a6cd112227ae)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-11-08 11:58:16 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-11-11 19:06:34 -0800 |
| commit | [581302298524e9d77c4c44ff5156a6cd112227ae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=581302298524e9d77c4c44ff5156a6cd112227ae) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=581302298524e9d77c4c44ff5156a6cd112227ae)) | |
| tree | [7d2976cfeb1993c89968f99772a8748b8b52078c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=581302298524e9d77c4c44ff5156a6cd112227ae) | |
| parent | [102d1404c385611c574498b1e0d1f3762e253359](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=102d1404c385611c574498b1e0d1f3762e253359) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=581302298524e9d77c4c44ff5156a6cd112227ae&id2=102d1404c385611c574498b1e0d1f3762e253359)) | |
| download | [linux-581302298524e9d77c4c44ff5156a6cd112227ae.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-581302298524e9d77c4c44ff5156a6cd112227ae.tar.gz) | |

mptcp: error out earlier on disconnectEric reported a division by zero splat in the MPTCP protocol:
Oops: divide error: 0000 [#1] PREEMPT SMP KASAN PTI
CPU: 1 UID: 0 PID: 6094 Comm: syz-executor317 Not tainted
6.12.0-rc5-syzkaller-00291-g05b92660cdfe #0
Hardware name: Google Google Compute Engine/Google Compute Engine,
BIOS Google 09/13/2024
RIP: 0010:\_\_tcp\_select\_window+0x5b4/0x1310 net/ipv4/tcp\_output.c:3163
Code: f6 44 01 e3 89 df e8 9b 75 09 f8 44 39 f3 0f 8d 11 ff ff ff e8
0d 74 09 f8 45 89 f4 e9 04 ff ff ff e8 00 74 09 f8 44 89 f0 99 <f7> 7c
24 14 41 29 d6 45 89 f4 e9 ec fe ff ff e8 e8 73 09 f8 48 89
RSP: 0018:ffffc900041f7930 EFLAGS: 00010293
RAX: 0000000000017e67 RBX: 0000000000017e67 RCX: ffffffff8983314b
RDX: 0000000000000000 RSI: ffffffff898331b0 RDI: 0000000000000004
RBP: 00000000005d6000 R08: 0000000000000004 R09: 0000000000017e67
R10: 0000000000003e80 R11: 0000000000000000 R12: 0000000000003e80
R13: ffff888031d9b440 R14: 0000000000017e67 R15: 00000000002eb000
FS: 00007feb5d7f16c0(0000) GS:ffff8880b8700000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007feb5d8adbb8 CR3: 0000000074e4c000 CR4: 00000000003526f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
\_\_tcp\_cleanup\_rbuf+0x3e7/0x4b0 net/ipv4/tcp.c:1493
mptcp\_rcv\_space\_adjust net/mptcp/protocol.c:2085 [inline]
mptcp\_recvmsg+0x2156/0x2600 net/mptcp/protocol.c:2289
inet\_recvmsg+0x469/0x6a0 net/ipv4/af\_inet.c:885
sock\_recvmsg\_nosec net/socket.c:1051 [inline]
sock\_recvmsg+0x1b2/0x250 net/socket.c:1073
\_\_sys\_recvfrom+0x1a5/0x2e0 net/socket.c:2265
\_\_do\_sys\_recvfrom net/socket.c:2283 [inline]
\_\_se\_sys\_recvfrom net/socket.c:2279 [inline]
\_\_x64\_sys\_recvfrom+0xe0/0x1c0 net/socket.c:2279
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xcd/0x250 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7feb5d857559
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 51 18 00 00 90 48 89 f8 48
89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d
01 f0 ff ff 73 01 c3 48 c7 c1 b0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007feb5d7f1208 EFLAGS: 00000246 ORIG\_RAX: 000000000000002d
RAX: ffffffffffffffda RBX: 00007feb5d8e1318 RCX: 00007feb5d857559
RDX: 000000800000000e RSI: 0000000000000000 RDI: 0000000000000003
RBP: 00007feb5d8e1310 R08: 0000000000000000 R09: ffffffff81000000
R10: 0000000000000100 R11: 0000000000000246 R12: 00007feb5d8e131c
R13: 00007feb5d8ae074 R14: 000000800000000e R15: 00000000fffffdef
and provided a nice reproducer.
The root cause is the current bad handling of racing disconnect.
After the blamed commit below, sk\_wait\_data() can return (with
error) with the underlying socket disconnected and a zero rcv\_mss.
Catch the error and return without performing any additional
operations on the current socket.
Reported-by: Eric Dumazet <edumazet@google.com>
Fixes: 419ce133ab92 ("tcp: allow again tcp\_disconnect() when threads are waiting")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/8c82ecf71662ecbc47bf390f9905de70884c9f2d.1731060874.git.pabeni@redhat.com](https://patch.msgid.link/8c82ecf71662ecbc47bf390f9905de70884c9f2d.1731060874.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=581302298524e9d77c4c44ff5156a6cd112227ae)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=581302298524e9d77c4c44ff5156a6cd112227ae) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex d263091659e076..95a5a3da394474 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=102d1404c385611c574498b1e0d1f3762e253359)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=581302298524e9d77c4c44ff5156a6cd112227ae)@@ -2205,7 +2205,7 @@ static int mptcp\_recvmsg(struct sock \*sk, struct msghdr \*msg, size\_t len, cmsg\_flags = MPTCP\_CMSG\_INQ;  while (copied < len) {- int bytes\_read;+ int err, bytes\_read;  bytes\_read = \_\_mptcp\_recvmsg\_mskq(msk, msg, len - copied, flags, &tss, &cmsg\_flags); if (unlikely(bytes\_read < 0)) {@@ -2267,9 +2267,16 @@ static int mptcp\_recvmsg(struct sock \*sk, struct msghdr \*msg, size\_t len, }  pr\_debug("block timeout %ld\n", timeo);- sk\_wait\_data(sk, &timeo, NULL);+ mptcp\_rcv\_space\_adjust(msk, copied);+ err = sk\_wait\_data(sk, &timeo, NULL);+ if (err < 0) {+ err = copied ? : err;+ goto out\_err;+ } } + mptcp\_rcv\_space\_adjust(msk, copied);+ out\_err: if (cmsg\_flags && copied >= 0) { if (cmsg\_flags & MPTCP\_CMSG\_TS)@@ -2285,8 +2292,6 @@ out\_err: pr\_debug("msk=%p rx queue empty=%d:%d copied=%d\n", msk, skb\_queue\_empty\_lockless(&sk->sk\_receive\_queue), skb\_queue\_empty(&msk->receive\_queue), copied);- if (!(flags & MSG\_PEEK))- mptcp\_rcv\_space\_adjust(msk, copied);  release\_sock(sk); return copied; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:24:56 +0000



=== Content from git.kernel.org_1b2847db_20250114_185309.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-11-08 11:58:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:38:31 +0100 |
| commit | [a66805c9b22caf4e42af7a616f6c6b83c90d1010](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010)) | |
| tree | [6836f8a7031cc7d6366c4fefbc3f4893dcfbef60](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010) | |
| parent | [1e53059729691ca4d905118258b9fbd17d854174](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e53059729691ca4d905118258b9fbd17d854174) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010&id2=1e53059729691ca4d905118258b9fbd17d854174)) | |
| download | [linux-a66805c9b22caf4e42af7a616f6c6b83c90d1010.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a66805c9b22caf4e42af7a616f6c6b83c90d1010.tar.gz) | |

mptcp: error out earlier on disconnect[ Upstream commit 581302298524e9d77c4c44ff5156a6cd112227ae ]
Eric reported a division by zero splat in the MPTCP protocol:
Oops: divide error: 0000 [#1] PREEMPT SMP KASAN PTI
CPU: 1 UID: 0 PID: 6094 Comm: syz-executor317 Not tainted
6.12.0-rc5-syzkaller-00291-g05b92660cdfe #0
Hardware name: Google Google Compute Engine/Google Compute Engine,
BIOS Google 09/13/2024
RIP: 0010:\_\_tcp\_select\_window+0x5b4/0x1310 net/ipv4/tcp\_output.c:3163
Code: f6 44 01 e3 89 df e8 9b 75 09 f8 44 39 f3 0f 8d 11 ff ff ff e8
0d 74 09 f8 45 89 f4 e9 04 ff ff ff e8 00 74 09 f8 44 89 f0 99 <f7> 7c
24 14 41 29 d6 45 89 f4 e9 ec fe ff ff e8 e8 73 09 f8 48 89
RSP: 0018:ffffc900041f7930 EFLAGS: 00010293
RAX: 0000000000017e67 RBX: 0000000000017e67 RCX: ffffffff8983314b
RDX: 0000000000000000 RSI: ffffffff898331b0 RDI: 0000000000000004
RBP: 00000000005d6000 R08: 0000000000000004 R09: 0000000000017e67
R10: 0000000000003e80 R11: 0000000000000000 R12: 0000000000003e80
R13: ffff888031d9b440 R14: 0000000000017e67 R15: 00000000002eb000
FS: 00007feb5d7f16c0(0000) GS:ffff8880b8700000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007feb5d8adbb8 CR3: 0000000074e4c000 CR4: 00000000003526f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
\_\_tcp\_cleanup\_rbuf+0x3e7/0x4b0 net/ipv4/tcp.c:1493
mptcp\_rcv\_space\_adjust net/mptcp/protocol.c:2085 [inline]
mptcp\_recvmsg+0x2156/0x2600 net/mptcp/protocol.c:2289
inet\_recvmsg+0x469/0x6a0 net/ipv4/af\_inet.c:885
sock\_recvmsg\_nosec net/socket.c:1051 [inline]
sock\_recvmsg+0x1b2/0x250 net/socket.c:1073
\_\_sys\_recvfrom+0x1a5/0x2e0 net/socket.c:2265
\_\_do\_sys\_recvfrom net/socket.c:2283 [inline]
\_\_se\_sys\_recvfrom net/socket.c:2279 [inline]
\_\_x64\_sys\_recvfrom+0xe0/0x1c0 net/socket.c:2279
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xcd/0x250 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7feb5d857559
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 51 18 00 00 90 48 89 f8 48
89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d
01 f0 ff ff 73 01 c3 48 c7 c1 b0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007feb5d7f1208 EFLAGS: 00000246 ORIG\_RAX: 000000000000002d
RAX: ffffffffffffffda RBX: 00007feb5d8e1318 RCX: 00007feb5d857559
RDX: 000000800000000e RSI: 0000000000000000 RDI: 0000000000000003
RBP: 00007feb5d8e1310 R08: 0000000000000000 R09: ffffffff81000000
R10: 0000000000000100 R11: 0000000000000246 R12: 00007feb5d8e131c
R13: 00007feb5d8ae074 R14: 000000800000000e R15: 00000000fffffdef
and provided a nice reproducer.
The root cause is the current bad handling of racing disconnect.
After the blamed commit below, sk\_wait\_data() can return (with
error) with the underlying socket disconnected and a zero rcv\_mss.
Catch the error and return without performing any additional
operations on the current socket.
Reported-by: Eric Dumazet <edumazet@google.com>
Fixes: 419ce133ab92 ("tcp: allow again tcp\_disconnect() when threads are waiting")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/8c82ecf71662ecbc47bf390f9905de70884c9f2d.1731060874.git.pabeni@redhat.com](https://patch.msgid.link/8c82ecf71662ecbc47bf390f9905de70884c9f2d.1731060874.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010)

| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex cd6f8d655c185f..e99ef1e67e9573 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=1e53059729691ca4d905118258b9fbd17d854174)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=a66805c9b22caf4e42af7a616f6c6b83c90d1010)@@ -2168,7 +2168,7 @@ static int mptcp\_recvmsg(struct sock \*sk, struct msghdr \*msg, size\_t len, cmsg\_flags = MPTCP\_CMSG\_INQ;  while (copied < len) {- int bytes\_read;+ int err, bytes\_read;  bytes\_read = \_\_mptcp\_recvmsg\_mskq(msk, msg, len - copied, flags, &tss, &cmsg\_flags); if (unlikely(bytes\_read < 0)) {@@ -2230,9 +2230,16 @@ static int mptcp\_recvmsg(struct sock \*sk, struct msghdr \*msg, size\_t len, }  pr\_debug("block timeout %ld\n", timeo);- sk\_wait\_data(sk, &timeo, NULL);+ mptcp\_rcv\_space\_adjust(msk, copied);+ err = sk\_wait\_data(sk, &timeo, NULL);+ if (err < 0) {+ err = copied ? : err;+ goto out\_err;+ } } + mptcp\_rcv\_space\_adjust(msk, copied);+ out\_err: if (cmsg\_flags && copied >= 0) { if (cmsg\_flags & MPTCP\_CMSG\_TS)@@ -2248,8 +2255,6 @@ out\_err: pr\_debug("msk=%p rx queue empty=%d:%d copied=%d\n", msk, skb\_queue\_empty\_lockless(&sk->sk\_receive\_queue), skb\_queue\_empty(&msk->receive\_queue), copied);- if (!(flags & MSG\_PEEK))- mptcp\_rcv\_space\_adjust(msk, copied);  release\_sock(sk); return copied; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:51:47 +0000


