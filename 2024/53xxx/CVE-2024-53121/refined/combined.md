=== Content from git.kernel.org_a2ff87ea_20250114_190816.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a508c74ceae2f5a4647f67c362126516d6404ed9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a508c74ceae2f5a4647f67c362126516d6404ed9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a508c74ceae2f5a4647f67c362126516d6404ed9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a508c74ceae2f5a4647f67c362126516d6404ed9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Bloch <mbloch@nvidia.com> | 2024-11-07 20:35:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:37 +0100 |
| commit | [a508c74ceae2f5a4647f67c362126516d6404ed9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a508c74ceae2f5a4647f67c362126516d6404ed9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a508c74ceae2f5a4647f67c362126516d6404ed9)) | |
| tree | [5facdd437252acb05fb906c3468c60ae2b118a44](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a508c74ceae2f5a4647f67c362126516d6404ed9) | |
| parent | [6e3f2c512d2b7dbd247485b1dd9e43e4210a18f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e3f2c512d2b7dbd247485b1dd9e43e4210a18f4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a508c74ceae2f5a4647f67c362126516d6404ed9&id2=6e3f2c512d2b7dbd247485b1dd9e43e4210a18f4)) | |
| download | [linux-a508c74ceae2f5a4647f67c362126516d6404ed9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a508c74ceae2f5a4647f67c362126516d6404ed9.tar.gz) | |

net/mlx5: fs, lock FTE when checking if active[ Upstream commit 9ca314419930f9135727e39d77e66262d5f7bef6 ]
The referenced commits introduced a two-step process for deleting FTEs:
- Lock the FTE, delete it from hardware, set the hardware deletion function
to NULL and unlock the FTE.
- Lock the parent flow group, delete the software copy of the FTE, and
remove it from the xarray.
However, this approach encounters a race condition if a rule with the same
match value is added simultaneously. In this scenario, fs\_core may set the
hardware deletion function to NULL prematurely, causing a panic during
subsequent rule deletions.
To prevent this, ensure the active flag of the FTE is checked under a lock,
which will prevent the fs\_core layer from attaching a new steering rule to
an FTE that is in the process of deletion.
[ 438.967589] MOSHE: 2496 mlx5\_del\_flow\_rules del\_hw\_func
[ 438.968205] ------------[ cut here ]------------
[ 438.968654] refcount\_t: decrement hit 0; leaking memory.
[ 438.969249] WARNING: CPU: 0 PID: 8957 at lib/refcount.c:31 refcount\_warn\_saturate+0xfb/0x110
[ 438.970054] Modules linked in: act\_mirred cls\_flower act\_gact sch\_ingress openvswitch nsh mlx5\_vdpa vringh vhost\_iotlb vdpa mlx5\_ib mlx5\_core xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter rpcsec\_gss\_krb5 auth\_rpcgss oid\_registry overlay rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm ib\_uverbs ib\_core zram zsmalloc fuse [last unloaded: cls\_flower]
[ 438.973288] CPU: 0 UID: 0 PID: 8957 Comm: tc Not tainted 6.12.0-rc1+ #8
[ 438.973888] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 438.974874] RIP: 0010:refcount\_warn\_saturate+0xfb/0x110
[ 438.975363] Code: 40 66 3b 82 c6 05 16 e9 4d 01 01 e8 1f 7c a0 ff 0f 0b c3 cc cc cc cc 48 c7 c7 10 66 3b 82 c6 05 fd e8 4d 01 01 e8 05 7c a0 ff <0f> 0b c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90
[ 438.976947] RSP: 0018:ffff888124a53610 EFLAGS: 00010286
[ 438.977446] RAX: 0000000000000000 RBX: ffff888119d56de0 RCX: 0000000000000000
[ 438.978090] RDX: ffff88852c828700 RSI: ffff88852c81b3c0 RDI: ffff88852c81b3c0
[ 438.978721] RBP: ffff888120fa0e88 R08: 0000000000000000 R09: ffff888124a534b0
[ 438.979353] R10: 0000000000000001 R11: 0000000000000001 R12: ffff888119d56de0
[ 438.979979] R13: ffff888120fa0ec0 R14: ffff888120fa0ee8 R15: ffff888119d56de0
[ 438.980607] FS: 00007fe6dcc0f800(0000) GS:ffff88852c800000(0000) knlGS:0000000000000000
[ 438.983984] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 438.984544] CR2: 00000000004275e0 CR3: 0000000186982001 CR4: 0000000000372eb0
[ 438.985205] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 438.985842] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 438.986507] Call Trace:
[ 438.986799] <TASK>
[ 438.987070] ? \_\_warn+0x7d/0x110
[ 438.987426] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.987877] ? report\_bug+0x17d/0x190
[ 438.988261] ? prb\_read\_valid+0x17/0x20
[ 438.988659] ? handle\_bug+0x53/0x90
[ 438.989054] ? exc\_invalid\_op+0x14/0x70
[ 438.989458] ? asm\_exc\_invalid\_op+0x16/0x20
[ 438.989883] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.990348] mlx5\_del\_flow\_rules+0x2f7/0x340 [mlx5\_core]
[ 438.990932] \_\_mlx5\_eswitch\_del\_rule+0x49/0x170 [mlx5\_core]
[ 438.991519] ? mlx5\_lag\_is\_sriov+0x3c/0x50 [mlx5\_core]
[ 438.992054] ? xas\_load+0x9/0xb0
[ 438.992407] mlx5e\_tc\_rule\_unoffload+0x45/0xe0 [mlx5\_core]
[ 438.993037] mlx5e\_tc\_del\_fdb\_flow+0x2a6/0x2e0 [mlx5\_core]
[ 438.993623] mlx5e\_flow\_put+0x29/0x60 [mlx5\_core]
[ 438.994161] mlx5e\_delete\_flower+0x261/0x390 [mlx5\_core]
[ 438.994728] tc\_setup\_cb\_destroy+0xb9/0x190
[ 438.995150] fl\_hw\_destroy\_filter+0x94/0xc0 [cls\_flower]
[ 438.995650] fl\_change+0x11a4/0x13c0 [cls\_flower]
[ 438.996105] tc\_new\_tfilter+0x347/0xbc0
[ 438.996503] ? \_\_\_slab\_alloc+0x70/0x8c0
[ 438.996929] rtnetlink\_rcv\_msg+0xf9/0x3e0
[ 438.997339] ? \_\_netlink\_sendskb+0x4c/0x70
[ 438.997751] ? netlink\_unicast+0x286/0x2d0
[ 438.998171] ? \_\_pfx\_rtnetlink\_rcv\_msg+0x10/0x10
[ 438.998625] netlink\_rcv\_skb+0x54/0x100
[ 438.999020] netlink\_unicast+0x203/0x2d0
[ 438.999421] netlink\_sendmsg+0x1e4/0x420
[ 438.999820] \_\_sock\_sendmsg+0xa1/0xb0
[ 439.000203] \_\_\_\_sys\_sendmsg+0x207/0x2a0
[ 439.000600] ? copy\_msghdr\_from\_user+0x6d/0xa0
[ 439.001072] \_\_\_sys\_sendmsg+0x80/0xc0
[ 439.001459] ? \_\_\_sys\_recvmsg+0x8b/0xc0
[ 439.001848] ? generic\_update\_time+0x4d/0x60
[ 439.002282] \_\_sys\_sendmsg+0x51/0x90
[ 439.002658] do\_syscall\_64+0x50/0x110
[ 439.003040] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 718ce4d601db ("net/mlx5: Consolidate update FTE for all removal changes")
Fixes: cefc23554fc2 ("net/mlx5: Fix FTE cleanup")
Signed-off-by: Mark Bloch <mbloch@nvidia.com>
Reviewed-by: Maor Gottlieb <maorg@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://patch.msgid.link/20241107183527.676877-4-tariqt@nvidia.com](https://patch.msgid.link/20241107183527.676877-4-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a508c74ceae2f5a4647f67c362126516d6404ed9)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=a508c74ceae2f5a4647f67c362126516d6404ed9) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c b/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.cindex 074c9eb44ab73b..c1a0d4e616b4b3 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=6e3f2c512d2b7dbd247485b1dd9e43e4210a18f4)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=a508c74ceae2f5a4647f67c362126516d6404ed9)@@ -1799,13 +1799,22 @@ lookup\_fte\_locked(struct mlx5\_flow\_group \*g, fte\_tmp = NULL; goto out; }++ nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD);+ if (!fte\_tmp->node.active) {+ up\_write\_ref\_node(&fte\_tmp->node, false);++ if (take\_write)+ up\_write\_ref\_node(&g->node, false);+ else+ up\_read\_ref\_node(&g->node);+ tree\_put\_node(&fte\_tmp->node, false);- fte\_tmp = NULL;- goto out;++ return NULL; } - nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD); out: if (take\_write) up\_write\_ref\_node(&g->node, false); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:52 +0000



=== Content from git.kernel.org_e91d459f_20250114_190813.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Bloch <mbloch@nvidia.com> | 2024-11-07 20:35:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:39:47 +0100 |
| commit | [933ef0d17f012b653e9e6006e3f50c8d0238b5ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed)) | |
| tree | [f52d35940183e3a56946518f15576996bb3019bb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed) | |
| parent | [0ae993fc42e4a28271c11b64a5fd6a2c352077cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ae993fc42e4a28271c11b64a5fd6a2c352077cd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed&id2=0ae993fc42e4a28271c11b64a5fd6a2c352077cd)) | |
| download | [linux-933ef0d17f012b653e9e6006e3f50c8d0238b5ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-933ef0d17f012b653e9e6006e3f50c8d0238b5ed.tar.gz) | |

net/mlx5: fs, lock FTE when checking if active[ Upstream commit 9ca314419930f9135727e39d77e66262d5f7bef6 ]
The referenced commits introduced a two-step process for deleting FTEs:
- Lock the FTE, delete it from hardware, set the hardware deletion function
to NULL and unlock the FTE.
- Lock the parent flow group, delete the software copy of the FTE, and
remove it from the xarray.
However, this approach encounters a race condition if a rule with the same
match value is added simultaneously. In this scenario, fs\_core may set the
hardware deletion function to NULL prematurely, causing a panic during
subsequent rule deletions.
To prevent this, ensure the active flag of the FTE is checked under a lock,
which will prevent the fs\_core layer from attaching a new steering rule to
an FTE that is in the process of deletion.
[ 438.967589] MOSHE: 2496 mlx5\_del\_flow\_rules del\_hw\_func
[ 438.968205] ------------[ cut here ]------------
[ 438.968654] refcount\_t: decrement hit 0; leaking memory.
[ 438.969249] WARNING: CPU: 0 PID: 8957 at lib/refcount.c:31 refcount\_warn\_saturate+0xfb/0x110
[ 438.970054] Modules linked in: act\_mirred cls\_flower act\_gact sch\_ingress openvswitch nsh mlx5\_vdpa vringh vhost\_iotlb vdpa mlx5\_ib mlx5\_core xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter rpcsec\_gss\_krb5 auth\_rpcgss oid\_registry overlay rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm ib\_uverbs ib\_core zram zsmalloc fuse [last unloaded: cls\_flower]
[ 438.973288] CPU: 0 UID: 0 PID: 8957 Comm: tc Not tainted 6.12.0-rc1+ #8
[ 438.973888] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 438.974874] RIP: 0010:refcount\_warn\_saturate+0xfb/0x110
[ 438.975363] Code: 40 66 3b 82 c6 05 16 e9 4d 01 01 e8 1f 7c a0 ff 0f 0b c3 cc cc cc cc 48 c7 c7 10 66 3b 82 c6 05 fd e8 4d 01 01 e8 05 7c a0 ff <0f> 0b c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90
[ 438.976947] RSP: 0018:ffff888124a53610 EFLAGS: 00010286
[ 438.977446] RAX: 0000000000000000 RBX: ffff888119d56de0 RCX: 0000000000000000
[ 438.978090] RDX: ffff88852c828700 RSI: ffff88852c81b3c0 RDI: ffff88852c81b3c0
[ 438.978721] RBP: ffff888120fa0e88 R08: 0000000000000000 R09: ffff888124a534b0
[ 438.979353] R10: 0000000000000001 R11: 0000000000000001 R12: ffff888119d56de0
[ 438.979979] R13: ffff888120fa0ec0 R14: ffff888120fa0ee8 R15: ffff888119d56de0
[ 438.980607] FS: 00007fe6dcc0f800(0000) GS:ffff88852c800000(0000) knlGS:0000000000000000
[ 438.983984] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 438.984544] CR2: 00000000004275e0 CR3: 0000000186982001 CR4: 0000000000372eb0
[ 438.985205] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 438.985842] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 438.986507] Call Trace:
[ 438.986799] <TASK>
[ 438.987070] ? \_\_warn+0x7d/0x110
[ 438.987426] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.987877] ? report\_bug+0x17d/0x190
[ 438.988261] ? prb\_read\_valid+0x17/0x20
[ 438.988659] ? handle\_bug+0x53/0x90
[ 438.989054] ? exc\_invalid\_op+0x14/0x70
[ 438.989458] ? asm\_exc\_invalid\_op+0x16/0x20
[ 438.989883] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.990348] mlx5\_del\_flow\_rules+0x2f7/0x340 [mlx5\_core]
[ 438.990932] \_\_mlx5\_eswitch\_del\_rule+0x49/0x170 [mlx5\_core]
[ 438.991519] ? mlx5\_lag\_is\_sriov+0x3c/0x50 [mlx5\_core]
[ 438.992054] ? xas\_load+0x9/0xb0
[ 438.992407] mlx5e\_tc\_rule\_unoffload+0x45/0xe0 [mlx5\_core]
[ 438.993037] mlx5e\_tc\_del\_fdb\_flow+0x2a6/0x2e0 [mlx5\_core]
[ 438.993623] mlx5e\_flow\_put+0x29/0x60 [mlx5\_core]
[ 438.994161] mlx5e\_delete\_flower+0x261/0x390 [mlx5\_core]
[ 438.994728] tc\_setup\_cb\_destroy+0xb9/0x190
[ 438.995150] fl\_hw\_destroy\_filter+0x94/0xc0 [cls\_flower]
[ 438.995650] fl\_change+0x11a4/0x13c0 [cls\_flower]
[ 438.996105] tc\_new\_tfilter+0x347/0xbc0
[ 438.996503] ? \_\_\_slab\_alloc+0x70/0x8c0
[ 438.996929] rtnetlink\_rcv\_msg+0xf9/0x3e0
[ 438.997339] ? \_\_netlink\_sendskb+0x4c/0x70
[ 438.997751] ? netlink\_unicast+0x286/0x2d0
[ 438.998171] ? \_\_pfx\_rtnetlink\_rcv\_msg+0x10/0x10
[ 438.998625] netlink\_rcv\_skb+0x54/0x100
[ 438.999020] netlink\_unicast+0x203/0x2d0
[ 438.999421] netlink\_sendmsg+0x1e4/0x420
[ 438.999820] \_\_sock\_sendmsg+0xa1/0xb0
[ 439.000203] \_\_\_\_sys\_sendmsg+0x207/0x2a0
[ 439.000600] ? copy\_msghdr\_from\_user+0x6d/0xa0
[ 439.001072] \_\_\_sys\_sendmsg+0x80/0xc0
[ 439.001459] ? \_\_\_sys\_recvmsg+0x8b/0xc0
[ 439.001848] ? generic\_update\_time+0x4d/0x60
[ 439.002282] \_\_sys\_sendmsg+0x51/0x90
[ 439.002658] do\_syscall\_64+0x50/0x110
[ 439.003040] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 718ce4d601db ("net/mlx5: Consolidate update FTE for all removal changes")
Fixes: cefc23554fc2 ("net/mlx5: Fix FTE cleanup")
Signed-off-by: Mark Bloch <mbloch@nvidia.com>
Reviewed-by: Maor Gottlieb <maorg@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://patch.msgid.link/20241107183527.676877-4-tariqt@nvidia.com](https://patch.msgid.link/20241107183527.676877-4-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c b/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.cindex a47d6419160d78..fb01acbadf7325 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=0ae993fc42e4a28271c11b64a5fd6a2c352077cd)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=933ef0d17f012b653e9e6006e3f50c8d0238b5ed)@@ -1946,13 +1946,22 @@ lookup\_fte\_locked(struct mlx5\_flow\_group \*g, fte\_tmp = NULL; goto out; }++ nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD);+ if (!fte\_tmp->node.active) {+ up\_write\_ref\_node(&fte\_tmp->node, false);++ if (take\_write)+ up\_write\_ref\_node(&g->node, false);+ else+ up\_read\_ref\_node(&g->node);+ tree\_put\_node(&fte\_tmp->node, false);- fte\_tmp = NULL;- goto out;++ return NULL; } - nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD); out: if (take\_write) up\_write\_ref\_node(&g->node, false); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:50 +0000



=== Content from git.kernel.org_c8cf8972_20250114_190812.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Bloch <mbloch@nvidia.com> | 2024-11-07 20:35:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:34 +0100 |
| commit | [5b47c2f47c2fe921681f4a4fe2790375e6c04cdd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd)) | |
| tree | [96800af6d4f79d12f749edd413ad80fd981406f6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd) | |
| parent | [4e47b99a7764b23a431bff6a3f91dfe77d294765](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e47b99a7764b23a431bff6a3f91dfe77d294765) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd&id2=4e47b99a7764b23a431bff6a3f91dfe77d294765)) | |
| download | [linux-5b47c2f47c2fe921681f4a4fe2790375e6c04cdd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5b47c2f47c2fe921681f4a4fe2790375e6c04cdd.tar.gz) | |

net/mlx5: fs, lock FTE when checking if active[ Upstream commit 9ca314419930f9135727e39d77e66262d5f7bef6 ]
The referenced commits introduced a two-step process for deleting FTEs:
- Lock the FTE, delete it from hardware, set the hardware deletion function
to NULL and unlock the FTE.
- Lock the parent flow group, delete the software copy of the FTE, and
remove it from the xarray.
However, this approach encounters a race condition if a rule with the same
match value is added simultaneously. In this scenario, fs\_core may set the
hardware deletion function to NULL prematurely, causing a panic during
subsequent rule deletions.
To prevent this, ensure the active flag of the FTE is checked under a lock,
which will prevent the fs\_core layer from attaching a new steering rule to
an FTE that is in the process of deletion.
[ 438.967589] MOSHE: 2496 mlx5\_del\_flow\_rules del\_hw\_func
[ 438.968205] ------------[ cut here ]------------
[ 438.968654] refcount\_t: decrement hit 0; leaking memory.
[ 438.969249] WARNING: CPU: 0 PID: 8957 at lib/refcount.c:31 refcount\_warn\_saturate+0xfb/0x110
[ 438.970054] Modules linked in: act\_mirred cls\_flower act\_gact sch\_ingress openvswitch nsh mlx5\_vdpa vringh vhost\_iotlb vdpa mlx5\_ib mlx5\_core xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter rpcsec\_gss\_krb5 auth\_rpcgss oid\_registry overlay rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm ib\_uverbs ib\_core zram zsmalloc fuse [last unloaded: cls\_flower]
[ 438.973288] CPU: 0 UID: 0 PID: 8957 Comm: tc Not tainted 6.12.0-rc1+ #8
[ 438.973888] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 438.974874] RIP: 0010:refcount\_warn\_saturate+0xfb/0x110
[ 438.975363] Code: 40 66 3b 82 c6 05 16 e9 4d 01 01 e8 1f 7c a0 ff 0f 0b c3 cc cc cc cc 48 c7 c7 10 66 3b 82 c6 05 fd e8 4d 01 01 e8 05 7c a0 ff <0f> 0b c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90
[ 438.976947] RSP: 0018:ffff888124a53610 EFLAGS: 00010286
[ 438.977446] RAX: 0000000000000000 RBX: ffff888119d56de0 RCX: 0000000000000000
[ 438.978090] RDX: ffff88852c828700 RSI: ffff88852c81b3c0 RDI: ffff88852c81b3c0
[ 438.978721] RBP: ffff888120fa0e88 R08: 0000000000000000 R09: ffff888124a534b0
[ 438.979353] R10: 0000000000000001 R11: 0000000000000001 R12: ffff888119d56de0
[ 438.979979] R13: ffff888120fa0ec0 R14: ffff888120fa0ee8 R15: ffff888119d56de0
[ 438.980607] FS: 00007fe6dcc0f800(0000) GS:ffff88852c800000(0000) knlGS:0000000000000000
[ 438.983984] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 438.984544] CR2: 00000000004275e0 CR3: 0000000186982001 CR4: 0000000000372eb0
[ 438.985205] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 438.985842] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 438.986507] Call Trace:
[ 438.986799] <TASK>
[ 438.987070] ? \_\_warn+0x7d/0x110
[ 438.987426] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.987877] ? report\_bug+0x17d/0x190
[ 438.988261] ? prb\_read\_valid+0x17/0x20
[ 438.988659] ? handle\_bug+0x53/0x90
[ 438.989054] ? exc\_invalid\_op+0x14/0x70
[ 438.989458] ? asm\_exc\_invalid\_op+0x16/0x20
[ 438.989883] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.990348] mlx5\_del\_flow\_rules+0x2f7/0x340 [mlx5\_core]
[ 438.990932] \_\_mlx5\_eswitch\_del\_rule+0x49/0x170 [mlx5\_core]
[ 438.991519] ? mlx5\_lag\_is\_sriov+0x3c/0x50 [mlx5\_core]
[ 438.992054] ? xas\_load+0x9/0xb0
[ 438.992407] mlx5e\_tc\_rule\_unoffload+0x45/0xe0 [mlx5\_core]
[ 438.993037] mlx5e\_tc\_del\_fdb\_flow+0x2a6/0x2e0 [mlx5\_core]
[ 438.993623] mlx5e\_flow\_put+0x29/0x60 [mlx5\_core]
[ 438.994161] mlx5e\_delete\_flower+0x261/0x390 [mlx5\_core]
[ 438.994728] tc\_setup\_cb\_destroy+0xb9/0x190
[ 438.995150] fl\_hw\_destroy\_filter+0x94/0xc0 [cls\_flower]
[ 438.995650] fl\_change+0x11a4/0x13c0 [cls\_flower]
[ 438.996105] tc\_new\_tfilter+0x347/0xbc0
[ 438.996503] ? \_\_\_slab\_alloc+0x70/0x8c0
[ 438.996929] rtnetlink\_rcv\_msg+0xf9/0x3e0
[ 438.997339] ? \_\_netlink\_sendskb+0x4c/0x70
[ 438.997751] ? netlink\_unicast+0x286/0x2d0
[ 438.998171] ? \_\_pfx\_rtnetlink\_rcv\_msg+0x10/0x10
[ 438.998625] netlink\_rcv\_skb+0x54/0x100
[ 438.999020] netlink\_unicast+0x203/0x2d0
[ 438.999421] netlink\_sendmsg+0x1e4/0x420
[ 438.999820] \_\_sock\_sendmsg+0xa1/0xb0
[ 439.000203] \_\_\_\_sys\_sendmsg+0x207/0x2a0
[ 439.000600] ? copy\_msghdr\_from\_user+0x6d/0xa0
[ 439.001072] \_\_\_sys\_sendmsg+0x80/0xc0
[ 439.001459] ? \_\_\_sys\_recvmsg+0x8b/0xc0
[ 439.001848] ? generic\_update\_time+0x4d/0x60
[ 439.002282] \_\_sys\_sendmsg+0x51/0x90
[ 439.002658] do\_syscall\_64+0x50/0x110
[ 439.003040] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 718ce4d601db ("net/mlx5: Consolidate update FTE for all removal changes")
Fixes: cefc23554fc2 ("net/mlx5: Fix FTE cleanup")
Signed-off-by: Mark Bloch <mbloch@nvidia.com>
Reviewed-by: Maor Gottlieb <maorg@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://patch.msgid.link/20241107183527.676877-4-tariqt@nvidia.com](https://patch.msgid.link/20241107183527.676877-4-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c b/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.cindex fbfa5637714daf..665619ce467468 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=4e47b99a7764b23a431bff6a3f91dfe77d294765)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=5b47c2f47c2fe921681f4a4fe2790375e6c04cdd)@@ -1806,13 +1806,22 @@ lookup\_fte\_locked(struct mlx5\_flow\_group \*g, fte\_tmp = NULL; goto out; }++ nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD);+ if (!fte\_tmp->node.active) {+ up\_write\_ref\_node(&fte\_tmp->node, false);++ if (take\_write)+ up\_write\_ref\_node(&g->node, false);+ else+ up\_read\_ref\_node(&g->node);+ tree\_put\_node(&fte\_tmp->node, false);- fte\_tmp = NULL;- goto out;++ return NULL; } - nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD); out: if (take\_write) up\_write\_ref\_node(&g->node, false); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:49 +0000



=== Content from git.kernel.org_2abfdb8f_20250114_190814.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ca314419930f9135727e39d77e66262d5f7bef6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ca314419930f9135727e39d77e66262d5f7bef6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ca314419930f9135727e39d77e66262d5f7bef6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ca314419930f9135727e39d77e66262d5f7bef6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Bloch <mbloch@nvidia.com> | 2024-11-07 20:35:23 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-11-11 19:23:38 -0800 |
| commit | [9ca314419930f9135727e39d77e66262d5f7bef6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ca314419930f9135727e39d77e66262d5f7bef6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ca314419930f9135727e39d77e66262d5f7bef6)) | |
| tree | [913bf9d5df5452acf89d49f041e6d2064de8c065](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ca314419930f9135727e39d77e66262d5f7bef6) | |
| parent | [d0989c9d2b3a89ae5e4ad45fe6d7bbe449fc49fe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0989c9d2b3a89ae5e4ad45fe6d7bbe449fc49fe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ca314419930f9135727e39d77e66262d5f7bef6&id2=d0989c9d2b3a89ae5e4ad45fe6d7bbe449fc49fe)) | |
| download | [linux-9ca314419930f9135727e39d77e66262d5f7bef6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ca314419930f9135727e39d77e66262d5f7bef6.tar.gz) | |

net/mlx5: fs, lock FTE when checking if activeThe referenced commits introduced a two-step process for deleting FTEs:
- Lock the FTE, delete it from hardware, set the hardware deletion function
to NULL and unlock the FTE.
- Lock the parent flow group, delete the software copy of the FTE, and
remove it from the xarray.
However, this approach encounters a race condition if a rule with the same
match value is added simultaneously. In this scenario, fs\_core may set the
hardware deletion function to NULL prematurely, causing a panic during
subsequent rule deletions.
To prevent this, ensure the active flag of the FTE is checked under a lock,
which will prevent the fs\_core layer from attaching a new steering rule to
an FTE that is in the process of deletion.
[ 438.967589] MOSHE: 2496 mlx5\_del\_flow\_rules del\_hw\_func
[ 438.968205] ------------[ cut here ]------------
[ 438.968654] refcount\_t: decrement hit 0; leaking memory.
[ 438.969249] WARNING: CPU: 0 PID: 8957 at lib/refcount.c:31 refcount\_warn\_saturate+0xfb/0x110
[ 438.970054] Modules linked in: act\_mirred cls\_flower act\_gact sch\_ingress openvswitch nsh mlx5\_vdpa vringh vhost\_iotlb vdpa mlx5\_ib mlx5\_core xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter rpcsec\_gss\_krb5 auth\_rpcgss oid\_registry overlay rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm ib\_uverbs ib\_core zram zsmalloc fuse [last unloaded: cls\_flower]
[ 438.973288] CPU: 0 UID: 0 PID: 8957 Comm: tc Not tainted 6.12.0-rc1+ #8
[ 438.973888] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 438.974874] RIP: 0010:refcount\_warn\_saturate+0xfb/0x110
[ 438.975363] Code: 40 66 3b 82 c6 05 16 e9 4d 01 01 e8 1f 7c a0 ff 0f 0b c3 cc cc cc cc 48 c7 c7 10 66 3b 82 c6 05 fd e8 4d 01 01 e8 05 7c a0 ff <0f> 0b c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90
[ 438.976947] RSP: 0018:ffff888124a53610 EFLAGS: 00010286
[ 438.977446] RAX: 0000000000000000 RBX: ffff888119d56de0 RCX: 0000000000000000
[ 438.978090] RDX: ffff88852c828700 RSI: ffff88852c81b3c0 RDI: ffff88852c81b3c0
[ 438.978721] RBP: ffff888120fa0e88 R08: 0000000000000000 R09: ffff888124a534b0
[ 438.979353] R10: 0000000000000001 R11: 0000000000000001 R12: ffff888119d56de0
[ 438.979979] R13: ffff888120fa0ec0 R14: ffff888120fa0ee8 R15: ffff888119d56de0
[ 438.980607] FS: 00007fe6dcc0f800(0000) GS:ffff88852c800000(0000) knlGS:0000000000000000
[ 438.983984] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 438.984544] CR2: 00000000004275e0 CR3: 0000000186982001 CR4: 0000000000372eb0
[ 438.985205] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 438.985842] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 438.986507] Call Trace:
[ 438.986799] <TASK>
[ 438.987070] ? \_\_warn+0x7d/0x110
[ 438.987426] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.987877] ? report\_bug+0x17d/0x190
[ 438.988261] ? prb\_read\_valid+0x17/0x20
[ 438.988659] ? handle\_bug+0x53/0x90
[ 438.989054] ? exc\_invalid\_op+0x14/0x70
[ 438.989458] ? asm\_exc\_invalid\_op+0x16/0x20
[ 438.989883] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.990348] mlx5\_del\_flow\_rules+0x2f7/0x340 [mlx5\_core]
[ 438.990932] \_\_mlx5\_eswitch\_del\_rule+0x49/0x170 [mlx5\_core]
[ 438.991519] ? mlx5\_lag\_is\_sriov+0x3c/0x50 [mlx5\_core]
[ 438.992054] ? xas\_load+0x9/0xb0
[ 438.992407] mlx5e\_tc\_rule\_unoffload+0x45/0xe0 [mlx5\_core]
[ 438.993037] mlx5e\_tc\_del\_fdb\_flow+0x2a6/0x2e0 [mlx5\_core]
[ 438.993623] mlx5e\_flow\_put+0x29/0x60 [mlx5\_core]
[ 438.994161] mlx5e\_delete\_flower+0x261/0x390 [mlx5\_core]
[ 438.994728] tc\_setup\_cb\_destroy+0xb9/0x190
[ 438.995150] fl\_hw\_destroy\_filter+0x94/0xc0 [cls\_flower]
[ 438.995650] fl\_change+0x11a4/0x13c0 [cls\_flower]
[ 438.996105] tc\_new\_tfilter+0x347/0xbc0
[ 438.996503] ? \_\_\_slab\_alloc+0x70/0x8c0
[ 438.996929] rtnetlink\_rcv\_msg+0xf9/0x3e0
[ 438.997339] ? \_\_netlink\_sendskb+0x4c/0x70
[ 438.997751] ? netlink\_unicast+0x286/0x2d0
[ 438.998171] ? \_\_pfx\_rtnetlink\_rcv\_msg+0x10/0x10
[ 438.998625] netlink\_rcv\_skb+0x54/0x100
[ 438.999020] netlink\_unicast+0x203/0x2d0
[ 438.999421] netlink\_sendmsg+0x1e4/0x420
[ 438.999820] \_\_sock\_sendmsg+0xa1/0xb0
[ 439.000203] \_\_\_\_sys\_sendmsg+0x207/0x2a0
[ 439.000600] ? copy\_msghdr\_from\_user+0x6d/0xa0
[ 439.001072] \_\_\_sys\_sendmsg+0x80/0xc0
[ 439.001459] ? \_\_\_sys\_recvmsg+0x8b/0xc0
[ 439.001848] ? generic\_update\_time+0x4d/0x60
[ 439.002282] \_\_sys\_sendmsg+0x51/0x90
[ 439.002658] do\_syscall\_64+0x50/0x110
[ 439.003040] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 718ce4d601db ("net/mlx5: Consolidate update FTE for all removal changes")
Fixes: cefc23554fc2 ("net/mlx5: Fix FTE cleanup")
Signed-off-by: Mark Bloch <mbloch@nvidia.com>
Reviewed-by: Maor Gottlieb <maorg@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://patch.msgid.link/20241107183527.676877-4-tariqt@nvidia.com](https://patch.msgid.link/20241107183527.676877-4-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ca314419930f9135727e39d77e66262d5f7bef6)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=9ca314419930f9135727e39d77e66262d5f7bef6) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c b/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.cindex 8505d5e241e1a7..6e4f8aaf8d2f21 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=d0989c9d2b3a89ae5e4ad45fe6d7bbe449fc49fe)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=9ca314419930f9135727e39d77e66262d5f7bef6)@@ -2105,13 +2105,22 @@ lookup\_fte\_locked(struct mlx5\_flow\_group \*g, fte\_tmp = NULL; goto out; }++ nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD);+ if (!fte\_tmp->node.active) {+ up\_write\_ref\_node(&fte\_tmp->node, false);++ if (take\_write)+ up\_write\_ref\_node(&g->node, false);+ else+ up\_read\_ref\_node(&g->node);+ tree\_put\_node(&fte\_tmp->node, false);- fte\_tmp = NULL;- goto out;++ return NULL; } - nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD); out: if (take\_write) up\_write\_ref\_node(&g->node, false); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:51 +0000



=== Content from git.kernel.org_28530b2d_20250114_190816.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bfba288f53192db08c68d4c568db9783fb9cb838)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bfba288f53192db08c68d4c568db9783fb9cb838)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfba288f53192db08c68d4c568db9783fb9cb838)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfba288f53192db08c68d4c568db9783fb9cb838)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Bloch <mbloch@nvidia.com> | 2024-11-07 20:35:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:37:29 +0100 |
| commit | [bfba288f53192db08c68d4c568db9783fb9cb838](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfba288f53192db08c68d4c568db9783fb9cb838) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bfba288f53192db08c68d4c568db9783fb9cb838)) | |
| tree | [4ff17da9bdd31448a6cd5bec9c9c3b98c1aa1eb0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bfba288f53192db08c68d4c568db9783fb9cb838) | |
| parent | [a749b23059b43a9b1787eb36c5d9d44150a34238](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a749b23059b43a9b1787eb36c5d9d44150a34238) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfba288f53192db08c68d4c568db9783fb9cb838&id2=a749b23059b43a9b1787eb36c5d9d44150a34238)) | |
| download | [linux-bfba288f53192db08c68d4c568db9783fb9cb838.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bfba288f53192db08c68d4c568db9783fb9cb838.tar.gz) | |

net/mlx5: fs, lock FTE when checking if active[ Upstream commit 9ca314419930f9135727e39d77e66262d5f7bef6 ]
The referenced commits introduced a two-step process for deleting FTEs:
- Lock the FTE, delete it from hardware, set the hardware deletion function
to NULL and unlock the FTE.
- Lock the parent flow group, delete the software copy of the FTE, and
remove it from the xarray.
However, this approach encounters a race condition if a rule with the same
match value is added simultaneously. In this scenario, fs\_core may set the
hardware deletion function to NULL prematurely, causing a panic during
subsequent rule deletions.
To prevent this, ensure the active flag of the FTE is checked under a lock,
which will prevent the fs\_core layer from attaching a new steering rule to
an FTE that is in the process of deletion.
[ 438.967589] MOSHE: 2496 mlx5\_del\_flow\_rules del\_hw\_func
[ 438.968205] ------------[ cut here ]------------
[ 438.968654] refcount\_t: decrement hit 0; leaking memory.
[ 438.969249] WARNING: CPU: 0 PID: 8957 at lib/refcount.c:31 refcount\_warn\_saturate+0xfb/0x110
[ 438.970054] Modules linked in: act\_mirred cls\_flower act\_gact sch\_ingress openvswitch nsh mlx5\_vdpa vringh vhost\_iotlb vdpa mlx5\_ib mlx5\_core xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter rpcsec\_gss\_krb5 auth\_rpcgss oid\_registry overlay rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm ib\_uverbs ib\_core zram zsmalloc fuse [last unloaded: cls\_flower]
[ 438.973288] CPU: 0 UID: 0 PID: 8957 Comm: tc Not tainted 6.12.0-rc1+ #8
[ 438.973888] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 438.974874] RIP: 0010:refcount\_warn\_saturate+0xfb/0x110
[ 438.975363] Code: 40 66 3b 82 c6 05 16 e9 4d 01 01 e8 1f 7c a0 ff 0f 0b c3 cc cc cc cc 48 c7 c7 10 66 3b 82 c6 05 fd e8 4d 01 01 e8 05 7c a0 ff <0f> 0b c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90
[ 438.976947] RSP: 0018:ffff888124a53610 EFLAGS: 00010286
[ 438.977446] RAX: 0000000000000000 RBX: ffff888119d56de0 RCX: 0000000000000000
[ 438.978090] RDX: ffff88852c828700 RSI: ffff88852c81b3c0 RDI: ffff88852c81b3c0
[ 438.978721] RBP: ffff888120fa0e88 R08: 0000000000000000 R09: ffff888124a534b0
[ 438.979353] R10: 0000000000000001 R11: 0000000000000001 R12: ffff888119d56de0
[ 438.979979] R13: ffff888120fa0ec0 R14: ffff888120fa0ee8 R15: ffff888119d56de0
[ 438.980607] FS: 00007fe6dcc0f800(0000) GS:ffff88852c800000(0000) knlGS:0000000000000000
[ 438.983984] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 438.984544] CR2: 00000000004275e0 CR3: 0000000186982001 CR4: 0000000000372eb0
[ 438.985205] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 438.985842] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 438.986507] Call Trace:
[ 438.986799] <TASK>
[ 438.987070] ? \_\_warn+0x7d/0x110
[ 438.987426] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.987877] ? report\_bug+0x17d/0x190
[ 438.988261] ? prb\_read\_valid+0x17/0x20
[ 438.988659] ? handle\_bug+0x53/0x90
[ 438.989054] ? exc\_invalid\_op+0x14/0x70
[ 438.989458] ? asm\_exc\_invalid\_op+0x16/0x20
[ 438.989883] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.990348] mlx5\_del\_flow\_rules+0x2f7/0x340 [mlx5\_core]
[ 438.990932] \_\_mlx5\_eswitch\_del\_rule+0x49/0x170 [mlx5\_core]
[ 438.991519] ? mlx5\_lag\_is\_sriov+0x3c/0x50 [mlx5\_core]
[ 438.992054] ? xas\_load+0x9/0xb0
[ 438.992407] mlx5e\_tc\_rule\_unoffload+0x45/0xe0 [mlx5\_core]
[ 438.993037] mlx5e\_tc\_del\_fdb\_flow+0x2a6/0x2e0 [mlx5\_core]
[ 438.993623] mlx5e\_flow\_put+0x29/0x60 [mlx5\_core]
[ 438.994161] mlx5e\_delete\_flower+0x261/0x390 [mlx5\_core]
[ 438.994728] tc\_setup\_cb\_destroy+0xb9/0x190
[ 438.995150] fl\_hw\_destroy\_filter+0x94/0xc0 [cls\_flower]
[ 438.995650] fl\_change+0x11a4/0x13c0 [cls\_flower]
[ 438.996105] tc\_new\_tfilter+0x347/0xbc0
[ 438.996503] ? \_\_\_slab\_alloc+0x70/0x8c0
[ 438.996929] rtnetlink\_rcv\_msg+0xf9/0x3e0
[ 438.997339] ? \_\_netlink\_sendskb+0x4c/0x70
[ 438.997751] ? netlink\_unicast+0x286/0x2d0
[ 438.998171] ? \_\_pfx\_rtnetlink\_rcv\_msg+0x10/0x10
[ 438.998625] netlink\_rcv\_skb+0x54/0x100
[ 438.999020] netlink\_unicast+0x203/0x2d0
[ 438.999421] netlink\_sendmsg+0x1e4/0x420
[ 438.999820] \_\_sock\_sendmsg+0xa1/0xb0
[ 439.000203] \_\_\_\_sys\_sendmsg+0x207/0x2a0
[ 439.000600] ? copy\_msghdr\_from\_user+0x6d/0xa0
[ 439.001072] \_\_\_sys\_sendmsg+0x80/0xc0
[ 439.001459] ? \_\_\_sys\_recvmsg+0x8b/0xc0
[ 439.001848] ? generic\_update\_time+0x4d/0x60
[ 439.002282] \_\_sys\_sendmsg+0x51/0x90
[ 439.002658] do\_syscall\_64+0x50/0x110
[ 439.003040] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 718ce4d601db ("net/mlx5: Consolidate update FTE for all removal changes")
Fixes: cefc23554fc2 ("net/mlx5: Fix FTE cleanup")
Signed-off-by: Mark Bloch <mbloch@nvidia.com>
Reviewed-by: Maor Gottlieb <maorg@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://patch.msgid.link/20241107183527.676877-4-tariqt@nvidia.com](https://patch.msgid.link/20241107183527.676877-4-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfba288f53192db08c68d4c568db9783fb9cb838)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=bfba288f53192db08c68d4c568db9783fb9cb838) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c b/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.cindex 164e10b5f9b7f7..50fdc3cbb778e6 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=a749b23059b43a9b1787eb36c5d9d44150a34238)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=bfba288f53192db08c68d4c568db9783fb9cb838)@@ -1880,13 +1880,22 @@ lookup\_fte\_locked(struct mlx5\_flow\_group \*g, fte\_tmp = NULL; goto out; }++ nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD);+ if (!fte\_tmp->node.active) {+ up\_write\_ref\_node(&fte\_tmp->node, false);++ if (take\_write)+ up\_write\_ref\_node(&g->node, false);+ else+ up\_read\_ref\_node(&g->node);+ tree\_put\_node(&fte\_tmp->node, false);- fte\_tmp = NULL;- goto out;++ return NULL; } - nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD); out: if (take\_write) up\_write\_ref\_node(&g->node, false); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:53 +0000



=== Content from git.kernel.org_b40f7068_20250114_190811.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Bloch <mbloch@nvidia.com> | 2024-11-07 20:35:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:38:31 +0100 |
| commit | [094d1a2121cee1e85ab07d74388f94809dcfb5b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9)) | |
| tree | [d24996da69488381c7a2c79ac6444b8d0ae720d4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9) | |
| parent | [ff825ab2f455299c0c7287550915a8878e2a66e0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff825ab2f455299c0c7287550915a8878e2a66e0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9&id2=ff825ab2f455299c0c7287550915a8878e2a66e0)) | |
| download | [linux-094d1a2121cee1e85ab07d74388f94809dcfb5b9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-094d1a2121cee1e85ab07d74388f94809dcfb5b9.tar.gz) | |

net/mlx5: fs, lock FTE when checking if active[ Upstream commit 9ca314419930f9135727e39d77e66262d5f7bef6 ]
The referenced commits introduced a two-step process for deleting FTEs:
- Lock the FTE, delete it from hardware, set the hardware deletion function
to NULL and unlock the FTE.
- Lock the parent flow group, delete the software copy of the FTE, and
remove it from the xarray.
However, this approach encounters a race condition if a rule with the same
match value is added simultaneously. In this scenario, fs\_core may set the
hardware deletion function to NULL prematurely, causing a panic during
subsequent rule deletions.
To prevent this, ensure the active flag of the FTE is checked under a lock,
which will prevent the fs\_core layer from attaching a new steering rule to
an FTE that is in the process of deletion.
[ 438.967589] MOSHE: 2496 mlx5\_del\_flow\_rules del\_hw\_func
[ 438.968205] ------------[ cut here ]------------
[ 438.968654] refcount\_t: decrement hit 0; leaking memory.
[ 438.969249] WARNING: CPU: 0 PID: 8957 at lib/refcount.c:31 refcount\_warn\_saturate+0xfb/0x110
[ 438.970054] Modules linked in: act\_mirred cls\_flower act\_gact sch\_ingress openvswitch nsh mlx5\_vdpa vringh vhost\_iotlb vdpa mlx5\_ib mlx5\_core xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter rpcsec\_gss\_krb5 auth\_rpcgss oid\_registry overlay rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm ib\_uverbs ib\_core zram zsmalloc fuse [last unloaded: cls\_flower]
[ 438.973288] CPU: 0 UID: 0 PID: 8957 Comm: tc Not tainted 6.12.0-rc1+ #8
[ 438.973888] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 438.974874] RIP: 0010:refcount\_warn\_saturate+0xfb/0x110
[ 438.975363] Code: 40 66 3b 82 c6 05 16 e9 4d 01 01 e8 1f 7c a0 ff 0f 0b c3 cc cc cc cc 48 c7 c7 10 66 3b 82 c6 05 fd e8 4d 01 01 e8 05 7c a0 ff <0f> 0b c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90
[ 438.976947] RSP: 0018:ffff888124a53610 EFLAGS: 00010286
[ 438.977446] RAX: 0000000000000000 RBX: ffff888119d56de0 RCX: 0000000000000000
[ 438.978090] RDX: ffff88852c828700 RSI: ffff88852c81b3c0 RDI: ffff88852c81b3c0
[ 438.978721] RBP: ffff888120fa0e88 R08: 0000000000000000 R09: ffff888124a534b0
[ 438.979353] R10: 0000000000000001 R11: 0000000000000001 R12: ffff888119d56de0
[ 438.979979] R13: ffff888120fa0ec0 R14: ffff888120fa0ee8 R15: ffff888119d56de0
[ 438.980607] FS: 00007fe6dcc0f800(0000) GS:ffff88852c800000(0000) knlGS:0000000000000000
[ 438.983984] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 438.984544] CR2: 00000000004275e0 CR3: 0000000186982001 CR4: 0000000000372eb0
[ 438.985205] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 438.985842] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 438.986507] Call Trace:
[ 438.986799] <TASK>
[ 438.987070] ? \_\_warn+0x7d/0x110
[ 438.987426] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.987877] ? report\_bug+0x17d/0x190
[ 438.988261] ? prb\_read\_valid+0x17/0x20
[ 438.988659] ? handle\_bug+0x53/0x90
[ 438.989054] ? exc\_invalid\_op+0x14/0x70
[ 438.989458] ? asm\_exc\_invalid\_op+0x16/0x20
[ 438.989883] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.990348] mlx5\_del\_flow\_rules+0x2f7/0x340 [mlx5\_core]
[ 438.990932] \_\_mlx5\_eswitch\_del\_rule+0x49/0x170 [mlx5\_core]
[ 438.991519] ? mlx5\_lag\_is\_sriov+0x3c/0x50 [mlx5\_core]
[ 438.992054] ? xas\_load+0x9/0xb0
[ 438.992407] mlx5e\_tc\_rule\_unoffload+0x45/0xe0 [mlx5\_core]
[ 438.993037] mlx5e\_tc\_del\_fdb\_flow+0x2a6/0x2e0 [mlx5\_core]
[ 438.993623] mlx5e\_flow\_put+0x29/0x60 [mlx5\_core]
[ 438.994161] mlx5e\_delete\_flower+0x261/0x390 [mlx5\_core]
[ 438.994728] tc\_setup\_cb\_destroy+0xb9/0x190
[ 438.995150] fl\_hw\_destroy\_filter+0x94/0xc0 [cls\_flower]
[ 438.995650] fl\_change+0x11a4/0x13c0 [cls\_flower]
[ 438.996105] tc\_new\_tfilter+0x347/0xbc0
[ 438.996503] ? \_\_\_slab\_alloc+0x70/0x8c0
[ 438.996929] rtnetlink\_rcv\_msg+0xf9/0x3e0
[ 438.997339] ? \_\_netlink\_sendskb+0x4c/0x70
[ 438.997751] ? netlink\_unicast+0x286/0x2d0
[ 438.998171] ? \_\_pfx\_rtnetlink\_rcv\_msg+0x10/0x10
[ 438.998625] netlink\_rcv\_skb+0x54/0x100
[ 438.999020] netlink\_unicast+0x203/0x2d0
[ 438.999421] netlink\_sendmsg+0x1e4/0x420
[ 438.999820] \_\_sock\_sendmsg+0xa1/0xb0
[ 439.000203] \_\_\_\_sys\_sendmsg+0x207/0x2a0
[ 439.000600] ? copy\_msghdr\_from\_user+0x6d/0xa0
[ 439.001072] \_\_\_sys\_sendmsg+0x80/0xc0
[ 439.001459] ? \_\_\_sys\_recvmsg+0x8b/0xc0
[ 439.001848] ? generic\_update\_time+0x4d/0x60
[ 439.002282] \_\_sys\_sendmsg+0x51/0x90
[ 439.002658] do\_syscall\_64+0x50/0x110
[ 439.003040] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 718ce4d601db ("net/mlx5: Consolidate update FTE for all removal changes")
Fixes: cefc23554fc2 ("net/mlx5: Fix FTE cleanup")
Signed-off-by: Mark Bloch <mbloch@nvidia.com>
Reviewed-by: Maor Gottlieb <maorg@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://patch.msgid.link/20241107183527.676877-4-tariqt@nvidia.com](https://patch.msgid.link/20241107183527.676877-4-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c b/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.cindex e2f7cecce6f1a0..991250f44c2ed1 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=ff825ab2f455299c0c7287550915a8878e2a66e0)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=094d1a2121cee1e85ab07d74388f94809dcfb5b9)@@ -1946,13 +1946,22 @@ lookup\_fte\_locked(struct mlx5\_flow\_group \*g, fte\_tmp = NULL; goto out; }++ nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD);+ if (!fte\_tmp->node.active) {+ up\_write\_ref\_node(&fte\_tmp->node, false);++ if (take\_write)+ up\_write\_ref\_node(&g->node, false);+ else+ up\_read\_ref\_node(&g->node);+ tree\_put\_node(&fte\_tmp->node, false);- fte\_tmp = NULL;- goto out;++ return NULL; } - nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD); out: if (take\_write) up\_write\_ref\_node(&g->node, false); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:48 +0000



=== Content from git.kernel.org_1e151e04_20250114_190812.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d568258f99f2076ab02e9234cbabbd43e12f30e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d568258f99f2076ab02e9234cbabbd43e12f30e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d568258f99f2076ab02e9234cbabbd43e12f30e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d568258f99f2076ab02e9234cbabbd43e12f30e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Bloch <mbloch@nvidia.com> | 2024-11-07 20:35:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:18 +0100 |
| commit | [0d568258f99f2076ab02e9234cbabbd43e12f30e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d568258f99f2076ab02e9234cbabbd43e12f30e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d568258f99f2076ab02e9234cbabbd43e12f30e)) | |
| tree | [bc692a2465e2759a1327c0fd5cc7e7a822e1c730](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d568258f99f2076ab02e9234cbabbd43e12f30e) | |
| parent | [598c956b62699c3753929602560d8df322e60559](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=598c956b62699c3753929602560d8df322e60559) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d568258f99f2076ab02e9234cbabbd43e12f30e&id2=598c956b62699c3753929602560d8df322e60559)) | |
| download | [linux-0d568258f99f2076ab02e9234cbabbd43e12f30e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d568258f99f2076ab02e9234cbabbd43e12f30e.tar.gz) | |

net/mlx5: fs, lock FTE when checking if active[ Upstream commit 9ca314419930f9135727e39d77e66262d5f7bef6 ]
The referenced commits introduced a two-step process for deleting FTEs:
- Lock the FTE, delete it from hardware, set the hardware deletion function
to NULL and unlock the FTE.
- Lock the parent flow group, delete the software copy of the FTE, and
remove it from the xarray.
However, this approach encounters a race condition if a rule with the same
match value is added simultaneously. In this scenario, fs\_core may set the
hardware deletion function to NULL prematurely, causing a panic during
subsequent rule deletions.
To prevent this, ensure the active flag of the FTE is checked under a lock,
which will prevent the fs\_core layer from attaching a new steering rule to
an FTE that is in the process of deletion.
[ 438.967589] MOSHE: 2496 mlx5\_del\_flow\_rules del\_hw\_func
[ 438.968205] ------------[ cut here ]------------
[ 438.968654] refcount\_t: decrement hit 0; leaking memory.
[ 438.969249] WARNING: CPU: 0 PID: 8957 at lib/refcount.c:31 refcount\_warn\_saturate+0xfb/0x110
[ 438.970054] Modules linked in: act\_mirred cls\_flower act\_gact sch\_ingress openvswitch nsh mlx5\_vdpa vringh vhost\_iotlb vdpa mlx5\_ib mlx5\_core xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter rpcsec\_gss\_krb5 auth\_rpcgss oid\_registry overlay rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm ib\_uverbs ib\_core zram zsmalloc fuse [last unloaded: cls\_flower]
[ 438.973288] CPU: 0 UID: 0 PID: 8957 Comm: tc Not tainted 6.12.0-rc1+ #8
[ 438.973888] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 438.974874] RIP: 0010:refcount\_warn\_saturate+0xfb/0x110
[ 438.975363] Code: 40 66 3b 82 c6 05 16 e9 4d 01 01 e8 1f 7c a0 ff 0f 0b c3 cc cc cc cc 48 c7 c7 10 66 3b 82 c6 05 fd e8 4d 01 01 e8 05 7c a0 ff <0f> 0b c3 cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90
[ 438.976947] RSP: 0018:ffff888124a53610 EFLAGS: 00010286
[ 438.977446] RAX: 0000000000000000 RBX: ffff888119d56de0 RCX: 0000000000000000
[ 438.978090] RDX: ffff88852c828700 RSI: ffff88852c81b3c0 RDI: ffff88852c81b3c0
[ 438.978721] RBP: ffff888120fa0e88 R08: 0000000000000000 R09: ffff888124a534b0
[ 438.979353] R10: 0000000000000001 R11: 0000000000000001 R12: ffff888119d56de0
[ 438.979979] R13: ffff888120fa0ec0 R14: ffff888120fa0ee8 R15: ffff888119d56de0
[ 438.980607] FS: 00007fe6dcc0f800(0000) GS:ffff88852c800000(0000) knlGS:0000000000000000
[ 438.983984] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 438.984544] CR2: 00000000004275e0 CR3: 0000000186982001 CR4: 0000000000372eb0
[ 438.985205] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 438.985842] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 438.986507] Call Trace:
[ 438.986799] <TASK>
[ 438.987070] ? \_\_warn+0x7d/0x110
[ 438.987426] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.987877] ? report\_bug+0x17d/0x190
[ 438.988261] ? prb\_read\_valid+0x17/0x20
[ 438.988659] ? handle\_bug+0x53/0x90
[ 438.989054] ? exc\_invalid\_op+0x14/0x70
[ 438.989458] ? asm\_exc\_invalid\_op+0x16/0x20
[ 438.989883] ? refcount\_warn\_saturate+0xfb/0x110
[ 438.990348] mlx5\_del\_flow\_rules+0x2f7/0x340 [mlx5\_core]
[ 438.990932] \_\_mlx5\_eswitch\_del\_rule+0x49/0x170 [mlx5\_core]
[ 438.991519] ? mlx5\_lag\_is\_sriov+0x3c/0x50 [mlx5\_core]
[ 438.992054] ? xas\_load+0x9/0xb0
[ 438.992407] mlx5e\_tc\_rule\_unoffload+0x45/0xe0 [mlx5\_core]
[ 438.993037] mlx5e\_tc\_del\_fdb\_flow+0x2a6/0x2e0 [mlx5\_core]
[ 438.993623] mlx5e\_flow\_put+0x29/0x60 [mlx5\_core]
[ 438.994161] mlx5e\_delete\_flower+0x261/0x390 [mlx5\_core]
[ 438.994728] tc\_setup\_cb\_destroy+0xb9/0x190
[ 438.995150] fl\_hw\_destroy\_filter+0x94/0xc0 [cls\_flower]
[ 438.995650] fl\_change+0x11a4/0x13c0 [cls\_flower]
[ 438.996105] tc\_new\_tfilter+0x347/0xbc0
[ 438.996503] ? \_\_\_slab\_alloc+0x70/0x8c0
[ 438.996929] rtnetlink\_rcv\_msg+0xf9/0x3e0
[ 438.997339] ? \_\_netlink\_sendskb+0x4c/0x70
[ 438.997751] ? netlink\_unicast+0x286/0x2d0
[ 438.998171] ? \_\_pfx\_rtnetlink\_rcv\_msg+0x10/0x10
[ 438.998625] netlink\_rcv\_skb+0x54/0x100
[ 438.999020] netlink\_unicast+0x203/0x2d0
[ 438.999421] netlink\_sendmsg+0x1e4/0x420
[ 438.999820] \_\_sock\_sendmsg+0xa1/0xb0
[ 439.000203] \_\_\_\_sys\_sendmsg+0x207/0x2a0
[ 439.000600] ? copy\_msghdr\_from\_user+0x6d/0xa0
[ 439.001072] \_\_\_sys\_sendmsg+0x80/0xc0
[ 439.001459] ? \_\_\_sys\_recvmsg+0x8b/0xc0
[ 439.001848] ? generic\_update\_time+0x4d/0x60
[ 439.002282] \_\_sys\_sendmsg+0x51/0x90
[ 439.002658] do\_syscall\_64+0x50/0x110
[ 439.003040] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 718ce4d601db ("net/mlx5: Consolidate update FTE for all removal changes")
Fixes: cefc23554fc2 ("net/mlx5: Fix FTE cleanup")
Signed-off-by: Mark Bloch <mbloch@nvidia.com>
Reviewed-by: Maor Gottlieb <maorg@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://patch.msgid.link/20241107183527.676877-4-tariqt@nvidia.com](https://patch.msgid.link/20241107183527.676877-4-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d568258f99f2076ab02e9234cbabbd43e12f30e)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=0d568258f99f2076ab02e9234cbabbd43e12f30e) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c b/drivers/net/ethernet/mellanox/mlx5/core/fs\_core.cindex 93fcde150a42fc..30d5b7f52a2a08 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=598c956b62699c3753929602560d8df322e60559)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/fs\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/fs_core.c?id=0d568258f99f2076ab02e9234cbabbd43e12f30e)@@ -1678,13 +1678,22 @@ lookup\_fte\_locked(struct mlx5\_flow\_group \*g, fte\_tmp = NULL; goto out; }++ nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD);+ if (!fte\_tmp->node.active) {+ up\_write\_ref\_node(&fte\_tmp->node, false);++ if (take\_write)+ up\_write\_ref\_node(&g->node, false);+ else+ up\_read\_ref\_node(&g->node);+ tree\_put\_node(&fte\_tmp->node, false);- fte\_tmp = NULL;- goto out;++ return NULL; } - nested\_down\_write\_ref\_node(&fte\_tmp->node, FS\_LOCK\_CHILD); out: if (take\_write) up\_write\_ref\_node(&g->node, false); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:49 +0000


