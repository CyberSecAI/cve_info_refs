=== Content from git.kernel.org_c5586d70_20250114_191034.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gao Xiang <hsiangkao@linux.alibaba.com> | 2024-11-16 01:36:51 +0800 |
| --- | --- | --- |
| committer | Gao Xiang <hsiangkao@linux.alibaba.com> | 2024-11-18 18:50:14 +0800 |
| commit | [0bc8061ffc733a0a246b8689b2d32a3e9204f43c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c)) | |
| tree | [6b813ab7246ef5a4aebd27ea2d46fbc177c6a259](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c) | |
| parent | [b49c0215b176e9c2e0998e7929eeb9261c9a7919](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b49c0215b176e9c2e0998e7929eeb9261c9a7919) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c&id2=b49c0215b176e9c2e0998e7929eeb9261c9a7919)) | |
| download | [linux-0bc8061ffc733a0a246b8689b2d32a3e9204f43c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0bc8061ffc733a0a246b8689b2d32a3e9204f43c.tar.gz) | |

erofs: handle NONHEAD !delta[1] lclusters gracefullysyzbot reported a WARNING in iomap\_iter\_done:
iomap\_fiemap+0x73b/0x9b0 fs/iomap/fiemap.c:80
ioctl\_fiemap fs/ioctl.c:220 [inline]
Generally, NONHEAD lclusters won't have delta[1]==0, except for crafted
images and filesystems created by pre-1.0 mkfs versions.
Previously, it would immediately bail out if delta[1]==0, which led to
inadequate decompressed lengths (thus FIEMAP is impacted). Treat it as
delta[1]=1 to work around these legacy mkfs versions.
`lclusterbits > 14` is illegal for compact indexes, error out too.
Reported-by: syzbot+6c0b301317aa0156f9eb@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/r/67373c0c.050a0220.2a2fcc.0079.GAE@google.com
Tested-by: syzbot+6c0b301317aa0156f9eb@syzkaller.appspotmail.com
Fixes: d95ae5e25326 ("erofs: add support for the full decompressed length")
Fixes: 001b8ccd0650 ("erofs: fix compact 4B support for 16k block size")
Signed-off-by: Gao Xiang <hsiangkao@linux.alibaba.com>
Link: [https://lore.kernel.org/r/20241115173651.3339514-1-hsiangkao@linux.alibaba.com](https://lore.kernel.org/r/20241115173651.3339514-1-hsiangkao%40linux.alibaba.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c)

| -rw-r--r-- | [fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/erofs/zmap.c?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 8 deletions

| diff --git a/fs/erofs/zmap.c b/fs/erofs/zmap.cindex a076cca1f54734..4535f2f0a0147e 100644--- a/[fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/erofs/zmap.c?id=b49c0215b176e9c2e0998e7929eeb9261c9a7919)+++ b/[fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/erofs/zmap.c?id=0bc8061ffc733a0a246b8689b2d32a3e9204f43c)@@ -219,7 +219,7 @@ static int z\_erofs\_load\_compact\_lcluster(struct z\_erofs\_maprecorder \*m, unsigned int amortizedshift; erofs\_off\_t pos; - if (lcn >= totalidx)+ if (lcn >= totalidx || vi->z\_logical\_clusterbits > 14) return -EINVAL;  m->lcn = lcn;@@ -390,7 +390,7 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) u64 lcn = m->lcn, headlcn = map->m\_la >> lclusterbits; int err; - do {+ while (1) { /\* handle the last EOF pcluster (no next HEAD lcluster) \*/ if ((lcn << lclusterbits) >= inode->i\_size) { map->m\_llen = inode->i\_size - map->m\_la;@@ -402,14 +402,16 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) return err;  if (m->type == Z\_EROFS\_LCLUSTER\_TYPE\_NONHEAD) {- DBG\_BUGON(!m->delta[1] &&- m->clusterofs != 1 << lclusterbits);+ /\* work around invalid d1 generated by pre-1.0 mkfs \*/+ if (unlikely(!m->delta[1])) {+ m->delta[1] = 1;+ DBG\_BUGON(1);+ } } else if (m->type == Z\_EROFS\_LCLUSTER\_TYPE\_PLAIN || m->type == Z\_EROFS\_LCLUSTER\_TYPE\_HEAD1 || m->type == Z\_EROFS\_LCLUSTER\_TYPE\_HEAD2) {- /\* go on until the next HEAD lcluster \*/ if (lcn != headlcn)- break;+ break; /\* ends at the next HEAD lcluster \*/ m->delta[1] = 1; } else { erofs\_err(inode->i\_sb, "unknown type %u @ lcn %llu of nid %llu",@@ -418,8 +420,7 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) return -EOPNOTSUPP; } lcn += m->delta[1];- } while (m->delta[1]);-+ } map->m\_llen = (lcn << lclusterbits) + m->clusterofs - map->m\_la; return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:09:11 +0000



=== Content from git.kernel.org_96be4323_20250114_191035.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=daaf68fef4b2ff97928227630021d37b27a96655)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=daaf68fef4b2ff97928227630021d37b27a96655)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=daaf68fef4b2ff97928227630021d37b27a96655)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=daaf68fef4b2ff97928227630021d37b27a96655)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gao Xiang <hsiangkao@linux.alibaba.com> | 2024-11-16 01:36:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:00 +0100 |
| commit | [daaf68fef4b2ff97928227630021d37b27a96655](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=daaf68fef4b2ff97928227630021d37b27a96655) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=daaf68fef4b2ff97928227630021d37b27a96655)) | |
| tree | [884cd69a9545ca5a201a3c85c61518e34f819559](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=daaf68fef4b2ff97928227630021d37b27a96655) | |
| parent | [679d8537e5748241c71ac97a6b6dc919eae31716](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=679d8537e5748241c71ac97a6b6dc919eae31716) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=daaf68fef4b2ff97928227630021d37b27a96655&id2=679d8537e5748241c71ac97a6b6dc919eae31716)) | |
| download | [linux-daaf68fef4b2ff97928227630021d37b27a96655.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-daaf68fef4b2ff97928227630021d37b27a96655.tar.gz) | |

erofs: handle NONHEAD !delta[1] lclusters gracefully[ Upstream commit 0bc8061ffc733a0a246b8689b2d32a3e9204f43c ]
syzbot reported a WARNING in iomap\_iter\_done:
iomap\_fiemap+0x73b/0x9b0 fs/iomap/fiemap.c:80
ioctl\_fiemap fs/ioctl.c:220 [inline]
Generally, NONHEAD lclusters won't have delta[1]==0, except for crafted
images and filesystems created by pre-1.0 mkfs versions.
Previously, it would immediately bail out if delta[1]==0, which led to
inadequate decompressed lengths (thus FIEMAP is impacted). Treat it as
delta[1]=1 to work around these legacy mkfs versions.
`lclusterbits > 14` is illegal for compact indexes, error out too.
Reported-by: syzbot+6c0b301317aa0156f9eb@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/r/67373c0c.050a0220.2a2fcc.0079.GAE@google.com
Tested-by: syzbot+6c0b301317aa0156f9eb@syzkaller.appspotmail.com
Fixes: d95ae5e25326 ("erofs: add support for the full decompressed length")
Fixes: 001b8ccd0650 ("erofs: fix compact 4B support for 16k block size")
Signed-off-by: Gao Xiang <hsiangkao@linux.alibaba.com>
Link: [https://lore.kernel.org/r/20241115173651.3339514-1-hsiangkao@linux.alibaba.com](https://lore.kernel.org/r/20241115173651.3339514-1-hsiangkao%40linux.alibaba.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=daaf68fef4b2ff97928227630021d37b27a96655)

| -rw-r--r-- | [fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/erofs/zmap.c?id=daaf68fef4b2ff97928227630021d37b27a96655) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 8 deletions

| diff --git a/fs/erofs/zmap.c b/fs/erofs/zmap.cindex a076cca1f54734..4535f2f0a0147e 100644--- a/[fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/erofs/zmap.c?id=679d8537e5748241c71ac97a6b6dc919eae31716)+++ b/[fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/erofs/zmap.c?id=daaf68fef4b2ff97928227630021d37b27a96655)@@ -219,7 +219,7 @@ static int z\_erofs\_load\_compact\_lcluster(struct z\_erofs\_maprecorder \*m, unsigned int amortizedshift; erofs\_off\_t pos; - if (lcn >= totalidx)+ if (lcn >= totalidx || vi->z\_logical\_clusterbits > 14) return -EINVAL;  m->lcn = lcn;@@ -390,7 +390,7 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) u64 lcn = m->lcn, headlcn = map->m\_la >> lclusterbits; int err; - do {+ while (1) { /\* handle the last EOF pcluster (no next HEAD lcluster) \*/ if ((lcn << lclusterbits) >= inode->i\_size) { map->m\_llen = inode->i\_size - map->m\_la;@@ -402,14 +402,16 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) return err;  if (m->type == Z\_EROFS\_LCLUSTER\_TYPE\_NONHEAD) {- DBG\_BUGON(!m->delta[1] &&- m->clusterofs != 1 << lclusterbits);+ /\* work around invalid d1 generated by pre-1.0 mkfs \*/+ if (unlikely(!m->delta[1])) {+ m->delta[1] = 1;+ DBG\_BUGON(1);+ } } else if (m->type == Z\_EROFS\_LCLUSTER\_TYPE\_PLAIN || m->type == Z\_EROFS\_LCLUSTER\_TYPE\_HEAD1 || m->type == Z\_EROFS\_LCLUSTER\_TYPE\_HEAD2) {- /\* go on until the next HEAD lcluster \*/ if (lcn != headlcn)- break;+ break; /\* ends at the next HEAD lcluster \*/ m->delta[1] = 1; } else { erofs\_err(inode->i\_sb, "unknown type %u @ lcn %llu of nid %llu",@@ -418,8 +420,7 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) return -EOPNOTSUPP; } lcn += m->delta[1];- } while (m->delta[1]);-+ } map->m\_llen = (lcn << lclusterbits) + m->clusterofs - map->m\_la; return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:09:12 +0000



=== Content from git.kernel.org_c9db7ab2_20250114_191036.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f466641debcbea8bdf78d1b63a6270aadf9301bf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f466641debcbea8bdf78d1b63a6270aadf9301bf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f466641debcbea8bdf78d1b63a6270aadf9301bf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f466641debcbea8bdf78d1b63a6270aadf9301bf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gao Xiang <hsiangkao@linux.alibaba.com> | 2024-11-16 01:36:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:11 +0100 |
| commit | [f466641debcbea8bdf78d1b63a6270aadf9301bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f466641debcbea8bdf78d1b63a6270aadf9301bf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f466641debcbea8bdf78d1b63a6270aadf9301bf)) | |
| tree | [5b63fa67f8c82d7521e49e4824ac149fd57a4d8f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f466641debcbea8bdf78d1b63a6270aadf9301bf) | |
| parent | [de5a44f351ca7efd9add9851b218f5353e2224b7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de5a44f351ca7efd9add9851b218f5353e2224b7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f466641debcbea8bdf78d1b63a6270aadf9301bf&id2=de5a44f351ca7efd9add9851b218f5353e2224b7)) | |
| download | [linux-f466641debcbea8bdf78d1b63a6270aadf9301bf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f466641debcbea8bdf78d1b63a6270aadf9301bf.tar.gz) | |

erofs: handle NONHEAD !delta[1] lclusters gracefully[ Upstream commit 0bc8061ffc733a0a246b8689b2d32a3e9204f43c ]
syzbot reported a WARNING in iomap\_iter\_done:
iomap\_fiemap+0x73b/0x9b0 fs/iomap/fiemap.c:80
ioctl\_fiemap fs/ioctl.c:220 [inline]
Generally, NONHEAD lclusters won't have delta[1]==0, except for crafted
images and filesystems created by pre-1.0 mkfs versions.
Previously, it would immediately bail out if delta[1]==0, which led to
inadequate decompressed lengths (thus FIEMAP is impacted). Treat it as
delta[1]=1 to work around these legacy mkfs versions.
`lclusterbits > 14` is illegal for compact indexes, error out too.
Reported-by: syzbot+6c0b301317aa0156f9eb@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/r/67373c0c.050a0220.2a2fcc.0079.GAE@google.com
Tested-by: syzbot+6c0b301317aa0156f9eb@syzkaller.appspotmail.com
Fixes: d95ae5e25326 ("erofs: add support for the full decompressed length")
Fixes: 001b8ccd0650 ("erofs: fix compact 4B support for 16k block size")
Signed-off-by: Gao Xiang <hsiangkao@linux.alibaba.com>
Link: [https://lore.kernel.org/r/20241115173651.3339514-1-hsiangkao@linux.alibaba.com](https://lore.kernel.org/r/20241115173651.3339514-1-hsiangkao%40linux.alibaba.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f466641debcbea8bdf78d1b63a6270aadf9301bf)

| -rw-r--r-- | [fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/erofs/zmap.c?id=f466641debcbea8bdf78d1b63a6270aadf9301bf) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 8 deletions

| diff --git a/fs/erofs/zmap.c b/fs/erofs/zmap.cindex 6bd435a565f614..76566c2cbf63eb 100644--- a/[fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/erofs/zmap.c?id=de5a44f351ca7efd9add9851b218f5353e2224b7)+++ b/[fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/erofs/zmap.c?id=f466641debcbea8bdf78d1b63a6270aadf9301bf)@@ -234,7 +234,7 @@ static int z\_erofs\_load\_compact\_lcluster(struct z\_erofs\_maprecorder \*m, unsigned int amortizedshift; erofs\_off\_t pos; - if (lcn >= totalidx)+ if (lcn >= totalidx || vi->z\_logical\_clusterbits > 14) return -EINVAL;  m->lcn = lcn;@@ -409,7 +409,7 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) u64 lcn = m->lcn, headlcn = map->m\_la >> lclusterbits; int err; - do {+ while (1) { /\* handle the last EOF pcluster (no next HEAD lcluster) \*/ if ((lcn << lclusterbits) >= inode->i\_size) { map->m\_llen = inode->i\_size - map->m\_la;@@ -421,14 +421,16 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) return err;  if (m->type == Z\_EROFS\_LCLUSTER\_TYPE\_NONHEAD) {- DBG\_BUGON(!m->delta[1] &&- m->clusterofs != 1 << lclusterbits);+ /\* work around invalid d1 generated by pre-1.0 mkfs \*/+ if (unlikely(!m->delta[1])) {+ m->delta[1] = 1;+ DBG\_BUGON(1);+ } } else if (m->type == Z\_EROFS\_LCLUSTER\_TYPE\_PLAIN || m->type == Z\_EROFS\_LCLUSTER\_TYPE\_HEAD1 || m->type == Z\_EROFS\_LCLUSTER\_TYPE\_HEAD2) {- /\* go on until the next HEAD lcluster \*/ if (lcn != headlcn)- break;+ break; /\* ends at the next HEAD lcluster \*/ m->delta[1] = 1; } else { erofs\_err(inode->i\_sb, "unknown type %u @ lcn %llu of nid %llu",@@ -437,8 +439,7 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) return -EOPNOTSUPP; } lcn += m->delta[1];- } while (m->delta[1]);-+ } map->m\_llen = (lcn << lclusterbits) + m->clusterofs - map->m\_la; return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:09:13 +0000



=== Content from git.kernel.org_874d5327_20250114_191034.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=480c6c7b55aeacac800bc2a0d321ff53273045e5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=480c6c7b55aeacac800bc2a0d321ff53273045e5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=480c6c7b55aeacac800bc2a0d321ff53273045e5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=480c6c7b55aeacac800bc2a0d321ff53273045e5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gao Xiang <hsiangkao@linux.alibaba.com> | 2024-11-16 01:36:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:28 +0100 |
| commit | [480c6c7b55aeacac800bc2a0d321ff53273045e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=480c6c7b55aeacac800bc2a0d321ff53273045e5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=480c6c7b55aeacac800bc2a0d321ff53273045e5)) | |
| tree | [a33c633be3d5453c4a07d18228499552768d2587](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=480c6c7b55aeacac800bc2a0d321ff53273045e5) | |
| parent | [7f0d0dd5a7f437d83cff954bc321f1a9b181efd5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f0d0dd5a7f437d83cff954bc321f1a9b181efd5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=480c6c7b55aeacac800bc2a0d321ff53273045e5&id2=7f0d0dd5a7f437d83cff954bc321f1a9b181efd5)) | |
| download | [linux-480c6c7b55aeacac800bc2a0d321ff53273045e5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-480c6c7b55aeacac800bc2a0d321ff53273045e5.tar.gz) | |

erofs: handle NONHEAD !delta[1] lclusters gracefully[ Upstream commit 0bc8061ffc733a0a246b8689b2d32a3e9204f43c ]
syzbot reported a WARNING in iomap\_iter\_done:
iomap\_fiemap+0x73b/0x9b0 fs/iomap/fiemap.c:80
ioctl\_fiemap fs/ioctl.c:220 [inline]
Generally, NONHEAD lclusters won't have delta[1]==0, except for crafted
images and filesystems created by pre-1.0 mkfs versions.
Previously, it would immediately bail out if delta[1]==0, which led to
inadequate decompressed lengths (thus FIEMAP is impacted). Treat it as
delta[1]=1 to work around these legacy mkfs versions.
`lclusterbits > 14` is illegal for compact indexes, error out too.
Reported-by: syzbot+6c0b301317aa0156f9eb@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/r/67373c0c.050a0220.2a2fcc.0079.GAE@google.com
Tested-by: syzbot+6c0b301317aa0156f9eb@syzkaller.appspotmail.com
Fixes: d95ae5e25326 ("erofs: add support for the full decompressed length")
Fixes: 001b8ccd0650 ("erofs: fix compact 4B support for 16k block size")
Signed-off-by: Gao Xiang <hsiangkao@linux.alibaba.com>
Link: [https://lore.kernel.org/r/20241115173651.3339514-1-hsiangkao@linux.alibaba.com](https://lore.kernel.org/r/20241115173651.3339514-1-hsiangkao%40linux.alibaba.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=480c6c7b55aeacac800bc2a0d321ff53273045e5)

| -rw-r--r-- | [fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/erofs/zmap.c?id=480c6c7b55aeacac800bc2a0d321ff53273045e5) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 8 deletions

| diff --git a/fs/erofs/zmap.c b/fs/erofs/zmap.cindex 403af6e31d5b2c..8d28cfc6a4b837 100644--- a/[fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/erofs/zmap.c?id=7f0d0dd5a7f437d83cff954bc321f1a9b181efd5)+++ b/[fs/erofs/zmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/erofs/zmap.c?id=480c6c7b55aeacac800bc2a0d321ff53273045e5)@@ -223,7 +223,7 @@ static int z\_erofs\_load\_compact\_lcluster(struct z\_erofs\_maprecorder \*m, unsigned int amortizedshift; erofs\_off\_t pos; - if (lcn >= totalidx)+ if (lcn >= totalidx || vi->z\_logical\_clusterbits > 14) return -EINVAL;  m->lcn = lcn;@@ -398,7 +398,7 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) u64 lcn = m->lcn, headlcn = map->m\_la >> lclusterbits; int err; - do {+ while (1) { /\* handle the last EOF pcluster (no next HEAD lcluster) \*/ if ((lcn << lclusterbits) >= inode->i\_size) { map->m\_llen = inode->i\_size - map->m\_la;@@ -410,14 +410,16 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) return err;  if (m->type == Z\_EROFS\_LCLUSTER\_TYPE\_NONHEAD) {- DBG\_BUGON(!m->delta[1] &&- m->clusterofs != 1 << lclusterbits);+ /\* work around invalid d1 generated by pre-1.0 mkfs \*/+ if (unlikely(!m->delta[1])) {+ m->delta[1] = 1;+ DBG\_BUGON(1);+ } } else if (m->type == Z\_EROFS\_LCLUSTER\_TYPE\_PLAIN || m->type == Z\_EROFS\_LCLUSTER\_TYPE\_HEAD1 || m->type == Z\_EROFS\_LCLUSTER\_TYPE\_HEAD2) {- /\* go on until the next HEAD lcluster \*/ if (lcn != headlcn)- break;+ break; /\* ends at the next HEAD lcluster \*/ m->delta[1] = 1; } else { erofs\_err(inode->i\_sb, "unknown type %u @ lcn %llu of nid %llu",@@ -426,8 +428,7 @@ static int z\_erofs\_get\_extent\_decompressedlen(struct z\_erofs\_maprecorder \*m) return -EOPNOTSUPP; } lcn += m->delta[1];- } while (m->delta[1]);-+ } map->m\_llen = (lcn << lclusterbits) + m->clusterofs - map->m\_la; return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:09:11 +0000


