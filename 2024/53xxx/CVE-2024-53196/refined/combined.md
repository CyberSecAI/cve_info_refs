=== Content from git.kernel.org_a21a6a79_20250114_202803.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Oliver Upton <oliver.upton@linux.dev> | 2024-10-25 20:31:03 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:09 +0100 |
| commit | [1e46460efe1ef9a31748de7675ff8fe0d8601af2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2)) | |
| tree | [7aeaf6f805632a81284f3e12f952cba12c7db948](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2) | |
| parent | [91991cfda279b4a5d5d518a3bd2cf9eb285415b8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91991cfda279b4a5d5d518a3bd2cf9eb285415b8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2&id2=91991cfda279b4a5d5d518a3bd2cf9eb285415b8)) | |
| download | [linux-1e46460efe1ef9a31748de7675ff8fe0d8601af2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1e46460efe1ef9a31748de7675ff8fe0d8601af2.tar.gz) | |

KVM: arm64: Don't retire aborted MMIO instructioncommit e735a5da64420a86be370b216c269b5dd8e830e2 upstream.
Returning an abort to the guest for an unsupported MMIO access is a
documented feature of the KVM UAPI. Nevertheless, it's clear that this
plumbing has seen limited testing, since userspace can trivially cause a
WARN in the MMIO return:
WARNING: CPU: 0 PID: 30558 at arch/arm64/include/asm/kvm\_emulate.h:536 kvm\_handle\_mmio\_return+0x46c/0x5c4 arch/arm64/include/asm/kvm\_emulate.h:536
Call trace:
kvm\_handle\_mmio\_return+0x46c/0x5c4 arch/arm64/include/asm/kvm\_emulate.h:536
kvm\_arch\_vcpu\_ioctl\_run+0x98/0x15b4 arch/arm64/kvm/arm.c:1133
kvm\_vcpu\_ioctl+0x75c/0xa78 virt/kvm/kvm\_main.c:4487
\_\_do\_sys\_ioctl fs/ioctl.c:51 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:893 [inline]
\_\_arm64\_sys\_ioctl+0x14c/0x1c8 fs/ioctl.c:893
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:35 [inline]
invoke\_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:49
el0\_svc\_common+0x1e0/0x23c arch/arm64/kernel/syscall.c:132
do\_el0\_svc+0x48/0x58 arch/arm64/kernel/syscall.c:151
el0\_svc+0x38/0x68 arch/arm64/kernel/entry-common.c:712
el0t\_64\_sync\_handler+0x90/0xfc arch/arm64/kernel/entry-common.c:730
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:598
The splat is complaining that KVM is advancing PC while an exception is
pending, i.e. that KVM is retiring the MMIO instruction despite a
pending synchronous external abort. Womp womp.
Fix the glaring UAPI bug by skipping over all the MMIO emulation in
case there is a pending synchronous exception. Note that while userspace
is capable of pending an asynchronous exception (SError, IRQ, or FIQ),
it is still safe to retire the MMIO instruction in this case as (1) they
are by definition asynchronous, and (2) KVM relies on hardware support
for pending/delivering these exceptions instead of the software state
machine for advancing PC.
Cc: stable@vger.kernel.org
Fixes: da345174ceca ("KVM: arm/arm64: Allow user injection of external data aborts")
Reported-by: Alexander Potapenko <glider@google.com>
Reviewed-by: Marc Zyngier <maz@kernel.org>
Link: [https://lore.kernel.org/r/20241025203106.3529261-2-oliver.upton@linux.dev](https://lore.kernel.org/r/20241025203106.3529261-2-oliver.upton%40linux.dev)
Signed-off-by: Oliver Upton <oliver.upton@linux.dev>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2)

| -rw-r--r-- | [arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/mmio.c?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 2 deletions

| diff --git a/arch/arm64/kvm/mmio.c b/arch/arm64/kvm/mmio.cindex cd6b7b83e2c370..ab365e839874e5 100644--- a/[arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/mmio.c?id=91991cfda279b4a5d5d518a3bd2cf9eb285415b8)+++ b/[arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/mmio.c?id=1e46460efe1ef9a31748de7675ff8fe0d8601af2)@@ -72,6 +72,31 @@ unsigned long kvm\_mmio\_read\_buf(const void \*buf, unsigned int len) return data; } +static bool kvm\_pending\_sync\_exception(struct kvm\_vcpu \*vcpu)+{+ if (!vcpu\_get\_flag(vcpu, PENDING\_EXCEPTION))+ return false;++ if (vcpu\_el1\_is\_32bit(vcpu)) {+ switch (vcpu\_get\_flag(vcpu, EXCEPT\_MASK)) {+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_UND):+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_IABT):+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_DABT):+ return true;+ default:+ return false;+ }+ } else {+ switch (vcpu\_get\_flag(vcpu, EXCEPT\_MASK)) {+ case unpack\_vcpu\_flag(EXCEPT\_AA64\_EL1\_SYNC):+ case unpack\_vcpu\_flag(EXCEPT\_AA64\_EL2\_SYNC):+ return true;+ default:+ return false;+ }+ }+}+ /\*\* \* kvm\_handle\_mmio\_return -- Handle MMIO loads after user space emulation \* or in-kernel IO emulation@@ -84,8 +109,11 @@ int kvm\_handle\_mmio\_return(struct kvm\_vcpu \*vcpu) unsigned int len; int mask; - /\* Detect an already handled MMIO return \*/- if (unlikely(!vcpu->mmio\_needed))+ /\*+ \* Detect if the MMIO return was already handled or if userspace aborted+ \* the MMIO access.+ \*/+ if (unlikely(!vcpu->mmio\_needed || kvm\_pending\_sync\_exception(vcpu))) return 1;  vcpu->mmio\_needed = 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:26:40 +0000



=== Content from git.kernel.org_c023ad4e_20250114_202804.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e735a5da64420a86be370b216c269b5dd8e830e2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e735a5da64420a86be370b216c269b5dd8e830e2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e735a5da64420a86be370b216c269b5dd8e830e2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e735a5da64420a86be370b216c269b5dd8e830e2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Oliver Upton <oliver.upton@linux.dev> | 2024-10-25 20:31:03 +0000 |
| --- | --- | --- |
| committer | Oliver Upton <oliver.upton@linux.dev> | 2024-10-26 14:37:49 +0000 |
| commit | [e735a5da64420a86be370b216c269b5dd8e830e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e735a5da64420a86be370b216c269b5dd8e830e2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e735a5da64420a86be370b216c269b5dd8e830e2)) | |
| tree | [f0510a11ac22de68ba2fee31a8a36db2b303f5a2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e735a5da64420a86be370b216c269b5dd8e830e2) | |
| parent | [8e929cb546ee42c9a61d24fae60605e9e3192354](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e929cb546ee42c9a61d24fae60605e9e3192354) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e735a5da64420a86be370b216c269b5dd8e830e2&id2=8e929cb546ee42c9a61d24fae60605e9e3192354)) | |
| download | [linux-e735a5da64420a86be370b216c269b5dd8e830e2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e735a5da64420a86be370b216c269b5dd8e830e2.tar.gz) | |

KVM: arm64: Don't retire aborted MMIO instructionReturning an abort to the guest for an unsupported MMIO access is a
documented feature of the KVM UAPI. Nevertheless, it's clear that this
plumbing has seen limited testing, since userspace can trivially cause a
WARN in the MMIO return:
WARNING: CPU: 0 PID: 30558 at arch/arm64/include/asm/kvm\_emulate.h:536 kvm\_handle\_mmio\_return+0x46c/0x5c4 arch/arm64/include/asm/kvm\_emulate.h:536
Call trace:
kvm\_handle\_mmio\_return+0x46c/0x5c4 arch/arm64/include/asm/kvm\_emulate.h:536
kvm\_arch\_vcpu\_ioctl\_run+0x98/0x15b4 arch/arm64/kvm/arm.c:1133
kvm\_vcpu\_ioctl+0x75c/0xa78 virt/kvm/kvm\_main.c:4487
\_\_do\_sys\_ioctl fs/ioctl.c:51 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:893 [inline]
\_\_arm64\_sys\_ioctl+0x14c/0x1c8 fs/ioctl.c:893
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:35 [inline]
invoke\_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:49
el0\_svc\_common+0x1e0/0x23c arch/arm64/kernel/syscall.c:132
do\_el0\_svc+0x48/0x58 arch/arm64/kernel/syscall.c:151
el0\_svc+0x38/0x68 arch/arm64/kernel/entry-common.c:712
el0t\_64\_sync\_handler+0x90/0xfc arch/arm64/kernel/entry-common.c:730
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:598
The splat is complaining that KVM is advancing PC while an exception is
pending, i.e. that KVM is retiring the MMIO instruction despite a
pending synchronous external abort. Womp womp.
Fix the glaring UAPI bug by skipping over all the MMIO emulation in
case there is a pending synchronous exception. Note that while userspace
is capable of pending an asynchronous exception (SError, IRQ, or FIQ),
it is still safe to retire the MMIO instruction in this case as (1) they
are by definition asynchronous, and (2) KVM relies on hardware support
for pending/delivering these exceptions instead of the software state
machine for advancing PC.
Cc: stable@vger.kernel.org
Fixes: da345174ceca ("KVM: arm/arm64: Allow user injection of external data aborts")
Reported-by: Alexander Potapenko <glider@google.com>
Reviewed-by: Marc Zyngier <maz@kernel.org>
Link: [https://lore.kernel.org/r/20241025203106.3529261-2-oliver.upton@linux.dev](https://lore.kernel.org/r/20241025203106.3529261-2-oliver.upton%40linux.dev)
Signed-off-by: Oliver Upton <oliver.upton@linux.dev>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e735a5da64420a86be370b216c269b5dd8e830e2)

| -rw-r--r-- | [arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/mmio.c?id=e735a5da64420a86be370b216c269b5dd8e830e2) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 2 deletions

| diff --git a/arch/arm64/kvm/mmio.c b/arch/arm64/kvm/mmio.cindex cd6b7b83e2c370..ab365e839874e5 100644--- a/[arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/mmio.c?id=8e929cb546ee42c9a61d24fae60605e9e3192354)+++ b/[arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/mmio.c?id=e735a5da64420a86be370b216c269b5dd8e830e2)@@ -72,6 +72,31 @@ unsigned long kvm\_mmio\_read\_buf(const void \*buf, unsigned int len) return data; } +static bool kvm\_pending\_sync\_exception(struct kvm\_vcpu \*vcpu)+{+ if (!vcpu\_get\_flag(vcpu, PENDING\_EXCEPTION))+ return false;++ if (vcpu\_el1\_is\_32bit(vcpu)) {+ switch (vcpu\_get\_flag(vcpu, EXCEPT\_MASK)) {+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_UND):+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_IABT):+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_DABT):+ return true;+ default:+ return false;+ }+ } else {+ switch (vcpu\_get\_flag(vcpu, EXCEPT\_MASK)) {+ case unpack\_vcpu\_flag(EXCEPT\_AA64\_EL1\_SYNC):+ case unpack\_vcpu\_flag(EXCEPT\_AA64\_EL2\_SYNC):+ return true;+ default:+ return false;+ }+ }+}+ /\*\* \* kvm\_handle\_mmio\_return -- Handle MMIO loads after user space emulation \* or in-kernel IO emulation@@ -84,8 +109,11 @@ int kvm\_handle\_mmio\_return(struct kvm\_vcpu \*vcpu) unsigned int len; int mask; - /\* Detect an already handled MMIO return \*/- if (unlikely(!vcpu->mmio\_needed))+ /\*+ \* Detect if the MMIO return was already handled or if userspace aborted+ \* the MMIO access.+ \*/+ if (unlikely(!vcpu->mmio\_needed || kvm\_pending\_sync\_exception(vcpu))) return 1;  vcpu->mmio\_needed = 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:26:42 +0000



=== Content from git.kernel.org_6ae0090a_20250114_202805.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Oliver Upton <oliver.upton@linux.dev> | 2024-10-25 20:31:03 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:40 +0100 |
| commit | [ea6b5d98fea4ee8cb443ea98fda520909e90d30e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e)) | |
| tree | [ff5e4084d55985c715a71b9d7dc4273a3cec0351](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e) | |
| parent | [3fe534a02897f5fb8a83c3a5d4447831d0cc9204](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3fe534a02897f5fb8a83c3a5d4447831d0cc9204) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e&id2=3fe534a02897f5fb8a83c3a5d4447831d0cc9204)) | |
| download | [linux-ea6b5d98fea4ee8cb443ea98fda520909e90d30e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ea6b5d98fea4ee8cb443ea98fda520909e90d30e.tar.gz) | |

KVM: arm64: Don't retire aborted MMIO instruction[ Upstream commit e735a5da64420a86be370b216c269b5dd8e830e2 ]
Returning an abort to the guest for an unsupported MMIO access is a
documented feature of the KVM UAPI. Nevertheless, it's clear that this
plumbing has seen limited testing, since userspace can trivially cause a
WARN in the MMIO return:
WARNING: CPU: 0 PID: 30558 at arch/arm64/include/asm/kvm\_emulate.h:536 kvm\_handle\_mmio\_return+0x46c/0x5c4 arch/arm64/include/asm/kvm\_emulate.h:536
Call trace:
kvm\_handle\_mmio\_return+0x46c/0x5c4 arch/arm64/include/asm/kvm\_emulate.h:536
kvm\_arch\_vcpu\_ioctl\_run+0x98/0x15b4 arch/arm64/kvm/arm.c:1133
kvm\_vcpu\_ioctl+0x75c/0xa78 virt/kvm/kvm\_main.c:4487
\_\_do\_sys\_ioctl fs/ioctl.c:51 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:893 [inline]
\_\_arm64\_sys\_ioctl+0x14c/0x1c8 fs/ioctl.c:893
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:35 [inline]
invoke\_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:49
el0\_svc\_common+0x1e0/0x23c arch/arm64/kernel/syscall.c:132
do\_el0\_svc+0x48/0x58 arch/arm64/kernel/syscall.c:151
el0\_svc+0x38/0x68 arch/arm64/kernel/entry-common.c:712
el0t\_64\_sync\_handler+0x90/0xfc arch/arm64/kernel/entry-common.c:730
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:598
The splat is complaining that KVM is advancing PC while an exception is
pending, i.e. that KVM is retiring the MMIO instruction despite a
pending synchronous external abort. Womp womp.
Fix the glaring UAPI bug by skipping over all the MMIO emulation in
case there is a pending synchronous exception. Note that while userspace
is capable of pending an asynchronous exception (SError, IRQ, or FIQ),
it is still safe to retire the MMIO instruction in this case as (1) they
are by definition asynchronous, and (2) KVM relies on hardware support
for pending/delivering these exceptions instead of the software state
machine for advancing PC.
Cc: stable@vger.kernel.org
Fixes: da345174ceca ("KVM: arm/arm64: Allow user injection of external data aborts")
Reported-by: Alexander Potapenko <glider@google.com>
Reviewed-by: Marc Zyngier <maz@kernel.org>
Link: [https://lore.kernel.org/r/20241025203106.3529261-2-oliver.upton@linux.dev](https://lore.kernel.org/r/20241025203106.3529261-2-oliver.upton%40linux.dev)
Signed-off-by: Oliver Upton <oliver.upton@linux.dev>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e)

| -rw-r--r-- | [arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/mmio.c?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 2 deletions

| diff --git a/arch/arm64/kvm/mmio.c b/arch/arm64/kvm/mmio.cindex 886ef30e121968..2aa503ff742ee5 100644--- a/[arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/mmio.c?id=3fe534a02897f5fb8a83c3a5d4447831d0cc9204)+++ b/[arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/mmio.c?id=ea6b5d98fea4ee8cb443ea98fda520909e90d30e)@@ -72,6 +72,31 @@ unsigned long kvm\_mmio\_read\_buf(const void \*buf, unsigned int len) return data; } +static bool kvm\_pending\_sync\_exception(struct kvm\_vcpu \*vcpu)+{+ if (!vcpu\_get\_flag(vcpu, PENDING\_EXCEPTION))+ return false;++ if (vcpu\_el1\_is\_32bit(vcpu)) {+ switch (vcpu\_get\_flag(vcpu, EXCEPT\_MASK)) {+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_UND):+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_IABT):+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_DABT):+ return true;+ default:+ return false;+ }+ } else {+ switch (vcpu\_get\_flag(vcpu, EXCEPT\_MASK)) {+ case unpack\_vcpu\_flag(EXCEPT\_AA64\_EL1\_SYNC):+ case unpack\_vcpu\_flag(EXCEPT\_AA64\_EL2\_SYNC):+ return true;+ default:+ return false;+ }+ }+}+ /\*\* \* kvm\_handle\_mmio\_return -- Handle MMIO loads after user space emulation \* or in-kernel IO emulation@@ -84,8 +109,11 @@ int kvm\_handle\_mmio\_return(struct kvm\_vcpu \*vcpu) unsigned int len; int mask; - /\* Detect an already handled MMIO return \*/- if (unlikely(!vcpu->mmio\_needed))+ /\*+ \* Detect if the MMIO return was already handled or if userspace aborted+ \* the MMIO access.+ \*/+ if (unlikely(!vcpu->mmio\_needed || kvm\_pending\_sync\_exception(vcpu))) return 1;  vcpu->mmio\_needed = 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:26:42 +0000



=== Content from git.kernel.org_7ff7d1bc_20250114_202804.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Oliver Upton <oliver.upton@linux.dev> | 2024-10-25 20:31:03 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:44 +0100 |
| commit | [d0571c3add987bcb69c2ffd7a70c998bf8ce60fb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb)) | |
| tree | [74ea279c6ad17e0e905266674f6bc3ac6e846432](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb) | |
| parent | [f3c6fa7ce9786e996d16794127ff7caffe5d31a8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3c6fa7ce9786e996d16794127ff7caffe5d31a8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb&id2=f3c6fa7ce9786e996d16794127ff7caffe5d31a8)) | |
| download | [linux-d0571c3add987bcb69c2ffd7a70c998bf8ce60fb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d0571c3add987bcb69c2ffd7a70c998bf8ce60fb.tar.gz) | |

KVM: arm64: Don't retire aborted MMIO instructioncommit e735a5da64420a86be370b216c269b5dd8e830e2 upstream.
Returning an abort to the guest for an unsupported MMIO access is a
documented feature of the KVM UAPI. Nevertheless, it's clear that this
plumbing has seen limited testing, since userspace can trivially cause a
WARN in the MMIO return:
WARNING: CPU: 0 PID: 30558 at arch/arm64/include/asm/kvm\_emulate.h:536 kvm\_handle\_mmio\_return+0x46c/0x5c4 arch/arm64/include/asm/kvm\_emulate.h:536
Call trace:
kvm\_handle\_mmio\_return+0x46c/0x5c4 arch/arm64/include/asm/kvm\_emulate.h:536
kvm\_arch\_vcpu\_ioctl\_run+0x98/0x15b4 arch/arm64/kvm/arm.c:1133
kvm\_vcpu\_ioctl+0x75c/0xa78 virt/kvm/kvm\_main.c:4487
\_\_do\_sys\_ioctl fs/ioctl.c:51 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:893 [inline]
\_\_arm64\_sys\_ioctl+0x14c/0x1c8 fs/ioctl.c:893
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:35 [inline]
invoke\_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:49
el0\_svc\_common+0x1e0/0x23c arch/arm64/kernel/syscall.c:132
do\_el0\_svc+0x48/0x58 arch/arm64/kernel/syscall.c:151
el0\_svc+0x38/0x68 arch/arm64/kernel/entry-common.c:712
el0t\_64\_sync\_handler+0x90/0xfc arch/arm64/kernel/entry-common.c:730
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:598
The splat is complaining that KVM is advancing PC while an exception is
pending, i.e. that KVM is retiring the MMIO instruction despite a
pending synchronous external abort. Womp womp.
Fix the glaring UAPI bug by skipping over all the MMIO emulation in
case there is a pending synchronous exception. Note that while userspace
is capable of pending an asynchronous exception (SError, IRQ, or FIQ),
it is still safe to retire the MMIO instruction in this case as (1) they
are by definition asynchronous, and (2) KVM relies on hardware support
for pending/delivering these exceptions instead of the software state
machine for advancing PC.
Cc: stable@vger.kernel.org
Fixes: da345174ceca ("KVM: arm/arm64: Allow user injection of external data aborts")
Reported-by: Alexander Potapenko <glider@google.com>
Reviewed-by: Marc Zyngier <maz@kernel.org>
Link: [https://lore.kernel.org/r/20241025203106.3529261-2-oliver.upton@linux.dev](https://lore.kernel.org/r/20241025203106.3529261-2-oliver.upton%40linux.dev)
Signed-off-by: Oliver Upton <oliver.upton@linux.dev>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb)

| -rw-r--r-- | [arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/mmio.c?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 2 deletions

| diff --git a/arch/arm64/kvm/mmio.c b/arch/arm64/kvm/mmio.cindex cd6b7b83e2c370..ab365e839874e5 100644--- a/[arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/mmio.c?id=f3c6fa7ce9786e996d16794127ff7caffe5d31a8)+++ b/[arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/mmio.c?id=d0571c3add987bcb69c2ffd7a70c998bf8ce60fb)@@ -72,6 +72,31 @@ unsigned long kvm\_mmio\_read\_buf(const void \*buf, unsigned int len) return data; } +static bool kvm\_pending\_sync\_exception(struct kvm\_vcpu \*vcpu)+{+ if (!vcpu\_get\_flag(vcpu, PENDING\_EXCEPTION))+ return false;++ if (vcpu\_el1\_is\_32bit(vcpu)) {+ switch (vcpu\_get\_flag(vcpu, EXCEPT\_MASK)) {+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_UND):+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_IABT):+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_DABT):+ return true;+ default:+ return false;+ }+ } else {+ switch (vcpu\_get\_flag(vcpu, EXCEPT\_MASK)) {+ case unpack\_vcpu\_flag(EXCEPT\_AA64\_EL1\_SYNC):+ case unpack\_vcpu\_flag(EXCEPT\_AA64\_EL2\_SYNC):+ return true;+ default:+ return false;+ }+ }+}+ /\*\* \* kvm\_handle\_mmio\_return -- Handle MMIO loads after user space emulation \* or in-kernel IO emulation@@ -84,8 +109,11 @@ int kvm\_handle\_mmio\_return(struct kvm\_vcpu \*vcpu) unsigned int len; int mask; - /\* Detect an already handled MMIO return \*/- if (unlikely(!vcpu->mmio\_needed))+ /\*+ \* Detect if the MMIO return was already handled or if userspace aborted+ \* the MMIO access.+ \*/+ if (unlikely(!vcpu->mmio\_needed || kvm\_pending\_sync\_exception(vcpu))) return 1;  vcpu->mmio\_needed = 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:26:41 +0000



=== Content from git.kernel.org_7a10639d_20250114_202803.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6af853cf5f897d55f42e9166f4db50e84e404fb3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6af853cf5f897d55f42e9166f4db50e84e404fb3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6af853cf5f897d55f42e9166f4db50e84e404fb3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6af853cf5f897d55f42e9166f4db50e84e404fb3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Oliver Upton <oliver.upton@linux.dev> | 2024-10-25 20:31:03 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:24 +0100 |
| commit | [6af853cf5f897d55f42e9166f4db50e84e404fb3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6af853cf5f897d55f42e9166f4db50e84e404fb3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6af853cf5f897d55f42e9166f4db50e84e404fb3)) | |
| tree | [b04b8275f7b2a5e787a66d06607dafc9ad4b2d73](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6af853cf5f897d55f42e9166f4db50e84e404fb3) | |
| parent | [b18c92b051abc790181d2820b9bc7efd17bb44c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b18c92b051abc790181d2820b9bc7efd17bb44c3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6af853cf5f897d55f42e9166f4db50e84e404fb3&id2=b18c92b051abc790181d2820b9bc7efd17bb44c3)) | |
| download | [linux-6af853cf5f897d55f42e9166f4db50e84e404fb3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6af853cf5f897d55f42e9166f4db50e84e404fb3.tar.gz) | |

KVM: arm64: Don't retire aborted MMIO instruction[ Upstream commit e735a5da64420a86be370b216c269b5dd8e830e2 ]
Returning an abort to the guest for an unsupported MMIO access is a
documented feature of the KVM UAPI. Nevertheless, it's clear that this
plumbing has seen limited testing, since userspace can trivially cause a
WARN in the MMIO return:
WARNING: CPU: 0 PID: 30558 at arch/arm64/include/asm/kvm\_emulate.h:536 kvm\_handle\_mmio\_return+0x46c/0x5c4 arch/arm64/include/asm/kvm\_emulate.h:536
Call trace:
kvm\_handle\_mmio\_return+0x46c/0x5c4 arch/arm64/include/asm/kvm\_emulate.h:536
kvm\_arch\_vcpu\_ioctl\_run+0x98/0x15b4 arch/arm64/kvm/arm.c:1133
kvm\_vcpu\_ioctl+0x75c/0xa78 virt/kvm/kvm\_main.c:4487
\_\_do\_sys\_ioctl fs/ioctl.c:51 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:893 [inline]
\_\_arm64\_sys\_ioctl+0x14c/0x1c8 fs/ioctl.c:893
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:35 [inline]
invoke\_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:49
el0\_svc\_common+0x1e0/0x23c arch/arm64/kernel/syscall.c:132
do\_el0\_svc+0x48/0x58 arch/arm64/kernel/syscall.c:151
el0\_svc+0x38/0x68 arch/arm64/kernel/entry-common.c:712
el0t\_64\_sync\_handler+0x90/0xfc arch/arm64/kernel/entry-common.c:730
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:598
The splat is complaining that KVM is advancing PC while an exception is
pending, i.e. that KVM is retiring the MMIO instruction despite a
pending synchronous external abort. Womp womp.
Fix the glaring UAPI bug by skipping over all the MMIO emulation in
case there is a pending synchronous exception. Note that while userspace
is capable of pending an asynchronous exception (SError, IRQ, or FIQ),
it is still safe to retire the MMIO instruction in this case as (1) they
are by definition asynchronous, and (2) KVM relies on hardware support
for pending/delivering these exceptions instead of the software state
machine for advancing PC.
Cc: stable@vger.kernel.org
Fixes: da345174ceca ("KVM: arm/arm64: Allow user injection of external data aborts")
Reported-by: Alexander Potapenko <glider@google.com>
Reviewed-by: Marc Zyngier <maz@kernel.org>
Link: [https://lore.kernel.org/r/20241025203106.3529261-2-oliver.upton@linux.dev](https://lore.kernel.org/r/20241025203106.3529261-2-oliver.upton%40linux.dev)
Signed-off-by: Oliver Upton <oliver.upton@linux.dev>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6af853cf5f897d55f42e9166f4db50e84e404fb3)

| -rw-r--r-- | [arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/mmio.c?id=6af853cf5f897d55f42e9166f4db50e84e404fb3) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 30 insertions, 2 deletions

| diff --git a/arch/arm64/kvm/mmio.c b/arch/arm64/kvm/mmio.cindex 886ef30e121968..2aa503ff742ee5 100644--- a/[arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/mmio.c?id=b18c92b051abc790181d2820b9bc7efd17bb44c3)+++ b/[arch/arm64/kvm/mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/mmio.c?id=6af853cf5f897d55f42e9166f4db50e84e404fb3)@@ -72,6 +72,31 @@ unsigned long kvm\_mmio\_read\_buf(const void \*buf, unsigned int len) return data; } +static bool kvm\_pending\_sync\_exception(struct kvm\_vcpu \*vcpu)+{+ if (!vcpu\_get\_flag(vcpu, PENDING\_EXCEPTION))+ return false;++ if (vcpu\_el1\_is\_32bit(vcpu)) {+ switch (vcpu\_get\_flag(vcpu, EXCEPT\_MASK)) {+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_UND):+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_IABT):+ case unpack\_vcpu\_flag(EXCEPT\_AA32\_DABT):+ return true;+ default:+ return false;+ }+ } else {+ switch (vcpu\_get\_flag(vcpu, EXCEPT\_MASK)) {+ case unpack\_vcpu\_flag(EXCEPT\_AA64\_EL1\_SYNC):+ case unpack\_vcpu\_flag(EXCEPT\_AA64\_EL2\_SYNC):+ return true;+ default:+ return false;+ }+ }+}+ /\*\* \* kvm\_handle\_mmio\_return -- Handle MMIO loads after user space emulation \* or in-kernel IO emulation@@ -84,8 +109,11 @@ int kvm\_handle\_mmio\_return(struct kvm\_vcpu \*vcpu) unsigned int len; int mask; - /\* Detect an already handled MMIO return \*/- if (unlikely(!vcpu->mmio\_needed))+ /\*+ \* Detect if the MMIO return was already handled or if userspace aborted+ \* the MMIO access.+ \*/+ if (unlikely(!vcpu->mmio\_needed || kvm\_pending\_sync\_exception(vcpu))) return 1;  vcpu->mmio\_needed = 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:26:40 +0000


