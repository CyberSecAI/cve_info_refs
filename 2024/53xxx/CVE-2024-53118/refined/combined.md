=== Content from git.kernel.org_3f8e9143_20250114_203557.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michal Luczaj <mhal@rbox.co> | 2024-11-07 21:46:13 +0100 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-11-12 12:16:51 +0100 |
| commit | [fbf7085b3ad1c7cc0677834c90f985f1b4f77a33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33)) | |
| tree | [7bac329ca124d0aa89fc841d662808556d5d8a9e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33) | |
| parent | [d7b0ff5a866724c3ad21f2628c22a63336deec3f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d7b0ff5a866724c3ad21f2628c22a63336deec3f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33&id2=d7b0ff5a866724c3ad21f2628c22a63336deec3f)) | |
| download | [linux-fbf7085b3ad1c7cc0677834c90f985f1b4f77a33.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fbf7085b3ad1c7cc0677834c90f985f1b4f77a33.tar.gz) | |

vsock: Fix sk\_error\_queue memory leakKernel queues MSG\_ZEROCOPY completion notifications on the error queue.
Where they remain, until explicitly recv()ed. To prevent memory leaks,
clean up the queue when the socket is destroyed.
unreferenced object 0xffff8881028beb00 (size 224):
comm "vsock\_test", pid 1218, jiffies 4294694897
hex dump (first 32 bytes):
90 b0 21 17 81 88 ff ff 90 b0 21 17 81 88 ff ff ..!.......!.....
00 00 00 00 00 00 00 00 00 b0 21 17 81 88 ff ff ..........!.....
backtrace (crc 6c7031ca):
[<ffffffff81418ef7>] kmem\_cache\_alloc\_node\_noprof+0x2f7/0x370
[<ffffffff81d35882>] \_\_alloc\_skb+0x132/0x180
[<ffffffff81d2d32b>] sock\_omalloc+0x4b/0x80
[<ffffffff81d3a8ae>] msg\_zerocopy\_realloc+0x9e/0x240
[<ffffffff81fe5cb2>] virtio\_transport\_send\_pkt\_info+0x412/0x4c0
[<ffffffff81fe6183>] virtio\_transport\_stream\_enqueue+0x43/0x50
[<ffffffff81fe0813>] vsock\_connectible\_sendmsg+0x373/0x450
[<ffffffff81d233d5>] \_\_\_\_sys\_sendmsg+0x365/0x3a0
[<ffffffff81d246f4>] \_\_\_sys\_sendmsg+0x84/0xd0
[<ffffffff81d26f47>] \_\_sys\_sendmsg+0x47/0x80
[<ffffffff820d3df3>] do\_syscall\_64+0x93/0x180
[<ffffffff8220012b>] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 581512a6dc93 ("vsock/virtio: MSG\_ZEROCOPY flag support")
Signed-off-by: Michal Luczaj <mhal@rbox.co>
Reviewed-by: Stefano Garzarella <sgarzare@redhat.com>
Acked-by: Arseniy Krasnov <avkrasnov@salutedevices.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33)

| -rw-r--r-- | [net/vmw\_vsock/af\_vsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/vmw_vsock/af_vsock.c?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/vmw\_vsock/af\_vsock.c b/net/vmw\_vsock/af\_vsock.cindex 35681adedd9aae..dfd29160fe11c4 100644--- a/[net/vmw\_vsock/af\_vsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/vmw_vsock/af_vsock.c?id=d7b0ff5a866724c3ad21f2628c22a63336deec3f)+++ b/[net/vmw\_vsock/af\_vsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/vmw_vsock/af_vsock.c?id=fbf7085b3ad1c7cc0677834c90f985f1b4f77a33)@@ -836,6 +836,9 @@ static void vsock\_sk\_destruct(struct sock \*sk) { struct vsock\_sock \*vsk = vsock\_sk(sk); + /\* Flush MSG\_ZEROCOPY leftovers. \*/+ \_\_skb\_queue\_purge(&sk->sk\_error\_queue);+ vsock\_deassign\_transport(vsk);  /\* When clearing these addresses, there's no need to set the family and |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:34:33 +0000



=== Content from git.kernel.org_d767adfd_20250114_203555.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michal Luczaj <mhal@rbox.co> | 2024-11-07 21:46:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:39:48 +0100 |
| commit | [bea4779a45f49275b1e1b1bd9de03cd3727244d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8)) | |
| tree | [7627d50e269f8c097a89dc1ffa0b0a62e0ac7131](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8) | |
| parent | [2415345042245de7601dcc6eafdbe3a3dcc9e379](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2415345042245de7601dcc6eafdbe3a3dcc9e379) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8&id2=2415345042245de7601dcc6eafdbe3a3dcc9e379)) | |
| download | [linux-bea4779a45f49275b1e1b1bd9de03cd3727244d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bea4779a45f49275b1e1b1bd9de03cd3727244d8.tar.gz) | |

vsock: Fix sk\_error\_queue memory leak[ Upstream commit fbf7085b3ad1c7cc0677834c90f985f1b4f77a33 ]
Kernel queues MSG\_ZEROCOPY completion notifications on the error queue.
Where they remain, until explicitly recv()ed. To prevent memory leaks,
clean up the queue when the socket is destroyed.
unreferenced object 0xffff8881028beb00 (size 224):
comm "vsock\_test", pid 1218, jiffies 4294694897
hex dump (first 32 bytes):
90 b0 21 17 81 88 ff ff 90 b0 21 17 81 88 ff ff ..!.......!.....
00 00 00 00 00 00 00 00 00 b0 21 17 81 88 ff ff ..........!.....
backtrace (crc 6c7031ca):
[<ffffffff81418ef7>] kmem\_cache\_alloc\_node\_noprof+0x2f7/0x370
[<ffffffff81d35882>] \_\_alloc\_skb+0x132/0x180
[<ffffffff81d2d32b>] sock\_omalloc+0x4b/0x80
[<ffffffff81d3a8ae>] msg\_zerocopy\_realloc+0x9e/0x240
[<ffffffff81fe5cb2>] virtio\_transport\_send\_pkt\_info+0x412/0x4c0
[<ffffffff81fe6183>] virtio\_transport\_stream\_enqueue+0x43/0x50
[<ffffffff81fe0813>] vsock\_connectible\_sendmsg+0x373/0x450
[<ffffffff81d233d5>] \_\_\_\_sys\_sendmsg+0x365/0x3a0
[<ffffffff81d246f4>] \_\_\_sys\_sendmsg+0x84/0xd0
[<ffffffff81d26f47>] \_\_sys\_sendmsg+0x47/0x80
[<ffffffff820d3df3>] do\_syscall\_64+0x93/0x180
[<ffffffff8220012b>] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 581512a6dc93 ("vsock/virtio: MSG\_ZEROCOPY flag support")
Signed-off-by: Michal Luczaj <mhal@rbox.co>
Reviewed-by: Stefano Garzarella <sgarzare@redhat.com>
Acked-by: Arseniy Krasnov <avkrasnov@salutedevices.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8)

| -rw-r--r-- | [net/vmw\_vsock/af\_vsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/vmw_vsock/af_vsock.c?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/vmw\_vsock/af\_vsock.c b/net/vmw\_vsock/af\_vsock.cindex 0ff9b2dd86bac2..a0202d9b479217 100644--- a/[net/vmw\_vsock/af\_vsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/vmw_vsock/af_vsock.c?id=2415345042245de7601dcc6eafdbe3a3dcc9e379)+++ b/[net/vmw\_vsock/af\_vsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/vmw_vsock/af_vsock.c?id=bea4779a45f49275b1e1b1bd9de03cd3727244d8)@@ -835,6 +835,9 @@ static void vsock\_sk\_destruct(struct sock \*sk) { struct vsock\_sock \*vsk = vsock\_sk(sk); + /\* Flush MSG\_ZEROCOPY leftovers. \*/+ \_\_skb\_queue\_purge(&sk->sk\_error\_queue);+ vsock\_deassign\_transport(vsk);  /\* When clearing these addresses, there's no need to set the family and |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:34:32 +0000


