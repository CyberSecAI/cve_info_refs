=== Content from git.kernel.org_ce262d7d_20250114_223106.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-29 12:17:36 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:41 +0100 |
| commit | [83f8713a0ef1d55d6a287bcfadcaab8245ac5098](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098)) | |
| tree | [988ad6d3fa96b8c540c07c0243037e629c939303](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098) | |
| parent | [678098cef6459206ac0375bc5fed089db0bdbe43](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=678098cef6459206ac0375bc5fed089db0bdbe43) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098&id2=678098cef6459206ac0375bc5fed089db0bdbe43)) | |
| download | [linux-83f8713a0ef1d55d6a287bcfadcaab8245ac5098.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-83f8713a0ef1d55d6a287bcfadcaab8245ac5098.tar.gz) | |

ocfs2: fix uninitialized value in ocfs2\_file\_read\_iter()[ Upstream commit adc77b19f62d7e80f98400b2fca9d700d2afdd6f ]
Syzbot has reported the following KMSAN splat:
BUG: KMSAN: uninit-value in ocfs2\_file\_read\_iter+0x9a4/0xf80
ocfs2\_file\_read\_iter+0x9a4/0xf80
\_\_io\_read+0x8d4/0x20f0
io\_read+0x3e/0xf0
io\_issue\_sqe+0x42b/0x22c0
io\_wq\_submit\_work+0xaf9/0xdc0
io\_worker\_handle\_work+0xd13/0x2110
io\_wq\_worker+0x447/0x1410
ret\_from\_fork+0x6f/0x90
ret\_from\_fork\_asm+0x1a/0x30
Uninit was created at:
\_\_alloc\_pages\_noprof+0x9a7/0xe00
alloc\_pages\_mpol\_noprof+0x299/0x990
alloc\_pages\_noprof+0x1bf/0x1e0
allocate\_slab+0x33a/0x1250
\_\_\_slab\_alloc+0x12ef/0x35e0
kmem\_cache\_alloc\_bulk\_noprof+0x486/0x1330
\_\_io\_alloc\_req\_refill+0x84/0x560
io\_submit\_sqes+0x172f/0x2f30
\_\_se\_sys\_io\_uring\_enter+0x406/0x41c0
\_\_x64\_sys\_io\_uring\_enter+0x11f/0x1a0
x64\_sys\_call+0x2b54/0x3ba0
do\_syscall\_64+0xcd/0x1e0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Since an instance of 'struct kiocb' may be passed from the block layer
with 'private' field uninitialized, introduce 'ocfs2\_iocb\_init\_rw\_locked()'
and use it from where 'ocfs2\_dio\_end\_io()' might take care, i.e. in
'ocfs2\_file\_read\_iter()' and 'ocfs2\_file\_write\_iter()'.
Link: [https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov@yandex.ru](https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov%40yandex.ru)
Fixes: 7cdfc3a1c397 ("ocfs2: Remember rw lock level during direct io")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Reported-by: syzbot+a73e253cca4f0230a5a5@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=a73e253cca4f0230a5a5
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Joseph Qi <jiangqi903@gmail.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098)

| -rw-r--r-- | [fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.h?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/file.c?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.h b/fs/ocfs2/aops.hindex 3a520117fa59f0..a9ce7947228c8d 100644--- a/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=678098cef6459206ac0375bc5fed089db0bdbe43)+++ b/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098)@@ -70,6 +70,8 @@ enum ocfs2\_iocb\_lock\_bits { OCFS2\_IOCB\_NUM\_LOCKS }; +#define ocfs2\_iocb\_init\_rw\_locked(iocb) \+ (iocb->private = NULL) #define ocfs2\_iocb\_clear\_rw\_locked(iocb) \ clear\_bit(OCFS2\_IOCB\_RW\_LOCK, (unsigned long \*)&iocb->private) #define ocfs2\_iocb\_rw\_locked\_level(iocb) \diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.cindex e96b947c3f5dd5..e29e267472bf8b 100644--- a/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=678098cef6459206ac0375bc5fed089db0bdbe43)+++ b/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=83f8713a0ef1d55d6a287bcfadcaab8245ac5098)@@ -2398,6 +2398,8 @@ static ssize\_t ocfs2\_file\_write\_iter(struct kiocb \*iocb, } else inode\_lock(inode); + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* Concurrent O\_DIRECT writes are allowed with \* mount\_option "coherency=buffered".@@ -2544,6 +2546,8 @@ static ssize\_t ocfs2\_file\_read\_iter(struct kiocb \*iocb, if (!direct\_io && nowait) return -EOPNOTSUPP; + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* buffered reads protect themselves in ->read\_folio(). O\_DIRECT reads \* need locks to protect pending reads from racing with truncate. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:29:43 +0000



=== Content from git.kernel.org_86227abc_20250114_223104.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=366c933c2ab34dd6551acc03b4872726b7605143)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=366c933c2ab34dd6551acc03b4872726b7605143)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=366c933c2ab34dd6551acc03b4872726b7605143)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=366c933c2ab34dd6551acc03b4872726b7605143)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-29 12:17:36 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:41 +0100 |
| commit | [366c933c2ab34dd6551acc03b4872726b7605143](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=366c933c2ab34dd6551acc03b4872726b7605143) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=366c933c2ab34dd6551acc03b4872726b7605143)) | |
| tree | [38c90ea8eeb0f786a82500bd4862872b639dcebe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=366c933c2ab34dd6551acc03b4872726b7605143) | |
| parent | [a8cc8a82297c0005f8850162385232c99d36046a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8cc8a82297c0005f8850162385232c99d36046a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=366c933c2ab34dd6551acc03b4872726b7605143&id2=a8cc8a82297c0005f8850162385232c99d36046a)) | |
| download | [linux-366c933c2ab34dd6551acc03b4872726b7605143.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-366c933c2ab34dd6551acc03b4872726b7605143.tar.gz) | |

ocfs2: fix uninitialized value in ocfs2\_file\_read\_iter()[ Upstream commit adc77b19f62d7e80f98400b2fca9d700d2afdd6f ]
Syzbot has reported the following KMSAN splat:
BUG: KMSAN: uninit-value in ocfs2\_file\_read\_iter+0x9a4/0xf80
ocfs2\_file\_read\_iter+0x9a4/0xf80
\_\_io\_read+0x8d4/0x20f0
io\_read+0x3e/0xf0
io\_issue\_sqe+0x42b/0x22c0
io\_wq\_submit\_work+0xaf9/0xdc0
io\_worker\_handle\_work+0xd13/0x2110
io\_wq\_worker+0x447/0x1410
ret\_from\_fork+0x6f/0x90
ret\_from\_fork\_asm+0x1a/0x30
Uninit was created at:
\_\_alloc\_pages\_noprof+0x9a7/0xe00
alloc\_pages\_mpol\_noprof+0x299/0x990
alloc\_pages\_noprof+0x1bf/0x1e0
allocate\_slab+0x33a/0x1250
\_\_\_slab\_alloc+0x12ef/0x35e0
kmem\_cache\_alloc\_bulk\_noprof+0x486/0x1330
\_\_io\_alloc\_req\_refill+0x84/0x560
io\_submit\_sqes+0x172f/0x2f30
\_\_se\_sys\_io\_uring\_enter+0x406/0x41c0
\_\_x64\_sys\_io\_uring\_enter+0x11f/0x1a0
x64\_sys\_call+0x2b54/0x3ba0
do\_syscall\_64+0xcd/0x1e0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Since an instance of 'struct kiocb' may be passed from the block layer
with 'private' field uninitialized, introduce 'ocfs2\_iocb\_init\_rw\_locked()'
and use it from where 'ocfs2\_dio\_end\_io()' might take care, i.e. in
'ocfs2\_file\_read\_iter()' and 'ocfs2\_file\_write\_iter()'.
Link: [https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov@yandex.ru](https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov%40yandex.ru)
Fixes: 7cdfc3a1c397 ("ocfs2: Remember rw lock level during direct io")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Reported-by: syzbot+a73e253cca4f0230a5a5@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=a73e253cca4f0230a5a5
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Joseph Qi <jiangqi903@gmail.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=366c933c2ab34dd6551acc03b4872726b7605143)

| -rw-r--r-- | [fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.h?id=366c933c2ab34dd6551acc03b4872726b7605143) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/file.c?id=366c933c2ab34dd6551acc03b4872726b7605143) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.h b/fs/ocfs2/aops.hindex 3a520117fa59f0..a9ce7947228c8d 100644--- a/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=a8cc8a82297c0005f8850162385232c99d36046a)+++ b/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=366c933c2ab34dd6551acc03b4872726b7605143)@@ -70,6 +70,8 @@ enum ocfs2\_iocb\_lock\_bits { OCFS2\_IOCB\_NUM\_LOCKS }; +#define ocfs2\_iocb\_init\_rw\_locked(iocb) \+ (iocb->private = NULL) #define ocfs2\_iocb\_clear\_rw\_locked(iocb) \ clear\_bit(OCFS2\_IOCB\_RW\_LOCK, (unsigned long \*)&iocb->private) #define ocfs2\_iocb\_rw\_locked\_level(iocb) \diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.cindex c6d0d17a759c1e..f772313ccb0625 100644--- a/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=a8cc8a82297c0005f8850162385232c99d36046a)+++ b/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=366c933c2ab34dd6551acc03b4872726b7605143)@@ -2397,6 +2397,8 @@ static ssize\_t ocfs2\_file\_write\_iter(struct kiocb \*iocb, } else inode\_lock(inode); + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* Concurrent O\_DIRECT writes are allowed with \* mount\_option "coherency=buffered".@@ -2543,6 +2545,8 @@ static ssize\_t ocfs2\_file\_read\_iter(struct kiocb \*iocb, if (!direct\_io && nowait) return -EOPNOTSUPP; + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* buffered reads protect themselves in ->read\_folio(). O\_DIRECT reads \* need locks to protect pending reads from racing with truncate. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:29:41 +0000



=== Content from git.kernel.org_85e97129_20250114_223105.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-29 12:17:36 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:34 +0100 |
| commit | [6c8f8d1e595dabd5389817f6d798cc8bd95c40ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab)) | |
| tree | [f5e113784474de350237c2b91027813ac80cf928](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab) | |
| parent | [4e48e5b26b3edc0e1dd329201ffc924a7a1f9337](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e48e5b26b3edc0e1dd329201ffc924a7a1f9337) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab&id2=4e48e5b26b3edc0e1dd329201ffc924a7a1f9337)) | |
| download | [linux-6c8f8d1e595dabd5389817f6d798cc8bd95c40ab.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6c8f8d1e595dabd5389817f6d798cc8bd95c40ab.tar.gz) | |

ocfs2: fix uninitialized value in ocfs2\_file\_read\_iter()[ Upstream commit adc77b19f62d7e80f98400b2fca9d700d2afdd6f ]
Syzbot has reported the following KMSAN splat:
BUG: KMSAN: uninit-value in ocfs2\_file\_read\_iter+0x9a4/0xf80
ocfs2\_file\_read\_iter+0x9a4/0xf80
\_\_io\_read+0x8d4/0x20f0
io\_read+0x3e/0xf0
io\_issue\_sqe+0x42b/0x22c0
io\_wq\_submit\_work+0xaf9/0xdc0
io\_worker\_handle\_work+0xd13/0x2110
io\_wq\_worker+0x447/0x1410
ret\_from\_fork+0x6f/0x90
ret\_from\_fork\_asm+0x1a/0x30
Uninit was created at:
\_\_alloc\_pages\_noprof+0x9a7/0xe00
alloc\_pages\_mpol\_noprof+0x299/0x990
alloc\_pages\_noprof+0x1bf/0x1e0
allocate\_slab+0x33a/0x1250
\_\_\_slab\_alloc+0x12ef/0x35e0
kmem\_cache\_alloc\_bulk\_noprof+0x486/0x1330
\_\_io\_alloc\_req\_refill+0x84/0x560
io\_submit\_sqes+0x172f/0x2f30
\_\_se\_sys\_io\_uring\_enter+0x406/0x41c0
\_\_x64\_sys\_io\_uring\_enter+0x11f/0x1a0
x64\_sys\_call+0x2b54/0x3ba0
do\_syscall\_64+0xcd/0x1e0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Since an instance of 'struct kiocb' may be passed from the block layer
with 'private' field uninitialized, introduce 'ocfs2\_iocb\_init\_rw\_locked()'
and use it from where 'ocfs2\_dio\_end\_io()' might take care, i.e. in
'ocfs2\_file\_read\_iter()' and 'ocfs2\_file\_write\_iter()'.
Link: [https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov@yandex.ru](https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov%40yandex.ru)
Fixes: 7cdfc3a1c397 ("ocfs2: Remember rw lock level during direct io")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Reported-by: syzbot+a73e253cca4f0230a5a5@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=a73e253cca4f0230a5a5
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Joseph Qi <jiangqi903@gmail.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab)

| -rw-r--r-- | [fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.h?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/file.c?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.h b/fs/ocfs2/aops.hindex 3494a62ed749cb..c1c21890299034 100644--- a/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=4e48e5b26b3edc0e1dd329201ffc924a7a1f9337)+++ b/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab)@@ -86,6 +86,8 @@ enum ocfs2\_iocb\_lock\_bits { OCFS2\_IOCB\_NUM\_LOCKS }; +#define ocfs2\_iocb\_init\_rw\_locked(iocb) \+ (iocb->private = NULL) #define ocfs2\_iocb\_clear\_rw\_locked(iocb) \ clear\_bit(OCFS2\_IOCB\_RW\_LOCK, (unsigned long \*)&iocb->private) #define ocfs2\_iocb\_rw\_locked\_level(iocb) \diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.cindex 9062002fd56c60..08cd712b433c84 100644--- a/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=4e48e5b26b3edc0e1dd329201ffc924a7a1f9337)+++ b/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=6c8f8d1e595dabd5389817f6d798cc8bd95c40ab)@@ -2412,6 +2412,8 @@ static ssize\_t ocfs2\_file\_write\_iter(struct kiocb \*iocb, } else inode\_lock(inode); + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* Concurrent O\_DIRECT writes are allowed with \* mount\_option "coherency=buffered".@@ -2558,6 +2560,8 @@ static ssize\_t ocfs2\_file\_read\_iter(struct kiocb \*iocb, if (!direct\_io && nowait) return -EOPNOTSUPP; + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* buffered reads protect themselves in ->readpage(). O\_DIRECT reads \* need locks to protect pending reads from racing with truncate. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:29:42 +0000



=== Content from git.kernel.org_cf24c432_20250114_223110.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-29 12:17:36 +0300 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-11-11 17:17:04 -0800 |
| commit | [adc77b19f62d7e80f98400b2fca9d700d2afdd6f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f)) | |
| tree | [987baf1291bef8d9deefe24a7f6f52fa4820b0a4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f) | |
| parent | [62bf7065cc6056a51a240c810b95d887e5bb7c8c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62bf7065cc6056a51a240c810b95d887e5bb7c8c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f&id2=62bf7065cc6056a51a240c810b95d887e5bb7c8c)) | |
| download | [linux-adc77b19f62d7e80f98400b2fca9d700d2afdd6f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-adc77b19f62d7e80f98400b2fca9d700d2afdd6f.tar.gz) | |

ocfs2: fix uninitialized value in ocfs2\_file\_read\_iter()Syzbot has reported the following KMSAN splat:
BUG: KMSAN: uninit-value in ocfs2\_file\_read\_iter+0x9a4/0xf80
ocfs2\_file\_read\_iter+0x9a4/0xf80
\_\_io\_read+0x8d4/0x20f0
io\_read+0x3e/0xf0
io\_issue\_sqe+0x42b/0x22c0
io\_wq\_submit\_work+0xaf9/0xdc0
io\_worker\_handle\_work+0xd13/0x2110
io\_wq\_worker+0x447/0x1410
ret\_from\_fork+0x6f/0x90
ret\_from\_fork\_asm+0x1a/0x30
Uninit was created at:
\_\_alloc\_pages\_noprof+0x9a7/0xe00
alloc\_pages\_mpol\_noprof+0x299/0x990
alloc\_pages\_noprof+0x1bf/0x1e0
allocate\_slab+0x33a/0x1250
\_\_\_slab\_alloc+0x12ef/0x35e0
kmem\_cache\_alloc\_bulk\_noprof+0x486/0x1330
\_\_io\_alloc\_req\_refill+0x84/0x560
io\_submit\_sqes+0x172f/0x2f30
\_\_se\_sys\_io\_uring\_enter+0x406/0x41c0
\_\_x64\_sys\_io\_uring\_enter+0x11f/0x1a0
x64\_sys\_call+0x2b54/0x3ba0
do\_syscall\_64+0xcd/0x1e0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Since an instance of 'struct kiocb' may be passed from the block layer
with 'private' field uninitialized, introduce 'ocfs2\_iocb\_init\_rw\_locked()'
and use it from where 'ocfs2\_dio\_end\_io()' might take care, i.e. in
'ocfs2\_file\_read\_iter()' and 'ocfs2\_file\_write\_iter()'.
Link: [https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov@yandex.ru](https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov%40yandex.ru)
Fixes: 7cdfc3a1c397 ("ocfs2: Remember rw lock level during direct io")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Reported-by: syzbot+a73e253cca4f0230a5a5@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=a73e253cca4f0230a5a5
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Joseph Qi <jiangqi903@gmail.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f)

| -rw-r--r-- | [fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.h?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/file.c?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.h b/fs/ocfs2/aops.hindex 45db1781ea735a..1d1b4b7edba02e 100644--- a/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=62bf7065cc6056a51a240c810b95d887e5bb7c8c)+++ b/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f)@@ -70,6 +70,8 @@ enum ocfs2\_iocb\_lock\_bits { OCFS2\_IOCB\_NUM\_LOCKS }; +#define ocfs2\_iocb\_init\_rw\_locked(iocb) \+ (iocb->private = NULL) #define ocfs2\_iocb\_clear\_rw\_locked(iocb) \ clear\_bit(OCFS2\_IOCB\_RW\_LOCK, (unsigned long \*)&iocb->private) #define ocfs2\_iocb\_rw\_locked\_level(iocb) \diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.cindex 06af21982c16ab..cb09330a086119 100644--- a/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=62bf7065cc6056a51a240c810b95d887e5bb7c8c)+++ b/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=adc77b19f62d7e80f98400b2fca9d700d2afdd6f)@@ -2398,6 +2398,8 @@ static ssize\_t ocfs2\_file\_write\_iter(struct kiocb \*iocb, } else inode\_lock(inode); + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* Concurrent O\_DIRECT writes are allowed with \* mount\_option "coherency=buffered".@@ -2544,6 +2546,8 @@ static ssize\_t ocfs2\_file\_read\_iter(struct kiocb \*iocb, if (!direct\_io && nowait) return -EOPNOTSUPP; + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* buffered reads protect themselves in ->read\_folio(). O\_DIRECT reads \* need locks to protect pending reads from racing with truncate. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:29:47 +0000



=== Content from git.kernel.org_e622f7c7_20250114_223109.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-29 12:17:36 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:20 +0100 |
| commit | [8e0de82ed18ba0e71f817adbd81317fd1032ca5a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a)) | |
| tree | [679f8728e63a0544a3dd770069dc1bbf660fa30f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a) | |
| parent | [ae5427f88f1978662150c7bae7356c46a34d834e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae5427f88f1978662150c7bae7356c46a34d834e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a&id2=ae5427f88f1978662150c7bae7356c46a34d834e)) | |
| download | [linux-8e0de82ed18ba0e71f817adbd81317fd1032ca5a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e0de82ed18ba0e71f817adbd81317fd1032ca5a.tar.gz) | |

ocfs2: fix uninitialized value in ocfs2\_file\_read\_iter()[ Upstream commit adc77b19f62d7e80f98400b2fca9d700d2afdd6f ]
Syzbot has reported the following KMSAN splat:
BUG: KMSAN: uninit-value in ocfs2\_file\_read\_iter+0x9a4/0xf80
ocfs2\_file\_read\_iter+0x9a4/0xf80
\_\_io\_read+0x8d4/0x20f0
io\_read+0x3e/0xf0
io\_issue\_sqe+0x42b/0x22c0
io\_wq\_submit\_work+0xaf9/0xdc0
io\_worker\_handle\_work+0xd13/0x2110
io\_wq\_worker+0x447/0x1410
ret\_from\_fork+0x6f/0x90
ret\_from\_fork\_asm+0x1a/0x30
Uninit was created at:
\_\_alloc\_pages\_noprof+0x9a7/0xe00
alloc\_pages\_mpol\_noprof+0x299/0x990
alloc\_pages\_noprof+0x1bf/0x1e0
allocate\_slab+0x33a/0x1250
\_\_\_slab\_alloc+0x12ef/0x35e0
kmem\_cache\_alloc\_bulk\_noprof+0x486/0x1330
\_\_io\_alloc\_req\_refill+0x84/0x560
io\_submit\_sqes+0x172f/0x2f30
\_\_se\_sys\_io\_uring\_enter+0x406/0x41c0
\_\_x64\_sys\_io\_uring\_enter+0x11f/0x1a0
x64\_sys\_call+0x2b54/0x3ba0
do\_syscall\_64+0xcd/0x1e0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Since an instance of 'struct kiocb' may be passed from the block layer
with 'private' field uninitialized, introduce 'ocfs2\_iocb\_init\_rw\_locked()'
and use it from where 'ocfs2\_dio\_end\_io()' might take care, i.e. in
'ocfs2\_file\_read\_iter()' and 'ocfs2\_file\_write\_iter()'.
Link: [https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov@yandex.ru](https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov%40yandex.ru)
Fixes: 7cdfc3a1c397 ("ocfs2: Remember rw lock level during direct io")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Reported-by: syzbot+a73e253cca4f0230a5a5@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=a73e253cca4f0230a5a5
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Joseph Qi <jiangqi903@gmail.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a)

| -rw-r--r-- | [fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.h?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/file.c?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.h b/fs/ocfs2/aops.hindex 3a520117fa59f0..a9ce7947228c8d 100644--- a/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=ae5427f88f1978662150c7bae7356c46a34d834e)+++ b/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a)@@ -70,6 +70,8 @@ enum ocfs2\_iocb\_lock\_bits { OCFS2\_IOCB\_NUM\_LOCKS }; +#define ocfs2\_iocb\_init\_rw\_locked(iocb) \+ (iocb->private = NULL) #define ocfs2\_iocb\_clear\_rw\_locked(iocb) \ clear\_bit(OCFS2\_IOCB\_RW\_LOCK, (unsigned long \*)&iocb->private) #define ocfs2\_iocb\_rw\_locked\_level(iocb) \diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.cindex e4acb795d11901..0585f281ff62f0 100644--- a/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=ae5427f88f1978662150c7bae7356c46a34d834e)+++ b/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=8e0de82ed18ba0e71f817adbd81317fd1032ca5a)@@ -2397,6 +2397,8 @@ static ssize\_t ocfs2\_file\_write\_iter(struct kiocb \*iocb, } else inode\_lock(inode); + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* Concurrent O\_DIRECT writes are allowed with \* mount\_option "coherency=buffered".@@ -2543,6 +2545,8 @@ static ssize\_t ocfs2\_file\_read\_iter(struct kiocb \*iocb, if (!direct\_io && nowait) return -EOPNOTSUPP; + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* buffered reads protect themselves in ->read\_folio(). O\_DIRECT reads \* need locks to protect pending reads from racing with truncate. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:29:46 +0000



=== Content from git.kernel.org_1c58bc0c_20250114_223112.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dc78efe556fed162d48736ef24066f42e463e27c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc78efe556fed162d48736ef24066f42e463e27c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc78efe556fed162d48736ef24066f42e463e27c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc78efe556fed162d48736ef24066f42e463e27c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-29 12:17:36 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:13 +0100 |
| commit | [dc78efe556fed162d48736ef24066f42e463e27c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc78efe556fed162d48736ef24066f42e463e27c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dc78efe556fed162d48736ef24066f42e463e27c)) | |
| tree | [bd2476a216fa841142fba07e5acbddc3263f1158](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc78efe556fed162d48736ef24066f42e463e27c) | |
| parent | [673f503cfe82ba94c9dd749944e9ab511d711ded](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=673f503cfe82ba94c9dd749944e9ab511d711ded) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc78efe556fed162d48736ef24066f42e463e27c&id2=673f503cfe82ba94c9dd749944e9ab511d711ded)) | |
| download | [linux-dc78efe556fed162d48736ef24066f42e463e27c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dc78efe556fed162d48736ef24066f42e463e27c.tar.gz) | |

ocfs2: fix uninitialized value in ocfs2\_file\_read\_iter()[ Upstream commit adc77b19f62d7e80f98400b2fca9d700d2afdd6f ]
Syzbot has reported the following KMSAN splat:
BUG: KMSAN: uninit-value in ocfs2\_file\_read\_iter+0x9a4/0xf80
ocfs2\_file\_read\_iter+0x9a4/0xf80
\_\_io\_read+0x8d4/0x20f0
io\_read+0x3e/0xf0
io\_issue\_sqe+0x42b/0x22c0
io\_wq\_submit\_work+0xaf9/0xdc0
io\_worker\_handle\_work+0xd13/0x2110
io\_wq\_worker+0x447/0x1410
ret\_from\_fork+0x6f/0x90
ret\_from\_fork\_asm+0x1a/0x30
Uninit was created at:
\_\_alloc\_pages\_noprof+0x9a7/0xe00
alloc\_pages\_mpol\_noprof+0x299/0x990
alloc\_pages\_noprof+0x1bf/0x1e0
allocate\_slab+0x33a/0x1250
\_\_\_slab\_alloc+0x12ef/0x35e0
kmem\_cache\_alloc\_bulk\_noprof+0x486/0x1330
\_\_io\_alloc\_req\_refill+0x84/0x560
io\_submit\_sqes+0x172f/0x2f30
\_\_se\_sys\_io\_uring\_enter+0x406/0x41c0
\_\_x64\_sys\_io\_uring\_enter+0x11f/0x1a0
x64\_sys\_call+0x2b54/0x3ba0
do\_syscall\_64+0xcd/0x1e0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Since an instance of 'struct kiocb' may be passed from the block layer
with 'private' field uninitialized, introduce 'ocfs2\_iocb\_init\_rw\_locked()'
and use it from where 'ocfs2\_dio\_end\_io()' might take care, i.e. in
'ocfs2\_file\_read\_iter()' and 'ocfs2\_file\_write\_iter()'.
Link: [https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov@yandex.ru](https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov%40yandex.ru)
Fixes: 7cdfc3a1c397 ("ocfs2: Remember rw lock level during direct io")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Reported-by: syzbot+a73e253cca4f0230a5a5@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=a73e253cca4f0230a5a5
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Joseph Qi <jiangqi903@gmail.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc78efe556fed162d48736ef24066f42e463e27c)

| -rw-r--r-- | [fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.h?id=dc78efe556fed162d48736ef24066f42e463e27c) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/file.c?id=dc78efe556fed162d48736ef24066f42e463e27c) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.h b/fs/ocfs2/aops.hindex 45db1781ea735a..1d1b4b7edba02e 100644--- a/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=673f503cfe82ba94c9dd749944e9ab511d711ded)+++ b/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=dc78efe556fed162d48736ef24066f42e463e27c)@@ -70,6 +70,8 @@ enum ocfs2\_iocb\_lock\_bits { OCFS2\_IOCB\_NUM\_LOCKS }; +#define ocfs2\_iocb\_init\_rw\_locked(iocb) \+ (iocb->private = NULL) #define ocfs2\_iocb\_clear\_rw\_locked(iocb) \ clear\_bit(OCFS2\_IOCB\_RW\_LOCK, (unsigned long \*)&iocb->private) #define ocfs2\_iocb\_rw\_locked\_level(iocb) \diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.cindex 06af21982c16ab..cb09330a086119 100644--- a/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=673f503cfe82ba94c9dd749944e9ab511d711ded)+++ b/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=dc78efe556fed162d48736ef24066f42e463e27c)@@ -2398,6 +2398,8 @@ static ssize\_t ocfs2\_file\_write\_iter(struct kiocb \*iocb, } else inode\_lock(inode); + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* Concurrent O\_DIRECT writes are allowed with \* mount\_option "coherency=buffered".@@ -2544,6 +2546,8 @@ static ssize\_t ocfs2\_file\_read\_iter(struct kiocb \*iocb, if (!direct\_io && nowait) return -EOPNOTSUPP; + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* buffered reads protect themselves in ->read\_folio(). O\_DIRECT reads \* need locks to protect pending reads from racing with truncate. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:29:49 +0000



=== Content from git.kernel.org_0748ebbb_20250114_223114.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f4078ef38d3163e6be47403a619558b19c4bfccd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4078ef38d3163e6be47403a619558b19c4bfccd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4078ef38d3163e6be47403a619558b19c4bfccd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4078ef38d3163e6be47403a619558b19c4bfccd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-29 12:17:36 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:30 +0100 |
| commit | [f4078ef38d3163e6be47403a619558b19c4bfccd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4078ef38d3163e6be47403a619558b19c4bfccd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f4078ef38d3163e6be47403a619558b19c4bfccd)) | |
| tree | [6e5543a7c9cd04f7e7ead1135a5a72dff1593b0a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4078ef38d3163e6be47403a619558b19c4bfccd) | |
| parent | [eaf92fad1f21be63427920c12f22227e5f757424](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eaf92fad1f21be63427920c12f22227e5f757424) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4078ef38d3163e6be47403a619558b19c4bfccd&id2=eaf92fad1f21be63427920c12f22227e5f757424)) | |
| download | [linux-f4078ef38d3163e6be47403a619558b19c4bfccd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f4078ef38d3163e6be47403a619558b19c4bfccd.tar.gz) | |

ocfs2: fix uninitialized value in ocfs2\_file\_read\_iter()[ Upstream commit adc77b19f62d7e80f98400b2fca9d700d2afdd6f ]
Syzbot has reported the following KMSAN splat:
BUG: KMSAN: uninit-value in ocfs2\_file\_read\_iter+0x9a4/0xf80
ocfs2\_file\_read\_iter+0x9a4/0xf80
\_\_io\_read+0x8d4/0x20f0
io\_read+0x3e/0xf0
io\_issue\_sqe+0x42b/0x22c0
io\_wq\_submit\_work+0xaf9/0xdc0
io\_worker\_handle\_work+0xd13/0x2110
io\_wq\_worker+0x447/0x1410
ret\_from\_fork+0x6f/0x90
ret\_from\_fork\_asm+0x1a/0x30
Uninit was created at:
\_\_alloc\_pages\_noprof+0x9a7/0xe00
alloc\_pages\_mpol\_noprof+0x299/0x990
alloc\_pages\_noprof+0x1bf/0x1e0
allocate\_slab+0x33a/0x1250
\_\_\_slab\_alloc+0x12ef/0x35e0
kmem\_cache\_alloc\_bulk\_noprof+0x486/0x1330
\_\_io\_alloc\_req\_refill+0x84/0x560
io\_submit\_sqes+0x172f/0x2f30
\_\_se\_sys\_io\_uring\_enter+0x406/0x41c0
\_\_x64\_sys\_io\_uring\_enter+0x11f/0x1a0
x64\_sys\_call+0x2b54/0x3ba0
do\_syscall\_64+0xcd/0x1e0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Since an instance of 'struct kiocb' may be passed from the block layer
with 'private' field uninitialized, introduce 'ocfs2\_iocb\_init\_rw\_locked()'
and use it from where 'ocfs2\_dio\_end\_io()' might take care, i.e. in
'ocfs2\_file\_read\_iter()' and 'ocfs2\_file\_write\_iter()'.
Link: [https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov@yandex.ru](https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov%40yandex.ru)
Fixes: 7cdfc3a1c397 ("ocfs2: Remember rw lock level during direct io")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Reported-by: syzbot+a73e253cca4f0230a5a5@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=a73e253cca4f0230a5a5
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Joseph Qi <jiangqi903@gmail.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4078ef38d3163e6be47403a619558b19c4bfccd)

| -rw-r--r-- | [fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.h?id=f4078ef38d3163e6be47403a619558b19c4bfccd) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/file.c?id=f4078ef38d3163e6be47403a619558b19c4bfccd) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.h b/fs/ocfs2/aops.hindex 70ed4382750d51..5b129ae9c3d22f 100644--- a/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=eaf92fad1f21be63427920c12f22227e5f757424)+++ b/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=f4078ef38d3163e6be47403a619558b19c4bfccd)@@ -72,6 +72,8 @@ enum ocfs2\_iocb\_lock\_bits { OCFS2\_IOCB\_NUM\_LOCKS }; +#define ocfs2\_iocb\_init\_rw\_locked(iocb) \+ (iocb->private = NULL) #define ocfs2\_iocb\_clear\_rw\_locked(iocb) \ clear\_bit(OCFS2\_IOCB\_RW\_LOCK, (unsigned long \*)&iocb->private) #define ocfs2\_iocb\_rw\_locked\_level(iocb) \diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.cindex 3bbeea2e60f708..54b843f5b73f5f 100644--- a/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=eaf92fad1f21be63427920c12f22227e5f757424)+++ b/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=f4078ef38d3163e6be47403a619558b19c4bfccd)@@ -2401,6 +2401,8 @@ static ssize\_t ocfs2\_file\_write\_iter(struct kiocb \*iocb, } else inode\_lock(inode); + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* Concurrent O\_DIRECT writes are allowed with \* mount\_option "coherency=buffered".@@ -2547,6 +2549,8 @@ static ssize\_t ocfs2\_file\_read\_iter(struct kiocb \*iocb, if (!direct\_io && nowait) return -EOPNOTSUPP; + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* buffered reads protect themselves in ->readpage(). O\_DIRECT reads \* need locks to protect pending reads from racing with truncate. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:29:51 +0000



=== Content from git.kernel.org_a8e27aa9_20250114_223108.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8c966150d5abff58c3c2bdb9a6e63fd773782905)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c966150d5abff58c3c2bdb9a6e63fd773782905)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c966150d5abff58c3c2bdb9a6e63fd773782905)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c966150d5abff58c3c2bdb9a6e63fd773782905)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-29 12:17:36 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:03 +0100 |
| commit | [8c966150d5abff58c3c2bdb9a6e63fd773782905](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c966150d5abff58c3c2bdb9a6e63fd773782905) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8c966150d5abff58c3c2bdb9a6e63fd773782905)) | |
| tree | [9223215b7839e99f745b6ee177d7766a4b6f71cb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c966150d5abff58c3c2bdb9a6e63fd773782905) | |
| parent | [35f5b68f63aac61d30ce0b0c6beb09b8845a3e65](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c966150d5abff58c3c2bdb9a6e63fd773782905&id2=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65)) | |
| download | [linux-8c966150d5abff58c3c2bdb9a6e63fd773782905.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8c966150d5abff58c3c2bdb9a6e63fd773782905.tar.gz) | |

ocfs2: fix uninitialized value in ocfs2\_file\_read\_iter()[ Upstream commit adc77b19f62d7e80f98400b2fca9d700d2afdd6f ]
Syzbot has reported the following KMSAN splat:
BUG: KMSAN: uninit-value in ocfs2\_file\_read\_iter+0x9a4/0xf80
ocfs2\_file\_read\_iter+0x9a4/0xf80
\_\_io\_read+0x8d4/0x20f0
io\_read+0x3e/0xf0
io\_issue\_sqe+0x42b/0x22c0
io\_wq\_submit\_work+0xaf9/0xdc0
io\_worker\_handle\_work+0xd13/0x2110
io\_wq\_worker+0x447/0x1410
ret\_from\_fork+0x6f/0x90
ret\_from\_fork\_asm+0x1a/0x30
Uninit was created at:
\_\_alloc\_pages\_noprof+0x9a7/0xe00
alloc\_pages\_mpol\_noprof+0x299/0x990
alloc\_pages\_noprof+0x1bf/0x1e0
allocate\_slab+0x33a/0x1250
\_\_\_slab\_alloc+0x12ef/0x35e0
kmem\_cache\_alloc\_bulk\_noprof+0x486/0x1330
\_\_io\_alloc\_req\_refill+0x84/0x560
io\_submit\_sqes+0x172f/0x2f30
\_\_se\_sys\_io\_uring\_enter+0x406/0x41c0
\_\_x64\_sys\_io\_uring\_enter+0x11f/0x1a0
x64\_sys\_call+0x2b54/0x3ba0
do\_syscall\_64+0xcd/0x1e0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Since an instance of 'struct kiocb' may be passed from the block layer
with 'private' field uninitialized, introduce 'ocfs2\_iocb\_init\_rw\_locked()'
and use it from where 'ocfs2\_dio\_end\_io()' might take care, i.e. in
'ocfs2\_file\_read\_iter()' and 'ocfs2\_file\_write\_iter()'.
Link: [https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov@yandex.ru](https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov%40yandex.ru)
Fixes: 7cdfc3a1c397 ("ocfs2: Remember rw lock level during direct io")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Reported-by: syzbot+a73e253cca4f0230a5a5@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=a73e253cca4f0230a5a5
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Joseph Qi <jiangqi903@gmail.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c966150d5abff58c3c2bdb9a6e63fd773782905)

| -rw-r--r-- | [fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.h?id=8c966150d5abff58c3c2bdb9a6e63fd773782905) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/file.c?id=8c966150d5abff58c3c2bdb9a6e63fd773782905) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.h b/fs/ocfs2/aops.hindex 3a520117fa59f0..a9ce7947228c8d 100644--- a/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65)+++ b/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=8c966150d5abff58c3c2bdb9a6e63fd773782905)@@ -70,6 +70,8 @@ enum ocfs2\_iocb\_lock\_bits { OCFS2\_IOCB\_NUM\_LOCKS }; +#define ocfs2\_iocb\_init\_rw\_locked(iocb) \+ (iocb->private = NULL) #define ocfs2\_iocb\_clear\_rw\_locked(iocb) \ clear\_bit(OCFS2\_IOCB\_RW\_LOCK, (unsigned long \*)&iocb->private) #define ocfs2\_iocb\_rw\_locked\_level(iocb) \diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.cindex 3c9316bf8a695e..cf877efdca5751 100644--- a/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65)+++ b/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=8c966150d5abff58c3c2bdb9a6e63fd773782905)@@ -2401,6 +2401,8 @@ static ssize\_t ocfs2\_file\_write\_iter(struct kiocb \*iocb, } else inode\_lock(inode); + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* Concurrent O\_DIRECT writes are allowed with \* mount\_option "coherency=buffered".@@ -2547,6 +2549,8 @@ static ssize\_t ocfs2\_file\_read\_iter(struct kiocb \*iocb, if (!direct\_io && nowait) return -EOPNOTSUPP; + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* buffered reads protect themselves in ->readpage(). O\_DIRECT reads \* need locks to protect pending reads from racing with truncate. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:29:44 +0000



=== Content from git.kernel.org_61fc30f5_20250114_223104.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-29 12:17:36 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:59 +0100 |
| commit | [66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f)) | |
| tree | [7911c49530d09a3c31a220f84baaca0bcb9e8d2f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f) | |
| parent | [bd715e191d444992d6ed124f15856da5c1cae2de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd715e191d444992d6ed124f15856da5c1cae2de) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f&id2=bd715e191d444992d6ed124f15856da5c1cae2de)) | |
| download | [linux-66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f.tar.gz) | |

ocfs2: fix uninitialized value in ocfs2\_file\_read\_iter()[ Upstream commit adc77b19f62d7e80f98400b2fca9d700d2afdd6f ]
Syzbot has reported the following KMSAN splat:
BUG: KMSAN: uninit-value in ocfs2\_file\_read\_iter+0x9a4/0xf80
ocfs2\_file\_read\_iter+0x9a4/0xf80
\_\_io\_read+0x8d4/0x20f0
io\_read+0x3e/0xf0
io\_issue\_sqe+0x42b/0x22c0
io\_wq\_submit\_work+0xaf9/0xdc0
io\_worker\_handle\_work+0xd13/0x2110
io\_wq\_worker+0x447/0x1410
ret\_from\_fork+0x6f/0x90
ret\_from\_fork\_asm+0x1a/0x30
Uninit was created at:
\_\_alloc\_pages\_noprof+0x9a7/0xe00
alloc\_pages\_mpol\_noprof+0x299/0x990
alloc\_pages\_noprof+0x1bf/0x1e0
allocate\_slab+0x33a/0x1250
\_\_\_slab\_alloc+0x12ef/0x35e0
kmem\_cache\_alloc\_bulk\_noprof+0x486/0x1330
\_\_io\_alloc\_req\_refill+0x84/0x560
io\_submit\_sqes+0x172f/0x2f30
\_\_se\_sys\_io\_uring\_enter+0x406/0x41c0
\_\_x64\_sys\_io\_uring\_enter+0x11f/0x1a0
x64\_sys\_call+0x2b54/0x3ba0
do\_syscall\_64+0xcd/0x1e0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Since an instance of 'struct kiocb' may be passed from the block layer
with 'private' field uninitialized, introduce 'ocfs2\_iocb\_init\_rw\_locked()'
and use it from where 'ocfs2\_dio\_end\_io()' might take care, i.e. in
'ocfs2\_file\_read\_iter()' and 'ocfs2\_file\_write\_iter()'.
Link: [https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov@yandex.ru](https://lkml.kernel.org/r/20241029091736.1501946-1-dmantipov%40yandex.ru)
Fixes: 7cdfc3a1c397 ("ocfs2: Remember rw lock level during direct io")
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Reported-by: syzbot+a73e253cca4f0230a5a5@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=a73e253cca4f0230a5a5
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Joseph Qi <jiangqi903@gmail.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f)

| -rw-r--r-- | [fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/aops.h?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/file.c?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/fs/ocfs2/aops.h b/fs/ocfs2/aops.hindex 70ed4382750d51..5b129ae9c3d22f 100644--- a/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=bd715e191d444992d6ed124f15856da5c1cae2de)+++ b/[fs/ocfs2/aops.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/aops.h?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f)@@ -72,6 +72,8 @@ enum ocfs2\_iocb\_lock\_bits { OCFS2\_IOCB\_NUM\_LOCKS }; +#define ocfs2\_iocb\_init\_rw\_locked(iocb) \+ (iocb->private = NULL) #define ocfs2\_iocb\_clear\_rw\_locked(iocb) \ clear\_bit(OCFS2\_IOCB\_RW\_LOCK, (unsigned long \*)&iocb->private) #define ocfs2\_iocb\_rw\_locked\_level(iocb) \diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.cindex 224ced997d64bb..3ce7606f5dbe8d 100644--- a/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=bd715e191d444992d6ed124f15856da5c1cae2de)+++ b/[fs/ocfs2/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=66b7ddd1804e2c4216dd7ead8eeb746cdbb3b62f)@@ -2401,6 +2401,8 @@ static ssize\_t ocfs2\_file\_write\_iter(struct kiocb \*iocb, } else inode\_lock(inode); + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* Concurrent O\_DIRECT writes are allowed with \* mount\_option "coherency=buffered".@@ -2547,6 +2549,8 @@ static ssize\_t ocfs2\_file\_read\_iter(struct kiocb \*iocb, if (!direct\_io && nowait) return -EOPNOTSUPP; + ocfs2\_iocb\_init\_rw\_locked(iocb);+ /\* \* buffered reads protect themselves in ->readpage(). O\_DIRECT reads \* need locks to protect pending reads from racing with truncate. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:29:41 +0000


