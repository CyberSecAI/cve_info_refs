=== Content from git.kernel.org_5d740cf3_20250114_195720.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3f23f96528e8fcf8619895c4c916c52653892ec1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3f23f96528e8fcf8619895c4c916c52653892ec1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f23f96528e8fcf8619895c4c916c52653892ec1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f23f96528e8fcf8619895c4c916c52653892ec1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liu Jian <liujian56@huawei.com> | 2024-11-12 21:54:34 +0800 |
| --- | --- | --- |
| committer | Trond Myklebust <trond.myklebust@hammerspace.com> | 2024-11-28 12:55:32 -0500 |
| commit | [3f23f96528e8fcf8619895c4c916c52653892ec1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f23f96528e8fcf8619895c4c916c52653892ec1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3f23f96528e8fcf8619895c4c916c52653892ec1)) | |
| tree | [0984b0fc2fd67e8b35e85a4851d2546311b583f6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3f23f96528e8fcf8619895c4c916c52653892ec1) | |
| parent | [d7bdd849ef1b681da03ac05ca0957b2cbe2d24b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d7bdd849ef1b681da03ac05ca0957b2cbe2d24b6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f23f96528e8fcf8619895c4c916c52653892ec1&id2=d7bdd849ef1b681da03ac05ca0957b2cbe2d24b6)) | |
| download | [linux-3f23f96528e8fcf8619895c4c916c52653892ec1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3f23f96528e8fcf8619895c4c916c52653892ec1.tar.gz) | |

sunrpc: fix one UAF issue caused by sunrpc kernel tcp socketBUG: KASAN: slab-use-after-free in tcp\_write\_timer\_handler+0x156/0x3e0
Read of size 1 at addr ffff888111f322cd by task swapper/0/0
CPU: 0 UID: 0 PID: 0 Comm: swapper/0 Not tainted 6.12.0-rc4-dirty #7
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1
Call Trace:
<IRQ>
dump\_stack\_lvl+0x68/0xa0
print\_address\_description.constprop.0+0x2c/0x3d0
print\_report+0xb4/0x270
kasan\_report+0xbd/0xf0
tcp\_write\_timer\_handler+0x156/0x3e0
tcp\_write\_timer+0x66/0x170
call\_timer\_fn+0xfb/0x1d0
\_\_run\_timers+0x3f8/0x480
run\_timer\_softirq+0x9b/0x100
handle\_softirqs+0x153/0x390
\_\_irq\_exit\_rcu+0x103/0x120
irq\_exit\_rcu+0xe/0x20
sysvec\_apic\_timer\_interrupt+0x76/0x90
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt+0x1a/0x20
RIP: 0010:default\_idle+0xf/0x20
Code: 4c 01 c7 4c 29 c2 e9 72 ff ff ff 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 f3 0f 1e fa 66 90 0f 00 2d 33 f8 25 00 fb f4 <fa> c3 cc cc cc
cc 66 66 2e 0f 1f 84 00 00 00 00 00 90 90 90 90 90
RSP: 0018:ffffffffa2007e28 EFLAGS: 00000242
RAX: 00000000000f3b31 RBX: 1ffffffff4400fc7 RCX: ffffffffa09c3196
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffffffff9f00590f
RBP: 0000000000000000 R08: 0000000000000001 R09: ffffed102360835d
R10: ffff88811b041aeb R11: 0000000000000001 R12: 0000000000000000
R13: ffffffffa202d7c0 R14: 0000000000000000 R15: 00000000000147d0
default\_idle\_call+0x6b/0xa0
cpuidle\_idle\_call+0x1af/0x1f0
do\_idle+0xbc/0x130
cpu\_startup\_entry+0x33/0x40
rest\_init+0x11f/0x210
start\_kernel+0x39a/0x420
x86\_64\_start\_reservations+0x18/0x30
x86\_64\_start\_kernel+0x97/0xa0
common\_startup\_64+0x13e/0x141
</TASK>
Allocated by task 595:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_slab\_alloc+0x87/0x90
kmem\_cache\_alloc\_noprof+0x12b/0x3f0
copy\_net\_ns+0x94/0x380
create\_new\_namespaces+0x24c/0x500
unshare\_nsproxy\_namespaces+0x75/0xf0
ksys\_unshare+0x24e/0x4f0
\_\_x64\_sys\_unshare+0x1f/0x30
do\_syscall\_64+0x70/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Freed by task 100:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x54/0x70
kmem\_cache\_free+0x156/0x5d0
cleanup\_net+0x5d3/0x670
process\_one\_work+0x776/0xa90
worker\_thread+0x2e2/0x560
kthread+0x1a8/0x1f0
ret\_from\_fork+0x34/0x60
ret\_from\_fork\_asm+0x1a/0x30
Reproduction script:
mkdir -p /mnt/nfsshare
mkdir -p /mnt/nfs/netns\_1
mkfs.ext4 /dev/sdb
mount /dev/sdb /mnt/nfsshare
systemctl restart nfs-server
chmod 777 /mnt/nfsshare
exportfs -i -o rw,no\_root\_squash \*:/mnt/nfsshare
ip netns add netns\_1
ip link add name veth\_1\_peer type veth peer veth\_1
ifconfig veth\_1\_peer 11.11.0.254 up
ip link set veth\_1 netns netns\_1
ip netns exec netns\_1 ifconfig veth\_1 11.11.0.1
ip netns exec netns\_1 /root/iptables -A OUTPUT -d 11.11.0.254 -p tcp \
--tcp-flags FIN FIN -j DROP
(note: In my environment, a DESTROY\_CLIENTID operation is always sent
immediately, breaking the nfs tcp connection.)
ip netns exec netns\_1 timeout -s 9 300 mount -t nfs -o proto=tcp,vers=4.1 \
11.11.0.254:/mnt/nfsshare /mnt/nfs/netns\_1
ip netns del netns\_1
The reason here is that the tcp socket in netns\_1 (nfs side) has been
shutdown and closed (done in xs\_destroy), but the FIN message (with ack)
is discarded, and the nfsd side keeps sending retransmission messages.
As a result, when the tcp sock in netns\_1 processes the received message,
it sends the message (FIN message) in the sending queue, and the tcp timer
is re-established. When the network namespace is deleted, the net structure
accessed by tcp's timer handler function causes problems.
To fix this problem, let's hold netns refcnt for the tcp kernel socket as
done in other modules. This is an ugly hack which can easily be backported
to earlier kernels. A proper fix which cleans up the interfaces will
follow, but may not be so easy to backport.
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Signed-off-by: Liu Jian <liujian56@huawei.com>
Acked-by: Jeff Layton <jlayton@kernel.org>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f23f96528e8fcf8619895c4c916c52653892ec1)

| -rw-r--r-- | [net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/svcsock.c?id=3f23f96528e8fcf8619895c4c916c52653892ec1) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=3f23f96528e8fcf8619895c4c916c52653892ec1) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/net/sunrpc/svcsock.c b/net/sunrpc/svcsock.cindex 825ec53576912a..59e2c46240f5c1 100644--- a/[net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/svcsock.c?id=d7bdd849ef1b681da03ac05ca0957b2cbe2d24b6)+++ b/[net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/svcsock.c?id=3f23f96528e8fcf8619895c4c916c52653892ec1)@@ -1551,6 +1551,10 @@ static struct svc\_xprt \*svc\_create\_socket(struct svc\_serv \*serv, newlen = error;  if (protocol == IPPROTO\_TCP) {+ \_\_netns\_tracker\_free(net, &sock->sk->ns\_tracker, false);+ sock->sk->sk\_net\_refcnt = 1;+ get\_net\_track(net, &sock->sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(net, 1); if ((error = kernel\_listen(sock, 64)) < 0) goto bummer; }diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex fecc8b8fa26618..c60936d8cef71b 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=d7bdd849ef1b681da03ac05ca0957b2cbe2d24b6)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=3f23f96528e8fcf8619895c4c916c52653892ec1)@@ -1941,6 +1941,13 @@ static struct socket \*xs\_create\_sock(struct rpc\_xprt \*xprt, goto out; } + if (protocol == IPPROTO\_TCP) {+ \_\_netns\_tracker\_free(xprt->xprt\_net, &sock->sk->ns\_tracker, false);+ sock->sk->sk\_net\_refcnt = 1;+ get\_net\_track(xprt->xprt\_net, &sock->sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(xprt->xprt\_net, 1);+ }+ filp = sock\_alloc\_file(sock, O\_NONBLOCK, NULL); if (IS\_ERR(filp)) return ERR\_CAST(filp); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:57 +0000



=== Content from git.kernel.org_fb0c1a69_20250114_195721.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=61c0a5eac96836de5e3a5897eccdc63162a94936)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61c0a5eac96836de5e3a5897eccdc63162a94936)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61c0a5eac96836de5e3a5897eccdc63162a94936)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61c0a5eac96836de5e3a5897eccdc63162a94936)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liu Jian <liujian56@huawei.com> | 2024-11-12 21:54:34 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:03:09 +0100 |
| commit | [61c0a5eac96836de5e3a5897eccdc63162a94936](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61c0a5eac96836de5e3a5897eccdc63162a94936) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=61c0a5eac96836de5e3a5897eccdc63162a94936)) | |
| tree | [443c5e31cc8653f41dc486ce52704307b64c1f01](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61c0a5eac96836de5e3a5897eccdc63162a94936) | |
| parent | [a84e6c15f101cd08f7534b09ecab5c21bdc0d72b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a84e6c15f101cd08f7534b09ecab5c21bdc0d72b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61c0a5eac96836de5e3a5897eccdc63162a94936&id2=a84e6c15f101cd08f7534b09ecab5c21bdc0d72b)) | |
| download | [linux-61c0a5eac96836de5e3a5897eccdc63162a94936.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-61c0a5eac96836de5e3a5897eccdc63162a94936.tar.gz) | |

sunrpc: fix one UAF issue caused by sunrpc kernel tcp socket[ Upstream commit 3f23f96528e8fcf8619895c4c916c52653892ec1 ]
BUG: KASAN: slab-use-after-free in tcp\_write\_timer\_handler+0x156/0x3e0
Read of size 1 at addr ffff888111f322cd by task swapper/0/0
CPU: 0 UID: 0 PID: 0 Comm: swapper/0 Not tainted 6.12.0-rc4-dirty #7
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1
Call Trace:
<IRQ>
dump\_stack\_lvl+0x68/0xa0
print\_address\_description.constprop.0+0x2c/0x3d0
print\_report+0xb4/0x270
kasan\_report+0xbd/0xf0
tcp\_write\_timer\_handler+0x156/0x3e0
tcp\_write\_timer+0x66/0x170
call\_timer\_fn+0xfb/0x1d0
\_\_run\_timers+0x3f8/0x480
run\_timer\_softirq+0x9b/0x100
handle\_softirqs+0x153/0x390
\_\_irq\_exit\_rcu+0x103/0x120
irq\_exit\_rcu+0xe/0x20
sysvec\_apic\_timer\_interrupt+0x76/0x90
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt+0x1a/0x20
RIP: 0010:default\_idle+0xf/0x20
Code: 4c 01 c7 4c 29 c2 e9 72 ff ff ff 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 f3 0f 1e fa 66 90 0f 00 2d 33 f8 25 00 fb f4 <fa> c3 cc cc cc
cc 66 66 2e 0f 1f 84 00 00 00 00 00 90 90 90 90 90
RSP: 0018:ffffffffa2007e28 EFLAGS: 00000242
RAX: 00000000000f3b31 RBX: 1ffffffff4400fc7 RCX: ffffffffa09c3196
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffffffff9f00590f
RBP: 0000000000000000 R08: 0000000000000001 R09: ffffed102360835d
R10: ffff88811b041aeb R11: 0000000000000001 R12: 0000000000000000
R13: ffffffffa202d7c0 R14: 0000000000000000 R15: 00000000000147d0
default\_idle\_call+0x6b/0xa0
cpuidle\_idle\_call+0x1af/0x1f0
do\_idle+0xbc/0x130
cpu\_startup\_entry+0x33/0x40
rest\_init+0x11f/0x210
start\_kernel+0x39a/0x420
x86\_64\_start\_reservations+0x18/0x30
x86\_64\_start\_kernel+0x97/0xa0
common\_startup\_64+0x13e/0x141
</TASK>
Allocated by task 595:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_slab\_alloc+0x87/0x90
kmem\_cache\_alloc\_noprof+0x12b/0x3f0
copy\_net\_ns+0x94/0x380
create\_new\_namespaces+0x24c/0x500
unshare\_nsproxy\_namespaces+0x75/0xf0
ksys\_unshare+0x24e/0x4f0
\_\_x64\_sys\_unshare+0x1f/0x30
do\_syscall\_64+0x70/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Freed by task 100:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x54/0x70
kmem\_cache\_free+0x156/0x5d0
cleanup\_net+0x5d3/0x670
process\_one\_work+0x776/0xa90
worker\_thread+0x2e2/0x560
kthread+0x1a8/0x1f0
ret\_from\_fork+0x34/0x60
ret\_from\_fork\_asm+0x1a/0x30
Reproduction script:
mkdir -p /mnt/nfsshare
mkdir -p /mnt/nfs/netns\_1
mkfs.ext4 /dev/sdb
mount /dev/sdb /mnt/nfsshare
systemctl restart nfs-server
chmod 777 /mnt/nfsshare
exportfs -i -o rw,no\_root\_squash \*:/mnt/nfsshare
ip netns add netns\_1
ip link add name veth\_1\_peer type veth peer veth\_1
ifconfig veth\_1\_peer 11.11.0.254 up
ip link set veth\_1 netns netns\_1
ip netns exec netns\_1 ifconfig veth\_1 11.11.0.1
ip netns exec netns\_1 /root/iptables -A OUTPUT -d 11.11.0.254 -p tcp \
--tcp-flags FIN FIN -j DROP
(note: In my environment, a DESTROY\_CLIENTID operation is always sent
immediately, breaking the nfs tcp connection.)
ip netns exec netns\_1 timeout -s 9 300 mount -t nfs -o proto=tcp,vers=4.1 \
11.11.0.254:/mnt/nfsshare /mnt/nfs/netns\_1
ip netns del netns\_1
The reason here is that the tcp socket in netns\_1 (nfs side) has been
shutdown and closed (done in xs\_destroy), but the FIN message (with ack)
is discarded, and the nfsd side keeps sending retransmission messages.
As a result, when the tcp sock in netns\_1 processes the received message,
it sends the message (FIN message) in the sending queue, and the tcp timer
is re-established. When the network namespace is deleted, the net structure
accessed by tcp's timer handler function causes problems.
To fix this problem, let's hold netns refcnt for the tcp kernel socket as
done in other modules. This is an ugly hack which can easily be backported
to earlier kernels. A proper fix which cleans up the interfaces will
follow, but may not be so easy to backport.
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Signed-off-by: Liu Jian <liujian56@huawei.com>
Acked-by: Jeff Layton <jlayton@kernel.org>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61c0a5eac96836de5e3a5897eccdc63162a94936)

| -rw-r--r-- | [net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/svcsock.c?id=61c0a5eac96836de5e3a5897eccdc63162a94936) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=61c0a5eac96836de5e3a5897eccdc63162a94936) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/net/sunrpc/svcsock.c b/net/sunrpc/svcsock.cindex 825ec53576912a..59e2c46240f5c1 100644--- a/[net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/svcsock.c?id=a84e6c15f101cd08f7534b09ecab5c21bdc0d72b)+++ b/[net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/svcsock.c?id=61c0a5eac96836de5e3a5897eccdc63162a94936)@@ -1551,6 +1551,10 @@ static struct svc\_xprt \*svc\_create\_socket(struct svc\_serv \*serv, newlen = error;  if (protocol == IPPROTO\_TCP) {+ \_\_netns\_tracker\_free(net, &sock->sk->ns\_tracker, false);+ sock->sk->sk\_net\_refcnt = 1;+ get\_net\_track(net, &sock->sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(net, 1); if ((error = kernel\_listen(sock, 64)) < 0) goto bummer; }diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex 43fb96de8ebe55..b69e6290acfabe 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=a84e6c15f101cd08f7534b09ecab5c21bdc0d72b)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=61c0a5eac96836de5e3a5897eccdc63162a94936)@@ -1940,6 +1940,13 @@ static struct socket \*xs\_create\_sock(struct rpc\_xprt \*xprt, goto out; } + if (protocol == IPPROTO\_TCP) {+ \_\_netns\_tracker\_free(xprt->xprt\_net, &sock->sk->ns\_tracker, false);+ sock->sk->sk\_net\_refcnt = 1;+ get\_net\_track(xprt->xprt\_net, &sock->sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(xprt->xprt\_net, 1);+ }+ filp = sock\_alloc\_file(sock, O\_NONBLOCK, NULL); if (IS\_ERR(filp)) return ERR\_CAST(filp); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:58 +0000



=== Content from git.kernel.org_9be1db19_20250114_195719.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0ca87e5063757132a044d35baba40a7d4bb25394)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ca87e5063757132a044d35baba40a7d4bb25394)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ca87e5063757132a044d35baba40a7d4bb25394)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ca87e5063757132a044d35baba40a7d4bb25394)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liu Jian <liujian56@huawei.com> | 2024-11-12 21:54:34 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:33:00 +0100 |
| commit | [0ca87e5063757132a044d35baba40a7d4bb25394](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ca87e5063757132a044d35baba40a7d4bb25394) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0ca87e5063757132a044d35baba40a7d4bb25394)) | |
| tree | [acd72174a03c20f2af8d7318ee1f1163574bed78](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ca87e5063757132a044d35baba40a7d4bb25394) | |
| parent | [931be6b73830bc3d358fe8e896221a22f882fdf7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=931be6b73830bc3d358fe8e896221a22f882fdf7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ca87e5063757132a044d35baba40a7d4bb25394&id2=931be6b73830bc3d358fe8e896221a22f882fdf7)) | |
| download | [linux-0ca87e5063757132a044d35baba40a7d4bb25394.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0ca87e5063757132a044d35baba40a7d4bb25394.tar.gz) | |

sunrpc: fix one UAF issue caused by sunrpc kernel tcp socket[ Upstream commit 3f23f96528e8fcf8619895c4c916c52653892ec1 ]
BUG: KASAN: slab-use-after-free in tcp\_write\_timer\_handler+0x156/0x3e0
Read of size 1 at addr ffff888111f322cd by task swapper/0/0
CPU: 0 UID: 0 PID: 0 Comm: swapper/0 Not tainted 6.12.0-rc4-dirty #7
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1
Call Trace:
<IRQ>
dump\_stack\_lvl+0x68/0xa0
print\_address\_description.constprop.0+0x2c/0x3d0
print\_report+0xb4/0x270
kasan\_report+0xbd/0xf0
tcp\_write\_timer\_handler+0x156/0x3e0
tcp\_write\_timer+0x66/0x170
call\_timer\_fn+0xfb/0x1d0
\_\_run\_timers+0x3f8/0x480
run\_timer\_softirq+0x9b/0x100
handle\_softirqs+0x153/0x390
\_\_irq\_exit\_rcu+0x103/0x120
irq\_exit\_rcu+0xe/0x20
sysvec\_apic\_timer\_interrupt+0x76/0x90
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt+0x1a/0x20
RIP: 0010:default\_idle+0xf/0x20
Code: 4c 01 c7 4c 29 c2 e9 72 ff ff ff 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 f3 0f 1e fa 66 90 0f 00 2d 33 f8 25 00 fb f4 <fa> c3 cc cc cc
cc 66 66 2e 0f 1f 84 00 00 00 00 00 90 90 90 90 90
RSP: 0018:ffffffffa2007e28 EFLAGS: 00000242
RAX: 00000000000f3b31 RBX: 1ffffffff4400fc7 RCX: ffffffffa09c3196
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffffffff9f00590f
RBP: 0000000000000000 R08: 0000000000000001 R09: ffffed102360835d
R10: ffff88811b041aeb R11: 0000000000000001 R12: 0000000000000000
R13: ffffffffa202d7c0 R14: 0000000000000000 R15: 00000000000147d0
default\_idle\_call+0x6b/0xa0
cpuidle\_idle\_call+0x1af/0x1f0
do\_idle+0xbc/0x130
cpu\_startup\_entry+0x33/0x40
rest\_init+0x11f/0x210
start\_kernel+0x39a/0x420
x86\_64\_start\_reservations+0x18/0x30
x86\_64\_start\_kernel+0x97/0xa0
common\_startup\_64+0x13e/0x141
</TASK>
Allocated by task 595:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_slab\_alloc+0x87/0x90
kmem\_cache\_alloc\_noprof+0x12b/0x3f0
copy\_net\_ns+0x94/0x380
create\_new\_namespaces+0x24c/0x500
unshare\_nsproxy\_namespaces+0x75/0xf0
ksys\_unshare+0x24e/0x4f0
\_\_x64\_sys\_unshare+0x1f/0x30
do\_syscall\_64+0x70/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Freed by task 100:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x54/0x70
kmem\_cache\_free+0x156/0x5d0
cleanup\_net+0x5d3/0x670
process\_one\_work+0x776/0xa90
worker\_thread+0x2e2/0x560
kthread+0x1a8/0x1f0
ret\_from\_fork+0x34/0x60
ret\_from\_fork\_asm+0x1a/0x30
Reproduction script:
mkdir -p /mnt/nfsshare
mkdir -p /mnt/nfs/netns\_1
mkfs.ext4 /dev/sdb
mount /dev/sdb /mnt/nfsshare
systemctl restart nfs-server
chmod 777 /mnt/nfsshare
exportfs -i -o rw,no\_root\_squash \*:/mnt/nfsshare
ip netns add netns\_1
ip link add name veth\_1\_peer type veth peer veth\_1
ifconfig veth\_1\_peer 11.11.0.254 up
ip link set veth\_1 netns netns\_1
ip netns exec netns\_1 ifconfig veth\_1 11.11.0.1
ip netns exec netns\_1 /root/iptables -A OUTPUT -d 11.11.0.254 -p tcp \
--tcp-flags FIN FIN -j DROP
(note: In my environment, a DESTROY\_CLIENTID operation is always sent
immediately, breaking the nfs tcp connection.)
ip netns exec netns\_1 timeout -s 9 300 mount -t nfs -o proto=tcp,vers=4.1 \
11.11.0.254:/mnt/nfsshare /mnt/nfs/netns\_1
ip netns del netns\_1
The reason here is that the tcp socket in netns\_1 (nfs side) has been
shutdown and closed (done in xs\_destroy), but the FIN message (with ack)
is discarded, and the nfsd side keeps sending retransmission messages.
As a result, when the tcp sock in netns\_1 processes the received message,
it sends the message (FIN message) in the sending queue, and the tcp timer
is re-established. When the network namespace is deleted, the net structure
accessed by tcp's timer handler function causes problems.
To fix this problem, let's hold netns refcnt for the tcp kernel socket as
done in other modules. This is an ugly hack which can easily be backported
to earlier kernels. A proper fix which cleans up the interfaces will
follow, but may not be so easy to backport.
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Signed-off-by: Liu Jian <liujian56@huawei.com>
Acked-by: Jeff Layton <jlayton@kernel.org>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ca87e5063757132a044d35baba40a7d4bb25394)

| -rw-r--r-- | [net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/svcsock.c?id=0ca87e5063757132a044d35baba40a7d4bb25394) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=0ca87e5063757132a044d35baba40a7d4bb25394) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/net/sunrpc/svcsock.c b/net/sunrpc/svcsock.cindex 933e12e3a55c75..83996eea100626 100644--- a/[net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/svcsock.c?id=931be6b73830bc3d358fe8e896221a22f882fdf7)+++ b/[net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/svcsock.c?id=0ca87e5063757132a044d35baba40a7d4bb25394)@@ -1562,6 +1562,10 @@ static struct svc\_xprt \*svc\_create\_socket(struct svc\_serv \*serv, newlen = error;  if (protocol == IPPROTO\_TCP) {+ \_\_netns\_tracker\_free(net, &sock->sk->ns\_tracker, false);+ sock->sk->sk\_net\_refcnt = 1;+ get\_net\_track(net, &sock->sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(net, 1); if ((error = kernel\_listen(sock, 64)) < 0) goto bummer; }diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex c5282972451254..1c4bc8234ea875 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=931be6b73830bc3d358fe8e896221a22f882fdf7)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=0ca87e5063757132a044d35baba40a7d4bb25394)@@ -1921,6 +1921,13 @@ static struct socket \*xs\_create\_sock(struct rpc\_xprt \*xprt, goto out; } + if (protocol == IPPROTO\_TCP) {+ \_\_netns\_tracker\_free(xprt->xprt\_net, &sock->sk->ns\_tracker, false);+ sock->sk->sk\_net\_refcnt = 1;+ get\_net\_track(xprt->xprt\_net, &sock->sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(xprt->xprt\_net, 1);+ }+ filp = sock\_alloc\_file(sock, O\_NONBLOCK, NULL); if (IS\_ERR(filp)) return ERR\_CAST(filp); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:57 +0000



=== Content from git.kernel.org_ba3db033_20250114_195721.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liu Jian <liujian56@huawei.com> | 2024-11-12 21:54:34 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:33 +0100 |
| commit | [694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3)) | |
| tree | [e84ce839cf085f44fdabb0412340a3b3166b55ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3) | |
| parent | [f1c4c4f9c9ba2e210f8a64542b0b9701ef82a3f5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1c4c4f9c9ba2e210f8a64542b0b9701ef82a3f5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3&id2=f1c4c4f9c9ba2e210f8a64542b0b9701ef82a3f5)) | |
| download | [linux-694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3.tar.gz) | |

sunrpc: fix one UAF issue caused by sunrpc kernel tcp socket[ Upstream commit 3f23f96528e8fcf8619895c4c916c52653892ec1 ]
BUG: KASAN: slab-use-after-free in tcp\_write\_timer\_handler+0x156/0x3e0
Read of size 1 at addr ffff888111f322cd by task swapper/0/0
CPU: 0 UID: 0 PID: 0 Comm: swapper/0 Not tainted 6.12.0-rc4-dirty #7
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1
Call Trace:
<IRQ>
dump\_stack\_lvl+0x68/0xa0
print\_address\_description.constprop.0+0x2c/0x3d0
print\_report+0xb4/0x270
kasan\_report+0xbd/0xf0
tcp\_write\_timer\_handler+0x156/0x3e0
tcp\_write\_timer+0x66/0x170
call\_timer\_fn+0xfb/0x1d0
\_\_run\_timers+0x3f8/0x480
run\_timer\_softirq+0x9b/0x100
handle\_softirqs+0x153/0x390
\_\_irq\_exit\_rcu+0x103/0x120
irq\_exit\_rcu+0xe/0x20
sysvec\_apic\_timer\_interrupt+0x76/0x90
</IRQ>
<TASK>
asm\_sysvec\_apic\_timer\_interrupt+0x1a/0x20
RIP: 0010:default\_idle+0xf/0x20
Code: 4c 01 c7 4c 29 c2 e9 72 ff ff ff 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 f3 0f 1e fa 66 90 0f 00 2d 33 f8 25 00 fb f4 <fa> c3 cc cc cc
cc 66 66 2e 0f 1f 84 00 00 00 00 00 90 90 90 90 90
RSP: 0018:ffffffffa2007e28 EFLAGS: 00000242
RAX: 00000000000f3b31 RBX: 1ffffffff4400fc7 RCX: ffffffffa09c3196
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffffffff9f00590f
RBP: 0000000000000000 R08: 0000000000000001 R09: ffffed102360835d
R10: ffff88811b041aeb R11: 0000000000000001 R12: 0000000000000000
R13: ffffffffa202d7c0 R14: 0000000000000000 R15: 00000000000147d0
default\_idle\_call+0x6b/0xa0
cpuidle\_idle\_call+0x1af/0x1f0
do\_idle+0xbc/0x130
cpu\_startup\_entry+0x33/0x40
rest\_init+0x11f/0x210
start\_kernel+0x39a/0x420
x86\_64\_start\_reservations+0x18/0x30
x86\_64\_start\_kernel+0x97/0xa0
common\_startup\_64+0x13e/0x141
</TASK>
Allocated by task 595:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_slab\_alloc+0x87/0x90
kmem\_cache\_alloc\_noprof+0x12b/0x3f0
copy\_net\_ns+0x94/0x380
create\_new\_namespaces+0x24c/0x500
unshare\_nsproxy\_namespaces+0x75/0xf0
ksys\_unshare+0x24e/0x4f0
\_\_x64\_sys\_unshare+0x1f/0x30
do\_syscall\_64+0x70/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Freed by task 100:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x54/0x70
kmem\_cache\_free+0x156/0x5d0
cleanup\_net+0x5d3/0x670
process\_one\_work+0x776/0xa90
worker\_thread+0x2e2/0x560
kthread+0x1a8/0x1f0
ret\_from\_fork+0x34/0x60
ret\_from\_fork\_asm+0x1a/0x30
Reproduction script:
mkdir -p /mnt/nfsshare
mkdir -p /mnt/nfs/netns\_1
mkfs.ext4 /dev/sdb
mount /dev/sdb /mnt/nfsshare
systemctl restart nfs-server
chmod 777 /mnt/nfsshare
exportfs -i -o rw,no\_root\_squash \*:/mnt/nfsshare
ip netns add netns\_1
ip link add name veth\_1\_peer type veth peer veth\_1
ifconfig veth\_1\_peer 11.11.0.254 up
ip link set veth\_1 netns netns\_1
ip netns exec netns\_1 ifconfig veth\_1 11.11.0.1
ip netns exec netns\_1 /root/iptables -A OUTPUT -d 11.11.0.254 -p tcp \
--tcp-flags FIN FIN -j DROP
(note: In my environment, a DESTROY\_CLIENTID operation is always sent
immediately, breaking the nfs tcp connection.)
ip netns exec netns\_1 timeout -s 9 300 mount -t nfs -o proto=tcp,vers=4.1 \
11.11.0.254:/mnt/nfsshare /mnt/nfs/netns\_1
ip netns del netns\_1
The reason here is that the tcp socket in netns\_1 (nfs side) has been
shutdown and closed (done in xs\_destroy), but the FIN message (with ack)
is discarded, and the nfsd side keeps sending retransmission messages.
As a result, when the tcp sock in netns\_1 processes the received message,
it sends the message (FIN message) in the sending queue, and the tcp timer
is re-established. When the network namespace is deleted, the net structure
accessed by tcp's timer handler function causes problems.
To fix this problem, let's hold netns refcnt for the tcp kernel socket as
done in other modules. This is an ugly hack which can easily be backported
to earlier kernels. A proper fix which cleans up the interfaces will
follow, but may not be so easy to backport.
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Signed-off-by: Liu Jian <liujian56@huawei.com>
Acked-by: Jeff Layton <jlayton@kernel.org>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3)

| -rw-r--r-- | [net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/svcsock.c?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sunrpc/xprtsock.c?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/net/sunrpc/svcsock.c b/net/sunrpc/svcsock.cindex 6b3f01beb294b9..9a97ffef3adf0e 100644--- a/[net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/svcsock.c?id=f1c4c4f9c9ba2e210f8a64542b0b9701ef82a3f5)+++ b/[net/sunrpc/svcsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/svcsock.c?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3)@@ -1552,6 +1552,10 @@ static struct svc\_xprt \*svc\_create\_socket(struct svc\_serv \*serv, newlen = error;  if (protocol == IPPROTO\_TCP) {+ \_\_netns\_tracker\_free(net, &sock->sk->ns\_tracker, false);+ sock->sk->sk\_net\_refcnt = 1;+ get\_net\_track(net, &sock->sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(net, 1); if ((error = kernel\_listen(sock, 64)) < 0) goto bummer; }diff --git a/net/sunrpc/xprtsock.c b/net/sunrpc/xprtsock.cindex 43fb96de8ebe55..b69e6290acfabe 100644--- a/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=f1c4c4f9c9ba2e210f8a64542b0b9701ef82a3f5)+++ b/[net/sunrpc/xprtsock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sunrpc/xprtsock.c?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3)@@ -1940,6 +1940,13 @@ static struct socket \*xs\_create\_sock(struct rpc\_xprt \*xprt, goto out; } + if (protocol == IPPROTO\_TCP) {+ \_\_netns\_tracker\_free(xprt->xprt\_net, &sock->sk->ns\_tracker, false);+ sock->sk->sk\_net\_refcnt = 1;+ get\_net\_track(xprt->xprt\_net, &sock->sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(xprt->xprt\_net, 1);+ }+ filp = sock\_alloc\_file(sock, O\_NONBLOCK, NULL); if (IS\_ERR(filp)) return ERR\_CAST(filp); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:55:58 +0000


