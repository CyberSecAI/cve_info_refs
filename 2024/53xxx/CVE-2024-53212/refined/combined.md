=== Content from git.kernel.org_cbf456bf_20250114_205405.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-11-19 14:44:31 -0800 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-11-24 16:58:07 -0800 |
| commit | [3bf39fa849ab8ed52abb6715922e6102d3df9f97](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97)) | |
| tree | [4ee5d595a56e44fc3918f076bbaf104e3e530bd8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97) | |
| parent | [f164b296638d1eb1fb1c537e93ab5c8b49966546](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f164b296638d1eb1fb1c537e93ab5c8b49966546) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97&id2=f164b296638d1eb1fb1c537e93ab5c8b49966546)) | |
| download | [linux-3bf39fa849ab8ed52abb6715922e6102d3df9f97.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3bf39fa849ab8ed52abb6715922e6102d3df9f97.tar.gz) | |

netlink: fix false positive warning in extack during dumpsCommit under fixes extended extack reporting to dumps.
It works under normal conditions, because extack errors are
usually reported during ->start() or the first ->dump(),
it's quite rare that the dump starts okay but fails later.
If the dump does fail later, however, the input skb will
already have the initiating message pulled, so checking
if bad attr falls within skb->data will fail.
Switch the check to using nlh, which is always valid.
syzbot found a way to hit that scenario by filling up
the receive queue. In this case we initiate a dump
but don't call ->dump() until there is read space for
an skb.
WARNING: CPU: 1 PID: 5845 at net/netlink/af\_netlink.c:2210 netlink\_ack\_tlv\_fill+0x1a8/0x560 net/netlink/af\_netlink.c:2209
RIP: 0010:netlink\_ack\_tlv\_fill+0x1a8/0x560 net/netlink/af\_netlink.c:2209
Call Trace:
<TASK>
netlink\_dump\_done+0x513/0x970 net/netlink/af\_netlink.c:2250
netlink\_dump+0x91f/0xe10 net/netlink/af\_netlink.c:2351
netlink\_recvmsg+0x6bb/0x11d0 net/netlink/af\_netlink.c:1983
sock\_recvmsg\_nosec net/socket.c:1051 [inline]
sock\_recvmsg+0x22f/0x280 net/socket.c:1073
\_\_sys\_recvfrom+0x246/0x3d0 net/socket.c:2267
\_\_do\_sys\_recvfrom net/socket.c:2285 [inline]
\_\_se\_sys\_recvfrom net/socket.c:2281 [inline]
\_\_x64\_sys\_recvfrom+0xde/0x100 net/socket.c:2281
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7ff37dd17a79
Reported-by: syzbot+d4373fa8042c06cefa84@syzkaller.appspotmail.com
Fixes: 8af4f60472fc ("netlink: support all extack types in dumps")
Reviewed-by: Jacob Keller <jacob.e.keller@intel.com>
Link: [https://patch.msgid.link/20241119224432.1713040-1-kuba@kernel.org](https://patch.msgid.link/20241119224432.1713040-1-kuba%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97)

| -rw-r--r-- | [net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netlink/af_netlink.c?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 10 deletions

| diff --git a/net/netlink/af\_netlink.c b/net/netlink/af\_netlink.cindex dd3517b0fdfd5e..f4e7b5e4bb59fd 100644--- a/[net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netlink/af_netlink.c?id=f164b296638d1eb1fb1c537e93ab5c8b49966546)+++ b/[net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netlink/af_netlink.c?id=3bf39fa849ab8ed52abb6715922e6102d3df9f97)@@ -2181,9 +2181,14 @@ netlink\_ack\_tlv\_len(struct netlink\_sock \*nlk, int err, return tlvlen; } +static bool nlmsg\_check\_in\_payload(const struct nlmsghdr \*nlh, const void \*addr)+{+ return !WARN\_ON(addr < nlmsg\_data(nlh) ||+ addr - (const void \*) nlh >= nlh->nlmsg\_len);+}+ static void-netlink\_ack\_tlv\_fill(struct sk\_buff \*in\_skb, struct sk\_buff \*skb,- const struct nlmsghdr \*nlh, int err,+netlink\_ack\_tlv\_fill(struct sk\_buff \*skb, const struct nlmsghdr \*nlh, int err, const struct netlink\_ext\_ack \*extack) { if (extack->\_msg)@@ -2195,9 +2200,7 @@ netlink\_ack\_tlv\_fill(struct sk\_buff \*in\_skb, struct sk\_buff \*skb, if (!err) return; - if (extack->bad\_attr &&- !WARN\_ON((u8 \*)extack->bad\_attr < in\_skb->data ||- (u8 \*)extack->bad\_attr >= in\_skb->data + in\_skb->len))+ if (extack->bad\_attr && nlmsg\_check\_in\_payload(nlh, extack->bad\_attr)) WARN\_ON(nla\_put\_u32(skb, NLMSGERR\_ATTR\_OFFS, (u8 \*)extack->bad\_attr - (const u8 \*)nlh)); if (extack->policy)@@ -2206,9 +2209,7 @@ netlink\_ack\_tlv\_fill(struct sk\_buff \*in\_skb, struct sk\_buff \*skb, if (extack->miss\_type) WARN\_ON(nla\_put\_u32(skb, NLMSGERR\_ATTR\_MISS\_TYPE, extack->miss\_type));- if (extack->miss\_nest &&- !WARN\_ON((u8 \*)extack->miss\_nest < in\_skb->data ||- (u8 \*)extack->miss\_nest > in\_skb->data + in\_skb->len))+ if (extack->miss\_nest && nlmsg\_check\_in\_payload(nlh, extack->miss\_nest)) WARN\_ON(nla\_put\_u32(skb, NLMSGERR\_ATTR\_MISS\_NEST, (u8 \*)extack->miss\_nest - (const u8 \*)nlh)); }@@ -2237,7 +2238,7 @@ static int netlink\_dump\_done(struct netlink\_sock \*nlk, struct sk\_buff \*skb, if (extack\_len) { nlh->nlmsg\_flags |= NLM\_F\_ACK\_TLVS; if (skb\_tailroom(skb) >= extack\_len) {- netlink\_ack\_tlv\_fill(cb->skb, skb, cb->nlh,+ netlink\_ack\_tlv\_fill(skb, cb->nlh, nlk->dump\_done\_errno, extack); nlmsg\_end(skb, nlh); }@@ -2496,7 +2497,7 @@ void netlink\_ack(struct sk\_buff \*in\_skb, struct nlmsghdr \*nlh, int err, }  if (tlvlen)- netlink\_ack\_tlv\_fill(in\_skb, skb, nlh, err, extack);+ netlink\_ack\_tlv\_fill(skb, nlh, err, extack);  nlmsg\_end(skb, rep); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:52:42 +0000



=== Content from git.kernel.org_a676b80c_20250114_205406.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-11-19 14:44:31 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:58 +0100 |
| commit | [6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d)) | |
| tree | [b3646a7c1234ab1b6531fa1e9ff11fa6eb183436](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d) | |
| parent | [e54f1237a8018bca25fe58cc3b5a0442051315d1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e54f1237a8018bca25fe58cc3b5a0442051315d1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d&id2=e54f1237a8018bca25fe58cc3b5a0442051315d1)) | |
| download | [linux-6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d.tar.gz) | |

netlink: fix false positive warning in extack during dumps[ Upstream commit 3bf39fa849ab8ed52abb6715922e6102d3df9f97 ]
Commit under fixes extended extack reporting to dumps.
It works under normal conditions, because extack errors are
usually reported during ->start() or the first ->dump(),
it's quite rare that the dump starts okay but fails later.
If the dump does fail later, however, the input skb will
already have the initiating message pulled, so checking
if bad attr falls within skb->data will fail.
Switch the check to using nlh, which is always valid.
syzbot found a way to hit that scenario by filling up
the receive queue. In this case we initiate a dump
but don't call ->dump() until there is read space for
an skb.
WARNING: CPU: 1 PID: 5845 at net/netlink/af\_netlink.c:2210 netlink\_ack\_tlv\_fill+0x1a8/0x560 net/netlink/af\_netlink.c:2209
RIP: 0010:netlink\_ack\_tlv\_fill+0x1a8/0x560 net/netlink/af\_netlink.c:2209
Call Trace:
<TASK>
netlink\_dump\_done+0x513/0x970 net/netlink/af\_netlink.c:2250
netlink\_dump+0x91f/0xe10 net/netlink/af\_netlink.c:2351
netlink\_recvmsg+0x6bb/0x11d0 net/netlink/af\_netlink.c:1983
sock\_recvmsg\_nosec net/socket.c:1051 [inline]
sock\_recvmsg+0x22f/0x280 net/socket.c:1073
\_\_sys\_recvfrom+0x246/0x3d0 net/socket.c:2267
\_\_do\_sys\_recvfrom net/socket.c:2285 [inline]
\_\_se\_sys\_recvfrom net/socket.c:2281 [inline]
\_\_x64\_sys\_recvfrom+0xde/0x100 net/socket.c:2281
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7ff37dd17a79
Reported-by: syzbot+d4373fa8042c06cefa84@syzkaller.appspotmail.com
Fixes: 8af4f60472fc ("netlink: support all extack types in dumps")
Reviewed-by: Jacob Keller <jacob.e.keller@intel.com>
Link: [https://patch.msgid.link/20241119224432.1713040-1-kuba@kernel.org](https://patch.msgid.link/20241119224432.1713040-1-kuba%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d)

| -rw-r--r-- | [net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netlink/af_netlink.c?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 10 deletions

| diff --git a/net/netlink/af\_netlink.c b/net/netlink/af\_netlink.cindex f84aad420d4464..775d707ec708a7 100644--- a/[net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netlink/af_netlink.c?id=e54f1237a8018bca25fe58cc3b5a0442051315d1)+++ b/[net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netlink/af_netlink.c?id=6406d0ce0414b807af5d2a4b781c3f3ee52b8a4d)@@ -2176,9 +2176,14 @@ netlink\_ack\_tlv\_len(struct netlink\_sock \*nlk, int err, return tlvlen; } +static bool nlmsg\_check\_in\_payload(const struct nlmsghdr \*nlh, const void \*addr)+{+ return !WARN\_ON(addr < nlmsg\_data(nlh) ||+ addr - (const void \*) nlh >= nlh->nlmsg\_len);+}+ static void-netlink\_ack\_tlv\_fill(struct sk\_buff \*in\_skb, struct sk\_buff \*skb,- const struct nlmsghdr \*nlh, int err,+netlink\_ack\_tlv\_fill(struct sk\_buff \*skb, const struct nlmsghdr \*nlh, int err, const struct netlink\_ext\_ack \*extack) { if (extack->\_msg)@@ -2190,9 +2195,7 @@ netlink\_ack\_tlv\_fill(struct sk\_buff \*in\_skb, struct sk\_buff \*skb, if (!err) return; - if (extack->bad\_attr &&- !WARN\_ON((u8 \*)extack->bad\_attr < in\_skb->data ||- (u8 \*)extack->bad\_attr >= in\_skb->data + in\_skb->len))+ if (extack->bad\_attr && nlmsg\_check\_in\_payload(nlh, extack->bad\_attr)) WARN\_ON(nla\_put\_u32(skb, NLMSGERR\_ATTR\_OFFS, (u8 \*)extack->bad\_attr - (const u8 \*)nlh)); if (extack->policy)@@ -2201,9 +2204,7 @@ netlink\_ack\_tlv\_fill(struct sk\_buff \*in\_skb, struct sk\_buff \*skb, if (extack->miss\_type) WARN\_ON(nla\_put\_u32(skb, NLMSGERR\_ATTR\_MISS\_TYPE, extack->miss\_type));- if (extack->miss\_nest &&- !WARN\_ON((u8 \*)extack->miss\_nest < in\_skb->data ||- (u8 \*)extack->miss\_nest > in\_skb->data + in\_skb->len))+ if (extack->miss\_nest && nlmsg\_check\_in\_payload(nlh, extack->miss\_nest)) WARN\_ON(nla\_put\_u32(skb, NLMSGERR\_ATTR\_MISS\_NEST, (u8 \*)extack->miss\_nest - (const u8 \*)nlh)); }@@ -2232,7 +2233,7 @@ static int netlink\_dump\_done(struct netlink\_sock \*nlk, struct sk\_buff \*skb, if (extack\_len) { nlh->nlmsg\_flags |= NLM\_F\_ACK\_TLVS; if (skb\_tailroom(skb) >= extack\_len) {- netlink\_ack\_tlv\_fill(cb->skb, skb, cb->nlh,+ netlink\_ack\_tlv\_fill(skb, cb->nlh, nlk->dump\_done\_errno, extack); nlmsg\_end(skb, nlh); }@@ -2491,7 +2492,7 @@ void netlink\_ack(struct sk\_buff \*in\_skb, struct nlmsghdr \*nlh, int err, }  if (tlvlen)- netlink\_ack\_tlv\_fill(in\_skb, skb, nlh, err, extack);+ netlink\_ack\_tlv\_fill(skb, nlh, err, extack);  nlmsg\_end(skb, rep); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:52:43 +0000



=== Content from git.kernel.org_07e8aad7_20250114_205404.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=28af028a71371df5fcbf807fd4444bba8d0c33cc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28af028a71371df5fcbf807fd4444bba8d0c33cc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28af028a71371df5fcbf807fd4444bba8d0c33cc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28af028a71371df5fcbf807fd4444bba8d0c33cc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-11-19 14:44:31 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:31 +0100 |
| commit | [28af028a71371df5fcbf807fd4444bba8d0c33cc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28af028a71371df5fcbf807fd4444bba8d0c33cc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=28af028a71371df5fcbf807fd4444bba8d0c33cc)) | |
| tree | [0af3fbfbcf76f344d3b48eafa5c72da47a499d3d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28af028a71371df5fcbf807fd4444bba8d0c33cc) | |
| parent | [36d3af0fab42a4ce2667568d513f0930a0eee238](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36d3af0fab42a4ce2667568d513f0930a0eee238) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28af028a71371df5fcbf807fd4444bba8d0c33cc&id2=36d3af0fab42a4ce2667568d513f0930a0eee238)) | |
| download | [linux-28af028a71371df5fcbf807fd4444bba8d0c33cc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-28af028a71371df5fcbf807fd4444bba8d0c33cc.tar.gz) | |

netlink: fix false positive warning in extack during dumps[ Upstream commit 3bf39fa849ab8ed52abb6715922e6102d3df9f97 ]
Commit under fixes extended extack reporting to dumps.
It works under normal conditions, because extack errors are
usually reported during ->start() or the first ->dump(),
it's quite rare that the dump starts okay but fails later.
If the dump does fail later, however, the input skb will
already have the initiating message pulled, so checking
if bad attr falls within skb->data will fail.
Switch the check to using nlh, which is always valid.
syzbot found a way to hit that scenario by filling up
the receive queue. In this case we initiate a dump
but don't call ->dump() until there is read space for
an skb.
WARNING: CPU: 1 PID: 5845 at net/netlink/af\_netlink.c:2210 netlink\_ack\_tlv\_fill+0x1a8/0x560 net/netlink/af\_netlink.c:2209
RIP: 0010:netlink\_ack\_tlv\_fill+0x1a8/0x560 net/netlink/af\_netlink.c:2209
Call Trace:
<TASK>
netlink\_dump\_done+0x513/0x970 net/netlink/af\_netlink.c:2250
netlink\_dump+0x91f/0xe10 net/netlink/af\_netlink.c:2351
netlink\_recvmsg+0x6bb/0x11d0 net/netlink/af\_netlink.c:1983
sock\_recvmsg\_nosec net/socket.c:1051 [inline]
sock\_recvmsg+0x22f/0x280 net/socket.c:1073
\_\_sys\_recvfrom+0x246/0x3d0 net/socket.c:2267
\_\_do\_sys\_recvfrom net/socket.c:2285 [inline]
\_\_se\_sys\_recvfrom net/socket.c:2281 [inline]
\_\_x64\_sys\_recvfrom+0xde/0x100 net/socket.c:2281
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7ff37dd17a79
Reported-by: syzbot+d4373fa8042c06cefa84@syzkaller.appspotmail.com
Fixes: 8af4f60472fc ("netlink: support all extack types in dumps")
Reviewed-by: Jacob Keller <jacob.e.keller@intel.com>
Link: [https://patch.msgid.link/20241119224432.1713040-1-kuba@kernel.org](https://patch.msgid.link/20241119224432.1713040-1-kuba%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28af028a71371df5fcbf807fd4444bba8d0c33cc)

| -rw-r--r-- | [net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netlink/af_netlink.c?id=28af028a71371df5fcbf807fd4444bba8d0c33cc) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 10 deletions

| diff --git a/net/netlink/af\_netlink.c b/net/netlink/af\_netlink.cindex f84aad420d4464..775d707ec708a7 100644--- a/[net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netlink/af_netlink.c?id=36d3af0fab42a4ce2667568d513f0930a0eee238)+++ b/[net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netlink/af_netlink.c?id=28af028a71371df5fcbf807fd4444bba8d0c33cc)@@ -2176,9 +2176,14 @@ netlink\_ack\_tlv\_len(struct netlink\_sock \*nlk, int err, return tlvlen; } +static bool nlmsg\_check\_in\_payload(const struct nlmsghdr \*nlh, const void \*addr)+{+ return !WARN\_ON(addr < nlmsg\_data(nlh) ||+ addr - (const void \*) nlh >= nlh->nlmsg\_len);+}+ static void-netlink\_ack\_tlv\_fill(struct sk\_buff \*in\_skb, struct sk\_buff \*skb,- const struct nlmsghdr \*nlh, int err,+netlink\_ack\_tlv\_fill(struct sk\_buff \*skb, const struct nlmsghdr \*nlh, int err, const struct netlink\_ext\_ack \*extack) { if (extack->\_msg)@@ -2190,9 +2195,7 @@ netlink\_ack\_tlv\_fill(struct sk\_buff \*in\_skb, struct sk\_buff \*skb, if (!err) return; - if (extack->bad\_attr &&- !WARN\_ON((u8 \*)extack->bad\_attr < in\_skb->data ||- (u8 \*)extack->bad\_attr >= in\_skb->data + in\_skb->len))+ if (extack->bad\_attr && nlmsg\_check\_in\_payload(nlh, extack->bad\_attr)) WARN\_ON(nla\_put\_u32(skb, NLMSGERR\_ATTR\_OFFS, (u8 \*)extack->bad\_attr - (const u8 \*)nlh)); if (extack->policy)@@ -2201,9 +2204,7 @@ netlink\_ack\_tlv\_fill(struct sk\_buff \*in\_skb, struct sk\_buff \*skb, if (extack->miss\_type) WARN\_ON(nla\_put\_u32(skb, NLMSGERR\_ATTR\_MISS\_TYPE, extack->miss\_type));- if (extack->miss\_nest &&- !WARN\_ON((u8 \*)extack->miss\_nest < in\_skb->data ||- (u8 \*)extack->miss\_nest > in\_skb->data + in\_skb->len))+ if (extack->miss\_nest && nlmsg\_check\_in\_payload(nlh, extack->miss\_nest)) WARN\_ON(nla\_put\_u32(skb, NLMSGERR\_ATTR\_MISS\_NEST, (u8 \*)extack->miss\_nest - (const u8 \*)nlh)); }@@ -2232,7 +2233,7 @@ static int netlink\_dump\_done(struct netlink\_sock \*nlk, struct sk\_buff \*skb, if (extack\_len) { nlh->nlmsg\_flags |= NLM\_F\_ACK\_TLVS; if (skb\_tailroom(skb) >= extack\_len) {- netlink\_ack\_tlv\_fill(cb->skb, skb, cb->nlh,+ netlink\_ack\_tlv\_fill(skb, cb->nlh, nlk->dump\_done\_errno, extack); nlmsg\_end(skb, nlh); }@@ -2491,7 +2492,7 @@ void netlink\_ack(struct sk\_buff \*in\_skb, struct nlmsghdr \*nlh, int err, }  if (tlvlen)- netlink\_ack\_tlv\_fill(in\_skb, skb, nlh, err, extack);+ netlink\_ack\_tlv\_fill(skb, nlh, err, extack);  nlmsg\_end(skb, rep); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:52:41 +0000


