=== Content from git.kernel.org_2c45a9eb_20250114_185946.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Uladzislau Rezki (Sony) <urezki@gmail.com> | 2024-10-22 12:53:07 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:52:52 +0100 |
| commit | [05b8ea1f16667f07c8e5843fb4bde3e49d49ead8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8)) | |
| tree | [eb4649cab375e4c3386666eabeb4e7d5f7c97df3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8) | |
| parent | [bd69a2cb7fa0af29084e55bc2be7d4d5420a4a40](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd69a2cb7fa0af29084e55bc2be7d4d5420a4a40) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8&id2=bd69a2cb7fa0af29084e55bc2be7d4d5420a4a40)) | |
| download | [linux-05b8ea1f16667f07c8e5843fb4bde3e49d49ead8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-05b8ea1f16667f07c8e5843fb4bde3e49d49ead8.tar.gz) | |

rcu/kvfree: Fix data-race in \_\_mod\_timer / kvfree\_call\_rcu[ Upstream commit a23da88c6c80e41e0503e0b481a22c9eea63f263 ]
KCSAN reports a data race when access the krcp->monitor\_work.timer.expires
variable in the schedule\_delayed\_monitor\_work() function:
<snip>
BUG: KCSAN: data-race in \_\_mod\_timer / kvfree\_call\_rcu
read to 0xffff888237d1cce8 of 8 bytes by task 10149 on cpu 1:
schedule\_delayed\_monitor\_work kernel/rcu/tree.c:3520 [inline]
kvfree\_call\_rcu+0x3b8/0x510 kernel/rcu/tree.c:3839
trie\_update\_elem+0x47c/0x620 kernel/bpf/lpm\_trie.c:441
bpf\_map\_update\_value+0x324/0x350 kernel/bpf/syscall.c:203
generic\_map\_update\_batch+0x401/0x520 kernel/bpf/syscall.c:1849
bpf\_map\_do\_batch+0x28c/0x3f0 kernel/bpf/syscall.c:5143
\_\_sys\_bpf+0x2e5/0x7a0
\_\_do\_sys\_bpf kernel/bpf/syscall.c:5741 [inline]
\_\_se\_sys\_bpf kernel/bpf/syscall.c:5739 [inline]
\_\_x64\_sys\_bpf+0x43/0x50 kernel/bpf/syscall.c:5739
x64\_sys\_call+0x2625/0x2d60 arch/x86/include/generated/asm/syscalls\_64.h:322
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xc9/0x1c0 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
write to 0xffff888237d1cce8 of 8 bytes by task 56 on cpu 0:
\_\_mod\_timer+0x578/0x7f0 kernel/time/timer.c:1173
add\_timer\_global+0x51/0x70 kernel/time/timer.c:1330
\_\_queue\_delayed\_work+0x127/0x1a0 kernel/workqueue.c:2523
queue\_delayed\_work\_on+0xdf/0x190 kernel/workqueue.c:2552
queue\_delayed\_work include/linux/workqueue.h:677 [inline]
schedule\_delayed\_monitor\_work kernel/rcu/tree.c:3525 [inline]
kfree\_rcu\_monitor+0x5e8/0x660 kernel/rcu/tree.c:3643
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0x483/0x9a0 kernel/workqueue.c:3310
worker\_thread+0x51d/0x6f0 kernel/workqueue.c:3391
kthread+0x1d1/0x210 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 UID: 0 PID: 56 Comm: kworker/u8:4 Not tainted 6.12.0-rc2-syzkaller-00050-g5b7c893ed5ed #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024
Workqueue: events\_unbound kfree\_rcu\_monitor
<snip>
kfree\_rcu\_monitor() rearms the work if a "krcp" has to be still
offloaded and this is done without holding krcp->lock, whereas
the kvfree\_call\_rcu() holds it.
Fix it by acquiring the "krcp->lock" for kfree\_rcu\_monitor() so
both functions do not race anymore.
Reported-by: syzbot+061d370693bdd99f9d34@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/lkml/ZxZ68KmHDQYU0yfD@pc636/T/](https://lore.kernel.org/lkml/ZxZ68KmHDQYU0yfD%40pc636/T/)
Fixes: 8fc5494ad5fa ("rcu/kvfree: Move need\_offload\_krc() out of krcp->lock")
Signed-off-by: Uladzislau Rezki (Sony) <urezki@gmail.com>
Reviewed-by: Neeraj Upadhyay <Neeraj.Upadhyay@amd.com>
Signed-off-by: Frederic Weisbecker <frederic@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8)

| -rw-r--r-- | [kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/rcu/tree.c?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 2 deletions

| diff --git a/kernel/rcu/tree.c b/kernel/rcu/tree.cindex 8af1354b223194..34f47c5b98216c 100644--- a/[kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/rcu/tree.c?id=bd69a2cb7fa0af29084e55bc2be7d4d5420a4a40)+++ b/[kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/rcu/tree.c?id=05b8ea1f16667f07c8e5843fb4bde3e49d49ead8)@@ -3531,7 +3531,7 @@ static int krc\_count(struct kfree\_rcu\_cpu \*krcp) }  static void-schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp)+\_\_schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp) { long delay, delay\_left; @@ -3546,6 +3546,16 @@ schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp) }  static void+schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp)+{+ unsigned long flags;++ raw\_spin\_lock\_irqsave(&krcp->lock, flags);+ \_\_schedule\_delayed\_monitor\_work(krcp);+ raw\_spin\_unlock\_irqrestore(&krcp->lock, flags);+}++static void kvfree\_rcu\_drain\_ready(struct kfree\_rcu\_cpu \*krcp) { struct list\_head bulk\_ready[FREE\_N\_CHANNELS];@@ -3855,7 +3865,7 @@ void kvfree\_call\_rcu(struct rcu\_head \*head, void \*ptr)  // Set timer to drain after KFREE\_DRAIN\_JIFFIES. if (rcu\_scheduler\_active == RCU\_SCHEDULER\_RUNNING)- schedule\_delayed\_monitor\_work(krcp);+ \_\_schedule\_delayed\_monitor\_work(krcp);  unlock\_return: krc\_this\_cpu\_unlock(krcp, flags); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:58:23 +0000



=== Content from git.kernel.org_40a61a19_20250114_185948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a23da88c6c80e41e0503e0b481a22c9eea63f263)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a23da88c6c80e41e0503e0b481a22c9eea63f263)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a23da88c6c80e41e0503e0b481a22c9eea63f263)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a23da88c6c80e41e0503e0b481a22c9eea63f263)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Uladzislau Rezki (Sony) <urezki@gmail.com> | 2024-10-22 12:53:07 +0200 |
| --- | --- | --- |
| committer | Frederic Weisbecker <frederic@kernel.org> | 2024-11-12 21:51:34 +0100 |
| commit | [a23da88c6c80e41e0503e0b481a22c9eea63f263](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a23da88c6c80e41e0503e0b481a22c9eea63f263) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a23da88c6c80e41e0503e0b481a22c9eea63f263)) | |
| tree | [5ea7d574f7d60778179cd78c0c857952b4cc11a5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a23da88c6c80e41e0503e0b481a22c9eea63f263) | |
| parent | [0ea3acbc804c2d5a165442cdf9c0526f4d324888](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ea3acbc804c2d5a165442cdf9c0526f4d324888) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a23da88c6c80e41e0503e0b481a22c9eea63f263&id2=0ea3acbc804c2d5a165442cdf9c0526f4d324888)) | |
| download | [linux-a23da88c6c80e41e0503e0b481a22c9eea63f263.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a23da88c6c80e41e0503e0b481a22c9eea63f263.tar.gz) | |

rcu/kvfree: Fix data-race in \_\_mod\_timer / kvfree\_call\_rcuKCSAN reports a data race when access the krcp->monitor\_work.timer.expires
variable in the schedule\_delayed\_monitor\_work() function:
<snip>
BUG: KCSAN: data-race in \_\_mod\_timer / kvfree\_call\_rcu
read to 0xffff888237d1cce8 of 8 bytes by task 10149 on cpu 1:
schedule\_delayed\_monitor\_work kernel/rcu/tree.c:3520 [inline]
kvfree\_call\_rcu+0x3b8/0x510 kernel/rcu/tree.c:3839
trie\_update\_elem+0x47c/0x620 kernel/bpf/lpm\_trie.c:441
bpf\_map\_update\_value+0x324/0x350 kernel/bpf/syscall.c:203
generic\_map\_update\_batch+0x401/0x520 kernel/bpf/syscall.c:1849
bpf\_map\_do\_batch+0x28c/0x3f0 kernel/bpf/syscall.c:5143
\_\_sys\_bpf+0x2e5/0x7a0
\_\_do\_sys\_bpf kernel/bpf/syscall.c:5741 [inline]
\_\_se\_sys\_bpf kernel/bpf/syscall.c:5739 [inline]
\_\_x64\_sys\_bpf+0x43/0x50 kernel/bpf/syscall.c:5739
x64\_sys\_call+0x2625/0x2d60 arch/x86/include/generated/asm/syscalls\_64.h:322
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xc9/0x1c0 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
write to 0xffff888237d1cce8 of 8 bytes by task 56 on cpu 0:
\_\_mod\_timer+0x578/0x7f0 kernel/time/timer.c:1173
add\_timer\_global+0x51/0x70 kernel/time/timer.c:1330
\_\_queue\_delayed\_work+0x127/0x1a0 kernel/workqueue.c:2523
queue\_delayed\_work\_on+0xdf/0x190 kernel/workqueue.c:2552
queue\_delayed\_work include/linux/workqueue.h:677 [inline]
schedule\_delayed\_monitor\_work kernel/rcu/tree.c:3525 [inline]
kfree\_rcu\_monitor+0x5e8/0x660 kernel/rcu/tree.c:3643
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0x483/0x9a0 kernel/workqueue.c:3310
worker\_thread+0x51d/0x6f0 kernel/workqueue.c:3391
kthread+0x1d1/0x210 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 UID: 0 PID: 56 Comm: kworker/u8:4 Not tainted 6.12.0-rc2-syzkaller-00050-g5b7c893ed5ed #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024
Workqueue: events\_unbound kfree\_rcu\_monitor
<snip>
kfree\_rcu\_monitor() rearms the work if a "krcp" has to be still
offloaded and this is done without holding krcp->lock, whereas
the kvfree\_call\_rcu() holds it.
Fix it by acquiring the "krcp->lock" for kfree\_rcu\_monitor() so
both functions do not race anymore.
Reported-by: syzbot+061d370693bdd99f9d34@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/lkml/ZxZ68KmHDQYU0yfD@pc636/T/](https://lore.kernel.org/lkml/ZxZ68KmHDQYU0yfD%40pc636/T/)
Fixes: 8fc5494ad5fa ("rcu/kvfree: Move need\_offload\_krc() out of krcp->lock")
Signed-off-by: Uladzislau Rezki (Sony) <urezki@gmail.com>
Reviewed-by: Neeraj Upadhyay <Neeraj.Upadhyay@amd.com>
Signed-off-by: Frederic Weisbecker <frederic@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a23da88c6c80e41e0503e0b481a22c9eea63f263)

| -rw-r--r-- | [kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/rcu/tree.c?id=a23da88c6c80e41e0503e0b481a22c9eea63f263) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 2 deletions

| diff --git a/kernel/rcu/tree.c b/kernel/rcu/tree.cindex 13829cf38f526c..ff98233d4aa59f 100644--- a/[kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/rcu/tree.c?id=0ea3acbc804c2d5a165442cdf9c0526f4d324888)+++ b/[kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/rcu/tree.c?id=a23da88c6c80e41e0503e0b481a22c9eea63f263)@@ -3511,7 +3511,7 @@ static int krc\_count(struct kfree\_rcu\_cpu \*krcp) }  static void-schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp)+\_\_schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp) { long delay, delay\_left; @@ -3526,6 +3526,16 @@ schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp) }  static void+schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp)+{+ unsigned long flags;++ raw\_spin\_lock\_irqsave(&krcp->lock, flags);+ \_\_schedule\_delayed\_monitor\_work(krcp);+ raw\_spin\_unlock\_irqrestore(&krcp->lock, flags);+}++static void kvfree\_rcu\_drain\_ready(struct kfree\_rcu\_cpu \*krcp) { struct list\_head bulk\_ready[FREE\_N\_CHANNELS];@@ -3836,7 +3846,7 @@ void kvfree\_call\_rcu(struct rcu\_head \*head, void \*ptr)  // Set timer to drain after KFREE\_DRAIN\_JIFFIES. if (rcu\_scheduler\_active == RCU\_SCHEDULER\_RUNNING)- schedule\_delayed\_monitor\_work(krcp);+ \_\_schedule\_delayed\_monitor\_work(krcp);  unlock\_return: krc\_this\_cpu\_unlock(krcp, flags); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:58:25 +0000



=== Content from git.kernel.org_7857d2fe_20250114_185947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Uladzislau Rezki (Sony) <urezki@gmail.com> | 2024-10-22 12:53:07 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:19 +0100 |
| commit | [5ced426d97ce84299ecfcc7bd8b38f975fd11089](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089)) | |
| tree | [f6564681dcca7a8ae864ea7f0af3b1a7f14f8edb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089) | |
| parent | [fc5e1ad3bba522ed1d4bb3724be5f506105ce8cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc5e1ad3bba522ed1d4bb3724be5f506105ce8cb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089&id2=fc5e1ad3bba522ed1d4bb3724be5f506105ce8cb)) | |
| download | [linux-5ced426d97ce84299ecfcc7bd8b38f975fd11089.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5ced426d97ce84299ecfcc7bd8b38f975fd11089.tar.gz) | |

rcu/kvfree: Fix data-race in \_\_mod\_timer / kvfree\_call\_rcu[ Upstream commit a23da88c6c80e41e0503e0b481a22c9eea63f263 ]
KCSAN reports a data race when access the krcp->monitor\_work.timer.expires
variable in the schedule\_delayed\_monitor\_work() function:
<snip>
BUG: KCSAN: data-race in \_\_mod\_timer / kvfree\_call\_rcu
read to 0xffff888237d1cce8 of 8 bytes by task 10149 on cpu 1:
schedule\_delayed\_monitor\_work kernel/rcu/tree.c:3520 [inline]
kvfree\_call\_rcu+0x3b8/0x510 kernel/rcu/tree.c:3839
trie\_update\_elem+0x47c/0x620 kernel/bpf/lpm\_trie.c:441
bpf\_map\_update\_value+0x324/0x350 kernel/bpf/syscall.c:203
generic\_map\_update\_batch+0x401/0x520 kernel/bpf/syscall.c:1849
bpf\_map\_do\_batch+0x28c/0x3f0 kernel/bpf/syscall.c:5143
\_\_sys\_bpf+0x2e5/0x7a0
\_\_do\_sys\_bpf kernel/bpf/syscall.c:5741 [inline]
\_\_se\_sys\_bpf kernel/bpf/syscall.c:5739 [inline]
\_\_x64\_sys\_bpf+0x43/0x50 kernel/bpf/syscall.c:5739
x64\_sys\_call+0x2625/0x2d60 arch/x86/include/generated/asm/syscalls\_64.h:322
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xc9/0x1c0 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
write to 0xffff888237d1cce8 of 8 bytes by task 56 on cpu 0:
\_\_mod\_timer+0x578/0x7f0 kernel/time/timer.c:1173
add\_timer\_global+0x51/0x70 kernel/time/timer.c:1330
\_\_queue\_delayed\_work+0x127/0x1a0 kernel/workqueue.c:2523
queue\_delayed\_work\_on+0xdf/0x190 kernel/workqueue.c:2552
queue\_delayed\_work include/linux/workqueue.h:677 [inline]
schedule\_delayed\_monitor\_work kernel/rcu/tree.c:3525 [inline]
kfree\_rcu\_monitor+0x5e8/0x660 kernel/rcu/tree.c:3643
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0x483/0x9a0 kernel/workqueue.c:3310
worker\_thread+0x51d/0x6f0 kernel/workqueue.c:3391
kthread+0x1d1/0x210 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 UID: 0 PID: 56 Comm: kworker/u8:4 Not tainted 6.12.0-rc2-syzkaller-00050-g5b7c893ed5ed #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024
Workqueue: events\_unbound kfree\_rcu\_monitor
<snip>
kfree\_rcu\_monitor() rearms the work if a "krcp" has to be still
offloaded and this is done without holding krcp->lock, whereas
the kvfree\_call\_rcu() holds it.
Fix it by acquiring the "krcp->lock" for kfree\_rcu\_monitor() so
both functions do not race anymore.
Reported-by: syzbot+061d370693bdd99f9d34@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/lkml/ZxZ68KmHDQYU0yfD@pc636/T/](https://lore.kernel.org/lkml/ZxZ68KmHDQYU0yfD%40pc636/T/)
Fixes: 8fc5494ad5fa ("rcu/kvfree: Move need\_offload\_krc() out of krcp->lock")
Signed-off-by: Uladzislau Rezki (Sony) <urezki@gmail.com>
Reviewed-by: Neeraj Upadhyay <Neeraj.Upadhyay@amd.com>
Signed-off-by: Frederic Weisbecker <frederic@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089)

| -rw-r--r-- | [kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/rcu/tree.c?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 2 deletions

| diff --git a/kernel/rcu/tree.c b/kernel/rcu/tree.cindex b1f883fcd9185a..3e486ccaa4ca34 100644--- a/[kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/rcu/tree.c?id=fc5e1ad3bba522ed1d4bb3724be5f506105ce8cb)+++ b/[kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/rcu/tree.c?id=5ced426d97ce84299ecfcc7bd8b38f975fd11089)@@ -3511,7 +3511,7 @@ static int krc\_count(struct kfree\_rcu\_cpu \*krcp) }  static void-schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp)+\_\_schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp) { long delay, delay\_left; @@ -3526,6 +3526,16 @@ schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp) }  static void+schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp)+{+ unsigned long flags;++ raw\_spin\_lock\_irqsave(&krcp->lock, flags);+ \_\_schedule\_delayed\_monitor\_work(krcp);+ raw\_spin\_unlock\_irqrestore(&krcp->lock, flags);+}++static void kvfree\_rcu\_drain\_ready(struct kfree\_rcu\_cpu \*krcp) { struct list\_head bulk\_ready[FREE\_N\_CHANNELS];@@ -3836,7 +3846,7 @@ void kvfree\_call\_rcu(struct rcu\_head \*head, void \*ptr)  // Set timer to drain after KFREE\_DRAIN\_JIFFIES. if (rcu\_scheduler\_active == RCU\_SCHEDULER\_RUNNING)- schedule\_delayed\_monitor\_work(krcp);+ \_\_schedule\_delayed\_monitor\_work(krcp);  unlock\_return: krc\_this\_cpu\_unlock(krcp, flags); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:58:24 +0000



=== Content from git.kernel.org_51afc6b4_20250114_185947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=967a0e61910825d1fad009d836a6cb41f7402395)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=967a0e61910825d1fad009d836a6cb41f7402395)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=967a0e61910825d1fad009d836a6cb41f7402395)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=967a0e61910825d1fad009d836a6cb41f7402395)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Uladzislau Rezki (Sony) <urezki@gmail.com> | 2024-10-22 12:53:07 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:31:49 +0100 |
| commit | [967a0e61910825d1fad009d836a6cb41f7402395](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=967a0e61910825d1fad009d836a6cb41f7402395) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=967a0e61910825d1fad009d836a6cb41f7402395)) | |
| tree | [e1527e6b88104f381795c680805a95f659275b5c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=967a0e61910825d1fad009d836a6cb41f7402395) | |
| parent | [f5fed8a850d08136f424ac378279162508dde4e0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5fed8a850d08136f424ac378279162508dde4e0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=967a0e61910825d1fad009d836a6cb41f7402395&id2=f5fed8a850d08136f424ac378279162508dde4e0)) | |
| download | [linux-967a0e61910825d1fad009d836a6cb41f7402395.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-967a0e61910825d1fad009d836a6cb41f7402395.tar.gz) | |

rcu/kvfree: Fix data-race in \_\_mod\_timer / kvfree\_call\_rcu[ Upstream commit a23da88c6c80e41e0503e0b481a22c9eea63f263 ]
KCSAN reports a data race when access the krcp->monitor\_work.timer.expires
variable in the schedule\_delayed\_monitor\_work() function:
<snip>
BUG: KCSAN: data-race in \_\_mod\_timer / kvfree\_call\_rcu
read to 0xffff888237d1cce8 of 8 bytes by task 10149 on cpu 1:
schedule\_delayed\_monitor\_work kernel/rcu/tree.c:3520 [inline]
kvfree\_call\_rcu+0x3b8/0x510 kernel/rcu/tree.c:3839
trie\_update\_elem+0x47c/0x620 kernel/bpf/lpm\_trie.c:441
bpf\_map\_update\_value+0x324/0x350 kernel/bpf/syscall.c:203
generic\_map\_update\_batch+0x401/0x520 kernel/bpf/syscall.c:1849
bpf\_map\_do\_batch+0x28c/0x3f0 kernel/bpf/syscall.c:5143
\_\_sys\_bpf+0x2e5/0x7a0
\_\_do\_sys\_bpf kernel/bpf/syscall.c:5741 [inline]
\_\_se\_sys\_bpf kernel/bpf/syscall.c:5739 [inline]
\_\_x64\_sys\_bpf+0x43/0x50 kernel/bpf/syscall.c:5739
x64\_sys\_call+0x2625/0x2d60 arch/x86/include/generated/asm/syscalls\_64.h:322
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xc9/0x1c0 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
write to 0xffff888237d1cce8 of 8 bytes by task 56 on cpu 0:
\_\_mod\_timer+0x578/0x7f0 kernel/time/timer.c:1173
add\_timer\_global+0x51/0x70 kernel/time/timer.c:1330
\_\_queue\_delayed\_work+0x127/0x1a0 kernel/workqueue.c:2523
queue\_delayed\_work\_on+0xdf/0x190 kernel/workqueue.c:2552
queue\_delayed\_work include/linux/workqueue.h:677 [inline]
schedule\_delayed\_monitor\_work kernel/rcu/tree.c:3525 [inline]
kfree\_rcu\_monitor+0x5e8/0x660 kernel/rcu/tree.c:3643
process\_one\_work kernel/workqueue.c:3229 [inline]
process\_scheduled\_works+0x483/0x9a0 kernel/workqueue.c:3310
worker\_thread+0x51d/0x6f0 kernel/workqueue.c:3391
kthread+0x1d1/0x210 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 UID: 0 PID: 56 Comm: kworker/u8:4 Not tainted 6.12.0-rc2-syzkaller-00050-g5b7c893ed5ed #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024
Workqueue: events\_unbound kfree\_rcu\_monitor
<snip>
kfree\_rcu\_monitor() rearms the work if a "krcp" has to be still
offloaded and this is done without holding krcp->lock, whereas
the kvfree\_call\_rcu() holds it.
Fix it by acquiring the "krcp->lock" for kfree\_rcu\_monitor() so
both functions do not race anymore.
Reported-by: syzbot+061d370693bdd99f9d34@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/lkml/ZxZ68KmHDQYU0yfD@pc636/T/](https://lore.kernel.org/lkml/ZxZ68KmHDQYU0yfD%40pc636/T/)
Fixes: 8fc5494ad5fa ("rcu/kvfree: Move need\_offload\_krc() out of krcp->lock")
Signed-off-by: Uladzislau Rezki (Sony) <urezki@gmail.com>
Reviewed-by: Neeraj Upadhyay <Neeraj.Upadhyay@amd.com>
Signed-off-by: Frederic Weisbecker <frederic@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=967a0e61910825d1fad009d836a6cb41f7402395)

| -rw-r--r-- | [kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/rcu/tree.c?id=967a0e61910825d1fad009d836a6cb41f7402395) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 2 deletions

| diff --git a/kernel/rcu/tree.c b/kernel/rcu/tree.cindex 3d7b119f6e2a36..fda08520c75c58 100644--- a/[kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/rcu/tree.c?id=f5fed8a850d08136f424ac378279162508dde4e0)+++ b/[kernel/rcu/tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/rcu/tree.c?id=967a0e61910825d1fad009d836a6cb41f7402395)@@ -3150,7 +3150,7 @@ static int krc\_count(struct kfree\_rcu\_cpu \*krcp) }  static void-schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp)+\_\_schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp) { long delay, delay\_left; @@ -3165,6 +3165,16 @@ schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp) }  static void+schedule\_delayed\_monitor\_work(struct kfree\_rcu\_cpu \*krcp)+{+ unsigned long flags;++ raw\_spin\_lock\_irqsave(&krcp->lock, flags);+ \_\_schedule\_delayed\_monitor\_work(krcp);+ raw\_spin\_unlock\_irqrestore(&krcp->lock, flags);+}++static void kvfree\_rcu\_drain\_ready(struct kfree\_rcu\_cpu \*krcp) { struct list\_head bulk\_ready[FREE\_N\_CHANNELS];@@ -3460,7 +3470,7 @@ void kvfree\_call\_rcu(struct rcu\_head \*head, void \*ptr)  // Set timer to drain after KFREE\_DRAIN\_JIFFIES. if (rcu\_scheduler\_active == RCU\_SCHEDULER\_RUNNING)- schedule\_delayed\_monitor\_work(krcp);+ \_\_schedule\_delayed\_monitor\_work(krcp);  unlock\_return: krc\_this\_cpu\_unlock(krcp, flags); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:58:24 +0000


