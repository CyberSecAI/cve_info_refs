=== Content from git.kernel.org_e7c2c42e_20250114_190745.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e9869c85c81168a1275f909d5972a3fc435304be)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e9869c85c81168a1275f909d5972a3fc435304be)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e9869c85c81168a1275f909d5972a3fc435304be)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e9869c85c81168a1275f909d5972a3fc435304be)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nilay Shroff <nilay@linux.ibm.com> | 2024-11-05 11:42:09 +0530 |
| --- | --- | --- |
| committer | Keith Busch <kbusch@kernel.org> | 2024-11-19 07:49:48 -0800 |
| commit | [e9869c85c81168a1275f909d5972a3fc435304be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e9869c85c81168a1275f909d5972a3fc435304be) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e9869c85c81168a1275f909d5972a3fc435304be)) | |
| tree | [c95d4976fdfce7b207d5cee1977dc5fdc36f107c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e9869c85c81168a1275f909d5972a3fc435304be) | |
| parent | [84488282166de6b6760ada8030e87aaa08bce3aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84488282166de6b6760ada8030e87aaa08bce3aa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e9869c85c81168a1275f909d5972a3fc435304be&id2=84488282166de6b6760ada8030e87aaa08bce3aa)) | |
| download | [linux-e9869c85c81168a1275f909d5972a3fc435304be.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e9869c85c81168a1275f909d5972a3fc435304be.tar.gz) | |

nvme-fabrics: fix kernel crash while shutting down controllerThe nvme keep-alive operation, which executes at a periodic interval,
could potentially sneak in while shutting down a fabric controller.
This may lead to a race between the fabric controller admin queue
destroy code path (invoked while shutting down controller) and hw/hctx
queue dispatcher called from the nvme keep-alive async request queuing
operation. This race could lead to the kernel crash shown below:
Call Trace:
autoremove\_wake\_function+0x0/0xbc (unreliable)
\_\_blk\_mq\_sched\_dispatch\_requests+0x114/0x24c
blk\_mq\_sched\_dispatch\_requests+0x44/0x84
blk\_mq\_run\_hw\_queue+0x140/0x220
nvme\_keep\_alive\_work+0xc8/0x19c [nvme\_core]
process\_one\_work+0x200/0x4e0
worker\_thread+0x340/0x504
kthread+0x138/0x140
start\_kernel\_thread+0x14/0x18
While shutting down fabric controller, if nvme keep-alive request sneaks
in then it would be flushed off. The nvme\_keep\_alive\_end\_io function is
then invoked to handle the end of the keep-alive operation which
decrements the admin->q\_usage\_counter and assuming this is the last/only
request in the admin queue then the admin->q\_usage\_counter becomes zero.
If that happens then blk-mq destroy queue operation (blk\_mq\_destroy\_
queue()) which could be potentially running simultaneously on another
cpu (as this is the controller shutdown code path) would forward
progress and deletes the admin queue. So, now from this point onward
we are not supposed to access the admin queue resources. However the
issue here's that the nvme keep-alive thread running hw/hctx queue
dispatch operation hasn't yet finished its work and so it could still
potentially access the admin queue resource while the admin queue had
been already deleted and that causes the above crash.
The above kernel crash is regression caused due to changes implemented
in commit a54a93d0e359 ("nvme: move stopping keep-alive into
nvme\_uninit\_ctrl()"). Ideally we should stop keep-alive before destroyin
g the admin queue and freeing the admin tagset so that it wouldn't sneak
in during the shutdown operation. However we removed the keep alive stop
operation from the beginning of the controller shutdown code path in commit
a54a93d0e359 ("nvme: move stopping keep-alive into nvme\_uninit\_ctrl()")
and added it under nvme\_uninit\_ctrl() which executes very late in the
shutdown code path after the admin queue is destroyed and its tagset is
removed. So this change created the possibility of keep-alive sneaking in
and interfering with the shutdown operation and causing observed kernel
crash.
To fix the observed crash, we decided to move nvme\_stop\_keep\_alive() from
nvme\_uninit\_ctrl() to nvme\_remove\_admin\_tag\_set(). This change would ensure
that we don't forward progress and delete the admin queue until the keep-
alive operation is finished (if it's in-flight) or cancelled and that would
help contain the race condition explained above and hence avoid the crash.
Moving nvme\_stop\_keep\_alive() to nvme\_remove\_admin\_tag\_set() instead of
adding nvme\_stop\_keep\_alive() to the beginning of the controller shutdown
code path in nvme\_stop\_ctrl(), as was the case earlier before commit
a54a93d0e359 ("nvme: move stopping keep-alive into nvme\_uninit\_ctrl()"),
would help save one callsite of nvme\_stop\_keep\_alive().
Fixes: a54a93d0e359 ("nvme: move stopping keep-alive into nvme\_uninit\_ctrl()")
Link: [https://lore.kernel.org/all/1a21f37b-0f2a-4745-8c56-4dc8628d3983@linux.ibm.com/](https://lore.kernel.org/all/1a21f37b-0f2a-4745-8c56-4dc8628d3983%40linux.ibm.com/)
Reviewed-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Nilay Shroff <nilay@linux.ibm.com>
Signed-off-by: Keith Busch <kbusch@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e9869c85c81168a1275f909d5972a3fc435304be)

| -rw-r--r-- | [drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/core.c?id=e9869c85c81168a1275f909d5972a3fc435304be) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/nvme/host/core.c b/drivers/nvme/host/core.cindex 1221ebe399d765..bfd71511c85f8b 100644--- a/[drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/core.c?id=84488282166de6b6760ada8030e87aaa08bce3aa)+++ b/[drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/core.c?id=e9869c85c81168a1275f909d5972a3fc435304be)@@ -4574,6 +4574,11 @@ EXPORT\_SYMBOL\_GPL(nvme\_alloc\_admin\_tag\_set);  void nvme\_remove\_admin\_tag\_set(struct nvme\_ctrl \*ctrl) {+ /\*+ \* As we're about to destroy the queue and free tagset+ \* we can not have keep-alive work running.+ \*/+ nvme\_stop\_keep\_alive(ctrl); blk\_mq\_destroy\_queue(ctrl->admin\_q); blk\_put\_queue(ctrl->admin\_q); if (ctrl->ops->flags & NVME\_F\_FABRICS) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:22 +0000



=== Content from git.kernel.org_5a880f82_20250114_190745.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5416b76a8156c1b8491f78f8a728f422104bb919)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5416b76a8156c1b8491f78f8a728f422104bb919)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5416b76a8156c1b8491f78f8a728f422104bb919)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5416b76a8156c1b8491f78f8a728f422104bb919)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nilay Shroff <nilay@linux.ibm.com> | 2024-11-05 11:42:09 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:03:06 +0100 |
| commit | [5416b76a8156c1b8491f78f8a728f422104bb919](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5416b76a8156c1b8491f78f8a728f422104bb919) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5416b76a8156c1b8491f78f8a728f422104bb919)) | |
| tree | [2bf0cb8db468011583eddf9e9dd5f860d6b48e65](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5416b76a8156c1b8491f78f8a728f422104bb919) | |
| parent | [5e15cc7a1d9335cc2e8b99ecffd975e22666c407](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e15cc7a1d9335cc2e8b99ecffd975e22666c407) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5416b76a8156c1b8491f78f8a728f422104bb919&id2=5e15cc7a1d9335cc2e8b99ecffd975e22666c407)) | |
| download | [linux-5416b76a8156c1b8491f78f8a728f422104bb919.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5416b76a8156c1b8491f78f8a728f422104bb919.tar.gz) | |

nvme-fabrics: fix kernel crash while shutting down controller[ Upstream commit e9869c85c81168a1275f909d5972a3fc435304be ]
The nvme keep-alive operation, which executes at a periodic interval,
could potentially sneak in while shutting down a fabric controller.
This may lead to a race between the fabric controller admin queue
destroy code path (invoked while shutting down controller) and hw/hctx
queue dispatcher called from the nvme keep-alive async request queuing
operation. This race could lead to the kernel crash shown below:
Call Trace:
autoremove\_wake\_function+0x0/0xbc (unreliable)
\_\_blk\_mq\_sched\_dispatch\_requests+0x114/0x24c
blk\_mq\_sched\_dispatch\_requests+0x44/0x84
blk\_mq\_run\_hw\_queue+0x140/0x220
nvme\_keep\_alive\_work+0xc8/0x19c [nvme\_core]
process\_one\_work+0x200/0x4e0
worker\_thread+0x340/0x504
kthread+0x138/0x140
start\_kernel\_thread+0x14/0x18
While shutting down fabric controller, if nvme keep-alive request sneaks
in then it would be flushed off. The nvme\_keep\_alive\_end\_io function is
then invoked to handle the end of the keep-alive operation which
decrements the admin->q\_usage\_counter and assuming this is the last/only
request in the admin queue then the admin->q\_usage\_counter becomes zero.
If that happens then blk-mq destroy queue operation (blk\_mq\_destroy\_
queue()) which could be potentially running simultaneously on another
cpu (as this is the controller shutdown code path) would forward
progress and deletes the admin queue. So, now from this point onward
we are not supposed to access the admin queue resources. However the
issue here's that the nvme keep-alive thread running hw/hctx queue
dispatch operation hasn't yet finished its work and so it could still
potentially access the admin queue resource while the admin queue had
been already deleted and that causes the above crash.
The above kernel crash is regression caused due to changes implemented
in commit a54a93d0e359 ("nvme: move stopping keep-alive into
nvme\_uninit\_ctrl()"). Ideally we should stop keep-alive before destroyin
g the admin queue and freeing the admin tagset so that it wouldn't sneak
in during the shutdown operation. However we removed the keep alive stop
operation from the beginning of the controller shutdown code path in commit
a54a93d0e359 ("nvme: move stopping keep-alive into nvme\_uninit\_ctrl()")
and added it under nvme\_uninit\_ctrl() which executes very late in the
shutdown code path after the admin queue is destroyed and its tagset is
removed. So this change created the possibility of keep-alive sneaking in
and interfering with the shutdown operation and causing observed kernel
crash.
To fix the observed crash, we decided to move nvme\_stop\_keep\_alive() from
nvme\_uninit\_ctrl() to nvme\_remove\_admin\_tag\_set(). This change would ensure
that we don't forward progress and delete the admin queue until the keep-
alive operation is finished (if it's in-flight) or cancelled and that would
help contain the race condition explained above and hence avoid the crash.
Moving nvme\_stop\_keep\_alive() to nvme\_remove\_admin\_tag\_set() instead of
adding nvme\_stop\_keep\_alive() to the beginning of the controller shutdown
code path in nvme\_stop\_ctrl(), as was the case earlier before commit
a54a93d0e359 ("nvme: move stopping keep-alive into nvme\_uninit\_ctrl()"),
would help save one callsite of nvme\_stop\_keep\_alive().
Fixes: a54a93d0e359 ("nvme: move stopping keep-alive into nvme\_uninit\_ctrl()")
Link: [https://lore.kernel.org/all/1a21f37b-0f2a-4745-8c56-4dc8628d3983@linux.ibm.com/](https://lore.kernel.org/all/1a21f37b-0f2a-4745-8c56-4dc8628d3983%40linux.ibm.com/)
Reviewed-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Nilay Shroff <nilay@linux.ibm.com>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5416b76a8156c1b8491f78f8a728f422104bb919)

| -rw-r--r-- | [drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/core.c?id=5416b76a8156c1b8491f78f8a728f422104bb919) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/nvme/host/core.c b/drivers/nvme/host/core.cindex 855b42c92284df..f0d4c6f3cb0555 100644--- a/[drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/core.c?id=5e15cc7a1d9335cc2e8b99ecffd975e22666c407)+++ b/[drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/core.c?id=5416b76a8156c1b8491f78f8a728f422104bb919)@@ -4591,6 +4591,11 @@ EXPORT\_SYMBOL\_GPL(nvme\_alloc\_admin\_tag\_set);  void nvme\_remove\_admin\_tag\_set(struct nvme\_ctrl \*ctrl) {+ /\*+ \* As we're about to destroy the queue and free tagset+ \* we can not have keep-alive work running.+ \*/+ nvme\_stop\_keep\_alive(ctrl); blk\_mq\_destroy\_queue(ctrl->admin\_q); blk\_put\_queue(ctrl->admin\_q); if (ctrl->ops->flags & NVME\_F\_FABRICS) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:22 +0000



=== Content from git.kernel.org_e28e4983_20250114_190744.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=30794f4952decb2ec8efa42f704cac5304499a41)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=30794f4952decb2ec8efa42f704cac5304499a41)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30794f4952decb2ec8efa42f704cac5304499a41)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30794f4952decb2ec8efa42f704cac5304499a41)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nilay Shroff <nilay@linux.ibm.com> | 2024-11-05 11:42:09 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:30 +0100 |
| commit | [30794f4952decb2ec8efa42f704cac5304499a41](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30794f4952decb2ec8efa42f704cac5304499a41) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=30794f4952decb2ec8efa42f704cac5304499a41)) | |
| tree | [824b4e9bb485507fc7e0652706ce6bc4bd9ad3b8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=30794f4952decb2ec8efa42f704cac5304499a41) | |
| parent | [25e3fb956bbd15cf2dffcacd4683df4a754b0762](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25e3fb956bbd15cf2dffcacd4683df4a754b0762) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30794f4952decb2ec8efa42f704cac5304499a41&id2=25e3fb956bbd15cf2dffcacd4683df4a754b0762)) | |
| download | [linux-30794f4952decb2ec8efa42f704cac5304499a41.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-30794f4952decb2ec8efa42f704cac5304499a41.tar.gz) | |

nvme-fabrics: fix kernel crash while shutting down controller[ Upstream commit e9869c85c81168a1275f909d5972a3fc435304be ]
The nvme keep-alive operation, which executes at a periodic interval,
could potentially sneak in while shutting down a fabric controller.
This may lead to a race between the fabric controller admin queue
destroy code path (invoked while shutting down controller) and hw/hctx
queue dispatcher called from the nvme keep-alive async request queuing
operation. This race could lead to the kernel crash shown below:
Call Trace:
autoremove\_wake\_function+0x0/0xbc (unreliable)
\_\_blk\_mq\_sched\_dispatch\_requests+0x114/0x24c
blk\_mq\_sched\_dispatch\_requests+0x44/0x84
blk\_mq\_run\_hw\_queue+0x140/0x220
nvme\_keep\_alive\_work+0xc8/0x19c [nvme\_core]
process\_one\_work+0x200/0x4e0
worker\_thread+0x340/0x504
kthread+0x138/0x140
start\_kernel\_thread+0x14/0x18
While shutting down fabric controller, if nvme keep-alive request sneaks
in then it would be flushed off. The nvme\_keep\_alive\_end\_io function is
then invoked to handle the end of the keep-alive operation which
decrements the admin->q\_usage\_counter and assuming this is the last/only
request in the admin queue then the admin->q\_usage\_counter becomes zero.
If that happens then blk-mq destroy queue operation (blk\_mq\_destroy\_
queue()) which could be potentially running simultaneously on another
cpu (as this is the controller shutdown code path) would forward
progress and deletes the admin queue. So, now from this point onward
we are not supposed to access the admin queue resources. However the
issue here's that the nvme keep-alive thread running hw/hctx queue
dispatch operation hasn't yet finished its work and so it could still
potentially access the admin queue resource while the admin queue had
been already deleted and that causes the above crash.
The above kernel crash is regression caused due to changes implemented
in commit a54a93d0e359 ("nvme: move stopping keep-alive into
nvme\_uninit\_ctrl()"). Ideally we should stop keep-alive before destroyin
g the admin queue and freeing the admin tagset so that it wouldn't sneak
in during the shutdown operation. However we removed the keep alive stop
operation from the beginning of the controller shutdown code path in commit
a54a93d0e359 ("nvme: move stopping keep-alive into nvme\_uninit\_ctrl()")
and added it under nvme\_uninit\_ctrl() which executes very late in the
shutdown code path after the admin queue is destroyed and its tagset is
removed. So this change created the possibility of keep-alive sneaking in
and interfering with the shutdown operation and causing observed kernel
crash.
To fix the observed crash, we decided to move nvme\_stop\_keep\_alive() from
nvme\_uninit\_ctrl() to nvme\_remove\_admin\_tag\_set(). This change would ensure
that we don't forward progress and delete the admin queue until the keep-
alive operation is finished (if it's in-flight) or cancelled and that would
help contain the race condition explained above and hence avoid the crash.
Moving nvme\_stop\_keep\_alive() to nvme\_remove\_admin\_tag\_set() instead of
adding nvme\_stop\_keep\_alive() to the beginning of the controller shutdown
code path in nvme\_stop\_ctrl(), as was the case earlier before commit
a54a93d0e359 ("nvme: move stopping keep-alive into nvme\_uninit\_ctrl()"),
would help save one callsite of nvme\_stop\_keep\_alive().
Fixes: a54a93d0e359 ("nvme: move stopping keep-alive into nvme\_uninit\_ctrl()")
Link: [https://lore.kernel.org/all/1a21f37b-0f2a-4745-8c56-4dc8628d3983@linux.ibm.com/](https://lore.kernel.org/all/1a21f37b-0f2a-4745-8c56-4dc8628d3983%40linux.ibm.com/)
Reviewed-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Nilay Shroff <nilay@linux.ibm.com>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30794f4952decb2ec8efa42f704cac5304499a41)

| -rw-r--r-- | [drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/core.c?id=30794f4952decb2ec8efa42f704cac5304499a41) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 0 deletions

| diff --git a/drivers/nvme/host/core.c b/drivers/nvme/host/core.cindex 128932c849a1a4..f49431cbc8dfcd 100644--- a/[drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/core.c?id=25e3fb956bbd15cf2dffcacd4683df4a754b0762)+++ b/[drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/core.c?id=30794f4952decb2ec8efa42f704cac5304499a41)@@ -4551,6 +4551,11 @@ EXPORT\_SYMBOL\_GPL(nvme\_alloc\_admin\_tag\_set);  void nvme\_remove\_admin\_tag\_set(struct nvme\_ctrl \*ctrl) {+ /\*+ \* As we're about to destroy the queue and free tagset+ \* we can not have keep-alive work running.+ \*/+ nvme\_stop\_keep\_alive(ctrl); blk\_mq\_destroy\_queue(ctrl->admin\_q); blk\_put\_queue(ctrl->admin\_q); if (ctrl->ops->flags & NVME\_F\_FABRICS) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:21 +0000


