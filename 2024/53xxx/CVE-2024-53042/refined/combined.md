=== Content from git.kernel.org_860df386_20250114_185941.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=72c0f482e39c87317ebf67661e28c8d86c93e870)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72c0f482e39c87317ebf67661e28c8d86c93e870)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72c0f482e39c87317ebf67661e28c8d86c93e870)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72c0f482e39c87317ebf67661e28c8d86c93e870)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-10-22 09:38:22 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:41 +0100 |
| commit | [72c0f482e39c87317ebf67661e28c8d86c93e870](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72c0f482e39c87317ebf67661e28c8d86c93e870) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=72c0f482e39c87317ebf67661e28c8d86c93e870)) | |
| tree | [8e278c1053a8f28234dcdbdbc98e66eca0ded3da](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72c0f482e39c87317ebf67661e28c8d86c93e870) | |
| parent | [a3ff23f7c3f0e13f718900803e090fd3997d6bc9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3ff23f7c3f0e13f718900803e090fd3997d6bc9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72c0f482e39c87317ebf67661e28c8d86c93e870&id2=a3ff23f7c3f0e13f718900803e090fd3997d6bc9)) | |
| download | [linux-72c0f482e39c87317ebf67661e28c8d86c93e870.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-72c0f482e39c87317ebf67661e28c8d86c93e870.tar.gz) | |

ipv4: ip\_tunnel: Fix suspicious RCU usage warning in ip\_tunnel\_init\_flow()[ Upstream commit ad4a3ca6a8e886f6491910a3ae5d53595e40597d ]
There are code paths from which the function is called without holding
the RCU read lock, resulting in a suspicious RCU usage warning [1].
Fix by using l3mdev\_master\_upper\_ifindex\_by\_index() which will acquire
the RCU read lock before calling
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu().
[1]
WARNING: suspicious RCU usage
6.12.0-rc3-custom-gac8f72681cf2 #141 Not tainted
-----------------------------
net/core/dev.c:876 RCU-list traversed in non-reader section!!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by ip/361:
#0: ffffffff86fc7cb0 (rtnl\_mutex){+.+.}-{3:3}, at: rtnetlink\_rcv\_msg+0x377/0xf60
stack backtrace:
CPU: 3 UID: 0 PID: 361 Comm: ip Not tainted 6.12.0-rc3-custom-gac8f72681cf2 #141
Hardware name: Bochs Bochs, BIOS Bochs 01/01/2011
Call Trace:
<TASK>
dump\_stack\_lvl+0xba/0x110
lockdep\_rcu\_suspicious.cold+0x4f/0xd6
dev\_get\_by\_index\_rcu+0x1d3/0x210
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu+0x2b/0xf0
ip\_tunnel\_bind\_dev+0x72f/0xa00
ip\_tunnel\_newlink+0x368/0x7a0
ipgre\_newlink+0x14c/0x170
\_\_rtnl\_newlink+0x1173/0x19c0
rtnl\_newlink+0x6c/0xa0
rtnetlink\_rcv\_msg+0x3cc/0xf60
netlink\_rcv\_skb+0x171/0x450
netlink\_unicast+0x539/0x7f0
netlink\_sendmsg+0x8c1/0xd80
\_\_\_\_sys\_sendmsg+0x8f9/0xc20
\_\_\_sys\_sendmsg+0x197/0x1e0
\_\_sys\_sendmsg+0x122/0x1f0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Fixes: db53cd3d88dc ("net: Handle l3mdev in ip\_tunnel\_init\_flow")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/20241022063822.462057-1-idosch@nvidia.com](https://patch.msgid.link/20241022063822.462057-1-idosch%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72c0f482e39c87317ebf67661e28c8d86c93e870)

| -rw-r--r-- | [include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/ip_tunnels.h?id=72c0f482e39c87317ebf67661e28c8d86c93e870) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/include/net/ip\_tunnels.h b/include/net/ip\_tunnels.hindex 0cc077c3dda302..f1ba369306fee7 100644--- a/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=a3ff23f7c3f0e13f718900803e090fd3997d6bc9)+++ b/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=72c0f482e39c87317ebf67661e28c8d86c93e870)@@ -252,7 +252,7 @@ static inline void ip\_tunnel\_init\_flow(struct flowi4 \*fl4, memset(fl4, 0, sizeof(\*fl4));  if (oif) {- fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index\_rcu(net, oif);+ fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index(net, oif); /\* Legacy VRF/l3mdev use case \*/ fl4->flowi4\_oif = fl4->flowi4\_l3mdev ? 0 : oif; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:58:18 +0000



=== Content from git.kernel.org_c18e4ea9_20250114_185939.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=699b48fc31727792edf2cab3829586ae6ba649e2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=699b48fc31727792edf2cab3829586ae6ba649e2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=699b48fc31727792edf2cab3829586ae6ba649e2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=699b48fc31727792edf2cab3829586ae6ba649e2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-10-22 09:38:22 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:18 +0100 |
| commit | [699b48fc31727792edf2cab3829586ae6ba649e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=699b48fc31727792edf2cab3829586ae6ba649e2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=699b48fc31727792edf2cab3829586ae6ba649e2)) | |
| tree | [5090549168f219a4898db2417a2645f7aa282d47](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=699b48fc31727792edf2cab3829586ae6ba649e2) | |
| parent | [07c9c26e37542486e34d767505e842f48f29c3f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c9c26e37542486e34d767505e842f48f29c3f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=699b48fc31727792edf2cab3829586ae6ba649e2&id2=07c9c26e37542486e34d767505e842f48f29c3f6)) | |
| download | [linux-699b48fc31727792edf2cab3829586ae6ba649e2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-699b48fc31727792edf2cab3829586ae6ba649e2.tar.gz) | |

ipv4: ip\_tunnel: Fix suspicious RCU usage warning in ip\_tunnel\_init\_flow()[ Upstream commit ad4a3ca6a8e886f6491910a3ae5d53595e40597d ]
There are code paths from which the function is called without holding
the RCU read lock, resulting in a suspicious RCU usage warning [1].
Fix by using l3mdev\_master\_upper\_ifindex\_by\_index() which will acquire
the RCU read lock before calling
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu().
[1]
WARNING: suspicious RCU usage
6.12.0-rc3-custom-gac8f72681cf2 #141 Not tainted
-----------------------------
net/core/dev.c:876 RCU-list traversed in non-reader section!!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by ip/361:
#0: ffffffff86fc7cb0 (rtnl\_mutex){+.+.}-{3:3}, at: rtnetlink\_rcv\_msg+0x377/0xf60
stack backtrace:
CPU: 3 UID: 0 PID: 361 Comm: ip Not tainted 6.12.0-rc3-custom-gac8f72681cf2 #141
Hardware name: Bochs Bochs, BIOS Bochs 01/01/2011
Call Trace:
<TASK>
dump\_stack\_lvl+0xba/0x110
lockdep\_rcu\_suspicious.cold+0x4f/0xd6
dev\_get\_by\_index\_rcu+0x1d3/0x210
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu+0x2b/0xf0
ip\_tunnel\_bind\_dev+0x72f/0xa00
ip\_tunnel\_newlink+0x368/0x7a0
ipgre\_newlink+0x14c/0x170
\_\_rtnl\_newlink+0x1173/0x19c0
rtnl\_newlink+0x6c/0xa0
rtnetlink\_rcv\_msg+0x3cc/0xf60
netlink\_rcv\_skb+0x171/0x450
netlink\_unicast+0x539/0x7f0
netlink\_sendmsg+0x8c1/0xd80
\_\_\_\_sys\_sendmsg+0x8f9/0xc20
\_\_\_sys\_sendmsg+0x197/0x1e0
\_\_sys\_sendmsg+0x122/0x1f0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Fixes: db53cd3d88dc ("net: Handle l3mdev in ip\_tunnel\_init\_flow")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/20241022063822.462057-1-idosch@nvidia.com](https://patch.msgid.link/20241022063822.462057-1-idosch%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=699b48fc31727792edf2cab3829586ae6ba649e2)

| -rw-r--r-- | [include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/ip_tunnels.h?id=699b48fc31727792edf2cab3829586ae6ba649e2) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/include/net/ip\_tunnels.h b/include/net/ip\_tunnels.hindex 4e69f52a51177f..006a61ddd36fa4 100644--- a/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=07c9c26e37542486e34d767505e842f48f29c3f6)+++ b/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=699b48fc31727792edf2cab3829586ae6ba649e2)@@ -260,7 +260,7 @@ static inline void ip\_tunnel\_init\_flow(struct flowi4 \*fl4, memset(fl4, 0, sizeof(\*fl4));  if (oif) {- fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index\_rcu(net, oif);+ fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index(net, oif); /\* Legacy VRF/l3mdev use case \*/ fl4->flowi4\_oif = fl4->flowi4\_l3mdev ? 0 : oif; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:58:16 +0000



=== Content from git.kernel.org_d0613809_20250114_185942.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-10-22 09:38:22 +0300 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-10-29 11:12:25 -0700 |
| commit | [ad4a3ca6a8e886f6491910a3ae5d53595e40597d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d)) | |
| tree | [6f6c590c2356eaa329af80f4f8d7fa14f6d3046f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d) | |
| parent | [bacccddbbcc3c853828745be325b24f85c8714c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bacccddbbcc3c853828745be325b24f85c8714c6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d&id2=bacccddbbcc3c853828745be325b24f85c8714c6)) | |
| download | [linux-ad4a3ca6a8e886f6491910a3ae5d53595e40597d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ad4a3ca6a8e886f6491910a3ae5d53595e40597d.tar.gz) | |

ipv4: ip\_tunnel: Fix suspicious RCU usage warning in ip\_tunnel\_init\_flow()There are code paths from which the function is called without holding
the RCU read lock, resulting in a suspicious RCU usage warning [1].
Fix by using l3mdev\_master\_upper\_ifindex\_by\_index() which will acquire
the RCU read lock before calling
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu().
[1]
WARNING: suspicious RCU usage
6.12.0-rc3-custom-gac8f72681cf2 #141 Not tainted
-----------------------------
net/core/dev.c:876 RCU-list traversed in non-reader section!!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by ip/361:
#0: ffffffff86fc7cb0 (rtnl\_mutex){+.+.}-{3:3}, at: rtnetlink\_rcv\_msg+0x377/0xf60
stack backtrace:
CPU: 3 UID: 0 PID: 361 Comm: ip Not tainted 6.12.0-rc3-custom-gac8f72681cf2 #141
Hardware name: Bochs Bochs, BIOS Bochs 01/01/2011
Call Trace:
<TASK>
dump\_stack\_lvl+0xba/0x110
lockdep\_rcu\_suspicious.cold+0x4f/0xd6
dev\_get\_by\_index\_rcu+0x1d3/0x210
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu+0x2b/0xf0
ip\_tunnel\_bind\_dev+0x72f/0xa00
ip\_tunnel\_newlink+0x368/0x7a0
ipgre\_newlink+0x14c/0x170
\_\_rtnl\_newlink+0x1173/0x19c0
rtnl\_newlink+0x6c/0xa0
rtnetlink\_rcv\_msg+0x3cc/0xf60
netlink\_rcv\_skb+0x171/0x450
netlink\_unicast+0x539/0x7f0
netlink\_sendmsg+0x8c1/0xd80
\_\_\_\_sys\_sendmsg+0x8f9/0xc20
\_\_\_sys\_sendmsg+0x197/0x1e0
\_\_sys\_sendmsg+0x122/0x1f0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Fixes: db53cd3d88dc ("net: Handle l3mdev in ip\_tunnel\_init\_flow")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/20241022063822.462057-1-idosch@nvidia.com](https://patch.msgid.link/20241022063822.462057-1-idosch%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d)

| -rw-r--r-- | [include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/ip_tunnels.h?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/include/net/ip\_tunnels.h b/include/net/ip\_tunnels.hindex 6194fbb564c689..6a070478254d84 100644--- a/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=bacccddbbcc3c853828745be325b24f85c8714c6)+++ b/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=ad4a3ca6a8e886f6491910a3ae5d53595e40597d)@@ -354,7 +354,7 @@ static inline void ip\_tunnel\_init\_flow(struct flowi4 \*fl4, memset(fl4, 0, sizeof(\*fl4));  if (oif) {- fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index\_rcu(net, oif);+ fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index(net, oif); /\* Legacy VRF/l3mdev use case \*/ fl4->flowi4\_oif = fl4->flowi4\_l3mdev ? 0 : oif; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:58:19 +0000



=== Content from git.kernel.org_e2460884_20250114_185940.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6dfaa458fe923211c766238a224e0a3c0522935c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6dfaa458fe923211c766238a224e0a3c0522935c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6dfaa458fe923211c766238a224e0a3c0522935c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6dfaa458fe923211c766238a224e0a3c0522935c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-10-22 09:38:22 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:47 +0100 |
| commit | [6dfaa458fe923211c766238a224e0a3c0522935c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6dfaa458fe923211c766238a224e0a3c0522935c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6dfaa458fe923211c766238a224e0a3c0522935c)) | |
| tree | [8856463cb75f9397d2d7ed9baf6833d5bcbda6f4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6dfaa458fe923211c766238a224e0a3c0522935c) | |
| parent | [82b107a27bab29146e159b6b9f21146c97c45a53](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82b107a27bab29146e159b6b9f21146c97c45a53) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6dfaa458fe923211c766238a224e0a3c0522935c&id2=82b107a27bab29146e159b6b9f21146c97c45a53)) | |
| download | [linux-6dfaa458fe923211c766238a224e0a3c0522935c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6dfaa458fe923211c766238a224e0a3c0522935c.tar.gz) | |

ipv4: ip\_tunnel: Fix suspicious RCU usage warning in ip\_tunnel\_init\_flow()[ Upstream commit ad4a3ca6a8e886f6491910a3ae5d53595e40597d ]
There are code paths from which the function is called without holding
the RCU read lock, resulting in a suspicious RCU usage warning [1].
Fix by using l3mdev\_master\_upper\_ifindex\_by\_index() which will acquire
the RCU read lock before calling
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu().
[1]
WARNING: suspicious RCU usage
6.12.0-rc3-custom-gac8f72681cf2 #141 Not tainted
-----------------------------
net/core/dev.c:876 RCU-list traversed in non-reader section!!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by ip/361:
#0: ffffffff86fc7cb0 (rtnl\_mutex){+.+.}-{3:3}, at: rtnetlink\_rcv\_msg+0x377/0xf60
stack backtrace:
CPU: 3 UID: 0 PID: 361 Comm: ip Not tainted 6.12.0-rc3-custom-gac8f72681cf2 #141
Hardware name: Bochs Bochs, BIOS Bochs 01/01/2011
Call Trace:
<TASK>
dump\_stack\_lvl+0xba/0x110
lockdep\_rcu\_suspicious.cold+0x4f/0xd6
dev\_get\_by\_index\_rcu+0x1d3/0x210
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu+0x2b/0xf0
ip\_tunnel\_bind\_dev+0x72f/0xa00
ip\_tunnel\_newlink+0x368/0x7a0
ipgre\_newlink+0x14c/0x170
\_\_rtnl\_newlink+0x1173/0x19c0
rtnl\_newlink+0x6c/0xa0
rtnetlink\_rcv\_msg+0x3cc/0xf60
netlink\_rcv\_skb+0x171/0x450
netlink\_unicast+0x539/0x7f0
netlink\_sendmsg+0x8c1/0xd80
\_\_\_\_sys\_sendmsg+0x8f9/0xc20
\_\_\_sys\_sendmsg+0x197/0x1e0
\_\_sys\_sendmsg+0x122/0x1f0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Fixes: db53cd3d88dc ("net: Handle l3mdev in ip\_tunnel\_init\_flow")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/20241022063822.462057-1-idosch@nvidia.com](https://patch.msgid.link/20241022063822.462057-1-idosch%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6dfaa458fe923211c766238a224e0a3c0522935c)

| -rw-r--r-- | [include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/ip_tunnels.h?id=6dfaa458fe923211c766238a224e0a3c0522935c) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/include/net/ip\_tunnels.h b/include/net/ip\_tunnels.hindex 1db2417b8ff52d..35d1e09940b278 100644--- a/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=82b107a27bab29146e159b6b9f21146c97c45a53)+++ b/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=6dfaa458fe923211c766238a224e0a3c0522935c)@@ -354,7 +354,7 @@ static inline void ip\_tunnel\_init\_flow(struct flowi4 \*fl4, memset(fl4, 0, sizeof(\*fl4));  if (oif) {- fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index\_rcu(net, oif);+ fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index(net, oif); /\* Legacy VRF/l3mdev use case \*/ fl4->flowi4\_oif = fl4->flowi4\_l3mdev ? 0 : oif; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:58:17 +0000



=== Content from git.kernel.org_f4a27284_20250114_185938.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-10-22 09:38:22 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:25:52 +0100 |
| commit | [5edcb3fdb12c3d46a6e79eeeec27d925b80fc168](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168)) | |
| tree | [730a3f27dda014aac1b6a2503dd861307c217a0e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168) | |
| parent | [ece593fc9c00741b682869d3f3dc584d37b7c9df](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ece593fc9c00741b682869d3f3dc584d37b7c9df) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168&id2=ece593fc9c00741b682869d3f3dc584d37b7c9df)) | |
| download | [linux-5edcb3fdb12c3d46a6e79eeeec27d925b80fc168.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5edcb3fdb12c3d46a6e79eeeec27d925b80fc168.tar.gz) | |

ipv4: ip\_tunnel: Fix suspicious RCU usage warning in ip\_tunnel\_init\_flow()[ Upstream commit ad4a3ca6a8e886f6491910a3ae5d53595e40597d ]
There are code paths from which the function is called without holding
the RCU read lock, resulting in a suspicious RCU usage warning [1].
Fix by using l3mdev\_master\_upper\_ifindex\_by\_index() which will acquire
the RCU read lock before calling
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu().
[1]
WARNING: suspicious RCU usage
6.12.0-rc3-custom-gac8f72681cf2 #141 Not tainted
-----------------------------
net/core/dev.c:876 RCU-list traversed in non-reader section!!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by ip/361:
#0: ffffffff86fc7cb0 (rtnl\_mutex){+.+.}-{3:3}, at: rtnetlink\_rcv\_msg+0x377/0xf60
stack backtrace:
CPU: 3 UID: 0 PID: 361 Comm: ip Not tainted 6.12.0-rc3-custom-gac8f72681cf2 #141
Hardware name: Bochs Bochs, BIOS Bochs 01/01/2011
Call Trace:
<TASK>
dump\_stack\_lvl+0xba/0x110
lockdep\_rcu\_suspicious.cold+0x4f/0xd6
dev\_get\_by\_index\_rcu+0x1d3/0x210
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu+0x2b/0xf0
ip\_tunnel\_bind\_dev+0x72f/0xa00
ip\_tunnel\_newlink+0x368/0x7a0
ipgre\_newlink+0x14c/0x170
\_\_rtnl\_newlink+0x1173/0x19c0
rtnl\_newlink+0x6c/0xa0
rtnetlink\_rcv\_msg+0x3cc/0xf60
netlink\_rcv\_skb+0x171/0x450
netlink\_unicast+0x539/0x7f0
netlink\_sendmsg+0x8c1/0xd80
\_\_\_\_sys\_sendmsg+0x8f9/0xc20
\_\_\_sys\_sendmsg+0x197/0x1e0
\_\_sys\_sendmsg+0x122/0x1f0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Fixes: db53cd3d88dc ("net: Handle l3mdev in ip\_tunnel\_init\_flow")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/20241022063822.462057-1-idosch@nvidia.com](https://patch.msgid.link/20241022063822.462057-1-idosch%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168)

| -rw-r--r-- | [include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/ip_tunnels.h?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/include/net/ip\_tunnels.h b/include/net/ip\_tunnels.hindex 0a0de98c0b7f2f..d8b9942f1afd9d 100644--- a/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=ece593fc9c00741b682869d3f3dc584d37b7c9df)+++ b/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=5edcb3fdb12c3d46a6e79eeeec27d925b80fc168)@@ -247,7 +247,7 @@ static inline void ip\_tunnel\_init\_flow(struct flowi4 \*fl4, memset(fl4, 0, sizeof(\*fl4));  if (oif) {- fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index\_rcu(net, oif);+ fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index(net, oif); /\* Legacy VRF/l3mdev use case \*/ fl4->flowi4\_oif = fl4->flowi4\_l3mdev ? 0 : oif; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:58:15 +0000



=== Content from git.kernel.org_1ad840f4_20250114_185943.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e2742758c9c85c84e077ede5f916479f724e11c2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2742758c9c85c84e077ede5f916479f724e11c2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2742758c9c85c84e077ede5f916479f724e11c2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2742758c9c85c84e077ede5f916479f724e11c2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-10-22 09:38:22 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:22:01 +0100 |
| commit | [e2742758c9c85c84e077ede5f916479f724e11c2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2742758c9c85c84e077ede5f916479f724e11c2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e2742758c9c85c84e077ede5f916479f724e11c2)) | |
| tree | [5c436f91d4d2c50d23448f454930fd4ff2912378](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2742758c9c85c84e077ede5f916479f724e11c2) | |
| parent | [465d3a8eca3f9d2d78588dfcebb407d5c1f314c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=465d3a8eca3f9d2d78588dfcebb407d5c1f314c5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2742758c9c85c84e077ede5f916479f724e11c2&id2=465d3a8eca3f9d2d78588dfcebb407d5c1f314c5)) | |
| download | [linux-e2742758c9c85c84e077ede5f916479f724e11c2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e2742758c9c85c84e077ede5f916479f724e11c2.tar.gz) | |

ipv4: ip\_tunnel: Fix suspicious RCU usage warning in ip\_tunnel\_init\_flow()[ Upstream commit ad4a3ca6a8e886f6491910a3ae5d53595e40597d ]
There are code paths from which the function is called without holding
the RCU read lock, resulting in a suspicious RCU usage warning [1].
Fix by using l3mdev\_master\_upper\_ifindex\_by\_index() which will acquire
the RCU read lock before calling
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu().
[1]
WARNING: suspicious RCU usage
6.12.0-rc3-custom-gac8f72681cf2 #141 Not tainted
-----------------------------
net/core/dev.c:876 RCU-list traversed in non-reader section!!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by ip/361:
#0: ffffffff86fc7cb0 (rtnl\_mutex){+.+.}-{3:3}, at: rtnetlink\_rcv\_msg+0x377/0xf60
stack backtrace:
CPU: 3 UID: 0 PID: 361 Comm: ip Not tainted 6.12.0-rc3-custom-gac8f72681cf2 #141
Hardware name: Bochs Bochs, BIOS Bochs 01/01/2011
Call Trace:
<TASK>
dump\_stack\_lvl+0xba/0x110
lockdep\_rcu\_suspicious.cold+0x4f/0xd6
dev\_get\_by\_index\_rcu+0x1d3/0x210
l3mdev\_master\_upper\_ifindex\_by\_index\_rcu+0x2b/0xf0
ip\_tunnel\_bind\_dev+0x72f/0xa00
ip\_tunnel\_newlink+0x368/0x7a0
ipgre\_newlink+0x14c/0x170
\_\_rtnl\_newlink+0x1173/0x19c0
rtnl\_newlink+0x6c/0xa0
rtnetlink\_rcv\_msg+0x3cc/0xf60
netlink\_rcv\_skb+0x171/0x450
netlink\_unicast+0x539/0x7f0
netlink\_sendmsg+0x8c1/0xd80
\_\_\_\_sys\_sendmsg+0x8f9/0xc20
\_\_\_sys\_sendmsg+0x197/0x1e0
\_\_sys\_sendmsg+0x122/0x1f0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Fixes: db53cd3d88dc ("net: Handle l3mdev in ip\_tunnel\_init\_flow")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://patch.msgid.link/20241022063822.462057-1-idosch@nvidia.com](https://patch.msgid.link/20241022063822.462057-1-idosch%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2742758c9c85c84e077ede5f916479f724e11c2)

| -rw-r--r-- | [include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/ip_tunnels.h?id=e2742758c9c85c84e077ede5f916479f724e11c2) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/include/net/ip\_tunnels.h b/include/net/ip\_tunnels.hindex f6cb68c2beadf1..cedf72924f19e1 100644--- a/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=465d3a8eca3f9d2d78588dfcebb407d5c1f314c5)+++ b/[include/net/ip\_tunnels.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/ip_tunnels.h?id=e2742758c9c85c84e077ede5f916479f724e11c2)@@ -247,7 +247,7 @@ static inline void ip\_tunnel\_init\_flow(struct flowi4 \*fl4, memset(fl4, 0, sizeof(\*fl4));  if (oif) {- fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index\_rcu(net, oif);+ fl4->flowi4\_l3mdev = l3mdev\_master\_upper\_ifindex\_by\_index(net, oif); /\* Legacy VRF/l3mdev use case \*/ fl4->flowi4\_oif = fl4->flowi4\_l3mdev ? 0 : oif; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:58:20 +0000


