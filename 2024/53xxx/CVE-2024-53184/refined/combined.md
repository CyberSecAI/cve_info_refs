=== Content from git.kernel.org_6d1387dd_20250114_181315.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tiwei Bie <tiwei.btw@antgroup.com> | 2024-11-05 00:32:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:02 +0100 |
| commit | [a5a75207efae4b558aaa34c288de7d6f2e926b4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b)) | |
| tree | [42270af0dcf39d0a0a71c89a3934c16a49678718](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b) | |
| parent | [6a3dbe75b201b374fabbe111159116141a457b51](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a3dbe75b201b374fabbe111159116141a457b51) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b&id2=6a3dbe75b201b374fabbe111159116141a457b51)) | |
| download | [linux-a5a75207efae4b558aaa34c288de7d6f2e926b4b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a5a75207efae4b558aaa34c288de7d6f2e926b4b.tar.gz) | |

um: ubd: Do not use drvdata in releasecommit 5bee35e5389f450a7eea7318deb9073e9414d3b1 upstream.
The drvdata is not available in release. Let's just use container\_of()
to get the ubd instance. Otherwise, removing a ubd device will result
in a crash:
RIP: 0033:blk\_mq\_free\_tag\_set+0x1f/0xba
RSP: 00000000e2083bf0 EFLAGS: 00010246
RAX: 000000006021463a RBX: 0000000000000348 RCX: 0000000062604d00
RDX: 0000000004208060 RSI: 00000000605241a0 RDI: 0000000000000348
RBP: 00000000e2083c10 R08: 0000000062414010 R09: 00000000601603f7
R10: 000000000000133a R11: 000000006038c4bd R12: 0000000000000000
R13: 0000000060213a5c R14: 0000000062405d20 R15: 00000000604f7aa0
Kernel panic - not syncing: Segfault with no mm
CPU: 0 PID: 17 Comm: kworker/0:1 Not tainted 6.8.0-rc3-00107-gba3f67c11638 #1
Workqueue: events mc\_work\_proc
Stack:
00000000 604f7ef0 62c5d000 62405d20
e2083c30 6002c776 6002c755 600e47ff
e2083c60 6025ffe3 04208060 603d36e0
Call Trace:
[<6002c776>] ubd\_device\_release+0x21/0x55
[<6002c755>] ? ubd\_device\_release+0x0/0x55
[<600e47ff>] ? kfree+0x0/0x100
[<6025ffe3>] device\_release+0x70/0xba
[<60381d6a>] kobject\_put+0xb5/0xe2
[<6026027b>] put\_device+0x19/0x1c
[<6026a036>] platform\_device\_put+0x26/0x29
[<6026ac5a>] platform\_device\_unregister+0x2c/0x2e
[<6002c52e>] ubd\_remove+0xb8/0xd6
[<6002bb74>] ? mconsole\_reply+0x0/0x50
[<6002b926>] mconsole\_remove+0x160/0x1cc
[<6002bbbc>] ? mconsole\_reply+0x48/0x50
[<6003379c>] ? um\_set\_signals+0x3b/0x43
[<60061c55>] ? update\_min\_vruntime+0x14/0x70
[<6006251f>] ? dequeue\_task\_fair+0x164/0x235
[<600620aa>] ? update\_cfs\_group+0x0/0x40
[<603a0e77>] ? \_\_schedule+0x0/0x3ed
[<60033761>] ? um\_set\_signals+0x0/0x43
[<6002af6a>] mc\_work\_proc+0x77/0x91
[<600520b4>] process\_scheduled\_works+0x1af/0x2c3
[<6004ede3>] ? assign\_work+0x0/0x58
[<600527a1>] worker\_thread+0x2f7/0x37a
[<6004ee3b>] ? set\_pf\_worker+0x0/0x64
[<6005765d>] ? arch\_local\_irq\_save+0x0/0x2d
[<60058e07>] ? kthread\_exit+0x0/0x3a
[<600524aa>] ? worker\_thread+0x0/0x37a
[<60058f9f>] kthread+0x130/0x135
[<6002068e>] new\_thread\_handler+0x85/0xb6
Cc: stable@vger.kernel.org
Signed-off-by: Tiwei Bie <tiwei.btw@antgroup.com>
Acked-By: Anton Ivanov <anton.ivanov@cambridgegreys.com>
Link: [https://patch.msgid.link/20241104163203.435515-3-tiwei.btw@antgroup.com](https://patch.msgid.link/20241104163203.435515-3-tiwei.btw%40antgroup.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b)

| -rw-r--r-- | [arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/ubd_kern.c?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/um/drivers/ubd\_kern.c b/arch/um/drivers/ubd\_kern.cindex 1203f5078cb571..18e85f929d7032 100644--- a/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=6a3dbe75b201b374fabbe111159116141a457b51)+++ b/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=a5a75207efae4b558aaa34c288de7d6f2e926b4b)@@ -799,7 +799,7 @@ static int ubd\_open\_dev(struct ubd \*ubd\_dev)  static void ubd\_device\_release(struct device \*dev) {- struct ubd \*ubd\_dev = dev\_get\_drvdata(dev);+ struct ubd \*ubd\_dev = container\_of(dev, struct ubd, pdev.dev);  blk\_mq\_free\_tag\_set(&ubd\_dev->tag\_set); \*ubd\_dev = ((struct ubd) DEFAULT\_UBD); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:11:53 +0000



=== Content from git.kernel.org_3ed56b52_20250114_181315.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5bee35e5389f450a7eea7318deb9073e9414d3b1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5bee35e5389f450a7eea7318deb9073e9414d3b1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5bee35e5389f450a7eea7318deb9073e9414d3b1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5bee35e5389f450a7eea7318deb9073e9414d3b1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tiwei Bie <tiwei.btw@antgroup.com> | 2024-11-05 00:32:01 +0800 |
| --- | --- | --- |
| committer | Johannes Berg <johannes.berg@intel.com> | 2024-11-07 18:05:22 +0100 |
| commit | [5bee35e5389f450a7eea7318deb9073e9414d3b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5bee35e5389f450a7eea7318deb9073e9414d3b1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5bee35e5389f450a7eea7318deb9073e9414d3b1)) | |
| tree | [51b2940e3e3990f0a3c348b87f4032c41b57d3fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5bee35e5389f450a7eea7318deb9073e9414d3b1) | |
| parent | [df700802abcac3c7c4a4ced099aa42b9a144eea8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df700802abcac3c7c4a4ced099aa42b9a144eea8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5bee35e5389f450a7eea7318deb9073e9414d3b1&id2=df700802abcac3c7c4a4ced099aa42b9a144eea8)) | |
| download | [linux-5bee35e5389f450a7eea7318deb9073e9414d3b1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5bee35e5389f450a7eea7318deb9073e9414d3b1.tar.gz) | |

um: ubd: Do not use drvdata in releaseThe drvdata is not available in release. Let's just use container\_of()
to get the ubd instance. Otherwise, removing a ubd device will result
in a crash:
RIP: 0033:blk\_mq\_free\_tag\_set+0x1f/0xba
RSP: 00000000e2083bf0 EFLAGS: 00010246
RAX: 000000006021463a RBX: 0000000000000348 RCX: 0000000062604d00
RDX: 0000000004208060 RSI: 00000000605241a0 RDI: 0000000000000348
RBP: 00000000e2083c10 R08: 0000000062414010 R09: 00000000601603f7
R10: 000000000000133a R11: 000000006038c4bd R12: 0000000000000000
R13: 0000000060213a5c R14: 0000000062405d20 R15: 00000000604f7aa0
Kernel panic - not syncing: Segfault with no mm
CPU: 0 PID: 17 Comm: kworker/0:1 Not tainted 6.8.0-rc3-00107-gba3f67c11638 #1
Workqueue: events mc\_work\_proc
Stack:
00000000 604f7ef0 62c5d000 62405d20
e2083c30 6002c776 6002c755 600e47ff
e2083c60 6025ffe3 04208060 603d36e0
Call Trace:
[<6002c776>] ubd\_device\_release+0x21/0x55
[<6002c755>] ? ubd\_device\_release+0x0/0x55
[<600e47ff>] ? kfree+0x0/0x100
[<6025ffe3>] device\_release+0x70/0xba
[<60381d6a>] kobject\_put+0xb5/0xe2
[<6026027b>] put\_device+0x19/0x1c
[<6026a036>] platform\_device\_put+0x26/0x29
[<6026ac5a>] platform\_device\_unregister+0x2c/0x2e
[<6002c52e>] ubd\_remove+0xb8/0xd6
[<6002bb74>] ? mconsole\_reply+0x0/0x50
[<6002b926>] mconsole\_remove+0x160/0x1cc
[<6002bbbc>] ? mconsole\_reply+0x48/0x50
[<6003379c>] ? um\_set\_signals+0x3b/0x43
[<60061c55>] ? update\_min\_vruntime+0x14/0x70
[<6006251f>] ? dequeue\_task\_fair+0x164/0x235
[<600620aa>] ? update\_cfs\_group+0x0/0x40
[<603a0e77>] ? \_\_schedule+0x0/0x3ed
[<60033761>] ? um\_set\_signals+0x0/0x43
[<6002af6a>] mc\_work\_proc+0x77/0x91
[<600520b4>] process\_scheduled\_works+0x1af/0x2c3
[<6004ede3>] ? assign\_work+0x0/0x58
[<600527a1>] worker\_thread+0x2f7/0x37a
[<6004ee3b>] ? set\_pf\_worker+0x0/0x64
[<6005765d>] ? arch\_local\_irq\_save+0x0/0x2d
[<60058e07>] ? kthread\_exit+0x0/0x3a
[<600524aa>] ? worker\_thread+0x0/0x37a
[<60058f9f>] kthread+0x130/0x135
[<6002068e>] new\_thread\_handler+0x85/0xb6
Cc: stable@vger.kernel.org
Signed-off-by: Tiwei Bie <tiwei.btw@antgroup.com>
Acked-By: Anton Ivanov <anton.ivanov@cambridgegreys.com>
Link: [https://patch.msgid.link/20241104163203.435515-3-tiwei.btw@antgroup.com](https://patch.msgid.link/20241104163203.435515-3-tiwei.btw%40antgroup.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5bee35e5389f450a7eea7318deb9073e9414d3b1)

| -rw-r--r-- | [arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/ubd_kern.c?id=5bee35e5389f450a7eea7318deb9073e9414d3b1) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/um/drivers/ubd\_kern.c b/arch/um/drivers/ubd\_kern.cindex f19173da64d83c..66c1a8835e3627 100644--- a/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=df700802abcac3c7c4a4ced099aa42b9a144eea8)+++ b/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=5bee35e5389f450a7eea7318deb9073e9414d3b1)@@ -779,7 +779,7 @@ static int ubd\_open\_dev(struct ubd \*ubd\_dev)  static void ubd\_device\_release(struct device \*dev) {- struct ubd \*ubd\_dev = dev\_get\_drvdata(dev);+ struct ubd \*ubd\_dev = container\_of(dev, struct ubd, pdev.dev);  blk\_mq\_free\_tag\_set(&ubd\_dev->tag\_set); \*ubd\_dev = ((struct ubd) DEFAULT\_UBD); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:11:52 +0000



=== Content from git.kernel.org_d6d0784e_20250114_181316.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tiwei Bie <tiwei.btw@antgroup.com> | 2024-11-05 00:32:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:18 +0100 |
| commit | [e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec)) | |
| tree | [7cf47f16eb773987be3d5df67f8dc8e52720b311](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec) | |
| parent | [58b1e84886a0c1ae6b49b006e6b9198b555281e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58b1e84886a0c1ae6b49b006e6b9198b555281e5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec&id2=58b1e84886a0c1ae6b49b006e6b9198b555281e5)) | |
| download | [linux-e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec.tar.gz) | |

um: ubd: Do not use drvdata in releasecommit 5bee35e5389f450a7eea7318deb9073e9414d3b1 upstream.
The drvdata is not available in release. Let's just use container\_of()
to get the ubd instance. Otherwise, removing a ubd device will result
in a crash:
RIP: 0033:blk\_mq\_free\_tag\_set+0x1f/0xba
RSP: 00000000e2083bf0 EFLAGS: 00010246
RAX: 000000006021463a RBX: 0000000000000348 RCX: 0000000062604d00
RDX: 0000000004208060 RSI: 00000000605241a0 RDI: 0000000000000348
RBP: 00000000e2083c10 R08: 0000000062414010 R09: 00000000601603f7
R10: 000000000000133a R11: 000000006038c4bd R12: 0000000000000000
R13: 0000000060213a5c R14: 0000000062405d20 R15: 00000000604f7aa0
Kernel panic - not syncing: Segfault with no mm
CPU: 0 PID: 17 Comm: kworker/0:1 Not tainted 6.8.0-rc3-00107-gba3f67c11638 #1
Workqueue: events mc\_work\_proc
Stack:
00000000 604f7ef0 62c5d000 62405d20
e2083c30 6002c776 6002c755 600e47ff
e2083c60 6025ffe3 04208060 603d36e0
Call Trace:
[<6002c776>] ubd\_device\_release+0x21/0x55
[<6002c755>] ? ubd\_device\_release+0x0/0x55
[<600e47ff>] ? kfree+0x0/0x100
[<6025ffe3>] device\_release+0x70/0xba
[<60381d6a>] kobject\_put+0xb5/0xe2
[<6026027b>] put\_device+0x19/0x1c
[<6026a036>] platform\_device\_put+0x26/0x29
[<6026ac5a>] platform\_device\_unregister+0x2c/0x2e
[<6002c52e>] ubd\_remove+0xb8/0xd6
[<6002bb74>] ? mconsole\_reply+0x0/0x50
[<6002b926>] mconsole\_remove+0x160/0x1cc
[<6002bbbc>] ? mconsole\_reply+0x48/0x50
[<6003379c>] ? um\_set\_signals+0x3b/0x43
[<60061c55>] ? update\_min\_vruntime+0x14/0x70
[<6006251f>] ? dequeue\_task\_fair+0x164/0x235
[<600620aa>] ? update\_cfs\_group+0x0/0x40
[<603a0e77>] ? \_\_schedule+0x0/0x3ed
[<60033761>] ? um\_set\_signals+0x0/0x43
[<6002af6a>] mc\_work\_proc+0x77/0x91
[<600520b4>] process\_scheduled\_works+0x1af/0x2c3
[<6004ede3>] ? assign\_work+0x0/0x58
[<600527a1>] worker\_thread+0x2f7/0x37a
[<6004ee3b>] ? set\_pf\_worker+0x0/0x64
[<6005765d>] ? arch\_local\_irq\_save+0x0/0x2d
[<60058e07>] ? kthread\_exit+0x0/0x3a
[<600524aa>] ? worker\_thread+0x0/0x37a
[<60058f9f>] kthread+0x130/0x135
[<6002068e>] new\_thread\_handler+0x85/0xb6
Cc: stable@vger.kernel.org
Signed-off-by: Tiwei Bie <tiwei.btw@antgroup.com>
Acked-By: Anton Ivanov <anton.ivanov@cambridgegreys.com>
Link: [https://patch.msgid.link/20241104163203.435515-3-tiwei.btw@antgroup.com](https://patch.msgid.link/20241104163203.435515-3-tiwei.btw%40antgroup.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec)

| -rw-r--r-- | [arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/ubd_kern.c?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/um/drivers/ubd\_kern.c b/arch/um/drivers/ubd\_kern.cindex 7f28ec1929dc0b..119df766270021 100644--- a/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=58b1e84886a0c1ae6b49b006e6b9198b555281e5)+++ b/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=e6e5a4cded9bef3a1b0a4fac815b7176eb9a18ec)@@ -779,7 +779,7 @@ static int ubd\_open\_dev(struct ubd \*ubd\_dev)  static void ubd\_device\_release(struct device \*dev) {- struct ubd \*ubd\_dev = dev\_get\_drvdata(dev);+ struct ubd \*ubd\_dev = container\_of(dev, struct ubd, pdev.dev);  blk\_mq\_free\_tag\_set(&ubd\_dev->tag\_set); \*ubd\_dev = ((struct ubd) DEFAULT\_UBD); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:11:53 +0000



=== Content from git.kernel.org_9e7710ce_20250114_181314.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5727343348f34e11a7c5a2a944d5aa505731d876)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5727343348f34e11a7c5a2a944d5aa505731d876)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5727343348f34e11a7c5a2a944d5aa505731d876)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5727343348f34e11a7c5a2a944d5aa505731d876)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tiwei Bie <tiwei.btw@antgroup.com> | 2024-11-05 00:32:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:16 +0100 |
| commit | [5727343348f34e11a7c5a2a944d5aa505731d876](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5727343348f34e11a7c5a2a944d5aa505731d876) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5727343348f34e11a7c5a2a944d5aa505731d876)) | |
| tree | [0e3b47475086d60a029b6140cbd2adb3bb17ea0e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5727343348f34e11a7c5a2a944d5aa505731d876) | |
| parent | [3b22047378eff22d48cfac9699a95087b91a6347](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b22047378eff22d48cfac9699a95087b91a6347) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5727343348f34e11a7c5a2a944d5aa505731d876&id2=3b22047378eff22d48cfac9699a95087b91a6347)) | |
| download | [linux-5727343348f34e11a7c5a2a944d5aa505731d876.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5727343348f34e11a7c5a2a944d5aa505731d876.tar.gz) | |

um: ubd: Do not use drvdata in releasecommit 5bee35e5389f450a7eea7318deb9073e9414d3b1 upstream.
The drvdata is not available in release. Let's just use container\_of()
to get the ubd instance. Otherwise, removing a ubd device will result
in a crash:
RIP: 0033:blk\_mq\_free\_tag\_set+0x1f/0xba
RSP: 00000000e2083bf0 EFLAGS: 00010246
RAX: 000000006021463a RBX: 0000000000000348 RCX: 0000000062604d00
RDX: 0000000004208060 RSI: 00000000605241a0 RDI: 0000000000000348
RBP: 00000000e2083c10 R08: 0000000062414010 R09: 00000000601603f7
R10: 000000000000133a R11: 000000006038c4bd R12: 0000000000000000
R13: 0000000060213a5c R14: 0000000062405d20 R15: 00000000604f7aa0
Kernel panic - not syncing: Segfault with no mm
CPU: 0 PID: 17 Comm: kworker/0:1 Not tainted 6.8.0-rc3-00107-gba3f67c11638 #1
Workqueue: events mc\_work\_proc
Stack:
00000000 604f7ef0 62c5d000 62405d20
e2083c30 6002c776 6002c755 600e47ff
e2083c60 6025ffe3 04208060 603d36e0
Call Trace:
[<6002c776>] ubd\_device\_release+0x21/0x55
[<6002c755>] ? ubd\_device\_release+0x0/0x55
[<600e47ff>] ? kfree+0x0/0x100
[<6025ffe3>] device\_release+0x70/0xba
[<60381d6a>] kobject\_put+0xb5/0xe2
[<6026027b>] put\_device+0x19/0x1c
[<6026a036>] platform\_device\_put+0x26/0x29
[<6026ac5a>] platform\_device\_unregister+0x2c/0x2e
[<6002c52e>] ubd\_remove+0xb8/0xd6
[<6002bb74>] ? mconsole\_reply+0x0/0x50
[<6002b926>] mconsole\_remove+0x160/0x1cc
[<6002bbbc>] ? mconsole\_reply+0x48/0x50
[<6003379c>] ? um\_set\_signals+0x3b/0x43
[<60061c55>] ? update\_min\_vruntime+0x14/0x70
[<6006251f>] ? dequeue\_task\_fair+0x164/0x235
[<600620aa>] ? update\_cfs\_group+0x0/0x40
[<603a0e77>] ? \_\_schedule+0x0/0x3ed
[<60033761>] ? um\_set\_signals+0x0/0x43
[<6002af6a>] mc\_work\_proc+0x77/0x91
[<600520b4>] process\_scheduled\_works+0x1af/0x2c3
[<6004ede3>] ? assign\_work+0x0/0x58
[<600527a1>] worker\_thread+0x2f7/0x37a
[<6004ee3b>] ? set\_pf\_worker+0x0/0x64
[<6005765d>] ? arch\_local\_irq\_save+0x0/0x2d
[<60058e07>] ? kthread\_exit+0x0/0x3a
[<600524aa>] ? worker\_thread+0x0/0x37a
[<60058f9f>] kthread+0x130/0x135
[<6002068e>] new\_thread\_handler+0x85/0xb6
Cc: stable@vger.kernel.org
Signed-off-by: Tiwei Bie <tiwei.btw@antgroup.com>
Acked-By: Anton Ivanov <anton.ivanov@cambridgegreys.com>
Link: [https://patch.msgid.link/20241104163203.435515-3-tiwei.btw@antgroup.com](https://patch.msgid.link/20241104163203.435515-3-tiwei.btw%40antgroup.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5727343348f34e11a7c5a2a944d5aa505731d876)

| -rw-r--r-- | [arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/ubd_kern.c?id=5727343348f34e11a7c5a2a944d5aa505731d876) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/um/drivers/ubd\_kern.c b/arch/um/drivers/ubd\_kern.cindex b3a4cc5a2091fb..b5f3fa514be16b 100644--- a/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=3b22047378eff22d48cfac9699a95087b91a6347)+++ b/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=5727343348f34e11a7c5a2a944d5aa505731d876)@@ -814,7 +814,7 @@ static int ubd\_open\_dev(struct ubd \*ubd\_dev)  static void ubd\_device\_release(struct device \*dev) {- struct ubd \*ubd\_dev = dev\_get\_drvdata(dev);+ struct ubd \*ubd\_dev = container\_of(dev, struct ubd, pdev.dev);  blk\_mq\_free\_tag\_set(&ubd\_dev->tag\_set); \*ubd\_dev = ((struct ubd) DEFAULT\_UBD); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:11:51 +0000



=== Content from git.kernel.org_15af27a9_20250114_181313.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=300e277e463e6326938dd55ea560eafa0f5c88a5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=300e277e463e6326938dd55ea560eafa0f5c88a5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=300e277e463e6326938dd55ea560eafa0f5c88a5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=300e277e463e6326938dd55ea560eafa0f5c88a5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tiwei Bie <tiwei.btw@antgroup.com> | 2024-11-05 00:32:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:37 +0100 |
| commit | [300e277e463e6326938dd55ea560eafa0f5c88a5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=300e277e463e6326938dd55ea560eafa0f5c88a5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=300e277e463e6326938dd55ea560eafa0f5c88a5)) | |
| tree | [ed9caa5a8d44e4334171d85ddc838a4c86da2a57](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=300e277e463e6326938dd55ea560eafa0f5c88a5) | |
| parent | [7cf819ea3774f16509914ffa6818c7ba132a4e2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7cf819ea3774f16509914ffa6818c7ba132a4e2f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=300e277e463e6326938dd55ea560eafa0f5c88a5&id2=7cf819ea3774f16509914ffa6818c7ba132a4e2f)) | |
| download | [linux-300e277e463e6326938dd55ea560eafa0f5c88a5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-300e277e463e6326938dd55ea560eafa0f5c88a5.tar.gz) | |

um: ubd: Do not use drvdata in releasecommit 5bee35e5389f450a7eea7318deb9073e9414d3b1 upstream.
The drvdata is not available in release. Let's just use container\_of()
to get the ubd instance. Otherwise, removing a ubd device will result
in a crash:
RIP: 0033:blk\_mq\_free\_tag\_set+0x1f/0xba
RSP: 00000000e2083bf0 EFLAGS: 00010246
RAX: 000000006021463a RBX: 0000000000000348 RCX: 0000000062604d00
RDX: 0000000004208060 RSI: 00000000605241a0 RDI: 0000000000000348
RBP: 00000000e2083c10 R08: 0000000062414010 R09: 00000000601603f7
R10: 000000000000133a R11: 000000006038c4bd R12: 0000000000000000
R13: 0000000060213a5c R14: 0000000062405d20 R15: 00000000604f7aa0
Kernel panic - not syncing: Segfault with no mm
CPU: 0 PID: 17 Comm: kworker/0:1 Not tainted 6.8.0-rc3-00107-gba3f67c11638 #1
Workqueue: events mc\_work\_proc
Stack:
00000000 604f7ef0 62c5d000 62405d20
e2083c30 6002c776 6002c755 600e47ff
e2083c60 6025ffe3 04208060 603d36e0
Call Trace:
[<6002c776>] ubd\_device\_release+0x21/0x55
[<6002c755>] ? ubd\_device\_release+0x0/0x55
[<600e47ff>] ? kfree+0x0/0x100
[<6025ffe3>] device\_release+0x70/0xba
[<60381d6a>] kobject\_put+0xb5/0xe2
[<6026027b>] put\_device+0x19/0x1c
[<6026a036>] platform\_device\_put+0x26/0x29
[<6026ac5a>] platform\_device\_unregister+0x2c/0x2e
[<6002c52e>] ubd\_remove+0xb8/0xd6
[<6002bb74>] ? mconsole\_reply+0x0/0x50
[<6002b926>] mconsole\_remove+0x160/0x1cc
[<6002bbbc>] ? mconsole\_reply+0x48/0x50
[<6003379c>] ? um\_set\_signals+0x3b/0x43
[<60061c55>] ? update\_min\_vruntime+0x14/0x70
[<6006251f>] ? dequeue\_task\_fair+0x164/0x235
[<600620aa>] ? update\_cfs\_group+0x0/0x40
[<603a0e77>] ? \_\_schedule+0x0/0x3ed
[<60033761>] ? um\_set\_signals+0x0/0x43
[<6002af6a>] mc\_work\_proc+0x77/0x91
[<600520b4>] process\_scheduled\_works+0x1af/0x2c3
[<6004ede3>] ? assign\_work+0x0/0x58
[<600527a1>] worker\_thread+0x2f7/0x37a
[<6004ee3b>] ? set\_pf\_worker+0x0/0x64
[<6005765d>] ? arch\_local\_irq\_save+0x0/0x2d
[<60058e07>] ? kthread\_exit+0x0/0x3a
[<600524aa>] ? worker\_thread+0x0/0x37a
[<60058f9f>] kthread+0x130/0x135
[<6002068e>] new\_thread\_handler+0x85/0xb6
Cc: stable@vger.kernel.org
Signed-off-by: Tiwei Bie <tiwei.btw@antgroup.com>
Acked-By: Anton Ivanov <anton.ivanov@cambridgegreys.com>
Link: [https://patch.msgid.link/20241104163203.435515-3-tiwei.btw@antgroup.com](https://patch.msgid.link/20241104163203.435515-3-tiwei.btw%40antgroup.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=300e277e463e6326938dd55ea560eafa0f5c88a5)

| -rw-r--r-- | [arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/ubd_kern.c?id=300e277e463e6326938dd55ea560eafa0f5c88a5) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/um/drivers/ubd\_kern.c b/arch/um/drivers/ubd\_kern.cindex a4e531f0e3b96f..70d3e46774431a 100644--- a/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=7cf819ea3774f16509914ffa6818c7ba132a4e2f)+++ b/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=300e277e463e6326938dd55ea560eafa0f5c88a5)@@ -860,7 +860,7 @@ static int ubd\_open\_dev(struct ubd \*ubd\_dev)  static void ubd\_device\_release(struct device \*dev) {- struct ubd \*ubd\_dev = dev\_get\_drvdata(dev);+ struct ubd \*ubd\_dev = container\_of(dev, struct ubd, pdev.dev);  blk\_cleanup\_queue(ubd\_dev->queue); blk\_mq\_free\_tag\_set(&ubd\_dev->tag\_set); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:11:50 +0000



=== Content from git.kernel.org_16a0df17_20250114_181312.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tiwei Bie <tiwei.btw@antgroup.com> | 2024-11-05 00:32:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:40 +0100 |
| commit | [23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8)) | |
| tree | [ff90f76d0dc150083939f646d4beefdb773cdd2c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8) | |
| parent | [4c63baf19ec3bbf687dcdcf3ae62909e6447f572](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c63baf19ec3bbf687dcdcf3ae62909e6447f572) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8&id2=4c63baf19ec3bbf687dcdcf3ae62909e6447f572)) | |
| download | [linux-23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8.tar.gz) | |

um: ubd: Do not use drvdata in releasecommit 5bee35e5389f450a7eea7318deb9073e9414d3b1 upstream.
The drvdata is not available in release. Let's just use container\_of()
to get the ubd instance. Otherwise, removing a ubd device will result
in a crash:
RIP: 0033:blk\_mq\_free\_tag\_set+0x1f/0xba
RSP: 00000000e2083bf0 EFLAGS: 00010246
RAX: 000000006021463a RBX: 0000000000000348 RCX: 0000000062604d00
RDX: 0000000004208060 RSI: 00000000605241a0 RDI: 0000000000000348
RBP: 00000000e2083c10 R08: 0000000062414010 R09: 00000000601603f7
R10: 000000000000133a R11: 000000006038c4bd R12: 0000000000000000
R13: 0000000060213a5c R14: 0000000062405d20 R15: 00000000604f7aa0
Kernel panic - not syncing: Segfault with no mm
CPU: 0 PID: 17 Comm: kworker/0:1 Not tainted 6.8.0-rc3-00107-gba3f67c11638 #1
Workqueue: events mc\_work\_proc
Stack:
00000000 604f7ef0 62c5d000 62405d20
e2083c30 6002c776 6002c755 600e47ff
e2083c60 6025ffe3 04208060 603d36e0
Call Trace:
[<6002c776>] ubd\_device\_release+0x21/0x55
[<6002c755>] ? ubd\_device\_release+0x0/0x55
[<600e47ff>] ? kfree+0x0/0x100
[<6025ffe3>] device\_release+0x70/0xba
[<60381d6a>] kobject\_put+0xb5/0xe2
[<6026027b>] put\_device+0x19/0x1c
[<6026a036>] platform\_device\_put+0x26/0x29
[<6026ac5a>] platform\_device\_unregister+0x2c/0x2e
[<6002c52e>] ubd\_remove+0xb8/0xd6
[<6002bb74>] ? mconsole\_reply+0x0/0x50
[<6002b926>] mconsole\_remove+0x160/0x1cc
[<6002bbbc>] ? mconsole\_reply+0x48/0x50
[<6003379c>] ? um\_set\_signals+0x3b/0x43
[<60061c55>] ? update\_min\_vruntime+0x14/0x70
[<6006251f>] ? dequeue\_task\_fair+0x164/0x235
[<600620aa>] ? update\_cfs\_group+0x0/0x40
[<603a0e77>] ? \_\_schedule+0x0/0x3ed
[<60033761>] ? um\_set\_signals+0x0/0x43
[<6002af6a>] mc\_work\_proc+0x77/0x91
[<600520b4>] process\_scheduled\_works+0x1af/0x2c3
[<6004ede3>] ? assign\_work+0x0/0x58
[<600527a1>] worker\_thread+0x2f7/0x37a
[<6004ee3b>] ? set\_pf\_worker+0x0/0x64
[<6005765d>] ? arch\_local\_irq\_save+0x0/0x2d
[<60058e07>] ? kthread\_exit+0x0/0x3a
[<600524aa>] ? worker\_thread+0x0/0x37a
[<60058f9f>] kthread+0x130/0x135
[<6002068e>] new\_thread\_handler+0x85/0xb6
Cc: stable@vger.kernel.org
Signed-off-by: Tiwei Bie <tiwei.btw@antgroup.com>
Acked-By: Anton Ivanov <anton.ivanov@cambridgegreys.com>
Link: [https://patch.msgid.link/20241104163203.435515-3-tiwei.btw@antgroup.com](https://patch.msgid.link/20241104163203.435515-3-tiwei.btw%40antgroup.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8)

| -rw-r--r-- | [arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/ubd_kern.c?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/um/drivers/ubd\_kern.c b/arch/um/drivers/ubd\_kern.cindex 4a32df89a491e8..7f82f1fbb8917c 100644--- a/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=4c63baf19ec3bbf687dcdcf3ae62909e6447f572)+++ b/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=23d742a3fcd4781eed015a3a93e6a0e3ab1ef2a8)@@ -854,7 +854,7 @@ static int ubd\_open\_dev(struct ubd \*ubd\_dev)  static void ubd\_device\_release(struct device \*dev) {- struct ubd \*ubd\_dev = dev\_get\_drvdata(dev);+ struct ubd \*ubd\_dev = container\_of(dev, struct ubd, pdev.dev);  blk\_cleanup\_queue(ubd\_dev->queue); \*ubd\_dev = ((struct ubd) DEFAULT\_UBD); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:11:49 +0000



=== Content from git.kernel.org_58725aaf_20250114_181313.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2d194d951895df214e066d08146e77cb6e02c1d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d194d951895df214e066d08146e77cb6e02c1d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d194d951895df214e066d08146e77cb6e02c1d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d194d951895df214e066d08146e77cb6e02c1d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tiwei Bie <tiwei.btw@antgroup.com> | 2024-11-05 00:32:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:49 +0100 |
| commit | [2d194d951895df214e066d08146e77cb6e02c1d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d194d951895df214e066d08146e77cb6e02c1d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2d194d951895df214e066d08146e77cb6e02c1d4)) | |
| tree | [f708dd913f918ff20845e5dffcbe9ef6251980ab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d194d951895df214e066d08146e77cb6e02c1d4) | |
| parent | [5e1feafa7347593f85e11c0fdd9b5bfffb373fb4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e1feafa7347593f85e11c0fdd9b5bfffb373fb4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d194d951895df214e066d08146e77cb6e02c1d4&id2=5e1feafa7347593f85e11c0fdd9b5bfffb373fb4)) | |
| download | [linux-2d194d951895df214e066d08146e77cb6e02c1d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2d194d951895df214e066d08146e77cb6e02c1d4.tar.gz) | |

um: ubd: Do not use drvdata in releasecommit 5bee35e5389f450a7eea7318deb9073e9414d3b1 upstream.
The drvdata is not available in release. Let's just use container\_of()
to get the ubd instance. Otherwise, removing a ubd device will result
in a crash:
RIP: 0033:blk\_mq\_free\_tag\_set+0x1f/0xba
RSP: 00000000e2083bf0 EFLAGS: 00010246
RAX: 000000006021463a RBX: 0000000000000348 RCX: 0000000062604d00
RDX: 0000000004208060 RSI: 00000000605241a0 RDI: 0000000000000348
RBP: 00000000e2083c10 R08: 0000000062414010 R09: 00000000601603f7
R10: 000000000000133a R11: 000000006038c4bd R12: 0000000000000000
R13: 0000000060213a5c R14: 0000000062405d20 R15: 00000000604f7aa0
Kernel panic - not syncing: Segfault with no mm
CPU: 0 PID: 17 Comm: kworker/0:1 Not tainted 6.8.0-rc3-00107-gba3f67c11638 #1
Workqueue: events mc\_work\_proc
Stack:
00000000 604f7ef0 62c5d000 62405d20
e2083c30 6002c776 6002c755 600e47ff
e2083c60 6025ffe3 04208060 603d36e0
Call Trace:
[<6002c776>] ubd\_device\_release+0x21/0x55
[<6002c755>] ? ubd\_device\_release+0x0/0x55
[<600e47ff>] ? kfree+0x0/0x100
[<6025ffe3>] device\_release+0x70/0xba
[<60381d6a>] kobject\_put+0xb5/0xe2
[<6026027b>] put\_device+0x19/0x1c
[<6026a036>] platform\_device\_put+0x26/0x29
[<6026ac5a>] platform\_device\_unregister+0x2c/0x2e
[<6002c52e>] ubd\_remove+0xb8/0xd6
[<6002bb74>] ? mconsole\_reply+0x0/0x50
[<6002b926>] mconsole\_remove+0x160/0x1cc
[<6002bbbc>] ? mconsole\_reply+0x48/0x50
[<6003379c>] ? um\_set\_signals+0x3b/0x43
[<60061c55>] ? update\_min\_vruntime+0x14/0x70
[<6006251f>] ? dequeue\_task\_fair+0x164/0x235
[<600620aa>] ? update\_cfs\_group+0x0/0x40
[<603a0e77>] ? \_\_schedule+0x0/0x3ed
[<60033761>] ? um\_set\_signals+0x0/0x43
[<6002af6a>] mc\_work\_proc+0x77/0x91
[<600520b4>] process\_scheduled\_works+0x1af/0x2c3
[<6004ede3>] ? assign\_work+0x0/0x58
[<600527a1>] worker\_thread+0x2f7/0x37a
[<6004ee3b>] ? set\_pf\_worker+0x0/0x64
[<6005765d>] ? arch\_local\_irq\_save+0x0/0x2d
[<60058e07>] ? kthread\_exit+0x0/0x3a
[<600524aa>] ? worker\_thread+0x0/0x37a
[<60058f9f>] kthread+0x130/0x135
[<6002068e>] new\_thread\_handler+0x85/0xb6
Cc: stable@vger.kernel.org
Signed-off-by: Tiwei Bie <tiwei.btw@antgroup.com>
Acked-By: Anton Ivanov <anton.ivanov@cambridgegreys.com>
Link: [https://patch.msgid.link/20241104163203.435515-3-tiwei.btw@antgroup.com](https://patch.msgid.link/20241104163203.435515-3-tiwei.btw%40antgroup.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d194d951895df214e066d08146e77cb6e02c1d4)

| -rw-r--r-- | [arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/ubd_kern.c?id=2d194d951895df214e066d08146e77cb6e02c1d4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/um/drivers/ubd\_kern.c b/arch/um/drivers/ubd\_kern.cindex ef7b4b911a455a..7ddda2c0ae436f 100644--- a/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=5e1feafa7347593f85e11c0fdd9b5bfffb373fb4)+++ b/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=2d194d951895df214e066d08146e77cb6e02c1d4)@@ -799,7 +799,7 @@ static int ubd\_open\_dev(struct ubd \*ubd\_dev)  static void ubd\_device\_release(struct device \*dev) {- struct ubd \*ubd\_dev = dev\_get\_drvdata(dev);+ struct ubd \*ubd\_dev = container\_of(dev, struct ubd, pdev.dev);  blk\_mq\_free\_tag\_set(&ubd\_dev->tag\_set); \*ubd\_dev = ((struct ubd) DEFAULT\_UBD); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:11:50 +0000



=== Content from git.kernel.org_4a90d2c1_20250114_181312.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=16cf8511680809a9f20b3dd224c06d482648f9e2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16cf8511680809a9f20b3dd224c06d482648f9e2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16cf8511680809a9f20b3dd224c06d482648f9e2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16cf8511680809a9f20b3dd224c06d482648f9e2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tiwei Bie <tiwei.btw@antgroup.com> | 2024-11-05 00:32:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:53 +0100 |
| commit | [16cf8511680809a9f20b3dd224c06d482648f9e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16cf8511680809a9f20b3dd224c06d482648f9e2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=16cf8511680809a9f20b3dd224c06d482648f9e2)) | |
| tree | [91be8db5dab4f7784597dbda3649a15e6ba64d18](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16cf8511680809a9f20b3dd224c06d482648f9e2) | |
| parent | [6a72e933f20d719c8041425950a4009257a5c7a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a72e933f20d719c8041425950a4009257a5c7a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16cf8511680809a9f20b3dd224c06d482648f9e2&id2=6a72e933f20d719c8041425950a4009257a5c7a6)) | |
| download | [linux-16cf8511680809a9f20b3dd224c06d482648f9e2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-16cf8511680809a9f20b3dd224c06d482648f9e2.tar.gz) | |

um: ubd: Do not use drvdata in releasecommit 5bee35e5389f450a7eea7318deb9073e9414d3b1 upstream.
The drvdata is not available in release. Let's just use container\_of()
to get the ubd instance. Otherwise, removing a ubd device will result
in a crash:
RIP: 0033:blk\_mq\_free\_tag\_set+0x1f/0xba
RSP: 00000000e2083bf0 EFLAGS: 00010246
RAX: 000000006021463a RBX: 0000000000000348 RCX: 0000000062604d00
RDX: 0000000004208060 RSI: 00000000605241a0 RDI: 0000000000000348
RBP: 00000000e2083c10 R08: 0000000062414010 R09: 00000000601603f7
R10: 000000000000133a R11: 000000006038c4bd R12: 0000000000000000
R13: 0000000060213a5c R14: 0000000062405d20 R15: 00000000604f7aa0
Kernel panic - not syncing: Segfault with no mm
CPU: 0 PID: 17 Comm: kworker/0:1 Not tainted 6.8.0-rc3-00107-gba3f67c11638 #1
Workqueue: events mc\_work\_proc
Stack:
00000000 604f7ef0 62c5d000 62405d20
e2083c30 6002c776 6002c755 600e47ff
e2083c60 6025ffe3 04208060 603d36e0
Call Trace:
[<6002c776>] ubd\_device\_release+0x21/0x55
[<6002c755>] ? ubd\_device\_release+0x0/0x55
[<600e47ff>] ? kfree+0x0/0x100
[<6025ffe3>] device\_release+0x70/0xba
[<60381d6a>] kobject\_put+0xb5/0xe2
[<6026027b>] put\_device+0x19/0x1c
[<6026a036>] platform\_device\_put+0x26/0x29
[<6026ac5a>] platform\_device\_unregister+0x2c/0x2e
[<6002c52e>] ubd\_remove+0xb8/0xd6
[<6002bb74>] ? mconsole\_reply+0x0/0x50
[<6002b926>] mconsole\_remove+0x160/0x1cc
[<6002bbbc>] ? mconsole\_reply+0x48/0x50
[<6003379c>] ? um\_set\_signals+0x3b/0x43
[<60061c55>] ? update\_min\_vruntime+0x14/0x70
[<6006251f>] ? dequeue\_task\_fair+0x164/0x235
[<600620aa>] ? update\_cfs\_group+0x0/0x40
[<603a0e77>] ? \_\_schedule+0x0/0x3ed
[<60033761>] ? um\_set\_signals+0x0/0x43
[<6002af6a>] mc\_work\_proc+0x77/0x91
[<600520b4>] process\_scheduled\_works+0x1af/0x2c3
[<6004ede3>] ? assign\_work+0x0/0x58
[<600527a1>] worker\_thread+0x2f7/0x37a
[<6004ee3b>] ? set\_pf\_worker+0x0/0x64
[<6005765d>] ? arch\_local\_irq\_save+0x0/0x2d
[<60058e07>] ? kthread\_exit+0x0/0x3a
[<600524aa>] ? worker\_thread+0x0/0x37a
[<60058f9f>] kthread+0x130/0x135
[<6002068e>] new\_thread\_handler+0x85/0xb6
Cc: stable@vger.kernel.org
Signed-off-by: Tiwei Bie <tiwei.btw@antgroup.com>
Acked-By: Anton Ivanov <anton.ivanov@cambridgegreys.com>
Link: [https://patch.msgid.link/20241104163203.435515-3-tiwei.btw@antgroup.com](https://patch.msgid.link/20241104163203.435515-3-tiwei.btw%40antgroup.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16cf8511680809a9f20b3dd224c06d482648f9e2)

| -rw-r--r-- | [arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/ubd_kern.c?id=16cf8511680809a9f20b3dd224c06d482648f9e2) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/um/drivers/ubd\_kern.c b/arch/um/drivers/ubd\_kern.cindex 7f28ec1929dc0b..119df766270021 100644--- a/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=6a72e933f20d719c8041425950a4009257a5c7a6)+++ b/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=16cf8511680809a9f20b3dd224c06d482648f9e2)@@ -779,7 +779,7 @@ static int ubd\_open\_dev(struct ubd \*ubd\_dev)  static void ubd\_device\_release(struct device \*dev) {- struct ubd \*ubd\_dev = dev\_get\_drvdata(dev);+ struct ubd \*ubd\_dev = container\_of(dev, struct ubd, pdev.dev);  blk\_mq\_free\_tag\_set(&ubd\_dev->tag\_set); \*ubd\_dev = ((struct ubd) DEFAULT\_UBD); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:11:49 +0000



=== Content from git.kernel.org_e2566469_20250114_181314.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=509ba8746f812e45a05034ba18b73db574693d11)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=509ba8746f812e45a05034ba18b73db574693d11)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=509ba8746f812e45a05034ba18b73db574693d11)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=509ba8746f812e45a05034ba18b73db574693d11)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tiwei Bie <tiwei.btw@antgroup.com> | 2024-11-05 00:32:01 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:10 +0100 |
| commit | [509ba8746f812e45a05034ba18b73db574693d11](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=509ba8746f812e45a05034ba18b73db574693d11) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=509ba8746f812e45a05034ba18b73db574693d11)) | |
| tree | [b6eedda09a005d64114abbe24a1f875d91e983ad](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=509ba8746f812e45a05034ba18b73db574693d11) | |
| parent | [0f6737cad88b016ddd0c7c69320bdd0e38eeda85](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f6737cad88b016ddd0c7c69320bdd0e38eeda85) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=509ba8746f812e45a05034ba18b73db574693d11&id2=0f6737cad88b016ddd0c7c69320bdd0e38eeda85)) | |
| download | [linux-509ba8746f812e45a05034ba18b73db574693d11.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-509ba8746f812e45a05034ba18b73db574693d11.tar.gz) | |

um: ubd: Do not use drvdata in releasecommit 5bee35e5389f450a7eea7318deb9073e9414d3b1 upstream.
The drvdata is not available in release. Let's just use container\_of()
to get the ubd instance. Otherwise, removing a ubd device will result
in a crash:
RIP: 0033:blk\_mq\_free\_tag\_set+0x1f/0xba
RSP: 00000000e2083bf0 EFLAGS: 00010246
RAX: 000000006021463a RBX: 0000000000000348 RCX: 0000000062604d00
RDX: 0000000004208060 RSI: 00000000605241a0 RDI: 0000000000000348
RBP: 00000000e2083c10 R08: 0000000062414010 R09: 00000000601603f7
R10: 000000000000133a R11: 000000006038c4bd R12: 0000000000000000
R13: 0000000060213a5c R14: 0000000062405d20 R15: 00000000604f7aa0
Kernel panic - not syncing: Segfault with no mm
CPU: 0 PID: 17 Comm: kworker/0:1 Not tainted 6.8.0-rc3-00107-gba3f67c11638 #1
Workqueue: events mc\_work\_proc
Stack:
00000000 604f7ef0 62c5d000 62405d20
e2083c30 6002c776 6002c755 600e47ff
e2083c60 6025ffe3 04208060 603d36e0
Call Trace:
[<6002c776>] ubd\_device\_release+0x21/0x55
[<6002c755>] ? ubd\_device\_release+0x0/0x55
[<600e47ff>] ? kfree+0x0/0x100
[<6025ffe3>] device\_release+0x70/0xba
[<60381d6a>] kobject\_put+0xb5/0xe2
[<6026027b>] put\_device+0x19/0x1c
[<6026a036>] platform\_device\_put+0x26/0x29
[<6026ac5a>] platform\_device\_unregister+0x2c/0x2e
[<6002c52e>] ubd\_remove+0xb8/0xd6
[<6002bb74>] ? mconsole\_reply+0x0/0x50
[<6002b926>] mconsole\_remove+0x160/0x1cc
[<6002bbbc>] ? mconsole\_reply+0x48/0x50
[<6003379c>] ? um\_set\_signals+0x3b/0x43
[<60061c55>] ? update\_min\_vruntime+0x14/0x70
[<6006251f>] ? dequeue\_task\_fair+0x164/0x235
[<600620aa>] ? update\_cfs\_group+0x0/0x40
[<603a0e77>] ? \_\_schedule+0x0/0x3ed
[<60033761>] ? um\_set\_signals+0x0/0x43
[<6002af6a>] mc\_work\_proc+0x77/0x91
[<600520b4>] process\_scheduled\_works+0x1af/0x2c3
[<6004ede3>] ? assign\_work+0x0/0x58
[<600527a1>] worker\_thread+0x2f7/0x37a
[<6004ee3b>] ? set\_pf\_worker+0x0/0x64
[<6005765d>] ? arch\_local\_irq\_save+0x0/0x2d
[<60058e07>] ? kthread\_exit+0x0/0x3a
[<600524aa>] ? worker\_thread+0x0/0x37a
[<60058f9f>] kthread+0x130/0x135
[<6002068e>] new\_thread\_handler+0x85/0xb6
Cc: stable@vger.kernel.org
Signed-off-by: Tiwei Bie <tiwei.btw@antgroup.com>
Acked-By: Anton Ivanov <anton.ivanov@cambridgegreys.com>
Link: [https://patch.msgid.link/20241104163203.435515-3-tiwei.btw@antgroup.com](https://patch.msgid.link/20241104163203.435515-3-tiwei.btw%40antgroup.com)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=509ba8746f812e45a05034ba18b73db574693d11)

| -rw-r--r-- | [arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/ubd_kern.c?id=509ba8746f812e45a05034ba18b73db574693d11) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/arch/um/drivers/ubd\_kern.c b/arch/um/drivers/ubd\_kern.cindex de28ce711687e8..7a66b88275cf75 100644--- a/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=0f6737cad88b016ddd0c7c69320bdd0e38eeda85)+++ b/[arch/um/drivers/ubd\_kern.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/ubd_kern.c?id=509ba8746f812e45a05034ba18b73db574693d11)@@ -861,7 +861,7 @@ static int ubd\_open\_dev(struct ubd \*ubd\_dev)  static void ubd\_device\_release(struct device \*dev) {- struct ubd \*ubd\_dev = dev\_get\_drvdata(dev);+ struct ubd \*ubd\_dev = container\_of(dev, struct ubd, pdev.dev);  blk\_cleanup\_queue(ubd\_dev->queue); blk\_mq\_free\_tag\_set(&ubd\_dev->tag\_set); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:11:51 +0000


