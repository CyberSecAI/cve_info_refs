=== Content from git.kernel.org_7db76c29_20250115_083803.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4f946479b326a3cbb193f2b8368aed9269514c35)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f946479b326a3cbb193f2b8368aed9269514c35)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f946479b326a3cbb193f2b8368aed9269514c35)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f946479b326a3cbb193f2b8368aed9269514c35)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hannes Reinecke <hare@suse.de> | 2024-10-02 13:51:41 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 15:07:20 +0100 |
| commit | [4f946479b326a3cbb193f2b8368aed9269514c35](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f946479b326a3cbb193f2b8368aed9269514c35) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4f946479b326a3cbb193f2b8368aed9269514c35)) | |
| tree | [b68bb1a18329b3230af342060ffa7a91998e149d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f946479b326a3cbb193f2b8368aed9269514c35) | |
| parent | [94a4d966f7e25da74ba5617d793b36a8addebfed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94a4d966f7e25da74ba5617d793b36a8addebfed) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f946479b326a3cbb193f2b8368aed9269514c35&id2=94a4d966f7e25da74ba5617d793b36a8addebfed)) | |
| download | [linux-4f946479b326a3cbb193f2b8368aed9269514c35.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4f946479b326a3cbb193f2b8368aed9269514c35.tar.gz) | |

nvme: tcp: avoid race between queue\_lock lock and destroy[ Upstream commit 782373ba27660ba7d330208cf5509ece6feb4545 ]
Commit 76d54bf20cdc ("nvme-tcp: don't access released socket during
error recovery") added a mutex\_lock() call for the queue->queue\_lock
in nvme\_tcp\_get\_address(). However, the mutex\_lock() races with
mutex\_destroy() in nvme\_tcp\_free\_queue(), and causes the WARN below.
DEBUG\_LOCKS\_WARN\_ON(lock->magic != lock)
WARNING: CPU: 3 PID: 34077 at kernel/locking/mutex.c:587 \_\_mutex\_lock+0xcf0/0x1220
Modules linked in: nvmet\_tcp nvmet nvme\_tcp nvme\_fabrics iw\_cm ib\_cm ib\_core pktcdvd nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6 nft\_reject nft\_ct nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables qrtr sunrpc ppdev 9pnet\_virtio 9pnet pcspkr netfs parport\_pc parport e1000 i2c\_piix4 i2c\_smbus loop fuse nfnetlink zram bochs drm\_vram\_helper drm\_ttm\_helper ttm drm\_kms\_helper xfs drm sym53c8xx floppy nvme scsi\_transport\_spi nvme\_core nvme\_auth serio\_raw ata\_generic pata\_acpi dm\_multipath qemu\_fw\_cfg [last unloaded: ib\_uverbs]
CPU: 3 UID: 0 PID: 34077 Comm: udisksd Not tainted 6.11.0-rc7 #319
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:\_\_mutex\_lock+0xcf0/0x1220
Code: 08 84 d2 0f 85 c8 04 00 00 8b 15 ef b6 c8 01 85 d2 0f 85 78 f4 ff ff 48 c7 c6 20 93 ee af 48 c7 c7 60 91 ee af e8 f0 a7 6d fd <0f> 0b e9 5e f4 ff ff 48 b8 00 00 00 00 00 fc ff df 4c 89 f2 48 c1
RSP: 0018:ffff88811305f760 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff88812c652058 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 0000000000000004 RDI: 0000000000000001
RBP: ffff88811305f8b0 R08: 0000000000000001 R09: ffffed1075c36341
R10: ffff8883ae1b1a0b R11: 0000000000010498 R12: 0000000000000000
R13: 0000000000000000 R14: dffffc0000000000 R15: ffff88812c652058
FS: 00007f9713ae4980(0000) GS:ffff8883ae180000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fcd78483c7c CR3: 0000000122c38000 CR4: 00000000000006f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
? \_\_warn.cold+0x5b/0x1af
? \_\_mutex\_lock+0xcf0/0x1220
? report\_bug+0x1ec/0x390
? handle\_bug+0x3c/0x80
? exc\_invalid\_op+0x13/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? \_\_mutex\_lock+0xcf0/0x1220
? nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
? \_\_pfx\_\_\_mutex\_lock+0x10/0x10
? \_\_lock\_acquire+0xd6a/0x59e0
? nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
? \_\_pfx\_nvme\_tcp\_get\_address+0x10/0x10 [nvme\_tcp]
nvme\_sysfs\_show\_address+0x81/0xc0 [nvme\_core]
dev\_attr\_show+0x42/0x80
? \_\_asan\_memset+0x1f/0x40
sysfs\_kf\_seq\_show+0x1f0/0x370
seq\_read\_iter+0x2cb/0x1130
? rw\_verify\_area+0x3b1/0x590
? \_\_mutex\_lock+0x433/0x1220
vfs\_read+0x6a6/0xa20
? lockdep\_hardirqs\_on+0x78/0x100
? \_\_pfx\_vfs\_read+0x10/0x10
ksys\_read+0xf7/0x1d0
? \_\_pfx\_ksys\_read+0x10/0x10
? \_\_x64\_sys\_openat+0x105/0x1d0
do\_syscall\_64+0x93/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? \_\_pfx\_ksys\_read+0x10/0x10
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? do\_syscall\_64+0x9f/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f9713f55cfa
Code: 55 48 89 e5 48 83 ec 20 48 89 55 e8 48 89 75 f0 89 7d f8 e8 e8 74 f8 ff 48 8b 55 e8 48 8b 75 f0 41 89 c0 8b 7d f8 31 c0 0f 05 <48> 3d 00 f0 ff ff 77 2e 44 89 c7 48 89 45 f8 e8 42 75 f8 ff 48 8b
RSP: 002b:00007ffd7f512e70 EFLAGS: 00000246 ORIG\_RAX: 0000000000000000
RAX: ffffffffffffffda RBX: 000055c38f316859 RCX: 00007f9713f55cfa
RDX: 0000000000000fff RSI: 00007ffd7f512eb0 RDI: 0000000000000011
RBP: 00007ffd7f512e90 R08: 0000000000000000 R09: 00000000ffffffff
R10: 0000000000000000 R11: 0000000000000246 R12: 000055c38f317148
R13: 0000000000000000 R14: 00007f96f4004f30 R15: 000055c3b6b623c0
</TASK>
The WARN is observed when the blktests test case nvme/014 is repeated
with tcp transport. It is rare, and 200 times repeat is required to
recreate in some test environments.
To avoid the WARN, check the NVME\_TCP\_Q\_LIVE flag before locking
queue->queue\_lock. The flag is cleared long time before the lock gets
destroyed.
Signed-off-by: Hannes Reinecke <hare@suse.de>
Signed-off-by: Shin'ichiro Kawasaki <shinichiro.kawasaki@wdc.com>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f946479b326a3cbb193f2b8368aed9269514c35)

| -rw-r--r-- | [drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/tcp.c?id=4f946479b326a3cbb193f2b8368aed9269514c35) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/nvme/host/tcp.c b/drivers/nvme/host/tcp.cindex f2fedd25915f96..29489c2c52fb9c 100644--- a/[drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/tcp.c?id=94a4d966f7e25da74ba5617d793b36a8addebfed)+++ b/[drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/tcp.c?id=4f946479b326a3cbb193f2b8368aed9269514c35)@@ -2495,10 +2495,11 @@ static int nvme\_tcp\_get\_address(struct nvme\_ctrl \*ctrl, char \*buf, int size)  len = nvmf\_get\_address(ctrl, buf, size); + if (!test\_bit(NVME\_TCP\_Q\_LIVE, &queue->flags))+ return len;+ mutex\_lock(&queue->queue\_lock); - if (!test\_bit(NVME\_TCP\_Q\_LIVE, &queue->flags))- goto done; ret = kernel\_getsockname(queue->sock, (struct sockaddr \*)&src\_addr); if (ret > 0) { if (len > 0)@@ -2506,7 +2507,7 @@ static int nvme\_tcp\_get\_address(struct nvme\_ctrl \*ctrl, char \*buf, int size) len += scnprintf(buf + len, size - len, "%ssrc\_addr=%pISc\n", (len) ? "," : "", &src\_addr); }-done:+ mutex\_unlock(&queue->queue\_lock);  return len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:36:41 +0000



=== Content from git.kernel.org_067e71c0_20250115_083805.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e15cebc1b21856944b387f4abd03b66bd3d4f027)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e15cebc1b21856944b387f4abd03b66bd3d4f027)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e15cebc1b21856944b387f4abd03b66bd3d4f027)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e15cebc1b21856944b387f4abd03b66bd3d4f027)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hannes Reinecke <hare@suse.de> | 2024-10-02 13:51:41 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 15:09:51 +0100 |
| commit | [e15cebc1b21856944b387f4abd03b66bd3d4f027](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e15cebc1b21856944b387f4abd03b66bd3d4f027) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e15cebc1b21856944b387f4abd03b66bd3d4f027)) | |
| tree | [67839f9f5942a110a38d60e26775756a5ff3a9df](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e15cebc1b21856944b387f4abd03b66bd3d4f027) | |
| parent | [5b8ed6ff190e97084bef54103cced44f4fad474b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b8ed6ff190e97084bef54103cced44f4fad474b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e15cebc1b21856944b387f4abd03b66bd3d4f027&id2=5b8ed6ff190e97084bef54103cced44f4fad474b)) | |
| download | [linux-e15cebc1b21856944b387f4abd03b66bd3d4f027.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e15cebc1b21856944b387f4abd03b66bd3d4f027.tar.gz) | |

nvme: tcp: avoid race between queue\_lock lock and destroy[ Upstream commit 782373ba27660ba7d330208cf5509ece6feb4545 ]
Commit 76d54bf20cdc ("nvme-tcp: don't access released socket during
error recovery") added a mutex\_lock() call for the queue->queue\_lock
in nvme\_tcp\_get\_address(). However, the mutex\_lock() races with
mutex\_destroy() in nvme\_tcp\_free\_queue(), and causes the WARN below.
DEBUG\_LOCKS\_WARN\_ON(lock->magic != lock)
WARNING: CPU: 3 PID: 34077 at kernel/locking/mutex.c:587 \_\_mutex\_lock+0xcf0/0x1220
Modules linked in: nvmet\_tcp nvmet nvme\_tcp nvme\_fabrics iw\_cm ib\_cm ib\_core pktcdvd nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6 nft\_reject nft\_ct nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables qrtr sunrpc ppdev 9pnet\_virtio 9pnet pcspkr netfs parport\_pc parport e1000 i2c\_piix4 i2c\_smbus loop fuse nfnetlink zram bochs drm\_vram\_helper drm\_ttm\_helper ttm drm\_kms\_helper xfs drm sym53c8xx floppy nvme scsi\_transport\_spi nvme\_core nvme\_auth serio\_raw ata\_generic pata\_acpi dm\_multipath qemu\_fw\_cfg [last unloaded: ib\_uverbs]
CPU: 3 UID: 0 PID: 34077 Comm: udisksd Not tainted 6.11.0-rc7 #319
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:\_\_mutex\_lock+0xcf0/0x1220
Code: 08 84 d2 0f 85 c8 04 00 00 8b 15 ef b6 c8 01 85 d2 0f 85 78 f4 ff ff 48 c7 c6 20 93 ee af 48 c7 c7 60 91 ee af e8 f0 a7 6d fd <0f> 0b e9 5e f4 ff ff 48 b8 00 00 00 00 00 fc ff df 4c 89 f2 48 c1
RSP: 0018:ffff88811305f760 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff88812c652058 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 0000000000000004 RDI: 0000000000000001
RBP: ffff88811305f8b0 R08: 0000000000000001 R09: ffffed1075c36341
R10: ffff8883ae1b1a0b R11: 0000000000010498 R12: 0000000000000000
R13: 0000000000000000 R14: dffffc0000000000 R15: ffff88812c652058
FS: 00007f9713ae4980(0000) GS:ffff8883ae180000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fcd78483c7c CR3: 0000000122c38000 CR4: 00000000000006f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
? \_\_warn.cold+0x5b/0x1af
? \_\_mutex\_lock+0xcf0/0x1220
? report\_bug+0x1ec/0x390
? handle\_bug+0x3c/0x80
? exc\_invalid\_op+0x13/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? \_\_mutex\_lock+0xcf0/0x1220
? nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
? \_\_pfx\_\_\_mutex\_lock+0x10/0x10
? \_\_lock\_acquire+0xd6a/0x59e0
? nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
? \_\_pfx\_nvme\_tcp\_get\_address+0x10/0x10 [nvme\_tcp]
nvme\_sysfs\_show\_address+0x81/0xc0 [nvme\_core]
dev\_attr\_show+0x42/0x80
? \_\_asan\_memset+0x1f/0x40
sysfs\_kf\_seq\_show+0x1f0/0x370
seq\_read\_iter+0x2cb/0x1130
? rw\_verify\_area+0x3b1/0x590
? \_\_mutex\_lock+0x433/0x1220
vfs\_read+0x6a6/0xa20
? lockdep\_hardirqs\_on+0x78/0x100
? \_\_pfx\_vfs\_read+0x10/0x10
ksys\_read+0xf7/0x1d0
? \_\_pfx\_ksys\_read+0x10/0x10
? \_\_x64\_sys\_openat+0x105/0x1d0
do\_syscall\_64+0x93/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? \_\_pfx\_ksys\_read+0x10/0x10
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? do\_syscall\_64+0x9f/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f9713f55cfa
Code: 55 48 89 e5 48 83 ec 20 48 89 55 e8 48 89 75 f0 89 7d f8 e8 e8 74 f8 ff 48 8b 55 e8 48 8b 75 f0 41 89 c0 8b 7d f8 31 c0 0f 05 <48> 3d 00 f0 ff ff 77 2e 44 89 c7 48 89 45 f8 e8 42 75 f8 ff 48 8b
RSP: 002b:00007ffd7f512e70 EFLAGS: 00000246 ORIG\_RAX: 0000000000000000
RAX: ffffffffffffffda RBX: 000055c38f316859 RCX: 00007f9713f55cfa
RDX: 0000000000000fff RSI: 00007ffd7f512eb0 RDI: 0000000000000011
RBP: 00007ffd7f512e90 R08: 0000000000000000 R09: 00000000ffffffff
R10: 0000000000000000 R11: 0000000000000246 R12: 000055c38f317148
R13: 0000000000000000 R14: 00007f96f4004f30 R15: 000055c3b6b623c0
</TASK>
The WARN is observed when the blktests test case nvme/014 is repeated
with tcp transport. It is rare, and 200 times repeat is required to
recreate in some test environments.
To avoid the WARN, check the NVME\_TCP\_Q\_LIVE flag before locking
queue->queue\_lock. The flag is cleared long time before the lock gets
destroyed.
Signed-off-by: Hannes Reinecke <hare@suse.de>
Signed-off-by: Shin'ichiro Kawasaki <shinichiro.kawasaki@wdc.com>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e15cebc1b21856944b387f4abd03b66bd3d4f027)

| -rw-r--r-- | [drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/tcp.c?id=e15cebc1b21856944b387f4abd03b66bd3d4f027) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/nvme/host/tcp.c b/drivers/nvme/host/tcp.cindex e3d82e91151afa..c4d776c0ec2060 100644--- a/[drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/tcp.c?id=5b8ed6ff190e97084bef54103cced44f4fad474b)+++ b/[drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/tcp.c?id=e15cebc1b21856944b387f4abd03b66bd3d4f027)@@ -2644,10 +2644,11 @@ static int nvme\_tcp\_get\_address(struct nvme\_ctrl \*ctrl, char \*buf, int size)  len = nvmf\_get\_address(ctrl, buf, size); + if (!test\_bit(NVME\_TCP\_Q\_LIVE, &queue->flags))+ return len;+ mutex\_lock(&queue->queue\_lock); - if (!test\_bit(NVME\_TCP\_Q\_LIVE, &queue->flags))- goto done; ret = kernel\_getsockname(queue->sock, (struct sockaddr \*)&src\_addr); if (ret > 0) { if (len > 0)@@ -2655,7 +2656,7 @@ static int nvme\_tcp\_get\_address(struct nvme\_ctrl \*ctrl, char \*buf, int size) len += scnprintf(buf + len, size - len, "%ssrc\_addr=%pISc\n", (len) ? "," : "", &src\_addr); }-done:+ mutex\_unlock(&queue->queue\_lock);  return len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:36:42 +0000



=== Content from git.kernel.org_3ca10ee0_20250115_083804.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=782373ba27660ba7d330208cf5509ece6feb4545)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=782373ba27660ba7d330208cf5509ece6feb4545)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=782373ba27660ba7d330208cf5509ece6feb4545)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=782373ba27660ba7d330208cf5509ece6feb4545)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hannes Reinecke <hare@suse.de> | 2024-10-02 13:51:41 +0900 |
| --- | --- | --- |
| committer | Keith Busch <kbusch@kernel.org> | 2024-10-03 12:14:35 -0700 |
| commit | [782373ba27660ba7d330208cf5509ece6feb4545](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=782373ba27660ba7d330208cf5509ece6feb4545) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=782373ba27660ba7d330208cf5509ece6feb4545)) | |
| tree | [4a215cc6f7bc137dd8e89269e84b623bf2f06e5b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=782373ba27660ba7d330208cf5509ece6feb4545) | |
| parent | [e38dad438fc08162e20c600ae899e9e60688f72e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e38dad438fc08162e20c600ae899e9e60688f72e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=782373ba27660ba7d330208cf5509ece6feb4545&id2=e38dad438fc08162e20c600ae899e9e60688f72e)) | |
| download | [linux-782373ba27660ba7d330208cf5509ece6feb4545.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-782373ba27660ba7d330208cf5509ece6feb4545.tar.gz) | |

nvme: tcp: avoid race between queue\_lock lock and destroyCommit 76d54bf20cdc ("nvme-tcp: don't access released socket during
error recovery") added a mutex\_lock() call for the queue->queue\_lock
in nvme\_tcp\_get\_address(). However, the mutex\_lock() races with
mutex\_destroy() in nvme\_tcp\_free\_queue(), and causes the WARN below.
DEBUG\_LOCKS\_WARN\_ON(lock->magic != lock)
WARNING: CPU: 3 PID: 34077 at kernel/locking/mutex.c:587 \_\_mutex\_lock+0xcf0/0x1220
Modules linked in: nvmet\_tcp nvmet nvme\_tcp nvme\_fabrics iw\_cm ib\_cm ib\_core pktcdvd nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6 nft\_reject nft\_ct nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables qrtr sunrpc ppdev 9pnet\_virtio 9pnet pcspkr netfs parport\_pc parport e1000 i2c\_piix4 i2c\_smbus loop fuse nfnetlink zram bochs drm\_vram\_helper drm\_ttm\_helper ttm drm\_kms\_helper xfs drm sym53c8xx floppy nvme scsi\_transport\_spi nvme\_core nvme\_auth serio\_raw ata\_generic pata\_acpi dm\_multipath qemu\_fw\_cfg [last unloaded: ib\_uverbs]
CPU: 3 UID: 0 PID: 34077 Comm: udisksd Not tainted 6.11.0-rc7 #319
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:\_\_mutex\_lock+0xcf0/0x1220
Code: 08 84 d2 0f 85 c8 04 00 00 8b 15 ef b6 c8 01 85 d2 0f 85 78 f4 ff ff 48 c7 c6 20 93 ee af 48 c7 c7 60 91 ee af e8 f0 a7 6d fd <0f> 0b e9 5e f4 ff ff 48 b8 00 00 00 00 00 fc ff df 4c 89 f2 48 c1
RSP: 0018:ffff88811305f760 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff88812c652058 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 0000000000000004 RDI: 0000000000000001
RBP: ffff88811305f8b0 R08: 0000000000000001 R09: ffffed1075c36341
R10: ffff8883ae1b1a0b R11: 0000000000010498 R12: 0000000000000000
R13: 0000000000000000 R14: dffffc0000000000 R15: ffff88812c652058
FS: 00007f9713ae4980(0000) GS:ffff8883ae180000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fcd78483c7c CR3: 0000000122c38000 CR4: 00000000000006f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
? \_\_warn.cold+0x5b/0x1af
? \_\_mutex\_lock+0xcf0/0x1220
? report\_bug+0x1ec/0x390
? handle\_bug+0x3c/0x80
? exc\_invalid\_op+0x13/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? \_\_mutex\_lock+0xcf0/0x1220
? nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
? \_\_pfx\_\_\_mutex\_lock+0x10/0x10
? \_\_lock\_acquire+0xd6a/0x59e0
? nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
? \_\_pfx\_nvme\_tcp\_get\_address+0x10/0x10 [nvme\_tcp]
nvme\_sysfs\_show\_address+0x81/0xc0 [nvme\_core]
dev\_attr\_show+0x42/0x80
? \_\_asan\_memset+0x1f/0x40
sysfs\_kf\_seq\_show+0x1f0/0x370
seq\_read\_iter+0x2cb/0x1130
? rw\_verify\_area+0x3b1/0x590
? \_\_mutex\_lock+0x433/0x1220
vfs\_read+0x6a6/0xa20
? lockdep\_hardirqs\_on+0x78/0x100
? \_\_pfx\_vfs\_read+0x10/0x10
ksys\_read+0xf7/0x1d0
? \_\_pfx\_ksys\_read+0x10/0x10
? \_\_x64\_sys\_openat+0x105/0x1d0
do\_syscall\_64+0x93/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? \_\_pfx\_ksys\_read+0x10/0x10
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? do\_syscall\_64+0x9f/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f9713f55cfa
Code: 55 48 89 e5 48 83 ec 20 48 89 55 e8 48 89 75 f0 89 7d f8 e8 e8 74 f8 ff 48 8b 55 e8 48 8b 75 f0 41 89 c0 8b 7d f8 31 c0 0f 05 <48> 3d 00 f0 ff ff 77 2e 44 89 c7 48 89 45 f8 e8 42 75 f8 ff 48 8b
RSP: 002b:00007ffd7f512e70 EFLAGS: 00000246 ORIG\_RAX: 0000000000000000
RAX: ffffffffffffffda RBX: 000055c38f316859 RCX: 00007f9713f55cfa
RDX: 0000000000000fff RSI: 00007ffd7f512eb0 RDI: 0000000000000011
RBP: 00007ffd7f512e90 R08: 0000000000000000 R09: 00000000ffffffff
R10: 0000000000000000 R11: 0000000000000246 R12: 000055c38f317148
R13: 0000000000000000 R14: 00007f96f4004f30 R15: 000055c3b6b623c0
</TASK>
The WARN is observed when the blktests test case nvme/014 is repeated
with tcp transport. It is rare, and 200 times repeat is required to
recreate in some test environments.
To avoid the WARN, check the NVME\_TCP\_Q\_LIVE flag before locking
queue->queue\_lock. The flag is cleared long time before the lock gets
destroyed.
Signed-off-by: Hannes Reinecke <hare@suse.de>
Signed-off-by: Shin'ichiro Kawasaki <shinichiro.kawasaki@wdc.com>
Signed-off-by: Keith Busch <kbusch@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=782373ba27660ba7d330208cf5509ece6feb4545)

| -rw-r--r-- | [drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/tcp.c?id=782373ba27660ba7d330208cf5509ece6feb4545) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/nvme/host/tcp.c b/drivers/nvme/host/tcp.cindex 89c44413c59394..3e416af2659f19 100644--- a/[drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/tcp.c?id=e38dad438fc08162e20c600ae899e9e60688f72e)+++ b/[drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/tcp.c?id=782373ba27660ba7d330208cf5509ece6feb4545)@@ -2644,10 +2644,11 @@ static int nvme\_tcp\_get\_address(struct nvme\_ctrl \*ctrl, char \*buf, int size)  len = nvmf\_get\_address(ctrl, buf, size); + if (!test\_bit(NVME\_TCP\_Q\_LIVE, &queue->flags))+ return len;+ mutex\_lock(&queue->queue\_lock); - if (!test\_bit(NVME\_TCP\_Q\_LIVE, &queue->flags))- goto done; ret = kernel\_getsockname(queue->sock, (struct sockaddr \*)&src\_addr); if (ret > 0) { if (len > 0)@@ -2655,7 +2656,7 @@ static int nvme\_tcp\_get\_address(struct nvme\_ctrl \*ctrl, char \*buf, int size) len += scnprintf(buf + len, size - len, "%ssrc\_addr=%pISc\n", (len) ? "," : "", &src\_addr); }-done:+ mutex\_unlock(&queue->queue\_lock);  return len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:36:41 +0000



=== Content from git.kernel.org_11b18002_20250115_083805.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=975cb1d2121511584695d0e47fdb90e6782da007)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=975cb1d2121511584695d0e47fdb90e6782da007)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=975cb1d2121511584695d0e47fdb90e6782da007)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=975cb1d2121511584695d0e47fdb90e6782da007)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hannes Reinecke <hare@suse.de> | 2024-10-02 13:51:41 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 15:08:56 +0100 |
| commit | [975cb1d2121511584695d0e47fdb90e6782da007](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=975cb1d2121511584695d0e47fdb90e6782da007) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=975cb1d2121511584695d0e47fdb90e6782da007)) | |
| tree | [b914051693b4139bcc14e2ee4099436b0e45c322](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=975cb1d2121511584695d0e47fdb90e6782da007) | |
| parent | [4b3441089235dd881638c140fda8c3339162126d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b3441089235dd881638c140fda8c3339162126d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=975cb1d2121511584695d0e47fdb90e6782da007&id2=4b3441089235dd881638c140fda8c3339162126d)) | |
| download | [linux-975cb1d2121511584695d0e47fdb90e6782da007.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-975cb1d2121511584695d0e47fdb90e6782da007.tar.gz) | |

nvme: tcp: avoid race between queue\_lock lock and destroy[ Upstream commit 782373ba27660ba7d330208cf5509ece6feb4545 ]
Commit 76d54bf20cdc ("nvme-tcp: don't access released socket during
error recovery") added a mutex\_lock() call for the queue->queue\_lock
in nvme\_tcp\_get\_address(). However, the mutex\_lock() races with
mutex\_destroy() in nvme\_tcp\_free\_queue(), and causes the WARN below.
DEBUG\_LOCKS\_WARN\_ON(lock->magic != lock)
WARNING: CPU: 3 PID: 34077 at kernel/locking/mutex.c:587 \_\_mutex\_lock+0xcf0/0x1220
Modules linked in: nvmet\_tcp nvmet nvme\_tcp nvme\_fabrics iw\_cm ib\_cm ib\_core pktcdvd nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6 nft\_reject nft\_ct nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables qrtr sunrpc ppdev 9pnet\_virtio 9pnet pcspkr netfs parport\_pc parport e1000 i2c\_piix4 i2c\_smbus loop fuse nfnetlink zram bochs drm\_vram\_helper drm\_ttm\_helper ttm drm\_kms\_helper xfs drm sym53c8xx floppy nvme scsi\_transport\_spi nvme\_core nvme\_auth serio\_raw ata\_generic pata\_acpi dm\_multipath qemu\_fw\_cfg [last unloaded: ib\_uverbs]
CPU: 3 UID: 0 PID: 34077 Comm: udisksd Not tainted 6.11.0-rc7 #319
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-2.fc40 04/01/2014
RIP: 0010:\_\_mutex\_lock+0xcf0/0x1220
Code: 08 84 d2 0f 85 c8 04 00 00 8b 15 ef b6 c8 01 85 d2 0f 85 78 f4 ff ff 48 c7 c6 20 93 ee af 48 c7 c7 60 91 ee af e8 f0 a7 6d fd <0f> 0b e9 5e f4 ff ff 48 b8 00 00 00 00 00 fc ff df 4c 89 f2 48 c1
RSP: 0018:ffff88811305f760 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff88812c652058 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 0000000000000004 RDI: 0000000000000001
RBP: ffff88811305f8b0 R08: 0000000000000001 R09: ffffed1075c36341
R10: ffff8883ae1b1a0b R11: 0000000000010498 R12: 0000000000000000
R13: 0000000000000000 R14: dffffc0000000000 R15: ffff88812c652058
FS: 00007f9713ae4980(0000) GS:ffff8883ae180000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fcd78483c7c CR3: 0000000122c38000 CR4: 00000000000006f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
? \_\_warn.cold+0x5b/0x1af
? \_\_mutex\_lock+0xcf0/0x1220
? report\_bug+0x1ec/0x390
? handle\_bug+0x3c/0x80
? exc\_invalid\_op+0x13/0x40
? asm\_exc\_invalid\_op+0x16/0x20
? \_\_mutex\_lock+0xcf0/0x1220
? nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
? \_\_pfx\_\_\_mutex\_lock+0x10/0x10
? \_\_lock\_acquire+0xd6a/0x59e0
? nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
nvme\_tcp\_get\_address+0xc2/0x1e0 [nvme\_tcp]
? \_\_pfx\_nvme\_tcp\_get\_address+0x10/0x10 [nvme\_tcp]
nvme\_sysfs\_show\_address+0x81/0xc0 [nvme\_core]
dev\_attr\_show+0x42/0x80
? \_\_asan\_memset+0x1f/0x40
sysfs\_kf\_seq\_show+0x1f0/0x370
seq\_read\_iter+0x2cb/0x1130
? rw\_verify\_area+0x3b1/0x590
? \_\_mutex\_lock+0x433/0x1220
vfs\_read+0x6a6/0xa20
? lockdep\_hardirqs\_on+0x78/0x100
? \_\_pfx\_vfs\_read+0x10/0x10
ksys\_read+0xf7/0x1d0
? \_\_pfx\_ksys\_read+0x10/0x10
? \_\_x64\_sys\_openat+0x105/0x1d0
do\_syscall\_64+0x93/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? \_\_pfx\_ksys\_read+0x10/0x10
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on\_prepare+0x16d/0x400
? do\_syscall\_64+0x9f/0x180
? lockdep\_hardirqs\_on+0x78/0x100
? do\_syscall\_64+0x9f/0x180
? do\_syscall\_64+0x9f/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f9713f55cfa
Code: 55 48 89 e5 48 83 ec 20 48 89 55 e8 48 89 75 f0 89 7d f8 e8 e8 74 f8 ff 48 8b 55 e8 48 8b 75 f0 41 89 c0 8b 7d f8 31 c0 0f 05 <48> 3d 00 f0 ff ff 77 2e 44 89 c7 48 89 45 f8 e8 42 75 f8 ff 48 8b
RSP: 002b:00007ffd7f512e70 EFLAGS: 00000246 ORIG\_RAX: 0000000000000000
RAX: ffffffffffffffda RBX: 000055c38f316859 RCX: 00007f9713f55cfa
RDX: 0000000000000fff RSI: 00007ffd7f512eb0 RDI: 0000000000000011
RBP: 00007ffd7f512e90 R08: 0000000000000000 R09: 00000000ffffffff
R10: 0000000000000000 R11: 0000000000000246 R12: 000055c38f317148
R13: 0000000000000000 R14: 00007f96f4004f30 R15: 000055c3b6b623c0
</TASK>
The WARN is observed when the blktests test case nvme/014 is repeated
with tcp transport. It is rare, and 200 times repeat is required to
recreate in some test environments.
To avoid the WARN, check the NVME\_TCP\_Q\_LIVE flag before locking
queue->queue\_lock. The flag is cleared long time before the lock gets
destroyed.
Signed-off-by: Hannes Reinecke <hare@suse.de>
Signed-off-by: Shin'ichiro Kawasaki <shinichiro.kawasaki@wdc.com>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=975cb1d2121511584695d0e47fdb90e6782da007)

| -rw-r--r-- | [drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/tcp.c?id=975cb1d2121511584695d0e47fdb90e6782da007) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/nvme/host/tcp.c b/drivers/nvme/host/tcp.cindex f1d62d74426f0e..be04c5f3856d24 100644--- a/[drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/tcp.c?id=4b3441089235dd881638c140fda8c3339162126d)+++ b/[drivers/nvme/host/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/tcp.c?id=975cb1d2121511584695d0e47fdb90e6782da007)@@ -2444,10 +2444,11 @@ static int nvme\_tcp\_get\_address(struct nvme\_ctrl \*ctrl, char \*buf, int size)  len = nvmf\_get\_address(ctrl, buf, size); + if (!test\_bit(NVME\_TCP\_Q\_LIVE, &queue->flags))+ return len;+ mutex\_lock(&queue->queue\_lock); - if (!test\_bit(NVME\_TCP\_Q\_LIVE, &queue->flags))- goto done; ret = kernel\_getsockname(queue->sock, (struct sockaddr \*)&src\_addr); if (ret > 0) { if (len > 0)@@ -2455,7 +2456,7 @@ static int nvme\_tcp\_get\_address(struct nvme\_ctrl \*ctrl, char \*buf, int size) len += scnprintf(buf + len, size - len, "%ssrc\_addr=%pISc\n", (len) ? "," : "", &src\_addr); }-done:+ mutex\_unlock(&queue->queue\_lock);  return len; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:36:42 +0000


