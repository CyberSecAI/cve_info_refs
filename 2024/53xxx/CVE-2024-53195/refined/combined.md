=== Content from git.kernel.org_a2679444_20250115_093641.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dd2f9861f27571d47998d71e7516bf7216db0b52)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dd2f9861f27571d47998d71e7516bf7216db0b52)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd2f9861f27571d47998d71e7516bf7216db0b52)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd2f9861f27571d47998d71e7516bf7216db0b52)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Raghavendra Rao Ananta <rananta@google.com> | 2024-10-28 23:45:33 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:44 +0100 |
| commit | [dd2f9861f27571d47998d71e7516bf7216db0b52](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd2f9861f27571d47998d71e7516bf7216db0b52) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dd2f9861f27571d47998d71e7516bf7216db0b52)) | |
| tree | [100c2001e79c44764585eb5d8016980f5ce4d543](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dd2f9861f27571d47998d71e7516bf7216db0b52) | |
| parent | [718f1712e155389fa332972e99d74abf65f888e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=718f1712e155389fa332972e99d74abf65f888e6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd2f9861f27571d47998d71e7516bf7216db0b52&id2=718f1712e155389fa332972e99d74abf65f888e6)) | |
| download | [linux-dd2f9861f27571d47998d71e7516bf7216db0b52.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dd2f9861f27571d47998d71e7516bf7216db0b52.tar.gz) | |

KVM: arm64: Get rid of userspace\_irqchip\_in\_usecommit 38d7aacca09230fdb98a34194fec2af597e8e20d upstream.
Improper use of userspace\_irqchip\_in\_use led to syzbot hitting the
following WARN\_ON() in kvm\_timer\_update\_irq():
WARNING: CPU: 0 PID: 3281 at arch/arm64/kvm/arch\_timer.c:459
kvm\_timer\_update\_irq+0x21c/0x394
Call trace:
kvm\_timer\_update\_irq+0x21c/0x394 arch/arm64/kvm/arch\_timer.c:459
kvm\_timer\_vcpu\_reset+0x158/0x684 arch/arm64/kvm/arch\_timer.c:968
kvm\_reset\_vcpu+0x3b4/0x560 arch/arm64/kvm/reset.c:264
kvm\_vcpu\_set\_target arch/arm64/kvm/arm.c:1553 [inline]
kvm\_arch\_vcpu\_ioctl\_vcpu\_init arch/arm64/kvm/arm.c:1573 [inline]
kvm\_arch\_vcpu\_ioctl+0x112c/0x1b3c arch/arm64/kvm/arm.c:1695
kvm\_vcpu\_ioctl+0x4ec/0xf74 virt/kvm/kvm\_main.c:4658
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:893 [inline]
\_\_arm64\_sys\_ioctl+0x108/0x184 fs/ioctl.c:893
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:35 [inline]
invoke\_syscall+0x78/0x1b8 arch/arm64/kernel/syscall.c:49
el0\_svc\_common+0xe8/0x1b0 arch/arm64/kernel/syscall.c:132
do\_el0\_svc+0x40/0x50 arch/arm64/kernel/syscall.c:151
el0\_svc+0x54/0x14c arch/arm64/kernel/entry-common.c:712
el0t\_64\_sync\_handler+0x84/0xfc arch/arm64/kernel/entry-common.c:730
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:598
The following sequence led to the scenario:
- Userspace creates a VM and a vCPU.
- The vCPU is initialized with KVM\_ARM\_VCPU\_PMU\_V3 during
KVM\_ARM\_VCPU\_INIT.
- Without any other setup, such as vGIC or vPMU, userspace issues
KVM\_RUN on the vCPU. Since the vPMU is requested, but not setup,
kvm\_arm\_pmu\_v3\_enable() fails in kvm\_arch\_vcpu\_run\_pid\_change().
As a result, KVM\_RUN returns after enabling the timer, but before
incrementing 'userspace\_irqchip\_in\_use':
kvm\_arch\_vcpu\_run\_pid\_change()
ret = kvm\_arm\_pmu\_v3\_enable()
if (!vcpu->arch.pmu.created)
return -EINVAL;
if (ret)
return ret;
[...]
if (!irqchip\_in\_kernel(kvm))
static\_branch\_inc(&userspace\_irqchip\_in\_use);
- Userspace ignores the error and issues KVM\_ARM\_VCPU\_INIT again.
Since the timer is already enabled, control moves through the
following flow, ultimately hitting the WARN\_ON():
kvm\_timer\_vcpu\_reset()
if (timer->enabled)
kvm\_timer\_update\_irq()
if (!userspace\_irqchip())
ret = kvm\_vgic\_inject\_irq()
ret = vgic\_lazy\_init()
if (unlikely(!vgic\_initialized(kvm)))
if (kvm->arch.vgic.vgic\_model !=
KVM\_DEV\_TYPE\_ARM\_VGIC\_V2)
return -EBUSY;
WARN\_ON(ret);
Theoretically, since userspace\_irqchip\_in\_use's functionality can be
simply replaced by '!irqchip\_in\_kernel()', get rid of the static key
to avoid the mismanagement, which also helps with the syzbot issue.
Cc: <stable@vger.kernel.org>
Reported-by: syzbot <syzkaller@googlegroups.com>
Suggested-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Raghavendra Rao Ananta <rananta@google.com>
Signed-off-by: Oliver Upton <oliver.upton@linux.dev>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd2f9861f27571d47998d71e7516bf7216db0b52)

| -rw-r--r-- | [arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/kvm_host.h?id=dd2f9861f27571d47998d71e7516bf7216db0b52) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/arch_timer.c?id=dd2f9861f27571d47998d71e7516bf7216db0b52) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/arm.c?id=dd2f9861f27571d47998d71e7516bf7216db0b52) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 4 insertions, 19 deletions

| diff --git a/arch/arm64/include/asm/kvm\_host.h b/arch/arm64/include/asm/kvm\_host.hindex af06ccb7ee3433..b84ed3ad91a9eb 100644--- a/[arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/kvm_host.h?id=718f1712e155389fa332972e99d74abf65f888e6)+++ b/[arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/kvm_host.h?id=dd2f9861f27571d47998d71e7516bf7216db0b52)@@ -72,8 +72,6 @@ enum kvm\_mode kvm\_get\_mode(void); static inline enum kvm\_mode kvm\_get\_mode(void) { return KVM\_MODE\_NONE; }; #endif -DECLARE\_STATIC\_KEY\_FALSE(userspace\_irqchip\_in\_use);- extern unsigned int \_\_ro\_after\_init kvm\_sve\_max\_vl; int \_\_init kvm\_arm\_init\_sve(void); diff --git a/arch/arm64/kvm/arch\_timer.c b/arch/arm64/kvm/arch\_timer.cindex a1e24228aaaa76..d221829502f3e0 100644--- a/[arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arch_timer.c?id=718f1712e155389fa332972e99d74abf65f888e6)+++ b/[arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arch_timer.c?id=dd2f9861f27571d47998d71e7516bf7216db0b52)@@ -206,8 +206,7 @@ void get\_timer\_map(struct kvm\_vcpu \*vcpu, struct timer\_map \*map)  static inline bool userspace\_irqchip(struct kvm \*kvm) {- return static\_branch\_unlikely(&userspace\_irqchip\_in\_use) &&- unlikely(!irqchip\_in\_kernel(kvm));+ return unlikely(!irqchip\_in\_kernel(kvm)); }  static void soft\_timer\_start(struct hrtimer \*hrt, u64 ns)diff --git a/arch/arm64/kvm/arm.c b/arch/arm64/kvm/arm.cindex 18413d869cca1a..4742e6c5ea7a00 100644--- a/[arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arm.c?id=718f1712e155389fa332972e99d74abf65f888e6)+++ b/[arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arm.c?id=dd2f9861f27571d47998d71e7516bf7216db0b52)@@ -57,7 +57,6 @@ DECLARE\_KVM\_NVHE\_PER\_CPU(struct kvm\_cpu\_context, kvm\_hyp\_ctxt); static bool vgic\_present, kvm\_arm\_initialised;  static DEFINE\_PER\_CPU(unsigned char, kvm\_hyp\_initialized);-DEFINE\_STATIC\_KEY\_FALSE(userspace\_irqchip\_in\_use);  bool is\_kvm\_arm\_initialised(void) {@@ -401,9 +400,6 @@ void kvm\_arch\_vcpu\_postcreate(struct kvm\_vcpu \*vcpu)  void kvm\_arch\_vcpu\_destroy(struct kvm\_vcpu \*vcpu) {- if (vcpu\_has\_run\_once(vcpu) && unlikely(!irqchip\_in\_kernel(vcpu->kvm)))- static\_branch\_dec(&userspace\_irqchip\_in\_use);- kvm\_mmu\_free\_memory\_cache(&vcpu->arch.mmu\_page\_cache); kvm\_timer\_vcpu\_terminate(vcpu); kvm\_pmu\_vcpu\_destroy(vcpu);@@ -627,14 +623,6 @@ int kvm\_arch\_vcpu\_run\_pid\_change(struct kvm\_vcpu \*vcpu) return ret; } - if (!irqchip\_in\_kernel(kvm)) {- /\*- \* Tell the rest of the code that there are userspace irqchip- \* VMs in the wild.- \*/- static\_branch\_inc(&userspace\_irqchip\_in\_use);- }- /\* \* Initialize traps for protected VMs. \* NOTE: Move to run in EL2 directly, rather than via a hypercall, once@@ -856,7 +844,7 @@ static bool kvm\_vcpu\_exit\_request(struct kvm\_vcpu \*vcpu, int \*ret) \* state gets updated in kvm\_timer\_update\_run and \* kvm\_pmu\_update\_run below). \*/- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use)) {+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) { if (kvm\_timer\_should\_notify\_user(vcpu) || kvm\_pmu\_should\_notify\_user(vcpu)) { \*ret = -EINTR;@@ -975,7 +963,7 @@ int kvm\_arch\_vcpu\_ioctl\_run(struct kvm\_vcpu \*vcpu) vcpu->mode = OUTSIDE\_GUEST\_MODE; isb(); /\* Ensure work in x\_flush\_hwstate is committed \*/ kvm\_pmu\_sync\_hwstate(vcpu);- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use))+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) kvm\_timer\_sync\_user(vcpu); kvm\_vgic\_sync\_hwstate(vcpu); local\_irq\_enable();@@ -1021,7 +1009,7 @@ int kvm\_arch\_vcpu\_ioctl\_run(struct kvm\_vcpu \*vcpu) \* we don't want vtimer interrupts to race with syncing the \* timer virtual interrupt state. \*/- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use))+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) kvm\_timer\_sync\_user(vcpu);  kvm\_arch\_vcpu\_ctxsync\_fp(vcpu); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:35:18 +0000



=== Content from git.kernel.org_ae860b02_20250115_093639.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=38d7aacca09230fdb98a34194fec2af597e8e20d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38d7aacca09230fdb98a34194fec2af597e8e20d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38d7aacca09230fdb98a34194fec2af597e8e20d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38d7aacca09230fdb98a34194fec2af597e8e20d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Raghavendra Rao Ananta <rananta@google.com> | 2024-10-28 23:45:33 +0000 |
| --- | --- | --- |
| committer | Oliver Upton <oliver.upton@linux.dev> | 2024-10-31 21:22:52 +0000 |
| commit | [38d7aacca09230fdb98a34194fec2af597e8e20d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38d7aacca09230fdb98a34194fec2af597e8e20d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=38d7aacca09230fdb98a34194fec2af597e8e20d)) | |
| tree | [3afe9f5a1e35026c76ba5b93b9c273c830c61908](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38d7aacca09230fdb98a34194fec2af597e8e20d) | |
| parent | [b56680de9c6489f2aed707fad2811e714b52fe4c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b56680de9c6489f2aed707fad2811e714b52fe4c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38d7aacca09230fdb98a34194fec2af597e8e20d&id2=b56680de9c6489f2aed707fad2811e714b52fe4c)) | |
| download | [linux-38d7aacca09230fdb98a34194fec2af597e8e20d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-38d7aacca09230fdb98a34194fec2af597e8e20d.tar.gz) | |

KVM: arm64: Get rid of userspace\_irqchip\_in\_useImproper use of userspace\_irqchip\_in\_use led to syzbot hitting the
following WARN\_ON() in kvm\_timer\_update\_irq():
WARNING: CPU: 0 PID: 3281 at arch/arm64/kvm/arch\_timer.c:459
kvm\_timer\_update\_irq+0x21c/0x394
Call trace:
kvm\_timer\_update\_irq+0x21c/0x394 arch/arm64/kvm/arch\_timer.c:459
kvm\_timer\_vcpu\_reset+0x158/0x684 arch/arm64/kvm/arch\_timer.c:968
kvm\_reset\_vcpu+0x3b4/0x560 arch/arm64/kvm/reset.c:264
kvm\_vcpu\_set\_target arch/arm64/kvm/arm.c:1553 [inline]
kvm\_arch\_vcpu\_ioctl\_vcpu\_init arch/arm64/kvm/arm.c:1573 [inline]
kvm\_arch\_vcpu\_ioctl+0x112c/0x1b3c arch/arm64/kvm/arm.c:1695
kvm\_vcpu\_ioctl+0x4ec/0xf74 virt/kvm/kvm\_main.c:4658
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:893 [inline]
\_\_arm64\_sys\_ioctl+0x108/0x184 fs/ioctl.c:893
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:35 [inline]
invoke\_syscall+0x78/0x1b8 arch/arm64/kernel/syscall.c:49
el0\_svc\_common+0xe8/0x1b0 arch/arm64/kernel/syscall.c:132
do\_el0\_svc+0x40/0x50 arch/arm64/kernel/syscall.c:151
el0\_svc+0x54/0x14c arch/arm64/kernel/entry-common.c:712
el0t\_64\_sync\_handler+0x84/0xfc arch/arm64/kernel/entry-common.c:730
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:598
The following sequence led to the scenario:
- Userspace creates a VM and a vCPU.
- The vCPU is initialized with KVM\_ARM\_VCPU\_PMU\_V3 during
KVM\_ARM\_VCPU\_INIT.
- Without any other setup, such as vGIC or vPMU, userspace issues
KVM\_RUN on the vCPU. Since the vPMU is requested, but not setup,
kvm\_arm\_pmu\_v3\_enable() fails in kvm\_arch\_vcpu\_run\_pid\_change().
As a result, KVM\_RUN returns after enabling the timer, but before
incrementing 'userspace\_irqchip\_in\_use':
kvm\_arch\_vcpu\_run\_pid\_change()
ret = kvm\_arm\_pmu\_v3\_enable()
if (!vcpu->arch.pmu.created)
return -EINVAL;
if (ret)
return ret;
[...]
if (!irqchip\_in\_kernel(kvm))
static\_branch\_inc(&userspace\_irqchip\_in\_use);
- Userspace ignores the error and issues KVM\_ARM\_VCPU\_INIT again.
Since the timer is already enabled, control moves through the
following flow, ultimately hitting the WARN\_ON():
kvm\_timer\_vcpu\_reset()
if (timer->enabled)
kvm\_timer\_update\_irq()
if (!userspace\_irqchip())
ret = kvm\_vgic\_inject\_irq()
ret = vgic\_lazy\_init()
if (unlikely(!vgic\_initialized(kvm)))
if (kvm->arch.vgic.vgic\_model !=
KVM\_DEV\_TYPE\_ARM\_VGIC\_V2)
return -EBUSY;
WARN\_ON(ret);
Theoretically, since userspace\_irqchip\_in\_use's functionality can be
simply replaced by '!irqchip\_in\_kernel()', get rid of the static key
to avoid the mismanagement, which also helps with the syzbot issue.
Cc: <stable@vger.kernel.org>
Reported-by: syzbot <syzkaller@googlegroups.com>
Suggested-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Raghavendra Rao Ananta <rananta@google.com>
Signed-off-by: Oliver Upton <oliver.upton@linux.dev>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38d7aacca09230fdb98a34194fec2af597e8e20d)

| -rw-r--r-- | [arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/kvm_host.h?id=38d7aacca09230fdb98a34194fec2af597e8e20d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/arch_timer.c?id=38d7aacca09230fdb98a34194fec2af597e8e20d) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/arm.c?id=38d7aacca09230fdb98a34194fec2af597e8e20d) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 4 insertions, 19 deletions

| diff --git a/arch/arm64/include/asm/kvm\_host.h b/arch/arm64/include/asm/kvm\_host.hindex 94cff508874bf2..b439aa6d459450 100644--- a/[arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/kvm_host.h?id=b56680de9c6489f2aed707fad2811e714b52fe4c)+++ b/[arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/kvm_host.h?id=38d7aacca09230fdb98a34194fec2af597e8e20d)@@ -73,8 +73,6 @@ enum kvm\_mode kvm\_get\_mode(void); static inline enum kvm\_mode kvm\_get\_mode(void) { return KVM\_MODE\_NONE; }; #endif -DECLARE\_STATIC\_KEY\_FALSE(userspace\_irqchip\_in\_use);- extern unsigned int \_\_ro\_after\_init kvm\_sve\_max\_vl; extern unsigned int \_\_ro\_after\_init kvm\_host\_sve\_max\_vl; int \_\_init kvm\_arm\_init\_sve(void);diff --git a/arch/arm64/kvm/arch\_timer.c b/arch/arm64/kvm/arch\_timer.cindex 879982b1cc739e..1215df59041856 100644--- a/[arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arch_timer.c?id=b56680de9c6489f2aed707fad2811e714b52fe4c)+++ b/[arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arch_timer.c?id=38d7aacca09230fdb98a34194fec2af597e8e20d)@@ -206,8 +206,7 @@ void get\_timer\_map(struct kvm\_vcpu \*vcpu, struct timer\_map \*map)  static inline bool userspace\_irqchip(struct kvm \*kvm) {- return static\_branch\_unlikely(&userspace\_irqchip\_in\_use) &&- unlikely(!irqchip\_in\_kernel(kvm));+ return unlikely(!irqchip\_in\_kernel(kvm)); }  static void soft\_timer\_start(struct hrtimer \*hrt, u64 ns)diff --git a/arch/arm64/kvm/arm.c b/arch/arm64/kvm/arm.cindex ece934bb453199..33965a7c21317f 100644--- a/[arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arm.c?id=b56680de9c6489f2aed707fad2811e714b52fe4c)+++ b/[arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arm.c?id=38d7aacca09230fdb98a34194fec2af597e8e20d)@@ -69,7 +69,6 @@ DECLARE\_KVM\_NVHE\_PER\_CPU(struct kvm\_cpu\_context, kvm\_hyp\_ctxt); static bool vgic\_present, kvm\_arm\_initialised;  static DEFINE\_PER\_CPU(unsigned char, kvm\_hyp\_initialized);-DEFINE\_STATIC\_KEY\_FALSE(userspace\_irqchip\_in\_use);  bool is\_kvm\_arm\_initialised(void) {@@ -503,9 +502,6 @@ void kvm\_arch\_vcpu\_postcreate(struct kvm\_vcpu \*vcpu)  void kvm\_arch\_vcpu\_destroy(struct kvm\_vcpu \*vcpu) {- if (vcpu\_has\_run\_once(vcpu) && unlikely(!irqchip\_in\_kernel(vcpu->kvm)))- static\_branch\_dec(&userspace\_irqchip\_in\_use);- kvm\_mmu\_free\_memory\_cache(&vcpu->arch.mmu\_page\_cache); kvm\_timer\_vcpu\_terminate(vcpu); kvm\_pmu\_vcpu\_destroy(vcpu);@@ -848,14 +844,6 @@ int kvm\_arch\_vcpu\_run\_pid\_change(struct kvm\_vcpu \*vcpu) return ret; } - if (!irqchip\_in\_kernel(kvm)) {- /\*- \* Tell the rest of the code that there are userspace irqchip- \* VMs in the wild.- \*/- static\_branch\_inc(&userspace\_irqchip\_in\_use);- }- mutex\_lock(&kvm->arch.config\_lock); set\_bit(KVM\_ARCH\_FLAG\_HAS\_RAN\_ONCE, &kvm->arch.flags); mutex\_unlock(&kvm->arch.config\_lock);@@ -1064,7 +1052,7 @@ static bool kvm\_vcpu\_exit\_request(struct kvm\_vcpu \*vcpu, int \*ret) \* state gets updated in kvm\_timer\_update\_run and \* kvm\_pmu\_update\_run below). \*/- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use)) {+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) { if (kvm\_timer\_should\_notify\_user(vcpu) || kvm\_pmu\_should\_notify\_user(vcpu)) { \*ret = -EINTR;@@ -1186,7 +1174,7 @@ int kvm\_arch\_vcpu\_ioctl\_run(struct kvm\_vcpu \*vcpu) vcpu->mode = OUTSIDE\_GUEST\_MODE; isb(); /\* Ensure work in x\_flush\_hwstate is committed \*/ kvm\_pmu\_sync\_hwstate(vcpu);- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use))+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) kvm\_timer\_sync\_user(vcpu); kvm\_vgic\_sync\_hwstate(vcpu); local\_irq\_enable();@@ -1232,7 +1220,7 @@ int kvm\_arch\_vcpu\_ioctl\_run(struct kvm\_vcpu \*vcpu) \* we don't want vtimer interrupts to race with syncing the \* timer virtual interrupt state. \*/- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use))+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) kvm\_timer\_sync\_user(vcpu);  kvm\_arch\_vcpu\_ctxsync\_fp(vcpu); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:35:16 +0000



=== Content from git.kernel.org_78dc4172_20250115_093641.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Raghavendra Rao Ananta <rananta@google.com> | 2024-10-28 23:45:33 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:44 +0100 |
| commit | [fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4)) | |
| tree | [0cbaede7be18052b042daca746570e1952b0fc57](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4) | |
| parent | [eabd7ef14048bb6302b3e76f741a9dd6e94ddf62](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eabd7ef14048bb6302b3e76f741a9dd6e94ddf62) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4&id2=eabd7ef14048bb6302b3e76f741a9dd6e94ddf62)) | |
| download | [linux-fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4.tar.gz) | |

KVM: arm64: Get rid of userspace\_irqchip\_in\_usecommit 38d7aacca09230fdb98a34194fec2af597e8e20d upstream.
Improper use of userspace\_irqchip\_in\_use led to syzbot hitting the
following WARN\_ON() in kvm\_timer\_update\_irq():
WARNING: CPU: 0 PID: 3281 at arch/arm64/kvm/arch\_timer.c:459
kvm\_timer\_update\_irq+0x21c/0x394
Call trace:
kvm\_timer\_update\_irq+0x21c/0x394 arch/arm64/kvm/arch\_timer.c:459
kvm\_timer\_vcpu\_reset+0x158/0x684 arch/arm64/kvm/arch\_timer.c:968
kvm\_reset\_vcpu+0x3b4/0x560 arch/arm64/kvm/reset.c:264
kvm\_vcpu\_set\_target arch/arm64/kvm/arm.c:1553 [inline]
kvm\_arch\_vcpu\_ioctl\_vcpu\_init arch/arm64/kvm/arm.c:1573 [inline]
kvm\_arch\_vcpu\_ioctl+0x112c/0x1b3c arch/arm64/kvm/arm.c:1695
kvm\_vcpu\_ioctl+0x4ec/0xf74 virt/kvm/kvm\_main.c:4658
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:893 [inline]
\_\_arm64\_sys\_ioctl+0x108/0x184 fs/ioctl.c:893
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:35 [inline]
invoke\_syscall+0x78/0x1b8 arch/arm64/kernel/syscall.c:49
el0\_svc\_common+0xe8/0x1b0 arch/arm64/kernel/syscall.c:132
do\_el0\_svc+0x40/0x50 arch/arm64/kernel/syscall.c:151
el0\_svc+0x54/0x14c arch/arm64/kernel/entry-common.c:712
el0t\_64\_sync\_handler+0x84/0xfc arch/arm64/kernel/entry-common.c:730
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:598
The following sequence led to the scenario:
- Userspace creates a VM and a vCPU.
- The vCPU is initialized with KVM\_ARM\_VCPU\_PMU\_V3 during
KVM\_ARM\_VCPU\_INIT.
- Without any other setup, such as vGIC or vPMU, userspace issues
KVM\_RUN on the vCPU. Since the vPMU is requested, but not setup,
kvm\_arm\_pmu\_v3\_enable() fails in kvm\_arch\_vcpu\_run\_pid\_change().
As a result, KVM\_RUN returns after enabling the timer, but before
incrementing 'userspace\_irqchip\_in\_use':
kvm\_arch\_vcpu\_run\_pid\_change()
ret = kvm\_arm\_pmu\_v3\_enable()
if (!vcpu->arch.pmu.created)
return -EINVAL;
if (ret)
return ret;
[...]
if (!irqchip\_in\_kernel(kvm))
static\_branch\_inc(&userspace\_irqchip\_in\_use);
- Userspace ignores the error and issues KVM\_ARM\_VCPU\_INIT again.
Since the timer is already enabled, control moves through the
following flow, ultimately hitting the WARN\_ON():
kvm\_timer\_vcpu\_reset()
if (timer->enabled)
kvm\_timer\_update\_irq()
if (!userspace\_irqchip())
ret = kvm\_vgic\_inject\_irq()
ret = vgic\_lazy\_init()
if (unlikely(!vgic\_initialized(kvm)))
if (kvm->arch.vgic.vgic\_model !=
KVM\_DEV\_TYPE\_ARM\_VGIC\_V2)
return -EBUSY;
WARN\_ON(ret);
Theoretically, since userspace\_irqchip\_in\_use's functionality can be
simply replaced by '!irqchip\_in\_kernel()', get rid of the static key
to avoid the mismanagement, which also helps with the syzbot issue.
Cc: <stable@vger.kernel.org>
Reported-by: syzbot <syzkaller@googlegroups.com>
Suggested-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Raghavendra Rao Ananta <rananta@google.com>
Signed-off-by: Oliver Upton <oliver.upton@linux.dev>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4)

| -rw-r--r-- | [arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/kvm_host.h?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/arch_timer.c?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/arm.c?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 4 insertions, 19 deletions

| diff --git a/arch/arm64/include/asm/kvm\_host.h b/arch/arm64/include/asm/kvm\_host.hindex bf64fed9820ea0..c315bc1a4e9adf 100644--- a/[arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/kvm_host.h?id=eabd7ef14048bb6302b3e76f741a9dd6e94ddf62)+++ b/[arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/kvm_host.h?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4)@@ -74,8 +74,6 @@ enum kvm\_mode kvm\_get\_mode(void); static inline enum kvm\_mode kvm\_get\_mode(void) { return KVM\_MODE\_NONE; }; #endif -DECLARE\_STATIC\_KEY\_FALSE(userspace\_irqchip\_in\_use);- extern unsigned int \_\_ro\_after\_init kvm\_sve\_max\_vl; extern unsigned int \_\_ro\_after\_init kvm\_host\_sve\_max\_vl; int \_\_init kvm\_arm\_init\_sve(void);diff --git a/arch/arm64/kvm/arch\_timer.c b/arch/arm64/kvm/arch\_timer.cindex 879982b1cc739e..1215df59041856 100644--- a/[arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arch_timer.c?id=eabd7ef14048bb6302b3e76f741a9dd6e94ddf62)+++ b/[arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arch_timer.c?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4)@@ -206,8 +206,7 @@ void get\_timer\_map(struct kvm\_vcpu \*vcpu, struct timer\_map \*map)  static inline bool userspace\_irqchip(struct kvm \*kvm) {- return static\_branch\_unlikely(&userspace\_irqchip\_in\_use) &&- unlikely(!irqchip\_in\_kernel(kvm));+ return unlikely(!irqchip\_in\_kernel(kvm)); }  static void soft\_timer\_start(struct hrtimer \*hrt, u64 ns)diff --git a/arch/arm64/kvm/arm.c b/arch/arm64/kvm/arm.cindex 48cafb65d6acff..70ff9a20ef3af3 100644--- a/[arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arm.c?id=eabd7ef14048bb6302b3e76f741a9dd6e94ddf62)+++ b/[arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arm.c?id=fe425d5239a28c21e0c83ee7a8f4cb210d29fdb4)@@ -69,7 +69,6 @@ DECLARE\_KVM\_NVHE\_PER\_CPU(struct kvm\_cpu\_context, kvm\_hyp\_ctxt); static bool vgic\_present, kvm\_arm\_initialised;  static DEFINE\_PER\_CPU(unsigned char, kvm\_hyp\_initialized);-DEFINE\_STATIC\_KEY\_FALSE(userspace\_irqchip\_in\_use);  bool is\_kvm\_arm\_initialised(void) {@@ -503,9 +502,6 @@ void kvm\_arch\_vcpu\_postcreate(struct kvm\_vcpu \*vcpu)  void kvm\_arch\_vcpu\_destroy(struct kvm\_vcpu \*vcpu) {- if (vcpu\_has\_run\_once(vcpu) && unlikely(!irqchip\_in\_kernel(vcpu->kvm)))- static\_branch\_dec(&userspace\_irqchip\_in\_use);- kvm\_mmu\_free\_memory\_cache(&vcpu->arch.mmu\_page\_cache); kvm\_timer\_vcpu\_terminate(vcpu); kvm\_pmu\_vcpu\_destroy(vcpu);@@ -848,14 +844,6 @@ int kvm\_arch\_vcpu\_run\_pid\_change(struct kvm\_vcpu \*vcpu) return ret; } - if (!irqchip\_in\_kernel(kvm)) {- /\*- \* Tell the rest of the code that there are userspace irqchip- \* VMs in the wild.- \*/- static\_branch\_inc(&userspace\_irqchip\_in\_use);- }- /\* \* Initialize traps for protected VMs. \* NOTE: Move to run in EL2 directly, rather than via a hypercall, once@@ -1077,7 +1065,7 @@ static bool kvm\_vcpu\_exit\_request(struct kvm\_vcpu \*vcpu, int \*ret) \* state gets updated in kvm\_timer\_update\_run and \* kvm\_pmu\_update\_run below). \*/- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use)) {+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) { if (kvm\_timer\_should\_notify\_user(vcpu) || kvm\_pmu\_should\_notify\_user(vcpu)) { \*ret = -EINTR;@@ -1199,7 +1187,7 @@ int kvm\_arch\_vcpu\_ioctl\_run(struct kvm\_vcpu \*vcpu) vcpu->mode = OUTSIDE\_GUEST\_MODE; isb(); /\* Ensure work in x\_flush\_hwstate is committed \*/ kvm\_pmu\_sync\_hwstate(vcpu);- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use))+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) kvm\_timer\_sync\_user(vcpu); kvm\_vgic\_sync\_hwstate(vcpu); local\_irq\_enable();@@ -1245,7 +1233,7 @@ int kvm\_arch\_vcpu\_ioctl\_run(struct kvm\_vcpu \*vcpu) \* we don't want vtimer interrupts to race with syncing the \* timer virtual interrupt state. \*/- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use))+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) kvm\_timer\_sync\_user(vcpu);  kvm\_arch\_vcpu\_ctxsync\_fp(vcpu); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:35:18 +0000



=== Content from git.kernel.org_73c4b796_20250115_093640.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Raghavendra Rao Ananta <rananta@google.com> | 2024-10-28 23:45:33 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:10 +0100 |
| commit | [c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c)) | |
| tree | [2b60c375e407740ddb71bd3d6d48feb2f17157e7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c) | |
| parent | [aeca8577c9e557162176d506a4bd586e0ce93c54](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aeca8577c9e557162176d506a4bd586e0ce93c54) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c&id2=aeca8577c9e557162176d506a4bd586e0ce93c54)) | |
| download | [linux-c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c.tar.gz) | |

KVM: arm64: Get rid of userspace\_irqchip\_in\_usecommit 38d7aacca09230fdb98a34194fec2af597e8e20d upstream.
Improper use of userspace\_irqchip\_in\_use led to syzbot hitting the
following WARN\_ON() in kvm\_timer\_update\_irq():
WARNING: CPU: 0 PID: 3281 at arch/arm64/kvm/arch\_timer.c:459
kvm\_timer\_update\_irq+0x21c/0x394
Call trace:
kvm\_timer\_update\_irq+0x21c/0x394 arch/arm64/kvm/arch\_timer.c:459
kvm\_timer\_vcpu\_reset+0x158/0x684 arch/arm64/kvm/arch\_timer.c:968
kvm\_reset\_vcpu+0x3b4/0x560 arch/arm64/kvm/reset.c:264
kvm\_vcpu\_set\_target arch/arm64/kvm/arm.c:1553 [inline]
kvm\_arch\_vcpu\_ioctl\_vcpu\_init arch/arm64/kvm/arm.c:1573 [inline]
kvm\_arch\_vcpu\_ioctl+0x112c/0x1b3c arch/arm64/kvm/arm.c:1695
kvm\_vcpu\_ioctl+0x4ec/0xf74 virt/kvm/kvm\_main.c:4658
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:893 [inline]
\_\_arm64\_sys\_ioctl+0x108/0x184 fs/ioctl.c:893
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:35 [inline]
invoke\_syscall+0x78/0x1b8 arch/arm64/kernel/syscall.c:49
el0\_svc\_common+0xe8/0x1b0 arch/arm64/kernel/syscall.c:132
do\_el0\_svc+0x40/0x50 arch/arm64/kernel/syscall.c:151
el0\_svc+0x54/0x14c arch/arm64/kernel/entry-common.c:712
el0t\_64\_sync\_handler+0x84/0xfc arch/arm64/kernel/entry-common.c:730
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:598
The following sequence led to the scenario:
- Userspace creates a VM and a vCPU.
- The vCPU is initialized with KVM\_ARM\_VCPU\_PMU\_V3 during
KVM\_ARM\_VCPU\_INIT.
- Without any other setup, such as vGIC or vPMU, userspace issues
KVM\_RUN on the vCPU. Since the vPMU is requested, but not setup,
kvm\_arm\_pmu\_v3\_enable() fails in kvm\_arch\_vcpu\_run\_pid\_change().
As a result, KVM\_RUN returns after enabling the timer, but before
incrementing 'userspace\_irqchip\_in\_use':
kvm\_arch\_vcpu\_run\_pid\_change()
ret = kvm\_arm\_pmu\_v3\_enable()
if (!vcpu->arch.pmu.created)
return -EINVAL;
if (ret)
return ret;
[...]
if (!irqchip\_in\_kernel(kvm))
static\_branch\_inc(&userspace\_irqchip\_in\_use);
- Userspace ignores the error and issues KVM\_ARM\_VCPU\_INIT again.
Since the timer is already enabled, control moves through the
following flow, ultimately hitting the WARN\_ON():
kvm\_timer\_vcpu\_reset()
if (timer->enabled)
kvm\_timer\_update\_irq()
if (!userspace\_irqchip())
ret = kvm\_vgic\_inject\_irq()
ret = vgic\_lazy\_init()
if (unlikely(!vgic\_initialized(kvm)))
if (kvm->arch.vgic.vgic\_model !=
KVM\_DEV\_TYPE\_ARM\_VGIC\_V2)
return -EBUSY;
WARN\_ON(ret);
Theoretically, since userspace\_irqchip\_in\_use's functionality can be
simply replaced by '!irqchip\_in\_kernel()', get rid of the static key
to avoid the mismanagement, which also helps with the syzbot issue.
Cc: <stable@vger.kernel.org>
Reported-by: syzbot <syzkaller@googlegroups.com>
Suggested-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Raghavendra Rao Ananta <rananta@google.com>
Signed-off-by: Oliver Upton <oliver.upton@linux.dev>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c)

| -rw-r--r-- | [arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/kvm_host.h?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/arch_timer.c?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/arm.c?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 4 insertions, 19 deletions

| diff --git a/arch/arm64/include/asm/kvm\_host.h b/arch/arm64/include/asm/kvm\_host.hindex 428934f64e9fc1..d2e6924d6f4623 100644--- a/[arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/kvm_host.h?id=aeca8577c9e557162176d506a4bd586e0ce93c54)+++ b/[arch/arm64/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/kvm_host.h?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c)@@ -73,8 +73,6 @@ enum kvm\_mode kvm\_get\_mode(void); static inline enum kvm\_mode kvm\_get\_mode(void) { return KVM\_MODE\_NONE; }; #endif -DECLARE\_STATIC\_KEY\_FALSE(userspace\_irqchip\_in\_use);- extern unsigned int \_\_ro\_after\_init kvm\_sve\_max\_vl; extern unsigned int \_\_ro\_after\_init kvm\_host\_sve\_max\_vl; int \_\_init kvm\_arm\_init\_sve(void);diff --git a/arch/arm64/kvm/arch\_timer.c b/arch/arm64/kvm/arch\_timer.cindex 879982b1cc739e..1215df59041856 100644--- a/[arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arch_timer.c?id=aeca8577c9e557162176d506a4bd586e0ce93c54)+++ b/[arch/arm64/kvm/arch\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arch_timer.c?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c)@@ -206,8 +206,7 @@ void get\_timer\_map(struct kvm\_vcpu \*vcpu, struct timer\_map \*map)  static inline bool userspace\_irqchip(struct kvm \*kvm) {- return static\_branch\_unlikely(&userspace\_irqchip\_in\_use) &&- unlikely(!irqchip\_in\_kernel(kvm));+ return unlikely(!irqchip\_in\_kernel(kvm)); }  static void soft\_timer\_start(struct hrtimer \*hrt, u64 ns)diff --git a/arch/arm64/kvm/arm.c b/arch/arm64/kvm/arm.cindex ebc6782e3cd073..5fe59748d24e63 100644--- a/[arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arm.c?id=aeca8577c9e557162176d506a4bd586e0ce93c54)+++ b/[arch/arm64/kvm/arm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/arm.c?id=c16e2dba39ff6ae84bb8dc9c8e0fb21d9b2f6f5c)@@ -67,7 +67,6 @@ DECLARE\_KVM\_NVHE\_PER\_CPU(struct kvm\_cpu\_context, kvm\_hyp\_ctxt); static bool vgic\_present, kvm\_arm\_initialised;  static DEFINE\_PER\_CPU(unsigned char, kvm\_hyp\_initialized);-DEFINE\_STATIC\_KEY\_FALSE(userspace\_irqchip\_in\_use);  bool is\_kvm\_arm\_initialised(void) {@@ -500,9 +499,6 @@ void kvm\_arch\_vcpu\_postcreate(struct kvm\_vcpu \*vcpu)  void kvm\_arch\_vcpu\_destroy(struct kvm\_vcpu \*vcpu) {- if (vcpu\_has\_run\_once(vcpu) && unlikely(!irqchip\_in\_kernel(vcpu->kvm)))- static\_branch\_dec(&userspace\_irqchip\_in\_use);- kvm\_mmu\_free\_memory\_cache(&vcpu->arch.mmu\_page\_cache); kvm\_timer\_vcpu\_terminate(vcpu); kvm\_pmu\_vcpu\_destroy(vcpu);@@ -847,14 +843,6 @@ int kvm\_arch\_vcpu\_run\_pid\_change(struct kvm\_vcpu \*vcpu) return ret; } - if (!irqchip\_in\_kernel(kvm)) {- /\*- \* Tell the rest of the code that there are userspace irqchip- \* VMs in the wild.- \*/- static\_branch\_inc(&userspace\_irqchip\_in\_use);- }- /\* \* Initialize traps for protected VMs. \* NOTE: Move to run in EL2 directly, rather than via a hypercall, once@@ -1074,7 +1062,7 @@ static bool kvm\_vcpu\_exit\_request(struct kvm\_vcpu \*vcpu, int \*ret) \* state gets updated in kvm\_timer\_update\_run and \* kvm\_pmu\_update\_run below). \*/- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use)) {+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) { if (kvm\_timer\_should\_notify\_user(vcpu) || kvm\_pmu\_should\_notify\_user(vcpu)) { \*ret = -EINTR;@@ -1196,7 +1184,7 @@ int kvm\_arch\_vcpu\_ioctl\_run(struct kvm\_vcpu \*vcpu) vcpu->mode = OUTSIDE\_GUEST\_MODE; isb(); /\* Ensure work in x\_flush\_hwstate is committed \*/ kvm\_pmu\_sync\_hwstate(vcpu);- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use))+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) kvm\_timer\_sync\_user(vcpu); kvm\_vgic\_sync\_hwstate(vcpu); local\_irq\_enable();@@ -1242,7 +1230,7 @@ int kvm\_arch\_vcpu\_ioctl\_run(struct kvm\_vcpu \*vcpu) \* we don't want vtimer interrupts to race with syncing the \* timer virtual interrupt state. \*/- if (static\_branch\_unlikely(&userspace\_irqchip\_in\_use))+ if (unlikely(!irqchip\_in\_kernel(vcpu->kvm))) kvm\_timer\_sync\_user(vcpu);  kvm\_arch\_vcpu\_ctxsync\_fp(vcpu); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:35:17 +0000


