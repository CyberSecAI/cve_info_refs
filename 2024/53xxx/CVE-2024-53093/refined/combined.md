=== Content from git.kernel.org_6b510628_20250115_095917.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Keith Busch <kbusch@kernel.org> | 2024-10-15 07:30:17 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 15:08:57 +0100 |
| commit | [4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e)) | |
| tree | [b7845a5a5f0736becbd90dc752325c1be1d0f15f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e) | |
| parent | [3406bfc813a9bbd9c3055795e985f527b7852e8c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3406bfc813a9bbd9c3055795e985f527b7852e8c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e&id2=3406bfc813a9bbd9c3055795e985f527b7852e8c)) | |
| download | [linux-4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e.tar.gz) | |

nvme-multipath: defer partition scanning[ Upstream commit 1f021341eef41e77a633186e9be5223de2ce5d48 ]
We need to suppress the partition scan from occuring within the
controller's scan\_work context. If a path error occurs here, the IO will
wait until a path becomes available or all paths are torn down, but that
action also occurs within scan\_work, so it would deadlock. Defer the
partion scan to a different context that does not block scan\_work.
Reported-by: Hannes Reinecke <hare@suse.de>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e)

| -rw-r--r-- | [drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/multipath.c?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/nvme.h?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 34 insertions, 0 deletions

| diff --git a/drivers/nvme/host/multipath.c b/drivers/nvme/host/multipath.cindex 37ea0fa421da8b..ede2a14dad8be7 100644--- a/[drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/multipath.c?id=3406bfc813a9bbd9c3055795e985f527b7852e8c)+++ b/[drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/multipath.c?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e)@@ -499,6 +499,20 @@ static int nvme\_add\_ns\_head\_cdev(struct nvme\_ns\_head \*head) return ret; } +static void nvme\_partition\_scan\_work(struct work\_struct \*work)+{+ struct nvme\_ns\_head \*head =+ container\_of(work, struct nvme\_ns\_head, partition\_scan\_work);++ if (WARN\_ON\_ONCE(!test\_and\_clear\_bit(GD\_SUPPRESS\_PART\_SCAN,+ &head->disk->state)))+ return;++ mutex\_lock(&head->disk->open\_mutex);+ bdev\_disk\_changed(head->disk, false);+ mutex\_unlock(&head->disk->open\_mutex);+}+ static void nvme\_requeue\_work(struct work\_struct \*work) { struct nvme\_ns\_head \*head =@@ -525,6 +539,7 @@ int nvme\_mpath\_alloc\_disk(struct nvme\_ctrl \*ctrl, struct nvme\_ns\_head \*head) bio\_list\_init(&head->requeue\_list); spin\_lock\_init(&head->requeue\_lock); INIT\_WORK(&head->requeue\_work, nvme\_requeue\_work);+ INIT\_WORK(&head->partition\_scan\_work, nvme\_partition\_scan\_work);  /\* \* Add a multipath node if the subsystems supports multiple controllers.@@ -540,6 +555,16 @@ int nvme\_mpath\_alloc\_disk(struct nvme\_ctrl \*ctrl, struct nvme\_ns\_head \*head) return -ENOMEM; head->disk->fops = &nvme\_ns\_head\_ops; head->disk->private\_data = head;++ /\*+ \* We need to suppress the partition scan from occuring within the+ \* controller's scan\_work context. If a path error occurs here, the IO+ \* will wait until a path becomes available or all paths are torn down,+ \* but that action also occurs within scan\_work, so it would deadlock.+ \* Defer the partion scan to a different context that does not block+ \* scan\_work.+ \*/+ set\_bit(GD\_SUPPRESS\_PART\_SCAN, &head->disk->state); sprintf(head->disk->disk\_name, "nvme%dn%d", ctrl->subsys->instance, head->instance); @@ -589,6 +614,7 @@ static void nvme\_mpath\_set\_live(struct nvme\_ns \*ns) return; } nvme\_add\_ns\_head\_cdev(head);+ kblockd\_schedule\_work(&head->partition\_scan\_work); }  mutex\_lock(&head->lock);@@ -889,6 +915,12 @@ void nvme\_mpath\_shutdown\_disk(struct nvme\_ns\_head \*head) kblockd\_schedule\_work(&head->requeue\_work); if (test\_bit(NVME\_NSHEAD\_DISK\_LIVE, &head->flags)) { nvme\_cdev\_del(&head->cdev, &head->cdev\_device);+ /\*+ \* requeue I/O after NVME\_NSHEAD\_DISK\_LIVE has been cleared+ \* to allow multipath to fail all I/O.+ \*/+ synchronize\_srcu(&head->srcu);+ kblockd\_schedule\_work(&head->requeue\_work); del\_gendisk(head->disk); } }@@ -900,6 +932,7 @@ void nvme\_mpath\_remove\_disk(struct nvme\_ns\_head \*head) /\* make sure all pending bios are cleaned up \*/ kblockd\_schedule\_work(&head->requeue\_work); flush\_work(&head->requeue\_work);+ flush\_work(&head->partition\_scan\_work); put\_disk(head->disk); } diff --git a/drivers/nvme/host/nvme.h b/drivers/nvme/host/nvme.hindex 799f8a2bb0b4f1..14a867245c29f3 100644--- a/[drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/nvme.h?id=3406bfc813a9bbd9c3055795e985f527b7852e8c)+++ b/[drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/nvme.h?id=4a57f42e5ed42cb8f1beb262c4f6d3e698939e4e)@@ -476,6 +476,7 @@ struct nvme\_ns\_head { struct bio\_list requeue\_list; spinlock\_t requeue\_lock; struct work\_struct requeue\_work;+ struct work\_struct partition\_scan\_work; struct mutex lock; unsigned long flags; #define NVME\_NSHEAD\_DISK\_LIVE 0 |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:57:54 +0000



=== Content from git.kernel.org_b966cf62_20250115_095916.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1f021341eef41e77a633186e9be5223de2ce5d48)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f021341eef41e77a633186e9be5223de2ce5d48)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f021341eef41e77a633186e9be5223de2ce5d48)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f021341eef41e77a633186e9be5223de2ce5d48)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Keith Busch <kbusch@kernel.org> | 2024-10-15 07:30:17 -0700 |
| --- | --- | --- |
| committer | Keith Busch <kbusch@kernel.org> | 2024-10-15 08:32:07 -0700 |
| commit | [1f021341eef41e77a633186e9be5223de2ce5d48](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f021341eef41e77a633186e9be5223de2ce5d48) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1f021341eef41e77a633186e9be5223de2ce5d48)) | |
| tree | [a2cdad083214e04ec803a01be157bdd16834e71e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f021341eef41e77a633186e9be5223de2ce5d48) | |
| parent | [0ce96a6708f34280a536263ee5c67e20c433dcce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ce96a6708f34280a536263ee5c67e20c433dcce) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f021341eef41e77a633186e9be5223de2ce5d48&id2=0ce96a6708f34280a536263ee5c67e20c433dcce)) | |
| download | [linux-1f021341eef41e77a633186e9be5223de2ce5d48.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1f021341eef41e77a633186e9be5223de2ce5d48.tar.gz) | |

nvme-multipath: defer partition scanningWe need to suppress the partition scan from occuring within the
controller's scan\_work context. If a path error occurs here, the IO will
wait until a path becomes available or all paths are torn down, but that
action also occurs within scan\_work, so it would deadlock. Defer the
partion scan to a different context that does not block scan\_work.
Reported-by: Hannes Reinecke <hare@suse.de>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f021341eef41e77a633186e9be5223de2ce5d48)

| -rw-r--r-- | [drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/multipath.c?id=1f021341eef41e77a633186e9be5223de2ce5d48) | 39 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/nvme.h?id=1f021341eef41e77a633186e9be5223de2ce5d48) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 34 insertions, 6 deletions

| diff --git a/drivers/nvme/host/multipath.c b/drivers/nvme/host/multipath.cindex bad1620fbbfc19..6a15873055b951 100644--- a/[drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/multipath.c?id=0ce96a6708f34280a536263ee5c67e20c433dcce)+++ b/[drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/multipath.c?id=1f021341eef41e77a633186e9be5223de2ce5d48)@@ -579,6 +579,20 @@ static int nvme\_add\_ns\_head\_cdev(struct nvme\_ns\_head \*head) return ret; } +static void nvme\_partition\_scan\_work(struct work\_struct \*work)+{+ struct nvme\_ns\_head \*head =+ container\_of(work, struct nvme\_ns\_head, partition\_scan\_work);++ if (WARN\_ON\_ONCE(!test\_and\_clear\_bit(GD\_SUPPRESS\_PART\_SCAN,+ &head->disk->state)))+ return;++ mutex\_lock(&head->disk->open\_mutex);+ bdev\_disk\_changed(head->disk, false);+ mutex\_unlock(&head->disk->open\_mutex);+}+ static void nvme\_requeue\_work(struct work\_struct \*work) { struct nvme\_ns\_head \*head =@@ -605,6 +619,7 @@ int nvme\_mpath\_alloc\_disk(struct nvme\_ctrl \*ctrl, struct nvme\_ns\_head \*head) bio\_list\_init(&head->requeue\_list); spin\_lock\_init(&head->requeue\_lock); INIT\_WORK(&head->requeue\_work, nvme\_requeue\_work);+ INIT\_WORK(&head->partition\_scan\_work, nvme\_partition\_scan\_work);  /\* \* Add a multipath node if the subsystems supports multiple controllers.@@ -628,6 +643,16 @@ int nvme\_mpath\_alloc\_disk(struct nvme\_ctrl \*ctrl, struct nvme\_ns\_head \*head) return PTR\_ERR(head->disk); head->disk->fops = &nvme\_ns\_head\_ops; head->disk->private\_data = head;++ /\*+ \* We need to suppress the partition scan from occuring within the+ \* controller's scan\_work context. If a path error occurs here, the IO+ \* will wait until a path becomes available or all paths are torn down,+ \* but that action also occurs within scan\_work, so it would deadlock.+ \* Defer the partion scan to a different context that does not block+ \* scan\_work.+ \*/+ set\_bit(GD\_SUPPRESS\_PART\_SCAN, &head->disk->state); sprintf(head->disk->disk\_name, "nvme%dn%d", ctrl->subsys->instance, head->instance); return 0;@@ -654,6 +679,7 @@ static void nvme\_mpath\_set\_live(struct nvme\_ns \*ns) return; } nvme\_add\_ns\_head\_cdev(head);+ kblockd\_schedule\_work(&head->partition\_scan\_work); }  mutex\_lock(&head->lock);@@ -973,14 +999,14 @@ void nvme\_mpath\_shutdown\_disk(struct nvme\_ns\_head \*head) return; if (test\_and\_clear\_bit(NVME\_NSHEAD\_DISK\_LIVE, &head->flags)) { nvme\_cdev\_del(&head->cdev, &head->cdev\_device);+ /\*+ \* requeue I/O after NVME\_NSHEAD\_DISK\_LIVE has been cleared+ \* to allow multipath to fail all I/O.+ \*/+ synchronize\_srcu(&head->srcu);+ kblockd\_schedule\_work(&head->requeue\_work); del\_gendisk(head->disk); }- /\*- \* requeue I/O after NVME\_NSHEAD\_DISK\_LIVE has been cleared- \* to allow multipath to fail all I/O.- \*/- synchronize\_srcu(&head->srcu);- kblockd\_schedule\_work(&head->requeue\_work); }  void nvme\_mpath\_remove\_disk(struct nvme\_ns\_head \*head)@@ -990,6 +1016,7 @@ void nvme\_mpath\_remove\_disk(struct nvme\_ns\_head \*head) /\* make sure all pending bios are cleaned up \*/ kblockd\_schedule\_work(&head->requeue\_work); flush\_work(&head->requeue\_work);+ flush\_work(&head->partition\_scan\_work); put\_disk(head->disk); } diff --git a/drivers/nvme/host/nvme.h b/drivers/nvme/host/nvme.hindex 313a4f978a2cf3..093cb423f536be 100644--- a/[drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/nvme.h?id=0ce96a6708f34280a536263ee5c67e20c433dcce)+++ b/[drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/nvme.h?id=1f021341eef41e77a633186e9be5223de2ce5d48)@@ -494,6 +494,7 @@ struct nvme\_ns\_head { struct bio\_list requeue\_list; spinlock\_t requeue\_lock; struct work\_struct requeue\_work;+ struct work\_struct partition\_scan\_work; struct mutex lock; unsigned long flags; #define NVME\_NSHEAD\_DISK\_LIVE 0 |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:57:53 +0000



=== Content from git.kernel.org_399dbc85_20250115_095918.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=60de2e03f984cfbcdc12fa552f95087c35a05a98)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60de2e03f984cfbcdc12fa552f95087c35a05a98)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60de2e03f984cfbcdc12fa552f95087c35a05a98)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60de2e03f984cfbcdc12fa552f95087c35a05a98)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Keith Busch <kbusch@kernel.org> | 2024-10-15 07:30:17 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 15:07:20 +0100 |
| commit | [60de2e03f984cfbcdc12fa552f95087c35a05a98](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60de2e03f984cfbcdc12fa552f95087c35a05a98) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=60de2e03f984cfbcdc12fa552f95087c35a05a98)) | |
| tree | [530596131c0f595528a5af02f580dc737632d168](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60de2e03f984cfbcdc12fa552f95087c35a05a98) | |
| parent | [f17c880a4736d8207c71581ce44e518a581c355b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f17c880a4736d8207c71581ce44e518a581c355b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60de2e03f984cfbcdc12fa552f95087c35a05a98&id2=f17c880a4736d8207c71581ce44e518a581c355b)) | |
| download | [linux-60de2e03f984cfbcdc12fa552f95087c35a05a98.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-60de2e03f984cfbcdc12fa552f95087c35a05a98.tar.gz) | |

nvme-multipath: defer partition scanning[ Upstream commit 1f021341eef41e77a633186e9be5223de2ce5d48 ]
We need to suppress the partition scan from occuring within the
controller's scan\_work context. If a path error occurs here, the IO will
wait until a path becomes available or all paths are torn down, but that
action also occurs within scan\_work, so it would deadlock. Defer the
partion scan to a different context that does not block scan\_work.
Reported-by: Hannes Reinecke <hare@suse.de>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60de2e03f984cfbcdc12fa552f95087c35a05a98)

| -rw-r--r-- | [drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/multipath.c?id=60de2e03f984cfbcdc12fa552f95087c35a05a98) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/nvme.h?id=60de2e03f984cfbcdc12fa552f95087c35a05a98) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 34 insertions, 0 deletions

| diff --git a/drivers/nvme/host/multipath.c b/drivers/nvme/host/multipath.cindex 93ada8941a4c5c..43b89c7d585f0b 100644--- a/[drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/multipath.c?id=f17c880a4736d8207c71581ce44e518a581c355b)+++ b/[drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/multipath.c?id=60de2e03f984cfbcdc12fa552f95087c35a05a98)@@ -463,6 +463,20 @@ static int nvme\_add\_ns\_head\_cdev(struct nvme\_ns\_head \*head) return ret; } +static void nvme\_partition\_scan\_work(struct work\_struct \*work)+{+ struct nvme\_ns\_head \*head =+ container\_of(work, struct nvme\_ns\_head, partition\_scan\_work);++ if (WARN\_ON\_ONCE(!test\_and\_clear\_bit(GD\_SUPPRESS\_PART\_SCAN,+ &head->disk->state)))+ return;++ mutex\_lock(&head->disk->open\_mutex);+ bdev\_disk\_changed(head->disk, false);+ mutex\_unlock(&head->disk->open\_mutex);+}+ static void nvme\_requeue\_work(struct work\_struct \*work) { struct nvme\_ns\_head \*head =@@ -489,6 +503,7 @@ int nvme\_mpath\_alloc\_disk(struct nvme\_ctrl \*ctrl, struct nvme\_ns\_head \*head) bio\_list\_init(&head->requeue\_list); spin\_lock\_init(&head->requeue\_lock); INIT\_WORK(&head->requeue\_work, nvme\_requeue\_work);+ INIT\_WORK(&head->partition\_scan\_work, nvme\_partition\_scan\_work);  /\* \* Add a multipath node if the subsystems supports multiple controllers.@@ -504,6 +519,16 @@ int nvme\_mpath\_alloc\_disk(struct nvme\_ctrl \*ctrl, struct nvme\_ns\_head \*head) return -ENOMEM; head->disk->fops = &nvme\_ns\_head\_ops; head->disk->private\_data = head;++ /\*+ \* We need to suppress the partition scan from occuring within the+ \* controller's scan\_work context. If a path error occurs here, the IO+ \* will wait until a path becomes available or all paths are torn down,+ \* but that action also occurs within scan\_work, so it would deadlock.+ \* Defer the partion scan to a different context that does not block+ \* scan\_work.+ \*/+ set\_bit(GD\_SUPPRESS\_PART\_SCAN, &head->disk->state); sprintf(head->disk->disk\_name, "nvme%dn%d", ctrl->subsys->instance, head->instance); @@ -552,6 +577,7 @@ static void nvme\_mpath\_set\_live(struct nvme\_ns \*ns) return; } nvme\_add\_ns\_head\_cdev(head);+ kblockd\_schedule\_work(&head->partition\_scan\_work); }  mutex\_lock(&head->lock);@@ -851,6 +877,12 @@ void nvme\_mpath\_shutdown\_disk(struct nvme\_ns\_head \*head) kblockd\_schedule\_work(&head->requeue\_work); if (test\_bit(NVME\_NSHEAD\_DISK\_LIVE, &head->flags)) { nvme\_cdev\_del(&head->cdev, &head->cdev\_device);+ /\*+ \* requeue I/O after NVME\_NSHEAD\_DISK\_LIVE has been cleared+ \* to allow multipath to fail all I/O.+ \*/+ synchronize\_srcu(&head->srcu);+ kblockd\_schedule\_work(&head->requeue\_work); del\_gendisk(head->disk); } }@@ -862,6 +894,7 @@ void nvme\_mpath\_remove\_disk(struct nvme\_ns\_head \*head) /\* make sure all pending bios are cleaned up \*/ kblockd\_schedule\_work(&head->requeue\_work); flush\_work(&head->requeue\_work);+ flush\_work(&head->partition\_scan\_work); put\_disk(head->disk); } diff --git a/drivers/nvme/host/nvme.h b/drivers/nvme/host/nvme.hindex 5f8a146b701484..0f49b779dec65a 100644--- a/[drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/nvme.h?id=f17c880a4736d8207c71581ce44e518a581c355b)+++ b/[drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/nvme.h?id=60de2e03f984cfbcdc12fa552f95087c35a05a98)@@ -460,6 +460,7 @@ struct nvme\_ns\_head { struct bio\_list requeue\_list; spinlock\_t requeue\_lock; struct work\_struct requeue\_work;+ struct work\_struct partition\_scan\_work; struct mutex lock; unsigned long flags; #define NVME\_NSHEAD\_DISK\_LIVE 0 |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:57:55 +0000



=== Content from git.kernel.org_086e138e_20250115_095919.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Keith Busch <kbusch@kernel.org> | 2024-10-15 07:30:17 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 15:09:52 +0100 |
| commit | [a91b7eddf45afeeb9c5ece11dddff5de0921b00f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f)) | |
| tree | [0365a23e7bfd9cc1a5b6e3fe23a7ea1ca37c0b06](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f) | |
| parent | [655e74d60d3e2c6bef08809329a17657de42a680](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=655e74d60d3e2c6bef08809329a17657de42a680) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f&id2=655e74d60d3e2c6bef08809329a17657de42a680)) | |
| download | [linux-a91b7eddf45afeeb9c5ece11dddff5de0921b00f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a91b7eddf45afeeb9c5ece11dddff5de0921b00f.tar.gz) | |

nvme-multipath: defer partition scanning[ Upstream commit 1f021341eef41e77a633186e9be5223de2ce5d48 ]
We need to suppress the partition scan from occuring within the
controller's scan\_work context. If a path error occurs here, the IO will
wait until a path becomes available or all paths are torn down, but that
action also occurs within scan\_work, so it would deadlock. Defer the
partion scan to a different context that does not block scan\_work.
Reported-by: Hannes Reinecke <hare@suse.de>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f)

| -rw-r--r-- | [drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/multipath.c?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/nvme.h?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 34 insertions, 0 deletions

| diff --git a/drivers/nvme/host/multipath.c b/drivers/nvme/host/multipath.cindex 6d97058cde7a11..a43982aaa40d74 100644--- a/[drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/multipath.c?id=655e74d60d3e2c6bef08809329a17657de42a680)+++ b/[drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/multipath.c?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f)@@ -577,6 +577,20 @@ static int nvme\_add\_ns\_head\_cdev(struct nvme\_ns\_head \*head) return ret; } +static void nvme\_partition\_scan\_work(struct work\_struct \*work)+{+ struct nvme\_ns\_head \*head =+ container\_of(work, struct nvme\_ns\_head, partition\_scan\_work);++ if (WARN\_ON\_ONCE(!test\_and\_clear\_bit(GD\_SUPPRESS\_PART\_SCAN,+ &head->disk->state)))+ return;++ mutex\_lock(&head->disk->open\_mutex);+ bdev\_disk\_changed(head->disk, false);+ mutex\_unlock(&head->disk->open\_mutex);+}+ static void nvme\_requeue\_work(struct work\_struct \*work) { struct nvme\_ns\_head \*head =@@ -603,6 +617,7 @@ int nvme\_mpath\_alloc\_disk(struct nvme\_ctrl \*ctrl, struct nvme\_ns\_head \*head) bio\_list\_init(&head->requeue\_list); spin\_lock\_init(&head->requeue\_lock); INIT\_WORK(&head->requeue\_work, nvme\_requeue\_work);+ INIT\_WORK(&head->partition\_scan\_work, nvme\_partition\_scan\_work);  /\* \* Add a multipath node if the subsystems supports multiple controllers.@@ -626,6 +641,16 @@ int nvme\_mpath\_alloc\_disk(struct nvme\_ctrl \*ctrl, struct nvme\_ns\_head \*head) return PTR\_ERR(head->disk); head->disk->fops = &nvme\_ns\_head\_ops; head->disk->private\_data = head;++ /\*+ \* We need to suppress the partition scan from occuring within the+ \* controller's scan\_work context. If a path error occurs here, the IO+ \* will wait until a path becomes available or all paths are torn down,+ \* but that action also occurs within scan\_work, so it would deadlock.+ \* Defer the partion scan to a different context that does not block+ \* scan\_work.+ \*/+ set\_bit(GD\_SUPPRESS\_PART\_SCAN, &head->disk->state); sprintf(head->disk->disk\_name, "nvme%dn%d", ctrl->subsys->instance, head->instance); return 0;@@ -652,6 +677,7 @@ static void nvme\_mpath\_set\_live(struct nvme\_ns \*ns) return; } nvme\_add\_ns\_head\_cdev(head);+ kblockd\_schedule\_work(&head->partition\_scan\_work); }  mutex\_lock(&head->lock);@@ -972,6 +998,12 @@ void nvme\_mpath\_shutdown\_disk(struct nvme\_ns\_head \*head) kblockd\_schedule\_work(&head->requeue\_work); if (test\_bit(NVME\_NSHEAD\_DISK\_LIVE, &head->flags)) { nvme\_cdev\_del(&head->cdev, &head->cdev\_device);+ /\*+ \* requeue I/O after NVME\_NSHEAD\_DISK\_LIVE has been cleared+ \* to allow multipath to fail all I/O.+ \*/+ synchronize\_srcu(&head->srcu);+ kblockd\_schedule\_work(&head->requeue\_work); del\_gendisk(head->disk); } }@@ -983,6 +1015,7 @@ void nvme\_mpath\_remove\_disk(struct nvme\_ns\_head \*head) /\* make sure all pending bios are cleaned up \*/ kblockd\_schedule\_work(&head->requeue\_work); flush\_work(&head->requeue\_work);+ flush\_work(&head->partition\_scan\_work); put\_disk(head->disk); } diff --git a/drivers/nvme/host/nvme.h b/drivers/nvme/host/nvme.hindex 313a4f978a2cf3..093cb423f536be 100644--- a/[drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/nvme.h?id=655e74d60d3e2c6bef08809329a17657de42a680)+++ b/[drivers/nvme/host/nvme.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/nvme.h?id=a91b7eddf45afeeb9c5ece11dddff5de0921b00f)@@ -494,6 +494,7 @@ struct nvme\_ns\_head { struct bio\_list requeue\_list; spinlock\_t requeue\_lock; struct work\_struct requeue\_work;+ struct work\_struct partition\_scan\_work; struct mutex lock; unsigned long flags; #define NVME\_NSHEAD\_DISK\_LIVE 0 |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:57:56 +0000


