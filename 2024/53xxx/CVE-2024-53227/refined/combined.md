=== Content from git.kernel.org_13912bd9_20250114_193452.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-23 09:18:09 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:10 +0100 |
| commit | [a2b5035ab0e368e8d8a371e27fbc72f133c0bd40](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40)) | |
| tree | [f01eab5592817c0243702247599213315278585d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40) | |
| parent | [a26feee1aea64789962a3bb47950b9cad4b00df8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a26feee1aea64789962a3bb47950b9cad4b00df8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40&id2=a26feee1aea64789962a3bb47950b9cad4b00df8)) | |
| download | [linux-a2b5035ab0e368e8d8a371e27fbc72f133c0bd40.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a2b5035ab0e368e8d8a371e27fbc72f133c0bd40.tar.gz) | |

scsi: bfa: Fix use-after-free in bfad\_im\_module\_exit()[ Upstream commit 178b8f38932d635e90f5f0e9af1986c6f4a89271 ]
BUG: KASAN: slab-use-after-free in \_\_lock\_acquire+0x2aca/0x3a20
Read of size 8 at addr ffff8881082d80c8 by task modprobe/25303
Call Trace:
<TASK>
dump\_stack\_lvl+0x95/0xe0
print\_report+0xcb/0x620
kasan\_report+0xbd/0xf0
\_\_lock\_acquire+0x2aca/0x3a20
lock\_acquire+0x19b/0x520
\_raw\_spin\_lock+0x2b/0x40
attribute\_container\_unregister+0x30/0x160
fc\_release\_transport+0x19/0x90 [scsi\_transport\_fc]
bfad\_im\_module\_exit+0x23/0x60 [bfa]
bfad\_init+0xdb/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
</TASK>
Allocated by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x7f/0x90
fc\_attach\_transport+0x4f/0x4740 [scsi\_transport\_fc]
bfad\_im\_module\_init+0x17/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x38/0x50
kfree+0x212/0x480
bfad\_im\_module\_init+0x7e/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Above issue happens as follows:
bfad\_init
error = bfad\_im\_module\_init()
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
if (error)
goto ext;
ext:
bfad\_im\_module\_exit();
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
--> Trigger double release
Don't call bfad\_im\_module\_exit() if bfad\_im\_module\_init() failed.
Fixes: 7725ccfda597 ("[SCSI] bfa: Brocade BFA FC SCSI driver")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Link: [https://lore.kernel.org/r/20241023011809.63466-1-yebin@huaweicloud.com](https://lore.kernel.org/r/20241023011809.63466-1-yebin%40huaweicloud.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40)

| -rw-r--r-- | [drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bfa/bfad.c?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/scsi/bfa/bfad.c b/drivers/scsi/bfa/bfad.cindex 62cb7a864fd53d..70c7515a822f52 100644--- a/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=a26feee1aea64789962a3bb47950b9cad4b00df8)+++ b/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=a2b5035ab0e368e8d8a371e27fbc72f133c0bd40)@@ -1693,9 +1693,8 @@ bfad\_init(void)  error = bfad\_im\_module\_init(); if (error) {- error = -ENOMEM; printk(KERN\_WARNING "bfad\_im\_module\_init failure\n");- goto ext;+ return -ENOMEM; }  if (strcmp(FCPI\_NAME, " fcpim") == 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:33:29 +0000



=== Content from git.kernel.org_b186324b_20250114_193449.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0ceac8012d3ddea3317f0d82934293d05feb8af1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ceac8012d3ddea3317f0d82934293d05feb8af1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ceac8012d3ddea3317f0d82934293d05feb8af1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ceac8012d3ddea3317f0d82934293d05feb8af1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-23 09:18:09 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:34 +0100 |
| commit | [0ceac8012d3ddea3317f0d82934293d05feb8af1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ceac8012d3ddea3317f0d82934293d05feb8af1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0ceac8012d3ddea3317f0d82934293d05feb8af1)) | |
| tree | [07ed03a893629d8bbeac59a7c08cb43234d25e8c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ceac8012d3ddea3317f0d82934293d05feb8af1) | |
| parent | [495a55944e939e1d85d8feb61a81165eb8cb36e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=495a55944e939e1d85d8feb61a81165eb8cb36e4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ceac8012d3ddea3317f0d82934293d05feb8af1&id2=495a55944e939e1d85d8feb61a81165eb8cb36e4)) | |
| download | [linux-0ceac8012d3ddea3317f0d82934293d05feb8af1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0ceac8012d3ddea3317f0d82934293d05feb8af1.tar.gz) | |

scsi: bfa: Fix use-after-free in bfad\_im\_module\_exit()[ Upstream commit 178b8f38932d635e90f5f0e9af1986c6f4a89271 ]
BUG: KASAN: slab-use-after-free in \_\_lock\_acquire+0x2aca/0x3a20
Read of size 8 at addr ffff8881082d80c8 by task modprobe/25303
Call Trace:
<TASK>
dump\_stack\_lvl+0x95/0xe0
print\_report+0xcb/0x620
kasan\_report+0xbd/0xf0
\_\_lock\_acquire+0x2aca/0x3a20
lock\_acquire+0x19b/0x520
\_raw\_spin\_lock+0x2b/0x40
attribute\_container\_unregister+0x30/0x160
fc\_release\_transport+0x19/0x90 [scsi\_transport\_fc]
bfad\_im\_module\_exit+0x23/0x60 [bfa]
bfad\_init+0xdb/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
</TASK>
Allocated by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x7f/0x90
fc\_attach\_transport+0x4f/0x4740 [scsi\_transport\_fc]
bfad\_im\_module\_init+0x17/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x38/0x50
kfree+0x212/0x480
bfad\_im\_module\_init+0x7e/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Above issue happens as follows:
bfad\_init
error = bfad\_im\_module\_init()
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
if (error)
goto ext;
ext:
bfad\_im\_module\_exit();
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
--> Trigger double release
Don't call bfad\_im\_module\_exit() if bfad\_im\_module\_init() failed.
Fixes: 7725ccfda597 ("[SCSI] bfa: Brocade BFA FC SCSI driver")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Link: [https://lore.kernel.org/r/20241023011809.63466-1-yebin@huaweicloud.com](https://lore.kernel.org/r/20241023011809.63466-1-yebin%40huaweicloud.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ceac8012d3ddea3317f0d82934293d05feb8af1)

| -rw-r--r-- | [drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bfa/bfad.c?id=0ceac8012d3ddea3317f0d82934293d05feb8af1) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/scsi/bfa/bfad.c b/drivers/scsi/bfa/bfad.cindex bd7e6a6fc1f184..7a2a9b05ed0919 100644--- a/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=495a55944e939e1d85d8feb61a81165eb8cb36e4)+++ b/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=0ceac8012d3ddea3317f0d82934293d05feb8af1)@@ -1711,9 +1711,8 @@ bfad\_init(void)  error = bfad\_im\_module\_init(); if (error) {- error = -ENOMEM; printk(KERN\_WARNING "bfad\_im\_module\_init failure\n");- goto ext;+ return -ENOMEM; }  if (strcmp(FCPI\_NAME, " fcpim") == 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:33:26 +0000



=== Content from git.kernel.org_8720bee5_20250114_193451.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3932c753f805a02e9364a4c58b590f21901f8490)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3932c753f805a02e9364a4c58b590f21901f8490)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3932c753f805a02e9364a4c58b590f21901f8490)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3932c753f805a02e9364a4c58b590f21901f8490)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-23 09:18:09 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:29 +0100 |
| commit | [3932c753f805a02e9364a4c58b590f21901f8490](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3932c753f805a02e9364a4c58b590f21901f8490) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3932c753f805a02e9364a4c58b590f21901f8490)) | |
| tree | [dd079c098ddc91bd6e699255baddef0578faf272](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3932c753f805a02e9364a4c58b590f21901f8490) | |
| parent | [5ea4b832b53b0932bd80879826fbfbf25e0bc359](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ea4b832b53b0932bd80879826fbfbf25e0bc359) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3932c753f805a02e9364a4c58b590f21901f8490&id2=5ea4b832b53b0932bd80879826fbfbf25e0bc359)) | |
| download | [linux-3932c753f805a02e9364a4c58b590f21901f8490.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3932c753f805a02e9364a4c58b590f21901f8490.tar.gz) | |

scsi: bfa: Fix use-after-free in bfad\_im\_module\_exit()[ Upstream commit 178b8f38932d635e90f5f0e9af1986c6f4a89271 ]
BUG: KASAN: slab-use-after-free in \_\_lock\_acquire+0x2aca/0x3a20
Read of size 8 at addr ffff8881082d80c8 by task modprobe/25303
Call Trace:
<TASK>
dump\_stack\_lvl+0x95/0xe0
print\_report+0xcb/0x620
kasan\_report+0xbd/0xf0
\_\_lock\_acquire+0x2aca/0x3a20
lock\_acquire+0x19b/0x520
\_raw\_spin\_lock+0x2b/0x40
attribute\_container\_unregister+0x30/0x160
fc\_release\_transport+0x19/0x90 [scsi\_transport\_fc]
bfad\_im\_module\_exit+0x23/0x60 [bfa]
bfad\_init+0xdb/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
</TASK>
Allocated by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x7f/0x90
fc\_attach\_transport+0x4f/0x4740 [scsi\_transport\_fc]
bfad\_im\_module\_init+0x17/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x38/0x50
kfree+0x212/0x480
bfad\_im\_module\_init+0x7e/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Above issue happens as follows:
bfad\_init
error = bfad\_im\_module\_init()
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
if (error)
goto ext;
ext:
bfad\_im\_module\_exit();
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
--> Trigger double release
Don't call bfad\_im\_module\_exit() if bfad\_im\_module\_init() failed.
Fixes: 7725ccfda597 ("[SCSI] bfa: Brocade BFA FC SCSI driver")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Link: [https://lore.kernel.org/r/20241023011809.63466-1-yebin@huaweicloud.com](https://lore.kernel.org/r/20241023011809.63466-1-yebin%40huaweicloud.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3932c753f805a02e9364a4c58b590f21901f8490)

| -rw-r--r-- | [drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bfa/bfad.c?id=3932c753f805a02e9364a4c58b590f21901f8490) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/scsi/bfa/bfad.c b/drivers/scsi/bfa/bfad.cindex 93e4011809919b..df848d2bd08e77 100644--- a/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=5ea4b832b53b0932bd80879826fbfbf25e0bc359)+++ b/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=3932c753f805a02e9364a4c58b590f21901f8490)@@ -1706,9 +1706,8 @@ bfad\_init(void)  error = bfad\_im\_module\_init(); if (error) {- error = -ENOMEM; printk(KERN\_WARNING "bfad\_im\_module\_init failure\n");- goto ext;+ return -ENOMEM; }  if (strcmp(FCPI\_NAME, " fcpim") == 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:33:28 +0000



=== Content from git.kernel.org_a943eb93_20250114_193452.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c28409f851abd93b37969cac7498828ad533afd9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c28409f851abd93b37969cac7498828ad533afd9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c28409f851abd93b37969cac7498828ad533afd9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c28409f851abd93b37969cac7498828ad533afd9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-23 09:18:09 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:18 +0100 |
| commit | [c28409f851abd93b37969cac7498828ad533afd9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c28409f851abd93b37969cac7498828ad533afd9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c28409f851abd93b37969cac7498828ad533afd9)) | |
| tree | [3db6e16cdd8fc5fbeeb7fdad1d3bdd6d86f95607](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c28409f851abd93b37969cac7498828ad533afd9) | |
| parent | [d069227df10d26ee484dacab35599102cfa47ee0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d069227df10d26ee484dacab35599102cfa47ee0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c28409f851abd93b37969cac7498828ad533afd9&id2=d069227df10d26ee484dacab35599102cfa47ee0)) | |
| download | [linux-c28409f851abd93b37969cac7498828ad533afd9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c28409f851abd93b37969cac7498828ad533afd9.tar.gz) | |

scsi: bfa: Fix use-after-free in bfad\_im\_module\_exit()[ Upstream commit 178b8f38932d635e90f5f0e9af1986c6f4a89271 ]
BUG: KASAN: slab-use-after-free in \_\_lock\_acquire+0x2aca/0x3a20
Read of size 8 at addr ffff8881082d80c8 by task modprobe/25303
Call Trace:
<TASK>
dump\_stack\_lvl+0x95/0xe0
print\_report+0xcb/0x620
kasan\_report+0xbd/0xf0
\_\_lock\_acquire+0x2aca/0x3a20
lock\_acquire+0x19b/0x520
\_raw\_spin\_lock+0x2b/0x40
attribute\_container\_unregister+0x30/0x160
fc\_release\_transport+0x19/0x90 [scsi\_transport\_fc]
bfad\_im\_module\_exit+0x23/0x60 [bfa]
bfad\_init+0xdb/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
</TASK>
Allocated by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x7f/0x90
fc\_attach\_transport+0x4f/0x4740 [scsi\_transport\_fc]
bfad\_im\_module\_init+0x17/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x38/0x50
kfree+0x212/0x480
bfad\_im\_module\_init+0x7e/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Above issue happens as follows:
bfad\_init
error = bfad\_im\_module\_init()
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
if (error)
goto ext;
ext:
bfad\_im\_module\_exit();
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
--> Trigger double release
Don't call bfad\_im\_module\_exit() if bfad\_im\_module\_init() failed.
Fixes: 7725ccfda597 ("[SCSI] bfa: Brocade BFA FC SCSI driver")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Link: [https://lore.kernel.org/r/20241023011809.63466-1-yebin@huaweicloud.com](https://lore.kernel.org/r/20241023011809.63466-1-yebin%40huaweicloud.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c28409f851abd93b37969cac7498828ad533afd9)

| -rw-r--r-- | [drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bfa/bfad.c?id=c28409f851abd93b37969cac7498828ad533afd9) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/scsi/bfa/bfad.c b/drivers/scsi/bfa/bfad.cindex 62cb7a864fd53d..70c7515a822f52 100644--- a/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=d069227df10d26ee484dacab35599102cfa47ee0)+++ b/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=c28409f851abd93b37969cac7498828ad533afd9)@@ -1693,9 +1693,8 @@ bfad\_init(void)  error = bfad\_im\_module\_init(); if (error) {- error = -ENOMEM; printk(KERN\_WARNING "bfad\_im\_module\_init failure\n");- goto ext;+ return -ENOMEM; }  if (strcmp(FCPI\_NAME, " fcpim") == 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:33:30 +0000



=== Content from git.kernel.org_77caa696_20250114_193450.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1ffdde30a90bf8efe8f270407f486706962b3292)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ffdde30a90bf8efe8f270407f486706962b3292)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ffdde30a90bf8efe8f270407f486706962b3292)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ffdde30a90bf8efe8f270407f486706962b3292)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-23 09:18:09 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:38 +0100 |
| commit | [1ffdde30a90bf8efe8f270407f486706962b3292](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ffdde30a90bf8efe8f270407f486706962b3292) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1ffdde30a90bf8efe8f270407f486706962b3292)) | |
| tree | [0586d431d15e2f22235b23890d719572d4c0d590](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ffdde30a90bf8efe8f270407f486706962b3292) | |
| parent | [3c8ecbaa39f8e81044b8c107ac6cd5338b760bc7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c8ecbaa39f8e81044b8c107ac6cd5338b760bc7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ffdde30a90bf8efe8f270407f486706962b3292&id2=3c8ecbaa39f8e81044b8c107ac6cd5338b760bc7)) | |
| download | [linux-1ffdde30a90bf8efe8f270407f486706962b3292.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1ffdde30a90bf8efe8f270407f486706962b3292.tar.gz) | |

scsi: bfa: Fix use-after-free in bfad\_im\_module\_exit()[ Upstream commit 178b8f38932d635e90f5f0e9af1986c6f4a89271 ]
BUG: KASAN: slab-use-after-free in \_\_lock\_acquire+0x2aca/0x3a20
Read of size 8 at addr ffff8881082d80c8 by task modprobe/25303
Call Trace:
<TASK>
dump\_stack\_lvl+0x95/0xe0
print\_report+0xcb/0x620
kasan\_report+0xbd/0xf0
\_\_lock\_acquire+0x2aca/0x3a20
lock\_acquire+0x19b/0x520
\_raw\_spin\_lock+0x2b/0x40
attribute\_container\_unregister+0x30/0x160
fc\_release\_transport+0x19/0x90 [scsi\_transport\_fc]
bfad\_im\_module\_exit+0x23/0x60 [bfa]
bfad\_init+0xdb/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
</TASK>
Allocated by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x7f/0x90
fc\_attach\_transport+0x4f/0x4740 [scsi\_transport\_fc]
bfad\_im\_module\_init+0x17/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x38/0x50
kfree+0x212/0x480
bfad\_im\_module\_init+0x7e/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Above issue happens as follows:
bfad\_init
error = bfad\_im\_module\_init()
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
if (error)
goto ext;
ext:
bfad\_im\_module\_exit();
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
--> Trigger double release
Don't call bfad\_im\_module\_exit() if bfad\_im\_module\_init() failed.
Fixes: 7725ccfda597 ("[SCSI] bfa: Brocade BFA FC SCSI driver")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Link: [https://lore.kernel.org/r/20241023011809.63466-1-yebin@huaweicloud.com](https://lore.kernel.org/r/20241023011809.63466-1-yebin%40huaweicloud.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ffdde30a90bf8efe8f270407f486706962b3292)

| -rw-r--r-- | [drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bfa/bfad.c?id=1ffdde30a90bf8efe8f270407f486706962b3292) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/scsi/bfa/bfad.c b/drivers/scsi/bfa/bfad.cindex 62cb7a864fd53d..70c7515a822f52 100644--- a/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=3c8ecbaa39f8e81044b8c107ac6cd5338b760bc7)+++ b/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=1ffdde30a90bf8efe8f270407f486706962b3292)@@ -1693,9 +1693,8 @@ bfad\_init(void)  error = bfad\_im\_module\_init(); if (error) {- error = -ENOMEM; printk(KERN\_WARNING "bfad\_im\_module\_init failure\n");- goto ext;+ return -ENOMEM; }  if (strcmp(FCPI\_NAME, " fcpim") == 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:33:28 +0000



=== Content from git.kernel.org_e17246ea_20250114_193453.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e76181a5be90abcc3ed8a300bd13878aa214d022)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e76181a5be90abcc3ed8a300bd13878aa214d022)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e76181a5be90abcc3ed8a300bd13878aa214d022)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e76181a5be90abcc3ed8a300bd13878aa214d022)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-23 09:18:09 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:02 +0100 |
| commit | [e76181a5be90abcc3ed8a300bd13878aa214d022](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e76181a5be90abcc3ed8a300bd13878aa214d022) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e76181a5be90abcc3ed8a300bd13878aa214d022)) | |
| tree | [53e46884a829340b98906432f6eef3373d9c0462](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e76181a5be90abcc3ed8a300bd13878aa214d022) | |
| parent | [94c5f05270dfc0bbcac641e7ebb4b9a6a48eee84](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94c5f05270dfc0bbcac641e7ebb4b9a6a48eee84) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e76181a5be90abcc3ed8a300bd13878aa214d022&id2=94c5f05270dfc0bbcac641e7ebb4b9a6a48eee84)) | |
| download | [linux-e76181a5be90abcc3ed8a300bd13878aa214d022.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e76181a5be90abcc3ed8a300bd13878aa214d022.tar.gz) | |

scsi: bfa: Fix use-after-free in bfad\_im\_module\_exit()[ Upstream commit 178b8f38932d635e90f5f0e9af1986c6f4a89271 ]
BUG: KASAN: slab-use-after-free in \_\_lock\_acquire+0x2aca/0x3a20
Read of size 8 at addr ffff8881082d80c8 by task modprobe/25303
Call Trace:
<TASK>
dump\_stack\_lvl+0x95/0xe0
print\_report+0xcb/0x620
kasan\_report+0xbd/0xf0
\_\_lock\_acquire+0x2aca/0x3a20
lock\_acquire+0x19b/0x520
\_raw\_spin\_lock+0x2b/0x40
attribute\_container\_unregister+0x30/0x160
fc\_release\_transport+0x19/0x90 [scsi\_transport\_fc]
bfad\_im\_module\_exit+0x23/0x60 [bfa]
bfad\_init+0xdb/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
</TASK>
Allocated by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x7f/0x90
fc\_attach\_transport+0x4f/0x4740 [scsi\_transport\_fc]
bfad\_im\_module\_init+0x17/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x38/0x50
kfree+0x212/0x480
bfad\_im\_module\_init+0x7e/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Above issue happens as follows:
bfad\_init
error = bfad\_im\_module\_init()
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
if (error)
goto ext;
ext:
bfad\_im\_module\_exit();
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
--> Trigger double release
Don't call bfad\_im\_module\_exit() if bfad\_im\_module\_init() failed.
Fixes: 7725ccfda597 ("[SCSI] bfa: Brocade BFA FC SCSI driver")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Link: [https://lore.kernel.org/r/20241023011809.63466-1-yebin@huaweicloud.com](https://lore.kernel.org/r/20241023011809.63466-1-yebin%40huaweicloud.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e76181a5be90abcc3ed8a300bd13878aa214d022)

| -rw-r--r-- | [drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bfa/bfad.c?id=e76181a5be90abcc3ed8a300bd13878aa214d022) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/scsi/bfa/bfad.c b/drivers/scsi/bfa/bfad.cindex 440ef32be048fe..45b5f83ad6da18 100644--- a/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=94c5f05270dfc0bbcac641e7ebb4b9a6a48eee84)+++ b/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=e76181a5be90abcc3ed8a300bd13878aa214d022)@@ -1705,9 +1705,8 @@ bfad\_init(void)  error = bfad\_im\_module\_init(); if (error) {- error = -ENOMEM; printk(KERN\_WARNING "bfad\_im\_module\_init failure\n");- goto ext;+ return -ENOMEM; }  if (strcmp(FCPI\_NAME, " fcpim") == 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:33:30 +0000



=== Content from git.kernel.org_b334d1fb_20250114_193451.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-23 09:18:09 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:40 +0100 |
| commit | [8f5a97443b547b4c83f876f1d6a11df0f1fd4efb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb)) | |
| tree | [4d0cf20fc92859e6210a1ef3c50848c734181f4e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb) | |
| parent | [41f80bdd5201a2969a47dd05d033a87ecce08c16](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41f80bdd5201a2969a47dd05d033a87ecce08c16) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb&id2=41f80bdd5201a2969a47dd05d033a87ecce08c16)) | |
| download | [linux-8f5a97443b547b4c83f876f1d6a11df0f1fd4efb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8f5a97443b547b4c83f876f1d6a11df0f1fd4efb.tar.gz) | |

scsi: bfa: Fix use-after-free in bfad\_im\_module\_exit()[ Upstream commit 178b8f38932d635e90f5f0e9af1986c6f4a89271 ]
BUG: KASAN: slab-use-after-free in \_\_lock\_acquire+0x2aca/0x3a20
Read of size 8 at addr ffff8881082d80c8 by task modprobe/25303
Call Trace:
<TASK>
dump\_stack\_lvl+0x95/0xe0
print\_report+0xcb/0x620
kasan\_report+0xbd/0xf0
\_\_lock\_acquire+0x2aca/0x3a20
lock\_acquire+0x19b/0x520
\_raw\_spin\_lock+0x2b/0x40
attribute\_container\_unregister+0x30/0x160
fc\_release\_transport+0x19/0x90 [scsi\_transport\_fc]
bfad\_im\_module\_exit+0x23/0x60 [bfa]
bfad\_init+0xdb/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
</TASK>
Allocated by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x7f/0x90
fc\_attach\_transport+0x4f/0x4740 [scsi\_transport\_fc]
bfad\_im\_module\_init+0x17/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x38/0x50
kfree+0x212/0x480
bfad\_im\_module\_init+0x7e/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Above issue happens as follows:
bfad\_init
error = bfad\_im\_module\_init()
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
if (error)
goto ext;
ext:
bfad\_im\_module\_exit();
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
--> Trigger double release
Don't call bfad\_im\_module\_exit() if bfad\_im\_module\_init() failed.
Fixes: 7725ccfda597 ("[SCSI] bfa: Brocade BFA FC SCSI driver")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Link: [https://lore.kernel.org/r/20241023011809.63466-1-yebin@huaweicloud.com](https://lore.kernel.org/r/20241023011809.63466-1-yebin%40huaweicloud.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb)

| -rw-r--r-- | [drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bfa/bfad.c?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/scsi/bfa/bfad.c b/drivers/scsi/bfa/bfad.cindex e5aa982ffedc34..d4455ca3a7dd2a 100644--- a/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=41f80bdd5201a2969a47dd05d033a87ecce08c16)+++ b/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=8f5a97443b547b4c83f876f1d6a11df0f1fd4efb)@@ -1699,9 +1699,8 @@ bfad\_init(void)  error = bfad\_im\_module\_init(); if (error) {- error = -ENOMEM; printk(KERN\_WARNING "bfad\_im\_module\_init failure\n");- goto ext;+ return -ENOMEM; }  if (strcmp(FCPI\_NAME, " fcpim") == 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:33:29 +0000



=== Content from git.kernel.org_0499e684_20250114_193454.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-23 09:18:09 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:58 +0100 |
| commit | [ef2c2580189ea88a0dcaf56eb3a565763a900edb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb)) | |
| tree | [d722d4f44d6e8b8bb568d6e3e72afefdbc371de6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb) | |
| parent | [cc30125eb6b65cabae44efd5286e6fe2affd9ab8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc30125eb6b65cabae44efd5286e6fe2affd9ab8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb&id2=cc30125eb6b65cabae44efd5286e6fe2affd9ab8)) | |
| download | [linux-ef2c2580189ea88a0dcaf56eb3a565763a900edb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ef2c2580189ea88a0dcaf56eb3a565763a900edb.tar.gz) | |

scsi: bfa: Fix use-after-free in bfad\_im\_module\_exit()[ Upstream commit 178b8f38932d635e90f5f0e9af1986c6f4a89271 ]
BUG: KASAN: slab-use-after-free in \_\_lock\_acquire+0x2aca/0x3a20
Read of size 8 at addr ffff8881082d80c8 by task modprobe/25303
Call Trace:
<TASK>
dump\_stack\_lvl+0x95/0xe0
print\_report+0xcb/0x620
kasan\_report+0xbd/0xf0
\_\_lock\_acquire+0x2aca/0x3a20
lock\_acquire+0x19b/0x520
\_raw\_spin\_lock+0x2b/0x40
attribute\_container\_unregister+0x30/0x160
fc\_release\_transport+0x19/0x90 [scsi\_transport\_fc]
bfad\_im\_module\_exit+0x23/0x60 [bfa]
bfad\_init+0xdb/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
</TASK>
Allocated by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x7f/0x90
fc\_attach\_transport+0x4f/0x4740 [scsi\_transport\_fc]
bfad\_im\_module\_init+0x17/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x38/0x50
kfree+0x212/0x480
bfad\_im\_module\_init+0x7e/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Above issue happens as follows:
bfad\_init
error = bfad\_im\_module\_init()
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
if (error)
goto ext;
ext:
bfad\_im\_module\_exit();
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
--> Trigger double release
Don't call bfad\_im\_module\_exit() if bfad\_im\_module\_init() failed.
Fixes: 7725ccfda597 ("[SCSI] bfa: Brocade BFA FC SCSI driver")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Link: [https://lore.kernel.org/r/20241023011809.63466-1-yebin@huaweicloud.com](https://lore.kernel.org/r/20241023011809.63466-1-yebin%40huaweicloud.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb)

| -rw-r--r-- | [drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bfa/bfad.c?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/scsi/bfa/bfad.c b/drivers/scsi/bfa/bfad.cindex 440ef32be048fe..45b5f83ad6da18 100644--- a/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=cc30125eb6b65cabae44efd5286e6fe2affd9ab8)+++ b/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=ef2c2580189ea88a0dcaf56eb3a565763a900edb)@@ -1705,9 +1705,8 @@ bfad\_init(void)  error = bfad\_im\_module\_init(); if (error) {- error = -ENOMEM; printk(KERN\_WARNING "bfad\_im\_module\_init failure\n");- goto ext;+ return -ENOMEM; }  if (strcmp(FCPI\_NAME, " fcpim") == 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:33:31 +0000



=== Content from git.kernel.org_2f4a4ce6_20250114_193450.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=178b8f38932d635e90f5f0e9af1986c6f4a89271)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=178b8f38932d635e90f5f0e9af1986c6f4a89271)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=178b8f38932d635e90f5f0e9af1986c6f4a89271)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=178b8f38932d635e90f5f0e9af1986c6f4a89271)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2024-10-23 09:18:09 +0800 |
| --- | --- | --- |
| committer | Martin K. Petersen <martin.petersen@oracle.com> | 2024-11-06 20:45:47 -0500 |
| commit | [178b8f38932d635e90f5f0e9af1986c6f4a89271](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=178b8f38932d635e90f5f0e9af1986c6f4a89271) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=178b8f38932d635e90f5f0e9af1986c6f4a89271)) | |
| tree | [587d4e02c76bea4f3002458cb2e0a6cbc62fd1e5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=178b8f38932d635e90f5f0e9af1986c6f4a89271) | |
| parent | [2e8375df86490bf4c1aa5f5973fb031998e1542f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e8375df86490bf4c1aa5f5973fb031998e1542f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=178b8f38932d635e90f5f0e9af1986c6f4a89271&id2=2e8375df86490bf4c1aa5f5973fb031998e1542f)) | |
| download | [linux-178b8f38932d635e90f5f0e9af1986c6f4a89271.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-178b8f38932d635e90f5f0e9af1986c6f4a89271.tar.gz) | |

scsi: bfa: Fix use-after-free in bfad\_im\_module\_exit()BUG: KASAN: slab-use-after-free in \_\_lock\_acquire+0x2aca/0x3a20
Read of size 8 at addr ffff8881082d80c8 by task modprobe/25303
Call Trace:
<TASK>
dump\_stack\_lvl+0x95/0xe0
print\_report+0xcb/0x620
kasan\_report+0xbd/0xf0
\_\_lock\_acquire+0x2aca/0x3a20
lock\_acquire+0x19b/0x520
\_raw\_spin\_lock+0x2b/0x40
attribute\_container\_unregister+0x30/0x160
fc\_release\_transport+0x19/0x90 [scsi\_transport\_fc]
bfad\_im\_module\_exit+0x23/0x60 [bfa]
bfad\_init+0xdb/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
</TASK>
Allocated by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x7f/0x90
fc\_attach\_transport+0x4f/0x4740 [scsi\_transport\_fc]
bfad\_im\_module\_init+0x17/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Freed by task 25303:
kasan\_save\_stack+0x24/0x50
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
\_\_kasan\_slab\_free+0x38/0x50
kfree+0x212/0x480
bfad\_im\_module\_init+0x7e/0x80 [bfa]
bfad\_init+0x23/0xff0 [bfa]
do\_one\_initcall+0xdc/0x550
do\_init\_module+0x22d/0x6b0
load\_module+0x4e96/0x5ff0
init\_module\_from\_file+0xcd/0x130
idempotent\_init\_module+0x330/0x620
\_\_x64\_sys\_finit\_module+0xb3/0x110
do\_syscall\_64+0xc1/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Above issue happens as follows:
bfad\_init
error = bfad\_im\_module\_init()
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
if (error)
goto ext;
ext:
bfad\_im\_module\_exit();
fc\_release\_transport(bfad\_im\_scsi\_transport\_template);
--> Trigger double release
Don't call bfad\_im\_module\_exit() if bfad\_im\_module\_init() failed.
Fixes: 7725ccfda597 ("[SCSI] bfa: Brocade BFA FC SCSI driver")
Signed-off-by: Ye Bin <yebin10@huawei.com>
Link: [https://lore.kernel.org/r/20241023011809.63466-1-yebin@huaweicloud.com](https://lore.kernel.org/r/20241023011809.63466-1-yebin%40huaweicloud.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=178b8f38932d635e90f5f0e9af1986c6f4a89271)

| -rw-r--r-- | [drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bfa/bfad.c?id=178b8f38932d635e90f5f0e9af1986c6f4a89271) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/scsi/bfa/bfad.c b/drivers/scsi/bfa/bfad.cindex 19675a6e0780da..6aa1d3a7e24bc8 100644--- a/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=2e8375df86490bf4c1aa5f5973fb031998e1542f)+++ b/[drivers/scsi/bfa/bfad.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bfa/bfad.c?id=178b8f38932d635e90f5f0e9af1986c6f4a89271)@@ -1673,9 +1673,8 @@ bfad\_init(void)  error = bfad\_im\_module\_init(); if (error) {- error = -ENOMEM; printk(KERN\_WARNING "bfad\_im\_module\_init failure\n");- goto ext;+ return -ENOMEM; }  if (strcmp(FCPI\_NAME, " fcpim") == 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:33:27 +0000


