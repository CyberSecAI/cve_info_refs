=== Content from git.kernel.org_9a12c964_20250115_093115.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eduard Zingerman <eddyz87@gmail.com> | 2024-09-24 14:08:43 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:11:35 +0100 |
| commit | [bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84)) | |
| tree | [c875ebfb761f39621b50ad1ceebb16ae22188b64](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84) | |
| parent | [4e76efda1f0aaad82f967e5ed955e12f6efb1dbd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e76efda1f0aaad82f967e5ed955e12f6efb1dbd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84&id2=4e76efda1f0aaad82f967e5ed955e12f6efb1dbd)) | |
| download | [linux-bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84.tar.gz) | |

bpf: sync\_linked\_regs() must preserve subreg\_defcommit e9bd9c498cb0f5843996dbe5cbce7a1836a83c70 upstream.
Range propagation must not affect subreg\_def marks, otherwise the
following example is rewritten by verifier incorrectly when
BPF\_F\_TEST\_RND\_HI32 flag is set:
0: call bpf\_ktime\_get\_ns call bpf\_ktime\_get\_ns
1: r0 &= 0x7fffffff after verifier r0 &= 0x7fffffff
2: w1 = w0 rewrites w1 = w0
3: if w0 < 10 goto +0 --------------> r11 = 0x2f5674a6 (r)
4: r1 >>= 32 r11 <<= 32 (r)
5: r0 = r1 r1 |= r11 (r)
6: exit; if w0 < 0xa goto pc+0
r1 >>= 32
r0 = r1
exit
(or zero extension of w1 at (2) is missing for architectures that
require zero extension for upper register half).
The following happens w/o this patch:
- r0 is marked as not a subreg at (0);
- w1 is marked as subreg at (2);
- w1 subreg\_def is overridden at (3) by copy\_register\_state();
- w1 is read at (5) but mark\_insn\_zext() does not mark (2)
for zero extension, because w1 subreg\_def is not set;
- because of BPF\_F\_TEST\_RND\_HI32 flag verifier inserts random
value for hi32 bits of (2) (marked (r));
- this random value is read at (5).
Fixes: 75748837b7e5 ("bpf: Propagate scalar ranges through register assignments.")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Eduard Zingerman <eddyz87@gmail.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://lore.kernel.org/bpf/7e2aa30a62d740db182c170fdd8f81c596df280d.camel@gmail.com
Link: [https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87@gmail.com](https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87%40gmail.com)
[ shung-hsi.yu: sync\_linked\_regs() was called find\_equal\_scalars() before commit
4bf79f9be434 ("bpf: Track equal scalars history on per-instruction level"), and
modification is done because there is only a single call to
copy\_register\_state() before commit 98d7ca374ba4 ("bpf: Track delta between
"linked" registers."). ]
Signed-off-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 3f47cfa17141a8..a3c3c66ca04759 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=4e76efda1f0aaad82f967e5ed955e12f6efb1dbd)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=bfe9446ea1d95f6cb7848da19dfd58d2eec6fd84)@@ -14497,8 +14497,11 @@ static void find\_equal\_scalars(struct bpf\_verifier\_state \*vstate, struct bpf\_reg\_state \*reg;  bpf\_for\_each\_reg\_in\_vstate(vstate, state, reg, ({- if (reg->type == SCALAR\_VALUE && reg->id == known\_reg->id)+ if (reg->type == SCALAR\_VALUE && reg->id == known\_reg->id) {+ s32 saved\_subreg\_def = reg->subreg\_def; copy\_register\_state(reg, known\_reg);+ reg->subreg\_def = saved\_subreg\_def;+ } })); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:29:52 +0000



=== Content from git.kernel.org_2c03f556_20250115_093114.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eduard Zingerman <eddyz87@gmail.com> | 2024-09-24 14:08:43 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:08:57 +0100 |
| commit | [60fd3538d2a8fd44c41d25088c0ece3e1fd30659](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659)) | |
| tree | [73d4d84293157d8b7456dfb451f977283e898bce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659) | |
| parent | [6fb69bb519dfe31d8f40ed4bd90c4f57b31cc907](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fb69bb519dfe31d8f40ed4bd90c4f57b31cc907) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659&id2=6fb69bb519dfe31d8f40ed4bd90c4f57b31cc907)) | |
| download | [linux-60fd3538d2a8fd44c41d25088c0ece3e1fd30659.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-60fd3538d2a8fd44c41d25088c0ece3e1fd30659.tar.gz) | |

bpf: sync\_linked\_regs() must preserve subreg\_defcommit e9bd9c498cb0f5843996dbe5cbce7a1836a83c70 upstream.
Range propagation must not affect subreg\_def marks, otherwise the
following example is rewritten by verifier incorrectly when
BPF\_F\_TEST\_RND\_HI32 flag is set:
0: call bpf\_ktime\_get\_ns call bpf\_ktime\_get\_ns
1: r0 &= 0x7fffffff after verifier r0 &= 0x7fffffff
2: w1 = w0 rewrites w1 = w0
3: if w0 < 10 goto +0 --------------> r11 = 0x2f5674a6 (r)
4: r1 >>= 32 r11 <<= 32 (r)
5: r0 = r1 r1 |= r11 (r)
6: exit; if w0 < 0xa goto pc+0
r1 >>= 32
r0 = r1
exit
(or zero extension of w1 at (2) is missing for architectures that
require zero extension for upper register half).
The following happens w/o this patch:
- r0 is marked as not a subreg at (0);
- w1 is marked as subreg at (2);
- w1 subreg\_def is overridden at (3) by copy\_register\_state();
- w1 is read at (5) but mark\_insn\_zext() does not mark (2)
for zero extension, because w1 subreg\_def is not set;
- because of BPF\_F\_TEST\_RND\_HI32 flag verifier inserts random
value for hi32 bits of (2) (marked (r));
- this random value is read at (5).
Fixes: 75748837b7e5 ("bpf: Propagate scalar ranges through register assignments.")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Eduard Zingerman <eddyz87@gmail.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://lore.kernel.org/bpf/7e2aa30a62d740db182c170fdd8f81c596df280d.camel@gmail.com
Link: [https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87@gmail.com](https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87%40gmail.com)
[ shung-hsi.yu: sync\_linked\_regs() was called find\_equal\_scalars() before commit
4bf79f9be434 ("bpf: Track equal scalars history on per-instruction level"), and
modification is done because there is only a single call to
copy\_register\_state() before commit 98d7ca374ba4 ("bpf: Track delta between
"linked" registers."). ]
Signed-off-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex b68572c41e9640..bdd5105337dc1a 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=6fb69bb519dfe31d8f40ed4bd90c4f57b31cc907)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=60fd3538d2a8fd44c41d25088c0ece3e1fd30659)@@ -10350,8 +10350,11 @@ static void find\_equal\_scalars(struct bpf\_verifier\_state \*vstate, struct bpf\_reg\_state \*reg;  bpf\_for\_each\_reg\_in\_vstate(vstate, state, reg, ({- if (reg->type == SCALAR\_VALUE && reg->id == known\_reg->id)+ if (reg->type == SCALAR\_VALUE && reg->id == known\_reg->id) {+ s32 saved\_subreg\_def = reg->subreg\_def; copy\_register\_state(reg, known\_reg);+ reg->subreg\_def = saved\_subreg\_def;+ } })); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:29:51 +0000



=== Content from git.kernel.org_60e07ba3_20250115_093117.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eduard Zingerman <eddyz87@gmail.com> | 2024-09-24 14:08:43 -0700 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2024-10-01 17:18:52 +0200 |
| commit | [e9bd9c498cb0f5843996dbe5cbce7a1836a83c70](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70)) | |
| tree | [67a233e1170b749cb4a20d0776307064e39b00ee](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70) | |
| parent | [8b62645b09f870d70c7910e7550289d444239a46](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b62645b09f870d70c7910e7550289d444239a46) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70&id2=8b62645b09f870d70c7910e7550289d444239a46)) | |
| download | [linux-e9bd9c498cb0f5843996dbe5cbce7a1836a83c70.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e9bd9c498cb0f5843996dbe5cbce7a1836a83c70.tar.gz) | |

bpf: sync\_linked\_regs() must preserve subreg\_defRange propagation must not affect subreg\_def marks, otherwise the
following example is rewritten by verifier incorrectly when
BPF\_F\_TEST\_RND\_HI32 flag is set:
0: call bpf\_ktime\_get\_ns call bpf\_ktime\_get\_ns
1: r0 &= 0x7fffffff after verifier r0 &= 0x7fffffff
2: w1 = w0 rewrites w1 = w0
3: if w0 < 10 goto +0 --------------> r11 = 0x2f5674a6 (r)
4: r1 >>= 32 r11 <<= 32 (r)
5: r0 = r1 r1 |= r11 (r)
6: exit; if w0 < 0xa goto pc+0
r1 >>= 32
r0 = r1
exit
(or zero extension of w1 at (2) is missing for architectures that
require zero extension for upper register half).
The following happens w/o this patch:
- r0 is marked as not a subreg at (0);
- w1 is marked as subreg at (2);
- w1 subreg\_def is overridden at (3) by copy\_register\_state();
- w1 is read at (5) but mark\_insn\_zext() does not mark (2)
for zero extension, because w1 subreg\_def is not set;
- because of BPF\_F\_TEST\_RND\_HI32 flag verifier inserts random
value for hi32 bits of (2) (marked (r));
- this random value is read at (5).
Fixes: 75748837b7e5 ("bpf: Propagate scalar ranges through register assignments.")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Eduard Zingerman <eddyz87@gmail.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://lore.kernel.org/bpf/7e2aa30a62d740db182c170fdd8f81c596df280d.camel@gmail.com
Link: [https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87@gmail.com](https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 0 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 9a7ed527e47e34..434de48cd24bd8 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=8b62645b09f870d70c7910e7550289d444239a46)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=e9bd9c498cb0f5843996dbe5cbce7a1836a83c70)@@ -15326,8 +15326,12 @@ static void sync\_linked\_regs(struct bpf\_verifier\_state \*vstate, struct bpf\_reg\_s continue; if ((!(reg->id & BPF\_ADD\_CONST) && !(known\_reg->id & BPF\_ADD\_CONST)) || reg->off == known\_reg->off) {+ s32 saved\_subreg\_def = reg->subreg\_def;+ copy\_register\_state(reg, known\_reg);+ reg->subreg\_def = saved\_subreg\_def; } else {+ s32 saved\_subreg\_def = reg->subreg\_def; s32 saved\_off = reg->off;  fake\_reg.type = SCALAR\_VALUE;@@ -15340,6 +15344,7 @@ static void sync\_linked\_regs(struct bpf\_verifier\_state \*vstate, struct bpf\_reg\_s \* otherwise another sync\_linked\_regs() will be incorrect. \*/ reg->off = saved\_off;+ reg->subreg\_def = saved\_subreg\_def;  scalar32\_min\_max\_add(reg, &fake\_reg); scalar\_min\_max\_add(reg, &fake\_reg); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:29:54 +0000



=== Content from git.kernel.org_275c4d48_20250115_093116.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dadf82c1b2608727bcc306843b540cd7414055a7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dadf82c1b2608727bcc306843b540cd7414055a7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dadf82c1b2608727bcc306843b540cd7414055a7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dadf82c1b2608727bcc306843b540cd7414055a7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eduard Zingerman <eddyz87@gmail.com> | 2024-09-24 14:08:43 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:06:12 +0100 |
| commit | [dadf82c1b2608727bcc306843b540cd7414055a7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dadf82c1b2608727bcc306843b540cd7414055a7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dadf82c1b2608727bcc306843b540cd7414055a7)) | |
| tree | [865ef04d55a7f5ba95aeae7c278c20c893b90ce1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dadf82c1b2608727bcc306843b540cd7414055a7) | |
| parent | [6fd69b2f2991f535bb8dc93aeea9d4b7d3ff684a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fd69b2f2991f535bb8dc93aeea9d4b7d3ff684a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dadf82c1b2608727bcc306843b540cd7414055a7&id2=6fd69b2f2991f535bb8dc93aeea9d4b7d3ff684a)) | |
| download | [linux-dadf82c1b2608727bcc306843b540cd7414055a7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dadf82c1b2608727bcc306843b540cd7414055a7.tar.gz) | |

bpf: sync\_linked\_regs() must preserve subreg\_defcommit e9bd9c498cb0f5843996dbe5cbce7a1836a83c70 upstream.
Range propagation must not affect subreg\_def marks, otherwise the
following example is rewritten by verifier incorrectly when
BPF\_F\_TEST\_RND\_HI32 flag is set:
0: call bpf\_ktime\_get\_ns call bpf\_ktime\_get\_ns
1: r0 &= 0x7fffffff after verifier r0 &= 0x7fffffff
2: w1 = w0 rewrites w1 = w0
3: if w0 < 10 goto +0 --------------> r11 = 0x2f5674a6 (r)
4: r1 >>= 32 r11 <<= 32 (r)
5: r0 = r1 r1 |= r11 (r)
6: exit; if w0 < 0xa goto pc+0
r1 >>= 32
r0 = r1
exit
(or zero extension of w1 at (2) is missing for architectures that
require zero extension for upper register half).
The following happens w/o this patch:
- r0 is marked as not a subreg at (0);
- w1 is marked as subreg at (2);
- w1 subreg\_def is overridden at (3) by copy\_register\_state();
- w1 is read at (5) but mark\_insn\_zext() does not mark (2)
for zero extension, because w1 subreg\_def is not set;
- because of BPF\_F\_TEST\_RND\_HI32 flag verifier inserts random
value for hi32 bits of (2) (marked (r));
- this random value is read at (5).
Fixes: 75748837b7e5 ("bpf: Propagate scalar ranges through register assignments.")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Eduard Zingerman <eddyz87@gmail.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://lore.kernel.org/bpf/7e2aa30a62d740db182c170fdd8f81c596df280d.camel@gmail.com
Link: [https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87@gmail.com](https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87%40gmail.com)
[ shung-hsi.yu: sync\_linked\_regs() was called find\_equal\_scalars() before commit
4bf79f9be434 ("bpf: Track equal scalars history on per-instruction level"), and
modification is done because there is only a single call to
copy\_register\_state() before commit 98d7ca374ba4 ("bpf: Track delta between
"linked" registers."). ]
Signed-off-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dadf82c1b2608727bcc306843b540cd7414055a7)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=dadf82c1b2608727bcc306843b540cd7414055a7) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 931611d2273699..e6d50e371a2b81 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=6fd69b2f2991f535bb8dc93aeea9d4b7d3ff684a)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=dadf82c1b2608727bcc306843b540cd7414055a7)@@ -8168,8 +8168,11 @@ static void find\_equal\_scalars(struct bpf\_verifier\_state \*vstate, struct bpf\_reg\_state \*reg;  bpf\_for\_each\_reg\_in\_vstate(vstate, state, reg, ({- if (reg->type == SCALAR\_VALUE && reg->id == known\_reg->id)+ if (reg->type == SCALAR\_VALUE && reg->id == known\_reg->id) {+ s32 saved\_subreg\_def = reg->subreg\_def; copy\_register\_state(reg, known\_reg);+ reg->subreg\_def = saved\_subreg\_def;+ } })); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:29:53 +0000



=== Content from git.kernel.org_0758effd_20250115_093114.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eduard Zingerman <eddyz87@gmail.com> | 2024-09-24 14:08:43 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-19 18:07:22 +0100 |
| commit | [b57ac2d92c1f565743f6890a5b9cf317ed856b09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09)) | |
| tree | [92e56109ef281bce3f1eb487cd339163a3432141](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09) | |
| parent | [4749f9f9b050adeb339f810e250095e2f6de9ac1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4749f9f9b050adeb339f810e250095e2f6de9ac1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09&id2=4749f9f9b050adeb339f810e250095e2f6de9ac1)) | |
| download | [linux-b57ac2d92c1f565743f6890a5b9cf317ed856b09.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b57ac2d92c1f565743f6890a5b9cf317ed856b09.tar.gz) | |

bpf: sync\_linked\_regs() must preserve subreg\_defcommit e9bd9c498cb0f5843996dbe5cbce7a1836a83c70 upstream.
Range propagation must not affect subreg\_def marks, otherwise the
following example is rewritten by verifier incorrectly when
BPF\_F\_TEST\_RND\_HI32 flag is set:
0: call bpf\_ktime\_get\_ns call bpf\_ktime\_get\_ns
1: r0 &= 0x7fffffff after verifier r0 &= 0x7fffffff
2: w1 = w0 rewrites w1 = w0
3: if w0 < 10 goto +0 --------------> r11 = 0x2f5674a6 (r)
4: r1 >>= 32 r11 <<= 32 (r)
5: r0 = r1 r1 |= r11 (r)
6: exit; if w0 < 0xa goto pc+0
r1 >>= 32
r0 = r1
exit
(or zero extension of w1 at (2) is missing for architectures that
require zero extension for upper register half).
The following happens w/o this patch:
- r0 is marked as not a subreg at (0);
- w1 is marked as subreg at (2);
- w1 subreg\_def is overridden at (3) by copy\_register\_state();
- w1 is read at (5) but mark\_insn\_zext() does not mark (2)
for zero extension, because w1 subreg\_def is not set;
- because of BPF\_F\_TEST\_RND\_HI32 flag verifier inserts random
value for hi32 bits of (2) (marked (r));
- this random value is read at (5).
Fixes: 75748837b7e5 ("bpf: Propagate scalar ranges through register assignments.")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Eduard Zingerman <eddyz87@gmail.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://lore.kernel.org/bpf/7e2aa30a62d740db182c170fdd8f81c596df280d.camel@gmail.com
Link: [https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87@gmail.com](https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87%40gmail.com)
[ shung-hsi.yu: sync\_linked\_regs() was called find\_equal\_scalars() before commit
4bf79f9be434 ("bpf: Track equal scalars history on per-instruction level"), and
modification is done because there is only a single call to
copy\_register\_state() before commit 98d7ca374ba4 ("bpf: Track delta between
"linked" registers."). ]
Signed-off-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex e29c0581f93ad7..7049a85a78ab22 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=4749f9f9b050adeb339f810e250095e2f6de9ac1)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=b57ac2d92c1f565743f6890a5b9cf317ed856b09)@@ -9223,8 +9223,11 @@ static void find\_equal\_scalars(struct bpf\_verifier\_state \*vstate, struct bpf\_reg\_state \*reg;  bpf\_for\_each\_reg\_in\_vstate(vstate, state, reg, ({- if (reg->type == SCALAR\_VALUE && reg->id == known\_reg->id)+ if (reg->type == SCALAR\_VALUE && reg->id == known\_reg->id) {+ s32 saved\_subreg\_def = reg->subreg\_def; copy\_register\_state(reg, known\_reg);+ reg->subreg\_def = saved\_subreg\_def;+ } })); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:29:52 +0000



=== Content from git.kernel.org_c253b11b_20250115_093117.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eduard Zingerman <eddyz87@gmail.com> | 2024-09-24 14:08:43 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:23 +0100 |
| commit | [e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0)) | |
| tree | [ae2c5d54e9e66d8f0dc77629402785ec0d793761](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0) | |
| parent | [c923f1fb8ae8627322d167b73bb4f978404a05de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c923f1fb8ae8627322d167b73bb4f978404a05de) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0&id2=c923f1fb8ae8627322d167b73bb4f978404a05de)) | |
| download | [linux-e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0.tar.gz) | |

bpf: sync\_linked\_regs() must preserve subreg\_def[ Upstream commit e9bd9c498cb0f5843996dbe5cbce7a1836a83c70 ]
Range propagation must not affect subreg\_def marks, otherwise the
following example is rewritten by verifier incorrectly when
BPF\_F\_TEST\_RND\_HI32 flag is set:
0: call bpf\_ktime\_get\_ns call bpf\_ktime\_get\_ns
1: r0 &= 0x7fffffff after verifier r0 &= 0x7fffffff
2: w1 = w0 rewrites w1 = w0
3: if w0 < 10 goto +0 --------------> r11 = 0x2f5674a6 (r)
4: r1 >>= 32 r11 <<= 32 (r)
5: r0 = r1 r1 |= r11 (r)
6: exit; if w0 < 0xa goto pc+0
r1 >>= 32
r0 = r1
exit
(or zero extension of w1 at (2) is missing for architectures that
require zero extension for upper register half).
The following happens w/o this patch:
- r0 is marked as not a subreg at (0);
- w1 is marked as subreg at (2);
- w1 subreg\_def is overridden at (3) by copy\_register\_state();
- w1 is read at (5) but mark\_insn\_zext() does not mark (2)
for zero extension, because w1 subreg\_def is not set;
- because of BPF\_F\_TEST\_RND\_HI32 flag verifier inserts random
value for hi32 bits of (2) (marked (r));
- this random value is read at (5).
Fixes: 75748837b7e5 ("bpf: Propagate scalar ranges through register assignments.")
Reported-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Lonial Con <kongln9170@gmail.com>
Signed-off-by: Eduard Zingerman <eddyz87@gmail.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://lore.kernel.org/bpf/7e2aa30a62d740db182c170fdd8f81c596df280d.camel@gmail.com
Link: [https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87@gmail.com](https://lore.kernel.org/bpf/20240924210844.1758441-1-eddyz87%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 0 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex d5215cb1747f16..5c5dea5e137e76 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=c923f1fb8ae8627322d167b73bb4f978404a05de)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0)@@ -15140,8 +15140,12 @@ static void find\_equal\_scalars(struct bpf\_verifier\_state \*vstate, continue; if ((!(reg->id & BPF\_ADD\_CONST) && !(known\_reg->id & BPF\_ADD\_CONST)) || reg->off == known\_reg->off) {+ s32 saved\_subreg\_def = reg->subreg\_def;+ copy\_register\_state(reg, known\_reg);+ reg->subreg\_def = saved\_subreg\_def; } else {+ s32 saved\_subreg\_def = reg->subreg\_def; s32 saved\_off = reg->off;  fake\_reg.type = SCALAR\_VALUE;@@ -15154,6 +15158,7 @@ static void find\_equal\_scalars(struct bpf\_verifier\_state \*vstate, \* otherwise another find\_equal\_scalars() will be incorrect. \*/ reg->off = saved\_off;+ reg->subreg\_def = saved\_subreg\_def;  scalar32\_min\_max\_add(reg, &fake\_reg); scalar\_min\_max\_add(reg, &fake\_reg); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:29:54 +0000


