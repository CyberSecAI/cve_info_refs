=== Content from git.kernel.org_3c60b99e_20250114_215945.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-11-07 01:07:33 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-11-11 17:20:23 -0800 |
| commit | [2026559a6c4ce34db117d2db8f710fe2a9420d5a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a)) | |
| tree | [b991539cc1212ddcf9281d66b78bba808ab40edb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a) | |
| parent | [cd45e963e44b0f10d90b9e6c0e8b4f47f3c92471](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd45e963e44b0f10d90b9e6c0e8b4f47f3c92471) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a&id2=cd45e963e44b0f10d90b9e6c0e8b4f47f3c92471)) | |
| download | [linux-2026559a6c4ce34db117d2db8f710fe2a9420d5a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2026559a6c4ce34db117d2db8f710fe2a9420d5a.tar.gz) | |

nilfs2: fix null-ptr-deref in block\_dirty\_buffer tracepointWhen using the "block:block\_dirty\_buffer" tracepoint, mark\_buffer\_dirty()
may cause a NULL pointer dereference, or a general protection fault when
KASAN is enabled.
This happens because, since the tracepoint was added in
mark\_buffer\_dirty(), it references the dev\_t member bh->b\_bdev->bd\_dev
regardless of whether the buffer head has a pointer to a block\_device
structure.
In the current implementation, nilfs\_grab\_buffer(), which grabs a buffer
to read (or create) a block of metadata, including b-tree node blocks,
does not set the block device, but instead does so only if the buffer is
not in the "uptodate" state for each of its caller block reading
functions. However, if the uptodate flag is set on a folio/page, and the
buffer heads are detached from it by try\_to\_free\_buffers(), and new buffer
heads are then attached by create\_empty\_buffers(), the uptodate flag may
be restored to each buffer without the block device being set to
bh->b\_bdev, and mark\_buffer\_dirty() may be called later in that state,
resulting in the bug mentioned above.
Fix this issue by making nilfs\_grab\_buffer() always set the block device
of the super block structure to the buffer head, regardless of the state
of the buffer's uptodate flag.
Link: [https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke%40gmail.com)
Fixes: 5305cb830834 ("block: add block\_{touch|dirty}\_buffer tracepoint")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Tejun Heo <tj@kernel.org>
Cc: Ubisectech Sirius <bugreport@valiantsec.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/gcinode.c?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/mdt.c?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 2 insertions, 6 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 57b4af5ad646bd..501ad7be5174cb 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=cd45e963e44b0f10d90b9e6c0e8b4f47f3c92471)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a)@@ -68,7 +68,6 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode));- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = blocknr; set\_buffer\_mapped(bh); set\_buffer\_uptodate(bh);@@ -133,7 +132,6 @@ int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr, goto found; } set\_buffer\_mapped(bh);- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = pblocknr; /\* set block address for read \*/ bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/gcinode.c b/fs/nilfs2/gcinode.cindex 1c9ae36a03abe9..ace22253fed0f2 100644--- a/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=cd45e963e44b0f10d90b9e6c0e8b4f47f3c92471)+++ b/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a)@@ -83,10 +83,8 @@ int nilfs\_gccache\_submit\_read\_data(struct inode \*inode, sector\_t blkoff, goto out; } - if (!buffer\_mapped(bh)) {- bh->b\_bdev = inode->i\_sb->s\_bdev;+ if (!buffer\_mapped(bh)) set\_buffer\_mapped(bh);- } bh->b\_blocknr = pbn; bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/mdt.c b/fs/nilfs2/mdt.cindex ceb7dc0b5badd3..2db6350b5ac2a4 100644--- a/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=cd45e963e44b0f10d90b9e6c0e8b4f47f3c92471)+++ b/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a)@@ -89,7 +89,6 @@ static int nilfs\_mdt\_create\_block(struct inode \*inode, unsigned long block, if (buffer\_uptodate(bh)) goto failed\_bh; - bh->b\_bdev = sb->s\_bdev; err = nilfs\_mdt\_insert\_new\_block(inode, block, bh, init\_block); if (likely(!err)) { get\_bh(bh);diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 296dbf9cca22d0..6dd8b854cd1f38 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=cd45e963e44b0f10d90b9e6c0e8b4f47f3c92471)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=2026559a6c4ce34db117d2db8f710fe2a9420d5a)@@ -63,6 +63,7 @@ struct buffer\_head \*nilfs\_grab\_buffer(struct inode \*inode, folio\_put(folio); return NULL; }+ bh->b\_bdev = inode->i\_sb->s\_bdev; return bh; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:58:22 +0000



=== Content from git.kernel.org_7760b50a_20250114_215943.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-11-07 01:07:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:19 +0100 |
| commit | [0ce59fb1c73fdd5b6028226aeb46259a0cdc0957](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957)) | |
| tree | [698fb07b35611a8aad0634ea5e79bacc0be7638a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957) | |
| parent | [a3abb978305269e1fb048b4e714ea665c49e970a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3abb978305269e1fb048b4e714ea665c49e970a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957&id2=a3abb978305269e1fb048b4e714ea665c49e970a)) | |
| download | [linux-0ce59fb1c73fdd5b6028226aeb46259a0cdc0957.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0ce59fb1c73fdd5b6028226aeb46259a0cdc0957.tar.gz) | |

nilfs2: fix null-ptr-deref in block\_dirty\_buffer tracepointcommit 2026559a6c4ce34db117d2db8f710fe2a9420d5a upstream.
When using the "block:block\_dirty\_buffer" tracepoint, mark\_buffer\_dirty()
may cause a NULL pointer dereference, or a general protection fault when
KASAN is enabled.
This happens because, since the tracepoint was added in
mark\_buffer\_dirty(), it references the dev\_t member bh->b\_bdev->bd\_dev
regardless of whether the buffer head has a pointer to a block\_device
structure.
In the current implementation, nilfs\_grab\_buffer(), which grabs a buffer
to read (or create) a block of metadata, including b-tree node blocks,
does not set the block device, but instead does so only if the buffer is
not in the "uptodate" state for each of its caller block reading
functions. However, if the uptodate flag is set on a folio/page, and the
buffer heads are detached from it by try\_to\_free\_buffers(), and new buffer
heads are then attached by create\_empty\_buffers(), the uptodate flag may
be restored to each buffer without the block device being set to
bh->b\_bdev, and mark\_buffer\_dirty() may be called later in that state,
resulting in the bug mentioned above.
Fix this issue by making nilfs\_grab\_buffer() always set the block device
of the super block structure to the buffer head, regardless of the state
of the buffer's uptodate flag.
Link: [https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke%40gmail.com)
Fixes: 5305cb830834 ("block: add block\_{touch|dirty}\_buffer tracepoint")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Tejun Heo <tj@kernel.org>
Cc: Ubisectech Sirius <bugreport@valiantsec.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/gcinode.c?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/mdt.c?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 2 insertions, 6 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 28a726553318b0..1ced5bc551e491 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=a3abb978305269e1fb048b4e714ea665c49e970a)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957)@@ -68,7 +68,6 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode));- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = blocknr; set\_buffer\_mapped(bh); set\_buffer\_uptodate(bh);@@ -133,7 +132,6 @@ int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr, goto found; } set\_buffer\_mapped(bh);- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = pblocknr; /\* set block address for read \*/ bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/gcinode.c b/fs/nilfs2/gcinode.cindex b0077f5f711240..518e10be107365 100644--- a/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=a3abb978305269e1fb048b4e714ea665c49e970a)+++ b/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957)@@ -83,10 +83,8 @@ int nilfs\_gccache\_submit\_read\_data(struct inode \*inode, sector\_t blkoff, goto out; } - if (!buffer\_mapped(bh)) {- bh->b\_bdev = inode->i\_sb->s\_bdev;+ if (!buffer\_mapped(bh)) set\_buffer\_mapped(bh);- } bh->b\_blocknr = pbn; bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/mdt.c b/fs/nilfs2/mdt.cindex e80ef2c0a785c4..c1f9649164897b 100644--- a/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=a3abb978305269e1fb048b4e714ea665c49e970a)+++ b/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957)@@ -89,7 +89,6 @@ static int nilfs\_mdt\_create\_block(struct inode \*inode, unsigned long block, if (buffer\_uptodate(bh)) goto failed\_bh; - bh->b\_bdev = sb->s\_bdev; err = nilfs\_mdt\_insert\_new\_block(inode, block, bh, init\_block); if (likely(!err)) { get\_bh(bh);diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 19fdd49603fc71..a5b2fcab6d4a98 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=a3abb978305269e1fb048b4e714ea665c49e970a)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=0ce59fb1c73fdd5b6028226aeb46259a0cdc0957)@@ -63,6 +63,7 @@ struct buffer\_head \*nilfs\_grab\_buffer(struct inode \*inode, put\_page(page); return NULL; }+ bh->b\_bdev = inode->i\_sb->s\_bdev; return bh; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:58:20 +0000



=== Content from git.kernel.org_41abe793_20250114_215958.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-11-07 01:07:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:39:53 +0100 |
| commit | [ffc440a76a0f476a7e6ea838ec0dc8e9979944d1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1)) | |
| tree | [5fef64198ef757740548b60452506cf27515816c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1) | |
| parent | [271b4664a1dbab969870b14464f7e51f5b4f05e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=271b4664a1dbab969870b14464f7e51f5b4f05e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1&id2=271b4664a1dbab969870b14464f7e51f5b4f05e2)) | |
| download | [linux-ffc440a76a0f476a7e6ea838ec0dc8e9979944d1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ffc440a76a0f476a7e6ea838ec0dc8e9979944d1.tar.gz) | |

nilfs2: fix null-ptr-deref in block\_dirty\_buffer tracepointcommit 2026559a6c4ce34db117d2db8f710fe2a9420d5a upstream.
When using the "block:block\_dirty\_buffer" tracepoint, mark\_buffer\_dirty()
may cause a NULL pointer dereference, or a general protection fault when
KASAN is enabled.
This happens because, since the tracepoint was added in
mark\_buffer\_dirty(), it references the dev\_t member bh->b\_bdev->bd\_dev
regardless of whether the buffer head has a pointer to a block\_device
structure.
In the current implementation, nilfs\_grab\_buffer(), which grabs a buffer
to read (or create) a block of metadata, including b-tree node blocks,
does not set the block device, but instead does so only if the buffer is
not in the "uptodate" state for each of its caller block reading
functions. However, if the uptodate flag is set on a folio/page, and the
buffer heads are detached from it by try\_to\_free\_buffers(), and new buffer
heads are then attached by create\_empty\_buffers(), the uptodate flag may
be restored to each buffer without the block device being set to
bh->b\_bdev, and mark\_buffer\_dirty() may be called later in that state,
resulting in the bug mentioned above.
Fix this issue by making nilfs\_grab\_buffer() always set the block device
of the super block structure to the buffer head, regardless of the state
of the buffer's uptodate flag.
Link: [https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke%40gmail.com)
Fixes: 5305cb830834 ("block: add block\_{touch|dirty}\_buffer tracepoint")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Tejun Heo <tj@kernel.org>
Cc: Ubisectech Sirius <bugreport@valiantsec.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/gcinode.c?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/mdt.c?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 2 insertions, 6 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex c034080c334b98..5f894459bafefe 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=271b4664a1dbab969870b14464f7e51f5b4f05e2)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1)@@ -68,7 +68,6 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode));- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = blocknr; set\_buffer\_mapped(bh); set\_buffer\_uptodate(bh);@@ -133,7 +132,6 @@ int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr, goto found; } set\_buffer\_mapped(bh);- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = pblocknr; /\* set block address for read \*/ bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/gcinode.c b/fs/nilfs2/gcinode.cindex 1c9ae36a03abe9..ace22253fed0f2 100644--- a/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=271b4664a1dbab969870b14464f7e51f5b4f05e2)+++ b/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1)@@ -83,10 +83,8 @@ int nilfs\_gccache\_submit\_read\_data(struct inode \*inode, sector\_t blkoff, goto out; } - if (!buffer\_mapped(bh)) {- bh->b\_bdev = inode->i\_sb->s\_bdev;+ if (!buffer\_mapped(bh)) set\_buffer\_mapped(bh);- } bh->b\_blocknr = pbn; bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/mdt.c b/fs/nilfs2/mdt.cindex 4f792a0ad0f0ff..8e66f2c13ad658 100644--- a/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=271b4664a1dbab969870b14464f7e51f5b4f05e2)+++ b/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1)@@ -89,7 +89,6 @@ static int nilfs\_mdt\_create\_block(struct inode \*inode, unsigned long block, if (buffer\_uptodate(bh)) goto failed\_bh; - bh->b\_bdev = sb->s\_bdev; err = nilfs\_mdt\_insert\_new\_block(inode, block, bh, init\_block); if (likely(!err)) { get\_bh(bh);diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex e7fe0edb950738..d30114a713608d 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=271b4664a1dbab969870b14464f7e51f5b4f05e2)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=ffc440a76a0f476a7e6ea838ec0dc8e9979944d1)@@ -63,6 +63,7 @@ struct buffer\_head \*nilfs\_grab\_buffer(struct inode \*inode, folio\_put(folio); return NULL; }+ bh->b\_bdev = inode->i\_sb->s\_bdev; return bh; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:58:34 +0000



=== Content from git.kernel.org_7ac1f861_20250114_215947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-11-07 01:07:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:28 +0100 |
| commit | [7af3309c7a2ef26831a67125b11c34a7e01c1b2a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a)) | |
| tree | [7e6812178f34385075ea156b5fb689ef99c0c8b7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a) | |
| parent | [bfeda42c801f6e6a719ba3ace68648d72f120442](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfeda42c801f6e6a719ba3ace68648d72f120442) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a&id2=bfeda42c801f6e6a719ba3ace68648d72f120442)) | |
| download | [linux-7af3309c7a2ef26831a67125b11c34a7e01c1b2a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7af3309c7a2ef26831a67125b11c34a7e01c1b2a.tar.gz) | |

nilfs2: fix null-ptr-deref in block\_dirty\_buffer tracepointcommit 2026559a6c4ce34db117d2db8f710fe2a9420d5a upstream.
When using the "block:block\_dirty\_buffer" tracepoint, mark\_buffer\_dirty()
may cause a NULL pointer dereference, or a general protection fault when
KASAN is enabled.
This happens because, since the tracepoint was added in
mark\_buffer\_dirty(), it references the dev\_t member bh->b\_bdev->bd\_dev
regardless of whether the buffer head has a pointer to a block\_device
structure.
In the current implementation, nilfs\_grab\_buffer(), which grabs a buffer
to read (or create) a block of metadata, including b-tree node blocks,
does not set the block device, but instead does so only if the buffer is
not in the "uptodate" state for each of its caller block reading
functions. However, if the uptodate flag is set on a folio/page, and the
buffer heads are detached from it by try\_to\_free\_buffers(), and new buffer
heads are then attached by create\_empty\_buffers(), the uptodate flag may
be restored to each buffer without the block device being set to
bh->b\_bdev, and mark\_buffer\_dirty() may be called later in that state,
resulting in the bug mentioned above.
Fix this issue by making nilfs\_grab\_buffer() always set the block device
of the super block structure to the buffer head, regardless of the state
of the buffer's uptodate flag.
Link: [https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke%40gmail.com)
Fixes: 5305cb830834 ("block: add block\_{touch|dirty}\_buffer tracepoint")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Tejun Heo <tj@kernel.org>
Cc: Ubisectech Sirius <bugreport@valiantsec.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/gcinode.c?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/mdt.c?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 2 insertions, 6 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex eb195c33c9a9ed..799b42e83d7c4c 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=bfeda42c801f6e6a719ba3ace68648d72f120442)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a)@@ -68,7 +68,6 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode));- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = blocknr; set\_buffer\_mapped(bh); set\_buffer\_uptodate(bh);@@ -133,7 +132,6 @@ int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr, goto found; } set\_buffer\_mapped(bh);- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = pblocknr; /\* set block address for read \*/ bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/gcinode.c b/fs/nilfs2/gcinode.cindex b0077f5f711240..518e10be107365 100644--- a/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=bfeda42c801f6e6a719ba3ace68648d72f120442)+++ b/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a)@@ -83,10 +83,8 @@ int nilfs\_gccache\_submit\_read\_data(struct inode \*inode, sector\_t blkoff, goto out; } - if (!buffer\_mapped(bh)) {- bh->b\_bdev = inode->i\_sb->s\_bdev;+ if (!buffer\_mapped(bh)) set\_buffer\_mapped(bh);- } bh->b\_blocknr = pbn; bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/mdt.c b/fs/nilfs2/mdt.cindex e80ef2c0a785c4..c1f9649164897b 100644--- a/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=bfeda42c801f6e6a719ba3ace68648d72f120442)+++ b/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a)@@ -89,7 +89,6 @@ static int nilfs\_mdt\_create\_block(struct inode \*inode, unsigned long block, if (buffer\_uptodate(bh)) goto failed\_bh; - bh->b\_bdev = sb->s\_bdev; err = nilfs\_mdt\_insert\_new\_block(inode, block, bh, init\_block); if (likely(!err)) { get\_bh(bh);diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 6bad9ace61a6bf..beb095d49138aa 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=bfeda42c801f6e6a719ba3ace68648d72f120442)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=7af3309c7a2ef26831a67125b11c34a7e01c1b2a)@@ -63,6 +63,7 @@ struct buffer\_head \*nilfs\_grab\_buffer(struct inode \*inode, put\_page(page); return NULL; }+ bh->b\_bdev = inode->i\_sb->s\_bdev; return bh; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:58:23 +0000



=== Content from git.kernel.org_12ba9f04_20250114_215942.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-11-07 01:07:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:38 +0100 |
| commit | [0a5014ad37c77ac6a2c525137c00a0e1724f6020](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020)) | |
| tree | [2fcbc45cd7c3632af1140dd193fc2cb3d936f336](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020) | |
| parent | [344558d81c7c420b0a6968e3d29105ee84055730](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=344558d81c7c420b0a6968e3d29105ee84055730) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020&id2=344558d81c7c420b0a6968e3d29105ee84055730)) | |
| download | [linux-0a5014ad37c77ac6a2c525137c00a0e1724f6020.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0a5014ad37c77ac6a2c525137c00a0e1724f6020.tar.gz) | |

nilfs2: fix null-ptr-deref in block\_dirty\_buffer tracepointcommit 2026559a6c4ce34db117d2db8f710fe2a9420d5a upstream.
When using the "block:block\_dirty\_buffer" tracepoint, mark\_buffer\_dirty()
may cause a NULL pointer dereference, or a general protection fault when
KASAN is enabled.
This happens because, since the tracepoint was added in
mark\_buffer\_dirty(), it references the dev\_t member bh->b\_bdev->bd\_dev
regardless of whether the buffer head has a pointer to a block\_device
structure.
In the current implementation, nilfs\_grab\_buffer(), which grabs a buffer
to read (or create) a block of metadata, including b-tree node blocks,
does not set the block device, but instead does so only if the buffer is
not in the "uptodate" state for each of its caller block reading
functions. However, if the uptodate flag is set on a folio/page, and the
buffer heads are detached from it by try\_to\_free\_buffers(), and new buffer
heads are then attached by create\_empty\_buffers(), the uptodate flag may
be restored to each buffer without the block device being set to
bh->b\_bdev, and mark\_buffer\_dirty() may be called later in that state,
resulting in the bug mentioned above.
Fix this issue by making nilfs\_grab\_buffer() always set the block device
of the super block structure to the buffer head, regardless of the state
of the buffer's uptodate flag.
Link: [https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke%40gmail.com)
Fixes: 5305cb830834 ("block: add block\_{touch|dirty}\_buffer tracepoint")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Tejun Heo <tj@kernel.org>
Cc: Ubisectech Sirius <bugreport@valiantsec.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/gcinode.c?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/mdt.c?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 2 insertions, 6 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 28a726553318b0..1ced5bc551e491 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=344558d81c7c420b0a6968e3d29105ee84055730)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020)@@ -68,7 +68,6 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode));- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = blocknr; set\_buffer\_mapped(bh); set\_buffer\_uptodate(bh);@@ -133,7 +132,6 @@ int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr, goto found; } set\_buffer\_mapped(bh);- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = pblocknr; /\* set block address for read \*/ bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/gcinode.c b/fs/nilfs2/gcinode.cindex b0077f5f711240..518e10be107365 100644--- a/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=344558d81c7c420b0a6968e3d29105ee84055730)+++ b/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020)@@ -83,10 +83,8 @@ int nilfs\_gccache\_submit\_read\_data(struct inode \*inode, sector\_t blkoff, goto out; } - if (!buffer\_mapped(bh)) {- bh->b\_bdev = inode->i\_sb->s\_bdev;+ if (!buffer\_mapped(bh)) set\_buffer\_mapped(bh);- } bh->b\_blocknr = pbn; bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/mdt.c b/fs/nilfs2/mdt.cindex e80ef2c0a785c4..c1f9649164897b 100644--- a/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=344558d81c7c420b0a6968e3d29105ee84055730)+++ b/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020)@@ -89,7 +89,6 @@ static int nilfs\_mdt\_create\_block(struct inode \*inode, unsigned long block, if (buffer\_uptodate(bh)) goto failed\_bh; - bh->b\_bdev = sb->s\_bdev; err = nilfs\_mdt\_insert\_new\_block(inode, block, bh, init\_block); if (likely(!err)) { get\_bh(bh);diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 3efc0b39c20d2f..d2d6d5c761e8db 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=344558d81c7c420b0a6968e3d29105ee84055730)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=0a5014ad37c77ac6a2c525137c00a0e1724f6020)@@ -63,6 +63,7 @@ struct buffer\_head \*nilfs\_grab\_buffer(struct inode \*inode, put\_page(page); return NULL; }+ bh->b\_bdev = inode->i\_sb->s\_bdev; return bh; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:58:19 +0000



=== Content from git.kernel.org_eab532a2_20250114_215948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-11-07 01:07:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:37:31 +0100 |
| commit | [86b19031dbc79abc378dfae357f6ea33ebeb0c95](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95)) | |
| tree | [ac9e3e2ad946e2f693cf0e8ef106ded48a3aa71f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95) | |
| parent | [c5e0a6af5f2444f8928e9ed1b71f521ea84d5d23](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5e0a6af5f2444f8928e9ed1b71f521ea84d5d23) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95&id2=c5e0a6af5f2444f8928e9ed1b71f521ea84d5d23)) | |
| download | [linux-86b19031dbc79abc378dfae357f6ea33ebeb0c95.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-86b19031dbc79abc378dfae357f6ea33ebeb0c95.tar.gz) | |

nilfs2: fix null-ptr-deref in block\_dirty\_buffer tracepointcommit 2026559a6c4ce34db117d2db8f710fe2a9420d5a upstream.
When using the "block:block\_dirty\_buffer" tracepoint, mark\_buffer\_dirty()
may cause a NULL pointer dereference, or a general protection fault when
KASAN is enabled.
This happens because, since the tracepoint was added in
mark\_buffer\_dirty(), it references the dev\_t member bh->b\_bdev->bd\_dev
regardless of whether the buffer head has a pointer to a block\_device
structure.
In the current implementation, nilfs\_grab\_buffer(), which grabs a buffer
to read (or create) a block of metadata, including b-tree node blocks,
does not set the block device, but instead does so only if the buffer is
not in the "uptodate" state for each of its caller block reading
functions. However, if the uptodate flag is set on a folio/page, and the
buffer heads are detached from it by try\_to\_free\_buffers(), and new buffer
heads are then attached by create\_empty\_buffers(), the uptodate flag may
be restored to each buffer without the block device being set to
bh->b\_bdev, and mark\_buffer\_dirty() may be called later in that state,
resulting in the bug mentioned above.
Fix this issue by making nilfs\_grab\_buffer() always set the block device
of the super block structure to the buffer head, regardless of the state
of the buffer's uptodate flag.
Link: [https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke%40gmail.com)
Fixes: 5305cb830834 ("block: add block\_{touch|dirty}\_buffer tracepoint")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Tejun Heo <tj@kernel.org>
Cc: Ubisectech Sirius <bugreport@valiantsec.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/gcinode.c?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/mdt.c?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 2 insertions, 6 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 19ed9015bd6606..13d943df871dd0 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=c5e0a6af5f2444f8928e9ed1b71f521ea84d5d23)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95)@@ -68,7 +68,6 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode));- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = blocknr; set\_buffer\_mapped(bh); set\_buffer\_uptodate(bh);@@ -133,7 +132,6 @@ int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr, goto found; } set\_buffer\_mapped(bh);- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = pblocknr; /\* set block address for read \*/ bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/gcinode.c b/fs/nilfs2/gcinode.cindex fcd13da5d0125d..2f612288ea4517 100644--- a/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=c5e0a6af5f2444f8928e9ed1b71f521ea84d5d23)+++ b/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95)@@ -83,10 +83,8 @@ int nilfs\_gccache\_submit\_read\_data(struct inode \*inode, sector\_t blkoff, goto out; } - if (!buffer\_mapped(bh)) {- bh->b\_bdev = inode->i\_sb->s\_bdev;+ if (!buffer\_mapped(bh)) set\_buffer\_mapped(bh);- } bh->b\_blocknr = pbn; bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/mdt.c b/fs/nilfs2/mdt.cindex cbf4fa60eea217..d0808953296ac8 100644--- a/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=c5e0a6af5f2444f8928e9ed1b71f521ea84d5d23)+++ b/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95)@@ -89,7 +89,6 @@ static int nilfs\_mdt\_create\_block(struct inode \*inode, unsigned long block, if (buffer\_uptodate(bh)) goto failed\_bh; - bh->b\_bdev = sb->s\_bdev; err = nilfs\_mdt\_insert\_new\_block(inode, block, bh, init\_block); if (likely(!err)) { get\_bh(bh);diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 0854b786a513d4..b4e2192e87967f 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=c5e0a6af5f2444f8928e9ed1b71f521ea84d5d23)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=86b19031dbc79abc378dfae357f6ea33ebeb0c95)@@ -63,6 +63,7 @@ struct buffer\_head \*nilfs\_grab\_buffer(struct inode \*inode, put\_page(page); return NULL; }+ bh->b\_bdev = inode->i\_sb->s\_bdev; return bh; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:58:25 +0000



=== Content from git.kernel.org_4c24c15d_20250114_215955.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-11-07 01:07:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:36 +0100 |
| commit | [d904e4d845aafbcfd8a40c1df7d999f02f062be8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8)) | |
| tree | [43fff434e281a0806428a9e070538b7ed334fd9f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8) | |
| parent | [647f416d31ace649df6995abcf8a9b47821a4dea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=647f416d31ace649df6995abcf8a9b47821a4dea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8&id2=647f416d31ace649df6995abcf8a9b47821a4dea)) | |
| download | [linux-d904e4d845aafbcfd8a40c1df7d999f02f062be8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d904e4d845aafbcfd8a40c1df7d999f02f062be8.tar.gz) | |

nilfs2: fix null-ptr-deref in block\_dirty\_buffer tracepointcommit 2026559a6c4ce34db117d2db8f710fe2a9420d5a upstream.
When using the "block:block\_dirty\_buffer" tracepoint, mark\_buffer\_dirty()
may cause a NULL pointer dereference, or a general protection fault when
KASAN is enabled.
This happens because, since the tracepoint was added in
mark\_buffer\_dirty(), it references the dev\_t member bh->b\_bdev->bd\_dev
regardless of whether the buffer head has a pointer to a block\_device
structure.
In the current implementation, nilfs\_grab\_buffer(), which grabs a buffer
to read (or create) a block of metadata, including b-tree node blocks,
does not set the block device, but instead does so only if the buffer is
not in the "uptodate" state for each of its caller block reading
functions. However, if the uptodate flag is set on a folio/page, and the
buffer heads are detached from it by try\_to\_free\_buffers(), and new buffer
heads are then attached by create\_empty\_buffers(), the uptodate flag may
be restored to each buffer without the block device being set to
bh->b\_bdev, and mark\_buffer\_dirty() may be called later in that state,
resulting in the bug mentioned above.
Fix this issue by making nilfs\_grab\_buffer() always set the block device
of the super block structure to the buffer head, regardless of the state
of the buffer's uptodate flag.
Link: [https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke%40gmail.com)
Fixes: 5305cb830834 ("block: add block\_{touch|dirty}\_buffer tracepoint")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Tejun Heo <tj@kernel.org>
Cc: Ubisectech Sirius <bugreport@valiantsec.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/gcinode.c?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/mdt.c?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 2 insertions, 6 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 28a726553318b0..1ced5bc551e491 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=647f416d31ace649df6995abcf8a9b47821a4dea)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8)@@ -68,7 +68,6 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode));- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = blocknr; set\_buffer\_mapped(bh); set\_buffer\_uptodate(bh);@@ -133,7 +132,6 @@ int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr, goto found; } set\_buffer\_mapped(bh);- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = pblocknr; /\* set block address for read \*/ bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/gcinode.c b/fs/nilfs2/gcinode.cindex b0077f5f711240..518e10be107365 100644--- a/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=647f416d31ace649df6995abcf8a9b47821a4dea)+++ b/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8)@@ -83,10 +83,8 @@ int nilfs\_gccache\_submit\_read\_data(struct inode \*inode, sector\_t blkoff, goto out; } - if (!buffer\_mapped(bh)) {- bh->b\_bdev = inode->i\_sb->s\_bdev;+ if (!buffer\_mapped(bh)) set\_buffer\_mapped(bh);- } bh->b\_blocknr = pbn; bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/mdt.c b/fs/nilfs2/mdt.cindex 131b5add32eebe..bd3e0f9144ff0d 100644--- a/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=647f416d31ace649df6995abcf8a9b47821a4dea)+++ b/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8)@@ -89,7 +89,6 @@ static int nilfs\_mdt\_create\_block(struct inode \*inode, unsigned long block, if (buffer\_uptodate(bh)) goto failed\_bh; - bh->b\_bdev = sb->s\_bdev; err = nilfs\_mdt\_insert\_new\_block(inode, block, bh, init\_block); if (likely(!err)) { get\_bh(bh);diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 3efc0b39c20d2f..d2d6d5c761e8db 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=647f416d31ace649df6995abcf8a9b47821a4dea)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=d904e4d845aafbcfd8a40c1df7d999f02f062be8)@@ -63,6 +63,7 @@ struct buffer\_head \*nilfs\_grab\_buffer(struct inode \*inode, put\_page(page); return NULL; }+ bh->b\_bdev = inode->i\_sb->s\_bdev; return bh; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:58:30 +0000



=== Content from git.kernel.org_0bacdef6_20250114_215951.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b0e4765740040c44039282057ecacd7435d1d2ba)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0e4765740040c44039282057ecacd7435d1d2ba)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0e4765740040c44039282057ecacd7435d1d2ba)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0e4765740040c44039282057ecacd7435d1d2ba)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-11-07 01:07:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:38:34 +0100 |
| commit | [b0e4765740040c44039282057ecacd7435d1d2ba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0e4765740040c44039282057ecacd7435d1d2ba) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b0e4765740040c44039282057ecacd7435d1d2ba)) | |
| tree | [b4d81ff55c0976c19497ab399c1c50ffd5567b6e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0e4765740040c44039282057ecacd7435d1d2ba) | |
| parent | [672668e0208f684f1430ab66a4d650a9de6f372e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=672668e0208f684f1430ab66a4d650a9de6f372e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0e4765740040c44039282057ecacd7435d1d2ba&id2=672668e0208f684f1430ab66a4d650a9de6f372e)) | |
| download | [linux-b0e4765740040c44039282057ecacd7435d1d2ba.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b0e4765740040c44039282057ecacd7435d1d2ba.tar.gz) | |

nilfs2: fix null-ptr-deref in block\_dirty\_buffer tracepointcommit 2026559a6c4ce34db117d2db8f710fe2a9420d5a upstream.
When using the "block:block\_dirty\_buffer" tracepoint, mark\_buffer\_dirty()
may cause a NULL pointer dereference, or a general protection fault when
KASAN is enabled.
This happens because, since the tracepoint was added in
mark\_buffer\_dirty(), it references the dev\_t member bh->b\_bdev->bd\_dev
regardless of whether the buffer head has a pointer to a block\_device
structure.
In the current implementation, nilfs\_grab\_buffer(), which grabs a buffer
to read (or create) a block of metadata, including b-tree node blocks,
does not set the block device, but instead does so only if the buffer is
not in the "uptodate" state for each of its caller block reading
functions. However, if the uptodate flag is set on a folio/page, and the
buffer heads are detached from it by try\_to\_free\_buffers(), and new buffer
heads are then attached by create\_empty\_buffers(), the uptodate flag may
be restored to each buffer without the block device being set to
bh->b\_bdev, and mark\_buffer\_dirty() may be called later in that state,
resulting in the bug mentioned above.
Fix this issue by making nilfs\_grab\_buffer() always set the block device
of the super block structure to the buffer head, regardless of the state
of the buffer's uptodate flag.
Link: [https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241106160811.3316-3-konishi.ryusuke%40gmail.com)
Fixes: 5305cb830834 ("block: add block\_{touch|dirty}\_buffer tracepoint")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Tejun Heo <tj@kernel.org>
Cc: Ubisectech Sirius <bugreport@valiantsec.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0e4765740040c44039282057ecacd7435d1d2ba)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=b0e4765740040c44039282057ecacd7435d1d2ba) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/gcinode.c?id=b0e4765740040c44039282057ecacd7435d1d2ba) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/mdt.c?id=b0e4765740040c44039282057ecacd7435d1d2ba) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=b0e4765740040c44039282057ecacd7435d1d2ba) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 2 insertions, 6 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 8fe348bceabe0b..eaf646b45cc9c1 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=672668e0208f684f1430ab66a4d650a9de6f372e)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=b0e4765740040c44039282057ecacd7435d1d2ba)@@ -68,7 +68,6 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode));- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = blocknr; set\_buffer\_mapped(bh); set\_buffer\_uptodate(bh);@@ -133,7 +132,6 @@ int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr, goto found; } set\_buffer\_mapped(bh);- bh->b\_bdev = inode->i\_sb->s\_bdev; bh->b\_blocknr = pblocknr; /\* set block address for read \*/ bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/gcinode.c b/fs/nilfs2/gcinode.cindex 8beb2730929d43..c5a119f3cb0d47 100644--- a/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=672668e0208f684f1430ab66a4d650a9de6f372e)+++ b/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=b0e4765740040c44039282057ecacd7435d1d2ba)@@ -83,10 +83,8 @@ int nilfs\_gccache\_submit\_read\_data(struct inode \*inode, sector\_t blkoff, goto out; } - if (!buffer\_mapped(bh)) {- bh->b\_bdev = inode->i\_sb->s\_bdev;+ if (!buffer\_mapped(bh)) set\_buffer\_mapped(bh);- } bh->b\_blocknr = pbn; bh->b\_end\_io = end\_buffer\_read\_sync; get\_bh(bh);diff --git a/fs/nilfs2/mdt.c b/fs/nilfs2/mdt.cindex 19c8158605ed0d..75a2ed5ee6e09b 100644--- a/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=672668e0208f684f1430ab66a4d650a9de6f372e)+++ b/[fs/nilfs2/mdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/mdt.c?id=b0e4765740040c44039282057ecacd7435d1d2ba)@@ -89,7 +89,6 @@ static int nilfs\_mdt\_create\_block(struct inode \*inode, unsigned long block, if (buffer\_uptodate(bh)) goto failed\_bh; - bh->b\_bdev = sb->s\_bdev; err = nilfs\_mdt\_insert\_new\_block(inode, block, bh, init\_block); if (likely(!err)) { get\_bh(bh);diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 92266fe63cf586..144e200c4909a9 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=672668e0208f684f1430ab66a4d650a9de6f372e)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=b0e4765740040c44039282057ecacd7435d1d2ba)@@ -63,6 +63,7 @@ struct buffer\_head \*nilfs\_grab\_buffer(struct inode \*inode, put\_page(page); return NULL; }+ bh->b\_bdev = inode->i\_sb->s\_bdev; return bh; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:58:26 +0000


