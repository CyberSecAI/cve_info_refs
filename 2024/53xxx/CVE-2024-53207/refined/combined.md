=== Content from git.kernel.org_0b6a9162_20250114_204630.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-11-21 11:09:22 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:35 +0100 |
| commit | [cac34e44281f1f1bd842adbbcfe3ef9ff0905111](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111)) | |
| tree | [bab5945fc9dda1cd11850315b7883fc4afb83eb7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111) | |
| parent | [87819234aa1d2a0cb0f962fabb335e798f5ec8b2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87819234aa1d2a0cb0f962fabb335e798f5ec8b2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111&id2=87819234aa1d2a0cb0f962fabb335e798f5ec8b2)) | |
| download | [linux-cac34e44281f1f1bd842adbbcfe3ef9ff0905111.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cac34e44281f1f1bd842adbbcfe3ef9ff0905111.tar.gz) | |

Bluetooth: MGMT: Fix possible deadlocks[ Upstream commit a66dfaf18fd61bb75ef8cee83db46b2aadf153d0 ]
This fixes possible deadlocks like the following caused by
hci\_cmd\_sync\_dequeue causing the destroy function to run:
INFO: task kworker/u19:0:143 blocked for more than 120 seconds.
Tainted: G W O 6.8.0-2024-03-19-intel-next-iLS-24ww14 #1
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
task:kworker/u19:0 state:D stack:0 pid:143 tgid:143 ppid:2 flags:0x00004000
Workqueue: hci0 hci\_cmd\_sync\_work [bluetooth]
Call Trace:
<TASK>
\_\_schedule+0x374/0xaf0
schedule+0x3c/0xf0
schedule\_preempt\_disabled+0x1c/0x30
\_\_mutex\_lock.constprop.0+0x3ef/0x7a0
\_\_mutex\_lock\_slowpath+0x13/0x20
mutex\_lock+0x3c/0x50
mgmt\_set\_connectable\_complete+0xa4/0x150 [bluetooth]
? kfree+0x211/0x2a0
hci\_cmd\_sync\_dequeue+0xae/0x130 [bluetooth]
? \_\_pfx\_cmd\_complete\_rsp+0x10/0x10 [bluetooth]
cmd\_complete\_rsp+0x26/0x80 [bluetooth]
mgmt\_pending\_foreach+0x4d/0x70 [bluetooth]
\_\_mgmt\_power\_off+0x8d/0x180 [bluetooth]
? \_raw\_spin\_unlock\_irq+0x23/0x40
hci\_dev\_close\_sync+0x445/0x5b0 [bluetooth]
hci\_set\_powered\_sync+0x149/0x250 [bluetooth]
set\_powered\_sync+0x24/0x60 [bluetooth]
hci\_cmd\_sync\_work+0x90/0x150 [bluetooth]
process\_one\_work+0x13e/0x300
worker\_thread+0x2f7/0x420
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0x107/0x140
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x3d/0x60
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1b/0x30
</TASK>
Tested-by: Kiran K <kiran.k@intel.com>
Fixes: f53e1c9c726d ("Bluetooth: MGMT: Fix possible crash on mgmt\_index\_removed")
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111)

| -rw-r--r-- | [net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/mgmt.c?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 9 deletions

| diff --git a/net/bluetooth/mgmt.c b/net/bluetooth/mgmt.cindex 37e9175be05761..2343e15f8938ec 100644--- a/[net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/mgmt.c?id=87819234aa1d2a0cb0f962fabb335e798f5ec8b2)+++ b/[net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/mgmt.c?id=cac34e44281f1f1bd842adbbcfe3ef9ff0905111)@@ -1517,7 +1517,8 @@ static void mgmt\_set\_discoverable\_complete(struct hci\_dev \*hdev, void \*data, bt\_dev\_dbg(hdev, "err %d", err);  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_DISCOVERABLE, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_DISCOVERABLE, hdev)) return;  hci\_dev\_lock(hdev);@@ -1691,7 +1692,8 @@ static void mgmt\_set\_connectable\_complete(struct hci\_dev \*hdev, void \*data, bt\_dev\_dbg(hdev, "err %d", err);  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_CONNECTABLE, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_CONNECTABLE, hdev)) return;  hci\_dev\_lock(hdev);@@ -1923,7 +1925,7 @@ static void set\_ssp\_complete(struct hci\_dev \*hdev, void \*data, int err) bool changed;  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_SSP, hdev))+ if (err == -ECANCELED || cmd != pending\_find(MGMT\_OP\_SET\_SSP, hdev)) return;  if (err) {@@ -3789,7 +3791,8 @@ static void set\_name\_complete(struct hci\_dev \*hdev, void \*data, int err)  bt\_dev\_dbg(hdev, "err %d", err); - if (cmd != pending\_find(MGMT\_OP\_SET\_LOCAL\_NAME, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_LOCAL\_NAME, hdev)) return;  if (status) {@@ -3964,7 +3967,8 @@ static void set\_default\_phy\_complete(struct hci\_dev \*hdev, void \*data, int err) struct sk\_buff \*skb = cmd->skb; u8 status = mgmt\_status(err); - if (cmd != pending\_find(MGMT\_OP\_SET\_PHY\_CONFIGURATION, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_PHY\_CONFIGURATION, hdev)) return;  if (!status) {@@ -5855,13 +5859,16 @@ static void start\_discovery\_complete(struct hci\_dev \*hdev, void \*data, int err) { struct mgmt\_pending\_cmd \*cmd = data; + bt\_dev\_dbg(hdev, "err %d", err);++ if (err == -ECANCELED)+ return;+ if (cmd != pending\_find(MGMT\_OP\_START\_DISCOVERY, hdev) && cmd != pending\_find(MGMT\_OP\_START\_LIMITED\_DISCOVERY, hdev) && cmd != pending\_find(MGMT\_OP\_START\_SERVICE\_DISCOVERY, hdev)) return; - bt\_dev\_dbg(hdev, "err %d", err);- mgmt\_cmd\_complete(cmd->sk, cmd->index, cmd->opcode, mgmt\_status(err), cmd->param, 1); mgmt\_pending\_remove(cmd);@@ -6094,7 +6101,8 @@ static void stop\_discovery\_complete(struct hci\_dev \*hdev, void \*data, int err) { struct mgmt\_pending\_cmd \*cmd = data; - if (cmd != pending\_find(MGMT\_OP\_STOP\_DISCOVERY, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_STOP\_DISCOVERY, hdev)) return;  bt\_dev\_dbg(hdev, "err %d", err);@@ -8085,7 +8093,8 @@ static void read\_local\_oob\_ext\_data\_complete(struct hci\_dev \*hdev, void \*data, u8 status = mgmt\_status(err); u16 eir\_len; - if (cmd != pending\_find(MGMT\_OP\_READ\_LOCAL\_OOB\_EXT\_DATA, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_READ\_LOCAL\_OOB\_EXT\_DATA, hdev)) return;  if (!status) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:45:07 +0000



=== Content from git.kernel.org_e9b000c8_20250114_204629.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c3f594a3473d6429a0bcf2004cb2885368741b79)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3f594a3473d6429a0bcf2004cb2885368741b79)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3f594a3473d6429a0bcf2004cb2885368741b79)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3f594a3473d6429a0bcf2004cb2885368741b79)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-11-21 11:09:22 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:56 +0100 |
| commit | [c3f594a3473d6429a0bcf2004cb2885368741b79](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3f594a3473d6429a0bcf2004cb2885368741b79) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c3f594a3473d6429a0bcf2004cb2885368741b79)) | |
| tree | [1c9e288aa5fdfe72c96040ccef703d94e19d59bc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3f594a3473d6429a0bcf2004cb2885368741b79) | |
| parent | [56bddf543d4d7ddeff3f87b554ddacfdf086bffe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56bddf543d4d7ddeff3f87b554ddacfdf086bffe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3f594a3473d6429a0bcf2004cb2885368741b79&id2=56bddf543d4d7ddeff3f87b554ddacfdf086bffe)) | |
| download | [linux-c3f594a3473d6429a0bcf2004cb2885368741b79.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c3f594a3473d6429a0bcf2004cb2885368741b79.tar.gz) | |

Bluetooth: MGMT: Fix possible deadlockscommit a66dfaf18fd61bb75ef8cee83db46b2aadf153d0 upstream.
This fixes possible deadlocks like the following caused by
hci\_cmd\_sync\_dequeue causing the destroy function to run:
INFO: task kworker/u19:0:143 blocked for more than 120 seconds.
Tainted: G W O 6.8.0-2024-03-19-intel-next-iLS-24ww14 #1
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
task:kworker/u19:0 state:D stack:0 pid:143 tgid:143 ppid:2 flags:0x00004000
Workqueue: hci0 hci\_cmd\_sync\_work [bluetooth]
Call Trace:
<TASK>
\_\_schedule+0x374/0xaf0
schedule+0x3c/0xf0
schedule\_preempt\_disabled+0x1c/0x30
\_\_mutex\_lock.constprop.0+0x3ef/0x7a0
\_\_mutex\_lock\_slowpath+0x13/0x20
mutex\_lock+0x3c/0x50
mgmt\_set\_connectable\_complete+0xa4/0x150 [bluetooth]
? kfree+0x211/0x2a0
hci\_cmd\_sync\_dequeue+0xae/0x130 [bluetooth]
? \_\_pfx\_cmd\_complete\_rsp+0x10/0x10 [bluetooth]
cmd\_complete\_rsp+0x26/0x80 [bluetooth]
mgmt\_pending\_foreach+0x4d/0x70 [bluetooth]
\_\_mgmt\_power\_off+0x8d/0x180 [bluetooth]
? \_raw\_spin\_unlock\_irq+0x23/0x40
hci\_dev\_close\_sync+0x445/0x5b0 [bluetooth]
hci\_set\_powered\_sync+0x149/0x250 [bluetooth]
set\_powered\_sync+0x24/0x60 [bluetooth]
hci\_cmd\_sync\_work+0x90/0x150 [bluetooth]
process\_one\_work+0x13e/0x300
worker\_thread+0x2f7/0x420
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0x107/0x140
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x3d/0x60
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1b/0x30
</TASK>
Tested-by: Kiran K <kiran.k@intel.com>
Fixes: f53e1c9c726d ("Bluetooth: MGMT: Fix possible crash on mgmt\_index\_removed")
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3f594a3473d6429a0bcf2004cb2885368741b79)

| -rw-r--r-- | [net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/mgmt.c?id=c3f594a3473d6429a0bcf2004cb2885368741b79) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 9 deletions

| diff --git a/net/bluetooth/mgmt.c b/net/bluetooth/mgmt.cindex 2876db19b071d5..dc3921269a5ab5 100644--- a/[net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/mgmt.c?id=56bddf543d4d7ddeff3f87b554ddacfdf086bffe)+++ b/[net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/mgmt.c?id=c3f594a3473d6429a0bcf2004cb2885368741b79)@@ -1521,7 +1521,8 @@ static void mgmt\_set\_discoverable\_complete(struct hci\_dev \*hdev, void \*data, bt\_dev\_dbg(hdev, "err %d", err);  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_DISCOVERABLE, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_DISCOVERABLE, hdev)) return;  hci\_dev\_lock(hdev);@@ -1695,7 +1696,8 @@ static void mgmt\_set\_connectable\_complete(struct hci\_dev \*hdev, void \*data, bt\_dev\_dbg(hdev, "err %d", err);  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_CONNECTABLE, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_CONNECTABLE, hdev)) return;  hci\_dev\_lock(hdev);@@ -1928,7 +1930,7 @@ static void set\_ssp\_complete(struct hci\_dev \*hdev, void \*data, int err) bool changed;  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_SSP, hdev))+ if (err == -ECANCELED || cmd != pending\_find(MGMT\_OP\_SET\_SSP, hdev)) return;  if (err) {@@ -3853,7 +3855,8 @@ static void set\_name\_complete(struct hci\_dev \*hdev, void \*data, int err)  bt\_dev\_dbg(hdev, "err %d", err); - if (cmd != pending\_find(MGMT\_OP\_SET\_LOCAL\_NAME, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_LOCAL\_NAME, hdev)) return;  if (status) {@@ -4028,7 +4031,8 @@ static void set\_default\_phy\_complete(struct hci\_dev \*hdev, void \*data, int err) struct sk\_buff \*skb = cmd->skb; u8 status = mgmt\_status(err); - if (cmd != pending\_find(MGMT\_OP\_SET\_PHY\_CONFIGURATION, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_PHY\_CONFIGURATION, hdev)) return;  if (!status) {@@ -5919,13 +5923,16 @@ static void start\_discovery\_complete(struct hci\_dev \*hdev, void \*data, int err) { struct mgmt\_pending\_cmd \*cmd = data; + bt\_dev\_dbg(hdev, "err %d", err);++ if (err == -ECANCELED)+ return;+ if (cmd != pending\_find(MGMT\_OP\_START\_DISCOVERY, hdev) && cmd != pending\_find(MGMT\_OP\_START\_LIMITED\_DISCOVERY, hdev) && cmd != pending\_find(MGMT\_OP\_START\_SERVICE\_DISCOVERY, hdev)) return; - bt\_dev\_dbg(hdev, "err %d", err);- mgmt\_cmd\_complete(cmd->sk, cmd->index, cmd->opcode, mgmt\_status(err), cmd->param, 1); mgmt\_pending\_remove(cmd);@@ -6158,7 +6165,8 @@ static void stop\_discovery\_complete(struct hci\_dev \*hdev, void \*data, int err) { struct mgmt\_pending\_cmd \*cmd = data; - if (cmd != pending\_find(MGMT\_OP\_STOP\_DISCOVERY, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_STOP\_DISCOVERY, hdev)) return;  bt\_dev\_dbg(hdev, "err %d", err);@@ -8105,7 +8113,8 @@ static void read\_local\_oob\_ext\_data\_complete(struct hci\_dev \*hdev, void \*data, u8 status = mgmt\_status(err); u16 eir\_len; - if (cmd != pending\_find(MGMT\_OP\_READ\_LOCAL\_OOB\_EXT\_DATA, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_READ\_LOCAL\_OOB\_EXT\_DATA, hdev)) return;  if (!status) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:45:06 +0000



=== Content from git.kernel.org_ea759fa7_20250114_204625.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5703fb1d85f653e35b327b14de4db7da239e4fd9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5703fb1d85f653e35b327b14de4db7da239e4fd9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5703fb1d85f653e35b327b14de4db7da239e4fd9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5703fb1d85f653e35b327b14de4db7da239e4fd9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-11-21 11:09:22 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:35 +0100 |
| commit | [5703fb1d85f653e35b327b14de4db7da239e4fd9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5703fb1d85f653e35b327b14de4db7da239e4fd9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5703fb1d85f653e35b327b14de4db7da239e4fd9)) | |
| tree | [e07ff06d536a9a90014e35e24e145a661ab1cf47](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5703fb1d85f653e35b327b14de4db7da239e4fd9) | |
| parent | [95f7a972194ad20696c36523b54c19a3567e0697](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95f7a972194ad20696c36523b54c19a3567e0697) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5703fb1d85f653e35b327b14de4db7da239e4fd9&id2=95f7a972194ad20696c36523b54c19a3567e0697)) | |
| download | [linux-5703fb1d85f653e35b327b14de4db7da239e4fd9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5703fb1d85f653e35b327b14de4db7da239e4fd9.tar.gz) | |

Bluetooth: MGMT: Fix possible deadlocks[ Upstream commit a66dfaf18fd61bb75ef8cee83db46b2aadf153d0 ]
This fixes possible deadlocks like the following caused by
hci\_cmd\_sync\_dequeue causing the destroy function to run:
INFO: task kworker/u19:0:143 blocked for more than 120 seconds.
Tainted: G W O 6.8.0-2024-03-19-intel-next-iLS-24ww14 #1
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
task:kworker/u19:0 state:D stack:0 pid:143 tgid:143 ppid:2 flags:0x00004000
Workqueue: hci0 hci\_cmd\_sync\_work [bluetooth]
Call Trace:
<TASK>
\_\_schedule+0x374/0xaf0
schedule+0x3c/0xf0
schedule\_preempt\_disabled+0x1c/0x30
\_\_mutex\_lock.constprop.0+0x3ef/0x7a0
\_\_mutex\_lock\_slowpath+0x13/0x20
mutex\_lock+0x3c/0x50
mgmt\_set\_connectable\_complete+0xa4/0x150 [bluetooth]
? kfree+0x211/0x2a0
hci\_cmd\_sync\_dequeue+0xae/0x130 [bluetooth]
? \_\_pfx\_cmd\_complete\_rsp+0x10/0x10 [bluetooth]
cmd\_complete\_rsp+0x26/0x80 [bluetooth]
mgmt\_pending\_foreach+0x4d/0x70 [bluetooth]
\_\_mgmt\_power\_off+0x8d/0x180 [bluetooth]
? \_raw\_spin\_unlock\_irq+0x23/0x40
hci\_dev\_close\_sync+0x445/0x5b0 [bluetooth]
hci\_set\_powered\_sync+0x149/0x250 [bluetooth]
set\_powered\_sync+0x24/0x60 [bluetooth]
hci\_cmd\_sync\_work+0x90/0x150 [bluetooth]
process\_one\_work+0x13e/0x300
worker\_thread+0x2f7/0x420
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0x107/0x140
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x3d/0x60
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1b/0x30
</TASK>
Tested-by: Kiran K <kiran.k@intel.com>
Fixes: f53e1c9c726d ("Bluetooth: MGMT: Fix possible crash on mgmt\_index\_removed")
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5703fb1d85f653e35b327b14de4db7da239e4fd9)

| -rw-r--r-- | [net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/mgmt.c?id=5703fb1d85f653e35b327b14de4db7da239e4fd9) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 9 deletions

| diff --git a/net/bluetooth/mgmt.c b/net/bluetooth/mgmt.cindex f84912552d294c..1175248e4bec4b 100644--- a/[net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/mgmt.c?id=95f7a972194ad20696c36523b54c19a3567e0697)+++ b/[net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/mgmt.c?id=5703fb1d85f653e35b327b14de4db7da239e4fd9)@@ -1510,7 +1510,8 @@ static void mgmt\_set\_discoverable\_complete(struct hci\_dev \*hdev, void \*data, bt\_dev\_dbg(hdev, "err %d", err);  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_DISCOVERABLE, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_DISCOVERABLE, hdev)) return;  hci\_dev\_lock(hdev);@@ -1684,7 +1685,8 @@ static void mgmt\_set\_connectable\_complete(struct hci\_dev \*hdev, void \*data, bt\_dev\_dbg(hdev, "err %d", err);  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_CONNECTABLE, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_CONNECTABLE, hdev)) return;  hci\_dev\_lock(hdev);@@ -1917,7 +1919,7 @@ static void set\_ssp\_complete(struct hci\_dev \*hdev, void \*data, int err) bool changed;  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_SSP, hdev))+ if (err == -ECANCELED || cmd != pending\_find(MGMT\_OP\_SET\_SSP, hdev)) return;  if (err) {@@ -3782,7 +3784,8 @@ static void set\_name\_complete(struct hci\_dev \*hdev, void \*data, int err)  bt\_dev\_dbg(hdev, "err %d", err); - if (cmd != pending\_find(MGMT\_OP\_SET\_LOCAL\_NAME, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_LOCAL\_NAME, hdev)) return;  if (status) {@@ -3957,7 +3960,8 @@ static void set\_default\_phy\_complete(struct hci\_dev \*hdev, void \*data, int err) struct sk\_buff \*skb = cmd->skb; u8 status = mgmt\_status(err); - if (cmd != pending\_find(MGMT\_OP\_SET\_PHY\_CONFIGURATION, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_PHY\_CONFIGURATION, hdev)) return;  if (!status) {@@ -5848,13 +5852,16 @@ static void start\_discovery\_complete(struct hci\_dev \*hdev, void \*data, int err) { struct mgmt\_pending\_cmd \*cmd = data; + bt\_dev\_dbg(hdev, "err %d", err);++ if (err == -ECANCELED)+ return;+ if (cmd != pending\_find(MGMT\_OP\_START\_DISCOVERY, hdev) && cmd != pending\_find(MGMT\_OP\_START\_LIMITED\_DISCOVERY, hdev) && cmd != pending\_find(MGMT\_OP\_START\_SERVICE\_DISCOVERY, hdev)) return; - bt\_dev\_dbg(hdev, "err %d", err);- mgmt\_cmd\_complete(cmd->sk, cmd->index, cmd->opcode, mgmt\_status(err), cmd->param, 1); mgmt\_pending\_remove(cmd);@@ -6087,7 +6094,8 @@ static void stop\_discovery\_complete(struct hci\_dev \*hdev, void \*data, int err) { struct mgmt\_pending\_cmd \*cmd = data; - if (cmd != pending\_find(MGMT\_OP\_STOP\_DISCOVERY, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_STOP\_DISCOVERY, hdev)) return;  bt\_dev\_dbg(hdev, "err %d", err);@@ -8032,7 +8040,8 @@ static void read\_local\_oob\_ext\_data\_complete(struct hci\_dev \*hdev, void \*data, u8 status = mgmt\_status(err); u16 eir\_len; - if (cmd != pending\_find(MGMT\_OP\_READ\_LOCAL\_OOB\_EXT\_DATA, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_READ\_LOCAL\_OOB\_EXT\_DATA, hdev)) return;  if (!status) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:45:02 +0000



=== Content from git.kernel.org_9277970a_20250114_204627.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-11-21 11:09:22 -0500 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-11-26 11:07:25 -0500 |
| commit | [a66dfaf18fd61bb75ef8cee83db46b2aadf153d0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0)) | |
| tree | [8945a114d8abc9eae560ffa0a9879a244e2a592a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0) | |
| parent | [0b882940665ca2849386ee459d4331aa2f8c4e7d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b882940665ca2849386ee459d4331aa2f8c4e7d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0&id2=0b882940665ca2849386ee459d4331aa2f8c4e7d)) | |
| download | [linux-a66dfaf18fd61bb75ef8cee83db46b2aadf153d0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a66dfaf18fd61bb75ef8cee83db46b2aadf153d0.tar.gz) | |

Bluetooth: MGMT: Fix possible deadlocksThis fixes possible deadlocks like the following caused by
hci\_cmd\_sync\_dequeue causing the destroy function to run:
INFO: task kworker/u19:0:143 blocked for more than 120 seconds.
Tainted: G W O 6.8.0-2024-03-19-intel-next-iLS-24ww14 #1
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
task:kworker/u19:0 state:D stack:0 pid:143 tgid:143 ppid:2 flags:0x00004000
Workqueue: hci0 hci\_cmd\_sync\_work [bluetooth]
Call Trace:
<TASK>
\_\_schedule+0x374/0xaf0
schedule+0x3c/0xf0
schedule\_preempt\_disabled+0x1c/0x30
\_\_mutex\_lock.constprop.0+0x3ef/0x7a0
\_\_mutex\_lock\_slowpath+0x13/0x20
mutex\_lock+0x3c/0x50
mgmt\_set\_connectable\_complete+0xa4/0x150 [bluetooth]
? kfree+0x211/0x2a0
hci\_cmd\_sync\_dequeue+0xae/0x130 [bluetooth]
? \_\_pfx\_cmd\_complete\_rsp+0x10/0x10 [bluetooth]
cmd\_complete\_rsp+0x26/0x80 [bluetooth]
mgmt\_pending\_foreach+0x4d/0x70 [bluetooth]
\_\_mgmt\_power\_off+0x8d/0x180 [bluetooth]
? \_raw\_spin\_unlock\_irq+0x23/0x40
hci\_dev\_close\_sync+0x445/0x5b0 [bluetooth]
hci\_set\_powered\_sync+0x149/0x250 [bluetooth]
set\_powered\_sync+0x24/0x60 [bluetooth]
hci\_cmd\_sync\_work+0x90/0x150 [bluetooth]
process\_one\_work+0x13e/0x300
worker\_thread+0x2f7/0x420
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0x107/0x140
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x3d/0x60
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1b/0x30
</TASK>
Tested-by: Kiran K <kiran.k@intel.com>
Fixes: f53e1c9c726d ("Bluetooth: MGMT: Fix possible crash on mgmt\_index\_removed")
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0)

| -rw-r--r-- | [net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/mgmt.c?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 9 deletions

| diff --git a/net/bluetooth/mgmt.c b/net/bluetooth/mgmt.cindex e406eb8e432777..b31192d473d09b 100644--- a/[net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/mgmt.c?id=0b882940665ca2849386ee459d4331aa2f8c4e7d)+++ b/[net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/mgmt.c?id=a66dfaf18fd61bb75ef8cee83db46b2aadf153d0)@@ -1518,7 +1518,8 @@ static void mgmt\_set\_discoverable\_complete(struct hci\_dev \*hdev, void \*data, bt\_dev\_dbg(hdev, "err %d", err);  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_DISCOVERABLE, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_DISCOVERABLE, hdev)) return;  hci\_dev\_lock(hdev);@@ -1692,7 +1693,8 @@ static void mgmt\_set\_connectable\_complete(struct hci\_dev \*hdev, void \*data, bt\_dev\_dbg(hdev, "err %d", err);  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_CONNECTABLE, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_CONNECTABLE, hdev)) return;  hci\_dev\_lock(hdev);@@ -1924,7 +1926,7 @@ static void set\_ssp\_complete(struct hci\_dev \*hdev, void \*data, int err) bool changed;  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_SSP, hdev))+ if (err == -ECANCELED || cmd != pending\_find(MGMT\_OP\_SET\_SSP, hdev)) return;  if (err) {@@ -3848,7 +3850,8 @@ static void set\_name\_complete(struct hci\_dev \*hdev, void \*data, int err)  bt\_dev\_dbg(hdev, "err %d", err); - if (cmd != pending\_find(MGMT\_OP\_SET\_LOCAL\_NAME, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_LOCAL\_NAME, hdev)) return;  if (status) {@@ -4023,7 +4026,8 @@ static void set\_default\_phy\_complete(struct hci\_dev \*hdev, void \*data, int err) struct sk\_buff \*skb = cmd->skb; u8 status = mgmt\_status(err); - if (cmd != pending\_find(MGMT\_OP\_SET\_PHY\_CONFIGURATION, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_PHY\_CONFIGURATION, hdev)) return;  if (!status) {@@ -5914,13 +5918,16 @@ static void start\_discovery\_complete(struct hci\_dev \*hdev, void \*data, int err) { struct mgmt\_pending\_cmd \*cmd = data; + bt\_dev\_dbg(hdev, "err %d", err);++ if (err == -ECANCELED)+ return;+ if (cmd != pending\_find(MGMT\_OP\_START\_DISCOVERY, hdev) && cmd != pending\_find(MGMT\_OP\_START\_LIMITED\_DISCOVERY, hdev) && cmd != pending\_find(MGMT\_OP\_START\_SERVICE\_DISCOVERY, hdev)) return; - bt\_dev\_dbg(hdev, "err %d", err);- mgmt\_cmd\_complete(cmd->sk, cmd->index, cmd->opcode, mgmt\_status(err), cmd->param, 1); mgmt\_pending\_remove(cmd);@@ -6153,7 +6160,8 @@ static void stop\_discovery\_complete(struct hci\_dev \*hdev, void \*data, int err) { struct mgmt\_pending\_cmd \*cmd = data; - if (cmd != pending\_find(MGMT\_OP\_STOP\_DISCOVERY, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_STOP\_DISCOVERY, hdev)) return;  bt\_dev\_dbg(hdev, "err %d", err);@@ -8144,7 +8152,8 @@ static void read\_local\_oob\_ext\_data\_complete(struct hci\_dev \*hdev, void \*data, u8 status = mgmt\_status(err); u16 eir\_len; - if (cmd != pending\_find(MGMT\_OP\_READ\_LOCAL\_OOB\_EXT\_DATA, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_READ\_LOCAL\_OOB\_EXT\_DATA, hdev)) return;  if (!status) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:45:04 +0000



=== Content from git.kernel.org_109e0789_20250114_204627.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-11-21 11:09:22 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:01 +0100 |
| commit | [6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e)) | |
| tree | [cebc1f4b19fa291e79a4854c69548e4fd34612f4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e) | |
| parent | [6b75f32bce90c085c89c45761373d940fdcff68c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b75f32bce90c085c89c45761373d940fdcff68c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e&id2=6b75f32bce90c085c89c45761373d940fdcff68c)) | |
| download | [linux-6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e.tar.gz) | |

Bluetooth: MGMT: Fix possible deadlocks[ Upstream commit a66dfaf18fd61bb75ef8cee83db46b2aadf153d0 ]
This fixes possible deadlocks like the following caused by
hci\_cmd\_sync\_dequeue causing the destroy function to run:
INFO: task kworker/u19:0:143 blocked for more than 120 seconds.
Tainted: G W O 6.8.0-2024-03-19-intel-next-iLS-24ww14 #1
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
task:kworker/u19:0 state:D stack:0 pid:143 tgid:143 ppid:2 flags:0x00004000
Workqueue: hci0 hci\_cmd\_sync\_work [bluetooth]
Call Trace:
<TASK>
\_\_schedule+0x374/0xaf0
schedule+0x3c/0xf0
schedule\_preempt\_disabled+0x1c/0x30
\_\_mutex\_lock.constprop.0+0x3ef/0x7a0
\_\_mutex\_lock\_slowpath+0x13/0x20
mutex\_lock+0x3c/0x50
mgmt\_set\_connectable\_complete+0xa4/0x150 [bluetooth]
? kfree+0x211/0x2a0
hci\_cmd\_sync\_dequeue+0xae/0x130 [bluetooth]
? \_\_pfx\_cmd\_complete\_rsp+0x10/0x10 [bluetooth]
cmd\_complete\_rsp+0x26/0x80 [bluetooth]
mgmt\_pending\_foreach+0x4d/0x70 [bluetooth]
\_\_mgmt\_power\_off+0x8d/0x180 [bluetooth]
? \_raw\_spin\_unlock\_irq+0x23/0x40
hci\_dev\_close\_sync+0x445/0x5b0 [bluetooth]
hci\_set\_powered\_sync+0x149/0x250 [bluetooth]
set\_powered\_sync+0x24/0x60 [bluetooth]
hci\_cmd\_sync\_work+0x90/0x150 [bluetooth]
process\_one\_work+0x13e/0x300
worker\_thread+0x2f7/0x420
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0x107/0x140
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x3d/0x60
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1b/0x30
</TASK>
Tested-by: Kiran K <kiran.k@intel.com>
Fixes: f53e1c9c726d ("Bluetooth: MGMT: Fix possible crash on mgmt\_index\_removed")
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e)

| -rw-r--r-- | [net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/mgmt.c?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 9 deletions

| diff --git a/net/bluetooth/mgmt.c b/net/bluetooth/mgmt.cindex 3cd747ca65437b..ac5684b38dbeb9 100644--- a/[net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/mgmt.c?id=6b75f32bce90c085c89c45761373d940fdcff68c)+++ b/[net/bluetooth/mgmt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/mgmt.c?id=6a25ce9b4af6dc26ee2b9c32d6bd37620bf9739e)@@ -1517,7 +1517,8 @@ static void mgmt\_set\_discoverable\_complete(struct hci\_dev \*hdev, void \*data, bt\_dev\_dbg(hdev, "err %d", err);  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_DISCOVERABLE, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_DISCOVERABLE, hdev)) return;  hci\_dev\_lock(hdev);@@ -1691,7 +1692,8 @@ static void mgmt\_set\_connectable\_complete(struct hci\_dev \*hdev, void \*data, bt\_dev\_dbg(hdev, "err %d", err);  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_CONNECTABLE, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_CONNECTABLE, hdev)) return;  hci\_dev\_lock(hdev);@@ -1923,7 +1925,7 @@ static void set\_ssp\_complete(struct hci\_dev \*hdev, void \*data, int err) bool changed;  /\* Make sure cmd still outstanding. \*/- if (cmd != pending\_find(MGMT\_OP\_SET\_SSP, hdev))+ if (err == -ECANCELED || cmd != pending\_find(MGMT\_OP\_SET\_SSP, hdev)) return;  if (err) {@@ -3789,7 +3791,8 @@ static void set\_name\_complete(struct hci\_dev \*hdev, void \*data, int err)  bt\_dev\_dbg(hdev, "err %d", err); - if (cmd != pending\_find(MGMT\_OP\_SET\_LOCAL\_NAME, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_LOCAL\_NAME, hdev)) return;  if (status) {@@ -3964,7 +3967,8 @@ static void set\_default\_phy\_complete(struct hci\_dev \*hdev, void \*data, int err) struct sk\_buff \*skb = cmd->skb; u8 status = mgmt\_status(err); - if (cmd != pending\_find(MGMT\_OP\_SET\_PHY\_CONFIGURATION, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_SET\_PHY\_CONFIGURATION, hdev)) return;  if (!status) {@@ -5855,13 +5859,16 @@ static void start\_discovery\_complete(struct hci\_dev \*hdev, void \*data, int err) { struct mgmt\_pending\_cmd \*cmd = data; + bt\_dev\_dbg(hdev, "err %d", err);++ if (err == -ECANCELED)+ return;+ if (cmd != pending\_find(MGMT\_OP\_START\_DISCOVERY, hdev) && cmd != pending\_find(MGMT\_OP\_START\_LIMITED\_DISCOVERY, hdev) && cmd != pending\_find(MGMT\_OP\_START\_SERVICE\_DISCOVERY, hdev)) return; - bt\_dev\_dbg(hdev, "err %d", err);- mgmt\_cmd\_complete(cmd->sk, cmd->index, cmd->opcode, mgmt\_status(err), cmd->param, 1); mgmt\_pending\_remove(cmd);@@ -6094,7 +6101,8 @@ static void stop\_discovery\_complete(struct hci\_dev \*hdev, void \*data, int err) { struct mgmt\_pending\_cmd \*cmd = data; - if (cmd != pending\_find(MGMT\_OP\_STOP\_DISCOVERY, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_STOP\_DISCOVERY, hdev)) return;  bt\_dev\_dbg(hdev, "err %d", err);@@ -8085,7 +8093,8 @@ static void read\_local\_oob\_ext\_data\_complete(struct hci\_dev \*hdev, void \*data, u8 status = mgmt\_status(err); u16 eir\_len; - if (cmd != pending\_find(MGMT\_OP\_READ\_LOCAL\_OOB\_EXT\_DATA, hdev))+ if (err == -ECANCELED ||+ cmd != pending\_find(MGMT\_OP\_READ\_LOCAL\_OOB\_EXT\_DATA, hdev)) return;  if (!status) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:45:03 +0000


