=== Content from git.kernel.org_43c12e81_20250114_230050.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=109aa654f85c5141e813b2cd1bd36d90be678407)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=109aa654f85c5141e813b2cd1bd36d90be678407)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=109aa654f85c5141e813b2cd1bd36d90be678407)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=109aa654f85c5141e813b2cd1bd36d90be678407)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luo Qiu <luoqiu@kylinsec.com.cn> | 2024-11-01 11:21:15 +0800 |
| --- | --- | --- |
| committer | Sudeep Holla <sudeep.holla@arm.com> | 2024-11-06 10:48:13 +0000 |
| commit | [109aa654f85c5141e813b2cd1bd36d90be678407](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=109aa654f85c5141e813b2cd1bd36d90be678407) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=109aa654f85c5141e813b2cd1bd36d90be678407)) | |
| tree | [6459172e902423aa6a3dca072804994afa5681d0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=109aa654f85c5141e813b2cd1bd36d90be678407) | |
| parent | [112ffc78dc8f4519b36853a415bd60fdf77edd1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=112ffc78dc8f4519b36853a415bd60fdf77edd1a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=109aa654f85c5141e813b2cd1bd36d90be678407&id2=112ffc78dc8f4519b36853a415bd60fdf77edd1a)) | |
| download | [linux-109aa654f85c5141e813b2cd1bd36d90be678407.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-109aa654f85c5141e813b2cd1bd36d90be678407.tar.gz) | |

firmware: arm\_scpi: Check the DVFS OPP count returned by the firmwareFix a kernel crash with the below call trace when the SCPI firmware
returns OPP count of zero.
dvfs\_info.opp\_count may be zero on some platforms during the reboot
test, and the kernel will crash after dereferencing the pointer to
kcalloc(info->count, sizeof(\*opp), GFP\_KERNEL).
| Unable to handle kernel NULL pointer dereference at virtual address 0000000000000028
| Mem abort info:
| ESR = 0x96000004
| Exception class = DABT (current EL), IL = 32 bits
| SET = 0, FnV = 0
| EA = 0, S1PTW = 0
| Data abort info:
| ISV = 0, ISS = 0x00000004
| CM = 0, WnR = 0
| user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000faefa08c
| [0000000000000028] pgd=0000000000000000
| Internal error: Oops: 96000004 [#1] SMP
| scpi-hwmon: probe of PHYT000D:00 failed with error -110
| Process systemd-udevd (pid: 1701, stack limit = 0x00000000aaede86c)
| CPU: 2 PID: 1701 Comm: systemd-udevd Not tainted 4.19.90+ #1
| Hardware name: PHYTIUM LTD Phytium FT2000/4/Phytium FT2000/4, BIOS
| pstate: 60000005 (nZCv daif -PAN -UAO)
| pc : scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| lr : clk\_register+0x438/0x720
| Call trace:
| scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| devm\_clk\_hw\_register+0x50/0xa0
| scpi\_clk\_ops\_init.isra.2+0xa0/0x138 [clk\_scpi]
| scpi\_clocks\_probe+0x528/0x70c [clk\_scpi]
| platform\_drv\_probe+0x58/0xa8
| really\_probe+0x260/0x3d0
| driver\_probe\_device+0x12c/0x148
| device\_driver\_attach+0x74/0x98
| \_\_driver\_attach+0xb4/0xe8
| bus\_for\_each\_dev+0x88/0xe0
| driver\_attach+0x30/0x40
| bus\_add\_driver+0x178/0x2b0
| driver\_register+0x64/0x118
| \_\_platform\_driver\_register+0x54/0x60
| scpi\_clocks\_driver\_init+0x24/0x1000 [clk\_scpi]
| do\_one\_initcall+0x54/0x220
| do\_init\_module+0x54/0x1c8
| load\_module+0x14a4/0x1668
| \_\_se\_sys\_finit\_module+0xf8/0x110
| \_\_arm64\_sys\_finit\_module+0x24/0x30
| el0\_svc\_common+0x78/0x170
| el0\_svc\_handler+0x38/0x78
| el0\_svc+0x8/0x340
| Code: 937d7c00 a94153f3 a8c27bfd f9400421 (b8606820)
| ---[ end trace 06feb22469d89fa8 ]---
| Kernel panic - not syncing: Fatal exception
| SMP: stopping secondary CPUs
| Kernel Offset: disabled
| CPU features: 0x10,a0002008
| Memory Limit: none
Fixes: 8cb7cf56c9fe ("firmware: add support for ARM System Control and Power Interface(SCPI) protocol")
Signed-off-by: Luo Qiu <luoqiu@kylinsec.com.cn>
Message-Id: <55A2F7A784391686+20241101032115.275977-1-luoqiu@kylinsec.com.cn>
Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=109aa654f85c5141e813b2cd1bd36d90be678407)

| -rw-r--r-- | [drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scpi.c?id=109aa654f85c5141e813b2cd1bd36d90be678407) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/firmware/arm\_scpi.c b/drivers/firmware/arm\_scpi.cindex 94a6b4e667de14..f4d47577f83ee7 100644--- a/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=112ffc78dc8f4519b36853a415bd60fdf77edd1a)+++ b/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=109aa654f85c5141e813b2cd1bd36d90be678407)@@ -630,6 +630,9 @@ static struct scpi\_dvfs\_info \*scpi\_dvfs\_get\_info(u8 domain) if (ret) return ERR\_PTR(ret); + if (!buf.opp\_count)+ return ERR\_PTR(-ENOENT);+ info = kmalloc(sizeof(\*info), GFP\_KERNEL); if (!info) return ERR\_PTR(-ENOMEM); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:59:27 +0000



=== Content from git.kernel.org_d38774df_20250114_230051.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luo Qiu <luoqiu@kylinsec.com.cn> | 2024-11-01 11:21:15 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:32 +0100 |
| commit | [12e2c520a0a4202575e4a45ea41f06a8e9aa3417](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417)) | |
| tree | [5e28a27fb21293ca715aa1934fef86d523ca1b00](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417) | |
| parent | [214872e90be2a216eb1dbc0b7ed6a133cb1f449a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=214872e90be2a216eb1dbc0b7ed6a133cb1f449a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417&id2=214872e90be2a216eb1dbc0b7ed6a133cb1f449a)) | |
| download | [linux-12e2c520a0a4202575e4a45ea41f06a8e9aa3417.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-12e2c520a0a4202575e4a45ea41f06a8e9aa3417.tar.gz) | |

firmware: arm\_scpi: Check the DVFS OPP count returned by the firmware[ Upstream commit 109aa654f85c5141e813b2cd1bd36d90be678407 ]
Fix a kernel crash with the below call trace when the SCPI firmware
returns OPP count of zero.
dvfs\_info.opp\_count may be zero on some platforms during the reboot
test, and the kernel will crash after dereferencing the pointer to
kcalloc(info->count, sizeof(\*opp), GFP\_KERNEL).
| Unable to handle kernel NULL pointer dereference at virtual address 0000000000000028
| Mem abort info:
| ESR = 0x96000004
| Exception class = DABT (current EL), IL = 32 bits
| SET = 0, FnV = 0
| EA = 0, S1PTW = 0
| Data abort info:
| ISV = 0, ISS = 0x00000004
| CM = 0, WnR = 0
| user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000faefa08c
| [0000000000000028] pgd=0000000000000000
| Internal error: Oops: 96000004 [#1] SMP
| scpi-hwmon: probe of PHYT000D:00 failed with error -110
| Process systemd-udevd (pid: 1701, stack limit = 0x00000000aaede86c)
| CPU: 2 PID: 1701 Comm: systemd-udevd Not tainted 4.19.90+ #1
| Hardware name: PHYTIUM LTD Phytium FT2000/4/Phytium FT2000/4, BIOS
| pstate: 60000005 (nZCv daif -PAN -UAO)
| pc : scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| lr : clk\_register+0x438/0x720
| Call trace:
| scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| devm\_clk\_hw\_register+0x50/0xa0
| scpi\_clk\_ops\_init.isra.2+0xa0/0x138 [clk\_scpi]
| scpi\_clocks\_probe+0x528/0x70c [clk\_scpi]
| platform\_drv\_probe+0x58/0xa8
| really\_probe+0x260/0x3d0
| driver\_probe\_device+0x12c/0x148
| device\_driver\_attach+0x74/0x98
| \_\_driver\_attach+0xb4/0xe8
| bus\_for\_each\_dev+0x88/0xe0
| driver\_attach+0x30/0x40
| bus\_add\_driver+0x178/0x2b0
| driver\_register+0x64/0x118
| \_\_platform\_driver\_register+0x54/0x60
| scpi\_clocks\_driver\_init+0x24/0x1000 [clk\_scpi]
| do\_one\_initcall+0x54/0x220
| do\_init\_module+0x54/0x1c8
| load\_module+0x14a4/0x1668
| \_\_se\_sys\_finit\_module+0xf8/0x110
| \_\_arm64\_sys\_finit\_module+0x24/0x30
| el0\_svc\_common+0x78/0x170
| el0\_svc\_handler+0x38/0x78
| el0\_svc+0x8/0x340
| Code: 937d7c00 a94153f3 a8c27bfd f9400421 (b8606820)
| ---[ end trace 06feb22469d89fa8 ]---
| Kernel panic - not syncing: Fatal exception
| SMP: stopping secondary CPUs
| Kernel Offset: disabled
| CPU features: 0x10,a0002008
| Memory Limit: none
Fixes: 8cb7cf56c9fe ("firmware: add support for ARM System Control and Power Interface(SCPI) protocol")
Signed-off-by: Luo Qiu <luoqiu@kylinsec.com.cn>
Message-Id: <55A2F7A784391686+20241101032115.275977-1-luoqiu@kylinsec.com.cn>
Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417)

| -rw-r--r-- | [drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scpi.c?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/firmware/arm\_scpi.c b/drivers/firmware/arm\_scpi.cindex 1ce27bb9deadad..2745a596e1d18a 100644--- a/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=214872e90be2a216eb1dbc0b7ed6a133cb1f449a)+++ b/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=12e2c520a0a4202575e4a45ea41f06a8e9aa3417)@@ -638,6 +638,9 @@ static struct scpi\_dvfs\_info \*scpi\_dvfs\_get\_info(u8 domain) if (ret) return ERR\_PTR(ret); + if (!buf.opp\_count)+ return ERR\_PTR(-ENOENT);+ info = kmalloc(sizeof(\*info), GFP\_KERNEL); if (!info) return ERR\_PTR(-ENOMEM); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:59:28 +0000



=== Content from git.kernel.org_6e4ecd40_20250114_230054.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luo Qiu <luoqiu@kylinsec.com.cn> | 2024-11-01 11:21:15 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:05 +0100 |
| commit | [dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325)) | |
| tree | [a4f82d97ad7f24f7d02a36477e51a48f35dd27d1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325) | |
| parent | [1b4f406a29fc23eb2fd3539b4806ffd95ec367d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b4f406a29fc23eb2fd3539b4806ffd95ec367d9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325&id2=1b4f406a29fc23eb2fd3539b4806ffd95ec367d9)) | |
| download | [linux-dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325.tar.gz) | |

firmware: arm\_scpi: Check the DVFS OPP count returned by the firmware[ Upstream commit 109aa654f85c5141e813b2cd1bd36d90be678407 ]
Fix a kernel crash with the below call trace when the SCPI firmware
returns OPP count of zero.
dvfs\_info.opp\_count may be zero on some platforms during the reboot
test, and the kernel will crash after dereferencing the pointer to
kcalloc(info->count, sizeof(\*opp), GFP\_KERNEL).
| Unable to handle kernel NULL pointer dereference at virtual address 0000000000000028
| Mem abort info:
| ESR = 0x96000004
| Exception class = DABT (current EL), IL = 32 bits
| SET = 0, FnV = 0
| EA = 0, S1PTW = 0
| Data abort info:
| ISV = 0, ISS = 0x00000004
| CM = 0, WnR = 0
| user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000faefa08c
| [0000000000000028] pgd=0000000000000000
| Internal error: Oops: 96000004 [#1] SMP
| scpi-hwmon: probe of PHYT000D:00 failed with error -110
| Process systemd-udevd (pid: 1701, stack limit = 0x00000000aaede86c)
| CPU: 2 PID: 1701 Comm: systemd-udevd Not tainted 4.19.90+ #1
| Hardware name: PHYTIUM LTD Phytium FT2000/4/Phytium FT2000/4, BIOS
| pstate: 60000005 (nZCv daif -PAN -UAO)
| pc : scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| lr : clk\_register+0x438/0x720
| Call trace:
| scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| devm\_clk\_hw\_register+0x50/0xa0
| scpi\_clk\_ops\_init.isra.2+0xa0/0x138 [clk\_scpi]
| scpi\_clocks\_probe+0x528/0x70c [clk\_scpi]
| platform\_drv\_probe+0x58/0xa8
| really\_probe+0x260/0x3d0
| driver\_probe\_device+0x12c/0x148
| device\_driver\_attach+0x74/0x98
| \_\_driver\_attach+0xb4/0xe8
| bus\_for\_each\_dev+0x88/0xe0
| driver\_attach+0x30/0x40
| bus\_add\_driver+0x178/0x2b0
| driver\_register+0x64/0x118
| \_\_platform\_driver\_register+0x54/0x60
| scpi\_clocks\_driver\_init+0x24/0x1000 [clk\_scpi]
| do\_one\_initcall+0x54/0x220
| do\_init\_module+0x54/0x1c8
| load\_module+0x14a4/0x1668
| \_\_se\_sys\_finit\_module+0xf8/0x110
| \_\_arm64\_sys\_finit\_module+0x24/0x30
| el0\_svc\_common+0x78/0x170
| el0\_svc\_handler+0x38/0x78
| el0\_svc+0x8/0x340
| Code: 937d7c00 a94153f3 a8c27bfd f9400421 (b8606820)
| ---[ end trace 06feb22469d89fa8 ]---
| Kernel panic - not syncing: Fatal exception
| SMP: stopping secondary CPUs
| Kernel Offset: disabled
| CPU features: 0x10,a0002008
| Memory Limit: none
Fixes: 8cb7cf56c9fe ("firmware: add support for ARM System Control and Power Interface(SCPI) protocol")
Signed-off-by: Luo Qiu <luoqiu@kylinsec.com.cn>
Message-Id: <55A2F7A784391686+20241101032115.275977-1-luoqiu@kylinsec.com.cn>
Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325)

| -rw-r--r-- | [drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scpi.c?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/firmware/arm\_scpi.c b/drivers/firmware/arm\_scpi.cindex 94a6b4e667de14..f4d47577f83ee7 100644--- a/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=1b4f406a29fc23eb2fd3539b4806ffd95ec367d9)+++ b/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=dfc9c2aa7f04f7db7e7225a5e118a24bf1c3b325)@@ -630,6 +630,9 @@ static struct scpi\_dvfs\_info \*scpi\_dvfs\_get\_info(u8 domain) if (ret) return ERR\_PTR(ret); + if (!buf.opp\_count)+ return ERR\_PTR(-ENOENT);+ info = kmalloc(sizeof(\*info), GFP\_KERNEL); if (!info) return ERR\_PTR(-ENOMEM); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:59:31 +0000



=== Content from git.kernel.org_d884153b_20250114_230049.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=06258e57fee253f4046d3a6a86d7fde09f596eac)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06258e57fee253f4046d3a6a86d7fde09f596eac)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06258e57fee253f4046d3a6a86d7fde09f596eac)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06258e57fee253f4046d3a6a86d7fde09f596eac)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luo Qiu <luoqiu@kylinsec.com.cn> | 2024-11-01 11:21:15 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:23 +0100 |
| commit | [06258e57fee253f4046d3a6a86d7fde09f596eac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06258e57fee253f4046d3a6a86d7fde09f596eac) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=06258e57fee253f4046d3a6a86d7fde09f596eac)) | |
| tree | [171efc42a983cd0e2ccfee8414fe2079dbc13963](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06258e57fee253f4046d3a6a86d7fde09f596eac) | |
| parent | [07121977cc7dc2e10d1ffd0aca76ac642a109880](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07121977cc7dc2e10d1ffd0aca76ac642a109880) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06258e57fee253f4046d3a6a86d7fde09f596eac&id2=07121977cc7dc2e10d1ffd0aca76ac642a109880)) | |
| download | [linux-06258e57fee253f4046d3a6a86d7fde09f596eac.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-06258e57fee253f4046d3a6a86d7fde09f596eac.tar.gz) | |

firmware: arm\_scpi: Check the DVFS OPP count returned by the firmware[ Upstream commit 109aa654f85c5141e813b2cd1bd36d90be678407 ]
Fix a kernel crash with the below call trace when the SCPI firmware
returns OPP count of zero.
dvfs\_info.opp\_count may be zero on some platforms during the reboot
test, and the kernel will crash after dereferencing the pointer to
kcalloc(info->count, sizeof(\*opp), GFP\_KERNEL).
| Unable to handle kernel NULL pointer dereference at virtual address 0000000000000028
| Mem abort info:
| ESR = 0x96000004
| Exception class = DABT (current EL), IL = 32 bits
| SET = 0, FnV = 0
| EA = 0, S1PTW = 0
| Data abort info:
| ISV = 0, ISS = 0x00000004
| CM = 0, WnR = 0
| user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000faefa08c
| [0000000000000028] pgd=0000000000000000
| Internal error: Oops: 96000004 [#1] SMP
| scpi-hwmon: probe of PHYT000D:00 failed with error -110
| Process systemd-udevd (pid: 1701, stack limit = 0x00000000aaede86c)
| CPU: 2 PID: 1701 Comm: systemd-udevd Not tainted 4.19.90+ #1
| Hardware name: PHYTIUM LTD Phytium FT2000/4/Phytium FT2000/4, BIOS
| pstate: 60000005 (nZCv daif -PAN -UAO)
| pc : scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| lr : clk\_register+0x438/0x720
| Call trace:
| scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| devm\_clk\_hw\_register+0x50/0xa0
| scpi\_clk\_ops\_init.isra.2+0xa0/0x138 [clk\_scpi]
| scpi\_clocks\_probe+0x528/0x70c [clk\_scpi]
| platform\_drv\_probe+0x58/0xa8
| really\_probe+0x260/0x3d0
| driver\_probe\_device+0x12c/0x148
| device\_driver\_attach+0x74/0x98
| \_\_driver\_attach+0xb4/0xe8
| bus\_for\_each\_dev+0x88/0xe0
| driver\_attach+0x30/0x40
| bus\_add\_driver+0x178/0x2b0
| driver\_register+0x64/0x118
| \_\_platform\_driver\_register+0x54/0x60
| scpi\_clocks\_driver\_init+0x24/0x1000 [clk\_scpi]
| do\_one\_initcall+0x54/0x220
| do\_init\_module+0x54/0x1c8
| load\_module+0x14a4/0x1668
| \_\_se\_sys\_finit\_module+0xf8/0x110
| \_\_arm64\_sys\_finit\_module+0x24/0x30
| el0\_svc\_common+0x78/0x170
| el0\_svc\_handler+0x38/0x78
| el0\_svc+0x8/0x340
| Code: 937d7c00 a94153f3 a8c27bfd f9400421 (b8606820)
| ---[ end trace 06feb22469d89fa8 ]---
| Kernel panic - not syncing: Fatal exception
| SMP: stopping secondary CPUs
| Kernel Offset: disabled
| CPU features: 0x10,a0002008
| Memory Limit: none
Fixes: 8cb7cf56c9fe ("firmware: add support for ARM System Control and Power Interface(SCPI) protocol")
Signed-off-by: Luo Qiu <luoqiu@kylinsec.com.cn>
Message-Id: <55A2F7A784391686+20241101032115.275977-1-luoqiu@kylinsec.com.cn>
Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06258e57fee253f4046d3a6a86d7fde09f596eac)

| -rw-r--r-- | [drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scpi.c?id=06258e57fee253f4046d3a6a86d7fde09f596eac) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/firmware/arm\_scpi.c b/drivers/firmware/arm\_scpi.cindex 435d0e2658a42e..3de25e9d18ef84 100644--- a/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=07121977cc7dc2e10d1ffd0aca76ac642a109880)+++ b/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=06258e57fee253f4046d3a6a86d7fde09f596eac)@@ -627,6 +627,9 @@ static struct scpi\_dvfs\_info \*scpi\_dvfs\_get\_info(u8 domain) if (ret) return ERR\_PTR(ret); + if (!buf.opp\_count)+ return ERR\_PTR(-ENOENT);+ info = kmalloc(sizeof(\*info), GFP\_KERNEL); if (!info) return ERR\_PTR(-ENOMEM); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:59:26 +0000



=== Content from git.kernel.org_db04135a_20250114_230052.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luo Qiu <luoqiu@kylinsec.com.cn> | 2024-11-01 11:21:15 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:48 +0100 |
| commit | [380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6)) | |
| tree | [99818fab83bfd5b0c7e9fff5ff1e40ccea05384a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6) | |
| parent | [02dff60d0c99a8b009379249192b6e7e352acf54](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02dff60d0c99a8b009379249192b6e7e352acf54) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6&id2=02dff60d0c99a8b009379249192b6e7e352acf54)) | |
| download | [linux-380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6.tar.gz) | |

firmware: arm\_scpi: Check the DVFS OPP count returned by the firmware[ Upstream commit 109aa654f85c5141e813b2cd1bd36d90be678407 ]
Fix a kernel crash with the below call trace when the SCPI firmware
returns OPP count of zero.
dvfs\_info.opp\_count may be zero on some platforms during the reboot
test, and the kernel will crash after dereferencing the pointer to
kcalloc(info->count, sizeof(\*opp), GFP\_KERNEL).
| Unable to handle kernel NULL pointer dereference at virtual address 0000000000000028
| Mem abort info:
| ESR = 0x96000004
| Exception class = DABT (current EL), IL = 32 bits
| SET = 0, FnV = 0
| EA = 0, S1PTW = 0
| Data abort info:
| ISV = 0, ISS = 0x00000004
| CM = 0, WnR = 0
| user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000faefa08c
| [0000000000000028] pgd=0000000000000000
| Internal error: Oops: 96000004 [#1] SMP
| scpi-hwmon: probe of PHYT000D:00 failed with error -110
| Process systemd-udevd (pid: 1701, stack limit = 0x00000000aaede86c)
| CPU: 2 PID: 1701 Comm: systemd-udevd Not tainted 4.19.90+ #1
| Hardware name: PHYTIUM LTD Phytium FT2000/4/Phytium FT2000/4, BIOS
| pstate: 60000005 (nZCv daif -PAN -UAO)
| pc : scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| lr : clk\_register+0x438/0x720
| Call trace:
| scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| devm\_clk\_hw\_register+0x50/0xa0
| scpi\_clk\_ops\_init.isra.2+0xa0/0x138 [clk\_scpi]
| scpi\_clocks\_probe+0x528/0x70c [clk\_scpi]
| platform\_drv\_probe+0x58/0xa8
| really\_probe+0x260/0x3d0
| driver\_probe\_device+0x12c/0x148
| device\_driver\_attach+0x74/0x98
| \_\_driver\_attach+0xb4/0xe8
| bus\_for\_each\_dev+0x88/0xe0
| driver\_attach+0x30/0x40
| bus\_add\_driver+0x178/0x2b0
| driver\_register+0x64/0x118
| \_\_platform\_driver\_register+0x54/0x60
| scpi\_clocks\_driver\_init+0x24/0x1000 [clk\_scpi]
| do\_one\_initcall+0x54/0x220
| do\_init\_module+0x54/0x1c8
| load\_module+0x14a4/0x1668
| \_\_se\_sys\_finit\_module+0xf8/0x110
| \_\_arm64\_sys\_finit\_module+0x24/0x30
| el0\_svc\_common+0x78/0x170
| el0\_svc\_handler+0x38/0x78
| el0\_svc+0x8/0x340
| Code: 937d7c00 a94153f3 a8c27bfd f9400421 (b8606820)
| ---[ end trace 06feb22469d89fa8 ]---
| Kernel panic - not syncing: Fatal exception
| SMP: stopping secondary CPUs
| Kernel Offset: disabled
| CPU features: 0x10,a0002008
| Memory Limit: none
Fixes: 8cb7cf56c9fe ("firmware: add support for ARM System Control and Power Interface(SCPI) protocol")
Signed-off-by: Luo Qiu <luoqiu@kylinsec.com.cn>
Message-Id: <55A2F7A784391686+20241101032115.275977-1-luoqiu@kylinsec.com.cn>
Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6)

| -rw-r--r-- | [drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scpi.c?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/firmware/arm\_scpi.c b/drivers/firmware/arm\_scpi.cindex 36391cb5130e2e..3a1d77b882f7eb 100644--- a/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=02dff60d0c99a8b009379249192b6e7e352acf54)+++ b/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=380c0e1d96f3b522f3170c18ee5e0f1a28fec5d6)@@ -627,6 +627,9 @@ static struct scpi\_dvfs\_info \*scpi\_dvfs\_get\_info(u8 domain) if (ret) return ERR\_PTR(ret); + if (!buf.opp\_count)+ return ERR\_PTR(-ENOENT);+ info = kmalloc(sizeof(\*info), GFP\_KERNEL); if (!info) return ERR\_PTR(-ENOMEM); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:59:29 +0000



=== Content from git.kernel.org_b4c8088b_20250114_230049.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=025067eeb945aa17c7dd483a63960125b7efb577)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=025067eeb945aa17c7dd483a63960125b7efb577)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=025067eeb945aa17c7dd483a63960125b7efb577)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=025067eeb945aa17c7dd483a63960125b7efb577)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luo Qiu <luoqiu@kylinsec.com.cn> | 2024-11-01 11:21:15 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:31:58 +0100 |
| commit | [025067eeb945aa17c7dd483a63960125b7efb577](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=025067eeb945aa17c7dd483a63960125b7efb577) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=025067eeb945aa17c7dd483a63960125b7efb577)) | |
| tree | [8fb51cba33314bb7f082b0014c32a3a3f6bac3b3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=025067eeb945aa17c7dd483a63960125b7efb577) | |
| parent | [667b0527a3e7a5b0e2384e12ef1a1e3df2a9ff2c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=667b0527a3e7a5b0e2384e12ef1a1e3df2a9ff2c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=025067eeb945aa17c7dd483a63960125b7efb577&id2=667b0527a3e7a5b0e2384e12ef1a1e3df2a9ff2c)) | |
| download | [linux-025067eeb945aa17c7dd483a63960125b7efb577.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-025067eeb945aa17c7dd483a63960125b7efb577.tar.gz) | |

firmware: arm\_scpi: Check the DVFS OPP count returned by the firmware[ Upstream commit 109aa654f85c5141e813b2cd1bd36d90be678407 ]
Fix a kernel crash with the below call trace when the SCPI firmware
returns OPP count of zero.
dvfs\_info.opp\_count may be zero on some platforms during the reboot
test, and the kernel will crash after dereferencing the pointer to
kcalloc(info->count, sizeof(\*opp), GFP\_KERNEL).
| Unable to handle kernel NULL pointer dereference at virtual address 0000000000000028
| Mem abort info:
| ESR = 0x96000004
| Exception class = DABT (current EL), IL = 32 bits
| SET = 0, FnV = 0
| EA = 0, S1PTW = 0
| Data abort info:
| ISV = 0, ISS = 0x00000004
| CM = 0, WnR = 0
| user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000faefa08c
| [0000000000000028] pgd=0000000000000000
| Internal error: Oops: 96000004 [#1] SMP
| scpi-hwmon: probe of PHYT000D:00 failed with error -110
| Process systemd-udevd (pid: 1701, stack limit = 0x00000000aaede86c)
| CPU: 2 PID: 1701 Comm: systemd-udevd Not tainted 4.19.90+ #1
| Hardware name: PHYTIUM LTD Phytium FT2000/4/Phytium FT2000/4, BIOS
| pstate: 60000005 (nZCv daif -PAN -UAO)
| pc : scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| lr : clk\_register+0x438/0x720
| Call trace:
| scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| devm\_clk\_hw\_register+0x50/0xa0
| scpi\_clk\_ops\_init.isra.2+0xa0/0x138 [clk\_scpi]
| scpi\_clocks\_probe+0x528/0x70c [clk\_scpi]
| platform\_drv\_probe+0x58/0xa8
| really\_probe+0x260/0x3d0
| driver\_probe\_device+0x12c/0x148
| device\_driver\_attach+0x74/0x98
| \_\_driver\_attach+0xb4/0xe8
| bus\_for\_each\_dev+0x88/0xe0
| driver\_attach+0x30/0x40
| bus\_add\_driver+0x178/0x2b0
| driver\_register+0x64/0x118
| \_\_platform\_driver\_register+0x54/0x60
| scpi\_clocks\_driver\_init+0x24/0x1000 [clk\_scpi]
| do\_one\_initcall+0x54/0x220
| do\_init\_module+0x54/0x1c8
| load\_module+0x14a4/0x1668
| \_\_se\_sys\_finit\_module+0xf8/0x110
| \_\_arm64\_sys\_finit\_module+0x24/0x30
| el0\_svc\_common+0x78/0x170
| el0\_svc\_handler+0x38/0x78
| el0\_svc+0x8/0x340
| Code: 937d7c00 a94153f3 a8c27bfd f9400421 (b8606820)
| ---[ end trace 06feb22469d89fa8 ]---
| Kernel panic - not syncing: Fatal exception
| SMP: stopping secondary CPUs
| Kernel Offset: disabled
| CPU features: 0x10,a0002008
| Memory Limit: none
Fixes: 8cb7cf56c9fe ("firmware: add support for ARM System Control and Power Interface(SCPI) protocol")
Signed-off-by: Luo Qiu <luoqiu@kylinsec.com.cn>
Message-Id: <55A2F7A784391686+20241101032115.275977-1-luoqiu@kylinsec.com.cn>
Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=025067eeb945aa17c7dd483a63960125b7efb577)

| -rw-r--r-- | [drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scpi.c?id=025067eeb945aa17c7dd483a63960125b7efb577) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/firmware/arm\_scpi.c b/drivers/firmware/arm\_scpi.cindex 435d0e2658a42e..3de25e9d18ef84 100644--- a/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=667b0527a3e7a5b0e2384e12ef1a1e3df2a9ff2c)+++ b/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=025067eeb945aa17c7dd483a63960125b7efb577)@@ -627,6 +627,9 @@ static struct scpi\_dvfs\_info \*scpi\_dvfs\_get\_info(u8 domain) if (ret) return ERR\_PTR(ret); + if (!buf.opp\_count)+ return ERR\_PTR(-ENOENT);+ info = kmalloc(sizeof(\*info), GFP\_KERNEL); if (!info) return ERR\_PTR(-ENOMEM); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:59:26 +0000



=== Content from git.kernel.org_6c843b03_20250114_230053.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luo Qiu <luoqiu@kylinsec.com.cn> | 2024-11-01 11:21:15 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:24 +0100 |
| commit | [8be4e51f3ecfb0915e3510b600c4cce0dc68a383](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383)) | |
| tree | [e09d2bcad6d7d3ef1f66d692bfdf4744bad839ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383) | |
| parent | [34914044052917fc4d2ae4214bbbcfa1101ef530](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=34914044052917fc4d2ae4214bbbcfa1101ef530) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383&id2=34914044052917fc4d2ae4214bbbcfa1101ef530)) | |
| download | [linux-8be4e51f3ecfb0915e3510b600c4cce0dc68a383.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8be4e51f3ecfb0915e3510b600c4cce0dc68a383.tar.gz) | |

firmware: arm\_scpi: Check the DVFS OPP count returned by the firmware[ Upstream commit 109aa654f85c5141e813b2cd1bd36d90be678407 ]
Fix a kernel crash with the below call trace when the SCPI firmware
returns OPP count of zero.
dvfs\_info.opp\_count may be zero on some platforms during the reboot
test, and the kernel will crash after dereferencing the pointer to
kcalloc(info->count, sizeof(\*opp), GFP\_KERNEL).
| Unable to handle kernel NULL pointer dereference at virtual address 0000000000000028
| Mem abort info:
| ESR = 0x96000004
| Exception class = DABT (current EL), IL = 32 bits
| SET = 0, FnV = 0
| EA = 0, S1PTW = 0
| Data abort info:
| ISV = 0, ISS = 0x00000004
| CM = 0, WnR = 0
| user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000faefa08c
| [0000000000000028] pgd=0000000000000000
| Internal error: Oops: 96000004 [#1] SMP
| scpi-hwmon: probe of PHYT000D:00 failed with error -110
| Process systemd-udevd (pid: 1701, stack limit = 0x00000000aaede86c)
| CPU: 2 PID: 1701 Comm: systemd-udevd Not tainted 4.19.90+ #1
| Hardware name: PHYTIUM LTD Phytium FT2000/4/Phytium FT2000/4, BIOS
| pstate: 60000005 (nZCv daif -PAN -UAO)
| pc : scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| lr : clk\_register+0x438/0x720
| Call trace:
| scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| devm\_clk\_hw\_register+0x50/0xa0
| scpi\_clk\_ops\_init.isra.2+0xa0/0x138 [clk\_scpi]
| scpi\_clocks\_probe+0x528/0x70c [clk\_scpi]
| platform\_drv\_probe+0x58/0xa8
| really\_probe+0x260/0x3d0
| driver\_probe\_device+0x12c/0x148
| device\_driver\_attach+0x74/0x98
| \_\_driver\_attach+0xb4/0xe8
| bus\_for\_each\_dev+0x88/0xe0
| driver\_attach+0x30/0x40
| bus\_add\_driver+0x178/0x2b0
| driver\_register+0x64/0x118
| \_\_platform\_driver\_register+0x54/0x60
| scpi\_clocks\_driver\_init+0x24/0x1000 [clk\_scpi]
| do\_one\_initcall+0x54/0x220
| do\_init\_module+0x54/0x1c8
| load\_module+0x14a4/0x1668
| \_\_se\_sys\_finit\_module+0xf8/0x110
| \_\_arm64\_sys\_finit\_module+0x24/0x30
| el0\_svc\_common+0x78/0x170
| el0\_svc\_handler+0x38/0x78
| el0\_svc+0x8/0x340
| Code: 937d7c00 a94153f3 a8c27bfd f9400421 (b8606820)
| ---[ end trace 06feb22469d89fa8 ]---
| Kernel panic - not syncing: Fatal exception
| SMP: stopping secondary CPUs
| Kernel Offset: disabled
| CPU features: 0x10,a0002008
| Memory Limit: none
Fixes: 8cb7cf56c9fe ("firmware: add support for ARM System Control and Power Interface(SCPI) protocol")
Signed-off-by: Luo Qiu <luoqiu@kylinsec.com.cn>
Message-Id: <55A2F7A784391686+20241101032115.275977-1-luoqiu@kylinsec.com.cn>
Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383)

| -rw-r--r-- | [drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scpi.c?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/firmware/arm\_scpi.c b/drivers/firmware/arm\_scpi.cindex 72634e9d811690..131b22bd713f36 100644--- a/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=34914044052917fc4d2ae4214bbbcfa1101ef530)+++ b/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=8be4e51f3ecfb0915e3510b600c4cce0dc68a383)@@ -627,6 +627,9 @@ static struct scpi\_dvfs\_info \*scpi\_dvfs\_get\_info(u8 domain) if (ret) return ERR\_PTR(ret); + if (!buf.opp\_count)+ return ERR\_PTR(-ENOENT);+ info = kmalloc(sizeof(\*info), GFP\_KERNEL); if (!info) return ERR\_PTR(-ENOMEM); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:59:30 +0000



=== Content from git.kernel.org_79303eea_20250114_230053.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9beaff47bcea5eec7d4ead98f5043057161fd71a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9beaff47bcea5eec7d4ead98f5043057161fd71a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9beaff47bcea5eec7d4ead98f5043057161fd71a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9beaff47bcea5eec7d4ead98f5043057161fd71a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luo Qiu <luoqiu@kylinsec.com.cn> | 2024-11-01 11:21:15 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:01:34 +0100 |
| commit | [9beaff47bcea5eec7d4ead98f5043057161fd71a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9beaff47bcea5eec7d4ead98f5043057161fd71a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9beaff47bcea5eec7d4ead98f5043057161fd71a)) | |
| tree | [4699bd0f16f03abadf4d00c86298c52bc0a39065](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9beaff47bcea5eec7d4ead98f5043057161fd71a) | |
| parent | [5dc9ab15203c8ae44b5193b7259525ed60b99788](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5dc9ab15203c8ae44b5193b7259525ed60b99788) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9beaff47bcea5eec7d4ead98f5043057161fd71a&id2=5dc9ab15203c8ae44b5193b7259525ed60b99788)) | |
| download | [linux-9beaff47bcea5eec7d4ead98f5043057161fd71a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9beaff47bcea5eec7d4ead98f5043057161fd71a.tar.gz) | |

firmware: arm\_scpi: Check the DVFS OPP count returned by the firmware[ Upstream commit 109aa654f85c5141e813b2cd1bd36d90be678407 ]
Fix a kernel crash with the below call trace when the SCPI firmware
returns OPP count of zero.
dvfs\_info.opp\_count may be zero on some platforms during the reboot
test, and the kernel will crash after dereferencing the pointer to
kcalloc(info->count, sizeof(\*opp), GFP\_KERNEL).
| Unable to handle kernel NULL pointer dereference at virtual address 0000000000000028
| Mem abort info:
| ESR = 0x96000004
| Exception class = DABT (current EL), IL = 32 bits
| SET = 0, FnV = 0
| EA = 0, S1PTW = 0
| Data abort info:
| ISV = 0, ISS = 0x00000004
| CM = 0, WnR = 0
| user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000faefa08c
| [0000000000000028] pgd=0000000000000000
| Internal error: Oops: 96000004 [#1] SMP
| scpi-hwmon: probe of PHYT000D:00 failed with error -110
| Process systemd-udevd (pid: 1701, stack limit = 0x00000000aaede86c)
| CPU: 2 PID: 1701 Comm: systemd-udevd Not tainted 4.19.90+ #1
| Hardware name: PHYTIUM LTD Phytium FT2000/4/Phytium FT2000/4, BIOS
| pstate: 60000005 (nZCv daif -PAN -UAO)
| pc : scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| lr : clk\_register+0x438/0x720
| Call trace:
| scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| devm\_clk\_hw\_register+0x50/0xa0
| scpi\_clk\_ops\_init.isra.2+0xa0/0x138 [clk\_scpi]
| scpi\_clocks\_probe+0x528/0x70c [clk\_scpi]
| platform\_drv\_probe+0x58/0xa8
| really\_probe+0x260/0x3d0
| driver\_probe\_device+0x12c/0x148
| device\_driver\_attach+0x74/0x98
| \_\_driver\_attach+0xb4/0xe8
| bus\_for\_each\_dev+0x88/0xe0
| driver\_attach+0x30/0x40
| bus\_add\_driver+0x178/0x2b0
| driver\_register+0x64/0x118
| \_\_platform\_driver\_register+0x54/0x60
| scpi\_clocks\_driver\_init+0x24/0x1000 [clk\_scpi]
| do\_one\_initcall+0x54/0x220
| do\_init\_module+0x54/0x1c8
| load\_module+0x14a4/0x1668
| \_\_se\_sys\_finit\_module+0xf8/0x110
| \_\_arm64\_sys\_finit\_module+0x24/0x30
| el0\_svc\_common+0x78/0x170
| el0\_svc\_handler+0x38/0x78
| el0\_svc+0x8/0x340
| Code: 937d7c00 a94153f3 a8c27bfd f9400421 (b8606820)
| ---[ end trace 06feb22469d89fa8 ]---
| Kernel panic - not syncing: Fatal exception
| SMP: stopping secondary CPUs
| Kernel Offset: disabled
| CPU features: 0x10,a0002008
| Memory Limit: none
Fixes: 8cb7cf56c9fe ("firmware: add support for ARM System Control and Power Interface(SCPI) protocol")
Signed-off-by: Luo Qiu <luoqiu@kylinsec.com.cn>
Message-Id: <55A2F7A784391686+20241101032115.275977-1-luoqiu@kylinsec.com.cn>
Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9beaff47bcea5eec7d4ead98f5043057161fd71a)

| -rw-r--r-- | [drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scpi.c?id=9beaff47bcea5eec7d4ead98f5043057161fd71a) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/firmware/arm\_scpi.c b/drivers/firmware/arm\_scpi.cindex 94a6b4e667de14..f4d47577f83ee7 100644--- a/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=5dc9ab15203c8ae44b5193b7259525ed60b99788)+++ b/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=9beaff47bcea5eec7d4ead98f5043057161fd71a)@@ -630,6 +630,9 @@ static struct scpi\_dvfs\_info \*scpi\_dvfs\_get\_info(u8 domain) if (ret) return ERR\_PTR(ret); + if (!buf.opp\_count)+ return ERR\_PTR(-ENOENT);+ info = kmalloc(sizeof(\*info), GFP\_KERNEL); if (!info) return ERR\_PTR(-ENOMEM); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:59:31 +0000



=== Content from git.kernel.org_e8e98f77_20250114_230051.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luo Qiu <luoqiu@kylinsec.com.cn> | 2024-11-01 11:21:15 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:50 +0100 |
| commit | [2a5b8de6fcb944f9af0c5fcb30bb0c039705e051](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051)) | |
| tree | [1007a42cd623e66ba1c2b260621c0ee9049b692a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051) | |
| parent | [ec0b5a3454fe349ecef4c2e9f051412c984ff674](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec0b5a3454fe349ecef4c2e9f051412c984ff674) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051&id2=ec0b5a3454fe349ecef4c2e9f051412c984ff674)) | |
| download | [linux-2a5b8de6fcb944f9af0c5fcb30bb0c039705e051.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2a5b8de6fcb944f9af0c5fcb30bb0c039705e051.tar.gz) | |

firmware: arm\_scpi: Check the DVFS OPP count returned by the firmware[ Upstream commit 109aa654f85c5141e813b2cd1bd36d90be678407 ]
Fix a kernel crash with the below call trace when the SCPI firmware
returns OPP count of zero.
dvfs\_info.opp\_count may be zero on some platforms during the reboot
test, and the kernel will crash after dereferencing the pointer to
kcalloc(info->count, sizeof(\*opp), GFP\_KERNEL).
| Unable to handle kernel NULL pointer dereference at virtual address 0000000000000028
| Mem abort info:
| ESR = 0x96000004
| Exception class = DABT (current EL), IL = 32 bits
| SET = 0, FnV = 0
| EA = 0, S1PTW = 0
| Data abort info:
| ISV = 0, ISS = 0x00000004
| CM = 0, WnR = 0
| user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000faefa08c
| [0000000000000028] pgd=0000000000000000
| Internal error: Oops: 96000004 [#1] SMP
| scpi-hwmon: probe of PHYT000D:00 failed with error -110
| Process systemd-udevd (pid: 1701, stack limit = 0x00000000aaede86c)
| CPU: 2 PID: 1701 Comm: systemd-udevd Not tainted 4.19.90+ #1
| Hardware name: PHYTIUM LTD Phytium FT2000/4/Phytium FT2000/4, BIOS
| pstate: 60000005 (nZCv daif -PAN -UAO)
| pc : scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| lr : clk\_register+0x438/0x720
| Call trace:
| scpi\_dvfs\_recalc\_rate+0x40/0x58 [clk\_scpi]
| devm\_clk\_hw\_register+0x50/0xa0
| scpi\_clk\_ops\_init.isra.2+0xa0/0x138 [clk\_scpi]
| scpi\_clocks\_probe+0x528/0x70c [clk\_scpi]
| platform\_drv\_probe+0x58/0xa8
| really\_probe+0x260/0x3d0
| driver\_probe\_device+0x12c/0x148
| device\_driver\_attach+0x74/0x98
| \_\_driver\_attach+0xb4/0xe8
| bus\_for\_each\_dev+0x88/0xe0
| driver\_attach+0x30/0x40
| bus\_add\_driver+0x178/0x2b0
| driver\_register+0x64/0x118
| \_\_platform\_driver\_register+0x54/0x60
| scpi\_clocks\_driver\_init+0x24/0x1000 [clk\_scpi]
| do\_one\_initcall+0x54/0x220
| do\_init\_module+0x54/0x1c8
| load\_module+0x14a4/0x1668
| \_\_se\_sys\_finit\_module+0xf8/0x110
| \_\_arm64\_sys\_finit\_module+0x24/0x30
| el0\_svc\_common+0x78/0x170
| el0\_svc\_handler+0x38/0x78
| el0\_svc+0x8/0x340
| Code: 937d7c00 a94153f3 a8c27bfd f9400421 (b8606820)
| ---[ end trace 06feb22469d89fa8 ]---
| Kernel panic - not syncing: Fatal exception
| SMP: stopping secondary CPUs
| Kernel Offset: disabled
| CPU features: 0x10,a0002008
| Memory Limit: none
Fixes: 8cb7cf56c9fe ("firmware: add support for ARM System Control and Power Interface(SCPI) protocol")
Signed-off-by: Luo Qiu <luoqiu@kylinsec.com.cn>
Message-Id: <55A2F7A784391686+20241101032115.275977-1-luoqiu@kylinsec.com.cn>
Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051)

| -rw-r--r-- | [drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scpi.c?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/firmware/arm\_scpi.c b/drivers/firmware/arm\_scpi.cindex 435d0e2658a42e..3de25e9d18ef84 100644--- a/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=ec0b5a3454fe349ecef4c2e9f051412c984ff674)+++ b/[drivers/firmware/arm\_scpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scpi.c?id=2a5b8de6fcb944f9af0c5fcb30bb0c039705e051)@@ -627,6 +627,9 @@ static struct scpi\_dvfs\_info \*scpi\_dvfs\_get\_info(u8 domain) if (ret) return ERR\_PTR(ret); + if (!buf.opp\_count)+ return ERR\_PTR(-ENOENT);+ info = kmalloc(sizeof(\*info), GFP\_KERNEL); if (!info) return ERR\_PTR(-ENOMEM); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:59:28 +0000


