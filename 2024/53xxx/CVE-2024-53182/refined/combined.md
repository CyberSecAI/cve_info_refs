=== Content from git.kernel.org_815a84a7_20250115_084808.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7baf94232651f39f7108c23bc9548bff89bdc77b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7baf94232651f39f7108c23bc9548bff89bdc77b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7baf94232651f39f7108c23bc9548bff89bdc77b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7baf94232651f39f7108c23bc9548bff89bdc77b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zach Wade <zachwade.k@gmail.com> | 2024-11-19 23:34:10 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:54 +0100 |
| commit | [7baf94232651f39f7108c23bc9548bff89bdc77b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7baf94232651f39f7108c23bc9548bff89bdc77b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7baf94232651f39f7108c23bc9548bff89bdc77b)) | |
| tree | [30aacbd3a4f4b4052a034af6b85e3faf794b66c4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7baf94232651f39f7108c23bc9548bff89bdc77b) | |
| parent | [1fae444a616620b9bb694f6bed8abc065a7023a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1fae444a616620b9bb694f6bed8abc065a7023a0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7baf94232651f39f7108c23bc9548bff89bdc77b&id2=1fae444a616620b9bb694f6bed8abc065a7023a0)) | |
| download | [linux-7baf94232651f39f7108c23bc9548bff89bdc77b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7baf94232651f39f7108c23bc9548bff89bdc77b.tar.gz) | |

Revert "block, bfq: merge bfq\_release\_process\_ref() into bfq\_put\_cooperator()"commit cf5a60d971c7b59efb89927919404be655a9e35a upstream.
This reverts commit bc3b1e9e7c50e1de0f573eea3871db61dd4787de.
The bic is associated with sync\_bfqq, and bfq\_release\_process\_ref cannot
be put into bfq\_put\_cooperator.
kasan report:
[ 400.347277] ==================================================================
[ 400.347287] BUG: KASAN: slab-use-after-free in bic\_set\_bfqq+0x200/0x230
[ 400.347420] Read of size 8 at addr ffff88881cab7d60 by task dockerd/5800
[ 400.347430]
[ 400.347436] CPU: 24 UID: 0 PID: 5800 Comm: dockerd Kdump: loaded Tainted: G E 6.12.0 #32
[ 400.347450] Tainted: [E]=UNSIGNED\_MODULE
[ 400.347454] Hardware name: VMware, Inc. VMware20,1/440BX Desktop Reference Platform, BIOS VMW201.00V.20192059.B64.2207280713 07/28/2022
[ 400.347460] Call Trace:
[ 400.347464] <TASK>
[ 400.347468] dump\_stack\_lvl+0x5d/0x80
[ 400.347490] print\_report+0x174/0x505
[ 400.347521] kasan\_report+0xe0/0x160
[ 400.347541] bic\_set\_bfqq+0x200/0x230
[ 400.347549] bfq\_bic\_update\_cgroup+0x419/0x740
[ 400.347560] bfq\_bio\_merge+0x133/0x320
[ 400.347584] blk\_mq\_submit\_bio+0x1761/0x1e20
[ 400.347625] \_\_submit\_bio+0x28b/0x7b0
[ 400.347664] submit\_bio\_noacct\_nocheck+0x6b2/0xd30
[ 400.347690] iomap\_readahead+0x50c/0x680
[ 400.347731] read\_pages+0x17f/0x9c0
[ 400.347785] page\_cache\_ra\_unbounded+0x366/0x4a0
[ 400.347795] filemap\_fault+0x83d/0x2340
[ 400.347819] \_\_xfs\_filemap\_fault+0x11a/0x7d0 [xfs]
[ 400.349256] \_\_do\_fault+0xf1/0x610
[ 400.349270] do\_fault+0x977/0x11a0
[ 400.349281] \_\_handle\_mm\_fault+0x5d1/0x850
[ 400.349314] handle\_mm\_fault+0x1f8/0x560
[ 400.349324] do\_user\_addr\_fault+0x324/0x970
[ 400.349337] exc\_page\_fault+0x76/0xf0
[ 400.349350] asm\_exc\_page\_fault+0x26/0x30
[ 400.349360] RIP: 0033:0x55a480d77375
[ 400.349384] Code: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc 49 3b 66 10 0f 86 ae 02 00 00 55 48 89 e5 48 83 ec 58 48 8b 10 <83> 7a 10 00 0f 84 27 02 00 00 44 0f b6 42 28 44 0f b6 4a 29 41 80
[ 400.349392] RSP: 002b:00007f18c37fd8b8 EFLAGS: 00010216
[ 400.349401] RAX: 00007f18c37fd9d0 RBX: 0000000000000000 RCX: 0000000000000000
[ 400.349407] RDX: 000055a484407d38 RSI: 000000c000e8b0c0 RDI: 0000000000000000
[ 400.349412] RBP: 00007f18c37fd910 R08: 000055a484017f60 R09: 000055a484066f80
[ 400.349417] R10: 0000000000194000 R11: 0000000000000005 R12: 0000000000000008
[ 400.349422] R13: 0000000000000000 R14: 000000c000476a80 R15: 0000000000000000
[ 400.349430] </TASK>
[ 400.349452]
[ 400.349454] Allocated by task 5800:
[ 400.349459] kasan\_save\_stack+0x30/0x50
[ 400.349469] kasan\_save\_track+0x14/0x30
[ 400.349475] \_\_kasan\_slab\_alloc+0x89/0x90
[ 400.349482] kmem\_cache\_alloc\_node\_noprof+0xdc/0x2a0
[ 400.349492] bfq\_get\_queue+0x1ef/0x1100
[ 400.349502] \_\_bfq\_get\_bfqq\_handle\_split+0x11a/0x510
[ 400.349511] bfq\_insert\_requests+0xf55/0x9030
[ 400.349519] blk\_mq\_flush\_plug\_list+0x446/0x14c0
[ 400.349527] \_\_blk\_flush\_plug+0x27c/0x4e0
[ 400.349534] blk\_finish\_plug+0x52/0xa0
[ 400.349540] \_xfs\_buf\_ioapply+0x739/0xc30 [xfs]
[ 400.350246] \_\_xfs\_buf\_submit+0x1b2/0x640 [xfs]
[ 400.350967] xfs\_buf\_read\_map+0x306/0xa20 [xfs]
[ 400.351672] xfs\_trans\_read\_buf\_map+0x285/0x7d0 [xfs]
[ 400.352386] xfs\_imap\_to\_bp+0x107/0x270 [xfs]
[ 400.353077] xfs\_iget+0x70d/0x1eb0 [xfs]
[ 400.353786] xfs\_lookup+0x2ca/0x3a0 [xfs]
[ 400.354506] xfs\_vn\_lookup+0x14e/0x1a0 [xfs]
[ 400.355197] \_\_lookup\_slow+0x19c/0x340
[ 400.355204] lookup\_one\_unlocked+0xfc/0x120
[ 400.355211] ovl\_lookup\_single+0x1b3/0xcf0 [overlay]
[ 400.355255] ovl\_lookup\_layer+0x316/0x490 [overlay]
[ 400.355295] ovl\_lookup+0x844/0x1fd0 [overlay]
[ 400.355351] lookup\_one\_qstr\_excl+0xef/0x150
[ 400.355357] do\_unlinkat+0x22a/0x620
[ 400.355366] \_\_x64\_sys\_unlinkat+0x109/0x1e0
[ 400.355375] do\_syscall\_64+0x82/0x160
[ 400.355384] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 400.355393]
[ 400.355395] Freed by task 5800:
[ 400.355400] kasan\_save\_stack+0x30/0x50
[ 400.355407] kasan\_save\_track+0x14/0x30
[ 400.355413] kasan\_save\_free\_info+0x3b/0x70
[ 400.355422] \_\_kasan\_slab\_free+0x4f/0x70
[ 400.355429] kmem\_cache\_free+0x176/0x520
[ 400.355438] bfq\_put\_queue+0x67e/0x980
[ 400.355447] bfq\_bic\_update\_cgroup+0x407/0x740
[ 400.355454] bfq\_bio\_merge+0x133/0x320
[ 400.355460] blk\_mq\_submit\_bio+0x1761/0x1e20
[ 400.355467] \_\_submit\_bio+0x28b/0x7b0
[ 400.355473] submit\_bio\_noacct\_nocheck+0x6b2/0xd30
[ 400.355480] iomap\_readahead+0x50c/0x680
[ 400.355490] read\_pages+0x17f/0x9c0
[ 400.355498] page\_cache\_ra\_unbounded+0x366/0x4a0
[ 400.355505] filemap\_fault+0x83d/0x2340
[ 400.355514] \_\_xfs\_filemap\_fault+0x11a/0x7d0 [xfs]
[ 400.356204] \_\_do\_fault+0xf1/0x610
[ 400.356213] do\_fault+0x977/0x11a0
[ 400.356221] \_\_handle\_mm\_fault+0x5d1/0x850
[ 400.356230] handle\_mm\_fault+0x1f8/0x560
[ 400.356238] do\_user\_addr\_fault+0x324/0x970
[ 400.356248] exc\_page\_fault+0x76/0xf0
[ 400.356258] asm\_exc\_page\_fault+0x26/0x30
[ 400.356266]
[ 400.356269] The buggy address belongs to the object at ffff88881cab7bc0
which belongs to the cache bfq\_queue of size 576
[ 400.356276] The buggy address is located 416 bytes inside of
freed 576-byte region [ffff88881cab7bc0, ffff88881cab7e00)
[ 400.356285]
[ 400.356287] The buggy address belongs to the physical page:
[ 400.356292] page: refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff88881cab0b00 pfn:0x81cab0
[ 400.356300] head: order:3 mapcount:0 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
[ 400.356323] flags: 0x50000000000040(head|node=1|zone=2)
[ 400.356331] page\_type: f5(slab)
[ 400.356340] raw: 0050000000000040 ffff88880a00c280 dead000000000122 0000000000000000
[ 400.356347] raw: ffff88881cab0b00 00000000802e0025 00000001f5000000 0000000000000000
[ 400.356354] head: 0050000000000040 ffff88880a00c280 dead000000000122 0000000000000000
[ 400.356359] head: ffff88881cab0b00 00000000802e0025 00000001f5000000 0000000000000000
[ 400.356365] head: 0050000000000003 ffffea002072ac01 ffffffffffffffff 0000000000000000
[ 400.356370] head: 0000000000000008 0000000000000000 00000000ffffffff 0000000000000000
[ 400.356378] page dumped because: kasan: bad access detected
[ 400.356381]
[ 400.356383] Memory state around the buggy address:
[ 400.356387] ffff88881cab7c00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 400.356392] ffff88881cab7c80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 400.356397] >ffff88881cab7d00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 400.356400] ^
[ 400.356405] ffff88881cab7d80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 400.356409] ffff88881cab7e00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 400.356413] ==================================================================
Cc: stable@vger.kernel.org
Fixes: bc3b1e9e7c50 ("block, bfq: merge bfq\_release\_process\_ref() into bfq\_put\_cooperator()")
Signed-off-by: Zach Wade <zachwade.k@gmail.com>
Cc: Ding Hui <dinghui@sangfor.com.cn>
Reviewed-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20241119153410.2546-1-zachwade.k@gmail.com](https://lore.kernel.org/r/20241119153410.2546-1-zachwade.k%40gmail.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7baf94232651f39f7108c23bc9548bff89bdc77b)

| -rw-r--r-- | [block/bfq-cgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/bfq-cgroup.c?id=7baf94232651f39f7108c23bc9548bff89bdc77b) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/bfq-iosched.c?id=7baf94232651f39f7108c23bc9548bff89bdc77b) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 2 deletions

| diff --git a/block/bfq-cgroup.c b/block/bfq-cgroup.cindex e831aedb464329..9fb9f353315025 100644--- a/[block/bfq-cgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-cgroup.c?id=1fae444a616620b9bb694f6bed8abc065a7023a0)+++ b/[block/bfq-cgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-cgroup.c?id=7baf94232651f39f7108c23bc9548bff89bdc77b)@@ -736,6 +736,7 @@ static void bfq\_sync\_bfqq\_move(struct bfq\_data \*bfqd, \*/ bfq\_put\_cooperator(sync\_bfqq); bic\_set\_bfqq(bic, NULL, true, act\_idx);+ bfq\_release\_process\_ref(bfqd, sync\_bfqq); } } diff --git a/block/bfq-iosched.c b/block/bfq-iosched.cindex 0747d9d0e48c8a..28c2bb06e859fe 100644--- a/[block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-iosched.c?id=1fae444a616620b9bb694f6bed8abc065a7023a0)+++ b/[block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-iosched.c?id=7baf94232651f39f7108c23bc9548bff89bdc77b)@@ -5434,8 +5434,6 @@ void bfq\_put\_cooperator(struct bfq\_queue \*bfqq) bfq\_put\_queue(\_\_bfqq); \_\_bfqq = next; }-- bfq\_release\_process\_ref(bfqq->bfqd, bfqq); }  static void bfq\_exit\_bfqq(struct bfq\_data \*bfqd, struct bfq\_queue \*bfqq)@@ -5448,6 +5446,8 @@ static void bfq\_exit\_bfqq(struct bfq\_data \*bfqd, struct bfq\_queue \*bfqq) bfq\_log\_bfqq(bfqd, bfqq, "exit\_bfqq: %p, %d", bfqq, bfqq->ref);  bfq\_put\_cooperator(bfqq);++ bfq\_release\_process\_ref(bfqd, bfqq); }  static void bfq\_exit\_icq\_bfqq(struct bfq\_io\_cq \*bic, bool is\_sync,@@ -6734,6 +6734,8 @@ bfq\_split\_bfqq(struct bfq\_io\_cq \*bic, struct bfq\_queue \*bfqq) bic\_set\_bfqq(bic, NULL, true, bfqq->actuator\_idx);  bfq\_put\_cooperator(bfqq);++ bfq\_release\_process\_ref(bfqq->bfqd, bfqq); return NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:46:46 +0000



=== Content from git.kernel.org_ba48bd52_20250115_084809.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cf5a60d971c7b59efb89927919404be655a9e35a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf5a60d971c7b59efb89927919404be655a9e35a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf5a60d971c7b59efb89927919404be655a9e35a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf5a60d971c7b59efb89927919404be655a9e35a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zach Wade <zachwade.k@gmail.com> | 2024-11-19 23:34:10 +0800 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-11-19 19:05:32 -0700 |
| commit | [cf5a60d971c7b59efb89927919404be655a9e35a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf5a60d971c7b59efb89927919404be655a9e35a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cf5a60d971c7b59efb89927919404be655a9e35a)) | |
| tree | [e3084c8d65cfdcaec40ce40e52bf61fd7f6f2589](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf5a60d971c7b59efb89927919404be655a9e35a) | |
| parent | [a1d9b4fd42d93f46c11e7e9d919a55a3f6ca6126](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a1d9b4fd42d93f46c11e7e9d919a55a3f6ca6126) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf5a60d971c7b59efb89927919404be655a9e35a&id2=a1d9b4fd42d93f46c11e7e9d919a55a3f6ca6126)) | |
| download | [linux-cf5a60d971c7b59efb89927919404be655a9e35a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cf5a60d971c7b59efb89927919404be655a9e35a.tar.gz) | |

Revert "block, bfq: merge bfq\_release\_process\_ref() into bfq\_put\_cooperator()"This reverts commit bc3b1e9e7c50e1de0f573eea3871db61dd4787de.
The bic is associated with sync\_bfqq, and bfq\_release\_process\_ref cannot
be put into bfq\_put\_cooperator.
kasan report:
[ 400.347277] ==================================================================
[ 400.347287] BUG: KASAN: slab-use-after-free in bic\_set\_bfqq+0x200/0x230
[ 400.347420] Read of size 8 at addr ffff88881cab7d60 by task dockerd/5800
[ 400.347430]
[ 400.347436] CPU: 24 UID: 0 PID: 5800 Comm: dockerd Kdump: loaded Tainted: G E 6.12.0 #32
[ 400.347450] Tainted: [E]=UNSIGNED\_MODULE
[ 400.347454] Hardware name: VMware, Inc. VMware20,1/440BX Desktop Reference Platform, BIOS VMW201.00V.20192059.B64.2207280713 07/28/2022
[ 400.347460] Call Trace:
[ 400.347464] <TASK>
[ 400.347468] dump\_stack\_lvl+0x5d/0x80
[ 400.347490] print\_report+0x174/0x505
[ 400.347521] kasan\_report+0xe0/0x160
[ 400.347541] bic\_set\_bfqq+0x200/0x230
[ 400.347549] bfq\_bic\_update\_cgroup+0x419/0x740
[ 400.347560] bfq\_bio\_merge+0x133/0x320
[ 400.347584] blk\_mq\_submit\_bio+0x1761/0x1e20
[ 400.347625] \_\_submit\_bio+0x28b/0x7b0
[ 400.347664] submit\_bio\_noacct\_nocheck+0x6b2/0xd30
[ 400.347690] iomap\_readahead+0x50c/0x680
[ 400.347731] read\_pages+0x17f/0x9c0
[ 400.347785] page\_cache\_ra\_unbounded+0x366/0x4a0
[ 400.347795] filemap\_fault+0x83d/0x2340
[ 400.347819] \_\_xfs\_filemap\_fault+0x11a/0x7d0 [xfs]
[ 400.349256] \_\_do\_fault+0xf1/0x610
[ 400.349270] do\_fault+0x977/0x11a0
[ 400.349281] \_\_handle\_mm\_fault+0x5d1/0x850
[ 400.349314] handle\_mm\_fault+0x1f8/0x560
[ 400.349324] do\_user\_addr\_fault+0x324/0x970
[ 400.349337] exc\_page\_fault+0x76/0xf0
[ 400.349350] asm\_exc\_page\_fault+0x26/0x30
[ 400.349360] RIP: 0033:0x55a480d77375
[ 400.349384] Code: cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc cc 49 3b 66 10 0f 86 ae 02 00 00 55 48 89 e5 48 83 ec 58 48 8b 10 <83> 7a 10 00 0f 84 27 02 00 00 44 0f b6 42 28 44 0f b6 4a 29 41 80
[ 400.349392] RSP: 002b:00007f18c37fd8b8 EFLAGS: 00010216
[ 400.349401] RAX: 00007f18c37fd9d0 RBX: 0000000000000000 RCX: 0000000000000000
[ 400.349407] RDX: 000055a484407d38 RSI: 000000c000e8b0c0 RDI: 0000000000000000
[ 400.349412] RBP: 00007f18c37fd910 R08: 000055a484017f60 R09: 000055a484066f80
[ 400.349417] R10: 0000000000194000 R11: 0000000000000005 R12: 0000000000000008
[ 400.349422] R13: 0000000000000000 R14: 000000c000476a80 R15: 0000000000000000
[ 400.349430] </TASK>
[ 400.349452]
[ 400.349454] Allocated by task 5800:
[ 400.349459] kasan\_save\_stack+0x30/0x50
[ 400.349469] kasan\_save\_track+0x14/0x30
[ 400.349475] \_\_kasan\_slab\_alloc+0x89/0x90
[ 400.349482] kmem\_cache\_alloc\_node\_noprof+0xdc/0x2a0
[ 400.349492] bfq\_get\_queue+0x1ef/0x1100
[ 400.349502] \_\_bfq\_get\_bfqq\_handle\_split+0x11a/0x510
[ 400.349511] bfq\_insert\_requests+0xf55/0x9030
[ 400.349519] blk\_mq\_flush\_plug\_list+0x446/0x14c0
[ 400.349527] \_\_blk\_flush\_plug+0x27c/0x4e0
[ 400.349534] blk\_finish\_plug+0x52/0xa0
[ 400.349540] \_xfs\_buf\_ioapply+0x739/0xc30 [xfs]
[ 400.350246] \_\_xfs\_buf\_submit+0x1b2/0x640 [xfs]
[ 400.350967] xfs\_buf\_read\_map+0x306/0xa20 [xfs]
[ 400.351672] xfs\_trans\_read\_buf\_map+0x285/0x7d0 [xfs]
[ 400.352386] xfs\_imap\_to\_bp+0x107/0x270 [xfs]
[ 400.353077] xfs\_iget+0x70d/0x1eb0 [xfs]
[ 400.353786] xfs\_lookup+0x2ca/0x3a0 [xfs]
[ 400.354506] xfs\_vn\_lookup+0x14e/0x1a0 [xfs]
[ 400.355197] \_\_lookup\_slow+0x19c/0x340
[ 400.355204] lookup\_one\_unlocked+0xfc/0x120
[ 400.355211] ovl\_lookup\_single+0x1b3/0xcf0 [overlay]
[ 400.355255] ovl\_lookup\_layer+0x316/0x490 [overlay]
[ 400.355295] ovl\_lookup+0x844/0x1fd0 [overlay]
[ 400.355351] lookup\_one\_qstr\_excl+0xef/0x150
[ 400.355357] do\_unlinkat+0x22a/0x620
[ 400.355366] \_\_x64\_sys\_unlinkat+0x109/0x1e0
[ 400.355375] do\_syscall\_64+0x82/0x160
[ 400.355384] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 400.355393]
[ 400.355395] Freed by task 5800:
[ 400.355400] kasan\_save\_stack+0x30/0x50
[ 400.355407] kasan\_save\_track+0x14/0x30
[ 400.355413] kasan\_save\_free\_info+0x3b/0x70
[ 400.355422] \_\_kasan\_slab\_free+0x4f/0x70
[ 400.355429] kmem\_cache\_free+0x176/0x520
[ 400.355438] bfq\_put\_queue+0x67e/0x980
[ 400.355447] bfq\_bic\_update\_cgroup+0x407/0x740
[ 400.355454] bfq\_bio\_merge+0x133/0x320
[ 400.355460] blk\_mq\_submit\_bio+0x1761/0x1e20
[ 400.355467] \_\_submit\_bio+0x28b/0x7b0
[ 400.355473] submit\_bio\_noacct\_nocheck+0x6b2/0xd30
[ 400.355480] iomap\_readahead+0x50c/0x680
[ 400.355490] read\_pages+0x17f/0x9c0
[ 400.355498] page\_cache\_ra\_unbounded+0x366/0x4a0
[ 400.355505] filemap\_fault+0x83d/0x2340
[ 400.355514] \_\_xfs\_filemap\_fault+0x11a/0x7d0 [xfs]
[ 400.356204] \_\_do\_fault+0xf1/0x610
[ 400.356213] do\_fault+0x977/0x11a0
[ 400.356221] \_\_handle\_mm\_fault+0x5d1/0x850
[ 400.356230] handle\_mm\_fault+0x1f8/0x560
[ 400.356238] do\_user\_addr\_fault+0x324/0x970
[ 400.356248] exc\_page\_fault+0x76/0xf0
[ 400.356258] asm\_exc\_page\_fault+0x26/0x30
[ 400.356266]
[ 400.356269] The buggy address belongs to the object at ffff88881cab7bc0
which belongs to the cache bfq\_queue of size 576
[ 400.356276] The buggy address is located 416 bytes inside of
freed 576-byte region [ffff88881cab7bc0, ffff88881cab7e00)
[ 400.356285]
[ 400.356287] The buggy address belongs to the physical page:
[ 400.356292] page: refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff88881cab0b00 pfn:0x81cab0
[ 400.356300] head: order:3 mapcount:0 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
[ 400.356323] flags: 0x50000000000040(head|node=1|zone=2)
[ 400.356331] page\_type: f5(slab)
[ 400.356340] raw: 0050000000000040 ffff88880a00c280 dead000000000122 0000000000000000
[ 400.356347] raw: ffff88881cab0b00 00000000802e0025 00000001f5000000 0000000000000000
[ 400.356354] head: 0050000000000040 ffff88880a00c280 dead000000000122 0000000000000000
[ 400.356359] head: ffff88881cab0b00 00000000802e0025 00000001f5000000 0000000000000000
[ 400.356365] head: 0050000000000003 ffffea002072ac01 ffffffffffffffff 0000000000000000
[ 400.356370] head: 0000000000000008 0000000000000000 00000000ffffffff 0000000000000000
[ 400.356378] page dumped because: kasan: bad access detected
[ 400.356381]
[ 400.356383] Memory state around the buggy address:
[ 400.356387] ffff88881cab7c00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 400.356392] ffff88881cab7c80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 400.356397] >ffff88881cab7d00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 400.356400] ^
[ 400.356405] ffff88881cab7d80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 400.356409] ffff88881cab7e00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 400.356413] ==================================================================
Cc: stable@vger.kernel.org
Fixes: bc3b1e9e7c50 ("block, bfq: merge bfq\_release\_process\_ref() into bfq\_put\_cooperator()")
Signed-off-by: Zach Wade <zachwade.k@gmail.com>
Cc: Ding Hui <dinghui@sangfor.com.cn>
Reviewed-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20241119153410.2546-1-zachwade.k@gmail.com](https://lore.kernel.org/r/20241119153410.2546-1-zachwade.k%40gmail.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf5a60d971c7b59efb89927919404be655a9e35a)

| -rw-r--r-- | [block/bfq-cgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/bfq-cgroup.c?id=cf5a60d971c7b59efb89927919404be655a9e35a) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/bfq-iosched.c?id=cf5a60d971c7b59efb89927919404be655a9e35a) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 2 deletions

| diff --git a/block/bfq-cgroup.c b/block/bfq-cgroup.cindex e831aedb464329..9fb9f353315025 100644--- a/[block/bfq-cgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-cgroup.c?id=a1d9b4fd42d93f46c11e7e9d919a55a3f6ca6126)+++ b/[block/bfq-cgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-cgroup.c?id=cf5a60d971c7b59efb89927919404be655a9e35a)@@ -736,6 +736,7 @@ static void bfq\_sync\_bfqq\_move(struct bfq\_data \*bfqd, \*/ bfq\_put\_cooperator(sync\_bfqq); bic\_set\_bfqq(bic, NULL, true, act\_idx);+ bfq\_release\_process\_ref(bfqd, sync\_bfqq); } } diff --git a/block/bfq-iosched.c b/block/bfq-iosched.cindex 0747d9d0e48c8a..28c2bb06e859fe 100644--- a/[block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-iosched.c?id=a1d9b4fd42d93f46c11e7e9d919a55a3f6ca6126)+++ b/[block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-iosched.c?id=cf5a60d971c7b59efb89927919404be655a9e35a)@@ -5434,8 +5434,6 @@ void bfq\_put\_cooperator(struct bfq\_queue \*bfqq) bfq\_put\_queue(\_\_bfqq); \_\_bfqq = next; }-- bfq\_release\_process\_ref(bfqq->bfqd, bfqq); }  static void bfq\_exit\_bfqq(struct bfq\_data \*bfqd, struct bfq\_queue \*bfqq)@@ -5448,6 +5446,8 @@ static void bfq\_exit\_bfqq(struct bfq\_data \*bfqd, struct bfq\_queue \*bfqq) bfq\_log\_bfqq(bfqd, bfqq, "exit\_bfqq: %p, %d", bfqq, bfqq->ref);  bfq\_put\_cooperator(bfqq);++ bfq\_release\_process\_ref(bfqd, bfqq); }  static void bfq\_exit\_icq\_bfqq(struct bfq\_io\_cq \*bic, bool is\_sync,@@ -6734,6 +6734,8 @@ bfq\_split\_bfqq(struct bfq\_io\_cq \*bic, struct bfq\_queue \*bfqq) bic\_set\_bfqq(bic, NULL, true, bfqq->actuator\_idx);  bfq\_put\_cooperator(bfqq);++ bfq\_release\_process\_ref(bfqq->bfqd, bfqq); return NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:46:46 +0000


