=== Content from git.kernel.org_ad58552a_20250114_201714.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8f3551f67991652c83469c7dd51d7b9b187b265f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f3551f67991652c83469c7dd51d7b9b187b265f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f3551f67991652c83469c7dd51d7b9b187b265f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f3551f67991652c83469c7dd51d7b9b187b265f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guilherme G. Piccoli <gpiccoli@igalia.com> | 2024-11-01 16:30:05 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:46 +0100 |
| commit | [8f3551f67991652c83469c7dd51d7b9b187b265f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f3551f67991652c83469c7dd51d7b9b187b265f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8f3551f67991652c83469c7dd51d7b9b187b265f)) | |
| tree | [61bc0ad492db523f888a9b13d63a0f7a7a87cea9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f3551f67991652c83469c7dd51d7b9b187b265f) | |
| parent | [223b546c6222d42147eff034433002ca5e2e7e09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=223b546c6222d42147eff034433002ca5e2e7e09) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f3551f67991652c83469c7dd51d7b9b187b265f&id2=223b546c6222d42147eff034433002ca5e2e7e09)) | |
| download | [linux-8f3551f67991652c83469c7dd51d7b9b187b265f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8f3551f67991652c83469c7dd51d7b9b187b265f.tar.gz) | |

wifi: rtlwifi: Drastically reduce the attempts to read efuse in case of failurescommit 5c1b544563005a00591a3aa86ecff62ed4d11be3 upstream.
Syzkaller reported a hung task with uevent\_show() on stack trace. That
specific issue was addressed by another commit [0], but even with that
fix applied (for example, running v6.12-rc5) we face another type of hung
task that comes from the same reproducer [1]. By investigating that, we
could narrow it to the following path:
(a) Syzkaller emulates a Realtek USB WiFi adapter using raw-gadget and
dummy\_hcd infrastructure.
(b) During the probe of rtl8192cu, the driver ends-up performing an efuse
read procedure (which is related to EEPROM load IIUC), and here lies the
issue: the function read\_efuse() calls read\_efuse\_byte() many times, as
loop iterations depending on the efuse size (in our example, 512 in total).
This procedure for reading efuse bytes relies in a loop that performs an
I/O read up to \*10k\* times in case of failures. We measured the time of
the loop inside read\_efuse\_byte() alone, and in this reproducer (which
involves the dummy\_hcd emulation layer), it takes 15 seconds each. As a
consequence, we have the driver stuck in its probe routine for big time,
exposing a stack trace like below if we attempt to reboot the system, for
example:
task:kworker/0:3 state:D stack:0 pid:662 tgid:662 ppid:2 flags:0x00004000
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_schedule+0xe22/0xeb6
schedule\_timeout+0xe7/0x132
\_\_wait\_for\_common+0xb5/0x12e
usb\_start\_wait\_urb+0xc5/0x1ef
? usb\_alloc\_urb+0x95/0xa4
usb\_control\_msg+0xff/0x184
\_usbctrl\_vendorreq\_sync+0xa0/0x161
\_usb\_read\_sync+0xb3/0xc5
read\_efuse\_byte+0x13c/0x146
read\_efuse+0x351/0x5f0
efuse\_read\_all\_map+0x42/0x52
rtl\_efuse\_shadow\_map\_update+0x60/0xef
rtl\_get\_hwinfo+0x5d/0x1c2
rtl92cu\_read\_eeprom\_info+0x10a/0x8d5
? rtl92c\_read\_chip\_version+0x14f/0x17e
rtl\_usb\_probe+0x323/0x851
usb\_probe\_interface+0x278/0x34b
really\_probe+0x202/0x4a4
\_\_driver\_probe\_device+0x166/0x1b2
driver\_probe\_device+0x2f/0xd8
[...]
We propose hereby to drastically reduce the attempts of doing the I/O
reads in case of failures, restricted to USB devices (given that
they're inherently slower than PCIe ones). By retrying up to 10 times
(instead of 10000), we got reponsiveness in the reproducer, while seems
reasonable to believe that there's no sane USB device implementation in
the field requiring this amount of retries at every I/O read in order
to properly work. Based on that assumption, it'd be good to have it
backported to stable but maybe not since driver implementation (the 10k
number comes from day 0), perhaps up to 6.x series makes sense.
[0] Commit 15fffc6a5624 ("driver core: Fix uevent\_show() vs driver detach race")
[1] A note about that: this syzkaller report presents multiple reproducers
that differs by the type of emulated USB device. For this specific case,
check the entry from 2024/08/08 06:23 in the list of crashes; the C repro
is available at https://syzkaller.appspot.com/text?tag=ReproC&x=1521fc83980000.
Cc: stable@vger.kernel.org # v6.1+
Reported-by: syzbot+edd9fe0d3a65b14588d5@syzkaller.appspotmail.com
Tested-by: Bitterblue Smith <rtl8821cerfe2@gmail.com>
Signed-off-by: Guilherme G. Piccoli <gpiccoli@igalia.com>
Signed-off-by: Ping-Ke Shih <pkshih@realtek.com>
Link: [https://patch.msgid.link/20241101193412.1390391-1-gpiccoli@igalia.com](https://patch.msgid.link/20241101193412.1390391-1-gpiccoli%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f3551f67991652c83469c7dd51d7b9b187b265f)

| -rw-r--r-- | [drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=8f3551f67991652c83469c7dd51d7b9b187b265f) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 1 deletions

| diff --git a/drivers/net/wireless/realtek/rtlwifi/efuse.c b/drivers/net/wireless/realtek/rtlwifi/efuse.cindex 2e945554ed6d59..6c8efd2b264269 100644--- a/[drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=223b546c6222d42147eff034433002ca5e2e7e09)+++ b/[drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=8f3551f67991652c83469c7dd51d7b9b187b265f)@@ -162,10 +162,19 @@ void efuse\_write\_1byte(struct ieee80211\_hw \*hw, u16 address, u8 value) void read\_efuse\_byte(struct ieee80211\_hw \*hw, u16 \_offset, u8 \*pbuf) { struct rtl\_priv \*rtlpriv = rtl\_priv(hw);+ u16 max\_attempts = 10000; u32 value32; u8 readbyte; u16 retry; + /\*+ \* In case of USB devices, transfer speeds are limited, hence+ \* efuse I/O reads could be (way) slower. So, decrease (a lot)+ \* the read attempts in case of failures.+ \*/+ if (rtlpriv->rtlhal.interface == INTF\_USB)+ max\_attempts = 10;+ rtl\_write\_byte(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL] + 1, (\_offset & 0xff)); readbyte = rtl\_read\_byte(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL] + 2);@@ -178,7 +187,7 @@ void read\_efuse\_byte(struct ieee80211\_hw \*hw, u16 \_offset, u8 \*pbuf)  retry = 0; value32 = rtl\_read\_dword(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL]);- while (!(((value32 >> 24) & 0xff) & 0x80) && (retry < 10000)) {+ while (!(((value32 >> 24) & 0xff) & 0x80) && (retry < max\_attempts)) { value32 = rtl\_read\_dword(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL]); retry++; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:15:50 +0000



=== Content from git.kernel.org_fb2ec6d1_20250114_201720.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guilherme G. Piccoli <gpiccoli@igalia.com> | 2024-11-01 16:30:05 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:14 +0100 |
| commit | [eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c)) | |
| tree | [5e8717253615f455cea2a99674639475b4db3ba3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c) | |
| parent | [90556b96338aa6037cd26dac857327fda7c19732](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90556b96338aa6037cd26dac857327fda7c19732) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c&id2=90556b96338aa6037cd26dac857327fda7c19732)) | |
| download | [linux-eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c.tar.gz) | |

wifi: rtlwifi: Drastically reduce the attempts to read efuse in case of failurescommit 5c1b544563005a00591a3aa86ecff62ed4d11be3 upstream.
Syzkaller reported a hung task with uevent\_show() on stack trace. That
specific issue was addressed by another commit [0], but even with that
fix applied (for example, running v6.12-rc5) we face another type of hung
task that comes from the same reproducer [1]. By investigating that, we
could narrow it to the following path:
(a) Syzkaller emulates a Realtek USB WiFi adapter using raw-gadget and
dummy\_hcd infrastructure.
(b) During the probe of rtl8192cu, the driver ends-up performing an efuse
read procedure (which is related to EEPROM load IIUC), and here lies the
issue: the function read\_efuse() calls read\_efuse\_byte() many times, as
loop iterations depending on the efuse size (in our example, 512 in total).
This procedure for reading efuse bytes relies in a loop that performs an
I/O read up to \*10k\* times in case of failures. We measured the time of
the loop inside read\_efuse\_byte() alone, and in this reproducer (which
involves the dummy\_hcd emulation layer), it takes 15 seconds each. As a
consequence, we have the driver stuck in its probe routine for big time,
exposing a stack trace like below if we attempt to reboot the system, for
example:
task:kworker/0:3 state:D stack:0 pid:662 tgid:662 ppid:2 flags:0x00004000
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_schedule+0xe22/0xeb6
schedule\_timeout+0xe7/0x132
\_\_wait\_for\_common+0xb5/0x12e
usb\_start\_wait\_urb+0xc5/0x1ef
? usb\_alloc\_urb+0x95/0xa4
usb\_control\_msg+0xff/0x184
\_usbctrl\_vendorreq\_sync+0xa0/0x161
\_usb\_read\_sync+0xb3/0xc5
read\_efuse\_byte+0x13c/0x146
read\_efuse+0x351/0x5f0
efuse\_read\_all\_map+0x42/0x52
rtl\_efuse\_shadow\_map\_update+0x60/0xef
rtl\_get\_hwinfo+0x5d/0x1c2
rtl92cu\_read\_eeprom\_info+0x10a/0x8d5
? rtl92c\_read\_chip\_version+0x14f/0x17e
rtl\_usb\_probe+0x323/0x851
usb\_probe\_interface+0x278/0x34b
really\_probe+0x202/0x4a4
\_\_driver\_probe\_device+0x166/0x1b2
driver\_probe\_device+0x2f/0xd8
[...]
We propose hereby to drastically reduce the attempts of doing the I/O
reads in case of failures, restricted to USB devices (given that
they're inherently slower than PCIe ones). By retrying up to 10 times
(instead of 10000), we got reponsiveness in the reproducer, while seems
reasonable to believe that there's no sane USB device implementation in
the field requiring this amount of retries at every I/O read in order
to properly work. Based on that assumption, it'd be good to have it
backported to stable but maybe not since driver implementation (the 10k
number comes from day 0), perhaps up to 6.x series makes sense.
[0] Commit 15fffc6a5624 ("driver core: Fix uevent\_show() vs driver detach race")
[1] A note about that: this syzkaller report presents multiple reproducers
that differs by the type of emulated USB device. For this specific case,
check the entry from 2024/08/08 06:23 in the list of crashes; the C repro
is available at https://syzkaller.appspot.com/text?tag=ReproC&x=1521fc83980000.
Cc: stable@vger.kernel.org # v6.1+
Reported-by: syzbot+edd9fe0d3a65b14588d5@syzkaller.appspotmail.com
Tested-by: Bitterblue Smith <rtl8821cerfe2@gmail.com>
Signed-off-by: Guilherme G. Piccoli <gpiccoli@igalia.com>
Signed-off-by: Ping-Ke Shih <pkshih@realtek.com>
Link: [https://patch.msgid.link/20241101193412.1390391-1-gpiccoli@igalia.com](https://patch.msgid.link/20241101193412.1390391-1-gpiccoli%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c)

| -rw-r--r-- | [drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 1 deletions

| diff --git a/drivers/net/wireless/realtek/rtlwifi/efuse.c b/drivers/net/wireless/realtek/rtlwifi/efuse.cindex 82cf5fb5175fef..6518e77b89f578 100644--- a/[drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=90556b96338aa6037cd26dac857327fda7c19732)+++ b/[drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=eeb0b9b9e66b0b54cdad8e1c1cf0f55e8ba4211c)@@ -162,10 +162,19 @@ void efuse\_write\_1byte(struct ieee80211\_hw \*hw, u16 address, u8 value) void read\_efuse\_byte(struct ieee80211\_hw \*hw, u16 \_offset, u8 \*pbuf) { struct rtl\_priv \*rtlpriv = rtl\_priv(hw);+ u16 max\_attempts = 10000; u32 value32; u8 readbyte; u16 retry; + /\*+ \* In case of USB devices, transfer speeds are limited, hence+ \* efuse I/O reads could be (way) slower. So, decrease (a lot)+ \* the read attempts in case of failures.+ \*/+ if (rtlpriv->rtlhal.interface == INTF\_USB)+ max\_attempts = 10;+ rtl\_write\_byte(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL] + 1, (\_offset & 0xff)); readbyte = rtl\_read\_byte(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL] + 2);@@ -178,7 +187,7 @@ void read\_efuse\_byte(struct ieee80211\_hw \*hw, u16 \_offset, u8 \*pbuf)  retry = 0; value32 = rtl\_read\_dword(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL]);- while (!(((value32 >> 24) & 0xff) & 0x80) && (retry < 10000)) {+ while (!(((value32 >> 24) & 0xff) & 0x80) && (retry < max\_attempts)) { value32 = rtl\_read\_dword(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL]); retry++; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:15:56 +0000



=== Content from git.kernel.org_633c95b3_20250114_201718.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guilherme G. Piccoli <gpiccoli@igalia.com> | 2024-11-01 16:30:05 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:01 +0100 |
| commit | [c386fb76f01794f1023d01a6ec5f5c93d00acd3b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b)) | |
| tree | [81518076cd2693e0ca8ea1df726b7aea76f9f217](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b) | |
| parent | [fc1f391a71a3ee88291e205cffd673fe24d99266](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc1f391a71a3ee88291e205cffd673fe24d99266) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b&id2=fc1f391a71a3ee88291e205cffd673fe24d99266)) | |
| download | [linux-c386fb76f01794f1023d01a6ec5f5c93d00acd3b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c386fb76f01794f1023d01a6ec5f5c93d00acd3b.tar.gz) | |

wifi: rtlwifi: Drastically reduce the attempts to read efuse in case of failurescommit 5c1b544563005a00591a3aa86ecff62ed4d11be3 upstream.
Syzkaller reported a hung task with uevent\_show() on stack trace. That
specific issue was addressed by another commit [0], but even with that
fix applied (for example, running v6.12-rc5) we face another type of hung
task that comes from the same reproducer [1]. By investigating that, we
could narrow it to the following path:
(a) Syzkaller emulates a Realtek USB WiFi adapter using raw-gadget and
dummy\_hcd infrastructure.
(b) During the probe of rtl8192cu, the driver ends-up performing an efuse
read procedure (which is related to EEPROM load IIUC), and here lies the
issue: the function read\_efuse() calls read\_efuse\_byte() many times, as
loop iterations depending on the efuse size (in our example, 512 in total).
This procedure for reading efuse bytes relies in a loop that performs an
I/O read up to \*10k\* times in case of failures. We measured the time of
the loop inside read\_efuse\_byte() alone, and in this reproducer (which
involves the dummy\_hcd emulation layer), it takes 15 seconds each. As a
consequence, we have the driver stuck in its probe routine for big time,
exposing a stack trace like below if we attempt to reboot the system, for
example:
task:kworker/0:3 state:D stack:0 pid:662 tgid:662 ppid:2 flags:0x00004000
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_schedule+0xe22/0xeb6
schedule\_timeout+0xe7/0x132
\_\_wait\_for\_common+0xb5/0x12e
usb\_start\_wait\_urb+0xc5/0x1ef
? usb\_alloc\_urb+0x95/0xa4
usb\_control\_msg+0xff/0x184
\_usbctrl\_vendorreq\_sync+0xa0/0x161
\_usb\_read\_sync+0xb3/0xc5
read\_efuse\_byte+0x13c/0x146
read\_efuse+0x351/0x5f0
efuse\_read\_all\_map+0x42/0x52
rtl\_efuse\_shadow\_map\_update+0x60/0xef
rtl\_get\_hwinfo+0x5d/0x1c2
rtl92cu\_read\_eeprom\_info+0x10a/0x8d5
? rtl92c\_read\_chip\_version+0x14f/0x17e
rtl\_usb\_probe+0x323/0x851
usb\_probe\_interface+0x278/0x34b
really\_probe+0x202/0x4a4
\_\_driver\_probe\_device+0x166/0x1b2
driver\_probe\_device+0x2f/0xd8
[...]
We propose hereby to drastically reduce the attempts of doing the I/O
reads in case of failures, restricted to USB devices (given that
they're inherently slower than PCIe ones). By retrying up to 10 times
(instead of 10000), we got reponsiveness in the reproducer, while seems
reasonable to believe that there's no sane USB device implementation in
the field requiring this amount of retries at every I/O read in order
to properly work. Based on that assumption, it'd be good to have it
backported to stable but maybe not since driver implementation (the 10k
number comes from day 0), perhaps up to 6.x series makes sense.
[0] Commit 15fffc6a5624 ("driver core: Fix uevent\_show() vs driver detach race")
[1] A note about that: this syzkaller report presents multiple reproducers
that differs by the type of emulated USB device. For this specific case,
check the entry from 2024/08/08 06:23 in the list of crashes; the C repro
is available at https://syzkaller.appspot.com/text?tag=ReproC&x=1521fc83980000.
Cc: stable@vger.kernel.org # v6.1+
Reported-by: syzbot+edd9fe0d3a65b14588d5@syzkaller.appspotmail.com
Tested-by: Bitterblue Smith <rtl8821cerfe2@gmail.com>
Signed-off-by: Guilherme G. Piccoli <gpiccoli@igalia.com>
Signed-off-by: Ping-Ke Shih <pkshih@realtek.com>
Link: [https://patch.msgid.link/20241101193412.1390391-1-gpiccoli@igalia.com](https://patch.msgid.link/20241101193412.1390391-1-gpiccoli%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b)

| -rw-r--r-- | [drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 1 deletions

| diff --git a/drivers/net/wireless/realtek/rtlwifi/efuse.c b/drivers/net/wireless/realtek/rtlwifi/efuse.cindex 2e945554ed6d59..6c8efd2b264269 100644--- a/[drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=fc1f391a71a3ee88291e205cffd673fe24d99266)+++ b/[drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=c386fb76f01794f1023d01a6ec5f5c93d00acd3b)@@ -162,10 +162,19 @@ void efuse\_write\_1byte(struct ieee80211\_hw \*hw, u16 address, u8 value) void read\_efuse\_byte(struct ieee80211\_hw \*hw, u16 \_offset, u8 \*pbuf) { struct rtl\_priv \*rtlpriv = rtl\_priv(hw);+ u16 max\_attempts = 10000; u32 value32; u8 readbyte; u16 retry; + /\*+ \* In case of USB devices, transfer speeds are limited, hence+ \* efuse I/O reads could be (way) slower. So, decrease (a lot)+ \* the read attempts in case of failures.+ \*/+ if (rtlpriv->rtlhal.interface == INTF\_USB)+ max\_attempts = 10;+ rtl\_write\_byte(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL] + 1, (\_offset & 0xff)); readbyte = rtl\_read\_byte(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL] + 2);@@ -178,7 +187,7 @@ void read\_efuse\_byte(struct ieee80211\_hw \*hw, u16 \_offset, u8 \*pbuf)  retry = 0; value32 = rtl\_read\_dword(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL]);- while (!(((value32 >> 24) & 0xff) & 0x80) && (retry < 10000)) {+ while (!(((value32 >> 24) & 0xff) & 0x80) && (retry < max\_attempts)) { value32 = rtl\_read\_dword(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL]); retry++; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:15:54 +0000



=== Content from git.kernel.org_831ace77_20250114_201712.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c1b544563005a00591a3aa86ecff62ed4d11be3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c1b544563005a00591a3aa86ecff62ed4d11be3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c1b544563005a00591a3aa86ecff62ed4d11be3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c1b544563005a00591a3aa86ecff62ed4d11be3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guilherme G. Piccoli <gpiccoli@igalia.com> | 2024-11-01 16:30:05 -0300 |
| --- | --- | --- |
| committer | Ping-Ke Shih <pkshih@realtek.com> | 2024-11-06 14:32:59 +0800 |
| commit | [5c1b544563005a00591a3aa86ecff62ed4d11be3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c1b544563005a00591a3aa86ecff62ed4d11be3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c1b544563005a00591a3aa86ecff62ed4d11be3)) | |
| tree | [256c3e0a84d68d4cf48b0429289ca9c86012ac8a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c1b544563005a00591a3aa86ecff62ed4d11be3) | |
| parent | [0e3e8284f8e1bf2fc0f7bf247194efe5cfc568c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e3e8284f8e1bf2fc0f7bf247194efe5cfc568c1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c1b544563005a00591a3aa86ecff62ed4d11be3&id2=0e3e8284f8e1bf2fc0f7bf247194efe5cfc568c1)) | |
| download | [linux-5c1b544563005a00591a3aa86ecff62ed4d11be3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c1b544563005a00591a3aa86ecff62ed4d11be3.tar.gz) | |

wifi: rtlwifi: Drastically reduce the attempts to read efuse in case of failuresSyzkaller reported a hung task with uevent\_show() on stack trace. That
specific issue was addressed by another commit [0], but even with that
fix applied (for example, running v6.12-rc5) we face another type of hung
task that comes from the same reproducer [1]. By investigating that, we
could narrow it to the following path:
(a) Syzkaller emulates a Realtek USB WiFi adapter using raw-gadget and
dummy\_hcd infrastructure.
(b) During the probe of rtl8192cu, the driver ends-up performing an efuse
read procedure (which is related to EEPROM load IIUC), and here lies the
issue: the function read\_efuse() calls read\_efuse\_byte() many times, as
loop iterations depending on the efuse size (in our example, 512 in total).
This procedure for reading efuse bytes relies in a loop that performs an
I/O read up to \*10k\* times in case of failures. We measured the time of
the loop inside read\_efuse\_byte() alone, and in this reproducer (which
involves the dummy\_hcd emulation layer), it takes 15 seconds each. As a
consequence, we have the driver stuck in its probe routine for big time,
exposing a stack trace like below if we attempt to reboot the system, for
example:
task:kworker/0:3 state:D stack:0 pid:662 tgid:662 ppid:2 flags:0x00004000
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_schedule+0xe22/0xeb6
schedule\_timeout+0xe7/0x132
\_\_wait\_for\_common+0xb5/0x12e
usb\_start\_wait\_urb+0xc5/0x1ef
? usb\_alloc\_urb+0x95/0xa4
usb\_control\_msg+0xff/0x184
\_usbctrl\_vendorreq\_sync+0xa0/0x161
\_usb\_read\_sync+0xb3/0xc5
read\_efuse\_byte+0x13c/0x146
read\_efuse+0x351/0x5f0
efuse\_read\_all\_map+0x42/0x52
rtl\_efuse\_shadow\_map\_update+0x60/0xef
rtl\_get\_hwinfo+0x5d/0x1c2
rtl92cu\_read\_eeprom\_info+0x10a/0x8d5
? rtl92c\_read\_chip\_version+0x14f/0x17e
rtl\_usb\_probe+0x323/0x851
usb\_probe\_interface+0x278/0x34b
really\_probe+0x202/0x4a4
\_\_driver\_probe\_device+0x166/0x1b2
driver\_probe\_device+0x2f/0xd8
[...]
We propose hereby to drastically reduce the attempts of doing the I/O
reads in case of failures, restricted to USB devices (given that
they're inherently slower than PCIe ones). By retrying up to 10 times
(instead of 10000), we got reponsiveness in the reproducer, while seems
reasonable to believe that there's no sane USB device implementation in
the field requiring this amount of retries at every I/O read in order
to properly work. Based on that assumption, it'd be good to have it
backported to stable but maybe not since driver implementation (the 10k
number comes from day 0), perhaps up to 6.x series makes sense.
[0] Commit 15fffc6a5624 ("driver core: Fix uevent\_show() vs driver detach race")
[1] A note about that: this syzkaller report presents multiple reproducers
that differs by the type of emulated USB device. For this specific case,
check the entry from 2024/08/08 06:23 in the list of crashes; the C repro
is available at https://syzkaller.appspot.com/text?tag=ReproC&x=1521fc83980000.
Cc: stable@vger.kernel.org # v6.1+
Reported-by: syzbot+edd9fe0d3a65b14588d5@syzkaller.appspotmail.com
Tested-by: Bitterblue Smith <rtl8821cerfe2@gmail.com>
Signed-off-by: Guilherme G. Piccoli <gpiccoli@igalia.com>
Signed-off-by: Ping-Ke Shih <pkshih@realtek.com>
Link: [https://patch.msgid.link/20241101193412.1390391-1-gpiccoli@igalia.com](https://patch.msgid.link/20241101193412.1390391-1-gpiccoli%40igalia.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c1b544563005a00591a3aa86ecff62ed4d11be3)

| -rw-r--r-- | [drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=5c1b544563005a00591a3aa86ecff62ed4d11be3) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 1 deletions

| diff --git a/drivers/net/wireless/realtek/rtlwifi/efuse.c b/drivers/net/wireless/realtek/rtlwifi/efuse.cindex 82cf5fb5175fef..6518e77b89f578 100644--- a/[drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=0e3e8284f8e1bf2fc0f7bf247194efe5cfc568c1)+++ b/[drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=5c1b544563005a00591a3aa86ecff62ed4d11be3)@@ -162,10 +162,19 @@ void efuse\_write\_1byte(struct ieee80211\_hw \*hw, u16 address, u8 value) void read\_efuse\_byte(struct ieee80211\_hw \*hw, u16 \_offset, u8 \*pbuf) { struct rtl\_priv \*rtlpriv = rtl\_priv(hw);+ u16 max\_attempts = 10000; u32 value32; u8 readbyte; u16 retry; + /\*+ \* In case of USB devices, transfer speeds are limited, hence+ \* efuse I/O reads could be (way) slower. So, decrease (a lot)+ \* the read attempts in case of failures.+ \*/+ if (rtlpriv->rtlhal.interface == INTF\_USB)+ max\_attempts = 10;+ rtl\_write\_byte(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL] + 1, (\_offset & 0xff)); readbyte = rtl\_read\_byte(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL] + 2);@@ -178,7 +187,7 @@ void read\_efuse\_byte(struct ieee80211\_hw \*hw, u16 \_offset, u8 \*pbuf)  retry = 0; value32 = rtl\_read\_dword(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL]);- while (!(((value32 >> 24) & 0xff) & 0x80) && (retry < 10000)) {+ while (!(((value32 >> 24) & 0xff) & 0x80) && (retry < max\_attempts)) { value32 = rtl\_read\_dword(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL]); retry++; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:15:49 +0000



=== Content from git.kernel.org_5763528f_20250114_201715.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ac064c656f105b9122bc43991a170f95f72b7a43)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ac064c656f105b9122bc43991a170f95f72b7a43)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac064c656f105b9122bc43991a170f95f72b7a43)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac064c656f105b9122bc43991a170f95f72b7a43)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guilherme G. Piccoli <gpiccoli@igalia.com> | 2024-11-01 16:30:05 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:49 +0100 |
| commit | [ac064c656f105b9122bc43991a170f95f72b7a43](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac064c656f105b9122bc43991a170f95f72b7a43) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ac064c656f105b9122bc43991a170f95f72b7a43)) | |
| tree | [08c3d6681b8d8edee17a79a384daae7bdb241fe0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ac064c656f105b9122bc43991a170f95f72b7a43) | |
| parent | [94c9100b600f05a36b33f9ed76dbd6fb0eb25386](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94c9100b600f05a36b33f9ed76dbd6fb0eb25386) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac064c656f105b9122bc43991a170f95f72b7a43&id2=94c9100b600f05a36b33f9ed76dbd6fb0eb25386)) | |
| download | [linux-ac064c656f105b9122bc43991a170f95f72b7a43.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ac064c656f105b9122bc43991a170f95f72b7a43.tar.gz) | |

wifi: rtlwifi: Drastically reduce the attempts to read efuse in case of failurescommit 5c1b544563005a00591a3aa86ecff62ed4d11be3 upstream.
Syzkaller reported a hung task with uevent\_show() on stack trace. That
specific issue was addressed by another commit [0], but even with that
fix applied (for example, running v6.12-rc5) we face another type of hung
task that comes from the same reproducer [1]. By investigating that, we
could narrow it to the following path:
(a) Syzkaller emulates a Realtek USB WiFi adapter using raw-gadget and
dummy\_hcd infrastructure.
(b) During the probe of rtl8192cu, the driver ends-up performing an efuse
read procedure (which is related to EEPROM load IIUC), and here lies the
issue: the function read\_efuse() calls read\_efuse\_byte() many times, as
loop iterations depending on the efuse size (in our example, 512 in total).
This procedure for reading efuse bytes relies in a loop that performs an
I/O read up to \*10k\* times in case of failures. We measured the time of
the loop inside read\_efuse\_byte() alone, and in this reproducer (which
involves the dummy\_hcd emulation layer), it takes 15 seconds each. As a
consequence, we have the driver stuck in its probe routine for big time,
exposing a stack trace like below if we attempt to reboot the system, for
example:
task:kworker/0:3 state:D stack:0 pid:662 tgid:662 ppid:2 flags:0x00004000
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_schedule+0xe22/0xeb6
schedule\_timeout+0xe7/0x132
\_\_wait\_for\_common+0xb5/0x12e
usb\_start\_wait\_urb+0xc5/0x1ef
? usb\_alloc\_urb+0x95/0xa4
usb\_control\_msg+0xff/0x184
\_usbctrl\_vendorreq\_sync+0xa0/0x161
\_usb\_read\_sync+0xb3/0xc5
read\_efuse\_byte+0x13c/0x146
read\_efuse+0x351/0x5f0
efuse\_read\_all\_map+0x42/0x52
rtl\_efuse\_shadow\_map\_update+0x60/0xef
rtl\_get\_hwinfo+0x5d/0x1c2
rtl92cu\_read\_eeprom\_info+0x10a/0x8d5
? rtl92c\_read\_chip\_version+0x14f/0x17e
rtl\_usb\_probe+0x323/0x851
usb\_probe\_interface+0x278/0x34b
really\_probe+0x202/0x4a4
\_\_driver\_probe\_device+0x166/0x1b2
driver\_probe\_device+0x2f/0xd8
[...]
We propose hereby to drastically reduce the attempts of doing the I/O
reads in case of failures, restricted to USB devices (given that
they're inherently slower than PCIe ones). By retrying up to 10 times
(instead of 10000), we got reponsiveness in the reproducer, while seems
reasonable to believe that there's no sane USB device implementation in
the field requiring this amount of retries at every I/O read in order
to properly work. Based on that assumption, it'd be good to have it
backported to stable but maybe not since driver implementation (the 10k
number comes from day 0), perhaps up to 6.x series makes sense.
[0] Commit 15fffc6a5624 ("driver core: Fix uevent\_show() vs driver detach race")
[1] A note about that: this syzkaller report presents multiple reproducers
that differs by the type of emulated USB device. For this specific case,
check the entry from 2024/08/08 06:23 in the list of crashes; the C repro
is available at https://syzkaller.appspot.com/text?tag=ReproC&x=1521fc83980000.
Cc: stable@vger.kernel.org # v6.1+
Reported-by: syzbot+edd9fe0d3a65b14588d5@syzkaller.appspotmail.com
Tested-by: Bitterblue Smith <rtl8821cerfe2@gmail.com>
Signed-off-by: Guilherme G. Piccoli <gpiccoli@igalia.com>
Signed-off-by: Ping-Ke Shih <pkshih@realtek.com>
Link: [https://patch.msgid.link/20241101193412.1390391-1-gpiccoli@igalia.com](https://patch.msgid.link/20241101193412.1390391-1-gpiccoli%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac064c656f105b9122bc43991a170f95f72b7a43)

| -rw-r--r-- | [drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=ac064c656f105b9122bc43991a170f95f72b7a43) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 1 deletions

| diff --git a/drivers/net/wireless/realtek/rtlwifi/efuse.c b/drivers/net/wireless/realtek/rtlwifi/efuse.cindex 82cf5fb5175fef..6518e77b89f578 100644--- a/[drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=94c9100b600f05a36b33f9ed76dbd6fb0eb25386)+++ b/[drivers/net/wireless/realtek/rtlwifi/efuse.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/realtek/rtlwifi/efuse.c?id=ac064c656f105b9122bc43991a170f95f72b7a43)@@ -162,10 +162,19 @@ void efuse\_write\_1byte(struct ieee80211\_hw \*hw, u16 address, u8 value) void read\_efuse\_byte(struct ieee80211\_hw \*hw, u16 \_offset, u8 \*pbuf) { struct rtl\_priv \*rtlpriv = rtl\_priv(hw);+ u16 max\_attempts = 10000; u32 value32; u8 readbyte; u16 retry; + /\*+ \* In case of USB devices, transfer speeds are limited, hence+ \* efuse I/O reads could be (way) slower. So, decrease (a lot)+ \* the read attempts in case of failures.+ \*/+ if (rtlpriv->rtlhal.interface == INTF\_USB)+ max\_attempts = 10;+ rtl\_write\_byte(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL] + 1, (\_offset & 0xff)); readbyte = rtl\_read\_byte(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL] + 2);@@ -178,7 +187,7 @@ void read\_efuse\_byte(struct ieee80211\_hw \*hw, u16 \_offset, u8 \*pbuf)  retry = 0; value32 = rtl\_read\_dword(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL]);- while (!(((value32 >> 24) & 0xff) & 0x80) && (retry < 10000)) {+ while (!(((value32 >> 24) & 0xff) & 0x80) && (retry < max\_attempts)) { value32 = rtl\_read\_dword(rtlpriv, rtlpriv->cfg->maps[EFUSE\_CTRL]); retry++; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:15:52 +0000


