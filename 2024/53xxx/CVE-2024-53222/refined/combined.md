=== Content from git.kernel.org_85e7e2d6_20250114_203329.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f364cdeb38938f9d03061682b8ff3779dd1730e5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f364cdeb38938f9d03061682b8ff3779dd1730e5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f364cdeb38938f9d03061682b8ff3779dd1730e5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f364cdeb38938f9d03061682b8ff3779dd1730e5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liu Shixin <liushixin2@huawei.com> | 2024-11-08 18:01:47 +0800 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-11-14 22:49:19 -0800 |
| commit | [f364cdeb38938f9d03061682b8ff3779dd1730e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f364cdeb38938f9d03061682b8ff3779dd1730e5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f364cdeb38938f9d03061682b8ff3779dd1730e5)) | |
| tree | [9c310da65cc8689634b5d3ed15fb3a96a7d2b233](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f364cdeb38938f9d03061682b8ff3779dd1730e5) | |
| parent | [05d4532b60e3e6e2a094ec56a88d1def50bd2430](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05d4532b60e3e6e2a094ec56a88d1def50bd2430) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f364cdeb38938f9d03061682b8ff3779dd1730e5&id2=05d4532b60e3e6e2a094ec56a88d1def50bd2430)) | |
| download | [linux-f364cdeb38938f9d03061682b8ff3779dd1730e5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f364cdeb38938f9d03061682b8ff3779dd1730e5.tar.gz) | |

zram: fix NULL pointer in comp\_algorithm\_show()LTP reported a NULL pointer dereference as followed:
CPU: 7 UID: 0 PID: 5995 Comm: cat Kdump: loaded Not tainted 6.12.0-rc6+ #3
Hardware name: QEMU KVM Virtual Machine, BIOS 0.0.0 02/06/2015
pstate: 40400005 (nZcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : \_\_pi\_strcmp+0x24/0x140
lr : zcomp\_available\_show+0x60/0x100 [zram]
sp : ffff800088b93b90
x29: ffff800088b93b90 x28: 0000000000000001 x27: 0000000000400cc0
x26: 0000000000000ffe x25: ffff80007b3e2388 x24: 0000000000000000
x23: ffff80007b3e2390 x22: ffff0004041a9000 x21: ffff80007b3e2900
x20: 0000000000000000 x19: 0000000000000000 x18: 0000000000000000
x17: 0000000000000000 x16: 0000000000000000 x15: 0000000000000000
x14: 0000000000000000 x13: 0000000000000000 x12: 0000000000000000
x11: 0000000000000000 x10: ffff80007b3e2900 x9 : ffff80007b3cb280
x8 : 0101010101010101 x7 : 0000000000000000 x6 : 0000000000000000
x5 : 0000000000000040 x4 : 0000000000000000 x3 : 00656c722d6f7a6c
x2 : 0000000000000000 x1 : ffff80007b3e2900 x0 : 0000000000000000
Call trace:
\_\_pi\_strcmp+0x24/0x140
comp\_algorithm\_show+0x40/0x70 [zram]
dev\_attr\_show+0x28/0x80
sysfs\_kf\_seq\_show+0x90/0x140
kernfs\_seq\_show+0x34/0x48
seq\_read\_iter+0x1d4/0x4e8
kernfs\_fop\_read\_iter+0x40/0x58
new\_sync\_read+0x9c/0x168
vfs\_read+0x1a8/0x1f8
ksys\_read+0x74/0x108
\_\_arm64\_sys\_read+0x24/0x38
invoke\_syscall+0x50/0x120
el0\_svc\_common.constprop.0+0xc8/0xf0
do\_el0\_svc+0x24/0x38
el0\_svc+0x38/0x138
el0t\_64\_sync\_handler+0xc0/0xc8
el0t\_64\_sync+0x188/0x190
The zram->comp\_algs[ZRAM\_PRIMARY\_COMP] can be NULL in zram\_add() if
comp\_algorithm\_set() has not been called. User can access the zram device
by sysfs after device\_add\_disk(), so there is a time window to trigger the
NULL pointer dereference. Move it ahead device\_add\_disk() to make sure
when user can access the zram device, it is ready. comp\_algorithm\_set()
is protected by zram->init\_lock in other places and no such problem.
Link: [https://lkml.kernel.org/r/20241108100147.3776123-1-liushixin2@huawei.com](https://lkml.kernel.org/r/20241108100147.3776123-1-liushixin2%40huawei.com)
Fixes: 7ac07a26dea7 ("zram: preparation for multi-zcomp support")
Signed-off-by: Liu Shixin <liushixin2@huawei.com>
Reviewed-by: Sergey Senozhatsky <senozhatsky@chromium.org>
Cc: Jens Axboe <axboe@kernel.dk>
Cc: Minchan Kim <minchan@kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f364cdeb38938f9d03061682b8ff3779dd1730e5)

| -rw-r--r-- | [drivers/block/zram/zram\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/zram/zram_drv.c?id=f364cdeb38938f9d03061682b8ff3779dd1730e5) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 3 deletions

| diff --git a/drivers/block/zram/zram\_drv.c b/drivers/block/zram/zram\_drv.cindex cee49bb0126d90..3dee026988dc8b 100644--- a/[drivers/block/zram/zram\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/zram/zram_drv.c?id=05d4532b60e3e6e2a094ec56a88d1def50bd2430)+++ b/[drivers/block/zram/zram\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/zram/zram_drv.c?id=f364cdeb38938f9d03061682b8ff3779dd1730e5)@@ -2572,6 +2572,8 @@ static int zram\_add(void) zram->disk->private\_data = zram; snprintf(zram->disk->disk\_name, 16, "zram%d", device\_id); atomic\_set(&zram->pp\_in\_progress, 0);+ zram\_comp\_params\_reset(zram);+ comp\_algorithm\_set(zram, ZRAM\_PRIMARY\_COMP, default\_compressor);  /\* Actual capacity set using sysfs (/sys/block/zram<id>/disksize \*/ set\_capacity(zram->disk, 0);@@ -2579,9 +2581,6 @@ static int zram\_add(void) if (ret) goto out\_cleanup\_disk; - zram\_comp\_params\_reset(zram);- comp\_algorithm\_set(zram, ZRAM\_PRIMARY\_COMP, default\_compressor);- zram\_debugfs\_register(zram); pr\_info("Added device: %s\n", zram->disk->disk\_name); return device\_id; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:32:06 +0000



=== Content from git.kernel.org_78babe65_20250114_203328.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=843d366ff19708668d95cda16bb8aba109a93dba)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=843d366ff19708668d95cda16bb8aba109a93dba)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=843d366ff19708668d95cda16bb8aba109a93dba)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=843d366ff19708668d95cda16bb8aba109a93dba)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liu Shixin <liushixin2@huawei.com> | 2024-11-08 18:01:47 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:16 +0100 |
| commit | [843d366ff19708668d95cda16bb8aba109a93dba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=843d366ff19708668d95cda16bb8aba109a93dba) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=843d366ff19708668d95cda16bb8aba109a93dba)) | |
| tree | [289e628cf40a906f3f865f63a56d6f9fb7738df8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=843d366ff19708668d95cda16bb8aba109a93dba) | |
| parent | [68b4cf88d4649b100671a26dca76b6b4b297c9c4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68b4cf88d4649b100671a26dca76b6b4b297c9c4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=843d366ff19708668d95cda16bb8aba109a93dba&id2=68b4cf88d4649b100671a26dca76b6b4b297c9c4)) | |
| download | [linux-843d366ff19708668d95cda16bb8aba109a93dba.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-843d366ff19708668d95cda16bb8aba109a93dba.tar.gz) | |

zram: fix NULL pointer in comp\_algorithm\_show()[ Upstream commit f364cdeb38938f9d03061682b8ff3779dd1730e5 ]
LTP reported a NULL pointer dereference as followed:
CPU: 7 UID: 0 PID: 5995 Comm: cat Kdump: loaded Not tainted 6.12.0-rc6+ #3
Hardware name: QEMU KVM Virtual Machine, BIOS 0.0.0 02/06/2015
pstate: 40400005 (nZcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : \_\_pi\_strcmp+0x24/0x140
lr : zcomp\_available\_show+0x60/0x100 [zram]
sp : ffff800088b93b90
x29: ffff800088b93b90 x28: 0000000000000001 x27: 0000000000400cc0
x26: 0000000000000ffe x25: ffff80007b3e2388 x24: 0000000000000000
x23: ffff80007b3e2390 x22: ffff0004041a9000 x21: ffff80007b3e2900
x20: 0000000000000000 x19: 0000000000000000 x18: 0000000000000000
x17: 0000000000000000 x16: 0000000000000000 x15: 0000000000000000
x14: 0000000000000000 x13: 0000000000000000 x12: 0000000000000000
x11: 0000000000000000 x10: ffff80007b3e2900 x9 : ffff80007b3cb280
x8 : 0101010101010101 x7 : 0000000000000000 x6 : 0000000000000000
x5 : 0000000000000040 x4 : 0000000000000000 x3 : 00656c722d6f7a6c
x2 : 0000000000000000 x1 : ffff80007b3e2900 x0 : 0000000000000000
Call trace:
\_\_pi\_strcmp+0x24/0x140
comp\_algorithm\_show+0x40/0x70 [zram]
dev\_attr\_show+0x28/0x80
sysfs\_kf\_seq\_show+0x90/0x140
kernfs\_seq\_show+0x34/0x48
seq\_read\_iter+0x1d4/0x4e8
kernfs\_fop\_read\_iter+0x40/0x58
new\_sync\_read+0x9c/0x168
vfs\_read+0x1a8/0x1f8
ksys\_read+0x74/0x108
\_\_arm64\_sys\_read+0x24/0x38
invoke\_syscall+0x50/0x120
el0\_svc\_common.constprop.0+0xc8/0xf0
do\_el0\_svc+0x24/0x38
el0\_svc+0x38/0x138
el0t\_64\_sync\_handler+0xc0/0xc8
el0t\_64\_sync+0x188/0x190
The zram->comp\_algs[ZRAM\_PRIMARY\_COMP] can be NULL in zram\_add() if
comp\_algorithm\_set() has not been called. User can access the zram device
by sysfs after device\_add\_disk(), so there is a time window to trigger the
NULL pointer dereference. Move it ahead device\_add\_disk() to make sure
when user can access the zram device, it is ready. comp\_algorithm\_set()
is protected by zram->init\_lock in other places and no such problem.
Link: [https://lkml.kernel.org/r/20241108100147.3776123-1-liushixin2@huawei.com](https://lkml.kernel.org/r/20241108100147.3776123-1-liushixin2%40huawei.com)
Fixes: 7ac07a26dea7 ("zram: preparation for multi-zcomp support")
Signed-off-by: Liu Shixin <liushixin2@huawei.com>
Reviewed-by: Sergey Senozhatsky <senozhatsky@chromium.org>
Cc: Jens Axboe <axboe@kernel.dk>
Cc: Minchan Kim <minchan@kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=843d366ff19708668d95cda16bb8aba109a93dba)

| -rw-r--r-- | [drivers/block/zram/zram\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/zram/zram_drv.c?id=843d366ff19708668d95cda16bb8aba109a93dba) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 3 deletions

| diff --git a/drivers/block/zram/zram\_drv.c b/drivers/block/zram/zram\_drv.cindex b742dc246b0c18..e682797cdee783 100644--- a/[drivers/block/zram/zram\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/zram/zram_drv.c?id=68b4cf88d4649b100671a26dca76b6b4b297c9c4)+++ b/[drivers/block/zram/zram\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/zram/zram_drv.c?id=843d366ff19708668d95cda16bb8aba109a93dba)@@ -2397,6 +2397,8 @@ static int zram\_add(void) zram->disk->private\_data = zram; snprintf(zram->disk->disk\_name, 16, "zram%d", device\_id); atomic\_set(&zram->pp\_in\_progress, 0);+ zram\_comp\_params\_reset(zram);+ comp\_algorithm\_set(zram, ZRAM\_PRIMARY\_COMP, default\_compressor);  /\* Actual capacity set using sysfs (/sys/block/zram<id>/disksize \*/ set\_capacity(zram->disk, 0);@@ -2404,9 +2406,6 @@ static int zram\_add(void) if (ret) goto out\_cleanup\_disk; - zram\_comp\_params\_reset(zram);- comp\_algorithm\_set(zram, ZRAM\_PRIMARY\_COMP, default\_compressor);- zram\_debugfs\_register(zram); pr\_info("Added device: %s\n", zram->disk->disk\_name); return device\_id; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:32:05 +0000


