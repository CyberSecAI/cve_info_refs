=== Content from git.kernel.org_ca5656db_20250114_192000.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Arkadiusz Kubalewski <arkadiusz.kubalewski@intel.com> | 2024-10-21 16:26:26 -0700 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-10-29 15:24:53 +0100 |
| commit | [6e58c33106220c6c0c8fbee9ab63eae76ad8f260](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260)) | |
| tree | [fac41ec6714078d03ce2ea19e6ca2538a999d8c1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260) | |
| parent | [3e13a8c0a5263827380c5090d822a92cb13767dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e13a8c0a5263827380c5090d822a92cb13767dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260&id2=3e13a8c0a5263827380c5090d822a92cb13767dd)) | |
| download | [linux-6e58c33106220c6c0c8fbee9ab63eae76ad8f260.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6e58c33106220c6c0c8fbee9ab63eae76ad8f260.tar.gz) | |

ice: fix crash on probe for DPLL enabled E810 LOMThe E810 Lan On Motherboard (LOM) design is vendor specific. Intel
provides the reference design, but it is up to vendor on the final
product design. For some cases, like Linux DPLL support, the static
values defined in the driver does not reflect the actual LOM design.
Current implementation of dpll pins is causing the crash on probe
of the ice driver for such DPLL enabled E810 LOM designs:
WARNING: (...) at drivers/dpll/dpll\_core.c:495 dpll\_pin\_get+0x2c4/0x330
...
Call Trace:
<TASK>
? \_\_warn+0x83/0x130
? dpll\_pin\_get+0x2c4/0x330
? report\_bug+0x1b7/0x1d0
? handle\_bug+0x42/0x70
? exc\_invalid\_op+0x18/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? dpll\_pin\_get+0x117/0x330
? dpll\_pin\_get+0x2c4/0x330
? dpll\_pin\_get+0x117/0x330
ice\_dpll\_get\_pins.isra.0+0x52/0xe0 [ice]
...
The number of dpll pins enabled by LOM vendor is greater than expected
and defined in the driver for Intel designed NICs, which causes the crash.
Prevent the crash and allow generic pin initialization within Linux DPLL
subsystem for DPLL enabled E810 LOM designs.
Newly designed solution for described issue will be based on "per HW
design" pin initialization. It requires pin information dynamically
acquired from the firmware and is already in progress, planned for
next-tree only.
Fixes: d7999f5ea64b ("ice: implement dpll interface to control cgu")
Reviewed-by: Karol Kolacinski <karol.kolacinski@intel.com>
Signed-off-by: Arkadiusz Kubalewski <arkadiusz.kubalewski@intel.com>
Tested-by: Pucha Himasekhar Reddy <himasekharx.reddy.pucha@intel.com>
Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_dpll.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_dpll.c?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260) | 70 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ptp\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ptp_hw.c?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260) | 21 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ptp\_hw.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ptp_hw.h?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260) | 1 | |  |  |  | | --- | --- | --- | |

3 files changed, 90 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_dpll.c b/drivers/net/ethernet/intel/ice/ice\_dpll.cindex 74c0e7319a4cac..d5ad6d84007c21 100644--- a/[drivers/net/ethernet/intel/ice/ice\_dpll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_dpll.c?id=3e13a8c0a5263827380c5090d822a92cb13767dd)+++ b/[drivers/net/ethernet/intel/ice/ice\_dpll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_dpll.c?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260)@@ -10,6 +10,7 @@ #define ICE\_DPLL\_PIN\_IDX\_INVALID 0xff #define ICE\_DPLL\_RCLK\_NUM\_PER\_PF 1 #define ICE\_DPLL\_PIN\_ESYNC\_PULSE\_HIGH\_PERCENT 25+#define ICE\_DPLL\_PIN\_GEN\_RCLK\_FREQ 1953125  /\*\* \* enum ice\_dpll\_pin\_type - enumerate ice pin types:@@ -2064,6 +2065,73 @@ static int ice\_dpll\_init\_worker(struct ice\_pf \*pf) }  /\*\*+ \* ice\_dpll\_init\_info\_pins\_generic - initializes generic pins info+ \* @pf: board private structure+ \* @input: if input pins initialized+ \*+ \* Init information for generic pins, cache them in PF's pins structures.+ \*+ \* Return:+ \* \* 0 - success+ \* \* negative - init failure reason+ \*/+static int ice\_dpll\_init\_info\_pins\_generic(struct ice\_pf \*pf, bool input)+{+ struct ice\_dpll \*de = &pf->dplls.eec, \*dp = &pf->dplls.pps;+ static const char labels[][sizeof("99")] = {+ "0", "1", "2", "3", "4", "5", "6", "7", "8",+ "9", "10", "11", "12", "13", "14", "15" };+ u32 cap = DPLL\_PIN\_CAPABILITIES\_STATE\_CAN\_CHANGE;+ enum ice\_dpll\_pin\_type pin\_type;+ int i, pin\_num, ret = -EINVAL;+ struct ice\_dpll\_pin \*pins;+ u32 phase\_adj\_max;++ if (input) {+ pin\_num = pf->dplls.num\_inputs;+ pins = pf->dplls.inputs;+ phase\_adj\_max = pf->dplls.input\_phase\_adj\_max;+ pin\_type = ICE\_DPLL\_PIN\_TYPE\_INPUT;+ cap |= DPLL\_PIN\_CAPABILITIES\_PRIORITY\_CAN\_CHANGE;+ } else {+ pin\_num = pf->dplls.num\_outputs;+ pins = pf->dplls.outputs;+ phase\_adj\_max = pf->dplls.output\_phase\_adj\_max;+ pin\_type = ICE\_DPLL\_PIN\_TYPE\_OUTPUT;+ }+ if (pin\_num > ARRAY\_SIZE(labels))+ return ret;++ for (i = 0; i < pin\_num; i++) {+ pins[i].idx = i;+ pins[i].prop.board\_label = labels[i];+ pins[i].prop.phase\_range.min = phase\_adj\_max;+ pins[i].prop.phase\_range.max = -phase\_adj\_max;+ pins[i].prop.capabilities = cap;+ pins[i].pf = pf;+ ret = ice\_dpll\_pin\_state\_update(pf, &pins[i], pin\_type, NULL);+ if (ret)+ break;+ if (input && pins[i].freq == ICE\_DPLL\_PIN\_GEN\_RCLK\_FREQ)+ pins[i].prop.type = DPLL\_PIN\_TYPE\_MUX;+ else+ pins[i].prop.type = DPLL\_PIN\_TYPE\_EXT;+ if (!input)+ continue;+ ret = ice\_aq\_get\_cgu\_ref\_prio(&pf->hw, de->dpll\_idx, i,+ &de->input\_prio[i]);+ if (ret)+ break;+ ret = ice\_aq\_get\_cgu\_ref\_prio(&pf->hw, dp->dpll\_idx, i,+ &dp->input\_prio[i]);+ if (ret)+ break;+ }++ return ret;+}++/\*\* \* ice\_dpll\_init\_info\_direct\_pins - initializes direct pins info \* @pf: board private structure \* @pin\_type: type of pins being initialized@@ -2101,6 +2169,8 @@ ice\_dpll\_init\_info\_direct\_pins(struct ice\_pf \*pf, default: return -EINVAL; }+ if (num\_pins != ice\_cgu\_get\_num\_pins(hw, input))+ return ice\_dpll\_init\_info\_pins\_generic(pf, input);  for (i = 0; i < num\_pins; i++) { caps = 0;diff --git a/drivers/net/ethernet/intel/ice/ice\_ptp\_hw.c b/drivers/net/ethernet/intel/ice/ice\_ptp\_hw.cindex 3a33e6b9b313d7..ec8db830ac73ae 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ptp\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp_hw.c?id=3e13a8c0a5263827380c5090d822a92cb13767dd)+++ b/[drivers/net/ethernet/intel/ice/ice\_ptp\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp_hw.c?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260)@@ -34,7 +34,6 @@ static const struct ice\_cgu\_pin\_desc ice\_e810t\_sfp\_cgu\_inputs[] = { ARRAY\_SIZE(ice\_cgu\_pin\_freq\_common), ice\_cgu\_pin\_freq\_common }, { "GNSS-1PPS", ZL\_REF4P, DPLL\_PIN\_TYPE\_GNSS, ARRAY\_SIZE(ice\_cgu\_pin\_freq\_1\_hz), ice\_cgu\_pin\_freq\_1\_hz },- { "OCXO", ZL\_REF4N, DPLL\_PIN\_TYPE\_INT\_OSCILLATOR, 0, }, };  static const struct ice\_cgu\_pin\_desc ice\_e810t\_qsfp\_cgu\_inputs[] = {@@ -52,7 +51,6 @@ static const struct ice\_cgu\_pin\_desc ice\_e810t\_qsfp\_cgu\_inputs[] = { ARRAY\_SIZE(ice\_cgu\_pin\_freq\_common), ice\_cgu\_pin\_freq\_common }, { "GNSS-1PPS", ZL\_REF4P, DPLL\_PIN\_TYPE\_GNSS, ARRAY\_SIZE(ice\_cgu\_pin\_freq\_1\_hz), ice\_cgu\_pin\_freq\_1\_hz },- { "OCXO", ZL\_REF4N, DPLL\_PIN\_TYPE\_INT\_OSCILLATOR, }, };  static const struct ice\_cgu\_pin\_desc ice\_e810t\_sfp\_cgu\_outputs[] = {@@ -5965,6 +5963,25 @@ ice\_cgu\_get\_pin\_desc(struct ice\_hw \*hw, bool input, int \*size) }  /\*\*+ \* ice\_cgu\_get\_num\_pins - get pin description array size+ \* @hw: pointer to the hw struct+ \* @input: if request is done against input or output pins+ \*+ \* Return: size of pin description array for given hw.+ \*/+int ice\_cgu\_get\_num\_pins(struct ice\_hw \*hw, bool input)+{+ const struct ice\_cgu\_pin\_desc \*t;+ int size;++ t = ice\_cgu\_get\_pin\_desc(hw, input, &size);+ if (t)+ return size;++ return 0;+}++/\*\* \* ice\_cgu\_get\_pin\_type - get pin's type \* @hw: pointer to the hw struct \* @pin: pin indexdiff --git a/drivers/net/ethernet/intel/ice/ice\_ptp\_hw.h b/drivers/net/ethernet/intel/ice/ice\_ptp\_hw.hindex 0852a34ade918b..6cedc1a906afb6 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ptp\_hw.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp_hw.h?id=3e13a8c0a5263827380c5090d822a92cb13767dd)+++ b/[drivers/net/ethernet/intel/ice/ice\_ptp\_hw.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp_hw.h?id=6e58c33106220c6c0c8fbee9ab63eae76ad8f260)@@ -404,6 +404,7 @@ int ice\_read\_sma\_ctrl\_e810t(struct ice\_hw \*hw, u8 \*data); int ice\_write\_sma\_ctrl\_e810t(struct ice\_hw \*hw, u8 data); int ice\_read\_pca9575\_reg\_e810t(struct ice\_hw \*hw, u8 offset, u8 \*data); bool ice\_is\_pca9575\_present(struct ice\_hw \*hw);+int ice\_cgu\_get\_num\_pins(struct ice\_hw \*hw, bool input); enum dpll\_pin\_type ice\_cgu\_get\_pin\_type(struct ice\_hw \*hw, u8 pin, bool input); struct dpll\_pin\_frequency \* ice\_cgu\_get\_pin\_freq\_supp(struct ice\_hw \*hw, u8 pin, bool input, u8 \*num); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:18:37 +0000



=== Content from git.kernel.org_07490b2c_20250114_192001.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=82b107a27bab29146e159b6b9f21146c97c45a53)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=82b107a27bab29146e159b6b9f21146c97c45a53)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82b107a27bab29146e159b6b9f21146c97c45a53)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82b107a27bab29146e159b6b9f21146c97c45a53)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Arkadiusz Kubalewski <arkadiusz.kubalewski@intel.com> | 2024-10-21 16:26:26 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:47 +0100 |
| commit | [82b107a27bab29146e159b6b9f21146c97c45a53](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82b107a27bab29146e159b6b9f21146c97c45a53) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=82b107a27bab29146e159b6b9f21146c97c45a53)) | |
| tree | [5ee0d9605569f50ebfb3a5ede8f41ca1619c9824](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=82b107a27bab29146e159b6b9f21146c97c45a53) | |
| parent | [61b6c0eda832a265eed798ba9499807e71b16c70](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61b6c0eda832a265eed798ba9499807e71b16c70) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82b107a27bab29146e159b6b9f21146c97c45a53&id2=61b6c0eda832a265eed798ba9499807e71b16c70)) | |
| download | [linux-82b107a27bab29146e159b6b9f21146c97c45a53.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-82b107a27bab29146e159b6b9f21146c97c45a53.tar.gz) | |

ice: fix crash on probe for DPLL enabled E810 LOM[ Upstream commit 6e58c33106220c6c0c8fbee9ab63eae76ad8f260 ]
The E810 Lan On Motherboard (LOM) design is vendor specific. Intel
provides the reference design, but it is up to vendor on the final
product design. For some cases, like Linux DPLL support, the static
values defined in the driver does not reflect the actual LOM design.
Current implementation of dpll pins is causing the crash on probe
of the ice driver for such DPLL enabled E810 LOM designs:
WARNING: (...) at drivers/dpll/dpll\_core.c:495 dpll\_pin\_get+0x2c4/0x330
...
Call Trace:
<TASK>
? \_\_warn+0x83/0x130
? dpll\_pin\_get+0x2c4/0x330
? report\_bug+0x1b7/0x1d0
? handle\_bug+0x42/0x70
? exc\_invalid\_op+0x18/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? dpll\_pin\_get+0x117/0x330
? dpll\_pin\_get+0x2c4/0x330
? dpll\_pin\_get+0x117/0x330
ice\_dpll\_get\_pins.isra.0+0x52/0xe0 [ice]
...
The number of dpll pins enabled by LOM vendor is greater than expected
and defined in the driver for Intel designed NICs, which causes the crash.
Prevent the crash and allow generic pin initialization within Linux DPLL
subsystem for DPLL enabled E810 LOM designs.
Newly designed solution for described issue will be based on "per HW
design" pin initialization. It requires pin information dynamically
acquired from the firmware and is already in progress, planned for
next-tree only.
Fixes: d7999f5ea64b ("ice: implement dpll interface to control cgu")
Reviewed-by: Karol Kolacinski <karol.kolacinski@intel.com>
Signed-off-by: Arkadiusz Kubalewski <arkadiusz.kubalewski@intel.com>
Tested-by: Pucha Himasekhar Reddy <himasekharx.reddy.pucha@intel.com>
Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=82b107a27bab29146e159b6b9f21146c97c45a53)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_dpll.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_dpll.c?id=82b107a27bab29146e159b6b9f21146c97c45a53) | 70 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ptp\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ptp_hw.c?id=82b107a27bab29146e159b6b9f21146c97c45a53) | 21 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ptp\_hw.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ptp_hw.h?id=82b107a27bab29146e159b6b9f21146c97c45a53) | 1 | |  |  |  | | --- | --- | --- | |

3 files changed, 90 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_dpll.c b/drivers/net/ethernet/intel/ice/ice\_dpll.cindex 74c0e7319a4cac..d5ad6d84007c21 100644--- a/[drivers/net/ethernet/intel/ice/ice\_dpll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_dpll.c?id=61b6c0eda832a265eed798ba9499807e71b16c70)+++ b/[drivers/net/ethernet/intel/ice/ice\_dpll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_dpll.c?id=82b107a27bab29146e159b6b9f21146c97c45a53)@@ -10,6 +10,7 @@ #define ICE\_DPLL\_PIN\_IDX\_INVALID 0xff #define ICE\_DPLL\_RCLK\_NUM\_PER\_PF 1 #define ICE\_DPLL\_PIN\_ESYNC\_PULSE\_HIGH\_PERCENT 25+#define ICE\_DPLL\_PIN\_GEN\_RCLK\_FREQ 1953125  /\*\* \* enum ice\_dpll\_pin\_type - enumerate ice pin types:@@ -2064,6 +2065,73 @@ static int ice\_dpll\_init\_worker(struct ice\_pf \*pf) }  /\*\*+ \* ice\_dpll\_init\_info\_pins\_generic - initializes generic pins info+ \* @pf: board private structure+ \* @input: if input pins initialized+ \*+ \* Init information for generic pins, cache them in PF's pins structures.+ \*+ \* Return:+ \* \* 0 - success+ \* \* negative - init failure reason+ \*/+static int ice\_dpll\_init\_info\_pins\_generic(struct ice\_pf \*pf, bool input)+{+ struct ice\_dpll \*de = &pf->dplls.eec, \*dp = &pf->dplls.pps;+ static const char labels[][sizeof("99")] = {+ "0", "1", "2", "3", "4", "5", "6", "7", "8",+ "9", "10", "11", "12", "13", "14", "15" };+ u32 cap = DPLL\_PIN\_CAPABILITIES\_STATE\_CAN\_CHANGE;+ enum ice\_dpll\_pin\_type pin\_type;+ int i, pin\_num, ret = -EINVAL;+ struct ice\_dpll\_pin \*pins;+ u32 phase\_adj\_max;++ if (input) {+ pin\_num = pf->dplls.num\_inputs;+ pins = pf->dplls.inputs;+ phase\_adj\_max = pf->dplls.input\_phase\_adj\_max;+ pin\_type = ICE\_DPLL\_PIN\_TYPE\_INPUT;+ cap |= DPLL\_PIN\_CAPABILITIES\_PRIORITY\_CAN\_CHANGE;+ } else {+ pin\_num = pf->dplls.num\_outputs;+ pins = pf->dplls.outputs;+ phase\_adj\_max = pf->dplls.output\_phase\_adj\_max;+ pin\_type = ICE\_DPLL\_PIN\_TYPE\_OUTPUT;+ }+ if (pin\_num > ARRAY\_SIZE(labels))+ return ret;++ for (i = 0; i < pin\_num; i++) {+ pins[i].idx = i;+ pins[i].prop.board\_label = labels[i];+ pins[i].prop.phase\_range.min = phase\_adj\_max;+ pins[i].prop.phase\_range.max = -phase\_adj\_max;+ pins[i].prop.capabilities = cap;+ pins[i].pf = pf;+ ret = ice\_dpll\_pin\_state\_update(pf, &pins[i], pin\_type, NULL);+ if (ret)+ break;+ if (input && pins[i].freq == ICE\_DPLL\_PIN\_GEN\_RCLK\_FREQ)+ pins[i].prop.type = DPLL\_PIN\_TYPE\_MUX;+ else+ pins[i].prop.type = DPLL\_PIN\_TYPE\_EXT;+ if (!input)+ continue;+ ret = ice\_aq\_get\_cgu\_ref\_prio(&pf->hw, de->dpll\_idx, i,+ &de->input\_prio[i]);+ if (ret)+ break;+ ret = ice\_aq\_get\_cgu\_ref\_prio(&pf->hw, dp->dpll\_idx, i,+ &dp->input\_prio[i]);+ if (ret)+ break;+ }++ return ret;+}++/\*\* \* ice\_dpll\_init\_info\_direct\_pins - initializes direct pins info \* @pf: board private structure \* @pin\_type: type of pins being initialized@@ -2101,6 +2169,8 @@ ice\_dpll\_init\_info\_direct\_pins(struct ice\_pf \*pf, default: return -EINVAL; }+ if (num\_pins != ice\_cgu\_get\_num\_pins(hw, input))+ return ice\_dpll\_init\_info\_pins\_generic(pf, input);  for (i = 0; i < num\_pins; i++) { caps = 0;diff --git a/drivers/net/ethernet/intel/ice/ice\_ptp\_hw.c b/drivers/net/ethernet/intel/ice/ice\_ptp\_hw.cindex 3a33e6b9b313d7..ec8db830ac73ae 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ptp\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp_hw.c?id=61b6c0eda832a265eed798ba9499807e71b16c70)+++ b/[drivers/net/ethernet/intel/ice/ice\_ptp\_hw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp_hw.c?id=82b107a27bab29146e159b6b9f21146c97c45a53)@@ -34,7 +34,6 @@ static const struct ice\_cgu\_pin\_desc ice\_e810t\_sfp\_cgu\_inputs[] = { ARRAY\_SIZE(ice\_cgu\_pin\_freq\_common), ice\_cgu\_pin\_freq\_common }, { "GNSS-1PPS", ZL\_REF4P, DPLL\_PIN\_TYPE\_GNSS, ARRAY\_SIZE(ice\_cgu\_pin\_freq\_1\_hz), ice\_cgu\_pin\_freq\_1\_hz },- { "OCXO", ZL\_REF4N, DPLL\_PIN\_TYPE\_INT\_OSCILLATOR, 0, }, };  static const struct ice\_cgu\_pin\_desc ice\_e810t\_qsfp\_cgu\_inputs[] = {@@ -52,7 +51,6 @@ static const struct ice\_cgu\_pin\_desc ice\_e810t\_qsfp\_cgu\_inputs[] = { ARRAY\_SIZE(ice\_cgu\_pin\_freq\_common), ice\_cgu\_pin\_freq\_common }, { "GNSS-1PPS", ZL\_REF4P, DPLL\_PIN\_TYPE\_GNSS, ARRAY\_SIZE(ice\_cgu\_pin\_freq\_1\_hz), ice\_cgu\_pin\_freq\_1\_hz },- { "OCXO", ZL\_REF4N, DPLL\_PIN\_TYPE\_INT\_OSCILLATOR, }, };  static const struct ice\_cgu\_pin\_desc ice\_e810t\_sfp\_cgu\_outputs[] = {@@ -5965,6 +5963,25 @@ ice\_cgu\_get\_pin\_desc(struct ice\_hw \*hw, bool input, int \*size) }  /\*\*+ \* ice\_cgu\_get\_num\_pins - get pin description array size+ \* @hw: pointer to the hw struct+ \* @input: if request is done against input or output pins+ \*+ \* Return: size of pin description array for given hw.+ \*/+int ice\_cgu\_get\_num\_pins(struct ice\_hw \*hw, bool input)+{+ const struct ice\_cgu\_pin\_desc \*t;+ int size;++ t = ice\_cgu\_get\_pin\_desc(hw, input, &size);+ if (t)+ return size;++ return 0;+}++/\*\* \* ice\_cgu\_get\_pin\_type - get pin's type \* @hw: pointer to the hw struct \* @pin: pin indexdiff --git a/drivers/net/ethernet/intel/ice/ice\_ptp\_hw.h b/drivers/net/ethernet/intel/ice/ice\_ptp\_hw.hindex 0852a34ade918b..6cedc1a906afb6 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ptp\_hw.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp_hw.h?id=61b6c0eda832a265eed798ba9499807e71b16c70)+++ b/[drivers/net/ethernet/intel/ice/ice\_ptp\_hw.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ptp_hw.h?id=82b107a27bab29146e159b6b9f21146c97c45a53)@@ -404,6 +404,7 @@ int ice\_read\_sma\_ctrl\_e810t(struct ice\_hw \*hw, u8 \*data); int ice\_write\_sma\_ctrl\_e810t(struct ice\_hw \*hw, u8 data); int ice\_read\_pca9575\_reg\_e810t(struct ice\_hw \*hw, u8 offset, u8 \*data); bool ice\_is\_pca9575\_present(struct ice\_hw \*hw);+int ice\_cgu\_get\_num\_pins(struct ice\_hw \*hw, bool input); enum dpll\_pin\_type ice\_cgu\_get\_pin\_type(struct ice\_hw \*hw, u8 pin, bool input); struct dpll\_pin\_frequency \* ice\_cgu\_get\_pin\_freq\_supp(struct ice\_hw \*hw, u8 pin, bool input, u8 \*num); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:18:38 +0000


