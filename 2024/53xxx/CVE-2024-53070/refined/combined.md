=== Content from git.kernel.org_b88e5bfc_20250114_183202.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=562804b1561cc248cc37746a1c96c83cab1d7209)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=562804b1561cc248cc37746a1c96c83cab1d7209)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=562804b1561cc248cc37746a1c96c83cab1d7209)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=562804b1561cc248cc37746a1c96c83cab1d7209)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roger Quadros <rogerq@kernel.org> | 2024-11-04 16:00:11 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:15:18 +0100 |
| commit | [562804b1561cc248cc37746a1c96c83cab1d7209](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=562804b1561cc248cc37746a1c96c83cab1d7209) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=562804b1561cc248cc37746a1c96c83cab1d7209)) | |
| tree | [653619c03261cd6a420cd0e56a4996bfedb12b99](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=562804b1561cc248cc37746a1c96c83cab1d7209) | |
| parent | [ccd811c304d2ee56189bfbc49302cb3c44361893](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ccd811c304d2ee56189bfbc49302cb3c44361893) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=562804b1561cc248cc37746a1c96c83cab1d7209&id2=ccd811c304d2ee56189bfbc49302cb3c44361893)) | |
| download | [linux-562804b1561cc248cc37746a1c96c83cab1d7209.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-562804b1561cc248cc37746a1c96c83cab1d7209.tar.gz) | |

usb: dwc3: fix fault at system suspend if device was already runtime suspendedcommit 9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b upstream.
If the device was already runtime suspended then during system suspend
we cannot access the device registers else it will crash.
Also we cannot access any registers after dwc3\_core\_exit() on some
platforms so move the dwc3\_enable\_susphy() call to the top.
Cc: stable@vger.kernel.org # v5.15+
Reported-by: William McVicker <willmcvicker@google.com>
Closes: https://lore.kernel.org/all/ZyVfcUuPq56R2m1Y@google.com
Fixes: 705e3ce37bcc ("usb: dwc3: core: Fix system suspend on TI AM62 platforms")
Signed-off-by: Roger Quadros <rogerq@kernel.org>
Acked-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Tested-by: Will McVicker <willmcvicker@google.com>
Link: [https://lore.kernel.org/r/20241104-am62-lpm-usb-fix-v1-1-e93df73a4f0d@kernel.org](https://lore.kernel.org/r/20241104-am62-lpm-usb-fix-v1-1-e93df73a4f0d%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=562804b1561cc248cc37746a1c96c83cab1d7209)

| -rw-r--r-- | [drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/core.c?id=562804b1561cc248cc37746a1c96c83cab1d7209) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 13 deletions

| diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.cindex 22edd8d451da02..297e6032bdd1a2 100644--- a/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=ccd811c304d2ee56189bfbc49302cb3c44361893)+++ b/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=562804b1561cc248cc37746a1c96c83cab1d7209)@@ -2131,10 +2131,18 @@ static int dwc3\_suspend\_common(struct dwc3 \*dwc, pm\_message\_t msg) { u32 reg; - dwc->susphy\_state = (dwc3\_readl(dwc->regs, DWC3\_GUSB2PHYCFG(0)) &- DWC3\_GUSB2PHYCFG\_SUSPHY) ||- (dwc3\_readl(dwc->regs, DWC3\_GUSB3PIPECTL(0)) &- DWC3\_GUSB3PIPECTL\_SUSPHY);+ if (!pm\_runtime\_suspended(dwc->dev) && !PMSG\_IS\_AUTO(msg)) {+ dwc->susphy\_state = (dwc3\_readl(dwc->regs, DWC3\_GUSB2PHYCFG(0)) &+ DWC3\_GUSB2PHYCFG\_SUSPHY) ||+ (dwc3\_readl(dwc->regs, DWC3\_GUSB3PIPECTL(0)) &+ DWC3\_GUSB3PIPECTL\_SUSPHY);+ /\*+ \* TI AM62 platform requires SUSPHY to be+ \* enabled for system suspend to work.+ \*/+ if (!dwc->susphy\_state)+ dwc3\_enable\_susphy(dwc, true);+ }  switch (dwc->current\_dr\_role) { case DWC3\_GCTL\_PRTCAP\_DEVICE:@@ -2183,15 +2191,6 @@ static int dwc3\_suspend\_common(struct dwc3 \*dwc, pm\_message\_t msg) break; } - if (!PMSG\_IS\_AUTO(msg)) {- /\*- \* TI AM62 platform requires SUSPHY to be- \* enabled for system suspend to work.- \*/- if (!dwc->susphy\_state)- dwc3\_enable\_susphy(dwc, true);- }- return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:30:39 +0000



=== Content from git.kernel.org_98b71a36_20250114_183204.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d9e65d461a9de037e7c9d584776d025cfce6d86d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d9e65d461a9de037e7c9d584776d025cfce6d86d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9e65d461a9de037e7c9d584776d025cfce6d86d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d9e65d461a9de037e7c9d584776d025cfce6d86d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roger Quadros <rogerq@kernel.org> | 2024-11-04 16:00:11 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:13:41 +0100 |
| commit | [d9e65d461a9de037e7c9d584776d025cfce6d86d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9e65d461a9de037e7c9d584776d025cfce6d86d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d9e65d461a9de037e7c9d584776d025cfce6d86d)) | |
| tree | [13401d3ba0a015c36f202afb8582d439252c4416](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d9e65d461a9de037e7c9d584776d025cfce6d86d) | |
| parent | [63559ba8077cbadae1c92a65b73ea522bf377dd9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63559ba8077cbadae1c92a65b73ea522bf377dd9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d9e65d461a9de037e7c9d584776d025cfce6d86d&id2=63559ba8077cbadae1c92a65b73ea522bf377dd9)) | |
| download | [linux-d9e65d461a9de037e7c9d584776d025cfce6d86d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d9e65d461a9de037e7c9d584776d025cfce6d86d.tar.gz) | |

usb: dwc3: fix fault at system suspend if device was already runtime suspendedcommit 9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b upstream.
If the device was already runtime suspended then during system suspend
we cannot access the device registers else it will crash.
Also we cannot access any registers after dwc3\_core\_exit() on some
platforms so move the dwc3\_enable\_susphy() call to the top.
Cc: stable@vger.kernel.org # v5.15+
Reported-by: William McVicker <willmcvicker@google.com>
Closes: https://lore.kernel.org/all/ZyVfcUuPq56R2m1Y@google.com
Fixes: 705e3ce37bcc ("usb: dwc3: core: Fix system suspend on TI AM62 platforms")
Signed-off-by: Roger Quadros <rogerq@kernel.org>
Acked-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Tested-by: Will McVicker <willmcvicker@google.com>
Link: [https://lore.kernel.org/r/20241104-am62-lpm-usb-fix-v1-1-e93df73a4f0d@kernel.org](https://lore.kernel.org/r/20241104-am62-lpm-usb-fix-v1-1-e93df73a4f0d%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d9e65d461a9de037e7c9d584776d025cfce6d86d)

| -rw-r--r-- | [drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/core.c?id=d9e65d461a9de037e7c9d584776d025cfce6d86d) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 13 deletions

| diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.cindex 0ca06a3ab71798..f507f055f523c1 100644--- a/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=63559ba8077cbadae1c92a65b73ea522bf377dd9)+++ b/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=d9e65d461a9de037e7c9d584776d025cfce6d86d)@@ -1796,10 +1796,18 @@ static int dwc3\_suspend\_common(struct dwc3 \*dwc, pm\_message\_t msg) { u32 reg; - dwc->susphy\_state = (dwc3\_readl(dwc->regs, DWC3\_GUSB2PHYCFG(0)) &- DWC3\_GUSB2PHYCFG\_SUSPHY) ||- (dwc3\_readl(dwc->regs, DWC3\_GUSB3PIPECTL(0)) &- DWC3\_GUSB3PIPECTL\_SUSPHY);+ if (!pm\_runtime\_suspended(dwc->dev) && !PMSG\_IS\_AUTO(msg)) {+ dwc->susphy\_state = (dwc3\_readl(dwc->regs, DWC3\_GUSB2PHYCFG(0)) &+ DWC3\_GUSB2PHYCFG\_SUSPHY) ||+ (dwc3\_readl(dwc->regs, DWC3\_GUSB3PIPECTL(0)) &+ DWC3\_GUSB3PIPECTL\_SUSPHY);+ /\*+ \* TI AM62 platform requires SUSPHY to be+ \* enabled for system suspend to work.+ \*/+ if (!dwc->susphy\_state)+ dwc3\_enable\_susphy(dwc, true);+ }  switch (dwc->current\_dr\_role) { case DWC3\_GCTL\_PRTCAP\_DEVICE:@@ -1848,15 +1856,6 @@ static int dwc3\_suspend\_common(struct dwc3 \*dwc, pm\_message\_t msg) break; } - if (!PMSG\_IS\_AUTO(msg)) {- /\*- \* TI AM62 platform requires SUSPHY to be- \* enabled for system suspend to work.- \*/- if (!dwc->susphy\_state)- dwc3\_enable\_susphy(dwc, true);- }- return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:30:41 +0000



=== Content from git.kernel.org_95c0cdb9_20250114_183201.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roger Quadros <rogerq@kernel.org> | 2024-11-04 16:00:11 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:12 +0100 |
| commit | [06b98197b69e2f2af9cb1991ee0b1c876edf7b86](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86)) | |
| tree | [1260e1d174d76bc5bcf606ad144fe872e5debc72](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86) | |
| parent | [b08baa75b989cf779cbfa0969681f8ba2dc46569](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b08baa75b989cf779cbfa0969681f8ba2dc46569) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86&id2=b08baa75b989cf779cbfa0969681f8ba2dc46569)) | |
| download | [linux-06b98197b69e2f2af9cb1991ee0b1c876edf7b86.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-06b98197b69e2f2af9cb1991ee0b1c876edf7b86.tar.gz) | |

usb: dwc3: fix fault at system suspend if device was already runtime suspendedcommit 9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b upstream.
If the device was already runtime suspended then during system suspend
we cannot access the device registers else it will crash.
Also we cannot access any registers after dwc3\_core\_exit() on some
platforms so move the dwc3\_enable\_susphy() call to the top.
Cc: stable@vger.kernel.org # v5.15+
Reported-by: William McVicker <willmcvicker@google.com>
Closes: https://lore.kernel.org/all/ZyVfcUuPq56R2m1Y@google.com
Fixes: 705e3ce37bcc ("usb: dwc3: core: Fix system suspend on TI AM62 platforms")
Signed-off-by: Roger Quadros <rogerq@kernel.org>
Acked-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Tested-by: Will McVicker <willmcvicker@google.com>
Link: [https://lore.kernel.org/r/20241104-am62-lpm-usb-fix-v1-1-e93df73a4f0d@kernel.org](https://lore.kernel.org/r/20241104-am62-lpm-usb-fix-v1-1-e93df73a4f0d%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86)

| -rw-r--r-- | [drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/core.c?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 13 deletions

| diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.cindex 427e5660f87c24..98114c2827c098 100644--- a/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=b08baa75b989cf779cbfa0969681f8ba2dc46569)+++ b/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=06b98197b69e2f2af9cb1991ee0b1c876edf7b86)@@ -2342,10 +2342,18 @@ static int dwc3\_suspend\_common(struct dwc3 \*dwc, pm\_message\_t msg) u32 reg; int i; - dwc->susphy\_state = (dwc3\_readl(dwc->regs, DWC3\_GUSB2PHYCFG(0)) &- DWC3\_GUSB2PHYCFG\_SUSPHY) ||- (dwc3\_readl(dwc->regs, DWC3\_GUSB3PIPECTL(0)) &- DWC3\_GUSB3PIPECTL\_SUSPHY);+ if (!pm\_runtime\_suspended(dwc->dev) && !PMSG\_IS\_AUTO(msg)) {+ dwc->susphy\_state = (dwc3\_readl(dwc->regs, DWC3\_GUSB2PHYCFG(0)) &+ DWC3\_GUSB2PHYCFG\_SUSPHY) ||+ (dwc3\_readl(dwc->regs, DWC3\_GUSB3PIPECTL(0)) &+ DWC3\_GUSB3PIPECTL\_SUSPHY);+ /\*+ \* TI AM62 platform requires SUSPHY to be+ \* enabled for system suspend to work.+ \*/+ if (!dwc->susphy\_state)+ dwc3\_enable\_susphy(dwc, true);+ }  switch (dwc->current\_dr\_role) { case DWC3\_GCTL\_PRTCAP\_DEVICE:@@ -2398,15 +2406,6 @@ static int dwc3\_suspend\_common(struct dwc3 \*dwc, pm\_message\_t msg) break; } - if (!PMSG\_IS\_AUTO(msg)) {- /\*- \* TI AM62 platform requires SUSPHY to be- \* enabled for system suspend to work.- \*/- if (!dwc->susphy\_state)- dwc3\_enable\_susphy(dwc, true);- }- return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:30:38 +0000



=== Content from git.kernel.org_e95e5027_20250114_183203.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roger Quadros <rogerq@kernel.org> | 2024-11-04 16:00:11 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-05 13:55:06 +0100 |
| commit | [9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b)) | |
| tree | [7fc9aa571ab485dc7c61b5740e3926db60eaa1db](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b) | |
| parent | [029778a4fd2c90c2e76a902b797c2348a722f1b8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=029778a4fd2c90c2e76a902b797c2348a722f1b8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b&id2=029778a4fd2c90c2e76a902b797c2348a722f1b8)) | |
| download | [linux-9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b.tar.gz) | |

usb: dwc3: fix fault at system suspend if device was already runtime suspendedIf the device was already runtime suspended then during system suspend
we cannot access the device registers else it will crash.
Also we cannot access any registers after dwc3\_core\_exit() on some
platforms so move the dwc3\_enable\_susphy() call to the top.
Cc: stable@vger.kernel.org # v5.15+
Reported-by: William McVicker <willmcvicker@google.com>
Closes: https://lore.kernel.org/all/ZyVfcUuPq56R2m1Y@google.com
Fixes: 705e3ce37bcc ("usb: dwc3: core: Fix system suspend on TI AM62 platforms")
Signed-off-by: Roger Quadros <rogerq@kernel.org>
Acked-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Tested-by: Will McVicker <willmcvicker@google.com>
Link: [https://lore.kernel.org/r/20241104-am62-lpm-usb-fix-v1-1-e93df73a4f0d@kernel.org](https://lore.kernel.org/r/20241104-am62-lpm-usb-fix-v1-1-e93df73a4f0d%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b)

| -rw-r--r-- | [drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/core.c?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 13 deletions

| diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.cindex 427e5660f87c24..98114c2827c098 100644--- a/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=029778a4fd2c90c2e76a902b797c2348a722f1b8)+++ b/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b)@@ -2342,10 +2342,18 @@ static int dwc3\_suspend\_common(struct dwc3 \*dwc, pm\_message\_t msg) u32 reg; int i; - dwc->susphy\_state = (dwc3\_readl(dwc->regs, DWC3\_GUSB2PHYCFG(0)) &- DWC3\_GUSB2PHYCFG\_SUSPHY) ||- (dwc3\_readl(dwc->regs, DWC3\_GUSB3PIPECTL(0)) &- DWC3\_GUSB3PIPECTL\_SUSPHY);+ if (!pm\_runtime\_suspended(dwc->dev) && !PMSG\_IS\_AUTO(msg)) {+ dwc->susphy\_state = (dwc3\_readl(dwc->regs, DWC3\_GUSB2PHYCFG(0)) &+ DWC3\_GUSB2PHYCFG\_SUSPHY) ||+ (dwc3\_readl(dwc->regs, DWC3\_GUSB3PIPECTL(0)) &+ DWC3\_GUSB3PIPECTL\_SUSPHY);+ /\*+ \* TI AM62 platform requires SUSPHY to be+ \* enabled for system suspend to work.+ \*/+ if (!dwc->susphy\_state)+ dwc3\_enable\_susphy(dwc, true);+ }  switch (dwc->current\_dr\_role) { case DWC3\_GCTL\_PRTCAP\_DEVICE:@@ -2398,15 +2406,6 @@ static int dwc3\_suspend\_common(struct dwc3 \*dwc, pm\_message\_t msg) break; } - if (!PMSG\_IS\_AUTO(msg)) {- /\*- \* TI AM62 platform requires SUSPHY to be- \* enabled for system suspend to work.- \*/- if (!dwc->susphy\_state)- dwc3\_enable\_susphy(dwc, true);- }- return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:30:40 +0000



=== Content from git.kernel.org_36cf4ef2_20250114_183201.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roger Quadros <rogerq@kernel.org> | 2024-11-04 16:00:11 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:19:39 +0100 |
| commit | [4abc5ee334fe4aba50461c45fdaaa4c5e5c57789](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789)) | |
| tree | [48978c9f56489349f891233487c8486f1f598061](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789) | |
| parent | [8a30da5aa9609663b3e05bcc91a916537f66a4cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a30da5aa9609663b3e05bcc91a916537f66a4cd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789&id2=8a30da5aa9609663b3e05bcc91a916537f66a4cd)) | |
| download | [linux-4abc5ee334fe4aba50461c45fdaaa4c5e5c57789.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4abc5ee334fe4aba50461c45fdaaa4c5e5c57789.tar.gz) | |

usb: dwc3: fix fault at system suspend if device was already runtime suspendedcommit 9cfb31e4c89d200d8ab7cb1e0bb9e6e8d621ca0b upstream.
If the device was already runtime suspended then during system suspend
we cannot access the device registers else it will crash.
Also we cannot access any registers after dwc3\_core\_exit() on some
platforms so move the dwc3\_enable\_susphy() call to the top.
Cc: stable@vger.kernel.org # v5.15+
Reported-by: William McVicker <willmcvicker@google.com>
Closes: https://lore.kernel.org/all/ZyVfcUuPq56R2m1Y@google.com
Fixes: 705e3ce37bcc ("usb: dwc3: core: Fix system suspend on TI AM62 platforms")
Signed-off-by: Roger Quadros <rogerq@kernel.org>
Acked-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Tested-by: Will McVicker <willmcvicker@google.com>
Link: [https://lore.kernel.org/r/20241104-am62-lpm-usb-fix-v1-1-e93df73a4f0d@kernel.org](https://lore.kernel.org/r/20241104-am62-lpm-usb-fix-v1-1-e93df73a4f0d%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789)

| -rw-r--r-- | [drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/core.c?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 13 deletions

| diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.cindex 8cbe19574bbcbc..fcb509059d7c49 100644--- a/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=8a30da5aa9609663b3e05bcc91a916537f66a4cd)+++ b/[drivers/usb/dwc3/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/core.c?id=4abc5ee334fe4aba50461c45fdaaa4c5e5c57789)@@ -2106,10 +2106,18 @@ static int dwc3\_suspend\_common(struct dwc3 \*dwc, pm\_message\_t msg) { u32 reg; - dwc->susphy\_state = (dwc3\_readl(dwc->regs, DWC3\_GUSB2PHYCFG(0)) &- DWC3\_GUSB2PHYCFG\_SUSPHY) ||- (dwc3\_readl(dwc->regs, DWC3\_GUSB3PIPECTL(0)) &- DWC3\_GUSB3PIPECTL\_SUSPHY);+ if (!pm\_runtime\_suspended(dwc->dev) && !PMSG\_IS\_AUTO(msg)) {+ dwc->susphy\_state = (dwc3\_readl(dwc->regs, DWC3\_GUSB2PHYCFG(0)) &+ DWC3\_GUSB2PHYCFG\_SUSPHY) ||+ (dwc3\_readl(dwc->regs, DWC3\_GUSB3PIPECTL(0)) &+ DWC3\_GUSB3PIPECTL\_SUSPHY);+ /\*+ \* TI AM62 platform requires SUSPHY to be+ \* enabled for system suspend to work.+ \*/+ if (!dwc->susphy\_state)+ dwc3\_enable\_susphy(dwc, true);+ }  switch (dwc->current\_dr\_role) { case DWC3\_GCTL\_PRTCAP\_DEVICE:@@ -2158,15 +2166,6 @@ static int dwc3\_suspend\_common(struct dwc3 \*dwc, pm\_message\_t msg) break; } - if (!PMSG\_IS\_AUTO(msg)) {- /\*- \* TI AM62 platform requires SUSPHY to be- \* enabled for system suspend to work.- \*/- if (!dwc->susphy\_state)- dwc3\_enable\_susphy(dwc, true);- }- return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:30:38 +0000


