=== Content from git.kernel.org_156de2f6_20250114_202947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roman Gushchin <roman.gushchin@linux.dev> | 2024-11-06 19:53:54 +0000 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-11-11 17:20:23 -0800 |
| commit | [66edc3a5894c74f8887c8af23b97593a0dd0df4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d)) | |
| tree | [f95fc2076a97ed6753652a5ecb71dc1e496918d3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d) | |
| parent | [e7ac4daeed91a25382091e73818ea0cddb1afd5e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7ac4daeed91a25382091e73818ea0cddb1afd5e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d&id2=e7ac4daeed91a25382091e73818ea0cddb1afd5e)) | |
| download | [linux-66edc3a5894c74f8887c8af23b97593a0dd0df4d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-66edc3a5894c74f8887c8af23b97593a0dd0df4d.tar.gz) | |

mm: page\_alloc: move mlocked flag clearance into free\_pages\_prepare()Syzbot reported a bad page state problem caused by a page being freed
using free\_page() still having a mlocked flag at free\_pages\_prepare()
stage:
BUG: Bad page state in process syz.5.504 pfn:61f45
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x61f45
flags: 0xfff00000080204(referenced|workingset|mlocked|node=0|zone=1|lastcpupid=0x7ff)
raw: 00fff00000080204 0000000000000000 dead000000000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: PAGE\_FLAGS\_CHECK\_AT\_FREE flag(s) set
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x400dc0(GFP\_KERNEL\_ACCOUNT|\_\_GFP\_ZERO), pid 8443, tgid 8442 (syz.5.504), ts 201884660643, free\_ts 201499827394
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1537
prep\_new\_page mm/page\_alloc.c:1545 [inline]
get\_page\_from\_freelist+0x303f/0x3190 mm/page\_alloc.c:3457
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4733
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
kvm\_coalesced\_mmio\_init+0x1f/0xf0 virt/kvm/coalesced\_mmio.c:99
kvm\_create\_vm virt/kvm/kvm\_main.c:1235 [inline]
kvm\_dev\_ioctl\_create\_vm virt/kvm/kvm\_main.c:5488 [inline]
kvm\_dev\_ioctl+0x12dc/0x2240 virt/kvm/kvm\_main.c:5530
\_\_do\_compat\_sys\_ioctl fs/ioctl.c:1007 [inline]
\_\_se\_compat\_sys\_ioctl+0x510/0xc90 fs/ioctl.c:950
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0xb4/0x110 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x34/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
page last free pid 8399 tgid 8399 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1108 [inline]
free\_unref\_folios+0xf12/0x18d0 mm/page\_alloc.c:2686
folios\_put\_refs+0x76c/0x860 mm/swap.c:1007
free\_pages\_and\_swap\_cache+0x5c8/0x690 mm/swap\_state.c:335
\_\_tlb\_batch\_free\_encoded\_pages mm/mmu\_gather.c:136 [inline]
tlb\_batch\_pages\_flush mm/mmu\_gather.c:149 [inline]
tlb\_flush\_mmu\_free mm/mmu\_gather.c:366 [inline]
tlb\_flush\_mmu+0x3a3/0x680 mm/mmu\_gather.c:373
tlb\_finish\_mmu+0xd4/0x200 mm/mmu\_gather.c:465
exit\_mmap+0x496/0xc40 mm/mmap.c:1926
\_\_mmput+0x115/0x390 kernel/fork.c:1348
exit\_mm+0x220/0x310 kernel/exit.c:571
do\_exit+0x9b2/0x28e0 kernel/exit.c:926
do\_group\_exit+0x207/0x2c0 kernel/exit.c:1088
\_\_do\_sys\_exit\_group kernel/exit.c:1099 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1097 [inline]
\_\_x64\_sys\_exit\_group+0x3f/0x40 kernel/exit.c:1097
x64\_sys\_call+0x2634/0x2640 arch/x86/include/generated/asm/syscalls\_64.h:232
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Modules linked in:
CPU: 0 UID: 0 PID: 8442 Comm: syz.5.504 Not tainted 6.12.0-rc6-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
bad\_page+0x176/0x1d0 mm/page\_alloc.c:501
free\_page\_is\_bad mm/page\_alloc.c:918 [inline]
free\_pages\_prepare mm/page\_alloc.c:1100 [inline]
free\_unref\_page+0xed0/0xf20 mm/page\_alloc.c:2638
kvm\_destroy\_vm virt/kvm/kvm\_main.c:1327 [inline]
kvm\_put\_kvm+0xc75/0x1350 virt/kvm/kvm\_main.c:1386
kvm\_vcpu\_release+0x54/0x60 virt/kvm/kvm\_main.c:4143
\_\_fput+0x23f/0x880 fs/file\_table.c:431
task\_work\_run+0x24f/0x310 kernel/task\_work.c:239
exit\_task\_work include/linux/task\_work.h:43 [inline]
do\_exit+0xa2f/0x28e0 kernel/exit.c:939
do\_group\_exit+0x207/0x2c0 kernel/exit.c:1088
\_\_do\_sys\_exit\_group kernel/exit.c:1099 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1097 [inline]
\_\_ia32\_sys\_exit\_group+0x3f/0x40 kernel/exit.c:1097
ia32\_sys\_call+0x2624/0x2630 arch/x86/include/generated/asm/syscalls\_32.h:253
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0xb4/0x110 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x34/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
RIP: 0023:0xf745d579
Code: Unable to access opcode bytes at 0xf745d54f.
RSP: 002b:00000000f75afd6c EFLAGS: 00000206 ORIG\_RAX: 00000000000000fc
RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 00000000ffffff9c RDI: 00000000f744cff4
RBP: 00000000f717ae61 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000206 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
</TASK>
The problem was originally introduced by commit b109b87050df ("mm/munlock:
replace clear\_page\_mlock() by final clearance"): it was focused on
handling pagecache and anonymous memory and wasn't suitable for lower
level get\_page()/free\_page() API's used for example by KVM, as with this
reproducer.
Fix it by moving the mlocked flag clearance down to free\_page\_prepare().
The bug itself if fairly old and harmless (aside from generating these
warnings), aside from a small memory leak - "bad" pages are stopped from
being allocated again.
Link: [https://lkml.kernel.org/r/20241106195354.270757-1-roman.gushchin@linux.dev](https://lkml.kernel.org/r/20241106195354.270757-1-roman.gushchin%40linux.dev)
Fixes: b109b87050df ("mm/munlock: replace clear\_page\_mlock() by final clearance")
Signed-off-by: Roman Gushchin <roman.gushchin@linux.dev>
Reported-by: syzbot+e985d3026c4fd041578e@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/6729f475.050a0220.701a.0019.GAE@google.com
Acked-by: Hugh Dickins <hughd@google.com>
Cc: Matthew Wilcox <willy@infradead.org>
Cc: Sean Christopherson <seanjc@google.com>
Cc: Vlastimil Babka <vbabka@suse.cz>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d)

| -rw-r--r-- | [mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page_alloc.c?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/swap.c?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d) | 14 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 14 deletions

| diff --git a/mm/page\_alloc.c b/mm/page\_alloc.cindex c6c7bb3ea71bc7..216fbbfbedcf91 100644--- a/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=e7ac4daeed91a25382091e73818ea0cddb1afd5e)+++ b/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d)@@ -1048,6 +1048,7 @@ \_\_always\_inline bool free\_pages\_prepare(struct page \*page, bool skip\_kasan\_poison = should\_skip\_kasan\_poison(page); bool init = want\_init\_on\_free(); bool compound = PageCompound(page);+ struct folio \*folio = page\_folio(page);  VM\_BUG\_ON\_PAGE(PageTail(page), page); @@ -1057,6 +1058,20 @@ \_\_always\_inline bool free\_pages\_prepare(struct page \*page, if (memcg\_kmem\_online() && PageMemcgKmem(page)) \_\_memcg\_kmem\_uncharge\_page(page, order); + /\*+ \* In rare cases, when truncation or holepunching raced with+ \* munlock after VM\_LOCKED was cleared, Mlocked may still be+ \* found set here. This does not indicate a problem, unless+ \* "unevictable\_pgs\_cleared" appears worryingly large.+ \*/+ if (unlikely(folio\_test\_mlocked(folio))) {+ long nr\_pages = folio\_nr\_pages(folio);++ \_\_folio\_clear\_mlocked(folio);+ zone\_stat\_mod\_folio(folio, NR\_MLOCK, -nr\_pages);+ count\_vm\_events(UNEVICTABLE\_PGCLEARED, nr\_pages);+ }+ if (unlikely(PageHWPoison(page)) && !order) { /\* Do not let hwpoison pages hit pcplists/buddy \*/ reset\_page\_owner(page, order);diff --git a/mm/swap.c b/mm/swap.cindex b8e3259ea2c472..59f30a981c6f96 100644--- a/[mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swap.c?id=e7ac4daeed91a25382091e73818ea0cddb1afd5e)+++ b/[mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swap.c?id=66edc3a5894c74f8887c8af23b97593a0dd0df4d)@@ -78,20 +78,6 @@ static void \_\_page\_cache\_release(struct folio \*folio, struct lruvec \*\*lruvecp, lruvec\_del\_folio(\*lruvecp, folio); \_\_folio\_clear\_lru\_flags(folio); }-- /\*- \* In rare cases, when truncation or holepunching raced with- \* munlock after VM\_LOCKED was cleared, Mlocked may still be- \* found set here. This does not indicate a problem, unless- \* "unevictable\_pgs\_cleared" appears worryingly large.- \*/- if (unlikely(folio\_test\_mlocked(folio))) {- long nr\_pages = folio\_nr\_pages(folio);-- \_\_folio\_clear\_mlocked(folio);- zone\_stat\_mod\_folio(folio, NR\_MLOCK, -nr\_pages);- count\_vm\_events(UNEVICTABLE\_PGCLEARED, nr\_pages);- } }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:28:24 +0000



=== Content from git.kernel.org_c15fb6ea_20250114_202946.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roman Gushchin <roman.gushchin@linux.dev> | 2024-11-06 19:53:54 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:31 +0100 |
| commit | [2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a)) | |
| tree | [d4afee061c003235e662413648b6b5b3f570867c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a) | |
| parent | [f6b5e3c7cb2106583287ce98d76a0004b8900269](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6b5e3c7cb2106583287ce98d76a0004b8900269) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a&id2=f6b5e3c7cb2106583287ce98d76a0004b8900269)) | |
| download | [linux-2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a.tar.gz) | |

mm: page\_alloc: move mlocked flag clearance into free\_pages\_prepare()commit 66edc3a5894c74f8887c8af23b97593a0dd0df4d upstream.
Syzbot reported a bad page state problem caused by a page being freed
using free\_page() still having a mlocked flag at free\_pages\_prepare()
stage:
BUG: Bad page state in process syz.5.504 pfn:61f45
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x61f45
flags: 0xfff00000080204(referenced|workingset|mlocked|node=0|zone=1|lastcpupid=0x7ff)
raw: 00fff00000080204 0000000000000000 dead000000000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: PAGE\_FLAGS\_CHECK\_AT\_FREE flag(s) set
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x400dc0(GFP\_KERNEL\_ACCOUNT|\_\_GFP\_ZERO), pid 8443, tgid 8442 (syz.5.504), ts 201884660643, free\_ts 201499827394
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1537
prep\_new\_page mm/page\_alloc.c:1545 [inline]
get\_page\_from\_freelist+0x303f/0x3190 mm/page\_alloc.c:3457
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4733
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
kvm\_coalesced\_mmio\_init+0x1f/0xf0 virt/kvm/coalesced\_mmio.c:99
kvm\_create\_vm virt/kvm/kvm\_main.c:1235 [inline]
kvm\_dev\_ioctl\_create\_vm virt/kvm/kvm\_main.c:5488 [inline]
kvm\_dev\_ioctl+0x12dc/0x2240 virt/kvm/kvm\_main.c:5530
\_\_do\_compat\_sys\_ioctl fs/ioctl.c:1007 [inline]
\_\_se\_compat\_sys\_ioctl+0x510/0xc90 fs/ioctl.c:950
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0xb4/0x110 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x34/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
page last free pid 8399 tgid 8399 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1108 [inline]
free\_unref\_folios+0xf12/0x18d0 mm/page\_alloc.c:2686
folios\_put\_refs+0x76c/0x860 mm/swap.c:1007
free\_pages\_and\_swap\_cache+0x5c8/0x690 mm/swap\_state.c:335
\_\_tlb\_batch\_free\_encoded\_pages mm/mmu\_gather.c:136 [inline]
tlb\_batch\_pages\_flush mm/mmu\_gather.c:149 [inline]
tlb\_flush\_mmu\_free mm/mmu\_gather.c:366 [inline]
tlb\_flush\_mmu+0x3a3/0x680 mm/mmu\_gather.c:373
tlb\_finish\_mmu+0xd4/0x200 mm/mmu\_gather.c:465
exit\_mmap+0x496/0xc40 mm/mmap.c:1926
\_\_mmput+0x115/0x390 kernel/fork.c:1348
exit\_mm+0x220/0x310 kernel/exit.c:571
do\_exit+0x9b2/0x28e0 kernel/exit.c:926
do\_group\_exit+0x207/0x2c0 kernel/exit.c:1088
\_\_do\_sys\_exit\_group kernel/exit.c:1099 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1097 [inline]
\_\_x64\_sys\_exit\_group+0x3f/0x40 kernel/exit.c:1097
x64\_sys\_call+0x2634/0x2640 arch/x86/include/generated/asm/syscalls\_64.h:232
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Modules linked in:
CPU: 0 UID: 0 PID: 8442 Comm: syz.5.504 Not tainted 6.12.0-rc6-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
bad\_page+0x176/0x1d0 mm/page\_alloc.c:501
free\_page\_is\_bad mm/page\_alloc.c:918 [inline]
free\_pages\_prepare mm/page\_alloc.c:1100 [inline]
free\_unref\_page+0xed0/0xf20 mm/page\_alloc.c:2638
kvm\_destroy\_vm virt/kvm/kvm\_main.c:1327 [inline]
kvm\_put\_kvm+0xc75/0x1350 virt/kvm/kvm\_main.c:1386
kvm\_vcpu\_release+0x54/0x60 virt/kvm/kvm\_main.c:4143
\_\_fput+0x23f/0x880 fs/file\_table.c:431
task\_work\_run+0x24f/0x310 kernel/task\_work.c:239
exit\_task\_work include/linux/task\_work.h:43 [inline]
do\_exit+0xa2f/0x28e0 kernel/exit.c:939
do\_group\_exit+0x207/0x2c0 kernel/exit.c:1088
\_\_do\_sys\_exit\_group kernel/exit.c:1099 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1097 [inline]
\_\_ia32\_sys\_exit\_group+0x3f/0x40 kernel/exit.c:1097
ia32\_sys\_call+0x2624/0x2630 arch/x86/include/generated/asm/syscalls\_32.h:253
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0xb4/0x110 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x34/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
RIP: 0023:0xf745d579
Code: Unable to access opcode bytes at 0xf745d54f.
RSP: 002b:00000000f75afd6c EFLAGS: 00000206 ORIG\_RAX: 00000000000000fc
RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 00000000ffffff9c RDI: 00000000f744cff4
RBP: 00000000f717ae61 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000206 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
</TASK>
The problem was originally introduced by commit b109b87050df ("mm/munlock:
replace clear\_page\_mlock() by final clearance"): it was focused on
handling pagecache and anonymous memory and wasn't suitable for lower
level get\_page()/free\_page() API's used for example by KVM, as with this
reproducer.
Fix it by moving the mlocked flag clearance down to free\_page\_prepare().
The bug itself if fairly old and harmless (aside from generating these
warnings), aside from a small memory leak - "bad" pages are stopped from
being allocated again.
Link: [https://lkml.kernel.org/r/20241106195354.270757-1-roman.gushchin@linux.dev](https://lkml.kernel.org/r/20241106195354.270757-1-roman.gushchin%40linux.dev)
Fixes: b109b87050df ("mm/munlock: replace clear\_page\_mlock() by final clearance")
Signed-off-by: Roman Gushchin <roman.gushchin@linux.dev>
Reported-by: syzbot+e985d3026c4fd041578e@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/6729f475.050a0220.701a.0019.GAE@google.com
Acked-by: Hugh Dickins <hughd@google.com>
Cc: Matthew Wilcox <willy@infradead.org>
Cc: Sean Christopherson <seanjc@google.com>
Cc: Vlastimil Babka <vbabka@suse.cz>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Hugh Dickins <hughd@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a)

| -rw-r--r-- | [mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page_alloc.c?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/swap.c?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a) | 20 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 20 deletions

| diff --git a/mm/page\_alloc.c b/mm/page\_alloc.cindex 58a3f70eb39bbd..6680ee77f96325 100644--- a/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=f6b5e3c7cb2106583287ce98d76a0004b8900269)+++ b/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a)@@ -1388,12 +1388,27 @@ static \_\_always\_inline bool free\_pages\_prepare(struct page \*page, int bad = 0; bool skip\_kasan\_poison = should\_skip\_kasan\_poison(page, fpi\_flags); bool init = want\_init\_on\_free();+ struct folio \*folio = page\_folio(page);  VM\_BUG\_ON\_PAGE(PageTail(page), page);  trace\_mm\_page\_free(page, order); kmsan\_free\_page(page, order); + /\*+ \* In rare cases, when truncation or holepunching raced with+ \* munlock after VM\_LOCKED was cleared, Mlocked may still be+ \* found set here. This does not indicate a problem, unless+ \* "unevictable\_pgs\_cleared" appears worryingly large.+ \*/+ if (unlikely(folio\_test\_mlocked(folio))) {+ long nr\_pages = folio\_nr\_pages(folio);++ \_\_folio\_clear\_mlocked(folio);+ zone\_stat\_mod\_folio(folio, NR\_MLOCK, -nr\_pages);+ count\_vm\_events(UNEVICTABLE\_PGCLEARED, nr\_pages);+ }+ if (unlikely(PageHWPoison(page)) && !order) { /\* \* Do not let hwpoison pages hit pcplists/buddydiff --git a/mm/swap.c b/mm/swap.cindex 955930f41d20c6..85aa04fc48a67c 100644--- a/[mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swap.c?id=f6b5e3c7cb2106583287ce98d76a0004b8900269)+++ b/[mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swap.c?id=2521664c1fc0fcea825ef0b4d8e2dfb622bc0f9a)@@ -88,14 +88,6 @@ static void \_\_page\_cache\_release(struct folio \*folio) \_\_folio\_clear\_lru\_flags(folio); unlock\_page\_lruvec\_irqrestore(lruvec, flags); }- /\* See comment on folio\_test\_mlocked in release\_pages() \*/- if (unlikely(folio\_test\_mlocked(folio))) {- long nr\_pages = folio\_nr\_pages(folio);-- \_\_folio\_clear\_mlocked(folio);- zone\_stat\_mod\_folio(folio, NR\_MLOCK, -nr\_pages);- count\_vm\_events(UNEVICTABLE\_PGCLEARED, nr\_pages);- } }  static void \_\_folio\_put\_small(struct folio \*folio)@@ -1034,18 +1026,6 @@ void release\_pages(struct page \*\*pages, int nr) \_\_folio\_clear\_lru\_flags(folio); } - /\*- \* In rare cases, when truncation or holepunching raced with- \* munlock after VM\_LOCKED was cleared, Mlocked may still be- \* found set here. This does not indicate a problem, unless- \* "unevictable\_pgs\_cleared" appears worryingly large.- \*/- if (unlikely(folio\_test\_mlocked(folio))) {- \_\_folio\_clear\_mlocked(folio);- zone\_stat\_sub\_folio(folio, NR\_MLOCK);- count\_vm\_event(UNEVICTABLE\_PGCLEARED);- }- list\_add(&folio->lru, &pages\_to\_free); } if (lruvec) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:28:23 +0000



=== Content from git.kernel.org_75472ff7_20250114_202948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roman Gushchin <roman.gushchin@linux.dev> | 2024-11-06 19:53:54 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:59:51 +0100 |
| commit | [81ad32b87eb91b627a4b0d8760434e5fac4b993a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a)) | |
| tree | [41ab32d38614ee4b845e773974d1682aa48d83d2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a) | |
| parent | [67a102352bb277e92caf76b05fa426fc212e847d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=67a102352bb277e92caf76b05fa426fc212e847d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a&id2=67a102352bb277e92caf76b05fa426fc212e847d)) | |
| download | [linux-81ad32b87eb91b627a4b0d8760434e5fac4b993a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-81ad32b87eb91b627a4b0d8760434e5fac4b993a.tar.gz) | |

mm: page\_alloc: move mlocked flag clearance into free\_pages\_prepare()commit 66edc3a5894c74f8887c8af23b97593a0dd0df4d upstream.
Syzbot reported a bad page state problem caused by a page being freed
using free\_page() still having a mlocked flag at free\_pages\_prepare()
stage:
BUG: Bad page state in process syz.5.504 pfn:61f45
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x61f45
flags: 0xfff00000080204(referenced|workingset|mlocked|node=0|zone=1|lastcpupid=0x7ff)
raw: 00fff00000080204 0000000000000000 dead000000000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: PAGE\_FLAGS\_CHECK\_AT\_FREE flag(s) set
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x400dc0(GFP\_KERNEL\_ACCOUNT|\_\_GFP\_ZERO), pid 8443, tgid 8442 (syz.5.504), ts 201884660643, free\_ts 201499827394
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1537
prep\_new\_page mm/page\_alloc.c:1545 [inline]
get\_page\_from\_freelist+0x303f/0x3190 mm/page\_alloc.c:3457
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4733
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
kvm\_coalesced\_mmio\_init+0x1f/0xf0 virt/kvm/coalesced\_mmio.c:99
kvm\_create\_vm virt/kvm/kvm\_main.c:1235 [inline]
kvm\_dev\_ioctl\_create\_vm virt/kvm/kvm\_main.c:5488 [inline]
kvm\_dev\_ioctl+0x12dc/0x2240 virt/kvm/kvm\_main.c:5530
\_\_do\_compat\_sys\_ioctl fs/ioctl.c:1007 [inline]
\_\_se\_compat\_sys\_ioctl+0x510/0xc90 fs/ioctl.c:950
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0xb4/0x110 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x34/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
page last free pid 8399 tgid 8399 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1108 [inline]
free\_unref\_folios+0xf12/0x18d0 mm/page\_alloc.c:2686
folios\_put\_refs+0x76c/0x860 mm/swap.c:1007
free\_pages\_and\_swap\_cache+0x5c8/0x690 mm/swap\_state.c:335
\_\_tlb\_batch\_free\_encoded\_pages mm/mmu\_gather.c:136 [inline]
tlb\_batch\_pages\_flush mm/mmu\_gather.c:149 [inline]
tlb\_flush\_mmu\_free mm/mmu\_gather.c:366 [inline]
tlb\_flush\_mmu+0x3a3/0x680 mm/mmu\_gather.c:373
tlb\_finish\_mmu+0xd4/0x200 mm/mmu\_gather.c:465
exit\_mmap+0x496/0xc40 mm/mmap.c:1926
\_\_mmput+0x115/0x390 kernel/fork.c:1348
exit\_mm+0x220/0x310 kernel/exit.c:571
do\_exit+0x9b2/0x28e0 kernel/exit.c:926
do\_group\_exit+0x207/0x2c0 kernel/exit.c:1088
\_\_do\_sys\_exit\_group kernel/exit.c:1099 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1097 [inline]
\_\_x64\_sys\_exit\_group+0x3f/0x40 kernel/exit.c:1097
x64\_sys\_call+0x2634/0x2640 arch/x86/include/generated/asm/syscalls\_64.h:232
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Modules linked in:
CPU: 0 UID: 0 PID: 8442 Comm: syz.5.504 Not tainted 6.12.0-rc6-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
bad\_page+0x176/0x1d0 mm/page\_alloc.c:501
free\_page\_is\_bad mm/page\_alloc.c:918 [inline]
free\_pages\_prepare mm/page\_alloc.c:1100 [inline]
free\_unref\_page+0xed0/0xf20 mm/page\_alloc.c:2638
kvm\_destroy\_vm virt/kvm/kvm\_main.c:1327 [inline]
kvm\_put\_kvm+0xc75/0x1350 virt/kvm/kvm\_main.c:1386
kvm\_vcpu\_release+0x54/0x60 virt/kvm/kvm\_main.c:4143
\_\_fput+0x23f/0x880 fs/file\_table.c:431
task\_work\_run+0x24f/0x310 kernel/task\_work.c:239
exit\_task\_work include/linux/task\_work.h:43 [inline]
do\_exit+0xa2f/0x28e0 kernel/exit.c:939
do\_group\_exit+0x207/0x2c0 kernel/exit.c:1088
\_\_do\_sys\_exit\_group kernel/exit.c:1099 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1097 [inline]
\_\_ia32\_sys\_exit\_group+0x3f/0x40 kernel/exit.c:1097
ia32\_sys\_call+0x2624/0x2630 arch/x86/include/generated/asm/syscalls\_32.h:253
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0xb4/0x110 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x34/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
RIP: 0023:0xf745d579
Code: Unable to access opcode bytes at 0xf745d54f.
RSP: 002b:00000000f75afd6c EFLAGS: 00000206 ORIG\_RAX: 00000000000000fc
RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 00000000ffffff9c RDI: 00000000f744cff4
RBP: 00000000f717ae61 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000206 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
</TASK>
The problem was originally introduced by commit b109b87050df ("mm/munlock:
replace clear\_page\_mlock() by final clearance"): it was focused on
handling pagecache and anonymous memory and wasn't suitable for lower
level get\_page()/free\_page() API's used for example by KVM, as with this
reproducer.
Fix it by moving the mlocked flag clearance down to free\_page\_prepare().
The bug itself if fairly old and harmless (aside from generating these
warnings), aside from a small memory leak - "bad" pages are stopped from
being allocated again.
Link: [https://lkml.kernel.org/r/20241106195354.270757-1-roman.gushchin@linux.dev](https://lkml.kernel.org/r/20241106195354.270757-1-roman.gushchin%40linux.dev)
Fixes: b109b87050df ("mm/munlock: replace clear\_page\_mlock() by final clearance")
Signed-off-by: Roman Gushchin <roman.gushchin@linux.dev>
Reported-by: syzbot+e985d3026c4fd041578e@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/6729f475.050a0220.701a.0019.GAE@google.com
Acked-by: Hugh Dickins <hughd@google.com>
Cc: Matthew Wilcox <willy@infradead.org>
Cc: Sean Christopherson <seanjc@google.com>
Cc: Vlastimil Babka <vbabka@suse.cz>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Hugh Dickins <hughd@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a)

| -rw-r--r-- | [mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page_alloc.c?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/swap.c?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a) | 20 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 20 deletions

| diff --git a/mm/page\_alloc.c b/mm/page\_alloc.cindex 3bda3f4570a234..f47439e0ef1085 100644--- a/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=67a102352bb277e92caf76b05fa426fc212e847d)+++ b/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a)@@ -1082,12 +1082,27 @@ static \_\_always\_inline bool free\_pages\_prepare(struct page \*page, int bad = 0; bool skip\_kasan\_poison = should\_skip\_kasan\_poison(page, fpi\_flags); bool init = want\_init\_on\_free();+ struct folio \*folio = page\_folio(page);  VM\_BUG\_ON\_PAGE(PageTail(page), page);  trace\_mm\_page\_free(page, order); kmsan\_free\_page(page, order); + /\*+ \* In rare cases, when truncation or holepunching raced with+ \* munlock after VM\_LOCKED was cleared, Mlocked may still be+ \* found set here. This does not indicate a problem, unless+ \* "unevictable\_pgs\_cleared" appears worryingly large.+ \*/+ if (unlikely(folio\_test\_mlocked(folio))) {+ long nr\_pages = folio\_nr\_pages(folio);++ \_\_folio\_clear\_mlocked(folio);+ zone\_stat\_mod\_folio(folio, NR\_MLOCK, -nr\_pages);+ count\_vm\_events(UNEVICTABLE\_PGCLEARED, nr\_pages);+ }+ if (unlikely(PageHWPoison(page)) && !order) { /\* \* Do not let hwpoison pages hit pcplists/buddydiff --git a/mm/swap.c b/mm/swap.cindex cd8f0150ba3aa8..42082eba42de3e 100644--- a/[mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swap.c?id=67a102352bb277e92caf76b05fa426fc212e847d)+++ b/[mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swap.c?id=81ad32b87eb91b627a4b0d8760434e5fac4b993a)@@ -89,14 +89,6 @@ static void \_\_page\_cache\_release(struct folio \*folio) \_\_folio\_clear\_lru\_flags(folio); unlock\_page\_lruvec\_irqrestore(lruvec, flags); }- /\* See comment on folio\_test\_mlocked in release\_pages() \*/- if (unlikely(folio\_test\_mlocked(folio))) {- long nr\_pages = folio\_nr\_pages(folio);-- \_\_folio\_clear\_mlocked(folio);- zone\_stat\_mod\_folio(folio, NR\_MLOCK, -nr\_pages);- count\_vm\_events(UNEVICTABLE\_PGCLEARED, nr\_pages);- } }  static void \_\_folio\_put\_small(struct folio \*folio)@@ -1021,18 +1013,6 @@ void release\_pages(release\_pages\_arg arg, int nr) \_\_folio\_clear\_lru\_flags(folio); } - /\*- \* In rare cases, when truncation or holepunching raced with- \* munlock after VM\_LOCKED was cleared, Mlocked may still be- \* found set here. This does not indicate a problem, unless- \* "unevictable\_pgs\_cleared" appears worryingly large.- \*/- if (unlikely(folio\_test\_mlocked(folio))) {- \_\_folio\_clear\_mlocked(folio);- zone\_stat\_sub\_folio(folio, NR\_MLOCK);- count\_vm\_event(UNEVICTABLE\_PGCLEARED);- }- list\_add(&folio->lru, &pages\_to\_free); } if (lruvec) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:28:25 +0000



=== Content from git.kernel.org_ab74a5d9_20250114_202948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roman Gushchin <roman.gushchin@linux.dev> | 2024-11-06 19:53:54 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:39:52 +0100 |
| commit | [7873d11911cd1d21e25c354eb130d8c3b5cb3ca5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5)) | |
| tree | [e0b7087324f78f7c28f1d8036791517508206a3d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5) | |
| parent | [386c7cc6c06d64cbf36d15c5e2319814765e107c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=386c7cc6c06d64cbf36d15c5e2319814765e107c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5&id2=386c7cc6c06d64cbf36d15c5e2319814765e107c)) | |
| download | [linux-7873d11911cd1d21e25c354eb130d8c3b5cb3ca5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7873d11911cd1d21e25c354eb130d8c3b5cb3ca5.tar.gz) | |

mm: page\_alloc: move mlocked flag clearance into free\_pages\_prepare()commit 66edc3a5894c74f8887c8af23b97593a0dd0df4d upstream.
Syzbot reported a bad page state problem caused by a page being freed
using free\_page() still having a mlocked flag at free\_pages\_prepare()
stage:
BUG: Bad page state in process syz.5.504 pfn:61f45
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x61f45
flags: 0xfff00000080204(referenced|workingset|mlocked|node=0|zone=1|lastcpupid=0x7ff)
raw: 00fff00000080204 0000000000000000 dead000000000122 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: PAGE\_FLAGS\_CHECK\_AT\_FREE flag(s) set
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x400dc0(GFP\_KERNEL\_ACCOUNT|\_\_GFP\_ZERO), pid 8443, tgid 8442 (syz.5.504), ts 201884660643, free\_ts 201499827394
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1537
prep\_new\_page mm/page\_alloc.c:1545 [inline]
get\_page\_from\_freelist+0x303f/0x3190 mm/page\_alloc.c:3457
\_\_alloc\_pages\_noprof+0x292/0x710 mm/page\_alloc.c:4733
alloc\_pages\_mpol\_noprof+0x3e8/0x680 mm/mempolicy.c:2265
kvm\_coalesced\_mmio\_init+0x1f/0xf0 virt/kvm/coalesced\_mmio.c:99
kvm\_create\_vm virt/kvm/kvm\_main.c:1235 [inline]
kvm\_dev\_ioctl\_create\_vm virt/kvm/kvm\_main.c:5488 [inline]
kvm\_dev\_ioctl+0x12dc/0x2240 virt/kvm/kvm\_main.c:5530
\_\_do\_compat\_sys\_ioctl fs/ioctl.c:1007 [inline]
\_\_se\_compat\_sys\_ioctl+0x510/0xc90 fs/ioctl.c:950
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0xb4/0x110 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x34/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
page last free pid 8399 tgid 8399 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1108 [inline]
free\_unref\_folios+0xf12/0x18d0 mm/page\_alloc.c:2686
folios\_put\_refs+0x76c/0x860 mm/swap.c:1007
free\_pages\_and\_swap\_cache+0x5c8/0x690 mm/swap\_state.c:335
\_\_tlb\_batch\_free\_encoded\_pages mm/mmu\_gather.c:136 [inline]
tlb\_batch\_pages\_flush mm/mmu\_gather.c:149 [inline]
tlb\_flush\_mmu\_free mm/mmu\_gather.c:366 [inline]
tlb\_flush\_mmu+0x3a3/0x680 mm/mmu\_gather.c:373
tlb\_finish\_mmu+0xd4/0x200 mm/mmu\_gather.c:465
exit\_mmap+0x496/0xc40 mm/mmap.c:1926
\_\_mmput+0x115/0x390 kernel/fork.c:1348
exit\_mm+0x220/0x310 kernel/exit.c:571
do\_exit+0x9b2/0x28e0 kernel/exit.c:926
do\_group\_exit+0x207/0x2c0 kernel/exit.c:1088
\_\_do\_sys\_exit\_group kernel/exit.c:1099 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1097 [inline]
\_\_x64\_sys\_exit\_group+0x3f/0x40 kernel/exit.c:1097
x64\_sys\_call+0x2634/0x2640 arch/x86/include/generated/asm/syscalls\_64.h:232
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Modules linked in:
CPU: 0 UID: 0 PID: 8442 Comm: syz.5.504 Not tainted 6.12.0-rc6-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:94 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120
bad\_page+0x176/0x1d0 mm/page\_alloc.c:501
free\_page\_is\_bad mm/page\_alloc.c:918 [inline]
free\_pages\_prepare mm/page\_alloc.c:1100 [inline]
free\_unref\_page+0xed0/0xf20 mm/page\_alloc.c:2638
kvm\_destroy\_vm virt/kvm/kvm\_main.c:1327 [inline]
kvm\_put\_kvm+0xc75/0x1350 virt/kvm/kvm\_main.c:1386
kvm\_vcpu\_release+0x54/0x60 virt/kvm/kvm\_main.c:4143
\_\_fput+0x23f/0x880 fs/file\_table.c:431
task\_work\_run+0x24f/0x310 kernel/task\_work.c:239
exit\_task\_work include/linux/task\_work.h:43 [inline]
do\_exit+0xa2f/0x28e0 kernel/exit.c:939
do\_group\_exit+0x207/0x2c0 kernel/exit.c:1088
\_\_do\_sys\_exit\_group kernel/exit.c:1099 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1097 [inline]
\_\_ia32\_sys\_exit\_group+0x3f/0x40 kernel/exit.c:1097
ia32\_sys\_call+0x2624/0x2630 arch/x86/include/generated/asm/syscalls\_32.h:253
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:165 [inline]
\_\_do\_fast\_syscall\_32+0xb4/0x110 arch/x86/entry/common.c:386
do\_fast\_syscall\_32+0x34/0x80 arch/x86/entry/common.c:411
entry\_SYSENTER\_compat\_after\_hwframe+0x84/0x8e
RIP: 0023:0xf745d579
Code: Unable to access opcode bytes at 0xf745d54f.
RSP: 002b:00000000f75afd6c EFLAGS: 00000206 ORIG\_RAX: 00000000000000fc
RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 00000000ffffff9c RDI: 00000000f744cff4
RBP: 00000000f717ae61 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000206 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
</TASK>
The problem was originally introduced by commit b109b87050df ("mm/munlock:
replace clear\_page\_mlock() by final clearance"): it was focused on
handling pagecache and anonymous memory and wasn't suitable for lower
level get\_page()/free\_page() API's used for example by KVM, as with this
reproducer.
Fix it by moving the mlocked flag clearance down to free\_page\_prepare().
The bug itself if fairly old and harmless (aside from generating these
warnings), aside from a small memory leak - "bad" pages are stopped from
being allocated again.
Link: [https://lkml.kernel.org/r/20241106195354.270757-1-roman.gushchin@linux.dev](https://lkml.kernel.org/r/20241106195354.270757-1-roman.gushchin%40linux.dev)
Fixes: b109b87050df ("mm/munlock: replace clear\_page\_mlock() by final clearance")
Signed-off-by: Roman Gushchin <roman.gushchin@linux.dev>
Reported-by: syzbot+e985d3026c4fd041578e@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/6729f475.050a0220.701a.0019.GAE@google.com
Acked-by: Hugh Dickins <hughd@google.com>
Cc: Matthew Wilcox <willy@infradead.org>
Cc: Sean Christopherson <seanjc@google.com>
Cc: Vlastimil Babka <vbabka@suse.cz>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5)

| -rw-r--r-- | [mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page_alloc.c?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/swap.c?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5) | 14 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 14 deletions

| diff --git a/mm/page\_alloc.c b/mm/page\_alloc.cindex ab53d0e51a8225..2f19464db66e05 100644--- a/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=386c7cc6c06d64cbf36d15c5e2319814765e107c)+++ b/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5)@@ -1040,6 +1040,7 @@ \_\_always\_inline bool free\_pages\_prepare(struct page \*page, bool skip\_kasan\_poison = should\_skip\_kasan\_poison(page); bool init = want\_init\_on\_free(); bool compound = PageCompound(page);+ struct folio \*folio = page\_folio(page);  VM\_BUG\_ON\_PAGE(PageTail(page), page); @@ -1049,6 +1050,20 @@ \_\_always\_inline bool free\_pages\_prepare(struct page \*page, if (memcg\_kmem\_online() && PageMemcgKmem(page)) \_\_memcg\_kmem\_uncharge\_page(page, order); + /\*+ \* In rare cases, when truncation or holepunching raced with+ \* munlock after VM\_LOCKED was cleared, Mlocked may still be+ \* found set here. This does not indicate a problem, unless+ \* "unevictable\_pgs\_cleared" appears worryingly large.+ \*/+ if (unlikely(folio\_test\_mlocked(folio))) {+ long nr\_pages = folio\_nr\_pages(folio);++ \_\_folio\_clear\_mlocked(folio);+ zone\_stat\_mod\_folio(folio, NR\_MLOCK, -nr\_pages);+ count\_vm\_events(UNEVICTABLE\_PGCLEARED, nr\_pages);+ }+ if (unlikely(PageHWPoison(page)) && !order) { /\* Do not let hwpoison pages hit pcplists/buddy \*/ reset\_page\_owner(page, order);diff --git a/mm/swap.c b/mm/swap.cindex 1e734a5a6453e2..5d1850adf76a13 100644--- a/[mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swap.c?id=386c7cc6c06d64cbf36d15c5e2319814765e107c)+++ b/[mm/swap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swap.c?id=7873d11911cd1d21e25c354eb130d8c3b5cb3ca5)@@ -82,20 +82,6 @@ static void \_\_page\_cache\_release(struct folio \*folio, struct lruvec \*\*lruvecp, lruvec\_del\_folio(\*lruvecp, folio); \_\_folio\_clear\_lru\_flags(folio); }-- /\*- \* In rare cases, when truncation or holepunching raced with- \* munlock after VM\_LOCKED was cleared, Mlocked may still be- \* found set here. This does not indicate a problem, unless- \* "unevictable\_pgs\_cleared" appears worryingly large.- \*/- if (unlikely(folio\_test\_mlocked(folio))) {- long nr\_pages = folio\_nr\_pages(folio);-- \_\_folio\_clear\_mlocked(folio);- zone\_stat\_mod\_folio(folio, NR\_MLOCK, -nr\_pages);- count\_vm\_events(UNEVICTABLE\_PGCLEARED, nr\_pages);- } }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:28:24 +0000


