=== Content from git.kernel.org_c94ad4a4_20250114_202800.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paul Aurich <paul@darkrain42.org> | 2024-11-18 13:50:26 -0800 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-11-21 10:45:50 -0600 |
| commit | [7afb86733685c64c604d32faf00fa4a1f22c2ab1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1)) | |
| tree | [1d312979bafc4e594d9a571d8ee1759cd0316033](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1) | |
| parent | [0812340811e45ec4039d409049be53056182a552](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0812340811e45ec4039d409049be53056182a552) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1&id2=0812340811e45ec4039d409049be53056182a552)) | |
| download | [linux-7afb86733685c64c604d32faf00fa4a1f22c2ab1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7afb86733685c64c604d32faf00fa4a1f22c2ab1.tar.gz) | |

smb: Don't leak cfid when reconnect races with open\_cached\_diropen\_cached\_dir() may either race with the tcon reconnection even before
compound\_send\_recv() or directly trigger a reconnection via
SMB2\_open\_init() or SMB\_query\_info\_init().
The reconnection process invokes invalidate\_all\_cached\_dirs() via
cifs\_mark\_open\_files\_invalid(), which removes all cfids from the
cfids->entries list but doesn't drop a ref if has\_lease isn't true. This
results in the currently-being-constructed cfid not being on the list,
but still having a refcount of 2. It leaks if returned from
open\_cached\_dir().
Fix this by setting cfid->has\_lease when the ref is actually taken; the
cfid will not be used by other threads until it has a valid time.
Addresses these kmemleaks:
unreferenced object 0xffff8881090c4000 (size 1024):
comm "bash", pid 1860, jiffies 4295126592
hex dump (first 32 bytes):
00 01 00 00 00 00 ad de 22 01 00 00 00 00 ad de ........".......
00 ca 45 22 81 88 ff ff f8 dc 4f 04 81 88 ff ff ..E"......O.....
backtrace (crc 6f58c20f):
[<ffffffff8b895a1e>] \_\_kmalloc\_cache\_noprof+0x2be/0x350
[<ffffffff8bda06e3>] open\_cached\_dir+0x993/0x1fb0
[<ffffffff8bdaa750>] cifs\_readdir+0x15a0/0x1d50
[<ffffffff8b9a853f>] iterate\_dir+0x28f/0x4b0
[<ffffffff8b9a9aed>] \_\_x64\_sys\_getdents64+0xfd/0x200
[<ffffffff8cf6da05>] do\_syscall\_64+0x95/0x1a0
[<ffffffff8d00012f>] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
unreferenced object 0xffff8881044fdcf8 (size 8):
comm "bash", pid 1860, jiffies 4295126592
hex dump (first 8 bytes):
00 cc cc cc cc cc cc cc ........
backtrace (crc 10c106a9):
[<ffffffff8b89a3d3>] \_\_kmalloc\_node\_track\_caller\_noprof+0x363/0x480
[<ffffffff8b7d7256>] kstrdup+0x36/0x60
[<ffffffff8bda0700>] open\_cached\_dir+0x9b0/0x1fb0
[<ffffffff8bdaa750>] cifs\_readdir+0x15a0/0x1d50
[<ffffffff8b9a853f>] iterate\_dir+0x28f/0x4b0
[<ffffffff8b9a9aed>] \_\_x64\_sys\_getdents64+0xfd/0x200
[<ffffffff8cf6da05>] do\_syscall\_64+0x95/0x1a0
[<ffffffff8d00012f>] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
And addresses these BUG splats when unmounting the SMB filesystem:
BUG: Dentry ffff888140590ba0{i=1000000000080,n=/} still in use (2) [unmount of cifs cifs]
WARNING: CPU: 3 PID: 3433 at fs/dcache.c:1536 umount\_check+0xd0/0x100
Modules linked in:
CPU: 3 UID: 0 PID: 3433 Comm: bash Not tainted 6.12.0-rc4-g850925a8133c-dirty #49
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020
RIP: 0010:umount\_check+0xd0/0x100
Code: 8d 7c 24 40 e8 31 5a f4 ff 49 8b 54 24 40 41 56 49 89 e9 45 89 e8 48 89 d9 41 57 48 89 de 48 c7 c7 80 e7 db ac e8 f0 72 9a ff <0f> 0b 58 31 c0 5a 5b 5d 41 5c 41 5d 41 5e 41 5f e9 2b e5 5d 01 41
RSP: 0018:ffff88811cc27978 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff888140590ba0 RCX: ffffffffaaf20bae
RDX: dffffc0000000000 RSI: 0000000000000008 RDI: ffff8881f6fb6f40
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed1023984ee3
R10: ffff88811cc2771f R11: 00000000016cfcc0 R12: ffff888134383e08
R13: 0000000000000002 R14: ffff8881462ec668 R15: ffffffffaceab4c0
FS: 00007f23bfa98740(0000) GS:ffff8881f6f80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000556de4a6f808 CR3: 0000000123c80000 CR4: 0000000000350ef0
Call Trace:
<TASK>
d\_walk+0x6a/0x530
shrink\_dcache\_for\_umount+0x6a/0x200
generic\_shutdown\_super+0x52/0x2a0
kill\_anon\_super+0x22/0x40
cifs\_kill\_sb+0x159/0x1e0
deactivate\_locked\_super+0x66/0xe0
cleanup\_mnt+0x140/0x210
task\_work\_run+0xfb/0x170
syscall\_exit\_to\_user\_mode+0x29f/0x2b0
do\_syscall\_64+0xa1/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f23bfb93ae7
Code: ff ff ff ff c3 66 0f 1f 44 00 00 48 8b 0d 11 93 0d 00 f7 d8 64 89 01 b8 ff ff ff ff eb bf 0f 1f 44 00 00 b8 50 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d e9 92 0d 00 f7 d8 64 89 01 48
RSP: 002b:00007ffee9138598 EFLAGS: 00000246 ORIG\_RAX: 0000000000000050
RAX: 0000000000000000 RBX: 0000558f1803e9a0 RCX: 00007f23bfb93ae7
RDX: 0000000000000000 RSI: 0000000000000004 RDI: 0000558f1803e9a0
RBP: 0000558f1803e600 R08: 0000000000000007 R09: 0000558f17fab610
R10: d91d5ec34ab757b0 R11: 0000000000000246 R12: 0000000000000001
R13: 0000000000000000 R14: 0000000000000015 R15: 0000000000000000
</TASK>
irq event stamp: 1163486
hardirqs last enabled at (1163485): [<ffffffffac98d344>] \_raw\_spin\_unlock\_irqrestore+0x34/0x60
hardirqs last disabled at (1163486): [<ffffffffac97dcfc>] \_\_schedule+0xc7c/0x19a0
softirqs last enabled at (1163482): [<ffffffffab79a3ee>] \_\_smb\_send\_rqst+0x3de/0x990
softirqs last disabled at (1163480): [<ffffffffac2314f1>] release\_sock+0x21/0xf0
---[ end trace 0000000000000000 ]---
VFS: Busy inodes after unmount of cifs (cifs)
------------[ cut here ]------------
kernel BUG at fs/super.c:661!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 1 UID: 0 PID: 3433 Comm: bash Tainted: G W 6.12.0-rc4-g850925a8133c-dirty #49
Tainted: [W]=WARN
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020
RIP: 0010:generic\_shutdown\_super+0x290/0x2a0
Code: e8 15 7c f7 ff 48 8b 5d 28 48 89 df e8 09 7c f7 ff 48 8b 0b 48 89 ee 48 8d 95 68 06 00 00 48 c7 c7 80 7f db ac e8 00 69 af ff <0f> 0b 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90 90 90 90 90 90
RSP: 0018:ffff88811cc27a50 EFLAGS: 00010246
RAX: 000000000000003e RBX: ffffffffae994420 RCX: 0000000000000027
RDX: 0000000000000000 RSI: ffffffffab06180e RDI: ffff8881f6eb18c8
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed103edd6319
R10: ffff8881f6eb18cb R11: 00000000016d3158 R12: ffff8881462ec9c0
R13: ffff8881462ec050 R14: 0000000000000001 R15: 0000000000000000
FS: 00007f23bfa98740(0000) GS:ffff8881f6e80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8364005d68 CR3: 0000000123c80000 CR4: 0000000000350ef0
Call Trace:
<TASK>
kill\_anon\_super+0x22/0x40
cifs\_kill\_sb+0x159/0x1e0
deactivate\_locked\_super+0x66/0xe0
cleanup\_mnt+0x140/0x210
task\_work\_run+0xfb/0x170
syscall\_exit\_to\_user\_mode+0x29f/0x2b0
do\_syscall\_64+0xa1/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f23bfb93ae7
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
RIP: 0010:generic\_shutdown\_super+0x290/0x2a0
Code: e8 15 7c f7 ff 48 8b 5d 28 48 89 df e8 09 7c f7 ff 48 8b 0b 48 89 ee 48 8d 95 68 06 00 00 48 c7 c7 80 7f db ac e8 00 69 af ff <0f> 0b 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90 90 90 90 90 90
RSP: 0018:ffff88811cc27a50 EFLAGS: 00010246
RAX: 000000000000003e RBX: ffffffffae994420 RCX: 0000000000000027
RDX: 0000000000000000 RSI: ffffffffab06180e RDI: ffff8881f6eb18c8
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed103edd6319
R10: ffff8881f6eb18cb R11: 00000000016d3158 R12: ffff8881462ec9c0
R13: ffff8881462ec050 R14: 0000000000000001 R15: 0000000000000000
FS: 00007f23bfa98740(0000) GS:ffff8881f6e80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8364005d68 CR3: 0000000123c80000 CR4: 0000000000350ef0
This reproduces eventually with an SMB mount and two shells running
these loops concurrently
- while true; do
cd ~; sleep 1;
for i in {1..3}; do cd /mnt/test/subdir;
echo $PWD; sleep 1; cd ..; echo $PWD; sleep 1;
done;
echo ...;
done
- while true; do
iptables -F OUTPUT; mount -t cifs -a;
for \_ in {0..2}; do ls /mnt/test/subdir/ | wc -l; done;
iptables -I OUTPUT -p tcp --dport 445 -j DROP;
sleep 10
echo "unmounting"; umount -l -t cifs -a; echo "done unmounting";
sleep 20
echo "recovering"; iptables -F OUTPUT;
sleep 10;
done
Fixes: ebe98f1447bb ("cifs: enable caching of directories for which a lease is held")
Fixes: 5c86919455c1 ("smb: client: fix use-after-free in smb2\_query\_info\_compound()")
Cc: stable@vger.kernel.org
Signed-off-by: Paul Aurich <paul@darkrain42.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1)

| -rw-r--r-- | [fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/cached_dir.c?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 13 deletions

| diff --git a/fs/smb/client/cached\_dir.c b/fs/smb/client/cached\_dir.cindex adcba13352045f..bb9d4c284ce577 100644--- a/[fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/cached_dir.c?id=0812340811e45ec4039d409049be53056182a552)+++ b/[fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/cached_dir.c?id=7afb86733685c64c604d32faf00fa4a1f22c2ab1)@@ -59,6 +59,16 @@ static struct cached\_fid \*find\_or\_create\_cached\_dir(struct cached\_fids \*cfids, list\_add(&cfid->entry, &cfids->entries); cfid->on\_list = true; kref\_get(&cfid->refcount);+ /\*+ \* Set @cfid->has\_lease to true during construction so that the lease+ \* reference can be put in cached\_dir\_lease\_break() due to a potential+ \* lease break right after the request is sent or while @cfid is still+ \* being cached, or if a reconnection is triggered during construction.+ \* Concurrent processes won't be to use it yet due to @cfid->time being+ \* zero.+ \*/+ cfid->has\_lease = true;+ spin\_unlock(&cfids->cfid\_list\_lock); return cfid; }@@ -176,12 +186,12 @@ replay\_again: return -ENOENT; } /\*- \* Return cached fid if it has a lease. Otherwise, it is either a new- \* entry or laundromat worker removed it from @cfids->entries. Caller- \* will put last reference if the latter.+ \* Return cached fid if it is valid (has a lease and has a time).+ \* Otherwise, it is either a new entry or laundromat worker removed it+ \* from @cfids->entries. Caller will put last reference if the latter. \*/ spin\_lock(&cfids->cfid\_list\_lock);- if (cfid->has\_lease) {+ if (cfid->has\_lease && cfid->time) { spin\_unlock(&cfids->cfid\_list\_lock); \*ret\_cfid = cfid; kfree(utf16\_path);@@ -267,15 +277,6 @@ replay\_again:  smb2\_set\_related(&rqst[1]); - /\*- \* Set @cfid->has\_lease to true before sending out compounded request so- \* its lease reference can be put in cached\_dir\_lease\_break() due to a- \* potential lease break right after the request is sent or while @cfid- \* is still being cached. Concurrent processes won't be to use it yet- \* due to @cfid->time being zero.- \*/- cfid->has\_lease = true;- if (retries) { smb2\_set\_replay(server, &rqst[0]); smb2\_set\_replay(server, &rqst[1]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:26:37 +0000



=== Content from git.kernel.org_e004967c_20250114_202758.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1d76332d783db12684b67592f1fb2057b88af4c3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1d76332d783db12684b67592f1fb2057b88af4c3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d76332d783db12684b67592f1fb2057b88af4c3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d76332d783db12684b67592f1fb2057b88af4c3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paul Aurich <paul@darkrain42.org> | 2024-11-18 13:50:26 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:24 +0100 |
| commit | [1d76332d783db12684b67592f1fb2057b88af4c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d76332d783db12684b67592f1fb2057b88af4c3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1d76332d783db12684b67592f1fb2057b88af4c3)) | |
| tree | [245caa0b3884127a46f42145f88b4a599a23db72](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1d76332d783db12684b67592f1fb2057b88af4c3) | |
| parent | [2ae227f8c2793036bcf0c2ff9f34f2b34a74722c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ae227f8c2793036bcf0c2ff9f34f2b34a74722c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d76332d783db12684b67592f1fb2057b88af4c3&id2=2ae227f8c2793036bcf0c2ff9f34f2b34a74722c)) | |
| download | [linux-1d76332d783db12684b67592f1fb2057b88af4c3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1d76332d783db12684b67592f1fb2057b88af4c3.tar.gz) | |

smb: Don't leak cfid when reconnect races with open\_cached\_dircommit 7afb86733685c64c604d32faf00fa4a1f22c2ab1 upstream.
open\_cached\_dir() may either race with the tcon reconnection even before
compound\_send\_recv() or directly trigger a reconnection via
SMB2\_open\_init() or SMB\_query\_info\_init().
The reconnection process invokes invalidate\_all\_cached\_dirs() via
cifs\_mark\_open\_files\_invalid(), which removes all cfids from the
cfids->entries list but doesn't drop a ref if has\_lease isn't true. This
results in the currently-being-constructed cfid not being on the list,
but still having a refcount of 2. It leaks if returned from
open\_cached\_dir().
Fix this by setting cfid->has\_lease when the ref is actually taken; the
cfid will not be used by other threads until it has a valid time.
Addresses these kmemleaks:
unreferenced object 0xffff8881090c4000 (size 1024):
comm "bash", pid 1860, jiffies 4295126592
hex dump (first 32 bytes):
00 01 00 00 00 00 ad de 22 01 00 00 00 00 ad de ........".......
00 ca 45 22 81 88 ff ff f8 dc 4f 04 81 88 ff ff ..E"......O.....
backtrace (crc 6f58c20f):
[<ffffffff8b895a1e>] \_\_kmalloc\_cache\_noprof+0x2be/0x350
[<ffffffff8bda06e3>] open\_cached\_dir+0x993/0x1fb0
[<ffffffff8bdaa750>] cifs\_readdir+0x15a0/0x1d50
[<ffffffff8b9a853f>] iterate\_dir+0x28f/0x4b0
[<ffffffff8b9a9aed>] \_\_x64\_sys\_getdents64+0xfd/0x200
[<ffffffff8cf6da05>] do\_syscall\_64+0x95/0x1a0
[<ffffffff8d00012f>] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
unreferenced object 0xffff8881044fdcf8 (size 8):
comm "bash", pid 1860, jiffies 4295126592
hex dump (first 8 bytes):
00 cc cc cc cc cc cc cc ........
backtrace (crc 10c106a9):
[<ffffffff8b89a3d3>] \_\_kmalloc\_node\_track\_caller\_noprof+0x363/0x480
[<ffffffff8b7d7256>] kstrdup+0x36/0x60
[<ffffffff8bda0700>] open\_cached\_dir+0x9b0/0x1fb0
[<ffffffff8bdaa750>] cifs\_readdir+0x15a0/0x1d50
[<ffffffff8b9a853f>] iterate\_dir+0x28f/0x4b0
[<ffffffff8b9a9aed>] \_\_x64\_sys\_getdents64+0xfd/0x200
[<ffffffff8cf6da05>] do\_syscall\_64+0x95/0x1a0
[<ffffffff8d00012f>] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
And addresses these BUG splats when unmounting the SMB filesystem:
BUG: Dentry ffff888140590ba0{i=1000000000080,n=/} still in use (2) [unmount of cifs cifs]
WARNING: CPU: 3 PID: 3433 at fs/dcache.c:1536 umount\_check+0xd0/0x100
Modules linked in:
CPU: 3 UID: 0 PID: 3433 Comm: bash Not tainted 6.12.0-rc4-g850925a8133c-dirty #49
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020
RIP: 0010:umount\_check+0xd0/0x100
Code: 8d 7c 24 40 e8 31 5a f4 ff 49 8b 54 24 40 41 56 49 89 e9 45 89 e8 48 89 d9 41 57 48 89 de 48 c7 c7 80 e7 db ac e8 f0 72 9a ff <0f> 0b 58 31 c0 5a 5b 5d 41 5c 41 5d 41 5e 41 5f e9 2b e5 5d 01 41
RSP: 0018:ffff88811cc27978 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff888140590ba0 RCX: ffffffffaaf20bae
RDX: dffffc0000000000 RSI: 0000000000000008 RDI: ffff8881f6fb6f40
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed1023984ee3
R10: ffff88811cc2771f R11: 00000000016cfcc0 R12: ffff888134383e08
R13: 0000000000000002 R14: ffff8881462ec668 R15: ffffffffaceab4c0
FS: 00007f23bfa98740(0000) GS:ffff8881f6f80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000556de4a6f808 CR3: 0000000123c80000 CR4: 0000000000350ef0
Call Trace:
<TASK>
d\_walk+0x6a/0x530
shrink\_dcache\_for\_umount+0x6a/0x200
generic\_shutdown\_super+0x52/0x2a0
kill\_anon\_super+0x22/0x40
cifs\_kill\_sb+0x159/0x1e0
deactivate\_locked\_super+0x66/0xe0
cleanup\_mnt+0x140/0x210
task\_work\_run+0xfb/0x170
syscall\_exit\_to\_user\_mode+0x29f/0x2b0
do\_syscall\_64+0xa1/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f23bfb93ae7
Code: ff ff ff ff c3 66 0f 1f 44 00 00 48 8b 0d 11 93 0d 00 f7 d8 64 89 01 b8 ff ff ff ff eb bf 0f 1f 44 00 00 b8 50 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d e9 92 0d 00 f7 d8 64 89 01 48
RSP: 002b:00007ffee9138598 EFLAGS: 00000246 ORIG\_RAX: 0000000000000050
RAX: 0000000000000000 RBX: 0000558f1803e9a0 RCX: 00007f23bfb93ae7
RDX: 0000000000000000 RSI: 0000000000000004 RDI: 0000558f1803e9a0
RBP: 0000558f1803e600 R08: 0000000000000007 R09: 0000558f17fab610
R10: d91d5ec34ab757b0 R11: 0000000000000246 R12: 0000000000000001
R13: 0000000000000000 R14: 0000000000000015 R15: 0000000000000000
</TASK>
irq event stamp: 1163486
hardirqs last enabled at (1163485): [<ffffffffac98d344>] \_raw\_spin\_unlock\_irqrestore+0x34/0x60
hardirqs last disabled at (1163486): [<ffffffffac97dcfc>] \_\_schedule+0xc7c/0x19a0
softirqs last enabled at (1163482): [<ffffffffab79a3ee>] \_\_smb\_send\_rqst+0x3de/0x990
softirqs last disabled at (1163480): [<ffffffffac2314f1>] release\_sock+0x21/0xf0
---[ end trace 0000000000000000 ]---
VFS: Busy inodes after unmount of cifs (cifs)
------------[ cut here ]------------
kernel BUG at fs/super.c:661!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 1 UID: 0 PID: 3433 Comm: bash Tainted: G W 6.12.0-rc4-g850925a8133c-dirty #49
Tainted: [W]=WARN
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020
RIP: 0010:generic\_shutdown\_super+0x290/0x2a0
Code: e8 15 7c f7 ff 48 8b 5d 28 48 89 df e8 09 7c f7 ff 48 8b 0b 48 89 ee 48 8d 95 68 06 00 00 48 c7 c7 80 7f db ac e8 00 69 af ff <0f> 0b 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90 90 90 90 90 90
RSP: 0018:ffff88811cc27a50 EFLAGS: 00010246
RAX: 000000000000003e RBX: ffffffffae994420 RCX: 0000000000000027
RDX: 0000000000000000 RSI: ffffffffab06180e RDI: ffff8881f6eb18c8
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed103edd6319
R10: ffff8881f6eb18cb R11: 00000000016d3158 R12: ffff8881462ec9c0
R13: ffff8881462ec050 R14: 0000000000000001 R15: 0000000000000000
FS: 00007f23bfa98740(0000) GS:ffff8881f6e80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8364005d68 CR3: 0000000123c80000 CR4: 0000000000350ef0
Call Trace:
<TASK>
kill\_anon\_super+0x22/0x40
cifs\_kill\_sb+0x159/0x1e0
deactivate\_locked\_super+0x66/0xe0
cleanup\_mnt+0x140/0x210
task\_work\_run+0xfb/0x170
syscall\_exit\_to\_user\_mode+0x29f/0x2b0
do\_syscall\_64+0xa1/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f23bfb93ae7
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
RIP: 0010:generic\_shutdown\_super+0x290/0x2a0
Code: e8 15 7c f7 ff 48 8b 5d 28 48 89 df e8 09 7c f7 ff 48 8b 0b 48 89 ee 48 8d 95 68 06 00 00 48 c7 c7 80 7f db ac e8 00 69 af ff <0f> 0b 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90 90 90 90 90 90
RSP: 0018:ffff88811cc27a50 EFLAGS: 00010246
RAX: 000000000000003e RBX: ffffffffae994420 RCX: 0000000000000027
RDX: 0000000000000000 RSI: ffffffffab06180e RDI: ffff8881f6eb18c8
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed103edd6319
R10: ffff8881f6eb18cb R11: 00000000016d3158 R12: ffff8881462ec9c0
R13: ffff8881462ec050 R14: 0000000000000001 R15: 0000000000000000
FS: 00007f23bfa98740(0000) GS:ffff8881f6e80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8364005d68 CR3: 0000000123c80000 CR4: 0000000000350ef0
This reproduces eventually with an SMB mount and two shells running
these loops concurrently
- while true; do
cd ~; sleep 1;
for i in {1..3}; do cd /mnt/test/subdir;
echo $PWD; sleep 1; cd ..; echo $PWD; sleep 1;
done;
echo ...;
done
- while true; do
iptables -F OUTPUT; mount -t cifs -a;
for \_ in {0..2}; do ls /mnt/test/subdir/ | wc -l; done;
iptables -I OUTPUT -p tcp --dport 445 -j DROP;
sleep 10
echo "unmounting"; umount -l -t cifs -a; echo "done unmounting";
sleep 20
echo "recovering"; iptables -F OUTPUT;
sleep 10;
done
Fixes: ebe98f1447bb ("cifs: enable caching of directories for which a lease is held")
Fixes: 5c86919455c1 ("smb: client: fix use-after-free in smb2\_query\_info\_compound()")
Cc: stable@vger.kernel.org
Signed-off-by: Paul Aurich <paul@darkrain42.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d76332d783db12684b67592f1fb2057b88af4c3)

| -rw-r--r-- | [fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/cached_dir.c?id=1d76332d783db12684b67592f1fb2057b88af4c3) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 13 deletions

| diff --git a/fs/smb/client/cached\_dir.c b/fs/smb/client/cached\_dir.cindex adcba13352045f..bb9d4c284ce577 100644--- a/[fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/cached_dir.c?id=2ae227f8c2793036bcf0c2ff9f34f2b34a74722c)+++ b/[fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/cached_dir.c?id=1d76332d783db12684b67592f1fb2057b88af4c3)@@ -59,6 +59,16 @@ static struct cached\_fid \*find\_or\_create\_cached\_dir(struct cached\_fids \*cfids, list\_add(&cfid->entry, &cfids->entries); cfid->on\_list = true; kref\_get(&cfid->refcount);+ /\*+ \* Set @cfid->has\_lease to true during construction so that the lease+ \* reference can be put in cached\_dir\_lease\_break() due to a potential+ \* lease break right after the request is sent or while @cfid is still+ \* being cached, or if a reconnection is triggered during construction.+ \* Concurrent processes won't be to use it yet due to @cfid->time being+ \* zero.+ \*/+ cfid->has\_lease = true;+ spin\_unlock(&cfids->cfid\_list\_lock); return cfid; }@@ -176,12 +186,12 @@ replay\_again: return -ENOENT; } /\*- \* Return cached fid if it has a lease. Otherwise, it is either a new- \* entry or laundromat worker removed it from @cfids->entries. Caller- \* will put last reference if the latter.+ \* Return cached fid if it is valid (has a lease and has a time).+ \* Otherwise, it is either a new entry or laundromat worker removed it+ \* from @cfids->entries. Caller will put last reference if the latter. \*/ spin\_lock(&cfids->cfid\_list\_lock);- if (cfid->has\_lease) {+ if (cfid->has\_lease && cfid->time) { spin\_unlock(&cfids->cfid\_list\_lock); \*ret\_cfid = cfid; kfree(utf16\_path);@@ -267,15 +277,6 @@ replay\_again:  smb2\_set\_related(&rqst[1]); - /\*- \* Set @cfid->has\_lease to true before sending out compounded request so- \* its lease reference can be put in cached\_dir\_lease\_break() due to a- \* potential lease break right after the request is sent or while @cfid- \* is still being cached. Concurrent processes won't be to use it yet- \* due to @cfid->time being zero.- \*/- cfid->has\_lease = true;- if (retries) { smb2\_set\_replay(server, &rqst[0]); smb2\_set\_replay(server, &rqst[1]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:26:35 +0000



=== Content from git.kernel.org_45c1bbae_20250114_202758.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=31fabf70d58388d5475e48ca8a6b7d2847b36678)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31fabf70d58388d5475e48ca8a6b7d2847b36678)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31fabf70d58388d5475e48ca8a6b7d2847b36678)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31fabf70d58388d5475e48ca8a6b7d2847b36678)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paul Aurich <paul@darkrain42.org> | 2024-11-18 13:50:26 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:52 +0100 |
| commit | [31fabf70d58388d5475e48ca8a6b7d2847b36678](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31fabf70d58388d5475e48ca8a6b7d2847b36678) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=31fabf70d58388d5475e48ca8a6b7d2847b36678)) | |
| tree | [cc4b56e44698803c2c47896d59781c18f0d4ab57](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31fabf70d58388d5475e48ca8a6b7d2847b36678) | |
| parent | [921d90907eb978763e21b9e4ddd4b0ae6629e110](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=921d90907eb978763e21b9e4ddd4b0ae6629e110) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31fabf70d58388d5475e48ca8a6b7d2847b36678&id2=921d90907eb978763e21b9e4ddd4b0ae6629e110)) | |
| download | [linux-31fabf70d58388d5475e48ca8a6b7d2847b36678.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-31fabf70d58388d5475e48ca8a6b7d2847b36678.tar.gz) | |

smb: Don't leak cfid when reconnect races with open\_cached\_dircommit 7afb86733685c64c604d32faf00fa4a1f22c2ab1 upstream.
open\_cached\_dir() may either race with the tcon reconnection even before
compound\_send\_recv() or directly trigger a reconnection via
SMB2\_open\_init() or SMB\_query\_info\_init().
The reconnection process invokes invalidate\_all\_cached\_dirs() via
cifs\_mark\_open\_files\_invalid(), which removes all cfids from the
cfids->entries list but doesn't drop a ref if has\_lease isn't true. This
results in the currently-being-constructed cfid not being on the list,
but still having a refcount of 2. It leaks if returned from
open\_cached\_dir().
Fix this by setting cfid->has\_lease when the ref is actually taken; the
cfid will not be used by other threads until it has a valid time.
Addresses these kmemleaks:
unreferenced object 0xffff8881090c4000 (size 1024):
comm "bash", pid 1860, jiffies 4295126592
hex dump (first 32 bytes):
00 01 00 00 00 00 ad de 22 01 00 00 00 00 ad de ........".......
00 ca 45 22 81 88 ff ff f8 dc 4f 04 81 88 ff ff ..E"......O.....
backtrace (crc 6f58c20f):
[<ffffffff8b895a1e>] \_\_kmalloc\_cache\_noprof+0x2be/0x350
[<ffffffff8bda06e3>] open\_cached\_dir+0x993/0x1fb0
[<ffffffff8bdaa750>] cifs\_readdir+0x15a0/0x1d50
[<ffffffff8b9a853f>] iterate\_dir+0x28f/0x4b0
[<ffffffff8b9a9aed>] \_\_x64\_sys\_getdents64+0xfd/0x200
[<ffffffff8cf6da05>] do\_syscall\_64+0x95/0x1a0
[<ffffffff8d00012f>] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
unreferenced object 0xffff8881044fdcf8 (size 8):
comm "bash", pid 1860, jiffies 4295126592
hex dump (first 8 bytes):
00 cc cc cc cc cc cc cc ........
backtrace (crc 10c106a9):
[<ffffffff8b89a3d3>] \_\_kmalloc\_node\_track\_caller\_noprof+0x363/0x480
[<ffffffff8b7d7256>] kstrdup+0x36/0x60
[<ffffffff8bda0700>] open\_cached\_dir+0x9b0/0x1fb0
[<ffffffff8bdaa750>] cifs\_readdir+0x15a0/0x1d50
[<ffffffff8b9a853f>] iterate\_dir+0x28f/0x4b0
[<ffffffff8b9a9aed>] \_\_x64\_sys\_getdents64+0xfd/0x200
[<ffffffff8cf6da05>] do\_syscall\_64+0x95/0x1a0
[<ffffffff8d00012f>] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
And addresses these BUG splats when unmounting the SMB filesystem:
BUG: Dentry ffff888140590ba0{i=1000000000080,n=/} still in use (2) [unmount of cifs cifs]
WARNING: CPU: 3 PID: 3433 at fs/dcache.c:1536 umount\_check+0xd0/0x100
Modules linked in:
CPU: 3 UID: 0 PID: 3433 Comm: bash Not tainted 6.12.0-rc4-g850925a8133c-dirty #49
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020
RIP: 0010:umount\_check+0xd0/0x100
Code: 8d 7c 24 40 e8 31 5a f4 ff 49 8b 54 24 40 41 56 49 89 e9 45 89 e8 48 89 d9 41 57 48 89 de 48 c7 c7 80 e7 db ac e8 f0 72 9a ff <0f> 0b 58 31 c0 5a 5b 5d 41 5c 41 5d 41 5e 41 5f e9 2b e5 5d 01 41
RSP: 0018:ffff88811cc27978 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff888140590ba0 RCX: ffffffffaaf20bae
RDX: dffffc0000000000 RSI: 0000000000000008 RDI: ffff8881f6fb6f40
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed1023984ee3
R10: ffff88811cc2771f R11: 00000000016cfcc0 R12: ffff888134383e08
R13: 0000000000000002 R14: ffff8881462ec668 R15: ffffffffaceab4c0
FS: 00007f23bfa98740(0000) GS:ffff8881f6f80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000556de4a6f808 CR3: 0000000123c80000 CR4: 0000000000350ef0
Call Trace:
<TASK>
d\_walk+0x6a/0x530
shrink\_dcache\_for\_umount+0x6a/0x200
generic\_shutdown\_super+0x52/0x2a0
kill\_anon\_super+0x22/0x40
cifs\_kill\_sb+0x159/0x1e0
deactivate\_locked\_super+0x66/0xe0
cleanup\_mnt+0x140/0x210
task\_work\_run+0xfb/0x170
syscall\_exit\_to\_user\_mode+0x29f/0x2b0
do\_syscall\_64+0xa1/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f23bfb93ae7
Code: ff ff ff ff c3 66 0f 1f 44 00 00 48 8b 0d 11 93 0d 00 f7 d8 64 89 01 b8 ff ff ff ff eb bf 0f 1f 44 00 00 b8 50 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d e9 92 0d 00 f7 d8 64 89 01 48
RSP: 002b:00007ffee9138598 EFLAGS: 00000246 ORIG\_RAX: 0000000000000050
RAX: 0000000000000000 RBX: 0000558f1803e9a0 RCX: 00007f23bfb93ae7
RDX: 0000000000000000 RSI: 0000000000000004 RDI: 0000558f1803e9a0
RBP: 0000558f1803e600 R08: 0000000000000007 R09: 0000558f17fab610
R10: d91d5ec34ab757b0 R11: 0000000000000246 R12: 0000000000000001
R13: 0000000000000000 R14: 0000000000000015 R15: 0000000000000000
</TASK>
irq event stamp: 1163486
hardirqs last enabled at (1163485): [<ffffffffac98d344>] \_raw\_spin\_unlock\_irqrestore+0x34/0x60
hardirqs last disabled at (1163486): [<ffffffffac97dcfc>] \_\_schedule+0xc7c/0x19a0
softirqs last enabled at (1163482): [<ffffffffab79a3ee>] \_\_smb\_send\_rqst+0x3de/0x990
softirqs last disabled at (1163480): [<ffffffffac2314f1>] release\_sock+0x21/0xf0
---[ end trace 0000000000000000 ]---
VFS: Busy inodes after unmount of cifs (cifs)
------------[ cut here ]------------
kernel BUG at fs/super.c:661!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 1 UID: 0 PID: 3433 Comm: bash Tainted: G W 6.12.0-rc4-g850925a8133c-dirty #49
Tainted: [W]=WARN
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020
RIP: 0010:generic\_shutdown\_super+0x290/0x2a0
Code: e8 15 7c f7 ff 48 8b 5d 28 48 89 df e8 09 7c f7 ff 48 8b 0b 48 89 ee 48 8d 95 68 06 00 00 48 c7 c7 80 7f db ac e8 00 69 af ff <0f> 0b 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90 90 90 90 90 90
RSP: 0018:ffff88811cc27a50 EFLAGS: 00010246
RAX: 000000000000003e RBX: ffffffffae994420 RCX: 0000000000000027
RDX: 0000000000000000 RSI: ffffffffab06180e RDI: ffff8881f6eb18c8
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed103edd6319
R10: ffff8881f6eb18cb R11: 00000000016d3158 R12: ffff8881462ec9c0
R13: ffff8881462ec050 R14: 0000000000000001 R15: 0000000000000000
FS: 00007f23bfa98740(0000) GS:ffff8881f6e80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8364005d68 CR3: 0000000123c80000 CR4: 0000000000350ef0
Call Trace:
<TASK>
kill\_anon\_super+0x22/0x40
cifs\_kill\_sb+0x159/0x1e0
deactivate\_locked\_super+0x66/0xe0
cleanup\_mnt+0x140/0x210
task\_work\_run+0xfb/0x170
syscall\_exit\_to\_user\_mode+0x29f/0x2b0
do\_syscall\_64+0xa1/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f23bfb93ae7
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
RIP: 0010:generic\_shutdown\_super+0x290/0x2a0
Code: e8 15 7c f7 ff 48 8b 5d 28 48 89 df e8 09 7c f7 ff 48 8b 0b 48 89 ee 48 8d 95 68 06 00 00 48 c7 c7 80 7f db ac e8 00 69 af ff <0f> 0b 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90 90 90 90 90 90
RSP: 0018:ffff88811cc27a50 EFLAGS: 00010246
RAX: 000000000000003e RBX: ffffffffae994420 RCX: 0000000000000027
RDX: 0000000000000000 RSI: ffffffffab06180e RDI: ffff8881f6eb18c8
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed103edd6319
R10: ffff8881f6eb18cb R11: 00000000016d3158 R12: ffff8881462ec9c0
R13: ffff8881462ec050 R14: 0000000000000001 R15: 0000000000000000
FS: 00007f23bfa98740(0000) GS:ffff8881f6e80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8364005d68 CR3: 0000000123c80000 CR4: 0000000000350ef0
This reproduces eventually with an SMB mount and two shells running
these loops concurrently
- while true; do
cd ~; sleep 1;
for i in {1..3}; do cd /mnt/test/subdir;
echo $PWD; sleep 1; cd ..; echo $PWD; sleep 1;
done;
echo ...;
done
- while true; do
iptables -F OUTPUT; mount -t cifs -a;
for \_ in {0..2}; do ls /mnt/test/subdir/ | wc -l; done;
iptables -I OUTPUT -p tcp --dport 445 -j DROP;
sleep 10
echo "unmounting"; umount -l -t cifs -a; echo "done unmounting";
sleep 20
echo "recovering"; iptables -F OUTPUT;
sleep 10;
done
Fixes: ebe98f1447bb ("cifs: enable caching of directories for which a lease is held")
Fixes: 5c86919455c1 ("smb: client: fix use-after-free in smb2\_query\_info\_compound()")
Cc: stable@vger.kernel.org
Signed-off-by: Paul Aurich <paul@darkrain42.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31fabf70d58388d5475e48ca8a6b7d2847b36678)

| -rw-r--r-- | [fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/cached_dir.c?id=31fabf70d58388d5475e48ca8a6b7d2847b36678) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 13 deletions

| diff --git a/fs/smb/client/cached\_dir.c b/fs/smb/client/cached\_dir.cindex adcba13352045f..bb9d4c284ce577 100644--- a/[fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/cached_dir.c?id=921d90907eb978763e21b9e4ddd4b0ae6629e110)+++ b/[fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/cached_dir.c?id=31fabf70d58388d5475e48ca8a6b7d2847b36678)@@ -59,6 +59,16 @@ static struct cached\_fid \*find\_or\_create\_cached\_dir(struct cached\_fids \*cfids, list\_add(&cfid->entry, &cfids->entries); cfid->on\_list = true; kref\_get(&cfid->refcount);+ /\*+ \* Set @cfid->has\_lease to true during construction so that the lease+ \* reference can be put in cached\_dir\_lease\_break() due to a potential+ \* lease break right after the request is sent or while @cfid is still+ \* being cached, or if a reconnection is triggered during construction.+ \* Concurrent processes won't be to use it yet due to @cfid->time being+ \* zero.+ \*/+ cfid->has\_lease = true;+ spin\_unlock(&cfids->cfid\_list\_lock); return cfid; }@@ -176,12 +186,12 @@ replay\_again: return -ENOENT; } /\*- \* Return cached fid if it has a lease. Otherwise, it is either a new- \* entry or laundromat worker removed it from @cfids->entries. Caller- \* will put last reference if the latter.+ \* Return cached fid if it is valid (has a lease and has a time).+ \* Otherwise, it is either a new entry or laundromat worker removed it+ \* from @cfids->entries. Caller will put last reference if the latter. \*/ spin\_lock(&cfids->cfid\_list\_lock);- if (cfid->has\_lease) {+ if (cfid->has\_lease && cfid->time) { spin\_unlock(&cfids->cfid\_list\_lock); \*ret\_cfid = cfid; kfree(utf16\_path);@@ -267,15 +277,6 @@ replay\_again:  smb2\_set\_related(&rqst[1]); - /\*- \* Set @cfid->has\_lease to true before sending out compounded request so- \* its lease reference can be put in cached\_dir\_lease\_break() due to a- \* potential lease break right after the request is sent or while @cfid- \* is still being cached. Concurrent processes won't be to use it yet- \* due to @cfid->time being zero.- \*/- cfid->has\_lease = true;- if (retries) { smb2\_set\_replay(server, &rqst[0]); smb2\_set\_replay(server, &rqst[1]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:26:36 +0000



=== Content from git.kernel.org_454d16ec_20250114_202759.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=73a57b25b4df23f22814fc06b7e8f9cf570be026)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73a57b25b4df23f22814fc06b7e8f9cf570be026)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73a57b25b4df23f22814fc06b7e8f9cf570be026)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73a57b25b4df23f22814fc06b7e8f9cf570be026)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paul Aurich <paul@darkrain42.org> | 2024-11-18 13:50:26 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:59 +0100 |
| commit | [73a57b25b4df23f22814fc06b7e8f9cf570be026](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73a57b25b4df23f22814fc06b7e8f9cf570be026) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=73a57b25b4df23f22814fc06b7e8f9cf570be026)) | |
| tree | [9dc04c5bffdd341877c31653355571c710eaf281](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73a57b25b4df23f22814fc06b7e8f9cf570be026) | |
| parent | [86be153441abf705da11dddcacdb2818fb160f5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86be153441abf705da11dddcacdb2818fb160f5d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73a57b25b4df23f22814fc06b7e8f9cf570be026&id2=86be153441abf705da11dddcacdb2818fb160f5d)) | |
| download | [linux-73a57b25b4df23f22814fc06b7e8f9cf570be026.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-73a57b25b4df23f22814fc06b7e8f9cf570be026.tar.gz) | |

smb: Don't leak cfid when reconnect races with open\_cached\_dircommit 7afb86733685c64c604d32faf00fa4a1f22c2ab1 upstream.
open\_cached\_dir() may either race with the tcon reconnection even before
compound\_send\_recv() or directly trigger a reconnection via
SMB2\_open\_init() or SMB\_query\_info\_init().
The reconnection process invokes invalidate\_all\_cached\_dirs() via
cifs\_mark\_open\_files\_invalid(), which removes all cfids from the
cfids->entries list but doesn't drop a ref if has\_lease isn't true. This
results in the currently-being-constructed cfid not being on the list,
but still having a refcount of 2. It leaks if returned from
open\_cached\_dir().
Fix this by setting cfid->has\_lease when the ref is actually taken; the
cfid will not be used by other threads until it has a valid time.
Addresses these kmemleaks:
unreferenced object 0xffff8881090c4000 (size 1024):
comm "bash", pid 1860, jiffies 4295126592
hex dump (first 32 bytes):
00 01 00 00 00 00 ad de 22 01 00 00 00 00 ad de ........".......
00 ca 45 22 81 88 ff ff f8 dc 4f 04 81 88 ff ff ..E"......O.....
backtrace (crc 6f58c20f):
[<ffffffff8b895a1e>] \_\_kmalloc\_cache\_noprof+0x2be/0x350
[<ffffffff8bda06e3>] open\_cached\_dir+0x993/0x1fb0
[<ffffffff8bdaa750>] cifs\_readdir+0x15a0/0x1d50
[<ffffffff8b9a853f>] iterate\_dir+0x28f/0x4b0
[<ffffffff8b9a9aed>] \_\_x64\_sys\_getdents64+0xfd/0x200
[<ffffffff8cf6da05>] do\_syscall\_64+0x95/0x1a0
[<ffffffff8d00012f>] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
unreferenced object 0xffff8881044fdcf8 (size 8):
comm "bash", pid 1860, jiffies 4295126592
hex dump (first 8 bytes):
00 cc cc cc cc cc cc cc ........
backtrace (crc 10c106a9):
[<ffffffff8b89a3d3>] \_\_kmalloc\_node\_track\_caller\_noprof+0x363/0x480
[<ffffffff8b7d7256>] kstrdup+0x36/0x60
[<ffffffff8bda0700>] open\_cached\_dir+0x9b0/0x1fb0
[<ffffffff8bdaa750>] cifs\_readdir+0x15a0/0x1d50
[<ffffffff8b9a853f>] iterate\_dir+0x28f/0x4b0
[<ffffffff8b9a9aed>] \_\_x64\_sys\_getdents64+0xfd/0x200
[<ffffffff8cf6da05>] do\_syscall\_64+0x95/0x1a0
[<ffffffff8d00012f>] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
And addresses these BUG splats when unmounting the SMB filesystem:
BUG: Dentry ffff888140590ba0{i=1000000000080,n=/} still in use (2) [unmount of cifs cifs]
WARNING: CPU: 3 PID: 3433 at fs/dcache.c:1536 umount\_check+0xd0/0x100
Modules linked in:
CPU: 3 UID: 0 PID: 3433 Comm: bash Not tainted 6.12.0-rc4-g850925a8133c-dirty #49
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020
RIP: 0010:umount\_check+0xd0/0x100
Code: 8d 7c 24 40 e8 31 5a f4 ff 49 8b 54 24 40 41 56 49 89 e9 45 89 e8 48 89 d9 41 57 48 89 de 48 c7 c7 80 e7 db ac e8 f0 72 9a ff <0f> 0b 58 31 c0 5a 5b 5d 41 5c 41 5d 41 5e 41 5f e9 2b e5 5d 01 41
RSP: 0018:ffff88811cc27978 EFLAGS: 00010286
RAX: 0000000000000000 RBX: ffff888140590ba0 RCX: ffffffffaaf20bae
RDX: dffffc0000000000 RSI: 0000000000000008 RDI: ffff8881f6fb6f40
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed1023984ee3
R10: ffff88811cc2771f R11: 00000000016cfcc0 R12: ffff888134383e08
R13: 0000000000000002 R14: ffff8881462ec668 R15: ffffffffaceab4c0
FS: 00007f23bfa98740(0000) GS:ffff8881f6f80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000556de4a6f808 CR3: 0000000123c80000 CR4: 0000000000350ef0
Call Trace:
<TASK>
d\_walk+0x6a/0x530
shrink\_dcache\_for\_umount+0x6a/0x200
generic\_shutdown\_super+0x52/0x2a0
kill\_anon\_super+0x22/0x40
cifs\_kill\_sb+0x159/0x1e0
deactivate\_locked\_super+0x66/0xe0
cleanup\_mnt+0x140/0x210
task\_work\_run+0xfb/0x170
syscall\_exit\_to\_user\_mode+0x29f/0x2b0
do\_syscall\_64+0xa1/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f23bfb93ae7
Code: ff ff ff ff c3 66 0f 1f 44 00 00 48 8b 0d 11 93 0d 00 f7 d8 64 89 01 b8 ff ff ff ff eb bf 0f 1f 44 00 00 b8 50 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d e9 92 0d 00 f7 d8 64 89 01 48
RSP: 002b:00007ffee9138598 EFLAGS: 00000246 ORIG\_RAX: 0000000000000050
RAX: 0000000000000000 RBX: 0000558f1803e9a0 RCX: 00007f23bfb93ae7
RDX: 0000000000000000 RSI: 0000000000000004 RDI: 0000558f1803e9a0
RBP: 0000558f1803e600 R08: 0000000000000007 R09: 0000558f17fab610
R10: d91d5ec34ab757b0 R11: 0000000000000246 R12: 0000000000000001
R13: 0000000000000000 R14: 0000000000000015 R15: 0000000000000000
</TASK>
irq event stamp: 1163486
hardirqs last enabled at (1163485): [<ffffffffac98d344>] \_raw\_spin\_unlock\_irqrestore+0x34/0x60
hardirqs last disabled at (1163486): [<ffffffffac97dcfc>] \_\_schedule+0xc7c/0x19a0
softirqs last enabled at (1163482): [<ffffffffab79a3ee>] \_\_smb\_send\_rqst+0x3de/0x990
softirqs last disabled at (1163480): [<ffffffffac2314f1>] release\_sock+0x21/0xf0
---[ end trace 0000000000000000 ]---
VFS: Busy inodes after unmount of cifs (cifs)
------------[ cut here ]------------
kernel BUG at fs/super.c:661!
Oops: invalid opcode: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 1 UID: 0 PID: 3433 Comm: bash Tainted: G W 6.12.0-rc4-g850925a8133c-dirty #49
Tainted: [W]=WARN
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020
RIP: 0010:generic\_shutdown\_super+0x290/0x2a0
Code: e8 15 7c f7 ff 48 8b 5d 28 48 89 df e8 09 7c f7 ff 48 8b 0b 48 89 ee 48 8d 95 68 06 00 00 48 c7 c7 80 7f db ac e8 00 69 af ff <0f> 0b 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90 90 90 90 90 90
RSP: 0018:ffff88811cc27a50 EFLAGS: 00010246
RAX: 000000000000003e RBX: ffffffffae994420 RCX: 0000000000000027
RDX: 0000000000000000 RSI: ffffffffab06180e RDI: ffff8881f6eb18c8
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed103edd6319
R10: ffff8881f6eb18cb R11: 00000000016d3158 R12: ffff8881462ec9c0
R13: ffff8881462ec050 R14: 0000000000000001 R15: 0000000000000000
FS: 00007f23bfa98740(0000) GS:ffff8881f6e80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8364005d68 CR3: 0000000123c80000 CR4: 0000000000350ef0
Call Trace:
<TASK>
kill\_anon\_super+0x22/0x40
cifs\_kill\_sb+0x159/0x1e0
deactivate\_locked\_super+0x66/0xe0
cleanup\_mnt+0x140/0x210
task\_work\_run+0xfb/0x170
syscall\_exit\_to\_user\_mode+0x29f/0x2b0
do\_syscall\_64+0xa1/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f23bfb93ae7
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
RIP: 0010:generic\_shutdown\_super+0x290/0x2a0
Code: e8 15 7c f7 ff 48 8b 5d 28 48 89 df e8 09 7c f7 ff 48 8b 0b 48 89 ee 48 8d 95 68 06 00 00 48 c7 c7 80 7f db ac e8 00 69 af ff <0f> 0b 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 00 90 90 90 90 90 90
RSP: 0018:ffff88811cc27a50 EFLAGS: 00010246
RAX: 000000000000003e RBX: ffffffffae994420 RCX: 0000000000000027
RDX: 0000000000000000 RSI: ffffffffab06180e RDI: ffff8881f6eb18c8
RBP: ffff8881462ec000 R08: 0000000000000001 R09: ffffed103edd6319
R10: ffff8881f6eb18cb R11: 00000000016d3158 R12: ffff8881462ec9c0
R13: ffff8881462ec050 R14: 0000000000000001 R15: 0000000000000000
FS: 00007f23bfa98740(0000) GS:ffff8881f6e80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f8364005d68 CR3: 0000000123c80000 CR4: 0000000000350ef0
This reproduces eventually with an SMB mount and two shells running
these loops concurrently
- while true; do
cd ~; sleep 1;
for i in {1..3}; do cd /mnt/test/subdir;
echo $PWD; sleep 1; cd ..; echo $PWD; sleep 1;
done;
echo ...;
done
- while true; do
iptables -F OUTPUT; mount -t cifs -a;
for \_ in {0..2}; do ls /mnt/test/subdir/ | wc -l; done;
iptables -I OUTPUT -p tcp --dport 445 -j DROP;
sleep 10
echo "unmounting"; umount -l -t cifs -a; echo "done unmounting";
sleep 20
echo "recovering"; iptables -F OUTPUT;
sleep 10;
done
Fixes: ebe98f1447bb ("cifs: enable caching of directories for which a lease is held")
Fixes: 5c86919455c1 ("smb: client: fix use-after-free in smb2\_query\_info\_compound()")
Cc: stable@vger.kernel.org
Signed-off-by: Paul Aurich <paul@darkrain42.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73a57b25b4df23f22814fc06b7e8f9cf570be026)

| -rw-r--r-- | [fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/cached_dir.c?id=73a57b25b4df23f22814fc06b7e8f9cf570be026) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 13 deletions

| diff --git a/fs/smb/client/cached\_dir.c b/fs/smb/client/cached\_dir.cindex adcba13352045f..bb9d4c284ce577 100644--- a/[fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/cached_dir.c?id=86be153441abf705da11dddcacdb2818fb160f5d)+++ b/[fs/smb/client/cached\_dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/cached_dir.c?id=73a57b25b4df23f22814fc06b7e8f9cf570be026)@@ -59,6 +59,16 @@ static struct cached\_fid \*find\_or\_create\_cached\_dir(struct cached\_fids \*cfids, list\_add(&cfid->entry, &cfids->entries); cfid->on\_list = true; kref\_get(&cfid->refcount);+ /\*+ \* Set @cfid->has\_lease to true during construction so that the lease+ \* reference can be put in cached\_dir\_lease\_break() due to a potential+ \* lease break right after the request is sent or while @cfid is still+ \* being cached, or if a reconnection is triggered during construction.+ \* Concurrent processes won't be to use it yet due to @cfid->time being+ \* zero.+ \*/+ cfid->has\_lease = true;+ spin\_unlock(&cfids->cfid\_list\_lock); return cfid; }@@ -176,12 +186,12 @@ replay\_again: return -ENOENT; } /\*- \* Return cached fid if it has a lease. Otherwise, it is either a new- \* entry or laundromat worker removed it from @cfids->entries. Caller- \* will put last reference if the latter.+ \* Return cached fid if it is valid (has a lease and has a time).+ \* Otherwise, it is either a new entry or laundromat worker removed it+ \* from @cfids->entries. Caller will put last reference if the latter. \*/ spin\_lock(&cfids->cfid\_list\_lock);- if (cfid->has\_lease) {+ if (cfid->has\_lease && cfid->time) { spin\_unlock(&cfids->cfid\_list\_lock); \*ret\_cfid = cfid; kfree(utf16\_path);@@ -267,15 +277,6 @@ replay\_again:  smb2\_set\_related(&rqst[1]); - /\*- \* Set @cfid->has\_lease to true before sending out compounded request so- \* its lease reference can be put in cached\_dir\_lease\_break() due to a- \* potential lease break right after the request is sent or while @cfid- \* is still being cached. Concurrent processes won't be to use it yet- \* due to @cfid->time being zero.- \*/- cfid->has\_lease = true;- if (retries) { smb2\_set\_replay(server, &rqst[0]); smb2\_set\_replay(server, &rqst[1]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:26:36 +0000


