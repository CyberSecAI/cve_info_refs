=== Content from git.kernel.org_2822b4b1_20250115_093515.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ef7134c7fc48e1441b398e55a862232868a6f0a7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef7134c7fc48e1441b398e55a862232868a6f0a7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef7134c7fc48e1441b398e55a862232868a6f0a7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef7134c7fc48e1441b398e55a862232868a6f0a7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-11-02 14:24:38 -0700 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-11-03 19:28:31 -0600 |
| commit | [ef7134c7fc48e1441b398e55a862232868a6f0a7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef7134c7fc48e1441b398e55a862232868a6f0a7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ef7134c7fc48e1441b398e55a862232868a6f0a7)) | |
| tree | [f0a25d9737ffe7e2570e4c646b367915d14bd77d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef7134c7fc48e1441b398e55a862232868a6f0a7) | |
| parent | [59b723cd2adbac2a34fc8e12c74ae26ae45bf230](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59b723cd2adbac2a34fc8e12c74ae26ae45bf230) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef7134c7fc48e1441b398e55a862232868a6f0a7&id2=59b723cd2adbac2a34fc8e12c74ae26ae45bf230)) | |
| download | [linux-ef7134c7fc48e1441b398e55a862232868a6f0a7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ef7134c7fc48e1441b398e55a862232868a6f0a7.tar.gz) | |

smb: client: Fix use-after-free of network namespace.Recently, we got a customer report that CIFS triggers oops while
reconnecting to a server. [0]
The workload runs on Kubernetes, and some pods mount CIFS servers
in non-root network namespaces. The problem rarely happened, but
it was always while the pod was dying.
The root cause is wrong reference counting for network namespace.
CIFS uses kernel sockets, which do not hold refcnt of the netns that
the socket belongs to. That means CIFS must ensure the socket is
always freed before its netns; otherwise, use-after-free happens.
The repro steps are roughly:
1. mount CIFS in a non-root netns
2. drop packets from the netns
3. destroy the netns
4. unmount CIFS
We can reproduce the issue quickly with the script [1] below and see
the splat [2] if CONFIG\_NET\_NS\_REFCNT\_TRACKER is enabled.
When the socket is TCP, it is hard to guarantee the netns lifetime
without holding refcnt due to async timers.
Let's hold netns refcnt for each socket as done for SMC in commit
9744d2bf1976 ("smc: Fix use-after-free in tcp\_write\_timer\_handler().").
Note that we need to move put\_net() from cifs\_put\_tcp\_session() to
clean\_demultiplex\_info(); otherwise, \_\_sock\_create() still could touch a
freed netns while cifsd tries to reconnect from cifs\_demultiplex\_thread().
Also, maybe\_get\_net() cannot be put just before \_\_sock\_create() because
the code is not under RCU and there is a small chance that the same
address happened to be reallocated to another netns.
[0]:
CIFS: VFS: \\XXXXXXXXXXX has not responded in 15 seconds. Reconnecting...
CIFS: Serverclose failed 4 times, giving up
Unable to handle kernel paging request at virtual address 14de99e461f84a07
Mem abort info:
ESR = 0x0000000096000004
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
FSC = 0x04: level 0 translation fault
Data abort info:
ISV = 0, ISS = 0x00000004
CM = 0, WnR = 0
[14de99e461f84a07] address between user and kernel address ranges
Internal error: Oops: 0000000096000004 [#1] SMP
Modules linked in: cls\_bpf sch\_ingress nls\_utf8 cifs cifs\_arc4 cifs\_md4 dns\_resolver tcp\_diag inet\_diag veth xt\_state xt\_connmark nf\_conntrack\_netlink xt\_nat xt\_statistic xt\_MASQUERADE xt\_mark xt\_addrtype ipt\_REJECT nf\_reject\_ipv4 nft\_chain\_nat nf\_nat xt\_conntrack nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 xt\_comment nft\_compat nf\_tables nfnetlink overlay nls\_ascii nls\_cp437 sunrpc vfat fat aes\_ce\_blk aes\_ce\_cipher ghash\_ce sm4\_ce\_cipher sm4 sm3\_ce sm3 sha3\_ce sha512\_ce sha512\_arm64 sha1\_ce ena button sch\_fq\_codel loop fuse configfs dmi\_sysfs sha2\_ce sha256\_arm64 dm\_mirror dm\_region\_hash dm\_log dm\_mod dax efivarfs
CPU: 5 PID: 2690970 Comm: cifsd Not tainted 6.1.103-109.184.amzn2023.aarch64 #1
Hardware name: Amazon EC2 r7g.4xlarge/, BIOS 1.0 11/1/2018
pstate: 00400005 (nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : fib\_rules\_lookup+0x44/0x238
lr : \_\_fib\_lookup+0x64/0xbc
sp : ffff8000265db790
x29: ffff8000265db790 x28: 0000000000000000 x27: 000000000000bd01
x26: 0000000000000000 x25: ffff000b4baf8000 x24: ffff00047b5e4580
x23: ffff8000265db7e0 x22: 0000000000000000 x21: ffff00047b5e4500
x20: ffff0010e3f694f8 x19: 14de99e461f849f7 x18: 0000000000000000
x17: 0000000000000000 x16: 0000000000000000 x15: 0000000000000000
x14: 0000000000000000 x13: 0000000000000000 x12: 3f92800abd010002
x11: 0000000000000001 x10: ffff0010e3f69420 x9 : ffff800008a6f294
x8 : 0000000000000000 x7 : 0000000000000006 x6 : 0000000000000000
x5 : 0000000000000001 x4 : ffff001924354280 x3 : ffff8000265db7e0
x2 : 0000000000000000 x1 : ffff0010e3f694f8 x0 : ffff00047b5e4500
Call trace:
fib\_rules\_lookup+0x44/0x238
\_\_fib\_lookup+0x64/0xbc
ip\_route\_output\_key\_hash\_rcu+0x2c4/0x398
ip\_route\_output\_key\_hash+0x60/0x8c
tcp\_v4\_connect+0x290/0x488
\_\_inet\_stream\_connect+0x108/0x3d0
inet\_stream\_connect+0x50/0x78
kernel\_connect+0x6c/0xac
generic\_ip\_connect+0x10c/0x6c8 [cifs]
\_\_reconnect\_target\_unlocked+0xa0/0x214 [cifs]
reconnect\_dfs\_server+0x144/0x460 [cifs]
cifs\_reconnect+0x88/0x148 [cifs]
cifs\_readv\_from\_socket+0x230/0x430 [cifs]
cifs\_read\_from\_socket+0x74/0xa8 [cifs]
cifs\_demultiplex\_thread+0xf8/0x704 [cifs]
kthread+0xd0/0xd4
Code: aa0003f8 f8480f13 eb18027f 540006c0 (b9401264)
[1]:
CIFS\_CRED="/root/cred.cifs"
CIFS\_USER="Administrator"
CIFS\_PASS="Password"
CIFS\_IP="X.X.X.X"
CIFS\_PATH="//${CIFS\_IP}/Users/Administrator/Desktop/CIFS\_TEST"
CIFS\_MNT="/mnt/smb"
DEV="enp0s3"
cat <<EOF > ${CIFS\_CRED}
username=${CIFS\_USER}
password=${CIFS\_PASS}
domain=EXAMPLE.COM
EOF
unshare -n bash -c "
mkdir -p ${CIFS\_MNT}
ip netns attach root 1
ip link add eth0 type veth peer veth0 netns root
ip link set eth0 up
ip -n root link set veth0 up
ip addr add 192.168.0.2/24 dev eth0
ip -n root addr add 192.168.0.1/24 dev veth0
ip route add default via 192.168.0.1 dev eth0
ip netns exec root sysctl net.ipv4.ip\_forward=1
ip netns exec root iptables -t nat -A POSTROUTING -s 192.168.0.2 -o ${DEV} -j MASQUERADE
mount -t cifs ${CIFS\_PATH} ${CIFS\_MNT} -o vers=3.0,sec=ntlmssp,credentials=${CIFS\_CRED},rsize=65536,wsize=65536,cache=none,echo\_interval=1
touch ${CIFS\_MNT}/a.txt
ip netns exec root iptables -t nat -D POSTROUTING -s 192.168.0.2 -o ${DEV} -j MASQUERADE
"
umount ${CIFS\_MNT}
[2]:
ref\_tracker: net notrefcnt@000000004bbc008d has 1/1 users at
sk\_alloc (./include/net/net\_namespace.h:339 net/core/sock.c:2227)
inet\_create (net/ipv4/af\_inet.c:326 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1576)
generic\_ip\_connect (fs/smb/client/connect.c:3075)
cifs\_get\_tcp\_session.part.0 (fs/smb/client/connect.c:3160 fs/smb/client/connect.c:1798)
cifs\_mount\_get\_session (fs/smb/client/trace.h:959 fs/smb/client/connect.c:3366)
dfs\_mount\_share (fs/smb/client/dfs.c:63 fs/smb/client/dfs.c:285)
cifs\_mount (fs/smb/client/connect.c:3622)
cifs\_smb3\_do\_mount (fs/smb/client/cifsfs.c:949)
smb3\_get\_tree (fs/smb/client/fs\_context.c:784 fs/smb/client/fs\_context.c:802 fs/smb/client/fs\_context.c:794)
vfs\_get\_tree (fs/super.c:1800)
path\_mount (fs/namespace.c:3508 fs/namespace.c:3834)
\_\_x64\_sys\_mount (fs/namespace.c:3848 fs/namespace.c:4057 fs/namespace.c:4034 fs/namespace.c:4034)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Acked-by: Tom Talpey <tom@talpey.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef7134c7fc48e1441b398e55a862232868a6f0a7)

| -rw-r--r-- | [fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/connect.c?id=ef7134c7fc48e1441b398e55a862232868a6f0a7) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 3 deletions

| diff --git a/fs/smb/client/connect.c b/fs/smb/client/connect.cindex 15d94ac4095ea8..0ce2d704b1f3f8 100644--- a/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=59b723cd2adbac2a34fc8e12c74ae26ae45bf230)+++ b/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=ef7134c7fc48e1441b398e55a862232868a6f0a7)@@ -1037,6 +1037,7 @@ clean\_demultiplex\_info(struct TCP\_Server\_Info \*server) \*/ } + put\_net(cifs\_net\_ns(server)); kfree(server->leaf\_fullpath); kfree(server); @@ -1635,8 +1636,6 @@ cifs\_put\_tcp\_session(struct TCP\_Server\_Info \*server, int from\_reconnect) /\* srv\_count can never go negative \*/ WARN\_ON(server->srv\_count < 0); - put\_net(cifs\_net\_ns(server));- list\_del\_init(&server->tcp\_ses\_list); spin\_unlock(&cifs\_tcp\_ses\_lock); @@ -3070,13 +3069,22 @@ generic\_ip\_connect(struct TCP\_Server\_Info \*server) if (server->ssocket) { socket = server->ssocket; } else {- rc = \_\_sock\_create(cifs\_net\_ns(server), sfamily, SOCK\_STREAM,+ struct net \*net = cifs\_net\_ns(server);+ struct sock \*sk;++ rc = \_\_sock\_create(net, sfamily, SOCK\_STREAM, IPPROTO\_TCP, &server->ssocket, 1); if (rc < 0) { cifs\_server\_dbg(VFS, "Error %d creating socket\n", rc); return rc; } + sk = server->ssocket->sk;+ \_\_netns\_tracker\_free(net, &sk->ns\_tracker, false);+ sk->sk\_net\_refcnt = 1;+ get\_net\_track(net, &sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(net, 1);+ /\* BB other socket options to set KEEPALIVE, NODELAY? \*/ cifs\_dbg(FYI, "Socket created\n"); socket = server->ssocket; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:33:53 +0000



=== Content from git.kernel.org_3c11d731_20250115_093514.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c7f9282fc27fc36dbaffc8527c723de264a132f8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7f9282fc27fc36dbaffc8527c723de264a132f8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7f9282fc27fc36dbaffc8527c723de264a132f8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7f9282fc27fc36dbaffc8527c723de264a132f8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-11-02 14:24:38 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 15:09:50 +0100 |
| commit | [c7f9282fc27fc36dbaffc8527c723de264a132f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7f9282fc27fc36dbaffc8527c723de264a132f8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c7f9282fc27fc36dbaffc8527c723de264a132f8)) | |
| tree | [691b6155e2a5e8f7717b64765bfe3a4d6e663746](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7f9282fc27fc36dbaffc8527c723de264a132f8) | |
| parent | [f0c5b21ac4e630f35b9a29268a0f712501d4ffac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0c5b21ac4e630f35b9a29268a0f712501d4ffac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7f9282fc27fc36dbaffc8527c723de264a132f8&id2=f0c5b21ac4e630f35b9a29268a0f712501d4ffac)) | |
| download | [linux-c7f9282fc27fc36dbaffc8527c723de264a132f8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c7f9282fc27fc36dbaffc8527c723de264a132f8.tar.gz) | |

smb: client: Fix use-after-free of network namespace.[ Upstream commit ef7134c7fc48e1441b398e55a862232868a6f0a7 ]
Recently, we got a customer report that CIFS triggers oops while
reconnecting to a server. [0]
The workload runs on Kubernetes, and some pods mount CIFS servers
in non-root network namespaces. The problem rarely happened, but
it was always while the pod was dying.
The root cause is wrong reference counting for network namespace.
CIFS uses kernel sockets, which do not hold refcnt of the netns that
the socket belongs to. That means CIFS must ensure the socket is
always freed before its netns; otherwise, use-after-free happens.
The repro steps are roughly:
1. mount CIFS in a non-root netns
2. drop packets from the netns
3. destroy the netns
4. unmount CIFS
We can reproduce the issue quickly with the script [1] below and see
the splat [2] if CONFIG\_NET\_NS\_REFCNT\_TRACKER is enabled.
When the socket is TCP, it is hard to guarantee the netns lifetime
without holding refcnt due to async timers.
Let's hold netns refcnt for each socket as done for SMC in commit
9744d2bf1976 ("smc: Fix use-after-free in tcp\_write\_timer\_handler().").
Note that we need to move put\_net() from cifs\_put\_tcp\_session() to
clean\_demultiplex\_info(); otherwise, \_\_sock\_create() still could touch a
freed netns while cifsd tries to reconnect from cifs\_demultiplex\_thread().
Also, maybe\_get\_net() cannot be put just before \_\_sock\_create() because
the code is not under RCU and there is a small chance that the same
address happened to be reallocated to another netns.
[0]:
CIFS: VFS: \\XXXXXXXXXXX has not responded in 15 seconds. Reconnecting...
CIFS: Serverclose failed 4 times, giving up
Unable to handle kernel paging request at virtual address 14de99e461f84a07
Mem abort info:
ESR = 0x0000000096000004
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
FSC = 0x04: level 0 translation fault
Data abort info:
ISV = 0, ISS = 0x00000004
CM = 0, WnR = 0
[14de99e461f84a07] address between user and kernel address ranges
Internal error: Oops: 0000000096000004 [#1] SMP
Modules linked in: cls\_bpf sch\_ingress nls\_utf8 cifs cifs\_arc4 cifs\_md4 dns\_resolver tcp\_diag inet\_diag veth xt\_state xt\_connmark nf\_conntrack\_netlink xt\_nat xt\_statistic xt\_MASQUERADE xt\_mark xt\_addrtype ipt\_REJECT nf\_reject\_ipv4 nft\_chain\_nat nf\_nat xt\_conntrack nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 xt\_comment nft\_compat nf\_tables nfnetlink overlay nls\_ascii nls\_cp437 sunrpc vfat fat aes\_ce\_blk aes\_ce\_cipher ghash\_ce sm4\_ce\_cipher sm4 sm3\_ce sm3 sha3\_ce sha512\_ce sha512\_arm64 sha1\_ce ena button sch\_fq\_codel loop fuse configfs dmi\_sysfs sha2\_ce sha256\_arm64 dm\_mirror dm\_region\_hash dm\_log dm\_mod dax efivarfs
CPU: 5 PID: 2690970 Comm: cifsd Not tainted 6.1.103-109.184.amzn2023.aarch64 #1
Hardware name: Amazon EC2 r7g.4xlarge/, BIOS 1.0 11/1/2018
pstate: 00400005 (nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : fib\_rules\_lookup+0x44/0x238
lr : \_\_fib\_lookup+0x64/0xbc
sp : ffff8000265db790
x29: ffff8000265db790 x28: 0000000000000000 x27: 000000000000bd01
x26: 0000000000000000 x25: ffff000b4baf8000 x24: ffff00047b5e4580
x23: ffff8000265db7e0 x22: 0000000000000000 x21: ffff00047b5e4500
x20: ffff0010e3f694f8 x19: 14de99e461f849f7 x18: 0000000000000000
x17: 0000000000000000 x16: 0000000000000000 x15: 0000000000000000
x14: 0000000000000000 x13: 0000000000000000 x12: 3f92800abd010002
x11: 0000000000000001 x10: ffff0010e3f69420 x9 : ffff800008a6f294
x8 : 0000000000000000 x7 : 0000000000000006 x6 : 0000000000000000
x5 : 0000000000000001 x4 : ffff001924354280 x3 : ffff8000265db7e0
x2 : 0000000000000000 x1 : ffff0010e3f694f8 x0 : ffff00047b5e4500
Call trace:
fib\_rules\_lookup+0x44/0x238
\_\_fib\_lookup+0x64/0xbc
ip\_route\_output\_key\_hash\_rcu+0x2c4/0x398
ip\_route\_output\_key\_hash+0x60/0x8c
tcp\_v4\_connect+0x290/0x488
\_\_inet\_stream\_connect+0x108/0x3d0
inet\_stream\_connect+0x50/0x78
kernel\_connect+0x6c/0xac
generic\_ip\_connect+0x10c/0x6c8 [cifs]
\_\_reconnect\_target\_unlocked+0xa0/0x214 [cifs]
reconnect\_dfs\_server+0x144/0x460 [cifs]
cifs\_reconnect+0x88/0x148 [cifs]
cifs\_readv\_from\_socket+0x230/0x430 [cifs]
cifs\_read\_from\_socket+0x74/0xa8 [cifs]
cifs\_demultiplex\_thread+0xf8/0x704 [cifs]
kthread+0xd0/0xd4
Code: aa0003f8 f8480f13 eb18027f 540006c0 (b9401264)
[1]:
CIFS\_CRED="/root/cred.cifs"
CIFS\_USER="Administrator"
CIFS\_PASS="Password"
CIFS\_IP="X.X.X.X"
CIFS\_PATH="//${CIFS\_IP}/Users/Administrator/Desktop/CIFS\_TEST"
CIFS\_MNT="/mnt/smb"
DEV="enp0s3"
cat <<EOF > ${CIFS\_CRED}
username=${CIFS\_USER}
password=${CIFS\_PASS}
domain=EXAMPLE.COM
EOF
unshare -n bash -c "
mkdir -p ${CIFS\_MNT}
ip netns attach root 1
ip link add eth0 type veth peer veth0 netns root
ip link set eth0 up
ip -n root link set veth0 up
ip addr add 192.168.0.2/24 dev eth0
ip -n root addr add 192.168.0.1/24 dev veth0
ip route add default via 192.168.0.1 dev eth0
ip netns exec root sysctl net.ipv4.ip\_forward=1
ip netns exec root iptables -t nat -A POSTROUTING -s 192.168.0.2 -o ${DEV} -j MASQUERADE
mount -t cifs ${CIFS\_PATH} ${CIFS\_MNT} -o vers=3.0,sec=ntlmssp,credentials=${CIFS\_CRED},rsize=65536,wsize=65536,cache=none,echo\_interval=1
touch ${CIFS\_MNT}/a.txt
ip netns exec root iptables -t nat -D POSTROUTING -s 192.168.0.2 -o ${DEV} -j MASQUERADE
"
umount ${CIFS\_MNT}
[2]:
ref\_tracker: net notrefcnt@000000004bbc008d has 1/1 users at
sk\_alloc (./include/net/net\_namespace.h:339 net/core/sock.c:2227)
inet\_create (net/ipv4/af\_inet.c:326 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1576)
generic\_ip\_connect (fs/smb/client/connect.c:3075)
cifs\_get\_tcp\_session.part.0 (fs/smb/client/connect.c:3160 fs/smb/client/connect.c:1798)
cifs\_mount\_get\_session (fs/smb/client/trace.h:959 fs/smb/client/connect.c:3366)
dfs\_mount\_share (fs/smb/client/dfs.c:63 fs/smb/client/dfs.c:285)
cifs\_mount (fs/smb/client/connect.c:3622)
cifs\_smb3\_do\_mount (fs/smb/client/cifsfs.c:949)
smb3\_get\_tree (fs/smb/client/fs\_context.c:784 fs/smb/client/fs\_context.c:802 fs/smb/client/fs\_context.c:794)
vfs\_get\_tree (fs/super.c:1800)
path\_mount (fs/namespace.c:3508 fs/namespace.c:3834)
\_\_x64\_sys\_mount (fs/namespace.c:3848 fs/namespace.c:4057 fs/namespace.c:4034 fs/namespace.c:4034)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Acked-by: Tom Talpey <tom@talpey.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7f9282fc27fc36dbaffc8527c723de264a132f8)

| -rw-r--r-- | [fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/connect.c?id=c7f9282fc27fc36dbaffc8527c723de264a132f8) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 3 deletions

| diff --git a/fs/smb/client/connect.c b/fs/smb/client/connect.cindex 5375b0c1dfb99d..9af28ed4cca46d 100644--- a/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=f0c5b21ac4e630f35b9a29268a0f712501d4ffac)+++ b/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=c7f9282fc27fc36dbaffc8527c723de264a132f8)@@ -1054,6 +1054,7 @@ clean\_demultiplex\_info(struct TCP\_Server\_Info \*server) \*/ } + put\_net(cifs\_net\_ns(server)); kfree(server->leaf\_fullpath); kfree(server); @@ -1649,8 +1650,6 @@ cifs\_put\_tcp\_session(struct TCP\_Server\_Info \*server, int from\_reconnect) /\* srv\_count can never go negative \*/ WARN\_ON(server->srv\_count < 0); - put\_net(cifs\_net\_ns(server));- list\_del\_init(&server->tcp\_ses\_list); spin\_unlock(&cifs\_tcp\_ses\_lock); @@ -3077,13 +3076,22 @@ generic\_ip\_connect(struct TCP\_Server\_Info \*server) if (server->ssocket) { socket = server->ssocket; } else {- rc = \_\_sock\_create(cifs\_net\_ns(server), sfamily, SOCK\_STREAM,+ struct net \*net = cifs\_net\_ns(server);+ struct sock \*sk;++ rc = \_\_sock\_create(net, sfamily, SOCK\_STREAM, IPPROTO\_TCP, &server->ssocket, 1); if (rc < 0) { cifs\_server\_dbg(VFS, "Error %d creating socket\n", rc); return rc; } + sk = server->ssocket->sk;+ \_\_netns\_tracker\_free(net, &sk->ns\_tracker, false);+ sk->sk\_net\_refcnt = 1;+ get\_net\_track(net, &sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(net, 1);+ /\* BB other socket options to set KEEPALIVE, NODELAY? \*/ cifs\_dbg(FYI, "Socket created\n"); socket = server->ssocket; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:33:51 +0000



=== Content from git.kernel.org_0dd6667b_20250115_093515.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e8c71494181153a134c96da28766a57bd1eac8cb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8c71494181153a134c96da28766a57bd1eac8cb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8c71494181153a134c96da28766a57bd1eac8cb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8c71494181153a134c96da28766a57bd1eac8cb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-11-02 14:24:38 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 15:08:57 +0100 |
| commit | [e8c71494181153a134c96da28766a57bd1eac8cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8c71494181153a134c96da28766a57bd1eac8cb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e8c71494181153a134c96da28766a57bd1eac8cb)) | |
| tree | [0315cb7534dd9dfaf4cf6d843e93b43b4142ce04](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8c71494181153a134c96da28766a57bd1eac8cb) | |
| parent | [1a1bcca5c9efd2c72c8d2fcbadf2d673cceb2ea7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a1bcca5c9efd2c72c8d2fcbadf2d673cceb2ea7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8c71494181153a134c96da28766a57bd1eac8cb&id2=1a1bcca5c9efd2c72c8d2fcbadf2d673cceb2ea7)) | |
| download | [linux-e8c71494181153a134c96da28766a57bd1eac8cb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e8c71494181153a134c96da28766a57bd1eac8cb.tar.gz) | |

smb: client: Fix use-after-free of network namespace.[ Upstream commit ef7134c7fc48e1441b398e55a862232868a6f0a7 ]
Recently, we got a customer report that CIFS triggers oops while
reconnecting to a server. [0]
The workload runs on Kubernetes, and some pods mount CIFS servers
in non-root network namespaces. The problem rarely happened, but
it was always while the pod was dying.
The root cause is wrong reference counting for network namespace.
CIFS uses kernel sockets, which do not hold refcnt of the netns that
the socket belongs to. That means CIFS must ensure the socket is
always freed before its netns; otherwise, use-after-free happens.
The repro steps are roughly:
1. mount CIFS in a non-root netns
2. drop packets from the netns
3. destroy the netns
4. unmount CIFS
We can reproduce the issue quickly with the script [1] below and see
the splat [2] if CONFIG\_NET\_NS\_REFCNT\_TRACKER is enabled.
When the socket is TCP, it is hard to guarantee the netns lifetime
without holding refcnt due to async timers.
Let's hold netns refcnt for each socket as done for SMC in commit
9744d2bf1976 ("smc: Fix use-after-free in tcp\_write\_timer\_handler().").
Note that we need to move put\_net() from cifs\_put\_tcp\_session() to
clean\_demultiplex\_info(); otherwise, \_\_sock\_create() still could touch a
freed netns while cifsd tries to reconnect from cifs\_demultiplex\_thread().
Also, maybe\_get\_net() cannot be put just before \_\_sock\_create() because
the code is not under RCU and there is a small chance that the same
address happened to be reallocated to another netns.
[0]:
CIFS: VFS: \\XXXXXXXXXXX has not responded in 15 seconds. Reconnecting...
CIFS: Serverclose failed 4 times, giving up
Unable to handle kernel paging request at virtual address 14de99e461f84a07
Mem abort info:
ESR = 0x0000000096000004
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
FSC = 0x04: level 0 translation fault
Data abort info:
ISV = 0, ISS = 0x00000004
CM = 0, WnR = 0
[14de99e461f84a07] address between user and kernel address ranges
Internal error: Oops: 0000000096000004 [#1] SMP
Modules linked in: cls\_bpf sch\_ingress nls\_utf8 cifs cifs\_arc4 cifs\_md4 dns\_resolver tcp\_diag inet\_diag veth xt\_state xt\_connmark nf\_conntrack\_netlink xt\_nat xt\_statistic xt\_MASQUERADE xt\_mark xt\_addrtype ipt\_REJECT nf\_reject\_ipv4 nft\_chain\_nat nf\_nat xt\_conntrack nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 xt\_comment nft\_compat nf\_tables nfnetlink overlay nls\_ascii nls\_cp437 sunrpc vfat fat aes\_ce\_blk aes\_ce\_cipher ghash\_ce sm4\_ce\_cipher sm4 sm3\_ce sm3 sha3\_ce sha512\_ce sha512\_arm64 sha1\_ce ena button sch\_fq\_codel loop fuse configfs dmi\_sysfs sha2\_ce sha256\_arm64 dm\_mirror dm\_region\_hash dm\_log dm\_mod dax efivarfs
CPU: 5 PID: 2690970 Comm: cifsd Not tainted 6.1.103-109.184.amzn2023.aarch64 #1
Hardware name: Amazon EC2 r7g.4xlarge/, BIOS 1.0 11/1/2018
pstate: 00400005 (nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : fib\_rules\_lookup+0x44/0x238
lr : \_\_fib\_lookup+0x64/0xbc
sp : ffff8000265db790
x29: ffff8000265db790 x28: 0000000000000000 x27: 000000000000bd01
x26: 0000000000000000 x25: ffff000b4baf8000 x24: ffff00047b5e4580
x23: ffff8000265db7e0 x22: 0000000000000000 x21: ffff00047b5e4500
x20: ffff0010e3f694f8 x19: 14de99e461f849f7 x18: 0000000000000000
x17: 0000000000000000 x16: 0000000000000000 x15: 0000000000000000
x14: 0000000000000000 x13: 0000000000000000 x12: 3f92800abd010002
x11: 0000000000000001 x10: ffff0010e3f69420 x9 : ffff800008a6f294
x8 : 0000000000000000 x7 : 0000000000000006 x6 : 0000000000000000
x5 : 0000000000000001 x4 : ffff001924354280 x3 : ffff8000265db7e0
x2 : 0000000000000000 x1 : ffff0010e3f694f8 x0 : ffff00047b5e4500
Call trace:
fib\_rules\_lookup+0x44/0x238
\_\_fib\_lookup+0x64/0xbc
ip\_route\_output\_key\_hash\_rcu+0x2c4/0x398
ip\_route\_output\_key\_hash+0x60/0x8c
tcp\_v4\_connect+0x290/0x488
\_\_inet\_stream\_connect+0x108/0x3d0
inet\_stream\_connect+0x50/0x78
kernel\_connect+0x6c/0xac
generic\_ip\_connect+0x10c/0x6c8 [cifs]
\_\_reconnect\_target\_unlocked+0xa0/0x214 [cifs]
reconnect\_dfs\_server+0x144/0x460 [cifs]
cifs\_reconnect+0x88/0x148 [cifs]
cifs\_readv\_from\_socket+0x230/0x430 [cifs]
cifs\_read\_from\_socket+0x74/0xa8 [cifs]
cifs\_demultiplex\_thread+0xf8/0x704 [cifs]
kthread+0xd0/0xd4
Code: aa0003f8 f8480f13 eb18027f 540006c0 (b9401264)
[1]:
CIFS\_CRED="/root/cred.cifs"
CIFS\_USER="Administrator"
CIFS\_PASS="Password"
CIFS\_IP="X.X.X.X"
CIFS\_PATH="//${CIFS\_IP}/Users/Administrator/Desktop/CIFS\_TEST"
CIFS\_MNT="/mnt/smb"
DEV="enp0s3"
cat <<EOF > ${CIFS\_CRED}
username=${CIFS\_USER}
password=${CIFS\_PASS}
domain=EXAMPLE.COM
EOF
unshare -n bash -c "
mkdir -p ${CIFS\_MNT}
ip netns attach root 1
ip link add eth0 type veth peer veth0 netns root
ip link set eth0 up
ip -n root link set veth0 up
ip addr add 192.168.0.2/24 dev eth0
ip -n root addr add 192.168.0.1/24 dev veth0
ip route add default via 192.168.0.1 dev eth0
ip netns exec root sysctl net.ipv4.ip\_forward=1
ip netns exec root iptables -t nat -A POSTROUTING -s 192.168.0.2 -o ${DEV} -j MASQUERADE
mount -t cifs ${CIFS\_PATH} ${CIFS\_MNT} -o vers=3.0,sec=ntlmssp,credentials=${CIFS\_CRED},rsize=65536,wsize=65536,cache=none,echo\_interval=1
touch ${CIFS\_MNT}/a.txt
ip netns exec root iptables -t nat -D POSTROUTING -s 192.168.0.2 -o ${DEV} -j MASQUERADE
"
umount ${CIFS\_MNT}
[2]:
ref\_tracker: net notrefcnt@000000004bbc008d has 1/1 users at
sk\_alloc (./include/net/net\_namespace.h:339 net/core/sock.c:2227)
inet\_create (net/ipv4/af\_inet.c:326 net/ipv4/af\_inet.c:252)
\_\_sock\_create (net/socket.c:1576)
generic\_ip\_connect (fs/smb/client/connect.c:3075)
cifs\_get\_tcp\_session.part.0 (fs/smb/client/connect.c:3160 fs/smb/client/connect.c:1798)
cifs\_mount\_get\_session (fs/smb/client/trace.h:959 fs/smb/client/connect.c:3366)
dfs\_mount\_share (fs/smb/client/dfs.c:63 fs/smb/client/dfs.c:285)
cifs\_mount (fs/smb/client/connect.c:3622)
cifs\_smb3\_do\_mount (fs/smb/client/cifsfs.c:949)
smb3\_get\_tree (fs/smb/client/fs\_context.c:784 fs/smb/client/fs\_context.c:802 fs/smb/client/fs\_context.c:794)
vfs\_get\_tree (fs/super.c:1800)
path\_mount (fs/namespace.c:3508 fs/namespace.c:3834)
\_\_x64\_sys\_mount (fs/namespace.c:3848 fs/namespace.c:4057 fs/namespace.c:4034 fs/namespace.c:4034)
do\_syscall\_64 (arch/x86/entry/common.c:52 arch/x86/entry/common.c:83)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:130)
Fixes: 26abe14379f8 ("net: Modify sk\_alloc to not reference count the netns of kernel sockets.")
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Acked-by: Tom Talpey <tom@talpey.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8c71494181153a134c96da28766a57bd1eac8cb)

| -rw-r--r-- | [fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/connect.c?id=e8c71494181153a134c96da28766a57bd1eac8cb) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 3 deletions

| diff --git a/fs/smb/client/connect.c b/fs/smb/client/connect.cindex e325e06357ffb7..1df0a6edcc2167 100644--- a/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=1a1bcca5c9efd2c72c8d2fcbadf2d673cceb2ea7)+++ b/[fs/smb/client/connect.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/connect.c?id=e8c71494181153a134c96da28766a57bd1eac8cb)@@ -1054,6 +1054,7 @@ clean\_demultiplex\_info(struct TCP\_Server\_Info \*server) \*/ } + put\_net(cifs\_net\_ns(server)); kfree(server->leaf\_fullpath); kfree(server); @@ -1649,8 +1650,6 @@ cifs\_put\_tcp\_session(struct TCP\_Server\_Info \*server, int from\_reconnect) /\* srv\_count can never go negative \*/ WARN\_ON(server->srv\_count < 0); - put\_net(cifs\_net\_ns(server));- list\_del\_init(&server->tcp\_ses\_list); spin\_unlock(&cifs\_tcp\_ses\_lock); @@ -3077,13 +3076,22 @@ generic\_ip\_connect(struct TCP\_Server\_Info \*server) if (server->ssocket) { socket = server->ssocket; } else {- rc = \_\_sock\_create(cifs\_net\_ns(server), sfamily, SOCK\_STREAM,+ struct net \*net = cifs\_net\_ns(server);+ struct sock \*sk;++ rc = \_\_sock\_create(net, sfamily, SOCK\_STREAM, IPPROTO\_TCP, &server->ssocket, 1); if (rc < 0) { cifs\_server\_dbg(VFS, "Error %d creating socket\n", rc); return rc; } + sk = server->ssocket->sk;+ \_\_netns\_tracker\_free(net, &sk->ns\_tracker, false);+ sk->sk\_net\_refcnt = 1;+ get\_net\_track(net, &sk->ns\_tracker, GFP\_KERNEL);+ sock\_inuse\_add(net, 1);+ /\* BB other socket options to set KEEPALIVE, NODELAY? \*/ cifs\_dbg(FYI, "Socket created\n"); socket = server->ssocket; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:33:52 +0000


