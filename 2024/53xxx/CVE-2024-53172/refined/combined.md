=== Content from git.kernel.org_c7b27541_20250114_190740.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2024-10-11 12:50:02 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:20 +0100 |
| commit | [b1ee0aa4945c49cbbd779da81040fcec4de80fd1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1)) | |
| tree | [a0168e79e31afde5244f7fc90c37076ae6b63900](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1) | |
| parent | [2b19d2fd58becd1042ecb55f3b96cc3d7a810018](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b19d2fd58becd1042ecb55f3b96cc3d7a810018) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1&id2=2b19d2fd58becd1042ecb55f3b96cc3d7a810018)) | |
| download | [linux-b1ee0aa4945c49cbbd779da81040fcec4de80fd1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b1ee0aa4945c49cbbd779da81040fcec4de80fd1.tar.gz) | |

ubi: fastmap: Fix duplicate slab cache names while attaching[ Upstream commit bcddf52b7a17adcebc768d26f4e27cf79adb424c ]
Since commit 4c39529663b9 ("slab: Warn on duplicate cache names when
DEBUG\_VM=y"), the duplicate slab cache names can be detected and a
kernel WARNING is thrown out.
In UBI fast attaching process, alloc\_ai() could be invoked twice
with the same slab cache name 'ubi\_aeb\_slab\_cache', which will trigger
following warning messages:
kmem\_cache of name 'ubi\_aeb\_slab\_cache' already exists
WARNING: CPU: 0 PID: 7519 at mm/slab\_common.c:107
\_\_kmem\_cache\_create\_args+0x100/0x5f0
Modules linked in: ubi(+) nandsim [last unloaded: nandsim]
CPU: 0 UID: 0 PID: 7519 Comm: modprobe Tainted: G 6.12.0-rc2
RIP: 0010:\_\_kmem\_cache\_create\_args+0x100/0x5f0
Call Trace:
\_\_kmem\_cache\_create\_args+0x100/0x5f0
alloc\_ai+0x295/0x3f0 [ubi]
ubi\_attach+0x3c3/0xcc0 [ubi]
ubi\_attach\_mtd\_dev+0x17cf/0x3fa0 [ubi]
ubi\_init+0x3fb/0x800 [ubi]
do\_init\_module+0x265/0x7d0
\_\_x64\_sys\_finit\_module+0x7a/0xc0
The problem could be easily reproduced by loading UBI device by fastmap
with CONFIG\_DEBUG\_VM=y.
Fix it by using different slab names for alloc\_ai() callers.
Fixes: d2158f69a7d4 ("UBI: Remove alloc\_ai() slab name from parameter list")
Fixes: fdf10ed710c0 ("ubi: Rework Fastmap attach base code")
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1)

| -rw-r--r-- | [drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/ubi/attach.c?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/mtd/ubi/attach.c b/drivers/mtd/ubi/attach.cindex ae5abe492b52ab..adc47b87b38a5f 100644--- a/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=2b19d2fd58becd1042ecb55f3b96cc3d7a810018)+++ b/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1)@@ -1447,7 +1447,7 @@ out\_ech: return err; } -static struct ubi\_attach\_info \*alloc\_ai(void)+static struct ubi\_attach\_info \*alloc\_ai(const char \*slab\_name) { struct ubi\_attach\_info \*ai; @@ -1461,7 +1461,7 @@ static struct ubi\_attach\_info \*alloc\_ai(void) INIT\_LIST\_HEAD(&ai->alien); INIT\_LIST\_HEAD(&ai->fastmap); ai->volumes = RB\_ROOT;- ai->aeb\_slab\_cache = kmem\_cache\_create("ubi\_aeb\_slab\_cache",+ ai->aeb\_slab\_cache = kmem\_cache\_create(slab\_name, sizeof(struct ubi\_ainf\_peb), 0, 0, NULL); if (!ai->aeb\_slab\_cache) {@@ -1491,7 +1491,7 @@ static int scan\_fast(struct ubi\_device \*ubi, struct ubi\_attach\_info \*\*ai)  err = -ENOMEM; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_fastmap"); if (!scan\_ai) goto out; @@ -1557,7 +1557,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) int err; struct ubi\_attach\_info \*ai; - ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1575,7 +1575,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (err > 0 || mtd\_is\_eccerr(err)) { if (err != UBI\_NO\_FASTMAP) { destroy\_ai(ai);- ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1614,7 +1614,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (ubi->fm && ubi\_dbg\_chk\_fastmap(ubi)) { struct ubi\_attach\_info \*scan\_ai; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_dbg\_chk\_fastmap"); if (!scan\_ai) { err = -ENOMEM; goto out\_wl; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:17 +0000



=== Content from git.kernel.org_4175ce39_20250114_190737.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=612824dd0c9465ef365ace38b056c663d110956d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=612824dd0c9465ef365ace38b056c663d110956d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=612824dd0c9465ef365ace38b056c663d110956d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=612824dd0c9465ef365ace38b056c663d110956d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2024-10-11 12:50:02 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:55 +0100 |
| commit | [612824dd0c9465ef365ace38b056c663d110956d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=612824dd0c9465ef365ace38b056c663d110956d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=612824dd0c9465ef365ace38b056c663d110956d)) | |
| tree | [c61a3004ddd53eb14e63a5fed19a0db287790994](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=612824dd0c9465ef365ace38b056c663d110956d) | |
| parent | [074b310f059127ba884d10660feb2562cb8c3975](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=074b310f059127ba884d10660feb2562cb8c3975) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=612824dd0c9465ef365ace38b056c663d110956d&id2=074b310f059127ba884d10660feb2562cb8c3975)) | |
| download | [linux-612824dd0c9465ef365ace38b056c663d110956d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-612824dd0c9465ef365ace38b056c663d110956d.tar.gz) | |

ubi: fastmap: Fix duplicate slab cache names while attaching[ Upstream commit bcddf52b7a17adcebc768d26f4e27cf79adb424c ]
Since commit 4c39529663b9 ("slab: Warn on duplicate cache names when
DEBUG\_VM=y"), the duplicate slab cache names can be detected and a
kernel WARNING is thrown out.
In UBI fast attaching process, alloc\_ai() could be invoked twice
with the same slab cache name 'ubi\_aeb\_slab\_cache', which will trigger
following warning messages:
kmem\_cache of name 'ubi\_aeb\_slab\_cache' already exists
WARNING: CPU: 0 PID: 7519 at mm/slab\_common.c:107
\_\_kmem\_cache\_create\_args+0x100/0x5f0
Modules linked in: ubi(+) nandsim [last unloaded: nandsim]
CPU: 0 UID: 0 PID: 7519 Comm: modprobe Tainted: G 6.12.0-rc2
RIP: 0010:\_\_kmem\_cache\_create\_args+0x100/0x5f0
Call Trace:
\_\_kmem\_cache\_create\_args+0x100/0x5f0
alloc\_ai+0x295/0x3f0 [ubi]
ubi\_attach+0x3c3/0xcc0 [ubi]
ubi\_attach\_mtd\_dev+0x17cf/0x3fa0 [ubi]
ubi\_init+0x3fb/0x800 [ubi]
do\_init\_module+0x265/0x7d0
\_\_x64\_sys\_finit\_module+0x7a/0xc0
The problem could be easily reproduced by loading UBI device by fastmap
with CONFIG\_DEBUG\_VM=y.
Fix it by using different slab names for alloc\_ai() callers.
Fixes: d2158f69a7d4 ("UBI: Remove alloc\_ai() slab name from parameter list")
Fixes: fdf10ed710c0 ("ubi: Rework Fastmap attach base code")
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=612824dd0c9465ef365ace38b056c663d110956d)

| -rw-r--r-- | [drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/ubi/attach.c?id=612824dd0c9465ef365ace38b056c663d110956d) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/mtd/ubi/attach.c b/drivers/mtd/ubi/attach.cindex ae5abe492b52ab..adc47b87b38a5f 100644--- a/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=074b310f059127ba884d10660feb2562cb8c3975)+++ b/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=612824dd0c9465ef365ace38b056c663d110956d)@@ -1447,7 +1447,7 @@ out\_ech: return err; } -static struct ubi\_attach\_info \*alloc\_ai(void)+static struct ubi\_attach\_info \*alloc\_ai(const char \*slab\_name) { struct ubi\_attach\_info \*ai; @@ -1461,7 +1461,7 @@ static struct ubi\_attach\_info \*alloc\_ai(void) INIT\_LIST\_HEAD(&ai->alien); INIT\_LIST\_HEAD(&ai->fastmap); ai->volumes = RB\_ROOT;- ai->aeb\_slab\_cache = kmem\_cache\_create("ubi\_aeb\_slab\_cache",+ ai->aeb\_slab\_cache = kmem\_cache\_create(slab\_name, sizeof(struct ubi\_ainf\_peb), 0, 0, NULL); if (!ai->aeb\_slab\_cache) {@@ -1491,7 +1491,7 @@ static int scan\_fast(struct ubi\_device \*ubi, struct ubi\_attach\_info \*\*ai)  err = -ENOMEM; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_fastmap"); if (!scan\_ai) goto out; @@ -1557,7 +1557,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) int err; struct ubi\_attach\_info \*ai; - ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1575,7 +1575,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (err > 0 || mtd\_is\_eccerr(err)) { if (err != UBI\_NO\_FASTMAP) { destroy\_ai(ai);- ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1614,7 +1614,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (ubi->fm && ubi\_dbg\_chk\_fastmap(ubi)) { struct ubi\_attach\_info \*scan\_ai; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_dbg\_chk\_fastmap"); if (!scan\_ai) { err = -ENOMEM; goto out\_wl; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:04:08 +0000



=== Content from git.kernel.org_40ef8b90_20250114_190739.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=871c148f8e0c32e505df9393ba4a303c3c3fe988)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=871c148f8e0c32e505df9393ba4a303c3c3fe988)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=871c148f8e0c32e505df9393ba4a303c3c3fe988)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=871c148f8e0c32e505df9393ba4a303c3c3fe988)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2024-10-11 12:50:02 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:40 +0100 |
| commit | [871c148f8e0c32e505df9393ba4a303c3c3fe988](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=871c148f8e0c32e505df9393ba4a303c3c3fe988) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=871c148f8e0c32e505df9393ba4a303c3c3fe988)) | |
| tree | [5ea1820784696c6fc972a991c3e3bb72cf46ba5e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=871c148f8e0c32e505df9393ba4a303c3c3fe988) | |
| parent | [f1f685b3ddb7148cbeab4564b43a8bf0eccee34d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1f685b3ddb7148cbeab4564b43a8bf0eccee34d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=871c148f8e0c32e505df9393ba4a303c3c3fe988&id2=f1f685b3ddb7148cbeab4564b43a8bf0eccee34d)) | |
| download | [linux-871c148f8e0c32e505df9393ba4a303c3c3fe988.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-871c148f8e0c32e505df9393ba4a303c3c3fe988.tar.gz) | |

ubi: fastmap: Fix duplicate slab cache names while attaching[ Upstream commit bcddf52b7a17adcebc768d26f4e27cf79adb424c ]
Since commit 4c39529663b9 ("slab: Warn on duplicate cache names when
DEBUG\_VM=y"), the duplicate slab cache names can be detected and a
kernel WARNING is thrown out.
In UBI fast attaching process, alloc\_ai() could be invoked twice
with the same slab cache name 'ubi\_aeb\_slab\_cache', which will trigger
following warning messages:
kmem\_cache of name 'ubi\_aeb\_slab\_cache' already exists
WARNING: CPU: 0 PID: 7519 at mm/slab\_common.c:107
\_\_kmem\_cache\_create\_args+0x100/0x5f0
Modules linked in: ubi(+) nandsim [last unloaded: nandsim]
CPU: 0 UID: 0 PID: 7519 Comm: modprobe Tainted: G 6.12.0-rc2
RIP: 0010:\_\_kmem\_cache\_create\_args+0x100/0x5f0
Call Trace:
\_\_kmem\_cache\_create\_args+0x100/0x5f0
alloc\_ai+0x295/0x3f0 [ubi]
ubi\_attach+0x3c3/0xcc0 [ubi]
ubi\_attach\_mtd\_dev+0x17cf/0x3fa0 [ubi]
ubi\_init+0x3fb/0x800 [ubi]
do\_init\_module+0x265/0x7d0
\_\_x64\_sys\_finit\_module+0x7a/0xc0
The problem could be easily reproduced by loading UBI device by fastmap
with CONFIG\_DEBUG\_VM=y.
Fix it by using different slab names for alloc\_ai() callers.
Fixes: d2158f69a7d4 ("UBI: Remove alloc\_ai() slab name from parameter list")
Fixes: fdf10ed710c0 ("ubi: Rework Fastmap attach base code")
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=871c148f8e0c32e505df9393ba4a303c3c3fe988)

| -rw-r--r-- | [drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/ubi/attach.c?id=871c148f8e0c32e505df9393ba4a303c3c3fe988) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/mtd/ubi/attach.c b/drivers/mtd/ubi/attach.cindex 10b2459f8951e7..98fb59ed996f86 100644--- a/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=f1f685b3ddb7148cbeab4564b43a8bf0eccee34d)+++ b/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=871c148f8e0c32e505df9393ba4a303c3c3fe988)@@ -1447,7 +1447,7 @@ out\_ech: return err; } -static struct ubi\_attach\_info \*alloc\_ai(void)+static struct ubi\_attach\_info \*alloc\_ai(const char \*slab\_name) { struct ubi\_attach\_info \*ai; @@ -1461,7 +1461,7 @@ static struct ubi\_attach\_info \*alloc\_ai(void) INIT\_LIST\_HEAD(&ai->alien); INIT\_LIST\_HEAD(&ai->fastmap); ai->volumes = RB\_ROOT;- ai->aeb\_slab\_cache = kmem\_cache\_create("ubi\_aeb\_slab\_cache",+ ai->aeb\_slab\_cache = kmem\_cache\_create(slab\_name, sizeof(struct ubi\_ainf\_peb), 0, 0, NULL); if (!ai->aeb\_slab\_cache) {@@ -1491,7 +1491,7 @@ static int scan\_fast(struct ubi\_device \*ubi, struct ubi\_attach\_info \*\*ai)  err = -ENOMEM; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_fastmap"); if (!scan\_ai) goto out; @@ -1557,7 +1557,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) int err; struct ubi\_attach\_info \*ai; - ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1575,7 +1575,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (err > 0 || mtd\_is\_eccerr(err)) { if (err != UBI\_NO\_FASTMAP) { destroy\_ai(ai);- ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1614,7 +1614,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (ubi->fm && ubi\_dbg\_chk\_fastmap(ubi)) { struct ubi\_attach\_info \*scan\_ai; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_dbg\_chk\_fastmap"); if (!scan\_ai) { err = -ENOMEM; goto out\_wl; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:16 +0000



=== Content from git.kernel.org_a3cd6f5c_20250114_190738.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6afdcb285794e75d2c8995e3a44f523c176cc2de)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6afdcb285794e75d2c8995e3a44f523c176cc2de)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6afdcb285794e75d2c8995e3a44f523c176cc2de)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6afdcb285794e75d2c8995e3a44f523c176cc2de)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2024-10-11 12:50:02 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:08 +0100 |
| commit | [6afdcb285794e75d2c8995e3a44f523c176cc2de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6afdcb285794e75d2c8995e3a44f523c176cc2de) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6afdcb285794e75d2c8995e3a44f523c176cc2de)) | |
| tree | [77503f98bbd38063720d5370b54316aed2a84c53](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6afdcb285794e75d2c8995e3a44f523c176cc2de) | |
| parent | [f88a7f5e261fd8aee3edbdcf083424a81672cdc5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f88a7f5e261fd8aee3edbdcf083424a81672cdc5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6afdcb285794e75d2c8995e3a44f523c176cc2de&id2=f88a7f5e261fd8aee3edbdcf083424a81672cdc5)) | |
| download | [linux-6afdcb285794e75d2c8995e3a44f523c176cc2de.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6afdcb285794e75d2c8995e3a44f523c176cc2de.tar.gz) | |

ubi: fastmap: Fix duplicate slab cache names while attaching[ Upstream commit bcddf52b7a17adcebc768d26f4e27cf79adb424c ]
Since commit 4c39529663b9 ("slab: Warn on duplicate cache names when
DEBUG\_VM=y"), the duplicate slab cache names can be detected and a
kernel WARNING is thrown out.
In UBI fast attaching process, alloc\_ai() could be invoked twice
with the same slab cache name 'ubi\_aeb\_slab\_cache', which will trigger
following warning messages:
kmem\_cache of name 'ubi\_aeb\_slab\_cache' already exists
WARNING: CPU: 0 PID: 7519 at mm/slab\_common.c:107
\_\_kmem\_cache\_create\_args+0x100/0x5f0
Modules linked in: ubi(+) nandsim [last unloaded: nandsim]
CPU: 0 UID: 0 PID: 7519 Comm: modprobe Tainted: G 6.12.0-rc2
RIP: 0010:\_\_kmem\_cache\_create\_args+0x100/0x5f0
Call Trace:
\_\_kmem\_cache\_create\_args+0x100/0x5f0
alloc\_ai+0x295/0x3f0 [ubi]
ubi\_attach+0x3c3/0xcc0 [ubi]
ubi\_attach\_mtd\_dev+0x17cf/0x3fa0 [ubi]
ubi\_init+0x3fb/0x800 [ubi]
do\_init\_module+0x265/0x7d0
\_\_x64\_sys\_finit\_module+0x7a/0xc0
The problem could be easily reproduced by loading UBI device by fastmap
with CONFIG\_DEBUG\_VM=y.
Fix it by using different slab names for alloc\_ai() callers.
Fixes: d2158f69a7d4 ("UBI: Remove alloc\_ai() slab name from parameter list")
Fixes: fdf10ed710c0 ("ubi: Rework Fastmap attach base code")
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6afdcb285794e75d2c8995e3a44f523c176cc2de)

| -rw-r--r-- | [drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/ubi/attach.c?id=6afdcb285794e75d2c8995e3a44f523c176cc2de) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/mtd/ubi/attach.c b/drivers/mtd/ubi/attach.cindex ae5abe492b52ab..adc47b87b38a5f 100644--- a/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=f88a7f5e261fd8aee3edbdcf083424a81672cdc5)+++ b/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=6afdcb285794e75d2c8995e3a44f523c176cc2de)@@ -1447,7 +1447,7 @@ out\_ech: return err; } -static struct ubi\_attach\_info \*alloc\_ai(void)+static struct ubi\_attach\_info \*alloc\_ai(const char \*slab\_name) { struct ubi\_attach\_info \*ai; @@ -1461,7 +1461,7 @@ static struct ubi\_attach\_info \*alloc\_ai(void) INIT\_LIST\_HEAD(&ai->alien); INIT\_LIST\_HEAD(&ai->fastmap); ai->volumes = RB\_ROOT;- ai->aeb\_slab\_cache = kmem\_cache\_create("ubi\_aeb\_slab\_cache",+ ai->aeb\_slab\_cache = kmem\_cache\_create(slab\_name, sizeof(struct ubi\_ainf\_peb), 0, 0, NULL); if (!ai->aeb\_slab\_cache) {@@ -1491,7 +1491,7 @@ static int scan\_fast(struct ubi\_device \*ubi, struct ubi\_attach\_info \*\*ai)  err = -ENOMEM; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_fastmap"); if (!scan\_ai) goto out; @@ -1557,7 +1557,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) int err; struct ubi\_attach\_info \*ai; - ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1575,7 +1575,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (err > 0 || mtd\_is\_eccerr(err)) { if (err != UBI\_NO\_FASTMAP) { destroy\_ai(ai);- ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1614,7 +1614,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (ubi->fm && ubi\_dbg\_chk\_fastmap(ubi)) { struct ubi\_attach\_info \*scan\_ai; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_dbg\_chk\_fastmap"); if (!scan\_ai) { err = -ENOMEM; goto out\_wl; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:15 +0000



=== Content from git.kernel.org_1b2dad9d_20250114_190736.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=04c0b0f37617099479c34e207c5550d081f585a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04c0b0f37617099479c34e207c5550d081f585a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04c0b0f37617099479c34e207c5550d081f585a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04c0b0f37617099479c34e207c5550d081f585a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2024-10-11 12:50:02 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:14 +0100 |
| commit | [04c0b0f37617099479c34e207c5550d081f585a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04c0b0f37617099479c34e207c5550d081f585a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=04c0b0f37617099479c34e207c5550d081f585a6)) | |
| tree | [b335b7582b5287e89cdf8a38f7ab4056fea5940c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04c0b0f37617099479c34e207c5550d081f585a6) | |
| parent | [36b25baf96b89ea43be164810b81864ff52210b0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36b25baf96b89ea43be164810b81864ff52210b0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04c0b0f37617099479c34e207c5550d081f585a6&id2=36b25baf96b89ea43be164810b81864ff52210b0)) | |
| download | [linux-04c0b0f37617099479c34e207c5550d081f585a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-04c0b0f37617099479c34e207c5550d081f585a6.tar.gz) | |

ubi: fastmap: Fix duplicate slab cache names while attaching[ Upstream commit bcddf52b7a17adcebc768d26f4e27cf79adb424c ]
Since commit 4c39529663b9 ("slab: Warn on duplicate cache names when
DEBUG\_VM=y"), the duplicate slab cache names can be detected and a
kernel WARNING is thrown out.
In UBI fast attaching process, alloc\_ai() could be invoked twice
with the same slab cache name 'ubi\_aeb\_slab\_cache', which will trigger
following warning messages:
kmem\_cache of name 'ubi\_aeb\_slab\_cache' already exists
WARNING: CPU: 0 PID: 7519 at mm/slab\_common.c:107
\_\_kmem\_cache\_create\_args+0x100/0x5f0
Modules linked in: ubi(+) nandsim [last unloaded: nandsim]
CPU: 0 UID: 0 PID: 7519 Comm: modprobe Tainted: G 6.12.0-rc2
RIP: 0010:\_\_kmem\_cache\_create\_args+0x100/0x5f0
Call Trace:
\_\_kmem\_cache\_create\_args+0x100/0x5f0
alloc\_ai+0x295/0x3f0 [ubi]
ubi\_attach+0x3c3/0xcc0 [ubi]
ubi\_attach\_mtd\_dev+0x17cf/0x3fa0 [ubi]
ubi\_init+0x3fb/0x800 [ubi]
do\_init\_module+0x265/0x7d0
\_\_x64\_sys\_finit\_module+0x7a/0xc0
The problem could be easily reproduced by loading UBI device by fastmap
with CONFIG\_DEBUG\_VM=y.
Fix it by using different slab names for alloc\_ai() callers.
Fixes: d2158f69a7d4 ("UBI: Remove alloc\_ai() slab name from parameter list")
Fixes: fdf10ed710c0 ("ubi: Rework Fastmap attach base code")
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04c0b0f37617099479c34e207c5550d081f585a6)

| -rw-r--r-- | [drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/ubi/attach.c?id=04c0b0f37617099479c34e207c5550d081f585a6) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/mtd/ubi/attach.c b/drivers/mtd/ubi/attach.cindex ae5abe492b52ab..adc47b87b38a5f 100644--- a/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=36b25baf96b89ea43be164810b81864ff52210b0)+++ b/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=04c0b0f37617099479c34e207c5550d081f585a6)@@ -1447,7 +1447,7 @@ out\_ech: return err; } -static struct ubi\_attach\_info \*alloc\_ai(void)+static struct ubi\_attach\_info \*alloc\_ai(const char \*slab\_name) { struct ubi\_attach\_info \*ai; @@ -1461,7 +1461,7 @@ static struct ubi\_attach\_info \*alloc\_ai(void) INIT\_LIST\_HEAD(&ai->alien); INIT\_LIST\_HEAD(&ai->fastmap); ai->volumes = RB\_ROOT;- ai->aeb\_slab\_cache = kmem\_cache\_create("ubi\_aeb\_slab\_cache",+ ai->aeb\_slab\_cache = kmem\_cache\_create(slab\_name, sizeof(struct ubi\_ainf\_peb), 0, 0, NULL); if (!ai->aeb\_slab\_cache) {@@ -1491,7 +1491,7 @@ static int scan\_fast(struct ubi\_device \*ubi, struct ubi\_attach\_info \*\*ai)  err = -ENOMEM; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_fastmap"); if (!scan\_ai) goto out; @@ -1557,7 +1557,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) int err; struct ubi\_attach\_info \*ai; - ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1575,7 +1575,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (err > 0 || mtd\_is\_eccerr(err)) { if (err != UBI\_NO\_FASTMAP) { destroy\_ai(ai);- ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1614,7 +1614,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (ubi->fm && ubi\_dbg\_chk\_fastmap(ubi)) { struct ubi\_attach\_info \*scan\_ai; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_dbg\_chk\_fastmap"); if (!scan\_ai) { err = -ENOMEM; goto out\_wl; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:13 +0000



=== Content from git.kernel.org_e8afb27b_20250114_190737.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3d8558135cd56a2a8052024be4073e160f36658c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d8558135cd56a2a8052024be4073e160f36658c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d8558135cd56a2a8052024be4073e160f36658c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d8558135cd56a2a8052024be4073e160f36658c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2024-10-11 12:50:02 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:28 +0100 |
| commit | [3d8558135cd56a2a8052024be4073e160f36658c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d8558135cd56a2a8052024be4073e160f36658c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3d8558135cd56a2a8052024be4073e160f36658c)) | |
| tree | [e1d23553498c4b11d116fc1dca4a1ec9abfa06de](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d8558135cd56a2a8052024be4073e160f36658c) | |
| parent | [6d1505741f8e97805b537a1355a7b9e7c968f714](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d1505741f8e97805b537a1355a7b9e7c968f714) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d8558135cd56a2a8052024be4073e160f36658c&id2=6d1505741f8e97805b537a1355a7b9e7c968f714)) | |
| download | [linux-3d8558135cd56a2a8052024be4073e160f36658c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3d8558135cd56a2a8052024be4073e160f36658c.tar.gz) | |

ubi: fastmap: Fix duplicate slab cache names while attaching[ Upstream commit bcddf52b7a17adcebc768d26f4e27cf79adb424c ]
Since commit 4c39529663b9 ("slab: Warn on duplicate cache names when
DEBUG\_VM=y"), the duplicate slab cache names can be detected and a
kernel WARNING is thrown out.
In UBI fast attaching process, alloc\_ai() could be invoked twice
with the same slab cache name 'ubi\_aeb\_slab\_cache', which will trigger
following warning messages:
kmem\_cache of name 'ubi\_aeb\_slab\_cache' already exists
WARNING: CPU: 0 PID: 7519 at mm/slab\_common.c:107
\_\_kmem\_cache\_create\_args+0x100/0x5f0
Modules linked in: ubi(+) nandsim [last unloaded: nandsim]
CPU: 0 UID: 0 PID: 7519 Comm: modprobe Tainted: G 6.12.0-rc2
RIP: 0010:\_\_kmem\_cache\_create\_args+0x100/0x5f0
Call Trace:
\_\_kmem\_cache\_create\_args+0x100/0x5f0
alloc\_ai+0x295/0x3f0 [ubi]
ubi\_attach+0x3c3/0xcc0 [ubi]
ubi\_attach\_mtd\_dev+0x17cf/0x3fa0 [ubi]
ubi\_init+0x3fb/0x800 [ubi]
do\_init\_module+0x265/0x7d0
\_\_x64\_sys\_finit\_module+0x7a/0xc0
The problem could be easily reproduced by loading UBI device by fastmap
with CONFIG\_DEBUG\_VM=y.
Fix it by using different slab names for alloc\_ai() callers.
Fixes: d2158f69a7d4 ("UBI: Remove alloc\_ai() slab name from parameter list")
Fixes: fdf10ed710c0 ("ubi: Rework Fastmap attach base code")
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d8558135cd56a2a8052024be4073e160f36658c)

| -rw-r--r-- | [drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/ubi/attach.c?id=3d8558135cd56a2a8052024be4073e160f36658c) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/mtd/ubi/attach.c b/drivers/mtd/ubi/attach.cindex ae5abe492b52ab..adc47b87b38a5f 100644--- a/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=6d1505741f8e97805b537a1355a7b9e7c968f714)+++ b/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=3d8558135cd56a2a8052024be4073e160f36658c)@@ -1447,7 +1447,7 @@ out\_ech: return err; } -static struct ubi\_attach\_info \*alloc\_ai(void)+static struct ubi\_attach\_info \*alloc\_ai(const char \*slab\_name) { struct ubi\_attach\_info \*ai; @@ -1461,7 +1461,7 @@ static struct ubi\_attach\_info \*alloc\_ai(void) INIT\_LIST\_HEAD(&ai->alien); INIT\_LIST\_HEAD(&ai->fastmap); ai->volumes = RB\_ROOT;- ai->aeb\_slab\_cache = kmem\_cache\_create("ubi\_aeb\_slab\_cache",+ ai->aeb\_slab\_cache = kmem\_cache\_create(slab\_name, sizeof(struct ubi\_ainf\_peb), 0, 0, NULL); if (!ai->aeb\_slab\_cache) {@@ -1491,7 +1491,7 @@ static int scan\_fast(struct ubi\_device \*ubi, struct ubi\_attach\_info \*\*ai)  err = -ENOMEM; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_fastmap"); if (!scan\_ai) goto out; @@ -1557,7 +1557,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) int err; struct ubi\_attach\_info \*ai; - ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1575,7 +1575,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (err > 0 || mtd\_is\_eccerr(err)) { if (err != UBI\_NO\_FASTMAP) { destroy\_ai(ai);- ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1614,7 +1614,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (ubi->fm && ubi\_dbg\_chk\_fastmap(ubi)) { struct ubi\_attach\_info \*scan\_ai; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_dbg\_chk\_fastmap"); if (!scan\_ai) { err = -ENOMEM; goto out\_wl; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:14 +0000



=== Content from git.kernel.org_9bd111c5_20250114_190740.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2024-10-11 12:50:02 +0800 |
| --- | --- | --- |
| committer | Richard Weinberger <richard@nod.at> | 2024-11-14 19:45:28 +0100 |
| commit | [bcddf52b7a17adcebc768d26f4e27cf79adb424c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c)) | |
| tree | [18ffa06480b328561bdc4ad3a6b4fd1e260f00ad](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c) | |
| parent | [8214951280a25e1260ee6dbf472b261b63b29af2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8214951280a25e1260ee6dbf472b261b63b29af2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c&id2=8214951280a25e1260ee6dbf472b261b63b29af2)) | |
| download | [linux-bcddf52b7a17adcebc768d26f4e27cf79adb424c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bcddf52b7a17adcebc768d26f4e27cf79adb424c.tar.gz) | |

ubi: fastmap: Fix duplicate slab cache names while attachingSince commit 4c39529663b9 ("slab: Warn on duplicate cache names when
DEBUG\_VM=y"), the duplicate slab cache names can be detected and a
kernel WARNING is thrown out.
In UBI fast attaching process, alloc\_ai() could be invoked twice
with the same slab cache name 'ubi\_aeb\_slab\_cache', which will trigger
following warning messages:
kmem\_cache of name 'ubi\_aeb\_slab\_cache' already exists
WARNING: CPU: 0 PID: 7519 at mm/slab\_common.c:107
\_\_kmem\_cache\_create\_args+0x100/0x5f0
Modules linked in: ubi(+) nandsim [last unloaded: nandsim]
CPU: 0 UID: 0 PID: 7519 Comm: modprobe Tainted: G 6.12.0-rc2
RIP: 0010:\_\_kmem\_cache\_create\_args+0x100/0x5f0
Call Trace:
\_\_kmem\_cache\_create\_args+0x100/0x5f0
alloc\_ai+0x295/0x3f0 [ubi]
ubi\_attach+0x3c3/0xcc0 [ubi]
ubi\_attach\_mtd\_dev+0x17cf/0x3fa0 [ubi]
ubi\_init+0x3fb/0x800 [ubi]
do\_init\_module+0x265/0x7d0
\_\_x64\_sys\_finit\_module+0x7a/0xc0
The problem could be easily reproduced by loading UBI device by fastmap
with CONFIG\_DEBUG\_VM=y.
Fix it by using different slab names for alloc\_ai() callers.
Fixes: d2158f69a7d4 ("UBI: Remove alloc\_ai() slab name from parameter list")
Fixes: fdf10ed710c0 ("ubi: Rework Fastmap attach base code")
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c)

| -rw-r--r-- | [drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/ubi/attach.c?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/mtd/ubi/attach.c b/drivers/mtd/ubi/attach.cindex ae5abe492b52ab..adc47b87b38a5f 100644--- a/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=8214951280a25e1260ee6dbf472b261b63b29af2)+++ b/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c)@@ -1447,7 +1447,7 @@ out\_ech: return err; } -static struct ubi\_attach\_info \*alloc\_ai(void)+static struct ubi\_attach\_info \*alloc\_ai(const char \*slab\_name) { struct ubi\_attach\_info \*ai; @@ -1461,7 +1461,7 @@ static struct ubi\_attach\_info \*alloc\_ai(void) INIT\_LIST\_HEAD(&ai->alien); INIT\_LIST\_HEAD(&ai->fastmap); ai->volumes = RB\_ROOT;- ai->aeb\_slab\_cache = kmem\_cache\_create("ubi\_aeb\_slab\_cache",+ ai->aeb\_slab\_cache = kmem\_cache\_create(slab\_name, sizeof(struct ubi\_ainf\_peb), 0, 0, NULL); if (!ai->aeb\_slab\_cache) {@@ -1491,7 +1491,7 @@ static int scan\_fast(struct ubi\_device \*ubi, struct ubi\_attach\_info \*\*ai)  err = -ENOMEM; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_fastmap"); if (!scan\_ai) goto out; @@ -1557,7 +1557,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) int err; struct ubi\_attach\_info \*ai; - ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1575,7 +1575,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (err > 0 || mtd\_is\_eccerr(err)) { if (err != UBI\_NO\_FASTMAP) { destroy\_ai(ai);- ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1614,7 +1614,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (ubi->fm && ubi\_dbg\_chk\_fastmap(ubi)) { struct ubi\_attach\_info \*scan\_ai; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_dbg\_chk\_fastmap"); if (!scan\_ai) { err = -ENOMEM; goto out\_wl; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:18 +0000



=== Content from git.kernel.org_faa6d7fe_20250114_190739.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2024-10-11 12:50:02 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:03:04 +0100 |
| commit | [7402c4bcb8a3f0d2ef4e687cd45c76be489cf509](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509)) | |
| tree | [d09f7b0aa70b80a958ad63099b611b1ce8c94bf0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509) | |
| parent | [7f0b3524a6c26ccde2588b611bdb17242cd7c86c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f0b3524a6c26ccde2588b611bdb17242cd7c86c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509&id2=7f0b3524a6c26ccde2588b611bdb17242cd7c86c)) | |
| download | [linux-7402c4bcb8a3f0d2ef4e687cd45c76be489cf509.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7402c4bcb8a3f0d2ef4e687cd45c76be489cf509.tar.gz) | |

ubi: fastmap: Fix duplicate slab cache names while attaching[ Upstream commit bcddf52b7a17adcebc768d26f4e27cf79adb424c ]
Since commit 4c39529663b9 ("slab: Warn on duplicate cache names when
DEBUG\_VM=y"), the duplicate slab cache names can be detected and a
kernel WARNING is thrown out.
In UBI fast attaching process, alloc\_ai() could be invoked twice
with the same slab cache name 'ubi\_aeb\_slab\_cache', which will trigger
following warning messages:
kmem\_cache of name 'ubi\_aeb\_slab\_cache' already exists
WARNING: CPU: 0 PID: 7519 at mm/slab\_common.c:107
\_\_kmem\_cache\_create\_args+0x100/0x5f0
Modules linked in: ubi(+) nandsim [last unloaded: nandsim]
CPU: 0 UID: 0 PID: 7519 Comm: modprobe Tainted: G 6.12.0-rc2
RIP: 0010:\_\_kmem\_cache\_create\_args+0x100/0x5f0
Call Trace:
\_\_kmem\_cache\_create\_args+0x100/0x5f0
alloc\_ai+0x295/0x3f0 [ubi]
ubi\_attach+0x3c3/0xcc0 [ubi]
ubi\_attach\_mtd\_dev+0x17cf/0x3fa0 [ubi]
ubi\_init+0x3fb/0x800 [ubi]
do\_init\_module+0x265/0x7d0
\_\_x64\_sys\_finit\_module+0x7a/0xc0
The problem could be easily reproduced by loading UBI device by fastmap
with CONFIG\_DEBUG\_VM=y.
Fix it by using different slab names for alloc\_ai() callers.
Fixes: d2158f69a7d4 ("UBI: Remove alloc\_ai() slab name from parameter list")
Fixes: fdf10ed710c0 ("ubi: Rework Fastmap attach base code")
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509)

| -rw-r--r-- | [drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/ubi/attach.c?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/mtd/ubi/attach.c b/drivers/mtd/ubi/attach.cindex ae5abe492b52ab..adc47b87b38a5f 100644--- a/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=7f0b3524a6c26ccde2588b611bdb17242cd7c86c)+++ b/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509)@@ -1447,7 +1447,7 @@ out\_ech: return err; } -static struct ubi\_attach\_info \*alloc\_ai(void)+static struct ubi\_attach\_info \*alloc\_ai(const char \*slab\_name) { struct ubi\_attach\_info \*ai; @@ -1461,7 +1461,7 @@ static struct ubi\_attach\_info \*alloc\_ai(void) INIT\_LIST\_HEAD(&ai->alien); INIT\_LIST\_HEAD(&ai->fastmap); ai->volumes = RB\_ROOT;- ai->aeb\_slab\_cache = kmem\_cache\_create("ubi\_aeb\_slab\_cache",+ ai->aeb\_slab\_cache = kmem\_cache\_create(slab\_name, sizeof(struct ubi\_ainf\_peb), 0, 0, NULL); if (!ai->aeb\_slab\_cache) {@@ -1491,7 +1491,7 @@ static int scan\_fast(struct ubi\_device \*ubi, struct ubi\_attach\_info \*\*ai)  err = -ENOMEM; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_fastmap"); if (!scan\_ai) goto out; @@ -1557,7 +1557,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) int err; struct ubi\_attach\_info \*ai; - ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1575,7 +1575,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (err > 0 || mtd\_is\_eccerr(err)) { if (err != UBI\_NO\_FASTMAP) { destroy\_ai(ai);- ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1614,7 +1614,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (ubi->fm && ubi\_dbg\_chk\_fastmap(ubi)) { struct ubi\_attach\_info \*scan\_ai; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_dbg\_chk\_fastmap"); if (!scan\_ai) { err = -ENOMEM; goto out\_wl; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:15 +0000



=== Content from git.kernel.org_1a6bb85e_20250114_190741.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhihao Cheng <chengzhihao1@huawei.com> | 2024-10-11 12:50:02 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:42 +0100 |
| commit | [ef52b7191ac41e68b1bf070d00c5b04ed16e4920](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920)) | |
| tree | [3a9e019a24c41ba8fb4cd562333ec8ea89fd27fa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920) | |
| parent | [4be5be8e4dcb34c70ec4a50e5141354380e552dc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4be5be8e4dcb34c70ec4a50e5141354380e552dc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920&id2=4be5be8e4dcb34c70ec4a50e5141354380e552dc)) | |
| download | [linux-ef52b7191ac41e68b1bf070d00c5b04ed16e4920.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ef52b7191ac41e68b1bf070d00c5b04ed16e4920.tar.gz) | |

ubi: fastmap: Fix duplicate slab cache names while attaching[ Upstream commit bcddf52b7a17adcebc768d26f4e27cf79adb424c ]
Since commit 4c39529663b9 ("slab: Warn on duplicate cache names when
DEBUG\_VM=y"), the duplicate slab cache names can be detected and a
kernel WARNING is thrown out.
In UBI fast attaching process, alloc\_ai() could be invoked twice
with the same slab cache name 'ubi\_aeb\_slab\_cache', which will trigger
following warning messages:
kmem\_cache of name 'ubi\_aeb\_slab\_cache' already exists
WARNING: CPU: 0 PID: 7519 at mm/slab\_common.c:107
\_\_kmem\_cache\_create\_args+0x100/0x5f0
Modules linked in: ubi(+) nandsim [last unloaded: nandsim]
CPU: 0 UID: 0 PID: 7519 Comm: modprobe Tainted: G 6.12.0-rc2
RIP: 0010:\_\_kmem\_cache\_create\_args+0x100/0x5f0
Call Trace:
\_\_kmem\_cache\_create\_args+0x100/0x5f0
alloc\_ai+0x295/0x3f0 [ubi]
ubi\_attach+0x3c3/0xcc0 [ubi]
ubi\_attach\_mtd\_dev+0x17cf/0x3fa0 [ubi]
ubi\_init+0x3fb/0x800 [ubi]
do\_init\_module+0x265/0x7d0
\_\_x64\_sys\_finit\_module+0x7a/0xc0
The problem could be easily reproduced by loading UBI device by fastmap
with CONFIG\_DEBUG\_VM=y.
Fix it by using different slab names for alloc\_ai() callers.
Fixes: d2158f69a7d4 ("UBI: Remove alloc\_ai() slab name from parameter list")
Fixes: fdf10ed710c0 ("ubi: Rework Fastmap attach base code")
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920)

| -rw-r--r-- | [drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mtd/ubi/attach.c?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/mtd/ubi/attach.c b/drivers/mtd/ubi/attach.cindex 93ceea4f27d573..d62e5b69ba4b2d 100644--- a/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=4be5be8e4dcb34c70ec4a50e5141354380e552dc)+++ b/[drivers/mtd/ubi/attach.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mtd/ubi/attach.c?id=ef52b7191ac41e68b1bf070d00c5b04ed16e4920)@@ -1459,7 +1459,7 @@ out\_ech: return err; } -static struct ubi\_attach\_info \*alloc\_ai(void)+static struct ubi\_attach\_info \*alloc\_ai(const char \*slab\_name) { struct ubi\_attach\_info \*ai; @@ -1473,7 +1473,7 @@ static struct ubi\_attach\_info \*alloc\_ai(void) INIT\_LIST\_HEAD(&ai->alien); INIT\_LIST\_HEAD(&ai->fastmap); ai->volumes = RB\_ROOT;- ai->aeb\_slab\_cache = kmem\_cache\_create("ubi\_aeb\_slab\_cache",+ ai->aeb\_slab\_cache = kmem\_cache\_create(slab\_name, sizeof(struct ubi\_ainf\_peb), 0, 0, NULL); if (!ai->aeb\_slab\_cache) {@@ -1503,7 +1503,7 @@ static int scan\_fast(struct ubi\_device \*ubi, struct ubi\_attach\_info \*\*ai)  err = -ENOMEM; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_fastmap"); if (!scan\_ai) goto out; @@ -1569,7 +1569,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) int err; struct ubi\_attach\_info \*ai; - ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1587,7 +1587,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (err > 0 || mtd\_is\_eccerr(err)) { if (err != UBI\_NO\_FASTMAP) { destroy\_ai(ai);- ai = alloc\_ai();+ ai = alloc\_ai("ubi\_aeb\_slab\_cache"); if (!ai) return -ENOMEM; @@ -1626,7 +1626,7 @@ int ubi\_attach(struct ubi\_device \*ubi, int force\_scan) if (ubi->fm && ubi\_dbg\_chk\_fastmap(ubi)) { struct ubi\_attach\_info \*scan\_ai; - scan\_ai = alloc\_ai();+ scan\_ai = alloc\_ai("ubi\_aeb\_slab\_cache\_dbg\_chk\_fastmap"); if (!scan\_ai) { err = -ENOMEM; goto out\_wl; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:18 +0000


