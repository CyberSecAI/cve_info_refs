=== Content from git.kernel.org_14055ecf_20250114_181043.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=44f48eb9a6051826227bbd375446064fb2a43c6c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=44f48eb9a6051826227bbd375446064fb2a43c6c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=44f48eb9a6051826227bbd375446064fb2a43c6c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=44f48eb9a6051826227bbd375446064fb2a43c6c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lorenzo Stoakes <lorenzo.stoakes@oracle.com> | 2024-11-15 12:38:16 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:38 +0100 |
| commit | [44f48eb9a6051826227bbd375446064fb2a43c6c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=44f48eb9a6051826227bbd375446064fb2a43c6c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=44f48eb9a6051826227bbd375446064fb2a43c6c)) | |
| tree | [92785c926794eddac3eb52b94d3c07128f7a7ee8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=44f48eb9a6051826227bbd375446064fb2a43c6c) | |
| parent | [679d3a53eb02b1f93b59f421dccf52d006df11ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=679d3a53eb02b1f93b59f421dccf52d006df11ec) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=44f48eb9a6051826227bbd375446064fb2a43c6c&id2=679d3a53eb02b1f93b59f421dccf52d006df11ec)) | |
| download | [linux-44f48eb9a6051826227bbd375446064fb2a43c6c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-44f48eb9a6051826227bbd375446064fb2a43c6c.tar.gz) | |

mm: resolve faulty mmap\_region() error path behaviour[ Upstream commit 5de195060b2e251a835f622759550e6202167641 ]
The mmap\_region() function is somewhat terrifying, with spaghetti-like
control flow and numerous means by which issues can arise and incomplete
state, memory leaks and other unpleasantness can occur.
A large amount of the complexity arises from trying to handle errors late
in the process of mapping a VMA, which forms the basis of recently
observed issues with resource leaks and observable inconsistent state.
Taking advantage of previous patches in this series we move a number of
checks earlier in the code, simplifying things by moving the core of the
logic into a static internal function \_\_mmap\_region().
Doing this allows us to perform a number of checks up front before we do
any real work, and allows us to unwind the writable unmap check
unconditionally as required and to perform a CONFIG\_DEBUG\_VM\_MAPLE\_TREE
validation unconditionally also.
We move a number of things here:
1. We preallocate memory for the iterator before we call the file-backed
memory hook, allowing us to exit early and avoid having to perform
complicated and error-prone close/free logic. We carefully free
iterator state on both success and error paths.
2. The enclosing mmap\_region() function handles the mapping\_map\_writable()
logic early. Previously the logic had the mapping\_map\_writable() at the
point of mapping a newly allocated file-backed VMA, and a matching
mapping\_unmap\_writable() on success and error paths.
We now do this unconditionally if this is a file-backed, shared writable
mapping. If a driver changes the flags to eliminate VM\_MAYWRITE, however
doing so does not invalidate the seal check we just performed, and we in
any case always decrement the counter in the wrapper.
We perform a debug assert to ensure a driver does not attempt to do the
opposite.
3. We also move arch\_validate\_flags() up into the mmap\_region()
function. This is only relevant on arm64 and sparc64, and the check is
only meaningful for SPARC with ADI enabled. We explicitly add a warning
for this arch if a driver invalidates this check, though the code ought
eventually to be fixed to eliminate the need for this.
With all of these measures in place, we no longer need to explicitly close
the VMA on error paths, as we place all checks which might fail prior to a
call to any driver mmap hook.
This eliminates an entire class of errors, makes the code easier to reason
about and more robust.
Link: [https://lkml.kernel.org/r/6e0becb36d2f5472053ac5d544c0edfe9b899e25.1730224667.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/6e0becb36d2f5472053ac5d544c0edfe9b899e25.1730224667.git.lorenzo.stoakes%40oracle.com)
Fixes: deb0f6562884 ("mm/mmap: undo ->mmap() when arch\_validate\_flags() fails")
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Reported-by: Jann Horn <jannh@google.com>
Reviewed-by: Liam R. Howlett <Liam.Howlett@oracle.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Tested-by: Mark Brown <broonie@kernel.org>
Cc: Andreas Larsson <andreas@gaisler.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: David S. Miller <davem@davemloft.net>
Cc: Helge Deller <deller@gmx.de>
Cc: James E.J. Bottomley <James.Bottomley@HansenPartnership.com>
Cc: Linus Torvalds <torvalds@linux-foundation.org>
Cc: Peter Xu <peterx@redhat.com>
Cc: Will Deacon <will@kernel.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=44f48eb9a6051826227bbd375446064fb2a43c6c)

| -rw-r--r-- | [mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/mmap.c?id=44f48eb9a6051826227bbd375446064fb2a43c6c) | 73 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 47 insertions, 26 deletions

| diff --git a/mm/mmap.c b/mm/mmap.cindex a766b1c1af32d2..f8a2f15fc5a208 100644--- a/[mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mmap.c?id=679d3a53eb02b1f93b59f421dccf52d006df11ec)+++ b/[mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mmap.c?id=44f48eb9a6051826227bbd375446064fb2a43c6c)@@ -1716,7 +1716,7 @@ static inline int accountable\_mapping(struct file \*file, vm\_flags\_t vm\_flags) return (vm\_flags & (VM\_NORESERVE | VM\_SHARED | VM\_WRITE)) == VM\_WRITE; } -unsigned long mmap\_region(struct file \*file, unsigned long addr,+static unsigned long \_\_mmap\_region(struct file \*file, unsigned long addr, unsigned long len, vm\_flags\_t vm\_flags, unsigned long pgoff, struct list\_head \*uf) {@@ -1780,16 +1780,10 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, vma->vm\_pgoff = pgoff;  if (file) {- if (vm\_flags & VM\_SHARED) {- error = mapping\_map\_writable(file->f\_mapping);- if (error)- goto free\_vma;- }- vma->vm\_file = get\_file(file); error = mmap\_file(file, vma); if (error)- goto unmap\_and\_free\_vma;+ goto unmap\_and\_free\_file\_vma;  /\* Can addr have changed?? \*@@ -1800,6 +1794,14 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, \*/ WARN\_ON\_ONCE(addr != vma->vm\_start); + /\*+ \* Drivers should not permit writability when previously it was+ \* disallowed.+ \*/+ VM\_WARN\_ON\_ONCE(vm\_flags != vma->vm\_flags &&+ !(vm\_flags & VM\_MAYWRITE) &&+ (vma->vm\_flags & VM\_MAYWRITE));+ addr = vma->vm\_start;  /\* If vm\_flags changed after mmap\_file(), we should try merge vma again@@ -1818,7 +1820,7 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, vma = merge; /\* Update vm\_flags to pick up the change. \*/ vm\_flags = vma->vm\_flags;- goto unmap\_writable;+ goto file\_expanded; } } @@ -1831,20 +1833,13 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, vma\_set\_anonymous(vma); } - /\* Allow architectures to sanity-check the vm\_flags \*/- if (!arch\_validate\_flags(vma->vm\_flags)) {- error = -EINVAL;- if (file)- goto close\_and\_free\_vma;- else- goto free\_vma;- }+#ifdef CONFIG\_SPARC64+ /\* TODO: Fix SPARC ADI! \*/+ WARN\_ON\_ONCE(!arch\_validate\_flags(vm\_flags));+#endif  vma\_link(mm, vma, prev, rb\_link, rb\_parent);- /\* Once vma denies write, undo our temporary denial count \*/-unmap\_writable:- if (file && vm\_flags & VM\_SHARED)- mapping\_unmap\_writable(file->f\_mapping);+file\_expanded: file = vma->vm\_file; out: perf\_event\_mmap(vma);@@ -1875,16 +1870,12 @@ out:  return addr; -close\_and\_free\_vma:- vma\_close(vma);-unmap\_and\_free\_vma:+unmap\_and\_free\_file\_vma: fput(vma->vm\_file); vma->vm\_file = NULL;  /\* Undo any partial mapping done by a device driver. \*/ unmap\_region(mm, vma, prev, vma->vm\_start, vma->vm\_end);- if (vm\_flags & VM\_SHARED)- mapping\_unmap\_writable(file->f\_mapping); free\_vma: vm\_area\_free(vma); unacct\_error:@@ -2907,6 +2898,36 @@ int do\_munmap(struct mm\_struct \*mm, unsigned long start, size\_t len, return \_\_do\_munmap(mm, start, len, uf, false); } +unsigned long mmap\_region(struct file \*file, unsigned long addr,+ unsigned long len, vm\_flags\_t vm\_flags, unsigned long pgoff,+ struct list\_head \*uf)+{+ unsigned long ret;+ bool writable\_file\_mapping = false;++ /\* Allow architectures to sanity-check the vm\_flags. \*/+ if (!arch\_validate\_flags(vm\_flags))+ return -EINVAL;++ /\* Map writable and ensure this isn't a sealed memfd. \*/+ if (file && (vm\_flags & VM\_SHARED)) {+ int error = mapping\_map\_writable(file->f\_mapping);++ if (error)+ return error;+ writable\_file\_mapping = true;+ }++ ret = \_\_mmap\_region(file, addr, len, vm\_flags, pgoff, uf);++ /\* Clear our write mapping regardless of error. \*/+ if (writable\_file\_mapping)+ mapping\_unmap\_writable(file->f\_mapping);++ validate\_mm(current->mm);+ return ret;+}+ static int \_\_vm\_munmap(unsigned long start, size\_t len, bool downgrade) { int ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:09:20 +0000



=== Content from git.kernel.org_c92f4d5b_20250114_181044.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lorenzo Stoakes <lorenzo.stoakes@oracle.com> | 2024-11-15 12:41:58 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:38:37 +0100 |
| commit | [bdc136e2b05fabcd780fe5f165d154eb779dfcb0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0)) | |
| tree | [dbed45599c9534f82d54dd69a12bd0325ee1d4b8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0) | |
| parent | [04b7efa421dc64417967ede47a88af5aca2bf578](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04b7efa421dc64417967ede47a88af5aca2bf578) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0&id2=04b7efa421dc64417967ede47a88af5aca2bf578)) | |
| download | [linux-bdc136e2b05fabcd780fe5f165d154eb779dfcb0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bdc136e2b05fabcd780fe5f165d154eb779dfcb0.tar.gz) | |

mm: resolve faulty mmap\_region() error path behaviour[ Upstream commit 5de195060b2e251a835f622759550e6202167641 ]
The mmap\_region() function is somewhat terrifying, with spaghetti-like
control flow and numerous means by which issues can arise and incomplete
state, memory leaks and other unpleasantness can occur.
A large amount of the complexity arises from trying to handle errors late
in the process of mapping a VMA, which forms the basis of recently
observed issues with resource leaks and observable inconsistent state.
Taking advantage of previous patches in this series we move a number of
checks earlier in the code, simplifying things by moving the core of the
logic into a static internal function \_\_mmap\_region().
Doing this allows us to perform a number of checks up front before we do
any real work, and allows us to unwind the writable unmap check
unconditionally as required and to perform a CONFIG\_DEBUG\_VM\_MAPLE\_TREE
validation unconditionally also.
We move a number of things here:
1. We preallocate memory for the iterator before we call the file-backed
memory hook, allowing us to exit early and avoid having to perform
complicated and error-prone close/free logic. We carefully free
iterator state on both success and error paths.
2. The enclosing mmap\_region() function handles the mapping\_map\_writable()
logic early. Previously the logic had the mapping\_map\_writable() at the
point of mapping a newly allocated file-backed VMA, and a matching
mapping\_unmap\_writable() on success and error paths.
We now do this unconditionally if this is a file-backed, shared writable
mapping. If a driver changes the flags to eliminate VM\_MAYWRITE, however
doing so does not invalidate the seal check we just performed, and we in
any case always decrement the counter in the wrapper.
We perform a debug assert to ensure a driver does not attempt to do the
opposite.
3. We also move arch\_validate\_flags() up into the mmap\_region()
function. This is only relevant on arm64 and sparc64, and the check is
only meaningful for SPARC with ADI enabled. We explicitly add a warning
for this arch if a driver invalidates this check, though the code ought
eventually to be fixed to eliminate the need for this.
With all of these measures in place, we no longer need to explicitly close
the VMA on error paths, as we place all checks which might fail prior to a
call to any driver mmap hook.
This eliminates an entire class of errors, makes the code easier to reason
about and more robust.
Link: [https://lkml.kernel.org/r/6e0becb36d2f5472053ac5d544c0edfe9b899e25.1730224667.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/6e0becb36d2f5472053ac5d544c0edfe9b899e25.1730224667.git.lorenzo.stoakes%40oracle.com)
Fixes: deb0f6562884 ("mm/mmap: undo ->mmap() when arch\_validate\_flags() fails")
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Reported-by: Jann Horn <jannh@google.com>
Reviewed-by: Liam R. Howlett <Liam.Howlett@oracle.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Tested-by: Mark Brown <broonie@kernel.org>
Cc: Andreas Larsson <andreas@gaisler.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: David S. Miller <davem@davemloft.net>
Cc: Helge Deller <deller@gmx.de>
Cc: James E.J. Bottomley <James.Bottomley@HansenPartnership.com>
Cc: Linus Torvalds <torvalds@linux-foundation.org>
Cc: Peter Xu <peterx@redhat.com>
Cc: Will Deacon <will@kernel.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0)

| -rw-r--r-- | [mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/mmap.c?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 66 insertions, 49 deletions

| diff --git a/mm/mmap.c b/mm/mmap.cindex fca3429da2fe32..e4dfeaef668a8e 100644--- a/[mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mmap.c?id=04b7efa421dc64417967ede47a88af5aca2bf578)+++ b/[mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mmap.c?id=bdc136e2b05fabcd780fe5f165d154eb779dfcb0)@@ -2666,14 +2666,14 @@ int do\_munmap(struct mm\_struct \*mm, unsigned long start, size\_t len, return do\_vmi\_munmap(&vmi, mm, start, len, uf, false); } -unsigned long mmap\_region(struct file \*file, unsigned long addr,+static unsigned long \_\_mmap\_region(struct file \*file, unsigned long addr, unsigned long len, vm\_flags\_t vm\_flags, unsigned long pgoff, struct list\_head \*uf) { struct mm\_struct \*mm = current->mm; struct vm\_area\_struct \*vma = NULL; struct vm\_area\_struct \*next, \*prev, \*merge;- pgoff\_t pglen = len >> PAGE\_SHIFT;+ pgoff\_t pglen = PHYS\_PFN(len); unsigned long charged = 0; unsigned long end = addr + len; unsigned long merge\_start = addr, merge\_end = end;@@ -2770,25 +2770,26 @@ cannot\_expand: vma->vm\_page\_prot = vm\_get\_page\_prot(vm\_flags); vma->vm\_pgoff = pgoff; - if (file) {- if (vm\_flags & VM\_SHARED) {- error = mapping\_map\_writable(file->f\_mapping);- if (error)- goto free\_vma;- }+ if (vma\_iter\_prealloc(&vmi, vma)) {+ error = -ENOMEM;+ goto free\_vma;+ } + if (file) { vma->vm\_file = get\_file(file); error = mmap\_file(file, vma); if (error)- goto unmap\_and\_free\_vma;+ goto unmap\_and\_free\_file\_vma; + /\* Drivers cannot alter the address of the VMA. \*/+ WARN\_ON\_ONCE(addr != vma->vm\_start); /\*- \* Expansion is handled above, merging is handled below.- \* Drivers should not alter the address of the VMA.+ \* Drivers should not permit writability when previously it was+ \* disallowed. \*/- error = -EINVAL;- if (WARN\_ON((addr != vma->vm\_start)))- goto close\_and\_free\_vma;+ VM\_WARN\_ON\_ONCE(vm\_flags != vma->vm\_flags &&+ !(vm\_flags & VM\_MAYWRITE) &&+ (vma->vm\_flags & VM\_MAYWRITE));  vma\_iter\_config(&vmi, addr, end); /\*@@ -2800,6 +2801,7 @@ cannot\_expand: vma->vm\_end, vma->vm\_flags, NULL, vma->vm\_file, vma->vm\_pgoff, NULL, NULL\_VM\_UFFD\_CTX, NULL);+ if (merge) { /\* \* ->mmap() can change vma->vm\_file and fput@@ -2813,7 +2815,7 @@ cannot\_expand: vma = merge; /\* Update vm\_flags to pick up the change. \*/ vm\_flags = vma->vm\_flags;- goto unmap\_writable;+ goto file\_expanded; } } @@ -2821,24 +2823,15 @@ cannot\_expand: } else if (vm\_flags & VM\_SHARED) { error = shmem\_zero\_setup(vma); if (error)- goto free\_vma;+ goto free\_iter\_vma; } else { vma\_set\_anonymous(vma); } - if (map\_deny\_write\_exec(vma->vm\_flags, vma->vm\_flags)) {- error = -EACCES;- goto close\_and\_free\_vma;- }-- /\* Allow architectures to sanity-check the vm\_flags \*/- error = -EINVAL;- if (!arch\_validate\_flags(vma->vm\_flags))- goto close\_and\_free\_vma;-- error = -ENOMEM;- if (vma\_iter\_prealloc(&vmi, vma))- goto close\_and\_free\_vma;+#ifdef CONFIG\_SPARC64+ /\* TODO: Fix SPARC ADI! \*/+ WARN\_ON\_ONCE(!arch\_validate\_flags(vm\_flags));+#endif  /\* Lock the VMA since it is modified after insertion into VMA tree \*/ vma\_start\_write(vma);@@ -2861,10 +2854,7 @@ cannot\_expand: \*/ khugepaged\_enter\_vma(vma, vma->vm\_flags); - /\* Once vma denies write, undo our temporary denial count \*/-unmap\_writable:- if (file && vm\_flags & VM\_SHARED)- mapping\_unmap\_writable(file->f\_mapping);+file\_expanded: file = vma->vm\_file; ksm\_add\_vma(vma); expanded:@@ -2894,33 +2884,60 @@ expanded:  vma\_set\_page\_prot(vma); - validate\_mm(mm); return addr; -close\_and\_free\_vma:- vma\_close(vma);-- if (file || vma->vm\_file) {-unmap\_and\_free\_vma:- fput(vma->vm\_file);- vma->vm\_file = NULL;+unmap\_and\_free\_file\_vma:+ fput(vma->vm\_file);+ vma->vm\_file = NULL; - vma\_iter\_set(&vmi, vma->vm\_end);- /\* Undo any partial mapping done by a device driver. \*/- unmap\_region(mm, &vmi.mas, vma, prev, next, vma->vm\_start,- vma->vm\_end, vma->vm\_end, true);- }- if (file && (vm\_flags & VM\_SHARED))- mapping\_unmap\_writable(file->f\_mapping);+ vma\_iter\_set(&vmi, vma->vm\_end);+ /\* Undo any partial mapping done by a device driver. \*/+ unmap\_region(mm, &vmi.mas, vma, prev, next, vma->vm\_start,+ vma->vm\_end, vma->vm\_end, true);+free\_iter\_vma:+ vma\_iter\_free(&vmi); free\_vma: vm\_area\_free(vma); unacct\_error: if (charged) vm\_unacct\_memory(charged);- validate\_mm(mm); return error; } +unsigned long mmap\_region(struct file \*file, unsigned long addr,+ unsigned long len, vm\_flags\_t vm\_flags, unsigned long pgoff,+ struct list\_head \*uf)+{+ unsigned long ret;+ bool writable\_file\_mapping = false;++ /\* Check to see if MDWE is applicable. \*/+ if (map\_deny\_write\_exec(vm\_flags, vm\_flags))+ return -EACCES;++ /\* Allow architectures to sanity-check the vm\_flags. \*/+ if (!arch\_validate\_flags(vm\_flags))+ return -EINVAL;++ /\* Map writable and ensure this isn't a sealed memfd. \*/+ if (file && (vm\_flags & VM\_SHARED)) {+ int error = mapping\_map\_writable(file->f\_mapping);++ if (error)+ return error;+ writable\_file\_mapping = true;+ }++ ret = \_\_mmap\_region(file, addr, len, vm\_flags, pgoff, uf);++ /\* Clear our write mapping regardless of error. \*/+ if (writable\_file\_mapping)+ mapping\_unmap\_writable(file->f\_mapping);++ validate\_mm(current->mm);+ return ret;+}+ static int \_\_vm\_munmap(unsigned long start, size\_t len, bool unlock) { int ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:09:22 +0000



=== Content from git.kernel.org_653fe41c_20250114_181044.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5de195060b2e251a835f622759550e6202167641)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5de195060b2e251a835f622759550e6202167641)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5de195060b2e251a835f622759550e6202167641)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5de195060b2e251a835f622759550e6202167641)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lorenzo Stoakes <lorenzo.stoakes@oracle.com> | 2024-10-29 18:11:48 +0000 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-11-05 16:49:55 -0800 |
| commit | [5de195060b2e251a835f622759550e6202167641](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5de195060b2e251a835f622759550e6202167641) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5de195060b2e251a835f622759550e6202167641)) | |
| tree | [5ede389e5538fe04df42fcf4835d8954b5419939](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5de195060b2e251a835f622759550e6202167641) | |
| parent | [5baf8b037debf4ec60108ccfeccb8636d1dbad81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5baf8b037debf4ec60108ccfeccb8636d1dbad81) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5de195060b2e251a835f622759550e6202167641&id2=5baf8b037debf4ec60108ccfeccb8636d1dbad81)) | |
| download | [linux-5de195060b2e251a835f622759550e6202167641.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5de195060b2e251a835f622759550e6202167641.tar.gz) | |

mm: resolve faulty mmap\_region() error path behaviourThe mmap\_region() function is somewhat terrifying, with spaghetti-like
control flow and numerous means by which issues can arise and incomplete
state, memory leaks and other unpleasantness can occur.
A large amount of the complexity arises from trying to handle errors late
in the process of mapping a VMA, which forms the basis of recently
observed issues with resource leaks and observable inconsistent state.
Taking advantage of previous patches in this series we move a number of
checks earlier in the code, simplifying things by moving the core of the
logic into a static internal function \_\_mmap\_region().
Doing this allows us to perform a number of checks up front before we do
any real work, and allows us to unwind the writable unmap check
unconditionally as required and to perform a CONFIG\_DEBUG\_VM\_MAPLE\_TREE
validation unconditionally also.
We move a number of things here:
1. We preallocate memory for the iterator before we call the file-backed
memory hook, allowing us to exit early and avoid having to perform
complicated and error-prone close/free logic. We carefully free
iterator state on both success and error paths.
2. The enclosing mmap\_region() function handles the mapping\_map\_writable()
logic early. Previously the logic had the mapping\_map\_writable() at the
point of mapping a newly allocated file-backed VMA, and a matching
mapping\_unmap\_writable() on success and error paths.
We now do this unconditionally if this is a file-backed, shared writable
mapping. If a driver changes the flags to eliminate VM\_MAYWRITE, however
doing so does not invalidate the seal check we just performed, and we in
any case always decrement the counter in the wrapper.
We perform a debug assert to ensure a driver does not attempt to do the
opposite.
3. We also move arch\_validate\_flags() up into the mmap\_region()
function. This is only relevant on arm64 and sparc64, and the check is
only meaningful for SPARC with ADI enabled. We explicitly add a warning
for this arch if a driver invalidates this check, though the code ought
eventually to be fixed to eliminate the need for this.
With all of these measures in place, we no longer need to explicitly close
the VMA on error paths, as we place all checks which might fail prior to a
call to any driver mmap hook.
This eliminates an entire class of errors, makes the code easier to reason
about and more robust.
Link: [https://lkml.kernel.org/r/6e0becb36d2f5472053ac5d544c0edfe9b899e25.1730224667.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/6e0becb36d2f5472053ac5d544c0edfe9b899e25.1730224667.git.lorenzo.stoakes%40oracle.com)
Fixes: deb0f6562884 ("mm/mmap: undo ->mmap() when arch\_validate\_flags() fails")
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Reported-by: Jann Horn <jannh@google.com>
Reviewed-by: Liam R. Howlett <Liam.Howlett@oracle.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Tested-by: Mark Brown <broonie@kernel.org>
Cc: Andreas Larsson <andreas@gaisler.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: David S. Miller <davem@davemloft.net>
Cc: Helge Deller <deller@gmx.de>
Cc: James E.J. Bottomley <James.Bottomley@HansenPartnership.com>
Cc: Linus Torvalds <torvalds@linux-foundation.org>
Cc: Peter Xu <peterx@redhat.com>
Cc: Will Deacon <will@kernel.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5de195060b2e251a835f622759550e6202167641)

| -rw-r--r-- | [mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/mmap.c?id=5de195060b2e251a835f622759550e6202167641) | 119 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 65 insertions, 54 deletions

| diff --git a/mm/mmap.c b/mm/mmap.cindex aee5fa08ae5d1f..79d541f1502b22 100644--- a/[mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mmap.c?id=5baf8b037debf4ec60108ccfeccb8636d1dbad81)+++ b/[mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mmap.c?id=5de195060b2e251a835f622759550e6202167641)@@ -1358,20 +1358,18 @@ int do\_munmap(struct mm\_struct \*mm, unsigned long start, size\_t len, return do\_vmi\_munmap(&vmi, mm, start, len, uf, false); } -unsigned long mmap\_region(struct file \*file, unsigned long addr,+static unsigned long \_\_mmap\_region(struct file \*file, unsigned long addr, unsigned long len, vm\_flags\_t vm\_flags, unsigned long pgoff, struct list\_head \*uf) { struct mm\_struct \*mm = current->mm; struct vm\_area\_struct \*vma = NULL; pgoff\_t pglen = PHYS\_PFN(len);- struct vm\_area\_struct \*merge; unsigned long charged = 0; struct vma\_munmap\_struct vms; struct ma\_state mas\_detach; struct maple\_tree mt\_detach; unsigned long end = addr + len;- bool writable\_file\_mapping = false; int error; VMA\_ITERATOR(vmi, mm, addr); VMG\_STATE(vmg, mm, &vmi, addr, end, vm\_flags, pgoff);@@ -1445,28 +1443,26 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, vm\_flags\_init(vma, vm\_flags); vma->vm\_page\_prot = vm\_get\_page\_prot(vm\_flags); + if (vma\_iter\_prealloc(&vmi, vma)) {+ error = -ENOMEM;+ goto free\_vma;+ }+ if (file) { vma->vm\_file = get\_file(file); error = mmap\_file(file, vma); if (error)- goto unmap\_and\_free\_vma;-- if (vma\_is\_shared\_maywrite(vma)) {- error = mapping\_map\_writable(file->f\_mapping);- if (error)- goto close\_and\_free\_vma;-- writable\_file\_mapping = true;- }+ goto unmap\_and\_free\_file\_vma; + /\* Drivers cannot alter the address of the VMA. \*/+ WARN\_ON\_ONCE(addr != vma->vm\_start); /\*- \* Expansion is handled above, merging is handled below.- \* Drivers should not alter the address of the VMA.+ \* Drivers should not permit writability when previously it was+ \* disallowed. \*/- if (WARN\_ON((addr != vma->vm\_start))) {- error = -EINVAL;- goto close\_and\_free\_vma;- }+ VM\_WARN\_ON\_ONCE(vm\_flags != vma->vm\_flags &&+ !(vm\_flags & VM\_MAYWRITE) &&+ (vma->vm\_flags & VM\_MAYWRITE));  vma\_iter\_config(&vmi, addr, end); /\*@@ -1474,6 +1470,8 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, \* vma again as we may succeed this time. \*/ if (unlikely(vm\_flags != vma->vm\_flags && vmg.prev)) {+ struct vm\_area\_struct \*merge;+ vmg.flags = vma->vm\_flags; /\* If this fails, state is reset ready for a reattempt. \*/ merge = vma\_merge\_new\_range(&vmg);@@ -1491,7 +1489,7 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, vma = merge; /\* Update vm\_flags to pick up the change. \*/ vm\_flags = vma->vm\_flags;- goto unmap\_writable;+ goto file\_expanded; } vma\_iter\_config(&vmi, addr, end); }@@ -1500,26 +1498,15 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, } else if (vm\_flags & VM\_SHARED) { error = shmem\_zero\_setup(vma); if (error)- goto free\_vma;+ goto free\_iter\_vma; } else { vma\_set\_anonymous(vma); } - if (map\_deny\_write\_exec(vma->vm\_flags, vma->vm\_flags)) {- error = -EACCES;- goto close\_and\_free\_vma;- }-- /\* Allow architectures to sanity-check the vm\_flags \*/- if (!arch\_validate\_flags(vma->vm\_flags)) {- error = -EINVAL;- goto close\_and\_free\_vma;- }-- if (vma\_iter\_prealloc(&vmi, vma)) {- error = -ENOMEM;- goto close\_and\_free\_vma;- }+#ifdef CONFIG\_SPARC64+ /\* TODO: Fix SPARC ADI! \*/+ WARN\_ON\_ONCE(!arch\_validate\_flags(vm\_flags));+#endif  /\* Lock the VMA since it is modified after insertion into VMA tree \*/ vma\_start\_write(vma);@@ -1533,10 +1520,7 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, \*/ khugepaged\_enter\_vma(vma, vma->vm\_flags); - /\* Once vma denies write, undo our temporary denial count \*/-unmap\_writable:- if (writable\_file\_mapping)- mapping\_unmap\_writable(file->f\_mapping);+file\_expanded: file = vma->vm\_file; ksm\_add\_vma(vma); expanded:@@ -1569,23 +1553,17 @@ expanded:  vma\_set\_page\_prot(vma); - validate\_mm(mm); return addr; -close\_and\_free\_vma:- vma\_close(vma);-- if (file || vma->vm\_file) {-unmap\_and\_free\_vma:- fput(vma->vm\_file);- vma->vm\_file = NULL;+unmap\_and\_free\_file\_vma:+ fput(vma->vm\_file);+ vma->vm\_file = NULL; - vma\_iter\_set(&vmi, vma->vm\_end);- /\* Undo any partial mapping done by a device driver. \*/- unmap\_region(&vmi.mas, vma, vmg.prev, vmg.next);- }- if (writable\_file\_mapping)- mapping\_unmap\_writable(file->f\_mapping);+ vma\_iter\_set(&vmi, vma->vm\_end);+ /\* Undo any partial mapping done by a device driver. \*/+ unmap\_region(&vmi.mas, vma, vmg.prev, vmg.next);+free\_iter\_vma:+ vma\_iter\_free(&vmi); free\_vma: vm\_area\_free(vma); unacct\_error:@@ -1595,10 +1573,43 @@ unacct\_error: abort\_munmap: vms\_abort\_munmap\_vmas(&vms, &mas\_detach); gather\_failed:- validate\_mm(mm); return error; } +unsigned long mmap\_region(struct file \*file, unsigned long addr,+ unsigned long len, vm\_flags\_t vm\_flags, unsigned long pgoff,+ struct list\_head \*uf)+{+ unsigned long ret;+ bool writable\_file\_mapping = false;++ /\* Check to see if MDWE is applicable. \*/+ if (map\_deny\_write\_exec(vm\_flags, vm\_flags))+ return -EACCES;++ /\* Allow architectures to sanity-check the vm\_flags. \*/+ if (!arch\_validate\_flags(vm\_flags))+ return -EINVAL;++ /\* Map writable and ensure this isn't a sealed memfd. \*/+ if (file && is\_shared\_maywrite(vm\_flags)) {+ int error = mapping\_map\_writable(file->f\_mapping);++ if (error)+ return error;+ writable\_file\_mapping = true;+ }++ ret = \_\_mmap\_region(file, addr, len, vm\_flags, pgoff, uf);++ /\* Clear our write mapping regardless of error. \*/+ if (writable\_file\_mapping)+ mapping\_unmap\_writable(file->f\_mapping);++ validate\_mm(current->mm);+ return ret;+}+ static int \_\_vm\_munmap(unsigned long start, size\_t len, bool unlock) { int ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:09:21 +0000



=== Content from git.kernel.org_8861c289_20250114_181043.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lorenzo Stoakes <lorenzo.stoakes@oracle.com> | 2024-11-18 16:17:28 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:37:34 +0100 |
| commit | [52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8)) | |
| tree | [6417ad606f666fbe6fbda956492cc1fdb77d0f4b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8) | |
| parent | [8fad7b004be8dc46eb801172ea62b0a2000fcf82](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8fad7b004be8dc46eb801172ea62b0a2000fcf82) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8&id2=8fad7b004be8dc46eb801172ea62b0a2000fcf82)) | |
| download | [linux-52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8.tar.gz) | |

mm: resolve faulty mmap\_region() error path behaviour[ Upstream commit 5de195060b2e251a835f622759550e6202167641 ]
The mmap\_region() function is somewhat terrifying, with spaghetti-like
control flow and numerous means by which issues can arise and incomplete
state, memory leaks and other unpleasantness can occur.
A large amount of the complexity arises from trying to handle errors late
in the process of mapping a VMA, which forms the basis of recently
observed issues with resource leaks and observable inconsistent state.
Taking advantage of previous patches in this series we move a number of
checks earlier in the code, simplifying things by moving the core of the
logic into a static internal function \_\_mmap\_region().
Doing this allows us to perform a number of checks up front before we do
any real work, and allows us to unwind the writable unmap check
unconditionally as required and to perform a CONFIG\_DEBUG\_VM\_MAPLE\_TREE
validation unconditionally also.
We move a number of things here:
1. We preallocate memory for the iterator before we call the file-backed
memory hook, allowing us to exit early and avoid having to perform
complicated and error-prone close/free logic. We carefully free
iterator state on both success and error paths.
2. The enclosing mmap\_region() function handles the mapping\_map\_writable()
logic early. Previously the logic had the mapping\_map\_writable() at the
point of mapping a newly allocated file-backed VMA, and a matching
mapping\_unmap\_writable() on success and error paths.
We now do this unconditionally if this is a file-backed, shared writable
mapping. If a driver changes the flags to eliminate VM\_MAYWRITE, however
doing so does not invalidate the seal check we just performed, and we in
any case always decrement the counter in the wrapper.
We perform a debug assert to ensure a driver does not attempt to do the
opposite.
3. We also move arch\_validate\_flags() up into the mmap\_region()
function. This is only relevant on arm64 and sparc64, and the check is
only meaningful for SPARC with ADI enabled. We explicitly add a warning
for this arch if a driver invalidates this check, though the code ought
eventually to be fixed to eliminate the need for this.
With all of these measures in place, we no longer need to explicitly close
the VMA on error paths, as we place all checks which might fail prior to a
call to any driver mmap hook.
This eliminates an entire class of errors, makes the code easier to reason
about and more robust.
Link: [https://lkml.kernel.org/r/6e0becb36d2f5472053ac5d544c0edfe9b899e25.1730224667.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/6e0becb36d2f5472053ac5d544c0edfe9b899e25.1730224667.git.lorenzo.stoakes%40oracle.com)
Fixes: deb0f6562884 ("mm/mmap: undo ->mmap() when arch\_validate\_flags() fails")
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Reported-by: Jann Horn <jannh@google.com>
Reviewed-by: Liam R. Howlett <Liam.Howlett@oracle.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Tested-by: Mark Brown <broonie@kernel.org>
Cc: Andreas Larsson <andreas@gaisler.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: David S. Miller <davem@davemloft.net>
Cc: Helge Deller <deller@gmx.de>
Cc: James E.J. Bottomley <James.Bottomley@HansenPartnership.com>
Cc: Linus Torvalds <torvalds@linux-foundation.org>
Cc: Peter Xu <peterx@redhat.com>
Cc: Will Deacon <will@kernel.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8)

| -rw-r--r-- | [mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/mmap.c?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8) | 104 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 57 insertions, 47 deletions

| diff --git a/mm/mmap.c b/mm/mmap.cindex 322677f61d3026..9a9933ede5423b 100644--- a/[mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mmap.c?id=8fad7b004be8dc46eb801172ea62b0a2000fcf82)+++ b/[mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mmap.c?id=52c81fd0f5a8bf8032687b94ccf00d13b44cc5c8)@@ -2652,7 +2652,7 @@ int do\_munmap(struct mm\_struct \*mm, unsigned long start, size\_t len, return do\_mas\_munmap(&mas, mm, start, len, uf, false); } -unsigned long mmap\_region(struct file \*file, unsigned long addr,+static unsigned long \_\_mmap\_region(struct file \*file, unsigned long addr, unsigned long len, vm\_flags\_t vm\_flags, unsigned long pgoff, struct list\_head \*uf) {@@ -2750,26 +2750,28 @@ cannot\_expand: vma->vm\_page\_prot = vm\_get\_page\_prot(vm\_flags); vma->vm\_pgoff = pgoff; - if (file) {- if (vm\_flags & VM\_SHARED) {- error = mapping\_map\_writable(file->f\_mapping);- if (error)- goto free\_vma;- }+ if (mas\_preallocate(&mas, vma, GFP\_KERNEL)) {+ error = -ENOMEM;+ goto free\_vma;+ } + if (file) { vma->vm\_file = get\_file(file); error = mmap\_file(file, vma); if (error)- goto unmap\_and\_free\_vma;+ goto unmap\_and\_free\_file\_vma;++ /\* Drivers cannot alter the address of the VMA. \*/+ WARN\_ON\_ONCE(addr != vma->vm\_start);  /\*- \* Expansion is handled above, merging is handled below.- \* Drivers should not alter the address of the VMA.+ \* Drivers should not permit writability when previously it was+ \* disallowed. \*/- if (WARN\_ON((addr != vma->vm\_start))) {- error = -EINVAL;- goto close\_and\_free\_vma;- }+ VM\_WARN\_ON\_ONCE(vm\_flags != vma->vm\_flags &&+ !(vm\_flags & VM\_MAYWRITE) &&+ (vma->vm\_flags & VM\_MAYWRITE));+ mas\_reset(&mas);  /\*@@ -2792,7 +2794,8 @@ cannot\_expand: vma = merge; /\* Update vm\_flags to pick up the change. \*/ vm\_flags = vma->vm\_flags;- goto unmap\_writable;+ mas\_destroy(&mas);+ goto file\_expanded; } } @@ -2800,31 +2803,15 @@ cannot\_expand: } else if (vm\_flags & VM\_SHARED) { error = shmem\_zero\_setup(vma); if (error)- goto free\_vma;+ goto free\_iter\_vma; } else { vma\_set\_anonymous(vma); } - /\* Allow architectures to sanity-check the vm\_flags \*/- if (!arch\_validate\_flags(vma->vm\_flags)) {- error = -EINVAL;- if (file)- goto close\_and\_free\_vma;- else if (vma->vm\_file)- goto unmap\_and\_free\_vma;- else- goto free\_vma;- }-- if (mas\_preallocate(&mas, vma, GFP\_KERNEL)) {- error = -ENOMEM;- if (file)- goto close\_and\_free\_vma;- else if (vma->vm\_file)- goto unmap\_and\_free\_vma;- else- goto free\_vma;- }+#ifdef CONFIG\_SPARC64+ /\* TODO: Fix SPARC ADI! \*/+ WARN\_ON\_ONCE(!arch\_validate\_flags(vm\_flags));+#endif  if (vma->vm\_file) i\_mmap\_lock\_write(vma->vm\_file->f\_mapping);@@ -2847,10 +2834,7 @@ cannot\_expand: \*/ khugepaged\_enter\_vma(vma, vma->vm\_flags); - /\* Once vma denies write, undo our temporary denial count \*/-unmap\_writable:- if (file && vm\_flags & VM\_SHARED)- mapping\_unmap\_writable(file->f\_mapping);+file\_expanded: file = vma->vm\_file; expanded: perf\_event\_mmap(vma);@@ -2879,28 +2863,54 @@ expanded:  vma\_set\_page\_prot(vma); - validate\_mm(mm); return addr; -close\_and\_free\_vma:- vma\_close(vma);-unmap\_and\_free\_vma:+unmap\_and\_free\_file\_vma: fput(vma->vm\_file); vma->vm\_file = NULL;  /\* Undo any partial mapping done by a device driver. \*/ unmap\_region(mm, mas.tree, vma, prev, next, vma->vm\_start, vma->vm\_end);- if (file && (vm\_flags & VM\_SHARED))- mapping\_unmap\_writable(file->f\_mapping);+free\_iter\_vma:+ mas\_destroy(&mas); free\_vma: vm\_area\_free(vma); unacct\_error: if (charged) vm\_unacct\_memory(charged);- validate\_mm(mm); return error; } +unsigned long mmap\_region(struct file \*file, unsigned long addr,+ unsigned long len, vm\_flags\_t vm\_flags, unsigned long pgoff,+ struct list\_head \*uf)+{+ unsigned long ret;+ bool writable\_file\_mapping = false;++ /\* Allow architectures to sanity-check the vm\_flags. \*/+ if (!arch\_validate\_flags(vm\_flags))+ return -EINVAL;++ /\* Map writable and ensure this isn't a sealed memfd. \*/+ if (file && (vm\_flags & VM\_SHARED)) {+ int error = mapping\_map\_writable(file->f\_mapping);++ if (error)+ return error;+ writable\_file\_mapping = true;+ }++ ret = \_\_mmap\_region(file, addr, len, vm\_flags, pgoff, uf);++ /\* Clear our write mapping regardless of error. \*/+ if (writable\_file\_mapping)+ mapping\_unmap\_writable(file->f\_mapping);++ validate\_mm(current->mm);+ return ret;+}+ static int \_\_vm\_munmap(unsigned long start, size\_t len, bool downgrade) { int ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:09:21 +0000



=== Content from project-zero.issues.chromium.org_74952bb2_20250114_181046.html ===
[Sign in](https://accounts.google.com/ServiceLogin?passive=1209600&osid=1&continue=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F374117290&followup=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F374117290&ec=GAZAkwI)

=== Content from git.kernel.org_2918acf6_20250114_181042.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lorenzo Stoakes <lorenzo.stoakes@oracle.com> | 2024-11-15 12:36:54 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:40 +0100 |
| commit | [43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed)) | |
| tree | [da1eb0e34f49b49482ff0b410669d14bd47935fb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed) | |
| parent | [a32712d54c61b4359e4bf00f6f805e301a89c534](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a32712d54c61b4359e4bf00f6f805e301a89c534) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed&id2=a32712d54c61b4359e4bf00f6f805e301a89c534)) | |
| download | [linux-43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed.tar.gz) | |

mm: resolve faulty mmap\_region() error path behaviour[ Upstream commit 5de195060b2e251a835f622759550e6202167641 ]
The mmap\_region() function is somewhat terrifying, with spaghetti-like
control flow and numerous means by which issues can arise and incomplete
state, memory leaks and other unpleasantness can occur.
A large amount of the complexity arises from trying to handle errors late
in the process of mapping a VMA, which forms the basis of recently
observed issues with resource leaks and observable inconsistent state.
Taking advantage of previous patches in this series we move a number of
checks earlier in the code, simplifying things by moving the core of the
logic into a static internal function \_\_mmap\_region().
Doing this allows us to perform a number of checks up front before we do
any real work, and allows us to unwind the writable unmap check
unconditionally as required and to perform a CONFIG\_DEBUG\_VM\_MAPLE\_TREE
validation unconditionally also.
We move a number of things here:
1. We preallocate memory for the iterator before we call the file-backed
memory hook, allowing us to exit early and avoid having to perform
complicated and error-prone close/free logic. We carefully free
iterator state on both success and error paths.
2. The enclosing mmap\_region() function handles the mapping\_map\_writable()
logic early. Previously the logic had the mapping\_map\_writable() at the
point of mapping a newly allocated file-backed VMA, and a matching
mapping\_unmap\_writable() on success and error paths.
We now do this unconditionally if this is a file-backed, shared writable
mapping. If a driver changes the flags to eliminate VM\_MAYWRITE, however
doing so does not invalidate the seal check we just performed, and we in
any case always decrement the counter in the wrapper.
We perform a debug assert to ensure a driver does not attempt to do the
opposite.
3. We also move arch\_validate\_flags() up into the mmap\_region()
function. This is only relevant on arm64 and sparc64, and the check is
only meaningful for SPARC with ADI enabled. We explicitly add a warning
for this arch if a driver invalidates this check, though the code ought
eventually to be fixed to eliminate the need for this.
With all of these measures in place, we no longer need to explicitly close
the VMA on error paths, as we place all checks which might fail prior to a
call to any driver mmap hook.
This eliminates an entire class of errors, makes the code easier to reason
about and more robust.
Link: [https://lkml.kernel.org/r/6e0becb36d2f5472053ac5d544c0edfe9b899e25.1730224667.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/6e0becb36d2f5472053ac5d544c0edfe9b899e25.1730224667.git.lorenzo.stoakes%40oracle.com)
Fixes: deb0f6562884 ("mm/mmap: undo ->mmap() when arch\_validate\_flags() fails")
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Reported-by: Jann Horn <jannh@google.com>
Reviewed-by: Liam R. Howlett <Liam.Howlett@oracle.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Tested-by: Mark Brown <broonie@kernel.org>
Cc: Andreas Larsson <andreas@gaisler.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: David S. Miller <davem@davemloft.net>
Cc: Helge Deller <deller@gmx.de>
Cc: James E.J. Bottomley <James.Bottomley@HansenPartnership.com>
Cc: Linus Torvalds <torvalds@linux-foundation.org>
Cc: Peter Xu <peterx@redhat.com>
Cc: Will Deacon <will@kernel.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed)

| -rw-r--r-- | [mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/mmap.c?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed) | 69 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 45 insertions, 24 deletions

| diff --git a/mm/mmap.c b/mm/mmap.cindex c30ebe82ebdb40..9f76625a17439f 100644--- a/[mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mmap.c?id=a32712d54c61b4359e4bf00f6f805e301a89c534)+++ b/[mm/mmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mmap.c?id=43323a4e5b3f8ccc08e2f835abfdc7ee9da8f6ed)@@ -1726,7 +1726,7 @@ static inline int accountable\_mapping(struct file \*file, vm\_flags\_t vm\_flags) return (vm\_flags & (VM\_NORESERVE | VM\_SHARED | VM\_WRITE)) == VM\_WRITE; } -unsigned long mmap\_region(struct file \*file, unsigned long addr,+static unsigned long \_\_mmap\_region(struct file \*file, unsigned long addr, unsigned long len, vm\_flags\_t vm\_flags, unsigned long pgoff, struct list\_head \*uf) {@@ -1795,11 +1795,6 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, if (error) goto free\_vma; }- if (vm\_flags & VM\_SHARED) {- error = mapping\_map\_writable(file->f\_mapping);- if (error)- goto allow\_write\_and\_free\_vma;- }  /\* ->mmap() can change vma->vm\_file, but must guarantee that \* vma\_link() below can deny write-access if VM\_DENYWRITE is set@@ -1809,7 +1804,7 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, vma->vm\_file = get\_file(file); error = mmap\_file(file, vma); if (error)- goto unmap\_and\_free\_vma;+ goto unmap\_and\_free\_file\_vma;  /\* Can addr have changed?? \*@@ -1820,6 +1815,14 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, \*/ WARN\_ON\_ONCE(addr != vma->vm\_start); + /\*+ \* Drivers should not permit writability when previously it was+ \* disallowed.+ \*/+ VM\_WARN\_ON\_ONCE(vm\_flags != vma->vm\_flags &&+ !(vm\_flags & VM\_MAYWRITE) &&+ (vma->vm\_flags & VM\_MAYWRITE));+ addr = vma->vm\_start;  /\* If vm\_flags changed after mmap\_file(), we should try merge vma again@@ -1851,21 +1854,14 @@ unsigned long mmap\_region(struct file \*file, unsigned long addr, vma\_set\_anonymous(vma); } - /\* Allow architectures to sanity-check the vm\_flags \*/- if (!arch\_validate\_flags(vma->vm\_flags)) {- error = -EINVAL;- if (file)- goto close\_and\_free\_vma;- else- goto free\_vma;- }+#ifdef CONFIG\_SPARC64+ /\* TODO: Fix SPARC ADI! \*/+ WARN\_ON\_ONCE(!arch\_validate\_flags(vm\_flags));+#endif  vma\_link(mm, vma, prev, rb\_link, rb\_parent);- /\* Once vma denies write, undo our temporary denial count \*/ if (file) { unmap\_writable:- if (vm\_flags & VM\_SHARED)- mapping\_unmap\_writable(file->f\_mapping); if (vm\_flags & VM\_DENYWRITE) allow\_write\_access(file); }@@ -1899,17 +1895,12 @@ out:  return addr; -close\_and\_free\_vma:- vma\_close(vma);-unmap\_and\_free\_vma:+unmap\_and\_free\_file\_vma: vma->vm\_file = NULL; fput(file);  /\* Undo any partial mapping done by a device driver. \*/ unmap\_region(mm, vma, prev, vma->vm\_start, vma->vm\_end);- if (vm\_flags & VM\_SHARED)- mapping\_unmap\_writable(file->f\_mapping);-allow\_write\_and\_free\_vma: if (vm\_flags & VM\_DENYWRITE) allow\_write\_access(file); free\_vma:@@ -2931,6 +2922,36 @@ int do\_munmap(struct mm\_struct \*mm, unsigned long start, size\_t len, return \_\_do\_munmap(mm, start, len, uf, false); } +unsigned long mmap\_region(struct file \*file, unsigned long addr,+ unsigned long len, vm\_flags\_t vm\_flags, unsigned long pgoff,+ struct list\_head \*uf)+{+ unsigned long ret;+ bool writable\_file\_mapping = false;++ /\* Allow architectures to sanity-check the vm\_flags. \*/+ if (!arch\_validate\_flags(vm\_flags))+ return -EINVAL;++ /\* Map writable and ensure this isn't a sealed memfd. \*/+ if (file && (vm\_flags & VM\_SHARED)) {+ int error = mapping\_map\_writable(file->f\_mapping);++ if (error)+ return error;+ writable\_file\_mapping = true;+ }++ ret = \_\_mmap\_region(file, addr, len, vm\_flags, pgoff, uf);++ /\* Clear our write mapping regardless of error. \*/+ if (writable\_file\_mapping)+ mapping\_unmap\_writable(file->f\_mapping);++ validate\_mm(current->mm);+ return ret;+}+ static int \_\_vm\_munmap(unsigned long start, size\_t len, bool downgrade) { int ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:09:20 +0000


