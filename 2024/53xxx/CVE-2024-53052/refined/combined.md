=== Content from git.kernel.org_44eb5d82_20250115_092434.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=003d2996964c03dfd34860500428f4cdf1f5879e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=003d2996964c03dfd34860500428f4cdf1f5879e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=003d2996964c03dfd34860500428f4cdf1f5879e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=003d2996964c03dfd34860500428f4cdf1f5879e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2024-10-31 08:05:44 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:26 +0100 |
| commit | [003d2996964c03dfd34860500428f4cdf1f5879e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=003d2996964c03dfd34860500428f4cdf1f5879e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=003d2996964c03dfd34860500428f4cdf1f5879e)) | |
| tree | [15ca49551a0210952e3bb30fd44b58bcf1e8a4b8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=003d2996964c03dfd34860500428f4cdf1f5879e) | |
| parent | [70bbe8d0a949413df1bb6532fd6b19fbf0f88feb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70bbe8d0a949413df1bb6532fd6b19fbf0f88feb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=003d2996964c03dfd34860500428f4cdf1f5879e&id2=70bbe8d0a949413df1bb6532fd6b19fbf0f88feb)) | |
| download | [linux-003d2996964c03dfd34860500428f4cdf1f5879e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-003d2996964c03dfd34860500428f4cdf1f5879e.tar.gz) | |

io\_uring/rw: fix missing NOWAIT check for O\_DIRECT start write[ Upstream commit 1d60d74e852647255bd8e76f5a22dc42531e4389 ]
When io\_uring starts a write, it'll call kiocb\_start\_write() to bump the
super block rwsem, preventing any freezes from happening while that
write is in-flight. The freeze side will grab that rwsem for writing,
excluding any new writers from happening and waiting for existing writes
to finish. But io\_uring unconditionally uses kiocb\_start\_write(), which
will block if someone is currently attempting to freeze the mount point.
This causes a deadlock where freeze is waiting for previous writes to
complete, but the previous writes cannot complete, as the task that is
supposed to complete them is blocked waiting on starting a new write.
This results in the following stuck trace showing that dependency with
the write blocked starting a new write:
task:fio state:D stack:0 pid:886 tgid:886 ppid:876
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_rwsem\_wait+0x1e8/0x3f8
\_\_percpu\_down\_read+0xe8/0x500
io\_write+0xbb8/0xff8
io\_issue\_sqe+0x10c/0x1020
io\_submit\_sqes+0x614/0x2110
\_\_arm64\_sys\_io\_uring\_enter+0x524/0x1038
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
INFO: task fsfreeze:7364 blocked for more than 15 seconds.
Not tainted 6.12.0-rc5-00063-g76aaf945701c #7963
with the attempting freezer stuck trying to grab the rwsem:
task:fsfreeze state:D stack:0 pid:7364 tgid:7364 ppid:995
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_down\_write+0x2b0/0x680
freeze\_super+0x248/0x8a8
do\_vfs\_ioctl+0x149c/0x1b18
\_\_arm64\_sys\_ioctl+0xd0/0x1a0
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
Fix this by having the io\_uring side honor IOCB\_NOWAIT, and only attempt a
blocking grab of the super block rwsem if it isn't set. For normal issue
where IOCB\_NOWAIT would always be set, this returns -EAGAIN which will
have io\_uring core issue a blocking attempt of the write. That will in
turn also get completions run, ensuring forward progress.
Since freezing requires CAP\_SYS\_ADMIN in the first place, this isn't
something that can be triggered by a regular user.
Cc: stable@vger.kernel.org # 5.10+
Reported-by: Peter Mann <peter.mann@sh.cz>
Link: [https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644@sh.cz](https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644%40sh.cz)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=003d2996964c03dfd34860500428f4cdf1f5879e)

| -rw-r--r-- | [io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/rw.c?id=003d2996964c03dfd34860500428f4cdf1f5879e) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 2 deletions

| diff --git a/io\_uring/rw.c b/io\_uring/rw.cindex 0a0c1c9db0f905..e90404c812fa25 100644--- a/[io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rw.c?id=70bbe8d0a949413df1bb6532fd6b19fbf0f88feb)+++ b/[io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rw.c?id=003d2996964c03dfd34860500428f4cdf1f5879e)@@ -860,6 +860,25 @@ done: return kiocb\_done(req, ret, issue\_flags); } +static bool io\_kiocb\_start\_write(struct io\_kiocb \*req, struct kiocb \*kiocb)+{+ struct inode \*inode;+ bool ret;++ if (!(req->flags & REQ\_F\_ISREG))+ return true;+ if (!(kiocb->ki\_flags & IOCB\_NOWAIT)) {+ kiocb\_start\_write(kiocb);+ return true;+ }++ inode = file\_inode(kiocb->ki\_filp);+ ret = sb\_start\_write\_trylock(inode->i\_sb);+ if (ret)+ \_\_sb\_writers\_release(inode->i\_sb, SB\_FREEZE\_WRITE);+ return ret;+}+ int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) { struct io\_rw \*rw = io\_kiocb\_to\_cmd(req, struct io\_rw);@@ -913,8 +932,8 @@ int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) return ret; } - if (req->flags & REQ\_F\_ISREG)- kiocb\_start\_write(kiocb);+ if (unlikely(!io\_kiocb\_start\_write(req, kiocb)))+ return -EAGAIN; kiocb->ki\_flags |= IOCB\_WRITE;  if (likely(req->file->f\_op->write\_iter)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:10 +0000



=== Content from git.kernel.org_15a47edc_20250115_092439.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=485d9232112b17f389b29497ff41b97b3189546b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=485d9232112b17f389b29497ff41b97b3189546b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=485d9232112b17f389b29497ff41b97b3189546b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=485d9232112b17f389b29497ff41b97b3189546b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2024-10-31 08:05:44 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:59:37 +0100 |
| commit | [485d9232112b17f389b29497ff41b97b3189546b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=485d9232112b17f389b29497ff41b97b3189546b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=485d9232112b17f389b29497ff41b97b3189546b)) | |
| tree | [2235556b29d70f5a2de8c8f5acd442e75068abd1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=485d9232112b17f389b29497ff41b97b3189546b) | |
| parent | [f336622838e595868da703c4de4f892a3320de57](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f336622838e595868da703c4de4f892a3320de57) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=485d9232112b17f389b29497ff41b97b3189546b&id2=f336622838e595868da703c4de4f892a3320de57)) | |
| download | [linux-485d9232112b17f389b29497ff41b97b3189546b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-485d9232112b17f389b29497ff41b97b3189546b.tar.gz) | |

io\_uring/rw: fix missing NOWAIT check for O\_DIRECT start writeCommit 1d60d74e852647255bd8e76f5a22dc42531e4389 upstream.
When io\_uring starts a write, it'll call kiocb\_start\_write() to bump the
super block rwsem, preventing any freezes from happening while that
write is in-flight. The freeze side will grab that rwsem for writing,
excluding any new writers from happening and waiting for existing writes
to finish. But io\_uring unconditionally uses kiocb\_start\_write(), which
will block if someone is currently attempting to freeze the mount point.
This causes a deadlock where freeze is waiting for previous writes to
complete, but the previous writes cannot complete, as the task that is
supposed to complete them is blocked waiting on starting a new write.
This results in the following stuck trace showing that dependency with
the write blocked starting a new write:
task:fio state:D stack:0 pid:886 tgid:886 ppid:876
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_rwsem\_wait+0x1e8/0x3f8
\_\_percpu\_down\_read+0xe8/0x500
io\_write+0xbb8/0xff8
io\_issue\_sqe+0x10c/0x1020
io\_submit\_sqes+0x614/0x2110
\_\_arm64\_sys\_io\_uring\_enter+0x524/0x1038
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
INFO: task fsfreeze:7364 blocked for more than 15 seconds.
Not tainted 6.12.0-rc5-00063-g76aaf945701c #7963
with the attempting freezer stuck trying to grab the rwsem:
task:fsfreeze state:D stack:0 pid:7364 tgid:7364 ppid:995
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_down\_write+0x2b0/0x680
freeze\_super+0x248/0x8a8
do\_vfs\_ioctl+0x149c/0x1b18
\_\_arm64\_sys\_ioctl+0xd0/0x1a0
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
Fix this by having the io\_uring side honor IOCB\_NOWAIT, and only attempt a
blocking grab of the super block rwsem if it isn't set. For normal issue
where IOCB\_NOWAIT would always be set, this returns -EAGAIN which will
have io\_uring core issue a blocking attempt of the write. That will in
turn also get completions run, ensuring forward progress.
Since freezing requires CAP\_SYS\_ADMIN in the first place, this isn't
something that can be triggered by a regular user.
Cc: stable@vger.kernel.org # 5.10+
Reported-by: Peter Mann <peter.mann@sh.cz>
Link: [https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644@sh.cz](https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644%40sh.cz)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=485d9232112b17f389b29497ff41b97b3189546b)

| -rw-r--r-- | [io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=485d9232112b17f389b29497ff41b97b3189546b) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 2 deletions

| diff --git a/io\_uring/io\_uring.c b/io\_uring/io\_uring.cindex a6afdea5cfd8eb..57c51e9638753d 100644--- a/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=f336622838e595868da703c4de4f892a3320de57)+++ b/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=485d9232112b17f389b29497ff41b97b3189546b)@@ -3719,6 +3719,25 @@ static int io\_write\_prep(struct io\_kiocb \*req, const struct io\_uring\_sqe \*sqe) return io\_prep\_rw(req, sqe, WRITE); } +static bool io\_kiocb\_start\_write(struct io\_kiocb \*req, struct kiocb \*kiocb)+{+ struct inode \*inode;+ bool ret;++ if (!(req->flags & REQ\_F\_ISREG))+ return true;+ if (!(kiocb->ki\_flags & IOCB\_NOWAIT)) {+ kiocb\_start\_write(kiocb);+ return true;+ }++ inode = file\_inode(kiocb->ki\_filp);+ ret = sb\_start\_write\_trylock(inode->i\_sb);+ if (ret)+ \_\_sb\_writers\_release(inode->i\_sb, SB\_FREEZE\_WRITE);+ return ret;+}+ static int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) { struct iovec inline\_vecs[UIO\_FASTIOV], \*iovec = inline\_vecs;@@ -3765,8 +3784,8 @@ static int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) if (unlikely(ret)) goto out\_free; - if (req->flags & REQ\_F\_ISREG)- kiocb\_start\_write(kiocb);+ if (unlikely(!io\_kiocb\_start\_write(req, kiocb)))+ goto copy\_iov; kiocb->ki\_flags |= IOCB\_WRITE;  if (req->file->f\_op->write\_iter) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:16 +0000



=== Content from git.kernel.org_cef0ae15_20250115_092443.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e8debb8e51354b201db494689198078ec2c1e75)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e8debb8e51354b201db494689198078ec2c1e75)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e8debb8e51354b201db494689198078ec2c1e75)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e8debb8e51354b201db494689198078ec2c1e75)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2024-10-31 08:05:44 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:47 +0100 |
| commit | [9e8debb8e51354b201db494689198078ec2c1e75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e8debb8e51354b201db494689198078ec2c1e75) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e8debb8e51354b201db494689198078ec2c1e75)) | |
| tree | [943a9890677547c668778ea7a3923ef16f1f5860](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e8debb8e51354b201db494689198078ec2c1e75) | |
| parent | [0ed78d3a299edb8188bdd136b75d7ba7a12e1297](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ed78d3a299edb8188bdd136b75d7ba7a12e1297) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e8debb8e51354b201db494689198078ec2c1e75&id2=0ed78d3a299edb8188bdd136b75d7ba7a12e1297)) | |
| download | [linux-9e8debb8e51354b201db494689198078ec2c1e75.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e8debb8e51354b201db494689198078ec2c1e75.tar.gz) | |

io\_uring/rw: fix missing NOWAIT check for O\_DIRECT start write[ Upstream commit 1d60d74e852647255bd8e76f5a22dc42531e4389 ]
When io\_uring starts a write, it'll call kiocb\_start\_write() to bump the
super block rwsem, preventing any freezes from happening while that
write is in-flight. The freeze side will grab that rwsem for writing,
excluding any new writers from happening and waiting for existing writes
to finish. But io\_uring unconditionally uses kiocb\_start\_write(), which
will block if someone is currently attempting to freeze the mount point.
This causes a deadlock where freeze is waiting for previous writes to
complete, but the previous writes cannot complete, as the task that is
supposed to complete them is blocked waiting on starting a new write.
This results in the following stuck trace showing that dependency with
the write blocked starting a new write:
task:fio state:D stack:0 pid:886 tgid:886 ppid:876
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_rwsem\_wait+0x1e8/0x3f8
\_\_percpu\_down\_read+0xe8/0x500
io\_write+0xbb8/0xff8
io\_issue\_sqe+0x10c/0x1020
io\_submit\_sqes+0x614/0x2110
\_\_arm64\_sys\_io\_uring\_enter+0x524/0x1038
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
INFO: task fsfreeze:7364 blocked for more than 15 seconds.
Not tainted 6.12.0-rc5-00063-g76aaf945701c #7963
with the attempting freezer stuck trying to grab the rwsem:
task:fsfreeze state:D stack:0 pid:7364 tgid:7364 ppid:995
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_down\_write+0x2b0/0x680
freeze\_super+0x248/0x8a8
do\_vfs\_ioctl+0x149c/0x1b18
\_\_arm64\_sys\_ioctl+0xd0/0x1a0
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
Fix this by having the io\_uring side honor IOCB\_NOWAIT, and only attempt a
blocking grab of the super block rwsem if it isn't set. For normal issue
where IOCB\_NOWAIT would always be set, this returns -EAGAIN which will
have io\_uring core issue a blocking attempt of the write. That will in
turn also get completions run, ensuring forward progress.
Since freezing requires CAP\_SYS\_ADMIN in the first place, this isn't
something that can be triggered by a regular user.
Cc: stable@vger.kernel.org # 5.10+
Reported-by: Peter Mann <peter.mann@sh.cz>
Link: [https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644@sh.cz](https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644%40sh.cz)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e8debb8e51354b201db494689198078ec2c1e75)

| -rw-r--r-- | [io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/rw.c?id=9e8debb8e51354b201db494689198078ec2c1e75) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 2 deletions

| diff --git a/io\_uring/rw.c b/io\_uring/rw.cindex c15c7873813b33..9d6e17a244ae79 100644--- a/[io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rw.c?id=0ed78d3a299edb8188bdd136b75d7ba7a12e1297)+++ b/[io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rw.c?id=9e8debb8e51354b201db494689198078ec2c1e75)@@ -839,6 +839,25 @@ done: return kiocb\_done(req, ret, issue\_flags); } +static bool io\_kiocb\_start\_write(struct io\_kiocb \*req, struct kiocb \*kiocb)+{+ struct inode \*inode;+ bool ret;++ if (!(req->flags & REQ\_F\_ISREG))+ return true;+ if (!(kiocb->ki\_flags & IOCB\_NOWAIT)) {+ kiocb\_start\_write(kiocb);+ return true;+ }++ inode = file\_inode(kiocb->ki\_filp);+ ret = sb\_start\_write\_trylock(inode->i\_sb);+ if (ret)+ \_\_sb\_writers\_release(inode->i\_sb, SB\_FREEZE\_WRITE);+ return ret;+}+ int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) { struct io\_rw \*rw = io\_kiocb\_to\_cmd(req, struct io\_rw);@@ -892,8 +911,8 @@ int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) return ret; } - if (req->flags & REQ\_F\_ISREG)- kiocb\_start\_write(kiocb);+ if (unlikely(!io\_kiocb\_start\_write(req, kiocb)))+ return -EAGAIN; kiocb->ki\_flags |= IOCB\_WRITE;  if (likely(req->file->f\_op->write\_iter)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:19 +0000



=== Content from git.kernel.org_31fdf1c1_20250115_092437.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=26b8c48f369b7591f5679e0b90612f4862a32929)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=26b8c48f369b7591f5679e0b90612f4862a32929)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26b8c48f369b7591f5679e0b90612f4862a32929)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26b8c48f369b7591f5679e0b90612f4862a32929)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2024-10-31 08:05:44 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:31:00 +0100 |
| commit | [26b8c48f369b7591f5679e0b90612f4862a32929](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26b8c48f369b7591f5679e0b90612f4862a32929) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=26b8c48f369b7591f5679e0b90612f4862a32929)) | |
| tree | [1182d659778ae0df5902aabacc9e72bf51c6453b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=26b8c48f369b7591f5679e0b90612f4862a32929) | |
| parent | [588df3561e4b705eb122d8af9bbe172b8c7967b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=588df3561e4b705eb122d8af9bbe172b8c7967b3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26b8c48f369b7591f5679e0b90612f4862a32929&id2=588df3561e4b705eb122d8af9bbe172b8c7967b3)) | |
| download | [linux-26b8c48f369b7591f5679e0b90612f4862a32929.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-26b8c48f369b7591f5679e0b90612f4862a32929.tar.gz) | |

io\_uring/rw: fix missing NOWAIT check for O\_DIRECT start write[ Upstream commit 1d60d74e852647255bd8e76f5a22dc42531e4389 ]
When io\_uring starts a write, it'll call kiocb\_start\_write() to bump the
super block rwsem, preventing any freezes from happening while that
write is in-flight. The freeze side will grab that rwsem for writing,
excluding any new writers from happening and waiting for existing writes
to finish. But io\_uring unconditionally uses kiocb\_start\_write(), which
will block if someone is currently attempting to freeze the mount point.
This causes a deadlock where freeze is waiting for previous writes to
complete, but the previous writes cannot complete, as the task that is
supposed to complete them is blocked waiting on starting a new write.
This results in the following stuck trace showing that dependency with
the write blocked starting a new write:
task:fio state:D stack:0 pid:886 tgid:886 ppid:876
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_rwsem\_wait+0x1e8/0x3f8
\_\_percpu\_down\_read+0xe8/0x500
io\_write+0xbb8/0xff8
io\_issue\_sqe+0x10c/0x1020
io\_submit\_sqes+0x614/0x2110
\_\_arm64\_sys\_io\_uring\_enter+0x524/0x1038
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
INFO: task fsfreeze:7364 blocked for more than 15 seconds.
Not tainted 6.12.0-rc5-00063-g76aaf945701c #7963
with the attempting freezer stuck trying to grab the rwsem:
task:fsfreeze state:D stack:0 pid:7364 tgid:7364 ppid:995
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_down\_write+0x2b0/0x680
freeze\_super+0x248/0x8a8
do\_vfs\_ioctl+0x149c/0x1b18
\_\_arm64\_sys\_ioctl+0xd0/0x1a0
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
Fix this by having the io\_uring side honor IOCB\_NOWAIT, and only attempt a
blocking grab of the super block rwsem if it isn't set. For normal issue
where IOCB\_NOWAIT would always be set, this returns -EAGAIN which will
have io\_uring core issue a blocking attempt of the write. That will in
turn also get completions run, ensuring forward progress.
Since freezing requires CAP\_SYS\_ADMIN in the first place, this isn't
something that can be triggered by a regular user.
Cc: stable@vger.kernel.org # 5.10+
Reported-by: Peter Mann <peter.mann@sh.cz>
Link: [https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644@sh.cz](https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644%40sh.cz)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26b8c48f369b7591f5679e0b90612f4862a32929)

| -rw-r--r-- | [io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/rw.c?id=26b8c48f369b7591f5679e0b90612f4862a32929) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 2 deletions

| diff --git a/io\_uring/rw.c b/io\_uring/rw.cindex 6b3bc0876f7fe0..19e2c1f9c4a212 100644--- a/[io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rw.c?id=588df3561e4b705eb122d8af9bbe172b8c7967b3)+++ b/[io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rw.c?id=26b8c48f369b7591f5679e0b90612f4862a32929)@@ -1016,6 +1016,25 @@ done: return IOU\_OK; } +static bool io\_kiocb\_start\_write(struct io\_kiocb \*req, struct kiocb \*kiocb)+{+ struct inode \*inode;+ bool ret;++ if (!(req->flags & REQ\_F\_ISREG))+ return true;+ if (!(kiocb->ki\_flags & IOCB\_NOWAIT)) {+ kiocb\_start\_write(kiocb);+ return true;+ }++ inode = file\_inode(kiocb->ki\_filp);+ ret = sb\_start\_write\_trylock(inode->i\_sb);+ if (ret)+ \_\_sb\_writers\_release(inode->i\_sb, SB\_FREEZE\_WRITE);+ return ret;+}+ int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) { bool force\_nonblock = issue\_flags & IO\_URING\_F\_NONBLOCK;@@ -1053,8 +1072,8 @@ int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) if (unlikely(ret)) return ret; - if (req->flags & REQ\_F\_ISREG)- kiocb\_start\_write(kiocb);+ if (unlikely(!io\_kiocb\_start\_write(req, kiocb)))+ return -EAGAIN; kiocb->ki\_flags |= IOCB\_WRITE;  if (likely(req->file->f\_op->write\_iter)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:14 +0000



=== Content from git.kernel.org_8785be04_20250115_092441.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2024-10-31 08:05:44 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:13:40 +0100 |
| commit | [4e24041ba86d50aaa4c792ae2c88ed01b3d96243](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243)) | |
| tree | [68b276ec7f837eb4e83511dfa36a1afe337cfc20](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243) | |
| parent | [a44e81249b8c6316ff65c8bb356ad5100d61f69b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a44e81249b8c6316ff65c8bb356ad5100d61f69b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243&id2=a44e81249b8c6316ff65c8bb356ad5100d61f69b)) | |
| download | [linux-4e24041ba86d50aaa4c792ae2c88ed01b3d96243.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4e24041ba86d50aaa4c792ae2c88ed01b3d96243.tar.gz) | |

io\_uring/rw: fix missing NOWAIT check for O\_DIRECT start writeCommit 1d60d74e852647255bd8e76f5a22dc42531e4389 upstream.
When io\_uring starts a write, it'll call kiocb\_start\_write() to bump the
super block rwsem, preventing any freezes from happening while that
write is in-flight. The freeze side will grab that rwsem for writing,
excluding any new writers from happening and waiting for existing writes
to finish. But io\_uring unconditionally uses kiocb\_start\_write(), which
will block if someone is currently attempting to freeze the mount point.
This causes a deadlock where freeze is waiting for previous writes to
complete, but the previous writes cannot complete, as the task that is
supposed to complete them is blocked waiting on starting a new write.
This results in the following stuck trace showing that dependency with
the write blocked starting a new write:
task:fio state:D stack:0 pid:886 tgid:886 ppid:876
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_rwsem\_wait+0x1e8/0x3f8
\_\_percpu\_down\_read+0xe8/0x500
io\_write+0xbb8/0xff8
io\_issue\_sqe+0x10c/0x1020
io\_submit\_sqes+0x614/0x2110
\_\_arm64\_sys\_io\_uring\_enter+0x524/0x1038
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
INFO: task fsfreeze:7364 blocked for more than 15 seconds.
Not tainted 6.12.0-rc5-00063-g76aaf945701c #7963
with the attempting freezer stuck trying to grab the rwsem:
task:fsfreeze state:D stack:0 pid:7364 tgid:7364 ppid:995
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_down\_write+0x2b0/0x680
freeze\_super+0x248/0x8a8
do\_vfs\_ioctl+0x149c/0x1b18
\_\_arm64\_sys\_ioctl+0xd0/0x1a0
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
Fix this by having the io\_uring side honor IOCB\_NOWAIT, and only attempt a
blocking grab of the super block rwsem if it isn't set. For normal issue
where IOCB\_NOWAIT would always be set, this returns -EAGAIN which will
have io\_uring core issue a blocking attempt of the write. That will in
turn also get completions run, ensuring forward progress.
Since freezing requires CAP\_SYS\_ADMIN in the first place, this isn't
something that can be triggered by a regular user.
Cc: stable@vger.kernel.org # 5.10+
Reported-by: Peter Mann <peter.mann@sh.cz>
Link: [https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644@sh.cz](https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644%40sh.cz)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243)

| -rw-r--r-- | [io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 2 deletions

| diff --git a/io\_uring/io\_uring.c b/io\_uring/io\_uring.cindex 718ab6a418425c..b53099b595cc79 100644--- a/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=a44e81249b8c6316ff65c8bb356ad5100d61f69b)+++ b/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=4e24041ba86d50aaa4c792ae2c88ed01b3d96243)@@ -3724,6 +3724,25 @@ static int io\_write\_prep(struct io\_kiocb \*req, const struct io\_uring\_sqe \*sqe) return io\_prep\_rw(req, sqe, WRITE); } +static bool io\_kiocb\_start\_write(struct io\_kiocb \*req, struct kiocb \*kiocb)+{+ struct inode \*inode;+ bool ret;++ if (!(req->flags & REQ\_F\_ISREG))+ return true;+ if (!(kiocb->ki\_flags & IOCB\_NOWAIT)) {+ kiocb\_start\_write(kiocb);+ return true;+ }++ inode = file\_inode(kiocb->ki\_filp);+ ret = sb\_start\_write\_trylock(inode->i\_sb);+ if (ret)+ \_\_sb\_writers\_release(inode->i\_sb, SB\_FREEZE\_WRITE);+ return ret;+}+ static int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) { struct iovec inline\_vecs[UIO\_FASTIOV], \*iovec = inline\_vecs;@@ -3770,8 +3789,8 @@ static int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) if (unlikely(ret)) goto out\_free; - if (req->flags & REQ\_F\_ISREG)- kiocb\_start\_write(kiocb);+ if (unlikely(!io\_kiocb\_start\_write(req, kiocb)))+ goto copy\_iov; kiocb->ki\_flags |= IOCB\_WRITE;  if (req->file->f\_op->write\_iter) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:17 +0000



=== Content from git.kernel.org_28f1f19a_20250115_092435.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1d60d74e852647255bd8e76f5a22dc42531e4389)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1d60d74e852647255bd8e76f5a22dc42531e4389)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d60d74e852647255bd8e76f5a22dc42531e4389)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d60d74e852647255bd8e76f5a22dc42531e4389)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2024-10-31 08:05:44 -0600 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-10-31 08:21:02 -0600 |
| commit | [1d60d74e852647255bd8e76f5a22dc42531e4389](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d60d74e852647255bd8e76f5a22dc42531e4389) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1d60d74e852647255bd8e76f5a22dc42531e4389)) | |
| tree | [3e061947abab3a973e073279f163d63cacfcfd3e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1d60d74e852647255bd8e76f5a22dc42531e4389) | |
| parent | [ae6a888a4357131c01d85f4c91fb32552dd0bf70](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae6a888a4357131c01d85f4c91fb32552dd0bf70) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d60d74e852647255bd8e76f5a22dc42531e4389&id2=ae6a888a4357131c01d85f4c91fb32552dd0bf70)) | |
| download | [linux-1d60d74e852647255bd8e76f5a22dc42531e4389.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1d60d74e852647255bd8e76f5a22dc42531e4389.tar.gz) | |

io\_uring/rw: fix missing NOWAIT check for O\_DIRECT start writeWhen io\_uring starts a write, it'll call kiocb\_start\_write() to bump the
super block rwsem, preventing any freezes from happening while that
write is in-flight. The freeze side will grab that rwsem for writing,
excluding any new writers from happening and waiting for existing writes
to finish. But io\_uring unconditionally uses kiocb\_start\_write(), which
will block if someone is currently attempting to freeze the mount point.
This causes a deadlock where freeze is waiting for previous writes to
complete, but the previous writes cannot complete, as the task that is
supposed to complete them is blocked waiting on starting a new write.
This results in the following stuck trace showing that dependency with
the write blocked starting a new write:
task:fio state:D stack:0 pid:886 tgid:886 ppid:876
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_rwsem\_wait+0x1e8/0x3f8
\_\_percpu\_down\_read+0xe8/0x500
io\_write+0xbb8/0xff8
io\_issue\_sqe+0x10c/0x1020
io\_submit\_sqes+0x614/0x2110
\_\_arm64\_sys\_io\_uring\_enter+0x524/0x1038
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
INFO: task fsfreeze:7364 blocked for more than 15 seconds.
Not tainted 6.12.0-rc5-00063-g76aaf945701c #7963
with the attempting freezer stuck trying to grab the rwsem:
task:fsfreeze state:D stack:0 pid:7364 tgid:7364 ppid:995
Call trace:
\_\_switch\_to+0x1d8/0x348
\_\_schedule+0x8e8/0x2248
schedule+0x110/0x3f0
percpu\_down\_write+0x2b0/0x680
freeze\_super+0x248/0x8a8
do\_vfs\_ioctl+0x149c/0x1b18
\_\_arm64\_sys\_ioctl+0xd0/0x1a0
invoke\_syscall+0x74/0x268
el0\_svc\_common.constprop.0+0x160/0x238
do\_el0\_svc+0x44/0x60
el0\_svc+0x44/0xb0
el0t\_64\_sync\_handler+0x118/0x128
el0t\_64\_sync+0x168/0x170
Fix this by having the io\_uring side honor IOCB\_NOWAIT, and only attempt a
blocking grab of the super block rwsem if it isn't set. For normal issue
where IOCB\_NOWAIT would always be set, this returns -EAGAIN which will
have io\_uring core issue a blocking attempt of the write. That will in
turn also get completions run, ensuring forward progress.
Since freezing requires CAP\_SYS\_ADMIN in the first place, this isn't
something that can be triggered by a regular user.
Cc: stable@vger.kernel.org # 5.10+
Reported-by: Peter Mann <peter.mann@sh.cz>
Link: [https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644@sh.cz](https://lore.kernel.org/io-uring/38c94aec-81c9-4f62-b44e-1d87f5597644%40sh.cz)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d60d74e852647255bd8e76f5a22dc42531e4389)

| -rw-r--r-- | [io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/rw.c?id=1d60d74e852647255bd8e76f5a22dc42531e4389) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 2 deletions

| diff --git a/io\_uring/rw.c b/io\_uring/rw.cindex 354c4e175654cf..155938f1009313 100644--- a/[io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rw.c?id=ae6a888a4357131c01d85f4c91fb32552dd0bf70)+++ b/[io\_uring/rw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rw.c?id=1d60d74e852647255bd8e76f5a22dc42531e4389)@@ -1014,6 +1014,25 @@ int io\_read\_mshot(struct io\_kiocb \*req, unsigned int issue\_flags) return IOU\_OK; } +static bool io\_kiocb\_start\_write(struct io\_kiocb \*req, struct kiocb \*kiocb)+{+ struct inode \*inode;+ bool ret;++ if (!(req->flags & REQ\_F\_ISREG))+ return true;+ if (!(kiocb->ki\_flags & IOCB\_NOWAIT)) {+ kiocb\_start\_write(kiocb);+ return true;+ }++ inode = file\_inode(kiocb->ki\_filp);+ ret = sb\_start\_write\_trylock(inode->i\_sb);+ if (ret)+ \_\_sb\_writers\_release(inode->i\_sb, SB\_FREEZE\_WRITE);+ return ret;+}+ int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) { bool force\_nonblock = issue\_flags & IO\_URING\_F\_NONBLOCK;@@ -1051,8 +1070,8 @@ int io\_write(struct io\_kiocb \*req, unsigned int issue\_flags) if (unlikely(ret)) return ret; - if (req->flags & REQ\_F\_ISREG)- kiocb\_start\_write(kiocb);+ if (unlikely(!io\_kiocb\_start\_write(req, kiocb)))+ return -EAGAIN; kiocb->ki\_flags |= IOCB\_WRITE;  if (likely(req->file->f\_op->write\_iter)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:12 +0000


