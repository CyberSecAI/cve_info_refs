The provided content relates to CVE-2024-53179.

**Root cause of vulnerability:**
A use-after-free vulnerability exists in the Linux kernel's CIFS (Common Internet File System) client when handling SMB2.1 connections with signing enabled. This is caused by a race condition that can occur during session setup.

**Weaknesses/vulnerabilities present:**
- **Use-after-free:** The `ses->auth_key.response` can be freed prematurely when a session is being closed or reconnected while another thread is trying to use it for signing operations in `smb2_calc_signature`.

**Impact of exploitation:**
- **Kernel crash:** The use-after-free can lead to a kernel crash due to accessing freed memory, resulting in a denial of service.
- **Potential code execution:** While not explicitly stated, use-after-free vulnerabilities can sometimes be exploited for arbitrary code execution, depending on the memory layout and how the freed memory is used.

**Attack vectors:**
- A malicious or compromised SMB server could trigger this race condition by initiating a session close/reconnect operation during the signing process when mounting a SMB2.1 share with signing enabled.

**Required attacker capabilities/position:**
- **Network access:** The attacker needs network access to a system with the vulnerable kernel and must be able to interact with the SMB service using SMB2.1 with signing.
- **SMB server:** The attacker needs to control or have access to a malicious SMB server to manipulate the session and trigger the race condition.

**Technical Details:**

The vulnerability occurs within these functions:
- `smb2_calc_signature`
- `smb2_get_sign_key`

The race condition involves:
1. Task A initiates a session and retrieves the auth key.
2. Task B tries to use the auth key to calculate a signature.
3. During Task B's operation, Task A might close/reconnect the session leading to `auth_key.response` being freed via `kfree_sensitive()` in the session logoff path, causing Task B to read the already freed `auth_key.response` in `crypto_shash_setkey()`

The fix involves:
- Introduce `smb2_get_sign_key` to retrieve the signing key.
-  Ensure that the `auth_key.response` is only accessed when the session status is `SES_GOOD` or `SES_EXITING`, using the `ses_lock` to prevent concurrent access to the session state.
-  Check the validity of `ses->auth_key.response` before copying it to the `key` variable.

The commit also removes the function `smb2_find_smb_ses` from the header file, since it's no longer used by other modules.