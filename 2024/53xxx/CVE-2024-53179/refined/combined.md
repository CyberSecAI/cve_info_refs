=== Content from git.kernel.org_970b293d_20250115_092453.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=343d7fe6df9e247671440a932b6a73af4fa86d95)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=343d7fe6df9e247671440a932b6a73af4fa86d95)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=343d7fe6df9e247671440a932b6a73af4fa86d95)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=343d7fe6df9e247671440a932b6a73af4fa86d95)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-11-11 10:40:55 -0300 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-11-17 22:20:54 -0600 |
| commit | [343d7fe6df9e247671440a932b6a73af4fa86d95](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=343d7fe6df9e247671440a932b6a73af4fa86d95) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=343d7fe6df9e247671440a932b6a73af4fa86d95)) | |
| tree | [0d13f8ea5f9cbff927248e1b523bbf36b50883a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=343d7fe6df9e247671440a932b6a73af4fa86d95) | |
| parent | [7460bf441656cebc2636189ab9ba9a65a0a8ab86](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7460bf441656cebc2636189ab9ba9a65a0a8ab86) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=343d7fe6df9e247671440a932b6a73af4fa86d95&id2=7460bf441656cebc2636189ab9ba9a65a0a8ab86)) | |
| download | [linux-343d7fe6df9e247671440a932b6a73af4fa86d95.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-343d7fe6df9e247671440a932b6a73af4fa86d95.tar.gz) | |

smb: client: fix use-after-free of signing keyCustomers have reported use-after-free in @ses->auth\_key.response with
SMB2.1 + sign mounts which occurs due to following race:
task A task B
cifs\_mount()
dfs\_mount\_share()
get\_session()
cifs\_mount\_get\_session() cifs\_send\_recv()
cifs\_get\_smb\_ses() compound\_send\_recv()
cifs\_setup\_session() smb2\_setup\_request()
kfree\_sensitive() smb2\_calc\_signature()
crypto\_shash\_setkey() \*UAF\*
Fix this by ensuring that we have a valid @ses->auth\_key.response by
checking whether @ses->ses\_status is SES\_GOOD or SES\_EXITING with
@ses->ses\_lock held. After commit 24a9799aa8ef ("smb: client: fix UAF
in smb2\_reconnect\_server()"), we made sure to call ->logoff() only
when @ses was known to be good (e.g. valid ->auth\_key.response), so
it's safe to access signing key when @ses->ses\_status == SES\_EXITING.
Cc: stable@vger.kernel.org
Reported-by: Jay Shin <jaeshin@redhat.com>
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=343d7fe6df9e247671440a932b6a73af4fa86d95)

| -rw-r--r-- | [fs/smb/client/smb2proto.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2proto.h?id=343d7fe6df9e247671440a932b6a73af4fa86d95) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/client/smb2transport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2transport.c?id=343d7fe6df9e247671440a932b6a73af4fa86d95) | 56 | |  |  |  | | --- | --- | --- | |

2 files changed, 40 insertions, 18 deletions

| diff --git a/fs/smb/client/smb2proto.h b/fs/smb/client/smb2proto.hindex 6f9885e4f66ca5..71504b30909e1e 100644--- a/[fs/smb/client/smb2proto.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2proto.h?id=7460bf441656cebc2636189ab9ba9a65a0a8ab86)+++ b/[fs/smb/client/smb2proto.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2proto.h?id=343d7fe6df9e247671440a932b6a73af4fa86d95)@@ -37,8 +37,6 @@ extern struct mid\_q\_entry \*smb2\_setup\_request(struct cifs\_ses \*ses, struct smb\_rqst \*rqst); extern struct mid\_q\_entry \*smb2\_setup\_async\_request( struct TCP\_Server\_Info \*server, struct smb\_rqst \*rqst);-extern struct cifs\_ses \*smb2\_find\_smb\_ses(struct TCP\_Server\_Info \*server,- \_\_u64 ses\_id); extern struct cifs\_tcon \*smb2\_find\_smb\_tcon(struct TCP\_Server\_Info \*server, \_\_u64 ses\_id, \_\_u32 tid); extern int smb2\_calc\_signature(struct smb\_rqst \*rqst,diff --git a/fs/smb/client/smb2transport.c b/fs/smb/client/smb2transport.cindex b486b14bb3306f..475b36c27f6543 100644--- a/[fs/smb/client/smb2transport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2transport.c?id=7460bf441656cebc2636189ab9ba9a65a0a8ab86)+++ b/[fs/smb/client/smb2transport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2transport.c?id=343d7fe6df9e247671440a932b6a73af4fa86d95)@@ -74,7 +74,7 @@ err:   static-int smb2\_get\_sign\_key(\_\_u64 ses\_id, struct TCP\_Server\_Info \*server, u8 \*key)+int smb3\_get\_sign\_key(\_\_u64 ses\_id, struct TCP\_Server\_Info \*server, u8 \*key) { struct cifs\_chan \*chan; struct TCP\_Server\_Info \*pserver;@@ -168,16 +168,41 @@ smb2\_find\_smb\_ses\_unlocked(struct TCP\_Server\_Info \*server, \_\_u64 ses\_id) return NULL; } -struct cifs\_ses \*-smb2\_find\_smb\_ses(struct TCP\_Server\_Info \*server, \_\_u64 ses\_id)+static int smb2\_get\_sign\_key(struct TCP\_Server\_Info \*server,+ \_\_u64 ses\_id, u8 \*key) { struct cifs\_ses \*ses;+ int rc = -ENOENT;++ if (SERVER\_IS\_CHAN(server))+ server = server->primary\_server;  spin\_lock(&cifs\_tcp\_ses\_lock);- ses = smb2\_find\_smb\_ses\_unlocked(server, ses\_id);- spin\_unlock(&cifs\_tcp\_ses\_lock);+ list\_for\_each\_entry(ses, &server->smb\_ses\_list, smb\_ses\_list) {+ if (ses->Suid != ses\_id)+ continue; - return ses;+ rc = 0;+ spin\_lock(&ses->ses\_lock);+ switch (ses->ses\_status) {+ case SES\_EXITING: /\* SMB2\_LOGOFF \*/+ case SES\_GOOD:+ if (likely(ses->auth\_key.response)) {+ memcpy(key, ses->auth\_key.response,+ SMB2\_NTLMV2\_SESSKEY\_SIZE);+ } else {+ rc = -EIO;+ }+ break;+ default:+ rc = -EAGAIN;+ break;+ }+ spin\_unlock(&ses->ses\_lock);+ break;+ }+ spin\_unlock(&cifs\_tcp\_ses\_lock);+ return rc; }  static struct cifs\_tcon \*@@ -236,14 +261,16 @@ smb2\_calc\_signature(struct smb\_rqst \*rqst, struct TCP\_Server\_Info \*server, unsigned char \*sigptr = smb2\_signature; struct kvec \*iov = rqst->rq\_iov; struct smb2\_hdr \*shdr = (struct smb2\_hdr \*)iov[0].iov\_base;- struct cifs\_ses \*ses; struct shash\_desc \*shash = NULL; struct smb\_rqst drqst;+ \_\_u64 sid = le64\_to\_cpu(shdr->SessionId);+ u8 key[SMB2\_NTLMV2\_SESSKEY\_SIZE]; - ses = smb2\_find\_smb\_ses(server, le64\_to\_cpu(shdr->SessionId));- if (unlikely(!ses)) {- cifs\_server\_dbg(FYI, "%s: Could not find session\n", \_\_func\_\_);- return -ENOENT;+ rc = smb2\_get\_sign\_key(server, sid, key);+ if (unlikely(rc)) {+ cifs\_server\_dbg(FYI, "%s: [sesid=0x%llx] couldn't find signing key: %d\n",+ \_\_func\_\_, sid, rc);+ return rc; }  memset(smb2\_signature, 0x0, SMB2\_HMACSHA256\_SIZE);@@ -260,8 +287,7 @@ smb2\_calc\_signature(struct smb\_rqst \*rqst, struct TCP\_Server\_Info \*server, shash = server->secmech.hmacsha256; } - rc = crypto\_shash\_setkey(shash->tfm, ses->auth\_key.response,- SMB2\_NTLMV2\_SESSKEY\_SIZE);+ rc = crypto\_shash\_setkey(shash->tfm, key, sizeof(key)); if (rc) { cifs\_server\_dbg(VFS, "%s: Could not update with response\n",@@ -303,8 +329,6 @@ smb2\_calc\_signature(struct smb\_rqst \*rqst, struct TCP\_Server\_Info \*server, out: if (allocate\_crypto) cifs\_free\_hash(&shash);- if (ses)- cifs\_put\_smb\_ses(ses); return rc; } @@ -570,7 +594,7 @@ smb3\_calc\_signature(struct smb\_rqst \*rqst, struct TCP\_Server\_Info \*server, struct smb\_rqst drqst; u8 key[SMB3\_SIGN\_KEY\_SIZE]; - rc = smb2\_get\_sign\_key(le64\_to\_cpu(shdr->SessionId), server, key);+ rc = smb3\_get\_sign\_key(le64\_to\_cpu(shdr->SessionId), server, key); if (unlikely(rc)) { cifs\_server\_dbg(FYI, "%s: Could not get signing key\n", \_\_func\_\_); return rc; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:29 +0000



=== Content from git.kernel.org_ecac87cc_20250115_092451.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-11-11 10:40:55 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:59 +0100 |
| commit | [0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591)) | |
| tree | [b04d236f1f869dc1c322e46e65cb10c06c20c94e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591) | |
| parent | [797d0d61ae3bb0be9650e957786240130440a2f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=797d0d61ae3bb0be9650e957786240130440a2f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591&id2=797d0d61ae3bb0be9650e957786240130440a2f6)) | |
| download | [linux-0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591.tar.gz) | |

smb: client: fix use-after-free of signing keycommit 343d7fe6df9e247671440a932b6a73af4fa86d95 upstream.
Customers have reported use-after-free in @ses->auth\_key.response with
SMB2.1 + sign mounts which occurs due to following race:
task A task B
cifs\_mount()
dfs\_mount\_share()
get\_session()
cifs\_mount\_get\_session() cifs\_send\_recv()
cifs\_get\_smb\_ses() compound\_send\_recv()
cifs\_setup\_session() smb2\_setup\_request()
kfree\_sensitive() smb2\_calc\_signature()
crypto\_shash\_setkey() \*UAF\*
Fix this by ensuring that we have a valid @ses->auth\_key.response by
checking whether @ses->ses\_status is SES\_GOOD or SES\_EXITING with
@ses->ses\_lock held. After commit 24a9799aa8ef ("smb: client: fix UAF
in smb2\_reconnect\_server()"), we made sure to call ->logoff() only
when @ses was known to be good (e.g. valid ->auth\_key.response), so
it's safe to access signing key when @ses->ses\_status == SES\_EXITING.
Cc: stable@vger.kernel.org
Reported-by: Jay Shin <jaeshin@redhat.com>
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591)

| -rw-r--r-- | [fs/smb/client/smb2proto.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2proto.h?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/client/smb2transport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2transport.c?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591) | 56 | |  |  |  | | --- | --- | --- | |

2 files changed, 40 insertions, 18 deletions

| diff --git a/fs/smb/client/smb2proto.h b/fs/smb/client/smb2proto.hindex 6f9885e4f66ca5..71504b30909e1e 100644--- a/[fs/smb/client/smb2proto.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2proto.h?id=797d0d61ae3bb0be9650e957786240130440a2f6)+++ b/[fs/smb/client/smb2proto.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2proto.h?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591)@@ -37,8 +37,6 @@ extern struct mid\_q\_entry \*smb2\_setup\_request(struct cifs\_ses \*ses, struct smb\_rqst \*rqst); extern struct mid\_q\_entry \*smb2\_setup\_async\_request( struct TCP\_Server\_Info \*server, struct smb\_rqst \*rqst);-extern struct cifs\_ses \*smb2\_find\_smb\_ses(struct TCP\_Server\_Info \*server,- \_\_u64 ses\_id); extern struct cifs\_tcon \*smb2\_find\_smb\_tcon(struct TCP\_Server\_Info \*server, \_\_u64 ses\_id, \_\_u32 tid); extern int smb2\_calc\_signature(struct smb\_rqst \*rqst,diff --git a/fs/smb/client/smb2transport.c b/fs/smb/client/smb2transport.cindex b486b14bb3306f..475b36c27f6543 100644--- a/[fs/smb/client/smb2transport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2transport.c?id=797d0d61ae3bb0be9650e957786240130440a2f6)+++ b/[fs/smb/client/smb2transport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2transport.c?id=0e2b654a3848bf9da3b0d54c1ccf3f1b8c635591)@@ -74,7 +74,7 @@ err:   static-int smb2\_get\_sign\_key(\_\_u64 ses\_id, struct TCP\_Server\_Info \*server, u8 \*key)+int smb3\_get\_sign\_key(\_\_u64 ses\_id, struct TCP\_Server\_Info \*server, u8 \*key) { struct cifs\_chan \*chan; struct TCP\_Server\_Info \*pserver;@@ -168,16 +168,41 @@ smb2\_find\_smb\_ses\_unlocked(struct TCP\_Server\_Info \*server, \_\_u64 ses\_id) return NULL; } -struct cifs\_ses \*-smb2\_find\_smb\_ses(struct TCP\_Server\_Info \*server, \_\_u64 ses\_id)+static int smb2\_get\_sign\_key(struct TCP\_Server\_Info \*server,+ \_\_u64 ses\_id, u8 \*key) { struct cifs\_ses \*ses;+ int rc = -ENOENT;++ if (SERVER\_IS\_CHAN(server))+ server = server->primary\_server;  spin\_lock(&cifs\_tcp\_ses\_lock);- ses = smb2\_find\_smb\_ses\_unlocked(server, ses\_id);- spin\_unlock(&cifs\_tcp\_ses\_lock);+ list\_for\_each\_entry(ses, &server->smb\_ses\_list, smb\_ses\_list) {+ if (ses->Suid != ses\_id)+ continue; - return ses;+ rc = 0;+ spin\_lock(&ses->ses\_lock);+ switch (ses->ses\_status) {+ case SES\_EXITING: /\* SMB2\_LOGOFF \*/+ case SES\_GOOD:+ if (likely(ses->auth\_key.response)) {+ memcpy(key, ses->auth\_key.response,+ SMB2\_NTLMV2\_SESSKEY\_SIZE);+ } else {+ rc = -EIO;+ }+ break;+ default:+ rc = -EAGAIN;+ break;+ }+ spin\_unlock(&ses->ses\_lock);+ break;+ }+ spin\_unlock(&cifs\_tcp\_ses\_lock);+ return rc; }  static struct cifs\_tcon \*@@ -236,14 +261,16 @@ smb2\_calc\_signature(struct smb\_rqst \*rqst, struct TCP\_Server\_Info \*server, unsigned char \*sigptr = smb2\_signature; struct kvec \*iov = rqst->rq\_iov; struct smb2\_hdr \*shdr = (struct smb2\_hdr \*)iov[0].iov\_base;- struct cifs\_ses \*ses; struct shash\_desc \*shash = NULL; struct smb\_rqst drqst;+ \_\_u64 sid = le64\_to\_cpu(shdr->SessionId);+ u8 key[SMB2\_NTLMV2\_SESSKEY\_SIZE]; - ses = smb2\_find\_smb\_ses(server, le64\_to\_cpu(shdr->SessionId));- if (unlikely(!ses)) {- cifs\_server\_dbg(FYI, "%s: Could not find session\n", \_\_func\_\_);- return -ENOENT;+ rc = smb2\_get\_sign\_key(server, sid, key);+ if (unlikely(rc)) {+ cifs\_server\_dbg(FYI, "%s: [sesid=0x%llx] couldn't find signing key: %d\n",+ \_\_func\_\_, sid, rc);+ return rc; }  memset(smb2\_signature, 0x0, SMB2\_HMACSHA256\_SIZE);@@ -260,8 +287,7 @@ smb2\_calc\_signature(struct smb\_rqst \*rqst, struct TCP\_Server\_Info \*server, shash = server->secmech.hmacsha256; } - rc = crypto\_shash\_setkey(shash->tfm, ses->auth\_key.response,- SMB2\_NTLMV2\_SESSKEY\_SIZE);+ rc = crypto\_shash\_setkey(shash->tfm, key, sizeof(key)); if (rc) { cifs\_server\_dbg(VFS, "%s: Could not update with response\n",@@ -303,8 +329,6 @@ smb2\_calc\_signature(struct smb\_rqst \*rqst, struct TCP\_Server\_Info \*server, out: if (allocate\_crypto) cifs\_free\_hash(&shash);- if (ses)- cifs\_put\_smb\_ses(ses); return rc; } @@ -570,7 +594,7 @@ smb3\_calc\_signature(struct smb\_rqst \*rqst, struct TCP\_Server\_Info \*server, struct smb\_rqst drqst; u8 key[SMB3\_SIGN\_KEY\_SIZE]; - rc = smb2\_get\_sign\_key(le64\_to\_cpu(shdr->SessionId), server, key);+ rc = smb3\_get\_sign\_key(le64\_to\_cpu(shdr->SessionId), server, key); if (unlikely(rc)) { cifs\_server\_dbg(FYI, "%s: Could not get signing key\n", \_\_func\_\_); return rc; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:23:28 +0000


