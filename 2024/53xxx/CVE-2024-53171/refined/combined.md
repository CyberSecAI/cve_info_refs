=== Content from git.kernel.org_9b6c9446_20250114_200728.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Waqar Hameed <waqar.hameed@axis.com> | 2024-10-09 16:46:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:41 +0100 |
| commit | [daac4aa1825de0dbc1a6eede2fa7f9fc53f14223](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223)) | |
| tree | [298329e91bcd33c554a4e6ddd86f6c716c7a5145](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223) | |
| parent | [871c148f8e0c32e505df9393ba4a303c3c3fe988](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=871c148f8e0c32e505df9393ba4a303c3c3fe988) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223&id2=871c148f8e0c32e505df9393ba4a303c3c3fe988)) | |
| download | [linux-daac4aa1825de0dbc1a6eede2fa7f9fc53f14223.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-daac4aa1825de0dbc1a6eede2fa7f9fc53f14223.tar.gz) | |

ubifs: authentication: Fix use-after-free in ubifs\_tnc\_end\_commit[ Upstream commit 4617fb8fc15effe8eda4dd898d4e33eb537a7140 ]
After an insertion in TNC, the tree might split and cause a node to
change its `znode->parent`. A further deletion of other nodes in the
tree (which also could free the nodes), the aforementioned node's
`znode->cparent` could still point to a freed node. This
`znode->cparent` may not be updated when getting nodes to commit in
`ubifs\_tnc\_start\_commit()`. This could then trigger a use-after-free
when accessing the `znode->cparent` in `write\_index()` in
`ubifs\_tnc\_end\_commit()`.
This can be triggered by running
rm -f /etc/test-file.bin
dd if=/dev/urandom of=/etc/test-file.bin bs=1M count=60 conv=fsync
in a loop, and with `CONFIG\_UBIFS\_FS\_AUTHENTICATION`. KASAN then
reports:
BUG: KASAN: use-after-free in ubifs\_tnc\_end\_commit+0xa5c/0x1950
Write of size 32 at addr ffffff800a3af86c by task ubifs\_bgt0\_20/153
Call trace:
dump\_backtrace+0x0/0x340
show\_stack+0x18/0x24
dump\_stack\_lvl+0x9c/0xbc
print\_address\_description.constprop.0+0x74/0x2b0
kasan\_report+0x1d8/0x1f0
kasan\_check\_range+0xf8/0x1a0
memcpy+0x84/0xf4
ubifs\_tnc\_end\_commit+0xa5c/0x1950
do\_commit+0x4e0/0x1340
ubifs\_bg\_thread+0x234/0x2e0
kthread+0x36c/0x410
ret\_from\_fork+0x10/0x20
Allocated by task 401:
kasan\_save\_stack+0x38/0x70
\_\_kasan\_kmalloc+0x8c/0xd0
\_\_kmalloc+0x34c/0x5bc
tnc\_insert+0x140/0x16a4
ubifs\_tnc\_add+0x370/0x52c
ubifs\_jnl\_write\_data+0x5d8/0x870
do\_writepage+0x36c/0x510
ubifs\_writepage+0x190/0x4dc
\_\_writepage+0x58/0x154
write\_cache\_pages+0x394/0x830
do\_writepages+0x1f0/0x5b0
filemap\_fdatawrite\_wbc+0x170/0x25c
file\_write\_and\_wait\_range+0x140/0x190
ubifs\_fsync+0xe8/0x290
vfs\_fsync\_range+0xc0/0x1e4
do\_fsync+0x40/0x90
\_\_arm64\_sys\_fsync+0x34/0x50
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
Freed by task 403:
kasan\_save\_stack+0x38/0x70
kasan\_set\_track+0x28/0x40
kasan\_set\_free\_info+0x28/0x4c
\_\_kasan\_slab\_free+0xd4/0x13c
kfree+0xc4/0x3a0
tnc\_delete+0x3f4/0xe40
ubifs\_tnc\_remove\_range+0x368/0x73c
ubifs\_tnc\_remove\_ino+0x29c/0x2e0
ubifs\_jnl\_delete\_inode+0x150/0x260
ubifs\_evict\_inode+0x1d4/0x2e4
evict+0x1c8/0x450
iput+0x2a0/0x3c4
do\_unlinkat+0x2cc/0x490
\_\_arm64\_sys\_unlinkat+0x90/0x100
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
The offending `memcpy()` in `ubifs\_copy\_hash()` has a use-after-free
when a node becomes root in TNC but still has a `cparent` to an already
freed node. More specifically, consider the following TNC:
zroot
/
/
zp1
/
/
zn
Inserting a new node `zn\_new` with a key smaller then `zn` will trigger
a split in `tnc\_insert()` if `zp1` is full:
zroot
/ \
/ \
zp1 zp2
/ \
/ \
zn\_new zn
`zn->parent` has now been moved to `zp2`, \*but\* `zn->cparent` still
points to `zp1`.
Now, consider a removal of all the nodes \_except\_ `zn`. Just when
`tnc\_delete()` is about to delete `zroot` and `zp2`:
zroot
\
\
zp2
\
\
zn
`zroot` and `zp2` get freed and the tree collapses:
zn
`zn` now becomes the new `zroot`.
`get\_znodes\_to\_commit()` will now only find `zn`, the new `zroot`, and
`write\_index()` will check its `znode->cparent` that wrongly points to
the already freed `zp1`. `ubifs\_copy\_hash()` thus gets wrongly called
with `znode->cparent->zbranch[znode->iip].hash` that triggers the
use-after-free!
Fix this by explicitly setting `znode->cparent` to `NULL` in
`get\_znodes\_to\_commit()` for the root node. The search for the dirty
nodes is bottom-up in the tree. Thus, when `find\_next\_dirty(znode)`
returns NULL, the current `znode` \_is\_ the root node. Add an assert for
this.
Fixes: 16a26b20d2af ("ubifs: authentication: Add hashes to index nodes")
Tested-by: Waqar Hameed <waqar.hameed@axis.com>
Co-developed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Waqar Hameed <waqar.hameed@axis.com>
Reviewed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223)

| -rw-r--r-- | [fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/tnc_commit.c?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/fs/ubifs/tnc\_commit.c b/fs/ubifs/tnc\_commit.cindex 234be1c4dc8705..dc4f794fd5b73c 100644--- a/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=871c148f8e0c32e505df9393ba4a303c3c3fe988)+++ b/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=daac4aa1825de0dbc1a6eede2fa7f9fc53f14223)@@ -657,6 +657,8 @@ static int get\_znodes\_to\_commit(struct ubifs\_info \*c) znode->alt = 0; cnext = find\_next\_dirty(znode); if (!cnext) {+ ubifs\_assert(c, !znode->parent);+ znode->cparent = NULL; znode->cnext = c->cnext; break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:06:05 +0000



=== Content from git.kernel.org_b54c5495_20250114_200723.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4d9807048b851d7a58d5bd089c16254af896e4df)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d9807048b851d7a58d5bd089c16254af896e4df)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d9807048b851d7a58d5bd089c16254af896e4df)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d9807048b851d7a58d5bd089c16254af896e4df)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Waqar Hameed <waqar.hameed@axis.com> | 2024-10-09 16:46:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:20 +0100 |
| commit | [4d9807048b851d7a58d5bd089c16254af896e4df](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d9807048b851d7a58d5bd089c16254af896e4df) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4d9807048b851d7a58d5bd089c16254af896e4df)) | |
| tree | [b682967e04ac6fe582ec4b9afcd8b6c555c06d39](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d9807048b851d7a58d5bd089c16254af896e4df) | |
| parent | [b1ee0aa4945c49cbbd779da81040fcec4de80fd1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d9807048b851d7a58d5bd089c16254af896e4df&id2=b1ee0aa4945c49cbbd779da81040fcec4de80fd1)) | |
| download | [linux-4d9807048b851d7a58d5bd089c16254af896e4df.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4d9807048b851d7a58d5bd089c16254af896e4df.tar.gz) | |

ubifs: authentication: Fix use-after-free in ubifs\_tnc\_end\_commit[ Upstream commit 4617fb8fc15effe8eda4dd898d4e33eb537a7140 ]
After an insertion in TNC, the tree might split and cause a node to
change its `znode->parent`. A further deletion of other nodes in the
tree (which also could free the nodes), the aforementioned node's
`znode->cparent` could still point to a freed node. This
`znode->cparent` may not be updated when getting nodes to commit in
`ubifs\_tnc\_start\_commit()`. This could then trigger a use-after-free
when accessing the `znode->cparent` in `write\_index()` in
`ubifs\_tnc\_end\_commit()`.
This can be triggered by running
rm -f /etc/test-file.bin
dd if=/dev/urandom of=/etc/test-file.bin bs=1M count=60 conv=fsync
in a loop, and with `CONFIG\_UBIFS\_FS\_AUTHENTICATION`. KASAN then
reports:
BUG: KASAN: use-after-free in ubifs\_tnc\_end\_commit+0xa5c/0x1950
Write of size 32 at addr ffffff800a3af86c by task ubifs\_bgt0\_20/153
Call trace:
dump\_backtrace+0x0/0x340
show\_stack+0x18/0x24
dump\_stack\_lvl+0x9c/0xbc
print\_address\_description.constprop.0+0x74/0x2b0
kasan\_report+0x1d8/0x1f0
kasan\_check\_range+0xf8/0x1a0
memcpy+0x84/0xf4
ubifs\_tnc\_end\_commit+0xa5c/0x1950
do\_commit+0x4e0/0x1340
ubifs\_bg\_thread+0x234/0x2e0
kthread+0x36c/0x410
ret\_from\_fork+0x10/0x20
Allocated by task 401:
kasan\_save\_stack+0x38/0x70
\_\_kasan\_kmalloc+0x8c/0xd0
\_\_kmalloc+0x34c/0x5bc
tnc\_insert+0x140/0x16a4
ubifs\_tnc\_add+0x370/0x52c
ubifs\_jnl\_write\_data+0x5d8/0x870
do\_writepage+0x36c/0x510
ubifs\_writepage+0x190/0x4dc
\_\_writepage+0x58/0x154
write\_cache\_pages+0x394/0x830
do\_writepages+0x1f0/0x5b0
filemap\_fdatawrite\_wbc+0x170/0x25c
file\_write\_and\_wait\_range+0x140/0x190
ubifs\_fsync+0xe8/0x290
vfs\_fsync\_range+0xc0/0x1e4
do\_fsync+0x40/0x90
\_\_arm64\_sys\_fsync+0x34/0x50
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
Freed by task 403:
kasan\_save\_stack+0x38/0x70
kasan\_set\_track+0x28/0x40
kasan\_set\_free\_info+0x28/0x4c
\_\_kasan\_slab\_free+0xd4/0x13c
kfree+0xc4/0x3a0
tnc\_delete+0x3f4/0xe40
ubifs\_tnc\_remove\_range+0x368/0x73c
ubifs\_tnc\_remove\_ino+0x29c/0x2e0
ubifs\_jnl\_delete\_inode+0x150/0x260
ubifs\_evict\_inode+0x1d4/0x2e4
evict+0x1c8/0x450
iput+0x2a0/0x3c4
do\_unlinkat+0x2cc/0x490
\_\_arm64\_sys\_unlinkat+0x90/0x100
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
The offending `memcpy()` in `ubifs\_copy\_hash()` has a use-after-free
when a node becomes root in TNC but still has a `cparent` to an already
freed node. More specifically, consider the following TNC:
zroot
/
/
zp1
/
/
zn
Inserting a new node `zn\_new` with a key smaller then `zn` will trigger
a split in `tnc\_insert()` if `zp1` is full:
zroot
/ \
/ \
zp1 zp2
/ \
/ \
zn\_new zn
`zn->parent` has now been moved to `zp2`, \*but\* `zn->cparent` still
points to `zp1`.
Now, consider a removal of all the nodes \_except\_ `zn`. Just when
`tnc\_delete()` is about to delete `zroot` and `zp2`:
zroot
\
\
zp2
\
\
zn
`zroot` and `zp2` get freed and the tree collapses:
zn
`zn` now becomes the new `zroot`.
`get\_znodes\_to\_commit()` will now only find `zn`, the new `zroot`, and
`write\_index()` will check its `znode->cparent` that wrongly points to
the already freed `zp1`. `ubifs\_copy\_hash()` thus gets wrongly called
with `znode->cparent->zbranch[znode->iip].hash` that triggers the
use-after-free!
Fix this by explicitly setting `znode->cparent` to `NULL` in
`get\_znodes\_to\_commit()` for the root node. The search for the dirty
nodes is bottom-up in the tree. Thus, when `find\_next\_dirty(znode)`
returns NULL, the current `znode` \_is\_ the root node. Add an assert for
this.
Fixes: 16a26b20d2af ("ubifs: authentication: Add hashes to index nodes")
Tested-by: Waqar Hameed <waqar.hameed@axis.com>
Co-developed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Waqar Hameed <waqar.hameed@axis.com>
Reviewed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d9807048b851d7a58d5bd089c16254af896e4df)

| -rw-r--r-- | [fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/tnc_commit.c?id=4d9807048b851d7a58d5bd089c16254af896e4df) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/fs/ubifs/tnc\_commit.c b/fs/ubifs/tnc\_commit.cindex 58c92c96ecef25..049905ade46550 100644--- a/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=b1ee0aa4945c49cbbd779da81040fcec4de80fd1)+++ b/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=4d9807048b851d7a58d5bd089c16254af896e4df)@@ -657,6 +657,8 @@ static int get\_znodes\_to\_commit(struct ubifs\_info \*c) znode->alt = 0; cnext = find\_next\_dirty(znode); if (!cnext) {+ ubifs\_assert(c, !znode->parent);+ znode->cparent = NULL; znode->cnext = c->cnext; break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:06:00 +0000



=== Content from git.kernel.org_8916dcb3_20250114_200721.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Waqar Hameed <waqar.hameed@axis.com> | 2024-10-09 16:46:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:28 +0100 |
| commit | [398a91599d263e41c5f95a2fd4ebdb6280b5c6c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3)) | |
| tree | [e4fa5b47b97a2ba2219705805436703369a11d58](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3) | |
| parent | [3d8558135cd56a2a8052024be4073e160f36658c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d8558135cd56a2a8052024be4073e160f36658c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3&id2=3d8558135cd56a2a8052024be4073e160f36658c)) | |
| download | [linux-398a91599d263e41c5f95a2fd4ebdb6280b5c6c3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-398a91599d263e41c5f95a2fd4ebdb6280b5c6c3.tar.gz) | |

ubifs: authentication: Fix use-after-free in ubifs\_tnc\_end\_commit[ Upstream commit 4617fb8fc15effe8eda4dd898d4e33eb537a7140 ]
After an insertion in TNC, the tree might split and cause a node to
change its `znode->parent`. A further deletion of other nodes in the
tree (which also could free the nodes), the aforementioned node's
`znode->cparent` could still point to a freed node. This
`znode->cparent` may not be updated when getting nodes to commit in
`ubifs\_tnc\_start\_commit()`. This could then trigger a use-after-free
when accessing the `znode->cparent` in `write\_index()` in
`ubifs\_tnc\_end\_commit()`.
This can be triggered by running
rm -f /etc/test-file.bin
dd if=/dev/urandom of=/etc/test-file.bin bs=1M count=60 conv=fsync
in a loop, and with `CONFIG\_UBIFS\_FS\_AUTHENTICATION`. KASAN then
reports:
BUG: KASAN: use-after-free in ubifs\_tnc\_end\_commit+0xa5c/0x1950
Write of size 32 at addr ffffff800a3af86c by task ubifs\_bgt0\_20/153
Call trace:
dump\_backtrace+0x0/0x340
show\_stack+0x18/0x24
dump\_stack\_lvl+0x9c/0xbc
print\_address\_description.constprop.0+0x74/0x2b0
kasan\_report+0x1d8/0x1f0
kasan\_check\_range+0xf8/0x1a0
memcpy+0x84/0xf4
ubifs\_tnc\_end\_commit+0xa5c/0x1950
do\_commit+0x4e0/0x1340
ubifs\_bg\_thread+0x234/0x2e0
kthread+0x36c/0x410
ret\_from\_fork+0x10/0x20
Allocated by task 401:
kasan\_save\_stack+0x38/0x70
\_\_kasan\_kmalloc+0x8c/0xd0
\_\_kmalloc+0x34c/0x5bc
tnc\_insert+0x140/0x16a4
ubifs\_tnc\_add+0x370/0x52c
ubifs\_jnl\_write\_data+0x5d8/0x870
do\_writepage+0x36c/0x510
ubifs\_writepage+0x190/0x4dc
\_\_writepage+0x58/0x154
write\_cache\_pages+0x394/0x830
do\_writepages+0x1f0/0x5b0
filemap\_fdatawrite\_wbc+0x170/0x25c
file\_write\_and\_wait\_range+0x140/0x190
ubifs\_fsync+0xe8/0x290
vfs\_fsync\_range+0xc0/0x1e4
do\_fsync+0x40/0x90
\_\_arm64\_sys\_fsync+0x34/0x50
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
Freed by task 403:
kasan\_save\_stack+0x38/0x70
kasan\_set\_track+0x28/0x40
kasan\_set\_free\_info+0x28/0x4c
\_\_kasan\_slab\_free+0xd4/0x13c
kfree+0xc4/0x3a0
tnc\_delete+0x3f4/0xe40
ubifs\_tnc\_remove\_range+0x368/0x73c
ubifs\_tnc\_remove\_ino+0x29c/0x2e0
ubifs\_jnl\_delete\_inode+0x150/0x260
ubifs\_evict\_inode+0x1d4/0x2e4
evict+0x1c8/0x450
iput+0x2a0/0x3c4
do\_unlinkat+0x2cc/0x490
\_\_arm64\_sys\_unlinkat+0x90/0x100
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
The offending `memcpy()` in `ubifs\_copy\_hash()` has a use-after-free
when a node becomes root in TNC but still has a `cparent` to an already
freed node. More specifically, consider the following TNC:
zroot
/
/
zp1
/
/
zn
Inserting a new node `zn\_new` with a key smaller then `zn` will trigger
a split in `tnc\_insert()` if `zp1` is full:
zroot
/ \
/ \
zp1 zp2
/ \
/ \
zn\_new zn
`zn->parent` has now been moved to `zp2`, \*but\* `zn->cparent` still
points to `zp1`.
Now, consider a removal of all the nodes \_except\_ `zn`. Just when
`tnc\_delete()` is about to delete `zroot` and `zp2`:
zroot
\
\
zp2
\
\
zn
`zroot` and `zp2` get freed and the tree collapses:
zn
`zn` now becomes the new `zroot`.
`get\_znodes\_to\_commit()` will now only find `zn`, the new `zroot`, and
`write\_index()` will check its `znode->cparent` that wrongly points to
the already freed `zp1`. `ubifs\_copy\_hash()` thus gets wrongly called
with `znode->cparent->zbranch[znode->iip].hash` that triggers the
use-after-free!
Fix this by explicitly setting `znode->cparent` to `NULL` in
`get\_znodes\_to\_commit()` for the root node. The search for the dirty
nodes is bottom-up in the tree. Thus, when `find\_next\_dirty(znode)`
returns NULL, the current `znode` \_is\_ the root node. Add an assert for
this.
Fixes: 16a26b20d2af ("ubifs: authentication: Add hashes to index nodes")
Tested-by: Waqar Hameed <waqar.hameed@axis.com>
Co-developed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Waqar Hameed <waqar.hameed@axis.com>
Reviewed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3)

| -rw-r--r-- | [fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/tnc_commit.c?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/fs/ubifs/tnc\_commit.c b/fs/ubifs/tnc\_commit.cindex a55e04822d16e9..7c43e0ccf6d47d 100644--- a/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=3d8558135cd56a2a8052024be4073e160f36658c)+++ b/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=398a91599d263e41c5f95a2fd4ebdb6280b5c6c3)@@ -657,6 +657,8 @@ static int get\_znodes\_to\_commit(struct ubifs\_info \*c) znode->alt = 0; cnext = find\_next\_dirty(znode); if (!cnext) {+ ubifs\_assert(c, !znode->parent);+ znode->cparent = NULL; znode->cnext = c->cnext; break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:05:58 +0000



=== Content from git.kernel.org_27edd19d_20250114_200725.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=74981f7577d183acad1cd58f74c10d263711a215)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=74981f7577d183acad1cd58f74c10d263711a215)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74981f7577d183acad1cd58f74c10d263711a215)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74981f7577d183acad1cd58f74c10d263711a215)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Waqar Hameed <waqar.hameed@axis.com> | 2024-10-09 16:46:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:08 +0100 |
| commit | [74981f7577d183acad1cd58f74c10d263711a215](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74981f7577d183acad1cd58f74c10d263711a215) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=74981f7577d183acad1cd58f74c10d263711a215)) | |
| tree | [6f78b45d08af98c23148d5d9a73fcbf3737b1b22](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=74981f7577d183acad1cd58f74c10d263711a215) | |
| parent | [6afdcb285794e75d2c8995e3a44f523c176cc2de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6afdcb285794e75d2c8995e3a44f523c176cc2de) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74981f7577d183acad1cd58f74c10d263711a215&id2=6afdcb285794e75d2c8995e3a44f523c176cc2de)) | |
| download | [linux-74981f7577d183acad1cd58f74c10d263711a215.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-74981f7577d183acad1cd58f74c10d263711a215.tar.gz) | |

ubifs: authentication: Fix use-after-free in ubifs\_tnc\_end\_commit[ Upstream commit 4617fb8fc15effe8eda4dd898d4e33eb537a7140 ]
After an insertion in TNC, the tree might split and cause a node to
change its `znode->parent`. A further deletion of other nodes in the
tree (which also could free the nodes), the aforementioned node's
`znode->cparent` could still point to a freed node. This
`znode->cparent` may not be updated when getting nodes to commit in
`ubifs\_tnc\_start\_commit()`. This could then trigger a use-after-free
when accessing the `znode->cparent` in `write\_index()` in
`ubifs\_tnc\_end\_commit()`.
This can be triggered by running
rm -f /etc/test-file.bin
dd if=/dev/urandom of=/etc/test-file.bin bs=1M count=60 conv=fsync
in a loop, and with `CONFIG\_UBIFS\_FS\_AUTHENTICATION`. KASAN then
reports:
BUG: KASAN: use-after-free in ubifs\_tnc\_end\_commit+0xa5c/0x1950
Write of size 32 at addr ffffff800a3af86c by task ubifs\_bgt0\_20/153
Call trace:
dump\_backtrace+0x0/0x340
show\_stack+0x18/0x24
dump\_stack\_lvl+0x9c/0xbc
print\_address\_description.constprop.0+0x74/0x2b0
kasan\_report+0x1d8/0x1f0
kasan\_check\_range+0xf8/0x1a0
memcpy+0x84/0xf4
ubifs\_tnc\_end\_commit+0xa5c/0x1950
do\_commit+0x4e0/0x1340
ubifs\_bg\_thread+0x234/0x2e0
kthread+0x36c/0x410
ret\_from\_fork+0x10/0x20
Allocated by task 401:
kasan\_save\_stack+0x38/0x70
\_\_kasan\_kmalloc+0x8c/0xd0
\_\_kmalloc+0x34c/0x5bc
tnc\_insert+0x140/0x16a4
ubifs\_tnc\_add+0x370/0x52c
ubifs\_jnl\_write\_data+0x5d8/0x870
do\_writepage+0x36c/0x510
ubifs\_writepage+0x190/0x4dc
\_\_writepage+0x58/0x154
write\_cache\_pages+0x394/0x830
do\_writepages+0x1f0/0x5b0
filemap\_fdatawrite\_wbc+0x170/0x25c
file\_write\_and\_wait\_range+0x140/0x190
ubifs\_fsync+0xe8/0x290
vfs\_fsync\_range+0xc0/0x1e4
do\_fsync+0x40/0x90
\_\_arm64\_sys\_fsync+0x34/0x50
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
Freed by task 403:
kasan\_save\_stack+0x38/0x70
kasan\_set\_track+0x28/0x40
kasan\_set\_free\_info+0x28/0x4c
\_\_kasan\_slab\_free+0xd4/0x13c
kfree+0xc4/0x3a0
tnc\_delete+0x3f4/0xe40
ubifs\_tnc\_remove\_range+0x368/0x73c
ubifs\_tnc\_remove\_ino+0x29c/0x2e0
ubifs\_jnl\_delete\_inode+0x150/0x260
ubifs\_evict\_inode+0x1d4/0x2e4
evict+0x1c8/0x450
iput+0x2a0/0x3c4
do\_unlinkat+0x2cc/0x490
\_\_arm64\_sys\_unlinkat+0x90/0x100
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
The offending `memcpy()` in `ubifs\_copy\_hash()` has a use-after-free
when a node becomes root in TNC but still has a `cparent` to an already
freed node. More specifically, consider the following TNC:
zroot
/
/
zp1
/
/
zn
Inserting a new node `zn\_new` with a key smaller then `zn` will trigger
a split in `tnc\_insert()` if `zp1` is full:
zroot
/ \
/ \
zp1 zp2
/ \
/ \
zn\_new zn
`zn->parent` has now been moved to `zp2`, \*but\* `zn->cparent` still
points to `zp1`.
Now, consider a removal of all the nodes \_except\_ `zn`. Just when
`tnc\_delete()` is about to delete `zroot` and `zp2`:
zroot
\
\
zp2
\
\
zn
`zroot` and `zp2` get freed and the tree collapses:
zn
`zn` now becomes the new `zroot`.
`get\_znodes\_to\_commit()` will now only find `zn`, the new `zroot`, and
`write\_index()` will check its `znode->cparent` that wrongly points to
the already freed `zp1`. `ubifs\_copy\_hash()` thus gets wrongly called
with `znode->cparent->zbranch[znode->iip].hash` that triggers the
use-after-free!
Fix this by explicitly setting `znode->cparent` to `NULL` in
`get\_znodes\_to\_commit()` for the root node. The search for the dirty
nodes is bottom-up in the tree. Thus, when `find\_next\_dirty(znode)`
returns NULL, the current `znode` \_is\_ the root node. Add an assert for
this.
Fixes: 16a26b20d2af ("ubifs: authentication: Add hashes to index nodes")
Tested-by: Waqar Hameed <waqar.hameed@axis.com>
Co-developed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Waqar Hameed <waqar.hameed@axis.com>
Reviewed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=74981f7577d183acad1cd58f74c10d263711a215)

| -rw-r--r-- | [fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/tnc_commit.c?id=74981f7577d183acad1cd58f74c10d263711a215) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/fs/ubifs/tnc\_commit.c b/fs/ubifs/tnc\_commit.cindex 01362ad5f804ae..efd52cc5343641 100644--- a/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=6afdcb285794e75d2c8995e3a44f523c176cc2de)+++ b/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=74981f7577d183acad1cd58f74c10d263711a215)@@ -657,6 +657,8 @@ static int get\_znodes\_to\_commit(struct ubifs\_info \*c) znode->alt = 0; cnext = find\_next\_dirty(znode); if (!cnext) {+ ubifs\_assert(c, !znode->parent);+ znode->cparent = NULL; znode->cnext = c->cnext; break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:06:01 +0000



=== Content from git.kernel.org_b7733cd6_20250114_200720.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Waqar Hameed <waqar.hameed@axis.com> | 2024-10-09 16:46:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:03:04 +0100 |
| commit | [2497479aecebe869d23a0064e0fd1a03e34f0e2a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a)) | |
| tree | [f14079d82f3ac998079251b72e240934a6fbf6d0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a) | |
| parent | [7402c4bcb8a3f0d2ef4e687cd45c76be489cf509](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a&id2=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509)) | |
| download | [linux-2497479aecebe869d23a0064e0fd1a03e34f0e2a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2497479aecebe869d23a0064e0fd1a03e34f0e2a.tar.gz) | |

ubifs: authentication: Fix use-after-free in ubifs\_tnc\_end\_commit[ Upstream commit 4617fb8fc15effe8eda4dd898d4e33eb537a7140 ]
After an insertion in TNC, the tree might split and cause a node to
change its `znode->parent`. A further deletion of other nodes in the
tree (which also could free the nodes), the aforementioned node's
`znode->cparent` could still point to a freed node. This
`znode->cparent` may not be updated when getting nodes to commit in
`ubifs\_tnc\_start\_commit()`. This could then trigger a use-after-free
when accessing the `znode->cparent` in `write\_index()` in
`ubifs\_tnc\_end\_commit()`.
This can be triggered by running
rm -f /etc/test-file.bin
dd if=/dev/urandom of=/etc/test-file.bin bs=1M count=60 conv=fsync
in a loop, and with `CONFIG\_UBIFS\_FS\_AUTHENTICATION`. KASAN then
reports:
BUG: KASAN: use-after-free in ubifs\_tnc\_end\_commit+0xa5c/0x1950
Write of size 32 at addr ffffff800a3af86c by task ubifs\_bgt0\_20/153
Call trace:
dump\_backtrace+0x0/0x340
show\_stack+0x18/0x24
dump\_stack\_lvl+0x9c/0xbc
print\_address\_description.constprop.0+0x74/0x2b0
kasan\_report+0x1d8/0x1f0
kasan\_check\_range+0xf8/0x1a0
memcpy+0x84/0xf4
ubifs\_tnc\_end\_commit+0xa5c/0x1950
do\_commit+0x4e0/0x1340
ubifs\_bg\_thread+0x234/0x2e0
kthread+0x36c/0x410
ret\_from\_fork+0x10/0x20
Allocated by task 401:
kasan\_save\_stack+0x38/0x70
\_\_kasan\_kmalloc+0x8c/0xd0
\_\_kmalloc+0x34c/0x5bc
tnc\_insert+0x140/0x16a4
ubifs\_tnc\_add+0x370/0x52c
ubifs\_jnl\_write\_data+0x5d8/0x870
do\_writepage+0x36c/0x510
ubifs\_writepage+0x190/0x4dc
\_\_writepage+0x58/0x154
write\_cache\_pages+0x394/0x830
do\_writepages+0x1f0/0x5b0
filemap\_fdatawrite\_wbc+0x170/0x25c
file\_write\_and\_wait\_range+0x140/0x190
ubifs\_fsync+0xe8/0x290
vfs\_fsync\_range+0xc0/0x1e4
do\_fsync+0x40/0x90
\_\_arm64\_sys\_fsync+0x34/0x50
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
Freed by task 403:
kasan\_save\_stack+0x38/0x70
kasan\_set\_track+0x28/0x40
kasan\_set\_free\_info+0x28/0x4c
\_\_kasan\_slab\_free+0xd4/0x13c
kfree+0xc4/0x3a0
tnc\_delete+0x3f4/0xe40
ubifs\_tnc\_remove\_range+0x368/0x73c
ubifs\_tnc\_remove\_ino+0x29c/0x2e0
ubifs\_jnl\_delete\_inode+0x150/0x260
ubifs\_evict\_inode+0x1d4/0x2e4
evict+0x1c8/0x450
iput+0x2a0/0x3c4
do\_unlinkat+0x2cc/0x490
\_\_arm64\_sys\_unlinkat+0x90/0x100
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
The offending `memcpy()` in `ubifs\_copy\_hash()` has a use-after-free
when a node becomes root in TNC but still has a `cparent` to an already
freed node. More specifically, consider the following TNC:
zroot
/
/
zp1
/
/
zn
Inserting a new node `zn\_new` with a key smaller then `zn` will trigger
a split in `tnc\_insert()` if `zp1` is full:
zroot
/ \
/ \
zp1 zp2
/ \
/ \
zn\_new zn
`zn->parent` has now been moved to `zp2`, \*but\* `zn->cparent` still
points to `zp1`.
Now, consider a removal of all the nodes \_except\_ `zn`. Just when
`tnc\_delete()` is about to delete `zroot` and `zp2`:
zroot
\
\
zp2
\
\
zn
`zroot` and `zp2` get freed and the tree collapses:
zn
`zn` now becomes the new `zroot`.
`get\_znodes\_to\_commit()` will now only find `zn`, the new `zroot`, and
`write\_index()` will check its `znode->cparent` that wrongly points to
the already freed `zp1`. `ubifs\_copy\_hash()` thus gets wrongly called
with `znode->cparent->zbranch[znode->iip].hash` that triggers the
use-after-free!
Fix this by explicitly setting `znode->cparent` to `NULL` in
`get\_znodes\_to\_commit()` for the root node. The search for the dirty
nodes is bottom-up in the tree. Thus, when `find\_next\_dirty(znode)`
returns NULL, the current `znode` \_is\_ the root node. Add an assert for
this.
Fixes: 16a26b20d2af ("ubifs: authentication: Add hashes to index nodes")
Tested-by: Waqar Hameed <waqar.hameed@axis.com>
Co-developed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Waqar Hameed <waqar.hameed@axis.com>
Reviewed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a)

| -rw-r--r-- | [fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/tnc_commit.c?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/fs/ubifs/tnc\_commit.c b/fs/ubifs/tnc\_commit.cindex a55e04822d16e9..7c43e0ccf6d47d 100644--- a/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=7402c4bcb8a3f0d2ef4e687cd45c76be489cf509)+++ b/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=2497479aecebe869d23a0064e0fd1a03e34f0e2a)@@ -657,6 +657,8 @@ static int get\_znodes\_to\_commit(struct ubifs\_info \*c) znode->alt = 0; cnext = find\_next\_dirty(znode); if (!cnext) {+ ubifs\_assert(c, !znode->parent);+ znode->cparent = NULL; znode->cnext = c->cnext; break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:05:56 +0000



=== Content from git.kernel.org_a8f9d8b9_20250114_200726.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Waqar Hameed <waqar.hameed@axis.com> | 2024-10-09 16:46:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:14 +0100 |
| commit | [8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb)) | |
| tree | [8b4a8454115231ab0c7478bb0e7bc193198601b2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb) | |
| parent | [04c0b0f37617099479c34e207c5550d081f585a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04c0b0f37617099479c34e207c5550d081f585a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb&id2=04c0b0f37617099479c34e207c5550d081f585a6)) | |
| download | [linux-8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb.tar.gz) | |

ubifs: authentication: Fix use-after-free in ubifs\_tnc\_end\_commit[ Upstream commit 4617fb8fc15effe8eda4dd898d4e33eb537a7140 ]
After an insertion in TNC, the tree might split and cause a node to
change its `znode->parent`. A further deletion of other nodes in the
tree (which also could free the nodes), the aforementioned node's
`znode->cparent` could still point to a freed node. This
`znode->cparent` may not be updated when getting nodes to commit in
`ubifs\_tnc\_start\_commit()`. This could then trigger a use-after-free
when accessing the `znode->cparent` in `write\_index()` in
`ubifs\_tnc\_end\_commit()`.
This can be triggered by running
rm -f /etc/test-file.bin
dd if=/dev/urandom of=/etc/test-file.bin bs=1M count=60 conv=fsync
in a loop, and with `CONFIG\_UBIFS\_FS\_AUTHENTICATION`. KASAN then
reports:
BUG: KASAN: use-after-free in ubifs\_tnc\_end\_commit+0xa5c/0x1950
Write of size 32 at addr ffffff800a3af86c by task ubifs\_bgt0\_20/153
Call trace:
dump\_backtrace+0x0/0x340
show\_stack+0x18/0x24
dump\_stack\_lvl+0x9c/0xbc
print\_address\_description.constprop.0+0x74/0x2b0
kasan\_report+0x1d8/0x1f0
kasan\_check\_range+0xf8/0x1a0
memcpy+0x84/0xf4
ubifs\_tnc\_end\_commit+0xa5c/0x1950
do\_commit+0x4e0/0x1340
ubifs\_bg\_thread+0x234/0x2e0
kthread+0x36c/0x410
ret\_from\_fork+0x10/0x20
Allocated by task 401:
kasan\_save\_stack+0x38/0x70
\_\_kasan\_kmalloc+0x8c/0xd0
\_\_kmalloc+0x34c/0x5bc
tnc\_insert+0x140/0x16a4
ubifs\_tnc\_add+0x370/0x52c
ubifs\_jnl\_write\_data+0x5d8/0x870
do\_writepage+0x36c/0x510
ubifs\_writepage+0x190/0x4dc
\_\_writepage+0x58/0x154
write\_cache\_pages+0x394/0x830
do\_writepages+0x1f0/0x5b0
filemap\_fdatawrite\_wbc+0x170/0x25c
file\_write\_and\_wait\_range+0x140/0x190
ubifs\_fsync+0xe8/0x290
vfs\_fsync\_range+0xc0/0x1e4
do\_fsync+0x40/0x90
\_\_arm64\_sys\_fsync+0x34/0x50
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
Freed by task 403:
kasan\_save\_stack+0x38/0x70
kasan\_set\_track+0x28/0x40
kasan\_set\_free\_info+0x28/0x4c
\_\_kasan\_slab\_free+0xd4/0x13c
kfree+0xc4/0x3a0
tnc\_delete+0x3f4/0xe40
ubifs\_tnc\_remove\_range+0x368/0x73c
ubifs\_tnc\_remove\_ino+0x29c/0x2e0
ubifs\_jnl\_delete\_inode+0x150/0x260
ubifs\_evict\_inode+0x1d4/0x2e4
evict+0x1c8/0x450
iput+0x2a0/0x3c4
do\_unlinkat+0x2cc/0x490
\_\_arm64\_sys\_unlinkat+0x90/0x100
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
The offending `memcpy()` in `ubifs\_copy\_hash()` has a use-after-free
when a node becomes root in TNC but still has a `cparent` to an already
freed node. More specifically, consider the following TNC:
zroot
/
/
zp1
/
/
zn
Inserting a new node `zn\_new` with a key smaller then `zn` will trigger
a split in `tnc\_insert()` if `zp1` is full:
zroot
/ \
/ \
zp1 zp2
/ \
/ \
zn\_new zn
`zn->parent` has now been moved to `zp2`, \*but\* `zn->cparent` still
points to `zp1`.
Now, consider a removal of all the nodes \_except\_ `zn`. Just when
`tnc\_delete()` is about to delete `zroot` and `zp2`:
zroot
\
\
zp2
\
\
zn
`zroot` and `zp2` get freed and the tree collapses:
zn
`zn` now becomes the new `zroot`.
`get\_znodes\_to\_commit()` will now only find `zn`, the new `zroot`, and
`write\_index()` will check its `znode->cparent` that wrongly points to
the already freed `zp1`. `ubifs\_copy\_hash()` thus gets wrongly called
with `znode->cparent->zbranch[znode->iip].hash` that triggers the
use-after-free!
Fix this by explicitly setting `znode->cparent` to `NULL` in
`get\_znodes\_to\_commit()` for the root node. The search for the dirty
nodes is bottom-up in the tree. Thus, when `find\_next\_dirty(znode)`
returns NULL, the current `znode` \_is\_ the root node. Add an assert for
this.
Fixes: 16a26b20d2af ("ubifs: authentication: Add hashes to index nodes")
Tested-by: Waqar Hameed <waqar.hameed@axis.com>
Co-developed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Waqar Hameed <waqar.hameed@axis.com>
Reviewed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb)

| -rw-r--r-- | [fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/tnc_commit.c?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/fs/ubifs/tnc\_commit.c b/fs/ubifs/tnc\_commit.cindex 234be1c4dc8705..dc4f794fd5b73c 100644--- a/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=04c0b0f37617099479c34e207c5550d081f585a6)+++ b/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=8d8b3f5f4cbfbf6cb0ea4a4d5dc296872b4151eb)@@ -657,6 +657,8 @@ static int get\_znodes\_to\_commit(struct ubifs\_info \*c) znode->alt = 0; cnext = find\_next\_dirty(znode); if (!cnext) {+ ubifs\_assert(c, !znode->parent);+ znode->cparent = NULL; znode->cnext = c->cnext; break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:06:03 +0000



=== Content from git.kernel.org_a634dcfe_20250114_200722.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Waqar Hameed <waqar.hameed@axis.com> | 2024-10-09 16:46:59 +0200 |
| --- | --- | --- |
| committer | Richard Weinberger <richard@nod.at> | 2024-11-14 19:46:58 +0100 |
| commit | [4617fb8fc15effe8eda4dd898d4e33eb537a7140](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140)) | |
| tree | [45c0d0d3694306302d87da1b88030154a7bdf787](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140) | |
| parent | [bcddf52b7a17adcebc768d26f4e27cf79adb424c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140&id2=bcddf52b7a17adcebc768d26f4e27cf79adb424c)) | |
| download | [linux-4617fb8fc15effe8eda4dd898d4e33eb537a7140.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4617fb8fc15effe8eda4dd898d4e33eb537a7140.tar.gz) | |

ubifs: authentication: Fix use-after-free in ubifs\_tnc\_end\_commitAfter an insertion in TNC, the tree might split and cause a node to
change its `znode->parent`. A further deletion of other nodes in the
tree (which also could free the nodes), the aforementioned node's
`znode->cparent` could still point to a freed node. This
`znode->cparent` may not be updated when getting nodes to commit in
`ubifs\_tnc\_start\_commit()`. This could then trigger a use-after-free
when accessing the `znode->cparent` in `write\_index()` in
`ubifs\_tnc\_end\_commit()`.
This can be triggered by running
rm -f /etc/test-file.bin
dd if=/dev/urandom of=/etc/test-file.bin bs=1M count=60 conv=fsync
in a loop, and with `CONFIG\_UBIFS\_FS\_AUTHENTICATION`. KASAN then
reports:
BUG: KASAN: use-after-free in ubifs\_tnc\_end\_commit+0xa5c/0x1950
Write of size 32 at addr ffffff800a3af86c by task ubifs\_bgt0\_20/153
Call trace:
dump\_backtrace+0x0/0x340
show\_stack+0x18/0x24
dump\_stack\_lvl+0x9c/0xbc
print\_address\_description.constprop.0+0x74/0x2b0
kasan\_report+0x1d8/0x1f0
kasan\_check\_range+0xf8/0x1a0
memcpy+0x84/0xf4
ubifs\_tnc\_end\_commit+0xa5c/0x1950
do\_commit+0x4e0/0x1340
ubifs\_bg\_thread+0x234/0x2e0
kthread+0x36c/0x410
ret\_from\_fork+0x10/0x20
Allocated by task 401:
kasan\_save\_stack+0x38/0x70
\_\_kasan\_kmalloc+0x8c/0xd0
\_\_kmalloc+0x34c/0x5bc
tnc\_insert+0x140/0x16a4
ubifs\_tnc\_add+0x370/0x52c
ubifs\_jnl\_write\_data+0x5d8/0x870
do\_writepage+0x36c/0x510
ubifs\_writepage+0x190/0x4dc
\_\_writepage+0x58/0x154
write\_cache\_pages+0x394/0x830
do\_writepages+0x1f0/0x5b0
filemap\_fdatawrite\_wbc+0x170/0x25c
file\_write\_and\_wait\_range+0x140/0x190
ubifs\_fsync+0xe8/0x290
vfs\_fsync\_range+0xc0/0x1e4
do\_fsync+0x40/0x90
\_\_arm64\_sys\_fsync+0x34/0x50
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
Freed by task 403:
kasan\_save\_stack+0x38/0x70
kasan\_set\_track+0x28/0x40
kasan\_set\_free\_info+0x28/0x4c
\_\_kasan\_slab\_free+0xd4/0x13c
kfree+0xc4/0x3a0
tnc\_delete+0x3f4/0xe40
ubifs\_tnc\_remove\_range+0x368/0x73c
ubifs\_tnc\_remove\_ino+0x29c/0x2e0
ubifs\_jnl\_delete\_inode+0x150/0x260
ubifs\_evict\_inode+0x1d4/0x2e4
evict+0x1c8/0x450
iput+0x2a0/0x3c4
do\_unlinkat+0x2cc/0x490
\_\_arm64\_sys\_unlinkat+0x90/0x100
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
The offending `memcpy()` in `ubifs\_copy\_hash()` has a use-after-free
when a node becomes root in TNC but still has a `cparent` to an already
freed node. More specifically, consider the following TNC:
zroot
/
/
zp1
/
/
zn
Inserting a new node `zn\_new` with a key smaller then `zn` will trigger
a split in `tnc\_insert()` if `zp1` is full:
zroot
/ \
/ \
zp1 zp2
/ \
/ \
zn\_new zn
`zn->parent` has now been moved to `zp2`, \*but\* `zn->cparent` still
points to `zp1`.
Now, consider a removal of all the nodes \_except\_ `zn`. Just when
`tnc\_delete()` is about to delete `zroot` and `zp2`:
zroot
\
\
zp2
\
\
zn
`zroot` and `zp2` get freed and the tree collapses:
zn
`zn` now becomes the new `zroot`.
`get\_znodes\_to\_commit()` will now only find `zn`, the new `zroot`, and
`write\_index()` will check its `znode->cparent` that wrongly points to
the already freed `zp1`. `ubifs\_copy\_hash()` thus gets wrongly called
with `znode->cparent->zbranch[znode->iip].hash` that triggers the
use-after-free!
Fix this by explicitly setting `znode->cparent` to `NULL` in
`get\_znodes\_to\_commit()` for the root node. The search for the dirty
nodes is bottom-up in the tree. Thus, when `find\_next\_dirty(znode)`
returns NULL, the current `znode` \_is\_ the root node. Add an assert for
this.
Fixes: 16a26b20d2af ("ubifs: authentication: Add hashes to index nodes")
Tested-by: Waqar Hameed <waqar.hameed@axis.com>
Co-developed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Waqar Hameed <waqar.hameed@axis.com>
Reviewed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140)

| -rw-r--r-- | [fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/tnc_commit.c?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/fs/ubifs/tnc\_commit.c b/fs/ubifs/tnc\_commit.cindex a55e04822d16e9..7c43e0ccf6d47d 100644--- a/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=bcddf52b7a17adcebc768d26f4e27cf79adb424c)+++ b/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=4617fb8fc15effe8eda4dd898d4e33eb537a7140)@@ -657,6 +657,8 @@ static int get\_znodes\_to\_commit(struct ubifs\_info \*c) znode->alt = 0; cnext = find\_next\_dirty(znode); if (!cnext) {+ ubifs\_assert(c, !znode->parent);+ znode->cparent = NULL; znode->cnext = c->cnext; break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:05:59 +0000



=== Content from git.kernel.org_b19b81c9_20250114_200718.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=01d3a2293d7e4edfff96618c15727db7e51f11b6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01d3a2293d7e4edfff96618c15727db7e51f11b6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01d3a2293d7e4edfff96618c15727db7e51f11b6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01d3a2293d7e4edfff96618c15727db7e51f11b6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Waqar Hameed <waqar.hameed@axis.com> | 2024-10-09 16:46:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:55 +0100 |
| commit | [01d3a2293d7e4edfff96618c15727db7e51f11b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01d3a2293d7e4edfff96618c15727db7e51f11b6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=01d3a2293d7e4edfff96618c15727db7e51f11b6)) | |
| tree | [135c1b46a30e507f49a88c17e5a0657291cca18a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01d3a2293d7e4edfff96618c15727db7e51f11b6) | |
| parent | [612824dd0c9465ef365ace38b056c663d110956d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=612824dd0c9465ef365ace38b056c663d110956d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01d3a2293d7e4edfff96618c15727db7e51f11b6&id2=612824dd0c9465ef365ace38b056c663d110956d)) | |
| download | [linux-01d3a2293d7e4edfff96618c15727db7e51f11b6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-01d3a2293d7e4edfff96618c15727db7e51f11b6.tar.gz) | |

ubifs: authentication: Fix use-after-free in ubifs\_tnc\_end\_commit[ Upstream commit 4617fb8fc15effe8eda4dd898d4e33eb537a7140 ]
After an insertion in TNC, the tree might split and cause a node to
change its `znode->parent`. A further deletion of other nodes in the
tree (which also could free the nodes), the aforementioned node's
`znode->cparent` could still point to a freed node. This
`znode->cparent` may not be updated when getting nodes to commit in
`ubifs\_tnc\_start\_commit()`. This could then trigger a use-after-free
when accessing the `znode->cparent` in `write\_index()` in
`ubifs\_tnc\_end\_commit()`.
This can be triggered by running
rm -f /etc/test-file.bin
dd if=/dev/urandom of=/etc/test-file.bin bs=1M count=60 conv=fsync
in a loop, and with `CONFIG\_UBIFS\_FS\_AUTHENTICATION`. KASAN then
reports:
BUG: KASAN: use-after-free in ubifs\_tnc\_end\_commit+0xa5c/0x1950
Write of size 32 at addr ffffff800a3af86c by task ubifs\_bgt0\_20/153
Call trace:
dump\_backtrace+0x0/0x340
show\_stack+0x18/0x24
dump\_stack\_lvl+0x9c/0xbc
print\_address\_description.constprop.0+0x74/0x2b0
kasan\_report+0x1d8/0x1f0
kasan\_check\_range+0xf8/0x1a0
memcpy+0x84/0xf4
ubifs\_tnc\_end\_commit+0xa5c/0x1950
do\_commit+0x4e0/0x1340
ubifs\_bg\_thread+0x234/0x2e0
kthread+0x36c/0x410
ret\_from\_fork+0x10/0x20
Allocated by task 401:
kasan\_save\_stack+0x38/0x70
\_\_kasan\_kmalloc+0x8c/0xd0
\_\_kmalloc+0x34c/0x5bc
tnc\_insert+0x140/0x16a4
ubifs\_tnc\_add+0x370/0x52c
ubifs\_jnl\_write\_data+0x5d8/0x870
do\_writepage+0x36c/0x510
ubifs\_writepage+0x190/0x4dc
\_\_writepage+0x58/0x154
write\_cache\_pages+0x394/0x830
do\_writepages+0x1f0/0x5b0
filemap\_fdatawrite\_wbc+0x170/0x25c
file\_write\_and\_wait\_range+0x140/0x190
ubifs\_fsync+0xe8/0x290
vfs\_fsync\_range+0xc0/0x1e4
do\_fsync+0x40/0x90
\_\_arm64\_sys\_fsync+0x34/0x50
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
Freed by task 403:
kasan\_save\_stack+0x38/0x70
kasan\_set\_track+0x28/0x40
kasan\_set\_free\_info+0x28/0x4c
\_\_kasan\_slab\_free+0xd4/0x13c
kfree+0xc4/0x3a0
tnc\_delete+0x3f4/0xe40
ubifs\_tnc\_remove\_range+0x368/0x73c
ubifs\_tnc\_remove\_ino+0x29c/0x2e0
ubifs\_jnl\_delete\_inode+0x150/0x260
ubifs\_evict\_inode+0x1d4/0x2e4
evict+0x1c8/0x450
iput+0x2a0/0x3c4
do\_unlinkat+0x2cc/0x490
\_\_arm64\_sys\_unlinkat+0x90/0x100
invoke\_syscall.constprop.0+0xa8/0x260
do\_el0\_svc+0xc8/0x1f0
el0\_svc+0x34/0x70
el0t\_64\_sync\_handler+0x108/0x114
el0t\_64\_sync+0x1a4/0x1a8
The offending `memcpy()` in `ubifs\_copy\_hash()` has a use-after-free
when a node becomes root in TNC but still has a `cparent` to an already
freed node. More specifically, consider the following TNC:
zroot
/
/
zp1
/
/
zn
Inserting a new node `zn\_new` with a key smaller then `zn` will trigger
a split in `tnc\_insert()` if `zp1` is full:
zroot
/ \
/ \
zp1 zp2
/ \
/ \
zn\_new zn
`zn->parent` has now been moved to `zp2`, \*but\* `zn->cparent` still
points to `zp1`.
Now, consider a removal of all the nodes \_except\_ `zn`. Just when
`tnc\_delete()` is about to delete `zroot` and `zp2`:
zroot
\
\
zp2
\
\
zn
`zroot` and `zp2` get freed and the tree collapses:
zn
`zn` now becomes the new `zroot`.
`get\_znodes\_to\_commit()` will now only find `zn`, the new `zroot`, and
`write\_index()` will check its `znode->cparent` that wrongly points to
the already freed `zp1`. `ubifs\_copy\_hash()` thus gets wrongly called
with `znode->cparent->zbranch[znode->iip].hash` that triggers the
use-after-free!
Fix this by explicitly setting `znode->cparent` to `NULL` in
`get\_znodes\_to\_commit()` for the root node. The search for the dirty
nodes is bottom-up in the tree. Thus, when `find\_next\_dirty(znode)`
returns NULL, the current `znode` \_is\_ the root node. Add an assert for
this.
Fixes: 16a26b20d2af ("ubifs: authentication: Add hashes to index nodes")
Tested-by: Waqar Hameed <waqar.hameed@axis.com>
Co-developed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Waqar Hameed <waqar.hameed@axis.com>
Reviewed-by: Zhihao Cheng <chengzhihao1@huawei.com>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01d3a2293d7e4edfff96618c15727db7e51f11b6)

| -rw-r--r-- | [fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ubifs/tnc_commit.c?id=01d3a2293d7e4edfff96618c15727db7e51f11b6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/fs/ubifs/tnc\_commit.c b/fs/ubifs/tnc\_commit.cindex a55e04822d16e9..7c43e0ccf6d47d 100644--- a/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=612824dd0c9465ef365ace38b056c663d110956d)+++ b/[fs/ubifs/tnc\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ubifs/tnc_commit.c?id=01d3a2293d7e4edfff96618c15727db7e51f11b6)@@ -657,6 +657,8 @@ static int get\_znodes\_to\_commit(struct ubifs\_info \*c) znode->alt = 0; cnext = find\_next\_dirty(znode); if (!cnext) {+ ubifs\_assert(c, !znode->parent);+ znode->cparent = NULL; znode->cnext = c->cnext; break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:05:54 +0000


