=== Content from git.kernel.org_ec293d1b_20250115_083926.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-10-15 11:43:39 +0800 |
| --- | --- | --- |
| committer | Jaegeuk Kim <jaegeuk@kernel.org> | 2024-10-16 15:54:06 +0000 |
| commit | [1acd73edbbfef2c3c5b43cba4006a7797eca7050](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050)) | |
| tree | [402588f19d301d14c37351e88f7c6f9f9753a6f8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050) | |
| parent | [b7d0a97b28083084ebdd8e5c6bccd12e6ec18faa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7d0a97b28083084ebdd8e5c6bccd12e6ec18faa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050&id2=b7d0a97b28083084ebdd8e5c6bccd12e6ec18faa)) | |
| download | [linux-1acd73edbbfef2c3c5b43cba4006a7797eca7050.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1acd73edbbfef2c3c5b43cba4006a7797eca7050.tar.gz) | |

f2fs: fix to account dirty data in \_\_get\_secs\_required()It will trigger system panic w/ testcase in [1]:
------------[ cut here ]------------
kernel BUG at fs/f2fs/segment.c:2752!
RIP: 0010:new\_curseg+0xc81/0x2110
Call Trace:
f2fs\_allocate\_data\_block+0x1c91/0x4540
do\_write\_page+0x163/0xdf0
f2fs\_outplace\_write\_data+0x1aa/0x340
f2fs\_do\_write\_data\_page+0x797/0x2280
f2fs\_write\_single\_data\_page+0x16cd/0x2190
f2fs\_write\_cache\_pages+0x994/0x1c80
f2fs\_write\_data\_pages+0x9cc/0xea0
do\_writepages+0x194/0x7a0
filemap\_fdatawrite\_wbc+0x12b/0x1a0
\_\_filemap\_fdatawrite\_range+0xbb/0xf0
file\_write\_and\_wait\_range+0xa1/0x110
f2fs\_do\_sync\_file+0x26f/0x1c50
f2fs\_sync\_file+0x12b/0x1d0
vfs\_fsync\_range+0xfa/0x230
do\_fsync+0x3d/0x80
\_\_x64\_sys\_fsync+0x37/0x50
x64\_sys\_call+0x1e88/0x20d0
do\_syscall\_64+0x4b/0x110
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
The root cause is if checkpoint\_disabling and lfs\_mode are both on,
it will trigger OPU for all overwritten data, it may cost more free
segment than expected, so f2fs must account those data correctly to
calculate cosumed free segments later, and return ENOSPC earlier to
avoid run out of free segment during block allocation.
[1] https://lore.kernel.org/fstests/20241015025106.3203676-1-chao@kernel.org/
Fixes: 4354994f097d ("f2fs: checkpoint disabling")
Cc: Daniel Rosenberg <drosen@google.com>
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050)

| -rw-r--r-- | [fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.h?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 25 insertions, 10 deletions

| diff --git a/fs/f2fs/segment.h b/fs/f2fs/segment.hindex e9cc73093417e7..55a01da6c4be58 100644--- a/[fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=b7d0a97b28083084ebdd8e5c6bccd12e6ec18faa)+++ b/[fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=1acd73edbbfef2c3c5b43cba4006a7797eca7050)@@ -561,18 +561,21 @@ static inline int reserved\_sections(struct f2fs\_sb\_info \*sbi) }  static inline bool has\_curseg\_enough\_space(struct f2fs\_sb\_info \*sbi,- unsigned int node\_blocks, unsigned int dent\_blocks)+ unsigned int node\_blocks, unsigned int data\_blocks,+ unsigned int dent\_blocks) { - unsigned segno, left\_blocks;+ unsigned int segno, left\_blocks, blocks; int i; - /\* check current node sections in the worst case. \*/- for (i = CURSEG\_HOT\_NODE; i <= CURSEG\_COLD\_NODE; i++) {+ /\* check current data/node sections in the worst case. \*/+ for (i = CURSEG\_HOT\_DATA; i < NR\_PERSISTENT\_LOG; i++) { segno = CURSEG\_I(sbi, i)->segno; left\_blocks = CAP\_BLKS\_PER\_SEC(sbi) - get\_ckpt\_valid\_blocks(sbi, segno, true);- if (node\_blocks > left\_blocks)++ blocks = i <= CURSEG\_COLD\_DATA ? data\_blocks : node\_blocks;+ if (blocks > left\_blocks) return false; } @@ -586,8 +589,9 @@ static inline bool has\_curseg\_enough\_space(struct f2fs\_sb\_info \*sbi, }  /\*- \* calculate needed sections for dirty node/dentry- \* and call has\_curseg\_enough\_space+ \* calculate needed sections for dirty node/dentry and call+ \* has\_curseg\_enough\_space, please note that, it needs to account+ \* dirty data as well in lfs mode when checkpoint is disabled. \*/ static inline void \_\_get\_secs\_required(struct f2fs\_sb\_info \*sbi, unsigned int \*lower\_p, unsigned int \*upper\_p, bool \*curseg\_p)@@ -596,19 +600,30 @@ static inline void \_\_get\_secs\_required(struct f2fs\_sb\_info \*sbi, get\_pages(sbi, F2FS\_DIRTY\_DENTS) + get\_pages(sbi, F2FS\_DIRTY\_IMETA); unsigned int total\_dent\_blocks = get\_pages(sbi, F2FS\_DIRTY\_DENTS);+ unsigned int total\_data\_blocks = 0; unsigned int node\_secs = total\_node\_blocks / CAP\_BLKS\_PER\_SEC(sbi); unsigned int dent\_secs = total\_dent\_blocks / CAP\_BLKS\_PER\_SEC(sbi);+ unsigned int data\_secs = 0; unsigned int node\_blocks = total\_node\_blocks % CAP\_BLKS\_PER\_SEC(sbi); unsigned int dent\_blocks = total\_dent\_blocks % CAP\_BLKS\_PER\_SEC(sbi);+ unsigned int data\_blocks = 0;++ if (f2fs\_lfs\_mode(sbi) &&+ unlikely(is\_sbi\_flag\_set(sbi, SBI\_CP\_DISABLED))) {+ total\_data\_blocks = get\_pages(sbi, F2FS\_DIRTY\_DATA);+ data\_secs = total\_data\_blocks / CAP\_BLKS\_PER\_SEC(sbi);+ data\_blocks = total\_data\_blocks % CAP\_BLKS\_PER\_SEC(sbi);+ }  if (lower\_p)- \*lower\_p = node\_secs + dent\_secs;+ \*lower\_p = node\_secs + dent\_secs + data\_secs; if (upper\_p) \*upper\_p = node\_secs + dent\_secs +- (node\_blocks ? 1 : 0) + (dent\_blocks ? 1 : 0);+ (node\_blocks ? 1 : 0) + (dent\_blocks ? 1 : 0) ++ (data\_blocks ? 1 : 0); if (curseg\_p) \*curseg\_p = has\_curseg\_enough\_space(sbi,- node\_blocks, dent\_blocks);+ node\_blocks, data\_blocks, dent\_blocks); }  static inline bool has\_not\_enough\_free\_secs(struct f2fs\_sb\_info \*sbi, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:38:03 +0000



=== Content from git.kernel.org_103790aa_20250115_083926.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6e58b2987960efcd917bc42da781cee256213618)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e58b2987960efcd917bc42da781cee256213618)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e58b2987960efcd917bc42da781cee256213618)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e58b2987960efcd917bc42da781cee256213618)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-10-15 11:43:39 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:44 +0100 |
| commit | [6e58b2987960efcd917bc42da781cee256213618](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e58b2987960efcd917bc42da781cee256213618) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6e58b2987960efcd917bc42da781cee256213618)) | |
| tree | [fe4aefbb964a57cdc23d51c4b9e4531179940e7b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e58b2987960efcd917bc42da781cee256213618) | |
| parent | [b6e617c111092746d2370686ca880b8a78d8e249](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6e617c111092746d2370686ca880b8a78d8e249) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e58b2987960efcd917bc42da781cee256213618&id2=b6e617c111092746d2370686ca880b8a78d8e249)) | |
| download | [linux-6e58b2987960efcd917bc42da781cee256213618.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6e58b2987960efcd917bc42da781cee256213618.tar.gz) | |

f2fs: fix to account dirty data in \_\_get\_secs\_required()[ Upstream commit 1acd73edbbfef2c3c5b43cba4006a7797eca7050 ]
It will trigger system panic w/ testcase in [1]:
------------[ cut here ]------------
kernel BUG at fs/f2fs/segment.c:2752!
RIP: 0010:new\_curseg+0xc81/0x2110
Call Trace:
f2fs\_allocate\_data\_block+0x1c91/0x4540
do\_write\_page+0x163/0xdf0
f2fs\_outplace\_write\_data+0x1aa/0x340
f2fs\_do\_write\_data\_page+0x797/0x2280
f2fs\_write\_single\_data\_page+0x16cd/0x2190
f2fs\_write\_cache\_pages+0x994/0x1c80
f2fs\_write\_data\_pages+0x9cc/0xea0
do\_writepages+0x194/0x7a0
filemap\_fdatawrite\_wbc+0x12b/0x1a0
\_\_filemap\_fdatawrite\_range+0xbb/0xf0
file\_write\_and\_wait\_range+0xa1/0x110
f2fs\_do\_sync\_file+0x26f/0x1c50
f2fs\_sync\_file+0x12b/0x1d0
vfs\_fsync\_range+0xfa/0x230
do\_fsync+0x3d/0x80
\_\_x64\_sys\_fsync+0x37/0x50
x64\_sys\_call+0x1e88/0x20d0
do\_syscall\_64+0x4b/0x110
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
The root cause is if checkpoint\_disabling and lfs\_mode are both on,
it will trigger OPU for all overwritten data, it may cost more free
segment than expected, so f2fs must account those data correctly to
calculate cosumed free segments later, and return ENOSPC earlier to
avoid run out of free segment during block allocation.
[1] https://lore.kernel.org/fstests/20241015025106.3203676-1-chao@kernel.org/
Fixes: 4354994f097d ("f2fs: checkpoint disabling")
Cc: Daniel Rosenberg <drosen@google.com>
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e58b2987960efcd917bc42da781cee256213618)

| -rw-r--r-- | [fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.h?id=6e58b2987960efcd917bc42da781cee256213618) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 25 insertions, 10 deletions

| diff --git a/fs/f2fs/segment.h b/fs/f2fs/segment.hindex 17d1723d98a0b3..dde79842d14d1f 100644--- a/[fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=b6e617c111092746d2370686ca880b8a78d8e249)+++ b/[fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=6e58b2987960efcd917bc42da781cee256213618)@@ -584,18 +584,21 @@ static inline int reserved\_sections(struct f2fs\_sb\_info \*sbi) }  static inline bool has\_curseg\_enough\_space(struct f2fs\_sb\_info \*sbi,- unsigned int node\_blocks, unsigned int dent\_blocks)+ unsigned int node\_blocks, unsigned int data\_blocks,+ unsigned int dent\_blocks) { - unsigned segno, left\_blocks;+ unsigned int segno, left\_blocks, blocks; int i; - /\* check current node sections in the worst case. \*/- for (i = CURSEG\_HOT\_NODE; i <= CURSEG\_COLD\_NODE; i++) {+ /\* check current data/node sections in the worst case. \*/+ for (i = CURSEG\_HOT\_DATA; i < NR\_PERSISTENT\_LOG; i++) { segno = CURSEG\_I(sbi, i)->segno; left\_blocks = CAP\_BLKS\_PER\_SEC(sbi) - get\_ckpt\_valid\_blocks(sbi, segno, true);- if (node\_blocks > left\_blocks)++ blocks = i <= CURSEG\_COLD\_DATA ? data\_blocks : node\_blocks;+ if (blocks > left\_blocks) return false; } @@ -609,8 +612,9 @@ static inline bool has\_curseg\_enough\_space(struct f2fs\_sb\_info \*sbi, }  /\*- \* calculate needed sections for dirty node/dentry- \* and call has\_curseg\_enough\_space+ \* calculate needed sections for dirty node/dentry and call+ \* has\_curseg\_enough\_space, please note that, it needs to account+ \* dirty data as well in lfs mode when checkpoint is disabled. \*/ static inline void \_\_get\_secs\_required(struct f2fs\_sb\_info \*sbi, unsigned int \*lower\_p, unsigned int \*upper\_p, bool \*curseg\_p)@@ -619,19 +623,30 @@ static inline void \_\_get\_secs\_required(struct f2fs\_sb\_info \*sbi, get\_pages(sbi, F2FS\_DIRTY\_DENTS) + get\_pages(sbi, F2FS\_DIRTY\_IMETA); unsigned int total\_dent\_blocks = get\_pages(sbi, F2FS\_DIRTY\_DENTS);+ unsigned int total\_data\_blocks = 0; unsigned int node\_secs = total\_node\_blocks / CAP\_BLKS\_PER\_SEC(sbi); unsigned int dent\_secs = total\_dent\_blocks / CAP\_BLKS\_PER\_SEC(sbi);+ unsigned int data\_secs = 0; unsigned int node\_blocks = total\_node\_blocks % CAP\_BLKS\_PER\_SEC(sbi); unsigned int dent\_blocks = total\_dent\_blocks % CAP\_BLKS\_PER\_SEC(sbi);+ unsigned int data\_blocks = 0;++ if (f2fs\_lfs\_mode(sbi) &&+ unlikely(is\_sbi\_flag\_set(sbi, SBI\_CP\_DISABLED))) {+ total\_data\_blocks = get\_pages(sbi, F2FS\_DIRTY\_DATA);+ data\_secs = total\_data\_blocks / CAP\_BLKS\_PER\_SEC(sbi);+ data\_blocks = total\_data\_blocks % CAP\_BLKS\_PER\_SEC(sbi);+ }  if (lower\_p)- \*lower\_p = node\_secs + dent\_secs;+ \*lower\_p = node\_secs + dent\_secs + data\_secs; if (upper\_p) \*upper\_p = node\_secs + dent\_secs +- (node\_blocks ? 1 : 0) + (dent\_blocks ? 1 : 0);+ (node\_blocks ? 1 : 0) + (dent\_blocks ? 1 : 0) ++ (data\_blocks ? 1 : 0); if (curseg\_p) \*curseg\_p = has\_curseg\_enough\_space(sbi,- node\_blocks, dent\_blocks);+ node\_blocks, data\_blocks, dent\_blocks); }  static inline bool has\_not\_enough\_free\_secs(struct f2fs\_sb\_info \*sbi, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:38:03 +0000



=== Content from git.kernel.org_f945efdc_20250115_083927.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-10-15 11:43:39 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:20 +0100 |
| commit | [e812871c068cc0f91ff9f5cee87d00df1c44aae4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4)) | |
| tree | [9d923e41999ad29320e76a0cf38c21f43c05b4a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4) | |
| parent | [3afa3958897189f9813d7a99529699634ff1e7be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3afa3958897189f9813d7a99529699634ff1e7be) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4&id2=3afa3958897189f9813d7a99529699634ff1e7be)) | |
| download | [linux-e812871c068cc0f91ff9f5cee87d00df1c44aae4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e812871c068cc0f91ff9f5cee87d00df1c44aae4.tar.gz) | |

f2fs: fix to account dirty data in \_\_get\_secs\_required()[ Upstream commit 1acd73edbbfef2c3c5b43cba4006a7797eca7050 ]
It will trigger system panic w/ testcase in [1]:
------------[ cut here ]------------
kernel BUG at fs/f2fs/segment.c:2752!
RIP: 0010:new\_curseg+0xc81/0x2110
Call Trace:
f2fs\_allocate\_data\_block+0x1c91/0x4540
do\_write\_page+0x163/0xdf0
f2fs\_outplace\_write\_data+0x1aa/0x340
f2fs\_do\_write\_data\_page+0x797/0x2280
f2fs\_write\_single\_data\_page+0x16cd/0x2190
f2fs\_write\_cache\_pages+0x994/0x1c80
f2fs\_write\_data\_pages+0x9cc/0xea0
do\_writepages+0x194/0x7a0
filemap\_fdatawrite\_wbc+0x12b/0x1a0
\_\_filemap\_fdatawrite\_range+0xbb/0xf0
file\_write\_and\_wait\_range+0xa1/0x110
f2fs\_do\_sync\_file+0x26f/0x1c50
f2fs\_sync\_file+0x12b/0x1d0
vfs\_fsync\_range+0xfa/0x230
do\_fsync+0x3d/0x80
\_\_x64\_sys\_fsync+0x37/0x50
x64\_sys\_call+0x1e88/0x20d0
do\_syscall\_64+0x4b/0x110
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
The root cause is if checkpoint\_disabling and lfs\_mode are both on,
it will trigger OPU for all overwritten data, it may cost more free
segment than expected, so f2fs must account those data correctly to
calculate cosumed free segments later, and return ENOSPC earlier to
avoid run out of free segment during block allocation.
[1] https://lore.kernel.org/fstests/20241015025106.3203676-1-chao@kernel.org/
Fixes: 4354994f097d ("f2fs: checkpoint disabling")
Cc: Daniel Rosenberg <drosen@google.com>
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4)

| -rw-r--r-- | [fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.h?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 25 insertions, 10 deletions

| diff --git a/fs/f2fs/segment.h b/fs/f2fs/segment.hindex 71adb4a43bec53..51b2b8c5c749c5 100644--- a/[fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=3afa3958897189f9813d7a99529699634ff1e7be)+++ b/[fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=e812871c068cc0f91ff9f5cee87d00df1c44aae4)@@ -559,18 +559,21 @@ static inline int reserved\_sections(struct f2fs\_sb\_info \*sbi) }  static inline bool has\_curseg\_enough\_space(struct f2fs\_sb\_info \*sbi,- unsigned int node\_blocks, unsigned int dent\_blocks)+ unsigned int node\_blocks, unsigned int data\_blocks,+ unsigned int dent\_blocks) { - unsigned segno, left\_blocks;+ unsigned int segno, left\_blocks, blocks; int i; - /\* check current node sections in the worst case. \*/- for (i = CURSEG\_HOT\_NODE; i <= CURSEG\_COLD\_NODE; i++) {+ /\* check current data/node sections in the worst case. \*/+ for (i = CURSEG\_HOT\_DATA; i < NR\_PERSISTENT\_LOG; i++) { segno = CURSEG\_I(sbi, i)->segno; left\_blocks = CAP\_BLKS\_PER\_SEC(sbi) - get\_ckpt\_valid\_blocks(sbi, segno, true);- if (node\_blocks > left\_blocks)++ blocks = i <= CURSEG\_COLD\_DATA ? data\_blocks : node\_blocks;+ if (blocks > left\_blocks) return false; } @@ -584,8 +587,9 @@ static inline bool has\_curseg\_enough\_space(struct f2fs\_sb\_info \*sbi, }  /\*- \* calculate needed sections for dirty node/dentry- \* and call has\_curseg\_enough\_space+ \* calculate needed sections for dirty node/dentry and call+ \* has\_curseg\_enough\_space, please note that, it needs to account+ \* dirty data as well in lfs mode when checkpoint is disabled. \*/ static inline void \_\_get\_secs\_required(struct f2fs\_sb\_info \*sbi, unsigned int \*lower\_p, unsigned int \*upper\_p, bool \*curseg\_p)@@ -594,19 +598,30 @@ static inline void \_\_get\_secs\_required(struct f2fs\_sb\_info \*sbi, get\_pages(sbi, F2FS\_DIRTY\_DENTS) + get\_pages(sbi, F2FS\_DIRTY\_IMETA); unsigned int total\_dent\_blocks = get\_pages(sbi, F2FS\_DIRTY\_DENTS);+ unsigned int total\_data\_blocks = 0; unsigned int node\_secs = total\_node\_blocks / CAP\_BLKS\_PER\_SEC(sbi); unsigned int dent\_secs = total\_dent\_blocks / CAP\_BLKS\_PER\_SEC(sbi);+ unsigned int data\_secs = 0; unsigned int node\_blocks = total\_node\_blocks % CAP\_BLKS\_PER\_SEC(sbi); unsigned int dent\_blocks = total\_dent\_blocks % CAP\_BLKS\_PER\_SEC(sbi);+ unsigned int data\_blocks = 0;++ if (f2fs\_lfs\_mode(sbi) &&+ unlikely(is\_sbi\_flag\_set(sbi, SBI\_CP\_DISABLED))) {+ total\_data\_blocks = get\_pages(sbi, F2FS\_DIRTY\_DATA);+ data\_secs = total\_data\_blocks / CAP\_BLKS\_PER\_SEC(sbi);+ data\_blocks = total\_data\_blocks % CAP\_BLKS\_PER\_SEC(sbi);+ }  if (lower\_p)- \*lower\_p = node\_secs + dent\_secs;+ \*lower\_p = node\_secs + dent\_secs + data\_secs; if (upper\_p) \*upper\_p = node\_secs + dent\_secs +- (node\_blocks ? 1 : 0) + (dent\_blocks ? 1 : 0);+ (node\_blocks ? 1 : 0) + (dent\_blocks ? 1 : 0) ++ (data\_blocks ? 1 : 0); if (curseg\_p) \*curseg\_p = has\_curseg\_enough\_space(sbi,- node\_blocks, dent\_blocks);+ node\_blocks, data\_blocks, dent\_blocks); }  static inline bool has\_not\_enough\_free\_secs(struct f2fs\_sb\_info \*sbi, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:38:04 +0000



=== Content from git.kernel.org_b0f945ef_20250115_083927.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-10-15 11:43:39 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:47 +0100 |
| commit | [9313b85ddc120e2d2f0efaf86d0204d4c98d60b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1)) | |
| tree | [53c38caab71129a3344cb47870530bc362cedaef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1) | |
| parent | [32f5e291b7677495f98246eec573767430321c08](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32f5e291b7677495f98246eec573767430321c08) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1&id2=32f5e291b7677495f98246eec573767430321c08)) | |
| download | [linux-9313b85ddc120e2d2f0efaf86d0204d4c98d60b1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9313b85ddc120e2d2f0efaf86d0204d4c98d60b1.tar.gz) | |

f2fs: fix to account dirty data in \_\_get\_secs\_required()[ Upstream commit 1acd73edbbfef2c3c5b43cba4006a7797eca7050 ]
It will trigger system panic w/ testcase in [1]:
------------[ cut here ]------------
kernel BUG at fs/f2fs/segment.c:2752!
RIP: 0010:new\_curseg+0xc81/0x2110
Call Trace:
f2fs\_allocate\_data\_block+0x1c91/0x4540
do\_write\_page+0x163/0xdf0
f2fs\_outplace\_write\_data+0x1aa/0x340
f2fs\_do\_write\_data\_page+0x797/0x2280
f2fs\_write\_single\_data\_page+0x16cd/0x2190
f2fs\_write\_cache\_pages+0x994/0x1c80
f2fs\_write\_data\_pages+0x9cc/0xea0
do\_writepages+0x194/0x7a0
filemap\_fdatawrite\_wbc+0x12b/0x1a0
\_\_filemap\_fdatawrite\_range+0xbb/0xf0
file\_write\_and\_wait\_range+0xa1/0x110
f2fs\_do\_sync\_file+0x26f/0x1c50
f2fs\_sync\_file+0x12b/0x1d0
vfs\_fsync\_range+0xfa/0x230
do\_fsync+0x3d/0x80
\_\_x64\_sys\_fsync+0x37/0x50
x64\_sys\_call+0x1e88/0x20d0
do\_syscall\_64+0x4b/0x110
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
The root cause is if checkpoint\_disabling and lfs\_mode are both on,
it will trigger OPU for all overwritten data, it may cost more free
segment than expected, so f2fs must account those data correctly to
calculate cosumed free segments later, and return ENOSPC earlier to
avoid run out of free segment during block allocation.
[1] https://lore.kernel.org/fstests/20241015025106.3203676-1-chao@kernel.org/
Fixes: 4354994f097d ("f2fs: checkpoint disabling")
Cc: Daniel Rosenberg <drosen@google.com>
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1)

| -rw-r--r-- | [fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.h?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 25 insertions, 10 deletions

| diff --git a/fs/f2fs/segment.h b/fs/f2fs/segment.hindex bfc01a521cb98e..c3aeca7e0dde6c 100644--- a/[fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=32f5e291b7677495f98246eec573767430321c08)+++ b/[fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=9313b85ddc120e2d2f0efaf86d0204d4c98d60b1)@@ -558,18 +558,21 @@ static inline int reserved\_sections(struct f2fs\_sb\_info \*sbi) }  static inline bool has\_curseg\_enough\_space(struct f2fs\_sb\_info \*sbi,- unsigned int node\_blocks, unsigned int dent\_blocks)+ unsigned int node\_blocks, unsigned int data\_blocks,+ unsigned int dent\_blocks) { - unsigned segno, left\_blocks;+ unsigned int segno, left\_blocks, blocks; int i; - /\* check current node sections in the worst case. \*/- for (i = CURSEG\_HOT\_NODE; i <= CURSEG\_COLD\_NODE; i++) {+ /\* check current data/node sections in the worst case. \*/+ for (i = CURSEG\_HOT\_DATA; i < NR\_PERSISTENT\_LOG; i++) { segno = CURSEG\_I(sbi, i)->segno; left\_blocks = CAP\_BLKS\_PER\_SEC(sbi) - get\_ckpt\_valid\_blocks(sbi, segno, true);- if (node\_blocks > left\_blocks)++ blocks = i <= CURSEG\_COLD\_DATA ? data\_blocks : node\_blocks;+ if (blocks > left\_blocks) return false; } @@ -583,8 +586,9 @@ static inline bool has\_curseg\_enough\_space(struct f2fs\_sb\_info \*sbi, }  /\*- \* calculate needed sections for dirty node/dentry- \* and call has\_curseg\_enough\_space+ \* calculate needed sections for dirty node/dentry and call+ \* has\_curseg\_enough\_space, please note that, it needs to account+ \* dirty data as well in lfs mode when checkpoint is disabled. \*/ static inline void \_\_get\_secs\_required(struct f2fs\_sb\_info \*sbi, unsigned int \*lower\_p, unsigned int \*upper\_p, bool \*curseg\_p)@@ -593,19 +597,30 @@ static inline void \_\_get\_secs\_required(struct f2fs\_sb\_info \*sbi, get\_pages(sbi, F2FS\_DIRTY\_DENTS) + get\_pages(sbi, F2FS\_DIRTY\_IMETA); unsigned int total\_dent\_blocks = get\_pages(sbi, F2FS\_DIRTY\_DENTS);+ unsigned int total\_data\_blocks = 0; unsigned int node\_secs = total\_node\_blocks / CAP\_BLKS\_PER\_SEC(sbi); unsigned int dent\_secs = total\_dent\_blocks / CAP\_BLKS\_PER\_SEC(sbi);+ unsigned int data\_secs = 0; unsigned int node\_blocks = total\_node\_blocks % CAP\_BLKS\_PER\_SEC(sbi); unsigned int dent\_blocks = total\_dent\_blocks % CAP\_BLKS\_PER\_SEC(sbi);+ unsigned int data\_blocks = 0;++ if (f2fs\_lfs\_mode(sbi) &&+ unlikely(is\_sbi\_flag\_set(sbi, SBI\_CP\_DISABLED))) {+ total\_data\_blocks = get\_pages(sbi, F2FS\_DIRTY\_DATA);+ data\_secs = total\_data\_blocks / CAP\_BLKS\_PER\_SEC(sbi);+ data\_blocks = total\_data\_blocks % CAP\_BLKS\_PER\_SEC(sbi);+ }  if (lower\_p)- \*lower\_p = node\_secs + dent\_secs;+ \*lower\_p = node\_secs + dent\_secs + data\_secs; if (upper\_p) \*upper\_p = node\_secs + dent\_secs +- (node\_blocks ? 1 : 0) + (dent\_blocks ? 1 : 0);+ (node\_blocks ? 1 : 0) + (dent\_blocks ? 1 : 0) ++ (data\_blocks ? 1 : 0); if (curseg\_p) \*curseg\_p = has\_curseg\_enough\_space(sbi,- node\_blocks, dent\_blocks);+ node\_blocks, data\_blocks, dent\_blocks); }  static inline bool has\_not\_enough\_free\_secs(struct f2fs\_sb\_info \*sbi, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:38:04 +0000



=== Content from git.kernel.org_9b763557_20250115_083928.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-10-15 11:43:39 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:25 +0100 |
| commit | [f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5)) | |
| tree | [1de197daca51bfb56c5871b9312c0763b69b3bb9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5) | |
| parent | [6b0ed65c94c238f1885112d436a66e8984cd495e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b0ed65c94c238f1885112d436a66e8984cd495e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5&id2=6b0ed65c94c238f1885112d436a66e8984cd495e)) | |
| download | [linux-f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5.tar.gz) | |

f2fs: fix to account dirty data in \_\_get\_secs\_required()[ Upstream commit 1acd73edbbfef2c3c5b43cba4006a7797eca7050 ]
It will trigger system panic w/ testcase in [1]:
------------[ cut here ]------------
kernel BUG at fs/f2fs/segment.c:2752!
RIP: 0010:new\_curseg+0xc81/0x2110
Call Trace:
f2fs\_allocate\_data\_block+0x1c91/0x4540
do\_write\_page+0x163/0xdf0
f2fs\_outplace\_write\_data+0x1aa/0x340
f2fs\_do\_write\_data\_page+0x797/0x2280
f2fs\_write\_single\_data\_page+0x16cd/0x2190
f2fs\_write\_cache\_pages+0x994/0x1c80
f2fs\_write\_data\_pages+0x9cc/0xea0
do\_writepages+0x194/0x7a0
filemap\_fdatawrite\_wbc+0x12b/0x1a0
\_\_filemap\_fdatawrite\_range+0xbb/0xf0
file\_write\_and\_wait\_range+0xa1/0x110
f2fs\_do\_sync\_file+0x26f/0x1c50
f2fs\_sync\_file+0x12b/0x1d0
vfs\_fsync\_range+0xfa/0x230
do\_fsync+0x3d/0x80
\_\_x64\_sys\_fsync+0x37/0x50
x64\_sys\_call+0x1e88/0x20d0
do\_syscall\_64+0x4b/0x110
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
The root cause is if checkpoint\_disabling and lfs\_mode are both on,
it will trigger OPU for all overwritten data, it may cost more free
segment than expected, so f2fs must account those data correctly to
calculate cosumed free segments later, and return ENOSPC earlier to
avoid run out of free segment during block allocation.
[1] https://lore.kernel.org/fstests/20241015025106.3203676-1-chao@kernel.org/
Fixes: 4354994f097d ("f2fs: checkpoint disabling")
Cc: Daniel Rosenberg <drosen@google.com>
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5)

| -rw-r--r-- | [fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.h?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 25 insertions, 10 deletions

| diff --git a/fs/f2fs/segment.h b/fs/f2fs/segment.hindex 952970166d5da8..cd2ec6acc71776 100644--- a/[fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=6b0ed65c94c238f1885112d436a66e8984cd495e)+++ b/[fs/f2fs/segment.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=f1b8bfe8d2f2fdf905d37c174d5bc1cd2b6910c5)@@ -559,18 +559,21 @@ static inline int reserved\_sections(struct f2fs\_sb\_info \*sbi) }  static inline bool has\_curseg\_enough\_space(struct f2fs\_sb\_info \*sbi,- unsigned int node\_blocks, unsigned int dent\_blocks)+ unsigned int node\_blocks, unsigned int data\_blocks,+ unsigned int dent\_blocks) { - unsigned segno, left\_blocks;+ unsigned int segno, left\_blocks, blocks; int i; - /\* check current node sections in the worst case. \*/- for (i = CURSEG\_HOT\_NODE; i <= CURSEG\_COLD\_NODE; i++) {+ /\* check current data/node sections in the worst case. \*/+ for (i = CURSEG\_HOT\_DATA; i < NR\_PERSISTENT\_LOG; i++) { segno = CURSEG\_I(sbi, i)->segno; left\_blocks = CAP\_BLKS\_PER\_SEC(sbi) - get\_ckpt\_valid\_blocks(sbi, segno, true);- if (node\_blocks > left\_blocks)++ blocks = i <= CURSEG\_COLD\_DATA ? data\_blocks : node\_blocks;+ if (blocks > left\_blocks) return false; } @@ -584,8 +587,9 @@ static inline bool has\_curseg\_enough\_space(struct f2fs\_sb\_info \*sbi, }  /\*- \* calculate needed sections for dirty node/dentry- \* and call has\_curseg\_enough\_space+ \* calculate needed sections for dirty node/dentry and call+ \* has\_curseg\_enough\_space, please note that, it needs to account+ \* dirty data as well in lfs mode when checkpoint is disabled. \*/ static inline void \_\_get\_secs\_required(struct f2fs\_sb\_info \*sbi, unsigned int \*lower\_p, unsigned int \*upper\_p, bool \*curseg\_p)@@ -594,19 +598,30 @@ static inline void \_\_get\_secs\_required(struct f2fs\_sb\_info \*sbi, get\_pages(sbi, F2FS\_DIRTY\_DENTS) + get\_pages(sbi, F2FS\_DIRTY\_IMETA); unsigned int total\_dent\_blocks = get\_pages(sbi, F2FS\_DIRTY\_DENTS);+ unsigned int total\_data\_blocks = 0; unsigned int node\_secs = total\_node\_blocks / CAP\_BLKS\_PER\_SEC(sbi); unsigned int dent\_secs = total\_dent\_blocks / CAP\_BLKS\_PER\_SEC(sbi);+ unsigned int data\_secs = 0; unsigned int node\_blocks = total\_node\_blocks % CAP\_BLKS\_PER\_SEC(sbi); unsigned int dent\_blocks = total\_dent\_blocks % CAP\_BLKS\_PER\_SEC(sbi);+ unsigned int data\_blocks = 0;++ if (f2fs\_lfs\_mode(sbi) &&+ unlikely(is\_sbi\_flag\_set(sbi, SBI\_CP\_DISABLED))) {+ total\_data\_blocks = get\_pages(sbi, F2FS\_DIRTY\_DATA);+ data\_secs = total\_data\_blocks / CAP\_BLKS\_PER\_SEC(sbi);+ data\_blocks = total\_data\_blocks % CAP\_BLKS\_PER\_SEC(sbi);+ }  if (lower\_p)- \*lower\_p = node\_secs + dent\_secs;+ \*lower\_p = node\_secs + dent\_secs + data\_secs; if (upper\_p) \*upper\_p = node\_secs + dent\_secs +- (node\_blocks ? 1 : 0) + (dent\_blocks ? 1 : 0);+ (node\_blocks ? 1 : 0) + (dent\_blocks ? 1 : 0) ++ (data\_blocks ? 1 : 0); if (curseg\_p) \*curseg\_p = has\_curseg\_enough\_space(sbi,- node\_blocks, dent\_blocks);+ node\_blocks, data\_blocks, dent\_blocks); }  static inline bool has\_not\_enough\_free\_secs(struct f2fs\_sb\_info \*sbi, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:38:05 +0000


