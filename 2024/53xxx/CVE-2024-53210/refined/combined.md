=== Content from git.kernel.org_e914c1a2_20250115_093525.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=934326aef7ac4652f81c69d18bf44eebaefc39c3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=934326aef7ac4652f81c69d18bf44eebaefc39c3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=934326aef7ac4652f81c69d18bf44eebaefc39c3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=934326aef7ac4652f81c69d18bf44eebaefc39c3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sidraya Jayagond <sidraya@linux.ibm.com> | 2024-11-19 16:22:19 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:50 +0100 |
| commit | [934326aef7ac4652f81c69d18bf44eebaefc39c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=934326aef7ac4652f81c69d18bf44eebaefc39c3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=934326aef7ac4652f81c69d18bf44eebaefc39c3)) | |
| tree | [d45b9eb6bba878cc3ab17e615f32dd45b68d7754](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=934326aef7ac4652f81c69d18bf44eebaefc39c3) | |
| parent | [cd11087343ec43c9b1cd18bb788a24f02b082bb5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd11087343ec43c9b1cd18bb788a24f02b082bb5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=934326aef7ac4652f81c69d18bf44eebaefc39c3&id2=cd11087343ec43c9b1cd18bb788a24f02b082bb5)) | |
| download | [linux-934326aef7ac4652f81c69d18bf44eebaefc39c3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-934326aef7ac4652f81c69d18bf44eebaefc39c3.tar.gz) | |

s390/iucv: MSG\_PEEK causes memory leak in iucv\_sock\_destruct()[ Upstream commit ebaf81317e42aa990ad20b113cfe3a7b20d4e937 ]
Passing MSG\_PEEK flag to skb\_recv\_datagram() increments skb refcount
(skb->users) and iucv\_sock\_recvmsg() does not decrement skb refcount
at exit.
This results in skb memory leak in skb\_queue\_purge() and WARN\_ON in
iucv\_sock\_destruct() during socket close. To fix this decrease
skb refcount by one if MSG\_PEEK is set in order to prevent memory
leak and WARN\_ON.
WARNING: CPU: 2 PID: 6292 at net/iucv/af\_iucv.c:286 iucv\_sock\_destruct+0x144/0x1a0 [af\_iucv]
CPU: 2 PID: 6292 Comm: afiucv\_test\_msg Kdump: loaded Tainted: G W 6.10.0-rc7 #1
Hardware name: IBM 3931 A01 704 (z/VM 7.3.0)
Call Trace:
[<001587c682c4aa98>] iucv\_sock\_destruct+0x148/0x1a0 [af\_iucv]
[<001587c682c4a9d0>] iucv\_sock\_destruct+0x80/0x1a0 [af\_iucv]
[<001587c704117a32>] \_\_sk\_destruct+0x52/0x550
[<001587c704104a54>] \_\_sock\_release+0xa4/0x230
[<001587c704104c0c>] sock\_close+0x2c/0x40
[<001587c702c5f5a8>] \_\_fput+0x2e8/0x970
[<001587c7024148c4>] task\_work\_run+0x1c4/0x2c0
[<001587c7023b0716>] do\_exit+0x996/0x1050
[<001587c7023b13aa>] do\_group\_exit+0x13a/0x360
[<001587c7023b1626>] \_\_s390x\_sys\_exit\_group+0x56/0x60
[<001587c7022bccca>] do\_syscall+0x27a/0x380
[<001587c7049a6a0c>] \_\_do\_syscall+0x9c/0x160
[<001587c7049ce8a8>] system\_call+0x70/0x98
Last Breaking-Event-Address:
[<001587c682c4a9d4>] iucv\_sock\_destruct+0x84/0x1a0 [af\_iucv]
Fixes: eac3731bd04c ("[S390]: Add AF\_IUCV socket support")
Reviewed-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: Thorsten Winkler <twinkler@linux.ibm.com>
Signed-off-by: Sidraya Jayagond <sidraya@linux.ibm.com>
Signed-off-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: David Wei <dw@davidwei.uk>
Link: [https://patch.msgid.link/20241119152219.3712168-1-wintera@linux.ibm.com](https://patch.msgid.link/20241119152219.3712168-1-wintera%40linux.ibm.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=934326aef7ac4652f81c69d18bf44eebaefc39c3)

| -rw-r--r-- | [net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/iucv/af_iucv.c?id=934326aef7ac4652f81c69d18bf44eebaefc39c3) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 9 deletions

| diff --git a/net/iucv/af\_iucv.c b/net/iucv/af\_iucv.cindex 815b1df0b2d194..0f660b1d3bd51c 100644--- a/[net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/iucv/af_iucv.c?id=cd11087343ec43c9b1cd18bb788a24f02b082bb5)+++ b/[net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/iucv/af_iucv.c?id=934326aef7ac4652f81c69d18bf44eebaefc39c3)@@ -1238,7 +1238,9 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, return -EOPNOTSUPP;  /\* receive/dequeue next skb:- \* the function understands MSG\_PEEK and, thus, does not dequeue skb \*/+ \* the function understands MSG\_PEEK and, thus, does not dequeue skb+ \* only refcount is increased.+ \*/ skb = skb\_recv\_datagram(sk, flags, &err); if (!skb) { if (sk->sk\_shutdown & RCV\_SHUTDOWN)@@ -1254,9 +1256,8 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg,  cskb = skb; if (skb\_copy\_datagram\_msg(cskb, offset, msg, copied)) {- if (!(flags & MSG\_PEEK))- skb\_queue\_head(&sk->sk\_receive\_queue, skb);- return -EFAULT;+ err = -EFAULT;+ goto err\_out; }  /\* SOCK\_SEQPACKET: set MSG\_TRUNC if recv buf size is too small \*/@@ -1273,11 +1274,8 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, err = put\_cmsg(msg, SOL\_IUCV, SCM\_IUCV\_TRGCLS, sizeof(IUCV\_SKB\_CB(skb)->class), (void \*)&IUCV\_SKB\_CB(skb)->class);- if (err) {- if (!(flags & MSG\_PEEK))- skb\_queue\_head(&sk->sk\_receive\_queue, skb);- return err;- }+ if (err)+ goto err\_out;  /\* Mark read part of skb as used \*/ if (!(flags & MSG\_PEEK)) {@@ -1333,8 +1331,18 @@ done: /\* SOCK\_SEQPACKET: return real length if MSG\_TRUNC is set \*/ if (sk->sk\_type == SOCK\_SEQPACKET && (flags & MSG\_TRUNC)) copied = rlen;+ if (flags & MSG\_PEEK)+ skb\_unref(skb);  return copied;++err\_out:+ if (!(flags & MSG\_PEEK))+ skb\_queue\_head(&sk->sk\_receive\_queue, skb);+ else+ skb\_unref(skb);++ return err; }  static inline \_\_poll\_t iucv\_accept\_poll(struct sock \*parent) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:02 +0000



=== Content from git.kernel.org_5b6dd26f_20250115_093524.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=42251c2d1ef1cb0822638bebb87ad9120c759673)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=42251c2d1ef1cb0822638bebb87ad9120c759673)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42251c2d1ef1cb0822638bebb87ad9120c759673)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=42251c2d1ef1cb0822638bebb87ad9120c759673)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sidraya Jayagond <sidraya@linux.ibm.com> | 2024-11-19 16:22:19 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:33 +0100 |
| commit | [42251c2d1ef1cb0822638bebb87ad9120c759673](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42251c2d1ef1cb0822638bebb87ad9120c759673) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=42251c2d1ef1cb0822638bebb87ad9120c759673)) | |
| tree | [5114d64126406316389c0434d64d52fddbcc974f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=42251c2d1ef1cb0822638bebb87ad9120c759673) | |
| parent | [f2a30e6fcd5abb9067d1059323574d18f27514e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2a30e6fcd5abb9067d1059323574d18f27514e7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=42251c2d1ef1cb0822638bebb87ad9120c759673&id2=f2a30e6fcd5abb9067d1059323574d18f27514e7)) | |
| download | [linux-42251c2d1ef1cb0822638bebb87ad9120c759673.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-42251c2d1ef1cb0822638bebb87ad9120c759673.tar.gz) | |

s390/iucv: MSG\_PEEK causes memory leak in iucv\_sock\_destruct()[ Upstream commit ebaf81317e42aa990ad20b113cfe3a7b20d4e937 ]
Passing MSG\_PEEK flag to skb\_recv\_datagram() increments skb refcount
(skb->users) and iucv\_sock\_recvmsg() does not decrement skb refcount
at exit.
This results in skb memory leak in skb\_queue\_purge() and WARN\_ON in
iucv\_sock\_destruct() during socket close. To fix this decrease
skb refcount by one if MSG\_PEEK is set in order to prevent memory
leak and WARN\_ON.
WARNING: CPU: 2 PID: 6292 at net/iucv/af\_iucv.c:286 iucv\_sock\_destruct+0x144/0x1a0 [af\_iucv]
CPU: 2 PID: 6292 Comm: afiucv\_test\_msg Kdump: loaded Tainted: G W 6.10.0-rc7 #1
Hardware name: IBM 3931 A01 704 (z/VM 7.3.0)
Call Trace:
[<001587c682c4aa98>] iucv\_sock\_destruct+0x148/0x1a0 [af\_iucv]
[<001587c682c4a9d0>] iucv\_sock\_destruct+0x80/0x1a0 [af\_iucv]
[<001587c704117a32>] \_\_sk\_destruct+0x52/0x550
[<001587c704104a54>] \_\_sock\_release+0xa4/0x230
[<001587c704104c0c>] sock\_close+0x2c/0x40
[<001587c702c5f5a8>] \_\_fput+0x2e8/0x970
[<001587c7024148c4>] task\_work\_run+0x1c4/0x2c0
[<001587c7023b0716>] do\_exit+0x996/0x1050
[<001587c7023b13aa>] do\_group\_exit+0x13a/0x360
[<001587c7023b1626>] \_\_s390x\_sys\_exit\_group+0x56/0x60
[<001587c7022bccca>] do\_syscall+0x27a/0x380
[<001587c7049a6a0c>] \_\_do\_syscall+0x9c/0x160
[<001587c7049ce8a8>] system\_call+0x70/0x98
Last Breaking-Event-Address:
[<001587c682c4a9d4>] iucv\_sock\_destruct+0x84/0x1a0 [af\_iucv]
Fixes: eac3731bd04c ("[S390]: Add AF\_IUCV socket support")
Reviewed-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: Thorsten Winkler <twinkler@linux.ibm.com>
Signed-off-by: Sidraya Jayagond <sidraya@linux.ibm.com>
Signed-off-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: David Wei <dw@davidwei.uk>
Link: [https://patch.msgid.link/20241119152219.3712168-1-wintera@linux.ibm.com](https://patch.msgid.link/20241119152219.3712168-1-wintera%40linux.ibm.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=42251c2d1ef1cb0822638bebb87ad9120c759673)

| -rw-r--r-- | [net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/iucv/af_iucv.c?id=42251c2d1ef1cb0822638bebb87ad9120c759673) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 9 deletions

| diff --git a/net/iucv/af\_iucv.c b/net/iucv/af\_iucv.cindex 815b1df0b2d194..0f660b1d3bd51c 100644--- a/[net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/iucv/af_iucv.c?id=f2a30e6fcd5abb9067d1059323574d18f27514e7)+++ b/[net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/iucv/af_iucv.c?id=42251c2d1ef1cb0822638bebb87ad9120c759673)@@ -1238,7 +1238,9 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, return -EOPNOTSUPP;  /\* receive/dequeue next skb:- \* the function understands MSG\_PEEK and, thus, does not dequeue skb \*/+ \* the function understands MSG\_PEEK and, thus, does not dequeue skb+ \* only refcount is increased.+ \*/ skb = skb\_recv\_datagram(sk, flags, &err); if (!skb) { if (sk->sk\_shutdown & RCV\_SHUTDOWN)@@ -1254,9 +1256,8 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg,  cskb = skb; if (skb\_copy\_datagram\_msg(cskb, offset, msg, copied)) {- if (!(flags & MSG\_PEEK))- skb\_queue\_head(&sk->sk\_receive\_queue, skb);- return -EFAULT;+ err = -EFAULT;+ goto err\_out; }  /\* SOCK\_SEQPACKET: set MSG\_TRUNC if recv buf size is too small \*/@@ -1273,11 +1274,8 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, err = put\_cmsg(msg, SOL\_IUCV, SCM\_IUCV\_TRGCLS, sizeof(IUCV\_SKB\_CB(skb)->class), (void \*)&IUCV\_SKB\_CB(skb)->class);- if (err) {- if (!(flags & MSG\_PEEK))- skb\_queue\_head(&sk->sk\_receive\_queue, skb);- return err;- }+ if (err)+ goto err\_out;  /\* Mark read part of skb as used \*/ if (!(flags & MSG\_PEEK)) {@@ -1333,8 +1331,18 @@ done: /\* SOCK\_SEQPACKET: return real length if MSG\_TRUNC is set \*/ if (sk->sk\_type == SOCK\_SEQPACKET && (flags & MSG\_TRUNC)) copied = rlen;+ if (flags & MSG\_PEEK)+ skb\_unref(skb);  return copied;++err\_out:+ if (!(flags & MSG\_PEEK))+ skb\_queue\_head(&sk->sk\_receive\_queue, skb);+ else+ skb\_unref(skb);++ return err; }  static inline \_\_poll\_t iucv\_accept\_poll(struct sock \*parent) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:01 +0000



=== Content from git.kernel.org_8375fb30_20250115_093527.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sidraya Jayagond <sidraya@linux.ibm.com> | 2024-11-19 16:22:19 +0100 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-11-26 10:02:53 +0100 |
| commit | [ebaf81317e42aa990ad20b113cfe3a7b20d4e937](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937)) | |
| tree | [2bc04c0bd0195679901ca1a8e64a7e450c69ae51](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937) | |
| parent | [5d066766c5f1252f98ff859265bcd1a5b52ac46c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d066766c5f1252f98ff859265bcd1a5b52ac46c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937&id2=5d066766c5f1252f98ff859265bcd1a5b52ac46c)) | |
| download | [linux-ebaf81317e42aa990ad20b113cfe3a7b20d4e937.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ebaf81317e42aa990ad20b113cfe3a7b20d4e937.tar.gz) | |

s390/iucv: MSG\_PEEK causes memory leak in iucv\_sock\_destruct()Passing MSG\_PEEK flag to skb\_recv\_datagram() increments skb refcount
(skb->users) and iucv\_sock\_recvmsg() does not decrement skb refcount
at exit.
This results in skb memory leak in skb\_queue\_purge() and WARN\_ON in
iucv\_sock\_destruct() during socket close. To fix this decrease
skb refcount by one if MSG\_PEEK is set in order to prevent memory
leak and WARN\_ON.
WARNING: CPU: 2 PID: 6292 at net/iucv/af\_iucv.c:286 iucv\_sock\_destruct+0x144/0x1a0 [af\_iucv]
CPU: 2 PID: 6292 Comm: afiucv\_test\_msg Kdump: loaded Tainted: G W 6.10.0-rc7 #1
Hardware name: IBM 3931 A01 704 (z/VM 7.3.0)
Call Trace:
[<001587c682c4aa98>] iucv\_sock\_destruct+0x148/0x1a0 [af\_iucv]
[<001587c682c4a9d0>] iucv\_sock\_destruct+0x80/0x1a0 [af\_iucv]
[<001587c704117a32>] \_\_sk\_destruct+0x52/0x550
[<001587c704104a54>] \_\_sock\_release+0xa4/0x230
[<001587c704104c0c>] sock\_close+0x2c/0x40
[<001587c702c5f5a8>] \_\_fput+0x2e8/0x970
[<001587c7024148c4>] task\_work\_run+0x1c4/0x2c0
[<001587c7023b0716>] do\_exit+0x996/0x1050
[<001587c7023b13aa>] do\_group\_exit+0x13a/0x360
[<001587c7023b1626>] \_\_s390x\_sys\_exit\_group+0x56/0x60
[<001587c7022bccca>] do\_syscall+0x27a/0x380
[<001587c7049a6a0c>] \_\_do\_syscall+0x9c/0x160
[<001587c7049ce8a8>] system\_call+0x70/0x98
Last Breaking-Event-Address:
[<001587c682c4a9d4>] iucv\_sock\_destruct+0x84/0x1a0 [af\_iucv]
Fixes: eac3731bd04c ("[S390]: Add AF\_IUCV socket support")
Reviewed-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: Thorsten Winkler <twinkler@linux.ibm.com>
Signed-off-by: Sidraya Jayagond <sidraya@linux.ibm.com>
Signed-off-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: David Wei <dw@davidwei.uk>
Link: [https://patch.msgid.link/20241119152219.3712168-1-wintera@linux.ibm.com](https://patch.msgid.link/20241119152219.3712168-1-wintera%40linux.ibm.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937)

| -rw-r--r-- | [net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/iucv/af_iucv.c?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 9 deletions

| diff --git a/net/iucv/af\_iucv.c b/net/iucv/af\_iucv.cindex c00323fa9eb66e..7929df08d4e023 100644--- a/[net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/iucv/af_iucv.c?id=5d066766c5f1252f98ff859265bcd1a5b52ac46c)+++ b/[net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/iucv/af_iucv.c?id=ebaf81317e42aa990ad20b113cfe3a7b20d4e937)@@ -1236,7 +1236,9 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, return -EOPNOTSUPP;  /\* receive/dequeue next skb:- \* the function understands MSG\_PEEK and, thus, does not dequeue skb \*/+ \* the function understands MSG\_PEEK and, thus, does not dequeue skb+ \* only refcount is increased.+ \*/ skb = skb\_recv\_datagram(sk, flags, &err); if (!skb) { if (sk->sk\_shutdown & RCV\_SHUTDOWN)@@ -1252,9 +1254,8 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg,  cskb = skb; if (skb\_copy\_datagram\_msg(cskb, offset, msg, copied)) {- if (!(flags & MSG\_PEEK))- skb\_queue\_head(&sk->sk\_receive\_queue, skb);- return -EFAULT;+ err = -EFAULT;+ goto err\_out; }  /\* SOCK\_SEQPACKET: set MSG\_TRUNC if recv buf size is too small \*/@@ -1271,11 +1272,8 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, err = put\_cmsg(msg, SOL\_IUCV, SCM\_IUCV\_TRGCLS, sizeof(IUCV\_SKB\_CB(skb)->class), (void \*)&IUCV\_SKB\_CB(skb)->class);- if (err) {- if (!(flags & MSG\_PEEK))- skb\_queue\_head(&sk->sk\_receive\_queue, skb);- return err;- }+ if (err)+ goto err\_out;  /\* Mark read part of skb as used \*/ if (!(flags & MSG\_PEEK)) {@@ -1331,8 +1329,18 @@ done: /\* SOCK\_SEQPACKET: return real length if MSG\_TRUNC is set \*/ if (sk->sk\_type == SOCK\_SEQPACKET && (flags & MSG\_TRUNC)) copied = rlen;+ if (flags & MSG\_PEEK)+ skb\_unref(skb);  return copied;++err\_out:+ if (!(flags & MSG\_PEEK))+ skb\_queue\_head(&sk->sk\_receive\_queue, skb);+ else+ skb\_unref(skb);++ return err; }  static inline \_\_poll\_t iucv\_accept\_poll(struct sock \*parent) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:04 +0000



=== Content from git.kernel.org_bd2fbb01_20250115_093525.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sidraya Jayagond <sidraya@linux.ibm.com> | 2024-11-19 16:22:19 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:58 +0100 |
| commit | [783c2c6e61c5a04eb8baea598753d5fa174dbe85](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85)) | |
| tree | [d0a2298a7e5ed84f7c678b27f2d021737b05f963](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85) | |
| parent | [416e60c4951c153aed64aa30ca82c249ff6bcb9a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=416e60c4951c153aed64aa30ca82c249ff6bcb9a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85&id2=416e60c4951c153aed64aa30ca82c249ff6bcb9a)) | |
| download | [linux-783c2c6e61c5a04eb8baea598753d5fa174dbe85.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-783c2c6e61c5a04eb8baea598753d5fa174dbe85.tar.gz) | |

s390/iucv: MSG\_PEEK causes memory leak in iucv\_sock\_destruct()[ Upstream commit ebaf81317e42aa990ad20b113cfe3a7b20d4e937 ]
Passing MSG\_PEEK flag to skb\_recv\_datagram() increments skb refcount
(skb->users) and iucv\_sock\_recvmsg() does not decrement skb refcount
at exit.
This results in skb memory leak in skb\_queue\_purge() and WARN\_ON in
iucv\_sock\_destruct() during socket close. To fix this decrease
skb refcount by one if MSG\_PEEK is set in order to prevent memory
leak and WARN\_ON.
WARNING: CPU: 2 PID: 6292 at net/iucv/af\_iucv.c:286 iucv\_sock\_destruct+0x144/0x1a0 [af\_iucv]
CPU: 2 PID: 6292 Comm: afiucv\_test\_msg Kdump: loaded Tainted: G W 6.10.0-rc7 #1
Hardware name: IBM 3931 A01 704 (z/VM 7.3.0)
Call Trace:
[<001587c682c4aa98>] iucv\_sock\_destruct+0x148/0x1a0 [af\_iucv]
[<001587c682c4a9d0>] iucv\_sock\_destruct+0x80/0x1a0 [af\_iucv]
[<001587c704117a32>] \_\_sk\_destruct+0x52/0x550
[<001587c704104a54>] \_\_sock\_release+0xa4/0x230
[<001587c704104c0c>] sock\_close+0x2c/0x40
[<001587c702c5f5a8>] \_\_fput+0x2e8/0x970
[<001587c7024148c4>] task\_work\_run+0x1c4/0x2c0
[<001587c7023b0716>] do\_exit+0x996/0x1050
[<001587c7023b13aa>] do\_group\_exit+0x13a/0x360
[<001587c7023b1626>] \_\_s390x\_sys\_exit\_group+0x56/0x60
[<001587c7022bccca>] do\_syscall+0x27a/0x380
[<001587c7049a6a0c>] \_\_do\_syscall+0x9c/0x160
[<001587c7049ce8a8>] system\_call+0x70/0x98
Last Breaking-Event-Address:
[<001587c682c4a9d4>] iucv\_sock\_destruct+0x84/0x1a0 [af\_iucv]
Fixes: eac3731bd04c ("[S390]: Add AF\_IUCV socket support")
Reviewed-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: Thorsten Winkler <twinkler@linux.ibm.com>
Signed-off-by: Sidraya Jayagond <sidraya@linux.ibm.com>
Signed-off-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: David Wei <dw@davidwei.uk>
Link: [https://patch.msgid.link/20241119152219.3712168-1-wintera@linux.ibm.com](https://patch.msgid.link/20241119152219.3712168-1-wintera%40linux.ibm.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85)

| -rw-r--r-- | [net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/iucv/af_iucv.c?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 9 deletions

| diff --git a/net/iucv/af\_iucv.c b/net/iucv/af\_iucv.cindex c00323fa9eb66e..7929df08d4e023 100644--- a/[net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/iucv/af_iucv.c?id=416e60c4951c153aed64aa30ca82c249ff6bcb9a)+++ b/[net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/iucv/af_iucv.c?id=783c2c6e61c5a04eb8baea598753d5fa174dbe85)@@ -1236,7 +1236,9 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, return -EOPNOTSUPP;  /\* receive/dequeue next skb:- \* the function understands MSG\_PEEK and, thus, does not dequeue skb \*/+ \* the function understands MSG\_PEEK and, thus, does not dequeue skb+ \* only refcount is increased.+ \*/ skb = skb\_recv\_datagram(sk, flags, &err); if (!skb) { if (sk->sk\_shutdown & RCV\_SHUTDOWN)@@ -1252,9 +1254,8 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg,  cskb = skb; if (skb\_copy\_datagram\_msg(cskb, offset, msg, copied)) {- if (!(flags & MSG\_PEEK))- skb\_queue\_head(&sk->sk\_receive\_queue, skb);- return -EFAULT;+ err = -EFAULT;+ goto err\_out; }  /\* SOCK\_SEQPACKET: set MSG\_TRUNC if recv buf size is too small \*/@@ -1271,11 +1272,8 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, err = put\_cmsg(msg, SOL\_IUCV, SCM\_IUCV\_TRGCLS, sizeof(IUCV\_SKB\_CB(skb)->class), (void \*)&IUCV\_SKB\_CB(skb)->class);- if (err) {- if (!(flags & MSG\_PEEK))- skb\_queue\_head(&sk->sk\_receive\_queue, skb);- return err;- }+ if (err)+ goto err\_out;  /\* Mark read part of skb as used \*/ if (!(flags & MSG\_PEEK)) {@@ -1331,8 +1329,18 @@ done: /\* SOCK\_SEQPACKET: return real length if MSG\_TRUNC is set \*/ if (sk->sk\_type == SOCK\_SEQPACKET && (flags & MSG\_TRUNC)) copied = rlen;+ if (flags & MSG\_PEEK)+ skb\_unref(skb);  return copied;++err\_out:+ if (!(flags & MSG\_PEEK))+ skb\_queue\_head(&sk->sk\_receive\_queue, skb);+ else+ skb\_unref(skb);++ return err; }  static inline \_\_poll\_t iucv\_accept\_poll(struct sock \*parent) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:02 +0000



=== Content from git.kernel.org_e9bc82fb_20250115_093526.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f603e66e1c59c1d25e60eb0636cb307d190782e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f603e66e1c59c1d25e60eb0636cb307d190782e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f603e66e1c59c1d25e60eb0636cb307d190782e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f603e66e1c59c1d25e60eb0636cb307d190782e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sidraya Jayagond <sidraya@linux.ibm.com> | 2024-11-19 16:22:19 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:31 +0100 |
| commit | [9f603e66e1c59c1d25e60eb0636cb307d190782e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f603e66e1c59c1d25e60eb0636cb307d190782e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f603e66e1c59c1d25e60eb0636cb307d190782e)) | |
| tree | [56aa5b22622a9dc469bfba68b92791d2d6bdc059](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f603e66e1c59c1d25e60eb0636cb307d190782e) | |
| parent | [a487cc8986d6dd75b60b59004f3bd2ea9b4dd541](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a487cc8986d6dd75b60b59004f3bd2ea9b4dd541) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f603e66e1c59c1d25e60eb0636cb307d190782e&id2=a487cc8986d6dd75b60b59004f3bd2ea9b4dd541)) | |
| download | [linux-9f603e66e1c59c1d25e60eb0636cb307d190782e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f603e66e1c59c1d25e60eb0636cb307d190782e.tar.gz) | |

s390/iucv: MSG\_PEEK causes memory leak in iucv\_sock\_destruct()[ Upstream commit ebaf81317e42aa990ad20b113cfe3a7b20d4e937 ]
Passing MSG\_PEEK flag to skb\_recv\_datagram() increments skb refcount
(skb->users) and iucv\_sock\_recvmsg() does not decrement skb refcount
at exit.
This results in skb memory leak in skb\_queue\_purge() and WARN\_ON in
iucv\_sock\_destruct() during socket close. To fix this decrease
skb refcount by one if MSG\_PEEK is set in order to prevent memory
leak and WARN\_ON.
WARNING: CPU: 2 PID: 6292 at net/iucv/af\_iucv.c:286 iucv\_sock\_destruct+0x144/0x1a0 [af\_iucv]
CPU: 2 PID: 6292 Comm: afiucv\_test\_msg Kdump: loaded Tainted: G W 6.10.0-rc7 #1
Hardware name: IBM 3931 A01 704 (z/VM 7.3.0)
Call Trace:
[<001587c682c4aa98>] iucv\_sock\_destruct+0x148/0x1a0 [af\_iucv]
[<001587c682c4a9d0>] iucv\_sock\_destruct+0x80/0x1a0 [af\_iucv]
[<001587c704117a32>] \_\_sk\_destruct+0x52/0x550
[<001587c704104a54>] \_\_sock\_release+0xa4/0x230
[<001587c704104c0c>] sock\_close+0x2c/0x40
[<001587c702c5f5a8>] \_\_fput+0x2e8/0x970
[<001587c7024148c4>] task\_work\_run+0x1c4/0x2c0
[<001587c7023b0716>] do\_exit+0x996/0x1050
[<001587c7023b13aa>] do\_group\_exit+0x13a/0x360
[<001587c7023b1626>] \_\_s390x\_sys\_exit\_group+0x56/0x60
[<001587c7022bccca>] do\_syscall+0x27a/0x380
[<001587c7049a6a0c>] \_\_do\_syscall+0x9c/0x160
[<001587c7049ce8a8>] system\_call+0x70/0x98
Last Breaking-Event-Address:
[<001587c682c4a9d4>] iucv\_sock\_destruct+0x84/0x1a0 [af\_iucv]
Fixes: eac3731bd04c ("[S390]: Add AF\_IUCV socket support")
Reviewed-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: Thorsten Winkler <twinkler@linux.ibm.com>
Signed-off-by: Sidraya Jayagond <sidraya@linux.ibm.com>
Signed-off-by: Alexandra Winter <wintera@linux.ibm.com>
Reviewed-by: David Wei <dw@davidwei.uk>
Link: [https://patch.msgid.link/20241119152219.3712168-1-wintera@linux.ibm.com](https://patch.msgid.link/20241119152219.3712168-1-wintera%40linux.ibm.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f603e66e1c59c1d25e60eb0636cb307d190782e)

| -rw-r--r-- | [net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/iucv/af_iucv.c?id=9f603e66e1c59c1d25e60eb0636cb307d190782e) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 9 deletions

| diff --git a/net/iucv/af\_iucv.c b/net/iucv/af\_iucv.cindex c00323fa9eb66e..7929df08d4e023 100644--- a/[net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/iucv/af_iucv.c?id=a487cc8986d6dd75b60b59004f3bd2ea9b4dd541)+++ b/[net/iucv/af\_iucv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/iucv/af_iucv.c?id=9f603e66e1c59c1d25e60eb0636cb307d190782e)@@ -1236,7 +1236,9 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, return -EOPNOTSUPP;  /\* receive/dequeue next skb:- \* the function understands MSG\_PEEK and, thus, does not dequeue skb \*/+ \* the function understands MSG\_PEEK and, thus, does not dequeue skb+ \* only refcount is increased.+ \*/ skb = skb\_recv\_datagram(sk, flags, &err); if (!skb) { if (sk->sk\_shutdown & RCV\_SHUTDOWN)@@ -1252,9 +1254,8 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg,  cskb = skb; if (skb\_copy\_datagram\_msg(cskb, offset, msg, copied)) {- if (!(flags & MSG\_PEEK))- skb\_queue\_head(&sk->sk\_receive\_queue, skb);- return -EFAULT;+ err = -EFAULT;+ goto err\_out; }  /\* SOCK\_SEQPACKET: set MSG\_TRUNC if recv buf size is too small \*/@@ -1271,11 +1272,8 @@ static int iucv\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, err = put\_cmsg(msg, SOL\_IUCV, SCM\_IUCV\_TRGCLS, sizeof(IUCV\_SKB\_CB(skb)->class), (void \*)&IUCV\_SKB\_CB(skb)->class);- if (err) {- if (!(flags & MSG\_PEEK))- skb\_queue\_head(&sk->sk\_receive\_queue, skb);- return err;- }+ if (err)+ goto err\_out;  /\* Mark read part of skb as used \*/ if (!(flags & MSG\_PEEK)) {@@ -1331,8 +1329,18 @@ done: /\* SOCK\_SEQPACKET: return real length if MSG\_TRUNC is set \*/ if (sk->sk\_type == SOCK\_SEQPACKET && (flags & MSG\_TRUNC)) copied = rlen;+ if (flags & MSG\_PEEK)+ skb\_unref(skb);  return copied;++err\_out:+ if (!(flags & MSG\_PEEK))+ skb\_queue\_head(&sk->sk\_receive\_queue, skb);+ else+ skb\_unref(skb);++ return err; }  static inline \_\_poll\_t iucv\_accept\_poll(struct sock \*parent) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:03 +0000


