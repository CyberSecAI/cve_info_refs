=== Content from git.kernel.org_2668faf3_20250114_201207.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d28b059ee4779b5102c5da6e929762520510e406)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d28b059ee4779b5102c5da6e929762520510e406)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d28b059ee4779b5102c5da6e929762520510e406)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d28b059ee4779b5102c5da6e929762520510e406)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2024-11-01 11:50:30 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:38:34 +0100 |
| commit | [d28b059ee4779b5102c5da6e929762520510e406](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d28b059ee4779b5102c5da6e929762520510e406) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d28b059ee4779b5102c5da6e929762520510e406)) | |
| tree | [bc5bbb69adb95d7b6749ffbf4b3bef6a3e415f66](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d28b059ee4779b5102c5da6e929762520510e406) | |
| parent | [4b7522b0040f173ebf21559f959eb30d4dddc28d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b7522b0040f173ebf21559f959eb30d4dddc28d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d28b059ee4779b5102c5da6e929762520510e406&id2=4b7522b0040f173ebf21559f959eb30d4dddc28d)) | |
| download | [linux-d28b059ee4779b5102c5da6e929762520510e406.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d28b059ee4779b5102c5da6e929762520510e406.tar.gz) | |

KVM: VMX: Bury Intel PT virtualization (guest/host mode) behind CONFIG\_BROKENcommit aa0d42cacf093a6fcca872edc954f6f812926a17 upstream.
Hide KVM's pt\_mode module param behind CONFIG\_BROKEN, i.e. disable support
for virtualizing Intel PT via guest/host mode unless BROKEN=y. There are
myriad bugs in the implementation, some of which are fatal to the guest,
and others which put the stability and health of the host at risk.
For guest fatalities, the most glaring issue is that KVM fails to ensure
tracing is disabled, and \*stays\* disabled prior to VM-Enter, which is
necessary as hardware disallows loading (the guest's) RTIT\_CTL if tracing
is enabled (enforced via a VMX consistency check). Per the SDM:
If the logical processor is operating with Intel PT enabled (if
IA32\_RTIT\_CTL.TraceEn = 1) at the time of VM entry, the "load
IA32\_RTIT\_CTL" VM-entry control must be 0.
On the host side, KVM doesn't validate the guest CPUID configuration
provided by userspace, and even worse, uses the guest configuration to
decide what MSRs to save/load at VM-Enter and VM-Exit. E.g. configuring
guest CPUID to enumerate more address ranges than are supported in hardware
will result in KVM trying to passthrough, save, and load non-existent MSRs,
which generates a variety of WARNs, ToPA ERRORs in the host, a potential
deadlock, etc.
Fixes: f99e3daf94ff ("KVM: x86: Add Intel PT virtualization work mode")
Cc: stable@vger.kernel.org
Cc: Adrian Hunter <adrian.hunter@intel.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Reviewed-by: Xiaoyao Li <xiaoyao.li@intel.com>
Tested-by: Adrian Hunter <adrian.hunter@intel.com>
Message-ID: <20241101185031.1799556-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d28b059ee4779b5102c5da6e929762520510e406)

| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=d28b059ee4779b5102c5da6e929762520510e406) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex 3cebf48f4ba581..479ef26626f2fe 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=4b7522b0040f173ebf21559f959eb30d4dddc28d)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=d28b059ee4779b5102c5da6e929762520510e406)@@ -212,9 +212,11 @@ module\_param(ple\_window\_shrink, uint, 0444); static unsigned int ple\_window\_max = KVM\_VMX\_DEFAULT\_PLE\_WINDOW\_MAX; module\_param(ple\_window\_max, uint, 0444); -/\* Default is SYSTEM mode, 1 for host-guest mode \*/+/\* Default is SYSTEM mode, 1 for host-guest mode (which is BROKEN) \*/ int \_\_read\_mostly pt\_mode = PT\_MODE\_SYSTEM;+#ifdef CONFIG\_BROKEN module\_param(pt\_mode, int, S\_IRUGO);+#endif  static DEFINE\_STATIC\_KEY\_FALSE(vmx\_l1d\_should\_flush); static DEFINE\_STATIC\_KEY\_FALSE(vmx\_l1d\_flush\_cond); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:10:44 +0000



=== Content from git.kernel.org_9acf48cb_20250114_201204.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2024-11-01 11:50:30 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:39:52 +0100 |
| commit | [b91bb0ce5cd7005b376eac690ec664c1b56372ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec)) | |
| tree | [74ab71bf8fa398eaa1434a5094e9c9247e6e3410](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec) | |
| parent | [cc99a5c6a97dbbd30f48ac2f35c95f7a7a590353](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc99a5c6a97dbbd30f48ac2f35c95f7a7a590353) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec&id2=cc99a5c6a97dbbd30f48ac2f35c95f7a7a590353)) | |
| download | [linux-b91bb0ce5cd7005b376eac690ec664c1b56372ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b91bb0ce5cd7005b376eac690ec664c1b56372ec.tar.gz) | |

KVM: VMX: Bury Intel PT virtualization (guest/host mode) behind CONFIG\_BROKENcommit aa0d42cacf093a6fcca872edc954f6f812926a17 upstream.
Hide KVM's pt\_mode module param behind CONFIG\_BROKEN, i.e. disable support
for virtualizing Intel PT via guest/host mode unless BROKEN=y. There are
myriad bugs in the implementation, some of which are fatal to the guest,
and others which put the stability and health of the host at risk.
For guest fatalities, the most glaring issue is that KVM fails to ensure
tracing is disabled, and \*stays\* disabled prior to VM-Enter, which is
necessary as hardware disallows loading (the guest's) RTIT\_CTL if tracing
is enabled (enforced via a VMX consistency check). Per the SDM:
If the logical processor is operating with Intel PT enabled (if
IA32\_RTIT\_CTL.TraceEn = 1) at the time of VM entry, the "load
IA32\_RTIT\_CTL" VM-entry control must be 0.
On the host side, KVM doesn't validate the guest CPUID configuration
provided by userspace, and even worse, uses the guest configuration to
decide what MSRs to save/load at VM-Enter and VM-Exit. E.g. configuring
guest CPUID to enumerate more address ranges than are supported in hardware
will result in KVM trying to passthrough, save, and load non-existent MSRs,
which generates a variety of WARNs, ToPA ERRORs in the host, a potential
deadlock, etc.
Fixes: f99e3daf94ff ("KVM: x86: Add Intel PT virtualization work mode")
Cc: stable@vger.kernel.org
Cc: Adrian Hunter <adrian.hunter@intel.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Reviewed-by: Xiaoyao Li <xiaoyao.li@intel.com>
Tested-by: Adrian Hunter <adrian.hunter@intel.com>
Message-ID: <20241101185031.1799556-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec)

| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex 9938094408a547..5455106b6d9c59 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=cc99a5c6a97dbbd30f48ac2f35c95f7a7a590353)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=b91bb0ce5cd7005b376eac690ec664c1b56372ec)@@ -217,9 +217,11 @@ module\_param(ple\_window\_shrink, uint, 0444); static unsigned int ple\_window\_max = KVM\_VMX\_DEFAULT\_PLE\_WINDOW\_MAX; module\_param(ple\_window\_max, uint, 0444); -/\* Default is SYSTEM mode, 1 for host-guest mode \*/+/\* Default is SYSTEM mode, 1 for host-guest mode (which is BROKEN) \*/ int \_\_read\_mostly pt\_mode = PT\_MODE\_SYSTEM;+#ifdef CONFIG\_BROKEN module\_param(pt\_mode, int, S\_IRUGO);+#endif  struct x86\_pmu\_lbr \_\_ro\_after\_init vmx\_lbr\_caps; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:10:41 +0000



=== Content from git.kernel.org_3a4b59d7_20250114_201208.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2024-11-01 11:50:30 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:38 +0100 |
| commit | [d4b42f926adcce4e5ec193c714afd9d37bba8e5b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b)) | |
| tree | [eec7c88120761f72605c752bc1fa1a38ed30a7de](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b) | |
| parent | [c96f90911dd1514d08a698127f91067dd9cdbc83](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c96f90911dd1514d08a698127f91067dd9cdbc83) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b&id2=c96f90911dd1514d08a698127f91067dd9cdbc83)) | |
| download | [linux-d4b42f926adcce4e5ec193c714afd9d37bba8e5b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d4b42f926adcce4e5ec193c714afd9d37bba8e5b.tar.gz) | |

KVM: VMX: Bury Intel PT virtualization (guest/host mode) behind CONFIG\_BROKENcommit aa0d42cacf093a6fcca872edc954f6f812926a17 upstream.
Hide KVM's pt\_mode module param behind CONFIG\_BROKEN, i.e. disable support
for virtualizing Intel PT via guest/host mode unless BROKEN=y. There are
myriad bugs in the implementation, some of which are fatal to the guest,
and others which put the stability and health of the host at risk.
For guest fatalities, the most glaring issue is that KVM fails to ensure
tracing is disabled, and \*stays\* disabled prior to VM-Enter, which is
necessary as hardware disallows loading (the guest's) RTIT\_CTL if tracing
is enabled (enforced via a VMX consistency check). Per the SDM:
If the logical processor is operating with Intel PT enabled (if
IA32\_RTIT\_CTL.TraceEn = 1) at the time of VM entry, the "load
IA32\_RTIT\_CTL" VM-entry control must be 0.
On the host side, KVM doesn't validate the guest CPUID configuration
provided by userspace, and even worse, uses the guest configuration to
decide what MSRs to save/load at VM-Enter and VM-Exit. E.g. configuring
guest CPUID to enumerate more address ranges than are supported in hardware
will result in KVM trying to passthrough, save, and load non-existent MSRs,
which generates a variety of WARNs, ToPA ERRORs in the host, a potential
deadlock, etc.
Fixes: f99e3daf94ff ("KVM: x86: Add Intel PT virtualization work mode")
Cc: stable@vger.kernel.org
Cc: Adrian Hunter <adrian.hunter@intel.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Reviewed-by: Xiaoyao Li <xiaoyao.li@intel.com>
Tested-by: Adrian Hunter <adrian.hunter@intel.com>
Message-ID: <20241101185031.1799556-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b)

| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex b29be51b72b445..1908f2aae9fa24 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=c96f90911dd1514d08a698127f91067dd9cdbc83)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=d4b42f926adcce4e5ec193c714afd9d37bba8e5b)@@ -199,9 +199,11 @@ module\_param(ple\_window\_shrink, uint, 0444); static unsigned int ple\_window\_max = KVM\_VMX\_DEFAULT\_PLE\_WINDOW\_MAX; module\_param(ple\_window\_max, uint, 0444); -/\* Default is SYSTEM mode, 1 for host-guest mode \*/+/\* Default is SYSTEM mode, 1 for host-guest mode (which is BROKEN) \*/ int \_\_read\_mostly pt\_mode = PT\_MODE\_SYSTEM;+#ifdef CONFIG\_BROKEN module\_param(pt\_mode, int, S\_IRUGO);+#endif  static DEFINE\_STATIC\_KEY\_FALSE(vmx\_l1d\_should\_flush); static DEFINE\_STATIC\_KEY\_FALSE(vmx\_l1d\_flush\_cond); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:10:45 +0000



=== Content from git.kernel.org_c8e74378_20250114_201202.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aa0d42cacf093a6fcca872edc954f6f812926a17)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa0d42cacf093a6fcca872edc954f6f812926a17)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa0d42cacf093a6fcca872edc954f6f812926a17)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa0d42cacf093a6fcca872edc954f6f812926a17)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2024-11-01 11:50:30 -0700 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2024-11-08 05:57:13 -0500 |
| commit | [aa0d42cacf093a6fcca872edc954f6f812926a17](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa0d42cacf093a6fcca872edc954f6f812926a17) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aa0d42cacf093a6fcca872edc954f6f812926a17)) | |
| tree | [46053ea8de66fce8d8c032cd0e7edc7ef9d34d4b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa0d42cacf093a6fcca872edc954f6f812926a17) | |
| parent | [d3ddef46f22e8c3124e0df1f325bc6a18dadff39](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3ddef46f22e8c3124e0df1f325bc6a18dadff39) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa0d42cacf093a6fcca872edc954f6f812926a17&id2=d3ddef46f22e8c3124e0df1f325bc6a18dadff39)) | |
| download | [linux-aa0d42cacf093a6fcca872edc954f6f812926a17.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aa0d42cacf093a6fcca872edc954f6f812926a17.tar.gz) | |

KVM: VMX: Bury Intel PT virtualization (guest/host mode) behind CONFIG\_BROKENHide KVM's pt\_mode module param behind CONFIG\_BROKEN, i.e. disable support
for virtualizing Intel PT via guest/host mode unless BROKEN=y. There are
myriad bugs in the implementation, some of which are fatal to the guest,
and others which put the stability and health of the host at risk.
For guest fatalities, the most glaring issue is that KVM fails to ensure
tracing is disabled, and \*stays\* disabled prior to VM-Enter, which is
necessary as hardware disallows loading (the guest's) RTIT\_CTL if tracing
is enabled (enforced via a VMX consistency check). Per the SDM:
If the logical processor is operating with Intel PT enabled (if
IA32\_RTIT\_CTL.TraceEn = 1) at the time of VM entry, the "load
IA32\_RTIT\_CTL" VM-entry control must be 0.
On the host side, KVM doesn't validate the guest CPUID configuration
provided by userspace, and even worse, uses the guest configuration to
decide what MSRs to save/load at VM-Enter and VM-Exit. E.g. configuring
guest CPUID to enumerate more address ranges than are supported in hardware
will result in KVM trying to passthrough, save, and load non-existent MSRs,
which generates a variety of WARNs, ToPA ERRORs in the host, a potential
deadlock, etc.
Fixes: f99e3daf94ff ("KVM: x86: Add Intel PT virtualization work mode")
Cc: stable@vger.kernel.org
Cc: Adrian Hunter <adrian.hunter@intel.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Reviewed-by: Xiaoyao Li <xiaoyao.li@intel.com>
Tested-by: Adrian Hunter <adrian.hunter@intel.com>
Message-ID: <20241101185031.1799556-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa0d42cacf093a6fcca872edc954f6f812926a17)

| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=aa0d42cacf093a6fcca872edc954f6f812926a17) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex 9886d67d9512c2..d28618e9277ede 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=d3ddef46f22e8c3124e0df1f325bc6a18dadff39)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=aa0d42cacf093a6fcca872edc954f6f812926a17)@@ -217,9 +217,11 @@ module\_param(ple\_window\_shrink, uint, 0444); static unsigned int ple\_window\_max = KVM\_VMX\_DEFAULT\_PLE\_WINDOW\_MAX; module\_param(ple\_window\_max, uint, 0444); -/\* Default is SYSTEM mode, 1 for host-guest mode \*/+/\* Default is SYSTEM mode, 1 for host-guest mode (which is BROKEN) \*/ int \_\_read\_mostly pt\_mode = PT\_MODE\_SYSTEM;+#ifdef CONFIG\_BROKEN module\_param(pt\_mode, int, S\_IRUGO);+#endif  struct x86\_pmu\_lbr \_\_ro\_after\_init vmx\_lbr\_caps; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:10:39 +0000



=== Content from git.kernel.org_2ede0654_20250114_201206.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c3742319d021f5aa3a0a8c828485fee14753f6de)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3742319d021f5aa3a0a8c828485fee14753f6de)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3742319d021f5aa3a0a8c828485fee14753f6de)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3742319d021f5aa3a0a8c828485fee14753f6de)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2024-11-01 11:50:30 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:18 +0100 |
| commit | [c3742319d021f5aa3a0a8c828485fee14753f6de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3742319d021f5aa3a0a8c828485fee14753f6de) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c3742319d021f5aa3a0a8c828485fee14753f6de)) | |
| tree | [8397b450bb1146f163d942d2b40f9b7f9fafb9fe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3742319d021f5aa3a0a8c828485fee14753f6de) | |
| parent | [5ae8cc0b0c027e9cab22596049bc4dd1cbc37ee4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ae8cc0b0c027e9cab22596049bc4dd1cbc37ee4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3742319d021f5aa3a0a8c828485fee14753f6de&id2=5ae8cc0b0c027e9cab22596049bc4dd1cbc37ee4)) | |
| download | [linux-c3742319d021f5aa3a0a8c828485fee14753f6de.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c3742319d021f5aa3a0a8c828485fee14753f6de.tar.gz) | |

KVM: VMX: Bury Intel PT virtualization (guest/host mode) behind CONFIG\_BROKENcommit aa0d42cacf093a6fcca872edc954f6f812926a17 upstream.
Hide KVM's pt\_mode module param behind CONFIG\_BROKEN, i.e. disable support
for virtualizing Intel PT via guest/host mode unless BROKEN=y. There are
myriad bugs in the implementation, some of which are fatal to the guest,
and others which put the stability and health of the host at risk.
For guest fatalities, the most glaring issue is that KVM fails to ensure
tracing is disabled, and \*stays\* disabled prior to VM-Enter, which is
necessary as hardware disallows loading (the guest's) RTIT\_CTL if tracing
is enabled (enforced via a VMX consistency check). Per the SDM:
If the logical processor is operating with Intel PT enabled (if
IA32\_RTIT\_CTL.TraceEn = 1) at the time of VM entry, the "load
IA32\_RTIT\_CTL" VM-entry control must be 0.
On the host side, KVM doesn't validate the guest CPUID configuration
provided by userspace, and even worse, uses the guest configuration to
decide what MSRs to save/load at VM-Enter and VM-Exit. E.g. configuring
guest CPUID to enumerate more address ranges than are supported in hardware
will result in KVM trying to passthrough, save, and load non-existent MSRs,
which generates a variety of WARNs, ToPA ERRORs in the host, a potential
deadlock, etc.
Fixes: f99e3daf94ff ("KVM: x86: Add Intel PT virtualization work mode")
Cc: stable@vger.kernel.org
Cc: Adrian Hunter <adrian.hunter@intel.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Reviewed-by: Xiaoyao Li <xiaoyao.li@intel.com>
Tested-by: Adrian Hunter <adrian.hunter@intel.com>
Message-ID: <20241101185031.1799556-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3742319d021f5aa3a0a8c828485fee14753f6de)

| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=c3742319d021f5aa3a0a8c828485fee14753f6de) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex c9307082979094..4d61e2239c5404 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=5ae8cc0b0c027e9cab22596049bc4dd1cbc37ee4)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=c3742319d021f5aa3a0a8c828485fee14753f6de)@@ -179,9 +179,11 @@ module\_param(ple\_window\_shrink, uint, 0444); static unsigned int ple\_window\_max = KVM\_VMX\_DEFAULT\_PLE\_WINDOW\_MAX; module\_param(ple\_window\_max, uint, 0444); -/\* Default is SYSTEM mode, 1 for host-guest mode \*/+/\* Default is SYSTEM mode, 1 for host-guest mode (which is BROKEN) \*/ int \_\_read\_mostly pt\_mode = PT\_MODE\_SYSTEM;+#ifdef CONFIG\_BROKEN module\_param(pt\_mode, int, S\_IRUGO);+#endif  static DEFINE\_STATIC\_KEY\_FALSE(vmx\_l1d\_should\_flush); static DEFINE\_STATIC\_KEY\_FALSE(vmx\_l1d\_flush\_cond); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:10:43 +0000



=== Content from git.kernel.org_ff24fe96_20250114_201209.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e6716f4230a8784957273ddd27326264b27b9313)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e6716f4230a8784957273ddd27326264b27b9313)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6716f4230a8784957273ddd27326264b27b9313)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6716f4230a8784957273ddd27326264b27b9313)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2024-11-01 11:50:30 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:37:31 +0100 |
| commit | [e6716f4230a8784957273ddd27326264b27b9313](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6716f4230a8784957273ddd27326264b27b9313) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e6716f4230a8784957273ddd27326264b27b9313)) | |
| tree | [461f3191157408a43caed17b0c88f19efe237a99](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e6716f4230a8784957273ddd27326264b27b9313) | |
| parent | [14db62eb01fa7a224c0c416253a540ba6f41f96d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14db62eb01fa7a224c0c416253a540ba6f41f96d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6716f4230a8784957273ddd27326264b27b9313&id2=14db62eb01fa7a224c0c416253a540ba6f41f96d)) | |
| download | [linux-e6716f4230a8784957273ddd27326264b27b9313.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e6716f4230a8784957273ddd27326264b27b9313.tar.gz) | |

KVM: VMX: Bury Intel PT virtualization (guest/host mode) behind CONFIG\_BROKENcommit aa0d42cacf093a6fcca872edc954f6f812926a17 upstream.
Hide KVM's pt\_mode module param behind CONFIG\_BROKEN, i.e. disable support
for virtualizing Intel PT via guest/host mode unless BROKEN=y. There are
myriad bugs in the implementation, some of which are fatal to the guest,
and others which put the stability and health of the host at risk.
For guest fatalities, the most glaring issue is that KVM fails to ensure
tracing is disabled, and \*stays\* disabled prior to VM-Enter, which is
necessary as hardware disallows loading (the guest's) RTIT\_CTL if tracing
is enabled (enforced via a VMX consistency check). Per the SDM:
If the logical processor is operating with Intel PT enabled (if
IA32\_RTIT\_CTL.TraceEn = 1) at the time of VM entry, the "load
IA32\_RTIT\_CTL" VM-entry control must be 0.
On the host side, KVM doesn't validate the guest CPUID configuration
provided by userspace, and even worse, uses the guest configuration to
decide what MSRs to save/load at VM-Enter and VM-Exit. E.g. configuring
guest CPUID to enumerate more address ranges than are supported in hardware
will result in KVM trying to passthrough, save, and load non-existent MSRs,
which generates a variety of WARNs, ToPA ERRORs in the host, a potential
deadlock, etc.
Fixes: f99e3daf94ff ("KVM: x86: Add Intel PT virtualization work mode")
Cc: stable@vger.kernel.org
Cc: Adrian Hunter <adrian.hunter@intel.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Reviewed-by: Xiaoyao Li <xiaoyao.li@intel.com>
Tested-by: Adrian Hunter <adrian.hunter@intel.com>
Message-ID: <20241101185031.1799556-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6716f4230a8784957273ddd27326264b27b9313)

| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=e6716f4230a8784957273ddd27326264b27b9313) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex 6baa4aa20fc7a6..460ba48eb66c8a 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=14db62eb01fa7a224c0c416253a540ba6f41f96d)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=e6716f4230a8784957273ddd27326264b27b9313)@@ -209,9 +209,11 @@ module\_param(ple\_window\_shrink, uint, 0444); static unsigned int ple\_window\_max = KVM\_VMX\_DEFAULT\_PLE\_WINDOW\_MAX; module\_param(ple\_window\_max, uint, 0444); -/\* Default is SYSTEM mode, 1 for host-guest mode \*/+/\* Default is SYSTEM mode, 1 for host-guest mode (which is BROKEN) \*/ int \_\_read\_mostly pt\_mode = PT\_MODE\_SYSTEM;+#ifdef CONFIG\_BROKEN module\_param(pt\_mode, int, S\_IRUGO);+#endif  static DEFINE\_STATIC\_KEY\_FALSE(vmx\_l1d\_should\_flush); static DEFINE\_STATIC\_KEY\_FALSE(vmx\_l1d\_flush\_cond); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:10:46 +0000



=== Content from git.kernel.org_0559ffbf_20250114_201203.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b8a1d572478b6f239061ee9578b2451bf2f021c2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8a1d572478b6f239061ee9578b2451bf2f021c2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8a1d572478b6f239061ee9578b2451bf2f021c2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8a1d572478b6f239061ee9578b2451bf2f021c2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2024-11-01 11:50:30 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:36 +0100 |
| commit | [b8a1d572478b6f239061ee9578b2451bf2f021c2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8a1d572478b6f239061ee9578b2451bf2f021c2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b8a1d572478b6f239061ee9578b2451bf2f021c2)) | |
| tree | [3f13410d604627ae7062b0ae8fb7ee29971af415](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8a1d572478b6f239061ee9578b2451bf2f021c2) | |
| parent | [8fbac997556bab15435b58ecc421e6b0587fb2e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8fbac997556bab15435b58ecc421e6b0587fb2e5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8a1d572478b6f239061ee9578b2451bf2f021c2&id2=8fbac997556bab15435b58ecc421e6b0587fb2e5)) | |
| download | [linux-b8a1d572478b6f239061ee9578b2451bf2f021c2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b8a1d572478b6f239061ee9578b2451bf2f021c2.tar.gz) | |

KVM: VMX: Bury Intel PT virtualization (guest/host mode) behind CONFIG\_BROKENcommit aa0d42cacf093a6fcca872edc954f6f812926a17 upstream.
Hide KVM's pt\_mode module param behind CONFIG\_BROKEN, i.e. disable support
for virtualizing Intel PT via guest/host mode unless BROKEN=y. There are
myriad bugs in the implementation, some of which are fatal to the guest,
and others which put the stability and health of the host at risk.
For guest fatalities, the most glaring issue is that KVM fails to ensure
tracing is disabled, and \*stays\* disabled prior to VM-Enter, which is
necessary as hardware disallows loading (the guest's) RTIT\_CTL if tracing
is enabled (enforced via a VMX consistency check). Per the SDM:
If the logical processor is operating with Intel PT enabled (if
IA32\_RTIT\_CTL.TraceEn = 1) at the time of VM entry, the "load
IA32\_RTIT\_CTL" VM-entry control must be 0.
On the host side, KVM doesn't validate the guest CPUID configuration
provided by userspace, and even worse, uses the guest configuration to
decide what MSRs to save/load at VM-Enter and VM-Exit. E.g. configuring
guest CPUID to enumerate more address ranges than are supported in hardware
will result in KVM trying to passthrough, save, and load non-existent MSRs,
which generates a variety of WARNs, ToPA ERRORs in the host, a potential
deadlock, etc.
Fixes: f99e3daf94ff ("KVM: x86: Add Intel PT virtualization work mode")
Cc: stable@vger.kernel.org
Cc: Adrian Hunter <adrian.hunter@intel.com>
Signed-off-by: Sean Christopherson <seanjc@google.com>
Reviewed-by: Xiaoyao Li <xiaoyao.li@intel.com>
Tested-by: Adrian Hunter <adrian.hunter@intel.com>
Message-ID: <20241101185031.1799556-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8a1d572478b6f239061ee9578b2451bf2f021c2)

| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=b8a1d572478b6f239061ee9578b2451bf2f021c2) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex c574175920cdd8..6965cf92bd3615 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=8fbac997556bab15435b58ecc421e6b0587fb2e5)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=b8a1d572478b6f239061ee9578b2451bf2f021c2)@@ -200,9 +200,11 @@ module\_param(ple\_window\_shrink, uint, 0444); static unsigned int ple\_window\_max = KVM\_VMX\_DEFAULT\_PLE\_WINDOW\_MAX; module\_param(ple\_window\_max, uint, 0444); -/\* Default is SYSTEM mode, 1 for host-guest mode \*/+/\* Default is SYSTEM mode, 1 for host-guest mode (which is BROKEN) \*/ int \_\_read\_mostly pt\_mode = PT\_MODE\_SYSTEM;+#ifdef CONFIG\_BROKEN module\_param(pt\_mode, int, S\_IRUGO);+#endif  static DEFINE\_STATIC\_KEY\_FALSE(vmx\_l1d\_should\_flush); static DEFINE\_STATIC\_KEY\_FALSE(vmx\_l1d\_flush\_cond); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:10:40 +0000


