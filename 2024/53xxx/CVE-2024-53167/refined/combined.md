=== Content from git.kernel.org_9af59805_20250114_203354.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Benjamin Coddington <bcodding@redhat.com> | 2024-11-22 10:11:11 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:03:09 +0100 |
| commit | [faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46)) | |
| tree | [6db4c493c518ff3864a4f1daa33e8ba2f0f5d6b4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46) | |
| parent | [61c0a5eac96836de5e3a5897eccdc63162a94936](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61c0a5eac96836de5e3a5897eccdc63162a94936) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46&id2=61c0a5eac96836de5e3a5897eccdc63162a94936)) | |
| download | [linux-faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46.tar.gz) | |

nfs/blocklayout: Don't attempt unregister for invalid block device[ Upstream commit 3a4ce14d9a6b868e0787e4582420b721c04ee41e ]
Since commit d869da91cccb ("nfs/blocklayout: Fix premature PR key
unregistration") an unmount of a pNFS SCSI layout-enabled NFS may
dereference a NULL block\_device in:
bl\_unregister\_scsi+0x16/0xe0 [blocklayoutdriver]
bl\_free\_device+0x70/0x80 [blocklayoutdriver]
bl\_free\_deviceid\_node+0x12/0x30 [blocklayoutdriver]
nfs4\_put\_deviceid\_node+0x60/0xc0 [nfsv4]
nfs4\_deviceid\_purge\_client+0x132/0x190 [nfsv4]
unset\_pnfs\_layoutdriver+0x59/0x60 [nfsv4]
nfs4\_destroy\_server+0x36/0x70 [nfsv4]
nfs\_free\_server+0x23/0xe0 [nfs]
deactivate\_locked\_super+0x30/0xb0
cleanup\_mnt+0xba/0x150
task\_work\_run+0x59/0x90
syscall\_exit\_to\_user\_mode+0x217/0x220
do\_syscall\_64+0x8e/0x160
This happens because even though we were able to create the
nfs4\_deviceid\_node, the lookup for the device was unable to attach the
block device to the pnfs\_block\_dev.
If we never found a block device to register, we can avoid this case with
the PNFS\_BDEV\_REGISTERED flag. Move the deref behind the test for the
flag.
Fixes: d869da91cccb ("nfs/blocklayout: Fix premature PR key unregistration")
Signed-off-by: Benjamin Coddington <bcodding@redhat.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46)

| -rw-r--r-- | [fs/nfs/blocklayout/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/blocklayout/dev.c?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 4 deletions

| diff --git a/fs/nfs/blocklayout/dev.c b/fs/nfs/blocklayout/dev.cindex 6252f44479457b..cab8809f0e0f48 100644--- a/[fs/nfs/blocklayout/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/blocklayout/dev.c?id=61c0a5eac96836de5e3a5897eccdc63162a94936)+++ b/[fs/nfs/blocklayout/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/blocklayout/dev.c?id=faa4bacfaeed827a4ca8cb8529a3ce65a9e8ef46)@@ -20,9 +20,6 @@ static void bl\_unregister\_scsi(struct pnfs\_block\_dev \*dev) const struct pr\_ops \*ops = bdev->bd\_disk->fops->pr\_ops; int status; - if (!test\_and\_clear\_bit(PNFS\_BDEV\_REGISTERED, &dev->flags))- return;- status = ops->pr\_register(bdev, dev->pr\_key, 0, false); if (status) trace\_bl\_pr\_key\_unreg\_err(bdev, dev->pr\_key, status);@@ -58,7 +55,8 @@ static void bl\_unregister\_dev(struct pnfs\_block\_dev \*dev) return; } - if (dev->type == PNFS\_BLOCK\_VOLUME\_SCSI)+ if (dev->type == PNFS\_BLOCK\_VOLUME\_SCSI &&+ test\_and\_clear\_bit(PNFS\_BDEV\_REGISTERED, &dev->flags)) bl\_unregister\_scsi(dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:32:32 +0000



=== Content from git.kernel.org_7d6af012_20250114_203353.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3402704a424f34bbcca7f4a4503859357f422217)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3402704a424f34bbcca7f4a4503859357f422217)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3402704a424f34bbcca7f4a4503859357f422217)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3402704a424f34bbcca7f4a4503859357f422217)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Benjamin Coddington <bcodding@redhat.com> | 2024-11-22 10:11:11 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:33 +0100 |
| commit | [3402704a424f34bbcca7f4a4503859357f422217](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3402704a424f34bbcca7f4a4503859357f422217) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3402704a424f34bbcca7f4a4503859357f422217)) | |
| tree | [04af54a7094b55351e2ae9a4e0b395d9e5a85760](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3402704a424f34bbcca7f4a4503859357f422217) | |
| parent | [694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3402704a424f34bbcca7f4a4503859357f422217&id2=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3)) | |
| download | [linux-3402704a424f34bbcca7f4a4503859357f422217.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3402704a424f34bbcca7f4a4503859357f422217.tar.gz) | |

nfs/blocklayout: Don't attempt unregister for invalid block device[ Upstream commit 3a4ce14d9a6b868e0787e4582420b721c04ee41e ]
Since commit d869da91cccb ("nfs/blocklayout: Fix premature PR key
unregistration") an unmount of a pNFS SCSI layout-enabled NFS may
dereference a NULL block\_device in:
bl\_unregister\_scsi+0x16/0xe0 [blocklayoutdriver]
bl\_free\_device+0x70/0x80 [blocklayoutdriver]
bl\_free\_deviceid\_node+0x12/0x30 [blocklayoutdriver]
nfs4\_put\_deviceid\_node+0x60/0xc0 [nfsv4]
nfs4\_deviceid\_purge\_client+0x132/0x190 [nfsv4]
unset\_pnfs\_layoutdriver+0x59/0x60 [nfsv4]
nfs4\_destroy\_server+0x36/0x70 [nfsv4]
nfs\_free\_server+0x23/0xe0 [nfs]
deactivate\_locked\_super+0x30/0xb0
cleanup\_mnt+0xba/0x150
task\_work\_run+0x59/0x90
syscall\_exit\_to\_user\_mode+0x217/0x220
do\_syscall\_64+0x8e/0x160
This happens because even though we were able to create the
nfs4\_deviceid\_node, the lookup for the device was unable to attach the
block device to the pnfs\_block\_dev.
If we never found a block device to register, we can avoid this case with
the PNFS\_BDEV\_REGISTERED flag. Move the deref behind the test for the
flag.
Fixes: d869da91cccb ("nfs/blocklayout: Fix premature PR key unregistration")
Signed-off-by: Benjamin Coddington <bcodding@redhat.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3402704a424f34bbcca7f4a4503859357f422217)

| -rw-r--r-- | [fs/nfs/blocklayout/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/blocklayout/dev.c?id=3402704a424f34bbcca7f4a4503859357f422217) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 4 deletions

| diff --git a/fs/nfs/blocklayout/dev.c b/fs/nfs/blocklayout/dev.cindex 6252f44479457b..cab8809f0e0f48 100644--- a/[fs/nfs/blocklayout/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/blocklayout/dev.c?id=694ccb05b79ee5f5a9f14c2f80d2635d3bb8bdc3)+++ b/[fs/nfs/blocklayout/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/blocklayout/dev.c?id=3402704a424f34bbcca7f4a4503859357f422217)@@ -20,9 +20,6 @@ static void bl\_unregister\_scsi(struct pnfs\_block\_dev \*dev) const struct pr\_ops \*ops = bdev->bd\_disk->fops->pr\_ops; int status; - if (!test\_and\_clear\_bit(PNFS\_BDEV\_REGISTERED, &dev->flags))- return;- status = ops->pr\_register(bdev, dev->pr\_key, 0, false); if (status) trace\_bl\_pr\_key\_unreg\_err(bdev, dev->pr\_key, status);@@ -58,7 +55,8 @@ static void bl\_unregister\_dev(struct pnfs\_block\_dev \*dev) return; } - if (dev->type == PNFS\_BLOCK\_VOLUME\_SCSI)+ if (dev->type == PNFS\_BLOCK\_VOLUME\_SCSI &&+ test\_and\_clear\_bit(PNFS\_BDEV\_REGISTERED, &dev->flags)) bl\_unregister\_scsi(dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:32:30 +0000



=== Content from git.kernel.org_ed74f591_20250114_203354.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Benjamin Coddington <bcodding@redhat.com> | 2024-11-22 10:11:11 -0500 |
| --- | --- | --- |
| committer | Trond Myklebust <trond.myklebust@hammerspace.com> | 2024-11-28 12:55:32 -0500 |
| commit | [3a4ce14d9a6b868e0787e4582420b721c04ee41e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e)) | |
| tree | [4f5804162623b019fa28da40aff337a433b18b24](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e) | |
| parent | [3f23f96528e8fcf8619895c4c916c52653892ec1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f23f96528e8fcf8619895c4c916c52653892ec1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e&id2=3f23f96528e8fcf8619895c4c916c52653892ec1)) | |
| download | [linux-3a4ce14d9a6b868e0787e4582420b721c04ee41e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3a4ce14d9a6b868e0787e4582420b721c04ee41e.tar.gz) | |

nfs/blocklayout: Don't attempt unregister for invalid block deviceSince commit d869da91cccb ("nfs/blocklayout: Fix premature PR key
unregistration") an unmount of a pNFS SCSI layout-enabled NFS may
dereference a NULL block\_device in:
bl\_unregister\_scsi+0x16/0xe0 [blocklayoutdriver]
bl\_free\_device+0x70/0x80 [blocklayoutdriver]
bl\_free\_deviceid\_node+0x12/0x30 [blocklayoutdriver]
nfs4\_put\_deviceid\_node+0x60/0xc0 [nfsv4]
nfs4\_deviceid\_purge\_client+0x132/0x190 [nfsv4]
unset\_pnfs\_layoutdriver+0x59/0x60 [nfsv4]
nfs4\_destroy\_server+0x36/0x70 [nfsv4]
nfs\_free\_server+0x23/0xe0 [nfs]
deactivate\_locked\_super+0x30/0xb0
cleanup\_mnt+0xba/0x150
task\_work\_run+0x59/0x90
syscall\_exit\_to\_user\_mode+0x217/0x220
do\_syscall\_64+0x8e/0x160
This happens because even though we were able to create the
nfs4\_deviceid\_node, the lookup for the device was unable to attach the
block device to the pnfs\_block\_dev.
If we never found a block device to register, we can avoid this case with
the PNFS\_BDEV\_REGISTERED flag. Move the deref behind the test for the
flag.
Fixes: d869da91cccb ("nfs/blocklayout: Fix premature PR key unregistration")
Signed-off-by: Benjamin Coddington <bcodding@redhat.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e)

| -rw-r--r-- | [fs/nfs/blocklayout/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/blocklayout/dev.c?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 4 deletions

| diff --git a/fs/nfs/blocklayout/dev.c b/fs/nfs/blocklayout/dev.cindex 6252f44479457b..cab8809f0e0f48 100644--- a/[fs/nfs/blocklayout/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/blocklayout/dev.c?id=3f23f96528e8fcf8619895c4c916c52653892ec1)+++ b/[fs/nfs/blocklayout/dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/blocklayout/dev.c?id=3a4ce14d9a6b868e0787e4582420b721c04ee41e)@@ -20,9 +20,6 @@ static void bl\_unregister\_scsi(struct pnfs\_block\_dev \*dev) const struct pr\_ops \*ops = bdev->bd\_disk->fops->pr\_ops; int status; - if (!test\_and\_clear\_bit(PNFS\_BDEV\_REGISTERED, &dev->flags))- return;- status = ops->pr\_register(bdev, dev->pr\_key, 0, false); if (status) trace\_bl\_pr\_key\_unreg\_err(bdev, dev->pr\_key, status);@@ -58,7 +55,8 @@ static void bl\_unregister\_dev(struct pnfs\_block\_dev \*dev) return; } - if (dev->type == PNFS\_BLOCK\_VOLUME\_SCSI)+ if (dev->type == PNFS\_BLOCK\_VOLUME\_SCSI &&+ test\_and\_clear\_bit(PNFS\_BDEV\_REGISTERED, &dev->flags)) bl\_unregister\_scsi(dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:32:31 +0000


