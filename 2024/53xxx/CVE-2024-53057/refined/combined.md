=== Content from git.kernel.org_2c0d5b74_20250115_084420.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=05df1b1dff8f197f1c275b57ccb2ca33021df552)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05df1b1dff8f197f1c275b57ccb2ca33021df552)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05df1b1dff8f197f1c275b57ccb2ca33021df552)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05df1b1dff8f197f1c275b57ccb2ca33021df552)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pedro Tammela <pctammela@mojatatu.com> | 2024-10-24 12:55:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:25:52 +0100 |
| commit | [05df1b1dff8f197f1c275b57ccb2ca33021df552](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05df1b1dff8f197f1c275b57ccb2ca33021df552) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=05df1b1dff8f197f1c275b57ccb2ca33021df552)) | |
| tree | [e89ce929c517fc2a0a8c696478b0f60623f8314c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05df1b1dff8f197f1c275b57ccb2ca33021df552) | |
| parent | [86833e4e6131d22a3fd6adb96377b3b952b28df4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86833e4e6131d22a3fd6adb96377b3b952b28df4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05df1b1dff8f197f1c275b57ccb2ca33021df552&id2=86833e4e6131d22a3fd6adb96377b3b952b28df4)) | |
| download | [linux-05df1b1dff8f197f1c275b57ccb2ca33021df552.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-05df1b1dff8f197f1c275b57ccb2ca33021df552.tar.gz) | |

net/sched: stop qdisc\_tree\_reduce\_backlog on TC\_H\_ROOT[ Upstream commit 2e95c4384438adeaa772caa560244b1a2efef816 ]
In qdisc\_tree\_reduce\_backlog, Qdiscs with major handle ffff: are assumed
to be either root or ingress. This assumption is bogus since it's valid
to create egress qdiscs with major handle ffff:
Budimir Markovic found that for qdiscs like DRR that maintain an active
class list, it will cause a UAF with a dangling class pointer.
In 066a3b5b2346, the concern was to avoid iterating over the ingress
qdisc since its parent is itself. The proper fix is to stop when parent
TC\_H\_ROOT is reached because the only way to retrieve ingress is when a
hierarchy which does not contain a ffff: major handle call into
qdisc\_lookup with TC\_H\_MAJ(TC\_H\_ROOT).
In the scenario where major ffff: is an egress qdisc in any of the tree
levels, the updates will also propagate to TC\_H\_ROOT, which then the
iteration must stop.
Fixes: 066a3b5b2346 ("[NET\_SCHED] sch\_api: fix qdisc\_tree\_decrease\_qlen() loop")
Reported-by: Budimir Markovic <markovicbudimir@gmail.com>
Suggested-by: Jamal Hadi Salim <jhs@mojatatu.com>
Tested-by: Victor Nogueira <victor@mojatatu.com>
Signed-off-by: Pedro Tammela <pctammela@mojatatu.com>
Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
net/sched/sch\_api.c | 2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241024165547.418570-1-jhs@mojatatu.com](https://patch.msgid.link/20241024165547.418570-1-jhs%40mojatatu.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05df1b1dff8f197f1c275b57ccb2ca33021df552)

| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=05df1b1dff8f197f1c275b57ccb2ca33021df552) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 724bfeccc6e7fa..bf8af9f3f3dce5 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=86833e4e6131d22a3fd6adb96377b3b952b28df4)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=05df1b1dff8f197f1c275b57ccb2ca33021df552)@@ -780,7 +780,7 @@ void qdisc\_tree\_reduce\_backlog(struct Qdisc \*sch, int n, int len) drops = max\_t(int, n, 0); rcu\_read\_lock(); while ((parentid = sch->parent)) {- if (TC\_H\_MAJ(parentid) == TC\_H\_MAJ(TC\_H\_INGRESS))+ if (parentid == TC\_H\_ROOT) break;  if (sch->flags & TCQ\_F\_NOPARENT) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:42:58 +0000



=== Content from git.kernel.org_b7eeeeed_20250115_084422.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=597cf9748c3477bf61bc35f0634129f56764ad24)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=597cf9748c3477bf61bc35f0634129f56764ad24)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=597cf9748c3477bf61bc35f0634129f56764ad24)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=597cf9748c3477bf61bc35f0634129f56764ad24)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pedro Tammela <pctammela@mojatatu.com> | 2024-10-24 12:55:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:18 +0100 |
| commit | [597cf9748c3477bf61bc35f0634129f56764ad24](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=597cf9748c3477bf61bc35f0634129f56764ad24) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=597cf9748c3477bf61bc35f0634129f56764ad24)) | |
| tree | [261637eacdb4c7a0f858bd1b7bdab27c1728c670](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=597cf9748c3477bf61bc35f0634129f56764ad24) | |
| parent | [42097a9dcaee33cdd7bf83f110be725e29cf7f81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42097a9dcaee33cdd7bf83f110be725e29cf7f81) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=597cf9748c3477bf61bc35f0634129f56764ad24&id2=42097a9dcaee33cdd7bf83f110be725e29cf7f81)) | |
| download | [linux-597cf9748c3477bf61bc35f0634129f56764ad24.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-597cf9748c3477bf61bc35f0634129f56764ad24.tar.gz) | |

net/sched: stop qdisc\_tree\_reduce\_backlog on TC\_H\_ROOT[ Upstream commit 2e95c4384438adeaa772caa560244b1a2efef816 ]
In qdisc\_tree\_reduce\_backlog, Qdiscs with major handle ffff: are assumed
to be either root or ingress. This assumption is bogus since it's valid
to create egress qdiscs with major handle ffff:
Budimir Markovic found that for qdiscs like DRR that maintain an active
class list, it will cause a UAF with a dangling class pointer.
In 066a3b5b2346, the concern was to avoid iterating over the ingress
qdisc since its parent is itself. The proper fix is to stop when parent
TC\_H\_ROOT is reached because the only way to retrieve ingress is when a
hierarchy which does not contain a ffff: major handle call into
qdisc\_lookup with TC\_H\_MAJ(TC\_H\_ROOT).
In the scenario where major ffff: is an egress qdisc in any of the tree
levels, the updates will also propagate to TC\_H\_ROOT, which then the
iteration must stop.
Fixes: 066a3b5b2346 ("[NET\_SCHED] sch\_api: fix qdisc\_tree\_decrease\_qlen() loop")
Reported-by: Budimir Markovic <markovicbudimir@gmail.com>
Suggested-by: Jamal Hadi Salim <jhs@mojatatu.com>
Tested-by: Victor Nogueira <victor@mojatatu.com>
Signed-off-by: Pedro Tammela <pctammela@mojatatu.com>
Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
net/sched/sch\_api.c | 2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241024165547.418570-1-jhs@mojatatu.com](https://patch.msgid.link/20241024165547.418570-1-jhs%40mojatatu.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=597cf9748c3477bf61bc35f0634129f56764ad24)

| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=597cf9748c3477bf61bc35f0634129f56764ad24) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 1455892694c001..00f95e7d1b9116 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=42097a9dcaee33cdd7bf83f110be725e29cf7f81)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=597cf9748c3477bf61bc35f0634129f56764ad24)@@ -791,7 +791,7 @@ void qdisc\_tree\_reduce\_backlog(struct Qdisc \*sch, int n, int len) drops = max\_t(int, n, 0); rcu\_read\_lock(); while ((parentid = sch->parent)) {- if (TC\_H\_MAJ(parentid) == TC\_H\_MAJ(TC\_H\_INGRESS))+ if (parentid == TC\_H\_ROOT) break;  if (sch->flags & TCQ\_F\_NOPARENT) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:42:59 +0000



=== Content from git.kernel.org_1a85ce98_20250115_084424.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pedro Tammela <pctammela@mojatatu.com> | 2024-10-24 12:55:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:22 +0100 |
| commit | [e7f9a6f97eb067599a74f3bcb6761976b0ed303e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e)) | |
| tree | [809c24820f99c5eef8bc51908eb38bf2479ce6d9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e) | |
| parent | [63d8172188c759c44cae7a57eece140e0b90a2e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63d8172188c759c44cae7a57eece140e0b90a2e1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e&id2=63d8172188c759c44cae7a57eece140e0b90a2e1)) | |
| download | [linux-e7f9a6f97eb067599a74f3bcb6761976b0ed303e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e7f9a6f97eb067599a74f3bcb6761976b0ed303e.tar.gz) | |

net/sched: stop qdisc\_tree\_reduce\_backlog on TC\_H\_ROOT[ Upstream commit 2e95c4384438adeaa772caa560244b1a2efef816 ]
In qdisc\_tree\_reduce\_backlog, Qdiscs with major handle ffff: are assumed
to be either root or ingress. This assumption is bogus since it's valid
to create egress qdiscs with major handle ffff:
Budimir Markovic found that for qdiscs like DRR that maintain an active
class list, it will cause a UAF with a dangling class pointer.
In 066a3b5b2346, the concern was to avoid iterating over the ingress
qdisc since its parent is itself. The proper fix is to stop when parent
TC\_H\_ROOT is reached because the only way to retrieve ingress is when a
hierarchy which does not contain a ffff: major handle call into
qdisc\_lookup with TC\_H\_MAJ(TC\_H\_ROOT).
In the scenario where major ffff: is an egress qdisc in any of the tree
levels, the updates will also propagate to TC\_H\_ROOT, which then the
iteration must stop.
Fixes: 066a3b5b2346 ("[NET\_SCHED] sch\_api: fix qdisc\_tree\_decrease\_qlen() loop")
Reported-by: Budimir Markovic <markovicbudimir@gmail.com>
Suggested-by: Jamal Hadi Salim <jhs@mojatatu.com>
Tested-by: Victor Nogueira <victor@mojatatu.com>
Signed-off-by: Pedro Tammela <pctammela@mojatatu.com>
Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
net/sched/sch\_api.c | 2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241024165547.418570-1-jhs@mojatatu.com](https://patch.msgid.link/20241024165547.418570-1-jhs%40mojatatu.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e)

| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex ab57c0ee9923ba..49c4e85257886b 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=63d8172188c759c44cae7a57eece140e0b90a2e1)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=e7f9a6f97eb067599a74f3bcb6761976b0ed303e)@@ -783,7 +783,7 @@ void qdisc\_tree\_reduce\_backlog(struct Qdisc \*sch, unsigned int n, drops = max\_t(int, n, 0); rcu\_read\_lock(); while ((parentid = sch->parent)) {- if (TC\_H\_MAJ(parentid) == TC\_H\_MAJ(TC\_H\_INGRESS))+ if (parentid == TC\_H\_ROOT) break;  if (sch->flags & TCQ\_F\_NOPARENT) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:43:01 +0000



=== Content from git.kernel.org_b5c194ca_20250115_084423.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pedro Tammela <pctammela@mojatatu.com> | 2024-10-24 12:55:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:22:01 +0100 |
| commit | [ce691c814bc7a3c30c220ffb5b7422715458fd9b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b)) | |
| tree | [0d917c9c3193ab469599d3a52576cf4ac230deb3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b) | |
| parent | [9cab53f032631fc1e03919bf13b35bd333a6b984](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9cab53f032631fc1e03919bf13b35bd333a6b984) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b&id2=9cab53f032631fc1e03919bf13b35bd333a6b984)) | |
| download | [linux-ce691c814bc7a3c30c220ffb5b7422715458fd9b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ce691c814bc7a3c30c220ffb5b7422715458fd9b.tar.gz) | |

net/sched: stop qdisc\_tree\_reduce\_backlog on TC\_H\_ROOT[ Upstream commit 2e95c4384438adeaa772caa560244b1a2efef816 ]
In qdisc\_tree\_reduce\_backlog, Qdiscs with major handle ffff: are assumed
to be either root or ingress. This assumption is bogus since it's valid
to create egress qdiscs with major handle ffff:
Budimir Markovic found that for qdiscs like DRR that maintain an active
class list, it will cause a UAF with a dangling class pointer.
In 066a3b5b2346, the concern was to avoid iterating over the ingress
qdisc since its parent is itself. The proper fix is to stop when parent
TC\_H\_ROOT is reached because the only way to retrieve ingress is when a
hierarchy which does not contain a ffff: major handle call into
qdisc\_lookup with TC\_H\_MAJ(TC\_H\_ROOT).
In the scenario where major ffff: is an egress qdisc in any of the tree
levels, the updates will also propagate to TC\_H\_ROOT, which then the
iteration must stop.
Fixes: 066a3b5b2346 ("[NET\_SCHED] sch\_api: fix qdisc\_tree\_decrease\_qlen() loop")
Reported-by: Budimir Markovic <markovicbudimir@gmail.com>
Suggested-by: Jamal Hadi Salim <jhs@mojatatu.com>
Tested-by: Victor Nogueira <victor@mojatatu.com>
Signed-off-by: Pedro Tammela <pctammela@mojatatu.com>
Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
net/sched/sch\_api.c | 2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241024165547.418570-1-jhs@mojatatu.com](https://patch.msgid.link/20241024165547.418570-1-jhs%40mojatatu.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b)

| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex d0e4845ea7018e..b4e405676600f4 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=9cab53f032631fc1e03919bf13b35bd333a6b984)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=ce691c814bc7a3c30c220ffb5b7422715458fd9b)@@ -780,7 +780,7 @@ void qdisc\_tree\_reduce\_backlog(struct Qdisc \*sch, int n, int len) drops = max\_t(int, n, 0); rcu\_read\_lock(); while ((parentid = sch->parent)) {- if (TC\_H\_MAJ(parentid) == TC\_H\_MAJ(TC\_H\_INGRESS))+ if (parentid == TC\_H\_ROOT) break;  if (sch->flags & TCQ\_F\_NOPARENT) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:43:00 +0000



=== Content from git.kernel.org_2f2b23ae_20250115_084423.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pedro Tammela <pctammela@mojatatu.com> | 2024-10-24 12:55:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:52 +0100 |
| commit | [dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20)) | |
| tree | [2699de5c7212d4a9b4b990e7b2432a684e77b0be](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20) | |
| parent | [2bb69ce76eedd2b7fc7a3b43314db7f5267fdf5e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2bb69ce76eedd2b7fc7a3b43314db7f5267fdf5e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20&id2=2bb69ce76eedd2b7fc7a3b43314db7f5267fdf5e)) | |
| download | [linux-dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20.tar.gz) | |

net/sched: stop qdisc\_tree\_reduce\_backlog on TC\_H\_ROOT[ Upstream commit 2e95c4384438adeaa772caa560244b1a2efef816 ]
In qdisc\_tree\_reduce\_backlog, Qdiscs with major handle ffff: are assumed
to be either root or ingress. This assumption is bogus since it's valid
to create egress qdiscs with major handle ffff:
Budimir Markovic found that for qdiscs like DRR that maintain an active
class list, it will cause a UAF with a dangling class pointer.
In 066a3b5b2346, the concern was to avoid iterating over the ingress
qdisc since its parent is itself. The proper fix is to stop when parent
TC\_H\_ROOT is reached because the only way to retrieve ingress is when a
hierarchy which does not contain a ffff: major handle call into
qdisc\_lookup with TC\_H\_MAJ(TC\_H\_ROOT).
In the scenario where major ffff: is an egress qdisc in any of the tree
levels, the updates will also propagate to TC\_H\_ROOT, which then the
iteration must stop.
Fixes: 066a3b5b2346 ("[NET\_SCHED] sch\_api: fix qdisc\_tree\_decrease\_qlen() loop")
Reported-by: Budimir Markovic <markovicbudimir@gmail.com>
Suggested-by: Jamal Hadi Salim <jhs@mojatatu.com>
Tested-by: Victor Nogueira <victor@mojatatu.com>
Signed-off-by: Pedro Tammela <pctammela@mojatatu.com>
Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
net/sched/sch\_api.c | 2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241024165547.418570-1-jhs@mojatatu.com](https://patch.msgid.link/20241024165547.418570-1-jhs%40mojatatu.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20)

| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 069d0d8a893977..b8dc03a7487e37 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=2bb69ce76eedd2b7fc7a3b43314db7f5267fdf5e)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=dbe778b08b5101df9e89bc06e0a3a7ecd2f4ef20)@@ -770,7 +770,7 @@ void qdisc\_tree\_reduce\_backlog(struct Qdisc \*sch, int n, int len) drops = max\_t(int, n, 0); rcu\_read\_lock(); while ((parentid = sch->parent)) {- if (TC\_H\_MAJ(parentid) == TC\_H\_MAJ(TC\_H\_INGRESS))+ if (parentid == TC\_H\_ROOT) break;  if (sch->flags & TCQ\_F\_NOPARENT) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:43:01 +0000



=== Content from git.kernel.org_e2635119_20250115_084421.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2e95c4384438adeaa772caa560244b1a2efef816)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2e95c4384438adeaa772caa560244b1a2efef816)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e95c4384438adeaa772caa560244b1a2efef816)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e95c4384438adeaa772caa560244b1a2efef816)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pedro Tammela <pctammela@mojatatu.com> | 2024-10-24 12:55:47 -0400 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-10-29 11:32:26 -0700 |
| commit | [2e95c4384438adeaa772caa560244b1a2efef816](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e95c4384438adeaa772caa560244b1a2efef816) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2e95c4384438adeaa772caa560244b1a2efef816)) | |
| tree | [f6a197ed9e1774a29bd1d35ba11283c9b1aa47c2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2e95c4384438adeaa772caa560244b1a2efef816) | |
| parent | [c59d72d0a4fbaa5fd7a04b2d13cfc101d01310db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c59d72d0a4fbaa5fd7a04b2d13cfc101d01310db) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e95c4384438adeaa772caa560244b1a2efef816&id2=c59d72d0a4fbaa5fd7a04b2d13cfc101d01310db)) | |
| download | [linux-2e95c4384438adeaa772caa560244b1a2efef816.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2e95c4384438adeaa772caa560244b1a2efef816.tar.gz) | |

net/sched: stop qdisc\_tree\_reduce\_backlog on TC\_H\_ROOTIn qdisc\_tree\_reduce\_backlog, Qdiscs with major handle ffff: are assumed
to be either root or ingress. This assumption is bogus since it's valid
to create egress qdiscs with major handle ffff:
Budimir Markovic found that for qdiscs like DRR that maintain an active
class list, it will cause a UAF with a dangling class pointer.
In 066a3b5b2346, the concern was to avoid iterating over the ingress
qdisc since its parent is itself. The proper fix is to stop when parent
TC\_H\_ROOT is reached because the only way to retrieve ingress is when a
hierarchy which does not contain a ffff: major handle call into
qdisc\_lookup with TC\_H\_MAJ(TC\_H\_ROOT).
In the scenario where major ffff: is an egress qdisc in any of the tree
levels, the updates will also propagate to TC\_H\_ROOT, which then the
iteration must stop.
Fixes: 066a3b5b2346 ("[NET\_SCHED] sch\_api: fix qdisc\_tree\_decrease\_qlen() loop")
Reported-by: Budimir Markovic <markovicbudimir@gmail.com>
Suggested-by: Jamal Hadi Salim <jhs@mojatatu.com>
Tested-by: Victor Nogueira <victor@mojatatu.com>
Signed-off-by: Pedro Tammela <pctammela@mojatatu.com>
Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
net/sched/sch\_api.c | 2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241024165547.418570-1-jhs@mojatatu.com](https://patch.msgid.link/20241024165547.418570-1-jhs%40mojatatu.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e95c4384438adeaa772caa560244b1a2efef816)

| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=2e95c4384438adeaa772caa560244b1a2efef816) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 2eefa478387997..a1d27bc039a364 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=c59d72d0a4fbaa5fd7a04b2d13cfc101d01310db)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=2e95c4384438adeaa772caa560244b1a2efef816)@@ -791,7 +791,7 @@ void qdisc\_tree\_reduce\_backlog(struct Qdisc \*sch, int n, int len) drops = max\_t(int, n, 0); rcu\_read\_lock(); while ((parentid = sch->parent)) {- if (TC\_H\_MAJ(parentid) == TC\_H\_MAJ(TC\_H\_INGRESS))+ if (parentid == TC\_H\_ROOT) break;  if (sch->flags & TCQ\_F\_NOPARENT) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:42:58 +0000



=== Content from git.kernel.org_47e06027_20250115_084422.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9995909615c3431a5304c1210face5f268d24dba)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9995909615c3431a5304c1210face5f268d24dba)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9995909615c3431a5304c1210face5f268d24dba)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9995909615c3431a5304c1210face5f268d24dba)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pedro Tammela <pctammela@mojatatu.com> | 2024-10-24 12:55:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:47 +0100 |
| commit | [9995909615c3431a5304c1210face5f268d24dba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9995909615c3431a5304c1210face5f268d24dba) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9995909615c3431a5304c1210face5f268d24dba)) | |
| tree | [19b3e1b38b2dcd35e5e30c3a1c44d675cdc8dca6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9995909615c3431a5304c1210face5f268d24dba) | |
| parent | [2218b9ea246e8a253f5e4e797073fb77d72f65c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2218b9ea246e8a253f5e4e797073fb77d72f65c8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9995909615c3431a5304c1210face5f268d24dba&id2=2218b9ea246e8a253f5e4e797073fb77d72f65c8)) | |
| download | [linux-9995909615c3431a5304c1210face5f268d24dba.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9995909615c3431a5304c1210face5f268d24dba.tar.gz) | |

net/sched: stop qdisc\_tree\_reduce\_backlog on TC\_H\_ROOT[ Upstream commit 2e95c4384438adeaa772caa560244b1a2efef816 ]
In qdisc\_tree\_reduce\_backlog, Qdiscs with major handle ffff: are assumed
to be either root or ingress. This assumption is bogus since it's valid
to create egress qdiscs with major handle ffff:
Budimir Markovic found that for qdiscs like DRR that maintain an active
class list, it will cause a UAF with a dangling class pointer.
In 066a3b5b2346, the concern was to avoid iterating over the ingress
qdisc since its parent is itself. The proper fix is to stop when parent
TC\_H\_ROOT is reached because the only way to retrieve ingress is when a
hierarchy which does not contain a ffff: major handle call into
qdisc\_lookup with TC\_H\_MAJ(TC\_H\_ROOT).
In the scenario where major ffff: is an egress qdisc in any of the tree
levels, the updates will also propagate to TC\_H\_ROOT, which then the
iteration must stop.
Fixes: 066a3b5b2346 ("[NET\_SCHED] sch\_api: fix qdisc\_tree\_decrease\_qlen() loop")
Reported-by: Budimir Markovic <markovicbudimir@gmail.com>
Suggested-by: Jamal Hadi Salim <jhs@mojatatu.com>
Tested-by: Victor Nogueira <victor@mojatatu.com>
Signed-off-by: Pedro Tammela <pctammela@mojatatu.com>
Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
net/sched/sch\_api.c | 2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241024165547.418570-1-jhs@mojatatu.com](https://patch.msgid.link/20241024165547.418570-1-jhs%40mojatatu.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9995909615c3431a5304c1210face5f268d24dba)

| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=9995909615c3431a5304c1210face5f268d24dba) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 2eefa478387997..a1d27bc039a364 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=2218b9ea246e8a253f5e4e797073fb77d72f65c8)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=9995909615c3431a5304c1210face5f268d24dba)@@ -791,7 +791,7 @@ void qdisc\_tree\_reduce\_backlog(struct Qdisc \*sch, int n, int len) drops = max\_t(int, n, 0); rcu\_read\_lock(); while ((parentid = sch->parent)) {- if (TC\_H\_MAJ(parentid) == TC\_H\_MAJ(TC\_H\_INGRESS))+ if (parentid == TC\_H\_ROOT) break;  if (sch->flags & TCQ\_F\_NOPARENT) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:43:00 +0000



=== Content from git.kernel.org_78bb8e44_20250115_084421.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=580b3189c1972aff0f993837567d36392e9d981b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=580b3189c1972aff0f993837567d36392e9d981b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=580b3189c1972aff0f993837567d36392e9d981b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=580b3189c1972aff0f993837567d36392e9d981b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pedro Tammela <pctammela@mojatatu.com> | 2024-10-24 12:55:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:41 +0100 |
| commit | [580b3189c1972aff0f993837567d36392e9d981b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=580b3189c1972aff0f993837567d36392e9d981b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=580b3189c1972aff0f993837567d36392e9d981b)) | |
| tree | [fb8e947c67db0f530a430217ed611f76922f9dee](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=580b3189c1972aff0f993837567d36392e9d981b) | |
| parent | [88bc4fe48b1cac2421b2effd85706f2cccbb047a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88bc4fe48b1cac2421b2effd85706f2cccbb047a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=580b3189c1972aff0f993837567d36392e9d981b&id2=88bc4fe48b1cac2421b2effd85706f2cccbb047a)) | |
| download | [linux-580b3189c1972aff0f993837567d36392e9d981b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-580b3189c1972aff0f993837567d36392e9d981b.tar.gz) | |

net/sched: stop qdisc\_tree\_reduce\_backlog on TC\_H\_ROOT[ Upstream commit 2e95c4384438adeaa772caa560244b1a2efef816 ]
In qdisc\_tree\_reduce\_backlog, Qdiscs with major handle ffff: are assumed
to be either root or ingress. This assumption is bogus since it's valid
to create egress qdiscs with major handle ffff:
Budimir Markovic found that for qdiscs like DRR that maintain an active
class list, it will cause a UAF with a dangling class pointer.
In 066a3b5b2346, the concern was to avoid iterating over the ingress
qdisc since its parent is itself. The proper fix is to stop when parent
TC\_H\_ROOT is reached because the only way to retrieve ingress is when a
hierarchy which does not contain a ffff: major handle call into
qdisc\_lookup with TC\_H\_MAJ(TC\_H\_ROOT).
In the scenario where major ffff: is an egress qdisc in any of the tree
levels, the updates will also propagate to TC\_H\_ROOT, which then the
iteration must stop.
Fixes: 066a3b5b2346 ("[NET\_SCHED] sch\_api: fix qdisc\_tree\_decrease\_qlen() loop")
Reported-by: Budimir Markovic <markovicbudimir@gmail.com>
Suggested-by: Jamal Hadi Salim <jhs@mojatatu.com>
Tested-by: Victor Nogueira <victor@mojatatu.com>
Signed-off-by: Pedro Tammela <pctammela@mojatatu.com>
Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
net/sched/sch\_api.c | 2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241024165547.418570-1-jhs@mojatatu.com](https://patch.msgid.link/20241024165547.418570-1-jhs%40mojatatu.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=580b3189c1972aff0f993837567d36392e9d981b)

| -rw-r--r-- | [net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_api.c?id=580b3189c1972aff0f993837567d36392e9d981b) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/sched/sch\_api.c b/net/sched/sch\_api.cindex 87ba5aaef20643..fe053e717260e7 100644--- a/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=88bc4fe48b1cac2421b2effd85706f2cccbb047a)+++ b/[net/sched/sch\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_api.c?id=580b3189c1972aff0f993837567d36392e9d981b)@@ -788,7 +788,7 @@ void qdisc\_tree\_reduce\_backlog(struct Qdisc \*sch, int n, int len) drops = max\_t(int, n, 0); rcu\_read\_lock(); while ((parentid = sch->parent)) {- if (TC\_H\_MAJ(parentid) == TC\_H\_MAJ(TC\_H\_INGRESS))+ if (parentid == TC\_H\_ROOT) break;  if (sch->flags & TCQ\_F\_NOPARENT) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:42:58 +0000


