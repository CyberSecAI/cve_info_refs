=== Content from git.kernel.org_cc52af6d_20250114_211426.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Avihai Horon <avihaih@nvidia.com> | 2024-11-24 16:27:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 10:59:37 +0100 |
| commit | [4464e5aa3aa4574063640f1082f7d7e323af8eb4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4)) | |
| tree | [660cfcebd77a400f3495529aaaa1c543f12fdc6a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4) | |
| parent | [60c8dd5dcd7520cbca3165bceec67cf7ee8443a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60c8dd5dcd7520cbca3165bceec67cf7ee8443a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4&id2=60c8dd5dcd7520cbca3165bceec67cf7ee8443a6)) | |
| download | [linux-4464e5aa3aa4574063640f1082f7d7e323af8eb4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4464e5aa3aa4574063640f1082f7d7e323af8eb4.tar.gz) | |

vfio/pci: Properly hide first-in-list PCIe extended capability[ Upstream commit fe4bf8d0b6716a423b16495d55b35d3fe515905d ]
There are cases where a PCIe extended capability should be hidden from
the user. For example, an unknown capability (i.e., capability with ID
greater than PCI\_EXT\_CAP\_ID\_MAX) or a capability that is intentionally
chosen to be hidden from the user.
Hiding a capability is done by virtualizing and modifying the 'Next
Capability Offset' field of the previous capability so it points to the
capability after the one that should be hidden.
The special case where the first capability in the list should be hidden
is handled differently because there is no previous capability that can
be modified. In this case, the capability ID and version are zeroed
while leaving the next pointer intact. This hides the capability and
leaves an anchor for the rest of the capability list.
However, today, hiding the first capability in the list is not done
properly if the capability is unknown, as struct
vfio\_pci\_core\_device->pci\_config\_map is set to the capability ID during
initialization but the capability ID is not properly checked later when
used in vfio\_config\_do\_rw(). This leads to the following warning [1] and
to an out-of-bounds access to ecap\_perms array.
Fix it by checking cap\_id in vfio\_config\_do\_rw(), and if it is greater
than PCI\_EXT\_CAP\_ID\_MAX, use an alternative struct perm\_bits for direct
read only access instead of the ecap\_perms array.
Note that this is safe since the above is the only case where cap\_id can
exceed PCI\_EXT\_CAP\_ID\_MAX (except for the special capabilities, which
are already checked before).
[1]
WARNING: CPU: 118 PID: 5329 at drivers/vfio/pci/vfio\_pci\_config.c:1900 vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
CPU: 118 UID: 0 PID: 5329 Comm: simx-qemu-syste Not tainted 6.12.0+ #1
(snip)
Call Trace:
<TASK>
? show\_regs+0x69/0x80
? \_\_warn+0x8d/0x140
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? report\_bug+0x18f/0x1a0
? handle\_bug+0x63/0xa0
? exc\_invalid\_op+0x19/0x70
? asm\_exc\_invalid\_op+0x1b/0x20
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? vfio\_pci\_config\_rw+0x244/0x430 [vfio\_pci\_core]
vfio\_pci\_rw+0x101/0x1b0 [vfio\_pci\_core]
vfio\_pci\_core\_read+0x1d/0x30 [vfio\_pci\_core]
vfio\_device\_fops\_read+0x27/0x40 [vfio]
vfs\_read+0xbd/0x340
? vfio\_device\_fops\_unl\_ioctl+0xbb/0x740 [vfio]
? \_\_rseq\_handle\_notify\_resume+0xa4/0x4b0
\_\_x64\_sys\_pread64+0x96/0xc0
x64\_sys\_call+0x1c3d/0x20d0
do\_syscall\_64+0x4d/0x120
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Signed-off-by: Avihai Horon <avihaih@nvidia.com>
Reviewed-by: Yi Liu <yi.l.liu@intel.com>
Tested-by: Yi Liu <yi.l.liu@intel.com>
Link: [https://lore.kernel.org/r/20241124142739.21698-1-avihaih@nvidia.com](https://lore.kernel.org/r/20241124142739.21698-1-avihaih%40nvidia.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4)

| -rw-r--r-- | [drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_config.c?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/vfio/pci/vfio\_pci\_config.c b/drivers/vfio/pci/vfio\_pci\_config.cindex 86e917f1cc2113..0f20e2d977d482 100644--- a/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=60c8dd5dcd7520cbca3165bceec67cf7ee8443a6)+++ b/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=4464e5aa3aa4574063640f1082f7d7e323af8eb4)@@ -315,6 +315,10 @@ static int vfio\_virt\_config\_read(struct vfio\_pci\_device \*vdev, int pos, return count; } +static struct perm\_bits direct\_ro\_perms = {+ .readfn = vfio\_direct\_config\_read,+};+ /\* Default capability regions to read-only, no-virtualization \*/ static struct perm\_bits cap\_perms[PCI\_CAP\_ID\_MAX + 1] = { [0 ... PCI\_CAP\_ID\_MAX] = { .readfn = vfio\_direct\_config\_read }@@ -1837,9 +1841,17 @@ static ssize\_t vfio\_config\_do\_rw(struct vfio\_pci\_device \*vdev, char \_\_user \*buf, cap\_start = \*ppos; } else { if (\*ppos >= PCI\_CFG\_SPACE\_SIZE) {- WARN\_ON(cap\_id > PCI\_EXT\_CAP\_ID\_MAX);+ /\*+ \* We can get a cap\_id that exceeds PCI\_EXT\_CAP\_ID\_MAX+ \* if we're hiding an unknown capability at the start+ \* of the extended capability list. Use default, ro+ \* access, which will virtualize the id and next values.+ \*/+ if (cap\_id > PCI\_EXT\_CAP\_ID\_MAX)+ perm = &direct\_ro\_perms;+ else+ perm = &ecap\_perms[cap\_id]; - perm = &ecap\_perms[cap\_id]; cap\_start = vfio\_find\_cap\_start(vdev, \*ppos); } else { WARN\_ON(cap\_id > PCI\_CAP\_ID\_MAX); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:13:03 +0000



=== Content from git.kernel.org_d825582c_20250114_211425.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1ef195178fb552478eb2587df4ad3be14ef76507)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ef195178fb552478eb2587df4ad3be14ef76507)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ef195178fb552478eb2587df4ad3be14ef76507)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ef195178fb552478eb2587df4ad3be14ef76507)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Avihai Horon <avihaih@nvidia.com> | 2024-11-24 16:27:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:29 +0100 |
| commit | [1ef195178fb552478eb2587df4ad3be14ef76507](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ef195178fb552478eb2587df4ad3be14ef76507) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1ef195178fb552478eb2587df4ad3be14ef76507)) | |
| tree | [b51b79bf71db98afb55f3ec9232eacbf07c59cb1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ef195178fb552478eb2587df4ad3be14ef76507) | |
| parent | [9b081b5f1a5ae82522d81c45a5527045ec068fe3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b081b5f1a5ae82522d81c45a5527045ec068fe3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ef195178fb552478eb2587df4ad3be14ef76507&id2=9b081b5f1a5ae82522d81c45a5527045ec068fe3)) | |
| download | [linux-1ef195178fb552478eb2587df4ad3be14ef76507.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1ef195178fb552478eb2587df4ad3be14ef76507.tar.gz) | |

vfio/pci: Properly hide first-in-list PCIe extended capability[ Upstream commit fe4bf8d0b6716a423b16495d55b35d3fe515905d ]
There are cases where a PCIe extended capability should be hidden from
the user. For example, an unknown capability (i.e., capability with ID
greater than PCI\_EXT\_CAP\_ID\_MAX) or a capability that is intentionally
chosen to be hidden from the user.
Hiding a capability is done by virtualizing and modifying the 'Next
Capability Offset' field of the previous capability so it points to the
capability after the one that should be hidden.
The special case where the first capability in the list should be hidden
is handled differently because there is no previous capability that can
be modified. In this case, the capability ID and version are zeroed
while leaving the next pointer intact. This hides the capability and
leaves an anchor for the rest of the capability list.
However, today, hiding the first capability in the list is not done
properly if the capability is unknown, as struct
vfio\_pci\_core\_device->pci\_config\_map is set to the capability ID during
initialization but the capability ID is not properly checked later when
used in vfio\_config\_do\_rw(). This leads to the following warning [1] and
to an out-of-bounds access to ecap\_perms array.
Fix it by checking cap\_id in vfio\_config\_do\_rw(), and if it is greater
than PCI\_EXT\_CAP\_ID\_MAX, use an alternative struct perm\_bits for direct
read only access instead of the ecap\_perms array.
Note that this is safe since the above is the only case where cap\_id can
exceed PCI\_EXT\_CAP\_ID\_MAX (except for the special capabilities, which
are already checked before).
[1]
WARNING: CPU: 118 PID: 5329 at drivers/vfio/pci/vfio\_pci\_config.c:1900 vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
CPU: 118 UID: 0 PID: 5329 Comm: simx-qemu-syste Not tainted 6.12.0+ #1
(snip)
Call Trace:
<TASK>
? show\_regs+0x69/0x80
? \_\_warn+0x8d/0x140
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? report\_bug+0x18f/0x1a0
? handle\_bug+0x63/0xa0
? exc\_invalid\_op+0x19/0x70
? asm\_exc\_invalid\_op+0x1b/0x20
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? vfio\_pci\_config\_rw+0x244/0x430 [vfio\_pci\_core]
vfio\_pci\_rw+0x101/0x1b0 [vfio\_pci\_core]
vfio\_pci\_core\_read+0x1d/0x30 [vfio\_pci\_core]
vfio\_device\_fops\_read+0x27/0x40 [vfio]
vfs\_read+0xbd/0x340
? vfio\_device\_fops\_unl\_ioctl+0xbb/0x740 [vfio]
? \_\_rseq\_handle\_notify\_resume+0xa4/0x4b0
\_\_x64\_sys\_pread64+0x96/0xc0
x64\_sys\_call+0x1c3d/0x20d0
do\_syscall\_64+0x4d/0x120
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Signed-off-by: Avihai Horon <avihaih@nvidia.com>
Reviewed-by: Yi Liu <yi.l.liu@intel.com>
Tested-by: Yi Liu <yi.l.liu@intel.com>
Link: [https://lore.kernel.org/r/20241124142739.21698-1-avihaih@nvidia.com](https://lore.kernel.org/r/20241124142739.21698-1-avihaih%40nvidia.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ef195178fb552478eb2587df4ad3be14ef76507)

| -rw-r--r-- | [drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_config.c?id=1ef195178fb552478eb2587df4ad3be14ef76507) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/vfio/pci/vfio\_pci\_config.c b/drivers/vfio/pci/vfio\_pci\_config.cindex 97422aafaa7b5d..ea2745c1ac5e68 100644--- a/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=9b081b5f1a5ae82522d81c45a5527045ec068fe3)+++ b/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=1ef195178fb552478eb2587df4ad3be14ef76507)@@ -313,6 +313,10 @@ static int vfio\_virt\_config\_read(struct vfio\_pci\_core\_device \*vdev, int pos, return count; } +static struct perm\_bits direct\_ro\_perms = {+ .readfn = vfio\_direct\_config\_read,+};+ /\* Default capability regions to read-only, no-virtualization \*/ static struct perm\_bits cap\_perms[PCI\_CAP\_ID\_MAX + 1] = { [0 ... PCI\_CAP\_ID\_MAX] = { .readfn = vfio\_direct\_config\_read }@@ -1897,9 +1901,17 @@ static ssize\_t vfio\_config\_do\_rw(struct vfio\_pci\_core\_device \*vdev, char \_\_user cap\_start = \*ppos; } else { if (\*ppos >= PCI\_CFG\_SPACE\_SIZE) {- WARN\_ON(cap\_id > PCI\_EXT\_CAP\_ID\_MAX);+ /\*+ \* We can get a cap\_id that exceeds PCI\_EXT\_CAP\_ID\_MAX+ \* if we're hiding an unknown capability at the start+ \* of the extended capability list. Use default, ro+ \* access, which will virtualize the id and next values.+ \*/+ if (cap\_id > PCI\_EXT\_CAP\_ID\_MAX)+ perm = &direct\_ro\_perms;+ else+ perm = &ecap\_perms[cap\_id]; - perm = &ecap\_perms[cap\_id]; cap\_start = vfio\_find\_cap\_start(vdev, \*ppos); } else { WARN\_ON(cap\_id > PCI\_CAP\_ID\_MAX); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:13:03 +0000



=== Content from git.kernel.org_3ba3c250_20250114_211428.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=949bee8065a85a5c6607c624dc05b5bc17119699)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=949bee8065a85a5c6607c624dc05b5bc17119699)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=949bee8065a85a5c6607c624dc05b5bc17119699)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=949bee8065a85a5c6607c624dc05b5bc17119699)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Avihai Horon <avihaih@nvidia.com> | 2024-11-24 16:27:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:56 +0100 |
| commit | [949bee8065a85a5c6607c624dc05b5bc17119699](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=949bee8065a85a5c6607c624dc05b5bc17119699) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=949bee8065a85a5c6607c624dc05b5bc17119699)) | |
| tree | [59720260428f58f7aa5ad6979c21ea338e58819d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=949bee8065a85a5c6607c624dc05b5bc17119699) | |
| parent | [74a730137c9cc01dd9552a11f36ff57dd259cfc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74a730137c9cc01dd9552a11f36ff57dd259cfc3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=949bee8065a85a5c6607c624dc05b5bc17119699&id2=74a730137c9cc01dd9552a11f36ff57dd259cfc3)) | |
| download | [linux-949bee8065a85a5c6607c624dc05b5bc17119699.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-949bee8065a85a5c6607c624dc05b5bc17119699.tar.gz) | |

vfio/pci: Properly hide first-in-list PCIe extended capability[ Upstream commit fe4bf8d0b6716a423b16495d55b35d3fe515905d ]
There are cases where a PCIe extended capability should be hidden from
the user. For example, an unknown capability (i.e., capability with ID
greater than PCI\_EXT\_CAP\_ID\_MAX) or a capability that is intentionally
chosen to be hidden from the user.
Hiding a capability is done by virtualizing and modifying the 'Next
Capability Offset' field of the previous capability so it points to the
capability after the one that should be hidden.
The special case where the first capability in the list should be hidden
is handled differently because there is no previous capability that can
be modified. In this case, the capability ID and version are zeroed
while leaving the next pointer intact. This hides the capability and
leaves an anchor for the rest of the capability list.
However, today, hiding the first capability in the list is not done
properly if the capability is unknown, as struct
vfio\_pci\_core\_device->pci\_config\_map is set to the capability ID during
initialization but the capability ID is not properly checked later when
used in vfio\_config\_do\_rw(). This leads to the following warning [1] and
to an out-of-bounds access to ecap\_perms array.
Fix it by checking cap\_id in vfio\_config\_do\_rw(), and if it is greater
than PCI\_EXT\_CAP\_ID\_MAX, use an alternative struct perm\_bits for direct
read only access instead of the ecap\_perms array.
Note that this is safe since the above is the only case where cap\_id can
exceed PCI\_EXT\_CAP\_ID\_MAX (except for the special capabilities, which
are already checked before).
[1]
WARNING: CPU: 118 PID: 5329 at drivers/vfio/pci/vfio\_pci\_config.c:1900 vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
CPU: 118 UID: 0 PID: 5329 Comm: simx-qemu-syste Not tainted 6.12.0+ #1
(snip)
Call Trace:
<TASK>
? show\_regs+0x69/0x80
? \_\_warn+0x8d/0x140
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? report\_bug+0x18f/0x1a0
? handle\_bug+0x63/0xa0
? exc\_invalid\_op+0x19/0x70
? asm\_exc\_invalid\_op+0x1b/0x20
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? vfio\_pci\_config\_rw+0x244/0x430 [vfio\_pci\_core]
vfio\_pci\_rw+0x101/0x1b0 [vfio\_pci\_core]
vfio\_pci\_core\_read+0x1d/0x30 [vfio\_pci\_core]
vfio\_device\_fops\_read+0x27/0x40 [vfio]
vfs\_read+0xbd/0x340
? vfio\_device\_fops\_unl\_ioctl+0xbb/0x740 [vfio]
? \_\_rseq\_handle\_notify\_resume+0xa4/0x4b0
\_\_x64\_sys\_pread64+0x96/0xc0
x64\_sys\_call+0x1c3d/0x20d0
do\_syscall\_64+0x4d/0x120
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Signed-off-by: Avihai Horon <avihaih@nvidia.com>
Reviewed-by: Yi Liu <yi.l.liu@intel.com>
Tested-by: Yi Liu <yi.l.liu@intel.com>
Link: [https://lore.kernel.org/r/20241124142739.21698-1-avihaih@nvidia.com](https://lore.kernel.org/r/20241124142739.21698-1-avihaih%40nvidia.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=949bee8065a85a5c6607c624dc05b5bc17119699)

| -rw-r--r-- | [drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_config.c?id=949bee8065a85a5c6607c624dc05b5bc17119699) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/vfio/pci/vfio\_pci\_config.c b/drivers/vfio/pci/vfio\_pci\_config.cindex 97422aafaa7b5d..ea2745c1ac5e68 100644--- a/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=74a730137c9cc01dd9552a11f36ff57dd259cfc3)+++ b/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=949bee8065a85a5c6607c624dc05b5bc17119699)@@ -313,6 +313,10 @@ static int vfio\_virt\_config\_read(struct vfio\_pci\_core\_device \*vdev, int pos, return count; } +static struct perm\_bits direct\_ro\_perms = {+ .readfn = vfio\_direct\_config\_read,+};+ /\* Default capability regions to read-only, no-virtualization \*/ static struct perm\_bits cap\_perms[PCI\_CAP\_ID\_MAX + 1] = { [0 ... PCI\_CAP\_ID\_MAX] = { .readfn = vfio\_direct\_config\_read }@@ -1897,9 +1901,17 @@ static ssize\_t vfio\_config\_do\_rw(struct vfio\_pci\_core\_device \*vdev, char \_\_user cap\_start = \*ppos; } else { if (\*ppos >= PCI\_CFG\_SPACE\_SIZE) {- WARN\_ON(cap\_id > PCI\_EXT\_CAP\_ID\_MAX);+ /\*+ \* We can get a cap\_id that exceeds PCI\_EXT\_CAP\_ID\_MAX+ \* if we're hiding an unknown capability at the start+ \* of the extended capability list. Use default, ro+ \* access, which will virtualize the id and next values.+ \*/+ if (cap\_id > PCI\_EXT\_CAP\_ID\_MAX)+ perm = &direct\_ro\_perms;+ else+ perm = &ecap\_perms[cap\_id]; - perm = &ecap\_perms[cap\_id]; cap\_start = vfio\_find\_cap\_start(vdev, \*ppos); } else { WARN\_ON(cap\_id > PCI\_CAP\_ID\_MAX); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:13:05 +0000



=== Content from git.kernel.org_b459dd47_20250114_211429.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9567bd34aa3b986736c290c5bcba47e0182ac47a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9567bd34aa3b986736c290c5bcba47e0182ac47a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9567bd34aa3b986736c290c5bcba47e0182ac47a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9567bd34aa3b986736c290c5bcba47e0182ac47a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Avihai Horon <avihaih@nvidia.com> | 2024-11-24 16:27:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:08 +0100 |
| commit | [9567bd34aa3b986736c290c5bcba47e0182ac47a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9567bd34aa3b986736c290c5bcba47e0182ac47a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9567bd34aa3b986736c290c5bcba47e0182ac47a)) | |
| tree | [c182bad57eae269ca1403d369e7d1f23b7e81614](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9567bd34aa3b986736c290c5bcba47e0182ac47a) | |
| parent | [dc2144cfefff3c47a4f574d76c8abfc830498b7b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc2144cfefff3c47a4f574d76c8abfc830498b7b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9567bd34aa3b986736c290c5bcba47e0182ac47a&id2=dc2144cfefff3c47a4f574d76c8abfc830498b7b)) | |
| download | [linux-9567bd34aa3b986736c290c5bcba47e0182ac47a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9567bd34aa3b986736c290c5bcba47e0182ac47a.tar.gz) | |

vfio/pci: Properly hide first-in-list PCIe extended capability[ Upstream commit fe4bf8d0b6716a423b16495d55b35d3fe515905d ]
There are cases where a PCIe extended capability should be hidden from
the user. For example, an unknown capability (i.e., capability with ID
greater than PCI\_EXT\_CAP\_ID\_MAX) or a capability that is intentionally
chosen to be hidden from the user.
Hiding a capability is done by virtualizing and modifying the 'Next
Capability Offset' field of the previous capability so it points to the
capability after the one that should be hidden.
The special case where the first capability in the list should be hidden
is handled differently because there is no previous capability that can
be modified. In this case, the capability ID and version are zeroed
while leaving the next pointer intact. This hides the capability and
leaves an anchor for the rest of the capability list.
However, today, hiding the first capability in the list is not done
properly if the capability is unknown, as struct
vfio\_pci\_core\_device->pci\_config\_map is set to the capability ID during
initialization but the capability ID is not properly checked later when
used in vfio\_config\_do\_rw(). This leads to the following warning [1] and
to an out-of-bounds access to ecap\_perms array.
Fix it by checking cap\_id in vfio\_config\_do\_rw(), and if it is greater
than PCI\_EXT\_CAP\_ID\_MAX, use an alternative struct perm\_bits for direct
read only access instead of the ecap\_perms array.
Note that this is safe since the above is the only case where cap\_id can
exceed PCI\_EXT\_CAP\_ID\_MAX (except for the special capabilities, which
are already checked before).
[1]
WARNING: CPU: 118 PID: 5329 at drivers/vfio/pci/vfio\_pci\_config.c:1900 vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
CPU: 118 UID: 0 PID: 5329 Comm: simx-qemu-syste Not tainted 6.12.0+ #1
(snip)
Call Trace:
<TASK>
? show\_regs+0x69/0x80
? \_\_warn+0x8d/0x140
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? report\_bug+0x18f/0x1a0
? handle\_bug+0x63/0xa0
? exc\_invalid\_op+0x19/0x70
? asm\_exc\_invalid\_op+0x1b/0x20
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? vfio\_pci\_config\_rw+0x244/0x430 [vfio\_pci\_core]
vfio\_pci\_rw+0x101/0x1b0 [vfio\_pci\_core]
vfio\_pci\_core\_read+0x1d/0x30 [vfio\_pci\_core]
vfio\_device\_fops\_read+0x27/0x40 [vfio]
vfs\_read+0xbd/0x340
? vfio\_device\_fops\_unl\_ioctl+0xbb/0x740 [vfio]
? \_\_rseq\_handle\_notify\_resume+0xa4/0x4b0
\_\_x64\_sys\_pread64+0x96/0xc0
x64\_sys\_call+0x1c3d/0x20d0
do\_syscall\_64+0x4d/0x120
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Signed-off-by: Avihai Horon <avihaih@nvidia.com>
Reviewed-by: Yi Liu <yi.l.liu@intel.com>
Tested-by: Yi Liu <yi.l.liu@intel.com>
Link: [https://lore.kernel.org/r/20241124142739.21698-1-avihaih@nvidia.com](https://lore.kernel.org/r/20241124142739.21698-1-avihaih%40nvidia.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9567bd34aa3b986736c290c5bcba47e0182ac47a)

| -rw-r--r-- | [drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_config.c?id=9567bd34aa3b986736c290c5bcba47e0182ac47a) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/vfio/pci/vfio\_pci\_config.c b/drivers/vfio/pci/vfio\_pci\_config.cindex 6e58b4bf7a6013..63f6308b0f8c9e 100644--- a/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=dc2144cfefff3c47a4f574d76c8abfc830498b7b)+++ b/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=9567bd34aa3b986736c290c5bcba47e0182ac47a)@@ -312,6 +312,10 @@ static int vfio\_virt\_config\_read(struct vfio\_pci\_core\_device \*vdev, int pos, return count; } +static struct perm\_bits direct\_ro\_perms = {+ .readfn = vfio\_direct\_config\_read,+};+ /\* Default capability regions to read-only, no-virtualization \*/ static struct perm\_bits cap\_perms[PCI\_CAP\_ID\_MAX + 1] = { [0 ... PCI\_CAP\_ID\_MAX] = { .readfn = vfio\_direct\_config\_read }@@ -1840,9 +1844,17 @@ static ssize\_t vfio\_config\_do\_rw(struct vfio\_pci\_core\_device \*vdev, char \_\_user cap\_start = \*ppos; } else { if (\*ppos >= PCI\_CFG\_SPACE\_SIZE) {- WARN\_ON(cap\_id > PCI\_EXT\_CAP\_ID\_MAX);+ /\*+ \* We can get a cap\_id that exceeds PCI\_EXT\_CAP\_ID\_MAX+ \* if we're hiding an unknown capability at the start+ \* of the extended capability list. Use default, ro+ \* access, which will virtualize the id and next values.+ \*/+ if (cap\_id > PCI\_EXT\_CAP\_ID\_MAX)+ perm = &direct\_ro\_perms;+ else+ perm = &ecap\_perms[cap\_id]; - perm = &ecap\_perms[cap\_id]; cap\_start = vfio\_find\_cap\_start(vdev, \*ppos); } else { WARN\_ON(cap\_id > PCI\_CAP\_ID\_MAX); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:13:06 +0000



=== Content from git.kernel.org_afab4030_20250114_211429.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Avihai Horon <avihaih@nvidia.com> | 2024-11-24 16:27:39 +0200 |
| --- | --- | --- |
| committer | Alex Williamson <alex.williamson@redhat.com> | 2024-11-25 08:34:22 -0700 |
| commit | [fe4bf8d0b6716a423b16495d55b35d3fe515905d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d)) | |
| tree | [179531e9c4ec95b4dde31fdd8ac21c2aff4c98c1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d) | |
| parent | [cb04444c243c001fc27f275e84792ff1c2b96867](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb04444c243c001fc27f275e84792ff1c2b96867) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d&id2=cb04444c243c001fc27f275e84792ff1c2b96867)) | |
| download | [linux-fe4bf8d0b6716a423b16495d55b35d3fe515905d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe4bf8d0b6716a423b16495d55b35d3fe515905d.tar.gz) | |

vfio/pci: Properly hide first-in-list PCIe extended capabilityThere are cases where a PCIe extended capability should be hidden from
the user. For example, an unknown capability (i.e., capability with ID
greater than PCI\_EXT\_CAP\_ID\_MAX) or a capability that is intentionally
chosen to be hidden from the user.
Hiding a capability is done by virtualizing and modifying the 'Next
Capability Offset' field of the previous capability so it points to the
capability after the one that should be hidden.
The special case where the first capability in the list should be hidden
is handled differently because there is no previous capability that can
be modified. In this case, the capability ID and version are zeroed
while leaving the next pointer intact. This hides the capability and
leaves an anchor for the rest of the capability list.
However, today, hiding the first capability in the list is not done
properly if the capability is unknown, as struct
vfio\_pci\_core\_device->pci\_config\_map is set to the capability ID during
initialization but the capability ID is not properly checked later when
used in vfio\_config\_do\_rw(). This leads to the following warning [1] and
to an out-of-bounds access to ecap\_perms array.
Fix it by checking cap\_id in vfio\_config\_do\_rw(), and if it is greater
than PCI\_EXT\_CAP\_ID\_MAX, use an alternative struct perm\_bits for direct
read only access instead of the ecap\_perms array.
Note that this is safe since the above is the only case where cap\_id can
exceed PCI\_EXT\_CAP\_ID\_MAX (except for the special capabilities, which
are already checked before).
[1]
WARNING: CPU: 118 PID: 5329 at drivers/vfio/pci/vfio\_pci\_config.c:1900 vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
CPU: 118 UID: 0 PID: 5329 Comm: simx-qemu-syste Not tainted 6.12.0+ #1
(snip)
Call Trace:
<TASK>
? show\_regs+0x69/0x80
? \_\_warn+0x8d/0x140
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? report\_bug+0x18f/0x1a0
? handle\_bug+0x63/0xa0
? exc\_invalid\_op+0x19/0x70
? asm\_exc\_invalid\_op+0x1b/0x20
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? vfio\_pci\_config\_rw+0x244/0x430 [vfio\_pci\_core]
vfio\_pci\_rw+0x101/0x1b0 [vfio\_pci\_core]
vfio\_pci\_core\_read+0x1d/0x30 [vfio\_pci\_core]
vfio\_device\_fops\_read+0x27/0x40 [vfio]
vfs\_read+0xbd/0x340
? vfio\_device\_fops\_unl\_ioctl+0xbb/0x740 [vfio]
? \_\_rseq\_handle\_notify\_resume+0xa4/0x4b0
\_\_x64\_sys\_pread64+0x96/0xc0
x64\_sys\_call+0x1c3d/0x20d0
do\_syscall\_64+0x4d/0x120
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Signed-off-by: Avihai Horon <avihaih@nvidia.com>
Reviewed-by: Yi Liu <yi.l.liu@intel.com>
Tested-by: Yi Liu <yi.l.liu@intel.com>
Link: [https://lore.kernel.org/r/20241124142739.21698-1-avihaih@nvidia.com](https://lore.kernel.org/r/20241124142739.21698-1-avihaih%40nvidia.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d)

| -rw-r--r-- | [drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_config.c?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/vfio/pci/vfio\_pci\_config.c b/drivers/vfio/pci/vfio\_pci\_config.cindex 97422aafaa7b5d..ea2745c1ac5e68 100644--- a/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=cb04444c243c001fc27f275e84792ff1c2b96867)+++ b/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=fe4bf8d0b6716a423b16495d55b35d3fe515905d)@@ -313,6 +313,10 @@ static int vfio\_virt\_config\_read(struct vfio\_pci\_core\_device \*vdev, int pos, return count; } +static struct perm\_bits direct\_ro\_perms = {+ .readfn = vfio\_direct\_config\_read,+};+ /\* Default capability regions to read-only, no-virtualization \*/ static struct perm\_bits cap\_perms[PCI\_CAP\_ID\_MAX + 1] = { [0 ... PCI\_CAP\_ID\_MAX] = { .readfn = vfio\_direct\_config\_read }@@ -1897,9 +1901,17 @@ static ssize\_t vfio\_config\_do\_rw(struct vfio\_pci\_core\_device \*vdev, char \_\_user cap\_start = \*ppos; } else { if (\*ppos >= PCI\_CFG\_SPACE\_SIZE) {- WARN\_ON(cap\_id > PCI\_EXT\_CAP\_ID\_MAX);+ /\*+ \* We can get a cap\_id that exceeds PCI\_EXT\_CAP\_ID\_MAX+ \* if we're hiding an unknown capability at the start+ \* of the extended capability list. Use default, ro+ \* access, which will virtualize the id and next values.+ \*/+ if (cap\_id > PCI\_EXT\_CAP\_ID\_MAX)+ perm = &direct\_ro\_perms;+ else+ perm = &ecap\_perms[cap\_id]; - perm = &ecap\_perms[cap\_id]; cap\_start = vfio\_find\_cap\_start(vdev, \*ppos); } else { WARN\_ON(cap\_id > PCI\_CAP\_ID\_MAX); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:13:06 +0000



=== Content from git.kernel.org_c76dc348_20250114_211428.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7d121f66b67921fb3b95e0ea9856bfba53733e91)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7d121f66b67921fb3b95e0ea9856bfba53733e91)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d121f66b67921fb3b95e0ea9856bfba53733e91)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d121f66b67921fb3b95e0ea9856bfba53733e91)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Avihai Horon <avihaih@nvidia.com> | 2024-11-24 16:27:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:33 +0100 |
| commit | [7d121f66b67921fb3b95e0ea9856bfba53733e91](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d121f66b67921fb3b95e0ea9856bfba53733e91) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7d121f66b67921fb3b95e0ea9856bfba53733e91)) | |
| tree | [a3601272650c9b30af5751540c4c576d9703730a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7d121f66b67921fb3b95e0ea9856bfba53733e91) | |
| parent | [d68d5f63b62c3a8e829891d36c8e288987066644](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d68d5f63b62c3a8e829891d36c8e288987066644) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d121f66b67921fb3b95e0ea9856bfba53733e91&id2=d68d5f63b62c3a8e829891d36c8e288987066644)) | |
| download | [linux-7d121f66b67921fb3b95e0ea9856bfba53733e91.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7d121f66b67921fb3b95e0ea9856bfba53733e91.tar.gz) | |

vfio/pci: Properly hide first-in-list PCIe extended capability[ Upstream commit fe4bf8d0b6716a423b16495d55b35d3fe515905d ]
There are cases where a PCIe extended capability should be hidden from
the user. For example, an unknown capability (i.e., capability with ID
greater than PCI\_EXT\_CAP\_ID\_MAX) or a capability that is intentionally
chosen to be hidden from the user.
Hiding a capability is done by virtualizing and modifying the 'Next
Capability Offset' field of the previous capability so it points to the
capability after the one that should be hidden.
The special case where the first capability in the list should be hidden
is handled differently because there is no previous capability that can
be modified. In this case, the capability ID and version are zeroed
while leaving the next pointer intact. This hides the capability and
leaves an anchor for the rest of the capability list.
However, today, hiding the first capability in the list is not done
properly if the capability is unknown, as struct
vfio\_pci\_core\_device->pci\_config\_map is set to the capability ID during
initialization but the capability ID is not properly checked later when
used in vfio\_config\_do\_rw(). This leads to the following warning [1] and
to an out-of-bounds access to ecap\_perms array.
Fix it by checking cap\_id in vfio\_config\_do\_rw(), and if it is greater
than PCI\_EXT\_CAP\_ID\_MAX, use an alternative struct perm\_bits for direct
read only access instead of the ecap\_perms array.
Note that this is safe since the above is the only case where cap\_id can
exceed PCI\_EXT\_CAP\_ID\_MAX (except for the special capabilities, which
are already checked before).
[1]
WARNING: CPU: 118 PID: 5329 at drivers/vfio/pci/vfio\_pci\_config.c:1900 vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
CPU: 118 UID: 0 PID: 5329 Comm: simx-qemu-syste Not tainted 6.12.0+ #1
(snip)
Call Trace:
<TASK>
? show\_regs+0x69/0x80
? \_\_warn+0x8d/0x140
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? report\_bug+0x18f/0x1a0
? handle\_bug+0x63/0xa0
? exc\_invalid\_op+0x19/0x70
? asm\_exc\_invalid\_op+0x1b/0x20
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? vfio\_pci\_config\_rw+0x244/0x430 [vfio\_pci\_core]
vfio\_pci\_rw+0x101/0x1b0 [vfio\_pci\_core]
vfio\_pci\_core\_read+0x1d/0x30 [vfio\_pci\_core]
vfio\_device\_fops\_read+0x27/0x40 [vfio]
vfs\_read+0xbd/0x340
? vfio\_device\_fops\_unl\_ioctl+0xbb/0x740 [vfio]
? \_\_rseq\_handle\_notify\_resume+0xa4/0x4b0
\_\_x64\_sys\_pread64+0x96/0xc0
x64\_sys\_call+0x1c3d/0x20d0
do\_syscall\_64+0x4d/0x120
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Signed-off-by: Avihai Horon <avihaih@nvidia.com>
Reviewed-by: Yi Liu <yi.l.liu@intel.com>
Tested-by: Yi Liu <yi.l.liu@intel.com>
Link: [https://lore.kernel.org/r/20241124142739.21698-1-avihaih@nvidia.com](https://lore.kernel.org/r/20241124142739.21698-1-avihaih%40nvidia.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d121f66b67921fb3b95e0ea9856bfba53733e91)

| -rw-r--r-- | [drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_config.c?id=7d121f66b67921fb3b95e0ea9856bfba53733e91) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/vfio/pci/vfio\_pci\_config.c b/drivers/vfio/pci/vfio\_pci\_config.cindex 50cd17fcf7541a..f34ee2a0c2c193 100644--- a/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=d68d5f63b62c3a8e829891d36c8e288987066644)+++ b/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=7d121f66b67921fb3b95e0ea9856bfba53733e91)@@ -312,6 +312,10 @@ static int vfio\_virt\_config\_read(struct vfio\_pci\_device \*vdev, int pos, return count; } +static struct perm\_bits direct\_ro\_perms = {+ .readfn = vfio\_direct\_config\_read,+};+ /\* Default capability regions to read-only, no-virtualization \*/ static struct perm\_bits cap\_perms[PCI\_CAP\_ID\_MAX + 1] = { [0 ... PCI\_CAP\_ID\_MAX] = { .readfn = vfio\_direct\_config\_read }@@ -1835,9 +1839,17 @@ static ssize\_t vfio\_config\_do\_rw(struct vfio\_pci\_device \*vdev, char \_\_user \*buf, cap\_start = \*ppos; } else { if (\*ppos >= PCI\_CFG\_SPACE\_SIZE) {- WARN\_ON(cap\_id > PCI\_EXT\_CAP\_ID\_MAX);+ /\*+ \* We can get a cap\_id that exceeds PCI\_EXT\_CAP\_ID\_MAX+ \* if we're hiding an unknown capability at the start+ \* of the extended capability list. Use default, ro+ \* access, which will virtualize the id and next values.+ \*/+ if (cap\_id > PCI\_EXT\_CAP\_ID\_MAX)+ perm = &direct\_ro\_perms;+ else+ perm = &ecap\_perms[cap\_id]; - perm = &ecap\_perms[cap\_id]; cap\_start = vfio\_find\_cap\_start(vdev, \*ppos); } else { WARN\_ON(cap\_id > PCI\_CAP\_ID\_MAX); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:13:05 +0000



=== Content from git.kernel.org_a5c20c38_20250114_211425.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Avihai Horon <avihaih@nvidia.com> | 2024-11-24 16:27:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:03 +0100 |
| commit | [0918f5643fc6c3f7801f4a22397d2cc09ba99207](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207)) | |
| tree | [d33198e620dfef5e4fcf521bcf9482241b3e513f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207) | |
| parent | [145482f4c89464556ac58f36bca8c1e3f10bf196](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=145482f4c89464556ac58f36bca8c1e3f10bf196) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207&id2=145482f4c89464556ac58f36bca8c1e3f10bf196)) | |
| download | [linux-0918f5643fc6c3f7801f4a22397d2cc09ba99207.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0918f5643fc6c3f7801f4a22397d2cc09ba99207.tar.gz) | |

vfio/pci: Properly hide first-in-list PCIe extended capability[ Upstream commit fe4bf8d0b6716a423b16495d55b35d3fe515905d ]
There are cases where a PCIe extended capability should be hidden from
the user. For example, an unknown capability (i.e., capability with ID
greater than PCI\_EXT\_CAP\_ID\_MAX) or a capability that is intentionally
chosen to be hidden from the user.
Hiding a capability is done by virtualizing and modifying the 'Next
Capability Offset' field of the previous capability so it points to the
capability after the one that should be hidden.
The special case where the first capability in the list should be hidden
is handled differently because there is no previous capability that can
be modified. In this case, the capability ID and version are zeroed
while leaving the next pointer intact. This hides the capability and
leaves an anchor for the rest of the capability list.
However, today, hiding the first capability in the list is not done
properly if the capability is unknown, as struct
vfio\_pci\_core\_device->pci\_config\_map is set to the capability ID during
initialization but the capability ID is not properly checked later when
used in vfio\_config\_do\_rw(). This leads to the following warning [1] and
to an out-of-bounds access to ecap\_perms array.
Fix it by checking cap\_id in vfio\_config\_do\_rw(), and if it is greater
than PCI\_EXT\_CAP\_ID\_MAX, use an alternative struct perm\_bits for direct
read only access instead of the ecap\_perms array.
Note that this is safe since the above is the only case where cap\_id can
exceed PCI\_EXT\_CAP\_ID\_MAX (except for the special capabilities, which
are already checked before).
[1]
WARNING: CPU: 118 PID: 5329 at drivers/vfio/pci/vfio\_pci\_config.c:1900 vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
CPU: 118 UID: 0 PID: 5329 Comm: simx-qemu-syste Not tainted 6.12.0+ #1
(snip)
Call Trace:
<TASK>
? show\_regs+0x69/0x80
? \_\_warn+0x8d/0x140
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? report\_bug+0x18f/0x1a0
? handle\_bug+0x63/0xa0
? exc\_invalid\_op+0x19/0x70
? asm\_exc\_invalid\_op+0x1b/0x20
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? vfio\_pci\_config\_rw+0x244/0x430 [vfio\_pci\_core]
vfio\_pci\_rw+0x101/0x1b0 [vfio\_pci\_core]
vfio\_pci\_core\_read+0x1d/0x30 [vfio\_pci\_core]
vfio\_device\_fops\_read+0x27/0x40 [vfio]
vfs\_read+0xbd/0x340
? vfio\_device\_fops\_unl\_ioctl+0xbb/0x740 [vfio]
? \_\_rseq\_handle\_notify\_resume+0xa4/0x4b0
\_\_x64\_sys\_pread64+0x96/0xc0
x64\_sys\_call+0x1c3d/0x20d0
do\_syscall\_64+0x4d/0x120
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Signed-off-by: Avihai Horon <avihaih@nvidia.com>
Reviewed-by: Yi Liu <yi.l.liu@intel.com>
Tested-by: Yi Liu <yi.l.liu@intel.com>
Link: [https://lore.kernel.org/r/20241124142739.21698-1-avihaih@nvidia.com](https://lore.kernel.org/r/20241124142739.21698-1-avihaih%40nvidia.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207)

| -rw-r--r-- | [drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_config.c?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/vfio/pci/vfio\_pci\_config.c b/drivers/vfio/pci/vfio\_pci\_config.cindex 47f21a6ca7fe94..401c3c776c6b53 100644--- a/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=145482f4c89464556ac58f36bca8c1e3f10bf196)+++ b/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=0918f5643fc6c3f7801f4a22397d2cc09ba99207)@@ -312,6 +312,10 @@ static int vfio\_virt\_config\_read(struct vfio\_pci\_device \*vdev, int pos, return count; } +static struct perm\_bits direct\_ro\_perms = {+ .readfn = vfio\_direct\_config\_read,+};+ /\* Default capability regions to read-only, no-virtualization \*/ static struct perm\_bits cap\_perms[PCI\_CAP\_ID\_MAX + 1] = { [0 ... PCI\_CAP\_ID\_MAX] = { .readfn = vfio\_direct\_config\_read }@@ -1840,9 +1844,17 @@ static ssize\_t vfio\_config\_do\_rw(struct vfio\_pci\_device \*vdev, char \_\_user \*buf, cap\_start = \*ppos; } else { if (\*ppos >= PCI\_CFG\_SPACE\_SIZE) {- WARN\_ON(cap\_id > PCI\_EXT\_CAP\_ID\_MAX);+ /\*+ \* We can get a cap\_id that exceeds PCI\_EXT\_CAP\_ID\_MAX+ \* if we're hiding an unknown capability at the start+ \* of the extended capability list. Use default, ro+ \* access, which will virtualize the id and next values.+ \*/+ if (cap\_id > PCI\_EXT\_CAP\_ID\_MAX)+ perm = &direct\_ro\_perms;+ else+ perm = &ecap\_perms[cap\_id]; - perm = &ecap\_perms[cap\_id]; cap\_start = vfio\_find\_cap\_start(vdev, \*ppos); } else { WARN\_ON(cap\_id > PCI\_CAP\_ID\_MAX); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:13:02 +0000



=== Content from git.kernel.org_83fc69e8_20250114_211427.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6c6502d944168cbd7e03a4a08ad6488f78d73485)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c6502d944168cbd7e03a4a08ad6488f78d73485)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c6502d944168cbd7e03a4a08ad6488f78d73485)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c6502d944168cbd7e03a4a08ad6488f78d73485)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Avihai Horon <avihaih@nvidia.com> | 2024-11-24 16:27:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:48 +0100 |
| commit | [6c6502d944168cbd7e03a4a08ad6488f78d73485](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c6502d944168cbd7e03a4a08ad6488f78d73485) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6c6502d944168cbd7e03a4a08ad6488f78d73485)) | |
| tree | [42fa41c7430f85cbc1e4bdc65a622bb7bf0407e2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c6502d944168cbd7e03a4a08ad6488f78d73485) | |
| parent | [ea3f18a680ec7e4a0391bc3a8a4252a4eb8828f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea3f18a680ec7e4a0391bc3a8a4252a4eb8828f8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c6502d944168cbd7e03a4a08ad6488f78d73485&id2=ea3f18a680ec7e4a0391bc3a8a4252a4eb8828f8)) | |
| download | [linux-6c6502d944168cbd7e03a4a08ad6488f78d73485.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6c6502d944168cbd7e03a4a08ad6488f78d73485.tar.gz) | |

vfio/pci: Properly hide first-in-list PCIe extended capability[ Upstream commit fe4bf8d0b6716a423b16495d55b35d3fe515905d ]
There are cases where a PCIe extended capability should be hidden from
the user. For example, an unknown capability (i.e., capability with ID
greater than PCI\_EXT\_CAP\_ID\_MAX) or a capability that is intentionally
chosen to be hidden from the user.
Hiding a capability is done by virtualizing and modifying the 'Next
Capability Offset' field of the previous capability so it points to the
capability after the one that should be hidden.
The special case where the first capability in the list should be hidden
is handled differently because there is no previous capability that can
be modified. In this case, the capability ID and version are zeroed
while leaving the next pointer intact. This hides the capability and
leaves an anchor for the rest of the capability list.
However, today, hiding the first capability in the list is not done
properly if the capability is unknown, as struct
vfio\_pci\_core\_device->pci\_config\_map is set to the capability ID during
initialization but the capability ID is not properly checked later when
used in vfio\_config\_do\_rw(). This leads to the following warning [1] and
to an out-of-bounds access to ecap\_perms array.
Fix it by checking cap\_id in vfio\_config\_do\_rw(), and if it is greater
than PCI\_EXT\_CAP\_ID\_MAX, use an alternative struct perm\_bits for direct
read only access instead of the ecap\_perms array.
Note that this is safe since the above is the only case where cap\_id can
exceed PCI\_EXT\_CAP\_ID\_MAX (except for the special capabilities, which
are already checked before).
[1]
WARNING: CPU: 118 PID: 5329 at drivers/vfio/pci/vfio\_pci\_config.c:1900 vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
CPU: 118 UID: 0 PID: 5329 Comm: simx-qemu-syste Not tainted 6.12.0+ #1
(snip)
Call Trace:
<TASK>
? show\_regs+0x69/0x80
? \_\_warn+0x8d/0x140
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? report\_bug+0x18f/0x1a0
? handle\_bug+0x63/0xa0
? exc\_invalid\_op+0x19/0x70
? asm\_exc\_invalid\_op+0x1b/0x20
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? vfio\_pci\_config\_rw+0x244/0x430 [vfio\_pci\_core]
vfio\_pci\_rw+0x101/0x1b0 [vfio\_pci\_core]
vfio\_pci\_core\_read+0x1d/0x30 [vfio\_pci\_core]
vfio\_device\_fops\_read+0x27/0x40 [vfio]
vfs\_read+0xbd/0x340
? vfio\_device\_fops\_unl\_ioctl+0xbb/0x740 [vfio]
? \_\_rseq\_handle\_notify\_resume+0xa4/0x4b0
\_\_x64\_sys\_pread64+0x96/0xc0
x64\_sys\_call+0x1c3d/0x20d0
do\_syscall\_64+0x4d/0x120
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Signed-off-by: Avihai Horon <avihaih@nvidia.com>
Reviewed-by: Yi Liu <yi.l.liu@intel.com>
Tested-by: Yi Liu <yi.l.liu@intel.com>
Link: [https://lore.kernel.org/r/20241124142739.21698-1-avihaih@nvidia.com](https://lore.kernel.org/r/20241124142739.21698-1-avihaih%40nvidia.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c6502d944168cbd7e03a4a08ad6488f78d73485)

| -rw-r--r-- | [drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_config.c?id=6c6502d944168cbd7e03a4a08ad6488f78d73485) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/vfio/pci/vfio\_pci\_config.c b/drivers/vfio/pci/vfio\_pci\_config.cindex 523e0144c86fab..7902e1ec0fef2f 100644--- a/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=ea3f18a680ec7e4a0391bc3a8a4252a4eb8828f8)+++ b/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=6c6502d944168cbd7e03a4a08ad6488f78d73485)@@ -312,6 +312,10 @@ static int vfio\_virt\_config\_read(struct vfio\_pci\_core\_device \*vdev, int pos, return count; } +static struct perm\_bits direct\_ro\_perms = {+ .readfn = vfio\_direct\_config\_read,+};+ /\* Default capability regions to read-only, no-virtualization \*/ static struct perm\_bits cap\_perms[PCI\_CAP\_ID\_MAX + 1] = { [0 ... PCI\_CAP\_ID\_MAX] = { .readfn = vfio\_direct\_config\_read }@@ -1890,9 +1894,17 @@ static ssize\_t vfio\_config\_do\_rw(struct vfio\_pci\_core\_device \*vdev, char \_\_user cap\_start = \*ppos; } else { if (\*ppos >= PCI\_CFG\_SPACE\_SIZE) {- WARN\_ON(cap\_id > PCI\_EXT\_CAP\_ID\_MAX);+ /\*+ \* We can get a cap\_id that exceeds PCI\_EXT\_CAP\_ID\_MAX+ \* if we're hiding an unknown capability at the start+ \* of the extended capability list. Use default, ro+ \* access, which will virtualize the id and next values.+ \*/+ if (cap\_id > PCI\_EXT\_CAP\_ID\_MAX)+ perm = &direct\_ro\_perms;+ else+ perm = &ecap\_perms[cap\_id]; - perm = &ecap\_perms[cap\_id]; cap\_start = vfio\_find\_cap\_start(vdev, \*ppos); } else { WARN\_ON(cap\_id > PCI\_CAP\_ID\_MAX); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:13:04 +0000



=== Content from git.kernel.org_ae2554a7_20250114_211424.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=06f2fcf49854ad05a09d09e0dbee6544fff04695)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06f2fcf49854ad05a09d09e0dbee6544fff04695)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06f2fcf49854ad05a09d09e0dbee6544fff04695)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06f2fcf49854ad05a09d09e0dbee6544fff04695)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Avihai Horon <avihaih@nvidia.com> | 2024-11-24 16:27:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:31 +0100 |
| commit | [06f2fcf49854ad05a09d09e0dbee6544fff04695](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06f2fcf49854ad05a09d09e0dbee6544fff04695) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=06f2fcf49854ad05a09d09e0dbee6544fff04695)) | |
| tree | [4f9c24990f64e9623c982153210a06fad4167d8b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06f2fcf49854ad05a09d09e0dbee6544fff04695) | |
| parent | [1f7b85e5ffd814a111ff38c3e619c7bb8ffafd02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f7b85e5ffd814a111ff38c3e619c7bb8ffafd02) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06f2fcf49854ad05a09d09e0dbee6544fff04695&id2=1f7b85e5ffd814a111ff38c3e619c7bb8ffafd02)) | |
| download | [linux-06f2fcf49854ad05a09d09e0dbee6544fff04695.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-06f2fcf49854ad05a09d09e0dbee6544fff04695.tar.gz) | |

vfio/pci: Properly hide first-in-list PCIe extended capability[ Upstream commit fe4bf8d0b6716a423b16495d55b35d3fe515905d ]
There are cases where a PCIe extended capability should be hidden from
the user. For example, an unknown capability (i.e., capability with ID
greater than PCI\_EXT\_CAP\_ID\_MAX) or a capability that is intentionally
chosen to be hidden from the user.
Hiding a capability is done by virtualizing and modifying the 'Next
Capability Offset' field of the previous capability so it points to the
capability after the one that should be hidden.
The special case where the first capability in the list should be hidden
is handled differently because there is no previous capability that can
be modified. In this case, the capability ID and version are zeroed
while leaving the next pointer intact. This hides the capability and
leaves an anchor for the rest of the capability list.
However, today, hiding the first capability in the list is not done
properly if the capability is unknown, as struct
vfio\_pci\_core\_device->pci\_config\_map is set to the capability ID during
initialization but the capability ID is not properly checked later when
used in vfio\_config\_do\_rw(). This leads to the following warning [1] and
to an out-of-bounds access to ecap\_perms array.
Fix it by checking cap\_id in vfio\_config\_do\_rw(), and if it is greater
than PCI\_EXT\_CAP\_ID\_MAX, use an alternative struct perm\_bits for direct
read only access instead of the ecap\_perms array.
Note that this is safe since the above is the only case where cap\_id can
exceed PCI\_EXT\_CAP\_ID\_MAX (except for the special capabilities, which
are already checked before).
[1]
WARNING: CPU: 118 PID: 5329 at drivers/vfio/pci/vfio\_pci\_config.c:1900 vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
CPU: 118 UID: 0 PID: 5329 Comm: simx-qemu-syste Not tainted 6.12.0+ #1
(snip)
Call Trace:
<TASK>
? show\_regs+0x69/0x80
? \_\_warn+0x8d/0x140
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? report\_bug+0x18f/0x1a0
? handle\_bug+0x63/0xa0
? exc\_invalid\_op+0x19/0x70
? asm\_exc\_invalid\_op+0x1b/0x20
? vfio\_pci\_config\_rw+0x395/0x430 [vfio\_pci\_core]
? vfio\_pci\_config\_rw+0x244/0x430 [vfio\_pci\_core]
vfio\_pci\_rw+0x101/0x1b0 [vfio\_pci\_core]
vfio\_pci\_core\_read+0x1d/0x30 [vfio\_pci\_core]
vfio\_device\_fops\_read+0x27/0x40 [vfio]
vfs\_read+0xbd/0x340
? vfio\_device\_fops\_unl\_ioctl+0xbb/0x740 [vfio]
? \_\_rseq\_handle\_notify\_resume+0xa4/0x4b0
\_\_x64\_sys\_pread64+0x96/0xc0
x64\_sys\_call+0x1c3d/0x20d0
do\_syscall\_64+0x4d/0x120
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Signed-off-by: Avihai Horon <avihaih@nvidia.com>
Reviewed-by: Yi Liu <yi.l.liu@intel.com>
Tested-by: Yi Liu <yi.l.liu@intel.com>
Link: [https://lore.kernel.org/r/20241124142739.21698-1-avihaih@nvidia.com](https://lore.kernel.org/r/20241124142739.21698-1-avihaih%40nvidia.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06f2fcf49854ad05a09d09e0dbee6544fff04695)

| -rw-r--r-- | [drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_config.c?id=06f2fcf49854ad05a09d09e0dbee6544fff04695) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/vfio/pci/vfio\_pci\_config.c b/drivers/vfio/pci/vfio\_pci\_config.cindex 7e2e62ab0869cf..a2ad4f7c716bf3 100644--- a/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=1f7b85e5ffd814a111ff38c3e619c7bb8ffafd02)+++ b/[drivers/vfio/pci/vfio\_pci\_config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_config.c?id=06f2fcf49854ad05a09d09e0dbee6544fff04695)@@ -313,6 +313,10 @@ static int vfio\_virt\_config\_read(struct vfio\_pci\_core\_device \*vdev, int pos, return count; } +static struct perm\_bits direct\_ro\_perms = {+ .readfn = vfio\_direct\_config\_read,+};+ /\* Default capability regions to read-only, no-virtualization \*/ static struct perm\_bits cap\_perms[PCI\_CAP\_ID\_MAX + 1] = { [0 ... PCI\_CAP\_ID\_MAX] = { .readfn = vfio\_direct\_config\_read }@@ -1897,9 +1901,17 @@ static ssize\_t vfio\_config\_do\_rw(struct vfio\_pci\_core\_device \*vdev, char \_\_user cap\_start = \*ppos; } else { if (\*ppos >= PCI\_CFG\_SPACE\_SIZE) {- WARN\_ON(cap\_id > PCI\_EXT\_CAP\_ID\_MAX);+ /\*+ \* We can get a cap\_id that exceeds PCI\_EXT\_CAP\_ID\_MAX+ \* if we're hiding an unknown capability at the start+ \* of the extended capability list. Use default, ro+ \* access, which will virtualize the id and next values.+ \*/+ if (cap\_id > PCI\_EXT\_CAP\_ID\_MAX)+ perm = &direct\_ro\_perms;+ else+ perm = &ecap\_perms[cap\_id]; - perm = &ecap\_perms[cap\_id]; cap\_start = vfio\_find\_cap\_start(vdev, \*ppos); } else { WARN\_ON(cap\_id > PCI\_CAP\_ID\_MAX); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:13:01 +0000


