=== Content from git.kernel.org_39a5db81_20250114_184443.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wang Liang <wangliang74@huawei.com> | 2024-11-07 10:34:05 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:39:47 +0100 |
| commit | [d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6)) | |
| tree | [9112b62ef12d2e76f2bcf8fa28eb309824a20fb9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6) | |
| parent | [bbf8bc7e75863942028131ae39c23118f62de6c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbf8bc7e75863942028131ae39c23118f62de6c0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6&id2=bbf8bc7e75863942028131ae39c23118f62de6c0)) | |
| download | [linux-d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6.tar.gz) | |

net: fix data-races around sk->sk\_forward\_alloc[ Upstream commit 073d89808c065ac4c672c0a613a71b27a80691cb ]
Syzkaller reported this warning:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 16 at net/ipv4/af\_inet.c:156 inet\_sock\_destruct+0x1c5/0x1e0
Modules linked in:
CPU: 0 UID: 0 PID: 16 Comm: ksoftirqd/0 Not tainted 6.12.0-rc5 #26
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
RIP: 0010:inet\_sock\_destruct+0x1c5/0x1e0
Code: 24 12 4c 89 e2 5b 48 c7 c7 98 ec bb 82 41 5c e9 d1 18 17 ff 4c 89 e6 5b 48 c7 c7 d0 ec bb 82 41 5c e9 bf 18 17 ff 0f 0b eb 83 <0f> 0b eb 97 0f 0b eb 87 0f 0b e9 68 ff ff ff 66 66 2e 0f 1f 84 00
RSP: 0018:ffffc9000008bd90 EFLAGS: 00010206
RAX: 0000000000000300 RBX: ffff88810b172a90 RCX: 0000000000000007
RDX: 0000000000000002 RSI: 0000000000000300 RDI: ffff88810b172a00
RBP: ffff88810b172a00 R08: ffff888104273c00 R09: 0000000000100007
R10: 0000000000020000 R11: 0000000000000006 R12: ffff88810b172a00
R13: 0000000000000004 R14: 0000000000000000 R15: ffff888237c31f78
FS: 0000000000000000(0000) GS:ffff888237c00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ffc63fecac8 CR3: 000000000342e000 CR4: 00000000000006f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
? \_\_warn+0x88/0x130
? inet\_sock\_destruct+0x1c5/0x1e0
? report\_bug+0x18e/0x1a0
? handle\_bug+0x53/0x90
? exc\_invalid\_op+0x18/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? inet\_sock\_destruct+0x1c5/0x1e0
\_\_sk\_destruct+0x2a/0x200
rcu\_do\_batch+0x1aa/0x530
? rcu\_do\_batch+0x13b/0x530
rcu\_core+0x159/0x2f0
handle\_softirqs+0xd3/0x2b0
? \_\_pfx\_smpboot\_thread\_fn+0x10/0x10
run\_ksoftirqd+0x25/0x30
smpboot\_thread\_fn+0xdd/0x1d0
kthread+0xd3/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x34/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
---[ end trace 0000000000000000 ]---
Its possible that two threads call tcp\_v6\_do\_rcv()/sk\_forward\_alloc\_add()
concurrently when sk->sk\_state == TCP\_LISTEN with sk->sk\_lock unlocked,
which triggers a data-race around sk->sk\_forward\_alloc:
tcp\_v6\_rcv
tcp\_v6\_do\_rcv
skb\_clone\_and\_charge\_r
sk\_rmem\_schedule
\_\_sk\_mem\_schedule
sk\_forward\_alloc\_add()
skb\_set\_owner\_r
sk\_mem\_charge
sk\_forward\_alloc\_add()
\_\_kfree\_skb
skb\_release\_all
skb\_release\_head\_state
sock\_rfree
sk\_mem\_uncharge
sk\_forward\_alloc\_add()
sk\_mem\_reclaim
// set local var reclaimable
\_\_sk\_mem\_reclaim
sk\_forward\_alloc\_add()
In this syzkaller testcase, two threads call
tcp\_v6\_do\_rcv() with skb->truesize=768, the sk\_forward\_alloc changes like
this:
(cpu 1) | (cpu 2) | sk\_forward\_alloc
... | ... | 0
\_\_sk\_mem\_schedule() | | +4096 = 4096
| \_\_sk\_mem\_schedule() | +4096 = 8192
sk\_mem\_charge() | | -768 = 7424
| sk\_mem\_charge() | -768 = 6656
... | ... |
sk\_mem\_uncharge() | | +768 = 7424
reclaimable=7424 | |
| sk\_mem\_uncharge() | +768 = 8192
| reclaimable=8192 |
\_\_sk\_mem\_reclaim() | | -4096 = 4096
| \_\_sk\_mem\_reclaim() | -8192 = -4096 != 0
The skb\_clone\_and\_charge\_r() should not be called in tcp\_v6\_do\_rcv() when
sk->sk\_state is TCP\_LISTEN, it happens later in tcp\_v6\_syn\_recv\_sock().
Fix the same issue in dccp\_v6\_do\_rcv().
Suggested-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Fixes: e994b2f0fb92 ("tcp: do not lock listener to process SYN packets")
Signed-off-by: Wang Liang <wangliang74@huawei.com>
Link: [https://patch.msgid.link/20241107023405.889239-1-wangliang74@huawei.com](https://patch.msgid.link/20241107023405.889239-1-wangliang74%40huawei.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6)

| -rw-r--r-- | [net/dccp/ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/dccp/ipv6.c?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv6/tcp\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/tcp_ipv6.c?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 2 insertions, 4 deletions

| diff --git a/net/dccp/ipv6.c b/net/dccp/ipv6.cindex da5dba120bc9a5..d6649246188d72 100644--- a/[net/dccp/ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dccp/ipv6.c?id=bbf8bc7e75863942028131ae39c23118f62de6c0)+++ b/[net/dccp/ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dccp/ipv6.c?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6)@@ -618,7 +618,7 @@ static int dccp\_v6\_do\_rcv(struct sock \*sk, struct sk\_buff \*skb) by tcp. Feel free to propose better solution. --ANK (980728) \*/- if (np->rxopt.all)+ if (np->rxopt.all && sk->sk\_state != DCCP\_LISTEN) opt\_skb = skb\_clone\_and\_charge\_r(skb, sk);  if (sk->sk\_state == DCCP\_OPEN) { /\* Fast path \*/diff --git a/net/ipv6/tcp\_ipv6.c b/net/ipv6/tcp\_ipv6.cindex 200fea92f12fc9..84cd46311da092 100644--- a/[net/ipv6/tcp\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/tcp_ipv6.c?id=bbf8bc7e75863942028131ae39c23118f62de6c0)+++ b/[net/ipv6/tcp\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/tcp_ipv6.c?id=d285eb9d0641c8344f2836081b4ccb7b3c5cc1b6)@@ -1617,7 +1617,7 @@ int tcp\_v6\_do\_rcv(struct sock \*sk, struct sk\_buff \*skb) by tcp. Feel free to propose better solution. --ANK (980728) \*/- if (np->rxopt.all)+ if (np->rxopt.all && sk->sk\_state != TCP\_LISTEN) opt\_skb = skb\_clone\_and\_charge\_r(skb, sk);  if (sk->sk\_state == TCP\_ESTABLISHED) { /\* Fast path \*/@@ -1655,8 +1655,6 @@ int tcp\_v6\_do\_rcv(struct sock \*sk, struct sk\_buff \*skb) if (reason) goto reset; }- if (opt\_skb)- \_\_kfree\_skb(opt\_skb); return 0; } } else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:43:20 +0000



=== Content from git.kernel.org_9824f6ea_20250114_184442.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=073d89808c065ac4c672c0a613a71b27a80691cb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=073d89808c065ac4c672c0a613a71b27a80691cb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=073d89808c065ac4c672c0a613a71b27a80691cb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=073d89808c065ac4c672c0a613a71b27a80691cb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wang Liang <wangliang74@huawei.com> | 2024-11-07 10:34:05 +0800 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-11-11 15:29:33 -0800 |
| commit | [073d89808c065ac4c672c0a613a71b27a80691cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=073d89808c065ac4c672c0a613a71b27a80691cb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=073d89808c065ac4c672c0a613a71b27a80691cb)) | |
| tree | [e1a21477ceeed5aebf4b9d92f76e97565b324248](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=073d89808c065ac4c672c0a613a71b27a80691cb) | |
| parent | [252e01e68241d33bfe0ed1fc333220d9bd8b06df](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=252e01e68241d33bfe0ed1fc333220d9bd8b06df) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=073d89808c065ac4c672c0a613a71b27a80691cb&id2=252e01e68241d33bfe0ed1fc333220d9bd8b06df)) | |
| download | [linux-073d89808c065ac4c672c0a613a71b27a80691cb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-073d89808c065ac4c672c0a613a71b27a80691cb.tar.gz) | |

net: fix data-races around sk->sk\_forward\_allocSyzkaller reported this warning:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 16 at net/ipv4/af\_inet.c:156 inet\_sock\_destruct+0x1c5/0x1e0
Modules linked in:
CPU: 0 UID: 0 PID: 16 Comm: ksoftirqd/0 Not tainted 6.12.0-rc5 #26
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
RIP: 0010:inet\_sock\_destruct+0x1c5/0x1e0
Code: 24 12 4c 89 e2 5b 48 c7 c7 98 ec bb 82 41 5c e9 d1 18 17 ff 4c 89 e6 5b 48 c7 c7 d0 ec bb 82 41 5c e9 bf 18 17 ff 0f 0b eb 83 <0f> 0b eb 97 0f 0b eb 87 0f 0b e9 68 ff ff ff 66 66 2e 0f 1f 84 00
RSP: 0018:ffffc9000008bd90 EFLAGS: 00010206
RAX: 0000000000000300 RBX: ffff88810b172a90 RCX: 0000000000000007
RDX: 0000000000000002 RSI: 0000000000000300 RDI: ffff88810b172a00
RBP: ffff88810b172a00 R08: ffff888104273c00 R09: 0000000000100007
R10: 0000000000020000 R11: 0000000000000006 R12: ffff88810b172a00
R13: 0000000000000004 R14: 0000000000000000 R15: ffff888237c31f78
FS: 0000000000000000(0000) GS:ffff888237c00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ffc63fecac8 CR3: 000000000342e000 CR4: 00000000000006f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
? \_\_warn+0x88/0x130
? inet\_sock\_destruct+0x1c5/0x1e0
? report\_bug+0x18e/0x1a0
? handle\_bug+0x53/0x90
? exc\_invalid\_op+0x18/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? inet\_sock\_destruct+0x1c5/0x1e0
\_\_sk\_destruct+0x2a/0x200
rcu\_do\_batch+0x1aa/0x530
? rcu\_do\_batch+0x13b/0x530
rcu\_core+0x159/0x2f0
handle\_softirqs+0xd3/0x2b0
? \_\_pfx\_smpboot\_thread\_fn+0x10/0x10
run\_ksoftirqd+0x25/0x30
smpboot\_thread\_fn+0xdd/0x1d0
kthread+0xd3/0x100
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x34/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
---[ end trace 0000000000000000 ]---
Its possible that two threads call tcp\_v6\_do\_rcv()/sk\_forward\_alloc\_add()
concurrently when sk->sk\_state == TCP\_LISTEN with sk->sk\_lock unlocked,
which triggers a data-race around sk->sk\_forward\_alloc:
tcp\_v6\_rcv
tcp\_v6\_do\_rcv
skb\_clone\_and\_charge\_r
sk\_rmem\_schedule
\_\_sk\_mem\_schedule
sk\_forward\_alloc\_add()
skb\_set\_owner\_r
sk\_mem\_charge
sk\_forward\_alloc\_add()
\_\_kfree\_skb
skb\_release\_all
skb\_release\_head\_state
sock\_rfree
sk\_mem\_uncharge
sk\_forward\_alloc\_add()
sk\_mem\_reclaim
// set local var reclaimable
\_\_sk\_mem\_reclaim
sk\_forward\_alloc\_add()
In this syzkaller testcase, two threads call
tcp\_v6\_do\_rcv() with skb->truesize=768, the sk\_forward\_alloc changes like
this:
(cpu 1) | (cpu 2) | sk\_forward\_alloc
... | ... | 0
\_\_sk\_mem\_schedule() | | +4096 = 4096
| \_\_sk\_mem\_schedule() | +4096 = 8192
sk\_mem\_charge() | | -768 = 7424
| sk\_mem\_charge() | -768 = 6656
... | ... |
sk\_mem\_uncharge() | | +768 = 7424
reclaimable=7424 | |
| sk\_mem\_uncharge() | +768 = 8192
| reclaimable=8192 |
\_\_sk\_mem\_reclaim() | | -4096 = 4096
| \_\_sk\_mem\_reclaim() | -8192 = -4096 != 0
The skb\_clone\_and\_charge\_r() should not be called in tcp\_v6\_do\_rcv() when
sk->sk\_state is TCP\_LISTEN, it happens later in tcp\_v6\_syn\_recv\_sock().
Fix the same issue in dccp\_v6\_do\_rcv().
Suggested-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Fixes: e994b2f0fb92 ("tcp: do not lock listener to process SYN packets")
Signed-off-by: Wang Liang <wangliang74@huawei.com>
Link: [https://patch.msgid.link/20241107023405.889239-1-wangliang74@huawei.com](https://patch.msgid.link/20241107023405.889239-1-wangliang74%40huawei.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=073d89808c065ac4c672c0a613a71b27a80691cb)

| -rw-r--r-- | [net/dccp/ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/dccp/ipv6.c?id=073d89808c065ac4c672c0a613a71b27a80691cb) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv6/tcp\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/tcp_ipv6.c?id=073d89808c065ac4c672c0a613a71b27a80691cb) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 2 insertions, 4 deletions

| diff --git a/net/dccp/ipv6.c b/net/dccp/ipv6.cindex da5dba120bc9a5..d6649246188d72 100644--- a/[net/dccp/ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dccp/ipv6.c?id=252e01e68241d33bfe0ed1fc333220d9bd8b06df)+++ b/[net/dccp/ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/dccp/ipv6.c?id=073d89808c065ac4c672c0a613a71b27a80691cb)@@ -618,7 +618,7 @@ static int dccp\_v6\_do\_rcv(struct sock \*sk, struct sk\_buff \*skb) by tcp. Feel free to propose better solution. --ANK (980728) \*/- if (np->rxopt.all)+ if (np->rxopt.all && sk->sk\_state != DCCP\_LISTEN) opt\_skb = skb\_clone\_and\_charge\_r(skb, sk);  if (sk->sk\_state == DCCP\_OPEN) { /\* Fast path \*/diff --git a/net/ipv6/tcp\_ipv6.c b/net/ipv6/tcp\_ipv6.cindex d71ab4e1efe1c6..c9de5ef8f26750 100644--- a/[net/ipv6/tcp\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/tcp_ipv6.c?id=252e01e68241d33bfe0ed1fc333220d9bd8b06df)+++ b/[net/ipv6/tcp\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/tcp_ipv6.c?id=073d89808c065ac4c672c0a613a71b27a80691cb)@@ -1618,7 +1618,7 @@ int tcp\_v6\_do\_rcv(struct sock \*sk, struct sk\_buff \*skb) by tcp. Feel free to propose better solution. --ANK (980728) \*/- if (np->rxopt.all)+ if (np->rxopt.all && sk->sk\_state != TCP\_LISTEN) opt\_skb = skb\_clone\_and\_charge\_r(skb, sk);  if (sk->sk\_state == TCP\_ESTABLISHED) { /\* Fast path \*/@@ -1656,8 +1656,6 @@ int tcp\_v6\_do\_rcv(struct sock \*sk, struct sk\_buff \*skb) if (reason) goto reset; }- if (opt\_skb)- \_\_kfree\_skb(opt\_skb); return 0; } } else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:24:55 +0000


