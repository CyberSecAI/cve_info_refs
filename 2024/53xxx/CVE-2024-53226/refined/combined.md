=== Content from git.kernel.org_b3b4ddae_20250114_222942.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b526d17eed850352d880b93b9bf20b93006bd92)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b526d17eed850352d880b93b9bf20b93006bd92)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b526d17eed850352d880b93b9bf20b93006bd92)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b526d17eed850352d880b93b9bf20b93006bd92)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Junxian Huang <huangjunxian6@hisilicon.com> | 2024-11-08 15:57:43 +0800 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2024-11-10 09:29:53 -0500 |
| commit | [6b526d17eed850352d880b93b9bf20b93006bd92](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b526d17eed850352d880b93b9bf20b93006bd92) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b526d17eed850352d880b93b9bf20b93006bd92)) | |
| tree | [2fa1cd211828bf2f144fb5b7fa35a7043b54c2a0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b526d17eed850352d880b93b9bf20b93006bd92) | |
| parent | [5dbcb1c1900f45182b5651c89257c272f1f3ead7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5dbcb1c1900f45182b5651c89257c272f1f3ead7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b526d17eed850352d880b93b9bf20b93006bd92&id2=5dbcb1c1900f45182b5651c89257c272f1f3ead7)) | |
| download | [linux-6b526d17eed850352d880b93b9bf20b93006bd92.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b526d17eed850352d880b93b9bf20b93006bd92.tar.gz) | |

RDMA/hns: Fix NULL pointer derefernce in hns\_roce\_map\_mr\_sg()ib\_map\_mr\_sg() allows ULPs to specify NULL as the sg\_offset argument.
The driver needs to check whether it is a NULL pointer before
dereferencing it.
Fixes: d387d4b54eb8 ("RDMA/hns: Fix missing pagesize and alignment check in FRMR")
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b526d17eed850352d880b93b9bf20b93006bd92)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=6b526d17eed850352d880b93b9bf20b93006bd92) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex b3f4327d0e64af..bf30b3a65a9ba9 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=5dbcb1c1900f45182b5651c89257c272f1f3ead7)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=6b526d17eed850352d880b93b9bf20b93006bd92)@@ -435,15 +435,16 @@ static int hns\_roce\_set\_page(struct ib\_mr \*ibmr, u64 addr) }  int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents,- unsigned int \*sg\_offset)+ unsigned int \*sg\_offset\_p) {+ unsigned int sg\_offset = sg\_offset\_p ? \*sg\_offset\_p : 0; struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibmr->device); struct ib\_device \*ibdev = &hr\_dev->ib\_dev; struct hns\_roce\_mr \*mr = to\_hr\_mr(ibmr); struct hns\_roce\_mtr \*mtr = &mr->pbl\_mtr; int ret, sg\_num = 0; - if (!IS\_ALIGNED(\*sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) ||+ if (!IS\_ALIGNED(sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) || ibmr->page\_size < HNS\_HW\_PAGE\_SIZE || ibmr->page\_size > HNS\_HW\_MAX\_PAGE\_SIZE) return sg\_num;@@ -454,7 +455,7 @@ int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents, if (!mr->page\_list) return sg\_num; - sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset, hns\_roce\_set\_page);+ sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset\_p, hns\_roce\_set\_page); if (sg\_num < 1) { ibdev\_err(ibdev, "failed to store sg pages %u %u, cnt = %d.\n", mr->npages, mr->pbl\_mtr.hem\_cfg.buf\_pg\_count, sg\_num); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:28:19 +0000



=== Content from git.kernel.org_bceb026f_20250114_222941.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Junxian Huang <huangjunxian6@hisilicon.com> | 2024-11-08 15:57:43 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:20 +0100 |
| commit | [6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7)) | |
| tree | [11846d438ccb2c9cdfe6ca5843ede87c69038a78](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7) | |
| parent | [451d57b22b4a68890ba1ee1a57f4d4069f35083e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=451d57b22b4a68890ba1ee1a57f4d4069f35083e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7&id2=451d57b22b4a68890ba1ee1a57f4d4069f35083e)) | |
| download | [linux-6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7.tar.gz) | |

RDMA/hns: Fix NULL pointer derefernce in hns\_roce\_map\_mr\_sg()[ Upstream commit 6b526d17eed850352d880b93b9bf20b93006bd92 ]
ib\_map\_mr\_sg() allows ULPs to specify NULL as the sg\_offset argument.
The driver needs to check whether it is a NULL pointer before
dereferencing it.
Fixes: d387d4b54eb8 ("RDMA/hns: Fix missing pagesize and alignment check in FRMR")
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex b053f2f43dacd4..7f29a55d378f02 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=451d57b22b4a68890ba1ee1a57f4d4069f35083e)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=6b0d7d6e6883d0ec70cd7b5a02c47c003d5defe7)@@ -415,15 +415,16 @@ static int hns\_roce\_set\_page(struct ib\_mr \*ibmr, u64 addr) }  int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents,- unsigned int \*sg\_offset)+ unsigned int \*sg\_offset\_p) {+ unsigned int sg\_offset = sg\_offset\_p ? \*sg\_offset\_p : 0; struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibmr->device); struct ib\_device \*ibdev = &hr\_dev->ib\_dev; struct hns\_roce\_mr \*mr = to\_hr\_mr(ibmr); struct hns\_roce\_mtr \*mtr = &mr->pbl\_mtr; int ret, sg\_num = 0; - if (!IS\_ALIGNED(\*sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) ||+ if (!IS\_ALIGNED(sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) || ibmr->page\_size < HNS\_HW\_PAGE\_SIZE || ibmr->page\_size > HNS\_HW\_MAX\_PAGE\_SIZE) return sg\_num;@@ -434,7 +435,7 @@ int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents, if (!mr->page\_list) return sg\_num; - sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset, hns\_roce\_set\_page);+ sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset\_p, hns\_roce\_set\_page); if (sg\_num < 1) { ibdev\_err(ibdev, "failed to store sg pages %u %u, cnt = %d.\n", mr->npages, mr->pbl\_mtr.hem\_cfg.buf\_pg\_count, sg\_num); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:28:18 +0000



=== Content from git.kernel.org_aff661d9_20250114_222940.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Junxian Huang <huangjunxian6@hisilicon.com> | 2024-11-08 15:57:43 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:03 +0100 |
| commit | [35f5b68f63aac61d30ce0b0c6beb09b8845a3e65](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65)) | |
| tree | [d139180a298065ae57e9b3f552c6187298e51274](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65) | |
| parent | [ef0613269a4fa5a0e6b245613ceb961502681a09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef0613269a4fa5a0e6b245613ceb961502681a09) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65&id2=ef0613269a4fa5a0e6b245613ceb961502681a09)) | |
| download | [linux-35f5b68f63aac61d30ce0b0c6beb09b8845a3e65.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35f5b68f63aac61d30ce0b0c6beb09b8845a3e65.tar.gz) | |

RDMA/hns: Fix NULL pointer derefernce in hns\_roce\_map\_mr\_sg()[ Upstream commit 6b526d17eed850352d880b93b9bf20b93006bd92 ]
ib\_map\_mr\_sg() allows ULPs to specify NULL as the sg\_offset argument.
The driver needs to check whether it is a NULL pointer before
dereferencing it.
Fixes: d387d4b54eb8 ("RDMA/hns: Fix missing pagesize and alignment check in FRMR")
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex 938db3f5aabe6b..79a59d5180cccd 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=ef0613269a4fa5a0e6b245613ceb961502681a09)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=35f5b68f63aac61d30ce0b0c6beb09b8845a3e65)@@ -438,15 +438,16 @@ static int hns\_roce\_set\_page(struct ib\_mr \*ibmr, u64 addr) }  int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents,- unsigned int \*sg\_offset)+ unsigned int \*sg\_offset\_p) {+ unsigned int sg\_offset = sg\_offset\_p ? \*sg\_offset\_p : 0; struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibmr->device); struct ib\_device \*ibdev = &hr\_dev->ib\_dev; struct hns\_roce\_mr \*mr = to\_hr\_mr(ibmr); struct hns\_roce\_mtr \*mtr = &mr->pbl\_mtr; int ret, sg\_num = 0; - if (!IS\_ALIGNED(\*sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) ||+ if (!IS\_ALIGNED(sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) || ibmr->page\_size < HNS\_HW\_PAGE\_SIZE || ibmr->page\_size > HNS\_HW\_MAX\_PAGE\_SIZE) return sg\_num;@@ -457,7 +458,7 @@ int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents, if (!mr->page\_list) return sg\_num; - sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset, hns\_roce\_set\_page);+ sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset\_p, hns\_roce\_set\_page); if (sg\_num < 1) { ibdev\_err(ibdev, "failed to store sg pages %u %u, cnt = %d.\n", mr->npages, mr->pbl\_mtr.hem\_cfg.buf\_pg\_count, sg\_num); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:28:17 +0000



=== Content from git.kernel.org_4c79892d_20250114_222943.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Junxian Huang <huangjunxian6@hisilicon.com> | 2024-11-08 15:57:43 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:12 +0100 |
| commit | [8c269bb2cc666ca580271e1a8136c63ac9162e1e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e)) | |
| tree | [cd3c5c343a13833bd7f06c2a8b191a9c706ba2c4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e) | |
| parent | [c1bc296815085375b6f868ffeb07ce62d2f11fb6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1bc296815085375b6f868ffeb07ce62d2f11fb6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e&id2=c1bc296815085375b6f868ffeb07ce62d2f11fb6)) | |
| download | [linux-8c269bb2cc666ca580271e1a8136c63ac9162e1e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8c269bb2cc666ca580271e1a8136c63ac9162e1e.tar.gz) | |

RDMA/hns: Fix NULL pointer derefernce in hns\_roce\_map\_mr\_sg()[ Upstream commit 6b526d17eed850352d880b93b9bf20b93006bd92 ]
ib\_map\_mr\_sg() allows ULPs to specify NULL as the sg\_offset argument.
The driver needs to check whether it is a NULL pointer before
dereferencing it.
Fixes: d387d4b54eb8 ("RDMA/hns: Fix missing pagesize and alignment check in FRMR")
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex b3f4327d0e64af..bf30b3a65a9ba9 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=c1bc296815085375b6f868ffeb07ce62d2f11fb6)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=8c269bb2cc666ca580271e1a8136c63ac9162e1e)@@ -435,15 +435,16 @@ static int hns\_roce\_set\_page(struct ib\_mr \*ibmr, u64 addr) }  int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents,- unsigned int \*sg\_offset)+ unsigned int \*sg\_offset\_p) {+ unsigned int sg\_offset = sg\_offset\_p ? \*sg\_offset\_p : 0; struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibmr->device); struct ib\_device \*ibdev = &hr\_dev->ib\_dev; struct hns\_roce\_mr \*mr = to\_hr\_mr(ibmr); struct hns\_roce\_mtr \*mtr = &mr->pbl\_mtr; int ret, sg\_num = 0; - if (!IS\_ALIGNED(\*sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) ||+ if (!IS\_ALIGNED(sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) || ibmr->page\_size < HNS\_HW\_PAGE\_SIZE || ibmr->page\_size > HNS\_HW\_MAX\_PAGE\_SIZE) return sg\_num;@@ -454,7 +455,7 @@ int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents, if (!mr->page\_list) return sg\_num; - sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset, hns\_roce\_set\_page);+ sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset\_p, hns\_roce\_set\_page); if (sg\_num < 1) { ibdev\_err(ibdev, "failed to store sg pages %u %u, cnt = %d.\n", mr->npages, mr->pbl\_mtr.hem\_cfg.buf\_pg\_count, sg\_num); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:28:20 +0000



=== Content from git.kernel.org_9b0fefe1_20250114_222942.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=71becb0e9df78a8d43dfd0efcef18c830a0af477)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=71becb0e9df78a8d43dfd0efcef18c830a0af477)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=71becb0e9df78a8d43dfd0efcef18c830a0af477)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=71becb0e9df78a8d43dfd0efcef18c830a0af477)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Junxian Huang <huangjunxian6@hisilicon.com> | 2024-11-08 15:57:43 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:40 +0100 |
| commit | [71becb0e9df78a8d43dfd0efcef18c830a0af477](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=71becb0e9df78a8d43dfd0efcef18c830a0af477) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=71becb0e9df78a8d43dfd0efcef18c830a0af477)) | |
| tree | [7472ae4ff727a05e1154f3dc66bf870322eae903](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=71becb0e9df78a8d43dfd0efcef18c830a0af477) | |
| parent | [ecc5802fd707d635e25dff935ba8b6bc81e730ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ecc5802fd707d635e25dff935ba8b6bc81e730ac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=71becb0e9df78a8d43dfd0efcef18c830a0af477&id2=ecc5802fd707d635e25dff935ba8b6bc81e730ac)) | |
| download | [linux-71becb0e9df78a8d43dfd0efcef18c830a0af477.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-71becb0e9df78a8d43dfd0efcef18c830a0af477.tar.gz) | |

RDMA/hns: Fix NULL pointer derefernce in hns\_roce\_map\_mr\_sg()[ Upstream commit 6b526d17eed850352d880b93b9bf20b93006bd92 ]
ib\_map\_mr\_sg() allows ULPs to specify NULL as the sg\_offset argument.
The driver needs to check whether it is a NULL pointer before
dereferencing it.
Fixes: d387d4b54eb8 ("RDMA/hns: Fix missing pagesize and alignment check in FRMR")
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=71becb0e9df78a8d43dfd0efcef18c830a0af477)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=71becb0e9df78a8d43dfd0efcef18c830a0af477) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex b3f4327d0e64af..bf30b3a65a9ba9 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=ecc5802fd707d635e25dff935ba8b6bc81e730ac)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=71becb0e9df78a8d43dfd0efcef18c830a0af477)@@ -435,15 +435,16 @@ static int hns\_roce\_set\_page(struct ib\_mr \*ibmr, u64 addr) }  int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents,- unsigned int \*sg\_offset)+ unsigned int \*sg\_offset\_p) {+ unsigned int sg\_offset = sg\_offset\_p ? \*sg\_offset\_p : 0; struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibmr->device); struct ib\_device \*ibdev = &hr\_dev->ib\_dev; struct hns\_roce\_mr \*mr = to\_hr\_mr(ibmr); struct hns\_roce\_mtr \*mtr = &mr->pbl\_mtr; int ret, sg\_num = 0; - if (!IS\_ALIGNED(\*sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) ||+ if (!IS\_ALIGNED(sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) || ibmr->page\_size < HNS\_HW\_PAGE\_SIZE || ibmr->page\_size > HNS\_HW\_MAX\_PAGE\_SIZE) return sg\_num;@@ -454,7 +455,7 @@ int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents, if (!mr->page\_list) return sg\_num; - sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset, hns\_roce\_set\_page);+ sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset\_p, hns\_roce\_set\_page); if (sg\_num < 1) { ibdev\_err(ibdev, "failed to store sg pages %u %u, cnt = %d.\n", mr->npages, mr->pbl\_mtr.hem\_cfg.buf\_pg\_count, sg\_num); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:28:19 +0000



=== Content from git.kernel.org_8567ab61_20250114_222940.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=52617e76f4963644db71dc0a17e998654dc0c7f4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=52617e76f4963644db71dc0a17e998654dc0c7f4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52617e76f4963644db71dc0a17e998654dc0c7f4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52617e76f4963644db71dc0a17e998654dc0c7f4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Junxian Huang <huangjunxian6@hisilicon.com> | 2024-11-08 15:57:43 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:41 +0100 |
| commit | [52617e76f4963644db71dc0a17e998654dc0c7f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52617e76f4963644db71dc0a17e998654dc0c7f4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=52617e76f4963644db71dc0a17e998654dc0c7f4)) | |
| tree | [511fbb1197083a0058fa9add47163a8e9f13c0c4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=52617e76f4963644db71dc0a17e998654dc0c7f4) | |
| parent | [630c6b9116dd0251a66f9be95e3042893a297b21](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=630c6b9116dd0251a66f9be95e3042893a297b21) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52617e76f4963644db71dc0a17e998654dc0c7f4&id2=630c6b9116dd0251a66f9be95e3042893a297b21)) | |
| download | [linux-52617e76f4963644db71dc0a17e998654dc0c7f4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-52617e76f4963644db71dc0a17e998654dc0c7f4.tar.gz) | |

RDMA/hns: Fix NULL pointer derefernce in hns\_roce\_map\_mr\_sg()[ Upstream commit 6b526d17eed850352d880b93b9bf20b93006bd92 ]
ib\_map\_mr\_sg() allows ULPs to specify NULL as the sg\_offset argument.
The driver needs to check whether it is a NULL pointer before
dereferencing it.
Fixes: d387d4b54eb8 ("RDMA/hns: Fix missing pagesize and alignment check in FRMR")
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52617e76f4963644db71dc0a17e998654dc0c7f4)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=52617e76f4963644db71dc0a17e998654dc0c7f4) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex b053f2f43dacd4..7f29a55d378f02 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=630c6b9116dd0251a66f9be95e3042893a297b21)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=52617e76f4963644db71dc0a17e998654dc0c7f4)@@ -415,15 +415,16 @@ static int hns\_roce\_set\_page(struct ib\_mr \*ibmr, u64 addr) }  int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents,- unsigned int \*sg\_offset)+ unsigned int \*sg\_offset\_p) {+ unsigned int sg\_offset = sg\_offset\_p ? \*sg\_offset\_p : 0; struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibmr->device); struct ib\_device \*ibdev = &hr\_dev->ib\_dev; struct hns\_roce\_mr \*mr = to\_hr\_mr(ibmr); struct hns\_roce\_mtr \*mtr = &mr->pbl\_mtr; int ret, sg\_num = 0; - if (!IS\_ALIGNED(\*sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) ||+ if (!IS\_ALIGNED(sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) || ibmr->page\_size < HNS\_HW\_PAGE\_SIZE || ibmr->page\_size > HNS\_HW\_MAX\_PAGE\_SIZE) return sg\_num;@@ -434,7 +435,7 @@ int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents, if (!mr->page\_list) return sg\_num; - sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset, hns\_roce\_set\_page);+ sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset\_p, hns\_roce\_set\_page); if (sg\_num < 1) { ibdev\_err(ibdev, "failed to store sg pages %u %u, cnt = %d.\n", mr->npages, mr->pbl\_mtr.hem\_cfg.buf\_pg\_count, sg\_num); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:28:18 +0000



=== Content from git.kernel.org_ee959e6a_20250114_222944.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bd715e191d444992d6ed124f15856da5c1cae2de)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bd715e191d444992d6ed124f15856da5c1cae2de)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd715e191d444992d6ed124f15856da5c1cae2de)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bd715e191d444992d6ed124f15856da5c1cae2de)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Junxian Huang <huangjunxian6@hisilicon.com> | 2024-11-08 15:57:43 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:59 +0100 |
| commit | [bd715e191d444992d6ed124f15856da5c1cae2de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd715e191d444992d6ed124f15856da5c1cae2de) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bd715e191d444992d6ed124f15856da5c1cae2de)) | |
| tree | [1bcd94b386dc40c390a0dbb470a3690281508fdd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bd715e191d444992d6ed124f15856da5c1cae2de) | |
| parent | [a4d2011cbe039b25024831427b60ab91ee247066](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4d2011cbe039b25024831427b60ab91ee247066) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bd715e191d444992d6ed124f15856da5c1cae2de&id2=a4d2011cbe039b25024831427b60ab91ee247066)) | |
| download | [linux-bd715e191d444992d6ed124f15856da5c1cae2de.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bd715e191d444992d6ed124f15856da5c1cae2de.tar.gz) | |

RDMA/hns: Fix NULL pointer derefernce in hns\_roce\_map\_mr\_sg()[ Upstream commit 6b526d17eed850352d880b93b9bf20b93006bd92 ]
ib\_map\_mr\_sg() allows ULPs to specify NULL as the sg\_offset argument.
The driver needs to check whether it is a NULL pointer before
dereferencing it.
Fixes: d387d4b54eb8 ("RDMA/hns: Fix missing pagesize and alignment check in FRMR")
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6@hisilicon.com](https://patch.msgid.link/20241108075743.2652258-3-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bd715e191d444992d6ed124f15856da5c1cae2de)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_mr.c?id=bd715e191d444992d6ed124f15856da5c1cae2de) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_mr.c b/drivers/infiniband/hw/hns/hns\_roce\_mr.cindex 5f038bd5571d16..b0623012586831 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=a4d2011cbe039b25024831427b60ab91ee247066)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_mr.c?id=bd715e191d444992d6ed124f15856da5c1cae2de)@@ -478,15 +478,16 @@ static int hns\_roce\_set\_page(struct ib\_mr \*ibmr, u64 addr) }  int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents,- unsigned int \*sg\_offset)+ unsigned int \*sg\_offset\_p) {+ unsigned int sg\_offset = sg\_offset\_p ? \*sg\_offset\_p : 0; struct hns\_roce\_dev \*hr\_dev = to\_hr\_dev(ibmr->device); struct ib\_device \*ibdev = &hr\_dev->ib\_dev; struct hns\_roce\_mr \*mr = to\_hr\_mr(ibmr); struct hns\_roce\_mtr \*mtr = &mr->pbl\_mtr; int ret, sg\_num = 0; - if (!IS\_ALIGNED(\*sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) ||+ if (!IS\_ALIGNED(sg\_offset, HNS\_ROCE\_FRMR\_ALIGN\_SIZE) || ibmr->page\_size < HNS\_HW\_PAGE\_SIZE || ibmr->page\_size > HNS\_HW\_MAX\_PAGE\_SIZE) return sg\_num;@@ -497,7 +498,7 @@ int hns\_roce\_map\_mr\_sg(struct ib\_mr \*ibmr, struct scatterlist \*sg, int sg\_nents, if (!mr->page\_list) return sg\_num; - sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset, hns\_roce\_set\_page);+ sg\_num = ib\_sg\_to\_pages(ibmr, sg, sg\_nents, sg\_offset\_p, hns\_roce\_set\_page); if (sg\_num < 1) { ibdev\_err(ibdev, "failed to store sg pages %u %u, cnt = %d.\n", mr->npages, mr->pbl\_mtr.hem\_cfg.buf\_pg\_count, sg\_num); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:28:21 +0000


