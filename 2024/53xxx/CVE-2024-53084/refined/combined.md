=== Content from git.kernel.org_b31e3294_20250114_210256.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cb86db12b290ed07d05df00d99fa150bb123e80e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cb86db12b290ed07d05df00d99fa150bb123e80e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb86db12b290ed07d05df00d99fa150bb123e80e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cb86db12b290ed07d05df00d99fa150bb123e80e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Brendan King <brendan.king@imgtec.com> | 2024-10-18 15:41:40 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:06 +0100 |
| commit | [cb86db12b290ed07d05df00d99fa150bb123e80e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb86db12b290ed07d05df00d99fa150bb123e80e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cb86db12b290ed07d05df00d99fa150bb123e80e)) | |
| tree | [9297d1889e1ab8518f7ceec1e95966669bd841e0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cb86db12b290ed07d05df00d99fa150bb123e80e) | |
| parent | [f949be64bc4108b875b47ac745a2d25b2780f1ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f949be64bc4108b875b47ac745a2d25b2780f1ab) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cb86db12b290ed07d05df00d99fa150bb123e80e&id2=f949be64bc4108b875b47ac745a2d25b2780f1ab)) | |
| download | [linux-cb86db12b290ed07d05df00d99fa150bb123e80e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cb86db12b290ed07d05df00d99fa150bb123e80e.tar.gz) | |

drm/imagination: Break an object reference loopcommit b04ce1e718bd55302b52d05d6873e233cb3ec7a1 upstream.
When remaining resources are being cleaned up on driver close,
outstanding VM mappings may result in resources being leaked, due
to an object reference loop, as shown below, with each object (or
set of objects) referencing the object below it:
PVR GEM Object
GPU scheduler "finished" fence
GPU scheduler “scheduled” fence
PVR driver “done” fence
PVR Context
PVR VM Context
PVR VM Mappings
PVR GEM Object
The reference that the PVR VM Context has on the VM mappings is a
soft one, in the sense that the freeing of outstanding VM mappings
is done as part of VM context destruction; no reference counts are
involved, as is the case for all the other references in the loop.
To break the reference loop during cleanup, free the outstanding
VM mappings before destroying the PVR Context associated with the
VM context.
Signed-off-by: Brendan King <brendan.king@imgtec.com>
Signed-off-by: Matt Coster <matt.coster@imgtec.com>
Reviewed-by: Frank Binns <frank.binns@imgtec.com>
Cc: stable@vger.kernel.org
Link: [https://patchwork.freedesktop.org/patch/msgid/8a25924f-1bb7-4d9a-a346-58e871dfb1d1@imgtec.com](https://patchwork.freedesktop.org/patch/msgid/8a25924f-1bb7-4d9a-a346-58e871dfb1d1%40imgtec.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cb86db12b290ed07d05df00d99fa150bb123e80e)

| -rw-r--r-- | [drivers/gpu/drm/imagination/pvr\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/imagination/pvr_context.c?id=cb86db12b290ed07d05df00d99fa150bb123e80e) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/imagination/pvr\_context.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/imagination/pvr_context.h?id=cb86db12b290ed07d05df00d99fa150bb123e80e) | 18 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/imagination/pvr\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/imagination/pvr_vm.c?id=cb86db12b290ed07d05df00d99fa150bb123e80e) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/imagination/pvr\_vm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/imagination/pvr_vm.h?id=cb86db12b290ed07d05df00d99fa150bb123e80e) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 56 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/imagination/pvr\_context.c b/drivers/gpu/drm/imagination/pvr\_context.cindex 255c93582734a8..4cb3494c0bb2c6 100644--- a/[drivers/gpu/drm/imagination/pvr\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_context.c?id=f949be64bc4108b875b47ac745a2d25b2780f1ab)+++ b/[drivers/gpu/drm/imagination/pvr\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_context.c?id=cb86db12b290ed07d05df00d99fa150bb123e80e)@@ -450,11 +450,30 @@ pvr\_context\_destroy(struct pvr\_file \*pvr\_file, u32 handle) \*/ void pvr\_destroy\_contexts\_for\_file(struct pvr\_file \*pvr\_file) {+ struct pvr\_device \*pvr\_dev = pvr\_file->pvr\_dev; struct pvr\_context \*ctx; unsigned long handle;  xa\_for\_each(&pvr\_file->ctx\_handles, handle, ctx) pvr\_context\_destroy(pvr\_file, handle);++ spin\_lock(&pvr\_dev->ctx\_list\_lock);+ ctx = list\_first\_entry(&pvr\_file->contexts, struct pvr\_context, file\_link);++ while (!list\_entry\_is\_head(ctx, &pvr\_file->contexts, file\_link)) {+ list\_del\_init(&ctx->file\_link);++ if (pvr\_context\_get\_if\_referenced(ctx)) {+ spin\_unlock(&pvr\_dev->ctx\_list\_lock);++ pvr\_vm\_unmap\_all(ctx->vm\_ctx);++ pvr\_context\_put(ctx);+ spin\_lock(&pvr\_dev->ctx\_list\_lock);+ }+ ctx = list\_first\_entry(&pvr\_file->contexts, struct pvr\_context, file\_link);+ }+ spin\_unlock(&pvr\_dev->ctx\_list\_lock); }  /\*\*diff --git a/drivers/gpu/drm/imagination/pvr\_context.h b/drivers/gpu/drm/imagination/pvr\_context.hindex a5b0a82a54a1d3..07afa179cdf421 100644--- a/[drivers/gpu/drm/imagination/pvr\_context.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_context.h?id=f949be64bc4108b875b47ac745a2d25b2780f1ab)+++ b/[drivers/gpu/drm/imagination/pvr\_context.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_context.h?id=cb86db12b290ed07d05df00d99fa150bb123e80e)@@ -127,6 +127,24 @@ pvr\_context\_get(struct pvr\_context \*ctx) }  /\*\*+ \* pvr\_context\_get\_if\_referenced() - Take an additional reference on a still+ \* referenced context.+ \* @ctx: Context pointer.+ \*+ \* Call pvr\_context\_put() to release.+ \*+ \* Returns:+ \* \* True on success, or+ \* \* false if no context pointer passed, or the context wasn't still+ \* \* referenced.+ \*/+static \_\_always\_inline bool+pvr\_context\_get\_if\_referenced(struct pvr\_context \*ctx)+{+ return ctx != NULL && kref\_get\_unless\_zero(&ctx->ref\_count) != 0;+}++/\*\* \* pvr\_context\_lookup() - Lookup context pointer from handle and file. \* @pvr\_file: Pointer to pvr\_file structure. \* @handle: Context handle.diff --git a/drivers/gpu/drm/imagination/pvr\_vm.c b/drivers/gpu/drm/imagination/pvr\_vm.cindex 97c0f772ed65f2..7bd6ba4c6e8ab6 100644--- a/[drivers/gpu/drm/imagination/pvr\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_vm.c?id=f949be64bc4108b875b47ac745a2d25b2780f1ab)+++ b/[drivers/gpu/drm/imagination/pvr\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_vm.c?id=cb86db12b290ed07d05df00d99fa150bb123e80e)@@ -14,6 +14,7 @@ #include <drm/drm\_gem.h> #include <drm/drm\_gpuvm.h> +#include <linux/bug.h> #include <linux/container\_of.h> #include <linux/err.h> #include <linux/errno.h>@@ -597,12 +598,26 @@ err\_free: }  /\*\*- \* pvr\_vm\_context\_release() - Teardown a VM context.- \* @ref\_count: Pointer to reference counter of the VM context.+ \* pvr\_vm\_unmap\_all() - Unmap all mappings associated with a VM context.+ \* @vm\_ctx: Target VM context. \* \* This function ensures that no mappings are left dangling by unmapping them \* all in order of ascending device-virtual address. \*/+void+pvr\_vm\_unmap\_all(struct pvr\_vm\_context \*vm\_ctx)+{+ WARN\_ON(pvr\_vm\_unmap(vm\_ctx, vm\_ctx->gpuvm\_mgr.mm\_start,+ vm\_ctx->gpuvm\_mgr.mm\_range));+}++/\*\*+ \* pvr\_vm\_context\_release() - Teardown a VM context.+ \* @ref\_count: Pointer to reference counter of the VM context.+ \*+ \* This function also ensures that no mappings are left dangling by calling+ \* pvr\_vm\_unmap\_all.+ \*/ static void pvr\_vm\_context\_release(struct kref \*ref\_count) {@@ -612,8 +627,7 @@ pvr\_vm\_context\_release(struct kref \*ref\_count) if (vm\_ctx->fw\_mem\_ctx\_obj) pvr\_fw\_object\_destroy(vm\_ctx->fw\_mem\_ctx\_obj); - WARN\_ON(pvr\_vm\_unmap(vm\_ctx, vm\_ctx->gpuvm\_mgr.mm\_start,- vm\_ctx->gpuvm\_mgr.mm\_range));+ pvr\_vm\_unmap\_all(vm\_ctx);  pvr\_mmu\_context\_destroy(vm\_ctx->mmu\_ctx); drm\_gem\_private\_object\_fini(&vm\_ctx->dummy\_gem);diff --git a/drivers/gpu/drm/imagination/pvr\_vm.h b/drivers/gpu/drm/imagination/pvr\_vm.hindex f2a6463f2b059e..79406243617c1f 100644--- a/[drivers/gpu/drm/imagination/pvr\_vm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_vm.h?id=f949be64bc4108b875b47ac745a2d25b2780f1ab)+++ b/[drivers/gpu/drm/imagination/pvr\_vm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_vm.h?id=cb86db12b290ed07d05df00d99fa150bb123e80e)@@ -39,6 +39,7 @@ int pvr\_vm\_map(struct pvr\_vm\_context \*vm\_ctx, struct pvr\_gem\_object \*pvr\_obj, u64 pvr\_obj\_offset, u64 device\_addr, u64 size); int pvr\_vm\_unmap(struct pvr\_vm\_context \*vm\_ctx, u64 device\_addr, u64 size);+void pvr\_vm\_unmap\_all(struct pvr\_vm\_context \*vm\_ctx);  dma\_addr\_t pvr\_vm\_get\_page\_table\_root\_addr(struct pvr\_vm\_context \*vm\_ctx); struct dma\_resv \*pvr\_vm\_get\_dma\_resv(struct pvr\_vm\_context \*vm\_ctx); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:01:33 +0000



=== Content from git.kernel.org_2969a091_20250114_210255.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Brendan King <brendan.king@imgtec.com> | 2024-10-18 15:41:40 +0000 |
| --- | --- | --- |
| committer | Matt Coster <matt.coster@imgtec.com> | 2024-11-04 09:41:38 +0000 |
| commit | [b04ce1e718bd55302b52d05d6873e233cb3ec7a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1)) | |
| tree | [2f5315e7bbc214b6f6f85fe183f065551ef91f77](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1) | |
| parent | [b0ef514bc6bbdeb8cc7492c0f473e14cb06b14d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0ef514bc6bbdeb8cc7492c0f473e14cb06b14d4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1&id2=b0ef514bc6bbdeb8cc7492c0f473e14cb06b14d4)) | |
| download | [linux-b04ce1e718bd55302b52d05d6873e233cb3ec7a1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b04ce1e718bd55302b52d05d6873e233cb3ec7a1.tar.gz) | |

drm/imagination: Break an object reference loopWhen remaining resources are being cleaned up on driver close,
outstanding VM mappings may result in resources being leaked, due
to an object reference loop, as shown below, with each object (or
set of objects) referencing the object below it:
PVR GEM Object
GPU scheduler "finished" fence
GPU scheduler “scheduled” fence
PVR driver “done” fence
PVR Context
PVR VM Context
PVR VM Mappings
PVR GEM Object
The reference that the PVR VM Context has on the VM mappings is a
soft one, in the sense that the freeing of outstanding VM mappings
is done as part of VM context destruction; no reference counts are
involved, as is the case for all the other references in the loop.
To break the reference loop during cleanup, free the outstanding
VM mappings before destroying the PVR Context associated with the
VM context.
Signed-off-by: Brendan King <brendan.king@imgtec.com>
Signed-off-by: Matt Coster <matt.coster@imgtec.com>
Reviewed-by: Frank Binns <frank.binns@imgtec.com>
Cc: stable@vger.kernel.org
Link: [https://patchwork.freedesktop.org/patch/msgid/8a25924f-1bb7-4d9a-a346-58e871dfb1d1@imgtec.com](https://patchwork.freedesktop.org/patch/msgid/8a25924f-1bb7-4d9a-a346-58e871dfb1d1%40imgtec.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1)

| -rw-r--r-- | [drivers/gpu/drm/imagination/pvr\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/imagination/pvr_context.c?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/imagination/pvr\_context.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/imagination/pvr_context.h?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1) | 18 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/imagination/pvr\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/imagination/pvr_vm.c?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/imagination/pvr\_vm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/imagination/pvr_vm.h?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 56 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/imagination/pvr\_context.c b/drivers/gpu/drm/imagination/pvr\_context.cindex 255c93582734a8..4cb3494c0bb2c6 100644--- a/[drivers/gpu/drm/imagination/pvr\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_context.c?id=b0ef514bc6bbdeb8cc7492c0f473e14cb06b14d4)+++ b/[drivers/gpu/drm/imagination/pvr\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_context.c?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1)@@ -450,11 +450,30 @@ pvr\_context\_destroy(struct pvr\_file \*pvr\_file, u32 handle) \*/ void pvr\_destroy\_contexts\_for\_file(struct pvr\_file \*pvr\_file) {+ struct pvr\_device \*pvr\_dev = pvr\_file->pvr\_dev; struct pvr\_context \*ctx; unsigned long handle;  xa\_for\_each(&pvr\_file->ctx\_handles, handle, ctx) pvr\_context\_destroy(pvr\_file, handle);++ spin\_lock(&pvr\_dev->ctx\_list\_lock);+ ctx = list\_first\_entry(&pvr\_file->contexts, struct pvr\_context, file\_link);++ while (!list\_entry\_is\_head(ctx, &pvr\_file->contexts, file\_link)) {+ list\_del\_init(&ctx->file\_link);++ if (pvr\_context\_get\_if\_referenced(ctx)) {+ spin\_unlock(&pvr\_dev->ctx\_list\_lock);++ pvr\_vm\_unmap\_all(ctx->vm\_ctx);++ pvr\_context\_put(ctx);+ spin\_lock(&pvr\_dev->ctx\_list\_lock);+ }+ ctx = list\_first\_entry(&pvr\_file->contexts, struct pvr\_context, file\_link);+ }+ spin\_unlock(&pvr\_dev->ctx\_list\_lock); }  /\*\*diff --git a/drivers/gpu/drm/imagination/pvr\_context.h b/drivers/gpu/drm/imagination/pvr\_context.hindex a5b0a82a54a1d3..07afa179cdf421 100644--- a/[drivers/gpu/drm/imagination/pvr\_context.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_context.h?id=b0ef514bc6bbdeb8cc7492c0f473e14cb06b14d4)+++ b/[drivers/gpu/drm/imagination/pvr\_context.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_context.h?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1)@@ -127,6 +127,24 @@ pvr\_context\_get(struct pvr\_context \*ctx) }  /\*\*+ \* pvr\_context\_get\_if\_referenced() - Take an additional reference on a still+ \* referenced context.+ \* @ctx: Context pointer.+ \*+ \* Call pvr\_context\_put() to release.+ \*+ \* Returns:+ \* \* True on success, or+ \* \* false if no context pointer passed, or the context wasn't still+ \* \* referenced.+ \*/+static \_\_always\_inline bool+pvr\_context\_get\_if\_referenced(struct pvr\_context \*ctx)+{+ return ctx != NULL && kref\_get\_unless\_zero(&ctx->ref\_count) != 0;+}++/\*\* \* pvr\_context\_lookup() - Lookup context pointer from handle and file. \* @pvr\_file: Pointer to pvr\_file structure. \* @handle: Context handle.diff --git a/drivers/gpu/drm/imagination/pvr\_vm.c b/drivers/gpu/drm/imagination/pvr\_vm.cindex 97c0f772ed65f2..7bd6ba4c6e8ab6 100644--- a/[drivers/gpu/drm/imagination/pvr\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_vm.c?id=b0ef514bc6bbdeb8cc7492c0f473e14cb06b14d4)+++ b/[drivers/gpu/drm/imagination/pvr\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_vm.c?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1)@@ -14,6 +14,7 @@ #include <drm/drm\_gem.h> #include <drm/drm\_gpuvm.h> +#include <linux/bug.h> #include <linux/container\_of.h> #include <linux/err.h> #include <linux/errno.h>@@ -597,12 +598,26 @@ err\_free: }  /\*\*- \* pvr\_vm\_context\_release() - Teardown a VM context.- \* @ref\_count: Pointer to reference counter of the VM context.+ \* pvr\_vm\_unmap\_all() - Unmap all mappings associated with a VM context.+ \* @vm\_ctx: Target VM context. \* \* This function ensures that no mappings are left dangling by unmapping them \* all in order of ascending device-virtual address. \*/+void+pvr\_vm\_unmap\_all(struct pvr\_vm\_context \*vm\_ctx)+{+ WARN\_ON(pvr\_vm\_unmap(vm\_ctx, vm\_ctx->gpuvm\_mgr.mm\_start,+ vm\_ctx->gpuvm\_mgr.mm\_range));+}++/\*\*+ \* pvr\_vm\_context\_release() - Teardown a VM context.+ \* @ref\_count: Pointer to reference counter of the VM context.+ \*+ \* This function also ensures that no mappings are left dangling by calling+ \* pvr\_vm\_unmap\_all.+ \*/ static void pvr\_vm\_context\_release(struct kref \*ref\_count) {@@ -612,8 +627,7 @@ pvr\_vm\_context\_release(struct kref \*ref\_count) if (vm\_ctx->fw\_mem\_ctx\_obj) pvr\_fw\_object\_destroy(vm\_ctx->fw\_mem\_ctx\_obj); - WARN\_ON(pvr\_vm\_unmap(vm\_ctx, vm\_ctx->gpuvm\_mgr.mm\_start,- vm\_ctx->gpuvm\_mgr.mm\_range));+ pvr\_vm\_unmap\_all(vm\_ctx);  pvr\_mmu\_context\_destroy(vm\_ctx->mmu\_ctx); drm\_gem\_private\_object\_fini(&vm\_ctx->dummy\_gem);diff --git a/drivers/gpu/drm/imagination/pvr\_vm.h b/drivers/gpu/drm/imagination/pvr\_vm.hindex f2a6463f2b059e..79406243617c1f 100644--- a/[drivers/gpu/drm/imagination/pvr\_vm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_vm.h?id=b0ef514bc6bbdeb8cc7492c0f473e14cb06b14d4)+++ b/[drivers/gpu/drm/imagination/pvr\_vm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/imagination/pvr_vm.h?id=b04ce1e718bd55302b52d05d6873e233cb3ec7a1)@@ -39,6 +39,7 @@ int pvr\_vm\_map(struct pvr\_vm\_context \*vm\_ctx, struct pvr\_gem\_object \*pvr\_obj, u64 pvr\_obj\_offset, u64 device\_addr, u64 size); int pvr\_vm\_unmap(struct pvr\_vm\_context \*vm\_ctx, u64 device\_addr, u64 size);+void pvr\_vm\_unmap\_all(struct pvr\_vm\_context \*vm\_ctx);  dma\_addr\_t pvr\_vm\_get\_page\_table\_root\_addr(struct pvr\_vm\_context \*vm\_ctx); struct dma\_resv \*pvr\_vm\_get\_dma\_resv(struct pvr\_vm\_context \*vm\_ctx); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:01:32 +0000


