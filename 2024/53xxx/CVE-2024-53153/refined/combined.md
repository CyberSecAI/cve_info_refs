=== Content from git.kernel.org_58907dd9_20250114_191956.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7d7cf89b119af433354f865fc01017b9f8aa411a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7d7cf89b119af433354f865fc01017b9f8aa411a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d7cf89b119af433354f865fc01017b9f8aa411a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d7cf89b119af433354f865fc01017b9f8aa411a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org> | 2024-08-17 11:09:03 +0530 |
| --- | --- | --- |
| committer | Krzysztof Wilczyński <kwilczynski@kernel.org> | 2024-11-03 09:03:30 +0000 |
| commit | [7d7cf89b119af433354f865fc01017b9f8aa411a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d7cf89b119af433354f865fc01017b9f8aa411a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7d7cf89b119af433354f865fc01017b9f8aa411a)) | |
| tree | [12e849006beb9c458b26f7ba05ede5be3be47bae](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7d7cf89b119af433354f865fc01017b9f8aa411a) | |
| parent | [ba4a2e2317b9faeca9193ed6d3193ddc3cf2aba3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba4a2e2317b9faeca9193ed6d3193ddc3cf2aba3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d7cf89b119af433354f865fc01017b9f8aa411a&id2=ba4a2e2317b9faeca9193ed6d3193ddc3cf2aba3)) | |
| download | [linux-7d7cf89b119af433354f865fc01017b9f8aa411a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7d7cf89b119af433354f865fc01017b9f8aa411a.tar.gz) | |

PCI: qcom-ep: Move controller cleanups to qcom\_pcie\_perst\_deassert()Currently, the endpoint cleanup function dw\_pcie\_ep\_cleanup() and EPF
deinit notify function pci\_epc\_deinit\_notify() are called during the
execution of qcom\_pcie\_perst\_assert() i.e., when the host has asserted
PERST#. But quickly after this step, refclk will also be disabled by the
host.
All of the Qcom endpoint SoCs supported as of now depend on the refclk from
the host for keeping the controller operational. Due to this limitation,
any access to the hardware registers in the absence of refclk will result
in a whole endpoint crash. Unfortunately, most of the controller cleanups
require accessing the hardware registers (like eDMA cleanup performed in
dw\_pcie\_ep\_cleanup(), powering down MHI EPF etc...). So these cleanup
functions are currently causing the crash in the endpoint SoC once host
asserts PERST#.
One way to address this issue is by generating the refclk in the endpoint
itself and not depending on the host. But that is not always possible as
some of the endpoint designs do require the endpoint to consume refclk from
the host (as I was told by the Qcom engineers).
Thus, fix this crash by moving the controller cleanups to the start of
the qcom\_pcie\_perst\_deassert() function. qcom\_pcie\_perst\_deassert() is
called whenever the host has deasserted PERST# and it is guaranteed that
the refclk would be active at this point. So at the start of this function
(after enabling resources), the controller cleanup can be performed. Once
finished, rest of the code execution for PERST# deassert can continue as
usual.
Fixes: 473b2cf9c4d1 ("PCI: endpoint: Introduce 'epc\_deinit' event and notify the EPF drivers")
Fixes: 570d7715eed8 ("PCI: dwc: ep: Introduce dw\_pcie\_ep\_cleanup() API for drivers supporting PERST#")
Link: [https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-1-d6b958226559@linaro.org](https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-1-d6b958226559%40linaro.org)
Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Krzysztof Wilczyński <kwilczynski@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d7cf89b119af433354f865fc01017b9f8aa411a)

| -rw-r--r-- | [drivers/pci/controller/dwc/pcie-qcom-ep.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/controller/dwc/pcie-qcom-ep.c?id=7d7cf89b119af433354f865fc01017b9f8aa411a) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/drivers/pci/controller/dwc/pcie-qcom-ep.c b/drivers/pci/controller/dwc/pcie-qcom-ep.cindex e588fcc5458936..b5ca5260f9049f 100644--- a/[drivers/pci/controller/dwc/pcie-qcom-ep.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-qcom-ep.c?id=ba4a2e2317b9faeca9193ed6d3193ddc3cf2aba3)+++ b/[drivers/pci/controller/dwc/pcie-qcom-ep.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-qcom-ep.c?id=7d7cf89b119af433354f865fc01017b9f8aa411a)@@ -396,6 +396,10 @@ static int qcom\_pcie\_perst\_deassert(struct dw\_pcie \*pci) return ret; } + /\* Perform cleanup that requires refclk \*/+ pci\_epc\_deinit\_notify(pci->ep.epc);+ dw\_pcie\_ep\_cleanup(&pci->ep);+ /\* Assert WAKE# to RC to indicate device is ready \*/ gpiod\_set\_value\_cansleep(pcie\_ep->wake, 1); usleep\_range(WAKE\_DELAY\_US, WAKE\_DELAY\_US + 500);@@ -540,8 +544,6 @@ static void qcom\_pcie\_perst\_assert(struct dw\_pcie \*pci) { struct qcom\_pcie\_ep \*pcie\_ep = to\_pcie\_ep(pci); - pci\_epc\_deinit\_notify(pci->ep.epc);- dw\_pcie\_ep\_cleanup(&pci->ep); qcom\_pcie\_disable\_resources(pcie\_ep); pcie\_ep->link\_status = QCOM\_PCIE\_EP\_LINK\_DISABLED; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:18:33 +0000



=== Content from git.kernel.org_4d5e9519_20250114_191957.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org> | 2024-08-17 11:09:03 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:49 +0100 |
| commit | [e03b5f1615c84f4139cb53ef8659f4cdb8d6a563](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563)) | |
| tree | [8c8432308dd83aa16fc0db2915cd6b9970fec3d0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563) | |
| parent | [98ce98d4d5e9b82fafbcf3634e1f832b02955229](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98ce98d4d5e9b82fafbcf3634e1f832b02955229) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563&id2=98ce98d4d5e9b82fafbcf3634e1f832b02955229)) | |
| download | [linux-e03b5f1615c84f4139cb53ef8659f4cdb8d6a563.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e03b5f1615c84f4139cb53ef8659f4cdb8d6a563.tar.gz) | |

PCI: qcom-ep: Move controller cleanups to qcom\_pcie\_perst\_deassert()[ Upstream commit 7d7cf89b119af433354f865fc01017b9f8aa411a ]
Currently, the endpoint cleanup function dw\_pcie\_ep\_cleanup() and EPF
deinit notify function pci\_epc\_deinit\_notify() are called during the
execution of qcom\_pcie\_perst\_assert() i.e., when the host has asserted
PERST#. But quickly after this step, refclk will also be disabled by the
host.
All of the Qcom endpoint SoCs supported as of now depend on the refclk from
the host for keeping the controller operational. Due to this limitation,
any access to the hardware registers in the absence of refclk will result
in a whole endpoint crash. Unfortunately, most of the controller cleanups
require accessing the hardware registers (like eDMA cleanup performed in
dw\_pcie\_ep\_cleanup(), powering down MHI EPF etc...). So these cleanup
functions are currently causing the crash in the endpoint SoC once host
asserts PERST#.
One way to address this issue is by generating the refclk in the endpoint
itself and not depending on the host. But that is not always possible as
some of the endpoint designs do require the endpoint to consume refclk from
the host (as I was told by the Qcom engineers).
Thus, fix this crash by moving the controller cleanups to the start of
the qcom\_pcie\_perst\_deassert() function. qcom\_pcie\_perst\_deassert() is
called whenever the host has deasserted PERST# and it is guaranteed that
the refclk would be active at this point. So at the start of this function
(after enabling resources), the controller cleanup can be performed. Once
finished, rest of the code execution for PERST# deassert can continue as
usual.
Fixes: 473b2cf9c4d1 ("PCI: endpoint: Introduce 'epc\_deinit' event and notify the EPF drivers")
Fixes: 570d7715eed8 ("PCI: dwc: ep: Introduce dw\_pcie\_ep\_cleanup() API for drivers supporting PERST#")
Link: [https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-1-d6b958226559@linaro.org](https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-1-d6b958226559%40linaro.org)
Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Krzysztof Wilczyński <kwilczynski@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563)

| -rw-r--r-- | [drivers/pci/controller/dwc/pcie-qcom-ep.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/controller/dwc/pcie-qcom-ep.c?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/drivers/pci/controller/dwc/pcie-qcom-ep.c b/drivers/pci/controller/dwc/pcie-qcom-ep.cindex c8bb7cd89678f5..a7f65d50d4ebbf 100644--- a/[drivers/pci/controller/dwc/pcie-qcom-ep.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-qcom-ep.c?id=98ce98d4d5e9b82fafbcf3634e1f832b02955229)+++ b/[drivers/pci/controller/dwc/pcie-qcom-ep.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-qcom-ep.c?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563)@@ -395,6 +395,10 @@ static int qcom\_pcie\_perst\_deassert(struct dw\_pcie \*pci) return ret; } + /\* Perform cleanup that requires refclk \*/+ pci\_epc\_deinit\_notify(pci->ep.epc);+ dw\_pcie\_ep\_cleanup(&pci->ep);+ /\* Assert WAKE# to RC to indicate device is ready \*/ gpiod\_set\_value\_cansleep(pcie\_ep->wake, 1); usleep\_range(WAKE\_DELAY\_US, WAKE\_DELAY\_US + 500);@@ -534,8 +538,6 @@ static void qcom\_pcie\_perst\_assert(struct dw\_pcie \*pci) { struct qcom\_pcie\_ep \*pcie\_ep = to\_pcie\_ep(pci); - pci\_epc\_deinit\_notify(pci->ep.epc);- dw\_pcie\_ep\_cleanup(&pci->ep); qcom\_pcie\_disable\_resources(pcie\_ep); pcie\_ep->link\_status = QCOM\_PCIE\_EP\_LINK\_DISABLED; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:18:34 +0000



=== Content from git.kernel.org_35b21084_20250114_191955.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=516969d5765e2302d33b4f251496eedb757d55ea)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=516969d5765e2302d33b4f251496eedb757d55ea)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=516969d5765e2302d33b4f251496eedb757d55ea)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=516969d5765e2302d33b4f251496eedb757d55ea)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org> | 2024-08-17 11:09:03 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:23 +0100 |
| commit | [516969d5765e2302d33b4f251496eedb757d55ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=516969d5765e2302d33b4f251496eedb757d55ea) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=516969d5765e2302d33b4f251496eedb757d55ea)) | |
| tree | [b9b04f12a6296d325f52163b02dc4fa1e55303e2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=516969d5765e2302d33b4f251496eedb757d55ea) | |
| parent | [a16e6f79665aa9580ab08a7306c85e07101011cb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a16e6f79665aa9580ab08a7306c85e07101011cb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=516969d5765e2302d33b4f251496eedb757d55ea&id2=a16e6f79665aa9580ab08a7306c85e07101011cb)) | |
| download | [linux-516969d5765e2302d33b4f251496eedb757d55ea.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-516969d5765e2302d33b4f251496eedb757d55ea.tar.gz) | |

PCI: qcom-ep: Move controller cleanups to qcom\_pcie\_perst\_deassert()[ Upstream commit 7d7cf89b119af433354f865fc01017b9f8aa411a ]
Currently, the endpoint cleanup function dw\_pcie\_ep\_cleanup() and EPF
deinit notify function pci\_epc\_deinit\_notify() are called during the
execution of qcom\_pcie\_perst\_assert() i.e., when the host has asserted
PERST#. But quickly after this step, refclk will also be disabled by the
host.
All of the Qcom endpoint SoCs supported as of now depend on the refclk from
the host for keeping the controller operational. Due to this limitation,
any access to the hardware registers in the absence of refclk will result
in a whole endpoint crash. Unfortunately, most of the controller cleanups
require accessing the hardware registers (like eDMA cleanup performed in
dw\_pcie\_ep\_cleanup(), powering down MHI EPF etc...). So these cleanup
functions are currently causing the crash in the endpoint SoC once host
asserts PERST#.
One way to address this issue is by generating the refclk in the endpoint
itself and not depending on the host. But that is not always possible as
some of the endpoint designs do require the endpoint to consume refclk from
the host (as I was told by the Qcom engineers).
Thus, fix this crash by moving the controller cleanups to the start of
the qcom\_pcie\_perst\_deassert() function. qcom\_pcie\_perst\_deassert() is
called whenever the host has deasserted PERST# and it is guaranteed that
the refclk would be active at this point. So at the start of this function
(after enabling resources), the controller cleanup can be performed. Once
finished, rest of the code execution for PERST# deassert can continue as
usual.
Fixes: 473b2cf9c4d1 ("PCI: endpoint: Introduce 'epc\_deinit' event and notify the EPF drivers")
Fixes: 570d7715eed8 ("PCI: dwc: ep: Introduce dw\_pcie\_ep\_cleanup() API for drivers supporting PERST#")
Link: [https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-1-d6b958226559@linaro.org](https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-1-d6b958226559%40linaro.org)
Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Krzysztof Wilczyński <kwilczynski@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=516969d5765e2302d33b4f251496eedb757d55ea)

| -rw-r--r-- | [drivers/pci/controller/dwc/pcie-qcom-ep.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/controller/dwc/pcie-qcom-ep.c?id=516969d5765e2302d33b4f251496eedb757d55ea) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/drivers/pci/controller/dwc/pcie-qcom-ep.c b/drivers/pci/controller/dwc/pcie-qcom-ep.cindex e588fcc5458936..b5ca5260f9049f 100644--- a/[drivers/pci/controller/dwc/pcie-qcom-ep.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-qcom-ep.c?id=a16e6f79665aa9580ab08a7306c85e07101011cb)+++ b/[drivers/pci/controller/dwc/pcie-qcom-ep.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-qcom-ep.c?id=516969d5765e2302d33b4f251496eedb757d55ea)@@ -396,6 +396,10 @@ static int qcom\_pcie\_perst\_deassert(struct dw\_pcie \*pci) return ret; } + /\* Perform cleanup that requires refclk \*/+ pci\_epc\_deinit\_notify(pci->ep.epc);+ dw\_pcie\_ep\_cleanup(&pci->ep);+ /\* Assert WAKE# to RC to indicate device is ready \*/ gpiod\_set\_value\_cansleep(pcie\_ep->wake, 1); usleep\_range(WAKE\_DELAY\_US, WAKE\_DELAY\_US + 500);@@ -540,8 +544,6 @@ static void qcom\_pcie\_perst\_assert(struct dw\_pcie \*pci) { struct qcom\_pcie\_ep \*pcie\_ep = to\_pcie\_ep(pci); - pci\_epc\_deinit\_notify(pci->ep.epc);- dw\_pcie\_ep\_cleanup(&pci->ep); qcom\_pcie\_disable\_resources(pcie\_ep); pcie\_ep->link\_status = QCOM\_PCIE\_EP\_LINK\_DISABLED; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:18:32 +0000


