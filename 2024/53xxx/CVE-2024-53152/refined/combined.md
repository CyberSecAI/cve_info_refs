=== Content from git.kernel.org_eb2047cf_20250114_224735.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=40e2125381dc11379112485e3eefdd25c6df5375)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=40e2125381dc11379112485e3eefdd25c6df5375)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=40e2125381dc11379112485e3eefdd25c6df5375)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=40e2125381dc11379112485e3eefdd25c6df5375)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org> | 2024-08-17 11:09:04 +0530 |
| --- | --- | --- |
| committer | Krzysztof Wilczyński <kwilczynski@kernel.org> | 2024-11-03 09:08:33 +0000 |
| commit | [40e2125381dc11379112485e3eefdd25c6df5375](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=40e2125381dc11379112485e3eefdd25c6df5375) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=40e2125381dc11379112485e3eefdd25c6df5375)) | |
| tree | [4ee27d5e3706aa643e281968bed80a840092d779](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=40e2125381dc11379112485e3eefdd25c6df5375) | |
| parent | [9852d85ec9d492ebef56dc5f229416c925758edc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9852d85ec9d492ebef56dc5f229416c925758edc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=40e2125381dc11379112485e3eefdd25c6df5375&id2=9852d85ec9d492ebef56dc5f229416c925758edc)) | |
| download | [linux-40e2125381dc11379112485e3eefdd25c6df5375.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-40e2125381dc11379112485e3eefdd25c6df5375.tar.gz) | |

PCI: tegra194: Move controller cleanups to pex\_ep\_event\_pex\_rst\_deassert()Currently, the endpoint cleanup function dw\_pcie\_ep\_cleanup() and EPF
deinit notify function pci\_epc\_deinit\_notify() are called during the
execution of pex\_ep\_event\_pex\_rst\_assert() i.e., when the host has asserted
PERST#. But quickly after this step, refclk will also be disabled by the
host.
All of the tegra194 endpoint SoCs supported as of now depend on the refclk
from the host for keeping the controller operational. Due to this
limitation, any access to the hardware registers in the absence of refclk
will result in a whole endpoint crash. Unfortunately, most of the
controller cleanups require accessing the hardware registers (like eDMA
cleanup performed in dw\_pcie\_ep\_cleanup(), etc...). So these cleanup
functions can cause the crash in the endpoint SoC once host asserts PERST#.
One way to address this issue is by generating the refclk in the endpoint
itself and not depending on the host. But that is not always possible as
some of the endpoint designs do require the endpoint to consume refclk from
the host.
Thus, fix this crash by moving the controller cleanups to the start of
the pex\_ep\_event\_pex\_rst\_deassert() function. This function is called
whenever the host has deasserted PERST# and it is guaranteed that the
refclk would be active at this point. So at the start of this function
(after enabling resources) the controller cleanup can be performed. Once
finished, rest of the code execution for PERST# deassert can continue as
usual.
Fixes: 473b2cf9c4d1 ("PCI: endpoint: Introduce 'epc\_deinit' event and notify the EPF drivers")
Fixes: 570d7715eed8 ("PCI: dwc: ep: Introduce dw\_pcie\_ep\_cleanup() API for drivers supporting PERST#")
Link: [https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-2-d6b958226559@linaro.org](https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-2-d6b958226559%40linaro.org)
Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Krzysztof Wilczyński <kwilczynski@kernel.org>
Cc: Jonathan Hunter <jonathanh@nvidia.com>
Cc: Thierry Reding <thierry.reding@gmail.com>
Cc: Vidya Sagar <vidyas@nvidia.com>
Cc: linux-tegra@vger.kernel.org
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=40e2125381dc11379112485e3eefdd25c6df5375)

| -rw-r--r-- | [drivers/pci/controller/dwc/pcie-tegra194.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/controller/dwc/pcie-tegra194.c?id=40e2125381dc11379112485e3eefdd25c6df5375) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/pci/controller/dwc/pcie-tegra194.c b/drivers/pci/controller/dwc/pcie-tegra194.cindex c1394f2ab63ff1..ced3b7e7bdaded 100644--- a/[drivers/pci/controller/dwc/pcie-tegra194.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-tegra194.c?id=9852d85ec9d492ebef56dc5f229416c925758edc)+++ b/[drivers/pci/controller/dwc/pcie-tegra194.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-tegra194.c?id=40e2125381dc11379112485e3eefdd25c6df5375)@@ -1704,9 +1704,6 @@ static void pex\_ep\_event\_pex\_rst\_assert(struct tegra\_pcie\_dw \*pcie) if (ret) dev\_err(pcie->dev, "Failed to go Detect state: %d\n", ret); - pci\_epc\_deinit\_notify(pcie->pci.ep.epc);- dw\_pcie\_ep\_cleanup(&pcie->pci.ep);- reset\_control\_assert(pcie->core\_rst);  tegra\_pcie\_disable\_phy(pcie);@@ -1785,6 +1782,10 @@ static void pex\_ep\_event\_pex\_rst\_deassert(struct tegra\_pcie\_dw \*pcie) goto fail\_phy; } + /\* Perform cleanup that requires refclk \*/+ pci\_epc\_deinit\_notify(pcie->pci.ep.epc);+ dw\_pcie\_ep\_cleanup(&pcie->pci.ep);+ /\* Clear any stale interrupt statuses \*/ appl\_writel(pcie, 0xFFFFFFFF, APPL\_INTR\_STATUS\_L0); appl\_writel(pcie, 0xFFFFFFFF, APPL\_INTR\_STATUS\_L1\_0\_0); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:46:12 +0000



=== Content from git.kernel.org_aa4025f8_20250114_224736.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=72034050ccf4202cd6558b0afd2474f756ea3b9b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72034050ccf4202cd6558b0afd2474f756ea3b9b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72034050ccf4202cd6558b0afd2474f756ea3b9b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72034050ccf4202cd6558b0afd2474f756ea3b9b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org> | 2024-08-17 11:09:04 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:23 +0100 |
| commit | [72034050ccf4202cd6558b0afd2474f756ea3b9b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72034050ccf4202cd6558b0afd2474f756ea3b9b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=72034050ccf4202cd6558b0afd2474f756ea3b9b)) | |
| tree | [80f0964116e489cf8c98220b54af21211dd5bebc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72034050ccf4202cd6558b0afd2474f756ea3b9b) | |
| parent | [516969d5765e2302d33b4f251496eedb757d55ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=516969d5765e2302d33b4f251496eedb757d55ea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72034050ccf4202cd6558b0afd2474f756ea3b9b&id2=516969d5765e2302d33b4f251496eedb757d55ea)) | |
| download | [linux-72034050ccf4202cd6558b0afd2474f756ea3b9b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-72034050ccf4202cd6558b0afd2474f756ea3b9b.tar.gz) | |

PCI: tegra194: Move controller cleanups to pex\_ep\_event\_pex\_rst\_deassert()[ Upstream commit 40e2125381dc11379112485e3eefdd25c6df5375 ]
Currently, the endpoint cleanup function dw\_pcie\_ep\_cleanup() and EPF
deinit notify function pci\_epc\_deinit\_notify() are called during the
execution of pex\_ep\_event\_pex\_rst\_assert() i.e., when the host has asserted
PERST#. But quickly after this step, refclk will also be disabled by the
host.
All of the tegra194 endpoint SoCs supported as of now depend on the refclk
from the host for keeping the controller operational. Due to this
limitation, any access to the hardware registers in the absence of refclk
will result in a whole endpoint crash. Unfortunately, most of the
controller cleanups require accessing the hardware registers (like eDMA
cleanup performed in dw\_pcie\_ep\_cleanup(), etc...). So these cleanup
functions can cause the crash in the endpoint SoC once host asserts PERST#.
One way to address this issue is by generating the refclk in the endpoint
itself and not depending on the host. But that is not always possible as
some of the endpoint designs do require the endpoint to consume refclk from
the host.
Thus, fix this crash by moving the controller cleanups to the start of
the pex\_ep\_event\_pex\_rst\_deassert() function. This function is called
whenever the host has deasserted PERST# and it is guaranteed that the
refclk would be active at this point. So at the start of this function
(after enabling resources) the controller cleanup can be performed. Once
finished, rest of the code execution for PERST# deassert can continue as
usual.
Fixes: 473b2cf9c4d1 ("PCI: endpoint: Introduce 'epc\_deinit' event and notify the EPF drivers")
Fixes: 570d7715eed8 ("PCI: dwc: ep: Introduce dw\_pcie\_ep\_cleanup() API for drivers supporting PERST#")
Link: [https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-2-d6b958226559@linaro.org](https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-2-d6b958226559%40linaro.org)
Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Krzysztof Wilczyński <kwilczynski@kernel.org>
Cc: Jonathan Hunter <jonathanh@nvidia.com>
Cc: Thierry Reding <thierry.reding@gmail.com>
Cc: Vidya Sagar <vidyas@nvidia.com>
Cc: linux-tegra@vger.kernel.org
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72034050ccf4202cd6558b0afd2474f756ea3b9b)

| -rw-r--r-- | [drivers/pci/controller/dwc/pcie-tegra194.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/controller/dwc/pcie-tegra194.c?id=72034050ccf4202cd6558b0afd2474f756ea3b9b) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/pci/controller/dwc/pcie-tegra194.c b/drivers/pci/controller/dwc/pcie-tegra194.cindex c1394f2ab63ff1..ced3b7e7bdaded 100644--- a/[drivers/pci/controller/dwc/pcie-tegra194.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-tegra194.c?id=516969d5765e2302d33b4f251496eedb757d55ea)+++ b/[drivers/pci/controller/dwc/pcie-tegra194.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-tegra194.c?id=72034050ccf4202cd6558b0afd2474f756ea3b9b)@@ -1704,9 +1704,6 @@ static void pex\_ep\_event\_pex\_rst\_assert(struct tegra\_pcie\_dw \*pcie) if (ret) dev\_err(pcie->dev, "Failed to go Detect state: %d\n", ret); - pci\_epc\_deinit\_notify(pcie->pci.ep.epc);- dw\_pcie\_ep\_cleanup(&pcie->pci.ep);- reset\_control\_assert(pcie->core\_rst);  tegra\_pcie\_disable\_phy(pcie);@@ -1785,6 +1782,10 @@ static void pex\_ep\_event\_pex\_rst\_deassert(struct tegra\_pcie\_dw \*pcie) goto fail\_phy; } + /\* Perform cleanup that requires refclk \*/+ pci\_epc\_deinit\_notify(pcie->pci.ep.epc);+ dw\_pcie\_ep\_cleanup(&pcie->pci.ep);+ /\* Clear any stale interrupt statuses \*/ appl\_writel(pcie, 0xFFFFFFFF, APPL\_INTR\_STATUS\_L0); appl\_writel(pcie, 0xFFFFFFFF, APPL\_INTR\_STATUS\_L1\_0\_0); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:46:13 +0000



=== Content from git.kernel.org_0c023c56_20250114_224735.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=70212c2300971506e986d95000d2745529cac9d7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=70212c2300971506e986d95000d2745529cac9d7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70212c2300971506e986d95000d2745529cac9d7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70212c2300971506e986d95000d2745529cac9d7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org> | 2024-08-17 11:09:04 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:53:49 +0100 |
| commit | [70212c2300971506e986d95000d2745529cac9d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70212c2300971506e986d95000d2745529cac9d7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=70212c2300971506e986d95000d2745529cac9d7)) | |
| tree | [26c60de104151df0e0cb60e50d0b06d456124af5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=70212c2300971506e986d95000d2745529cac9d7) | |
| parent | [e03b5f1615c84f4139cb53ef8659f4cdb8d6a563](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70212c2300971506e986d95000d2745529cac9d7&id2=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563)) | |
| download | [linux-70212c2300971506e986d95000d2745529cac9d7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-70212c2300971506e986d95000d2745529cac9d7.tar.gz) | |

PCI: tegra194: Move controller cleanups to pex\_ep\_event\_pex\_rst\_deassert()[ Upstream commit 40e2125381dc11379112485e3eefdd25c6df5375 ]
Currently, the endpoint cleanup function dw\_pcie\_ep\_cleanup() and EPF
deinit notify function pci\_epc\_deinit\_notify() are called during the
execution of pex\_ep\_event\_pex\_rst\_assert() i.e., when the host has asserted
PERST#. But quickly after this step, refclk will also be disabled by the
host.
All of the tegra194 endpoint SoCs supported as of now depend on the refclk
from the host for keeping the controller operational. Due to this
limitation, any access to the hardware registers in the absence of refclk
will result in a whole endpoint crash. Unfortunately, most of the
controller cleanups require accessing the hardware registers (like eDMA
cleanup performed in dw\_pcie\_ep\_cleanup(), etc...). So these cleanup
functions can cause the crash in the endpoint SoC once host asserts PERST#.
One way to address this issue is by generating the refclk in the endpoint
itself and not depending on the host. But that is not always possible as
some of the endpoint designs do require the endpoint to consume refclk from
the host.
Thus, fix this crash by moving the controller cleanups to the start of
the pex\_ep\_event\_pex\_rst\_deassert() function. This function is called
whenever the host has deasserted PERST# and it is guaranteed that the
refclk would be active at this point. So at the start of this function
(after enabling resources) the controller cleanup can be performed. Once
finished, rest of the code execution for PERST# deassert can continue as
usual.
Fixes: 473b2cf9c4d1 ("PCI: endpoint: Introduce 'epc\_deinit' event and notify the EPF drivers")
Fixes: 570d7715eed8 ("PCI: dwc: ep: Introduce dw\_pcie\_ep\_cleanup() API for drivers supporting PERST#")
Link: [https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-2-d6b958226559@linaro.org](https://lore.kernel.org/r/20240817-pci-qcom-ep-cleanup-v1-2-d6b958226559%40linaro.org)
Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Krzysztof Wilczyński <kwilczynski@kernel.org>
Cc: Jonathan Hunter <jonathanh@nvidia.com>
Cc: Thierry Reding <thierry.reding@gmail.com>
Cc: Vidya Sagar <vidyas@nvidia.com>
Cc: linux-tegra@vger.kernel.org
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70212c2300971506e986d95000d2745529cac9d7)

| -rw-r--r-- | [drivers/pci/controller/dwc/pcie-tegra194.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/controller/dwc/pcie-tegra194.c?id=70212c2300971506e986d95000d2745529cac9d7) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/pci/controller/dwc/pcie-tegra194.c b/drivers/pci/controller/dwc/pcie-tegra194.cindex 4bf7b433417a3b..d68dd18ed43cb6 100644--- a/[drivers/pci/controller/dwc/pcie-tegra194.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-tegra194.c?id=e03b5f1615c84f4139cb53ef8659f4cdb8d6a563)+++ b/[drivers/pci/controller/dwc/pcie-tegra194.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/controller/dwc/pcie-tegra194.c?id=70212c2300971506e986d95000d2745529cac9d7)@@ -1709,9 +1709,6 @@ static void pex\_ep\_event\_pex\_rst\_assert(struct tegra\_pcie\_dw \*pcie) if (ret) dev\_err(pcie->dev, "Failed to go Detect state: %d\n", ret); - pci\_epc\_deinit\_notify(pcie->pci.ep.epc);- dw\_pcie\_ep\_cleanup(&pcie->pci.ep);- reset\_control\_assert(pcie->core\_rst);  tegra\_pcie\_disable\_phy(pcie);@@ -1790,6 +1787,10 @@ static void pex\_ep\_event\_pex\_rst\_deassert(struct tegra\_pcie\_dw \*pcie) goto fail\_phy; } + /\* Perform cleanup that requires refclk \*/+ pci\_epc\_deinit\_notify(pcie->pci.ep.epc);+ dw\_pcie\_ep\_cleanup(&pcie->pci.ep);+ /\* Clear any stale interrupt statuses \*/ appl\_writel(pcie, 0xFFFFFFFF, APPL\_INTR\_STATUS\_L0); appl\_writel(pcie, 0xFFFFFFFF, APPL\_INTR\_STATUS\_L1\_0\_0); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:46:13 +0000


