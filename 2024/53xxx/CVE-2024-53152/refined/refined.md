The provided content describes a fix for a bug in the Tegra194 PCIe endpoint driver. This bug occurs when the host asserts PERST# (PCI Express reset signal).

**Root cause of vulnerability:**
- The endpoint cleanup functions `dw_pcie_ep_cleanup()` and `pci_epc_deinit_notify()` were being called during the `pex_ep_event_pex_rst_assert()` function, which executes when the host asserts PERST#.
- Immediately after this, the reference clock (refclk) is disabled by the host.
- The Tegra194 endpoint SoCs rely on the host's refclk for operation.
- Accessing hardware registers without the refclk leads to a crash.
- The cleanup functions require accessing hardware registers, causing a crash after the host asserts PERST#.

**Weaknesses/vulnerabilities present:**
- Improper timing of cleanup functions relative to the availability of the reference clock.
- Dependence on the host's reference clock for the endpoint's operational stability.
- Vulnerability to endpoint crashes due to hardware register access during power-down sequence.

**Impact of exploitation:**
- Endpoint crashes.
- Loss of functionality of the PCI endpoint device.
- Potential for denial of service or system instability.

**Attack vectors:**
- The vulnerability is triggered when the host asserts the PERST# signal to reset the PCI endpoint, which is typically part of normal PCI bus operation or during a reset event initiated by the host.

**Required attacker capabilities/position:**
- An attacker would need control or influence over the host system to trigger a PCI reset by asserting PERST# signal. This could be a privileged attacker or an attacker who has managed to compromise the host.

**Fix:**
The fix moves the controller cleanup functions (`pci_epc_deinit_notify()` and `dw_pcie_ep_cleanup()`) to the beginning of `pex_ep_event_pex_rst_deassert()`. This function is called when the host deasserts PERST#, which guarantees that the refclk is active, allowing the controller cleanup to be performed safely before the rest of the deassert operation.