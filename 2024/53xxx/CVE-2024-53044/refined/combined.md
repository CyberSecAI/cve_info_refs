=== Content from git.kernel.org_e3fde662_20250114_193245.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8966eb69a143b1c032365fe84f2815f3c46f2590)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8966eb69a143b1c032365fe84f2815f3c46f2590)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8966eb69a143b1c032365fe84f2815f3c46f2590)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8966eb69a143b1c032365fe84f2815f3c46f2590)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2024-10-23 13:05:41 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:47 +0100 |
| commit | [8966eb69a143b1c032365fe84f2815f3c46f2590](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8966eb69a143b1c032365fe84f2815f3c46f2590) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8966eb69a143b1c032365fe84f2815f3c46f2590)) | |
| tree | [90469972509bdbcce7010b7fedcfc01d14d5e869](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8966eb69a143b1c032365fe84f2815f3c46f2590) | |
| parent | [27bd7a742e171362c9eb52ad5d1d71d3321f949f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27bd7a742e171362c9eb52ad5d1d71d3321f949f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8966eb69a143b1c032365fe84f2815f3c46f2590&id2=27bd7a742e171362c9eb52ad5d1d71d3321f949f)) | |
| download | [linux-8966eb69a143b1c032365fe84f2815f3c46f2590.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8966eb69a143b1c032365fe84f2815f3c46f2590.tar.gz) | |

net/sched: sch\_api: fix xa\_insert() error path in tcf\_block\_get\_ext()[ Upstream commit a13e690191eafc154b3f60afe9ce35aa9b9128b4 ]
This command:
$ tc qdisc replace dev eth0 ingress\_block 1 egress\_block 1 clsact
Error: block dev insert failed: -EBUSY.
fails because user space requests the same block index to be set for
both ingress and egress.
[ side note, I don't think it even failed prior to commit 913b47d3424e
("net/sched: Introduce tc block netdev tracking infra"), because this
is a command from an old set of notes of mine which used to work, but
alas, I did not scientifically bisect this ]
The problem is not that it fails, but rather, that the second time
around, it fails differently (and irrecoverably):
$ tc qdisc replace dev eth0 ingress\_block 1 egress\_block 1 clsact
Error: dsa\_core: Flow block cb is busy.
[ another note: the extack is added by me for illustration purposes.
the context of the problem is that clsact\_init() obtains the same
&q->ingress\_block pointer as &q->egress\_block, and since we call
tcf\_block\_get\_ext() on both of them, "dev" will be added to the
block->ports xarray twice, thus failing the operation: once through
the ingress block pointer, and once again through the egress block
pointer. the problem itself is that when xa\_insert() fails, we have
emitted a FLOW\_BLOCK\_BIND command through ndo\_setup\_tc(), but the
offload never sees a corresponding FLOW\_BLOCK\_UNBIND. ]
Even correcting the bad user input, we still cannot recover:
$ tc qdisc replace dev swp3 ingress\_block 1 egress\_block 2 clsact
Error: dsa\_core: Flow block cb is busy.
Basically the only way to recover is to reboot the system, or unbind and
rebind the net device driver.
To fix the bug, we need to fill the correct error teardown path which
was missed during code movement, and call tcf\_block\_offload\_unbind()
when xa\_insert() fails.
[ last note, fundamentally I blame the label naming convention in
tcf\_block\_get\_ext() for the bug. The labels should be named after what
they do, not after the error path that jumps to them. This way, it is
obviously wrong that two labels pointing to the same code mean
something is wrong, and checking the code correctness at the goto site
is also easier ]
Fixes: 94e2557d086a ("net: sched: move block device tracking into tcf\_block\_get/put\_ext()")
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
Link: [https://patch.msgid.link/20241023100541.974362-1-vladimir.oltean@nxp.com](https://patch.msgid.link/20241023100541.974362-1-vladimir.oltean%40nxp.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8966eb69a143b1c032365fe84f2815f3c46f2590)

| -rw-r--r-- | [net/sched/cls\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/cls_api.c?id=8966eb69a143b1c032365fe84f2815f3c46f2590) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/net/sched/cls\_api.c b/net/sched/cls\_api.cindex 17d97bbe890fd5..bbc778c233c892 100644--- a/[net/sched/cls\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/cls_api.c?id=27bd7a742e171362c9eb52ad5d1d71d3321f949f)+++ b/[net/sched/cls\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/cls_api.c?id=8966eb69a143b1c032365fe84f2815f3c46f2590)@@ -1518,6 +1518,7 @@ int tcf\_block\_get\_ext(struct tcf\_block \*\*p\_block, struct Qdisc \*q, return 0;  err\_dev\_insert:+ tcf\_block\_offload\_unbind(block, q, ei); err\_block\_offload\_bind: tcf\_chain0\_head\_change\_cb\_del(block, ei); err\_chain0\_head\_change\_cb\_add: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:31:22 +0000



=== Content from git.kernel.org_c3227ead_20250114_193246.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2024-10-23 13:05:41 +0300 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-10-29 11:45:23 -0700 |
| commit | [a13e690191eafc154b3f60afe9ce35aa9b9128b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4)) | |
| tree | [1e092c3df36784834b1f75840964473121b9ce1f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4) | |
| parent | [4ce1f56a1eaced2523329bef800d004e30f2f76c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ce1f56a1eaced2523329bef800d004e30f2f76c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4&id2=4ce1f56a1eaced2523329bef800d004e30f2f76c)) | |
| download | [linux-a13e690191eafc154b3f60afe9ce35aa9b9128b4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a13e690191eafc154b3f60afe9ce35aa9b9128b4.tar.gz) | |

net/sched: sch\_api: fix xa\_insert() error path in tcf\_block\_get\_ext()This command:
$ tc qdisc replace dev eth0 ingress\_block 1 egress\_block 1 clsact
Error: block dev insert failed: -EBUSY.
fails because user space requests the same block index to be set for
both ingress and egress.
[ side note, I don't think it even failed prior to commit 913b47d3424e
("net/sched: Introduce tc block netdev tracking infra"), because this
is a command from an old set of notes of mine which used to work, but
alas, I did not scientifically bisect this ]
The problem is not that it fails, but rather, that the second time
around, it fails differently (and irrecoverably):
$ tc qdisc replace dev eth0 ingress\_block 1 egress\_block 1 clsact
Error: dsa\_core: Flow block cb is busy.
[ another note: the extack is added by me for illustration purposes.
the context of the problem is that clsact\_init() obtains the same
&q->ingress\_block pointer as &q->egress\_block, and since we call
tcf\_block\_get\_ext() on both of them, "dev" will be added to the
block->ports xarray twice, thus failing the operation: once through
the ingress block pointer, and once again through the egress block
pointer. the problem itself is that when xa\_insert() fails, we have
emitted a FLOW\_BLOCK\_BIND command through ndo\_setup\_tc(), but the
offload never sees a corresponding FLOW\_BLOCK\_UNBIND. ]
Even correcting the bad user input, we still cannot recover:
$ tc qdisc replace dev swp3 ingress\_block 1 egress\_block 2 clsact
Error: dsa\_core: Flow block cb is busy.
Basically the only way to recover is to reboot the system, or unbind and
rebind the net device driver.
To fix the bug, we need to fill the correct error teardown path which
was missed during code movement, and call tcf\_block\_offload\_unbind()
when xa\_insert() fails.
[ last note, fundamentally I blame the label naming convention in
tcf\_block\_get\_ext() for the bug. The labels should be named after what
they do, not after the error path that jumps to them. This way, it is
obviously wrong that two labels pointing to the same code mean
something is wrong, and checking the code correctness at the goto site
is also easier ]
Fixes: 94e2557d086a ("net: sched: move block device tracking into tcf\_block\_get/put\_ext()")
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
Link: [https://patch.msgid.link/20241023100541.974362-1-vladimir.oltean@nxp.com](https://patch.msgid.link/20241023100541.974362-1-vladimir.oltean%40nxp.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4)

| -rw-r--r-- | [net/sched/cls\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/cls_api.c?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/net/sched/cls\_api.c b/net/sched/cls\_api.cindex 17d97bbe890fd5..bbc778c233c892 100644--- a/[net/sched/cls\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/cls_api.c?id=4ce1f56a1eaced2523329bef800d004e30f2f76c)+++ b/[net/sched/cls\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/cls_api.c?id=a13e690191eafc154b3f60afe9ce35aa9b9128b4)@@ -1518,6 +1518,7 @@ int tcf\_block\_get\_ext(struct tcf\_block \*\*p\_block, struct Qdisc \*q, return 0;  err\_dev\_insert:+ tcf\_block\_offload\_unbind(block, q, ei); err\_block\_offload\_bind: tcf\_chain0\_head\_change\_cb\_del(block, ei); err\_chain0\_head\_change\_cb\_add: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:31:23 +0000


