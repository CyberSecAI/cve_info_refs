=== Content from git.kernel.org_3959bc20_20250114_185123.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-17 21:07:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-09 10:32:44 +0100 |
| commit | [9b07fb464eb69a752406e78e62ab3a60bfa7b00d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d)) | |
| tree | [7e76370f9a73ba5e6b4adb7651f19a1e6ef88f87](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d) | |
| parent | [1b8868b818ecbbf70d883b18354c3c0b45466c35](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b8868b818ecbbf70d883b18354c3c0b45466c35) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d&id2=1b8868b818ecbbf70d883b18354c3c0b45466c35)) | |
| download | [linux-9b07fb464eb69a752406e78e62ab3a60bfa7b00d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9b07fb464eb69a752406e78e62ab3a60bfa7b00d.tar.gz) | |

comedi: Flush partial mappings in error casecommit ce8f9fb651fac95dd41f69afe54d935420b945bd upstream.
If some remap\_pfn\_range() calls succeeded before one failed, we still have
buffer pages mapped into the userspace page tables when we drop the buffer
reference with comedi\_buf\_map\_put(bm). The userspace mappings are only
cleaned up later in the mmap error path.
Fix it by explicitly flushing all mappings in our VMA on the error path.
See commit 79a61cc3fc04 ("mm: avoid leaving partial pfn mappings around in
error case").
Cc: stable@vger.kernel.org
Fixes: ed9eccbe8970 ("Staging: add comedi core")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce@google.com](https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d)

| -rw-r--r-- | [drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/comedi_fops.c?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 0 deletions

| diff --git a/drivers/comedi/comedi\_fops.c b/drivers/comedi/comedi\_fops.cindex 1548dea15df140..81763e3f948467 100644--- a/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=1b8868b818ecbbf70d883b18354c3c0b45466c35)+++ b/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=9b07fb464eb69a752406e78e62ab3a60bfa7b00d)@@ -2407,6 +2407,18 @@ static int comedi\_mmap(struct file \*file, struct vm\_area\_struct \*vma)  start += PAGE\_SIZE; }++#ifdef CONFIG\_MMU+ /\*+ \* Leaving behind a partial mapping of a buffer we're about to+ \* drop is unsafe, see remap\_pfn\_range\_notrack().+ \* We need to zap the range here ourselves instead of relying+ \* on the automatic zapping in remap\_pfn\_range() because we call+ \* remap\_pfn\_range() in a loop.+ \*/+ if (retval)+ zap\_vma\_ptes(vma, vma->vm\_start, size);+#endif }  if (retval == 0) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:50:00 +0000



=== Content from git.kernel.org_ed2e03c9_20250114_185125.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ce8f9fb651fac95dd41f69afe54d935420b945bd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce8f9fb651fac95dd41f69afe54d935420b945bd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce8f9fb651fac95dd41f69afe54d935420b945bd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce8f9fb651fac95dd41f69afe54d935420b945bd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-17 21:07:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-05 14:01:07 +0100 |
| commit | [ce8f9fb651fac95dd41f69afe54d935420b945bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce8f9fb651fac95dd41f69afe54d935420b945bd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ce8f9fb651fac95dd41f69afe54d935420b945bd)) | |
| tree | [bf669f5b548324c35fe009dfcb62c83d0d66b7dc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce8f9fb651fac95dd41f69afe54d935420b945bd) | |
| parent | [9365f0de4303f82ed4c2db1c39d3de824b249d80](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9365f0de4303f82ed4c2db1c39d3de824b249d80) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce8f9fb651fac95dd41f69afe54d935420b945bd&id2=9365f0de4303f82ed4c2db1c39d3de824b249d80)) | |
| download | [linux-ce8f9fb651fac95dd41f69afe54d935420b945bd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ce8f9fb651fac95dd41f69afe54d935420b945bd.tar.gz) | |

comedi: Flush partial mappings in error caseIf some remap\_pfn\_range() calls succeeded before one failed, we still have
buffer pages mapped into the userspace page tables when we drop the buffer
reference with comedi\_buf\_map\_put(bm). The userspace mappings are only
cleaned up later in the mmap error path.
Fix it by explicitly flushing all mappings in our VMA on the error path.
See commit 79a61cc3fc04 ("mm: avoid leaving partial pfn mappings around in
error case").
Cc: stable@vger.kernel.org
Fixes: ed9eccbe8970 ("Staging: add comedi core")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce@google.com](https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce8f9fb651fac95dd41f69afe54d935420b945bd)

| -rw-r--r-- | [drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/comedi_fops.c?id=ce8f9fb651fac95dd41f69afe54d935420b945bd) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 0 deletions

| diff --git a/drivers/comedi/comedi\_fops.c b/drivers/comedi/comedi\_fops.cindex 1b481731df964e..b9df9b19d4bd97 100644--- a/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=9365f0de4303f82ed4c2db1c39d3de824b249d80)+++ b/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=ce8f9fb651fac95dd41f69afe54d935420b945bd)@@ -2407,6 +2407,18 @@ static int comedi\_mmap(struct file \*file, struct vm\_area\_struct \*vma)  start += PAGE\_SIZE; }++#ifdef CONFIG\_MMU+ /\*+ \* Leaving behind a partial mapping of a buffer we're about to+ \* drop is unsafe, see remap\_pfn\_range\_notrack().+ \* We need to zap the range here ourselves instead of relying+ \* on the automatic zapping in remap\_pfn\_range() because we call+ \* remap\_pfn\_range() in a loop.+ \*/+ if (retval)+ zap\_vma\_ptes(vma, vma->vm\_start, size);+#endif }  if (retval == 0) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:50:02 +0000



=== Content from git.kernel.org_e7955841_20250114_185120.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=16c507df509113c037cdc0ba642b9ab3389bd26c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16c507df509113c037cdc0ba642b9ab3389bd26c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16c507df509113c037cdc0ba642b9ab3389bd26c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16c507df509113c037cdc0ba642b9ab3389bd26c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-17 21:07:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:53:59 +0100 |
| commit | [16c507df509113c037cdc0ba642b9ab3389bd26c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16c507df509113c037cdc0ba642b9ab3389bd26c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=16c507df509113c037cdc0ba642b9ab3389bd26c)) | |
| tree | [de6fcf10814e4d3fb5dece0f817edacbe3307f58](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16c507df509113c037cdc0ba642b9ab3389bd26c) | |
| parent | [65988ab857cc83be2e47d757f82c7373e3042426](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65988ab857cc83be2e47d757f82c7373e3042426) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16c507df509113c037cdc0ba642b9ab3389bd26c&id2=65988ab857cc83be2e47d757f82c7373e3042426)) | |
| download | [linux-16c507df509113c037cdc0ba642b9ab3389bd26c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-16c507df509113c037cdc0ba642b9ab3389bd26c.tar.gz) | |

comedi: Flush partial mappings in error casecommit ce8f9fb651fac95dd41f69afe54d935420b945bd upstream.
If some remap\_pfn\_range() calls succeeded before one failed, we still have
buffer pages mapped into the userspace page tables when we drop the buffer
reference with comedi\_buf\_map\_put(bm). The userspace mappings are only
cleaned up later in the mmap error path.
Fix it by explicitly flushing all mappings in our VMA on the error path.
See commit 79a61cc3fc04 ("mm: avoid leaving partial pfn mappings around in
error case").
Cc: stable@vger.kernel.org
Fixes: ed9eccbe8970 ("Staging: add comedi core")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce@google.com](https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16c507df509113c037cdc0ba642b9ab3389bd26c)

| -rw-r--r-- | [drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/comedi_fops.c?id=16c507df509113c037cdc0ba642b9ab3389bd26c) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 0 deletions

| diff --git a/drivers/comedi/comedi\_fops.c b/drivers/comedi/comedi\_fops.cindex e2114bcf815ad8..37eb26abfd8788 100644--- a/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=65988ab857cc83be2e47d757f82c7373e3042426)+++ b/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=16c507df509113c037cdc0ba642b9ab3389bd26c)@@ -2402,6 +2402,18 @@ static int comedi\_mmap(struct file \*file, struct vm\_area\_struct \*vma)  start += PAGE\_SIZE; }++#ifdef CONFIG\_MMU+ /\*+ \* Leaving behind a partial mapping of a buffer we're about to+ \* drop is unsafe, see remap\_pfn\_range\_notrack().+ \* We need to zap the range here ourselves instead of relying+ \* on the automatic zapping in remap\_pfn\_range() because we call+ \* remap\_pfn\_range() in a loop.+ \*/+ if (retval)+ zap\_vma\_ptes(vma, vma->vm\_start, size);+#endif }  if (retval == 0) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:49:57 +0000



=== Content from git.kernel.org_619e7334_20250114_185122.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-17 21:07:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:13 +0100 |
| commit | [8797b7712de704dc231f9e821d8eb3b9aeb3a032](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032)) | |
| tree | [aca60aea0a2bda1846916996907edf8c2b266c86](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032) | |
| parent | [1484fdc59e04e562c294aead2fe9b93bbc96a7ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1484fdc59e04e562c294aead2fe9b93bbc96a7ef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032&id2=1484fdc59e04e562c294aead2fe9b93bbc96a7ef)) | |
| download | [linux-8797b7712de704dc231f9e821d8eb3b9aeb3a032.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8797b7712de704dc231f9e821d8eb3b9aeb3a032.tar.gz) | |

comedi: Flush partial mappings in error casecommit ce8f9fb651fac95dd41f69afe54d935420b945bd upstream.
If some remap\_pfn\_range() calls succeeded before one failed, we still have
buffer pages mapped into the userspace page tables when we drop the buffer
reference with comedi\_buf\_map\_put(bm). The userspace mappings are only
cleaned up later in the mmap error path.
Fix it by explicitly flushing all mappings in our VMA on the error path.
See commit 79a61cc3fc04 ("mm: avoid leaving partial pfn mappings around in
error case").
Cc: stable@vger.kernel.org
Fixes: ed9eccbe8970 ("Staging: add comedi core")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce@google.com](https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032)

| -rw-r--r-- | [drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/comedi_fops.c?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 0 deletions

| diff --git a/drivers/comedi/comedi\_fops.c b/drivers/comedi/comedi\_fops.cindex 763cea8418f8e8..ea1d31f53454b1 100644--- a/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=1484fdc59e04e562c294aead2fe9b93bbc96a7ef)+++ b/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=8797b7712de704dc231f9e821d8eb3b9aeb3a032)@@ -2402,6 +2402,18 @@ static int comedi\_mmap(struct file \*file, struct vm\_area\_struct \*vma)  start += PAGE\_SIZE; }++#ifdef CONFIG\_MMU+ /\*+ \* Leaving behind a partial mapping of a buffer we're about to+ \* drop is unsafe, see remap\_pfn\_range\_notrack().+ \* We need to zap the range here ourselves instead of relying+ \* on the automatic zapping in remap\_pfn\_range() because we call+ \* remap\_pfn\_range() in a loop.+ \*/+ if (retval)+ zap\_vma\_ptes(vma, vma->vm\_start, size);+#endif }  if (retval == 0) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:49:59 +0000



=== Content from git.kernel.org_fb7497c3_20250114_185124.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c6963a06ce5c61d3238751ada04ee1569663a828)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6963a06ce5c61d3238751ada04ee1569663a828)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6963a06ce5c61d3238751ada04ee1569663a828)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6963a06ce5c61d3238751ada04ee1569663a828)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-17 21:07:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 13:54:11 +0100 |
| commit | [c6963a06ce5c61d3238751ada04ee1569663a828](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6963a06ce5c61d3238751ada04ee1569663a828) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c6963a06ce5c61d3238751ada04ee1569663a828)) | |
| tree | [86bc27323a55bb3a2c7c0c0a16475e609b643020](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6963a06ce5c61d3238751ada04ee1569663a828) | |
| parent | [45a8f8232a495221ed058191629f5c628f21601a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=45a8f8232a495221ed058191629f5c628f21601a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6963a06ce5c61d3238751ada04ee1569663a828&id2=45a8f8232a495221ed058191629f5c628f21601a)) | |
| download | [linux-c6963a06ce5c61d3238751ada04ee1569663a828.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c6963a06ce5c61d3238751ada04ee1569663a828.tar.gz) | |

comedi: Flush partial mappings in error casecommit ce8f9fb651fac95dd41f69afe54d935420b945bd upstream.
If some remap\_pfn\_range() calls succeeded before one failed, we still have
buffer pages mapped into the userspace page tables when we drop the buffer
reference with comedi\_buf\_map\_put(bm). The userspace mappings are only
cleaned up later in the mmap error path.
Fix it by explicitly flushing all mappings in our VMA on the error path.
See commit 79a61cc3fc04 ("mm: avoid leaving partial pfn mappings around in
error case").
Cc: stable@vger.kernel.org
Fixes: ed9eccbe8970 ("Staging: add comedi core")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce@google.com](https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6963a06ce5c61d3238751ada04ee1569663a828)

| -rw-r--r-- | [drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/comedi_fops.c?id=c6963a06ce5c61d3238751ada04ee1569663a828) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 0 deletions

| diff --git a/drivers/comedi/comedi\_fops.c b/drivers/comedi/comedi\_fops.cindex 1b481731df964e..b9df9b19d4bd97 100644--- a/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=45a8f8232a495221ed058191629f5c628f21601a)+++ b/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=c6963a06ce5c61d3238751ada04ee1569663a828)@@ -2407,6 +2407,18 @@ static int comedi\_mmap(struct file \*file, struct vm\_area\_struct \*vma)  start += PAGE\_SIZE; }++#ifdef CONFIG\_MMU+ /\*+ \* Leaving behind a partial mapping of a buffer we're about to+ \* drop is unsafe, see remap\_pfn\_range\_notrack().+ \* We need to zap the range here ourselves instead of relying+ \* on the automatic zapping in remap\_pfn\_range() because we call+ \* remap\_pfn\_range() in a loop.+ \*/+ if (retval)+ zap\_vma\_ptes(vma, vma->vm\_start, size);+#endif }  if (retval == 0) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:50:02 +0000



=== Content from git.kernel.org_0d82e81a_20250114_185121.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-17 21:07:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:44:36 +0100 |
| commit | [57f048c2d205b85e34282a9b0b0ae177e84c2f44](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44)) | |
| tree | [7fdfc343d3a5cc579069ebc71f01c7ca5f66f2de](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44) | |
| parent | [d0ddd2c92b75a19a37c887154223372b600fed37](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0ddd2c92b75a19a37c887154223372b600fed37) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44&id2=d0ddd2c92b75a19a37c887154223372b600fed37)) | |
| download | [linux-57f048c2d205b85e34282a9b0b0ae177e84c2f44.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-57f048c2d205b85e34282a9b0b0ae177e84c2f44.tar.gz) | |

comedi: Flush partial mappings in error casecommit ce8f9fb651fac95dd41f69afe54d935420b945bd upstream.
If some remap\_pfn\_range() calls succeeded before one failed, we still have
buffer pages mapped into the userspace page tables when we drop the buffer
reference with comedi\_buf\_map\_put(bm). The userspace mappings are only
cleaned up later in the mmap error path.
Fix it by explicitly flushing all mappings in our VMA on the error path.
See commit 79a61cc3fc04 ("mm: avoid leaving partial pfn mappings around in
error case").
Cc: stable@vger.kernel.org
Fixes: ed9eccbe8970 ("Staging: add comedi core")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce@google.com](https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44)

| -rw-r--r-- | [drivers/staging/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/staging/comedi/comedi_fops.c?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 0 deletions

| diff --git a/drivers/staging/comedi/comedi\_fops.c b/drivers/staging/comedi/comedi\_fops.cindex e84b4fb493d627..8b2337f8303d85 100644--- a/[drivers/staging/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/comedi_fops.c?id=d0ddd2c92b75a19a37c887154223372b600fed37)+++ b/[drivers/staging/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/comedi_fops.c?id=57f048c2d205b85e34282a9b0b0ae177e84c2f44)@@ -2383,6 +2383,18 @@ static int comedi\_mmap(struct file \*file, struct vm\_area\_struct \*vma)  start += PAGE\_SIZE; }++#ifdef CONFIG\_MMU+ /\*+ \* Leaving behind a partial mapping of a buffer we're about to+ \* drop is unsafe, see remap\_pfn\_range\_notrack().+ \* We need to zap the range here ourselves instead of relying+ \* on the automatic zapping in remap\_pfn\_range() because we call+ \* remap\_pfn\_range() in a loop.+ \*/+ if (retval)+ zap\_vma\_ptes(vma, vma->vm\_start, size);+#endif }  if (retval == 0) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:49:59 +0000



=== Content from git.kernel.org_7ee8271b_20250114_185124.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b9322408d83accc8b96322bc7356593206288c56)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b9322408d83accc8b96322bc7356593206288c56)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9322408d83accc8b96322bc7356593206288c56)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9322408d83accc8b96322bc7356593206288c56)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-17 21:07:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:48:09 +0100 |
| commit | [b9322408d83accc8b96322bc7356593206288c56](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9322408d83accc8b96322bc7356593206288c56) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b9322408d83accc8b96322bc7356593206288c56)) | |
| tree | [c36413a1de605316a1176ba57046641f32af371a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b9322408d83accc8b96322bc7356593206288c56) | |
| parent | [a4236cc4f9524287a7659878026c21cfba16b082](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4236cc4f9524287a7659878026c21cfba16b082) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9322408d83accc8b96322bc7356593206288c56&id2=a4236cc4f9524287a7659878026c21cfba16b082)) | |
| download | [linux-b9322408d83accc8b96322bc7356593206288c56.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b9322408d83accc8b96322bc7356593206288c56.tar.gz) | |

comedi: Flush partial mappings in error casecommit ce8f9fb651fac95dd41f69afe54d935420b945bd upstream.
If some remap\_pfn\_range() calls succeeded before one failed, we still have
buffer pages mapped into the userspace page tables when we drop the buffer
reference with comedi\_buf\_map\_put(bm). The userspace mappings are only
cleaned up later in the mmap error path.
Fix it by explicitly flushing all mappings in our VMA on the error path.
See commit 79a61cc3fc04 ("mm: avoid leaving partial pfn mappings around in
error case").
Cc: stable@vger.kernel.org
Fixes: ed9eccbe8970 ("Staging: add comedi core")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce@google.com](https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b9322408d83accc8b96322bc7356593206288c56)

| -rw-r--r-- | [drivers/staging/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/staging/comedi/comedi_fops.c?id=b9322408d83accc8b96322bc7356593206288c56) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 0 deletions

| diff --git a/drivers/staging/comedi/comedi\_fops.c b/drivers/staging/comedi/comedi\_fops.cindex 9858fae816f721..8f896e6208a8d1 100644--- a/[drivers/staging/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/comedi_fops.c?id=a4236cc4f9524287a7659878026c21cfba16b082)+++ b/[drivers/staging/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/comedi_fops.c?id=b9322408d83accc8b96322bc7356593206288c56)@@ -2402,6 +2402,18 @@ static int comedi\_mmap(struct file \*file, struct vm\_area\_struct \*vma)  start += PAGE\_SIZE; }++#ifdef CONFIG\_MMU+ /\*+ \* Leaving behind a partial mapping of a buffer we're about to+ \* drop is unsafe, see remap\_pfn\_range\_notrack().+ \* We need to zap the range here ourselves instead of relying+ \* on the automatic zapping in remap\_pfn\_range() because we call+ \* remap\_pfn\_range() in a loop.+ \*/+ if (retval)+ zap\_vma\_ptes(vma, vma->vm\_start, size);+#endif }  if (retval == 0) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:50:01 +0000



=== Content from git.kernel.org_014acc3b_20250114_185121.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=297f14fbb81895f4ccdb0ad25d196786d6461e00)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=297f14fbb81895f4ccdb0ad25d196786d6461e00)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=297f14fbb81895f4ccdb0ad25d196786d6461e00)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=297f14fbb81895f4ccdb0ad25d196786d6461e00)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-17 21:07:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-05 14:02:46 +0100 |
| commit | [297f14fbb81895f4ccdb0ad25d196786d6461e00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=297f14fbb81895f4ccdb0ad25d196786d6461e00) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=297f14fbb81895f4ccdb0ad25d196786d6461e00)) | |
| tree | [bd25986c007c47b4c9186ed8189c408a0c2877b5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=297f14fbb81895f4ccdb0ad25d196786d6461e00) | |
| parent | [83af1cfa10d9aafdabd06b3655e07727f373b434](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83af1cfa10d9aafdabd06b3655e07727f373b434) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=297f14fbb81895f4ccdb0ad25d196786d6461e00&id2=83af1cfa10d9aafdabd06b3655e07727f373b434)) | |
| download | [linux-297f14fbb81895f4ccdb0ad25d196786d6461e00.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-297f14fbb81895f4ccdb0ad25d196786d6461e00.tar.gz) | |

comedi: Flush partial mappings in error casecommit ce8f9fb651fac95dd41f69afe54d935420b945bd upstream.
If some remap\_pfn\_range() calls succeeded before one failed, we still have
buffer pages mapped into the userspace page tables when we drop the buffer
reference with comedi\_buf\_map\_put(bm). The userspace mappings are only
cleaned up later in the mmap error path.
Fix it by explicitly flushing all mappings in our VMA on the error path.
See commit 79a61cc3fc04 ("mm: avoid leaving partial pfn mappings around in
error case").
Cc: stable@vger.kernel.org
Fixes: ed9eccbe8970 ("Staging: add comedi core")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce@google.com](https://lore.kernel.org/r/20241017-comedi-tlb-v3-1-16b82f9372ce%40google.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=297f14fbb81895f4ccdb0ad25d196786d6461e00)

| -rw-r--r-- | [drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/comedi_fops.c?id=297f14fbb81895f4ccdb0ad25d196786d6461e00) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 0 deletions

| diff --git a/drivers/comedi/comedi\_fops.c b/drivers/comedi/comedi\_fops.cindex 1b481731df964e..b9df9b19d4bd97 100644--- a/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=83af1cfa10d9aafdabd06b3655e07727f373b434)+++ b/[drivers/comedi/comedi\_fops.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/comedi_fops.c?id=297f14fbb81895f4ccdb0ad25d196786d6461e00)@@ -2407,6 +2407,18 @@ static int comedi\_mmap(struct file \*file, struct vm\_area\_struct \*vma)  start += PAGE\_SIZE; }++#ifdef CONFIG\_MMU+ /\*+ \* Leaving behind a partial mapping of a buffer we're about to+ \* drop is unsafe, see remap\_pfn\_range\_notrack().+ \* We need to zap the range here ourselves instead of relying+ \* on the automatic zapping in remap\_pfn\_range() because we call+ \* remap\_pfn\_range() in a loop.+ \*/+ if (retval)+ zap\_vma\_ptes(vma, vma->vm\_start, size);+#endif }  if (retval == 0) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:49:58 +0000


