=== Content from git.kernel.org_73041dc9_20250114_222225.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3c36a72c1d27de6618c1c480c793d9924640f5bb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c36a72c1d27de6618c1c480c793d9924640f5bb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c36a72c1d27de6618c1c480c793d9924640f5bb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c36a72c1d27de6618c1c480c793d9924640f5bb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qu Wenruo <wqu@suse.com> | 2024-09-19 20:18:11 +0930 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2024-10-22 16:10:51 +0200 |
| commit | [3c36a72c1d27de6618c1c480c793d9924640f5bb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c36a72c1d27de6618c1c480c793d9924640f5bb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3c36a72c1d27de6618c1c480c793d9924640f5bb)) | |
| tree | [092747142852827ccd89a4d535599dbd9b591c06](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c36a72c1d27de6618c1c480c793d9924640f5bb) | |
| parent | [7a2339058ed71f54c1e12e1b3c25aab1b1ba7943](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a2339058ed71f54c1e12e1b3c25aab1b1ba7943) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c36a72c1d27de6618c1c480c793d9924640f5bb&id2=7a2339058ed71f54c1e12e1b3c25aab1b1ba7943)) | |
| download | [linux-3c36a72c1d27de6618c1c480c793d9924640f5bb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3c36a72c1d27de6618c1c480c793d9924640f5bb.tar.gz) | |

btrfs: reject ro->rw reconfiguration if there are hard ro requirements[BUG]
Syzbot reports the following crash:
BTRFS info (device loop0 state MCS): disabling free space tree
BTRFS info (device loop0 state MCS): clearing compat-ro feature flag for FREE\_SPACE\_TREE (0x1)
BTRFS info (device loop0 state MCS): clearing compat-ro feature flag for FREE\_SPACE\_TREE\_VALID (0x2)
Oops: general protection fault, probably for non-canonical address 0xdffffc0000000003: 0000 [#1] PREEMPT SMP KASAN NOPTI
KASAN: null-ptr-deref in range [0x0000000000000018-0x000000000000001f]
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
RIP: 0010:backup\_super\_roots fs/btrfs/disk-io.c:1691 [inline]
RIP: 0010:write\_all\_supers+0x97a/0x40f0 fs/btrfs/disk-io.c:4041
Call Trace:
<TASK>
btrfs\_commit\_transaction+0x1eae/0x3740 fs/btrfs/transaction.c:2530
btrfs\_delete\_free\_space\_tree+0x383/0x730 fs/btrfs/free-space-tree.c:1312
btrfs\_start\_pre\_rw\_mount+0xf28/0x1300 fs/btrfs/disk-io.c:3012
btrfs\_remount\_rw fs/btrfs/super.c:1309 [inline]
btrfs\_reconfigure+0xae6/0x2d40 fs/btrfs/super.c:1534
btrfs\_reconfigure\_for\_mount fs/btrfs/super.c:2020 [inline]
btrfs\_get\_tree\_subvol fs/btrfs/super.c:2079 [inline]
btrfs\_get\_tree+0x918/0x1920 fs/btrfs/super.c:2115
vfs\_get\_tree+0x90/0x2b0 fs/super.c:1800
do\_new\_mount+0x2be/0xb40 fs/namespace.c:3472
do\_mount fs/namespace.c:3812 [inline]
\_\_do\_sys\_mount fs/namespace.c:4020 [inline]
\_\_se\_sys\_mount+0x2d6/0x3c0 fs/namespace.c:3997
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
[CAUSE]
To support mounting different subvolume with different RO/RW flags for
the new mount APIs, btrfs introduced two workaround to support this feature:
- Skip mount option/feature checks if we are mounting a different
subvolume
- Reconfigure the fs to RW if the initial mount is RO
Combining these two, we can have the following sequence:
- Mount the fs ro,rescue=all,clear\_cache,space\_cache=v1
rescue=all will mark the fs as hard read-only, so no v2 cache clearing
will happen.
- Mount a subvolume rw of the same fs.
We go into btrfs\_get\_tree\_subvol(), but fc\_mount() returns EBUSY
because our new fc is RW, different from the original fs.
Now we enter btrfs\_reconfigure\_for\_mount(), which switches the RO flag
first so that we can grab the existing fs\_info.
Then we reconfigure the fs to RW.
- During reconfiguration, option/features check is skipped
This means we will restart the v2 cache clearing, and convert back to
v1 cache.
This will trigger fs writes, and since the original fs has "rescue=all"
option, it skips the csum tree read.
And eventually causing NULL pointer dereference in super block
writeback.
[FIX]
For reconfiguration caused by different subvolume RO/RW flags, ensure we
always run btrfs\_check\_options() to ensure we have proper hard RO
requirements met.
In fact the function btrfs\_check\_options() doesn't really do many
complex checks, but hard RO requirement and some feature dependency
checks, thus there is no special reason not to do the check for mount
reconfiguration.
Reported-by: syzbot+56360f93efa90ff15870@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/0000000000008c5d090621cb2770@google.com/](https://lore.kernel.org/linux-btrfs/0000000000008c5d090621cb2770%40google.com/)
Fixes: f044b318675f ("btrfs: handle the ro->rw transition for mounting different subvolumes")
CC: stable@vger.kernel.org # 6.8+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c36a72c1d27de6618c1c480c793d9924640f5bb)

| -rw-r--r-- | [fs/btrfs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/super.c?id=3c36a72c1d27de6618c1c480c793d9924640f5bb) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/fs/btrfs/super.c b/fs/btrfs/super.cindex 3f8673f97432b8..926d7a9ed99df0 100644--- a/[fs/btrfs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/super.c?id=7a2339058ed71f54c1e12e1b3c25aab1b1ba7943)+++ b/[fs/btrfs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/super.c?id=3c36a72c1d27de6618c1c480c793d9924640f5bb)@@ -1507,8 +1507,7 @@ static int btrfs\_reconfigure(struct fs\_context \*fc) sync\_filesystem(sb); set\_bit(BTRFS\_FS\_STATE\_REMOUNTING, &fs\_info->fs\_state); - if (!mount\_reconfigure &&- !btrfs\_check\_options(fs\_info, &ctx->mount\_opt, fc->sb\_flags))+ if (!btrfs\_check\_options(fs\_info, &ctx->mount\_opt, fc->sb\_flags)) return -EINVAL;  ret = btrfs\_check\_features(fs\_info, !(fc->sb\_flags & SB\_RDONLY)); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:21:02 +0000



=== Content from git.kernel.org_3ee465f6_20250114_222224.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=23724398b55d9570f6ae79dd2ea026fff8896bf1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23724398b55d9570f6ae79dd2ea026fff8896bf1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23724398b55d9570f6ae79dd2ea026fff8896bf1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23724398b55d9570f6ae79dd2ea026fff8896bf1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qu Wenruo <wqu@suse.com> | 2024-09-19 20:18:11 +0930 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:40 +0100 |
| commit | [23724398b55d9570f6ae79dd2ea026fff8896bf1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23724398b55d9570f6ae79dd2ea026fff8896bf1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=23724398b55d9570f6ae79dd2ea026fff8896bf1)) | |
| tree | [41aa214a3e60e0c4cdeb92329e93bbd4c8cf718d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23724398b55d9570f6ae79dd2ea026fff8896bf1) | |
| parent | [bee6f519137bab011c65012904b20e3e7f8c6da5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bee6f519137bab011c65012904b20e3e7f8c6da5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23724398b55d9570f6ae79dd2ea026fff8896bf1&id2=bee6f519137bab011c65012904b20e3e7f8c6da5)) | |
| download | [linux-23724398b55d9570f6ae79dd2ea026fff8896bf1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-23724398b55d9570f6ae79dd2ea026fff8896bf1.tar.gz) | |

btrfs: reject ro->rw reconfiguration if there are hard ro requirementscommit 3c36a72c1d27de6618c1c480c793d9924640f5bb upstream.
[BUG]
Syzbot reports the following crash:
BTRFS info (device loop0 state MCS): disabling free space tree
BTRFS info (device loop0 state MCS): clearing compat-ro feature flag for FREE\_SPACE\_TREE (0x1)
BTRFS info (device loop0 state MCS): clearing compat-ro feature flag for FREE\_SPACE\_TREE\_VALID (0x2)
Oops: general protection fault, probably for non-canonical address 0xdffffc0000000003: 0000 [#1] PREEMPT SMP KASAN NOPTI
KASAN: null-ptr-deref in range [0x0000000000000018-0x000000000000001f]
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.3-debian-1.16.3-2~bpo12+1 04/01/2014
RIP: 0010:backup\_super\_roots fs/btrfs/disk-io.c:1691 [inline]
RIP: 0010:write\_all\_supers+0x97a/0x40f0 fs/btrfs/disk-io.c:4041
Call Trace:
<TASK>
btrfs\_commit\_transaction+0x1eae/0x3740 fs/btrfs/transaction.c:2530
btrfs\_delete\_free\_space\_tree+0x383/0x730 fs/btrfs/free-space-tree.c:1312
btrfs\_start\_pre\_rw\_mount+0xf28/0x1300 fs/btrfs/disk-io.c:3012
btrfs\_remount\_rw fs/btrfs/super.c:1309 [inline]
btrfs\_reconfigure+0xae6/0x2d40 fs/btrfs/super.c:1534
btrfs\_reconfigure\_for\_mount fs/btrfs/super.c:2020 [inline]
btrfs\_get\_tree\_subvol fs/btrfs/super.c:2079 [inline]
btrfs\_get\_tree+0x918/0x1920 fs/btrfs/super.c:2115
vfs\_get\_tree+0x90/0x2b0 fs/super.c:1800
do\_new\_mount+0x2be/0xb40 fs/namespace.c:3472
do\_mount fs/namespace.c:3812 [inline]
\_\_do\_sys\_mount fs/namespace.c:4020 [inline]
\_\_se\_sys\_mount+0x2d6/0x3c0 fs/namespace.c:3997
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
[CAUSE]
To support mounting different subvolume with different RO/RW flags for
the new mount APIs, btrfs introduced two workaround to support this feature:
- Skip mount option/feature checks if we are mounting a different
subvolume
- Reconfigure the fs to RW if the initial mount is RO
Combining these two, we can have the following sequence:
- Mount the fs ro,rescue=all,clear\_cache,space\_cache=v1
rescue=all will mark the fs as hard read-only, so no v2 cache clearing
will happen.
- Mount a subvolume rw of the same fs.
We go into btrfs\_get\_tree\_subvol(), but fc\_mount() returns EBUSY
because our new fc is RW, different from the original fs.
Now we enter btrfs\_reconfigure\_for\_mount(), which switches the RO flag
first so that we can grab the existing fs\_info.
Then we reconfigure the fs to RW.
- During reconfiguration, option/features check is skipped
This means we will restart the v2 cache clearing, and convert back to
v1 cache.
This will trigger fs writes, and since the original fs has "rescue=all"
option, it skips the csum tree read.
And eventually causing NULL pointer dereference in super block
writeback.
[FIX]
For reconfiguration caused by different subvolume RO/RW flags, ensure we
always run btrfs\_check\_options() to ensure we have proper hard RO
requirements met.
In fact the function btrfs\_check\_options() doesn't really do many
complex checks, but hard RO requirement and some feature dependency
checks, thus there is no special reason not to do the check for mount
reconfiguration.
Reported-by: syzbot+56360f93efa90ff15870@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/linux-btrfs/0000000000008c5d090621cb2770@google.com/](https://lore.kernel.org/linux-btrfs/0000000000008c5d090621cb2770%40google.com/)
Fixes: f044b318675f ("btrfs: handle the ro->rw transition for mounting different subvolumes")
CC: stable@vger.kernel.org # 6.8+
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23724398b55d9570f6ae79dd2ea026fff8896bf1)

| -rw-r--r-- | [fs/btrfs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/super.c?id=23724398b55d9570f6ae79dd2ea026fff8896bf1) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/fs/btrfs/super.c b/fs/btrfs/super.cindex 3f8673f97432b8..926d7a9ed99df0 100644--- a/[fs/btrfs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/super.c?id=bee6f519137bab011c65012904b20e3e7f8c6da5)+++ b/[fs/btrfs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/super.c?id=23724398b55d9570f6ae79dd2ea026fff8896bf1)@@ -1507,8 +1507,7 @@ static int btrfs\_reconfigure(struct fs\_context \*fc) sync\_filesystem(sb); set\_bit(BTRFS\_FS\_STATE\_REMOUNTING, &fs\_info->fs\_state); - if (!mount\_reconfigure &&- !btrfs\_check\_options(fs\_info, &ctx->mount\_opt, fc->sb\_flags))+ if (!btrfs\_check\_options(fs\_info, &ctx->mount\_opt, fc->sb\_flags)) return -EINVAL;  ret = btrfs\_check\_features(fs\_info, !(fc->sb\_flags & SB\_RDONLY)); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:21:01 +0000


