=== Content from git.kernel.org_c45b67aa_20250114_190140.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d88564c79d1cedaf2655f12261eca0d2796bde4e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d88564c79d1cedaf2655f12261eca0d2796bde4e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d88564c79d1cedaf2655f12261eca0d2796bde4e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d88564c79d1cedaf2655f12261eca0d2796bde4e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-10-15 12:32:06 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:24 +0100 |
| commit | [d88564c79d1cedaf2655f12261eca0d2796bde4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d88564c79d1cedaf2655f12261eca0d2796bde4e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d88564c79d1cedaf2655f12261eca0d2796bde4e)) | |
| tree | [0057794ea2278754065285b52ddac69e29b0e85e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d88564c79d1cedaf2655f12261eca0d2796bde4e) | |
| parent | [5ec33b1fe86d0d4686024632d3e489d3171fe014](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ec33b1fe86d0d4686024632d3e489d3171fe014) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d88564c79d1cedaf2655f12261eca0d2796bde4e&id2=5ec33b1fe86d0d4686024632d3e489d3171fe014)) | |
| download | [linux-d88564c79d1cedaf2655f12261eca0d2796bde4e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d88564c79d1cedaf2655f12261eca0d2796bde4e.tar.gz) | |

net/mlx5: Fix command bitmask initialization[ Upstream commit d62b14045c6511a7b2d4948d1a83a4e592deeb05 ]
Command bitmask have a dedicated bit for MANAGE\_PAGES command, this bit
isn't Initialize during command bitmask Initialization, only during
MANAGE\_PAGES.
In addition, mlx5\_cmd\_trigger\_completions() is trying to trigger
completion for MANAGE\_PAGES command as well.
Hence, in case health error occurred before any MANAGE\_PAGES command
have been invoke (for example, during mlx5\_enable\_hca()),
mlx5\_cmd\_trigger\_completions() will try to trigger completion for
MANAGE\_PAGES command, which will result in null-ptr-deref error.[1]
Fix it by Initialize command bitmask correctly.
While at it, re-write the code for better understanding.
[1]
BUG: KASAN: null-ptr-deref in mlx5\_cmd\_trigger\_completions+0x1db/0x600 [mlx5\_core]
Write of size 4 at addr 0000000000000214 by task kworker/u96:2/12078
CPU: 10 PID: 12078 Comm: kworker/u96:2 Not tainted 6.9.0-rc2\_for\_upstream\_debug\_2024\_04\_07\_19\_01 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: mlx5\_health0000:08:00.0 mlx5\_fw\_fatal\_reporter\_err\_work [mlx5\_core]
Call Trace:
<TASK>
dump\_stack\_lvl+0x7e/0xc0
kasan\_report+0xb9/0xf0
kasan\_check\_range+0xec/0x190
mlx5\_cmd\_trigger\_completions+0x1db/0x600 [mlx5\_core]
mlx5\_cmd\_flush+0x94/0x240 [mlx5\_core]
enter\_error\_state+0x6c/0xd0 [mlx5\_core]
mlx5\_fw\_fatal\_reporter\_err\_work+0xf3/0x480 [mlx5\_core]
process\_one\_work+0x787/0x1490
? lockdep\_hardirqs\_on\_prepare+0x400/0x400
? pwq\_dec\_nr\_in\_flight+0xda0/0xda0
? assign\_work+0x168/0x240
worker\_thread+0x586/0xd30
? rescuer\_thread+0xae0/0xae0
kthread+0x2df/0x3b0
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x2d/0x70
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Fixes: 9b98d395b85d ("net/mlx5: Start health poll at earlier stage of driver load")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Reviewed-by: Saeed Mahameed <saeedm@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d88564c79d1cedaf2655f12261eca0d2796bde4e)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=d88564c79d1cedaf2655f12261eca0d2796bde4e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 48dc4ae87af092..80af0fc7101fdc 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=5ec33b1fe86d0d4686024632d3e489d3171fe014)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=d88564c79d1cedaf2655f12261eca0d2796bde4e)@@ -1758,6 +1758,10 @@ static void mlx5\_cmd\_comp\_handler(struct mlx5\_core\_dev \*dev, u64 vec, bool force } } +#define MLX5\_MAX\_MANAGE\_PAGES\_CMD\_ENT 1+#define MLX5\_CMD\_MASK ((1UL << (cmd->vars.max\_reg\_cmds + \+ MLX5\_MAX\_MANAGE\_PAGES\_CMD\_ENT)) - 1)+ static void mlx5\_cmd\_trigger\_completions(struct mlx5\_core\_dev \*dev) { struct mlx5\_cmd \*cmd = &dev->cmd;@@ -1769,7 +1773,7 @@ static void mlx5\_cmd\_trigger\_completions(struct mlx5\_core\_dev \*dev) /\* wait for pending handlers to complete \*/ mlx5\_eq\_synchronize\_cmd\_irq(dev); spin\_lock\_irqsave(&dev->cmd.alloc\_lock, flags);- vector = ~dev->cmd.vars.bitmask & ((1ul << (1 << dev->cmd.vars.log\_sz)) - 1);+ vector = ~dev->cmd.vars.bitmask & MLX5\_CMD\_MASK; if (!vector) goto no\_trig; @@ -2275,7 +2279,7 @@ int mlx5\_cmd\_enable(struct mlx5\_core\_dev \*dev)  cmd->state = MLX5\_CMDIF\_STATE\_DOWN; cmd->vars.max\_reg\_cmds = (1 << cmd->vars.log\_sz) - 1;- cmd->vars.bitmask = (1UL << cmd->vars.max\_reg\_cmds) - 1;+ cmd->vars.bitmask = MLX5\_CMD\_MASK;  sema\_init(&cmd->vars.sem, cmd->vars.max\_reg\_cmds); sema\_init(&cmd->vars.pages\_sem, 1); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:00:17 +0000



=== Content from git.kernel.org_b54e866b_20250114_190139.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-10-15 12:32:06 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:56:01 +0100 |
| commit | [d1606090bb294cecb7de3c4ed177f5aa0abd4c4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e)) | |
| tree | [0bc3650bc6d693d5c6fe82cc7c4aa771eb191c7a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e) | |
| parent | [18c8ea940d25228a3dcf90c322349982ac0610b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=18c8ea940d25228a3dcf90c322349982ac0610b4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e&id2=18c8ea940d25228a3dcf90c322349982ac0610b4)) | |
| download | [linux-d1606090bb294cecb7de3c4ed177f5aa0abd4c4e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d1606090bb294cecb7de3c4ed177f5aa0abd4c4e.tar.gz) | |

net/mlx5: Fix command bitmask initialization[ Upstream commit d62b14045c6511a7b2d4948d1a83a4e592deeb05 ]
Command bitmask have a dedicated bit for MANAGE\_PAGES command, this bit
isn't Initialize during command bitmask Initialization, only during
MANAGE\_PAGES.
In addition, mlx5\_cmd\_trigger\_completions() is trying to trigger
completion for MANAGE\_PAGES command as well.
Hence, in case health error occurred before any MANAGE\_PAGES command
have been invoke (for example, during mlx5\_enable\_hca()),
mlx5\_cmd\_trigger\_completions() will try to trigger completion for
MANAGE\_PAGES command, which will result in null-ptr-deref error.[1]
Fix it by Initialize command bitmask correctly.
While at it, re-write the code for better understanding.
[1]
BUG: KASAN: null-ptr-deref in mlx5\_cmd\_trigger\_completions+0x1db/0x600 [mlx5\_core]
Write of size 4 at addr 0000000000000214 by task kworker/u96:2/12078
CPU: 10 PID: 12078 Comm: kworker/u96:2 Not tainted 6.9.0-rc2\_for\_upstream\_debug\_2024\_04\_07\_19\_01 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: mlx5\_health0000:08:00.0 mlx5\_fw\_fatal\_reporter\_err\_work [mlx5\_core]
Call Trace:
<TASK>
dump\_stack\_lvl+0x7e/0xc0
kasan\_report+0xb9/0xf0
kasan\_check\_range+0xec/0x190
mlx5\_cmd\_trigger\_completions+0x1db/0x600 [mlx5\_core]
mlx5\_cmd\_flush+0x94/0x240 [mlx5\_core]
enter\_error\_state+0x6c/0xd0 [mlx5\_core]
mlx5\_fw\_fatal\_reporter\_err\_work+0xf3/0x480 [mlx5\_core]
process\_one\_work+0x787/0x1490
? lockdep\_hardirqs\_on\_prepare+0x400/0x400
? pwq\_dec\_nr\_in\_flight+0xda0/0xda0
? assign\_work+0x168/0x240
worker\_thread+0x586/0xd30
? rescuer\_thread+0xae0/0xae0
kthread+0x2df/0x3b0
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x2d/0x70
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Fixes: 9b98d395b85d ("net/mlx5: Start health poll at earlier stage of driver load")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Reviewed-by: Saeed Mahameed <saeedm@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex c6ddf51818efe8..4a1eb6cd699cb5 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=18c8ea940d25228a3dcf90c322349982ac0610b4)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e)@@ -1755,6 +1755,10 @@ static void mlx5\_cmd\_comp\_handler(struct mlx5\_core\_dev \*dev, u64 vec, bool force } } +#define MLX5\_MAX\_MANAGE\_PAGES\_CMD\_ENT 1+#define MLX5\_CMD\_MASK ((1UL << (cmd->vars.max\_reg\_cmds + \+ MLX5\_MAX\_MANAGE\_PAGES\_CMD\_ENT)) - 1)+ static void mlx5\_cmd\_trigger\_completions(struct mlx5\_core\_dev \*dev) { struct mlx5\_cmd \*cmd = &dev->cmd;@@ -1766,7 +1770,7 @@ static void mlx5\_cmd\_trigger\_completions(struct mlx5\_core\_dev \*dev) /\* wait for pending handlers to complete \*/ mlx5\_eq\_synchronize\_cmd\_irq(dev); spin\_lock\_irqsave(&dev->cmd.alloc\_lock, flags);- vector = ~dev->cmd.vars.bitmask & ((1ul << (1 << dev->cmd.vars.log\_sz)) - 1);+ vector = ~dev->cmd.vars.bitmask & MLX5\_CMD\_MASK; if (!vector) goto no\_trig; @@ -2301,7 +2305,7 @@ int mlx5\_cmd\_enable(struct mlx5\_core\_dev \*dev)  cmd->state = MLX5\_CMDIF\_STATE\_DOWN; cmd->vars.max\_reg\_cmds = (1 << cmd->vars.log\_sz) - 1;- cmd->vars.bitmask = (1UL << cmd->vars.max\_reg\_cmds) - 1;+ cmd->vars.bitmask = MLX5\_CMD\_MASK;  sema\_init(&cmd->vars.sem, cmd->vars.max\_reg\_cmds); sema\_init(&cmd->vars.pages\_sem, 1); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:00:16 +0000



=== Content from git.kernel.org_c736d5ef_20250114_190140.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-10-15 12:32:06 +0300 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-10-17 12:14:07 +0200 |
| commit | [d62b14045c6511a7b2d4948d1a83a4e592deeb05](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05)) | |
| tree | [0eb7fbb0c896ea93a19eae96d80b98657f948d86](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05) | |
| parent | [d4f25be27e3ef7e23998fbd3dd4bff0602de7ae5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4f25be27e3ef7e23998fbd3dd4bff0602de7ae5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05&id2=d4f25be27e3ef7e23998fbd3dd4bff0602de7ae5)) | |
| download | [linux-d62b14045c6511a7b2d4948d1a83a4e592deeb05.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d62b14045c6511a7b2d4948d1a83a4e592deeb05.tar.gz) | |

net/mlx5: Fix command bitmask initializationCommand bitmask have a dedicated bit for MANAGE\_PAGES command, this bit
isn't Initialize during command bitmask Initialization, only during
MANAGE\_PAGES.
In addition, mlx5\_cmd\_trigger\_completions() is trying to trigger
completion for MANAGE\_PAGES command as well.
Hence, in case health error occurred before any MANAGE\_PAGES command
have been invoke (for example, during mlx5\_enable\_hca()),
mlx5\_cmd\_trigger\_completions() will try to trigger completion for
MANAGE\_PAGES command, which will result in null-ptr-deref error.[1]
Fix it by Initialize command bitmask correctly.
While at it, re-write the code for better understanding.
[1]
BUG: KASAN: null-ptr-deref in mlx5\_cmd\_trigger\_completions+0x1db/0x600 [mlx5\_core]
Write of size 4 at addr 0000000000000214 by task kworker/u96:2/12078
CPU: 10 PID: 12078 Comm: kworker/u96:2 Not tainted 6.9.0-rc2\_for\_upstream\_debug\_2024\_04\_07\_19\_01 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: mlx5\_health0000:08:00.0 mlx5\_fw\_fatal\_reporter\_err\_work [mlx5\_core]
Call Trace:
<TASK>
dump\_stack\_lvl+0x7e/0xc0
kasan\_report+0xb9/0xf0
kasan\_check\_range+0xec/0x190
mlx5\_cmd\_trigger\_completions+0x1db/0x600 [mlx5\_core]
mlx5\_cmd\_flush+0x94/0x240 [mlx5\_core]
enter\_error\_state+0x6c/0xd0 [mlx5\_core]
mlx5\_fw\_fatal\_reporter\_err\_work+0xf3/0x480 [mlx5\_core]
process\_one\_work+0x787/0x1490
? lockdep\_hardirqs\_on\_prepare+0x400/0x400
? pwq\_dec\_nr\_in\_flight+0xda0/0xda0
? assign\_work+0x168/0x240
worker\_thread+0x586/0xd30
? rescuer\_thread+0xae0/0xae0
kthread+0x2df/0x3b0
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x2d/0x70
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Fixes: 9b98d395b85d ("net/mlx5: Start health poll at earlier stage of driver load")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Reviewed-by: Saeed Mahameed <saeedm@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex a64d96effb9eac..6bd8a18e3af3a1 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=d4f25be27e3ef7e23998fbd3dd4bff0602de7ae5)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05)@@ -1765,6 +1765,10 @@ static void mlx5\_cmd\_comp\_handler(struct mlx5\_core\_dev \*dev, u64 vec, bool force } } +#define MLX5\_MAX\_MANAGE\_PAGES\_CMD\_ENT 1+#define MLX5\_CMD\_MASK ((1UL << (cmd->vars.max\_reg\_cmds + \+ MLX5\_MAX\_MANAGE\_PAGES\_CMD\_ENT)) - 1)+ static void mlx5\_cmd\_trigger\_completions(struct mlx5\_core\_dev \*dev) { struct mlx5\_cmd \*cmd = &dev->cmd;@@ -1776,7 +1780,7 @@ static void mlx5\_cmd\_trigger\_completions(struct mlx5\_core\_dev \*dev) /\* wait for pending handlers to complete \*/ mlx5\_eq\_synchronize\_cmd\_irq(dev); spin\_lock\_irqsave(&dev->cmd.alloc\_lock, flags);- vector = ~dev->cmd.vars.bitmask & ((1ul << (1 << dev->cmd.vars.log\_sz)) - 1);+ vector = ~dev->cmd.vars.bitmask & MLX5\_CMD\_MASK; if (!vector) goto no\_trig; @@ -2361,7 +2365,7 @@ int mlx5\_cmd\_enable(struct mlx5\_core\_dev \*dev)  cmd->state = MLX5\_CMDIF\_STATE\_DOWN; cmd->vars.max\_reg\_cmds = (1 << cmd->vars.log\_sz) - 1;- cmd->vars.bitmask = (1UL << cmd->vars.max\_reg\_cmds) - 1;+ cmd->vars.bitmask = MLX5\_CMD\_MASK;  sema\_init(&cmd->vars.sem, cmd->vars.max\_reg\_cmds); sema\_init(&cmd->vars.pages\_sem, 1); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:00:17 +0000



=== Content from git.kernel.org_ee1ba49e_20250114_190139.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2feac1e562be0efc621a6722644a90f355d53473)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2feac1e562be0efc621a6722644a90f355d53473)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2feac1e562be0efc621a6722644a90f355d53473)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2feac1e562be0efc621a6722644a90f355d53473)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-10-15 12:32:06 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:31 +0100 |
| commit | [2feac1e562be0efc621a6722644a90f355d53473](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2feac1e562be0efc621a6722644a90f355d53473) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2feac1e562be0efc621a6722644a90f355d53473)) | |
| tree | [279fc202458d6deb1aa1ed278c7842b5066063f3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2feac1e562be0efc621a6722644a90f355d53473) | |
| parent | [863c7f4187443fcfedadeab5554a024b679049d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=863c7f4187443fcfedadeab5554a024b679049d7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2feac1e562be0efc621a6722644a90f355d53473&id2=863c7f4187443fcfedadeab5554a024b679049d7)) | |
| download | [linux-2feac1e562be0efc621a6722644a90f355d53473.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2feac1e562be0efc621a6722644a90f355d53473.tar.gz) | |

net/mlx5: Fix command bitmask initialization[ Upstream commit d62b14045c6511a7b2d4948d1a83a4e592deeb05 ]
Command bitmask have a dedicated bit for MANAGE\_PAGES command, this bit
isn't Initialize during command bitmask Initialization, only during
MANAGE\_PAGES.
In addition, mlx5\_cmd\_trigger\_completions() is trying to trigger
completion for MANAGE\_PAGES command as well.
Hence, in case health error occurred before any MANAGE\_PAGES command
have been invoke (for example, during mlx5\_enable\_hca()),
mlx5\_cmd\_trigger\_completions() will try to trigger completion for
MANAGE\_PAGES command, which will result in null-ptr-deref error.[1]
Fix it by Initialize command bitmask correctly.
While at it, re-write the code for better understanding.
[1]
BUG: KASAN: null-ptr-deref in mlx5\_cmd\_trigger\_completions+0x1db/0x600 [mlx5\_core]
Write of size 4 at addr 0000000000000214 by task kworker/u96:2/12078
CPU: 10 PID: 12078 Comm: kworker/u96:2 Not tainted 6.9.0-rc2\_for\_upstream\_debug\_2024\_04\_07\_19\_01 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: mlx5\_health0000:08:00.0 mlx5\_fw\_fatal\_reporter\_err\_work [mlx5\_core]
Call Trace:
<TASK>
dump\_stack\_lvl+0x7e/0xc0
kasan\_report+0xb9/0xf0
kasan\_check\_range+0xec/0x190
mlx5\_cmd\_trigger\_completions+0x1db/0x600 [mlx5\_core]
mlx5\_cmd\_flush+0x94/0x240 [mlx5\_core]
enter\_error\_state+0x6c/0xd0 [mlx5\_core]
mlx5\_fw\_fatal\_reporter\_err\_work+0xf3/0x480 [mlx5\_core]
process\_one\_work+0x787/0x1490
? lockdep\_hardirqs\_on\_prepare+0x400/0x400
? pwq\_dec\_nr\_in\_flight+0xda0/0xda0
? assign\_work+0x168/0x240
worker\_thread+0x586/0xd30
? rescuer\_thread+0xae0/0xae0
kthread+0x2df/0x3b0
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x2d/0x70
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Fixes: 9b98d395b85d ("net/mlx5: Start health poll at earlier stage of driver load")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Reviewed-by: Saeed Mahameed <saeedm@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2feac1e562be0efc621a6722644a90f355d53473)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=2feac1e562be0efc621a6722644a90f355d53473) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 20768ef2e9d2b2..86d63c5f27ce26 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=863c7f4187443fcfedadeab5554a024b679049d7)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=2feac1e562be0efc621a6722644a90f355d53473)@@ -1760,6 +1760,10 @@ static void mlx5\_cmd\_comp\_handler(struct mlx5\_core\_dev \*dev, u64 vec, bool force } } +#define MLX5\_MAX\_MANAGE\_PAGES\_CMD\_ENT 1+#define MLX5\_CMD\_MASK ((1UL << (cmd->vars.max\_reg\_cmds + \+ MLX5\_MAX\_MANAGE\_PAGES\_CMD\_ENT)) - 1)+ static void mlx5\_cmd\_trigger\_completions(struct mlx5\_core\_dev \*dev) { struct mlx5\_cmd \*cmd = &dev->cmd;@@ -1771,7 +1775,7 @@ static void mlx5\_cmd\_trigger\_completions(struct mlx5\_core\_dev \*dev) /\* wait for pending handlers to complete \*/ mlx5\_eq\_synchronize\_cmd\_irq(dev); spin\_lock\_irqsave(&dev->cmd.alloc\_lock, flags);- vector = ~dev->cmd.vars.bitmask & ((1ul << (1 << dev->cmd.vars.log\_sz)) - 1);+ vector = ~dev->cmd.vars.bitmask & MLX5\_CMD\_MASK; if (!vector) goto no\_trig; @@ -2345,7 +2349,7 @@ int mlx5\_cmd\_enable(struct mlx5\_core\_dev \*dev)  cmd->state = MLX5\_CMDIF\_STATE\_DOWN; cmd->vars.max\_reg\_cmds = (1 << cmd->vars.log\_sz) - 1;- cmd->vars.bitmask = (1UL << cmd->vars.max\_reg\_cmds) - 1;+ cmd->vars.bitmask = MLX5\_CMD\_MASK;  sema\_init(&cmd->vars.sem, cmd->vars.max\_reg\_cmds); sema\_init(&cmd->vars.pages\_sem, 1); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:00:16 +0000


