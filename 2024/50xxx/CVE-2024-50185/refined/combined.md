=== Content from git.kernel.org_da8325f7_20250114_224411.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e32d262c89e2b22cb0640223f953b548617ed8a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e32d262c89e2b22cb0640223f953b548617ed8a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e32d262c89e2b22cb0640223f953b548617ed8a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e32d262c89e2b22cb0640223f953b548617ed8a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-08 13:04:52 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-10-09 19:43:44 -0700 |
| commit | [e32d262c89e2b22cb0640223f953b548617ed8a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e32d262c89e2b22cb0640223f953b548617ed8a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e32d262c89e2b22cb0640223f953b548617ed8a6)) | |
| tree | [aa5c02296b9d5ebe22a19d9a1643eaf524ecbc0e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e32d262c89e2b22cb0640223f953b548617ed8a6) | |
| parent | [d94785bb46b6167382b1de3290eccc91fa98df53](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d94785bb46b6167382b1de3290eccc91fa98df53) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e32d262c89e2b22cb0640223f953b548617ed8a6&id2=d94785bb46b6167382b1de3290eccc91fa98df53)) | |
| download | [linux-e32d262c89e2b22cb0640223f953b548617ed8a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e32d262c89e2b22cb0640223f953b548617ed8a6.tar.gz) | |

mptcp: handle consistently DSS corruptionBugged peer implementation can send corrupted DSS options, consistently
hitting a few warning in the data path. Use DEBUG\_NET assertions, to
avoid the splat on some builds and handle consistently the error, dumping
related MIBs and performing fallback and/or reset according to the
subflow type.
Fixes: 6771bfd9ee24 ("mptcp: update mptcp ack sequence from work queue")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e32d262c89e2b22cb0640223f953b548617ed8a6)

| -rw-r--r-- | [net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.c?id=e32d262c89e2b22cb0640223f953b548617ed8a6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.h?id=e32d262c89e2b22cb0640223f953b548617ed8a6) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=e32d262c89e2b22cb0640223f953b548617ed8a6) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/subflow.c?id=e32d262c89e2b22cb0640223f953b548617ed8a6) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 28 insertions, 4 deletions

| diff --git a/net/mptcp/mib.c b/net/mptcp/mib.cindex 38c2efc82b948d..ad88bd3c58dffe 100644--- a/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=d94785bb46b6167382b1de3290eccc91fa98df53)+++ b/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=e32d262c89e2b22cb0640223f953b548617ed8a6)@@ -32,6 +32,8 @@ static const struct snmp\_mib mptcp\_snmp\_list[] = { SNMP\_MIB\_ITEM("MPJoinSynTxBindErr", MPTCP\_MIB\_JOINSYNTXBINDERR), SNMP\_MIB\_ITEM("MPJoinSynTxConnectErr", MPTCP\_MIB\_JOINSYNTXCONNECTERR), SNMP\_MIB\_ITEM("DSSNotMatching", MPTCP\_MIB\_DSSNOMATCH),+ SNMP\_MIB\_ITEM("DSSCorruptionFallback", MPTCP\_MIB\_DSSCORRUPTIONFALLBACK),+ SNMP\_MIB\_ITEM("DSSCorruptionReset", MPTCP\_MIB\_DSSCORRUPTIONRESET), SNMP\_MIB\_ITEM("InfiniteMapTx", MPTCP\_MIB\_INFINITEMAPTX), SNMP\_MIB\_ITEM("InfiniteMapRx", MPTCP\_MIB\_INFINITEMAPRX), SNMP\_MIB\_ITEM("DSSNoMatchTCP", MPTCP\_MIB\_DSSTCPMISMATCH),diff --git a/net/mptcp/mib.h b/net/mptcp/mib.hindex c8ffe18a872217..3206cdda8bb106 100644--- a/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=d94785bb46b6167382b1de3290eccc91fa98df53)+++ b/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=e32d262c89e2b22cb0640223f953b548617ed8a6)@@ -27,6 +27,8 @@ enum linux\_mptcp\_mib\_field { MPTCP\_MIB\_JOINSYNTXBINDERR, /\* Not able to bind() the address when sending a SYN + MP\_JOIN \*/ MPTCP\_MIB\_JOINSYNTXCONNECTERR, /\* Not able to connect() when sending a SYN + MP\_JOIN \*/ MPTCP\_MIB\_DSSNOMATCH, /\* Received a new mapping that did not match the previous one \*/+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK,/\* DSS corruption detected, fallback \*/+ MPTCP\_MIB\_DSSCORRUPTIONRESET, /\* DSS corruption detected, MPJ subflow reset \*/ MPTCP\_MIB\_INFINITEMAPTX, /\* Sent an infinite mapping \*/ MPTCP\_MIB\_INFINITEMAPRX, /\* Received an infinite mapping \*/ MPTCP\_MIB\_DSSTCPMISMATCH, /\* DSS-mapping did not map with TCP's sequence numbers \*/diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex c2317919fc148a..6d0e201c3eb26a 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=d94785bb46b6167382b1de3290eccc91fa98df53)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=e32d262c89e2b22cb0640223f953b548617ed8a6)@@ -620,6 +620,18 @@ static bool mptcp\_check\_data\_fin(struct sock \*sk) return ret; } +static void mptcp\_dss\_corruption(struct mptcp\_sock \*msk, struct sock \*ssk)+{+ if (READ\_ONCE(msk->allow\_infinite\_fallback)) {+ MPTCP\_INC\_STATS(sock\_net(ssk),+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK);+ mptcp\_do\_fallback(ssk);+ } else {+ MPTCP\_INC\_STATS(sock\_net(ssk), MPTCP\_MIB\_DSSCORRUPTIONRESET);+ mptcp\_subflow\_reset(ssk);+ }+}+ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, struct sock \*ssk, unsigned int \*bytes)@@ -692,10 +704,16 @@ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, moved += len; seq += len; - if (WARN\_ON\_ONCE(map\_remaining < len))- break;+ if (unlikely(map\_remaining < len)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1);+ mptcp\_dss\_corruption(msk, ssk);+ } } else {- WARN\_ON\_ONCE(!fin);+ if (unlikely(!fin)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1);+ mptcp\_dss\_corruption(msk, ssk);+ }+ sk\_eat\_skb(ssk, skb); done = true; }diff --git a/net/mptcp/subflow.c b/net/mptcp/subflow.cindex 1040b3b9696b74..e1046a696ab5c7 100644--- a/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=d94785bb46b6167382b1de3290eccc91fa98df53)+++ b/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=e32d262c89e2b22cb0640223f953b548617ed8a6)@@ -975,8 +975,10 @@ static bool skb\_is\_fully\_mapped(struct sock \*ssk, struct sk\_buff \*skb) unsigned int skb\_consumed;  skb\_consumed = tcp\_sk(ssk)->copied\_seq - TCP\_SKB\_CB(skb)->seq;- if (WARN\_ON\_ONCE(skb\_consumed >= skb->len))+ if (unlikely(skb\_consumed >= skb->len)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1); return true;+ }  return skb->len - skb\_consumed <= subflow->map\_data\_len - mptcp\_subflow\_get\_map\_offset(subflow); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:42:48 +0000



=== Content from git.kernel.org_644272aa_20250114_224408.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-19 11:30:48 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:40:47 +0200 |
| commit | [12c1676d598e3b8dd92a033b623b792cc2ea1ec5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)) | |
| tree | [df4cee9bf70e2d6ad916f881cbb22bf92e8c8ff2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5) | |
| parent | [6654efe264b014d8ea9fc38f79efb568b1b79069](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6654efe264b014d8ea9fc38f79efb568b1b79069) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5&id2=6654efe264b014d8ea9fc38f79efb568b1b79069)) | |
| download | [linux-12c1676d598e3b8dd92a033b623b792cc2ea1ec5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-12c1676d598e3b8dd92a033b623b792cc2ea1ec5.tar.gz) | |

mptcp: handle consistently DSS corruptioncommit e32d262c89e2b22cb0640223f953b548617ed8a6 upstream.
Bugged peer implementation can send corrupted DSS options, consistently
hitting a few warning in the data path. Use DEBUG\_NET assertions, to
avoid the splat on some builds and handle consistently the error, dumping
related MIBs and performing fallback and/or reset according to the
subflow type.
Fixes: 6771bfd9ee24 ("mptcp: update mptcp ack sequence from work queue")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflicts in mib.[ch], because commit 104125b82e5c ("mptcp: add mib
for infinite map sending") is linked to a new feature, not available
in this version. Resolving the conflicts is easy, simply adding the
new lines declaring the new "DSS corruptions" MIB entries.
Also removed in protocol.c and subflow.c all DEBUG\_NET\_WARN\_ON\_ONCE
because they are not defined in this version: enough with the MIB
counters that have been added in this commit. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)

| -rw-r--r-- | [net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.c?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.h?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5) | 20 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/subflow.c?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 22 insertions, 4 deletions

| diff --git a/net/mptcp/mib.c b/net/mptcp/mib.cindex c2fadfcfd6d6a4..08f82e1ca2f7b3 100644--- a/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=6654efe264b014d8ea9fc38f79efb568b1b79069)+++ b/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)@@ -26,6 +26,8 @@ static const struct snmp\_mib mptcp\_snmp\_list[] = { SNMP\_MIB\_ITEM("MPJoinAckRx", MPTCP\_MIB\_JOINACKRX), SNMP\_MIB\_ITEM("MPJoinAckHMacFailure", MPTCP\_MIB\_JOINACKMAC), SNMP\_MIB\_ITEM("DSSNotMatching", MPTCP\_MIB\_DSSNOMATCH),+ SNMP\_MIB\_ITEM("DSSCorruptionFallback", MPTCP\_MIB\_DSSCORRUPTIONFALLBACK),+ SNMP\_MIB\_ITEM("DSSCorruptionReset", MPTCP\_MIB\_DSSCORRUPTIONRESET), SNMP\_MIB\_ITEM("InfiniteMapRx", MPTCP\_MIB\_INFINITEMAPRX), SNMP\_MIB\_ITEM("DSSNoMatchTCP", MPTCP\_MIB\_DSSTCPMISMATCH), SNMP\_MIB\_ITEM("DataCsumErr", MPTCP\_MIB\_DATACSUMERR),diff --git a/net/mptcp/mib.h b/net/mptcp/mib.hindex 90025acdcf7245..1b7f6d24904b24 100644--- a/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=6654efe264b014d8ea9fc38f79efb568b1b79069)+++ b/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)@@ -19,6 +19,8 @@ enum linux\_mptcp\_mib\_field { MPTCP\_MIB\_JOINACKRX, /\* Received an ACK + MP\_JOIN \*/ MPTCP\_MIB\_JOINACKMAC, /\* HMAC was wrong on ACK + MP\_JOIN \*/ MPTCP\_MIB\_DSSNOMATCH, /\* Received a new mapping that did not match the previous one \*/+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK,/\* DSS corruption detected, fallback \*/+ MPTCP\_MIB\_DSSCORRUPTIONRESET, /\* DSS corruption detected, MPJ subflow reset \*/ MPTCP\_MIB\_INFINITEMAPRX, /\* Received an infinite mapping \*/ MPTCP\_MIB\_DSSTCPMISMATCH, /\* DSS-mapping did not map with TCP's sequence numbers \*/ MPTCP\_MIB\_DATACSUMERR, /\* The data checksum fail \*/diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 73a0b0d153825d..34c98596350e87 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=6654efe264b014d8ea9fc38f79efb568b1b79069)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)@@ -554,6 +554,18 @@ static bool mptcp\_check\_data\_fin(struct sock \*sk) return ret; } +static void mptcp\_dss\_corruption(struct mptcp\_sock \*msk, struct sock \*ssk)+{+ if (READ\_ONCE(msk->allow\_infinite\_fallback)) {+ MPTCP\_INC\_STATS(sock\_net(ssk),+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK);+ mptcp\_do\_fallback(ssk);+ } else {+ MPTCP\_INC\_STATS(sock\_net(ssk), MPTCP\_MIB\_DSSCORRUPTIONRESET);+ mptcp\_subflow\_reset(ssk);+ }+}+ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, struct sock \*ssk, unsigned int \*bytes)@@ -626,10 +638,12 @@ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, moved += len; seq += len; - if (WARN\_ON\_ONCE(map\_remaining < len))- break;+ if (unlikely(map\_remaining < len))+ mptcp\_dss\_corruption(msk, ssk); } else {- WARN\_ON\_ONCE(!fin);+ if (unlikely(!fin))+ mptcp\_dss\_corruption(msk, ssk);+ sk\_eat\_skb(ssk, skb); done = true; }diff --git a/net/mptcp/subflow.c b/net/mptcp/subflow.cindex 412823af2c1d49..7eff961267d0bc 100644--- a/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=6654efe264b014d8ea9fc38f79efb568b1b79069)+++ b/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=12c1676d598e3b8dd92a033b623b792cc2ea1ec5)@@ -847,7 +847,7 @@ static bool skb\_is\_fully\_mapped(struct sock \*ssk, struct sk\_buff \*skb) unsigned int skb\_consumed;  skb\_consumed = tcp\_sk(ssk)->copied\_seq - TCP\_SKB\_CB(skb)->seq;- if (WARN\_ON\_ONCE(skb\_consumed >= skb->len))+ if (unlikely(skb\_consumed >= skb->len)) return true;  return skb->len - skb\_consumed <= subflow->map\_data\_len - |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:42:45 +0000



=== Content from git.kernel.org_af44b1f5_20250114_224411.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fde99e972b8f88cebe619241d7aa43d288ef666a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fde99e972b8f88cebe619241d7aa43d288ef666a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fde99e972b8f88cebe619241d7aa43d288ef666a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fde99e972b8f88cebe619241d7aa43d288ef666a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-19 12:29:08 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:39:29 +0200 |
| commit | [fde99e972b8f88cebe619241d7aa43d288ef666a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fde99e972b8f88cebe619241d7aa43d288ef666a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fde99e972b8f88cebe619241d7aa43d288ef666a)) | |
| tree | [b54d747221a0233414c29ae67c18932b0148b23b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fde99e972b8f88cebe619241d7aa43d288ef666a) | |
| parent | [609937aa962a62e93acfc04dd370b665e6152dfb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=609937aa962a62e93acfc04dd370b665e6152dfb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fde99e972b8f88cebe619241d7aa43d288ef666a&id2=609937aa962a62e93acfc04dd370b665e6152dfb)) | |
| download | [linux-fde99e972b8f88cebe619241d7aa43d288ef666a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fde99e972b8f88cebe619241d7aa43d288ef666a.tar.gz) | |

mptcp: handle consistently DSS corruptioncommit e32d262c89e2b22cb0640223f953b548617ed8a6 upstream.
Bugged peer implementation can send corrupted DSS options, consistently
hitting a few warning in the data path. Use DEBUG\_NET assertions, to
avoid the splat on some builds and handle consistently the error, dumping
related MIBs and performing fallback and/or reset according to the
subflow type.
Fixes: 6771bfd9ee24 ("mptcp: update mptcp ack sequence from work queue")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflicts in mib.[ch], because commit 104125b82e5c ("mptcp: add mib
for infinite map sending") is linked to a new feature, not available
in this version. Resolving the conflicts is easy, simply adding the
new lines declaring the new "DSS corruptions" MIB entries.
Also removed in protocol.c and subflow.c all DEBUG\_NET\_WARN\_ON\_ONCE
because they are not defined in this version: enough with the MIB
counters that have been added in this commit. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fde99e972b8f88cebe619241d7aa43d288ef666a)

| -rw-r--r-- | [net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.c?id=fde99e972b8f88cebe619241d7aa43d288ef666a) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.h?id=fde99e972b8f88cebe619241d7aa43d288ef666a) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=fde99e972b8f88cebe619241d7aa43d288ef666a) | 20 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/subflow.c?id=fde99e972b8f88cebe619241d7aa43d288ef666a) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 22 insertions, 4 deletions

| diff --git a/net/mptcp/mib.c b/net/mptcp/mib.cindex f4034e000f3ef6..44d083958d8e59 100644--- a/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=609937aa962a62e93acfc04dd370b665e6152dfb)+++ b/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=fde99e972b8f88cebe619241d7aa43d288ef666a)@@ -23,6 +23,8 @@ static const struct snmp\_mib mptcp\_snmp\_list[] = { SNMP\_MIB\_ITEM("MPJoinAckRx", MPTCP\_MIB\_JOINACKRX), SNMP\_MIB\_ITEM("MPJoinAckHMacFailure", MPTCP\_MIB\_JOINACKMAC), SNMP\_MIB\_ITEM("DSSNotMatching", MPTCP\_MIB\_DSSNOMATCH),+ SNMP\_MIB\_ITEM("DSSCorruptionFallback", MPTCP\_MIB\_DSSCORRUPTIONFALLBACK),+ SNMP\_MIB\_ITEM("DSSCorruptionReset", MPTCP\_MIB\_DSSCORRUPTIONRESET), SNMP\_MIB\_ITEM("InfiniteMapRx", MPTCP\_MIB\_INFINITEMAPRX), SNMP\_MIB\_ITEM("OFOQueueTail", MPTCP\_MIB\_OFOQUEUETAIL), SNMP\_MIB\_ITEM("OFOQueue", MPTCP\_MIB\_OFOQUEUE),diff --git a/net/mptcp/mib.h b/net/mptcp/mib.hindex a9f43ff00b3c8d..0e17e1cebdbcfd 100644--- a/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=609937aa962a62e93acfc04dd370b665e6152dfb)+++ b/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=fde99e972b8f88cebe619241d7aa43d288ef666a)@@ -16,6 +16,8 @@ enum linux\_mptcp\_mib\_field { MPTCP\_MIB\_JOINACKRX, /\* Received an ACK + MP\_JOIN \*/ MPTCP\_MIB\_JOINACKMAC, /\* HMAC was wrong on ACK + MP\_JOIN \*/ MPTCP\_MIB\_DSSNOMATCH, /\* Received a new mapping that did not match the previous one \*/+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK,/\* DSS corruption detected, fallback \*/+ MPTCP\_MIB\_DSSCORRUPTIONRESET, /\* DSS corruption detected, MPJ subflow reset \*/ MPTCP\_MIB\_INFINITEMAPRX, /\* Received an infinite mapping \*/ MPTCP\_MIB\_OFOQUEUETAIL, /\* Segments inserted into OoO queue tail \*/ MPTCP\_MIB\_OFOQUEUE, /\* Segments inserted into OoO queue \*/diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 24a21ff0cb8a8a..8558309a2d3fd3 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=609937aa962a62e93acfc04dd370b665e6152dfb)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=fde99e972b8f88cebe619241d7aa43d288ef666a)@@ -457,6 +457,18 @@ static void mptcp\_check\_data\_fin(struct sock \*sk) } } +static void mptcp\_dss\_corruption(struct mptcp\_sock \*msk, struct sock \*ssk)+{+ if (READ\_ONCE(msk->allow\_infinite\_fallback)) {+ MPTCP\_INC\_STATS(sock\_net(ssk),+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK);+ mptcp\_do\_fallback(ssk);+ } else {+ MPTCP\_INC\_STATS(sock\_net(ssk), MPTCP\_MIB\_DSSCORRUPTIONRESET);+ mptcp\_subflow\_reset(ssk);+ }+}+ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, struct sock \*ssk, unsigned int \*bytes)@@ -519,10 +531,12 @@ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, moved += len; seq += len; - if (WARN\_ON\_ONCE(map\_remaining < len))- break;+ if (unlikely(map\_remaining < len))+ mptcp\_dss\_corruption(msk, ssk); } else {- WARN\_ON\_ONCE(!fin);+ if (unlikely(!fin))+ mptcp\_dss\_corruption(msk, ssk);+ sk\_eat\_skb(ssk, skb); done = true; }diff --git a/net/mptcp/subflow.c b/net/mptcp/subflow.cindex 0c020ca463f43f..c3434069fb0a53 100644--- a/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=609937aa962a62e93acfc04dd370b665e6152dfb)+++ b/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=fde99e972b8f88cebe619241d7aa43d288ef666a)@@ -702,7 +702,7 @@ static bool skb\_is\_fully\_mapped(struct sock \*ssk, struct sk\_buff \*skb) unsigned int skb\_consumed;  skb\_consumed = tcp\_sk(ssk)->copied\_seq - TCP\_SKB\_CB(skb)->seq;- if (WARN\_ON\_ONCE(skb\_consumed >= skb->len))+ if (unlikely(skb\_consumed >= skb->len)) return true;  return skb->len - skb\_consumed <= subflow->map\_data\_len - |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:42:48 +0000



=== Content from git.kernel.org_3c4fb386_20250114_224410.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8bfd391bde685df7289b928ce8876a3583be4bfb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8bfd391bde685df7289b928ce8876a3583be4bfb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bfd391bde685df7289b928ce8876a3583be4bfb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bfd391bde685df7289b928ce8876a3583be4bfb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-08 13:04:52 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:27:00 +0200 |
| commit | [8bfd391bde685df7289b928ce8876a3583be4bfb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bfd391bde685df7289b928ce8876a3583be4bfb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8bfd391bde685df7289b928ce8876a3583be4bfb)) | |
| tree | [744532cf648445cf5ac2760c9541c6e404861a5b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8bfd391bde685df7289b928ce8876a3583be4bfb) | |
| parent | [f82b629d41dd79fc143de40e894452ed52eb0d5a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f82b629d41dd79fc143de40e894452ed52eb0d5a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bfd391bde685df7289b928ce8876a3583be4bfb&id2=f82b629d41dd79fc143de40e894452ed52eb0d5a)) | |
| download | [linux-8bfd391bde685df7289b928ce8876a3583be4bfb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8bfd391bde685df7289b928ce8876a3583be4bfb.tar.gz) | |

mptcp: handle consistently DSS corruptioncommit e32d262c89e2b22cb0640223f953b548617ed8a6 upstream.
Bugged peer implementation can send corrupted DSS options, consistently
hitting a few warning in the data path. Use DEBUG\_NET assertions, to
avoid the splat on some builds and handle consistently the error, dumping
related MIBs and performing fallback and/or reset according to the
subflow type.
Fixes: 6771bfd9ee24 ("mptcp: update mptcp ack sequence from work queue")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bfd391bde685df7289b928ce8876a3583be4bfb)

| -rw-r--r-- | [net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.c?id=8bfd391bde685df7289b928ce8876a3583be4bfb) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.h?id=8bfd391bde685df7289b928ce8876a3583be4bfb) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=8bfd391bde685df7289b928ce8876a3583be4bfb) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/subflow.c?id=8bfd391bde685df7289b928ce8876a3583be4bfb) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 28 insertions, 4 deletions

| diff --git a/net/mptcp/mib.c b/net/mptcp/mib.cindex 7884217f33eb2f..79f2278434b950 100644--- a/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=f82b629d41dd79fc143de40e894452ed52eb0d5a)+++ b/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=8bfd391bde685df7289b928ce8876a3583be4bfb)@@ -26,6 +26,8 @@ static const struct snmp\_mib mptcp\_snmp\_list[] = { SNMP\_MIB\_ITEM("MPJoinAckRx", MPTCP\_MIB\_JOINACKRX), SNMP\_MIB\_ITEM("MPJoinAckHMacFailure", MPTCP\_MIB\_JOINACKMAC), SNMP\_MIB\_ITEM("DSSNotMatching", MPTCP\_MIB\_DSSNOMATCH),+ SNMP\_MIB\_ITEM("DSSCorruptionFallback", MPTCP\_MIB\_DSSCORRUPTIONFALLBACK),+ SNMP\_MIB\_ITEM("DSSCorruptionReset", MPTCP\_MIB\_DSSCORRUPTIONRESET), SNMP\_MIB\_ITEM("InfiniteMapTx", MPTCP\_MIB\_INFINITEMAPTX), SNMP\_MIB\_ITEM("InfiniteMapRx", MPTCP\_MIB\_INFINITEMAPRX), SNMP\_MIB\_ITEM("DSSNoMatchTCP", MPTCP\_MIB\_DSSTCPMISMATCH),diff --git a/net/mptcp/mib.h b/net/mptcp/mib.hindex 66aa67f49d032c..3f4ca290be6904 100644--- a/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=f82b629d41dd79fc143de40e894452ed52eb0d5a)+++ b/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=8bfd391bde685df7289b928ce8876a3583be4bfb)@@ -21,6 +21,8 @@ enum linux\_mptcp\_mib\_field { MPTCP\_MIB\_JOINACKRX, /\* Received an ACK + MP\_JOIN \*/ MPTCP\_MIB\_JOINACKMAC, /\* HMAC was wrong on ACK + MP\_JOIN \*/ MPTCP\_MIB\_DSSNOMATCH, /\* Received a new mapping that did not match the previous one \*/+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK,/\* DSS corruption detected, fallback \*/+ MPTCP\_MIB\_DSSCORRUPTIONRESET, /\* DSS corruption detected, MPJ subflow reset \*/ MPTCP\_MIB\_INFINITEMAPTX, /\* Sent an infinite mapping \*/ MPTCP\_MIB\_INFINITEMAPRX, /\* Received an infinite mapping \*/ MPTCP\_MIB\_DSSTCPMISMATCH, /\* DSS-mapping did not map with TCP's sequence numbers \*/diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 37ebcb7640ebb3..d4b3bc46cdaaf5 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=f82b629d41dd79fc143de40e894452ed52eb0d5a)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=8bfd391bde685df7289b928ce8876a3583be4bfb)@@ -620,6 +620,18 @@ static bool mptcp\_check\_data\_fin(struct sock \*sk) return ret; } +static void mptcp\_dss\_corruption(struct mptcp\_sock \*msk, struct sock \*ssk)+{+ if (READ\_ONCE(msk->allow\_infinite\_fallback)) {+ MPTCP\_INC\_STATS(sock\_net(ssk),+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK);+ mptcp\_do\_fallback(ssk);+ } else {+ MPTCP\_INC\_STATS(sock\_net(ssk), MPTCP\_MIB\_DSSCORRUPTIONRESET);+ mptcp\_subflow\_reset(ssk);+ }+}+ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, struct sock \*ssk, unsigned int \*bytes)@@ -692,10 +704,16 @@ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, moved += len; seq += len; - if (WARN\_ON\_ONCE(map\_remaining < len))- break;+ if (unlikely(map\_remaining < len)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1);+ mptcp\_dss\_corruption(msk, ssk);+ } } else {- WARN\_ON\_ONCE(!fin);+ if (unlikely(!fin)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1);+ mptcp\_dss\_corruption(msk, ssk);+ }+ sk\_eat\_skb(ssk, skb); done = true; }diff --git a/net/mptcp/subflow.c b/net/mptcp/subflow.cindex c0ce9faeb4008e..7d14da95a28305 100644--- a/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=f82b629d41dd79fc143de40e894452ed52eb0d5a)+++ b/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=8bfd391bde685df7289b928ce8876a3583be4bfb)@@ -971,8 +971,10 @@ static bool skb\_is\_fully\_mapped(struct sock \*ssk, struct sk\_buff \*skb) unsigned int skb\_consumed;  skb\_consumed = tcp\_sk(ssk)->copied\_seq - TCP\_SKB\_CB(skb)->seq;- if (WARN\_ON\_ONCE(skb\_consumed >= skb->len))+ if (unlikely(skb\_consumed >= skb->len)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1); return true;+ }  return skb->len - skb\_consumed <= subflow->map\_data\_len - mptcp\_subflow\_get\_map\_offset(subflow); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:42:47 +0000



=== Content from git.kernel.org_51a39554_20250114_224409.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-08 13:04:52 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:27 +0200 |
| commit | [35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25)) | |
| tree | [4a47c056fd41f3b76ea77f6938b181e99364c5bf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25) | |
| parent | [3b196f47591436beb736f7a93e73691228115a02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b196f47591436beb736f7a93e73691228115a02) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25&id2=3b196f47591436beb736f7a93e73691228115a02)) | |
| download | [linux-35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25.tar.gz) | |

mptcp: handle consistently DSS corruptioncommit e32d262c89e2b22cb0640223f953b548617ed8a6 upstream.
Bugged peer implementation can send corrupted DSS options, consistently
hitting a few warning in the data path. Use DEBUG\_NET assertions, to
avoid the splat on some builds and handle consistently the error, dumping
related MIBs and performing fallback and/or reset according to the
subflow type.
Fixes: 6771bfd9ee24 ("mptcp: update mptcp ack sequence from work queue")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25)

| -rw-r--r-- | [net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.c?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.h?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/subflow.c?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 28 insertions, 4 deletions

| diff --git a/net/mptcp/mib.c b/net/mptcp/mib.cindex 1f3161a38b9d28..691d7c1e8504a5 100644--- a/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=3b196f47591436beb736f7a93e73691228115a02)+++ b/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25)@@ -26,6 +26,8 @@ static const struct snmp\_mib mptcp\_snmp\_list[] = { SNMP\_MIB\_ITEM("MPJoinAckRx", MPTCP\_MIB\_JOINACKRX), SNMP\_MIB\_ITEM("MPJoinAckHMacFailure", MPTCP\_MIB\_JOINACKMAC), SNMP\_MIB\_ITEM("DSSNotMatching", MPTCP\_MIB\_DSSNOMATCH),+ SNMP\_MIB\_ITEM("DSSCorruptionFallback", MPTCP\_MIB\_DSSCORRUPTIONFALLBACK),+ SNMP\_MIB\_ITEM("DSSCorruptionReset", MPTCP\_MIB\_DSSCORRUPTIONRESET), SNMP\_MIB\_ITEM("InfiniteMapTx", MPTCP\_MIB\_INFINITEMAPTX), SNMP\_MIB\_ITEM("InfiniteMapRx", MPTCP\_MIB\_INFINITEMAPRX), SNMP\_MIB\_ITEM("DSSNoMatchTCP", MPTCP\_MIB\_DSSTCPMISMATCH),diff --git a/net/mptcp/mib.h b/net/mptcp/mib.hindex a7b94f5c5d2776..bd3d72e1eb24ee 100644--- a/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=3b196f47591436beb736f7a93e73691228115a02)+++ b/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25)@@ -19,6 +19,8 @@ enum linux\_mptcp\_mib\_field { MPTCP\_MIB\_JOINACKRX, /\* Received an ACK + MP\_JOIN \*/ MPTCP\_MIB\_JOINACKMAC, /\* HMAC was wrong on ACK + MP\_JOIN \*/ MPTCP\_MIB\_DSSNOMATCH, /\* Received a new mapping that did not match the previous one \*/+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK,/\* DSS corruption detected, fallback \*/+ MPTCP\_MIB\_DSSCORRUPTIONRESET, /\* DSS corruption detected, MPJ subflow reset \*/ MPTCP\_MIB\_INFINITEMAPTX, /\* Sent an infinite mapping \*/ MPTCP\_MIB\_INFINITEMAPRX, /\* Received an infinite mapping \*/ MPTCP\_MIB\_DSSTCPMISMATCH, /\* DSS-mapping did not map with TCP's sequence numbers \*/diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex 62a2da0f2b54d6..d68e93dab88c3e 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=3b196f47591436beb736f7a93e73691228115a02)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25)@@ -630,6 +630,18 @@ static bool mptcp\_check\_data\_fin(struct sock \*sk) return ret; } +static void mptcp\_dss\_corruption(struct mptcp\_sock \*msk, struct sock \*ssk)+{+ if (READ\_ONCE(msk->allow\_infinite\_fallback)) {+ MPTCP\_INC\_STATS(sock\_net(ssk),+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK);+ mptcp\_do\_fallback(ssk);+ } else {+ MPTCP\_INC\_STATS(sock\_net(ssk), MPTCP\_MIB\_DSSCORRUPTIONRESET);+ mptcp\_subflow\_reset(ssk);+ }+}+ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, struct sock \*ssk, unsigned int \*bytes)@@ -702,10 +714,16 @@ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, moved += len; seq += len; - if (WARN\_ON\_ONCE(map\_remaining < len))- break;+ if (unlikely(map\_remaining < len)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1);+ mptcp\_dss\_corruption(msk, ssk);+ } } else {- WARN\_ON\_ONCE(!fin);+ if (unlikely(!fin)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1);+ mptcp\_dss\_corruption(msk, ssk);+ }+ sk\_eat\_skb(ssk, skb); done = true; }diff --git a/net/mptcp/subflow.c b/net/mptcp/subflow.cindex b3167d505ff07c..e77b4e6021e8a3 100644--- a/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=3b196f47591436beb736f7a93e73691228115a02)+++ b/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=35668f8ec84f6c944676e48ecc6bbc5fc8e6fe25)@@ -855,8 +855,10 @@ static bool skb\_is\_fully\_mapped(struct sock \*ssk, struct sk\_buff \*skb) unsigned int skb\_consumed;  skb\_consumed = tcp\_sk(ssk)->copied\_seq - TCP\_SKB\_CB(skb)->seq;- if (WARN\_ON\_ONCE(skb\_consumed >= skb->len))+ if (unlikely(skb\_consumed >= skb->len)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1); return true;+ }  return skb->len - skb\_consumed <= subflow->map\_data\_len - mptcp\_subflow\_get\_map\_offset(subflow); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:42:46 +0000



=== Content from git.kernel.org_b14371a6_20250114_224410.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-10-08 13:04:52 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:24:36 +0200 |
| commit | [b8be15d1ae7ea4eedd547c3b3141f592fbddcd30](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30)) | |
| tree | [a527dbc334669d00b50b26f0a70bde6c88112ea8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30) | |
| parent | [143ffa7878e2d9d9c3836ee8304ce4930f7852a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=143ffa7878e2d9d9c3836ee8304ce4930f7852a3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30&id2=143ffa7878e2d9d9c3836ee8304ce4930f7852a3)) | |
| download | [linux-b8be15d1ae7ea4eedd547c3b3141f592fbddcd30.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b8be15d1ae7ea4eedd547c3b3141f592fbddcd30.tar.gz) | |

mptcp: handle consistently DSS corruptioncommit e32d262c89e2b22cb0640223f953b548617ed8a6 upstream.
Bugged peer implementation can send corrupted DSS options, consistently
hitting a few warning in the data path. Use DEBUG\_NET assertions, to
avoid the splat on some builds and handle consistently the error, dumping
related MIBs and performing fallback and/or reset according to the
subflow type.
Fixes: 6771bfd9ee24 ("mptcp: update mptcp ack sequence from work queue")
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551@kernel.org](https://patch.msgid.link/20241008-net-mptcp-fallback-fixes-v1-1-c6fb8e93e551%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30)

| -rw-r--r-- | [net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.c?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/mib.h?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/protocol.c?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/subflow.c?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 28 insertions, 4 deletions

| diff --git a/net/mptcp/mib.c b/net/mptcp/mib.cindex 7884217f33eb2f..79f2278434b950 100644--- a/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=143ffa7878e2d9d9c3836ee8304ce4930f7852a3)+++ b/[net/mptcp/mib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.c?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30)@@ -26,6 +26,8 @@ static const struct snmp\_mib mptcp\_snmp\_list[] = { SNMP\_MIB\_ITEM("MPJoinAckRx", MPTCP\_MIB\_JOINACKRX), SNMP\_MIB\_ITEM("MPJoinAckHMacFailure", MPTCP\_MIB\_JOINACKMAC), SNMP\_MIB\_ITEM("DSSNotMatching", MPTCP\_MIB\_DSSNOMATCH),+ SNMP\_MIB\_ITEM("DSSCorruptionFallback", MPTCP\_MIB\_DSSCORRUPTIONFALLBACK),+ SNMP\_MIB\_ITEM("DSSCorruptionReset", MPTCP\_MIB\_DSSCORRUPTIONRESET), SNMP\_MIB\_ITEM("InfiniteMapTx", MPTCP\_MIB\_INFINITEMAPTX), SNMP\_MIB\_ITEM("InfiniteMapRx", MPTCP\_MIB\_INFINITEMAPRX), SNMP\_MIB\_ITEM("DSSNoMatchTCP", MPTCP\_MIB\_DSSTCPMISMATCH),diff --git a/net/mptcp/mib.h b/net/mptcp/mib.hindex 443604462ace80..e6e570251d32a4 100644--- a/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=143ffa7878e2d9d9c3836ee8304ce4930f7852a3)+++ b/[net/mptcp/mib.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/mib.h?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30)@@ -19,6 +19,8 @@ enum linux\_mptcp\_mib\_field { MPTCP\_MIB\_JOINACKRX, /\* Received an ACK + MP\_JOIN \*/ MPTCP\_MIB\_JOINACKMAC, /\* HMAC was wrong on ACK + MP\_JOIN \*/ MPTCP\_MIB\_DSSNOMATCH, /\* Received a new mapping that did not match the previous one \*/+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK,/\* DSS corruption detected, fallback \*/+ MPTCP\_MIB\_DSSCORRUPTIONRESET, /\* DSS corruption detected, MPJ subflow reset \*/ MPTCP\_MIB\_INFINITEMAPTX, /\* Sent an infinite mapping \*/ MPTCP\_MIB\_INFINITEMAPRX, /\* Received an infinite mapping \*/ MPTCP\_MIB\_DSSTCPMISMATCH, /\* DSS-mapping did not map with TCP's sequence numbers \*/diff --git a/net/mptcp/protocol.c b/net/mptcp/protocol.cindex ba6248372aee70..8cdd4ec152e7b5 100644--- a/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=143ffa7878e2d9d9c3836ee8304ce4930f7852a3)+++ b/[net/mptcp/protocol.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/protocol.c?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30)@@ -620,6 +620,18 @@ static bool mptcp\_check\_data\_fin(struct sock \*sk) return ret; } +static void mptcp\_dss\_corruption(struct mptcp\_sock \*msk, struct sock \*ssk)+{+ if (READ\_ONCE(msk->allow\_infinite\_fallback)) {+ MPTCP\_INC\_STATS(sock\_net(ssk),+ MPTCP\_MIB\_DSSCORRUPTIONFALLBACK);+ mptcp\_do\_fallback(ssk);+ } else {+ MPTCP\_INC\_STATS(sock\_net(ssk), MPTCP\_MIB\_DSSCORRUPTIONRESET);+ mptcp\_subflow\_reset(ssk);+ }+}+ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, struct sock \*ssk, unsigned int \*bytes)@@ -692,10 +704,16 @@ static bool \_\_mptcp\_move\_skbs\_from\_subflow(struct mptcp\_sock \*msk, moved += len; seq += len; - if (WARN\_ON\_ONCE(map\_remaining < len))- break;+ if (unlikely(map\_remaining < len)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1);+ mptcp\_dss\_corruption(msk, ssk);+ } } else {- WARN\_ON\_ONCE(!fin);+ if (unlikely(!fin)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1);+ mptcp\_dss\_corruption(msk, ssk);+ }+ sk\_eat\_skb(ssk, skb); done = true; }diff --git a/net/mptcp/subflow.c b/net/mptcp/subflow.cindex afbbae041d422b..38f46502d76e04 100644--- a/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=143ffa7878e2d9d9c3836ee8304ce4930f7852a3)+++ b/[net/mptcp/subflow.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/subflow.c?id=b8be15d1ae7ea4eedd547c3b3141f592fbddcd30)@@ -944,8 +944,10 @@ static bool skb\_is\_fully\_mapped(struct sock \*ssk, struct sk\_buff \*skb) unsigned int skb\_consumed;  skb\_consumed = tcp\_sk(ssk)->copied\_seq - TCP\_SKB\_CB(skb)->seq;- if (WARN\_ON\_ONCE(skb\_consumed >= skb->len))+ if (unlikely(skb\_consumed >= skb->len)) {+ DEBUG\_NET\_WARN\_ON\_ONCE(1); return true;+ }  return skb->len - skb\_consumed <= subflow->map\_data\_len - mptcp\_subflow\_get\_map\_offset(subflow); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:42:47 +0000


