=== Content from git.kernel.org_ec1cacc3_20250115_093455.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bartosz Golaszewski <bartosz.golaszewski@linaro.org> | 2024-10-03 10:43:41 +0200 |
| --- | --- | --- |
| committer | Bjorn Helgaas <bhelgaas@google.com> | 2024-10-12 09:31:44 -0500 |
| commit | [1d59d474e1cb7d4fdf87dfaf96f44647f13ea590](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590)) | |
| tree | [52e87d3ddcdb662ffa1ab96d078e78678b422785](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590) | |
| parent | [9852d85ec9d492ebef56dc5f229416c925758edc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9852d85ec9d492ebef56dc5f229416c925758edc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590&id2=9852d85ec9d492ebef56dc5f229416c925758edc)) | |
| download | [linux-1d59d474e1cb7d4fdf87dfaf96f44647f13ea590.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1d59d474e1cb7d4fdf87dfaf96f44647f13ea590.tar.gz) | |

PCI: Hold rescan lock while adding devices during host probeSince adding the PCI power control code, we may end up with a race between
the pwrctl platform device rescanning the bus and host controller probe
functions. The latter need to take the rescan lock when adding devices or
we may end up in an undefined state having two incompletely added devices
and hit the following crash when trying to remove the device over sysfs:
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
Internal error: Oops: 0000000096000004 [#1] SMP
Call trace:
\_\_pi\_strlen+0x14/0x150
kernfs\_find\_ns+0x80/0x13c
kernfs\_remove\_by\_name\_ns+0x54/0xf0
sysfs\_remove\_bin\_file+0x24/0x34
pci\_remove\_resource\_files+0x3c/0x84
pci\_remove\_sysfs\_dev\_files+0x28/0x38
pci\_stop\_bus\_device+0x8c/0xd8
pci\_stop\_bus\_device+0x40/0xd8
pci\_stop\_and\_remove\_bus\_device\_locked+0x28/0x48
remove\_store+0x70/0xb0
dev\_attr\_store+0x20/0x38
sysfs\_kf\_write+0x58/0x78
kernfs\_fop\_write\_iter+0xe8/0x184
vfs\_write+0x2dc/0x308
ksys\_write+0x7c/0xec
Fixes: 4565d2652a37 ("PCI/pwrctl: Add PCI power control core code")
Link: [https://lore.kernel.org/r/20241003084342.27501-1-brgl@bgdev.pl](https://lore.kernel.org/r/20241003084342.27501-1-brgl%40bgdev.pl)
Reported-by: Konrad Dybcio <konradybcio@kernel.org>
Tested-by: Konrad Dybcio <konradybcio@kernel.org>
Signed-off-by: Bartosz Golaszewski <bartosz.golaszewski@linaro.org>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590)

| -rw-r--r-- | [drivers/pci/probe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/probe.c?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/pci/probe.c b/drivers/pci/probe.cindex 4f68414c308609..f1615805f5b078 100644--- a/[drivers/pci/probe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/probe.c?id=9852d85ec9d492ebef56dc5f229416c925758edc)+++ b/[drivers/pci/probe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/probe.c?id=1d59d474e1cb7d4fdf87dfaf96f44647f13ea590)@@ -3105,7 +3105,9 @@ int pci\_host\_probe(struct pci\_host\_bridge \*bridge) list\_for\_each\_entry(child, &bus->children, node) pcie\_bus\_configure\_settings(child); + pci\_lock\_rescan\_remove(); pci\_bus\_add\_devices(bus);+ pci\_unlock\_rescan\_remove(); return 0; } EXPORT\_SYMBOL\_GPL(pci\_host\_probe); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:33:31 +0000



=== Content from git.kernel.org_d79549e7_20250115_093456.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bartosz Golaszewski <bartosz.golaszewski@linaro.org> | 2024-10-03 10:43:41 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:38 +0100 |
| commit | [d4f38a0e7cc94615f63cf7765ca117e5cc2773ae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae)) | |
| tree | [ecdd307b7254b0f1d052181f9a035bb6f4e0fc77](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae) | |
| parent | [ac35c4e44831271d99370a57cd77eeae2e39f634](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac35c4e44831271d99370a57cd77eeae2e39f634) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae&id2=ac35c4e44831271d99370a57cd77eeae2e39f634)) | |
| download | [linux-d4f38a0e7cc94615f63cf7765ca117e5cc2773ae.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d4f38a0e7cc94615f63cf7765ca117e5cc2773ae.tar.gz) | |

PCI: Hold rescan lock while adding devices during host probe[ Upstream commit 1d59d474e1cb7d4fdf87dfaf96f44647f13ea590 ]
Since adding the PCI power control code, we may end up with a race between
the pwrctl platform device rescanning the bus and host controller probe
functions. The latter need to take the rescan lock when adding devices or
we may end up in an undefined state having two incompletely added devices
and hit the following crash when trying to remove the device over sysfs:
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
Internal error: Oops: 0000000096000004 [#1] SMP
Call trace:
\_\_pi\_strlen+0x14/0x150
kernfs\_find\_ns+0x80/0x13c
kernfs\_remove\_by\_name\_ns+0x54/0xf0
sysfs\_remove\_bin\_file+0x24/0x34
pci\_remove\_resource\_files+0x3c/0x84
pci\_remove\_sysfs\_dev\_files+0x28/0x38
pci\_stop\_bus\_device+0x8c/0xd8
pci\_stop\_bus\_device+0x40/0xd8
pci\_stop\_and\_remove\_bus\_device\_locked+0x28/0x48
remove\_store+0x70/0xb0
dev\_attr\_store+0x20/0x38
sysfs\_kf\_write+0x58/0x78
kernfs\_fop\_write\_iter+0xe8/0x184
vfs\_write+0x2dc/0x308
ksys\_write+0x7c/0xec
Fixes: 4565d2652a37 ("PCI/pwrctl: Add PCI power control core code")
Link: [https://lore.kernel.org/r/20241003084342.27501-1-brgl@bgdev.pl](https://lore.kernel.org/r/20241003084342.27501-1-brgl%40bgdev.pl)
Reported-by: Konrad Dybcio <konradybcio@kernel.org>
Tested-by: Konrad Dybcio <konradybcio@kernel.org>
Signed-off-by: Bartosz Golaszewski <bartosz.golaszewski@linaro.org>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae)

| -rw-r--r-- | [drivers/pci/probe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/probe.c?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/pci/probe.c b/drivers/pci/probe.cindex e9e56bbb3b59d1..d203e23b75620c 100644--- a/[drivers/pci/probe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/probe.c?id=ac35c4e44831271d99370a57cd77eeae2e39f634)+++ b/[drivers/pci/probe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/probe.c?id=d4f38a0e7cc94615f63cf7765ca117e5cc2773ae)@@ -3106,7 +3106,9 @@ int pci\_host\_probe(struct pci\_host\_bridge \*bridge) list\_for\_each\_entry(child, &bus->children, node) pcie\_bus\_configure\_settings(child); + pci\_lock\_rescan\_remove(); pci\_bus\_add\_devices(bus);+ pci\_unlock\_rescan\_remove(); return 0; } EXPORT\_SYMBOL\_GPL(pci\_host\_probe); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:33:33 +0000


