=== Content from git.kernel.org_2994f102_20250114_190110.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Rutland <mark.rutland@arm.com> | 2024-10-08 16:58:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:51:19 +0200 |
| commit | [3d2530c65be04e93720e30f191a7cf1a3aa8b51c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c)) | |
| tree | [d75848013ced6457e8e0c8282d7678747fbf7814](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c) | |
| parent | [bec9ff9b9c8e14c2b813c1eeb7db906d4078c99c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bec9ff9b9c8e14c2b813c1eeb7db906d4078c99c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c&id2=bec9ff9b9c8e14c2b813c1eeb7db906d4078c99c)) | |
| download | [linux-3d2530c65be04e93720e30f191a7cf1a3aa8b51c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3d2530c65be04e93720e30f191a7cf1a3aa8b51c.tar.gz) | |

arm64: probes: Fix uprobes for big-endian kernelscommit 13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7 upstream.
The arm64 uprobes code is broken for big-endian kernels as it doesn't
convert the in-memory instruction encoding (which is always
little-endian) into the kernel's native endianness before analyzing and
simulating instructions. This may result in a few distinct problems:
\* The kernel may may erroneously reject probing an instruction which can
safely be probed.
\* The kernel may erroneously erroneously permit stepping an
instruction out-of-line when that instruction cannot be stepped
out-of-line safely.
\* The kernel may erroneously simulate instruction incorrectly dur to
interpretting the byte-swapped encoding.
The endianness mismatch isn't caught by the compiler or sparse because:
\* The arch\_uprobe::{insn,ixol} fields are encoded as arrays of u8, so
the compiler and sparse have no idea these contain a little-endian
32-bit value. The core uprobes code populates these with a memcpy()
which similarly does not handle endianness.
\* While the uprobe\_opcode\_t type is an alias for \_\_le32, both
arch\_uprobe\_analyze\_insn() and arch\_uprobe\_skip\_sstep() cast from u8[]
to the similarly-named probe\_opcode\_t, which is an alias for u32.
Hence there is no endianness conversion warning.
Fix this by changing the arch\_uprobe::{insn,ixol} fields to \_\_le32 and
adding the appropriate \_\_le32\_to\_cpu() conversions prior to consuming
the instruction encoding. The core uprobes copies these fields as opaque
ranges of bytes, and so is unaffected by this change.
At the same time, remove MAX\_UINSN\_BYTES and consistently use
AARCH64\_INSN\_SIZE for clarity.
Tested with the following:
| #include <stdio.h>
| #include <stdbool.h>
|
| #define noinline \_\_attribute\_\_((noinline))
|
| static noinline void \*adrp\_self(void)
| {
| void \*addr;
|
| asm volatile(
| " adrp %x0, adrp\_self\n"
| " add %x0, %x0, :lo12:adrp\_self\n"
| : "=r" (addr));
| }
|
|
| int main(int argc, char \*argv)
| {
| void \*ptr = adrp\_self();
| bool equal = (ptr == adrp\_self);
|
| printf("adrp\_self => %p\n"
| "adrp\_self() => %p\n"
| "%s\n",
| adrp\_self, ptr, equal ? "EQUAL" : "NOT EQUAL");
|
| return 0;
| }
.... where the adrp\_self() function was compiled to:
| 00000000004007e0 <adrp\_self>:
| 4007e0: 90000000 adrp x0, 400000 <\_\_ehdr\_start>
| 4007e4: 911f8000 add x0, x0, #0x7e0
| 4007e8: d65f03c0 ret
Before this patch, the ADRP is not recognized, and is assumed to be
steppable, resulting in corruption of the result:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0xffffffffff7e0
| NOT EQUAL
After this patch, the ADRP is correctly recognized and simulated:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| #
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
Fixes: 9842ceae9fa8 ("arm64: Add uprobe support")
Cc: stable@vger.kernel.org
Signed-off-by: Mark Rutland <mark.rutland@arm.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: Will Deacon <will@kernel.org>
Link: [https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland@arm.com](https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland%40arm.com)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c)

| -rw-r--r-- | [arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/uprobes.h?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/probes/uprobes.c?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 7 deletions

| diff --git a/arch/arm64/include/asm/uprobes.h b/arch/arm64/include/asm/uprobes.hindex 2b09495499c618..014b02897f8e22 100644--- a/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=bec9ff9b9c8e14c2b813c1eeb7db906d4078c99c)+++ b/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c)@@ -10,11 +10,9 @@ #include <asm/insn.h> #include <asm/probes.h> -#define MAX\_UINSN\_BYTES AARCH64\_INSN\_SIZE- #define UPROBE\_SWBP\_INSN cpu\_to\_le32(BRK64\_OPCODE\_UPROBES) #define UPROBE\_SWBP\_INSN\_SIZE AARCH64\_INSN\_SIZE-#define UPROBE\_XOL\_SLOT\_BYTES MAX\_UINSN\_BYTES+#define UPROBE\_XOL\_SLOT\_BYTES AARCH64\_INSN\_SIZE  typedef \_\_le32 uprobe\_opcode\_t; @@ -23,8 +21,8 @@ struct arch\_uprobe\_task {  struct arch\_uprobe { union {- u8 insn[MAX\_UINSN\_BYTES];- u8 ixol[MAX\_UINSN\_BYTES];+ \_\_le32 insn;+ \_\_le32 ixol; }; struct arch\_probe\_insn api; bool simulate;diff --git a/arch/arm64/kernel/probes/uprobes.c b/arch/arm64/kernel/probes/uprobes.cindex d49aef2657cdf7..a2f137a595fc1c 100644--- a/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=bec9ff9b9c8e14c2b813c1eeb7db906d4078c99c)+++ b/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=3d2530c65be04e93720e30f191a7cf1a3aa8b51c)@@ -42,7 +42,7 @@ int arch\_uprobe\_analyze\_insn(struct arch\_uprobe \*auprobe, struct mm\_struct \*mm, else if (!IS\_ALIGNED(addr, AARCH64\_INSN\_SIZE)) return -EINVAL; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn);  switch (arm\_probe\_decode\_insn(insn, &auprobe->api)) { case INSN\_REJECTED:@@ -108,7 +108,7 @@ bool arch\_uprobe\_skip\_sstep(struct arch\_uprobe \*auprobe, struct pt\_regs \*regs) if (!auprobe->simulate) return false; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn); addr = instruction\_pointer(regs);  if (auprobe->api.handler) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:59:47 +0000



=== Content from git.kernel.org_3028b71c_20250114_190110.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Rutland <mark.rutland@arm.com> | 2024-10-08 16:58:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:46:20 +0200 |
| commit | [8165bf83b8a64be801d59cd2532b0d1ffed74d00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00)) | |
| tree | [6903f7cb222228cd5b8a6d48f29a3c3426f7688e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00) | |
| parent | [173c13e38799c362c5acb6731a695abac11daeab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=173c13e38799c362c5acb6731a695abac11daeab) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00&id2=173c13e38799c362c5acb6731a695abac11daeab)) | |
| download | [linux-8165bf83b8a64be801d59cd2532b0d1ffed74d00.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8165bf83b8a64be801d59cd2532b0d1ffed74d00.tar.gz) | |

arm64: probes: Fix uprobes for big-endian kernelscommit 13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7 upstream.
The arm64 uprobes code is broken for big-endian kernels as it doesn't
convert the in-memory instruction encoding (which is always
little-endian) into the kernel's native endianness before analyzing and
simulating instructions. This may result in a few distinct problems:
\* The kernel may may erroneously reject probing an instruction which can
safely be probed.
\* The kernel may erroneously erroneously permit stepping an
instruction out-of-line when that instruction cannot be stepped
out-of-line safely.
\* The kernel may erroneously simulate instruction incorrectly dur to
interpretting the byte-swapped encoding.
The endianness mismatch isn't caught by the compiler or sparse because:
\* The arch\_uprobe::{insn,ixol} fields are encoded as arrays of u8, so
the compiler and sparse have no idea these contain a little-endian
32-bit value. The core uprobes code populates these with a memcpy()
which similarly does not handle endianness.
\* While the uprobe\_opcode\_t type is an alias for \_\_le32, both
arch\_uprobe\_analyze\_insn() and arch\_uprobe\_skip\_sstep() cast from u8[]
to the similarly-named probe\_opcode\_t, which is an alias for u32.
Hence there is no endianness conversion warning.
Fix this by changing the arch\_uprobe::{insn,ixol} fields to \_\_le32 and
adding the appropriate \_\_le32\_to\_cpu() conversions prior to consuming
the instruction encoding. The core uprobes copies these fields as opaque
ranges of bytes, and so is unaffected by this change.
At the same time, remove MAX\_UINSN\_BYTES and consistently use
AARCH64\_INSN\_SIZE for clarity.
Tested with the following:
| #include <stdio.h>
| #include <stdbool.h>
|
| #define noinline \_\_attribute\_\_((noinline))
|
| static noinline void \*adrp\_self(void)
| {
| void \*addr;
|
| asm volatile(
| " adrp %x0, adrp\_self\n"
| " add %x0, %x0, :lo12:adrp\_self\n"
| : "=r" (addr));
| }
|
|
| int main(int argc, char \*argv)
| {
| void \*ptr = adrp\_self();
| bool equal = (ptr == adrp\_self);
|
| printf("adrp\_self => %p\n"
| "adrp\_self() => %p\n"
| "%s\n",
| adrp\_self, ptr, equal ? "EQUAL" : "NOT EQUAL");
|
| return 0;
| }
.... where the adrp\_self() function was compiled to:
| 00000000004007e0 <adrp\_self>:
| 4007e0: 90000000 adrp x0, 400000 <\_\_ehdr\_start>
| 4007e4: 911f8000 add x0, x0, #0x7e0
| 4007e8: d65f03c0 ret
Before this patch, the ADRP is not recognized, and is assumed to be
steppable, resulting in corruption of the result:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0xffffffffff7e0
| NOT EQUAL
After this patch, the ADRP is correctly recognized and simulated:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| #
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
Fixes: 9842ceae9fa8 ("arm64: Add uprobe support")
Cc: stable@vger.kernel.org
Signed-off-by: Mark Rutland <mark.rutland@arm.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: Will Deacon <will@kernel.org>
Link: [https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland@arm.com](https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland%40arm.com)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00)

| -rw-r--r-- | [arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/uprobes.h?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/probes/uprobes.c?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 7 deletions

| diff --git a/arch/arm64/include/asm/uprobes.h b/arch/arm64/include/asm/uprobes.hindex 2b09495499c618..014b02897f8e22 100644--- a/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=173c13e38799c362c5acb6731a695abac11daeab)+++ b/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00)@@ -10,11 +10,9 @@ #include <asm/insn.h> #include <asm/probes.h> -#define MAX\_UINSN\_BYTES AARCH64\_INSN\_SIZE- #define UPROBE\_SWBP\_INSN cpu\_to\_le32(BRK64\_OPCODE\_UPROBES) #define UPROBE\_SWBP\_INSN\_SIZE AARCH64\_INSN\_SIZE-#define UPROBE\_XOL\_SLOT\_BYTES MAX\_UINSN\_BYTES+#define UPROBE\_XOL\_SLOT\_BYTES AARCH64\_INSN\_SIZE  typedef \_\_le32 uprobe\_opcode\_t; @@ -23,8 +21,8 @@ struct arch\_uprobe\_task {  struct arch\_uprobe { union {- u8 insn[MAX\_UINSN\_BYTES];- u8 ixol[MAX\_UINSN\_BYTES];+ \_\_le32 insn;+ \_\_le32 ixol; }; struct arch\_probe\_insn api; bool simulate;diff --git a/arch/arm64/kernel/probes/uprobes.c b/arch/arm64/kernel/probes/uprobes.cindex d49aef2657cdf7..a2f137a595fc1c 100644--- a/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=173c13e38799c362c5acb6731a695abac11daeab)+++ b/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=8165bf83b8a64be801d59cd2532b0d1ffed74d00)@@ -42,7 +42,7 @@ int arch\_uprobe\_analyze\_insn(struct arch\_uprobe \*auprobe, struct mm\_struct \*mm, else if (!IS\_ALIGNED(addr, AARCH64\_INSN\_SIZE)) return -EINVAL; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn);  switch (arm\_probe\_decode\_insn(insn, &auprobe->api)) { case INSN\_REJECTED:@@ -108,7 +108,7 @@ bool arch\_uprobe\_skip\_sstep(struct arch\_uprobe \*auprobe, struct pt\_regs \*regs) if (!auprobe->simulate) return false; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn); addr = instruction\_pointer(regs);  if (auprobe->api.handler) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:59:48 +0000



=== Content from git.kernel.org_789cf4fe_20250114_190109.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=14841bb7a531b96e2dde37423a3b33e75147c60d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=14841bb7a531b96e2dde37423a3b33e75147c60d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14841bb7a531b96e2dde37423a3b33e75147c60d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=14841bb7a531b96e2dde37423a3b33e75147c60d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Rutland <mark.rutland@arm.com> | 2024-10-08 16:58:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:56:01 +0100 |
| commit | [14841bb7a531b96e2dde37423a3b33e75147c60d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14841bb7a531b96e2dde37423a3b33e75147c60d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=14841bb7a531b96e2dde37423a3b33e75147c60d)) | |
| tree | [c4419182ddb1da4df21c700e98e5ea95c842255a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=14841bb7a531b96e2dde37423a3b33e75147c60d) | |
| parent | [63f9dae763a856fff69d676ee705a47cd7b297d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63f9dae763a856fff69d676ee705a47cd7b297d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=14841bb7a531b96e2dde37423a3b33e75147c60d&id2=63f9dae763a856fff69d676ee705a47cd7b297d8)) | |
| download | [linux-14841bb7a531b96e2dde37423a3b33e75147c60d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-14841bb7a531b96e2dde37423a3b33e75147c60d.tar.gz) | |

arm64: probes: Fix uprobes for big-endian kernels[ Upstream commit 13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7 ]
The arm64 uprobes code is broken for big-endian kernels as it doesn't
convert the in-memory instruction encoding (which is always
little-endian) into the kernel's native endianness before analyzing and
simulating instructions. This may result in a few distinct problems:
\* The kernel may may erroneously reject probing an instruction which can
safely be probed.
\* The kernel may erroneously erroneously permit stepping an
instruction out-of-line when that instruction cannot be stepped
out-of-line safely.
\* The kernel may erroneously simulate instruction incorrectly dur to
interpretting the byte-swapped encoding.
The endianness mismatch isn't caught by the compiler or sparse because:
\* The arch\_uprobe::{insn,ixol} fields are encoded as arrays of u8, so
the compiler and sparse have no idea these contain a little-endian
32-bit value. The core uprobes code populates these with a memcpy()
which similarly does not handle endianness.
\* While the uprobe\_opcode\_t type is an alias for \_\_le32, both
arch\_uprobe\_analyze\_insn() and arch\_uprobe\_skip\_sstep() cast from u8[]
to the similarly-named probe\_opcode\_t, which is an alias for u32.
Hence there is no endianness conversion warning.
Fix this by changing the arch\_uprobe::{insn,ixol} fields to \_\_le32 and
adding the appropriate \_\_le32\_to\_cpu() conversions prior to consuming
the instruction encoding. The core uprobes copies these fields as opaque
ranges of bytes, and so is unaffected by this change.
At the same time, remove MAX\_UINSN\_BYTES and consistently use
AARCH64\_INSN\_SIZE for clarity.
Tested with the following:
| #include <stdio.h>
| #include <stdbool.h>
|
| #define noinline \_\_attribute\_\_((noinline))
|
| static noinline void \*adrp\_self(void)
| {
| void \*addr;
|
| asm volatile(
| " adrp %x0, adrp\_self\n"
| " add %x0, %x0, :lo12:adrp\_self\n"
| : "=r" (addr));
| }
|
|
| int main(int argc, char \*argv)
| {
| void \*ptr = adrp\_self();
| bool equal = (ptr == adrp\_self);
|
| printf("adrp\_self => %p\n"
| "adrp\_self() => %p\n"
| "%s\n",
| adrp\_self, ptr, equal ? "EQUAL" : "NOT EQUAL");
|
| return 0;
| }
.... where the adrp\_self() function was compiled to:
| 00000000004007e0 <adrp\_self>:
| 4007e0: 90000000 adrp x0, 400000 <\_\_ehdr\_start>
| 4007e4: 911f8000 add x0, x0, #0x7e0
| 4007e8: d65f03c0 ret
Before this patch, the ADRP is not recognized, and is assumed to be
steppable, resulting in corruption of the result:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0xffffffffff7e0
| NOT EQUAL
After this patch, the ADRP is correctly recognized and simulated:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| #
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
Fixes: 9842ceae9fa8 ("arm64: Add uprobe support")
Cc: stable@vger.kernel.org
Signed-off-by: Mark Rutland <mark.rutland@arm.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: Will Deacon <will@kernel.org>
Link: [https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland@arm.com](https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland%40arm.com)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=14841bb7a531b96e2dde37423a3b33e75147c60d)

| -rw-r--r-- | [arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/uprobes.h?id=14841bb7a531b96e2dde37423a3b33e75147c60d) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/probes/uprobes.c?id=14841bb7a531b96e2dde37423a3b33e75147c60d) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 7 deletions

| diff --git a/arch/arm64/include/asm/uprobes.h b/arch/arm64/include/asm/uprobes.hindex ba4bff5ca67494..98f29a43bfe898 100644--- a/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=63f9dae763a856fff69d676ee705a47cd7b297d8)+++ b/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=14841bb7a531b96e2dde37423a3b33e75147c60d)@@ -10,11 +10,9 @@ #include <asm/insn.h> #include <asm/probes.h> -#define MAX\_UINSN\_BYTES AARCH64\_INSN\_SIZE- #define UPROBE\_SWBP\_INSN cpu\_to\_le32(BRK64\_OPCODE\_UPROBES) #define UPROBE\_SWBP\_INSN\_SIZE AARCH64\_INSN\_SIZE-#define UPROBE\_XOL\_SLOT\_BYTES MAX\_UINSN\_BYTES+#define UPROBE\_XOL\_SLOT\_BYTES AARCH64\_INSN\_SIZE  typedef u32 uprobe\_opcode\_t; @@ -23,8 +21,8 @@ struct arch\_uprobe\_task {  struct arch\_uprobe { union {- u8 insn[MAX\_UINSN\_BYTES];- u8 ixol[MAX\_UINSN\_BYTES];+ \_\_le32 insn;+ \_\_le32 ixol; }; struct arch\_probe\_insn api; bool simulate;diff --git a/arch/arm64/kernel/probes/uprobes.c b/arch/arm64/kernel/probes/uprobes.cindex d49aef2657cdf7..a2f137a595fc1c 100644--- a/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=63f9dae763a856fff69d676ee705a47cd7b297d8)+++ b/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=14841bb7a531b96e2dde37423a3b33e75147c60d)@@ -42,7 +42,7 @@ int arch\_uprobe\_analyze\_insn(struct arch\_uprobe \*auprobe, struct mm\_struct \*mm, else if (!IS\_ALIGNED(addr, AARCH64\_INSN\_SIZE)) return -EINVAL; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn);  switch (arm\_probe\_decode\_insn(insn, &auprobe->api)) { case INSN\_REJECTED:@@ -108,7 +108,7 @@ bool arch\_uprobe\_skip\_sstep(struct arch\_uprobe \*auprobe, struct pt\_regs \*regs) if (!auprobe->simulate) return false; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn); addr = instruction\_pointer(regs);  if (auprobe->api.handler) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:59:47 +0000



=== Content from git.kernel.org_d9d6eaa9_20250114_190109.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Rutland <mark.rutland@arm.com> | 2024-10-08 16:58:48 +0100 |
| --- | --- | --- |
| committer | Will Deacon <will@kernel.org> | 2024-10-09 16:56:53 +0100 |
| commit | [13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7)) | |
| tree | [630daf85e057fb6fc28d4357bd9cc19473c62469](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7) | |
| parent | [50f813e57601c22b6f26ced3193b9b94d70a2640](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50f813e57601c22b6f26ced3193b9b94d70a2640) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7&id2=50f813e57601c22b6f26ced3193b9b94d70a2640)) | |
| download | [linux-13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7.tar.gz) | |

arm64: probes: Fix uprobes for big-endian kernelsThe arm64 uprobes code is broken for big-endian kernels as it doesn't
convert the in-memory instruction encoding (which is always
little-endian) into the kernel's native endianness before analyzing and
simulating instructions. This may result in a few distinct problems:
\* The kernel may may erroneously reject probing an instruction which can
safely be probed.
\* The kernel may erroneously erroneously permit stepping an
instruction out-of-line when that instruction cannot be stepped
out-of-line safely.
\* The kernel may erroneously simulate instruction incorrectly dur to
interpretting the byte-swapped encoding.
The endianness mismatch isn't caught by the compiler or sparse because:
\* The arch\_uprobe::{insn,ixol} fields are encoded as arrays of u8, so
the compiler and sparse have no idea these contain a little-endian
32-bit value. The core uprobes code populates these with a memcpy()
which similarly does not handle endianness.
\* While the uprobe\_opcode\_t type is an alias for \_\_le32, both
arch\_uprobe\_analyze\_insn() and arch\_uprobe\_skip\_sstep() cast from u8[]
to the similarly-named probe\_opcode\_t, which is an alias for u32.
Hence there is no endianness conversion warning.
Fix this by changing the arch\_uprobe::{insn,ixol} fields to \_\_le32 and
adding the appropriate \_\_le32\_to\_cpu() conversions prior to consuming
the instruction encoding. The core uprobes copies these fields as opaque
ranges of bytes, and so is unaffected by this change.
At the same time, remove MAX\_UINSN\_BYTES and consistently use
AARCH64\_INSN\_SIZE for clarity.
Tested with the following:
| #include <stdio.h>
| #include <stdbool.h>
|
| #define noinline \_\_attribute\_\_((noinline))
|
| static noinline void \*adrp\_self(void)
| {
| void \*addr;
|
| asm volatile(
| " adrp %x0, adrp\_self\n"
| " add %x0, %x0, :lo12:adrp\_self\n"
| : "=r" (addr));
| }
|
|
| int main(int argc, char \*argv)
| {
| void \*ptr = adrp\_self();
| bool equal = (ptr == adrp\_self);
|
| printf("adrp\_self => %p\n"
| "adrp\_self() => %p\n"
| "%s\n",
| adrp\_self, ptr, equal ? "EQUAL" : "NOT EQUAL");
|
| return 0;
| }
.... where the adrp\_self() function was compiled to:
| 00000000004007e0 <adrp\_self>:
| 4007e0: 90000000 adrp x0, 400000 <\_\_ehdr\_start>
| 4007e4: 911f8000 add x0, x0, #0x7e0
| 4007e8: d65f03c0 ret
Before this patch, the ADRP is not recognized, and is assumed to be
steppable, resulting in corruption of the result:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0xffffffffff7e0
| NOT EQUAL
After this patch, the ADRP is correctly recognized and simulated:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| #
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
Fixes: 9842ceae9fa8 ("arm64: Add uprobe support")
Cc: stable@vger.kernel.org
Signed-off-by: Mark Rutland <mark.rutland@arm.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: Will Deacon <will@kernel.org>
Link: [https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland@arm.com](https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland%40arm.com)
Signed-off-by: Will Deacon <will@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7)

| -rw-r--r-- | [arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/uprobes.h?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/probes/uprobes.c?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 7 deletions

| diff --git a/arch/arm64/include/asm/uprobes.h b/arch/arm64/include/asm/uprobes.hindex 2b09495499c618..014b02897f8e22 100644--- a/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=50f813e57601c22b6f26ced3193b9b94d70a2640)+++ b/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7)@@ -10,11 +10,9 @@ #include <asm/insn.h> #include <asm/probes.h> -#define MAX\_UINSN\_BYTES AARCH64\_INSN\_SIZE- #define UPROBE\_SWBP\_INSN cpu\_to\_le32(BRK64\_OPCODE\_UPROBES) #define UPROBE\_SWBP\_INSN\_SIZE AARCH64\_INSN\_SIZE-#define UPROBE\_XOL\_SLOT\_BYTES MAX\_UINSN\_BYTES+#define UPROBE\_XOL\_SLOT\_BYTES AARCH64\_INSN\_SIZE  typedef \_\_le32 uprobe\_opcode\_t; @@ -23,8 +21,8 @@ struct arch\_uprobe\_task {  struct arch\_uprobe { union {- u8 insn[MAX\_UINSN\_BYTES];- u8 ixol[MAX\_UINSN\_BYTES];+ \_\_le32 insn;+ \_\_le32 ixol; }; struct arch\_probe\_insn api; bool simulate;diff --git a/arch/arm64/kernel/probes/uprobes.c b/arch/arm64/kernel/probes/uprobes.cindex d49aef2657cdf7..a2f137a595fc1c 100644--- a/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=50f813e57601c22b6f26ced3193b9b94d70a2640)+++ b/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7)@@ -42,7 +42,7 @@ int arch\_uprobe\_analyze\_insn(struct arch\_uprobe \*auprobe, struct mm\_struct \*mm, else if (!IS\_ALIGNED(addr, AARCH64\_INSN\_SIZE)) return -EINVAL; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn);  switch (arm\_probe\_decode\_insn(insn, &auprobe->api)) { case INSN\_REJECTED:@@ -108,7 +108,7 @@ bool arch\_uprobe\_skip\_sstep(struct arch\_uprobe \*auprobe, struct pt\_regs \*regs) if (!auprobe->simulate) return false; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn); addr = instruction\_pointer(regs);  if (auprobe->api.handler) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:59:46 +0000



=== Content from git.kernel.org_3508e3be_20250114_190111.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Rutland <mark.rutland@arm.com> | 2024-10-08 16:58:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:21 +0100 |
| commit | [b6a638cb600e13f94b5464724eaa6ab7f3349ca2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2)) | |
| tree | [92c920030acecdba38d0619b0a1430b3707c37d7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2) | |
| parent | [8fd414d25465bb666c71b5490fa939411e49228b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8fd414d25465bb666c71b5490fa939411e49228b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2&id2=8fd414d25465bb666c71b5490fa939411e49228b)) | |
| download | [linux-b6a638cb600e13f94b5464724eaa6ab7f3349ca2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b6a638cb600e13f94b5464724eaa6ab7f3349ca2.tar.gz) | |

arm64: probes: Fix uprobes for big-endian kernels[ Upstream commit 13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7 ]
The arm64 uprobes code is broken for big-endian kernels as it doesn't
convert the in-memory instruction encoding (which is always
little-endian) into the kernel's native endianness before analyzing and
simulating instructions. This may result in a few distinct problems:
\* The kernel may may erroneously reject probing an instruction which can
safely be probed.
\* The kernel may erroneously erroneously permit stepping an
instruction out-of-line when that instruction cannot be stepped
out-of-line safely.
\* The kernel may erroneously simulate instruction incorrectly dur to
interpretting the byte-swapped encoding.
The endianness mismatch isn't caught by the compiler or sparse because:
\* The arch\_uprobe::{insn,ixol} fields are encoded as arrays of u8, so
the compiler and sparse have no idea these contain a little-endian
32-bit value. The core uprobes code populates these with a memcpy()
which similarly does not handle endianness.
\* While the uprobe\_opcode\_t type is an alias for \_\_le32, both
arch\_uprobe\_analyze\_insn() and arch\_uprobe\_skip\_sstep() cast from u8[]
to the similarly-named probe\_opcode\_t, which is an alias for u32.
Hence there is no endianness conversion warning.
Fix this by changing the arch\_uprobe::{insn,ixol} fields to \_\_le32 and
adding the appropriate \_\_le32\_to\_cpu() conversions prior to consuming
the instruction encoding. The core uprobes copies these fields as opaque
ranges of bytes, and so is unaffected by this change.
At the same time, remove MAX\_UINSN\_BYTES and consistently use
AARCH64\_INSN\_SIZE for clarity.
Tested with the following:
| #include <stdio.h>
| #include <stdbool.h>
|
| #define noinline \_\_attribute\_\_((noinline))
|
| static noinline void \*adrp\_self(void)
| {
| void \*addr;
|
| asm volatile(
| " adrp %x0, adrp\_self\n"
| " add %x0, %x0, :lo12:adrp\_self\n"
| : "=r" (addr));
| }
|
|
| int main(int argc, char \*argv)
| {
| void \*ptr = adrp\_self();
| bool equal = (ptr == adrp\_self);
|
| printf("adrp\_self => %p\n"
| "adrp\_self() => %p\n"
| "%s\n",
| adrp\_self, ptr, equal ? "EQUAL" : "NOT EQUAL");
|
| return 0;
| }
.... where the adrp\_self() function was compiled to:
| 00000000004007e0 <adrp\_self>:
| 4007e0: 90000000 adrp x0, 400000 <\_\_ehdr\_start>
| 4007e4: 911f8000 add x0, x0, #0x7e0
| 4007e8: d65f03c0 ret
Before this patch, the ADRP is not recognized, and is assumed to be
steppable, resulting in corruption of the result:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0xffffffffff7e0
| NOT EQUAL
After this patch, the ADRP is correctly recognized and simulated:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| #
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
Fixes: 9842ceae9fa8 ("arm64: Add uprobe support")
Cc: stable@vger.kernel.org
Signed-off-by: Mark Rutland <mark.rutland@arm.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: Will Deacon <will@kernel.org>
Link: [https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland@arm.com](https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland%40arm.com)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2)

| -rw-r--r-- | [arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/uprobes.h?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/probes/uprobes.c?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 7 deletions

| diff --git a/arch/arm64/include/asm/uprobes.h b/arch/arm64/include/asm/uprobes.hindex 189755d3326010..bf3ba528fb6cb0 100644--- a/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=8fd414d25465bb666c71b5490fa939411e49228b)+++ b/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2)@@ -13,11 +13,9 @@ #include <asm/insn.h> #include <asm/probes.h> -#define MAX\_UINSN\_BYTES AARCH64\_INSN\_SIZE- #define UPROBE\_SWBP\_INSN cpu\_to\_le32(BRK64\_OPCODE\_UPROBES) #define UPROBE\_SWBP\_INSN\_SIZE AARCH64\_INSN\_SIZE-#define UPROBE\_XOL\_SLOT\_BYTES MAX\_UINSN\_BYTES+#define UPROBE\_XOL\_SLOT\_BYTES AARCH64\_INSN\_SIZE  typedef u32 uprobe\_opcode\_t; @@ -26,8 +24,8 @@ struct arch\_uprobe\_task {  struct arch\_uprobe { union {- u8 insn[MAX\_UINSN\_BYTES];- u8 ixol[MAX\_UINSN\_BYTES];+ \_\_le32 insn;+ \_\_le32 ixol; }; struct arch\_probe\_insn api; bool simulate;diff --git a/arch/arm64/kernel/probes/uprobes.c b/arch/arm64/kernel/probes/uprobes.cindex 6aeb11aa7e2835..851689216007c1 100644--- a/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=8fd414d25465bb666c71b5490fa939411e49228b)+++ b/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=b6a638cb600e13f94b5464724eaa6ab7f3349ca2)@@ -45,7 +45,7 @@ int arch\_uprobe\_analyze\_insn(struct arch\_uprobe \*auprobe, struct mm\_struct \*mm, else if (!IS\_ALIGNED(addr, AARCH64\_INSN\_SIZE)) return -EINVAL; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn);  switch (arm\_probe\_decode\_insn(insn, &auprobe->api)) { case INSN\_REJECTED:@@ -111,7 +111,7 @@ bool arch\_uprobe\_skip\_sstep(struct arch\_uprobe \*auprobe, struct pt\_regs \*regs) if (!auprobe->simulate) return false; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn); addr = instruction\_pointer(regs);  if (auprobe->api.handler) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:59:48 +0000



=== Content from git.kernel.org_29408109_20250114_190112.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Rutland <mark.rutland@arm.com> | 2024-10-08 16:58:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:21:58 +0100 |
| commit | [cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80)) | |
| tree | [75ed3b39340816d7df17127aa5d76bf867866cae](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80) | |
| parent | [7f1ef59185d23450d77e94671c0abb03f8978c01](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f1ef59185d23450d77e94671c0abb03f8978c01) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80&id2=7f1ef59185d23450d77e94671c0abb03f8978c01)) | |
| download | [linux-cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80.tar.gz) | |

arm64: probes: Fix uprobes for big-endian kernels[ Upstream commit 13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7 ]
The arm64 uprobes code is broken for big-endian kernels as it doesn't
convert the in-memory instruction encoding (which is always
little-endian) into the kernel's native endianness before analyzing and
simulating instructions. This may result in a few distinct problems:
\* The kernel may may erroneously reject probing an instruction which can
safely be probed.
\* The kernel may erroneously erroneously permit stepping an
instruction out-of-line when that instruction cannot be stepped
out-of-line safely.
\* The kernel may erroneously simulate instruction incorrectly dur to
interpretting the byte-swapped encoding.
The endianness mismatch isn't caught by the compiler or sparse because:
\* The arch\_uprobe::{insn,ixol} fields are encoded as arrays of u8, so
the compiler and sparse have no idea these contain a little-endian
32-bit value. The core uprobes code populates these with a memcpy()
which similarly does not handle endianness.
\* While the uprobe\_opcode\_t type is an alias for \_\_le32, both
arch\_uprobe\_analyze\_insn() and arch\_uprobe\_skip\_sstep() cast from u8[]
to the similarly-named probe\_opcode\_t, which is an alias for u32.
Hence there is no endianness conversion warning.
Fix this by changing the arch\_uprobe::{insn,ixol} fields to \_\_le32 and
adding the appropriate \_\_le32\_to\_cpu() conversions prior to consuming
the instruction encoding. The core uprobes copies these fields as opaque
ranges of bytes, and so is unaffected by this change.
At the same time, remove MAX\_UINSN\_BYTES and consistently use
AARCH64\_INSN\_SIZE for clarity.
Tested with the following:
| #include <stdio.h>
| #include <stdbool.h>
|
| #define noinline \_\_attribute\_\_((noinline))
|
| static noinline void \*adrp\_self(void)
| {
| void \*addr;
|
| asm volatile(
| " adrp %x0, adrp\_self\n"
| " add %x0, %x0, :lo12:adrp\_self\n"
| : "=r" (addr));
| }
|
|
| int main(int argc, char \*argv)
| {
| void \*ptr = adrp\_self();
| bool equal = (ptr == adrp\_self);
|
| printf("adrp\_self => %p\n"
| "adrp\_self() => %p\n"
| "%s\n",
| adrp\_self, ptr, equal ? "EQUAL" : "NOT EQUAL");
|
| return 0;
| }
.... where the adrp\_self() function was compiled to:
| 00000000004007e0 <adrp\_self>:
| 4007e0: 90000000 adrp x0, 400000 <\_\_ehdr\_start>
| 4007e4: 911f8000 add x0, x0, #0x7e0
| 4007e8: d65f03c0 ret
Before this patch, the ADRP is not recognized, and is assumed to be
steppable, resulting in corruption of the result:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0xffffffffff7e0
| NOT EQUAL
After this patch, the ADRP is correctly recognized and simulated:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| #
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
Fixes: 9842ceae9fa8 ("arm64: Add uprobe support")
Cc: stable@vger.kernel.org
Signed-off-by: Mark Rutland <mark.rutland@arm.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: Will Deacon <will@kernel.org>
Link: [https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland@arm.com](https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland%40arm.com)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80)

| -rw-r--r-- | [arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/uprobes.h?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/probes/uprobes.c?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 7 deletions

| diff --git a/arch/arm64/include/asm/uprobes.h b/arch/arm64/include/asm/uprobes.hindex ba4bff5ca67494..98f29a43bfe898 100644--- a/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=7f1ef59185d23450d77e94671c0abb03f8978c01)+++ b/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80)@@ -10,11 +10,9 @@ #include <asm/insn.h> #include <asm/probes.h> -#define MAX\_UINSN\_BYTES AARCH64\_INSN\_SIZE- #define UPROBE\_SWBP\_INSN cpu\_to\_le32(BRK64\_OPCODE\_UPROBES) #define UPROBE\_SWBP\_INSN\_SIZE AARCH64\_INSN\_SIZE-#define UPROBE\_XOL\_SLOT\_BYTES MAX\_UINSN\_BYTES+#define UPROBE\_XOL\_SLOT\_BYTES AARCH64\_INSN\_SIZE  typedef u32 uprobe\_opcode\_t; @@ -23,8 +21,8 @@ struct arch\_uprobe\_task {  struct arch\_uprobe { union {- u8 insn[MAX\_UINSN\_BYTES];- u8 ixol[MAX\_UINSN\_BYTES];+ \_\_le32 insn;+ \_\_le32 ixol; }; struct arch\_probe\_insn api; bool simulate;diff --git a/arch/arm64/kernel/probes/uprobes.c b/arch/arm64/kernel/probes/uprobes.cindex 2c247634552b19..8a02c549e57fd3 100644--- a/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=7f1ef59185d23450d77e94671c0abb03f8978c01)+++ b/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=cf9ddf9ed94c15564a05bbf6e9f18dffa0c7df80)@@ -42,7 +42,7 @@ int arch\_uprobe\_analyze\_insn(struct arch\_uprobe \*auprobe, struct mm\_struct \*mm, else if (!IS\_ALIGNED(addr, AARCH64\_INSN\_SIZE)) return -EINVAL; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn);  switch (arm\_probe\_decode\_insn(insn, &auprobe->api)) { case INSN\_REJECTED:@@ -108,7 +108,7 @@ bool arch\_uprobe\_skip\_sstep(struct arch\_uprobe \*auprobe, struct pt\_regs \*regs) if (!auprobe->simulate) return false; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn); addr = instruction\_pointer(regs);  if (auprobe->api.handler) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:59:49 +0000



=== Content from git.kernel.org_42fa9853_20250114_190113.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e6ab336213918575124d6db43dc5d3554526242e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e6ab336213918575124d6db43dc5d3554526242e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6ab336213918575124d6db43dc5d3554526242e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6ab336213918575124d6db43dc5d3554526242e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Rutland <mark.rutland@arm.com> | 2024-10-08 16:58:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:50 +0100 |
| commit | [e6ab336213918575124d6db43dc5d3554526242e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6ab336213918575124d6db43dc5d3554526242e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e6ab336213918575124d6db43dc5d3554526242e)) | |
| tree | [6a97d7910bc5a77c948e433475c4000fb541790a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e6ab336213918575124d6db43dc5d3554526242e) | |
| parent | [5aa6cd3130c80f17630a214c2e25091f0c4b5e9a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5aa6cd3130c80f17630a214c2e25091f0c4b5e9a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6ab336213918575124d6db43dc5d3554526242e&id2=5aa6cd3130c80f17630a214c2e25091f0c4b5e9a)) | |
| download | [linux-e6ab336213918575124d6db43dc5d3554526242e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e6ab336213918575124d6db43dc5d3554526242e.tar.gz) | |

arm64: probes: Fix uprobes for big-endian kernels[ Upstream commit 13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7 ]
The arm64 uprobes code is broken for big-endian kernels as it doesn't
convert the in-memory instruction encoding (which is always
little-endian) into the kernel's native endianness before analyzing and
simulating instructions. This may result in a few distinct problems:
\* The kernel may may erroneously reject probing an instruction which can
safely be probed.
\* The kernel may erroneously erroneously permit stepping an
instruction out-of-line when that instruction cannot be stepped
out-of-line safely.
\* The kernel may erroneously simulate instruction incorrectly dur to
interpretting the byte-swapped encoding.
The endianness mismatch isn't caught by the compiler or sparse because:
\* The arch\_uprobe::{insn,ixol} fields are encoded as arrays of u8, so
the compiler and sparse have no idea these contain a little-endian
32-bit value. The core uprobes code populates these with a memcpy()
which similarly does not handle endianness.
\* While the uprobe\_opcode\_t type is an alias for \_\_le32, both
arch\_uprobe\_analyze\_insn() and arch\_uprobe\_skip\_sstep() cast from u8[]
to the similarly-named probe\_opcode\_t, which is an alias for u32.
Hence there is no endianness conversion warning.
Fix this by changing the arch\_uprobe::{insn,ixol} fields to \_\_le32 and
adding the appropriate \_\_le32\_to\_cpu() conversions prior to consuming
the instruction encoding. The core uprobes copies these fields as opaque
ranges of bytes, and so is unaffected by this change.
At the same time, remove MAX\_UINSN\_BYTES and consistently use
AARCH64\_INSN\_SIZE for clarity.
Tested with the following:
| #include <stdio.h>
| #include <stdbool.h>
|
| #define noinline \_\_attribute\_\_((noinline))
|
| static noinline void \*adrp\_self(void)
| {
| void \*addr;
|
| asm volatile(
| " adrp %x0, adrp\_self\n"
| " add %x0, %x0, :lo12:adrp\_self\n"
| : "=r" (addr));
| }
|
|
| int main(int argc, char \*argv)
| {
| void \*ptr = adrp\_self();
| bool equal = (ptr == adrp\_self);
|
| printf("adrp\_self => %p\n"
| "adrp\_self() => %p\n"
| "%s\n",
| adrp\_self, ptr, equal ? "EQUAL" : "NOT EQUAL");
|
| return 0;
| }
.... where the adrp\_self() function was compiled to:
| 00000000004007e0 <adrp\_self>:
| 4007e0: 90000000 adrp x0, 400000 <\_\_ehdr\_start>
| 4007e4: 911f8000 add x0, x0, #0x7e0
| 4007e8: d65f03c0 ret
Before this patch, the ADRP is not recognized, and is assumed to be
steppable, resulting in corruption of the result:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0xffffffffff7e0
| NOT EQUAL
After this patch, the ADRP is correctly recognized and simulated:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| #
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
Fixes: 9842ceae9fa8 ("arm64: Add uprobe support")
Cc: stable@vger.kernel.org
Signed-off-by: Mark Rutland <mark.rutland@arm.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: Will Deacon <will@kernel.org>
Link: [https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland@arm.com](https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland%40arm.com)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6ab336213918575124d6db43dc5d3554526242e)

| -rw-r--r-- | [arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/uprobes.h?id=e6ab336213918575124d6db43dc5d3554526242e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/probes/uprobes.c?id=e6ab336213918575124d6db43dc5d3554526242e) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 7 deletions

| diff --git a/arch/arm64/include/asm/uprobes.h b/arch/arm64/include/asm/uprobes.hindex ba4bff5ca67494..98f29a43bfe898 100644--- a/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=5aa6cd3130c80f17630a214c2e25091f0c4b5e9a)+++ b/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=e6ab336213918575124d6db43dc5d3554526242e)@@ -10,11 +10,9 @@ #include <asm/insn.h> #include <asm/probes.h> -#define MAX\_UINSN\_BYTES AARCH64\_INSN\_SIZE- #define UPROBE\_SWBP\_INSN cpu\_to\_le32(BRK64\_OPCODE\_UPROBES) #define UPROBE\_SWBP\_INSN\_SIZE AARCH64\_INSN\_SIZE-#define UPROBE\_XOL\_SLOT\_BYTES MAX\_UINSN\_BYTES+#define UPROBE\_XOL\_SLOT\_BYTES AARCH64\_INSN\_SIZE  typedef u32 uprobe\_opcode\_t; @@ -23,8 +21,8 @@ struct arch\_uprobe\_task {  struct arch\_uprobe { union {- u8 insn[MAX\_UINSN\_BYTES];- u8 ixol[MAX\_UINSN\_BYTES];+ \_\_le32 insn;+ \_\_le32 ixol; }; struct arch\_probe\_insn api; bool simulate;diff --git a/arch/arm64/kernel/probes/uprobes.c b/arch/arm64/kernel/probes/uprobes.cindex 2c247634552b19..8a02c549e57fd3 100644--- a/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=5aa6cd3130c80f17630a214c2e25091f0c4b5e9a)+++ b/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=e6ab336213918575124d6db43dc5d3554526242e)@@ -42,7 +42,7 @@ int arch\_uprobe\_analyze\_insn(struct arch\_uprobe \*auprobe, struct mm\_struct \*mm, else if (!IS\_ALIGNED(addr, AARCH64\_INSN\_SIZE)) return -EINVAL; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn);  switch (arm\_probe\_decode\_insn(insn, &auprobe->api)) { case INSN\_REJECTED:@@ -108,7 +108,7 @@ bool arch\_uprobe\_skip\_sstep(struct arch\_uprobe \*auprobe, struct pt\_regs \*regs) if (!auprobe->simulate) return false; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn); addr = instruction\_pointer(regs);  if (auprobe->api.handler) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:59:50 +0000



=== Content from git.kernel.org_51bff677_20250114_190111.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cf60d19d40184e43d9a624e55a0da73be09e938d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf60d19d40184e43d9a624e55a0da73be09e938d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf60d19d40184e43d9a624e55a0da73be09e938d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf60d19d40184e43d9a624e55a0da73be09e938d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Rutland <mark.rutland@arm.com> | 2024-10-08 16:58:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:52:34 +0100 |
| commit | [cf60d19d40184e43d9a624e55a0da73be09e938d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf60d19d40184e43d9a624e55a0da73be09e938d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cf60d19d40184e43d9a624e55a0da73be09e938d)) | |
| tree | [8351544572b2277be4ea26f255f4059ce2d89395](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf60d19d40184e43d9a624e55a0da73be09e938d) | |
| parent | [acfb32d42a31d378bcb68a2ceb04c033e16f96a8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acfb32d42a31d378bcb68a2ceb04c033e16f96a8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf60d19d40184e43d9a624e55a0da73be09e938d&id2=acfb32d42a31d378bcb68a2ceb04c033e16f96a8)) | |
| download | [linux-cf60d19d40184e43d9a624e55a0da73be09e938d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cf60d19d40184e43d9a624e55a0da73be09e938d.tar.gz) | |

arm64: probes: Fix uprobes for big-endian kernels[ Upstream commit 13f8f1e05f1dc36dbba6cba0ae03354c0dafcde7 ]
The arm64 uprobes code is broken for big-endian kernels as it doesn't
convert the in-memory instruction encoding (which is always
little-endian) into the kernel's native endianness before analyzing and
simulating instructions. This may result in a few distinct problems:
\* The kernel may may erroneously reject probing an instruction which can
safely be probed.
\* The kernel may erroneously erroneously permit stepping an
instruction out-of-line when that instruction cannot be stepped
out-of-line safely.
\* The kernel may erroneously simulate instruction incorrectly dur to
interpretting the byte-swapped encoding.
The endianness mismatch isn't caught by the compiler or sparse because:
\* The arch\_uprobe::{insn,ixol} fields are encoded as arrays of u8, so
the compiler and sparse have no idea these contain a little-endian
32-bit value. The core uprobes code populates these with a memcpy()
which similarly does not handle endianness.
\* While the uprobe\_opcode\_t type is an alias for \_\_le32, both
arch\_uprobe\_analyze\_insn() and arch\_uprobe\_skip\_sstep() cast from u8[]
to the similarly-named probe\_opcode\_t, which is an alias for u32.
Hence there is no endianness conversion warning.
Fix this by changing the arch\_uprobe::{insn,ixol} fields to \_\_le32 and
adding the appropriate \_\_le32\_to\_cpu() conversions prior to consuming
the instruction encoding. The core uprobes copies these fields as opaque
ranges of bytes, and so is unaffected by this change.
At the same time, remove MAX\_UINSN\_BYTES and consistently use
AARCH64\_INSN\_SIZE for clarity.
Tested with the following:
| #include <stdio.h>
| #include <stdbool.h>
|
| #define noinline \_\_attribute\_\_((noinline))
|
| static noinline void \*adrp\_self(void)
| {
| void \*addr;
|
| asm volatile(
| " adrp %x0, adrp\_self\n"
| " add %x0, %x0, :lo12:adrp\_self\n"
| : "=r" (addr));
| }
|
|
| int main(int argc, char \*argv)
| {
| void \*ptr = adrp\_self();
| bool equal = (ptr == adrp\_self);
|
| printf("adrp\_self => %p\n"
| "adrp\_self() => %p\n"
| "%s\n",
| adrp\_self, ptr, equal ? "EQUAL" : "NOT EQUAL");
|
| return 0;
| }
.... where the adrp\_self() function was compiled to:
| 00000000004007e0 <adrp\_self>:
| 4007e0: 90000000 adrp x0, 400000 <\_\_ehdr\_start>
| 4007e4: 911f8000 add x0, x0, #0x7e0
| 4007e8: d65f03c0 ret
Before this patch, the ADRP is not recognized, and is assumed to be
steppable, resulting in corruption of the result:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0xffffffffff7e0
| NOT EQUAL
After this patch, the ADRP is correctly recognized and simulated:
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
| #
| # echo 'p /root/adrp-self:0x007e0' > /sys/kernel/tracing/uprobe\_events
| # echo 1 > /sys/kernel/tracing/events/uprobes/enable
| # ./adrp-self
| adrp\_self => 0x4007e0
| adrp\_self() => 0x4007e0
| EQUAL
Fixes: 9842ceae9fa8 ("arm64: Add uprobe support")
Cc: stable@vger.kernel.org
Signed-off-by: Mark Rutland <mark.rutland@arm.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>
Cc: Will Deacon <will@kernel.org>
Link: [https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland@arm.com](https://lore.kernel.org/r/20241008155851.801546-4-mark.rutland%40arm.com)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf60d19d40184e43d9a624e55a0da73be09e938d)

| -rw-r--r-- | [arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/uprobes.h?id=cf60d19d40184e43d9a624e55a0da73be09e938d) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/probes/uprobes.c?id=cf60d19d40184e43d9a624e55a0da73be09e938d) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 7 deletions

| diff --git a/arch/arm64/include/asm/uprobes.h b/arch/arm64/include/asm/uprobes.hindex ba4bff5ca67494..98f29a43bfe898 100644--- a/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=acfb32d42a31d378bcb68a2ceb04c033e16f96a8)+++ b/[arch/arm64/include/asm/uprobes.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/uprobes.h?id=cf60d19d40184e43d9a624e55a0da73be09e938d)@@ -10,11 +10,9 @@ #include <asm/insn.h> #include <asm/probes.h> -#define MAX\_UINSN\_BYTES AARCH64\_INSN\_SIZE- #define UPROBE\_SWBP\_INSN cpu\_to\_le32(BRK64\_OPCODE\_UPROBES) #define UPROBE\_SWBP\_INSN\_SIZE AARCH64\_INSN\_SIZE-#define UPROBE\_XOL\_SLOT\_BYTES MAX\_UINSN\_BYTES+#define UPROBE\_XOL\_SLOT\_BYTES AARCH64\_INSN\_SIZE  typedef u32 uprobe\_opcode\_t; @@ -23,8 +21,8 @@ struct arch\_uprobe\_task {  struct arch\_uprobe { union {- u8 insn[MAX\_UINSN\_BYTES];- u8 ixol[MAX\_UINSN\_BYTES];+ \_\_le32 insn;+ \_\_le32 ixol; }; struct arch\_probe\_insn api; bool simulate;diff --git a/arch/arm64/kernel/probes/uprobes.c b/arch/arm64/kernel/probes/uprobes.cindex d49aef2657cdf7..a2f137a595fc1c 100644--- a/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=acfb32d42a31d378bcb68a2ceb04c033e16f96a8)+++ b/[arch/arm64/kernel/probes/uprobes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/probes/uprobes.c?id=cf60d19d40184e43d9a624e55a0da73be09e938d)@@ -42,7 +42,7 @@ int arch\_uprobe\_analyze\_insn(struct arch\_uprobe \*auprobe, struct mm\_struct \*mm, else if (!IS\_ALIGNED(addr, AARCH64\_INSN\_SIZE)) return -EINVAL; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn);  switch (arm\_probe\_decode\_insn(insn, &auprobe->api)) { case INSN\_REJECTED:@@ -108,7 +108,7 @@ bool arch\_uprobe\_skip\_sstep(struct arch\_uprobe \*auprobe, struct pt\_regs \*regs) if (!auprobe->simulate) return false; - insn = \*(probe\_opcode\_t \*)(&auprobe->insn[0]);+ insn = le32\_to\_cpu(auprobe->insn); addr = instruction\_pointer(regs);  if (auprobe->api.handler) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:59:49 +0000


