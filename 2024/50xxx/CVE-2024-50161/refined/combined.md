=== Content from git.kernel.org_c6651d38_20250114_235013.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6f957d972feee9b385ea3ae6530310a84e55ba71)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6f957d972feee9b385ea3ae6530310a84e55ba71)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f957d972feee9b385ea3ae6530310a84e55ba71)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f957d972feee9b385ea3ae6530310a84e55ba71)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hou Tao <houtao1@huawei.com> | 2024-10-08 15:11:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:24 +0100 |
| commit | [6f957d972feee9b385ea3ae6530310a84e55ba71](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f957d972feee9b385ea3ae6530310a84e55ba71) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6f957d972feee9b385ea3ae6530310a84e55ba71)) | |
| tree | [507bcc91a1c978bfcaf440606b076e78b6ed047d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6f957d972feee9b385ea3ae6530310a84e55ba71) | |
| parent | [900396e8fffbf57304a4b8757ecd704553eee1ce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=900396e8fffbf57304a4b8757ecd704553eee1ce) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f957d972feee9b385ea3ae6530310a84e55ba71&id2=900396e8fffbf57304a4b8757ecd704553eee1ce)) | |
| download | [linux-6f957d972feee9b385ea3ae6530310a84e55ba71.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6f957d972feee9b385ea3ae6530310a84e55ba71.tar.gz) | |

bpf: Check the remaining info\_cnt before repeating btf fields[ Upstream commit 797d73ee232dd1833dec4824bc53a22032e97c1c ]
When trying to repeat the btf fields for array of nested struct, it
doesn't check the remaining info\_cnt. The following splat will be
reported when the value of ret \* nelems is greater than BTF\_FIELDS\_MAX:
------------[ cut here ]------------
UBSAN: array-index-out-of-bounds in ../kernel/bpf/btf.c:3951:49
index 11 is out of range for type 'btf\_field\_info [11]'
CPU: 6 UID: 0 PID: 411 Comm: test\_progs ...... 6.11.0-rc4+ #1
Tainted: [O]=OOT\_MODULE
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS ...
Call Trace:
<TASK>
dump\_stack\_lvl+0x57/0x70
dump\_stack+0x10/0x20
ubsan\_epilogue+0x9/0x40
\_\_ubsan\_handle\_out\_of\_bounds+0x6f/0x80
? kallsyms\_lookup\_name+0x48/0xb0
btf\_parse\_fields+0x992/0xce0
map\_create+0x591/0x770
\_\_sys\_bpf+0x229/0x2410
\_\_x64\_sys\_bpf+0x1f/0x30
x64\_sys\_call+0x199/0x9f0
do\_syscall\_64+0x3b/0xc0
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7fea56f2cc5d
......
</TASK>
---[ end trace ]---
Fix it by checking the remaining info\_cnt in btf\_repeat\_fields() before
repeating the btf fields.
Fixes: 64e8ee814819 ("bpf: look into the types of the fields of a struct type recursively.")
Signed-off-by: Hou Tao <houtao1@huawei.com>
Acked-by: Eduard Zingerman <eddyz87@gmail.com>
Link: [https://lore.kernel.org/r/20241008071114.3718177-2-houtao@huaweicloud.com](https://lore.kernel.org/r/20241008071114.3718177-2-houtao%40huaweicloud.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f957d972feee9b385ea3ae6530310a84e55ba71)

| -rw-r--r-- | [kernel/bpf/btf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/btf.c?id=6f957d972feee9b385ea3ae6530310a84e55ba71) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 4 deletions

| diff --git a/kernel/bpf/btf.c b/kernel/bpf/btf.cindex 9b068afd179533..5f4f1d0bc23a47 100644--- a/[kernel/bpf/btf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/btf.c?id=900396e8fffbf57304a4b8757ecd704553eee1ce)+++ b/[kernel/bpf/btf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/btf.c?id=6f957d972feee9b385ea3ae6530310a84e55ba71)@@ -3528,7 +3528,7 @@ end: \* (i + 1) \* elem\_size \* where i is the repeat index and elem\_size is the size of an element. \*/-static int btf\_repeat\_fields(struct btf\_field\_info \*info,+static int btf\_repeat\_fields(struct btf\_field\_info \*info, int info\_cnt, u32 field\_cnt, u32 repeat\_cnt, u32 elem\_size) { u32 i, j;@@ -3548,6 +3548,12 @@ static int btf\_repeat\_fields(struct btf\_field\_info \*info, } } + /\* The type of struct size or variable size is u32,+ \* so the multiplication will not overflow.+ \*/+ if (field\_cnt \* (repeat\_cnt + 1) > info\_cnt)+ return -E2BIG;+ cur = field\_cnt; for (i = 0; i < repeat\_cnt; i++) { memcpy(&info[cur], &info[0], field\_cnt \* sizeof(info[0]));@@ -3592,7 +3598,7 @@ static int btf\_find\_nested\_struct(const struct btf \*btf, const struct btf\_type \* info[i].off += off;  if (nelems > 1) {- err = btf\_repeat\_fields(info, ret, nelems - 1, t->size);+ err = btf\_repeat\_fields(info, info\_cnt, ret, nelems - 1, t->size); if (err == 0) ret \*= nelems; else@@ -3686,10 +3692,10 @@ static int btf\_find\_field\_one(const struct btf \*btf,  if (ret == BTF\_FIELD\_IGNORE) return 0;- if (nelems > info\_cnt)+ if (!info\_cnt) return -E2BIG; if (nelems > 1) {- ret = btf\_repeat\_fields(info, 1, nelems - 1, sz);+ ret = btf\_repeat\_fields(info, info\_cnt, 1, nelems - 1, sz); if (ret < 0) return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:48:50 +0000



=== Content from git.kernel.org_955df670_20250114_235014.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=797d73ee232dd1833dec4824bc53a22032e97c1c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=797d73ee232dd1833dec4824bc53a22032e97c1c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=797d73ee232dd1833dec4824bc53a22032e97c1c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=797d73ee232dd1833dec4824bc53a22032e97c1c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hou Tao <houtao1@huawei.com> | 2024-10-08 15:11:13 +0800 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2024-10-09 16:32:46 -0700 |
| commit | [797d73ee232dd1833dec4824bc53a22032e97c1c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=797d73ee232dd1833dec4824bc53a22032e97c1c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=797d73ee232dd1833dec4824bc53a22032e97c1c)) | |
| tree | [7b24e67500dce87db9645570bf6a02cbef6b3d94](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=797d73ee232dd1833dec4824bc53a22032e97c1c) | |
| parent | [b24d7f0da6ef5a23456a301eaf51b170f961d4ae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b24d7f0da6ef5a23456a301eaf51b170f961d4ae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=797d73ee232dd1833dec4824bc53a22032e97c1c&id2=b24d7f0da6ef5a23456a301eaf51b170f961d4ae)) | |
| download | [linux-797d73ee232dd1833dec4824bc53a22032e97c1c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-797d73ee232dd1833dec4824bc53a22032e97c1c.tar.gz) | |

bpf: Check the remaining info\_cnt before repeating btf fieldsWhen trying to repeat the btf fields for array of nested struct, it
doesn't check the remaining info\_cnt. The following splat will be
reported when the value of ret \* nelems is greater than BTF\_FIELDS\_MAX:
------------[ cut here ]------------
UBSAN: array-index-out-of-bounds in ../kernel/bpf/btf.c:3951:49
index 11 is out of range for type 'btf\_field\_info [11]'
CPU: 6 UID: 0 PID: 411 Comm: test\_progs ...... 6.11.0-rc4+ #1
Tainted: [O]=OOT\_MODULE
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS ...
Call Trace:
<TASK>
dump\_stack\_lvl+0x57/0x70
dump\_stack+0x10/0x20
ubsan\_epilogue+0x9/0x40
\_\_ubsan\_handle\_out\_of\_bounds+0x6f/0x80
? kallsyms\_lookup\_name+0x48/0xb0
btf\_parse\_fields+0x992/0xce0
map\_create+0x591/0x770
\_\_sys\_bpf+0x229/0x2410
\_\_x64\_sys\_bpf+0x1f/0x30
x64\_sys\_call+0x199/0x9f0
do\_syscall\_64+0x3b/0xc0
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7fea56f2cc5d
......
</TASK>
---[ end trace ]---
Fix it by checking the remaining info\_cnt in btf\_repeat\_fields() before
repeating the btf fields.
Fixes: 64e8ee814819 ("bpf: look into the types of the fields of a struct type recursively.")
Signed-off-by: Hou Tao <houtao1@huawei.com>
Acked-by: Eduard Zingerman <eddyz87@gmail.com>
Link: [https://lore.kernel.org/r/20241008071114.3718177-2-houtao@huaweicloud.com](https://lore.kernel.org/r/20241008071114.3718177-2-houtao%40huaweicloud.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=797d73ee232dd1833dec4824bc53a22032e97c1c)

| -rw-r--r-- | [kernel/bpf/btf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/btf.c?id=797d73ee232dd1833dec4824bc53a22032e97c1c) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 4 deletions

| diff --git a/kernel/bpf/btf.c b/kernel/bpf/btf.cindex a05da5f4354742..5cd1c7a23848cc 100644--- a/[kernel/bpf/btf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/btf.c?id=b24d7f0da6ef5a23456a301eaf51b170f961d4ae)+++ b/[kernel/bpf/btf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/btf.c?id=797d73ee232dd1833dec4824bc53a22032e97c1c)@@ -3523,7 +3523,7 @@ end: \* (i + 1) \* elem\_size \* where i is the repeat index and elem\_size is the size of an element. \*/-static int btf\_repeat\_fields(struct btf\_field\_info \*info,+static int btf\_repeat\_fields(struct btf\_field\_info \*info, int info\_cnt, u32 field\_cnt, u32 repeat\_cnt, u32 elem\_size) { u32 i, j;@@ -3543,6 +3543,12 @@ static int btf\_repeat\_fields(struct btf\_field\_info \*info, } } + /\* The type of struct size or variable size is u32,+ \* so the multiplication will not overflow.+ \*/+ if (field\_cnt \* (repeat\_cnt + 1) > info\_cnt)+ return -E2BIG;+ cur = field\_cnt; for (i = 0; i < repeat\_cnt; i++) { memcpy(&info[cur], &info[0], field\_cnt \* sizeof(info[0]));@@ -3587,7 +3593,7 @@ static int btf\_find\_nested\_struct(const struct btf \*btf, const struct btf\_type \* info[i].off += off;  if (nelems > 1) {- err = btf\_repeat\_fields(info, ret, nelems - 1, t->size);+ err = btf\_repeat\_fields(info, info\_cnt, ret, nelems - 1, t->size); if (err == 0) ret \*= nelems; else@@ -3681,10 +3687,10 @@ static int btf\_find\_field\_one(const struct btf \*btf,  if (ret == BTF\_FIELD\_IGNORE) return 0;- if (nelems > info\_cnt)+ if (!info\_cnt) return -E2BIG; if (nelems > 1) {- ret = btf\_repeat\_fields(info, 1, nelems - 1, sz);+ ret = btf\_repeat\_fields(info, info\_cnt, 1, nelems - 1, sz); if (ret < 0) return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:48:50 +0000


