=== Content from git.kernel.org_bd033aca_20250114_200532.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8501e38dc9e0060814c4085815fc83da3e6d43bf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8501e38dc9e0060814c4085815fc83da3e6d43bf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8501e38dc9e0060814c4085815fc83da3e6d43bf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8501e38dc9e0060814c4085815fc83da3e6d43bf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:51 +0100 |
| commit | [8501e38dc9e0060814c4085815fc83da3e6d43bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8501e38dc9e0060814c4085815fc83da3e6d43bf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8501e38dc9e0060814c4085815fc83da3e6d43bf)) | |
| tree | [b9f73e44c3ed96dbb2450ce29b508a51ccc903b4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8501e38dc9e0060814c4085815fc83da3e6d43bf) | |
| parent | [a45d78569b6581bbc3afd5f5dd5299035cf72cb9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a45d78569b6581bbc3afd5f5dd5299035cf72cb9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8501e38dc9e0060814c4085815fc83da3e6d43bf&id2=a45d78569b6581bbc3afd5f5dd5299035cf72cb9)) | |
| download | [linux-8501e38dc9e0060814c4085815fc83da3e6d43bf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8501e38dc9e0060814c4085815fc83da3e6d43bf.tar.gz) | |

dm cache: fix out-of-bounds access to the dirty bitset when resizingcommit 792227719725497ce10a8039803bec13f89f8910 upstream.
dm-cache checks the dirty bits of the cache blocks to be dropped when
shrinking the fast device, but an index bug in bitset iteration causes
out-of-bounds access.
Reproduce steps:
1. create a cache device of 1024 cache blocks (128 bytes dirty bitset)
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
2. shrink the fast device to 512 cache blocks, triggering out-of-bounds
access to the dirty bitset (offset 0x80)
dmsetup suspend cache
dmsetup reload cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in cache\_preresume+0x269/0x7b0
Read of size 8 at addr ffffc900000f3080 by task dmsetup/131
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc900000f3000, ffffc900000f5000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc900000f2f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
>ffffc900000f3080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc900000f3100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3180: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by making the index post-incremented.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8501e38dc9e0060814c4085815fc83da3e6d43bf)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=8501e38dc9e0060814c4085815fc83da3e6d43bf) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 4851966c30817e..be06e66e317871 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=a45d78569b6581bbc3afd5f5dd5299035cf72cb9)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=8501e38dc9e0060814c4085815fc83da3e6d43bf)@@ -3010,13 +3010,13 @@ static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) \* We can't drop a dirty block when shrinking the cache. \*/ while (from\_cblock(new\_size) < from\_cblock(cache->cache\_size)) {- new\_size = to\_cblock(from\_cblock(new\_size) + 1); if (is\_dirty(cache, new\_size)) { DMERR("%s: unable to shrink cache; cache block %llu is dirty", cache\_device\_name(cache), (unsigned long long) from\_cblock(new\_size)); return false; }+ new\_size = to\_cblock(from\_cblock(new\_size) + 1); }  return true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:04:09 +0000



=== Content from git.kernel.org_84325c73_20250114_200530.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:06 +0100 |
| commit | [4fa4feb873cea0e9d6ff883b37cca6f33169d8b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4)) | |
| tree | [736aa02fa65b483a3e7a99efbd90afc4838c1673](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4) | |
| parent | [5db9a408014015a1c64d919e6ff220721c139503](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5db9a408014015a1c64d919e6ff220721c139503) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4&id2=5db9a408014015a1c64d919e6ff220721c139503)) | |
| download | [linux-4fa4feb873cea0e9d6ff883b37cca6f33169d8b4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4fa4feb873cea0e9d6ff883b37cca6f33169d8b4.tar.gz) | |

dm cache: fix out-of-bounds access to the dirty bitset when resizingcommit 792227719725497ce10a8039803bec13f89f8910 upstream.
dm-cache checks the dirty bits of the cache blocks to be dropped when
shrinking the fast device, but an index bug in bitset iteration causes
out-of-bounds access.
Reproduce steps:
1. create a cache device of 1024 cache blocks (128 bytes dirty bitset)
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
2. shrink the fast device to 512 cache blocks, triggering out-of-bounds
access to the dirty bitset (offset 0x80)
dmsetup suspend cache
dmsetup reload cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in cache\_preresume+0x269/0x7b0
Read of size 8 at addr ffffc900000f3080 by task dmsetup/131
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc900000f3000, ffffc900000f5000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc900000f2f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
>ffffc900000f3080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc900000f3100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3180: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by making the index post-incremented.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex f7251f575ec459..dd4147df2465fe 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=5db9a408014015a1c64d919e6ff220721c139503)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=4fa4feb873cea0e9d6ff883b37cca6f33169d8b4)@@ -3002,13 +3002,13 @@ static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) \* We can't drop a dirty block when shrinking the cache. \*/ while (from\_cblock(new\_size) < from\_cblock(cache->cache\_size)) {- new\_size = to\_cblock(from\_cblock(new\_size) + 1); if (is\_dirty(cache, new\_size)) { DMERR("%s: unable to shrink cache; cache block %llu is dirty", cache\_device\_name(cache), (unsigned long long) from\_cblock(new\_size)); return false; }+ new\_size = to\_cblock(from\_cblock(new\_size) + 1); }  return true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:04:07 +0000



=== Content from git.kernel.org_acaa3740_20250114_200532.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=792227719725497ce10a8039803bec13f89f8910)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=792227719725497ce10a8039803bec13f89f8910)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=792227719725497ce10a8039803bec13f89f8910)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=792227719725497ce10a8039803bec13f89f8910)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:16 +0800 |
| --- | --- | --- |
| committer | Mikulas Patocka <mpatocka@redhat.com> | 2024-11-04 17:39:31 +0100 |
| commit | [792227719725497ce10a8039803bec13f89f8910](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=792227719725497ce10a8039803bec13f89f8910) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=792227719725497ce10a8039803bec13f89f8910)) | |
| tree | [5b7c6f84277a36a1024e52f43786af5d5db20da2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=792227719725497ce10a8039803bec13f89f8910) | |
| parent | [135496c208ba26fd68cdef10b64ed7a91ac9a7ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=792227719725497ce10a8039803bec13f89f8910&id2=135496c208ba26fd68cdef10b64ed7a91ac9a7ff)) | |
| download | [linux-792227719725497ce10a8039803bec13f89f8910.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-792227719725497ce10a8039803bec13f89f8910.tar.gz) | |

dm cache: fix out-of-bounds access to the dirty bitset when resizingdm-cache checks the dirty bits of the cache blocks to be dropped when
shrinking the fast device, but an index bug in bitset iteration causes
out-of-bounds access.
Reproduce steps:
1. create a cache device of 1024 cache blocks (128 bytes dirty bitset)
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
2. shrink the fast device to 512 cache blocks, triggering out-of-bounds
access to the dirty bitset (offset 0x80)
dmsetup suspend cache
dmsetup reload cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in cache\_preresume+0x269/0x7b0
Read of size 8 at addr ffffc900000f3080 by task dmsetup/131
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc900000f3000, ffffc900000f5000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc900000f2f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
>ffffc900000f3080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc900000f3100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3180: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by making the index post-incremented.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=792227719725497ce10a8039803bec13f89f8910)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=792227719725497ce10a8039803bec13f89f8910) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 68e9a1abd303d9..1fcd8c5c220e8b 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=792227719725497ce10a8039803bec13f89f8910)@@ -2912,13 +2912,13 @@ static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) \* We can't drop a dirty block when shrinking the cache. \*/ while (from\_cblock(new\_size) < from\_cblock(cache->cache\_size)) {- new\_size = to\_cblock(from\_cblock(new\_size) + 1); if (is\_dirty(cache, new\_size)) { DMERR("%s: unable to shrink cache; cache block %llu is dirty", cache\_device\_name(cache), (unsigned long long) from\_cblock(new\_size)); return false; }+ new\_size = to\_cblock(from\_cblock(new\_size) + 1); }  return true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:04:09 +0000



=== Content from git.kernel.org_63537197_20250114_200533.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:19:37 +0100 |
| commit | [e57648ce325fa405fe6bbd0e6a618ced7c301a2d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d)) | |
| tree | [e1f40672cc96084900f42e021c403d54ca7f3028](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d) | |
| parent | [8cc12dab635333c4ea28e72d7b947be7d0543c2c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d&id2=8cc12dab635333c4ea28e72d7b947be7d0543c2c)) | |
| download | [linux-e57648ce325fa405fe6bbd0e6a618ced7c301a2d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e57648ce325fa405fe6bbd0e6a618ced7c301a2d.tar.gz) | |

dm cache: fix out-of-bounds access to the dirty bitset when resizingcommit 792227719725497ce10a8039803bec13f89f8910 upstream.
dm-cache checks the dirty bits of the cache blocks to be dropped when
shrinking the fast device, but an index bug in bitset iteration causes
out-of-bounds access.
Reproduce steps:
1. create a cache device of 1024 cache blocks (128 bytes dirty bitset)
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
2. shrink the fast device to 512 cache blocks, triggering out-of-bounds
access to the dirty bitset (offset 0x80)
dmsetup suspend cache
dmsetup reload cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in cache\_preresume+0x269/0x7b0
Read of size 8 at addr ffffc900000f3080 by task dmsetup/131
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc900000f3000, ffffc900000f5000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc900000f2f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
>ffffc900000f3080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc900000f3100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3180: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by making the index post-incremented.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 3056cb5e752509..fd3000bd61468e 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=e57648ce325fa405fe6bbd0e6a618ced7c301a2d)@@ -2916,13 +2916,13 @@ static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) \* We can't drop a dirty block when shrinking the cache. \*/ while (from\_cblock(new\_size) < from\_cblock(cache->cache\_size)) {- new\_size = to\_cblock(from\_cblock(new\_size) + 1); if (is\_dirty(cache, new\_size)) { DMERR("%s: unable to shrink cache; cache block %llu is dirty", cache\_device\_name(cache), (unsigned long long) from\_cblock(new\_size)); return false; }+ new\_size = to\_cblock(from\_cblock(new\_size) + 1); }  return true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:04:10 +0000



=== Content from git.kernel.org_2e938a5a_20250114_200534.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:13:39 +0100 |
| commit | [ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f)) | |
| tree | [4ac7af7102bd07b069c1872f6ef0d183818c7886](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f) | |
| parent | [850c31160f6e2e42a7e9e2a5799faa81f286071c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=850c31160f6e2e42a7e9e2a5799faa81f286071c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f&id2=850c31160f6e2e42a7e9e2a5799faa81f286071c)) | |
| download | [linux-ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f.tar.gz) | |

dm cache: fix out-of-bounds access to the dirty bitset when resizingcommit 792227719725497ce10a8039803bec13f89f8910 upstream.
dm-cache checks the dirty bits of the cache blocks to be dropped when
shrinking the fast device, but an index bug in bitset iteration causes
out-of-bounds access.
Reproduce steps:
1. create a cache device of 1024 cache blocks (128 bytes dirty bitset)
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
2. shrink the fast device to 512 cache blocks, triggering out-of-bounds
access to the dirty bitset (offset 0x80)
dmsetup suspend cache
dmsetup reload cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in cache\_preresume+0x269/0x7b0
Read of size 8 at addr ffffc900000f3080 by task dmsetup/131
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc900000f3000, ffffc900000f5000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc900000f2f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
>ffffc900000f3080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc900000f3100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3180: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by making the index post-incremented.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 07f29b85a0d5e1..cc265cfa119d24 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=850c31160f6e2e42a7e9e2a5799faa81f286071c)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=ff1dd8a04c30e8d4e2fd5c83198ca672eb6a9e7f)@@ -2891,13 +2891,13 @@ static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) \* We can't drop a dirty block when shrinking the cache. \*/ while (from\_cblock(new\_size) < from\_cblock(cache->cache\_size)) {- new\_size = to\_cblock(from\_cblock(new\_size) + 1); if (is\_dirty(cache, new\_size)) { DMERR("%s: unable to shrink cache; cache block %llu is dirty", cache\_device\_name(cache), (unsigned long long) from\_cblock(new\_size)); return false; }+ new\_size = to\_cblock(from\_cblock(new\_size) + 1); }  return true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:04:11 +0000



=== Content from git.kernel.org_994384f5_20250114_200530.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3b02c40ff10fdf83cc545850db208de855ebe22c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b02c40ff10fdf83cc545850db208de855ebe22c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b02c40ff10fdf83cc545850db208de855ebe22c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b02c40ff10fdf83cc545850db208de855ebe22c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:07 +0100 |
| commit | [3b02c40ff10fdf83cc545850db208de855ebe22c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b02c40ff10fdf83cc545850db208de855ebe22c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3b02c40ff10fdf83cc545850db208de855ebe22c)) | |
| tree | [e3eb650689738db5b99f9f3b8dccaaf558928fc5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b02c40ff10fdf83cc545850db208de855ebe22c) | |
| parent | [aee3ecda73ce13af7c3e556383342b57e6bd0718](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aee3ecda73ce13af7c3e556383342b57e6bd0718) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b02c40ff10fdf83cc545850db208de855ebe22c&id2=aee3ecda73ce13af7c3e556383342b57e6bd0718)) | |
| download | [linux-3b02c40ff10fdf83cc545850db208de855ebe22c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3b02c40ff10fdf83cc545850db208de855ebe22c.tar.gz) | |

dm cache: fix out-of-bounds access to the dirty bitset when resizingcommit 792227719725497ce10a8039803bec13f89f8910 upstream.
dm-cache checks the dirty bits of the cache blocks to be dropped when
shrinking the fast device, but an index bug in bitset iteration causes
out-of-bounds access.
Reproduce steps:
1. create a cache device of 1024 cache blocks (128 bytes dirty bitset)
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
2. shrink the fast device to 512 cache blocks, triggering out-of-bounds
access to the dirty bitset (offset 0x80)
dmsetup suspend cache
dmsetup reload cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in cache\_preresume+0x269/0x7b0
Read of size 8 at addr ffffc900000f3080 by task dmsetup/131
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc900000f3000, ffffc900000f5000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc900000f2f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
>ffffc900000f3080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc900000f3100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3180: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by making the index post-incremented.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b02c40ff10fdf83cc545850db208de855ebe22c)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=3b02c40ff10fdf83cc545850db208de855ebe22c) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 72a44ee12ca1f4..68e8d5459289a4 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=aee3ecda73ce13af7c3e556383342b57e6bd0718)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=3b02c40ff10fdf83cc545850db208de855ebe22c)@@ -2912,13 +2912,13 @@ static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) \* We can't drop a dirty block when shrinking the cache. \*/ while (from\_cblock(new\_size) < from\_cblock(cache->cache\_size)) {- new\_size = to\_cblock(from\_cblock(new\_size) + 1); if (is\_dirty(cache, new\_size)) { DMERR("%s: unable to shrink cache; cache block %llu is dirty", cache\_device\_name(cache), (unsigned long long) from\_cblock(new\_size)); return false; }+ new\_size = to\_cblock(from\_cblock(new\_size) + 1); }  return true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:04:07 +0000



=== Content from git.kernel.org_47e6a0b5_20250114_200533.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ee1f74925717ab36f6a091104c170639501ce818)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ee1f74925717ab36f6a091104c170639501ce818)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee1f74925717ab36f6a091104c170639501ce818)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee1f74925717ab36f6a091104c170639501ce818)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:59:37 +0100 |
| commit | [ee1f74925717ab36f6a091104c170639501ce818](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee1f74925717ab36f6a091104c170639501ce818) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ee1f74925717ab36f6a091104c170639501ce818)) | |
| tree | [ec3b0fd688d51a2a3636f37632da1ea9b1f5a671](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ee1f74925717ab36f6a091104c170639501ce818) | |
| parent | [5b975f146d827184fcf64ff506048c1ba87c5e98](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b975f146d827184fcf64ff506048c1ba87c5e98) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee1f74925717ab36f6a091104c170639501ce818&id2=5b975f146d827184fcf64ff506048c1ba87c5e98)) | |
| download | [linux-ee1f74925717ab36f6a091104c170639501ce818.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ee1f74925717ab36f6a091104c170639501ce818.tar.gz) | |

dm cache: fix out-of-bounds access to the dirty bitset when resizingcommit 792227719725497ce10a8039803bec13f89f8910 upstream.
dm-cache checks the dirty bits of the cache blocks to be dropped when
shrinking the fast device, but an index bug in bitset iteration causes
out-of-bounds access.
Reproduce steps:
1. create a cache device of 1024 cache blocks (128 bytes dirty bitset)
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
2. shrink the fast device to 512 cache blocks, triggering out-of-bounds
access to the dirty bitset (offset 0x80)
dmsetup suspend cache
dmsetup reload cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in cache\_preresume+0x269/0x7b0
Read of size 8 at addr ffffc900000f3080 by task dmsetup/131
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc900000f3000, ffffc900000f5000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc900000f2f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
>ffffc900000f3080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc900000f3100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3180: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by making the index post-incremented.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ee1f74925717ab36f6a091104c170639501ce818)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=ee1f74925717ab36f6a091104c170639501ce818) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 9f87fbb85bbccd..11b21636b47ff7 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=5b975f146d827184fcf64ff506048c1ba87c5e98)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=ee1f74925717ab36f6a091104c170639501ce818)@@ -2966,13 +2966,13 @@ static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) \* We can't drop a dirty block when shrinking the cache. \*/ while (from\_cblock(new\_size) < from\_cblock(cache->cache\_size)) {- new\_size = to\_cblock(from\_cblock(new\_size) + 1); if (is\_dirty(cache, new\_size)) { DMERR("%s: unable to shrink cache; cache block %llu is dirty", cache\_device\_name(cache), (unsigned long long) from\_cblock(new\_size)); return false; }+ new\_size = to\_cblock(from\_cblock(new\_size) + 1); }  return true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:04:10 +0000



=== Content from git.kernel.org_cd6a1a55_20250114_200531.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=56507203e1b6127967ec2b51fb0b23a0d4af1334)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=56507203e1b6127967ec2b51fb0b23a0d4af1334)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56507203e1b6127967ec2b51fb0b23a0d4af1334)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=56507203e1b6127967ec2b51fb0b23a0d4af1334)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:16 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:15:15 +0100 |
| commit | [56507203e1b6127967ec2b51fb0b23a0d4af1334](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56507203e1b6127967ec2b51fb0b23a0d4af1334) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=56507203e1b6127967ec2b51fb0b23a0d4af1334)) | |
| tree | [699dd9614e5b8d928b65970542f81f1b8c13018b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=56507203e1b6127967ec2b51fb0b23a0d4af1334) | |
| parent | [5a754d3c771280f2d06bf8ab716d6a0d36ca256e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=56507203e1b6127967ec2b51fb0b23a0d4af1334&id2=5a754d3c771280f2d06bf8ab716d6a0d36ca256e)) | |
| download | [linux-56507203e1b6127967ec2b51fb0b23a0d4af1334.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-56507203e1b6127967ec2b51fb0b23a0d4af1334.tar.gz) | |

dm cache: fix out-of-bounds access to the dirty bitset when resizingcommit 792227719725497ce10a8039803bec13f89f8910 upstream.
dm-cache checks the dirty bits of the cache blocks to be dropped when
shrinking the fast device, but an index bug in bitset iteration causes
out-of-bounds access.
Reproduce steps:
1. create a cache device of 1024 cache blocks (128 bytes dirty bitset)
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
2. shrink the fast device to 512 cache blocks, triggering out-of-bounds
access to the dirty bitset (offset 0x80)
dmsetup suspend cache
dmsetup reload cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in cache\_preresume+0x269/0x7b0
Read of size 8 at addr ffffc900000f3080 by task dmsetup/131
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc900000f3000, ffffc900000f5000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc900000f2f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
>ffffc900000f3080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc900000f3100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc900000f3180: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by making the index post-incremented.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=56507203e1b6127967ec2b51fb0b23a0d4af1334)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=56507203e1b6127967ec2b51fb0b23a0d4af1334) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex c774ede6f92585..59908dbd4c18da 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=56507203e1b6127967ec2b51fb0b23a0d4af1334)@@ -2889,13 +2889,13 @@ static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) \* We can't drop a dirty block when shrinking the cache. \*/ while (from\_cblock(new\_size) < from\_cblock(cache->cache\_size)) {- new\_size = to\_cblock(from\_cblock(new\_size) + 1); if (is\_dirty(cache, new\_size)) { DMERR("%s: unable to shrink cache; cache block %llu is dirty", cache\_device\_name(cache), (unsigned long long) from\_cblock(new\_size)); return false; }+ new\_size = to\_cblock(from\_cblock(new\_size) + 1); }  return true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:04:08 +0000


