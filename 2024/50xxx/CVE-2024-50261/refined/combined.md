=== Content from git.kernel.org_230c4265_20250114_180256.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jianbo Liu <jianbol@nvidia.com> | 2024-10-21 13:03:09 +0300 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-10-28 16:13:50 -0700 |
| commit | [f1e54d11b210b53d418ff1476c6b58a2f434dfc0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0)) | |
| tree | [7f6249b7dafb356f9c6ad387856745f086b88392](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0) | |
| parent | [b5abbf612092ebb3e026c0c4756a109d8750f5a5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5abbf612092ebb3e026c0c4756a109d8750f5a5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0&id2=b5abbf612092ebb3e026c0c4756a109d8750f5a5)) | |
| download | [linux-f1e54d11b210b53d418ff1476c6b58a2f434dfc0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f1e54d11b210b53d418ff1476c6b58a2f434dfc0.tar.gz) | |

macsec: Fix use-after-free while sending the offloading packetKASAN reports the following UAF. The metadata\_dst, which is used to
store the SCI value for macsec offload, is already freed by
metadata\_dst\_free() in macsec\_free\_netdev(), while driver still use it
for sending the packet.
To fix this issue, dst\_release() is used instead to release
metadata\_dst. So it is not freed instantly in macsec\_free\_netdev() if
still referenced by skb.
BUG: KASAN: slab-use-after-free in mlx5e\_xmit+0x1e8f/0x4190 [mlx5\_core]
Read of size 2 at addr ffff88813e42e038 by task kworker/7:2/714
[...]
Workqueue: mld mld\_ifc\_work
Call Trace:
<TASK>
dump\_stack\_lvl+0x51/0x60
print\_report+0xc1/0x600
kasan\_report+0xab/0xe0
mlx5e\_xmit+0x1e8f/0x4190 [mlx5\_core]
dev\_hard\_start\_xmit+0x120/0x530
sch\_direct\_xmit+0x149/0x11e0
\_\_qdisc\_run+0x3ad/0x1730
\_\_dev\_queue\_xmit+0x1196/0x2ed0
vlan\_dev\_hard\_start\_xmit+0x32e/0x510 [8021q]
dev\_hard\_start\_xmit+0x120/0x530
\_\_dev\_queue\_xmit+0x14a7/0x2ed0
macsec\_start\_xmit+0x13e9/0x2340
dev\_hard\_start\_xmit+0x120/0x530
\_\_dev\_queue\_xmit+0x14a7/0x2ed0
ip6\_finish\_output2+0x923/0x1a70
ip6\_finish\_output+0x2d7/0x970
ip6\_output+0x1ce/0x3a0
NF\_HOOK.constprop.0+0x15f/0x190
mld\_sendpack+0x59a/0xbd0
mld\_ifc\_work+0x48a/0xa80
process\_one\_work+0x5aa/0xe50
worker\_thread+0x79c/0x1290
kthread+0x28f/0x350
ret\_from\_fork+0x2d/0x70
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Allocated by task 3922:
kasan\_save\_stack+0x20/0x40
kasan\_save\_track+0x10/0x30
\_\_kasan\_kmalloc+0x77/0x90
\_\_kmalloc\_noprof+0x188/0x400
metadata\_dst\_alloc+0x1f/0x4e0
macsec\_newlink+0x914/0x1410
\_\_rtnl\_newlink+0xe08/0x15b0
rtnl\_newlink+0x5f/0x90
rtnetlink\_rcv\_msg+0x667/0xa80
netlink\_rcv\_skb+0x12c/0x360
netlink\_unicast+0x551/0x770
netlink\_sendmsg+0x72d/0xbd0
\_\_sock\_sendmsg+0xc5/0x190
\_\_\_\_sys\_sendmsg+0x52e/0x6a0
\_\_\_sys\_sendmsg+0xeb/0x170
\_\_sys\_sendmsg+0xb5/0x140
do\_syscall\_64+0x4c/0x100
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Freed by task 4011:
kasan\_save\_stack+0x20/0x40
kasan\_save\_track+0x10/0x30
kasan\_save\_free\_info+0x37/0x50
poison\_slab\_object+0x10c/0x190
\_\_kasan\_slab\_free+0x11/0x30
kfree+0xe0/0x290
macsec\_free\_netdev+0x3f/0x140
netdev\_run\_todo+0x450/0xc70
rtnetlink\_rcv\_msg+0x66f/0xa80
netlink\_rcv\_skb+0x12c/0x360
netlink\_unicast+0x551/0x770
netlink\_sendmsg+0x72d/0xbd0
\_\_sock\_sendmsg+0xc5/0x190
\_\_\_\_sys\_sendmsg+0x52e/0x6a0
\_\_\_sys\_sendmsg+0xeb/0x170
\_\_sys\_sendmsg+0xb5/0x140
do\_syscall\_64+0x4c/0x100
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Fixes: 0a28bfd4971f ("net/macsec: Add MACsec skb\_metadata\_dst Tx Data path support")
Signed-off-by: Jianbo Liu <jianbol@nvidia.com>
Reviewed-by: Patrisious Haddad <phaddad@nvidia.com>
Reviewed-by: Chris Mi <cmi@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Sabrina Dubroca <sd@queasysnail.net>
Link: [https://patch.msgid.link/20241021100309.234125-1-tariqt@nvidia.com](https://patch.msgid.link/20241021100309.234125-1-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0)

| -rw-r--r-- | [drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/macsec.c?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/net/macsec.c b/drivers/net/macsec.cindex 26034f80d4a4cc..ee215928257387 100644--- a/[drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/macsec.c?id=b5abbf612092ebb3e026c0c4756a109d8750f5a5)+++ b/[drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/macsec.c?id=f1e54d11b210b53d418ff1476c6b58a2f434dfc0)@@ -3798,8 +3798,7 @@ static void macsec\_free\_netdev(struct net\_device \*dev) { struct macsec\_dev \*macsec = macsec\_priv(dev); - if (macsec->secy.tx\_sc.md\_dst)- metadata\_dst\_free(macsec->secy.tx\_sc.md\_dst);+ dst\_release(&macsec->secy.tx\_sc.md\_dst->dst); free\_percpu(macsec->stats); free\_percpu(macsec->secy.tx\_sc.stats); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:01:33 +0000



=== Content from git.kernel.org_1ca7657e_20250114_180255.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jianbo Liu <jianbol@nvidia.com> | 2024-10-21 13:03:09 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:18 +0100 |
| commit | [9f5ae743dbe9a2458540a7d35fff0f990df025cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf)) | |
| tree | [05f6210e58d769f4ed59111ba59097652d430cf6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf) | |
| parent | [b33b410597ebe4c06660f789880544ab2126baac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b33b410597ebe4c06660f789880544ab2126baac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf&id2=b33b410597ebe4c06660f789880544ab2126baac)) | |
| download | [linux-9f5ae743dbe9a2458540a7d35fff0f990df025cf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f5ae743dbe9a2458540a7d35fff0f990df025cf.tar.gz) | |

macsec: Fix use-after-free while sending the offloading packet[ Upstream commit f1e54d11b210b53d418ff1476c6b58a2f434dfc0 ]
KASAN reports the following UAF. The metadata\_dst, which is used to
store the SCI value for macsec offload, is already freed by
metadata\_dst\_free() in macsec\_free\_netdev(), while driver still use it
for sending the packet.
To fix this issue, dst\_release() is used instead to release
metadata\_dst. So it is not freed instantly in macsec\_free\_netdev() if
still referenced by skb.
BUG: KASAN: slab-use-after-free in mlx5e\_xmit+0x1e8f/0x4190 [mlx5\_core]
Read of size 2 at addr ffff88813e42e038 by task kworker/7:2/714
[...]
Workqueue: mld mld\_ifc\_work
Call Trace:
<TASK>
dump\_stack\_lvl+0x51/0x60
print\_report+0xc1/0x600
kasan\_report+0xab/0xe0
mlx5e\_xmit+0x1e8f/0x4190 [mlx5\_core]
dev\_hard\_start\_xmit+0x120/0x530
sch\_direct\_xmit+0x149/0x11e0
\_\_qdisc\_run+0x3ad/0x1730
\_\_dev\_queue\_xmit+0x1196/0x2ed0
vlan\_dev\_hard\_start\_xmit+0x32e/0x510 [8021q]
dev\_hard\_start\_xmit+0x120/0x530
\_\_dev\_queue\_xmit+0x14a7/0x2ed0
macsec\_start\_xmit+0x13e9/0x2340
dev\_hard\_start\_xmit+0x120/0x530
\_\_dev\_queue\_xmit+0x14a7/0x2ed0
ip6\_finish\_output2+0x923/0x1a70
ip6\_finish\_output+0x2d7/0x970
ip6\_output+0x1ce/0x3a0
NF\_HOOK.constprop.0+0x15f/0x190
mld\_sendpack+0x59a/0xbd0
mld\_ifc\_work+0x48a/0xa80
process\_one\_work+0x5aa/0xe50
worker\_thread+0x79c/0x1290
kthread+0x28f/0x350
ret\_from\_fork+0x2d/0x70
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Allocated by task 3922:
kasan\_save\_stack+0x20/0x40
kasan\_save\_track+0x10/0x30
\_\_kasan\_kmalloc+0x77/0x90
\_\_kmalloc\_noprof+0x188/0x400
metadata\_dst\_alloc+0x1f/0x4e0
macsec\_newlink+0x914/0x1410
\_\_rtnl\_newlink+0xe08/0x15b0
rtnl\_newlink+0x5f/0x90
rtnetlink\_rcv\_msg+0x667/0xa80
netlink\_rcv\_skb+0x12c/0x360
netlink\_unicast+0x551/0x770
netlink\_sendmsg+0x72d/0xbd0
\_\_sock\_sendmsg+0xc5/0x190
\_\_\_\_sys\_sendmsg+0x52e/0x6a0
\_\_\_sys\_sendmsg+0xeb/0x170
\_\_sys\_sendmsg+0xb5/0x140
do\_syscall\_64+0x4c/0x100
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Freed by task 4011:
kasan\_save\_stack+0x20/0x40
kasan\_save\_track+0x10/0x30
kasan\_save\_free\_info+0x37/0x50
poison\_slab\_object+0x10c/0x190
\_\_kasan\_slab\_free+0x11/0x30
kfree+0xe0/0x290
macsec\_free\_netdev+0x3f/0x140
netdev\_run\_todo+0x450/0xc70
rtnetlink\_rcv\_msg+0x66f/0xa80
netlink\_rcv\_skb+0x12c/0x360
netlink\_unicast+0x551/0x770
netlink\_sendmsg+0x72d/0xbd0
\_\_sock\_sendmsg+0xc5/0x190
\_\_\_\_sys\_sendmsg+0x52e/0x6a0
\_\_\_sys\_sendmsg+0xeb/0x170
\_\_sys\_sendmsg+0xb5/0x140
do\_syscall\_64+0x4c/0x100
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Fixes: 0a28bfd4971f ("net/macsec: Add MACsec skb\_metadata\_dst Tx Data path support")
Signed-off-by: Jianbo Liu <jianbol@nvidia.com>
Reviewed-by: Patrisious Haddad <phaddad@nvidia.com>
Reviewed-by: Chris Mi <cmi@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Sabrina Dubroca <sd@queasysnail.net>
Link: [https://patch.msgid.link/20241021100309.234125-1-tariqt@nvidia.com](https://patch.msgid.link/20241021100309.234125-1-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf)

| -rw-r--r-- | [drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/macsec.c?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/net/macsec.c b/drivers/net/macsec.cindex 2ada8baf815b15..7c96493a367bff 100644--- a/[drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/macsec.c?id=b33b410597ebe4c06660f789880544ab2126baac)+++ b/[drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/macsec.c?id=9f5ae743dbe9a2458540a7d35fff0f990df025cf)@@ -3715,8 +3715,7 @@ static void macsec\_free\_netdev(struct net\_device \*dev) { struct macsec\_dev \*macsec = macsec\_priv(dev); - if (macsec->secy.tx\_sc.md\_dst)- metadata\_dst\_free(macsec->secy.tx\_sc.md\_dst);+ dst\_release(&macsec->secy.tx\_sc.md\_dst->dst); free\_percpu(macsec->stats); free\_percpu(macsec->secy.tx\_sc.stats); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:01:32 +0000



=== Content from git.kernel.org_a7590462_20250114_180255.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=872932cf75cf859804370a265dd58118129386fa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=872932cf75cf859804370a265dd58118129386fa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=872932cf75cf859804370a265dd58118129386fa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=872932cf75cf859804370a265dd58118129386fa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jianbo Liu <jianbol@nvidia.com> | 2024-10-21 13:03:09 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:41 +0100 |
| commit | [872932cf75cf859804370a265dd58118129386fa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=872932cf75cf859804370a265dd58118129386fa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=872932cf75cf859804370a265dd58118129386fa)) | |
| tree | [0d7e94598477c71d87adabd58b09b01ff93f6a3b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=872932cf75cf859804370a265dd58118129386fa) | |
| parent | [618ee79e812b64a7502dd5f213d0210d6e1c7c9d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=618ee79e812b64a7502dd5f213d0210d6e1c7c9d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=872932cf75cf859804370a265dd58118129386fa&id2=618ee79e812b64a7502dd5f213d0210d6e1c7c9d)) | |
| download | [linux-872932cf75cf859804370a265dd58118129386fa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-872932cf75cf859804370a265dd58118129386fa.tar.gz) | |

macsec: Fix use-after-free while sending the offloading packet[ Upstream commit f1e54d11b210b53d418ff1476c6b58a2f434dfc0 ]
KASAN reports the following UAF. The metadata\_dst, which is used to
store the SCI value for macsec offload, is already freed by
metadata\_dst\_free() in macsec\_free\_netdev(), while driver still use it
for sending the packet.
To fix this issue, dst\_release() is used instead to release
metadata\_dst. So it is not freed instantly in macsec\_free\_netdev() if
still referenced by skb.
BUG: KASAN: slab-use-after-free in mlx5e\_xmit+0x1e8f/0x4190 [mlx5\_core]
Read of size 2 at addr ffff88813e42e038 by task kworker/7:2/714
[...]
Workqueue: mld mld\_ifc\_work
Call Trace:
<TASK>
dump\_stack\_lvl+0x51/0x60
print\_report+0xc1/0x600
kasan\_report+0xab/0xe0
mlx5e\_xmit+0x1e8f/0x4190 [mlx5\_core]
dev\_hard\_start\_xmit+0x120/0x530
sch\_direct\_xmit+0x149/0x11e0
\_\_qdisc\_run+0x3ad/0x1730
\_\_dev\_queue\_xmit+0x1196/0x2ed0
vlan\_dev\_hard\_start\_xmit+0x32e/0x510 [8021q]
dev\_hard\_start\_xmit+0x120/0x530
\_\_dev\_queue\_xmit+0x14a7/0x2ed0
macsec\_start\_xmit+0x13e9/0x2340
dev\_hard\_start\_xmit+0x120/0x530
\_\_dev\_queue\_xmit+0x14a7/0x2ed0
ip6\_finish\_output2+0x923/0x1a70
ip6\_finish\_output+0x2d7/0x970
ip6\_output+0x1ce/0x3a0
NF\_HOOK.constprop.0+0x15f/0x190
mld\_sendpack+0x59a/0xbd0
mld\_ifc\_work+0x48a/0xa80
process\_one\_work+0x5aa/0xe50
worker\_thread+0x79c/0x1290
kthread+0x28f/0x350
ret\_from\_fork+0x2d/0x70
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Allocated by task 3922:
kasan\_save\_stack+0x20/0x40
kasan\_save\_track+0x10/0x30
\_\_kasan\_kmalloc+0x77/0x90
\_\_kmalloc\_noprof+0x188/0x400
metadata\_dst\_alloc+0x1f/0x4e0
macsec\_newlink+0x914/0x1410
\_\_rtnl\_newlink+0xe08/0x15b0
rtnl\_newlink+0x5f/0x90
rtnetlink\_rcv\_msg+0x667/0xa80
netlink\_rcv\_skb+0x12c/0x360
netlink\_unicast+0x551/0x770
netlink\_sendmsg+0x72d/0xbd0
\_\_sock\_sendmsg+0xc5/0x190
\_\_\_\_sys\_sendmsg+0x52e/0x6a0
\_\_\_sys\_sendmsg+0xeb/0x170
\_\_sys\_sendmsg+0xb5/0x140
do\_syscall\_64+0x4c/0x100
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Freed by task 4011:
kasan\_save\_stack+0x20/0x40
kasan\_save\_track+0x10/0x30
kasan\_save\_free\_info+0x37/0x50
poison\_slab\_object+0x10c/0x190
\_\_kasan\_slab\_free+0x11/0x30
kfree+0xe0/0x290
macsec\_free\_netdev+0x3f/0x140
netdev\_run\_todo+0x450/0xc70
rtnetlink\_rcv\_msg+0x66f/0xa80
netlink\_rcv\_skb+0x12c/0x360
netlink\_unicast+0x551/0x770
netlink\_sendmsg+0x72d/0xbd0
\_\_sock\_sendmsg+0xc5/0x190
\_\_\_\_sys\_sendmsg+0x52e/0x6a0
\_\_\_sys\_sendmsg+0xeb/0x170
\_\_sys\_sendmsg+0xb5/0x140
do\_syscall\_64+0x4c/0x100
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Fixes: 0a28bfd4971f ("net/macsec: Add MACsec skb\_metadata\_dst Tx Data path support")
Signed-off-by: Jianbo Liu <jianbol@nvidia.com>
Reviewed-by: Patrisious Haddad <phaddad@nvidia.com>
Reviewed-by: Chris Mi <cmi@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Sabrina Dubroca <sd@queasysnail.net>
Link: [https://patch.msgid.link/20241021100309.234125-1-tariqt@nvidia.com](https://patch.msgid.link/20241021100309.234125-1-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=872932cf75cf859804370a265dd58118129386fa)

| -rw-r--r-- | [drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/macsec.c?id=872932cf75cf859804370a265dd58118129386fa) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/net/macsec.c b/drivers/net/macsec.cindex 3a19d6f0e0dd80..c007e262daf7db 100644--- a/[drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/macsec.c?id=618ee79e812b64a7502dd5f213d0210d6e1c7c9d)+++ b/[drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/macsec.c?id=872932cf75cf859804370a265dd58118129386fa)@@ -3726,8 +3726,7 @@ static void macsec\_free\_netdev(struct net\_device \*dev) { struct macsec\_dev \*macsec = macsec\_priv(dev); - if (macsec->secy.tx\_sc.md\_dst)- metadata\_dst\_free(macsec->secy.tx\_sc.md\_dst);+ dst\_release(&macsec->secy.tx\_sc.md\_dst->dst); free\_percpu(macsec->stats); free\_percpu(macsec->secy.tx\_sc.stats); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:01:32 +0000



=== Content from git.kernel.org_0f9e1ffe_20250114_180254.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4614640f1d5c93c22272117dc256e9940ccac8e8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4614640f1d5c93c22272117dc256e9940ccac8e8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4614640f1d5c93c22272117dc256e9940ccac8e8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4614640f1d5c93c22272117dc256e9940ccac8e8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jianbo Liu <jianbol@nvidia.com> | 2024-10-21 13:03:09 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:46 +0100 |
| commit | [4614640f1d5c93c22272117dc256e9940ccac8e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4614640f1d5c93c22272117dc256e9940ccac8e8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4614640f1d5c93c22272117dc256e9940ccac8e8)) | |
| tree | [fa41ec0832775ec86dc3009142d624d14f877b73](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4614640f1d5c93c22272117dc256e9940ccac8e8) | |
| parent | [a883bd7fabc050b9a8d97b1a1c6f2aa44df9a09a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a883bd7fabc050b9a8d97b1a1c6f2aa44df9a09a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4614640f1d5c93c22272117dc256e9940ccac8e8&id2=a883bd7fabc050b9a8d97b1a1c6f2aa44df9a09a)) | |
| download | [linux-4614640f1d5c93c22272117dc256e9940ccac8e8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4614640f1d5c93c22272117dc256e9940ccac8e8.tar.gz) | |

macsec: Fix use-after-free while sending the offloading packet[ Upstream commit f1e54d11b210b53d418ff1476c6b58a2f434dfc0 ]
KASAN reports the following UAF. The metadata\_dst, which is used to
store the SCI value for macsec offload, is already freed by
metadata\_dst\_free() in macsec\_free\_netdev(), while driver still use it
for sending the packet.
To fix this issue, dst\_release() is used instead to release
metadata\_dst. So it is not freed instantly in macsec\_free\_netdev() if
still referenced by skb.
BUG: KASAN: slab-use-after-free in mlx5e\_xmit+0x1e8f/0x4190 [mlx5\_core]
Read of size 2 at addr ffff88813e42e038 by task kworker/7:2/714
[...]
Workqueue: mld mld\_ifc\_work
Call Trace:
<TASK>
dump\_stack\_lvl+0x51/0x60
print\_report+0xc1/0x600
kasan\_report+0xab/0xe0
mlx5e\_xmit+0x1e8f/0x4190 [mlx5\_core]
dev\_hard\_start\_xmit+0x120/0x530
sch\_direct\_xmit+0x149/0x11e0
\_\_qdisc\_run+0x3ad/0x1730
\_\_dev\_queue\_xmit+0x1196/0x2ed0
vlan\_dev\_hard\_start\_xmit+0x32e/0x510 [8021q]
dev\_hard\_start\_xmit+0x120/0x530
\_\_dev\_queue\_xmit+0x14a7/0x2ed0
macsec\_start\_xmit+0x13e9/0x2340
dev\_hard\_start\_xmit+0x120/0x530
\_\_dev\_queue\_xmit+0x14a7/0x2ed0
ip6\_finish\_output2+0x923/0x1a70
ip6\_finish\_output+0x2d7/0x970
ip6\_output+0x1ce/0x3a0
NF\_HOOK.constprop.0+0x15f/0x190
mld\_sendpack+0x59a/0xbd0
mld\_ifc\_work+0x48a/0xa80
process\_one\_work+0x5aa/0xe50
worker\_thread+0x79c/0x1290
kthread+0x28f/0x350
ret\_from\_fork+0x2d/0x70
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Allocated by task 3922:
kasan\_save\_stack+0x20/0x40
kasan\_save\_track+0x10/0x30
\_\_kasan\_kmalloc+0x77/0x90
\_\_kmalloc\_noprof+0x188/0x400
metadata\_dst\_alloc+0x1f/0x4e0
macsec\_newlink+0x914/0x1410
\_\_rtnl\_newlink+0xe08/0x15b0
rtnl\_newlink+0x5f/0x90
rtnetlink\_rcv\_msg+0x667/0xa80
netlink\_rcv\_skb+0x12c/0x360
netlink\_unicast+0x551/0x770
netlink\_sendmsg+0x72d/0xbd0
\_\_sock\_sendmsg+0xc5/0x190
\_\_\_\_sys\_sendmsg+0x52e/0x6a0
\_\_\_sys\_sendmsg+0xeb/0x170
\_\_sys\_sendmsg+0xb5/0x140
do\_syscall\_64+0x4c/0x100
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Freed by task 4011:
kasan\_save\_stack+0x20/0x40
kasan\_save\_track+0x10/0x30
kasan\_save\_free\_info+0x37/0x50
poison\_slab\_object+0x10c/0x190
\_\_kasan\_slab\_free+0x11/0x30
kfree+0xe0/0x290
macsec\_free\_netdev+0x3f/0x140
netdev\_run\_todo+0x450/0xc70
rtnetlink\_rcv\_msg+0x66f/0xa80
netlink\_rcv\_skb+0x12c/0x360
netlink\_unicast+0x551/0x770
netlink\_sendmsg+0x72d/0xbd0
\_\_sock\_sendmsg+0xc5/0x190
\_\_\_\_sys\_sendmsg+0x52e/0x6a0
\_\_\_sys\_sendmsg+0xeb/0x170
\_\_sys\_sendmsg+0xb5/0x140
do\_syscall\_64+0x4c/0x100
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Fixes: 0a28bfd4971f ("net/macsec: Add MACsec skb\_metadata\_dst Tx Data path support")
Signed-off-by: Jianbo Liu <jianbol@nvidia.com>
Reviewed-by: Patrisious Haddad <phaddad@nvidia.com>
Reviewed-by: Chris Mi <cmi@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Sabrina Dubroca <sd@queasysnail.net>
Link: [https://patch.msgid.link/20241021100309.234125-1-tariqt@nvidia.com](https://patch.msgid.link/20241021100309.234125-1-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4614640f1d5c93c22272117dc256e9940ccac8e8)

| -rw-r--r-- | [drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/macsec.c?id=4614640f1d5c93c22272117dc256e9940ccac8e8) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/net/macsec.c b/drivers/net/macsec.cindex 2a31d09d43ed49..edee2870f62ab7 100644--- a/[drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/macsec.c?id=a883bd7fabc050b9a8d97b1a1c6f2aa44df9a09a)+++ b/[drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/macsec.c?id=4614640f1d5c93c22272117dc256e9940ccac8e8)@@ -3798,8 +3798,7 @@ static void macsec\_free\_netdev(struct net\_device \*dev) { struct macsec\_dev \*macsec = macsec\_priv(dev); - if (macsec->secy.tx\_sc.md\_dst)- metadata\_dst\_free(macsec->secy.tx\_sc.md\_dst);+ dst\_release(&macsec->secy.tx\_sc.md\_dst->dst); free\_percpu(macsec->stats); free\_percpu(macsec->secy.tx\_sc.stats); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:01:32 +0000


