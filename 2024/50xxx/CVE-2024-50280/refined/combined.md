=== Content from git.kernel.org_fca6f02a_20250114_233120.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aee3ecda73ce13af7c3e556383342b57e6bd0718)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aee3ecda73ce13af7c3e556383342b57e6bd0718)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aee3ecda73ce13af7c3e556383342b57e6bd0718)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aee3ecda73ce13af7c3e556383342b57e6bd0718)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:12:49 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:07 +0100 |
| commit | [aee3ecda73ce13af7c3e556383342b57e6bd0718](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aee3ecda73ce13af7c3e556383342b57e6bd0718) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aee3ecda73ce13af7c3e556383342b57e6bd0718)) | |
| tree | [22590be232d5790a472bab3e97644fd6e59ba92e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aee3ecda73ce13af7c3e556383342b57e6bd0718) | |
| parent | [f11eecdc70b766c12a4f0d0cf64132102cb30553](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f11eecdc70b766c12a4f0d0cf64132102cb30553) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aee3ecda73ce13af7c3e556383342b57e6bd0718&id2=f11eecdc70b766c12a4f0d0cf64132102cb30553)) | |
| download | [linux-aee3ecda73ce13af7c3e556383342b57e6bd0718.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aee3ecda73ce13af7c3e556383342b57e6bd0718.tar.gz) | |

dm cache: fix flushing uninitialized delayed\_work on cache\_ctr errorcommit 135496c208ba26fd68cdef10b64ed7a91ac9a7ff upstream.
An unexpected WARN\_ON from flush\_work() may occur when cache creation
fails, caused by destroying the uninitialized delayed\_work waker in the
error path of cache\_create(). For example, the warning appears on the
superblock checksum error.
Reproduce steps:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/urandom of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
Kernel logs:
(snip)
WARNING: CPU: 0 PID: 84 at kernel/workqueue.c:4178 \_\_flush\_work+0x5d4/0x890
Fix by pulling out the cancel\_delayed\_work\_sync() from the constructor's
error path. This patch doesn't affect the use-after-free fix for
concurrent dm\_resume and dm\_destroy (commit 6a459d8edbdb ("dm cache: Fix
UAF in destroy()")) as cache\_dtr is not changed.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: 6a459d8edbdb ("dm cache: Fix UAF in destroy()")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aee3ecda73ce13af7c3e556383342b57e6bd0718)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=aee3ecda73ce13af7c3e556383342b57e6bd0718) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 9 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 5070efb839b576..72a44ee12ca1f4 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=f11eecdc70b766c12a4f0d0cf64132102cb30553)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=aee3ecda73ce13af7c3e556383342b57e6bd0718)@@ -1905,16 +1905,13 @@ static void check\_migrations(struct work\_struct \*ws) \* This function gets called on the error paths of the constructor, so we \* have to cope with a partially initialised struct. \*/-static void destroy(struct cache \*cache)+static void \_\_destroy(struct cache \*cache) {- unsigned int i;- mempool\_exit(&cache->migration\_pool);  if (cache->prison) dm\_bio\_prison\_destroy\_v2(cache->prison); - cancel\_delayed\_work\_sync(&cache->waker); if (cache->wq) destroy\_workqueue(cache->wq); @@ -1942,13 +1939,22 @@ static void destroy(struct cache \*cache) if (cache->policy) dm\_cache\_policy\_destroy(cache->policy); + bioset\_exit(&cache->bs);++ kfree(cache);+}++static void destroy(struct cache \*cache)+{+ unsigned int i;++ cancel\_delayed\_work\_sync(&cache->waker);+ for (i = 0; i < cache->nr\_ctr\_args ; i++) kfree(cache->ctr\_args[i]); kfree(cache->ctr\_args); - bioset\_exit(&cache->bs);-- kfree(cache);+ \_\_destroy(cache); }  static void cache\_dtr(struct dm\_target \*ti)@@ -2561,7 +2567,7 @@ static int cache\_create(struct cache\_args \*ca, struct cache \*\*result) \*result = cache; return 0; bad:- destroy(cache);+ \_\_destroy(cache); return r; } @@ -2612,7 +2618,7 @@ static int cache\_ctr(struct dm\_target \*ti, unsigned int argc, char \*\*argv)  r = copy\_ctr\_args(cache, argc - 3, (const char \*\*)argv + 3); if (r) {- destroy(cache);+ \_\_destroy(cache); goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:29:57 +0000



=== Content from git.kernel.org_f33fa2eb_20250114_233113.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:12:49 +0800 |
| --- | --- | --- |
| committer | Mikulas Patocka <mpatocka@redhat.com> | 2024-11-04 17:39:31 +0100 |
| commit | [135496c208ba26fd68cdef10b64ed7a91ac9a7ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff)) | |
| tree | [7eaa157909873552c93bedc7f97c472a8e5053e1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff) | |
| parent | [235d2e739fcbe964c9ce179b4c991025662dcdb6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=235d2e739fcbe964c9ce179b4c991025662dcdb6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff&id2=235d2e739fcbe964c9ce179b4c991025662dcdb6)) | |
| download | [linux-135496c208ba26fd68cdef10b64ed7a91ac9a7ff.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-135496c208ba26fd68cdef10b64ed7a91ac9a7ff.tar.gz) | |

dm cache: fix flushing uninitialized delayed\_work on cache\_ctr errorAn unexpected WARN\_ON from flush\_work() may occur when cache creation
fails, caused by destroying the uninitialized delayed\_work waker in the
error path of cache\_create(). For example, the warning appears on the
superblock checksum error.
Reproduce steps:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/urandom of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
Kernel logs:
(snip)
WARNING: CPU: 0 PID: 84 at kernel/workqueue.c:4178 \_\_flush\_work+0x5d4/0x890
Fix by pulling out the cancel\_delayed\_work\_sync() from the constructor's
error path. This patch doesn't affect the use-after-free fix for
concurrent dm\_resume and dm\_destroy (commit 6a459d8edbdb ("dm cache: Fix
UAF in destroy()")) as cache\_dtr is not changed.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: 6a459d8edbdb ("dm cache: Fix UAF in destroy()")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 9 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 90772b42c2344e..68e9a1abd303d9 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=235d2e739fcbe964c9ce179b4c991025662dcdb6)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=135496c208ba26fd68cdef10b64ed7a91ac9a7ff)@@ -1905,16 +1905,13 @@ static void check\_migrations(struct work\_struct \*ws) \* This function gets called on the error paths of the constructor, so we \* have to cope with a partially initialised struct. \*/-static void destroy(struct cache \*cache)+static void \_\_destroy(struct cache \*cache) {- unsigned int i;- mempool\_exit(&cache->migration\_pool);  if (cache->prison) dm\_bio\_prison\_destroy\_v2(cache->prison); - cancel\_delayed\_work\_sync(&cache->waker); if (cache->wq) destroy\_workqueue(cache->wq); @@ -1942,13 +1939,22 @@ static void destroy(struct cache \*cache) if (cache->policy) dm\_cache\_policy\_destroy(cache->policy); + bioset\_exit(&cache->bs);++ kfree(cache);+}++static void destroy(struct cache \*cache)+{+ unsigned int i;++ cancel\_delayed\_work\_sync(&cache->waker);+ for (i = 0; i < cache->nr\_ctr\_args ; i++) kfree(cache->ctr\_args[i]); kfree(cache->ctr\_args); - bioset\_exit(&cache->bs);-- kfree(cache);+ \_\_destroy(cache); }  static void cache\_dtr(struct dm\_target \*ti)@@ -2561,7 +2567,7 @@ static int cache\_create(struct cache\_args \*ca, struct cache \*\*result) \*result = cache; return 0; bad:- destroy(cache);+ \_\_destroy(cache); return r; } @@ -2612,7 +2618,7 @@ static int cache\_ctr(struct dm\_target \*ti, unsigned int argc, char \*\*argv)  r = copy\_ctr\_args(cache, argc - 3, (const char \*\*)argv + 3); if (r) {- destroy(cache);+ \_\_destroy(cache); goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:29:50 +0000



=== Content from git.kernel.org_01e25dba_20250114_233118.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:12:49 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:19:36 +0100 |
| commit | [8cc12dab635333c4ea28e72d7b947be7d0543c2c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c)) | |
| tree | [efc29a9e9b1228b6af81dcf924c90274b7338074](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c) | |
| parent | [11d5a3f8427a763842e914f9541d1fd6ea7cda99](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11d5a3f8427a763842e914f9541d1fd6ea7cda99) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c&id2=11d5a3f8427a763842e914f9541d1fd6ea7cda99)) | |
| download | [linux-8cc12dab635333c4ea28e72d7b947be7d0543c2c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8cc12dab635333c4ea28e72d7b947be7d0543c2c.tar.gz) | |

dm cache: fix flushing uninitialized delayed\_work on cache\_ctr errorcommit 135496c208ba26fd68cdef10b64ed7a91ac9a7ff upstream.
An unexpected WARN\_ON from flush\_work() may occur when cache creation
fails, caused by destroying the uninitialized delayed\_work waker in the
error path of cache\_create(). For example, the warning appears on the
superblock checksum error.
Reproduce steps:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/urandom of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
Kernel logs:
(snip)
WARNING: CPU: 0 PID: 84 at kernel/workqueue.c:4178 \_\_flush\_work+0x5d4/0x890
Fix by pulling out the cancel\_delayed\_work\_sync() from the constructor's
error path. This patch doesn't affect the use-after-free fix for
concurrent dm\_resume and dm\_destroy (commit 6a459d8edbdb ("dm cache: Fix
UAF in destroy()")) as cache\_dtr is not changed.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: 6a459d8edbdb ("dm cache: Fix UAF in destroy()")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 9 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 66be937cee107c..3056cb5e752509 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=11d5a3f8427a763842e914f9541d1fd6ea7cda99)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=8cc12dab635333c4ea28e72d7b947be7d0543c2c)@@ -1909,16 +1909,13 @@ static void check\_migrations(struct work\_struct \*ws) \* This function gets called on the error paths of the constructor, so we \* have to cope with a partially initialised struct. \*/-static void destroy(struct cache \*cache)+static void \_\_destroy(struct cache \*cache) {- unsigned int i;- mempool\_exit(&cache->migration\_pool);  if (cache->prison) dm\_bio\_prison\_destroy\_v2(cache->prison); - cancel\_delayed\_work\_sync(&cache->waker); if (cache->wq) destroy\_workqueue(cache->wq); @@ -1946,13 +1943,22 @@ static void destroy(struct cache \*cache) if (cache->policy) dm\_cache\_policy\_destroy(cache->policy); + bioset\_exit(&cache->bs);++ kfree(cache);+}++static void destroy(struct cache \*cache)+{+ unsigned int i;++ cancel\_delayed\_work\_sync(&cache->waker);+ for (i = 0; i < cache->nr\_ctr\_args ; i++) kfree(cache->ctr\_args[i]); kfree(cache->ctr\_args); - bioset\_exit(&cache->bs);-- kfree(cache);+ \_\_destroy(cache); }  static void cache\_dtr(struct dm\_target \*ti)@@ -2565,7 +2571,7 @@ static int cache\_create(struct cache\_args \*ca, struct cache \*\*result) \*result = cache; return 0; bad:- destroy(cache);+ \_\_destroy(cache); return r; } @@ -2616,7 +2622,7 @@ static int cache\_ctr(struct dm\_target \*ti, unsigned int argc, char \*\*argv)  r = copy\_ctr\_args(cache, argc - 3, (const char \*\*)argv + 3); if (r) {- destroy(cache);+ \_\_destroy(cache); goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:29:53 +0000



=== Content from git.kernel.org_69543c81_20250114_233115.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:12:49 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:15:15 +0100 |
| commit | [5a754d3c771280f2d06bf8ab716d6a0d36ca256e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e)) | |
| tree | [531f8371c4ceaeb11845d89b8826477825661547](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e) | |
| parent | [ffaf0f6eab4617d6b0e3eb55208f679bf378f275](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ffaf0f6eab4617d6b0e3eb55208f679bf378f275) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e&id2=ffaf0f6eab4617d6b0e3eb55208f679bf378f275)) | |
| download | [linux-5a754d3c771280f2d06bf8ab716d6a0d36ca256e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5a754d3c771280f2d06bf8ab716d6a0d36ca256e.tar.gz) | |

dm cache: fix flushing uninitialized delayed\_work on cache\_ctr errorcommit 135496c208ba26fd68cdef10b64ed7a91ac9a7ff upstream.
An unexpected WARN\_ON from flush\_work() may occur when cache creation
fails, caused by destroying the uninitialized delayed\_work waker in the
error path of cache\_create(). For example, the warning appears on the
superblock checksum error.
Reproduce steps:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/urandom of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
dmsetup create cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
Kernel logs:
(snip)
WARNING: CPU: 0 PID: 84 at kernel/workqueue.c:4178 \_\_flush\_work+0x5d4/0x890
Fix by pulling out the cancel\_delayed\_work\_sync() from the constructor's
error path. This patch doesn't affect the use-after-free fix for
concurrent dm\_resume and dm\_destroy (commit 6a459d8edbdb ("dm cache: Fix
UAF in destroy()")) as cache\_dtr is not changed.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: 6a459d8edbdb ("dm cache: Fix UAF in destroy()")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 9 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex ebfbbd1ec9a3de..c774ede6f92585 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=ffaf0f6eab4617d6b0e3eb55208f679bf378f275)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=5a754d3c771280f2d06bf8ab716d6a0d36ca256e)@@ -1882,16 +1882,13 @@ static void check\_migrations(struct work\_struct \*ws) \* This function gets called on the error paths of the constructor, so we \* have to cope with a partially initialised struct. \*/-static void destroy(struct cache \*cache)+static void \_\_destroy(struct cache \*cache) {- unsigned int i;- mempool\_exit(&cache->migration\_pool);  if (cache->prison) dm\_bio\_prison\_destroy\_v2(cache->prison); - cancel\_delayed\_work\_sync(&cache->waker); if (cache->wq) destroy\_workqueue(cache->wq); @@ -1919,13 +1916,22 @@ static void destroy(struct cache \*cache) if (cache->policy) dm\_cache\_policy\_destroy(cache->policy); + bioset\_exit(&cache->bs);++ kfree(cache);+}++static void destroy(struct cache \*cache)+{+ unsigned int i;++ cancel\_delayed\_work\_sync(&cache->waker);+ for (i = 0; i < cache->nr\_ctr\_args ; i++) kfree(cache->ctr\_args[i]); kfree(cache->ctr\_args); - bioset\_exit(&cache->bs);-- kfree(cache);+ \_\_destroy(cache); }  static void cache\_dtr(struct dm\_target \*ti)@@ -2538,7 +2544,7 @@ static int cache\_create(struct cache\_args \*ca, struct cache \*\*result) \*result = cache; return 0; bad:- destroy(cache);+ \_\_destroy(cache); return r; } @@ -2589,7 +2595,7 @@ static int cache\_ctr(struct dm\_target \*ti, unsigned int argc, char \*\*argv)  r = copy\_ctr\_args(cache, argc - 3, (const char \*\*)argv + 3); if (r) {- destroy(cache);+ \_\_destroy(cache); goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:29:51 +0000


