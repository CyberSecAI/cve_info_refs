=== Content from git.kernel.org_60db2198_20250114_182206.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c9539e09c67880ecd88b51188c346a2cc078b06c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9539e09c67880ecd88b51188c346a2cc078b06c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9539e09c67880ecd88b51188c346a2cc078b06c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9539e09c67880ecd88b51188c346a2cc078b06c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hou Tao <houtao1@huawei.com> | 2024-10-30 18:05:14 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:48 +0100 |
| commit | [c9539e09c67880ecd88b51188c346a2cc078b06c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9539e09c67880ecd88b51188c346a2cc078b06c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c9539e09c67880ecd88b51188c346a2cc078b06c)) | |
| tree | [9ad46d5f778591de9d728134ce0780835705d0dc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9539e09c67880ecd88b51188c346a2cc078b06c) | |
| parent | [23c39b8659ce9234d57089bf9ecf6753df901f72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23c39b8659ce9234d57089bf9ecf6753df901f72) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9539e09c67880ecd88b51188c346a2cc078b06c&id2=23c39b8659ce9234d57089bf9ecf6753df901f72)) | |
| download | [linux-c9539e09c67880ecd88b51188c346a2cc078b06c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c9539e09c67880ecd88b51188c346a2cc078b06c.tar.gz) | |

bpf: Check the validity of nr\_words in bpf\_iter\_bits\_new()[ Upstream commit 393397fbdcad7396639d7077c33f86169184ba99 ]
Check the validity of nr\_words in bpf\_iter\_bits\_new(). Without this
check, when multiplication overflow occurs for nr\_bits (e.g., when
nr\_words = 0x0400-0001, nr\_bits becomes 64), stack corruption may occur
due to bpf\_probe\_read\_kernel\_common(..., nr\_bytes = 0x2000-0008).
Fix it by limiting the maximum value of nr\_words to 511. The value is
derived from the current implementation of BPF memory allocator. To
ensure compatibility if the BPF memory allocator's size limitation
changes in the future, use the helper bpf\_mem\_alloc\_check\_size() to
check whether nr\_bytes is too larger. And return -E2BIG instead of
-ENOMEM for oversized nr\_bytes.
Fixes: 4665415975b0 ("bpf: Add bits iterator")
Signed-off-by: Hou Tao <houtao1@huawei.com>
Link: [https://lore.kernel.org/r/20241030100516.3633640-4-houtao@huaweicloud.com](https://lore.kernel.org/r/20241030100516.3633640-4-houtao%40huaweicloud.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9539e09c67880ecd88b51188c346a2cc078b06c)

| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=c9539e09c67880ecd88b51188c346a2cc078b06c) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex a4521d2606b6b3..8419de44c51749 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=23c39b8659ce9234d57089bf9ecf6753df901f72)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=c9539e09c67880ecd88b51188c346a2cc078b06c)@@ -2830,6 +2830,8 @@ struct bpf\_iter\_bits { \_\_u64 \_\_opaque[2]; } \_\_aligned(8); +#define BITS\_ITER\_NR\_WORDS\_MAX 511+ struct bpf\_iter\_bits\_kern { union { unsigned long \*bits;@@ -2844,7 +2846,8 @@ struct bpf\_iter\_bits\_kern { \* @it: The new bpf\_iter\_bits to be created \* @unsafe\_ptr\_\_ign: A pointer pointing to a memory area to be iterated over \* @nr\_words: The size of the specified memory area, measured in 8-byte units.- \* Due to the limitation of memalloc, it can't be greater than 512.+ \* The maximum value of @nr\_words is @BITS\_ITER\_NR\_WORDS\_MAX. This limit may be+ \* further reduced by the BPF memory allocator implementation. \* \* This function initializes a new bpf\_iter\_bits structure for iterating over \* a memory area which is specified by the @unsafe\_ptr\_\_ign and @nr\_words. It@@ -2871,6 +2874,8 @@ bpf\_iter\_bits\_new(struct bpf\_iter\_bits \*it, const u64 \*unsafe\_ptr\_\_ign, u32 nr\_w  if (!unsafe\_ptr\_\_ign || !nr\_words) return -EINVAL;+ if (nr\_words > BITS\_ITER\_NR\_WORDS\_MAX)+ return -E2BIG;  /\* Optimization for u64 mask \*/ if (nr\_bits == 64) {@@ -2882,6 +2887,9 @@ bpf\_iter\_bits\_new(struct bpf\_iter\_bits \*it, const u64 \*unsafe\_ptr\_\_ign, u32 nr\_w return 0; } + if (bpf\_mem\_alloc\_check\_size(false, nr\_bytes))+ return -E2BIG;+ /\* Fallback to memalloc \*/ kit->bits = bpf\_mem\_alloc(&bpf\_global\_ma, nr\_bytes); if (!kit->bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:20:43 +0000



=== Content from git.kernel.org_4e9bf4d1_20250114_182205.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=393397fbdcad7396639d7077c33f86169184ba99)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=393397fbdcad7396639d7077c33f86169184ba99)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=393397fbdcad7396639d7077c33f86169184ba99)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=393397fbdcad7396639d7077c33f86169184ba99)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hou Tao <houtao1@huawei.com> | 2024-10-30 18:05:14 +0800 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2024-10-30 12:13:46 -0700 |
| commit | [393397fbdcad7396639d7077c33f86169184ba99](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=393397fbdcad7396639d7077c33f86169184ba99) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=393397fbdcad7396639d7077c33f86169184ba99)) | |
| tree | [736e0d75c7b2152ef05de5881337a75b87d5b0b5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=393397fbdcad7396639d7077c33f86169184ba99) | |
| parent | [62a898b07b83f6f407003d8a70f0827a5af08a59](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62a898b07b83f6f407003d8a70f0827a5af08a59) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=393397fbdcad7396639d7077c33f86169184ba99&id2=62a898b07b83f6f407003d8a70f0827a5af08a59)) | |
| download | [linux-393397fbdcad7396639d7077c33f86169184ba99.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-393397fbdcad7396639d7077c33f86169184ba99.tar.gz) | |

bpf: Check the validity of nr\_words in bpf\_iter\_bits\_new()Check the validity of nr\_words in bpf\_iter\_bits\_new(). Without this
check, when multiplication overflow occurs for nr\_bits (e.g., when
nr\_words = 0x0400-0001, nr\_bits becomes 64), stack corruption may occur
due to bpf\_probe\_read\_kernel\_common(..., nr\_bytes = 0x2000-0008).
Fix it by limiting the maximum value of nr\_words to 511. The value is
derived from the current implementation of BPF memory allocator. To
ensure compatibility if the BPF memory allocator's size limitation
changes in the future, use the helper bpf\_mem\_alloc\_check\_size() to
check whether nr\_bytes is too larger. And return -E2BIG instead of
-ENOMEM for oversized nr\_bytes.
Fixes: 4665415975b0 ("bpf: Add bits iterator")
Signed-off-by: Hou Tao <houtao1@huawei.com>
Link: [https://lore.kernel.org/r/20241030100516.3633640-4-houtao@huaweicloud.com](https://lore.kernel.org/r/20241030100516.3633640-4-houtao%40huaweicloud.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=393397fbdcad7396639d7077c33f86169184ba99)

| -rw-r--r-- | [kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/helpers.c?id=393397fbdcad7396639d7077c33f86169184ba99) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.cindex d913a8f1fbd9ab..018985ebc5ce8f 100644--- a/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=62a898b07b83f6f407003d8a70f0827a5af08a59)+++ b/[kernel/bpf/helpers.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/helpers.c?id=393397fbdcad7396639d7077c33f86169184ba99)@@ -2851,6 +2851,8 @@ struct bpf\_iter\_bits { \_\_u64 \_\_opaque[2]; } \_\_aligned(8); +#define BITS\_ITER\_NR\_WORDS\_MAX 511+ struct bpf\_iter\_bits\_kern { union { unsigned long \*bits;@@ -2865,7 +2867,8 @@ struct bpf\_iter\_bits\_kern { \* @it: The new bpf\_iter\_bits to be created \* @unsafe\_ptr\_\_ign: A pointer pointing to a memory area to be iterated over \* @nr\_words: The size of the specified memory area, measured in 8-byte units.- \* Due to the limitation of memalloc, it can't be greater than 512.+ \* The maximum value of @nr\_words is @BITS\_ITER\_NR\_WORDS\_MAX. This limit may be+ \* further reduced by the BPF memory allocator implementation. \* \* This function initializes a new bpf\_iter\_bits structure for iterating over \* a memory area which is specified by the @unsafe\_ptr\_\_ign and @nr\_words. It@@ -2892,6 +2895,8 @@ bpf\_iter\_bits\_new(struct bpf\_iter\_bits \*it, const u64 \*unsafe\_ptr\_\_ign, u32 nr\_w  if (!unsafe\_ptr\_\_ign || !nr\_words) return -EINVAL;+ if (nr\_words > BITS\_ITER\_NR\_WORDS\_MAX)+ return -E2BIG;  /\* Optimization for u64 mask \*/ if (nr\_bits == 64) {@@ -2903,6 +2908,9 @@ bpf\_iter\_bits\_new(struct bpf\_iter\_bits \*it, const u64 \*unsafe\_ptr\_\_ign, u32 nr\_w return 0; } + if (bpf\_mem\_alloc\_check\_size(false, nr\_bytes))+ return -E2BIG;+ /\* Fallback to memalloc \*/ kit->bits = bpf\_mem\_alloc(&bpf\_global\_ma, nr\_bytes); if (!kit->bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:20:42 +0000


