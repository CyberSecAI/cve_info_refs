=== Content from git.kernel.org_b8582361_20250114_181033.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1f1764466c33a4466363b821a25cd65c46a5a793)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f1764466c33a4466363b821a25cd65c46a5a793)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f1764466c33a4466363b821a25cd65c46a5a793)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f1764466c33a4466363b821a25cd65c46a5a793)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sungwoo Kim <iam@sung-woo.kim> | 2024-10-29 19:44:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:19 +0100 |
| commit | [1f1764466c33a4466363b821a25cd65c46a5a793](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f1764466c33a4466363b821a25cd65c46a5a793) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1f1764466c33a4466363b821a25cd65c46a5a793)) | |
| tree | [819b213e0eb5c15a733ba49df9c0b6385807f24c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f1764466c33a4466363b821a25cd65c46a5a793) | |
| parent | [fef63832317d9d24e1214cdd8f204d02ebdf8499](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fef63832317d9d24e1214cdd8f204d02ebdf8499) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f1764466c33a4466363b821a25cd65c46a5a793&id2=fef63832317d9d24e1214cdd8f204d02ebdf8499)) | |
| download | [linux-1f1764466c33a4466363b821a25cd65c46a5a793.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1f1764466c33a4466363b821a25cd65c46a5a793.tar.gz) | |

Bluetooth: hci: fix null-ptr-deref in hci\_read\_supported\_codecs[ Upstream commit 1e67d8641813f1876a42eeb4f532487b8a7fb0a8 ]
Fix \_\_hci\_cmd\_sync\_sk() to return not NULL for unknown opcodes.
\_\_hci\_cmd\_sync\_sk() returns NULL if a command returns a status event.
However, it also returns NULL where an opcode doesn't exist in the
hci\_cc table because hci\_cmd\_complete\_evt() assumes status = skb->data[0]
for unknown opcodes.
This leads to null-ptr-deref in cmd\_sync for HCI\_OP\_READ\_LOCAL\_CODECS as
there is no hci\_cc for HCI\_OP\_READ\_LOCAL\_CODECS, which always assumes
status = skb->data[0].
KASAN: null-ptr-deref in range [0x0000000000000070-0x0000000000000077]
CPU: 1 PID: 2000 Comm: kworker/u9:5 Not tainted 6.9.0-ga6bcb805883c-dirty #10
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Workqueue: hci7 hci\_power\_on
RIP: 0010:hci\_read\_supported\_codecs+0xb9/0x870 net/bluetooth/hci\_codec.c:138
Code: 08 48 89 ef e8 b8 c1 8f fd 48 8b 75 00 e9 96 00 00 00 49 89 c6 48 ba 00 00 00 00 00 fc ff df 4c 8d 60 70 4c 89 e3 48 c1 eb 03 <0f> b6 04 13 84 c0 0f 85 82 06 00 00 41 83 3c 24 02 77 0a e8 bf 78
RSP: 0018:ffff888120bafac8 EFLAGS: 00010212
RAX: 0000000000000000 RBX: 000000000000000e RCX: ffff8881173f0040
RDX: dffffc0000000000 RSI: ffffffffa58496c0 RDI: ffff88810b9ad1e4
RBP: ffff88810b9ac000 R08: ffffffffa77882a7 R09: 1ffffffff4ef1054
R10: dffffc0000000000 R11: fffffbfff4ef1055 R12: 0000000000000070
R13: 0000000000000000 R14: 0000000000000000 R15: ffff88810b9ac000
FS: 0000000000000000(0000) GS:ffff8881f6c00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f6ddaa3439e CR3: 0000000139764003 CR4: 0000000000770ef0
PKRU: 55555554
Call Trace:
<TASK>
hci\_read\_local\_codecs\_sync net/bluetooth/hci\_sync.c:4546 [inline]
hci\_init\_stage\_sync net/bluetooth/hci\_sync.c:3441 [inline]
hci\_init4\_sync net/bluetooth/hci\_sync.c:4706 [inline]
hci\_init\_sync net/bluetooth/hci\_sync.c:4742 [inline]
hci\_dev\_init\_sync net/bluetooth/hci\_sync.c:4912 [inline]
hci\_dev\_open\_sync+0x19a9/0x2d30 net/bluetooth/hci\_sync.c:4994
hci\_dev\_do\_open net/bluetooth/hci\_core.c:483 [inline]
hci\_power\_on+0x11e/0x560 net/bluetooth/hci\_core.c:1015
process\_one\_work kernel/workqueue.c:3267 [inline]
process\_scheduled\_works+0x8ef/0x14f0 kernel/workqueue.c:3348
worker\_thread+0x91f/0xe50 kernel/workqueue.c:3429
kthread+0x2cb/0x360 kernel/kthread.c:388
ret\_from\_fork+0x4d/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Fixes: abfeea476c68 ("Bluetooth: hci\_sync: Convert MGMT\_OP\_START\_DISCOVERY")
Signed-off-by: Sungwoo Kim <iam@sung-woo.kim>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f1764466c33a4466363b821a25cd65c46a5a793)

| -rw-r--r-- | [net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sync.c?id=1f1764466c33a4466363b821a25cd65c46a5a793) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 7 deletions

| diff --git a/net/bluetooth/hci\_sync.c b/net/bluetooth/hci\_sync.cindex 75515a1d2923aa..c553b637cda7f3 100644--- a/[net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sync.c?id=fef63832317d9d24e1214cdd8f204d02ebdf8499)+++ b/[net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sync.c?id=1f1764466c33a4466363b821a25cd65c46a5a793)@@ -201,6 +201,12 @@ struct sk\_buff \*\_\_hci\_cmd\_sync\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, return ERR\_PTR(err); } + /\* If command return a status event skb will be set to NULL as there are+ \* no parameters.+ \*/+ if (!skb)+ return ERR\_PTR(-ENODATA);+ return skb; } EXPORT\_SYMBOL(\_\_hci\_cmd\_sync\_sk);@@ -250,6 +256,11 @@ int \_\_hci\_cmd\_sync\_status\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, u8 status;  skb = \_\_hci\_cmd\_sync\_sk(hdev, opcode, plen, param, event, timeout, sk);++ /\* If command return a status event, skb will be set to -ENODATA \*/+ if (skb == ERR\_PTR(-ENODATA))+ return 0;+ if (IS\_ERR(skb)) { if (!event) bt\_dev\_err(hdev, "Opcode 0x%4.4x failed: %ld", opcode,@@ -257,13 +268,6 @@ int \_\_hci\_cmd\_sync\_status\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, return PTR\_ERR(skb); } - /\* If command return a status event skb will be set to NULL as there are- \* no parameters, in case of failure IS\_ERR(skb) would have be set to- \* the actual error would be found with PTR\_ERR(skb).- \*/- if (!skb)- return 0;- status = skb->data[0];  kfree\_skb(skb); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:09:11 +0000



=== Content from git.kernel.org_3ccb5937_20250114_181033.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sungwoo Kim <iam@sung-woo.kim> | 2024-10-29 19:44:41 +0000 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-10-30 14:49:09 -0400 |
| commit | [1e67d8641813f1876a42eeb4f532487b8a7fb0a8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8)) | |
| tree | [c8e6c31ed830d3c889e12a368e9e2c32c428f048](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8) | |
| parent | [c05c62850a8f035a267151dd86ea3daf887e28b8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c05c62850a8f035a267151dd86ea3daf887e28b8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8&id2=c05c62850a8f035a267151dd86ea3daf887e28b8)) | |
| download | [linux-1e67d8641813f1876a42eeb4f532487b8a7fb0a8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1e67d8641813f1876a42eeb4f532487b8a7fb0a8.tar.gz) | |

Bluetooth: hci: fix null-ptr-deref in hci\_read\_supported\_codecsFix \_\_hci\_cmd\_sync\_sk() to return not NULL for unknown opcodes.
\_\_hci\_cmd\_sync\_sk() returns NULL if a command returns a status event.
However, it also returns NULL where an opcode doesn't exist in the
hci\_cc table because hci\_cmd\_complete\_evt() assumes status = skb->data[0]
for unknown opcodes.
This leads to null-ptr-deref in cmd\_sync for HCI\_OP\_READ\_LOCAL\_CODECS as
there is no hci\_cc for HCI\_OP\_READ\_LOCAL\_CODECS, which always assumes
status = skb->data[0].
KASAN: null-ptr-deref in range [0x0000000000000070-0x0000000000000077]
CPU: 1 PID: 2000 Comm: kworker/u9:5 Not tainted 6.9.0-ga6bcb805883c-dirty #10
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Workqueue: hci7 hci\_power\_on
RIP: 0010:hci\_read\_supported\_codecs+0xb9/0x870 net/bluetooth/hci\_codec.c:138
Code: 08 48 89 ef e8 b8 c1 8f fd 48 8b 75 00 e9 96 00 00 00 49 89 c6 48 ba 00 00 00 00 00 fc ff df 4c 8d 60 70 4c 89 e3 48 c1 eb 03 <0f> b6 04 13 84 c0 0f 85 82 06 00 00 41 83 3c 24 02 77 0a e8 bf 78
RSP: 0018:ffff888120bafac8 EFLAGS: 00010212
RAX: 0000000000000000 RBX: 000000000000000e RCX: ffff8881173f0040
RDX: dffffc0000000000 RSI: ffffffffa58496c0 RDI: ffff88810b9ad1e4
RBP: ffff88810b9ac000 R08: ffffffffa77882a7 R09: 1ffffffff4ef1054
R10: dffffc0000000000 R11: fffffbfff4ef1055 R12: 0000000000000070
R13: 0000000000000000 R14: 0000000000000000 R15: ffff88810b9ac000
FS: 0000000000000000(0000) GS:ffff8881f6c00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f6ddaa3439e CR3: 0000000139764003 CR4: 0000000000770ef0
PKRU: 55555554
Call Trace:
<TASK>
hci\_read\_local\_codecs\_sync net/bluetooth/hci\_sync.c:4546 [inline]
hci\_init\_stage\_sync net/bluetooth/hci\_sync.c:3441 [inline]
hci\_init4\_sync net/bluetooth/hci\_sync.c:4706 [inline]
hci\_init\_sync net/bluetooth/hci\_sync.c:4742 [inline]
hci\_dev\_init\_sync net/bluetooth/hci\_sync.c:4912 [inline]
hci\_dev\_open\_sync+0x19a9/0x2d30 net/bluetooth/hci\_sync.c:4994
hci\_dev\_do\_open net/bluetooth/hci\_core.c:483 [inline]
hci\_power\_on+0x11e/0x560 net/bluetooth/hci\_core.c:1015
process\_one\_work kernel/workqueue.c:3267 [inline]
process\_scheduled\_works+0x8ef/0x14f0 kernel/workqueue.c:3348
worker\_thread+0x91f/0xe50 kernel/workqueue.c:3429
kthread+0x2cb/0x360 kernel/kthread.c:388
ret\_from\_fork+0x4d/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Fixes: abfeea476c68 ("Bluetooth: hci\_sync: Convert MGMT\_OP\_START\_DISCOVERY")
Signed-off-by: Sungwoo Kim <iam@sung-woo.kim>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8)

| -rw-r--r-- | [net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sync.c?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 7 deletions

| diff --git a/net/bluetooth/hci\_sync.c b/net/bluetooth/hci\_sync.cindex ae7a5817883aad..c0203a2b510756 100644--- a/[net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sync.c?id=c05c62850a8f035a267151dd86ea3daf887e28b8)+++ b/[net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sync.c?id=1e67d8641813f1876a42eeb4f532487b8a7fb0a8)@@ -206,6 +206,12 @@ struct sk\_buff \*\_\_hci\_cmd\_sync\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, return ERR\_PTR(err); } + /\* If command return a status event skb will be set to NULL as there are+ \* no parameters.+ \*/+ if (!skb)+ return ERR\_PTR(-ENODATA);+ return skb; } EXPORT\_SYMBOL(\_\_hci\_cmd\_sync\_sk);@@ -255,6 +261,11 @@ int \_\_hci\_cmd\_sync\_status\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, u8 status;  skb = \_\_hci\_cmd\_sync\_sk(hdev, opcode, plen, param, event, timeout, sk);++ /\* If command return a status event, skb will be set to -ENODATA \*/+ if (skb == ERR\_PTR(-ENODATA))+ return 0;+ if (IS\_ERR(skb)) { if (!event) bt\_dev\_err(hdev, "Opcode 0x%4.4x failed: %ld", opcode,@@ -262,13 +273,6 @@ int \_\_hci\_cmd\_sync\_status\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, return PTR\_ERR(skb); } - /\* If command return a status event skb will be set to NULL as there are- \* no parameters, in case of failure IS\_ERR(skb) would have be set to- \* the actual error would be found with PTR\_ERR(skb).- \*/- if (!skb)- return 0;- status = skb->data[0];  kfree\_skb(skb); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:09:10 +0000



=== Content from git.kernel.org_2fae1036_20250114_181034.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=48d7c24b7ef6417c68f206566364db1f8087bb23)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48d7c24b7ef6417c68f206566364db1f8087bb23)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48d7c24b7ef6417c68f206566364db1f8087bb23)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48d7c24b7ef6417c68f206566364db1f8087bb23)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sungwoo Kim <iam@sung-woo.kim> | 2024-10-29 19:44:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:48 +0100 |
| commit | [48d7c24b7ef6417c68f206566364db1f8087bb23](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48d7c24b7ef6417c68f206566364db1f8087bb23) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=48d7c24b7ef6417c68f206566364db1f8087bb23)) | |
| tree | [07163f263f5ec1b6e092674798f11e98c324b11c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48d7c24b7ef6417c68f206566364db1f8087bb23) | |
| parent | [f85b057e34419e5ec0583a65078a11ccc1d4540a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f85b057e34419e5ec0583a65078a11ccc1d4540a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48d7c24b7ef6417c68f206566364db1f8087bb23&id2=f85b057e34419e5ec0583a65078a11ccc1d4540a)) | |
| download | [linux-48d7c24b7ef6417c68f206566364db1f8087bb23.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-48d7c24b7ef6417c68f206566364db1f8087bb23.tar.gz) | |

Bluetooth: hci: fix null-ptr-deref in hci\_read\_supported\_codecs[ Upstream commit 1e67d8641813f1876a42eeb4f532487b8a7fb0a8 ]
Fix \_\_hci\_cmd\_sync\_sk() to return not NULL for unknown opcodes.
\_\_hci\_cmd\_sync\_sk() returns NULL if a command returns a status event.
However, it also returns NULL where an opcode doesn't exist in the
hci\_cc table because hci\_cmd\_complete\_evt() assumes status = skb->data[0]
for unknown opcodes.
This leads to null-ptr-deref in cmd\_sync for HCI\_OP\_READ\_LOCAL\_CODECS as
there is no hci\_cc for HCI\_OP\_READ\_LOCAL\_CODECS, which always assumes
status = skb->data[0].
KASAN: null-ptr-deref in range [0x0000000000000070-0x0000000000000077]
CPU: 1 PID: 2000 Comm: kworker/u9:5 Not tainted 6.9.0-ga6bcb805883c-dirty #10
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Workqueue: hci7 hci\_power\_on
RIP: 0010:hci\_read\_supported\_codecs+0xb9/0x870 net/bluetooth/hci\_codec.c:138
Code: 08 48 89 ef e8 b8 c1 8f fd 48 8b 75 00 e9 96 00 00 00 49 89 c6 48 ba 00 00 00 00 00 fc ff df 4c 8d 60 70 4c 89 e3 48 c1 eb 03 <0f> b6 04 13 84 c0 0f 85 82 06 00 00 41 83 3c 24 02 77 0a e8 bf 78
RSP: 0018:ffff888120bafac8 EFLAGS: 00010212
RAX: 0000000000000000 RBX: 000000000000000e RCX: ffff8881173f0040
RDX: dffffc0000000000 RSI: ffffffffa58496c0 RDI: ffff88810b9ad1e4
RBP: ffff88810b9ac000 R08: ffffffffa77882a7 R09: 1ffffffff4ef1054
R10: dffffc0000000000 R11: fffffbfff4ef1055 R12: 0000000000000070
R13: 0000000000000000 R14: 0000000000000000 R15: ffff88810b9ac000
FS: 0000000000000000(0000) GS:ffff8881f6c00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f6ddaa3439e CR3: 0000000139764003 CR4: 0000000000770ef0
PKRU: 55555554
Call Trace:
<TASK>
hci\_read\_local\_codecs\_sync net/bluetooth/hci\_sync.c:4546 [inline]
hci\_init\_stage\_sync net/bluetooth/hci\_sync.c:3441 [inline]
hci\_init4\_sync net/bluetooth/hci\_sync.c:4706 [inline]
hci\_init\_sync net/bluetooth/hci\_sync.c:4742 [inline]
hci\_dev\_init\_sync net/bluetooth/hci\_sync.c:4912 [inline]
hci\_dev\_open\_sync+0x19a9/0x2d30 net/bluetooth/hci\_sync.c:4994
hci\_dev\_do\_open net/bluetooth/hci\_core.c:483 [inline]
hci\_power\_on+0x11e/0x560 net/bluetooth/hci\_core.c:1015
process\_one\_work kernel/workqueue.c:3267 [inline]
process\_scheduled\_works+0x8ef/0x14f0 kernel/workqueue.c:3348
worker\_thread+0x91f/0xe50 kernel/workqueue.c:3429
kthread+0x2cb/0x360 kernel/kthread.c:388
ret\_from\_fork+0x4d/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Fixes: abfeea476c68 ("Bluetooth: hci\_sync: Convert MGMT\_OP\_START\_DISCOVERY")
Signed-off-by: Sungwoo Kim <iam@sung-woo.kim>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48d7c24b7ef6417c68f206566364db1f8087bb23)

| -rw-r--r-- | [net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sync.c?id=48d7c24b7ef6417c68f206566364db1f8087bb23) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 7 deletions

| diff --git a/net/bluetooth/hci\_sync.c b/net/bluetooth/hci\_sync.cindex ae7a5817883aad..c0203a2b510756 100644--- a/[net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sync.c?id=f85b057e34419e5ec0583a65078a11ccc1d4540a)+++ b/[net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sync.c?id=48d7c24b7ef6417c68f206566364db1f8087bb23)@@ -206,6 +206,12 @@ struct sk\_buff \*\_\_hci\_cmd\_sync\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, return ERR\_PTR(err); } + /\* If command return a status event skb will be set to NULL as there are+ \* no parameters.+ \*/+ if (!skb)+ return ERR\_PTR(-ENODATA);+ return skb; } EXPORT\_SYMBOL(\_\_hci\_cmd\_sync\_sk);@@ -255,6 +261,11 @@ int \_\_hci\_cmd\_sync\_status\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, u8 status;  skb = \_\_hci\_cmd\_sync\_sk(hdev, opcode, plen, param, event, timeout, sk);++ /\* If command return a status event, skb will be set to -ENODATA \*/+ if (skb == ERR\_PTR(-ENODATA))+ return 0;+ if (IS\_ERR(skb)) { if (!event) bt\_dev\_err(hdev, "Opcode 0x%4.4x failed: %ld", opcode,@@ -262,13 +273,6 @@ int \_\_hci\_cmd\_sync\_status\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, return PTR\_ERR(skb); } - /\* If command return a status event skb will be set to NULL as there are- \* no parameters, in case of failure IS\_ERR(skb) would have be set to- \* the actual error would be found with PTR\_ERR(skb).- \*/- if (!skb)- return 0;- status = skb->data[0];  kfree\_skb(skb); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:09:11 +0000



=== Content from git.kernel.org_95601661_20250114_181034.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5d9054b9f769a8e124c4fa02072437c864726baf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d9054b9f769a8e124c4fa02072437c864726baf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d9054b9f769a8e124c4fa02072437c864726baf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d9054b9f769a8e124c4fa02072437c864726baf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sungwoo Kim <iam@sung-woo.kim> | 2024-10-29 19:44:41 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:41 +0100 |
| commit | [5d9054b9f769a8e124c4fa02072437c864726baf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d9054b9f769a8e124c4fa02072437c864726baf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5d9054b9f769a8e124c4fa02072437c864726baf)) | |
| tree | [bc1ce381e3aa541fef578af237a35cb62d76beff](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d9054b9f769a8e124c4fa02072437c864726baf) | |
| parent | [4f7b586aae53c2ed820661803da8ce18b1361921](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f7b586aae53c2ed820661803da8ce18b1361921) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d9054b9f769a8e124c4fa02072437c864726baf&id2=4f7b586aae53c2ed820661803da8ce18b1361921)) | |
| download | [linux-5d9054b9f769a8e124c4fa02072437c864726baf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5d9054b9f769a8e124c4fa02072437c864726baf.tar.gz) | |

Bluetooth: hci: fix null-ptr-deref in hci\_read\_supported\_codecs[ Upstream commit 1e67d8641813f1876a42eeb4f532487b8a7fb0a8 ]
Fix \_\_hci\_cmd\_sync\_sk() to return not NULL for unknown opcodes.
\_\_hci\_cmd\_sync\_sk() returns NULL if a command returns a status event.
However, it also returns NULL where an opcode doesn't exist in the
hci\_cc table because hci\_cmd\_complete\_evt() assumes status = skb->data[0]
for unknown opcodes.
This leads to null-ptr-deref in cmd\_sync for HCI\_OP\_READ\_LOCAL\_CODECS as
there is no hci\_cc for HCI\_OP\_READ\_LOCAL\_CODECS, which always assumes
status = skb->data[0].
KASAN: null-ptr-deref in range [0x0000000000000070-0x0000000000000077]
CPU: 1 PID: 2000 Comm: kworker/u9:5 Not tainted 6.9.0-ga6bcb805883c-dirty #10
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Workqueue: hci7 hci\_power\_on
RIP: 0010:hci\_read\_supported\_codecs+0xb9/0x870 net/bluetooth/hci\_codec.c:138
Code: 08 48 89 ef e8 b8 c1 8f fd 48 8b 75 00 e9 96 00 00 00 49 89 c6 48 ba 00 00 00 00 00 fc ff df 4c 8d 60 70 4c 89 e3 48 c1 eb 03 <0f> b6 04 13 84 c0 0f 85 82 06 00 00 41 83 3c 24 02 77 0a e8 bf 78
RSP: 0018:ffff888120bafac8 EFLAGS: 00010212
RAX: 0000000000000000 RBX: 000000000000000e RCX: ffff8881173f0040
RDX: dffffc0000000000 RSI: ffffffffa58496c0 RDI: ffff88810b9ad1e4
RBP: ffff88810b9ac000 R08: ffffffffa77882a7 R09: 1ffffffff4ef1054
R10: dffffc0000000000 R11: fffffbfff4ef1055 R12: 0000000000000070
R13: 0000000000000000 R14: 0000000000000000 R15: ffff88810b9ac000
FS: 0000000000000000(0000) GS:ffff8881f6c00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f6ddaa3439e CR3: 0000000139764003 CR4: 0000000000770ef0
PKRU: 55555554
Call Trace:
<TASK>
hci\_read\_local\_codecs\_sync net/bluetooth/hci\_sync.c:4546 [inline]
hci\_init\_stage\_sync net/bluetooth/hci\_sync.c:3441 [inline]
hci\_init4\_sync net/bluetooth/hci\_sync.c:4706 [inline]
hci\_init\_sync net/bluetooth/hci\_sync.c:4742 [inline]
hci\_dev\_init\_sync net/bluetooth/hci\_sync.c:4912 [inline]
hci\_dev\_open\_sync+0x19a9/0x2d30 net/bluetooth/hci\_sync.c:4994
hci\_dev\_do\_open net/bluetooth/hci\_core.c:483 [inline]
hci\_power\_on+0x11e/0x560 net/bluetooth/hci\_core.c:1015
process\_one\_work kernel/workqueue.c:3267 [inline]
process\_scheduled\_works+0x8ef/0x14f0 kernel/workqueue.c:3348
worker\_thread+0x91f/0xe50 kernel/workqueue.c:3429
kthread+0x2cb/0x360 kernel/kthread.c:388
ret\_from\_fork+0x4d/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Fixes: abfeea476c68 ("Bluetooth: hci\_sync: Convert MGMT\_OP\_START\_DISCOVERY")
Signed-off-by: Sungwoo Kim <iam@sung-woo.kim>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d9054b9f769a8e124c4fa02072437c864726baf)

| -rw-r--r-- | [net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_sync.c?id=5d9054b9f769a8e124c4fa02072437c864726baf) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 7 deletions

| diff --git a/net/bluetooth/hci\_sync.c b/net/bluetooth/hci\_sync.cindex 0cc187ff358740..c368235202b25f 100644--- a/[net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sync.c?id=4f7b586aae53c2ed820661803da8ce18b1361921)+++ b/[net/bluetooth/hci\_sync.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_sync.c?id=5d9054b9f769a8e124c4fa02072437c864726baf)@@ -200,6 +200,12 @@ struct sk\_buff \*\_\_hci\_cmd\_sync\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, return ERR\_PTR(err); } + /\* If command return a status event skb will be set to NULL as there are+ \* no parameters.+ \*/+ if (!skb)+ return ERR\_PTR(-ENODATA);+ return skb; } EXPORT\_SYMBOL(\_\_hci\_cmd\_sync\_sk);@@ -249,6 +255,11 @@ int \_\_hci\_cmd\_sync\_status\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, u8 status;  skb = \_\_hci\_cmd\_sync\_sk(hdev, opcode, plen, param, event, timeout, sk);++ /\* If command return a status event, skb will be set to -ENODATA \*/+ if (skb == ERR\_PTR(-ENODATA))+ return 0;+ if (IS\_ERR(skb)) { if (!event) bt\_dev\_err(hdev, "Opcode 0x%4.4x failed: %ld", opcode,@@ -256,13 +267,6 @@ int \_\_hci\_cmd\_sync\_status\_sk(struct hci\_dev \*hdev, u16 opcode, u32 plen, return PTR\_ERR(skb); } - /\* If command return a status event skb will be set to NULL as there are- \* no parameters, in case of failure IS\_ERR(skb) would have be set to- \* the actual error would be found with PTR\_ERR(skb).- \*/- if (!skb)- return 0;- status = skb->data[0];  kfree\_skb(skb); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:09:11 +0000


