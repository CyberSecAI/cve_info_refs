=== Content from git.kernel.org_310e625f_20250114_195928.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-10-22 12:31:08 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:56:05 +0100 |
| commit | [9ddda5d967e84796e7df1b54a55f36b4b9f21079](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079)) | |
| tree | [16e0b984b649c5f43bdbb81a7540dfd3e1262438](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079) | |
| parent | [5f063bbf1ee6b01611c016b54e050a41506eb794](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f063bbf1ee6b01611c016b54e050a41506eb794) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079&id2=5f063bbf1ee6b01611c016b54e050a41506eb794)) | |
| download | [linux-9ddda5d967e84796e7df1b54a55f36b4b9f21079.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ddda5d967e84796e7df1b54a55f36b4b9f21079.tar.gz) | |

Bluetooth: SCO: Fix UAF on sco\_sock\_timeout[ Upstream commit 1bf4470a3939c678fb822073e9ea77a0560bc6bb ]
conn->sk maybe have been unlinked/freed while waiting for sco\_conn\_lock
so this checks if the conn->sk is still valid by checking if it part of
sco\_sk\_list.
Reported-by: syzbot+4c0d0c4cde787116d465@syzkaller.appspotmail.com
Tested-by: syzbot+4c0d0c4cde787116d465@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=4c0d0c4cde787116d465
Fixes: ba316be1b6a0 ("Bluetooth: schedule SCO timeouts with delayed\_work")
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079)

| -rw-r--r-- | [include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/bluetooth.h?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/af_bluetooth.c?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/sco.c?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 35 insertions, 6 deletions

| diff --git a/include/net/bluetooth/bluetooth.h b/include/net/bluetooth/bluetooth.hindex c7f1dd34ea4705..41fc7f12971a55 100644--- a/[include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/bluetooth.h?id=5f063bbf1ee6b01611c016b54e050a41506eb794)+++ b/[include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/bluetooth.h?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079)@@ -383,6 +383,7 @@ int bt\_sock\_register(int proto, const struct net\_proto\_family \*ops); void bt\_sock\_unregister(int proto); void bt\_sock\_link(struct bt\_sock\_list \*l, struct sock \*s); void bt\_sock\_unlink(struct bt\_sock\_list \*l, struct sock \*s);+bool bt\_sock\_linked(struct bt\_sock\_list \*l, struct sock \*s); struct sock \*bt\_sock\_alloc(struct net \*net, struct socket \*sock, struct proto \*prot, int proto, gfp\_t prio, int kern); int bt\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, size\_t len,diff --git a/net/bluetooth/af\_bluetooth.c b/net/bluetooth/af\_bluetooth.cindex 0c70172555b4f0..4c3bd051603872 100644--- a/[net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/af_bluetooth.c?id=5f063bbf1ee6b01611c016b54e050a41506eb794)+++ b/[net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/af_bluetooth.c?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079)@@ -177,6 +177,28 @@ void bt\_sock\_unlink(struct bt\_sock\_list \*l, struct sock \*sk) } EXPORT\_SYMBOL(bt\_sock\_unlink); +bool bt\_sock\_linked(struct bt\_sock\_list \*l, struct sock \*s)+{+ struct sock \*sk;++ if (!l || !s)+ return false;++ read\_lock(&l->lock);++ sk\_for\_each(sk, &l->head) {+ if (s == sk) {+ read\_unlock(&l->lock);+ return true;+ }+ }++ read\_unlock(&l->lock);++ return false;+}+EXPORT\_SYMBOL(bt\_sock\_linked);+ void bt\_accept\_enqueue(struct sock \*parent, struct sock \*sk, bool bh) { BT\_DBG("parent %p, sk %p", parent, sk);diff --git a/net/bluetooth/sco.c b/net/bluetooth/sco.cindex 92ea01f9def3e0..ad5afde17213a2 100644--- a/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=5f063bbf1ee6b01611c016b54e050a41506eb794)+++ b/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=9ddda5d967e84796e7df1b54a55f36b4b9f21079)@@ -77,6 +77,16 @@ struct sco\_pinfo { #define SCO\_CONN\_TIMEOUT (HZ \* 40) #define SCO\_DISCONN\_TIMEOUT (HZ \* 2) +static struct sock \*sco\_sock\_hold(struct sco\_conn \*conn)+{+ if (!conn || !bt\_sock\_linked(&sco\_sk\_list, conn->sk))+ return NULL;++ sock\_hold(conn->sk);++ return conn->sk;+}+ static void sco\_sock\_timeout(struct work\_struct \*work) { struct sco\_conn \*conn = container\_of(work, struct sco\_conn,@@ -88,9 +98,7 @@ static void sco\_sock\_timeout(struct work\_struct \*work) sco\_conn\_unlock(conn); return; }- sk = conn->sk;- if (sk)- sock\_hold(sk);+ sk = sco\_sock\_hold(conn); sco\_conn\_unlock(conn);  if (!sk)@@ -195,9 +203,7 @@ static void sco\_conn\_del(struct hci\_conn \*hcon, int err)  /\* Kill socket \*/ sco\_conn\_lock(conn);- sk = conn->sk;- if (sk)- sock\_hold(sk);+ sk = sco\_sock\_hold(conn); sco\_conn\_unlock(conn);  if (sk) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:58:05 +0000



=== Content from git.kernel.org_05975999_20250114_195927.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-10-22 12:31:08 -0400 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-10-23 10:20:29 -0400 |
| commit | [1bf4470a3939c678fb822073e9ea77a0560bc6bb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb)) | |
| tree | [4e3b5bfbbaf5f90fa8cc5bfed68e30405229f41e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb) | |
| parent | [989fa5171f005ecf63440057218d8aeb1795287d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=989fa5171f005ecf63440057218d8aeb1795287d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb&id2=989fa5171f005ecf63440057218d8aeb1795287d)) | |
| download | [linux-1bf4470a3939c678fb822073e9ea77a0560bc6bb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1bf4470a3939c678fb822073e9ea77a0560bc6bb.tar.gz) | |

Bluetooth: SCO: Fix UAF on sco\_sock\_timeoutconn->sk maybe have been unlinked/freed while waiting for sco\_conn\_lock
so this checks if the conn->sk is still valid by checking if it part of
sco\_sk\_list.
Reported-by: syzbot+4c0d0c4cde787116d465@syzkaller.appspotmail.com
Tested-by: syzbot+4c0d0c4cde787116d465@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=4c0d0c4cde787116d465
Fixes: ba316be1b6a0 ("Bluetooth: schedule SCO timeouts with delayed\_work")
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb)

| -rw-r--r-- | [include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/bluetooth.h?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/af_bluetooth.c?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/sco.c?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 35 insertions, 6 deletions

| diff --git a/include/net/bluetooth/bluetooth.h b/include/net/bluetooth/bluetooth.hindex 5d655e109b2c0a..f66bc85c6411dd 100644--- a/[include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/bluetooth.h?id=989fa5171f005ecf63440057218d8aeb1795287d)+++ b/[include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/bluetooth.h?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb)@@ -403,6 +403,7 @@ int bt\_sock\_register(int proto, const struct net\_proto\_family \*ops); void bt\_sock\_unregister(int proto); void bt\_sock\_link(struct bt\_sock\_list \*l, struct sock \*s); void bt\_sock\_unlink(struct bt\_sock\_list \*l, struct sock \*s);+bool bt\_sock\_linked(struct bt\_sock\_list \*l, struct sock \*s); struct sock \*bt\_sock\_alloc(struct net \*net, struct socket \*sock, struct proto \*prot, int proto, gfp\_t prio, int kern); int bt\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, size\_t len,diff --git a/net/bluetooth/af\_bluetooth.c b/net/bluetooth/af\_bluetooth.cindex 67604ccec2f427..bdce9270487d15 100644--- a/[net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/af_bluetooth.c?id=989fa5171f005ecf63440057218d8aeb1795287d)+++ b/[net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/af_bluetooth.c?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb)@@ -185,6 +185,28 @@ void bt\_sock\_unlink(struct bt\_sock\_list \*l, struct sock \*sk) } EXPORT\_SYMBOL(bt\_sock\_unlink); +bool bt\_sock\_linked(struct bt\_sock\_list \*l, struct sock \*s)+{+ struct sock \*sk;++ if (!l || !s)+ return false;++ read\_lock(&l->lock);++ sk\_for\_each(sk, &l->head) {+ if (s == sk) {+ read\_unlock(&l->lock);+ return true;+ }+ }++ read\_unlock(&l->lock);++ return false;+}+EXPORT\_SYMBOL(bt\_sock\_linked);+ void bt\_accept\_enqueue(struct sock \*parent, struct sock \*sk, bool bh) { const struct cred \*old\_cred;diff --git a/net/bluetooth/sco.c b/net/bluetooth/sco.cindex a5ac160c592eb9..1c7252a3686694 100644--- a/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=989fa5171f005ecf63440057218d8aeb1795287d)+++ b/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=1bf4470a3939c678fb822073e9ea77a0560bc6bb)@@ -76,6 +76,16 @@ struct sco\_pinfo { #define SCO\_CONN\_TIMEOUT (HZ \* 40) #define SCO\_DISCONN\_TIMEOUT (HZ \* 2) +static struct sock \*sco\_sock\_hold(struct sco\_conn \*conn)+{+ if (!conn || !bt\_sock\_linked(&sco\_sk\_list, conn->sk))+ return NULL;++ sock\_hold(conn->sk);++ return conn->sk;+}+ static void sco\_sock\_timeout(struct work\_struct \*work) { struct sco\_conn \*conn = container\_of(work, struct sco\_conn,@@ -87,9 +97,7 @@ static void sco\_sock\_timeout(struct work\_struct \*work) sco\_conn\_unlock(conn); return; }- sk = conn->sk;- if (sk)- sock\_hold(sk);+ sk = sco\_sock\_hold(conn); sco\_conn\_unlock(conn);  if (!sk)@@ -194,9 +202,7 @@ static void sco\_conn\_del(struct hci\_conn \*hcon, int err)  /\* Kill socket \*/ sco\_conn\_lock(conn);- sk = conn->sk;- if (sk)- sock\_hold(sk);+ sk = sco\_sock\_hold(conn); sco\_conn\_unlock(conn);  if (sk) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:58:04 +0000



=== Content from git.kernel.org_20ae003a_20250114_195927.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=80b05fbfa998480fb3d5299d93eab946f51e9c36)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=80b05fbfa998480fb3d5299d93eab946f51e9c36)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80b05fbfa998480fb3d5299d93eab946f51e9c36)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=80b05fbfa998480fb3d5299d93eab946f51e9c36)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-10-22 12:31:08 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:37 +0100 |
| commit | [80b05fbfa998480fb3d5299d93eab946f51e9c36](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80b05fbfa998480fb3d5299d93eab946f51e9c36) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=80b05fbfa998480fb3d5299d93eab946f51e9c36)) | |
| tree | [9e978d72cfb2ff6376d708d3d88f1c513198e791](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=80b05fbfa998480fb3d5299d93eab946f51e9c36) | |
| parent | [cfdb13a54e05eb98d9940cb6d1a13e7f994d811f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfdb13a54e05eb98d9940cb6d1a13e7f994d811f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=80b05fbfa998480fb3d5299d93eab946f51e9c36&id2=cfdb13a54e05eb98d9940cb6d1a13e7f994d811f)) | |
| download | [linux-80b05fbfa998480fb3d5299d93eab946f51e9c36.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-80b05fbfa998480fb3d5299d93eab946f51e9c36.tar.gz) | |

Bluetooth: SCO: Fix UAF on sco\_sock\_timeout[ Upstream commit 1bf4470a3939c678fb822073e9ea77a0560bc6bb ]
conn->sk maybe have been unlinked/freed while waiting for sco\_conn\_lock
so this checks if the conn->sk is still valid by checking if it part of
sco\_sk\_list.
Reported-by: syzbot+4c0d0c4cde787116d465@syzkaller.appspotmail.com
Tested-by: syzbot+4c0d0c4cde787116d465@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=4c0d0c4cde787116d465
Fixes: ba316be1b6a0 ("Bluetooth: schedule SCO timeouts with delayed\_work")
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=80b05fbfa998480fb3d5299d93eab946f51e9c36)

| -rw-r--r-- | [include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/bluetooth.h?id=80b05fbfa998480fb3d5299d93eab946f51e9c36) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/af_bluetooth.c?id=80b05fbfa998480fb3d5299d93eab946f51e9c36) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/sco.c?id=80b05fbfa998480fb3d5299d93eab946f51e9c36) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 35 insertions, 6 deletions

| diff --git a/include/net/bluetooth/bluetooth.h b/include/net/bluetooth/bluetooth.hindex 5d655e109b2c0a..f66bc85c6411dd 100644--- a/[include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/bluetooth.h?id=cfdb13a54e05eb98d9940cb6d1a13e7f994d811f)+++ b/[include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/bluetooth.h?id=80b05fbfa998480fb3d5299d93eab946f51e9c36)@@ -403,6 +403,7 @@ int bt\_sock\_register(int proto, const struct net\_proto\_family \*ops); void bt\_sock\_unregister(int proto); void bt\_sock\_link(struct bt\_sock\_list \*l, struct sock \*s); void bt\_sock\_unlink(struct bt\_sock\_list \*l, struct sock \*s);+bool bt\_sock\_linked(struct bt\_sock\_list \*l, struct sock \*s); struct sock \*bt\_sock\_alloc(struct net \*net, struct socket \*sock, struct proto \*prot, int proto, gfp\_t prio, int kern); int bt\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, size\_t len,diff --git a/net/bluetooth/af\_bluetooth.c b/net/bluetooth/af\_bluetooth.cindex e39fba5565c5d4..0b4d0a8bd36141 100644--- a/[net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/af_bluetooth.c?id=cfdb13a54e05eb98d9940cb6d1a13e7f994d811f)+++ b/[net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/af_bluetooth.c?id=80b05fbfa998480fb3d5299d93eab946f51e9c36)@@ -185,6 +185,28 @@ void bt\_sock\_unlink(struct bt\_sock\_list \*l, struct sock \*sk) } EXPORT\_SYMBOL(bt\_sock\_unlink); +bool bt\_sock\_linked(struct bt\_sock\_list \*l, struct sock \*s)+{+ struct sock \*sk;++ if (!l || !s)+ return false;++ read\_lock(&l->lock);++ sk\_for\_each(sk, &l->head) {+ if (s == sk) {+ read\_unlock(&l->lock);+ return true;+ }+ }++ read\_unlock(&l->lock);++ return false;+}+EXPORT\_SYMBOL(bt\_sock\_linked);+ void bt\_accept\_enqueue(struct sock \*parent, struct sock \*sk, bool bh) { const struct cred \*old\_cred;diff --git a/net/bluetooth/sco.c b/net/bluetooth/sco.cindex a5ac160c592eb9..1c7252a3686694 100644--- a/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=cfdb13a54e05eb98d9940cb6d1a13e7f994d811f)+++ b/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=80b05fbfa998480fb3d5299d93eab946f51e9c36)@@ -76,6 +76,16 @@ struct sco\_pinfo { #define SCO\_CONN\_TIMEOUT (HZ \* 40) #define SCO\_DISCONN\_TIMEOUT (HZ \* 2) +static struct sock \*sco\_sock\_hold(struct sco\_conn \*conn)+{+ if (!conn || !bt\_sock\_linked(&sco\_sk\_list, conn->sk))+ return NULL;++ sock\_hold(conn->sk);++ return conn->sk;+}+ static void sco\_sock\_timeout(struct work\_struct \*work) { struct sco\_conn \*conn = container\_of(work, struct sco\_conn,@@ -87,9 +97,7 @@ static void sco\_sock\_timeout(struct work\_struct \*work) sco\_conn\_unlock(conn); return; }- sk = conn->sk;- if (sk)- sock\_hold(sk);+ sk = sco\_sock\_hold(conn); sco\_conn\_unlock(conn);  if (!sk)@@ -194,9 +202,7 @@ static void sco\_conn\_del(struct hci\_conn \*hcon, int err)  /\* Kill socket \*/ sco\_conn\_lock(conn);- sk = conn->sk;- if (sk)- sock\_hold(sk);+ sk = sco\_sock\_hold(conn); sco\_conn\_unlock(conn);  if (sk) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:58:05 +0000



=== Content from git.kernel.org_350b6296_20250114_195929.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-10-22 12:31:08 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:30 +0100 |
| commit | [d30803f6a972b5b9e26d1d43b583c7ec151de04b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b)) | |
| tree | [ef56fdd28dbb20cb13739f786e363d9089bb48a3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b) | |
| parent | [1ba33b327c3f88a7baee598979d73ab5b44d41cc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ba33b327c3f88a7baee598979d73ab5b44d41cc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b&id2=1ba33b327c3f88a7baee598979d73ab5b44d41cc)) | |
| download | [linux-d30803f6a972b5b9e26d1d43b583c7ec151de04b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d30803f6a972b5b9e26d1d43b583c7ec151de04b.tar.gz) | |

Bluetooth: SCO: Fix UAF on sco\_sock\_timeout[ Upstream commit 1bf4470a3939c678fb822073e9ea77a0560bc6bb ]
conn->sk maybe have been unlinked/freed while waiting for sco\_conn\_lock
so this checks if the conn->sk is still valid by checking if it part of
sco\_sk\_list.
Reported-by: syzbot+4c0d0c4cde787116d465@syzkaller.appspotmail.com
Tested-by: syzbot+4c0d0c4cde787116d465@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=4c0d0c4cde787116d465
Fixes: ba316be1b6a0 ("Bluetooth: schedule SCO timeouts with delayed\_work")
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b)

| -rw-r--r-- | [include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/bluetooth.h?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/af_bluetooth.c?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/sco.c?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 35 insertions, 6 deletions

| diff --git a/include/net/bluetooth/bluetooth.h b/include/net/bluetooth/bluetooth.hindex e4a6831133f818..4763a47bf8c8a8 100644--- a/[include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/bluetooth.h?id=1ba33b327c3f88a7baee598979d73ab5b44d41cc)+++ b/[include/net/bluetooth/bluetooth.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/bluetooth.h?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b)@@ -403,6 +403,7 @@ int bt\_sock\_register(int proto, const struct net\_proto\_family \*ops); void bt\_sock\_unregister(int proto); void bt\_sock\_link(struct bt\_sock\_list \*l, struct sock \*s); void bt\_sock\_unlink(struct bt\_sock\_list \*l, struct sock \*s);+bool bt\_sock\_linked(struct bt\_sock\_list \*l, struct sock \*s); struct sock \*bt\_sock\_alloc(struct net \*net, struct socket \*sock, struct proto \*prot, int proto, gfp\_t prio, int kern); int bt\_sock\_recvmsg(struct socket \*sock, struct msghdr \*msg, size\_t len,diff --git a/net/bluetooth/af\_bluetooth.c b/net/bluetooth/af\_bluetooth.cindex e39fba5565c5d4..0b4d0a8bd36141 100644--- a/[net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/af_bluetooth.c?id=1ba33b327c3f88a7baee598979d73ab5b44d41cc)+++ b/[net/bluetooth/af\_bluetooth.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/af_bluetooth.c?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b)@@ -185,6 +185,28 @@ void bt\_sock\_unlink(struct bt\_sock\_list \*l, struct sock \*sk) } EXPORT\_SYMBOL(bt\_sock\_unlink); +bool bt\_sock\_linked(struct bt\_sock\_list \*l, struct sock \*s)+{+ struct sock \*sk;++ if (!l || !s)+ return false;++ read\_lock(&l->lock);++ sk\_for\_each(sk, &l->head) {+ if (s == sk) {+ read\_unlock(&l->lock);+ return true;+ }+ }++ read\_unlock(&l->lock);++ return false;+}+EXPORT\_SYMBOL(bt\_sock\_linked);+ void bt\_accept\_enqueue(struct sock \*parent, struct sock \*sk, bool bh) { const struct cred \*old\_cred;diff --git a/net/bluetooth/sco.c b/net/bluetooth/sco.cindex 3c3650902c8396..fb368540139a18 100644--- a/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=1ba33b327c3f88a7baee598979d73ab5b44d41cc)+++ b/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=d30803f6a972b5b9e26d1d43b583c7ec151de04b)@@ -76,6 +76,16 @@ struct sco\_pinfo { #define SCO\_CONN\_TIMEOUT (HZ \* 40) #define SCO\_DISCONN\_TIMEOUT (HZ \* 2) +static struct sock \*sco\_sock\_hold(struct sco\_conn \*conn)+{+ if (!conn || !bt\_sock\_linked(&sco\_sk\_list, conn->sk))+ return NULL;++ sock\_hold(conn->sk);++ return conn->sk;+}+ static void sco\_sock\_timeout(struct work\_struct \*work) { struct sco\_conn \*conn = container\_of(work, struct sco\_conn,@@ -87,9 +97,7 @@ static void sco\_sock\_timeout(struct work\_struct \*work) sco\_conn\_unlock(conn); return; }- sk = conn->sk;- if (sk)- sock\_hold(sk);+ sk = sco\_sock\_hold(conn); sco\_conn\_unlock(conn);  if (!sk)@@ -194,9 +202,7 @@ static void sco\_conn\_del(struct hci\_conn \*hcon, int err)  /\* Kill socket \*/ sco\_conn\_lock(conn);- sk = conn->sk;- if (sk)- sock\_hold(sk);+ sk = sco\_sock\_hold(conn); sco\_conn\_unlock(conn);  if (sk) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:58:06 +0000


