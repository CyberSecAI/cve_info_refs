=== Content from git.kernel.org_3c7d75ce_20250114_224130.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=483b7261b35a9d369082ab298a6670912243f0be)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=483b7261b35a9d369082ab298a6670912243f0be)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=483b7261b35a9d369082ab298a6670912243f0be)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=483b7261b35a9d369082ab298a6670912243f0be)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:59:37 +0100 |
| commit | [483b7261b35a9d369082ab298a6670912243f0be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=483b7261b35a9d369082ab298a6670912243f0be) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=483b7261b35a9d369082ab298a6670912243f0be)) | |
| tree | [d1f62c73f32334d80ccd708a9a37b72d35862386](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=483b7261b35a9d369082ab298a6670912243f0be) | |
| parent | [f136d8d3f26fd5113e80ba7c70f7e9a5932295b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f136d8d3f26fd5113e80ba7c70f7e9a5932295b3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=483b7261b35a9d369082ab298a6670912243f0be&id2=f136d8d3f26fd5113e80ba7c70f7e9a5932295b3)) | |
| download | [linux-483b7261b35a9d369082ab298a6670912243f0be.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-483b7261b35a9d369082ab298a6670912243f0be.tar.gz) | |

dm cache: fix potential out-of-bounds access on the first resumecommit c0ade5d98979585d4f5a93e4514c2e9a65afa08d upstream.
Out-of-bounds access occurs if the fast device is expanded unexpectedly
before the first-time resume of the cache table. This happens because
expanding the fast device requires reloading the cache table for
cache\_create to allocate new in-core data structures that fit the new
size, and the check in cache\_preresume is not performed during the
first resume, leading to the issue.
Reproduce steps:
1. prepare component devices:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
2. load a cache table of 512 cache blocks, and deliberately expand the
fast device before resuming the cache, making the in-core data
structures inadequate.
dmsetup create cache --notable
dmsetup reload cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
dmsetup reload cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
3. suspend the cache to write out the in-core dirty bitset and hint
array, leading to out-of-bounds access to the dirty bitset at offset
0x40:
dmsetup suspend cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in is\_dirty\_callback+0x2b/0x80
Read of size 8 at addr ffffc90000085040 by task dmsetup/90
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc90000085000, ffffc90000087000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc90000084f00: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000084f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
>ffffc90000085000: 00 00 00 00 00 00 00 00 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc90000085080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000085100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by checking the size change on the first resume.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=483b7261b35a9d369082ab298a6670912243f0be)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=483b7261b35a9d369082ab298a6670912243f0be) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 21 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 3a17265d811de4..63eac25ec8819b 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=f136d8d3f26fd5113e80ba7c70f7e9a5932295b3)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=483b7261b35a9d369082ab298a6670912243f0be)@@ -2955,24 +2955,24 @@ static dm\_cblock\_t get\_cache\_dev\_size(struct cache \*cache) static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) { if (from\_cblock(new\_size) > from\_cblock(cache->cache\_size)) {- if (cache->sized) {- DMERR("%s: unable to extend cache due to missing cache table reload",- cache\_device\_name(cache));- return false;- }+ DMERR("%s: unable to extend cache due to missing cache table reload",+ cache\_device\_name(cache));+ return false; }  /\* \* We can't drop a dirty block when shrinking the cache. \*/- new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,- from\_cblock(cache->cache\_size),- from\_cblock(new\_size)));- if (new\_size != cache->cache\_size) {- DMERR("%s: unable to shrink cache; cache block %llu is dirty",- cache\_device\_name(cache),- (unsigned long long) from\_cblock(new\_size));- return false;+ if (cache->loaded\_mappings) {+ new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,+ from\_cblock(cache->cache\_size),+ from\_cblock(new\_size)));+ if (new\_size != cache->cache\_size) {+ DMERR("%s: unable to shrink cache; cache block %llu is dirty",+ cache\_device\_name(cache),+ (unsigned long long) from\_cblock(new\_size));+ return false;+ } }  return true;@@ -3003,20 +3003,15 @@ static int cache\_preresume(struct dm\_target \*ti) /\* \* Check to see if the cache has resized. \*/- if (!cache->sized) {- r = resize\_cache\_dev(cache, csize);- if (r)- return r;-- cache->sized = true;-- } else if (csize != cache->cache\_size) {+ if (!cache->sized || csize != cache->cache\_size) { if (!can\_resize(cache, csize)) return -EINVAL;  r = resize\_cache\_dev(cache, csize); if (r) return r;++ cache->sized = true; }  if (!cache->loaded\_mappings) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:07 +0000



=== Content from git.kernel.org_87c6575c_20250114_224130.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:54 +0800 |
| --- | --- | --- |
| committer | Mikulas Patocka <mpatocka@redhat.com> | 2024-11-04 17:39:31 +0100 |
| commit | [c0ade5d98979585d4f5a93e4514c2e9a65afa08d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d)) | |
| tree | [7f941c9b356c7f62350ed3d4bc21e8343e8313e1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d) | |
| parent | [f484697e619a83ecc370443a34746379ad99d204](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f484697e619a83ecc370443a34746379ad99d204) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d&id2=f484697e619a83ecc370443a34746379ad99d204)) | |
| download | [linux-c0ade5d98979585d4f5a93e4514c2e9a65afa08d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c0ade5d98979585d4f5a93e4514c2e9a65afa08d.tar.gz) | |

dm cache: fix potential out-of-bounds access on the first resumeOut-of-bounds access occurs if the fast device is expanded unexpectedly
before the first-time resume of the cache table. This happens because
expanding the fast device requires reloading the cache table for
cache\_create to allocate new in-core data structures that fit the new
size, and the check in cache\_preresume is not performed during the
first resume, leading to the issue.
Reproduce steps:
1. prepare component devices:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
2. load a cache table of 512 cache blocks, and deliberately expand the
fast device before resuming the cache, making the in-core data
structures inadequate.
dmsetup create cache --notable
dmsetup reload cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
dmsetup reload cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
3. suspend the cache to write out the in-core dirty bitset and hint
array, leading to out-of-bounds access to the dirty bitset at offset
0x40:
dmsetup suspend cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in is\_dirty\_callback+0x2b/0x80
Read of size 8 at addr ffffc90000085040 by task dmsetup/90
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc90000085000, ffffc90000087000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc90000084f00: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000084f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
>ffffc90000085000: 00 00 00 00 00 00 00 00 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc90000085080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000085100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by checking the size change on the first resume.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 21 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex fa8ef2c32af891..40709310e3275a 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=f484697e619a83ecc370443a34746379ad99d204)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=c0ade5d98979585d4f5a93e4514c2e9a65afa08d)@@ -2901,24 +2901,24 @@ static dm\_cblock\_t get\_cache\_dev\_size(struct cache \*cache) static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) { if (from\_cblock(new\_size) > from\_cblock(cache->cache\_size)) {- if (cache->sized) {- DMERR("%s: unable to extend cache due to missing cache table reload",- cache\_device\_name(cache));- return false;- }+ DMERR("%s: unable to extend cache due to missing cache table reload",+ cache\_device\_name(cache));+ return false; }  /\* \* We can't drop a dirty block when shrinking the cache. \*/- new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,- from\_cblock(cache->cache\_size),- from\_cblock(new\_size)));- if (new\_size != cache->cache\_size) {- DMERR("%s: unable to shrink cache; cache block %llu is dirty",- cache\_device\_name(cache),- (unsigned long long) from\_cblock(new\_size));- return false;+ if (cache->loaded\_mappings) {+ new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,+ from\_cblock(cache->cache\_size),+ from\_cblock(new\_size)));+ if (new\_size != cache->cache\_size) {+ DMERR("%s: unable to shrink cache; cache block %llu is dirty",+ cache\_device\_name(cache),+ (unsigned long long) from\_cblock(new\_size));+ return false;+ } }  return true;@@ -2949,20 +2949,15 @@ static int cache\_preresume(struct dm\_target \*ti) /\* \* Check to see if the cache has resized. \*/- if (!cache->sized) {- r = resize\_cache\_dev(cache, csize);- if (r)- return r;-- cache->sized = true;-- } else if (csize != cache->cache\_size) {+ if (!cache->sized || csize != cache->cache\_size) { if (!can\_resize(cache, csize)) return -EINVAL;  r = resize\_cache\_dev(cache, csize); if (r) return r;++ cache->sized = true; }  if (!cache->loaded\_mappings) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:07 +0000



=== Content from git.kernel.org_e16a2c68_20250114_224132.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:06 +0100 |
| commit | [e492f71854ce03474d49e87fd98b8df1f7cd1d2d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d)) | |
| tree | [ac81ea95752cb6f2b120b35a19deb25e3b319075](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d) | |
| parent | [c90c5e02556d2781b6506ab4b8dd7613d9008bcd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c90c5e02556d2781b6506ab4b8dd7613d9008bcd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d&id2=c90c5e02556d2781b6506ab4b8dd7613d9008bcd)) | |
| download | [linux-e492f71854ce03474d49e87fd98b8df1f7cd1d2d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e492f71854ce03474d49e87fd98b8df1f7cd1d2d.tar.gz) | |

dm cache: fix potential out-of-bounds access on the first resumecommit c0ade5d98979585d4f5a93e4514c2e9a65afa08d upstream.
Out-of-bounds access occurs if the fast device is expanded unexpectedly
before the first-time resume of the cache table. This happens because
expanding the fast device requires reloading the cache table for
cache\_create to allocate new in-core data structures that fit the new
size, and the check in cache\_preresume is not performed during the
first resume, leading to the issue.
Reproduce steps:
1. prepare component devices:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
2. load a cache table of 512 cache blocks, and deliberately expand the
fast device before resuming the cache, making the in-core data
structures inadequate.
dmsetup create cache --notable
dmsetup reload cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
dmsetup reload cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
3. suspend the cache to write out the in-core dirty bitset and hint
array, leading to out-of-bounds access to the dirty bitset at offset
0x40:
dmsetup suspend cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in is\_dirty\_callback+0x2b/0x80
Read of size 8 at addr ffffc90000085040 by task dmsetup/90
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc90000085000, ffffc90000087000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc90000084f00: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000084f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
>ffffc90000085000: 00 00 00 00 00 00 00 00 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc90000085080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000085100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by checking the size change on the first resume.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 21 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex fe3213e5669e02..016212f9991d7f 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=c90c5e02556d2781b6506ab4b8dd7613d9008bcd)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=e492f71854ce03474d49e87fd98b8df1f7cd1d2d)@@ -2991,24 +2991,24 @@ static dm\_cblock\_t get\_cache\_dev\_size(struct cache \*cache) static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) { if (from\_cblock(new\_size) > from\_cblock(cache->cache\_size)) {- if (cache->sized) {- DMERR("%s: unable to extend cache due to missing cache table reload",- cache\_device\_name(cache));- return false;- }+ DMERR("%s: unable to extend cache due to missing cache table reload",+ cache\_device\_name(cache));+ return false; }  /\* \* We can't drop a dirty block when shrinking the cache. \*/- new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,- from\_cblock(cache->cache\_size),- from\_cblock(new\_size)));- if (new\_size != cache->cache\_size) {- DMERR("%s: unable to shrink cache; cache block %llu is dirty",- cache\_device\_name(cache),- (unsigned long long) from\_cblock(new\_size));- return false;+ if (cache->loaded\_mappings) {+ new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,+ from\_cblock(cache->cache\_size),+ from\_cblock(new\_size)));+ if (new\_size != cache->cache\_size) {+ DMERR("%s: unable to shrink cache; cache block %llu is dirty",+ cache\_device\_name(cache),+ (unsigned long long) from\_cblock(new\_size));+ return false;+ } }  return true;@@ -3039,20 +3039,15 @@ static int cache\_preresume(struct dm\_target \*ti) /\* \* Check to see if the cache has resized. \*/- if (!cache->sized) {- r = resize\_cache\_dev(cache, csize);- if (r)- return r;-- cache->sized = true;-- } else if (csize != cache->cache\_size) {+ if (!cache->sized || csize != cache->cache\_size) { if (!can\_resize(cache, csize)) return -EINVAL;  r = resize\_cache\_dev(cache, csize); if (r) return r;++ cache->sized = true; }  if (!cache->loaded\_mappings) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:10 +0000



=== Content from git.kernel.org_6f9bdc37_20250114_224127.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=036dd6e3d2638103e0092864577ea1d091466b86)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=036dd6e3d2638103e0092864577ea1d091466b86)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=036dd6e3d2638103e0092864577ea1d091466b86)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=036dd6e3d2638103e0092864577ea1d091466b86)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:19:37 +0100 |
| commit | [036dd6e3d2638103e0092864577ea1d091466b86](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=036dd6e3d2638103e0092864577ea1d091466b86) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=036dd6e3d2638103e0092864577ea1d091466b86)) | |
| tree | [7557f4f82bcc2879ba7dc0cd292c440727663db5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=036dd6e3d2638103e0092864577ea1d091466b86) | |
| parent | [53421c3c0ee04bd2bf7080d2ac157a419cf89c91](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53421c3c0ee04bd2bf7080d2ac157a419cf89c91) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=036dd6e3d2638103e0092864577ea1d091466b86&id2=53421c3c0ee04bd2bf7080d2ac157a419cf89c91)) | |
| download | [linux-036dd6e3d2638103e0092864577ea1d091466b86.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-036dd6e3d2638103e0092864577ea1d091466b86.tar.gz) | |

dm cache: fix potential out-of-bounds access on the first resumecommit c0ade5d98979585d4f5a93e4514c2e9a65afa08d upstream.
Out-of-bounds access occurs if the fast device is expanded unexpectedly
before the first-time resume of the cache table. This happens because
expanding the fast device requires reloading the cache table for
cache\_create to allocate new in-core data structures that fit the new
size, and the check in cache\_preresume is not performed during the
first resume, leading to the issue.
Reproduce steps:
1. prepare component devices:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
2. load a cache table of 512 cache blocks, and deliberately expand the
fast device before resuming the cache, making the in-core data
structures inadequate.
dmsetup create cache --notable
dmsetup reload cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
dmsetup reload cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
3. suspend the cache to write out the in-core dirty bitset and hint
array, leading to out-of-bounds access to the dirty bitset at offset
0x40:
dmsetup suspend cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in is\_dirty\_callback+0x2b/0x80
Read of size 8 at addr ffffc90000085040 by task dmsetup/90
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc90000085000, ffffc90000087000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc90000084f00: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000084f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
>ffffc90000085000: 00 00 00 00 00 00 00 00 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc90000085080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000085100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by checking the size change on the first resume.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=036dd6e3d2638103e0092864577ea1d091466b86)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=036dd6e3d2638103e0092864577ea1d091466b86) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 21 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 2923e292eb7226..fb809b46d6aa76 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=53421c3c0ee04bd2bf7080d2ac157a419cf89c91)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=036dd6e3d2638103e0092864577ea1d091466b86)@@ -2905,24 +2905,24 @@ static dm\_cblock\_t get\_cache\_dev\_size(struct cache \*cache) static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) { if (from\_cblock(new\_size) > from\_cblock(cache->cache\_size)) {- if (cache->sized) {- DMERR("%s: unable to extend cache due to missing cache table reload",- cache\_device\_name(cache));- return false;- }+ DMERR("%s: unable to extend cache due to missing cache table reload",+ cache\_device\_name(cache));+ return false; }  /\* \* We can't drop a dirty block when shrinking the cache. \*/- new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,- from\_cblock(cache->cache\_size),- from\_cblock(new\_size)));- if (new\_size != cache->cache\_size) {- DMERR("%s: unable to shrink cache; cache block %llu is dirty",- cache\_device\_name(cache),- (unsigned long long) from\_cblock(new\_size));- return false;+ if (cache->loaded\_mappings) {+ new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,+ from\_cblock(cache->cache\_size),+ from\_cblock(new\_size)));+ if (new\_size != cache->cache\_size) {+ DMERR("%s: unable to shrink cache; cache block %llu is dirty",+ cache\_device\_name(cache),+ (unsigned long long) from\_cblock(new\_size));+ return false;+ } }  return true;@@ -2953,20 +2953,15 @@ static int cache\_preresume(struct dm\_target \*ti) /\* \* Check to see if the cache has resized. \*/- if (!cache->sized) {- r = resize\_cache\_dev(cache, csize);- if (r)- return r;-- cache->sized = true;-- } else if (csize != cache->cache\_size) {+ if (!cache->sized || csize != cache->cache\_size) { if (!can\_resize(cache, csize)) return -EINVAL;  r = resize\_cache\_dev(cache, csize); if (r) return r;++ cache->sized = true; }  if (!cache->loaded\_mappings) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:05 +0000



=== Content from git.kernel.org_0f781b22_20250114_224134.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:13:39 +0100 |
| commit | [fdef3b94dfebd57e3077a578b6e309a2bb6fa688](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688)) | |
| tree | [8a6b1d59dcd4493234e47ae94229f6181a19ef33](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688) | |
| parent | [01c4e15a45bb7d57192a2fc26133177d40bce33b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01c4e15a45bb7d57192a2fc26133177d40bce33b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688&id2=01c4e15a45bb7d57192a2fc26133177d40bce33b)) | |
| download | [linux-fdef3b94dfebd57e3077a578b6e309a2bb6fa688.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fdef3b94dfebd57e3077a578b6e309a2bb6fa688.tar.gz) | |

dm cache: fix potential out-of-bounds access on the first resumecommit c0ade5d98979585d4f5a93e4514c2e9a65afa08d upstream.
Out-of-bounds access occurs if the fast device is expanded unexpectedly
before the first-time resume of the cache table. This happens because
expanding the fast device requires reloading the cache table for
cache\_create to allocate new in-core data structures that fit the new
size, and the check in cache\_preresume is not performed during the
first resume, leading to the issue.
Reproduce steps:
1. prepare component devices:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
2. load a cache table of 512 cache blocks, and deliberately expand the
fast device before resuming the cache, making the in-core data
structures inadequate.
dmsetup create cache --notable
dmsetup reload cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
dmsetup reload cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
3. suspend the cache to write out the in-core dirty bitset and hint
array, leading to out-of-bounds access to the dirty bitset at offset
0x40:
dmsetup suspend cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in is\_dirty\_callback+0x2b/0x80
Read of size 8 at addr ffffc90000085040 by task dmsetup/90
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc90000085000, ffffc90000087000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc90000084f00: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000084f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
>ffffc90000085000: 00 00 00 00 00 00 00 00 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc90000085080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000085100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by checking the size change on the first resume.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 21 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex b4811679fe5610..31c4100d38c1ae 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=01c4e15a45bb7d57192a2fc26133177d40bce33b)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=fdef3b94dfebd57e3077a578b6e309a2bb6fa688)@@ -2880,24 +2880,24 @@ static dm\_cblock\_t get\_cache\_dev\_size(struct cache \*cache) static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) { if (from\_cblock(new\_size) > from\_cblock(cache->cache\_size)) {- if (cache->sized) {- DMERR("%s: unable to extend cache due to missing cache table reload",- cache\_device\_name(cache));- return false;- }+ DMERR("%s: unable to extend cache due to missing cache table reload",+ cache\_device\_name(cache));+ return false; }  /\* \* We can't drop a dirty block when shrinking the cache. \*/- new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,- from\_cblock(cache->cache\_size),- from\_cblock(new\_size)));- if (new\_size != cache->cache\_size) {- DMERR("%s: unable to shrink cache; cache block %llu is dirty",- cache\_device\_name(cache),- (unsigned long long) from\_cblock(new\_size));- return false;+ if (cache->loaded\_mappings) {+ new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,+ from\_cblock(cache->cache\_size),+ from\_cblock(new\_size)));+ if (new\_size != cache->cache\_size) {+ DMERR("%s: unable to shrink cache; cache block %llu is dirty",+ cache\_device\_name(cache),+ (unsigned long long) from\_cblock(new\_size));+ return false;+ } }  return true;@@ -2928,20 +2928,15 @@ static int cache\_preresume(struct dm\_target \*ti) /\* \* Check to see if the cache has resized. \*/- if (!cache->sized) {- r = resize\_cache\_dev(cache, csize);- if (r)- return r;-- cache->sized = true;-- } else if (csize != cache->cache\_size) {+ if (!cache->sized || csize != cache->cache\_size) { if (!can\_resize(cache, csize)) return -EINVAL;  r = resize\_cache\_dev(cache, csize); if (r) return r;++ cache->sized = true; }  if (!cache->loaded\_mappings) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:11 +0000



=== Content from git.kernel.org_6c21cafe_20250114_224129.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2222b0929d00e2d13732b799b63be391b5de4492)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2222b0929d00e2d13732b799b63be391b5de4492)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2222b0929d00e2d13732b799b63be391b5de4492)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2222b0929d00e2d13732b799b63be391b5de4492)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:51 +0100 |
| commit | [2222b0929d00e2d13732b799b63be391b5de4492](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2222b0929d00e2d13732b799b63be391b5de4492) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2222b0929d00e2d13732b799b63be391b5de4492)) | |
| tree | [7002b92909da1ace40e708b8c09df30d8d5133a6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2222b0929d00e2d13732b799b63be391b5de4492) | |
| parent | [8c3400a7fb262948e21566d2fe2930fc40f7df53](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c3400a7fb262948e21566d2fe2930fc40f7df53) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2222b0929d00e2d13732b799b63be391b5de4492&id2=8c3400a7fb262948e21566d2fe2930fc40f7df53)) | |
| download | [linux-2222b0929d00e2d13732b799b63be391b5de4492.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2222b0929d00e2d13732b799b63be391b5de4492.tar.gz) | |

dm cache: fix potential out-of-bounds access on the first resumecommit c0ade5d98979585d4f5a93e4514c2e9a65afa08d upstream.
Out-of-bounds access occurs if the fast device is expanded unexpectedly
before the first-time resume of the cache table. This happens because
expanding the fast device requires reloading the cache table for
cache\_create to allocate new in-core data structures that fit the new
size, and the check in cache\_preresume is not performed during the
first resume, leading to the issue.
Reproduce steps:
1. prepare component devices:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
2. load a cache table of 512 cache blocks, and deliberately expand the
fast device before resuming the cache, making the in-core data
structures inadequate.
dmsetup create cache --notable
dmsetup reload cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
dmsetup reload cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
3. suspend the cache to write out the in-core dirty bitset and hint
array, leading to out-of-bounds access to the dirty bitset at offset
0x40:
dmsetup suspend cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in is\_dirty\_callback+0x2b/0x80
Read of size 8 at addr ffffc90000085040 by task dmsetup/90
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc90000085000, ffffc90000087000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc90000084f00: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000084f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
>ffffc90000085000: 00 00 00 00 00 00 00 00 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc90000085080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000085100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by checking the size change on the first resume.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2222b0929d00e2d13732b799b63be391b5de4492)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=2222b0929d00e2d13732b799b63be391b5de4492) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 21 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex e2f54e789bac8b..c1d2e3376afcd4 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=8c3400a7fb262948e21566d2fe2930fc40f7df53)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=2222b0929d00e2d13732b799b63be391b5de4492)@@ -2999,24 +2999,24 @@ static dm\_cblock\_t get\_cache\_dev\_size(struct cache \*cache) static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) { if (from\_cblock(new\_size) > from\_cblock(cache->cache\_size)) {- if (cache->sized) {- DMERR("%s: unable to extend cache due to missing cache table reload",- cache\_device\_name(cache));- return false;- }+ DMERR("%s: unable to extend cache due to missing cache table reload",+ cache\_device\_name(cache));+ return false; }  /\* \* We can't drop a dirty block when shrinking the cache. \*/- new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,- from\_cblock(cache->cache\_size),- from\_cblock(new\_size)));- if (new\_size != cache->cache\_size) {- DMERR("%s: unable to shrink cache; cache block %llu is dirty",- cache\_device\_name(cache),- (unsigned long long) from\_cblock(new\_size));- return false;+ if (cache->loaded\_mappings) {+ new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,+ from\_cblock(cache->cache\_size),+ from\_cblock(new\_size)));+ if (new\_size != cache->cache\_size) {+ DMERR("%s: unable to shrink cache; cache block %llu is dirty",+ cache\_device\_name(cache),+ (unsigned long long) from\_cblock(new\_size));+ return false;+ } }  return true;@@ -3047,20 +3047,15 @@ static int cache\_preresume(struct dm\_target \*ti) /\* \* Check to see if the cache has resized. \*/- if (!cache->sized) {- r = resize\_cache\_dev(cache, csize);- if (r)- return r;-- cache->sized = true;-- } else if (csize != cache->cache\_size) {+ if (!cache->sized || csize != cache->cache\_size) { if (!can\_resize(cache, csize)) return -EINVAL;  r = resize\_cache\_dev(cache, csize); if (r) return r;++ cache->sized = true; }  if (!cache->loaded\_mappings) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:06 +0000



=== Content from git.kernel.org_f42949eb_20250114_224131.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:15:15 +0100 |
| commit | [c52ec00cb2f9bebfada22edcc0db385b910a1cdb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb)) | |
| tree | [3fbec2fa5f37ba760e545888a930e5798450fc11](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb) | |
| parent | [011450c2f96ca4f6f642778d5d67ca42b370e7e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=011450c2f96ca4f6f642778d5d67ca42b370e7e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb&id2=011450c2f96ca4f6f642778d5d67ca42b370e7e2)) | |
| download | [linux-c52ec00cb2f9bebfada22edcc0db385b910a1cdb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c52ec00cb2f9bebfada22edcc0db385b910a1cdb.tar.gz) | |

dm cache: fix potential out-of-bounds access on the first resumecommit c0ade5d98979585d4f5a93e4514c2e9a65afa08d upstream.
Out-of-bounds access occurs if the fast device is expanded unexpectedly
before the first-time resume of the cache table. This happens because
expanding the fast device requires reloading the cache table for
cache\_create to allocate new in-core data structures that fit the new
size, and the check in cache\_preresume is not performed during the
first resume, leading to the issue.
Reproduce steps:
1. prepare component devices:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
2. load a cache table of 512 cache blocks, and deliberately expand the
fast device before resuming the cache, making the in-core data
structures inadequate.
dmsetup create cache --notable
dmsetup reload cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
dmsetup reload cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
3. suspend the cache to write out the in-core dirty bitset and hint
array, leading to out-of-bounds access to the dirty bitset at offset
0x40:
dmsetup suspend cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in is\_dirty\_callback+0x2b/0x80
Read of size 8 at addr ffffc90000085040 by task dmsetup/90
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc90000085000, ffffc90000087000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc90000084f00: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000084f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
>ffffc90000085000: 00 00 00 00 00 00 00 00 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc90000085080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000085100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by checking the size change on the first resume.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 21 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex f852e27231f03b..e714114d495a95 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=011450c2f96ca4f6f642778d5d67ca42b370e7e2)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=c52ec00cb2f9bebfada22edcc0db385b910a1cdb)@@ -2878,24 +2878,24 @@ static dm\_cblock\_t get\_cache\_dev\_size(struct cache \*cache) static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) { if (from\_cblock(new\_size) > from\_cblock(cache->cache\_size)) {- if (cache->sized) {- DMERR("%s: unable to extend cache due to missing cache table reload",- cache\_device\_name(cache));- return false;- }+ DMERR("%s: unable to extend cache due to missing cache table reload",+ cache\_device\_name(cache));+ return false; }  /\* \* We can't drop a dirty block when shrinking the cache. \*/- new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,- from\_cblock(cache->cache\_size),- from\_cblock(new\_size)));- if (new\_size != cache->cache\_size) {- DMERR("%s: unable to shrink cache; cache block %llu is dirty",- cache\_device\_name(cache),- (unsigned long long) from\_cblock(new\_size));- return false;+ if (cache->loaded\_mappings) {+ new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,+ from\_cblock(cache->cache\_size),+ from\_cblock(new\_size)));+ if (new\_size != cache->cache\_size) {+ DMERR("%s: unable to shrink cache; cache block %llu is dirty",+ cache\_device\_name(cache),+ (unsigned long long) from\_cblock(new\_size));+ return false;+ } }  return true;@@ -2926,20 +2926,15 @@ static int cache\_preresume(struct dm\_target \*ti) /\* \* Check to see if the cache has resized. \*/- if (!cache->sized) {- r = resize\_cache\_dev(cache, csize);- if (r)- return r;-- cache->sized = true;-- } else if (csize != cache->cache\_size) {+ if (!cache->sized || csize != cache->cache\_size) { if (!can\_resize(cache, csize)) return -EINVAL;  r = resize\_cache\_dev(cache, csize); if (r) return r;++ cache->sized = true; }  if (!cache->loaded\_mappings) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:08 +0000



=== Content from git.kernel.org_86efa797_20250114_224128.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming-Hung Tsai <mtsai@redhat.com> | 2024-10-22 15:13:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:08 +0100 |
| commit | [13ed3624c6ef283acefa4cc42cc8ae54fd4391a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4)) | |
| tree | [25fa979574d8be548ed5e4ba9747264e51543bd7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4) | |
| parent | [59fa772120ed02e598fdd815a8f8694e5428333f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59fa772120ed02e598fdd815a8f8694e5428333f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4&id2=59fa772120ed02e598fdd815a8f8694e5428333f)) | |
| download | [linux-13ed3624c6ef283acefa4cc42cc8ae54fd4391a4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-13ed3624c6ef283acefa4cc42cc8ae54fd4391a4.tar.gz) | |

dm cache: fix potential out-of-bounds access on the first resumecommit c0ade5d98979585d4f5a93e4514c2e9a65afa08d upstream.
Out-of-bounds access occurs if the fast device is expanded unexpectedly
before the first-time resume of the cache table. This happens because
expanding the fast device requires reloading the cache table for
cache\_create to allocate new in-core data structures that fit the new
size, and the check in cache\_preresume is not performed during the
first resume, leading to the issue.
Reproduce steps:
1. prepare component devices:
dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
dd if=/dev/zero of=/dev/mapper/cmeta bs=4k count=1 oflag=direct
2. load a cache table of 512 cache blocks, and deliberately expand the
fast device before resuming the cache, making the in-core data
structures inadequate.
dmsetup create cache --notable
dmsetup reload cache --table "0 524288 cache /dev/mapper/cmeta \
/dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
dmsetup reload cdata --table "0 131072 linear /dev/sdc 8192"
dmsetup resume cdata
dmsetup resume cache
3. suspend the cache to write out the in-core dirty bitset and hint
array, leading to out-of-bounds access to the dirty bitset at offset
0x40:
dmsetup suspend cache
KASAN reports:
BUG: KASAN: vmalloc-out-of-bounds in is\_dirty\_callback+0x2b/0x80
Read of size 8 at addr ffffc90000085040 by task dmsetup/90
(...snip...)
The buggy address belongs to the virtual mapping at
[ffffc90000085000, ffffc90000087000) created by:
cache\_ctr+0x176a/0x35f0
(...snip...)
Memory state around the buggy address:
ffffc90000084f00: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000084f80: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
>ffffc90000085000: 00 00 00 00 00 00 00 00 f8 f8 f8 f8 f8 f8 f8 f8
^
ffffc90000085080: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
ffffc90000085100: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8
Fix by checking the size change on the first resume.
Signed-off-by: Ming-Hung Tsai <mtsai@redhat.com>
Fixes: f494a9c6b1b6 ("dm cache: cache shrinking support")
Cc: stable@vger.kernel.org
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Joe Thornber <thornber@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4)

| -rw-r--r-- | [drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-cache-target.c?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 21 deletions

| diff --git a/drivers/md/dm-cache-target.c b/drivers/md/dm-cache-target.cindex 8a7ae77df47fb6..8c0ede33af6fb5 100644--- a/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=59fa772120ed02e598fdd815a8f8694e5428333f)+++ b/[drivers/md/dm-cache-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-cache-target.c?id=13ed3624c6ef283acefa4cc42cc8ae54fd4391a4)@@ -2901,24 +2901,24 @@ static dm\_cblock\_t get\_cache\_dev\_size(struct cache \*cache) static bool can\_resize(struct cache \*cache, dm\_cblock\_t new\_size) { if (from\_cblock(new\_size) > from\_cblock(cache->cache\_size)) {- if (cache->sized) {- DMERR("%s: unable to extend cache due to missing cache table reload",- cache\_device\_name(cache));- return false;- }+ DMERR("%s: unable to extend cache due to missing cache table reload",+ cache\_device\_name(cache));+ return false; }  /\* \* We can't drop a dirty block when shrinking the cache. \*/- new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,- from\_cblock(cache->cache\_size),- from\_cblock(new\_size)));- if (new\_size != cache->cache\_size) {- DMERR("%s: unable to shrink cache; cache block %llu is dirty",- cache\_device\_name(cache),- (unsigned long long) from\_cblock(new\_size));- return false;+ if (cache->loaded\_mappings) {+ new\_size = to\_cblock(find\_next\_bit(cache->dirty\_bitset,+ from\_cblock(cache->cache\_size),+ from\_cblock(new\_size)));+ if (new\_size != cache->cache\_size) {+ DMERR("%s: unable to shrink cache; cache block %llu is dirty",+ cache\_device\_name(cache),+ (unsigned long long) from\_cblock(new\_size));+ return false;+ } }  return true;@@ -2949,20 +2949,15 @@ static int cache\_preresume(struct dm\_target \*ti) /\* \* Check to see if the cache has resized. \*/- if (!cache->sized) {- r = resize\_cache\_dev(cache, csize);- if (r)- return r;-- cache->sized = true;-- } else if (csize != cache->cache\_size) {+ if (!cache->sized || csize != cache->cache\_size) { if (!can\_resize(cache, csize)) return -EINVAL;  r = resize\_cache\_dev(cache, csize); if (r) return r;++ cache->sized = true; }  if (!cache->loaded\_mappings) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:40:05 +0000


