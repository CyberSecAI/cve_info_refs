=== Content from git.kernel.org_3b1254b1_20250114_203629.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=75452da51e2403e14be007df80d133e1443fc967)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=75452da51e2403e14be007df80d133e1443fc967)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=75452da51e2403e14be007df80d133e1443fc967)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=75452da51e2403e14be007df80d133e1443fc967)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maíra Canal <mcanal@igalia.com> | 2024-10-04 09:36:00 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:26 +0200 |
| commit | [75452da51e2403e14be007df80d133e1443fc967](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=75452da51e2403e14be007df80d133e1443fc967) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=75452da51e2403e14be007df80d133e1443fc967)) | |
| tree | [eb122188794d209bcbcda7a565c54e8352095289](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=75452da51e2403e14be007df80d133e1443fc967) | |
| parent | [0c9e9a3a4873705740b19300cadc6599170646ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c9e9a3a4873705740b19300cadc6599170646ef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=75452da51e2403e14be007df80d133e1443fc967&id2=0c9e9a3a4873705740b19300cadc6599170646ef)) | |
| download | [linux-75452da51e2403e14be007df80d133e1443fc967.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-75452da51e2403e14be007df80d133e1443fc967.tar.gz) | |

drm/vc4: Stop the active perfmon before being destroyedcommit 0b2ad4f6f2bec74a5287d96cb2325a5e11706f22 upstream.
Upon closing the file descriptor, the active performance monitor is not
stopped. Although all perfmons are destroyed in `vc4\_perfmon\_close\_file()`,
the active performance monitor's pointer (`vc4->active\_perfmon`) is still
retained.
If we open a new file descriptor and submit a few jobs with performance
monitors, the driver will attempt to stop the active performance monitor
using the stale pointer in `vc4->active\_perfmon`. However, this pointer
is no longer valid because the previous process has already terminated,
and all performance monitors associated with it have been destroyed and
freed.
To fix this, when the active performance monitor belongs to a given
process, explicitly stop it before destroying and freeing it.
Cc: stable@vger.kernel.org # v4.17+
Cc: Boris Brezillon <bbrezillon@kernel.org>
Cc: Juan A. Suarez Romero <jasuarez@igalia.com>
Fixes: 65101d8c9108 ("drm/vc4: Expose performance counters to userspace")
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Reviewed-by: Juan A. Suarez <jasuarez@igalia.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20241004123817.890016-2-mcanal@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20241004123817.890016-2-mcanal%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=75452da51e2403e14be007df80d133e1443fc967)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_perfmon.c?id=75452da51e2403e14be007df80d133e1443fc967) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_perfmon.c b/drivers/gpu/drm/vc4/vc4\_perfmon.cindex c4ac2c94623815..c00a5cc2316d20 100644--- a/[drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_perfmon.c?id=0c9e9a3a4873705740b19300cadc6599170646ef)+++ b/[drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_perfmon.c?id=75452da51e2403e14be007df80d133e1443fc967)@@ -116,6 +116,11 @@ void vc4\_perfmon\_open\_file(struct vc4\_file \*vc4file) static int vc4\_perfmon\_idr\_del(int id, void \*elem, void \*data) { struct vc4\_perfmon \*perfmon = elem;+ struct vc4\_dev \*vc4 = (struct vc4\_dev \*)data;++ /\* If the active perfmon is being destroyed, stop it first \*/+ if (perfmon == vc4->active\_perfmon)+ vc4\_perfmon\_stop(vc4, perfmon, false);  vc4\_perfmon\_put(perfmon); @@ -130,7 +135,7 @@ void vc4\_perfmon\_close\_file(struct vc4\_file \*vc4file) return;  mutex\_lock(&vc4file->perfmon.lock);- idr\_for\_each(&vc4file->perfmon.idr, vc4\_perfmon\_idr\_del, NULL);+ idr\_for\_each(&vc4file->perfmon.idr, vc4\_perfmon\_idr\_del, vc4); idr\_destroy(&vc4file->perfmon.idr); mutex\_unlock(&vc4file->perfmon.lock); mutex\_destroy(&vc4file->perfmon.lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:35:06 +0000



=== Content from git.kernel.org_97655308_20250114_203630.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maíra Canal <mcanal@igalia.com> | 2024-10-04 09:36:00 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:26:56 +0200 |
| commit | [c9adba739d5f7cdc47a7754df4a17b47b1ecf513](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513)) | |
| tree | [69054f5f1d5221fd95840c022c5c9caf5dbc77e4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513) | |
| parent | [333767cbce6ac20ec794c76eec82ed0ef55022db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=333767cbce6ac20ec794c76eec82ed0ef55022db) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513&id2=333767cbce6ac20ec794c76eec82ed0ef55022db)) | |
| download | [linux-c9adba739d5f7cdc47a7754df4a17b47b1ecf513.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c9adba739d5f7cdc47a7754df4a17b47b1ecf513.tar.gz) | |

drm/vc4: Stop the active perfmon before being destroyedcommit 0b2ad4f6f2bec74a5287d96cb2325a5e11706f22 upstream.
Upon closing the file descriptor, the active performance monitor is not
stopped. Although all perfmons are destroyed in `vc4\_perfmon\_close\_file()`,
the active performance monitor's pointer (`vc4->active\_perfmon`) is still
retained.
If we open a new file descriptor and submit a few jobs with performance
monitors, the driver will attempt to stop the active performance monitor
using the stale pointer in `vc4->active\_perfmon`. However, this pointer
is no longer valid because the previous process has already terminated,
and all performance monitors associated with it have been destroyed and
freed.
To fix this, when the active performance monitor belongs to a given
process, explicitly stop it before destroying and freeing it.
Cc: stable@vger.kernel.org # v4.17+
Cc: Boris Brezillon <bbrezillon@kernel.org>
Cc: Juan A. Suarez Romero <jasuarez@igalia.com>
Fixes: 65101d8c9108 ("drm/vc4: Expose performance counters to userspace")
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Reviewed-by: Juan A. Suarez <jasuarez@igalia.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20241004123817.890016-2-mcanal@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20241004123817.890016-2-mcanal%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_perfmon.c?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_perfmon.c b/drivers/gpu/drm/vc4/vc4\_perfmon.cindex c4ac2c94623815..c00a5cc2316d20 100644--- a/[drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_perfmon.c?id=333767cbce6ac20ec794c76eec82ed0ef55022db)+++ b/[drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_perfmon.c?id=c9adba739d5f7cdc47a7754df4a17b47b1ecf513)@@ -116,6 +116,11 @@ void vc4\_perfmon\_open\_file(struct vc4\_file \*vc4file) static int vc4\_perfmon\_idr\_del(int id, void \*elem, void \*data) { struct vc4\_perfmon \*perfmon = elem;+ struct vc4\_dev \*vc4 = (struct vc4\_dev \*)data;++ /\* If the active perfmon is being destroyed, stop it first \*/+ if (perfmon == vc4->active\_perfmon)+ vc4\_perfmon\_stop(vc4, perfmon, false);  vc4\_perfmon\_put(perfmon); @@ -130,7 +135,7 @@ void vc4\_perfmon\_close\_file(struct vc4\_file \*vc4file) return;  mutex\_lock(&vc4file->perfmon.lock);- idr\_for\_each(&vc4file->perfmon.idr, vc4\_perfmon\_idr\_del, NULL);+ idr\_for\_each(&vc4file->perfmon.idr, vc4\_perfmon\_idr\_del, vc4); idr\_destroy(&vc4file->perfmon.idr); mutex\_unlock(&vc4file->perfmon.lock); mutex\_destroy(&vc4file->perfmon.lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:35:07 +0000



=== Content from git.kernel.org_bc4c5785_20250114_203628.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maíra Canal <mcanal@igalia.com> | 2024-10-04 09:36:00 -0300 |
| --- | --- | --- |
| committer | Maíra Canal <mcanal@igalia.com> | 2024-10-07 09:06:46 -0300 |
| commit | [0b2ad4f6f2bec74a5287d96cb2325a5e11706f22](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22)) | |
| tree | [ba2465b3156b5dd975f98dbcdf326ae1389ed3b1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22) | |
| parent | [7d1fd3638ee3a9f9bca4785fffb638ca19120718](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d1fd3638ee3a9f9bca4785fffb638ca19120718) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22&id2=7d1fd3638ee3a9f9bca4785fffb638ca19120718)) | |
| download | [linux-0b2ad4f6f2bec74a5287d96cb2325a5e11706f22.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0b2ad4f6f2bec74a5287d96cb2325a5e11706f22.tar.gz) | |

drm/vc4: Stop the active perfmon before being destroyedUpon closing the file descriptor, the active performance monitor is not
stopped. Although all perfmons are destroyed in `vc4\_perfmon\_close\_file()`,
the active performance monitor's pointer (`vc4->active\_perfmon`) is still
retained.
If we open a new file descriptor and submit a few jobs with performance
monitors, the driver will attempt to stop the active performance monitor
using the stale pointer in `vc4->active\_perfmon`. However, this pointer
is no longer valid because the previous process has already terminated,
and all performance monitors associated with it have been destroyed and
freed.
To fix this, when the active performance monitor belongs to a given
process, explicitly stop it before destroying and freeing it.
Cc: stable@vger.kernel.org # v4.17+
Cc: Boris Brezillon <bbrezillon@kernel.org>
Cc: Juan A. Suarez Romero <jasuarez@igalia.com>
Fixes: 65101d8c9108 ("drm/vc4: Expose performance counters to userspace")
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Reviewed-by: Juan A. Suarez <jasuarez@igalia.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20241004123817.890016-2-mcanal@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20241004123817.890016-2-mcanal%40igalia.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_perfmon.c?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_perfmon.c b/drivers/gpu/drm/vc4/vc4\_perfmon.cindex c4ac2c94623815..c00a5cc2316d20 100644--- a/[drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_perfmon.c?id=7d1fd3638ee3a9f9bca4785fffb638ca19120718)+++ b/[drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_perfmon.c?id=0b2ad4f6f2bec74a5287d96cb2325a5e11706f22)@@ -116,6 +116,11 @@ void vc4\_perfmon\_open\_file(struct vc4\_file \*vc4file) static int vc4\_perfmon\_idr\_del(int id, void \*elem, void \*data) { struct vc4\_perfmon \*perfmon = elem;+ struct vc4\_dev \*vc4 = (struct vc4\_dev \*)data;++ /\* If the active perfmon is being destroyed, stop it first \*/+ if (perfmon == vc4->active\_perfmon)+ vc4\_perfmon\_stop(vc4, perfmon, false);  vc4\_perfmon\_put(perfmon); @@ -130,7 +135,7 @@ void vc4\_perfmon\_close\_file(struct vc4\_file \*vc4file) return;  mutex\_lock(&vc4file->perfmon.lock);- idr\_for\_each(&vc4file->perfmon.idr, vc4\_perfmon\_idr\_del, NULL);+ idr\_for\_each(&vc4file->perfmon.idr, vc4\_perfmon\_idr\_del, vc4); idr\_destroy(&vc4file->perfmon.idr); mutex\_unlock(&vc4file->perfmon.lock); mutex\_destroy(&vc4file->perfmon.lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:35:05 +0000



=== Content from git.kernel.org_e8230afe_20250114_203629.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=937943c042503dc6087438bf3557f9057a588ba0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=937943c042503dc6087438bf3557f9057a588ba0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=937943c042503dc6087438bf3557f9057a588ba0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=937943c042503dc6087438bf3557f9057a588ba0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maíra Canal <mcanal@igalia.com> | 2024-10-04 09:36:00 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:24:34 +0200 |
| commit | [937943c042503dc6087438bf3557f9057a588ba0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=937943c042503dc6087438bf3557f9057a588ba0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=937943c042503dc6087438bf3557f9057a588ba0)) | |
| tree | [8705139555890c872c9a10d7b7bd0a44188c86e1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=937943c042503dc6087438bf3557f9057a588ba0) | |
| parent | [07c51108d9e278831c16191d1223ee49986e7890](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c51108d9e278831c16191d1223ee49986e7890) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=937943c042503dc6087438bf3557f9057a588ba0&id2=07c51108d9e278831c16191d1223ee49986e7890)) | |
| download | [linux-937943c042503dc6087438bf3557f9057a588ba0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-937943c042503dc6087438bf3557f9057a588ba0.tar.gz) | |

drm/vc4: Stop the active perfmon before being destroyedcommit 0b2ad4f6f2bec74a5287d96cb2325a5e11706f22 upstream.
Upon closing the file descriptor, the active performance monitor is not
stopped. Although all perfmons are destroyed in `vc4\_perfmon\_close\_file()`,
the active performance monitor's pointer (`vc4->active\_perfmon`) is still
retained.
If we open a new file descriptor and submit a few jobs with performance
monitors, the driver will attempt to stop the active performance monitor
using the stale pointer in `vc4->active\_perfmon`. However, this pointer
is no longer valid because the previous process has already terminated,
and all performance monitors associated with it have been destroyed and
freed.
To fix this, when the active performance monitor belongs to a given
process, explicitly stop it before destroying and freeing it.
Cc: stable@vger.kernel.org # v4.17+
Cc: Boris Brezillon <bbrezillon@kernel.org>
Cc: Juan A. Suarez Romero <jasuarez@igalia.com>
Fixes: 65101d8c9108 ("drm/vc4: Expose performance counters to userspace")
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Reviewed-by: Juan A. Suarez <jasuarez@igalia.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20241004123817.890016-2-mcanal@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20241004123817.890016-2-mcanal%40igalia.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=937943c042503dc6087438bf3557f9057a588ba0)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_perfmon.c?id=937943c042503dc6087438bf3557f9057a588ba0) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_perfmon.c b/drivers/gpu/drm/vc4/vc4\_perfmon.cindex c4ac2c94623815..c00a5cc2316d20 100644--- a/[drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_perfmon.c?id=07c51108d9e278831c16191d1223ee49986e7890)+++ b/[drivers/gpu/drm/vc4/vc4\_perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_perfmon.c?id=937943c042503dc6087438bf3557f9057a588ba0)@@ -116,6 +116,11 @@ void vc4\_perfmon\_open\_file(struct vc4\_file \*vc4file) static int vc4\_perfmon\_idr\_del(int id, void \*elem, void \*data) { struct vc4\_perfmon \*perfmon = elem;+ struct vc4\_dev \*vc4 = (struct vc4\_dev \*)data;++ /\* If the active perfmon is being destroyed, stop it first \*/+ if (perfmon == vc4->active\_perfmon)+ vc4\_perfmon\_stop(vc4, perfmon, false);  vc4\_perfmon\_put(perfmon); @@ -130,7 +135,7 @@ void vc4\_perfmon\_close\_file(struct vc4\_file \*vc4file) return;  mutex\_lock(&vc4file->perfmon.lock);- idr\_for\_each(&vc4file->perfmon.idr, vc4\_perfmon\_idr\_del, NULL);+ idr\_for\_each(&vc4file->perfmon.idr, vc4\_perfmon\_idr\_del, vc4); idr\_destroy(&vc4file->perfmon.idr); mutex\_unlock(&vc4file->perfmon.lock); mutex\_destroy(&vc4file->perfmon.lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:35:06 +0000


