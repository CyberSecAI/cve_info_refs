=== Content from git.kernel.org_8a870a18_20250114_214627.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Erkun <yangerkun@huaweicloud.com> | 2024-10-21 16:25:40 +0800 |
| --- | --- | --- |
| committer | Chuck Lever <chuck.lever@oracle.com> | 2024-10-21 10:27:36 -0400 |
| commit | [d5ff2fb2e7167e9483846e34148e60c0c016a1f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6)) | |
| tree | [366432f04dbe8fae3ecfff09fd49562e16317247](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6) | |
| parent | [8dd91e8d31febf4d9cca3ae1bb4771d33ae7ee5a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8dd91e8d31febf4d9cca3ae1bb4771d33ae7ee5a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6&id2=8dd91e8d31febf4d9cca3ae1bb4771d33ae7ee5a)) | |
| download | [linux-d5ff2fb2e7167e9483846e34148e60c0c016a1f6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d5ff2fb2e7167e9483846e34148e60c0c016a1f6.tar.gz) | |

nfsd: cancel nfsd\_shrinker\_work using sync mode in nfs4\_state\_shutdown\_netIn the normal case, when we excute `echo 0 > /proc/fs/nfsd/threads`, the
function `nfs4\_state\_destroy\_net` in `nfs4\_state\_shutdown\_net` will
release all resources related to the hashed `nfs4\_client`. If the
`nfsd\_client\_shrinker` is running concurrently, the `expire\_client`
function will first unhash this client and then destroy it. This can
lead to the following warning. Additionally, numerous use-after-free
errors may occur as well.
nfsd\_client\_shrinker echo 0 > /proc/fs/nfsd/threads
expire\_client nfsd\_shutdown\_net
unhash\_client ...
nfs4\_state\_shutdown\_net
/\* won't wait shrinker exit \*/
/\* cancel\_work(&nn->nfsd\_shrinker\_work)
\* nfsd\_file for this /\* won't destroy unhashed client1 \*/
\* client1 still alive nfs4\_state\_destroy\_net
\*/
nfsd\_file\_cache\_shutdown
/\* trigger warning \*/
kmem\_cache\_destroy(nfsd\_file\_slab)
kmem\_cache\_destroy(nfsd\_file\_mark\_slab)
/\* release nfsd\_file and mark \*/
\_\_destroy\_client
====================================================================
BUG nfsd\_file (Not tainted): Objects remaining in nfsd\_file on
\_\_kmem\_cache\_shutdown()
--------------------------------------------------------------------
CPU: 4 UID: 0 PID: 764 Comm: sh Not tainted 6.12.0-rc3+ #1
dump\_stack\_lvl+0x53/0x70
slab\_err+0xb0/0xf0
\_\_kmem\_cache\_shutdown+0x15c/0x310
kmem\_cache\_destroy+0x66/0x160
nfsd\_file\_cache\_shutdown+0xac/0x210 [nfsd]
nfsd\_destroy\_serv+0x251/0x2a0 [nfsd]
nfsd\_svc+0x125/0x1e0 [nfsd]
write\_threads+0x16a/0x2a0 [nfsd]
nfsctl\_transaction\_write+0x74/0xa0 [nfsd]
vfs\_write+0x1a5/0x6d0
ksys\_write+0xc1/0x160
do\_syscall\_64+0x5f/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
====================================================================
BUG nfsd\_file\_mark (Tainted: G B W ): Objects remaining
nfsd\_file\_mark on \_\_kmem\_cache\_shutdown()
--------------------------------------------------------------------
dump\_stack\_lvl+0x53/0x70
slab\_err+0xb0/0xf0
\_\_kmem\_cache\_shutdown+0x15c/0x310
kmem\_cache\_destroy+0x66/0x160
nfsd\_file\_cache\_shutdown+0xc8/0x210 [nfsd]
nfsd\_destroy\_serv+0x251/0x2a0 [nfsd]
nfsd\_svc+0x125/0x1e0 [nfsd]
write\_threads+0x16a/0x2a0 [nfsd]
nfsctl\_transaction\_write+0x74/0xa0 [nfsd]
vfs\_write+0x1a5/0x6d0
ksys\_write+0xc1/0x160
do\_syscall\_64+0x5f/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
To resolve this issue, cancel `nfsd\_shrinker\_work` using synchronous
mode in nfs4\_state\_shutdown\_net.
Fixes: 7c24fa225081 ("NFSD: replace delayed\_work with work\_struct for nfsd\_client\_shrinker")
Signed-off-by: Yang Erkun <yangerkun@huaweicloud.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6)

| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex d1a2c677be7e6a..551d2958ec2905 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=8dd91e8d31febf4d9cca3ae1bb4771d33ae7ee5a)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=d5ff2fb2e7167e9483846e34148e60c0c016a1f6)@@ -8716,7 +8716,7 @@ nfs4\_state\_shutdown\_net(struct net \*net) struct nfsd\_net \*nn = net\_generic(net, nfsd\_net\_id);  shrinker\_free(nn->nfsd\_client\_shrinker);- cancel\_work(&nn->nfsd\_shrinker\_work);+ cancel\_work\_sync(&nn->nfsd\_shrinker\_work); cancel\_delayed\_work\_sync(&nn->laundromat\_work); locks\_end\_grace(&nn->nfsd4\_manager); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:45:03 +0000



=== Content from git.kernel.org_9f6e9f72_20250114_214628.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f965dc0f099a54fca100acf6909abe52d0c85328)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f965dc0f099a54fca100acf6909abe52d0c85328)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f965dc0f099a54fca100acf6909abe52d0c85328)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f965dc0f099a54fca100acf6909abe52d0c85328)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Erkun <yangerkun@huaweicloud.com> | 2024-10-21 16:25:40 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:31 +0100 |
| commit | [f965dc0f099a54fca100acf6909abe52d0c85328](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f965dc0f099a54fca100acf6909abe52d0c85328) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f965dc0f099a54fca100acf6909abe52d0c85328)) | |
| tree | [5c3c728f4e9e06ed33f56aaa09a3254fae9fb74b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f965dc0f099a54fca100acf6909abe52d0c85328) | |
| parent | [5f0468f30c8f885218a0786876db2f8c3b277e2d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f0468f30c8f885218a0786876db2f8c3b277e2d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f965dc0f099a54fca100acf6909abe52d0c85328&id2=5f0468f30c8f885218a0786876db2f8c3b277e2d)) | |
| download | [linux-f965dc0f099a54fca100acf6909abe52d0c85328.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f965dc0f099a54fca100acf6909abe52d0c85328.tar.gz) | |

nfsd: cancel nfsd\_shrinker\_work using sync mode in nfs4\_state\_shutdown\_net[ Upstream commit d5ff2fb2e7167e9483846e34148e60c0c016a1f6 ]
In the normal case, when we excute `echo 0 > /proc/fs/nfsd/threads`, the
function `nfs4\_state\_destroy\_net` in `nfs4\_state\_shutdown\_net` will
release all resources related to the hashed `nfs4\_client`. If the
`nfsd\_client\_shrinker` is running concurrently, the `expire\_client`
function will first unhash this client and then destroy it. This can
lead to the following warning. Additionally, numerous use-after-free
errors may occur as well.
nfsd\_client\_shrinker echo 0 > /proc/fs/nfsd/threads
expire\_client nfsd\_shutdown\_net
unhash\_client ...
nfs4\_state\_shutdown\_net
/\* won't wait shrinker exit \*/
/\* cancel\_work(&nn->nfsd\_shrinker\_work)
\* nfsd\_file for this /\* won't destroy unhashed client1 \*/
\* client1 still alive nfs4\_state\_destroy\_net
\*/
nfsd\_file\_cache\_shutdown
/\* trigger warning \*/
kmem\_cache\_destroy(nfsd\_file\_slab)
kmem\_cache\_destroy(nfsd\_file\_mark\_slab)
/\* release nfsd\_file and mark \*/
\_\_destroy\_client
====================================================================
BUG nfsd\_file (Not tainted): Objects remaining in nfsd\_file on
\_\_kmem\_cache\_shutdown()
--------------------------------------------------------------------
CPU: 4 UID: 0 PID: 764 Comm: sh Not tainted 6.12.0-rc3+ #1
dump\_stack\_lvl+0x53/0x70
slab\_err+0xb0/0xf0
\_\_kmem\_cache\_shutdown+0x15c/0x310
kmem\_cache\_destroy+0x66/0x160
nfsd\_file\_cache\_shutdown+0xac/0x210 [nfsd]
nfsd\_destroy\_serv+0x251/0x2a0 [nfsd]
nfsd\_svc+0x125/0x1e0 [nfsd]
write\_threads+0x16a/0x2a0 [nfsd]
nfsctl\_transaction\_write+0x74/0xa0 [nfsd]
vfs\_write+0x1a5/0x6d0
ksys\_write+0xc1/0x160
do\_syscall\_64+0x5f/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
====================================================================
BUG nfsd\_file\_mark (Tainted: G B W ): Objects remaining
nfsd\_file\_mark on \_\_kmem\_cache\_shutdown()
--------------------------------------------------------------------
dump\_stack\_lvl+0x53/0x70
slab\_err+0xb0/0xf0
\_\_kmem\_cache\_shutdown+0x15c/0x310
kmem\_cache\_destroy+0x66/0x160
nfsd\_file\_cache\_shutdown+0xc8/0x210 [nfsd]
nfsd\_destroy\_serv+0x251/0x2a0 [nfsd]
nfsd\_svc+0x125/0x1e0 [nfsd]
write\_threads+0x16a/0x2a0 [nfsd]
nfsctl\_transaction\_write+0x74/0xa0 [nfsd]
vfs\_write+0x1a5/0x6d0
ksys\_write+0xc1/0x160
do\_syscall\_64+0x5f/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
To resolve this issue, cancel `nfsd\_shrinker\_work` using synchronous
mode in nfs4\_state\_shutdown\_net.
Fixes: 7c24fa225081 ("NFSD: replace delayed\_work with work\_struct for nfsd\_client\_shrinker")
Signed-off-by: Yang Erkun <yangerkun@huaweicloud.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f965dc0f099a54fca100acf6909abe52d0c85328)

| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=f965dc0f099a54fca100acf6909abe52d0c85328) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex f16bbbfcf672c8..975dd74a7a4db4 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=5f0468f30c8f885218a0786876db2f8c3b277e2d)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=f965dc0f099a54fca100acf6909abe52d0c85328)@@ -8254,7 +8254,7 @@ nfs4\_state\_shutdown\_net(struct net \*net) struct nfsd\_net \*nn = net\_generic(net, nfsd\_net\_id);  unregister\_shrinker(&nn->nfsd\_client\_shrinker);- cancel\_work(&nn->nfsd\_shrinker\_work);+ cancel\_work\_sync(&nn->nfsd\_shrinker\_work); cancel\_delayed\_work\_sync(&nn->laundromat\_work); locks\_end\_grace(&nn->nfsd4\_manager); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:45:05 +0000



=== Content from git.kernel.org_04f42de0_20250114_214625.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=add1df5eba163a3a6ece11cb85890e2e410baaea)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=add1df5eba163a3a6ece11cb85890e2e410baaea)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=add1df5eba163a3a6ece11cb85890e2e410baaea)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=add1df5eba163a3a6ece11cb85890e2e410baaea)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Erkun <yangerkun@huaweicloud.com> | 2024-10-21 16:25:40 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:39 +0100 |
| commit | [add1df5eba163a3a6ece11cb85890e2e410baaea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=add1df5eba163a3a6ece11cb85890e2e410baaea) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=add1df5eba163a3a6ece11cb85890e2e410baaea)) | |
| tree | [853ccff9bd67df8051e998a1e6ca73e2c79f33c6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=add1df5eba163a3a6ece11cb85890e2e410baaea) | |
| parent | [782b118d69354e713083aa5e2f82a766c620a809](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=782b118d69354e713083aa5e2f82a766c620a809) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=add1df5eba163a3a6ece11cb85890e2e410baaea&id2=782b118d69354e713083aa5e2f82a766c620a809)) | |
| download | [linux-add1df5eba163a3a6ece11cb85890e2e410baaea.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-add1df5eba163a3a6ece11cb85890e2e410baaea.tar.gz) | |

nfsd: cancel nfsd\_shrinker\_work using sync mode in nfs4\_state\_shutdown\_net[ Upstream commit d5ff2fb2e7167e9483846e34148e60c0c016a1f6 ]
In the normal case, when we excute `echo 0 > /proc/fs/nfsd/threads`, the
function `nfs4\_state\_destroy\_net` in `nfs4\_state\_shutdown\_net` will
release all resources related to the hashed `nfs4\_client`. If the
`nfsd\_client\_shrinker` is running concurrently, the `expire\_client`
function will first unhash this client and then destroy it. This can
lead to the following warning. Additionally, numerous use-after-free
errors may occur as well.
nfsd\_client\_shrinker echo 0 > /proc/fs/nfsd/threads
expire\_client nfsd\_shutdown\_net
unhash\_client ...
nfs4\_state\_shutdown\_net
/\* won't wait shrinker exit \*/
/\* cancel\_work(&nn->nfsd\_shrinker\_work)
\* nfsd\_file for this /\* won't destroy unhashed client1 \*/
\* client1 still alive nfs4\_state\_destroy\_net
\*/
nfsd\_file\_cache\_shutdown
/\* trigger warning \*/
kmem\_cache\_destroy(nfsd\_file\_slab)
kmem\_cache\_destroy(nfsd\_file\_mark\_slab)
/\* release nfsd\_file and mark \*/
\_\_destroy\_client
====================================================================
BUG nfsd\_file (Not tainted): Objects remaining in nfsd\_file on
\_\_kmem\_cache\_shutdown()
--------------------------------------------------------------------
CPU: 4 UID: 0 PID: 764 Comm: sh Not tainted 6.12.0-rc3+ #1
dump\_stack\_lvl+0x53/0x70
slab\_err+0xb0/0xf0
\_\_kmem\_cache\_shutdown+0x15c/0x310
kmem\_cache\_destroy+0x66/0x160
nfsd\_file\_cache\_shutdown+0xac/0x210 [nfsd]
nfsd\_destroy\_serv+0x251/0x2a0 [nfsd]
nfsd\_svc+0x125/0x1e0 [nfsd]
write\_threads+0x16a/0x2a0 [nfsd]
nfsctl\_transaction\_write+0x74/0xa0 [nfsd]
vfs\_write+0x1a5/0x6d0
ksys\_write+0xc1/0x160
do\_syscall\_64+0x5f/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
====================================================================
BUG nfsd\_file\_mark (Tainted: G B W ): Objects remaining
nfsd\_file\_mark on \_\_kmem\_cache\_shutdown()
--------------------------------------------------------------------
dump\_stack\_lvl+0x53/0x70
slab\_err+0xb0/0xf0
\_\_kmem\_cache\_shutdown+0x15c/0x310
kmem\_cache\_destroy+0x66/0x160
nfsd\_file\_cache\_shutdown+0xc8/0x210 [nfsd]
nfsd\_destroy\_serv+0x251/0x2a0 [nfsd]
nfsd\_svc+0x125/0x1e0 [nfsd]
write\_threads+0x16a/0x2a0 [nfsd]
nfsctl\_transaction\_write+0x74/0xa0 [nfsd]
vfs\_write+0x1a5/0x6d0
ksys\_write+0xc1/0x160
do\_syscall\_64+0x5f/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
To resolve this issue, cancel `nfsd\_shrinker\_work` using synchronous
mode in nfs4\_state\_shutdown\_net.
Fixes: 7c24fa225081 ("NFSD: replace delayed\_work with work\_struct for nfsd\_client\_shrinker")
Signed-off-by: Yang Erkun <yangerkun@huaweicloud.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=add1df5eba163a3a6ece11cb85890e2e410baaea)

| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=add1df5eba163a3a6ece11cb85890e2e410baaea) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex 64cf5d7b7a4e27..150b637f03ee65 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=782b118d69354e713083aa5e2f82a766c620a809)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=add1df5eba163a3a6ece11cb85890e2e410baaea)@@ -8687,7 +8687,7 @@ nfs4\_state\_shutdown\_net(struct net \*net) struct nfsd\_net \*nn = net\_generic(net, nfsd\_net\_id);  shrinker\_free(nn->nfsd\_client\_shrinker);- cancel\_work(&nn->nfsd\_shrinker\_work);+ cancel\_work\_sync(&nn->nfsd\_shrinker\_work); cancel\_delayed\_work\_sync(&nn->laundromat\_work); locks\_end\_grace(&nn->nfsd4\_manager); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:45:02 +0000



=== Content from git.kernel.org_c216b4e0_20250114_214623.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=36775f42e039b01d4abe8998bf66771a37d3cdcc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=36775f42e039b01d4abe8998bf66771a37d3cdcc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36775f42e039b01d4abe8998bf66771a37d3cdcc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36775f42e039b01d4abe8998bf66771a37d3cdcc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Erkun <yangerkun@huaweicloud.com> | 2024-10-21 16:25:40 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2025-01-02 10:30:55 +0100 |
| commit | [36775f42e039b01d4abe8998bf66771a37d3cdcc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36775f42e039b01d4abe8998bf66771a37d3cdcc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=36775f42e039b01d4abe8998bf66771a37d3cdcc)) | |
| tree | [6683a4d897388002c6216fdf47e6f143c8ff3249](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=36775f42e039b01d4abe8998bf66771a37d3cdcc) | |
| parent | [459ef4a242b06ae12b1e70828b6224b2d159d5cc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=459ef4a242b06ae12b1e70828b6224b2d159d5cc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36775f42e039b01d4abe8998bf66771a37d3cdcc&id2=459ef4a242b06ae12b1e70828b6224b2d159d5cc)) | |
| download | [linux-36775f42e039b01d4abe8998bf66771a37d3cdcc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-36775f42e039b01d4abe8998bf66771a37d3cdcc.tar.gz) | |

nfsd: cancel nfsd\_shrinker\_work using sync mode in nfs4\_state\_shutdown\_netcommit d5ff2fb2e7167e9483846e34148e60c0c016a1f6 upstream.
In the normal case, when we excute `echo 0 > /proc/fs/nfsd/threads`, the
function `nfs4\_state\_destroy\_net` in `nfs4\_state\_shutdown\_net` will
release all resources related to the hashed `nfs4\_client`. If the
`nfsd\_client\_shrinker` is running concurrently, the `expire\_client`
function will first unhash this client and then destroy it. This can
lead to the following warning. Additionally, numerous use-after-free
errors may occur as well.
nfsd\_client\_shrinker echo 0 > /proc/fs/nfsd/threads
expire\_client nfsd\_shutdown\_net
unhash\_client ...
nfs4\_state\_shutdown\_net
/\* won't wait shrinker exit \*/
/\* cancel\_work(&nn->nfsd\_shrinker\_work)
\* nfsd\_file for this /\* won't destroy unhashed client1 \*/
\* client1 still alive nfs4\_state\_destroy\_net
\*/
nfsd\_file\_cache\_shutdown
/\* trigger warning \*/
kmem\_cache\_destroy(nfsd\_file\_slab)
kmem\_cache\_destroy(nfsd\_file\_mark\_slab)
/\* release nfsd\_file and mark \*/
\_\_destroy\_client
====================================================================
BUG nfsd\_file (Not tainted): Objects remaining in nfsd\_file on
\_\_kmem\_cache\_shutdown()
--------------------------------------------------------------------
CPU: 4 UID: 0 PID: 764 Comm: sh Not tainted 6.12.0-rc3+ #1
dump\_stack\_lvl+0x53/0x70
slab\_err+0xb0/0xf0
\_\_kmem\_cache\_shutdown+0x15c/0x310
kmem\_cache\_destroy+0x66/0x160
nfsd\_file\_cache\_shutdown+0xac/0x210 [nfsd]
nfsd\_destroy\_serv+0x251/0x2a0 [nfsd]
nfsd\_svc+0x125/0x1e0 [nfsd]
write\_threads+0x16a/0x2a0 [nfsd]
nfsctl\_transaction\_write+0x74/0xa0 [nfsd]
vfs\_write+0x1a5/0x6d0
ksys\_write+0xc1/0x160
do\_syscall\_64+0x5f/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
====================================================================
BUG nfsd\_file\_mark (Tainted: G B W ): Objects remaining
nfsd\_file\_mark on \_\_kmem\_cache\_shutdown()
--------------------------------------------------------------------
dump\_stack\_lvl+0x53/0x70
slab\_err+0xb0/0xf0
\_\_kmem\_cache\_shutdown+0x15c/0x310
kmem\_cache\_destroy+0x66/0x160
nfsd\_file\_cache\_shutdown+0xc8/0x210 [nfsd]
nfsd\_destroy\_serv+0x251/0x2a0 [nfsd]
nfsd\_svc+0x125/0x1e0 [nfsd]
write\_threads+0x16a/0x2a0 [nfsd]
nfsctl\_transaction\_write+0x74/0xa0 [nfsd]
vfs\_write+0x1a5/0x6d0
ksys\_write+0xc1/0x160
do\_syscall\_64+0x5f/0x170
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
To resolve this issue, cancel `nfsd\_shrinker\_work` using synchronous
mode in nfs4\_state\_shutdown\_net.
Fixes: 7c24fa225081 ("NFSD: replace delayed\_work with work\_struct for nfsd\_client\_shrinker")
Signed-off-by: Yang Erkun <yangerkun@huaweicloud.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36775f42e039b01d4abe8998bf66771a37d3cdcc)

| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=36775f42e039b01d4abe8998bf66771a37d3cdcc) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex 8bceae771c1c75..f6fa719ee32668 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=459ef4a242b06ae12b1e70828b6224b2d159d5cc)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=36775f42e039b01d4abe8998bf66771a37d3cdcc)@@ -8208,7 +8208,7 @@ nfs4\_state\_shutdown\_net(struct net \*net) struct nfsd\_net \*nn = net\_generic(net, nfsd\_net\_id);  unregister\_shrinker(&nn->nfsd\_client\_shrinker);- cancel\_work(&nn->nfsd\_shrinker\_work);+ cancel\_work\_sync(&nn->nfsd\_shrinker\_work); cancel\_delayed\_work\_sync(&nn->laundromat\_work); locks\_end\_grace(&nn->nfsd4\_manager); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:45:00 +0000


