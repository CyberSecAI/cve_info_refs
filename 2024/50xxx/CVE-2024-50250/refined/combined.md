=== Content from git.kernel.org_571f2071_20250114_210846.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Darrick J. Wong <djwong@kernel.org> | 2024-10-03 08:09:48 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:19 +0100 |
| commit | [9bc18bb476e50e32e5d08f2734d63d63e0fa528c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c)) | |
| tree | [3293f9e9ac1680a38d70665b4ba689eea9135343](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c) | |
| parent | [35adbe088888af796a47d6af5dc7ff3c12a11c6c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35adbe088888af796a47d6af5dc7ff3c12a11c6c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c&id2=35adbe088888af796a47d6af5dc7ff3c12a11c6c)) | |
| download | [linux-9bc18bb476e50e32e5d08f2734d63d63e0fa528c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9bc18bb476e50e32e5d08f2734d63d63e0fa528c.tar.gz) | |

fsdax: dax\_unshare\_iter needs to copy entire blocks[ Upstream commit 50793801fc7f6d08def48754fb0f0706b0cfc394 ]
The code that copies data from srcmap to iomap in dax\_unshare\_iter is
very very broken, which bfoster's recent fsx changes have exposed.
If the pos and len passed to dax\_file\_unshare are not aligned to an
fsblock boundary, the iter pos and length in the \_iter function will
reflect this unalignment.
dax\_iomap\_direct\_access always returns a pointer to the start of the
kmapped fsdax page, even if its pos argument is in the middle of that
page. This is catastrophic for data integrity when iter->pos is not
aligned to a page, because daddr/saddr do not point to the same byte in
the file as iter->pos. Hence we corrupt user data by copying it to the
wrong place.
If iter->pos + iomap\_length() in the \_iter function not aligned to a
page, then we fail to copy a full block, and only partially populate the
destination block. This is catastrophic for data confidentiality
because we expose stale pmem contents.
Fix both of these issues by aligning copy\_pos/copy\_len to a page
boundary (remember, this is fsdax so 1 fsblock == 1 base page) so that
we always copy full blocks.
We're not done yet -- there's no call to invalidate\_inode\_pages2\_range,
so programs that have the file range mmap'd will continue accessing the
old memory mapping after the file metadata updates have completed.
Be careful with the return value -- if the unshare succeeds, we still
need to return the number of bytes that the iomap iter thinks we're
operating on.
Cc: ruansy.fnst@fujitsu.com
Fixes: d984648e428b ("fsdax,xfs: port unshare to fsdax")
Signed-off-by: Darrick J. Wong <djwong@kernel.org>
Link: [https://lore.kernel.org/r/172796813328.1131942.16777025316348797355.stgit@frogsfrogsfrogs](https://lore.kernel.org/r/172796813328.1131942.16777025316348797355.stgit%40frogsfrogsfrogs)
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c)

| -rw-r--r-- | [fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/dax.c?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 27 insertions, 7 deletions

| diff --git a/fs/dax.c b/fs/dax.cindex 5e7fc5017570dd..8c09578fa03573 100644--- a/[fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/dax.c?id=35adbe088888af796a47d6af5dc7ff3c12a11c6c)+++ b/[fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/dax.c?id=9bc18bb476e50e32e5d08f2734d63d63e0fa528c)@@ -1262,26 +1262,46 @@ static s64 dax\_unshare\_iter(struct iomap\_iter \*iter) { struct iomap \*iomap = &iter->iomap; const struct iomap \*srcmap = iomap\_iter\_srcmap(iter);- loff\_t pos = iter->pos;- loff\_t length = iomap\_length(iter);+ loff\_t copy\_pos = iter->pos;+ u64 copy\_len = iomap\_length(iter);+ u32 mod; int id = 0; s64 ret = 0; void \*daddr = NULL, \*saddr = NULL;  if (!iomap\_want\_unshare\_iter(iter))- return length;+ return iomap\_length(iter);++ /\*+ \* Extend the file range to be aligned to fsblock/pagesize, because+ \* we need to copy entire blocks, not just the byte range specified.+ \* Invalidate the mapping because we're about to CoW.+ \*/+ mod = offset\_in\_page(copy\_pos);+ if (mod) {+ copy\_len += mod;+ copy\_pos -= mod;+ }++ mod = offset\_in\_page(copy\_pos + copy\_len);+ if (mod)+ copy\_len += PAGE\_SIZE - mod;++ invalidate\_inode\_pages2\_range(iter->inode->i\_mapping,+ copy\_pos >> PAGE\_SHIFT,+ (copy\_pos + copy\_len - 1) >> PAGE\_SHIFT);  id = dax\_read\_lock();- ret = dax\_iomap\_direct\_access(iomap, pos, length, &daddr, NULL);+ ret = dax\_iomap\_direct\_access(iomap, copy\_pos, copy\_len, &daddr, NULL); if (ret < 0) goto out\_unlock; - ret = dax\_iomap\_direct\_access(srcmap, pos, length, &saddr, NULL);+ ret = dax\_iomap\_direct\_access(srcmap, copy\_pos, copy\_len, &saddr, NULL); if (ret < 0) goto out\_unlock; - if (copy\_mc\_to\_kernel(daddr, saddr, length) == 0)- ret = length;+ if (copy\_mc\_to\_kernel(daddr, saddr, copy\_len) == 0)+ ret = iomap\_length(iter); else ret = -EIO; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:07:22 +0000



=== Content from git.kernel.org_38de81c6_20250114_210843.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e9c0f500b42216ef930f5c0d1703989a451913d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e9c0f500b42216ef930f5c0d1703989a451913d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e9c0f500b42216ef930f5c0d1703989a451913d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e9c0f500b42216ef930f5c0d1703989a451913d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Darrick J. Wong <djwong@kernel.org> | 2024-10-03 08:09:48 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:49 +0100 |
| commit | [8e9c0f500b42216ef930f5c0d1703989a451913d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e9c0f500b42216ef930f5c0d1703989a451913d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e9c0f500b42216ef930f5c0d1703989a451913d)) | |
| tree | [aacf0c60d8b4912059a85a6ef62eb2ca3d65ef1c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e9c0f500b42216ef930f5c0d1703989a451913d) | |
| parent | [67b6a710b9bad9e832e4ca554e0936761dbe07fe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=67b6a710b9bad9e832e4ca554e0936761dbe07fe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e9c0f500b42216ef930f5c0d1703989a451913d&id2=67b6a710b9bad9e832e4ca554e0936761dbe07fe)) | |
| download | [linux-8e9c0f500b42216ef930f5c0d1703989a451913d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e9c0f500b42216ef930f5c0d1703989a451913d.tar.gz) | |

fsdax: dax\_unshare\_iter needs to copy entire blocks[ Upstream commit 50793801fc7f6d08def48754fb0f0706b0cfc394 ]
The code that copies data from srcmap to iomap in dax\_unshare\_iter is
very very broken, which bfoster's recent fsx changes have exposed.
If the pos and len passed to dax\_file\_unshare are not aligned to an
fsblock boundary, the iter pos and length in the \_iter function will
reflect this unalignment.
dax\_iomap\_direct\_access always returns a pointer to the start of the
kmapped fsdax page, even if its pos argument is in the middle of that
page. This is catastrophic for data integrity when iter->pos is not
aligned to a page, because daddr/saddr do not point to the same byte in
the file as iter->pos. Hence we corrupt user data by copying it to the
wrong place.
If iter->pos + iomap\_length() in the \_iter function not aligned to a
page, then we fail to copy a full block, and only partially populate the
destination block. This is catastrophic for data confidentiality
because we expose stale pmem contents.
Fix both of these issues by aligning copy\_pos/copy\_len to a page
boundary (remember, this is fsdax so 1 fsblock == 1 base page) so that
we always copy full blocks.
We're not done yet -- there's no call to invalidate\_inode\_pages2\_range,
so programs that have the file range mmap'd will continue accessing the
old memory mapping after the file metadata updates have completed.
Be careful with the return value -- if the unshare succeeds, we still
need to return the number of bytes that the iomap iter thinks we're
operating on.
Cc: ruansy.fnst@fujitsu.com
Fixes: d984648e428b ("fsdax,xfs: port unshare to fsdax")
Signed-off-by: Darrick J. Wong <djwong@kernel.org>
Link: [https://lore.kernel.org/r/172796813328.1131942.16777025316348797355.stgit@frogsfrogsfrogs](https://lore.kernel.org/r/172796813328.1131942.16777025316348797355.stgit%40frogsfrogsfrogs)
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e9c0f500b42216ef930f5c0d1703989a451913d)

| -rw-r--r-- | [fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/dax.c?id=8e9c0f500b42216ef930f5c0d1703989a451913d) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 27 insertions, 7 deletions

| diff --git a/fs/dax.c b/fs/dax.cindex 9fbbdaa784b43e..21b47402b3dca4 100644--- a/[fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/dax.c?id=67b6a710b9bad9e832e4ca554e0936761dbe07fe)+++ b/[fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/dax.c?id=8e9c0f500b42216ef930f5c0d1703989a451913d)@@ -1262,26 +1262,46 @@ static s64 dax\_unshare\_iter(struct iomap\_iter \*iter) { struct iomap \*iomap = &iter->iomap; const struct iomap \*srcmap = iomap\_iter\_srcmap(iter);- loff\_t pos = iter->pos;- loff\_t length = iomap\_length(iter);+ loff\_t copy\_pos = iter->pos;+ u64 copy\_len = iomap\_length(iter);+ u32 mod; int id = 0; s64 ret = 0; void \*daddr = NULL, \*saddr = NULL;  if (!iomap\_want\_unshare\_iter(iter))- return length;+ return iomap\_length(iter);++ /\*+ \* Extend the file range to be aligned to fsblock/pagesize, because+ \* we need to copy entire blocks, not just the byte range specified.+ \* Invalidate the mapping because we're about to CoW.+ \*/+ mod = offset\_in\_page(copy\_pos);+ if (mod) {+ copy\_len += mod;+ copy\_pos -= mod;+ }++ mod = offset\_in\_page(copy\_pos + copy\_len);+ if (mod)+ copy\_len += PAGE\_SIZE - mod;++ invalidate\_inode\_pages2\_range(iter->inode->i\_mapping,+ copy\_pos >> PAGE\_SHIFT,+ (copy\_pos + copy\_len - 1) >> PAGE\_SHIFT);  id = dax\_read\_lock();- ret = dax\_iomap\_direct\_access(iomap, pos, length, &daddr, NULL);+ ret = dax\_iomap\_direct\_access(iomap, copy\_pos, copy\_len, &daddr, NULL); if (ret < 0) goto out\_unlock; - ret = dax\_iomap\_direct\_access(srcmap, pos, length, &saddr, NULL);+ ret = dax\_iomap\_direct\_access(srcmap, copy\_pos, copy\_len, &saddr, NULL); if (ret < 0) goto out\_unlock; - if (copy\_mc\_to\_kernel(daddr, saddr, length) == 0)- ret = length;+ if (copy\_mc\_to\_kernel(daddr, saddr, copy\_len) == 0)+ ret = iomap\_length(iter); else ret = -EIO; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:07:20 +0000



=== Content from git.kernel.org_4ca25693_20250114_210842.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=50793801fc7f6d08def48754fb0f0706b0cfc394)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50793801fc7f6d08def48754fb0f0706b0cfc394)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50793801fc7f6d08def48754fb0f0706b0cfc394)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50793801fc7f6d08def48754fb0f0706b0cfc394)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Darrick J. Wong <djwong@kernel.org> | 2024-10-03 08:09:48 -0700 |
| --- | --- | --- |
| committer | Christian Brauner <brauner@kernel.org> | 2024-10-07 13:51:47 +0200 |
| commit | [50793801fc7f6d08def48754fb0f0706b0cfc394](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50793801fc7f6d08def48754fb0f0706b0cfc394) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=50793801fc7f6d08def48754fb0f0706b0cfc394)) | |
| tree | [7383541e667b3aa308eb87d2ead61b419bb992a8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50793801fc7f6d08def48754fb0f0706b0cfc394) | |
| parent | [95472274b6fed8f2d30fbdda304e12174b3d4099](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95472274b6fed8f2d30fbdda304e12174b3d4099) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50793801fc7f6d08def48754fb0f0706b0cfc394&id2=95472274b6fed8f2d30fbdda304e12174b3d4099)) | |
| download | [linux-50793801fc7f6d08def48754fb0f0706b0cfc394.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-50793801fc7f6d08def48754fb0f0706b0cfc394.tar.gz) | |

fsdax: dax\_unshare\_iter needs to copy entire blocksThe code that copies data from srcmap to iomap in dax\_unshare\_iter is
very very broken, which bfoster's recent fsx changes have exposed.
If the pos and len passed to dax\_file\_unshare are not aligned to an
fsblock boundary, the iter pos and length in the \_iter function will
reflect this unalignment.
dax\_iomap\_direct\_access always returns a pointer to the start of the
kmapped fsdax page, even if its pos argument is in the middle of that
page. This is catastrophic for data integrity when iter->pos is not
aligned to a page, because daddr/saddr do not point to the same byte in
the file as iter->pos. Hence we corrupt user data by copying it to the
wrong place.
If iter->pos + iomap\_length() in the \_iter function not aligned to a
page, then we fail to copy a full block, and only partially populate the
destination block. This is catastrophic for data confidentiality
because we expose stale pmem contents.
Fix both of these issues by aligning copy\_pos/copy\_len to a page
boundary (remember, this is fsdax so 1 fsblock == 1 base page) so that
we always copy full blocks.
We're not done yet -- there's no call to invalidate\_inode\_pages2\_range,
so programs that have the file range mmap'd will continue accessing the
old memory mapping after the file metadata updates have completed.
Be careful with the return value -- if the unshare succeeds, we still
need to return the number of bytes that the iomap iter thinks we're
operating on.
Cc: ruansy.fnst@fujitsu.com
Fixes: d984648e428b ("fsdax,xfs: port unshare to fsdax")
Signed-off-by: Darrick J. Wong <djwong@kernel.org>
Link: [https://lore.kernel.org/r/172796813328.1131942.16777025316348797355.stgit@frogsfrogsfrogs](https://lore.kernel.org/r/172796813328.1131942.16777025316348797355.stgit%40frogsfrogsfrogs)
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Christian Brauner <brauner@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50793801fc7f6d08def48754fb0f0706b0cfc394)

| -rw-r--r-- | [fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/dax.c?id=50793801fc7f6d08def48754fb0f0706b0cfc394) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 27 insertions, 7 deletions

| diff --git a/fs/dax.c b/fs/dax.cindex 9fbbdaa784b43e..21b47402b3dca4 100644--- a/[fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/dax.c?id=95472274b6fed8f2d30fbdda304e12174b3d4099)+++ b/[fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/dax.c?id=50793801fc7f6d08def48754fb0f0706b0cfc394)@@ -1262,26 +1262,46 @@ static s64 dax\_unshare\_iter(struct iomap\_iter \*iter) { struct iomap \*iomap = &iter->iomap; const struct iomap \*srcmap = iomap\_iter\_srcmap(iter);- loff\_t pos = iter->pos;- loff\_t length = iomap\_length(iter);+ loff\_t copy\_pos = iter->pos;+ u64 copy\_len = iomap\_length(iter);+ u32 mod; int id = 0; s64 ret = 0; void \*daddr = NULL, \*saddr = NULL;  if (!iomap\_want\_unshare\_iter(iter))- return length;+ return iomap\_length(iter);++ /\*+ \* Extend the file range to be aligned to fsblock/pagesize, because+ \* we need to copy entire blocks, not just the byte range specified.+ \* Invalidate the mapping because we're about to CoW.+ \*/+ mod = offset\_in\_page(copy\_pos);+ if (mod) {+ copy\_len += mod;+ copy\_pos -= mod;+ }++ mod = offset\_in\_page(copy\_pos + copy\_len);+ if (mod)+ copy\_len += PAGE\_SIZE - mod;++ invalidate\_inode\_pages2\_range(iter->inode->i\_mapping,+ copy\_pos >> PAGE\_SHIFT,+ (copy\_pos + copy\_len - 1) >> PAGE\_SHIFT);  id = dax\_read\_lock();- ret = dax\_iomap\_direct\_access(iomap, pos, length, &daddr, NULL);+ ret = dax\_iomap\_direct\_access(iomap, copy\_pos, copy\_len, &daddr, NULL); if (ret < 0) goto out\_unlock; - ret = dax\_iomap\_direct\_access(srcmap, pos, length, &saddr, NULL);+ ret = dax\_iomap\_direct\_access(srcmap, copy\_pos, copy\_len, &saddr, NULL); if (ret < 0) goto out\_unlock; - if (copy\_mc\_to\_kernel(daddr, saddr, length) == 0)- ret = length;+ if (copy\_mc\_to\_kernel(daddr, saddr, copy\_len) == 0)+ ret = iomap\_length(iter); else ret = -EIO; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:07:18 +0000



=== Content from git.kernel.org_97a1fe95_20250114_210849.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Darrick J. Wong <djwong@kernel.org> | 2024-10-03 08:09:48 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:42 +0100 |
| commit | [bdbc96c23197d773a7d1bf03e4f11de593b0ff28](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28)) | |
| tree | [df42e59155498aff499db5c3f7951e51b4a46012](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28) | |
| parent | [a01987cd90fa20b970fc729850c1366420eac0b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a01987cd90fa20b970fc729850c1366420eac0b4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28&id2=a01987cd90fa20b970fc729850c1366420eac0b4)) | |
| download | [linux-bdbc96c23197d773a7d1bf03e4f11de593b0ff28.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bdbc96c23197d773a7d1bf03e4f11de593b0ff28.tar.gz) | |

fsdax: dax\_unshare\_iter needs to copy entire blocks[ Upstream commit 50793801fc7f6d08def48754fb0f0706b0cfc394 ]
The code that copies data from srcmap to iomap in dax\_unshare\_iter is
very very broken, which bfoster's recent fsx changes have exposed.
If the pos and len passed to dax\_file\_unshare are not aligned to an
fsblock boundary, the iter pos and length in the \_iter function will
reflect this unalignment.
dax\_iomap\_direct\_access always returns a pointer to the start of the
kmapped fsdax page, even if its pos argument is in the middle of that
page. This is catastrophic for data integrity when iter->pos is not
aligned to a page, because daddr/saddr do not point to the same byte in
the file as iter->pos. Hence we corrupt user data by copying it to the
wrong place.
If iter->pos + iomap\_length() in the \_iter function not aligned to a
page, then we fail to copy a full block, and only partially populate the
destination block. This is catastrophic for data confidentiality
because we expose stale pmem contents.
Fix both of these issues by aligning copy\_pos/copy\_len to a page
boundary (remember, this is fsdax so 1 fsblock == 1 base page) so that
we always copy full blocks.
We're not done yet -- there's no call to invalidate\_inode\_pages2\_range,
so programs that have the file range mmap'd will continue accessing the
old memory mapping after the file metadata updates have completed.
Be careful with the return value -- if the unshare succeeds, we still
need to return the number of bytes that the iomap iter thinks we're
operating on.
Cc: ruansy.fnst@fujitsu.com
Fixes: d984648e428b ("fsdax,xfs: port unshare to fsdax")
Signed-off-by: Darrick J. Wong <djwong@kernel.org>
Link: [https://lore.kernel.org/r/172796813328.1131942.16777025316348797355.stgit@frogsfrogsfrogs](https://lore.kernel.org/r/172796813328.1131942.16777025316348797355.stgit%40frogsfrogsfrogs)
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28)

| -rw-r--r-- | [fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/dax.c?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 27 insertions, 7 deletions

| diff --git a/fs/dax.c b/fs/dax.cindex fa5a82b27c2f64..ca7138bb1d5454 100644--- a/[fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/dax.c?id=a01987cd90fa20b970fc729850c1366420eac0b4)+++ b/[fs/dax.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/dax.c?id=bdbc96c23197d773a7d1bf03e4f11de593b0ff28)@@ -1225,26 +1225,46 @@ static s64 dax\_unshare\_iter(struct iomap\_iter \*iter) { struct iomap \*iomap = &iter->iomap; const struct iomap \*srcmap = iomap\_iter\_srcmap(iter);- loff\_t pos = iter->pos;- loff\_t length = iomap\_length(iter);+ loff\_t copy\_pos = iter->pos;+ u64 copy\_len = iomap\_length(iter);+ u32 mod; int id = 0; s64 ret = 0; void \*daddr = NULL, \*saddr = NULL;  if (!iomap\_want\_unshare\_iter(iter))- return length;+ return iomap\_length(iter);++ /\*+ \* Extend the file range to be aligned to fsblock/pagesize, because+ \* we need to copy entire blocks, not just the byte range specified.+ \* Invalidate the mapping because we're about to CoW.+ \*/+ mod = offset\_in\_page(copy\_pos);+ if (mod) {+ copy\_len += mod;+ copy\_pos -= mod;+ }++ mod = offset\_in\_page(copy\_pos + copy\_len);+ if (mod)+ copy\_len += PAGE\_SIZE - mod;++ invalidate\_inode\_pages2\_range(iter->inode->i\_mapping,+ copy\_pos >> PAGE\_SHIFT,+ (copy\_pos + copy\_len - 1) >> PAGE\_SHIFT);  id = dax\_read\_lock();- ret = dax\_iomap\_direct\_access(iomap, pos, length, &daddr, NULL);+ ret = dax\_iomap\_direct\_access(iomap, copy\_pos, copy\_len, &daddr, NULL); if (ret < 0) goto out\_unlock; - ret = dax\_iomap\_direct\_access(srcmap, pos, length, &saddr, NULL);+ ret = dax\_iomap\_direct\_access(srcmap, copy\_pos, copy\_len, &saddr, NULL); if (ret < 0) goto out\_unlock; - if (copy\_mc\_to\_kernel(daddr, saddr, length) == 0)- ret = length;+ if (copy\_mc\_to\_kernel(daddr, saddr, copy\_len) == 0)+ ret = iomap\_length(iter); else ret = -EIO; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:07:24 +0000


