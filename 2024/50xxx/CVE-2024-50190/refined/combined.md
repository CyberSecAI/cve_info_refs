=== Content from git.kernel.org_5ead649f_20250114_184219.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=43544b4e30732c3d88f423252281915d5bc739b6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=43544b4e30732c3d88f423252281915d5bc739b6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43544b4e30732c3d88f423252281915d5bc739b6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43544b4e30732c3d88f423252281915d5bc739b6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Przemek Kitszel <przemyslaw.kitszel@intel.com> | 2024-09-10 15:57:21 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:26:43 +0200 |
| commit | [43544b4e30732c3d88f423252281915d5bc739b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43544b4e30732c3d88f423252281915d5bc739b6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=43544b4e30732c3d88f423252281915d5bc739b6)) | |
| tree | [3775f3daca779bb31aba4a20850bbe308d9fad96](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=43544b4e30732c3d88f423252281915d5bc739b6) | |
| parent | [d35f2aec214e108a2144f1a30773124d930fad0f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d35f2aec214e108a2144f1a30773124d930fad0f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43544b4e30732c3d88f423252281915d5bc739b6&id2=d35f2aec214e108a2144f1a30773124d930fad0f)) | |
| download | [linux-43544b4e30732c3d88f423252281915d5bc739b6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-43544b4e30732c3d88f423252281915d5bc739b6.tar.gz) | |

ice: fix memleak in ice\_init\_tx\_topology()[ Upstream commit c188afdc36113760873ec78cbc036f6b05f77621 ]
Fix leak of the FW blob (DDP pkg).
Make ice\_cfg\_tx\_topo() const-correct, so ice\_init\_tx\_topology() can avoid
copying whole FW blob. Copy just the topology section, and only when
needed. Reuse the buffer allocated for the read of the current topology.
This was found by kmemleak, with the following trace for each PF:
[<ffffffff8761044d>] kmemdup\_noprof+0x1d/0x50
[<ffffffffc0a0a480>] ice\_init\_ddp\_config+0x100/0x220 [ice]
[<ffffffffc0a0da7f>] ice\_init\_dev+0x6f/0x200 [ice]
[<ffffffffc0a0dc49>] ice\_init+0x29/0x560 [ice]
[<ffffffffc0a10c1d>] ice\_probe+0x21d/0x310 [ice]
Constify ice\_cfg\_tx\_topo() @buf parameter.
This cascades further down to few more functions.
Fixes: cc5776fe1832 ("ice: Enable switching default Tx scheduler topology")
CC: Larysa Zaremba <larysa.zaremba@intel.com>
CC: Jacob Keller <jacob.e.keller@intel.com>
CC: Pucha Himasekhar Reddy <himasekharx.reddy.pucha@intel.com>
CC: Mateusz Polchlopek <mateusz.polchlopek@intel.com>
Signed-off-by: Przemek Kitszel <przemyslaw.kitszel@intel.com>
Reviewed-by: Jacob Keller <jacob.e.keller@intel.com>
Tested-by: Pucha Himasekhar Reddy <himasekharx.reddy.pucha@intel.com> (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43544b4e30732c3d88f423252281915d5bc739b6)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ddp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ddp.c?id=43544b4e30732c3d88f423252281915d5bc739b6) | 58 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ddp.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ddp.h?id=43544b4e30732c3d88f423252281915d5bc739b6) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_main.c?id=43544b4e30732c3d88f423252281915d5bc739b6) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 31 insertions, 39 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_ddp.c b/drivers/net/ethernet/intel/ice/ice\_ddp.cindex f182179529b7de..6b60b7c4de0933 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ddp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ddp.c?id=d35f2aec214e108a2144f1a30773124d930fad0f)+++ b/[drivers/net/ethernet/intel/ice/ice\_ddp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ddp.c?id=43544b4e30732c3d88f423252281915d5bc739b6)@@ -31,7 +31,7 @@ static const struct ice\_tunnel\_type\_scan tnls[] = { \* Verifies various attributes of the package file, including length, format \* version, and the requirement of at least one segment. \*/-static enum ice\_ddp\_state ice\_verify\_pkg(struct ice\_pkg\_hdr \*pkg, u32 len)+static enum ice\_ddp\_state ice\_verify\_pkg(const struct ice\_pkg\_hdr \*pkg, u32 len) { u32 seg\_count; u32 i;@@ -57,13 +57,13 @@ static enum ice\_ddp\_state ice\_verify\_pkg(struct ice\_pkg\_hdr \*pkg, u32 len) /\* all segments must fit within length \*/ for (i = 0; i < seg\_count; i++) { u32 off = le32\_to\_cpu(pkg->seg\_offset[i]);- struct ice\_generic\_seg\_hdr \*seg;+ const struct ice\_generic\_seg\_hdr \*seg;  /\* segment header must fit \*/ if (len < off + sizeof(\*seg)) return ICE\_DDP\_PKG\_INVALID\_FILE; - seg = (struct ice\_generic\_seg\_hdr \*)((u8 \*)pkg + off);+ seg = (void \*)pkg + off;  /\* segment body must fit \*/ if (len < off + le32\_to\_cpu(seg->seg\_size))@@ -119,13 +119,13 @@ static enum ice\_ddp\_state ice\_chk\_pkg\_version(struct ice\_pkg\_ver \*pkg\_ver) \* \* This helper function validates a buffer's header. \*/-static struct ice\_buf\_hdr \*ice\_pkg\_val\_buf(struct ice\_buf \*buf)+static const struct ice\_buf\_hdr \*ice\_pkg\_val\_buf(const struct ice\_buf \*buf) {- struct ice\_buf\_hdr \*hdr;+ const struct ice\_buf\_hdr \*hdr; u16 section\_count; u16 data\_end; - hdr = (struct ice\_buf\_hdr \*)buf->buf;+ hdr = (const struct ice\_buf\_hdr \*)buf->buf; /\* verify data \*/ section\_count = le16\_to\_cpu(hdr->section\_count); if (section\_count < ICE\_MIN\_S\_COUNT || section\_count > ICE\_MAX\_S\_COUNT)@@ -165,8 +165,8 @@ static struct ice\_buf\_table \*ice\_find\_buf\_table(struct ice\_seg \*ice\_seg) \* unexpected value has been detected (for example an invalid section count or \* an invalid buffer end value). \*/-static struct ice\_buf\_hdr \*ice\_pkg\_enum\_buf(struct ice\_seg \*ice\_seg,- struct ice\_pkg\_enum \*state)+static const struct ice\_buf\_hdr \*ice\_pkg\_enum\_buf(struct ice\_seg \*ice\_seg,+ struct ice\_pkg\_enum \*state) { if (ice\_seg) { state->buf\_table = ice\_find\_buf\_table(ice\_seg);@@ -1800,9 +1800,9 @@ int ice\_update\_pkg(struct ice\_hw \*hw, struct ice\_buf \*bufs, u32 count) \* success it returns a pointer to the segment header, otherwise it will \* return NULL. \*/-static struct ice\_generic\_seg\_hdr \*+static const struct ice\_generic\_seg\_hdr \* ice\_find\_seg\_in\_pkg(struct ice\_hw \*hw, u32 seg\_type,- struct ice\_pkg\_hdr \*pkg\_hdr)+ const struct ice\_pkg\_hdr \*pkg\_hdr) { u32 i; @@ -1813,11 +1813,9 @@ ice\_find\_seg\_in\_pkg(struct ice\_hw \*hw, u32 seg\_type,  /\* Search all package segments for the requested segment type \*/ for (i = 0; i < le32\_to\_cpu(pkg\_hdr->seg\_count); i++) {- struct ice\_generic\_seg\_hdr \*seg;+ const struct ice\_generic\_seg\_hdr \*seg; - seg = (struct ice\_generic\_seg\_hdr- \*)((u8 \*)pkg\_hdr +- le32\_to\_cpu(pkg\_hdr->seg\_offset[i]));+ seg = (void \*)pkg\_hdr + le32\_to\_cpu(pkg\_hdr->seg\_offset[i]);  if (le32\_to\_cpu(seg->seg\_type) == seg\_type) return seg;@@ -2354,12 +2352,12 @@ ice\_get\_set\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u16 buf\_size, \* \* Return: zero when update was successful, negative values otherwise. \*/-int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len)+int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, const void \*buf, u32 len) {- u8 \*current\_topo, \*new\_topo = NULL;- struct ice\_run\_time\_cfg\_seg \*seg;- struct ice\_buf\_hdr \*section;- struct ice\_pkg\_hdr \*pkg\_hdr;+ u8 \*new\_topo = NULL, \*topo \_\_free(kfree) = NULL;+ const struct ice\_run\_time\_cfg\_seg \*seg;+ const struct ice\_buf\_hdr \*section;+ const struct ice\_pkg\_hdr \*pkg\_hdr; enum ice\_ddp\_state state; u16 offset, size = 0; u32 reg = 0;@@ -2375,15 +2373,13 @@ int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len) return -EOPNOTSUPP; } - current\_topo = kzalloc(ICE\_AQ\_MAX\_BUF\_LEN, GFP\_KERNEL);- if (!current\_topo)+ topo = kzalloc(ICE\_AQ\_MAX\_BUF\_LEN, GFP\_KERNEL);+ if (!topo) return -ENOMEM; - /\* Get the current Tx topology \*/- status = ice\_get\_set\_tx\_topo(hw, current\_topo, ICE\_AQ\_MAX\_BUF\_LEN, NULL,- &flags, false);-- kfree(current\_topo);+ /\* Get the current Tx topology flags \*/+ status = ice\_get\_set\_tx\_topo(hw, topo, ICE\_AQ\_MAX\_BUF\_LEN, NULL, &flags,+ false);  if (status) { ice\_debug(hw, ICE\_DBG\_INIT, "Get current topology is failed\n");@@ -2419,7 +2415,7 @@ int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len) goto update\_topo; } - pkg\_hdr = (struct ice\_pkg\_hdr \*)buf;+ pkg\_hdr = (const struct ice\_pkg\_hdr \*)buf; state = ice\_verify\_pkg(pkg\_hdr, len); if (state) { ice\_debug(hw, ICE\_DBG\_INIT, "Failed to verify pkg (err: %d)\n",@@ -2428,7 +2424,7 @@ int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len) }  /\* Find runtime configuration segment \*/- seg = (struct ice\_run\_time\_cfg\_seg \*)+ seg = (const struct ice\_run\_time\_cfg\_seg \*) ice\_find\_seg\_in\_pkg(hw, SEGMENT\_TYPE\_ICE\_RUN\_TIME\_CFG, pkg\_hdr); if (!seg) { ice\_debug(hw, ICE\_DBG\_INIT, "5 layer topology segment is missing\n");@@ -2461,8 +2457,10 @@ int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len) return -EIO; } - /\* Get the new topology buffer \*/- new\_topo = ((u8 \*)section) + offset;+ /\* Get the new topology buffer, reuse current topo copy mem \*/+ static\_assert(ICE\_PKG\_BUF\_SIZE == ICE\_AQ\_MAX\_BUF\_LEN);+ new\_topo = topo;+ memcpy(new\_topo, (u8 \*)section + offset, size);  update\_topo: /\* Acquire global lock to make sure that set topology issueddiff --git a/drivers/net/ethernet/intel/ice/ice\_ddp.h b/drivers/net/ethernet/intel/ice/ice\_ddp.hindex 622543f08b4313..00840e5a107790 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ddp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ddp.h?id=d35f2aec214e108a2144f1a30773124d930fad0f)+++ b/[drivers/net/ethernet/intel/ice/ice\_ddp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ddp.h?id=43544b4e30732c3d88f423252281915d5bc739b6)@@ -430,7 +430,7 @@ struct ice\_pkg\_enum { u32 buf\_idx;  u32 type;- struct ice\_buf\_hdr \*buf;+ const struct ice\_buf\_hdr \*buf; u32 sect\_idx; void \*sect; u32 sect\_type;@@ -454,6 +454,6 @@ u16 ice\_pkg\_buf\_get\_active\_sections(struct ice\_buf\_build \*bld); void \*ice\_pkg\_enum\_section(struct ice\_seg \*ice\_seg, struct ice\_pkg\_enum \*state, u32 sect\_type); -int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len);+int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, const void \*buf, u32 len);  #endifdiff --git a/drivers/net/ethernet/intel/ice/ice\_main.c b/drivers/net/ethernet/intel/ice/ice\_main.cindex ea780d468579fa..a06dcf8367db09 100644--- a/[drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=d35f2aec214e108a2144f1a30773124d930fad0f)+++ b/[drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=43544b4e30732c3d88f423252281915d5bc739b6)@@ -4548,16 +4548,10 @@ ice\_init\_tx\_topology(struct ice\_hw \*hw, const struct firmware \*firmware) u8 num\_tx\_sched\_layers = hw->num\_tx\_sched\_layers; struct ice\_pf \*pf = hw->back; struct device \*dev;- u8 \*buf\_copy; int err;  dev = ice\_pf\_to\_dev(pf);- /\* ice\_cfg\_tx\_topo buf argument is not a constant,- \* so we have to make a copy- \*/- buf\_copy = kmemdup(firmware->data, firmware->size, GFP\_KERNEL);-- err = ice\_cfg\_tx\_topo(hw, buf\_copy, firmware->size);+ err = ice\_cfg\_tx\_topo(hw, firmware->data, firmware->size); if (!err) { if (hw->num\_tx\_sched\_layers > num\_tx\_sched\_layers) dev\_info(dev, "Tx scheduling layers switching feature disabled\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:40:56 +0000



=== Content from git.kernel.org_c1a8bfe3_20250114_184219.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c188afdc36113760873ec78cbc036f6b05f77621)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c188afdc36113760873ec78cbc036f6b05f77621)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c188afdc36113760873ec78cbc036f6b05f77621)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c188afdc36113760873ec78cbc036f6b05f77621)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Przemek Kitszel <przemyslaw.kitszel@intel.com> | 2024-09-10 15:57:21 +0200 |
| --- | --- | --- |
| committer | Tony Nguyen <anthony.l.nguyen@intel.com> | 2024-09-30 14:23:31 -0700 |
| commit | [c188afdc36113760873ec78cbc036f6b05f77621](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c188afdc36113760873ec78cbc036f6b05f77621) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c188afdc36113760873ec78cbc036f6b05f77621)) | |
| tree | [ff6f9cda150e4886cfc89be6dff3f00adeeae6ea](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c188afdc36113760873ec78cbc036f6b05f77621) | |
| parent | [d019b1a9128d65956f04679ec2bb8b0800f13358](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d019b1a9128d65956f04679ec2bb8b0800f13358) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c188afdc36113760873ec78cbc036f6b05f77621&id2=d019b1a9128d65956f04679ec2bb8b0800f13358)) | |
| download | [linux-c188afdc36113760873ec78cbc036f6b05f77621.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c188afdc36113760873ec78cbc036f6b05f77621.tar.gz) | |

ice: fix memleak in ice\_init\_tx\_topology()Fix leak of the FW blob (DDP pkg).
Make ice\_cfg\_tx\_topo() const-correct, so ice\_init\_tx\_topology() can avoid
copying whole FW blob. Copy just the topology section, and only when
needed. Reuse the buffer allocated for the read of the current topology.
This was found by kmemleak, with the following trace for each PF:
[<ffffffff8761044d>] kmemdup\_noprof+0x1d/0x50
[<ffffffffc0a0a480>] ice\_init\_ddp\_config+0x100/0x220 [ice]
[<ffffffffc0a0da7f>] ice\_init\_dev+0x6f/0x200 [ice]
[<ffffffffc0a0dc49>] ice\_init+0x29/0x560 [ice]
[<ffffffffc0a10c1d>] ice\_probe+0x21d/0x310 [ice]
Constify ice\_cfg\_tx\_topo() @buf parameter.
This cascades further down to few more functions.
Fixes: cc5776fe1832 ("ice: Enable switching default Tx scheduler topology")
CC: Larysa Zaremba <larysa.zaremba@intel.com>
CC: Jacob Keller <jacob.e.keller@intel.com>
CC: Pucha Himasekhar Reddy <himasekharx.reddy.pucha@intel.com>
CC: Mateusz Polchlopek <mateusz.polchlopek@intel.com>
Signed-off-by: Przemek Kitszel <przemyslaw.kitszel@intel.com>
Reviewed-by: Jacob Keller <jacob.e.keller@intel.com>
Tested-by: Pucha Himasekhar Reddy <himasekharx.reddy.pucha@intel.com> (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c188afdc36113760873ec78cbc036f6b05f77621)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ddp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ddp.c?id=c188afdc36113760873ec78cbc036f6b05f77621) | 58 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_ddp.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_ddp.h?id=c188afdc36113760873ec78cbc036f6b05f77621) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_main.c?id=c188afdc36113760873ec78cbc036f6b05f77621) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 31 insertions, 39 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_ddp.c b/drivers/net/ethernet/intel/ice/ice\_ddp.cindex 953262b88a586f..272fd823a825d0 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ddp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ddp.c?id=d019b1a9128d65956f04679ec2bb8b0800f13358)+++ b/[drivers/net/ethernet/intel/ice/ice\_ddp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ddp.c?id=c188afdc36113760873ec78cbc036f6b05f77621)@@ -31,7 +31,7 @@ static const struct ice\_tunnel\_type\_scan tnls[] = { \* Verifies various attributes of the package file, including length, format \* version, and the requirement of at least one segment. \*/-static enum ice\_ddp\_state ice\_verify\_pkg(struct ice\_pkg\_hdr \*pkg, u32 len)+static enum ice\_ddp\_state ice\_verify\_pkg(const struct ice\_pkg\_hdr \*pkg, u32 len) { u32 seg\_count; u32 i;@@ -57,13 +57,13 @@ static enum ice\_ddp\_state ice\_verify\_pkg(struct ice\_pkg\_hdr \*pkg, u32 len) /\* all segments must fit within length \*/ for (i = 0; i < seg\_count; i++) { u32 off = le32\_to\_cpu(pkg->seg\_offset[i]);- struct ice\_generic\_seg\_hdr \*seg;+ const struct ice\_generic\_seg\_hdr \*seg;  /\* segment header must fit \*/ if (len < off + sizeof(\*seg)) return ICE\_DDP\_PKG\_INVALID\_FILE; - seg = (struct ice\_generic\_seg\_hdr \*)((u8 \*)pkg + off);+ seg = (void \*)pkg + off;  /\* segment body must fit \*/ if (len < off + le32\_to\_cpu(seg->seg\_size))@@ -119,13 +119,13 @@ static enum ice\_ddp\_state ice\_chk\_pkg\_version(struct ice\_pkg\_ver \*pkg\_ver) \* \* This helper function validates a buffer's header. \*/-static struct ice\_buf\_hdr \*ice\_pkg\_val\_buf(struct ice\_buf \*buf)+static const struct ice\_buf\_hdr \*ice\_pkg\_val\_buf(const struct ice\_buf \*buf) {- struct ice\_buf\_hdr \*hdr;+ const struct ice\_buf\_hdr \*hdr; u16 section\_count; u16 data\_end; - hdr = (struct ice\_buf\_hdr \*)buf->buf;+ hdr = (const struct ice\_buf\_hdr \*)buf->buf; /\* verify data \*/ section\_count = le16\_to\_cpu(hdr->section\_count); if (section\_count < ICE\_MIN\_S\_COUNT || section\_count > ICE\_MAX\_S\_COUNT)@@ -165,8 +165,8 @@ static struct ice\_buf\_table \*ice\_find\_buf\_table(struct ice\_seg \*ice\_seg) \* unexpected value has been detected (for example an invalid section count or \* an invalid buffer end value). \*/-static struct ice\_buf\_hdr \*ice\_pkg\_enum\_buf(struct ice\_seg \*ice\_seg,- struct ice\_pkg\_enum \*state)+static const struct ice\_buf\_hdr \*ice\_pkg\_enum\_buf(struct ice\_seg \*ice\_seg,+ struct ice\_pkg\_enum \*state) { if (ice\_seg) { state->buf\_table = ice\_find\_buf\_table(ice\_seg);@@ -1800,9 +1800,9 @@ int ice\_update\_pkg(struct ice\_hw \*hw, struct ice\_buf \*bufs, u32 count) \* success it returns a pointer to the segment header, otherwise it will \* return NULL. \*/-static struct ice\_generic\_seg\_hdr \*+static const struct ice\_generic\_seg\_hdr \* ice\_find\_seg\_in\_pkg(struct ice\_hw \*hw, u32 seg\_type,- struct ice\_pkg\_hdr \*pkg\_hdr)+ const struct ice\_pkg\_hdr \*pkg\_hdr) { u32 i; @@ -1813,11 +1813,9 @@ ice\_find\_seg\_in\_pkg(struct ice\_hw \*hw, u32 seg\_type,  /\* Search all package segments for the requested segment type \*/ for (i = 0; i < le32\_to\_cpu(pkg\_hdr->seg\_count); i++) {- struct ice\_generic\_seg\_hdr \*seg;+ const struct ice\_generic\_seg\_hdr \*seg; - seg = (struct ice\_generic\_seg\_hdr- \*)((u8 \*)pkg\_hdr +- le32\_to\_cpu(pkg\_hdr->seg\_offset[i]));+ seg = (void \*)pkg\_hdr + le32\_to\_cpu(pkg\_hdr->seg\_offset[i]);  if (le32\_to\_cpu(seg->seg\_type) == seg\_type) return seg;@@ -2354,12 +2352,12 @@ ice\_get\_set\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u16 buf\_size, \* \* Return: zero when update was successful, negative values otherwise. \*/-int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len)+int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, const void \*buf, u32 len) {- u8 \*current\_topo, \*new\_topo = NULL;- struct ice\_run\_time\_cfg\_seg \*seg;- struct ice\_buf\_hdr \*section;- struct ice\_pkg\_hdr \*pkg\_hdr;+ u8 \*new\_topo = NULL, \*topo \_\_free(kfree) = NULL;+ const struct ice\_run\_time\_cfg\_seg \*seg;+ const struct ice\_buf\_hdr \*section;+ const struct ice\_pkg\_hdr \*pkg\_hdr; enum ice\_ddp\_state state; u16 offset, size = 0; u32 reg = 0;@@ -2375,15 +2373,13 @@ int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len) return -EOPNOTSUPP; } - current\_topo = kzalloc(ICE\_AQ\_MAX\_BUF\_LEN, GFP\_KERNEL);- if (!current\_topo)+ topo = kzalloc(ICE\_AQ\_MAX\_BUF\_LEN, GFP\_KERNEL);+ if (!topo) return -ENOMEM; - /\* Get the current Tx topology \*/- status = ice\_get\_set\_tx\_topo(hw, current\_topo, ICE\_AQ\_MAX\_BUF\_LEN, NULL,- &flags, false);-- kfree(current\_topo);+ /\* Get the current Tx topology flags \*/+ status = ice\_get\_set\_tx\_topo(hw, topo, ICE\_AQ\_MAX\_BUF\_LEN, NULL, &flags,+ false);  if (status) { ice\_debug(hw, ICE\_DBG\_INIT, "Get current topology is failed\n");@@ -2419,7 +2415,7 @@ int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len) goto update\_topo; } - pkg\_hdr = (struct ice\_pkg\_hdr \*)buf;+ pkg\_hdr = (const struct ice\_pkg\_hdr \*)buf; state = ice\_verify\_pkg(pkg\_hdr, len); if (state) { ice\_debug(hw, ICE\_DBG\_INIT, "Failed to verify pkg (err: %d)\n",@@ -2428,7 +2424,7 @@ int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len) }  /\* Find runtime configuration segment \*/- seg = (struct ice\_run\_time\_cfg\_seg \*)+ seg = (const struct ice\_run\_time\_cfg\_seg \*) ice\_find\_seg\_in\_pkg(hw, SEGMENT\_TYPE\_ICE\_RUN\_TIME\_CFG, pkg\_hdr); if (!seg) { ice\_debug(hw, ICE\_DBG\_INIT, "5 layer topology segment is missing\n");@@ -2461,8 +2457,10 @@ int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len) return -EIO; } - /\* Get the new topology buffer \*/- new\_topo = ((u8 \*)section) + offset;+ /\* Get the new topology buffer, reuse current topo copy mem \*/+ static\_assert(ICE\_PKG\_BUF\_SIZE == ICE\_AQ\_MAX\_BUF\_LEN);+ new\_topo = topo;+ memcpy(new\_topo, (u8 \*)section + offset, size);  update\_topo: /\* Acquire global lock to make sure that set topology issueddiff --git a/drivers/net/ethernet/intel/ice/ice\_ddp.h b/drivers/net/ethernet/intel/ice/ice\_ddp.hindex 97f27231747548..79551da2a4b022 100644--- a/[drivers/net/ethernet/intel/ice/ice\_ddp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ddp.h?id=d019b1a9128d65956f04679ec2bb8b0800f13358)+++ b/[drivers/net/ethernet/intel/ice/ice\_ddp.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_ddp.h?id=c188afdc36113760873ec78cbc036f6b05f77621)@@ -438,7 +438,7 @@ struct ice\_pkg\_enum { u32 buf\_idx;  u32 type;- struct ice\_buf\_hdr \*buf;+ const struct ice\_buf\_hdr \*buf; u32 sect\_idx; void \*sect; u32 sect\_type;@@ -467,6 +467,6 @@ ice\_pkg\_enum\_entry(struct ice\_seg \*ice\_seg, struct ice\_pkg\_enum \*state, void \*ice\_pkg\_enum\_section(struct ice\_seg \*ice\_seg, struct ice\_pkg\_enum \*state, u32 sect\_type); -int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, u8 \*buf, u32 len);+int ice\_cfg\_tx\_topo(struct ice\_hw \*hw, const void \*buf, u32 len);  #endifdiff --git a/drivers/net/ethernet/intel/ice/ice\_main.c b/drivers/net/ethernet/intel/ice/ice\_main.cindex eeb48cc48e089f..fbab72fab79ca7 100644--- a/[drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=d019b1a9128d65956f04679ec2bb8b0800f13358)+++ b/[drivers/net/ethernet/intel/ice/ice\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=c188afdc36113760873ec78cbc036f6b05f77621)@@ -4536,16 +4536,10 @@ ice\_init\_tx\_topology(struct ice\_hw \*hw, const struct firmware \*firmware) u8 num\_tx\_sched\_layers = hw->num\_tx\_sched\_layers; struct ice\_pf \*pf = hw->back; struct device \*dev;- u8 \*buf\_copy; int err;  dev = ice\_pf\_to\_dev(pf);- /\* ice\_cfg\_tx\_topo buf argument is not a constant,- \* so we have to make a copy- \*/- buf\_copy = kmemdup(firmware->data, firmware->size, GFP\_KERNEL);-- err = ice\_cfg\_tx\_topo(hw, buf\_copy, firmware->size);+ err = ice\_cfg\_tx\_topo(hw, firmware->data, firmware->size); if (!err) { if (hw->num\_tx\_sched\_layers > num\_tx\_sched\_layers) dev\_info(dev, "Tx scheduling layers switching feature disabled\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:40:56 +0000


