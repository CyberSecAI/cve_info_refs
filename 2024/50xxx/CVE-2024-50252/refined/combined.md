=== Content from git.kernel.org_8276c5c2_20250114_184202.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-10-25 16:26:28 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-10-30 18:24:39 -0700 |
| commit | [12ae97c531fcd3bfd774d4dfeaeac23eafe24280](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280)) | |
| tree | [03f639f5728d78b9930e62a6fd66cbe81ee040fb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280) | |
| parent | [d0fbdc3ae9ecc614ddffde55dccbcacef353da0b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0fbdc3ae9ecc614ddffde55dccbcacef353da0b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280&id2=d0fbdc3ae9ecc614ddffde55dccbcacef353da0b)) | |
| download | [linux-12ae97c531fcd3bfd774d4dfeaeac23eafe24280.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-12ae97c531fcd3bfd774d4dfeaeac23eafe24280.tar.gz) | |

mlxsw: spectrum\_ipip: Fix memory leak when changing remote IPv6 addressThe device stores IPv6 addresses that are used for encapsulation in
linear memory that is managed by the driver.
Changing the remote address of an ip6gre net device never worked
properly, but since cited commit the following reproducer [1] would
result in a warning [2] and a memory leak [3]. The problem is that the
new remote address is never added by the driver to its hash table (and
therefore the device) and the old address is never removed from it.
Fix by programming the new address when the configuration of the ip6gre
net device changes and removing the old one. If the address did not
change, then the above would result in increasing the reference count of
the address and then decreasing it.
[1]
# ip link add name bla up type ip6gre local 2001:db8:1::1 remote 2001:db8:2::1 tos inherit ttl inherit
# ip link set dev bla type ip6gre remote 2001:db8:3::1
# ip link del dev bla
# devlink dev reload pci/0000:01:00.0
[2]
WARNING: CPU: 0 PID: 1682 at drivers/net/ethernet/mellanox/mlxsw/spectrum.c:3002 mlxsw\_sp\_ipv6\_addr\_put+0x140/0x1d0
Modules linked in:
CPU: 0 UID: 0 PID: 1682 Comm: ip Not tainted 6.12.0-rc3-custom-g86b5b55bc835 #151
Hardware name: Nvidia SN5600/VMOD0013, BIOS 5.13 05/31/2023
RIP: 0010:mlxsw\_sp\_ipv6\_addr\_put+0x140/0x1d0
[...]
Call Trace:
<TASK>
mlxsw\_sp\_router\_netdevice\_event+0x55f/0x1240
notifier\_call\_chain+0x5a/0xd0
call\_netdevice\_notifiers\_info+0x39/0x90
unregister\_netdevice\_many\_notify+0x63e/0x9d0
rtnl\_dellink+0x16b/0x3a0
rtnetlink\_rcv\_msg+0x142/0x3f0
netlink\_rcv\_skb+0x50/0x100
netlink\_unicast+0x242/0x390
netlink\_sendmsg+0x1de/0x420
\_\_\_\_sys\_sendmsg+0x2bd/0x320
\_\_\_sys\_sendmsg+0x9a/0xe0
\_\_sys\_sendmsg+0x7a/0xd0
do\_syscall\_64+0x9e/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
[3]
unreferenced object 0xffff898081f597a0 (size 32):
comm "ip", pid 1626, jiffies 4294719324
hex dump (first 32 bytes):
20 01 0d b8 00 02 00 00 00 00 00 00 00 00 00 01 ...............
21 49 61 83 80 89 ff ff 00 00 00 00 01 00 00 00 !Ia.............
backtrace (crc fd9be911):
[<00000000df89c55d>] \_\_kmalloc\_cache\_noprof+0x1da/0x260
[<00000000ff2a1ddb>] mlxsw\_sp\_ipv6\_addr\_kvdl\_index\_get+0x281/0x340
[<000000009ddd445d>] mlxsw\_sp\_router\_netdevice\_event+0x47b/0x1240
[<00000000743e7757>] notifier\_call\_chain+0x5a/0xd0
[<000000007c7b9e13>] call\_netdevice\_notifiers\_info+0x39/0x90
[<000000002509645d>] register\_netdevice+0x5f7/0x7a0
[<00000000c2e7d2a9>] ip6gre\_newlink\_common.isra.0+0x65/0x130
[<0000000087cd6d8d>] ip6gre\_newlink+0x72/0x120
[<000000004df7c7cc>] rtnl\_newlink+0x471/0xa20
[<0000000057ed632a>] rtnetlink\_rcv\_msg+0x142/0x3f0
[<0000000032e0d5b5>] netlink\_rcv\_skb+0x50/0x100
[<00000000908bca63>] netlink\_unicast+0x242/0x390
[<00000000cdbe1c87>] netlink\_sendmsg+0x1de/0x420
[<0000000011db153e>] \_\_\_\_sys\_sendmsg+0x2bd/0x320
[<000000003b6d53eb>] \_\_\_sys\_sendmsg+0x9a/0xe0
[<00000000cae27c62>] \_\_sys\_sendmsg+0x7a/0xd0
Fixes: cf42911523e0 ("mlxsw: spectrum\_ipip: Use common hash table for IPv6 address mapping")
Reported-by: Maksym Yaremchuk <maksymy@nvidia.com>
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Signed-off-by: Petr Machata <petrm@nvidia.com>
Link: [https://patch.msgid.link/e91012edc5a6cb9df37b78fd377f669381facfcb.1729866134.git.petrm@nvidia.com](https://patch.msgid.link/e91012edc5a6cb9df37b78fd377f669381facfcb.1729866134.git.petrm%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c b/drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.cindex d761a1235994cc..7ea798a4949e2d 100644--- a/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=d0fbdc3ae9ecc614ddffde55dccbcacef353da0b)+++ b/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=12ae97c531fcd3bfd774d4dfeaeac23eafe24280)@@ -481,11 +481,33 @@ mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre6(struct mlxsw\_sp \*mlxsw\_sp, struct mlxsw\_sp\_ipip\_entry \*ipip\_entry, struct netlink\_ext\_ack \*extack) {+ u32 new\_kvdl\_index, old\_kvdl\_index = ipip\_entry->dip\_kvdl\_index;+ struct in6\_addr old\_addr6 = ipip\_entry->parms.daddr.addr6; struct mlxsw\_sp\_ipip\_parms new\_parms;+ int err;  new\_parms = mlxsw\_sp\_ipip\_netdev\_parms\_init\_gre6(ipip\_entry->ol\_dev);- return mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre(mlxsw\_sp, ipip\_entry,- &new\_parms, extack);++ err = mlxsw\_sp\_ipv6\_addr\_kvdl\_index\_get(mlxsw\_sp,+ &new\_parms.daddr.addr6,+ &new\_kvdl\_index);+ if (err)+ return err;+ ipip\_entry->dip\_kvdl\_index = new\_kvdl\_index;++ err = mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre(mlxsw\_sp, ipip\_entry,+ &new\_parms, extack);+ if (err)+ goto err\_change\_gre;++ mlxsw\_sp\_ipv6\_addr\_put(mlxsw\_sp, &old\_addr6);++ return 0;++err\_change\_gre:+ ipip\_entry->dip\_kvdl\_index = old\_kvdl\_index;+ mlxsw\_sp\_ipv6\_addr\_put(mlxsw\_sp, &new\_parms.daddr.addr6);+ return err; }  static int |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:40:39 +0000



=== Content from git.kernel.org_7e0e19c4_20250114_184202.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=31384aa2ad05c29c7745000f321154f42de24d1a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31384aa2ad05c29c7745000f321154f42de24d1a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31384aa2ad05c29c7745000f321154f42de24d1a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31384aa2ad05c29c7745000f321154f42de24d1a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-10-25 16:26:28 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:19 +0100 |
| commit | [31384aa2ad05c29c7745000f321154f42de24d1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31384aa2ad05c29c7745000f321154f42de24d1a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=31384aa2ad05c29c7745000f321154f42de24d1a)) | |
| tree | [de15e52bf7c2a5ca52f4b9c319e80ac0db50745c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31384aa2ad05c29c7745000f321154f42de24d1a) | |
| parent | [598f95742fdc6538e5a1c64ae9dbcdfa5ea2edc1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=598f95742fdc6538e5a1c64ae9dbcdfa5ea2edc1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31384aa2ad05c29c7745000f321154f42de24d1a&id2=598f95742fdc6538e5a1c64ae9dbcdfa5ea2edc1)) | |
| download | [linux-31384aa2ad05c29c7745000f321154f42de24d1a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-31384aa2ad05c29c7745000f321154f42de24d1a.tar.gz) | |

mlxsw: spectrum\_ipip: Fix memory leak when changing remote IPv6 address[ Upstream commit 12ae97c531fcd3bfd774d4dfeaeac23eafe24280 ]
The device stores IPv6 addresses that are used for encapsulation in
linear memory that is managed by the driver.
Changing the remote address of an ip6gre net device never worked
properly, but since cited commit the following reproducer [1] would
result in a warning [2] and a memory leak [3]. The problem is that the
new remote address is never added by the driver to its hash table (and
therefore the device) and the old address is never removed from it.
Fix by programming the new address when the configuration of the ip6gre
net device changes and removing the old one. If the address did not
change, then the above would result in increasing the reference count of
the address and then decreasing it.
[1]
# ip link add name bla up type ip6gre local 2001:db8:1::1 remote 2001:db8:2::1 tos inherit ttl inherit
# ip link set dev bla type ip6gre remote 2001:db8:3::1
# ip link del dev bla
# devlink dev reload pci/0000:01:00.0
[2]
WARNING: CPU: 0 PID: 1682 at drivers/net/ethernet/mellanox/mlxsw/spectrum.c:3002 mlxsw\_sp\_ipv6\_addr\_put+0x140/0x1d0
Modules linked in:
CPU: 0 UID: 0 PID: 1682 Comm: ip Not tainted 6.12.0-rc3-custom-g86b5b55bc835 #151
Hardware name: Nvidia SN5600/VMOD0013, BIOS 5.13 05/31/2023
RIP: 0010:mlxsw\_sp\_ipv6\_addr\_put+0x140/0x1d0
[...]
Call Trace:
<TASK>
mlxsw\_sp\_router\_netdevice\_event+0x55f/0x1240
notifier\_call\_chain+0x5a/0xd0
call\_netdevice\_notifiers\_info+0x39/0x90
unregister\_netdevice\_many\_notify+0x63e/0x9d0
rtnl\_dellink+0x16b/0x3a0
rtnetlink\_rcv\_msg+0x142/0x3f0
netlink\_rcv\_skb+0x50/0x100
netlink\_unicast+0x242/0x390
netlink\_sendmsg+0x1de/0x420
\_\_\_\_sys\_sendmsg+0x2bd/0x320
\_\_\_sys\_sendmsg+0x9a/0xe0
\_\_sys\_sendmsg+0x7a/0xd0
do\_syscall\_64+0x9e/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
[3]
unreferenced object 0xffff898081f597a0 (size 32):
comm "ip", pid 1626, jiffies 4294719324
hex dump (first 32 bytes):
20 01 0d b8 00 02 00 00 00 00 00 00 00 00 00 01 ...............
21 49 61 83 80 89 ff ff 00 00 00 00 01 00 00 00 !Ia.............
backtrace (crc fd9be911):
[<00000000df89c55d>] \_\_kmalloc\_cache\_noprof+0x1da/0x260
[<00000000ff2a1ddb>] mlxsw\_sp\_ipv6\_addr\_kvdl\_index\_get+0x281/0x340
[<000000009ddd445d>] mlxsw\_sp\_router\_netdevice\_event+0x47b/0x1240
[<00000000743e7757>] notifier\_call\_chain+0x5a/0xd0
[<000000007c7b9e13>] call\_netdevice\_notifiers\_info+0x39/0x90
[<000000002509645d>] register\_netdevice+0x5f7/0x7a0
[<00000000c2e7d2a9>] ip6gre\_newlink\_common.isra.0+0x65/0x130
[<0000000087cd6d8d>] ip6gre\_newlink+0x72/0x120
[<000000004df7c7cc>] rtnl\_newlink+0x471/0xa20
[<0000000057ed632a>] rtnetlink\_rcv\_msg+0x142/0x3f0
[<0000000032e0d5b5>] netlink\_rcv\_skb+0x50/0x100
[<00000000908bca63>] netlink\_unicast+0x242/0x390
[<00000000cdbe1c87>] netlink\_sendmsg+0x1de/0x420
[<0000000011db153e>] \_\_\_\_sys\_sendmsg+0x2bd/0x320
[<000000003b6d53eb>] \_\_\_sys\_sendmsg+0x9a/0xe0
[<00000000cae27c62>] \_\_sys\_sendmsg+0x7a/0xd0
Fixes: cf42911523e0 ("mlxsw: spectrum\_ipip: Use common hash table for IPv6 address mapping")
Reported-by: Maksym Yaremchuk <maksymy@nvidia.com>
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Signed-off-by: Petr Machata <petrm@nvidia.com>
Link: [https://patch.msgid.link/e91012edc5a6cb9df37b78fd377f669381facfcb.1729866134.git.petrm@nvidia.com](https://patch.msgid.link/e91012edc5a6cb9df37b78fd377f669381facfcb.1729866134.git.petrm%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31384aa2ad05c29c7745000f321154f42de24d1a)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=31384aa2ad05c29c7745000f321154f42de24d1a) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c b/drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.cindex 3340b4a694c3ef..cbded3ed645057 100644--- a/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=598f95742fdc6538e5a1c64ae9dbcdfa5ea2edc1)+++ b/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=31384aa2ad05c29c7745000f321154f42de24d1a)@@ -471,11 +471,33 @@ mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre6(struct mlxsw\_sp \*mlxsw\_sp, struct mlxsw\_sp\_ipip\_entry \*ipip\_entry, struct netlink\_ext\_ack \*extack) {+ u32 new\_kvdl\_index, old\_kvdl\_index = ipip\_entry->dip\_kvdl\_index;+ struct in6\_addr old\_addr6 = ipip\_entry->parms.daddr.addr6; struct mlxsw\_sp\_ipip\_parms new\_parms;+ int err;  new\_parms = mlxsw\_sp\_ipip\_netdev\_parms\_init\_gre6(ipip\_entry->ol\_dev);- return mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre(mlxsw\_sp, ipip\_entry,- &new\_parms, extack);++ err = mlxsw\_sp\_ipv6\_addr\_kvdl\_index\_get(mlxsw\_sp,+ &new\_parms.daddr.addr6,+ &new\_kvdl\_index);+ if (err)+ return err;+ ipip\_entry->dip\_kvdl\_index = new\_kvdl\_index;++ err = mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre(mlxsw\_sp, ipip\_entry,+ &new\_parms, extack);+ if (err)+ goto err\_change\_gre;++ mlxsw\_sp\_ipv6\_addr\_put(mlxsw\_sp, &old\_addr6);++ return 0;++err\_change\_gre:+ ipip\_entry->dip\_kvdl\_index = old\_kvdl\_index;+ mlxsw\_sp\_ipv6\_addr\_put(mlxsw\_sp, &new\_parms.daddr.addr6);+ return err; }  static int |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:40:39 +0000



=== Content from git.kernel.org_1ed16b46_20250114_184203.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-10-25 16:26:28 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:42 +0100 |
| commit | [d8f298eb6659eb6a38e26b79e77de4449dc6e61b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b)) | |
| tree | [245e896c47c8c7d1e31bfad2beb612ba68010800](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b) | |
| parent | [637edb11563e45daf52eb4c37e7f23cb206a459a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=637edb11563e45daf52eb4c37e7f23cb206a459a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b&id2=637edb11563e45daf52eb4c37e7f23cb206a459a)) | |
| download | [linux-d8f298eb6659eb6a38e26b79e77de4449dc6e61b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d8f298eb6659eb6a38e26b79e77de4449dc6e61b.tar.gz) | |

mlxsw: spectrum\_ipip: Fix memory leak when changing remote IPv6 address[ Upstream commit 12ae97c531fcd3bfd774d4dfeaeac23eafe24280 ]
The device stores IPv6 addresses that are used for encapsulation in
linear memory that is managed by the driver.
Changing the remote address of an ip6gre net device never worked
properly, but since cited commit the following reproducer [1] would
result in a warning [2] and a memory leak [3]. The problem is that the
new remote address is never added by the driver to its hash table (and
therefore the device) and the old address is never removed from it.
Fix by programming the new address when the configuration of the ip6gre
net device changes and removing the old one. If the address did not
change, then the above would result in increasing the reference count of
the address and then decreasing it.
[1]
# ip link add name bla up type ip6gre local 2001:db8:1::1 remote 2001:db8:2::1 tos inherit ttl inherit
# ip link set dev bla type ip6gre remote 2001:db8:3::1
# ip link del dev bla
# devlink dev reload pci/0000:01:00.0
[2]
WARNING: CPU: 0 PID: 1682 at drivers/net/ethernet/mellanox/mlxsw/spectrum.c:3002 mlxsw\_sp\_ipv6\_addr\_put+0x140/0x1d0
Modules linked in:
CPU: 0 UID: 0 PID: 1682 Comm: ip Not tainted 6.12.0-rc3-custom-g86b5b55bc835 #151
Hardware name: Nvidia SN5600/VMOD0013, BIOS 5.13 05/31/2023
RIP: 0010:mlxsw\_sp\_ipv6\_addr\_put+0x140/0x1d0
[...]
Call Trace:
<TASK>
mlxsw\_sp\_router\_netdevice\_event+0x55f/0x1240
notifier\_call\_chain+0x5a/0xd0
call\_netdevice\_notifiers\_info+0x39/0x90
unregister\_netdevice\_many\_notify+0x63e/0x9d0
rtnl\_dellink+0x16b/0x3a0
rtnetlink\_rcv\_msg+0x142/0x3f0
netlink\_rcv\_skb+0x50/0x100
netlink\_unicast+0x242/0x390
netlink\_sendmsg+0x1de/0x420
\_\_\_\_sys\_sendmsg+0x2bd/0x320
\_\_\_sys\_sendmsg+0x9a/0xe0
\_\_sys\_sendmsg+0x7a/0xd0
do\_syscall\_64+0x9e/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
[3]
unreferenced object 0xffff898081f597a0 (size 32):
comm "ip", pid 1626, jiffies 4294719324
hex dump (first 32 bytes):
20 01 0d b8 00 02 00 00 00 00 00 00 00 00 00 01 ...............
21 49 61 83 80 89 ff ff 00 00 00 00 01 00 00 00 !Ia.............
backtrace (crc fd9be911):
[<00000000df89c55d>] \_\_kmalloc\_cache\_noprof+0x1da/0x260
[<00000000ff2a1ddb>] mlxsw\_sp\_ipv6\_addr\_kvdl\_index\_get+0x281/0x340
[<000000009ddd445d>] mlxsw\_sp\_router\_netdevice\_event+0x47b/0x1240
[<00000000743e7757>] notifier\_call\_chain+0x5a/0xd0
[<000000007c7b9e13>] call\_netdevice\_notifiers\_info+0x39/0x90
[<000000002509645d>] register\_netdevice+0x5f7/0x7a0
[<00000000c2e7d2a9>] ip6gre\_newlink\_common.isra.0+0x65/0x130
[<0000000087cd6d8d>] ip6gre\_newlink+0x72/0x120
[<000000004df7c7cc>] rtnl\_newlink+0x471/0xa20
[<0000000057ed632a>] rtnetlink\_rcv\_msg+0x142/0x3f0
[<0000000032e0d5b5>] netlink\_rcv\_skb+0x50/0x100
[<00000000908bca63>] netlink\_unicast+0x242/0x390
[<00000000cdbe1c87>] netlink\_sendmsg+0x1de/0x420
[<0000000011db153e>] \_\_\_\_sys\_sendmsg+0x2bd/0x320
[<000000003b6d53eb>] \_\_\_sys\_sendmsg+0x9a/0xe0
[<00000000cae27c62>] \_\_sys\_sendmsg+0x7a/0xd0
Fixes: cf42911523e0 ("mlxsw: spectrum\_ipip: Use common hash table for IPv6 address mapping")
Reported-by: Maksym Yaremchuk <maksymy@nvidia.com>
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Signed-off-by: Petr Machata <petrm@nvidia.com>
Link: [https://patch.msgid.link/e91012edc5a6cb9df37b78fd377f669381facfcb.1729866134.git.petrm@nvidia.com](https://patch.msgid.link/e91012edc5a6cb9df37b78fd377f669381facfcb.1729866134.git.petrm%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c b/drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.cindex fd421fbfc71bd3..0888d2d16375c9 100644--- a/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=637edb11563e45daf52eb4c37e7f23cb206a459a)+++ b/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=d8f298eb6659eb6a38e26b79e77de4449dc6e61b)@@ -538,11 +538,33 @@ mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre6(struct mlxsw\_sp \*mlxsw\_sp, struct mlxsw\_sp\_ipip\_entry \*ipip\_entry, struct netlink\_ext\_ack \*extack) {+ u32 new\_kvdl\_index, old\_kvdl\_index = ipip\_entry->dip\_kvdl\_index;+ struct in6\_addr old\_addr6 = ipip\_entry->parms.daddr.addr6; struct mlxsw\_sp\_ipip\_parms new\_parms;+ int err;  new\_parms = mlxsw\_sp\_ipip\_netdev\_parms\_init\_gre6(ipip\_entry->ol\_dev);- return mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre(mlxsw\_sp, ipip\_entry,- &new\_parms, extack);++ err = mlxsw\_sp\_ipv6\_addr\_kvdl\_index\_get(mlxsw\_sp,+ &new\_parms.daddr.addr6,+ &new\_kvdl\_index);+ if (err)+ return err;+ ipip\_entry->dip\_kvdl\_index = new\_kvdl\_index;++ err = mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre(mlxsw\_sp, ipip\_entry,+ &new\_parms, extack);+ if (err)+ goto err\_change\_gre;++ mlxsw\_sp\_ipv6\_addr\_put(mlxsw\_sp, &old\_addr6);++ return 0;++err\_change\_gre:+ ipip\_entry->dip\_kvdl\_index = old\_kvdl\_index;+ mlxsw\_sp\_ipv6\_addr\_put(mlxsw\_sp, &new\_parms.daddr.addr6);+ return err; }  static int |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:40:40 +0000



=== Content from git.kernel.org_eb4f1512_20250114_184202.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-10-25 16:26:28 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:48 +0100 |
| commit | [c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942)) | |
| tree | [04ac5d2b3284b2df34c69c78dbb727b2f52ebd72](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942) | |
| parent | [321d697c717b361eb1d12a3f11384c5baf3f64d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=321d697c717b361eb1d12a3f11384c5baf3f64d3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942&id2=321d697c717b361eb1d12a3f11384c5baf3f64d3)) | |
| download | [linux-c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942.tar.gz) | |

mlxsw: spectrum\_ipip: Fix memory leak when changing remote IPv6 address[ Upstream commit 12ae97c531fcd3bfd774d4dfeaeac23eafe24280 ]
The device stores IPv6 addresses that are used for encapsulation in
linear memory that is managed by the driver.
Changing the remote address of an ip6gre net device never worked
properly, but since cited commit the following reproducer [1] would
result in a warning [2] and a memory leak [3]. The problem is that the
new remote address is never added by the driver to its hash table (and
therefore the device) and the old address is never removed from it.
Fix by programming the new address when the configuration of the ip6gre
net device changes and removing the old one. If the address did not
change, then the above would result in increasing the reference count of
the address and then decreasing it.
[1]
# ip link add name bla up type ip6gre local 2001:db8:1::1 remote 2001:db8:2::1 tos inherit ttl inherit
# ip link set dev bla type ip6gre remote 2001:db8:3::1
# ip link del dev bla
# devlink dev reload pci/0000:01:00.0
[2]
WARNING: CPU: 0 PID: 1682 at drivers/net/ethernet/mellanox/mlxsw/spectrum.c:3002 mlxsw\_sp\_ipv6\_addr\_put+0x140/0x1d0
Modules linked in:
CPU: 0 UID: 0 PID: 1682 Comm: ip Not tainted 6.12.0-rc3-custom-g86b5b55bc835 #151
Hardware name: Nvidia SN5600/VMOD0013, BIOS 5.13 05/31/2023
RIP: 0010:mlxsw\_sp\_ipv6\_addr\_put+0x140/0x1d0
[...]
Call Trace:
<TASK>
mlxsw\_sp\_router\_netdevice\_event+0x55f/0x1240
notifier\_call\_chain+0x5a/0xd0
call\_netdevice\_notifiers\_info+0x39/0x90
unregister\_netdevice\_many\_notify+0x63e/0x9d0
rtnl\_dellink+0x16b/0x3a0
rtnetlink\_rcv\_msg+0x142/0x3f0
netlink\_rcv\_skb+0x50/0x100
netlink\_unicast+0x242/0x390
netlink\_sendmsg+0x1de/0x420
\_\_\_\_sys\_sendmsg+0x2bd/0x320
\_\_\_sys\_sendmsg+0x9a/0xe0
\_\_sys\_sendmsg+0x7a/0xd0
do\_syscall\_64+0x9e/0x1a0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
[3]
unreferenced object 0xffff898081f597a0 (size 32):
comm "ip", pid 1626, jiffies 4294719324
hex dump (first 32 bytes):
20 01 0d b8 00 02 00 00 00 00 00 00 00 00 00 01 ...............
21 49 61 83 80 89 ff ff 00 00 00 00 01 00 00 00 !Ia.............
backtrace (crc fd9be911):
[<00000000df89c55d>] \_\_kmalloc\_cache\_noprof+0x1da/0x260
[<00000000ff2a1ddb>] mlxsw\_sp\_ipv6\_addr\_kvdl\_index\_get+0x281/0x340
[<000000009ddd445d>] mlxsw\_sp\_router\_netdevice\_event+0x47b/0x1240
[<00000000743e7757>] notifier\_call\_chain+0x5a/0xd0
[<000000007c7b9e13>] call\_netdevice\_notifiers\_info+0x39/0x90
[<000000002509645d>] register\_netdevice+0x5f7/0x7a0
[<00000000c2e7d2a9>] ip6gre\_newlink\_common.isra.0+0x65/0x130
[<0000000087cd6d8d>] ip6gre\_newlink+0x72/0x120
[<000000004df7c7cc>] rtnl\_newlink+0x471/0xa20
[<0000000057ed632a>] rtnetlink\_rcv\_msg+0x142/0x3f0
[<0000000032e0d5b5>] netlink\_rcv\_skb+0x50/0x100
[<00000000908bca63>] netlink\_unicast+0x242/0x390
[<00000000cdbe1c87>] netlink\_sendmsg+0x1de/0x420
[<0000000011db153e>] \_\_\_\_sys\_sendmsg+0x2bd/0x320
[<000000003b6d53eb>] \_\_\_sys\_sendmsg+0x9a/0xe0
[<00000000cae27c62>] \_\_sys\_sendmsg+0x7a/0xd0
Fixes: cf42911523e0 ("mlxsw: spectrum\_ipip: Use common hash table for IPv6 address mapping")
Reported-by: Maksym Yaremchuk <maksymy@nvidia.com>
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Signed-off-by: Petr Machata <petrm@nvidia.com>
Link: [https://patch.msgid.link/e91012edc5a6cb9df37b78fd377f669381facfcb.1729866134.git.petrm@nvidia.com](https://patch.msgid.link/e91012edc5a6cb9df37b78fd377f669381facfcb.1729866134.git.petrm%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c b/drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.cindex d761a1235994cc..7ea798a4949e2d 100644--- a/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=321d697c717b361eb1d12a3f11384c5baf3f64d3)+++ b/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_ipip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_ipip.c?id=c1bbdbe07f0bc3bc9f87efe4672d67208c6d6942)@@ -481,11 +481,33 @@ mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre6(struct mlxsw\_sp \*mlxsw\_sp, struct mlxsw\_sp\_ipip\_entry \*ipip\_entry, struct netlink\_ext\_ack \*extack) {+ u32 new\_kvdl\_index, old\_kvdl\_index = ipip\_entry->dip\_kvdl\_index;+ struct in6\_addr old\_addr6 = ipip\_entry->parms.daddr.addr6; struct mlxsw\_sp\_ipip\_parms new\_parms;+ int err;  new\_parms = mlxsw\_sp\_ipip\_netdev\_parms\_init\_gre6(ipip\_entry->ol\_dev);- return mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre(mlxsw\_sp, ipip\_entry,- &new\_parms, extack);++ err = mlxsw\_sp\_ipv6\_addr\_kvdl\_index\_get(mlxsw\_sp,+ &new\_parms.daddr.addr6,+ &new\_kvdl\_index);+ if (err)+ return err;+ ipip\_entry->dip\_kvdl\_index = new\_kvdl\_index;++ err = mlxsw\_sp\_ipip\_ol\_netdev\_change\_gre(mlxsw\_sp, ipip\_entry,+ &new\_parms, extack);+ if (err)+ goto err\_change\_gre;++ mlxsw\_sp\_ipv6\_addr\_put(mlxsw\_sp, &old\_addr6);++ return 0;++err\_change\_gre:+ ipip\_entry->dip\_kvdl\_index = old\_kvdl\_index;+ mlxsw\_sp\_ipv6\_addr\_put(mlxsw\_sp, &new\_parms.daddr.addr6);+ return err; }  static int |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:40:40 +0000


