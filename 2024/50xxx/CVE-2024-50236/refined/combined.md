=== Content from git.kernel.org_461691de_20250115_092251.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manikanta Pubbisetty <quic\_mpubbise@quicinc.com> | 2024-10-15 12:11:03 +0530 |
| --- | --- | --- |
| committer | Jeff Johnson <quic\_jjohnson@quicinc.com> | 2024-10-16 07:30:31 -0700 |
| commit | [e15d84b3bba187aa372dff7c58ce1fd5cb48a076](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076)) | |
| tree | [f1702b318b7514dec3e3b374bedd5147f8e2a06d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076) | |
| parent | [2f833e8948d6c88a3a257d4e426c9897b4907d5a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f833e8948d6c88a3a257d4e426c9897b4907d5a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076&id2=2f833e8948d6c88a3a257d4e426c9897b4907d5a)) | |
| download | [linux-e15d84b3bba187aa372dff7c58ce1fd5cb48a076.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e15d84b3bba187aa372dff7c58ce1fd5cb48a076.tar.gz) | |

wifi: ath10k: Fix memory leak in management txIn the current logic, memory is allocated for storing the MSDU context
during management packet TX but this memory is not being freed during
management TX completion. Similar leaks are seen in the management TX
cleanup logic.
Kmemleak reports this problem as below,
unreferenced object 0xffffff80b64ed250 (size 16):
comm "kworker/u16:7", pid 148, jiffies 4294687130 (age 714.199s)
hex dump (first 16 bytes):
00 2b d8 d8 80 ff ff ff c4 74 e9 fd 07 00 00 00 .+.......t......
backtrace:
[<ffffffe6e7b245dc>] \_\_kmem\_cache\_alloc\_node+0x1e4/0x2d8
[<ffffffe6e7adde88>] kmalloc\_trace+0x48/0x110
[<ffffffe6bbd765fc>] ath10k\_wmi\_tlv\_op\_gen\_mgmt\_tx\_send+0xd4/0x1d8 [ath10k\_core]
[<ffffffe6bbd3eed4>] ath10k\_mgmt\_over\_wmi\_tx\_work+0x134/0x298 [ath10k\_core]
[<ffffffe6e78d5974>] process\_scheduled\_works+0x1ac/0x400
[<ffffffe6e78d60b8>] worker\_thread+0x208/0x328
[<ffffffe6e78dc890>] kthread+0x100/0x1c0
[<ffffffe6e78166c0>] ret\_from\_fork+0x10/0x20
Free the memory during completion and cleanup to fix the leak.
Protect the mgmt\_pending\_tx idr\_remove() operation in
ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send() using ar->data\_lock similar to
other instances.
Tested-on: WCN3990 hw1.0 SNOC WLAN.HL.2.0-01387-QCAHLSWMTPLZ-1
Fixes: dc405152bb64 ("ath10k: handle mgmt tx completion event")
Fixes: c730c477176a ("ath10k: Remove msdu from idr when management pkt send fails")
Cc: stable@vger.kernel.org
Signed-off-by: Manikanta Pubbisetty <quic\_mpubbise@quicinc.com>
Link: [https://patch.msgid.link/20241015064103.6060-1-quic\_mpubbise@quicinc.com](https://patch.msgid.link/20241015064103.6060-1-quic_mpubbise%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076)

| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi.c?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath10k/wmi-tlv.c b/drivers/net/wireless/ath/ath10k/wmi-tlv.cindex dbaf26d6a7a618..16d07d619b4df9 100644--- a/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=2f833e8948d6c88a3a257d4e426c9897b4907d5a)+++ b/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076)@@ -3043,9 +3043,14 @@ ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send(struct ath10k \*ar, struct sk\_buff \*msdu) { struct ath10k\_skb\_cb \*cb = ATH10K\_SKB\_CB(msdu);+ struct ath10k\_mgmt\_tx\_pkt\_addr \*pkt\_addr; struct ath10k\_wmi \*wmi = &ar->wmi; - idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_lock\_bh(&ar->data\_lock);+ pkt\_addr = idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_unlock\_bh(&ar->data\_lock);++ kfree(pkt\_addr);  return 0; }diff --git a/drivers/net/wireless/ath/ath10k/wmi.c b/drivers/net/wireless/ath/ath10k/wmi.cindex fe234459836497..1d58452ed8ca6d 100644--- a/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=2f833e8948d6c88a3a257d4e426c9897b4907d5a)+++ b/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=e15d84b3bba187aa372dff7c58ce1fd5cb48a076)@@ -2441,6 +2441,7 @@ wmi\_process\_mgmt\_tx\_comp(struct ath10k \*ar, struct mgmt\_tx\_compl\_params \*param) dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); info = IEEE80211\_SKB\_CB(msdu);+ kfree(pkt\_addr);  if (param->status) { info->flags &= ~IEEE80211\_TX\_STAT\_ACK;@@ -9612,6 +9613,7 @@ static int ath10k\_wmi\_mgmt\_tx\_clean\_up\_pending(int msdu\_id, void \*ptr, dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); ieee80211\_free\_txskb(ar->hw, msdu);+ kfree(pkt\_addr);  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:28 +0000



=== Content from git.kernel.org_3218b0e2_20250115_092248.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5f5a939759c79e7385946c85e62feca51a18d816)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5f5a939759c79e7385946c85e62feca51a18d816)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f5a939759c79e7385946c85e62feca51a18d816)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5f5a939759c79e7385946c85e62feca51a18d816)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manikanta Pubbisetty <quic\_mpubbise@quicinc.com> | 2024-10-15 12:11:03 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:23 +0100 |
| commit | [5f5a939759c79e7385946c85e62feca51a18d816](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f5a939759c79e7385946c85e62feca51a18d816) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5f5a939759c79e7385946c85e62feca51a18d816)) | |
| tree | [9b394b43648b2a7ef2a1051c70a5d6891d5c372d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5f5a939759c79e7385946c85e62feca51a18d816) | |
| parent | [ee35c423042c9e04079fdee3db545135d609d6ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee35c423042c9e04079fdee3db545135d609d6ea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5f5a939759c79e7385946c85e62feca51a18d816&id2=ee35c423042c9e04079fdee3db545135d609d6ea)) | |
| download | [linux-5f5a939759c79e7385946c85e62feca51a18d816.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5f5a939759c79e7385946c85e62feca51a18d816.tar.gz) | |

wifi: ath10k: Fix memory leak in management txcommit e15d84b3bba187aa372dff7c58ce1fd5cb48a076 upstream.
In the current logic, memory is allocated for storing the MSDU context
during management packet TX but this memory is not being freed during
management TX completion. Similar leaks are seen in the management TX
cleanup logic.
Kmemleak reports this problem as below,
unreferenced object 0xffffff80b64ed250 (size 16):
comm "kworker/u16:7", pid 148, jiffies 4294687130 (age 714.199s)
hex dump (first 16 bytes):
00 2b d8 d8 80 ff ff ff c4 74 e9 fd 07 00 00 00 .+.......t......
backtrace:
[<ffffffe6e7b245dc>] \_\_kmem\_cache\_alloc\_node+0x1e4/0x2d8
[<ffffffe6e7adde88>] kmalloc\_trace+0x48/0x110
[<ffffffe6bbd765fc>] ath10k\_wmi\_tlv\_op\_gen\_mgmt\_tx\_send+0xd4/0x1d8 [ath10k\_core]
[<ffffffe6bbd3eed4>] ath10k\_mgmt\_over\_wmi\_tx\_work+0x134/0x298 [ath10k\_core]
[<ffffffe6e78d5974>] process\_scheduled\_works+0x1ac/0x400
[<ffffffe6e78d60b8>] worker\_thread+0x208/0x328
[<ffffffe6e78dc890>] kthread+0x100/0x1c0
[<ffffffe6e78166c0>] ret\_from\_fork+0x10/0x20
Free the memory during completion and cleanup to fix the leak.
Protect the mgmt\_pending\_tx idr\_remove() operation in
ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send() using ar->data\_lock similar to
other instances.
Tested-on: WCN3990 hw1.0 SNOC WLAN.HL.2.0-01387-QCAHLSWMTPLZ-1
Fixes: dc405152bb64 ("ath10k: handle mgmt tx completion event")
Fixes: c730c477176a ("ath10k: Remove msdu from idr when management pkt send fails")
Cc: stable@vger.kernel.org
Signed-off-by: Manikanta Pubbisetty <quic\_mpubbise@quicinc.com>
Link: [https://patch.msgid.link/20241015064103.6060-1-quic\_mpubbise@quicinc.com](https://patch.msgid.link/20241015064103.6060-1-quic_mpubbise%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5f5a939759c79e7385946c85e62feca51a18d816)

| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=5f5a939759c79e7385946c85e62feca51a18d816) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi.c?id=5f5a939759c79e7385946c85e62feca51a18d816) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath10k/wmi-tlv.c b/drivers/net/wireless/ath/ath10k/wmi-tlv.cindex 0ce08e9a0a3d2d..8318740b127257 100644--- a/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=ee35c423042c9e04079fdee3db545135d609d6ea)+++ b/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=5f5a939759c79e7385946c85e62feca51a18d816)@@ -3042,9 +3042,14 @@ ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send(struct ath10k \*ar, struct sk\_buff \*msdu) { struct ath10k\_skb\_cb \*cb = ATH10K\_SKB\_CB(msdu);+ struct ath10k\_mgmt\_tx\_pkt\_addr \*pkt\_addr; struct ath10k\_wmi \*wmi = &ar->wmi; - idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_lock\_bh(&ar->data\_lock);+ pkt\_addr = idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_unlock\_bh(&ar->data\_lock);++ kfree(pkt\_addr);  return 0; }diff --git a/drivers/net/wireless/ath/ath10k/wmi.c b/drivers/net/wireless/ath/ath10k/wmi.cindex ee08a4c668f7a0..1c21dbde77b84e 100644--- a/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=ee35c423042c9e04079fdee3db545135d609d6ea)+++ b/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=5f5a939759c79e7385946c85e62feca51a18d816)@@ -2440,6 +2440,7 @@ wmi\_process\_mgmt\_tx\_comp(struct ath10k \*ar, struct mgmt\_tx\_compl\_params \*param) dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); info = IEEE80211\_SKB\_CB(msdu);+ kfree(pkt\_addr);  if (param->status) { info->flags &= ~IEEE80211\_TX\_STAT\_ACK;@@ -9559,6 +9560,7 @@ static int ath10k\_wmi\_mgmt\_tx\_clean\_up\_pending(int msdu\_id, void \*ptr, dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); ieee80211\_free\_txskb(ar->hw, msdu);+ kfree(pkt\_addr);  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:25 +0000



=== Content from git.kernel.org_e887656f_20250115_092249.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6cc23898e6ba47e976050d3c080b4d2c1add3748)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6cc23898e6ba47e976050d3c080b4d2c1add3748)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6cc23898e6ba47e976050d3c080b4d2c1add3748)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cc23898e6ba47e976050d3c080b4d2c1add3748)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manikanta Pubbisetty <quic\_mpubbise@quicinc.com> | 2024-10-15 12:11:03 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:45 +0100 |
| commit | [6cc23898e6ba47e976050d3c080b4d2c1add3748](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6cc23898e6ba47e976050d3c080b4d2c1add3748) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6cc23898e6ba47e976050d3c080b4d2c1add3748)) | |
| tree | [d3f91025eb679ae6c791203a6d50b8ae7721f0e4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6cc23898e6ba47e976050d3c080b4d2c1add3748) | |
| parent | [8f6cd4d5bb7406656835a90e4f1a2192607f0c21](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f6cd4d5bb7406656835a90e4f1a2192607f0c21) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cc23898e6ba47e976050d3c080b4d2c1add3748&id2=8f6cd4d5bb7406656835a90e4f1a2192607f0c21)) | |
| download | [linux-6cc23898e6ba47e976050d3c080b4d2c1add3748.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6cc23898e6ba47e976050d3c080b4d2c1add3748.tar.gz) | |

wifi: ath10k: Fix memory leak in management txcommit e15d84b3bba187aa372dff7c58ce1fd5cb48a076 upstream.
In the current logic, memory is allocated for storing the MSDU context
during management packet TX but this memory is not being freed during
management TX completion. Similar leaks are seen in the management TX
cleanup logic.
Kmemleak reports this problem as below,
unreferenced object 0xffffff80b64ed250 (size 16):
comm "kworker/u16:7", pid 148, jiffies 4294687130 (age 714.199s)
hex dump (first 16 bytes):
00 2b d8 d8 80 ff ff ff c4 74 e9 fd 07 00 00 00 .+.......t......
backtrace:
[<ffffffe6e7b245dc>] \_\_kmem\_cache\_alloc\_node+0x1e4/0x2d8
[<ffffffe6e7adde88>] kmalloc\_trace+0x48/0x110
[<ffffffe6bbd765fc>] ath10k\_wmi\_tlv\_op\_gen\_mgmt\_tx\_send+0xd4/0x1d8 [ath10k\_core]
[<ffffffe6bbd3eed4>] ath10k\_mgmt\_over\_wmi\_tx\_work+0x134/0x298 [ath10k\_core]
[<ffffffe6e78d5974>] process\_scheduled\_works+0x1ac/0x400
[<ffffffe6e78d60b8>] worker\_thread+0x208/0x328
[<ffffffe6e78dc890>] kthread+0x100/0x1c0
[<ffffffe6e78166c0>] ret\_from\_fork+0x10/0x20
Free the memory during completion and cleanup to fix the leak.
Protect the mgmt\_pending\_tx idr\_remove() operation in
ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send() using ar->data\_lock similar to
other instances.
Tested-on: WCN3990 hw1.0 SNOC WLAN.HL.2.0-01387-QCAHLSWMTPLZ-1
Fixes: dc405152bb64 ("ath10k: handle mgmt tx completion event")
Fixes: c730c477176a ("ath10k: Remove msdu from idr when management pkt send fails")
Cc: stable@vger.kernel.org
Signed-off-by: Manikanta Pubbisetty <quic\_mpubbise@quicinc.com>
Link: [https://patch.msgid.link/20241015064103.6060-1-quic\_mpubbise@quicinc.com](https://patch.msgid.link/20241015064103.6060-1-quic_mpubbise%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cc23898e6ba47e976050d3c080b4d2c1add3748)

| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=6cc23898e6ba47e976050d3c080b4d2c1add3748) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi.c?id=6cc23898e6ba47e976050d3c080b4d2c1add3748) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath10k/wmi-tlv.c b/drivers/net/wireless/ath/ath10k/wmi-tlv.cindex 4d5009604eee7f..a0cb2aa2533e23 100644--- a/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=8f6cd4d5bb7406656835a90e4f1a2192607f0c21)+++ b/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=6cc23898e6ba47e976050d3c080b4d2c1add3748)@@ -3035,9 +3035,14 @@ ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send(struct ath10k \*ar, struct sk\_buff \*msdu) { struct ath10k\_skb\_cb \*cb = ATH10K\_SKB\_CB(msdu);+ struct ath10k\_mgmt\_tx\_pkt\_addr \*pkt\_addr; struct ath10k\_wmi \*wmi = &ar->wmi; - idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_lock\_bh(&ar->data\_lock);+ pkt\_addr = idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_unlock\_bh(&ar->data\_lock);++ kfree(pkt\_addr);  return 0; }diff --git a/drivers/net/wireless/ath/ath10k/wmi.c b/drivers/net/wireless/ath/ath10k/wmi.cindex 8a5a44d75b1419..b126ffba480f10 100644--- a/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=8f6cd4d5bb7406656835a90e4f1a2192607f0c21)+++ b/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=6cc23898e6ba47e976050d3c080b4d2c1add3748)@@ -2440,6 +2440,7 @@ wmi\_process\_mgmt\_tx\_comp(struct ath10k \*ar, struct mgmt\_tx\_compl\_params \*param) dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); info = IEEE80211\_SKB\_CB(msdu);+ kfree(pkt\_addr);  if (param->status) { info->flags &= ~IEEE80211\_TX\_STAT\_ACK;@@ -9581,6 +9582,7 @@ static int ath10k\_wmi\_mgmt\_tx\_clean\_up\_pending(int msdu\_id, void \*ptr, dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); ieee80211\_free\_txskb(ar->hw, msdu);+ kfree(pkt\_addr);  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:26 +0000



=== Content from git.kernel.org_a208e3b4_20250115_092249.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manikanta Pubbisetty <quic\_mpubbise@quicinc.com> | 2024-10-15 12:11:03 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:53 +0100 |
| commit | [6fc9af3df6ca7f3c94774d20f62dc7b49616026d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d)) | |
| tree | [b019dcc0f4c73363dac0e469f9c7dfe0283a51bc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d) | |
| parent | [78b698fbf37208ee921ee4cedea75b5d33d6ea9f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78b698fbf37208ee921ee4cedea75b5d33d6ea9f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d&id2=78b698fbf37208ee921ee4cedea75b5d33d6ea9f)) | |
| download | [linux-6fc9af3df6ca7f3c94774d20f62dc7b49616026d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6fc9af3df6ca7f3c94774d20f62dc7b49616026d.tar.gz) | |

wifi: ath10k: Fix memory leak in management txcommit e15d84b3bba187aa372dff7c58ce1fd5cb48a076 upstream.
In the current logic, memory is allocated for storing the MSDU context
during management packet TX but this memory is not being freed during
management TX completion. Similar leaks are seen in the management TX
cleanup logic.
Kmemleak reports this problem as below,
unreferenced object 0xffffff80b64ed250 (size 16):
comm "kworker/u16:7", pid 148, jiffies 4294687130 (age 714.199s)
hex dump (first 16 bytes):
00 2b d8 d8 80 ff ff ff c4 74 e9 fd 07 00 00 00 .+.......t......
backtrace:
[<ffffffe6e7b245dc>] \_\_kmem\_cache\_alloc\_node+0x1e4/0x2d8
[<ffffffe6e7adde88>] kmalloc\_trace+0x48/0x110
[<ffffffe6bbd765fc>] ath10k\_wmi\_tlv\_op\_gen\_mgmt\_tx\_send+0xd4/0x1d8 [ath10k\_core]
[<ffffffe6bbd3eed4>] ath10k\_mgmt\_over\_wmi\_tx\_work+0x134/0x298 [ath10k\_core]
[<ffffffe6e78d5974>] process\_scheduled\_works+0x1ac/0x400
[<ffffffe6e78d60b8>] worker\_thread+0x208/0x328
[<ffffffe6e78dc890>] kthread+0x100/0x1c0
[<ffffffe6e78166c0>] ret\_from\_fork+0x10/0x20
Free the memory during completion and cleanup to fix the leak.
Protect the mgmt\_pending\_tx idr\_remove() operation in
ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send() using ar->data\_lock similar to
other instances.
Tested-on: WCN3990 hw1.0 SNOC WLAN.HL.2.0-01387-QCAHLSWMTPLZ-1
Fixes: dc405152bb64 ("ath10k: handle mgmt tx completion event")
Fixes: c730c477176a ("ath10k: Remove msdu from idr when management pkt send fails")
Cc: stable@vger.kernel.org
Signed-off-by: Manikanta Pubbisetty <quic\_mpubbise@quicinc.com>
Link: [https://patch.msgid.link/20241015064103.6060-1-quic\_mpubbise@quicinc.com](https://patch.msgid.link/20241015064103.6060-1-quic_mpubbise%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d)

| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi.c?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath10k/wmi-tlv.c b/drivers/net/wireless/ath/ath10k/wmi-tlv.cindex ee1c86bb5078b8..9101e0a14a57c3 100644--- a/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=78b698fbf37208ee921ee4cedea75b5d33d6ea9f)+++ b/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d)@@ -2854,9 +2854,14 @@ ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send(struct ath10k \*ar, struct sk\_buff \*msdu) { struct ath10k\_skb\_cb \*cb = ATH10K\_SKB\_CB(msdu);+ struct ath10k\_mgmt\_tx\_pkt\_addr \*pkt\_addr; struct ath10k\_wmi \*wmi = &ar->wmi; - idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_lock\_bh(&ar->data\_lock);+ pkt\_addr = idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_unlock\_bh(&ar->data\_lock);++ kfree(pkt\_addr);  return 0; }diff --git a/drivers/net/wireless/ath/ath10k/wmi.c b/drivers/net/wireless/ath/ath10k/wmi.cindex 81689dbab7f497..ed6316c41cb78e 100644--- a/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=78b698fbf37208ee921ee4cedea75b5d33d6ea9f)+++ b/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d)@@ -2385,6 +2385,7 @@ wmi\_process\_mgmt\_tx\_comp(struct ath10k \*ar, struct mgmt\_tx\_compl\_params \*param) dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); info = IEEE80211\_SKB\_CB(msdu);+ kfree(pkt\_addr);  if (param->status) { info->flags &= ~IEEE80211\_TX\_STAT\_ACK;@@ -9466,6 +9467,7 @@ static int ath10k\_wmi\_mgmt\_tx\_clean\_up\_pending(int msdu\_id, void \*ptr, dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); ieee80211\_free\_txskb(ar->hw, msdu);+ kfree(pkt\_addr);  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:26 +0000



=== Content from git.kernel.org_ad2ce55c_20250115_092247.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manikanta Pubbisetty <quic\_mpubbise@quicinc.com> | 2024-10-15 12:11:03 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:54 +0100 |
| commit | [2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b)) | |
| tree | [a68113e6cc7e24c63800a133a41e0ed785c92b07](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b) | |
| parent | [3ccf525a73d48e814634847f6d4a6150c6f0dffc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ccf525a73d48e814634847f6d4a6150c6f0dffc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b&id2=3ccf525a73d48e814634847f6d4a6150c6f0dffc)) | |
| download | [linux-2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b.tar.gz) | |

wifi: ath10k: Fix memory leak in management txcommit e15d84b3bba187aa372dff7c58ce1fd5cb48a076 upstream.
In the current logic, memory is allocated for storing the MSDU context
during management packet TX but this memory is not being freed during
management TX completion. Similar leaks are seen in the management TX
cleanup logic.
Kmemleak reports this problem as below,
unreferenced object 0xffffff80b64ed250 (size 16):
comm "kworker/u16:7", pid 148, jiffies 4294687130 (age 714.199s)
hex dump (first 16 bytes):
00 2b d8 d8 80 ff ff ff c4 74 e9 fd 07 00 00 00 .+.......t......
backtrace:
[<ffffffe6e7b245dc>] \_\_kmem\_cache\_alloc\_node+0x1e4/0x2d8
[<ffffffe6e7adde88>] kmalloc\_trace+0x48/0x110
[<ffffffe6bbd765fc>] ath10k\_wmi\_tlv\_op\_gen\_mgmt\_tx\_send+0xd4/0x1d8 [ath10k\_core]
[<ffffffe6bbd3eed4>] ath10k\_mgmt\_over\_wmi\_tx\_work+0x134/0x298 [ath10k\_core]
[<ffffffe6e78d5974>] process\_scheduled\_works+0x1ac/0x400
[<ffffffe6e78d60b8>] worker\_thread+0x208/0x328
[<ffffffe6e78dc890>] kthread+0x100/0x1c0
[<ffffffe6e78166c0>] ret\_from\_fork+0x10/0x20
Free the memory during completion and cleanup to fix the leak.
Protect the mgmt\_pending\_tx idr\_remove() operation in
ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send() using ar->data\_lock similar to
other instances.
Tested-on: WCN3990 hw1.0 SNOC WLAN.HL.2.0-01387-QCAHLSWMTPLZ-1
Fixes: dc405152bb64 ("ath10k: handle mgmt tx completion event")
Fixes: c730c477176a ("ath10k: Remove msdu from idr when management pkt send fails")
Cc: stable@vger.kernel.org
Signed-off-by: Manikanta Pubbisetty <quic\_mpubbise@quicinc.com>
Link: [https://patch.msgid.link/20241015064103.6060-1-quic\_mpubbise@quicinc.com](https://patch.msgid.link/20241015064103.6060-1-quic_mpubbise%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b)

| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi.c?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath10k/wmi-tlv.c b/drivers/net/wireless/ath/ath10k/wmi-tlv.cindex dbaf26d6a7a618..16d07d619b4df9 100644--- a/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=3ccf525a73d48e814634847f6d4a6150c6f0dffc)+++ b/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b)@@ -3043,9 +3043,14 @@ ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send(struct ath10k \*ar, struct sk\_buff \*msdu) { struct ath10k\_skb\_cb \*cb = ATH10K\_SKB\_CB(msdu);+ struct ath10k\_mgmt\_tx\_pkt\_addr \*pkt\_addr; struct ath10k\_wmi \*wmi = &ar->wmi; - idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_lock\_bh(&ar->data\_lock);+ pkt\_addr = idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_unlock\_bh(&ar->data\_lock);++ kfree(pkt\_addr);  return 0; }diff --git a/drivers/net/wireless/ath/ath10k/wmi.c b/drivers/net/wireless/ath/ath10k/wmi.cindex fe234459836497..1d58452ed8ca6d 100644--- a/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=3ccf525a73d48e814634847f6d4a6150c6f0dffc)+++ b/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=2f6f1e26ac6d2b38e2198a71f81f0ade14d6b07b)@@ -2441,6 +2441,7 @@ wmi\_process\_mgmt\_tx\_comp(struct ath10k \*ar, struct mgmt\_tx\_compl\_params \*param) dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); info = IEEE80211\_SKB\_CB(msdu);+ kfree(pkt\_addr);  if (param->status) { info->flags &= ~IEEE80211\_TX\_STAT\_ACK;@@ -9612,6 +9613,7 @@ static int ath10k\_wmi\_mgmt\_tx\_clean\_up\_pending(int msdu\_id, void \*ptr, dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); ieee80211\_free\_txskb(ar->hw, msdu);+ kfree(pkt\_addr);  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:24 +0000



=== Content from git.kernel.org_c17032e2_20250115_092250.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=705be2dc45c7f852e211e16bc41a916fab741983)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=705be2dc45c7f852e211e16bc41a916fab741983)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=705be2dc45c7f852e211e16bc41a916fab741983)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=705be2dc45c7f852e211e16bc41a916fab741983)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manikanta Pubbisetty <quic\_mpubbise@quicinc.com> | 2024-10-15 12:11:03 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:25:54 +0100 |
| commit | [705be2dc45c7f852e211e16bc41a916fab741983](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=705be2dc45c7f852e211e16bc41a916fab741983) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=705be2dc45c7f852e211e16bc41a916fab741983)) | |
| tree | [5c9e0b847f69a5ba2a2f1a64b1c46dedacfd9c85](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=705be2dc45c7f852e211e16bc41a916fab741983) | |
| parent | [b2bcbe5450b20641f512d6b26c6b256a5a4f847f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2bcbe5450b20641f512d6b26c6b256a5a4f847f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=705be2dc45c7f852e211e16bc41a916fab741983&id2=b2bcbe5450b20641f512d6b26c6b256a5a4f847f)) | |
| download | [linux-705be2dc45c7f852e211e16bc41a916fab741983.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-705be2dc45c7f852e211e16bc41a916fab741983.tar.gz) | |

wifi: ath10k: Fix memory leak in management txcommit e15d84b3bba187aa372dff7c58ce1fd5cb48a076 upstream.
In the current logic, memory is allocated for storing the MSDU context
during management packet TX but this memory is not being freed during
management TX completion. Similar leaks are seen in the management TX
cleanup logic.
Kmemleak reports this problem as below,
unreferenced object 0xffffff80b64ed250 (size 16):
comm "kworker/u16:7", pid 148, jiffies 4294687130 (age 714.199s)
hex dump (first 16 bytes):
00 2b d8 d8 80 ff ff ff c4 74 e9 fd 07 00 00 00 .+.......t......
backtrace:
[<ffffffe6e7b245dc>] \_\_kmem\_cache\_alloc\_node+0x1e4/0x2d8
[<ffffffe6e7adde88>] kmalloc\_trace+0x48/0x110
[<ffffffe6bbd765fc>] ath10k\_wmi\_tlv\_op\_gen\_mgmt\_tx\_send+0xd4/0x1d8 [ath10k\_core]
[<ffffffe6bbd3eed4>] ath10k\_mgmt\_over\_wmi\_tx\_work+0x134/0x298 [ath10k\_core]
[<ffffffe6e78d5974>] process\_scheduled\_works+0x1ac/0x400
[<ffffffe6e78d60b8>] worker\_thread+0x208/0x328
[<ffffffe6e78dc890>] kthread+0x100/0x1c0
[<ffffffe6e78166c0>] ret\_from\_fork+0x10/0x20
Free the memory during completion and cleanup to fix the leak.
Protect the mgmt\_pending\_tx idr\_remove() operation in
ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send() using ar->data\_lock similar to
other instances.
Tested-on: WCN3990 hw1.0 SNOC WLAN.HL.2.0-01387-QCAHLSWMTPLZ-1
Fixes: dc405152bb64 ("ath10k: handle mgmt tx completion event")
Fixes: c730c477176a ("ath10k: Remove msdu from idr when management pkt send fails")
Cc: stable@vger.kernel.org
Signed-off-by: Manikanta Pubbisetty <quic\_mpubbise@quicinc.com>
Link: [https://patch.msgid.link/20241015064103.6060-1-quic\_mpubbise@quicinc.com](https://patch.msgid.link/20241015064103.6060-1-quic_mpubbise%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=705be2dc45c7f852e211e16bc41a916fab741983)

| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=705be2dc45c7f852e211e16bc41a916fab741983) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi.c?id=705be2dc45c7f852e211e16bc41a916fab741983) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath10k/wmi-tlv.c b/drivers/net/wireless/ath/ath10k/wmi-tlv.cindex d5dafbecc1845e..117616ac6b2ff5 100644--- a/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=b2bcbe5450b20641f512d6b26c6b256a5a4f847f)+++ b/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=705be2dc45c7f852e211e16bc41a916fab741983)@@ -3035,9 +3035,14 @@ ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send(struct ath10k \*ar, struct sk\_buff \*msdu) { struct ath10k\_skb\_cb \*cb = ATH10K\_SKB\_CB(msdu);+ struct ath10k\_mgmt\_tx\_pkt\_addr \*pkt\_addr; struct ath10k\_wmi \*wmi = &ar->wmi; - idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_lock\_bh(&ar->data\_lock);+ pkt\_addr = idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_unlock\_bh(&ar->data\_lock);++ kfree(pkt\_addr);  return 0; }diff --git a/drivers/net/wireless/ath/ath10k/wmi.c b/drivers/net/wireless/ath/ath10k/wmi.cindex c8ccea542fec73..572aabc0541c5f 100644--- a/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=b2bcbe5450b20641f512d6b26c6b256a5a4f847f)+++ b/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=705be2dc45c7f852e211e16bc41a916fab741983)@@ -2440,6 +2440,7 @@ wmi\_process\_mgmt\_tx\_comp(struct ath10k \*ar, struct mgmt\_tx\_compl\_params \*param) dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); info = IEEE80211\_SKB\_CB(msdu);+ kfree(pkt\_addr);  if (param->status) { info->flags &= ~IEEE80211\_TX\_STAT\_ACK;@@ -9581,6 +9582,7 @@ static int ath10k\_wmi\_mgmt\_tx\_clean\_up\_pending(int msdu\_id, void \*ptr, dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); ieee80211\_free\_txskb(ar->hw, msdu);+ kfree(pkt\_addr);  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:27 +0000



=== Content from git.kernel.org_aba43c80_20250115_092251.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eff818238bedb9c2484c251ec46f9f160911cdc0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eff818238bedb9c2484c251ec46f9f160911cdc0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eff818238bedb9c2484c251ec46f9f160911cdc0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eff818238bedb9c2484c251ec46f9f160911cdc0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manikanta Pubbisetty <quic\_mpubbise@quicinc.com> | 2024-10-15 12:11:03 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:23 +0100 |
| commit | [eff818238bedb9c2484c251ec46f9f160911cdc0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eff818238bedb9c2484c251ec46f9f160911cdc0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eff818238bedb9c2484c251ec46f9f160911cdc0)) | |
| tree | [94908a601fda75828cd77e7db0114b3e6bd11260](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eff818238bedb9c2484c251ec46f9f160911cdc0) | |
| parent | [b0b862aa3dbcd16b3c4715259a825f48ca540088](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0b862aa3dbcd16b3c4715259a825f48ca540088) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eff818238bedb9c2484c251ec46f9f160911cdc0&id2=b0b862aa3dbcd16b3c4715259a825f48ca540088)) | |
| download | [linux-eff818238bedb9c2484c251ec46f9f160911cdc0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eff818238bedb9c2484c251ec46f9f160911cdc0.tar.gz) | |

wifi: ath10k: Fix memory leak in management txcommit e15d84b3bba187aa372dff7c58ce1fd5cb48a076 upstream.
In the current logic, memory is allocated for storing the MSDU context
during management packet TX but this memory is not being freed during
management TX completion. Similar leaks are seen in the management TX
cleanup logic.
Kmemleak reports this problem as below,
unreferenced object 0xffffff80b64ed250 (size 16):
comm "kworker/u16:7", pid 148, jiffies 4294687130 (age 714.199s)
hex dump (first 16 bytes):
00 2b d8 d8 80 ff ff ff c4 74 e9 fd 07 00 00 00 .+.......t......
backtrace:
[<ffffffe6e7b245dc>] \_\_kmem\_cache\_alloc\_node+0x1e4/0x2d8
[<ffffffe6e7adde88>] kmalloc\_trace+0x48/0x110
[<ffffffe6bbd765fc>] ath10k\_wmi\_tlv\_op\_gen\_mgmt\_tx\_send+0xd4/0x1d8 [ath10k\_core]
[<ffffffe6bbd3eed4>] ath10k\_mgmt\_over\_wmi\_tx\_work+0x134/0x298 [ath10k\_core]
[<ffffffe6e78d5974>] process\_scheduled\_works+0x1ac/0x400
[<ffffffe6e78d60b8>] worker\_thread+0x208/0x328
[<ffffffe6e78dc890>] kthread+0x100/0x1c0
[<ffffffe6e78166c0>] ret\_from\_fork+0x10/0x20
Free the memory during completion and cleanup to fix the leak.
Protect the mgmt\_pending\_tx idr\_remove() operation in
ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send() using ar->data\_lock similar to
other instances.
Tested-on: WCN3990 hw1.0 SNOC WLAN.HL.2.0-01387-QCAHLSWMTPLZ-1
Fixes: dc405152bb64 ("ath10k: handle mgmt tx completion event")
Fixes: c730c477176a ("ath10k: Remove msdu from idr when management pkt send fails")
Cc: stable@vger.kernel.org
Signed-off-by: Manikanta Pubbisetty <quic\_mpubbise@quicinc.com>
Link: [https://patch.msgid.link/20241015064103.6060-1-quic\_mpubbise@quicinc.com](https://patch.msgid.link/20241015064103.6060-1-quic_mpubbise%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eff818238bedb9c2484c251ec46f9f160911cdc0)

| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=eff818238bedb9c2484c251ec46f9f160911cdc0) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi.c?id=eff818238bedb9c2484c251ec46f9f160911cdc0) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath10k/wmi-tlv.c b/drivers/net/wireless/ath/ath10k/wmi-tlv.cindex c9df78950ff4b5..1d3031bd44fe18 100644--- a/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=b0b862aa3dbcd16b3c4715259a825f48ca540088)+++ b/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=eff818238bedb9c2484c251ec46f9f160911cdc0)@@ -2655,9 +2655,14 @@ ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send(struct ath10k \*ar, struct sk\_buff \*msdu) { struct ath10k\_skb\_cb \*cb = ATH10K\_SKB\_CB(msdu);+ struct ath10k\_mgmt\_tx\_pkt\_addr \*pkt\_addr; struct ath10k\_wmi \*wmi = &ar->wmi; - idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_lock\_bh(&ar->data\_lock);+ pkt\_addr = idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_unlock\_bh(&ar->data\_lock);++ kfree(pkt\_addr);  return 0; }diff --git a/drivers/net/wireless/ath/ath10k/wmi.c b/drivers/net/wireless/ath/ath10k/wmi.cindex 967a39304648ed..e21b5c5015758c 100644--- a/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=b0b862aa3dbcd16b3c4715259a825f48ca540088)+++ b/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=eff818238bedb9c2484c251ec46f9f160911cdc0)@@ -2362,6 +2362,7 @@ static int wmi\_process\_mgmt\_tx\_comp(struct ath10k \*ar, u32 desc\_id, dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); info = IEEE80211\_SKB\_CB(msdu);+ kfree(pkt\_addr);  if (status) info->flags &= ~IEEE80211\_TX\_STAT\_ACK;@@ -9233,6 +9234,7 @@ static int ath10k\_wmi\_mgmt\_tx\_clean\_up\_pending(int msdu\_id, void \*ptr, dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); ieee80211\_free\_txskb(ar->hw, msdu);+ kfree(pkt\_addr);  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:28 +0000



=== Content from git.kernel.org_711c5036_20250115_092247.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4112450da7d67b59ccedc2208bae622db17dbcb8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4112450da7d67b59ccedc2208bae622db17dbcb8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4112450da7d67b59ccedc2208bae622db17dbcb8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4112450da7d67b59ccedc2208bae622db17dbcb8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Manikanta Pubbisetty <quic\_mpubbise@quicinc.com> | 2024-10-15 12:11:03 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:22:03 +0100 |
| commit | [4112450da7d67b59ccedc2208bae622db17dbcb8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4112450da7d67b59ccedc2208bae622db17dbcb8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4112450da7d67b59ccedc2208bae622db17dbcb8)) | |
| tree | [3547b182e4e57bee4b9bd2f4b62ef58fd4336a33](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4112450da7d67b59ccedc2208bae622db17dbcb8) | |
| parent | [c21efba8b5a86537ccdf43f77536bad02f82776c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c21efba8b5a86537ccdf43f77536bad02f82776c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4112450da7d67b59ccedc2208bae622db17dbcb8&id2=c21efba8b5a86537ccdf43f77536bad02f82776c)) | |
| download | [linux-4112450da7d67b59ccedc2208bae622db17dbcb8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4112450da7d67b59ccedc2208bae622db17dbcb8.tar.gz) | |

wifi: ath10k: Fix memory leak in management txcommit e15d84b3bba187aa372dff7c58ce1fd5cb48a076 upstream.
In the current logic, memory is allocated for storing the MSDU context
during management packet TX but this memory is not being freed during
management TX completion. Similar leaks are seen in the management TX
cleanup logic.
Kmemleak reports this problem as below,
unreferenced object 0xffffff80b64ed250 (size 16):
comm "kworker/u16:7", pid 148, jiffies 4294687130 (age 714.199s)
hex dump (first 16 bytes):
00 2b d8 d8 80 ff ff ff c4 74 e9 fd 07 00 00 00 .+.......t......
backtrace:
[<ffffffe6e7b245dc>] \_\_kmem\_cache\_alloc\_node+0x1e4/0x2d8
[<ffffffe6e7adde88>] kmalloc\_trace+0x48/0x110
[<ffffffe6bbd765fc>] ath10k\_wmi\_tlv\_op\_gen\_mgmt\_tx\_send+0xd4/0x1d8 [ath10k\_core]
[<ffffffe6bbd3eed4>] ath10k\_mgmt\_over\_wmi\_tx\_work+0x134/0x298 [ath10k\_core]
[<ffffffe6e78d5974>] process\_scheduled\_works+0x1ac/0x400
[<ffffffe6e78d60b8>] worker\_thread+0x208/0x328
[<ffffffe6e78dc890>] kthread+0x100/0x1c0
[<ffffffe6e78166c0>] ret\_from\_fork+0x10/0x20
Free the memory during completion and cleanup to fix the leak.
Protect the mgmt\_pending\_tx idr\_remove() operation in
ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send() using ar->data\_lock similar to
other instances.
Tested-on: WCN3990 hw1.0 SNOC WLAN.HL.2.0-01387-QCAHLSWMTPLZ-1
Fixes: dc405152bb64 ("ath10k: handle mgmt tx completion event")
Fixes: c730c477176a ("ath10k: Remove msdu from idr when management pkt send fails")
Cc: stable@vger.kernel.org
Signed-off-by: Manikanta Pubbisetty <quic\_mpubbise@quicinc.com>
Link: [https://patch.msgid.link/20241015064103.6060-1-quic\_mpubbise@quicinc.com](https://patch.msgid.link/20241015064103.6060-1-quic_mpubbise%40quicinc.com)
Signed-off-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4112450da7d67b59ccedc2208bae622db17dbcb8)

| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=4112450da7d67b59ccedc2208bae622db17dbcb8) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath10k/wmi.c?id=4112450da7d67b59ccedc2208bae622db17dbcb8) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath10k/wmi-tlv.c b/drivers/net/wireless/ath/ath10k/wmi-tlv.cindex 0eeb74245372fb..7e65788238bb56 100644--- a/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=c21efba8b5a86537ccdf43f77536bad02f82776c)+++ b/[drivers/net/wireless/ath/ath10k/wmi-tlv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi-tlv.c?id=4112450da7d67b59ccedc2208bae622db17dbcb8)@@ -3035,9 +3035,14 @@ ath10k\_wmi\_tlv\_op\_cleanup\_mgmt\_tx\_send(struct ath10k \*ar, struct sk\_buff \*msdu) { struct ath10k\_skb\_cb \*cb = ATH10K\_SKB\_CB(msdu);+ struct ath10k\_mgmt\_tx\_pkt\_addr \*pkt\_addr; struct ath10k\_wmi \*wmi = &ar->wmi; - idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_lock\_bh(&ar->data\_lock);+ pkt\_addr = idr\_remove(&wmi->mgmt\_pending\_tx, cb->msdu\_id);+ spin\_unlock\_bh(&ar->data\_lock);++ kfree(pkt\_addr);  return 0; }diff --git a/drivers/net/wireless/ath/ath10k/wmi.c b/drivers/net/wireless/ath/ath10k/wmi.cindex 9cfd35dc87ba32..dc5d9f9be34f0e 100644--- a/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=c21efba8b5a86537ccdf43f77536bad02f82776c)+++ b/[drivers/net/wireless/ath/ath10k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath10k/wmi.c?id=4112450da7d67b59ccedc2208bae622db17dbcb8)@@ -2440,6 +2440,7 @@ wmi\_process\_mgmt\_tx\_comp(struct ath10k \*ar, struct mgmt\_tx\_compl\_params \*param) dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); info = IEEE80211\_SKB\_CB(msdu);+ kfree(pkt\_addr);  if (param->status) { info->flags &= ~IEEE80211\_TX\_STAT\_ACK;@@ -9581,6 +9582,7 @@ static int ath10k\_wmi\_mgmt\_tx\_clean\_up\_pending(int msdu\_id, void \*ptr, dma\_unmap\_single(ar->dev, pkt\_addr->paddr, msdu->len, DMA\_TO\_DEVICE); ieee80211\_free\_txskb(ar->hw, msdu);+ kfree(pkt\_addr);  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:24 +0000


