=== Content from git.kernel.org_4a8a6ce0_20250115_092039.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | SeongJae Park <sj@kernel.org> | 2024-10-31 09:12:03 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:12 +0100 |
| commit | [2d339a1f0f16ff5dea58e612ff336f0be0d041e9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9)) | |
| tree | [4c5c10d7a80e99cd09c80130cb14a904d15eb6cc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9) | |
| parent | [0208ea17a1e4456fbfe555f13ae5c28f3d671e40](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0208ea17a1e4456fbfe555f13ae5c28f3d671e40) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9&id2=0208ea17a1e4456fbfe555f13ae5c28f3d671e40)) | |
| download | [linux-2d339a1f0f16ff5dea58e612ff336f0be0d041e9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2d339a1f0f16ff5dea58e612ff336f0be0d041e9.tar.gz) | |

mm/damon/core: avoid overflow in damon\_feed\_loop\_next\_input()commit 4401e9d10ab0281a520b9f8c220f30f60b5c248f upstream.
damon\_feed\_loop\_next\_input() is inefficient and fragile to overflows.
Specifically, 'score\_goal\_diff\_bp' calculation can overflow when 'score'
is high. The calculation is actually unnecessary at all because 'goal' is
a constant of value 10,000. Calculation of 'compensation' is again
fragile to overflow. Final calculation of return value for under-achiving
case is again fragile to overflow when the current score is
under-achieving the target.
Add two corner cases handling at the beginning of the function to make the
body easier to read, and rewrite the body of the function to avoid
overflows and the unnecessary bp value calcuation.
Link: [https://lkml.kernel.org/r/20241031161203.47751-1-sj@kernel.org](https://lkml.kernel.org/r/20241031161203.47751-1-sj%40kernel.org)
Fixes: 9294a037c015 ("mm/damon/core: implement goal-oriented feedback-driven quota auto-tuning")
Signed-off-by: SeongJae Park <sj@kernel.org>
Reported-by: Guenter Roeck <linux@roeck-us.net>
Closes: https://lore.kernel.org/944f3d5b-9177-48e7-8ec9-7f1331a3fea3@roeck-us.net
Tested-by: Guenter Roeck <linux@roeck-us.net>
Cc: <stable@vger.kernel.org> [6.8.x]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9)

| -rw-r--r-- | [mm/damon/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/damon/core.c?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 7 deletions

| diff --git a/mm/damon/core.c b/mm/damon/core.cindex 7a87628b76ab70..a26233fc2784d4 100644--- a/[mm/damon/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/damon/core.c?id=0208ea17a1e4456fbfe555f13ae5c28f3d671e40)+++ b/[mm/damon/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/damon/core.c?id=2d339a1f0f16ff5dea58e612ff336f0be0d041e9)@@ -1450,17 +1450,31 @@ static unsigned long damon\_feed\_loop\_next\_input(unsigned long last\_input, unsigned long score) { const unsigned long goal = 10000;- unsigned long score\_goal\_diff = max(goal, score) - min(goal, score);- unsigned long score\_goal\_diff\_bp = score\_goal\_diff \* 10000 / goal;- unsigned long compensation = last\_input \* score\_goal\_diff\_bp / 10000; /\* Set minimum input as 10000 to avoid compensation be zero \*/ const unsigned long min\_input = 10000;+ unsigned long score\_goal\_diff, compensation;+ bool over\_achieving = score > goal; - if (goal > score)+ if (score == goal)+ return last\_input;+ if (score >= goal \* 2)+ return min\_input;++ if (over\_achieving)+ score\_goal\_diff = score - goal;+ else+ score\_goal\_diff = goal - score;++ if (last\_input < ULONG\_MAX / score\_goal\_diff)+ compensation = last\_input \* score\_goal\_diff / goal;+ else+ compensation = last\_input / goal \* score\_goal\_diff;++ if (over\_achieving)+ return max(last\_input - compensation, min\_input);+ if (last\_input < ULONG\_MAX - compensation) return last\_input + compensation;- if (last\_input > compensation + min\_input)- return last\_input - compensation;- return min\_input;+ return ULONG\_MAX; }  #ifdef CONFIG\_PSI |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:19:16 +0000



=== Content from git.kernel.org_1454449f_20250115_092041.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | SeongJae Park <sj@kernel.org> | 2024-10-31 09:12:03 -0700 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-11-07 14:14:59 -0800 |
| commit | [4401e9d10ab0281a520b9f8c220f30f60b5c248f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f)) | |
| tree | [9d36e1c84b3c714531be43b8c4ff0c04a67c1ddc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f) | |
| parent | [8e7bde615f634a82a44b1f3d293c049fd3ef9ca9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e7bde615f634a82a44b1f3d293c049fd3ef9ca9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f&id2=8e7bde615f634a82a44b1f3d293c049fd3ef9ca9)) | |
| download | [linux-4401e9d10ab0281a520b9f8c220f30f60b5c248f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4401e9d10ab0281a520b9f8c220f30f60b5c248f.tar.gz) | |

mm/damon/core: avoid overflow in damon\_feed\_loop\_next\_input()damon\_feed\_loop\_next\_input() is inefficient and fragile to overflows.
Specifically, 'score\_goal\_diff\_bp' calculation can overflow when 'score'
is high. The calculation is actually unnecessary at all because 'goal' is
a constant of value 10,000. Calculation of 'compensation' is again
fragile to overflow. Final calculation of return value for under-achiving
case is again fragile to overflow when the current score is
under-achieving the target.
Add two corner cases handling at the beginning of the function to make the
body easier to read, and rewrite the body of the function to avoid
overflows and the unnecessary bp value calcuation.
Link: [https://lkml.kernel.org/r/20241031161203.47751-1-sj@kernel.org](https://lkml.kernel.org/r/20241031161203.47751-1-sj%40kernel.org)
Fixes: 9294a037c015 ("mm/damon/core: implement goal-oriented feedback-driven quota auto-tuning")
Signed-off-by: SeongJae Park <sj@kernel.org>
Reported-by: Guenter Roeck <linux@roeck-us.net>
Closes: https://lore.kernel.org/944f3d5b-9177-48e7-8ec9-7f1331a3fea3@roeck-us.net
Tested-by: Guenter Roeck <linux@roeck-us.net>
Cc: <stable@vger.kernel.org> [6.8.x]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f)

| -rw-r--r-- | [mm/damon/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/damon/core.c?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 7 deletions

| diff --git a/mm/damon/core.c b/mm/damon/core.cindex ce700e694b6366..511c3f61ab44c4 100644--- a/[mm/damon/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/damon/core.c?id=8e7bde615f634a82a44b1f3d293c049fd3ef9ca9)+++ b/[mm/damon/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/damon/core.c?id=4401e9d10ab0281a520b9f8c220f30f60b5c248f)@@ -1456,17 +1456,31 @@ static unsigned long damon\_feed\_loop\_next\_input(unsigned long last\_input, unsigned long score) { const unsigned long goal = 10000;- unsigned long score\_goal\_diff = max(goal, score) - min(goal, score);- unsigned long score\_goal\_diff\_bp = score\_goal\_diff \* 10000 / goal;- unsigned long compensation = last\_input \* score\_goal\_diff\_bp / 10000; /\* Set minimum input as 10000 to avoid compensation be zero \*/ const unsigned long min\_input = 10000;+ unsigned long score\_goal\_diff, compensation;+ bool over\_achieving = score > goal; - if (goal > score)+ if (score == goal)+ return last\_input;+ if (score >= goal \* 2)+ return min\_input;++ if (over\_achieving)+ score\_goal\_diff = score - goal;+ else+ score\_goal\_diff = goal - score;++ if (last\_input < ULONG\_MAX / score\_goal\_diff)+ compensation = last\_input \* score\_goal\_diff / goal;+ else+ compensation = last\_input / goal \* score\_goal\_diff;++ if (over\_achieving)+ return max(last\_input - compensation, min\_input);+ if (last\_input < ULONG\_MAX - compensation) return last\_input + compensation;- if (last\_input > compensation + min\_input)- return last\_input - compensation;- return min\_input;+ return ULONG\_MAX; }  #ifdef CONFIG\_PSI |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:19:18 +0000


