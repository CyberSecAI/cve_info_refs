=== Content from git.kernel.org_fe05ee9b_20250114_225643.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=01c473e64cafe2231e51be140446388024e669e8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01c473e64cafe2231e51be140446388024e669e8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01c473e64cafe2231e51be140446388024e669e8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01c473e64cafe2231e51be140446388024e669e8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vamsi Krishna Brahmajosyula <vamsikrishna.brahmajosyula@gmail.com> | 2024-10-18 16:19:58 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:42 +0100 |
| commit | [01c473e64cafe2231e51be140446388024e669e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01c473e64cafe2231e51be140446388024e669e8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=01c473e64cafe2231e51be140446388024e669e8)) | |
| tree | [d614c479d1c4fa879c3833fcb05d5a8c1f33bf44](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01c473e64cafe2231e51be140446388024e669e8) | |
| parent | [fc6afa07b5e251148fb37600ee06e1a7007178c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc6afa07b5e251148fb37600ee06e1a7007178c3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01c473e64cafe2231e51be140446388024e669e8&id2=fc6afa07b5e251148fb37600ee06e1a7007178c3)) | |
| download | [linux-01c473e64cafe2231e51be140446388024e669e8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-01c473e64cafe2231e51be140446388024e669e8.tar.gz) | |

platform/x86/intel/pmc: Fix pmc\_core\_iounmap to call iounmap for valid addresses[ Upstream commit 48771da48072823956b271dddd568492c13d8170 ]
Commit 50c6dbdfd16e ("x86/ioremap: Improve iounmap() address range checks")
introduces a WARN when adrress ranges of iounmap are invalid. On Thinkpad
P1 Gen 7 (Meteor Lake-P) this caused the following warning to appear:
WARNING: CPU: 7 PID: 713 at arch/x86/mm/ioremap.c:461 iounmap+0x58/0x1f0
Modules linked in: rfkill(+) snd\_timer(+) fjes(+) snd soundcore intel\_pmc\_core(+)
int3403\_thermal(+) int340x\_thermal\_zone intel\_vsec pmt\_telemetry acpi\_pad pmt\_class
acpi\_tad int3400\_thermal acpi\_thermal\_rel joydev loop nfnetlink zram xe drm\_suballoc\_helper
nouveau i915 mxm\_wmi drm\_ttm\_helper gpu\_sched drm\_gpuvm drm\_exec drm\_buddy i2c\_algo\_bit
crct10dif\_pclmul crc32\_pclmul ttm crc32c\_intel polyval\_clmulni rtsx\_pci\_sdmmc ucsi\_acpi
polyval\_generic mmc\_core hid\_multitouch drm\_display\_helper ghash\_clmulni\_intel typec\_ucsi
nvme sha512\_ssse3 video sha256\_ssse3 nvme\_core intel\_vpu sha1\_ssse3 rtsx\_pci cec typec
nvme\_auth i2c\_hid\_acpi i2c\_hid wmi pinctrl\_meteorlake serio\_raw ip6\_tables ip\_tables fuse
CPU: 7 UID: 0 PID: 713 Comm: (udev-worker) Not tainted 6.12.0-rc2iounmap+ #42
Hardware name: LENOVO 21KWCTO1WW/21KWCTO1WW, BIOS N48ET19W (1.06 ) 07/18/2024
RIP: 0010:iounmap+0x58/0x1f0
Code: 85 6a 01 00 00 48 8b 05 e6 e2 28 04 48 39 c5 72 19 eb 26 cc cc cc 48 ba 00 00 00 00 00 00 32 00 48 8d 44 02 ff 48 39 c5 72 23 <0f> 0b 48 83 c4 08 5b 5d 41 5c c3 cc cc cc cc 48 ba 00 00 00 00 00
RSP: 0018:ffff888131eff038 EFLAGS: 00010207
RAX: ffffc90000000000 RBX: 0000000000000000 RCX: ffff888e33b80000
RDX: dffffc0000000000 RSI: ffff888e33bc29c0 RDI: 0000000000000000
RBP: 0000000000000000 R08: ffff8881598a8000 R09: ffff888e2ccedc10
R10: 0000000000000003 R11: ffffffffb3367634 R12: 00000000fe000000
R13: ffff888101d0da28 R14: ffffffffc2e437e0 R15: ffff888110b03b28
FS: 00007f3c1d4b3980(0000) GS:ffff888e33b80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00005651cfc93578 CR3: 0000000124e4c002 CR4: 0000000000f70ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000ffff07f0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<TASK>
? \_\_warn.cold+0xb6/0x176
? iounmap+0x58/0x1f0
? report\_bug+0x1f4/0x2b0
? handle\_bug+0x58/0x90
? exc\_invalid\_op+0x17/0x40
? asm\_exc\_invalid\_op+0x1a/0x20
? iounmap+0x58/0x1f0
pmc\_core\_ssram\_get\_pmc+0x477/0x6c0 [intel\_pmc\_core]
? \_\_pfx\_pmc\_core\_ssram\_get\_pmc+0x10/0x10 [intel\_pmc\_core]
? \_\_pfx\_do\_pci\_enable\_device+0x10/0x10
? pci\_wait\_for\_pending+0x60/0x110
? pci\_enable\_device\_flags+0x1e3/0x2e0
? \_\_pfx\_mtl\_core\_init+0x10/0x10 [intel\_pmc\_core]
pmc\_core\_ssram\_init+0x7f/0x110 [intel\_pmc\_core]
mtl\_core\_init+0xda/0x130 [intel\_pmc\_core]
? \_\_mutex\_init+0xb9/0x130
pmc\_core\_probe+0x27e/0x10b0 [intel\_pmc\_core]
? \_raw\_spin\_lock\_irqsave+0x96/0xf0
? \_\_pfx\_pmc\_core\_probe+0x10/0x10 [intel\_pmc\_core]
? \_\_pfx\_mutex\_unlock+0x10/0x10
? \_\_pfx\_mutex\_lock+0x10/0x10
? device\_pm\_check\_callbacks+0x82/0x370
? acpi\_dev\_pm\_attach+0x234/0x2b0
platform\_probe+0x9f/0x150
really\_probe+0x1e0/0x8a0
\_\_driver\_probe\_device+0x18c/0x370
? \_\_pfx\_\_\_driver\_attach+0x10/0x10
driver\_probe\_device+0x4a/0x120
\_\_driver\_attach+0x190/0x4a0
? \_\_pfx\_\_\_driver\_attach+0x10/0x10
bus\_for\_each\_dev+0x103/0x180
? \_\_pfx\_bus\_for\_each\_dev+0x10/0x10
? klist\_add\_tail+0x136/0x270
bus\_add\_driver+0x2fc/0x540
driver\_register+0x1a5/0x360
? \_\_pfx\_pmc\_core\_driver\_init+0x10/0x10 [intel\_pmc\_core]
do\_one\_initcall+0xa4/0x380
? \_\_pfx\_do\_one\_initcall+0x10/0x10
? kasan\_unpoison+0x44/0x70
do\_init\_module+0x296/0x800
load\_module+0x5090/0x6ce0
? \_\_pfx\_load\_module+0x10/0x10
? ima\_post\_read\_file+0x193/0x200
? \_\_pfx\_ima\_post\_read\_file+0x10/0x10
? rw\_verify\_area+0x152/0x4c0
? kernel\_read\_file+0x257/0x750
? \_\_pfx\_kernel\_read\_file+0x10/0x10
? \_\_pfx\_filemap\_get\_read\_batch+0x10/0x10
? init\_module\_from\_file+0xd1/0x130
init\_module\_from\_file+0xd1/0x130
? \_\_pfx\_init\_module\_from\_file+0x10/0x10
? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
? \_\_pfx\_cred\_has\_capability.isra.0+0x10/0x10
idempotent\_init\_module+0x236/0x770
? \_\_pfx\_idempotent\_init\_module+0x10/0x10
? fdget+0x58/0x3f0
? security\_capable+0x7d/0x110
\_\_x64\_sys\_finit\_module+0xbe/0x130
do\_syscall\_64+0x82/0x160
? \_\_pfx\_filemap\_read+0x10/0x10
? \_\_pfx\_\_\_fsnotify\_parent+0x10/0x10
? vfs\_read+0x3a6/0xa30
? vfs\_read+0x3a6/0xa30
? \_\_seccomp\_filter+0x175/0xc60
? \_\_pfx\_\_\_seccomp\_filter+0x10/0x10
? fdget\_pos+0x1ce/0x500
? syscall\_exit\_to\_user\_mode\_prepare+0x149/0x170
? syscall\_exit\_to\_user\_mode+0x10/0x210
? do\_syscall\_64+0x8e/0x160
? switch\_fpu\_return+0xe3/0x1f0
? syscall\_exit\_to\_user\_mode+0x1d5/0x210
? do\_syscall\_64+0x8e/0x160
? exc\_page\_fault+0x76/0xf0
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f3c1d6d155d
Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 83 58 0f 00 f7 d8 64 89 01 48
RSP: 002b:00007ffe6309db38 EFLAGS: 00000246 ORIG\_RAX: 0000000000000139
RAX: ffffffffffffffda RBX: 0000557c212550a0 RCX: 00007f3c1d6d155d
RDX: 0000000000000000 RSI: 00007f3c1cd943bd RDI: 0000000000000025
RBP: 00007ffe6309dbf0 R08: 00007f3c1d7c7b20 R09: 00007ffe6309db80
R10: 0000557c21255270 R11: 0000000000000246 R12: 00007f3c1cd943bd
R13: 0000000000020000 R14: 0000557c21255c80 R15: 0000557c21255240
</TASK>
no\_free\_ptr(tmp\_ssram) sets tmp\_ssram NULL while assigning ssram.
pmc\_core\_iounmap calls iounmap unconditionally causing the above
warning to appear during boot.
Fix it by checking for a valid address before calling iounmap.
Also in the function pmc\_core\_ssram\_get\_pmc return -ENOMEM when
ioremap fails similar to other instances in the file.
Fixes: a01486dc4bb1 ("platform/x86/intel/pmc: Cleanup SSRAM discovery")
Reviewed-by: Ilpo Järvinen <ilpo.jarvinen@linux.intel.com>
Reviewed-by: David E. Box <david.e.box@linux.intel.com>
Signed-off-by: Vamsi Krishna Brahmajosyula <vamsikrishna.brahmajosyula@gmail.com>
Link: [https://lore.kernel.org/r/20241018104958.14195-1-vamsikrishna.brahmajosyula@gmail.com](https://lore.kernel.org/r/20241018104958.14195-1-vamsikrishna.brahmajosyula%40gmail.com)
Reviewed-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01c473e64cafe2231e51be140446388024e669e8)

| -rw-r--r-- | [drivers/platform/x86/intel/pmc/core\_ssram.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/pmc/core_ssram.c?id=01c473e64cafe2231e51be140446388024e669e8) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/platform/x86/intel/pmc/core\_ssram.c b/drivers/platform/x86/intel/pmc/core\_ssram.cindex 1bde86c54eb979..239211486fb91c 100644--- a/[drivers/platform/x86/intel/pmc/core\_ssram.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/pmc/core_ssram.c?id=fc6afa07b5e251148fb37600ee06e1a7007178c3)+++ b/[drivers/platform/x86/intel/pmc/core\_ssram.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/pmc/core_ssram.c?id=01c473e64cafe2231e51be140446388024e669e8)@@ -29,7 +29,7 @@ #define LPM\_REG\_COUNT 28 #define LPM\_MODE\_OFFSET 1 -DEFINE\_FREE(pmc\_core\_iounmap, void \_\_iomem \*, iounmap(\_T));+DEFINE\_FREE(pmc\_core\_iounmap, void \_\_iomem \*, if (\_T) iounmap(\_T))  static u32 pmc\_core\_find\_guid(struct pmc\_info \*list, const struct pmc\_reg\_map \*map) {@@ -262,6 +262,8 @@ pmc\_core\_ssram\_get\_pmc(struct pmc\_dev \*pmcdev, int pmc\_idx, u32 offset)  ssram\_base = ssram\_pcidev->resource[0].start; tmp\_ssram = ioremap(ssram\_base, SSRAM\_HDR\_SIZE);+ if (!tmp\_ssram)+ return -ENOMEM;  if (pmc\_idx != PMC\_IDX\_MAIN) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:55:20 +0000



=== Content from git.kernel.org_bd62d084_20250114_225643.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=48771da48072823956b271dddd568492c13d8170)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48771da48072823956b271dddd568492c13d8170)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48771da48072823956b271dddd568492c13d8170)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48771da48072823956b271dddd568492c13d8170)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vamsi Krishna Brahmajosyula <vamsikrishna.brahmajosyula@gmail.com> | 2024-10-18 16:19:58 +0530 |
| --- | --- | --- |
| committer | Hans de Goede <hdegoede@redhat.com> | 2024-10-21 16:31:59 +0200 |
| commit | [48771da48072823956b271dddd568492c13d8170](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48771da48072823956b271dddd568492c13d8170) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=48771da48072823956b271dddd568492c13d8170)) | |
| tree | [688faa72383ca06f5ce2e65206a8ca5b1024abb6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48771da48072823956b271dddd568492c13d8170) | |
| parent | [5fa607880168d991bdc819f493a11155e935abe6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5fa607880168d991bdc819f493a11155e935abe6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48771da48072823956b271dddd568492c13d8170&id2=5fa607880168d991bdc819f493a11155e935abe6)) | |
| download | [linux-48771da48072823956b271dddd568492c13d8170.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-48771da48072823956b271dddd568492c13d8170.tar.gz) | |

platform/x86/intel/pmc: Fix pmc\_core\_iounmap to call iounmap for valid addressesCommit 50c6dbdfd16e ("x86/ioremap: Improve iounmap() address range checks")
introduces a WARN when adrress ranges of iounmap are invalid. On Thinkpad
P1 Gen 7 (Meteor Lake-P) this caused the following warning to appear:
WARNING: CPU: 7 PID: 713 at arch/x86/mm/ioremap.c:461 iounmap+0x58/0x1f0
Modules linked in: rfkill(+) snd\_timer(+) fjes(+) snd soundcore intel\_pmc\_core(+)
int3403\_thermal(+) int340x\_thermal\_zone intel\_vsec pmt\_telemetry acpi\_pad pmt\_class
acpi\_tad int3400\_thermal acpi\_thermal\_rel joydev loop nfnetlink zram xe drm\_suballoc\_helper
nouveau i915 mxm\_wmi drm\_ttm\_helper gpu\_sched drm\_gpuvm drm\_exec drm\_buddy i2c\_algo\_bit
crct10dif\_pclmul crc32\_pclmul ttm crc32c\_intel polyval\_clmulni rtsx\_pci\_sdmmc ucsi\_acpi
polyval\_generic mmc\_core hid\_multitouch drm\_display\_helper ghash\_clmulni\_intel typec\_ucsi
nvme sha512\_ssse3 video sha256\_ssse3 nvme\_core intel\_vpu sha1\_ssse3 rtsx\_pci cec typec
nvme\_auth i2c\_hid\_acpi i2c\_hid wmi pinctrl\_meteorlake serio\_raw ip6\_tables ip\_tables fuse
CPU: 7 UID: 0 PID: 713 Comm: (udev-worker) Not tainted 6.12.0-rc2iounmap+ #42
Hardware name: LENOVO 21KWCTO1WW/21KWCTO1WW, BIOS N48ET19W (1.06 ) 07/18/2024
RIP: 0010:iounmap+0x58/0x1f0
Code: 85 6a 01 00 00 48 8b 05 e6 e2 28 04 48 39 c5 72 19 eb 26 cc cc cc 48 ba 00 00 00 00 00 00 32 00 48 8d 44 02 ff 48 39 c5 72 23 <0f> 0b 48 83 c4 08 5b 5d 41 5c c3 cc cc cc cc 48 ba 00 00 00 00 00
RSP: 0018:ffff888131eff038 EFLAGS: 00010207
RAX: ffffc90000000000 RBX: 0000000000000000 RCX: ffff888e33b80000
RDX: dffffc0000000000 RSI: ffff888e33bc29c0 RDI: 0000000000000000
RBP: 0000000000000000 R08: ffff8881598a8000 R09: ffff888e2ccedc10
R10: 0000000000000003 R11: ffffffffb3367634 R12: 00000000fe000000
R13: ffff888101d0da28 R14: ffffffffc2e437e0 R15: ffff888110b03b28
FS: 00007f3c1d4b3980(0000) GS:ffff888e33b80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00005651cfc93578 CR3: 0000000124e4c002 CR4: 0000000000f70ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000ffff07f0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<TASK>
? \_\_warn.cold+0xb6/0x176
? iounmap+0x58/0x1f0
? report\_bug+0x1f4/0x2b0
? handle\_bug+0x58/0x90
? exc\_invalid\_op+0x17/0x40
? asm\_exc\_invalid\_op+0x1a/0x20
? iounmap+0x58/0x1f0
pmc\_core\_ssram\_get\_pmc+0x477/0x6c0 [intel\_pmc\_core]
? \_\_pfx\_pmc\_core\_ssram\_get\_pmc+0x10/0x10 [intel\_pmc\_core]
? \_\_pfx\_do\_pci\_enable\_device+0x10/0x10
? pci\_wait\_for\_pending+0x60/0x110
? pci\_enable\_device\_flags+0x1e3/0x2e0
? \_\_pfx\_mtl\_core\_init+0x10/0x10 [intel\_pmc\_core]
pmc\_core\_ssram\_init+0x7f/0x110 [intel\_pmc\_core]
mtl\_core\_init+0xda/0x130 [intel\_pmc\_core]
? \_\_mutex\_init+0xb9/0x130
pmc\_core\_probe+0x27e/0x10b0 [intel\_pmc\_core]
? \_raw\_spin\_lock\_irqsave+0x96/0xf0
? \_\_pfx\_pmc\_core\_probe+0x10/0x10 [intel\_pmc\_core]
? \_\_pfx\_mutex\_unlock+0x10/0x10
? \_\_pfx\_mutex\_lock+0x10/0x10
? device\_pm\_check\_callbacks+0x82/0x370
? acpi\_dev\_pm\_attach+0x234/0x2b0
platform\_probe+0x9f/0x150
really\_probe+0x1e0/0x8a0
\_\_driver\_probe\_device+0x18c/0x370
? \_\_pfx\_\_\_driver\_attach+0x10/0x10
driver\_probe\_device+0x4a/0x120
\_\_driver\_attach+0x190/0x4a0
? \_\_pfx\_\_\_driver\_attach+0x10/0x10
bus\_for\_each\_dev+0x103/0x180
? \_\_pfx\_bus\_for\_each\_dev+0x10/0x10
? klist\_add\_tail+0x136/0x270
bus\_add\_driver+0x2fc/0x540
driver\_register+0x1a5/0x360
? \_\_pfx\_pmc\_core\_driver\_init+0x10/0x10 [intel\_pmc\_core]
do\_one\_initcall+0xa4/0x380
? \_\_pfx\_do\_one\_initcall+0x10/0x10
? kasan\_unpoison+0x44/0x70
do\_init\_module+0x296/0x800
load\_module+0x5090/0x6ce0
? \_\_pfx\_load\_module+0x10/0x10
? ima\_post\_read\_file+0x193/0x200
? \_\_pfx\_ima\_post\_read\_file+0x10/0x10
? rw\_verify\_area+0x152/0x4c0
? kernel\_read\_file+0x257/0x750
? \_\_pfx\_kernel\_read\_file+0x10/0x10
? \_\_pfx\_filemap\_get\_read\_batch+0x10/0x10
? init\_module\_from\_file+0xd1/0x130
init\_module\_from\_file+0xd1/0x130
? \_\_pfx\_init\_module\_from\_file+0x10/0x10
? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
? \_\_pfx\_cred\_has\_capability.isra.0+0x10/0x10
idempotent\_init\_module+0x236/0x770
? \_\_pfx\_idempotent\_init\_module+0x10/0x10
? fdget+0x58/0x3f0
? security\_capable+0x7d/0x110
\_\_x64\_sys\_finit\_module+0xbe/0x130
do\_syscall\_64+0x82/0x160
? \_\_pfx\_filemap\_read+0x10/0x10
? \_\_pfx\_\_\_fsnotify\_parent+0x10/0x10
? vfs\_read+0x3a6/0xa30
? vfs\_read+0x3a6/0xa30
? \_\_seccomp\_filter+0x175/0xc60
? \_\_pfx\_\_\_seccomp\_filter+0x10/0x10
? fdget\_pos+0x1ce/0x500
? syscall\_exit\_to\_user\_mode\_prepare+0x149/0x170
? syscall\_exit\_to\_user\_mode+0x10/0x210
? do\_syscall\_64+0x8e/0x160
? switch\_fpu\_return+0xe3/0x1f0
? syscall\_exit\_to\_user\_mode+0x1d5/0x210
? do\_syscall\_64+0x8e/0x160
? exc\_page\_fault+0x76/0xf0
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
RIP: 0033:0x7f3c1d6d155d
Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 83 58 0f 00 f7 d8 64 89 01 48
RSP: 002b:00007ffe6309db38 EFLAGS: 00000246 ORIG\_RAX: 0000000000000139
RAX: ffffffffffffffda RBX: 0000557c212550a0 RCX: 00007f3c1d6d155d
RDX: 0000000000000000 RSI: 00007f3c1cd943bd RDI: 0000000000000025
RBP: 00007ffe6309dbf0 R08: 00007f3c1d7c7b20 R09: 00007ffe6309db80
R10: 0000557c21255270 R11: 0000000000000246 R12: 00007f3c1cd943bd
R13: 0000000000020000 R14: 0000557c21255c80 R15: 0000557c21255240
</TASK>
no\_free\_ptr(tmp\_ssram) sets tmp\_ssram NULL while assigning ssram.
pmc\_core\_iounmap calls iounmap unconditionally causing the above
warning to appear during boot.
Fix it by checking for a valid address before calling iounmap.
Also in the function pmc\_core\_ssram\_get\_pmc return -ENOMEM when
ioremap fails similar to other instances in the file.
Fixes: a01486dc4bb1 ("platform/x86/intel/pmc: Cleanup SSRAM discovery")
Reviewed-by: Ilpo Järvinen <ilpo.jarvinen@linux.intel.com>
Reviewed-by: David E. Box <david.e.box@linux.intel.com>
Signed-off-by: Vamsi Krishna Brahmajosyula <vamsikrishna.brahmajosyula@gmail.com>
Link: [https://lore.kernel.org/r/20241018104958.14195-1-vamsikrishna.brahmajosyula@gmail.com](https://lore.kernel.org/r/20241018104958.14195-1-vamsikrishna.brahmajosyula%40gmail.com)
Reviewed-by: Hans de Goede <hdegoede@redhat.com>
Signed-off-by: Hans de Goede <hdegoede@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48771da48072823956b271dddd568492c13d8170)

| -rw-r--r-- | [drivers/platform/x86/intel/pmc/core\_ssram.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/intel/pmc/core_ssram.c?id=48771da48072823956b271dddd568492c13d8170) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/platform/x86/intel/pmc/core\_ssram.c b/drivers/platform/x86/intel/pmc/core\_ssram.cindex c259c96b7dfdb4..8504154b649f47 100644--- a/[drivers/platform/x86/intel/pmc/core\_ssram.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/pmc/core_ssram.c?id=5fa607880168d991bdc819f493a11155e935abe6)+++ b/[drivers/platform/x86/intel/pmc/core\_ssram.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/intel/pmc/core_ssram.c?id=48771da48072823956b271dddd568492c13d8170)@@ -29,7 +29,7 @@ #define LPM\_REG\_COUNT 28 #define LPM\_MODE\_OFFSET 1 -DEFINE\_FREE(pmc\_core\_iounmap, void \_\_iomem \*, iounmap(\_T));+DEFINE\_FREE(pmc\_core\_iounmap, void \_\_iomem \*, if (\_T) iounmap(\_T))  static u32 pmc\_core\_find\_guid(struct pmc\_info \*list, const struct pmc\_reg\_map \*map) {@@ -262,6 +262,8 @@ pmc\_core\_ssram\_get\_pmc(struct pmc\_dev \*pmcdev, int pmc\_idx, u32 offset)  ssram\_base = ssram\_pcidev->resource[0].start; tmp\_ssram = ioremap(ssram\_base, SSRAM\_HDR\_SIZE);+ if (!tmp\_ssram)+ return -ENOMEM;  if (pmc\_idx != PMC\_IDX\_MAIN) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:55:20 +0000


