=== Content from git.kernel.org_8430e77f_20250114_211858.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-07 23:42:04 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:51:20 +0200 |
| commit | [1552ce9ce8af47c0fe911682e5e1855e25851ca9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9)) | |
| tree | [d2979f2bfb255e6f8fb90bcef4a85c9dd20bad6e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9) | |
| parent | [21817e1e426ece6c2eeb1fab1de4f295abcddf8c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=21817e1e426ece6c2eeb1fab1de4f295abcddf8c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9&id2=21817e1e426ece6c2eeb1fab1de4f295abcddf8c)) | |
| download | [linux-1552ce9ce8af47c0fe911682e5e1855e25851ca9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1552ce9ce8af47c0fe911682e5e1855e25851ca9.tar.gz) | |

mm/mremap: fix move\_normal\_pmd/retract\_page\_tables racecommit 6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa upstream.
In mremap(), move\_page\_tables() looks at the type of the PMD entry and the
specified address range to figure out by which method the next chunk of
page table entries should be moved.
At that point, the mmap\_lock is held in write mode, but no rmap locks are
held yet. For PMD entries that point to page tables and are fully covered
by the source address range, move\_pgt\_entry(NORMAL\_PMD, ...) is called,
which first takes rmap locks, then does move\_normal\_pmd().
move\_normal\_pmd() takes the necessary page table locks at source and
destination, then moves an entire page table from the source to the
destination.
The problem is: The rmap locks, which protect against concurrent page
table removal by retract\_page\_tables() in the THP code, are only taken
after the PMD entry has been read and it has been decided how to move it.
So we can race as follows (with two processes that have mappings of the
same tmpfs file that is stored on a tmpfs mount with huge=advise); note
that process A accesses page tables through the MM while process B does it
through the file rmap:
process A process B
========= =========
mremap
mremap\_to
move\_vma
move\_page\_tables
get\_old\_pmd
alloc\_new\_pmd
\*\*\* PREEMPT \*\*\*
madvise(MADV\_COLLAPSE)
do\_madvise
madvise\_walk\_vmas
madvise\_vma\_behavior
madvise\_collapse
hpage\_collapse\_scan\_file
collapse\_file
retract\_page\_tables
i\_mmap\_lock\_read(mapping)
pmdp\_collapse\_flush
i\_mmap\_unlock\_read(mapping)
move\_pgt\_entry(NORMAL\_PMD, ...)
take\_rmap\_locks
move\_normal\_pmd
drop\_rmap\_locks
When this happens, move\_normal\_pmd() can end up creating bogus PMD entries
in the line `pmd\_populate(mm, new\_pmd, pmd\_pgtable(pmd))`. The effect
depends on arch-specific and machine-specific details; on x86, you can end
up with physical page 0 mapped as a page table, which is likely
exploitable for user->kernel privilege escalation.
Fix the race by letting process B recheck that the PMD still points to a
page table after the rmap locks have been taken. Otherwise, we bail and
let the caller fall back to the PTE-level copying path, which will then
bail immediately at the pmd\_none() check.
Bug reachability: Reaching this bug requires that you can create
shmem/file THP mappings - anonymous THP uses different code that doesn't
zap stuff under rmap locks. File THP is gated on an experimental config
flag (CONFIG\_READ\_ONLY\_THP\_FOR\_FS), so on normal distro kernels you need
shmem THP to hit this bug. As far as I know, getting shmem THP normally
requires that you can mount your own tmpfs with the right mount flags,
which would require creating your own user+mount namespace; though I don't
know if some distros maybe enable shmem THP by default or something like
that.
Bug impact: This issue can likely be used for user->kernel privilege
escalation when it is reachable.
Link: [https://lkml.kernel.org/r/20241007-move\_normal\_pmd-vs-collapse-fix-2-v1-1-5ead9631f2ea@google.com](https://lkml.kernel.org/r/20241007-move_normal_pmd-vs-collapse-fix-2-v1-1-5ead9631f2ea%40google.com)
Fixes: 1d65b771bc08 ("mm/khugepaged: retract\_page\_tables() without mmap or vma lock")
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: David Hildenbrand <david@redhat.com>
Co-developed-by: David Hildenbrand <david@redhat.com>
Closes: https://project-zero.issues.chromium.org/371047675
Acked-by: Qi Zheng <zhengqi.arch@bytedance.com>
Reviewed-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Cc: Hugh Dickins <hughd@google.com>
Cc: Joel Fernandes <joel@joelfernandes.org>
Cc: Matthew Wilcox <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9)

| -rw-r--r-- | [mm/mremap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/mremap.c?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 2 deletions

| diff --git a/mm/mremap.c b/mm/mremap.cindex e7ae140fc6409b..3ca167d84c5655 100644--- a/[mm/mremap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mremap.c?id=21817e1e426ece6c2eeb1fab1de4f295abcddf8c)+++ b/[mm/mremap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mremap.c?id=1552ce9ce8af47c0fe911682e5e1855e25851ca9)@@ -238,6 +238,7 @@ static bool move\_normal\_pmd(struct vm\_area\_struct \*vma, unsigned long old\_addr, { spinlock\_t \*old\_ptl, \*new\_ptl; struct mm\_struct \*mm = vma->vm\_mm;+ bool res = false; pmd\_t pmd;  if (!arch\_supports\_page\_table\_move())@@ -277,19 +278,25 @@ static bool move\_normal\_pmd(struct vm\_area\_struct \*vma, unsigned long old\_addr, if (new\_ptl != old\_ptl) spin\_lock\_nested(new\_ptl, SINGLE\_DEPTH\_NESTING); - /\* Clear the pmd \*/ pmd = \*old\_pmd;++ /\* Racing with collapse? \*/+ if (unlikely(!pmd\_present(pmd) || pmd\_leaf(pmd)))+ goto out\_unlock;+ /\* Clear the pmd \*/ pmd\_clear(old\_pmd);+ res = true;  VM\_BUG\_ON(!pmd\_none(\*new\_pmd));  pmd\_populate(mm, new\_pmd, pmd\_pgtable(pmd)); flush\_tlb\_range(vma, old\_addr, old\_addr + PMD\_SIZE);+out\_unlock: if (new\_ptl != old\_ptl) spin\_unlock(new\_ptl); spin\_unlock(old\_ptl); - return true;+ return res; } #else static inline bool move\_normal\_pmd(struct vm\_area\_struct \*vma, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:17:35 +0000



=== Content from git.kernel.org_30982dff_20250114_211901.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-07 23:42:04 +0200 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-10-17 00:28:07 -0700 |
| commit | [6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa)) | |
| tree | [03e1e5ba792cb9fec8a4389e5153751696affe4c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa) | |
| parent | [8f3ce3d996bf1e2f8474ec3ddabdb8765c19e6ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f3ce3d996bf1e2f8474ec3ddabdb8765c19e6ea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa&id2=8f3ce3d996bf1e2f8474ec3ddabdb8765c19e6ea)) | |
| download | [linux-6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa.tar.gz) | |

mm/mremap: fix move\_normal\_pmd/retract\_page\_tables raceIn mremap(), move\_page\_tables() looks at the type of the PMD entry and the
specified address range to figure out by which method the next chunk of
page table entries should be moved.
At that point, the mmap\_lock is held in write mode, but no rmap locks are
held yet. For PMD entries that point to page tables and are fully covered
by the source address range, move\_pgt\_entry(NORMAL\_PMD, ...) is called,
which first takes rmap locks, then does move\_normal\_pmd().
move\_normal\_pmd() takes the necessary page table locks at source and
destination, then moves an entire page table from the source to the
destination.
The problem is: The rmap locks, which protect against concurrent page
table removal by retract\_page\_tables() in the THP code, are only taken
after the PMD entry has been read and it has been decided how to move it.
So we can race as follows (with two processes that have mappings of the
same tmpfs file that is stored on a tmpfs mount with huge=advise); note
that process A accesses page tables through the MM while process B does it
through the file rmap:
process A process B
========= =========
mremap
mremap\_to
move\_vma
move\_page\_tables
get\_old\_pmd
alloc\_new\_pmd
\*\*\* PREEMPT \*\*\*
madvise(MADV\_COLLAPSE)
do\_madvise
madvise\_walk\_vmas
madvise\_vma\_behavior
madvise\_collapse
hpage\_collapse\_scan\_file
collapse\_file
retract\_page\_tables
i\_mmap\_lock\_read(mapping)
pmdp\_collapse\_flush
i\_mmap\_unlock\_read(mapping)
move\_pgt\_entry(NORMAL\_PMD, ...)
take\_rmap\_locks
move\_normal\_pmd
drop\_rmap\_locks
When this happens, move\_normal\_pmd() can end up creating bogus PMD entries
in the line `pmd\_populate(mm, new\_pmd, pmd\_pgtable(pmd))`. The effect
depends on arch-specific and machine-specific details; on x86, you can end
up with physical page 0 mapped as a page table, which is likely
exploitable for user->kernel privilege escalation.
Fix the race by letting process B recheck that the PMD still points to a
page table after the rmap locks have been taken. Otherwise, we bail and
let the caller fall back to the PTE-level copying path, which will then
bail immediately at the pmd\_none() check.
Bug reachability: Reaching this bug requires that you can create
shmem/file THP mappings - anonymous THP uses different code that doesn't
zap stuff under rmap locks. File THP is gated on an experimental config
flag (CONFIG\_READ\_ONLY\_THP\_FOR\_FS), so on normal distro kernels you need
shmem THP to hit this bug. As far as I know, getting shmem THP normally
requires that you can mount your own tmpfs with the right mount flags,
which would require creating your own user+mount namespace; though I don't
know if some distros maybe enable shmem THP by default or something like
that.
Bug impact: This issue can likely be used for user->kernel privilege
escalation when it is reachable.
Link: [https://lkml.kernel.org/r/20241007-move\_normal\_pmd-vs-collapse-fix-2-v1-1-5ead9631f2ea@google.com](https://lkml.kernel.org/r/20241007-move_normal_pmd-vs-collapse-fix-2-v1-1-5ead9631f2ea%40google.com)
Fixes: 1d65b771bc08 ("mm/khugepaged: retract\_page\_tables() without mmap or vma lock")
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: David Hildenbrand <david@redhat.com>
Co-developed-by: David Hildenbrand <david@redhat.com>
Closes: https://project-zero.issues.chromium.org/371047675
Acked-by: Qi Zheng <zhengqi.arch@bytedance.com>
Reviewed-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Cc: Hugh Dickins <hughd@google.com>
Cc: Joel Fernandes <joel@joelfernandes.org>
Cc: Matthew Wilcox <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa)

| -rw-r--r-- | [mm/mremap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/mremap.c?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 2 deletions

| diff --git a/mm/mremap.c b/mm/mremap.cindex 24712f8dbb6b5c..dda09e957a5d4c 100644--- a/[mm/mremap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mremap.c?id=8f3ce3d996bf1e2f8474ec3ddabdb8765c19e6ea)+++ b/[mm/mremap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mremap.c?id=6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa)@@ -238,6 +238,7 @@ static bool move\_normal\_pmd(struct vm\_area\_struct \*vma, unsigned long old\_addr, { spinlock\_t \*old\_ptl, \*new\_ptl; struct mm\_struct \*mm = vma->vm\_mm;+ bool res = false; pmd\_t pmd;  if (!arch\_supports\_page\_table\_move())@@ -277,19 +278,25 @@ static bool move\_normal\_pmd(struct vm\_area\_struct \*vma, unsigned long old\_addr, if (new\_ptl != old\_ptl) spin\_lock\_nested(new\_ptl, SINGLE\_DEPTH\_NESTING); - /\* Clear the pmd \*/ pmd = \*old\_pmd;++ /\* Racing with collapse? \*/+ if (unlikely(!pmd\_present(pmd) || pmd\_leaf(pmd)))+ goto out\_unlock;+ /\* Clear the pmd \*/ pmd\_clear(old\_pmd);+ res = true;  VM\_BUG\_ON(!pmd\_none(\*new\_pmd));  pmd\_populate(mm, new\_pmd, pmd\_pgtable(pmd)); flush\_tlb\_range(vma, old\_addr, old\_addr + PMD\_SIZE);+out\_unlock: if (new\_ptl != old\_ptl) spin\_unlock(new\_ptl); spin\_unlock(old\_ptl); - return true;+ return res; } #else static inline bool move\_normal\_pmd(struct vm\_area\_struct \*vma, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:17:37 +0000



=== Content from git.kernel.org_0ace55f1_20250114_211859.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=17396e32f975130b3e6251f024c8807d192e4c3e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17396e32f975130b3e6251f024c8807d192e4c3e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17396e32f975130b3e6251f024c8807d192e4c3e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17396e32f975130b3e6251f024c8807d192e4c3e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2024-10-07 23:42:04 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:46:21 +0200 |
| commit | [17396e32f975130b3e6251f024c8807d192e4c3e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17396e32f975130b3e6251f024c8807d192e4c3e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=17396e32f975130b3e6251f024c8807d192e4c3e)) | |
| tree | [fa8e96487e65d2a5722ab831e92bbce4a6040269](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17396e32f975130b3e6251f024c8807d192e4c3e) | |
| parent | [6b91fd65a117b6e9f2384e139a9bab894f37ae06](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b91fd65a117b6e9f2384e139a9bab894f37ae06) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17396e32f975130b3e6251f024c8807d192e4c3e&id2=6b91fd65a117b6e9f2384e139a9bab894f37ae06)) | |
| download | [linux-17396e32f975130b3e6251f024c8807d192e4c3e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-17396e32f975130b3e6251f024c8807d192e4c3e.tar.gz) | |

mm/mremap: fix move\_normal\_pmd/retract\_page\_tables racecommit 6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa upstream.
In mremap(), move\_page\_tables() looks at the type of the PMD entry and the
specified address range to figure out by which method the next chunk of
page table entries should be moved.
At that point, the mmap\_lock is held in write mode, but no rmap locks are
held yet. For PMD entries that point to page tables and are fully covered
by the source address range, move\_pgt\_entry(NORMAL\_PMD, ...) is called,
which first takes rmap locks, then does move\_normal\_pmd().
move\_normal\_pmd() takes the necessary page table locks at source and
destination, then moves an entire page table from the source to the
destination.
The problem is: The rmap locks, which protect against concurrent page
table removal by retract\_page\_tables() in the THP code, are only taken
after the PMD entry has been read and it has been decided how to move it.
So we can race as follows (with two processes that have mappings of the
same tmpfs file that is stored on a tmpfs mount with huge=advise); note
that process A accesses page tables through the MM while process B does it
through the file rmap:
process A process B
========= =========
mremap
mremap\_to
move\_vma
move\_page\_tables
get\_old\_pmd
alloc\_new\_pmd
\*\*\* PREEMPT \*\*\*
madvise(MADV\_COLLAPSE)
do\_madvise
madvise\_walk\_vmas
madvise\_vma\_behavior
madvise\_collapse
hpage\_collapse\_scan\_file
collapse\_file
retract\_page\_tables
i\_mmap\_lock\_read(mapping)
pmdp\_collapse\_flush
i\_mmap\_unlock\_read(mapping)
move\_pgt\_entry(NORMAL\_PMD, ...)
take\_rmap\_locks
move\_normal\_pmd
drop\_rmap\_locks
When this happens, move\_normal\_pmd() can end up creating bogus PMD entries
in the line `pmd\_populate(mm, new\_pmd, pmd\_pgtable(pmd))`. The effect
depends on arch-specific and machine-specific details; on x86, you can end
up with physical page 0 mapped as a page table, which is likely
exploitable for user->kernel privilege escalation.
Fix the race by letting process B recheck that the PMD still points to a
page table after the rmap locks have been taken. Otherwise, we bail and
let the caller fall back to the PTE-level copying path, which will then
bail immediately at the pmd\_none() check.
Bug reachability: Reaching this bug requires that you can create
shmem/file THP mappings - anonymous THP uses different code that doesn't
zap stuff under rmap locks. File THP is gated on an experimental config
flag (CONFIG\_READ\_ONLY\_THP\_FOR\_FS), so on normal distro kernels you need
shmem THP to hit this bug. As far as I know, getting shmem THP normally
requires that you can mount your own tmpfs with the right mount flags,
which would require creating your own user+mount namespace; though I don't
know if some distros maybe enable shmem THP by default or something like
that.
Bug impact: This issue can likely be used for user->kernel privilege
escalation when it is reachable.
Link: [https://lkml.kernel.org/r/20241007-move\_normal\_pmd-vs-collapse-fix-2-v1-1-5ead9631f2ea@google.com](https://lkml.kernel.org/r/20241007-move_normal_pmd-vs-collapse-fix-2-v1-1-5ead9631f2ea%40google.com)
Fixes: 1d65b771bc08 ("mm/khugepaged: retract\_page\_tables() without mmap or vma lock")
Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: David Hildenbrand <david@redhat.com>
Co-developed-by: David Hildenbrand <david@redhat.com>
Closes: https://project-zero.issues.chromium.org/371047675
Acked-by: Qi Zheng <zhengqi.arch@bytedance.com>
Reviewed-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Cc: Hugh Dickins <hughd@google.com>
Cc: Joel Fernandes <joel@joelfernandes.org>
Cc: Matthew Wilcox <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17396e32f975130b3e6251f024c8807d192e4c3e)

| -rw-r--r-- | [mm/mremap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/mremap.c?id=17396e32f975130b3e6251f024c8807d192e4c3e) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 2 deletions

| diff --git a/mm/mremap.c b/mm/mremap.cindex 382e81c33fc437..df71010baabe7e 100644--- a/[mm/mremap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mremap.c?id=6b91fd65a117b6e9f2384e139a9bab894f37ae06)+++ b/[mm/mremap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/mremap.c?id=17396e32f975130b3e6251f024c8807d192e4c3e)@@ -238,6 +238,7 @@ static bool move\_normal\_pmd(struct vm\_area\_struct \*vma, unsigned long old\_addr, { spinlock\_t \*old\_ptl, \*new\_ptl; struct mm\_struct \*mm = vma->vm\_mm;+ bool res = false; pmd\_t pmd;  if (!arch\_supports\_page\_table\_move())@@ -277,19 +278,25 @@ static bool move\_normal\_pmd(struct vm\_area\_struct \*vma, unsigned long old\_addr, if (new\_ptl != old\_ptl) spin\_lock\_nested(new\_ptl, SINGLE\_DEPTH\_NESTING); - /\* Clear the pmd \*/ pmd = \*old\_pmd;++ /\* Racing with collapse? \*/+ if (unlikely(!pmd\_present(pmd) || pmd\_leaf(pmd)))+ goto out\_unlock;+ /\* Clear the pmd \*/ pmd\_clear(old\_pmd);+ res = true;  VM\_BUG\_ON(!pmd\_none(\*new\_pmd));  pmd\_populate(mm, new\_pmd, pmd\_pgtable(pmd)); flush\_tlb\_range(vma, old\_addr, old\_addr + PMD\_SIZE);+out\_unlock: if (new\_ptl != old\_ptl) spin\_unlock(new\_ptl); spin\_unlock(old\_ptl); - return true;+ return res; } #else static inline bool move\_normal\_pmd(struct vm\_area\_struct \*vma, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:17:35 +0000



=== Content from project-zero.issues.chromium.org_e1c54caf_20250114_211903.html ===
[Sign in](https://accounts.google.com/ServiceLogin?passive=1209600&osid=1&continue=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F371047675&followup=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F371047675&ec=GAZAkwI)
