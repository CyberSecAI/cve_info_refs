=== Content from git.kernel.org_76910638_20250114_203857.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peiyang Wang <wangpeiyang1@huawei.com> | 2024-11-01 17:15:07 +0800 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-11-05 13:45:39 +0100 |
| commit | [df3dff8ab6d79edc942464999d06fbaedf8cdd18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18)) | |
| tree | [0f15e9adf7de2fc26534bf5e6b0b6f74d9c37f40](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18) | |
| parent | [249cfa318fb1b77eb726c2ff4f74c9685f04e568](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=249cfa318fb1b77eb726c2ff4f74c9685f04e568) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18&id2=249cfa318fb1b77eb726c2ff4f74c9685f04e568)) | |
| download | [linux-df3dff8ab6d79edc942464999d06fbaedf8cdd18.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-df3dff8ab6d79edc942464999d06fbaedf8cdd18.tar.gz) | |

net: hns3: fix kernel crash when uninstalling driverWhen the driver is uninstalled and the VF is disabled concurrently, a
kernel crash occurs. The reason is that the two actions call function
pci\_disable\_sriov(). The num\_VFs is checked to determine whether to
release the corresponding resources. During the second calling, num\_VFs
is not 0 and the resource release function is called. However, the
corresponding resource has been released during the first invoking.
Therefore, the problem occurs:
[15277.839633][T50670] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
...
[15278.131557][T50670] Call trace:
[15278.134686][T50670] klist\_put+0x28/0x12c
[15278.138682][T50670] klist\_del+0x14/0x20
[15278.142592][T50670] device\_del+0xbc/0x3c0
[15278.146676][T50670] pci\_remove\_bus\_device+0x84/0x120
[15278.151714][T50670] pci\_stop\_and\_remove\_bus\_device+0x6c/0x80
[15278.157447][T50670] pci\_iov\_remove\_virtfn+0xb4/0x12c
[15278.162485][T50670] sriov\_disable+0x50/0x11c
[15278.166829][T50670] pci\_disable\_sriov+0x24/0x30
[15278.171433][T50670] hnae3\_unregister\_ae\_algo\_prepare+0x60/0x90 [hnae3]
[15278.178039][T50670] hclge\_exit+0x28/0xd0 [hclge]
[15278.182730][T50670] \_\_se\_sys\_delete\_module.isra.0+0x164/0x230
[15278.188550][T50670] \_\_arm64\_sys\_delete\_module+0x1c/0x30
[15278.193848][T50670] invoke\_syscall+0x50/0x11c
[15278.198278][T50670] el0\_svc\_common.constprop.0+0x158/0x164
[15278.203837][T50670] do\_el0\_svc+0x34/0xcc
[15278.207834][T50670] el0\_svc+0x20/0x30
For details, see the following figure.
rmmod hclge disable VFs
----------------------------------------------------
hclge\_exit() sriov\_numvfs\_store()
... device\_lock()
pci\_disable\_sriov() hns3\_pci\_sriov\_configure()
pci\_disable\_sriov()
sriov\_disable()
sriov\_disable() if !num\_VFs :
if !num\_VFs : return;
return; sriov\_del\_vfs()
sriov\_del\_vfs() ...
... klist\_put()
klist\_put() ...
... num\_VFs = 0;
num\_VFs = 0; device\_unlock();
In this patch, when driver is removing, we get the device\_lock()
to protect num\_VFs, just like sriov\_numvfs\_store().
Fixes: 0dd8a25f355b ("net: hns3: disable sriov before unload hclge layer")
Signed-off-by: Peiyang Wang <wangpeiyang1@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241101091507.3644584-1-shaojijie@huawei.com](https://patch.msgid.link/20241101091507.3644584-1-shaojijie%40huawei.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hnae3.c b/drivers/net/ethernet/hisilicon/hns3/hnae3.cindex 67b0bf310daaaf..9a63fbc6940831 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=249cfa318fb1b77eb726c2ff4f74c9685f04e568)+++ b/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=df3dff8ab6d79edc942464999d06fbaedf8cdd18)@@ -25,8 +25,11 @@ void hnae3\_unregister\_ae\_algo\_prepare(struct hnae3\_ae\_algo \*ae\_algo) pci\_id = pci\_match\_id(ae\_algo->pdev\_id\_table, ae\_dev->pdev); if (!pci\_id) continue;- if (IS\_ENABLED(CONFIG\_PCI\_IOV))+ if (IS\_ENABLED(CONFIG\_PCI\_IOV)) {+ device\_lock(&ae\_dev->pdev->dev); pci\_disable\_sriov(ae\_dev->pdev);+ device\_unlock(&ae\_dev->pdev->dev);+ } } } EXPORT\_SYMBOL(hnae3\_unregister\_ae\_algo\_prepare); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:34 +0000



=== Content from git.kernel.org_7b916501_20250114_203855.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a0df055775f30850c0da8f7dab40d67c0fd63908)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0df055775f30850c0da8f7dab40d67c0fd63908)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0df055775f30850c0da8f7dab40d67c0fd63908)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0df055775f30850c0da8f7dab40d67c0fd63908)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peiyang Wang <wangpeiyang1@huawei.com> | 2024-11-01 17:15:07 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:05 +0100 |
| commit | [a0df055775f30850c0da8f7dab40d67c0fd63908](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0df055775f30850c0da8f7dab40d67c0fd63908) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a0df055775f30850c0da8f7dab40d67c0fd63908)) | |
| tree | [e2a91c810ebc1b3ac3711ff7952fcb1f3217709e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0df055775f30850c0da8f7dab40d67c0fd63908) | |
| parent | [d15e97d187ab4bab4dff19882f3ed42ca99b341a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d15e97d187ab4bab4dff19882f3ed42ca99b341a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0df055775f30850c0da8f7dab40d67c0fd63908&id2=d15e97d187ab4bab4dff19882f3ed42ca99b341a)) | |
| download | [linux-a0df055775f30850c0da8f7dab40d67c0fd63908.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a0df055775f30850c0da8f7dab40d67c0fd63908.tar.gz) | |

net: hns3: fix kernel crash when uninstalling driver[ Upstream commit df3dff8ab6d79edc942464999d06fbaedf8cdd18 ]
When the driver is uninstalled and the VF is disabled concurrently, a
kernel crash occurs. The reason is that the two actions call function
pci\_disable\_sriov(). The num\_VFs is checked to determine whether to
release the corresponding resources. During the second calling, num\_VFs
is not 0 and the resource release function is called. However, the
corresponding resource has been released during the first invoking.
Therefore, the problem occurs:
[15277.839633][T50670] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
...
[15278.131557][T50670] Call trace:
[15278.134686][T50670] klist\_put+0x28/0x12c
[15278.138682][T50670] klist\_del+0x14/0x20
[15278.142592][T50670] device\_del+0xbc/0x3c0
[15278.146676][T50670] pci\_remove\_bus\_device+0x84/0x120
[15278.151714][T50670] pci\_stop\_and\_remove\_bus\_device+0x6c/0x80
[15278.157447][T50670] pci\_iov\_remove\_virtfn+0xb4/0x12c
[15278.162485][T50670] sriov\_disable+0x50/0x11c
[15278.166829][T50670] pci\_disable\_sriov+0x24/0x30
[15278.171433][T50670] hnae3\_unregister\_ae\_algo\_prepare+0x60/0x90 [hnae3]
[15278.178039][T50670] hclge\_exit+0x28/0xd0 [hclge]
[15278.182730][T50670] \_\_se\_sys\_delete\_module.isra.0+0x164/0x230
[15278.188550][T50670] \_\_arm64\_sys\_delete\_module+0x1c/0x30
[15278.193848][T50670] invoke\_syscall+0x50/0x11c
[15278.198278][T50670] el0\_svc\_common.constprop.0+0x158/0x164
[15278.203837][T50670] do\_el0\_svc+0x34/0xcc
[15278.207834][T50670] el0\_svc+0x20/0x30
For details, see the following figure.
rmmod hclge disable VFs
----------------------------------------------------
hclge\_exit() sriov\_numvfs\_store()
... device\_lock()
pci\_disable\_sriov() hns3\_pci\_sriov\_configure()
pci\_disable\_sriov()
sriov\_disable()
sriov\_disable() if !num\_VFs :
if !num\_VFs : return;
return; sriov\_del\_vfs()
sriov\_del\_vfs() ...
... klist\_put()
klist\_put() ...
... num\_VFs = 0;
num\_VFs = 0; device\_unlock();
In this patch, when driver is removing, we get the device\_lock()
to protect num\_VFs, just like sriov\_numvfs\_store().
Fixes: 0dd8a25f355b ("net: hns3: disable sriov before unload hclge layer")
Signed-off-by: Peiyang Wang <wangpeiyang1@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241101091507.3644584-1-shaojijie@huawei.com](https://patch.msgid.link/20241101091507.3644584-1-shaojijie%40huawei.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0df055775f30850c0da8f7dab40d67c0fd63908)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=a0df055775f30850c0da8f7dab40d67c0fd63908) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hnae3.c b/drivers/net/ethernet/hisilicon/hns3/hnae3.cindex b250d0fe9ac508..1265010f063fe4 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=d15e97d187ab4bab4dff19882f3ed42ca99b341a)+++ b/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=a0df055775f30850c0da8f7dab40d67c0fd63908)@@ -25,8 +25,11 @@ void hnae3\_unregister\_ae\_algo\_prepare(struct hnae3\_ae\_algo \*ae\_algo) pci\_id = pci\_match\_id(ae\_algo->pdev\_id\_table, ae\_dev->pdev); if (!pci\_id) continue;- if (IS\_ENABLED(CONFIG\_PCI\_IOV))+ if (IS\_ENABLED(CONFIG\_PCI\_IOV)) {+ device\_lock(&ae\_dev->pdev->dev); pci\_disable\_sriov(ae\_dev->pdev);+ device\_unlock(&ae\_dev->pdev->dev);+ } } } EXPORT\_SYMBOL(hnae3\_unregister\_ae\_algo\_prepare); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:31 +0000



=== Content from git.kernel.org_27fc0bf5_20250114_203849.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=719edd9f3372ce7fb3b157647c6658672946874b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=719edd9f3372ce7fb3b157647c6658672946874b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=719edd9f3372ce7fb3b157647c6658672946874b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=719edd9f3372ce7fb3b157647c6658672946874b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peiyang Wang <wangpeiyang1@huawei.com> | 2024-11-01 17:15:07 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:19:31 +0100 |
| commit | [719edd9f3372ce7fb3b157647c6658672946874b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=719edd9f3372ce7fb3b157647c6658672946874b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=719edd9f3372ce7fb3b157647c6658672946874b)) | |
| tree | [ce93de270120c2a0f5ac013b95161fa4f81861a2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=719edd9f3372ce7fb3b157647c6658672946874b) | |
| parent | [4b0599a66614350fd270b6d31e17cf6b9c3c5e99](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b0599a66614350fd270b6d31e17cf6b9c3c5e99) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=719edd9f3372ce7fb3b157647c6658672946874b&id2=4b0599a66614350fd270b6d31e17cf6b9c3c5e99)) | |
| download | [linux-719edd9f3372ce7fb3b157647c6658672946874b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-719edd9f3372ce7fb3b157647c6658672946874b.tar.gz) | |

net: hns3: fix kernel crash when uninstalling driver[ Upstream commit df3dff8ab6d79edc942464999d06fbaedf8cdd18 ]
When the driver is uninstalled and the VF is disabled concurrently, a
kernel crash occurs. The reason is that the two actions call function
pci\_disable\_sriov(). The num\_VFs is checked to determine whether to
release the corresponding resources. During the second calling, num\_VFs
is not 0 and the resource release function is called. However, the
corresponding resource has been released during the first invoking.
Therefore, the problem occurs:
[15277.839633][T50670] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
...
[15278.131557][T50670] Call trace:
[15278.134686][T50670] klist\_put+0x28/0x12c
[15278.138682][T50670] klist\_del+0x14/0x20
[15278.142592][T50670] device\_del+0xbc/0x3c0
[15278.146676][T50670] pci\_remove\_bus\_device+0x84/0x120
[15278.151714][T50670] pci\_stop\_and\_remove\_bus\_device+0x6c/0x80
[15278.157447][T50670] pci\_iov\_remove\_virtfn+0xb4/0x12c
[15278.162485][T50670] sriov\_disable+0x50/0x11c
[15278.166829][T50670] pci\_disable\_sriov+0x24/0x30
[15278.171433][T50670] hnae3\_unregister\_ae\_algo\_prepare+0x60/0x90 [hnae3]
[15278.178039][T50670] hclge\_exit+0x28/0xd0 [hclge]
[15278.182730][T50670] \_\_se\_sys\_delete\_module.isra.0+0x164/0x230
[15278.188550][T50670] \_\_arm64\_sys\_delete\_module+0x1c/0x30
[15278.193848][T50670] invoke\_syscall+0x50/0x11c
[15278.198278][T50670] el0\_svc\_common.constprop.0+0x158/0x164
[15278.203837][T50670] do\_el0\_svc+0x34/0xcc
[15278.207834][T50670] el0\_svc+0x20/0x30
For details, see the following figure.
rmmod hclge disable VFs
----------------------------------------------------
hclge\_exit() sriov\_numvfs\_store()
... device\_lock()
pci\_disable\_sriov() hns3\_pci\_sriov\_configure()
pci\_disable\_sriov()
sriov\_disable()
sriov\_disable() if !num\_VFs :
if !num\_VFs : return;
return; sriov\_del\_vfs()
sriov\_del\_vfs() ...
... klist\_put()
klist\_put() ...
... num\_VFs = 0;
num\_VFs = 0; device\_unlock();
In this patch, when driver is removing, we get the device\_lock()
to protect num\_VFs, just like sriov\_numvfs\_store().
Fixes: 0dd8a25f355b ("net: hns3: disable sriov before unload hclge layer")
Signed-off-by: Peiyang Wang <wangpeiyang1@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241101091507.3644584-1-shaojijie@huawei.com](https://patch.msgid.link/20241101091507.3644584-1-shaojijie%40huawei.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=719edd9f3372ce7fb3b157647c6658672946874b)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=719edd9f3372ce7fb3b157647c6658672946874b) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hnae3.c b/drivers/net/ethernet/hisilicon/hns3/hnae3.cindex 67b0bf310daaaf..9a63fbc6940831 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=4b0599a66614350fd270b6d31e17cf6b9c3c5e99)+++ b/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=719edd9f3372ce7fb3b157647c6658672946874b)@@ -25,8 +25,11 @@ void hnae3\_unregister\_ae\_algo\_prepare(struct hnae3\_ae\_algo \*ae\_algo) pci\_id = pci\_match\_id(ae\_algo->pdev\_id\_table, ae\_dev->pdev); if (!pci\_id) continue;- if (IS\_ENABLED(CONFIG\_PCI\_IOV))+ if (IS\_ENABLED(CONFIG\_PCI\_IOV)) {+ device\_lock(&ae\_dev->pdev->dev); pci\_disable\_sriov(ae\_dev->pdev);+ device\_unlock(&ae\_dev->pdev->dev);+ } } } EXPORT\_SYMBOL(hnae3\_unregister\_ae\_algo\_prepare); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:26 +0000



=== Content from git.kernel.org_42d25d79_20250114_203856.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peiyang Wang <wangpeiyang1@huawei.com> | 2024-11-01 17:15:07 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:00 +0100 |
| commit | [b5c94e4d947d15d521e935ff10c5a22a7883dea5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5)) | |
| tree | [18d297131577358b72c6edb0867b644b86a9df64](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5) | |
| parent | [a515c817b3395f8d47b10031e2c28afaa5c3d93d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a515c817b3395f8d47b10031e2c28afaa5c3d93d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5&id2=a515c817b3395f8d47b10031e2c28afaa5c3d93d)) | |
| download | [linux-b5c94e4d947d15d521e935ff10c5a22a7883dea5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b5c94e4d947d15d521e935ff10c5a22a7883dea5.tar.gz) | |

net: hns3: fix kernel crash when uninstalling driver[ Upstream commit df3dff8ab6d79edc942464999d06fbaedf8cdd18 ]
When the driver is uninstalled and the VF is disabled concurrently, a
kernel crash occurs. The reason is that the two actions call function
pci\_disable\_sriov(). The num\_VFs is checked to determine whether to
release the corresponding resources. During the second calling, num\_VFs
is not 0 and the resource release function is called. However, the
corresponding resource has been released during the first invoking.
Therefore, the problem occurs:
[15277.839633][T50670] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
...
[15278.131557][T50670] Call trace:
[15278.134686][T50670] klist\_put+0x28/0x12c
[15278.138682][T50670] klist\_del+0x14/0x20
[15278.142592][T50670] device\_del+0xbc/0x3c0
[15278.146676][T50670] pci\_remove\_bus\_device+0x84/0x120
[15278.151714][T50670] pci\_stop\_and\_remove\_bus\_device+0x6c/0x80
[15278.157447][T50670] pci\_iov\_remove\_virtfn+0xb4/0x12c
[15278.162485][T50670] sriov\_disable+0x50/0x11c
[15278.166829][T50670] pci\_disable\_sriov+0x24/0x30
[15278.171433][T50670] hnae3\_unregister\_ae\_algo\_prepare+0x60/0x90 [hnae3]
[15278.178039][T50670] hclge\_exit+0x28/0xd0 [hclge]
[15278.182730][T50670] \_\_se\_sys\_delete\_module.isra.0+0x164/0x230
[15278.188550][T50670] \_\_arm64\_sys\_delete\_module+0x1c/0x30
[15278.193848][T50670] invoke\_syscall+0x50/0x11c
[15278.198278][T50670] el0\_svc\_common.constprop.0+0x158/0x164
[15278.203837][T50670] do\_el0\_svc+0x34/0xcc
[15278.207834][T50670] el0\_svc+0x20/0x30
For details, see the following figure.
rmmod hclge disable VFs
----------------------------------------------------
hclge\_exit() sriov\_numvfs\_store()
... device\_lock()
pci\_disable\_sriov() hns3\_pci\_sriov\_configure()
pci\_disable\_sriov()
sriov\_disable()
sriov\_disable() if !num\_VFs :
if !num\_VFs : return;
return; sriov\_del\_vfs()
sriov\_del\_vfs() ...
... klist\_put()
klist\_put() ...
... num\_VFs = 0;
num\_VFs = 0; device\_unlock();
In this patch, when driver is removing, we get the device\_lock()
to protect num\_VFs, just like sriov\_numvfs\_store().
Fixes: 0dd8a25f355b ("net: hns3: disable sriov before unload hclge layer")
Signed-off-by: Peiyang Wang <wangpeiyang1@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241101091507.3644584-1-shaojijie@huawei.com](https://patch.msgid.link/20241101091507.3644584-1-shaojijie%40huawei.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hnae3.c b/drivers/net/ethernet/hisilicon/hns3/hnae3.cindex 67b0bf310daaaf..9a63fbc6940831 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=a515c817b3395f8d47b10031e2c28afaa5c3d93d)+++ b/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=b5c94e4d947d15d521e935ff10c5a22a7883dea5)@@ -25,8 +25,11 @@ void hnae3\_unregister\_ae\_algo\_prepare(struct hnae3\_ae\_algo \*ae\_algo) pci\_id = pci\_match\_id(ae\_algo->pdev\_id\_table, ae\_dev->pdev); if (!pci\_id) continue;- if (IS\_ENABLED(CONFIG\_PCI\_IOV))+ if (IS\_ENABLED(CONFIG\_PCI\_IOV)) {+ device\_lock(&ae\_dev->pdev->dev); pci\_disable\_sriov(ae\_dev->pdev);+ device\_unlock(&ae\_dev->pdev->dev);+ } } } EXPORT\_SYMBOL(hnae3\_unregister\_ae\_algo\_prepare); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:33 +0000



=== Content from git.kernel.org_b3a56d6c_20250114_203851.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peiyang Wang <wangpeiyang1@huawei.com> | 2024-11-01 17:15:07 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:15:11 +0100 |
| commit | [76b155e14d9b182ce83d32ada2d0d7219ea8c8dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd)) | |
| tree | [26d01eef3e4d40ec9ab207ea50b5d13cd2bb78bb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd) | |
| parent | [7ad3fb3bfd43feb4e15c81dffd23ac4e55742791](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ad3fb3bfd43feb4e15c81dffd23ac4e55742791) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd&id2=7ad3fb3bfd43feb4e15c81dffd23ac4e55742791)) | |
| download | [linux-76b155e14d9b182ce83d32ada2d0d7219ea8c8dd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-76b155e14d9b182ce83d32ada2d0d7219ea8c8dd.tar.gz) | |

net: hns3: fix kernel crash when uninstalling driver[ Upstream commit df3dff8ab6d79edc942464999d06fbaedf8cdd18 ]
When the driver is uninstalled and the VF is disabled concurrently, a
kernel crash occurs. The reason is that the two actions call function
pci\_disable\_sriov(). The num\_VFs is checked to determine whether to
release the corresponding resources. During the second calling, num\_VFs
is not 0 and the resource release function is called. However, the
corresponding resource has been released during the first invoking.
Therefore, the problem occurs:
[15277.839633][T50670] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
...
[15278.131557][T50670] Call trace:
[15278.134686][T50670] klist\_put+0x28/0x12c
[15278.138682][T50670] klist\_del+0x14/0x20
[15278.142592][T50670] device\_del+0xbc/0x3c0
[15278.146676][T50670] pci\_remove\_bus\_device+0x84/0x120
[15278.151714][T50670] pci\_stop\_and\_remove\_bus\_device+0x6c/0x80
[15278.157447][T50670] pci\_iov\_remove\_virtfn+0xb4/0x12c
[15278.162485][T50670] sriov\_disable+0x50/0x11c
[15278.166829][T50670] pci\_disable\_sriov+0x24/0x30
[15278.171433][T50670] hnae3\_unregister\_ae\_algo\_prepare+0x60/0x90 [hnae3]
[15278.178039][T50670] hclge\_exit+0x28/0xd0 [hclge]
[15278.182730][T50670] \_\_se\_sys\_delete\_module.isra.0+0x164/0x230
[15278.188550][T50670] \_\_arm64\_sys\_delete\_module+0x1c/0x30
[15278.193848][T50670] invoke\_syscall+0x50/0x11c
[15278.198278][T50670] el0\_svc\_common.constprop.0+0x158/0x164
[15278.203837][T50670] do\_el0\_svc+0x34/0xcc
[15278.207834][T50670] el0\_svc+0x20/0x30
For details, see the following figure.
rmmod hclge disable VFs
----------------------------------------------------
hclge\_exit() sriov\_numvfs\_store()
... device\_lock()
pci\_disable\_sriov() hns3\_pci\_sriov\_configure()
pci\_disable\_sriov()
sriov\_disable()
sriov\_disable() if !num\_VFs :
if !num\_VFs : return;
return; sriov\_del\_vfs()
sriov\_del\_vfs() ...
... klist\_put()
klist\_put() ...
... num\_VFs = 0;
num\_VFs = 0; device\_unlock();
In this patch, when driver is removing, we get the device\_lock()
to protect num\_VFs, just like sriov\_numvfs\_store().
Fixes: 0dd8a25f355b ("net: hns3: disable sriov before unload hclge layer")
Signed-off-by: Peiyang Wang <wangpeiyang1@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241101091507.3644584-1-shaojijie@huawei.com](https://patch.msgid.link/20241101091507.3644584-1-shaojijie%40huawei.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hnae3.c b/drivers/net/ethernet/hisilicon/hns3/hnae3.cindex 67b0bf310daaaf..9a63fbc6940831 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=7ad3fb3bfd43feb4e15c81dffd23ac4e55742791)+++ b/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=76b155e14d9b182ce83d32ada2d0d7219ea8c8dd)@@ -25,8 +25,11 @@ void hnae3\_unregister\_ae\_algo\_prepare(struct hnae3\_ae\_algo \*ae\_algo) pci\_id = pci\_match\_id(ae\_algo->pdev\_id\_table, ae\_dev->pdev); if (!pci\_id) continue;- if (IS\_ENABLED(CONFIG\_PCI\_IOV))+ if (IS\_ENABLED(CONFIG\_PCI\_IOV)) {+ device\_lock(&ae\_dev->pdev->dev); pci\_disable\_sriov(ae\_dev->pdev);+ device\_unlock(&ae\_dev->pdev->dev);+ } } } EXPORT\_SYMBOL(hnae3\_unregister\_ae\_algo\_prepare); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:28 +0000



=== Content from git.kernel.org_84ec5623_20250114_203858.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peiyang Wang <wangpeiyang1@huawei.com> | 2024-11-01 17:15:07 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:13:36 +0100 |
| commit | [e36482b222e00cc7aeeea772fc0cf2943590bc4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d)) | |
| tree | [416694da13b9012d379c52fe060181654dd8b9fc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d) | |
| parent | [262dc6ea5f1eb18c4d08ad83d51222d0dd0dd42a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=262dc6ea5f1eb18c4d08ad83d51222d0dd0dd42a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d&id2=262dc6ea5f1eb18c4d08ad83d51222d0dd0dd42a)) | |
| download | [linux-e36482b222e00cc7aeeea772fc0cf2943590bc4d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e36482b222e00cc7aeeea772fc0cf2943590bc4d.tar.gz) | |

net: hns3: fix kernel crash when uninstalling driver[ Upstream commit df3dff8ab6d79edc942464999d06fbaedf8cdd18 ]
When the driver is uninstalled and the VF is disabled concurrently, a
kernel crash occurs. The reason is that the two actions call function
pci\_disable\_sriov(). The num\_VFs is checked to determine whether to
release the corresponding resources. During the second calling, num\_VFs
is not 0 and the resource release function is called. However, the
corresponding resource has been released during the first invoking.
Therefore, the problem occurs:
[15277.839633][T50670] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
...
[15278.131557][T50670] Call trace:
[15278.134686][T50670] klist\_put+0x28/0x12c
[15278.138682][T50670] klist\_del+0x14/0x20
[15278.142592][T50670] device\_del+0xbc/0x3c0
[15278.146676][T50670] pci\_remove\_bus\_device+0x84/0x120
[15278.151714][T50670] pci\_stop\_and\_remove\_bus\_device+0x6c/0x80
[15278.157447][T50670] pci\_iov\_remove\_virtfn+0xb4/0x12c
[15278.162485][T50670] sriov\_disable+0x50/0x11c
[15278.166829][T50670] pci\_disable\_sriov+0x24/0x30
[15278.171433][T50670] hnae3\_unregister\_ae\_algo\_prepare+0x60/0x90 [hnae3]
[15278.178039][T50670] hclge\_exit+0x28/0xd0 [hclge]
[15278.182730][T50670] \_\_se\_sys\_delete\_module.isra.0+0x164/0x230
[15278.188550][T50670] \_\_arm64\_sys\_delete\_module+0x1c/0x30
[15278.193848][T50670] invoke\_syscall+0x50/0x11c
[15278.198278][T50670] el0\_svc\_common.constprop.0+0x158/0x164
[15278.203837][T50670] do\_el0\_svc+0x34/0xcc
[15278.207834][T50670] el0\_svc+0x20/0x30
For details, see the following figure.
rmmod hclge disable VFs
----------------------------------------------------
hclge\_exit() sriov\_numvfs\_store()
... device\_lock()
pci\_disable\_sriov() hns3\_pci\_sriov\_configure()
pci\_disable\_sriov()
sriov\_disable()
sriov\_disable() if !num\_VFs :
if !num\_VFs : return;
return; sriov\_del\_vfs()
sriov\_del\_vfs() ...
... klist\_put()
klist\_put() ...
... num\_VFs = 0;
num\_VFs = 0; device\_unlock();
In this patch, when driver is removing, we get the device\_lock()
to protect num\_VFs, just like sriov\_numvfs\_store().
Fixes: 0dd8a25f355b ("net: hns3: disable sriov before unload hclge layer")
Signed-off-by: Peiyang Wang <wangpeiyang1@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241101091507.3644584-1-shaojijie@huawei.com](https://patch.msgid.link/20241101091507.3644584-1-shaojijie%40huawei.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hnae3.c b/drivers/net/ethernet/hisilicon/hns3/hnae3.cindex 67b0bf310daaaf..9a63fbc6940831 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=262dc6ea5f1eb18c4d08ad83d51222d0dd0dd42a)+++ b/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=e36482b222e00cc7aeeea772fc0cf2943590bc4d)@@ -25,8 +25,11 @@ void hnae3\_unregister\_ae\_algo\_prepare(struct hnae3\_ae\_algo \*ae\_algo) pci\_id = pci\_match\_id(ae\_algo->pdev\_id\_table, ae\_dev->pdev); if (!pci\_id) continue;- if (IS\_ENABLED(CONFIG\_PCI\_IOV))+ if (IS\_ENABLED(CONFIG\_PCI\_IOV)) {+ device\_lock(&ae\_dev->pdev->dev); pci\_disable\_sriov(ae\_dev->pdev);+ device\_unlock(&ae\_dev->pdev->dev);+ } } } EXPORT\_SYMBOL(hnae3\_unregister\_ae\_algo\_prepare); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:35 +0000



=== Content from git.kernel.org_edfa3918_20250114_203853.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7ae4e56de7dbd0999578246a536cf52a63f4056d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ae4e56de7dbd0999578246a536cf52a63f4056d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ae4e56de7dbd0999578246a536cf52a63f4056d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ae4e56de7dbd0999578246a536cf52a63f4056d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peiyang Wang <wangpeiyang1@huawei.com> | 2024-11-01 17:15:07 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:50 +0100 |
| commit | [7ae4e56de7dbd0999578246a536cf52a63f4056d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ae4e56de7dbd0999578246a536cf52a63f4056d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7ae4e56de7dbd0999578246a536cf52a63f4056d)) | |
| tree | [baaef7bb3bb8886084e78315c83e3f486bbb62b1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ae4e56de7dbd0999578246a536cf52a63f4056d) | |
| parent | [83b3b73afce63a726d72ac5418ff65fff4cbccdd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83b3b73afce63a726d72ac5418ff65fff4cbccdd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ae4e56de7dbd0999578246a536cf52a63f4056d&id2=83b3b73afce63a726d72ac5418ff65fff4cbccdd)) | |
| download | [linux-7ae4e56de7dbd0999578246a536cf52a63f4056d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7ae4e56de7dbd0999578246a536cf52a63f4056d.tar.gz) | |

net: hns3: fix kernel crash when uninstalling driver[ Upstream commit df3dff8ab6d79edc942464999d06fbaedf8cdd18 ]
When the driver is uninstalled and the VF is disabled concurrently, a
kernel crash occurs. The reason is that the two actions call function
pci\_disable\_sriov(). The num\_VFs is checked to determine whether to
release the corresponding resources. During the second calling, num\_VFs
is not 0 and the resource release function is called. However, the
corresponding resource has been released during the first invoking.
Therefore, the problem occurs:
[15277.839633][T50670] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
...
[15278.131557][T50670] Call trace:
[15278.134686][T50670] klist\_put+0x28/0x12c
[15278.138682][T50670] klist\_del+0x14/0x20
[15278.142592][T50670] device\_del+0xbc/0x3c0
[15278.146676][T50670] pci\_remove\_bus\_device+0x84/0x120
[15278.151714][T50670] pci\_stop\_and\_remove\_bus\_device+0x6c/0x80
[15278.157447][T50670] pci\_iov\_remove\_virtfn+0xb4/0x12c
[15278.162485][T50670] sriov\_disable+0x50/0x11c
[15278.166829][T50670] pci\_disable\_sriov+0x24/0x30
[15278.171433][T50670] hnae3\_unregister\_ae\_algo\_prepare+0x60/0x90 [hnae3]
[15278.178039][T50670] hclge\_exit+0x28/0xd0 [hclge]
[15278.182730][T50670] \_\_se\_sys\_delete\_module.isra.0+0x164/0x230
[15278.188550][T50670] \_\_arm64\_sys\_delete\_module+0x1c/0x30
[15278.193848][T50670] invoke\_syscall+0x50/0x11c
[15278.198278][T50670] el0\_svc\_common.constprop.0+0x158/0x164
[15278.203837][T50670] do\_el0\_svc+0x34/0xcc
[15278.207834][T50670] el0\_svc+0x20/0x30
For details, see the following figure.
rmmod hclge disable VFs
----------------------------------------------------
hclge\_exit() sriov\_numvfs\_store()
... device\_lock()
pci\_disable\_sriov() hns3\_pci\_sriov\_configure()
pci\_disable\_sriov()
sriov\_disable()
sriov\_disable() if !num\_VFs :
if !num\_VFs : return;
return; sriov\_del\_vfs()
sriov\_del\_vfs() ...
... klist\_put()
klist\_put() ...
... num\_VFs = 0;
num\_VFs = 0; device\_unlock();
In this patch, when driver is removing, we get the device\_lock()
to protect num\_VFs, just like sriov\_numvfs\_store().
Fixes: 0dd8a25f355b ("net: hns3: disable sriov before unload hclge layer")
Signed-off-by: Peiyang Wang <wangpeiyang1@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241101091507.3644584-1-shaojijie@huawei.com](https://patch.msgid.link/20241101091507.3644584-1-shaojijie%40huawei.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ae4e56de7dbd0999578246a536cf52a63f4056d)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=7ae4e56de7dbd0999578246a536cf52a63f4056d) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hnae3.c b/drivers/net/ethernet/hisilicon/hns3/hnae3.cindex 2e38c7d214c458..6c7cef6f1532fb 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=83b3b73afce63a726d72ac5418ff65fff4cbccdd)+++ b/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=7ae4e56de7dbd0999578246a536cf52a63f4056d)@@ -25,8 +25,11 @@ void hnae3\_unregister\_ae\_algo\_prepare(struct hnae3\_ae\_algo \*ae\_algo) pci\_id = pci\_match\_id(ae\_algo->pdev\_id\_table, ae\_dev->pdev); if (!pci\_id) continue;- if (IS\_ENABLED(CONFIG\_PCI\_IOV))+ if (IS\_ENABLED(CONFIG\_PCI\_IOV)) {+ device\_lock(&ae\_dev->pdev->dev); pci\_disable\_sriov(ae\_dev->pdev);+ device\_unlock(&ae\_dev->pdev->dev);+ } } } EXPORT\_SYMBOL(hnae3\_unregister\_ae\_algo\_prepare); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:29 +0000



=== Content from git.kernel.org_4b2bd1f7_20250114_203848.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=590a4b2d4e0b73586e88bce9b8135b593355ec09)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=590a4b2d4e0b73586e88bce9b8135b593355ec09)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=590a4b2d4e0b73586e88bce9b8135b593355ec09)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=590a4b2d4e0b73586e88bce9b8135b593355ec09)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peiyang Wang <wangpeiyang1@huawei.com> | 2024-11-01 17:15:07 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:59:35 +0100 |
| commit | [590a4b2d4e0b73586e88bce9b8135b593355ec09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=590a4b2d4e0b73586e88bce9b8135b593355ec09) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=590a4b2d4e0b73586e88bce9b8135b593355ec09)) | |
| tree | [48fe5df10ac0e4fc724af246b56cd867a966641d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=590a4b2d4e0b73586e88bce9b8135b593355ec09) | |
| parent | [cf6bae33c5aa714200946ae3dd2aa97657713bbd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf6bae33c5aa714200946ae3dd2aa97657713bbd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=590a4b2d4e0b73586e88bce9b8135b593355ec09&id2=cf6bae33c5aa714200946ae3dd2aa97657713bbd)) | |
| download | [linux-590a4b2d4e0b73586e88bce9b8135b593355ec09.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-590a4b2d4e0b73586e88bce9b8135b593355ec09.tar.gz) | |

net: hns3: fix kernel crash when uninstalling driver[ Upstream commit df3dff8ab6d79edc942464999d06fbaedf8cdd18 ]
When the driver is uninstalled and the VF is disabled concurrently, a
kernel crash occurs. The reason is that the two actions call function
pci\_disable\_sriov(). The num\_VFs is checked to determine whether to
release the corresponding resources. During the second calling, num\_VFs
is not 0 and the resource release function is called. However, the
corresponding resource has been released during the first invoking.
Therefore, the problem occurs:
[15277.839633][T50670] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
...
[15278.131557][T50670] Call trace:
[15278.134686][T50670] klist\_put+0x28/0x12c
[15278.138682][T50670] klist\_del+0x14/0x20
[15278.142592][T50670] device\_del+0xbc/0x3c0
[15278.146676][T50670] pci\_remove\_bus\_device+0x84/0x120
[15278.151714][T50670] pci\_stop\_and\_remove\_bus\_device+0x6c/0x80
[15278.157447][T50670] pci\_iov\_remove\_virtfn+0xb4/0x12c
[15278.162485][T50670] sriov\_disable+0x50/0x11c
[15278.166829][T50670] pci\_disable\_sriov+0x24/0x30
[15278.171433][T50670] hnae3\_unregister\_ae\_algo\_prepare+0x60/0x90 [hnae3]
[15278.178039][T50670] hclge\_exit+0x28/0xd0 [hclge]
[15278.182730][T50670] \_\_se\_sys\_delete\_module.isra.0+0x164/0x230
[15278.188550][T50670] \_\_arm64\_sys\_delete\_module+0x1c/0x30
[15278.193848][T50670] invoke\_syscall+0x50/0x11c
[15278.198278][T50670] el0\_svc\_common.constprop.0+0x158/0x164
[15278.203837][T50670] do\_el0\_svc+0x34/0xcc
[15278.207834][T50670] el0\_svc+0x20/0x30
For details, see the following figure.
rmmod hclge disable VFs
----------------------------------------------------
hclge\_exit() sriov\_numvfs\_store()
... device\_lock()
pci\_disable\_sriov() hns3\_pci\_sriov\_configure()
pci\_disable\_sriov()
sriov\_disable()
sriov\_disable() if !num\_VFs :
if !num\_VFs : return;
return; sriov\_del\_vfs()
sriov\_del\_vfs() ...
... klist\_put()
klist\_put() ...
... num\_VFs = 0;
num\_VFs = 0; device\_unlock();
In this patch, when driver is removing, we get the device\_lock()
to protect num\_VFs, just like sriov\_numvfs\_store().
Fixes: 0dd8a25f355b ("net: hns3: disable sriov before unload hclge layer")
Signed-off-by: Peiyang Wang <wangpeiyang1@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20241101091507.3644584-1-shaojijie@huawei.com](https://patch.msgid.link/20241101091507.3644584-1-shaojijie%40huawei.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=590a4b2d4e0b73586e88bce9b8135b593355ec09)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=590a4b2d4e0b73586e88bce9b8135b593355ec09) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hnae3.c b/drivers/net/ethernet/hisilicon/hns3/hnae3.cindex 67b0bf310daaaf..9a63fbc6940831 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=cf6bae33c5aa714200946ae3dd2aa97657713bbd)+++ b/[drivers/net/ethernet/hisilicon/hns3/hnae3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hnae3.c?id=590a4b2d4e0b73586e88bce9b8135b593355ec09)@@ -25,8 +25,11 @@ void hnae3\_unregister\_ae\_algo\_prepare(struct hnae3\_ae\_algo \*ae\_algo) pci\_id = pci\_match\_id(ae\_algo->pdev\_id\_table, ae\_dev->pdev); if (!pci\_id) continue;- if (IS\_ENABLED(CONFIG\_PCI\_IOV))+ if (IS\_ENABLED(CONFIG\_PCI\_IOV)) {+ device\_lock(&ae\_dev->pdev->dev); pci\_disable\_sriov(ae\_dev->pdev);+ device\_unlock(&ae\_dev->pdev->dev);+ } } } EXPORT\_SYMBOL(hnae3\_unregister\_ae\_algo\_prepare); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:37:25 +0000


