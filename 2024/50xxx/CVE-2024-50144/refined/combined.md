=== Content from git.kernel.org_03c18dcb_20250114_190741.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=03a86c24aea0920a1ca20a0d7771d5e176db538d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=03a86c24aea0920a1ca20a0d7771d5e176db538d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03a86c24aea0920a1ca20a0d7771d5e176db538d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=03a86c24aea0920a1ca20a0d7771d5e176db538d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-10-09 09:48:09 +0100 |
| --- | --- | --- |
| committer | Lucas De Marchi <lucas.demarchi@intel.com> | 2024-10-16 09:00:22 -0500 |
| commit | [03a86c24aea0920a1ca20a0d7771d5e176db538d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03a86c24aea0920a1ca20a0d7771d5e176db538d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=03a86c24aea0920a1ca20a0d7771d5e176db538d)) | |
| tree | [d927a79dc09b67643316df670b63e49cd2cfe7ef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=03a86c24aea0920a1ca20a0d7771d5e176db538d) | |
| parent | [4ceead37ca9f5e555fe46e8528bd14dd1d2728e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ceead37ca9f5e555fe46e8528bd14dd1d2728e8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=03a86c24aea0920a1ca20a0d7771d5e176db538d&id2=4ceead37ca9f5e555fe46e8528bd14dd1d2728e8)) | |
| download | [linux-03a86c24aea0920a1ca20a0d7771d5e176db538d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-03a86c24aea0920a1ca20a0d7771d5e176db538d.tar.gz) | |

drm/xe: fix unbalanced rpm put() with fence\_fini()Currently we can call fence\_fini() twice if something goes wrong when
sending the GuC CT for the tlb request, since we signal the fence and
return an error, leading to the caller also calling fini() on the error
path in the case of stack version of the flow, which leads to an extra
rpm put() which might later cause device to enter suspend when it
shouldn't. It looks like we can just drop the fini() call since the
fence signaller side will already call this for us.
There are known mysterious splats with device going to sleep even with
an rpm ref, and this could be one candidate.
v2 (Matt B):
- Prefer warning if we detect double fini()
Fixes: f002702290fc ("drm/xe: Hold a PM ref when GT TLB invalidations are inflight")
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Matthew Brost <matthew.brost@intel.com>
Cc: Nirmoy Das <nirmoy.das@intel.com>
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Reviewed-by: Nirmoy Das <nirmoy.das@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20241009084808.204432-3-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20241009084808.204432-3-matthew.auld%40intel.com)
(cherry picked from commit cfcbc0520d5055825f0647ab922b655688605183)
Signed-off-by: Lucas De Marchi <lucas.demarchi@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=03a86c24aea0920a1ca20a0d7771d5e176db538d)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.c?id=03a86c24aea0920a1ca20a0d7771d5e176db538d) | 29 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.h?id=03a86c24aea0920a1ca20a0d7771d5e176db538d) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_vm.c?id=03a86c24aea0920a1ca20a0d7771d5e176db538d) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 15 insertions, 23 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.c b/drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.cindex cca9cf536f7693..bbb9e411d21f64 100644--- a/[drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.c?id=4ceead37ca9f5e555fe46e8528bd14dd1d2728e8)+++ b/[drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.c?id=03a86c24aea0920a1ca20a0d7771d5e176db538d)@@ -37,6 +37,15 @@ static long tlb\_timeout\_jiffies(struct xe\_gt \*gt) return hw\_tlb\_timeout + 2 \* delay; } +static void xe\_gt\_tlb\_invalidation\_fence\_fini(struct xe\_gt\_tlb\_invalidation\_fence \*fence)+{+ if (WARN\_ON\_ONCE(!fence->gt))+ return;++ xe\_pm\_runtime\_put(gt\_to\_xe(fence->gt));+ fence->gt = NULL; /\* fini() should be called once \*/+}+ static void \_\_invalidation\_fence\_signal(struct xe\_device \*xe, struct xe\_gt\_tlb\_invalidation\_fence \*fence) {@@ -204,7 +213,7 @@ static int send\_tlb\_invalidation(struct xe\_guc \*guc, tlb\_timeout\_jiffies(gt)); } spin\_unlock\_irq(&gt->tlb\_invalidation.pending\_lock);- } else if (ret < 0) {+ } else { \_\_invalidation\_fence\_signal(xe, fence); } if (!ret) {@@ -267,10 +276,8 @@ int xe\_gt\_tlb\_invalidation\_ggtt(struct xe\_gt \*gt)  xe\_gt\_tlb\_invalidation\_fence\_init(gt, &fence, true); ret = xe\_gt\_tlb\_invalidation\_guc(gt, &fence);- if (ret < 0) {- xe\_gt\_tlb\_invalidation\_fence\_fini(&fence);+ if (ret) return ret;- }  xe\_gt\_tlb\_invalidation\_fence\_wait(&fence); } else if (xe\_device\_uc\_enabled(xe) && !xe\_device\_wedged(xe)) {@@ -496,7 +503,8 @@ static const struct dma\_fence\_ops invalidation\_fence\_ops = { \* @stack: fence is stack variable \* \* Initialize TLB invalidation fence for use. xe\_gt\_tlb\_invalidation\_fence\_fini- \* must be called if fence is not signaled.+ \* will be automatically called when fence is signalled (all fences must signal),+ \* even on error. \*/ void xe\_gt\_tlb\_invalidation\_fence\_init(struct xe\_gt \*gt, struct xe\_gt\_tlb\_invalidation\_fence \*fence,@@ -516,14 +524,3 @@ void xe\_gt\_tlb\_invalidation\_fence\_init(struct xe\_gt \*gt, dma\_fence\_get(&fence->base); fence->gt = gt; }--/\*\*- \* xe\_gt\_tlb\_invalidation\_fence\_fini - Finalize TLB invalidation fence- \* @fence: TLB invalidation fence to finalize- \*- \* Drop PM ref which fence took durinig init.- \*/-void xe\_gt\_tlb\_invalidation\_fence\_fini(struct xe\_gt\_tlb\_invalidation\_fence \*fence)-{- xe\_pm\_runtime\_put(gt\_to\_xe(fence->gt));-}diff --git a/drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.h b/drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.hindex a84065fa324c76..f430d5797af701 100644--- a/[drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.h?id=4ceead37ca9f5e555fe46e8528bd14dd1d2728e8)+++ b/[drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.h?id=03a86c24aea0920a1ca20a0d7771d5e176db538d)@@ -28,7 +28,6 @@ int xe\_guc\_tlb\_invalidation\_done\_handler(struct xe\_guc \*guc, u32 \*msg, u32 len); void xe\_gt\_tlb\_invalidation\_fence\_init(struct xe\_gt \*gt, struct xe\_gt\_tlb\_invalidation\_fence \*fence, bool stack);-void xe\_gt\_tlb\_invalidation\_fence\_fini(struct xe\_gt\_tlb\_invalidation\_fence \*fence);  static inline void xe\_gt\_tlb\_invalidation\_fence\_wait(struct xe\_gt\_tlb\_invalidation\_fence \*fence)diff --git a/drivers/gpu/drm/xe/xe\_vm.c b/drivers/gpu/drm/xe/xe\_vm.cindex ce9dca4d4e87b4..c99380271de62f 100644--- a/[drivers/gpu/drm/xe/xe\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_vm.c?id=4ceead37ca9f5e555fe46e8528bd14dd1d2728e8)+++ b/[drivers/gpu/drm/xe/xe\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_vm.c?id=03a86c24aea0920a1ca20a0d7771d5e176db538d)@@ -3199,10 +3199,8 @@ int xe\_vm\_invalidate\_vma(struct xe\_vma \*vma)  ret = xe\_gt\_tlb\_invalidation\_vma(tile->primary\_gt, &fence[fence\_id], vma);- if (ret < 0) {- xe\_gt\_tlb\_invalidation\_fence\_fini(&fence[fence\_id]);+ if (ret) goto wait;- } ++fence\_id;  if (!tile->media\_gt)@@ -3214,10 +3212,8 @@ int xe\_vm\_invalidate\_vma(struct xe\_vma \*vma)  ret = xe\_gt\_tlb\_invalidation\_vma(tile->media\_gt, &fence[fence\_id], vma);- if (ret < 0) {- xe\_gt\_tlb\_invalidation\_fence\_fini(&fence[fence\_id]);+ if (ret) goto wait;- } ++fence\_id; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:18 +0000



=== Content from git.kernel.org_eeb0cfc8_20250114_190741.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=046bd018c0123b1a49c22abed5f9ea31d1454c78)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=046bd018c0123b1a49c22abed5f9ea31d1454c78)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=046bd018c0123b1a49c22abed5f9ea31d1454c78)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=046bd018c0123b1a49c22abed5f9ea31d1454c78)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-10-09 09:48:09 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:30 +0100 |
| commit | [046bd018c0123b1a49c22abed5f9ea31d1454c78](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=046bd018c0123b1a49c22abed5f9ea31d1454c78) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=046bd018c0123b1a49c22abed5f9ea31d1454c78)) | |
| tree | [5f067ee5f18a7da8574948672833b214793e4da8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=046bd018c0123b1a49c22abed5f9ea31d1454c78) | |
| parent | [d465c676cc596261be781775369cf12a7d86bd1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d465c676cc596261be781775369cf12a7d86bd1f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=046bd018c0123b1a49c22abed5f9ea31d1454c78&id2=d465c676cc596261be781775369cf12a7d86bd1f)) | |
| download | [linux-046bd018c0123b1a49c22abed5f9ea31d1454c78.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-046bd018c0123b1a49c22abed5f9ea31d1454c78.tar.gz) | |

drm/xe: fix unbalanced rpm put() with fence\_fini()[ Upstream commit 03a86c24aea0920a1ca20a0d7771d5e176db538d ]
Currently we can call fence\_fini() twice if something goes wrong when
sending the GuC CT for the tlb request, since we signal the fence and
return an error, leading to the caller also calling fini() on the error
path in the case of stack version of the flow, which leads to an extra
rpm put() which might later cause device to enter suspend when it
shouldn't. It looks like we can just drop the fini() call since the
fence signaller side will already call this for us.
There are known mysterious splats with device going to sleep even with
an rpm ref, and this could be one candidate.
v2 (Matt B):
- Prefer warning if we detect double fini()
Fixes: f002702290fc ("drm/xe: Hold a PM ref when GT TLB invalidations are inflight")
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Matthew Brost <matthew.brost@intel.com>
Cc: Nirmoy Das <nirmoy.das@intel.com>
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Reviewed-by: Nirmoy Das <nirmoy.das@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20241009084808.204432-3-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20241009084808.204432-3-matthew.auld%40intel.com)
(cherry picked from commit cfcbc0520d5055825f0647ab922b655688605183)
Signed-off-by: Lucas De Marchi <lucas.demarchi@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=046bd018c0123b1a49c22abed5f9ea31d1454c78)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.c?id=046bd018c0123b1a49c22abed5f9ea31d1454c78) | 29 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.h?id=046bd018c0123b1a49c22abed5f9ea31d1454c78) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_vm.c?id=046bd018c0123b1a49c22abed5f9ea31d1454c78) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 15 insertions, 23 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.c b/drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.cindex 87cb76a8718c99..82795133e129ec 100644--- a/[drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.c?id=d465c676cc596261be781775369cf12a7d86bd1f)+++ b/[drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.c?id=046bd018c0123b1a49c22abed5f9ea31d1454c78)@@ -36,6 +36,15 @@ static long tlb\_timeout\_jiffies(struct xe\_gt \*gt) return hw\_tlb\_timeout + 2 \* delay; } +static void xe\_gt\_tlb\_invalidation\_fence\_fini(struct xe\_gt\_tlb\_invalidation\_fence \*fence)+{+ if (WARN\_ON\_ONCE(!fence->gt))+ return;++ xe\_pm\_runtime\_put(gt\_to\_xe(fence->gt));+ fence->gt = NULL; /\* fini() should be called once \*/+}+ static void \_\_invalidation\_fence\_signal(struct xe\_device \*xe, struct xe\_gt\_tlb\_invalidation\_fence \*fence) {@@ -203,7 +212,7 @@ static int send\_tlb\_invalidation(struct xe\_guc \*guc, tlb\_timeout\_jiffies(gt)); } spin\_unlock\_irq(&gt->tlb\_invalidation.pending\_lock);- } else if (ret < 0) {+ } else { \_\_invalidation\_fence\_signal(xe, fence); } if (!ret) {@@ -265,10 +274,8 @@ int xe\_gt\_tlb\_invalidation\_ggtt(struct xe\_gt \*gt)  xe\_gt\_tlb\_invalidation\_fence\_init(gt, &fence, true); ret = xe\_gt\_tlb\_invalidation\_guc(gt, &fence);- if (ret < 0) {- xe\_gt\_tlb\_invalidation\_fence\_fini(&fence);+ if (ret) return ret;- }  xe\_gt\_tlb\_invalidation\_fence\_wait(&fence); } else if (xe\_device\_uc\_enabled(xe) && !xe\_device\_wedged(xe)) {@@ -494,7 +501,8 @@ static const struct dma\_fence\_ops invalidation\_fence\_ops = { \* @stack: fence is stack variable \* \* Initialize TLB invalidation fence for use. xe\_gt\_tlb\_invalidation\_fence\_fini- \* must be called if fence is not signaled.+ \* will be automatically called when fence is signalled (all fences must signal),+ \* even on error. \*/ void xe\_gt\_tlb\_invalidation\_fence\_init(struct xe\_gt \*gt, struct xe\_gt\_tlb\_invalidation\_fence \*fence,@@ -514,14 +522,3 @@ void xe\_gt\_tlb\_invalidation\_fence\_init(struct xe\_gt \*gt, dma\_fence\_get(&fence->base); fence->gt = gt; }--/\*\*- \* xe\_gt\_tlb\_invalidation\_fence\_fini - Finalize TLB invalidation fence- \* @fence: TLB invalidation fence to finalize- \*- \* Drop PM ref which fence took durinig init.- \*/-void xe\_gt\_tlb\_invalidation\_fence\_fini(struct xe\_gt\_tlb\_invalidation\_fence \*fence)-{- xe\_pm\_runtime\_put(gt\_to\_xe(fence->gt));-}diff --git a/drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.h b/drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.hindex a84065fa324c76..f430d5797af701 100644--- a/[drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.h?id=d465c676cc596261be781775369cf12a7d86bd1f)+++ b/[drivers/gpu/drm/xe/xe\_gt\_tlb\_invalidation.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_gt_tlb_invalidation.h?id=046bd018c0123b1a49c22abed5f9ea31d1454c78)@@ -28,7 +28,6 @@ int xe\_guc\_tlb\_invalidation\_done\_handler(struct xe\_guc \*guc, u32 \*msg, u32 len); void xe\_gt\_tlb\_invalidation\_fence\_init(struct xe\_gt \*gt, struct xe\_gt\_tlb\_invalidation\_fence \*fence, bool stack);-void xe\_gt\_tlb\_invalidation\_fence\_fini(struct xe\_gt\_tlb\_invalidation\_fence \*fence);  static inline void xe\_gt\_tlb\_invalidation\_fence\_wait(struct xe\_gt\_tlb\_invalidation\_fence \*fence)diff --git a/drivers/gpu/drm/xe/xe\_vm.c b/drivers/gpu/drm/xe/xe\_vm.cindex 49ba9a1e375f42..3ac41f70ea6b17 100644--- a/[drivers/gpu/drm/xe/xe\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_vm.c?id=d465c676cc596261be781775369cf12a7d86bd1f)+++ b/[drivers/gpu/drm/xe/xe\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_vm.c?id=046bd018c0123b1a49c22abed5f9ea31d1454c78)@@ -3377,10 +3377,8 @@ int xe\_vm\_invalidate\_vma(struct xe\_vma \*vma)  ret = xe\_gt\_tlb\_invalidation\_vma(tile->primary\_gt, &fence[fence\_id], vma);- if (ret < 0) {- xe\_gt\_tlb\_invalidation\_fence\_fini(&fence[fence\_id]);+ if (ret) goto wait;- } ++fence\_id;  if (!tile->media\_gt)@@ -3392,10 +3390,8 @@ int xe\_vm\_invalidate\_vma(struct xe\_vma \*vma)  ret = xe\_gt\_tlb\_invalidation\_vma(tile->media\_gt, &fence[fence\_id], vma);- if (ret < 0) {- xe\_gt\_tlb\_invalidation\_fence\_fini(&fence[fence\_id]);+ if (ret) goto wait;- } ++fence\_id; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:18 +0000


