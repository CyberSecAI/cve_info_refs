=== Content from git.kernel.org_76ec5ae6_20250114_202340.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-18 08:13:39 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:37 +0100 |
| commit | [e4369cb6acf6b895ac2453cc1cdf2f4326122c6d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d)) | |
| tree | [fd26f5afeef63cf014d86441d9c3c0824a2de8dd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d) | |
| parent | [2240f9376f20f8b6463232b4ca7292569217237f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2240f9376f20f8b6463232b4ca7292569217237f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d&id2=2240f9376f20f8b6463232b4ca7292569217237f)) | |
| download | [linux-e4369cb6acf6b895ac2453cc1cdf2f4326122c6d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e4369cb6acf6b895ac2453cc1cdf2f4326122c6d.tar.gz) | |

net: sched: use RCU read-side critical section in taprio\_dump()[ Upstream commit b22db8b8befe90b61c98626ca1a2fbb0505e9fe3 ]
Fix possible use-after-free in 'taprio\_dump()' by adding RCU
read-side critical section there. Never seen on x86 but
found on a KASAN-enabled arm64 system when investigating
https://syzkaller.appspot.com/bug?extid=b65e0af58423fc8a73aa:
[T15862] BUG: KASAN: slab-use-after-free in taprio\_dump+0xa0c/0xbb0
[T15862] Read of size 4 at addr ffff0000d4bb88f8 by task repro/15862
[T15862]
[T15862] CPU: 0 UID: 0 PID: 15862 Comm: repro Not tainted 6.11.0-rc1-00293-gdefaf1a2113a-dirty #2
[T15862] Hardware name: QEMU QEMU Virtual Machine, BIOS edk2-20240524-5.fc40 05/24/2024
[T15862] Call trace:
[T15862] dump\_backtrace+0x20c/0x220
[T15862] show\_stack+0x2c/0x40
[T15862] dump\_stack\_lvl+0xf8/0x174
[T15862] print\_report+0x170/0x4d8
[T15862] kasan\_report+0xb8/0x1d4
[T15862] \_\_asan\_report\_load4\_noabort+0x20/0x2c
[T15862] taprio\_dump+0xa0c/0xbb0
[T15862] tc\_fill\_qdisc+0x540/0x1020
[T15862] qdisc\_notify.isra.0+0x330/0x3a0
[T15862] tc\_modify\_qdisc+0x7b8/0x1838
[T15862] rtnetlink\_rcv\_msg+0x3c8/0xc20
[T15862] netlink\_rcv\_skb+0x1f8/0x3d4
[T15862] rtnetlink\_rcv+0x28/0x40
[T15862] netlink\_unicast+0x51c/0x790
[T15862] netlink\_sendmsg+0x79c/0xc20
[T15862] \_\_sock\_sendmsg+0xe0/0x1a0
[T15862] \_\_\_\_sys\_sendmsg+0x6c0/0x840
[T15862] \_\_\_sys\_sendmsg+0x1ac/0x1f0
[T15862] \_\_sys\_sendmsg+0x110/0x1d0
[T15862] \_\_arm64\_sys\_sendmsg+0x74/0xb0
[T15862] invoke\_syscall+0x88/0x2e0
[T15862] el0\_svc\_common.constprop.0+0xe4/0x2a0
[T15862] do\_el0\_svc+0x44/0x60
[T15862] el0\_svc+0x50/0x184
[T15862] el0t\_64\_sync\_handler+0x120/0x12c
[T15862] el0t\_64\_sync+0x190/0x194
[T15862]
[T15862] Allocated by task 15857:
[T15862] kasan\_save\_stack+0x3c/0x70
[T15862] kasan\_save\_track+0x20/0x3c
[T15862] kasan\_save\_alloc\_info+0x40/0x60
[T15862] \_\_kasan\_kmalloc+0xd4/0xe0
[T15862] \_\_kmalloc\_cache\_noprof+0x194/0x334
[T15862] taprio\_change+0x45c/0x2fe0
[T15862] tc\_modify\_qdisc+0x6a8/0x1838
[T15862] rtnetlink\_rcv\_msg+0x3c8/0xc20
[T15862] netlink\_rcv\_skb+0x1f8/0x3d4
[T15862] rtnetlink\_rcv+0x28/0x40
[T15862] netlink\_unicast+0x51c/0x790
[T15862] netlink\_sendmsg+0x79c/0xc20
[T15862] \_\_sock\_sendmsg+0xe0/0x1a0
[T15862] \_\_\_\_sys\_sendmsg+0x6c0/0x840
[T15862] \_\_\_sys\_sendmsg+0x1ac/0x1f0
[T15862] \_\_sys\_sendmsg+0x110/0x1d0
[T15862] \_\_arm64\_sys\_sendmsg+0x74/0xb0
[T15862] invoke\_syscall+0x88/0x2e0
[T15862] el0\_svc\_common.constprop.0+0xe4/0x2a0
[T15862] do\_el0\_svc+0x44/0x60
[T15862] el0\_svc+0x50/0x184
[T15862] el0t\_64\_sync\_handler+0x120/0x12c
[T15862] el0t\_64\_sync+0x190/0x194
[T15862]
[T15862] Freed by task 6192:
[T15862] kasan\_save\_stack+0x3c/0x70
[T15862] kasan\_save\_track+0x20/0x3c
[T15862] kasan\_save\_free\_info+0x4c/0x80
[T15862] poison\_slab\_object+0x110/0x160
[T15862] \_\_kasan\_slab\_free+0x3c/0x74
[T15862] kfree+0x134/0x3c0
[T15862] taprio\_free\_sched\_cb+0x18c/0x220
[T15862] rcu\_core+0x920/0x1b7c
[T15862] rcu\_core\_si+0x10/0x1c
[T15862] handle\_softirqs+0x2e8/0xd64
[T15862] \_\_do\_softirq+0x14/0x20
Fixes: 18cdd2f0998a ("net/sched: taprio: taprio\_dump and taprio\_change are protected by rtnl\_mutex")
Acked-by: Vinicius Costa Gomes <vinicius.gomes@intel.com>
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20241018051339.418890-2-dmantipov@yandex.ru](https://patch.msgid.link/20241018051339.418890-2-dmantipov%40yandex.ru)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d)

| -rw-r--r-- | [net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_taprio.c?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 6 deletions

| diff --git a/net/sched/sch\_taprio.c b/net/sched/sch\_taprio.cindex 9f4e004cdb8be8..8623dc0bafc09b 100644--- a/[net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_taprio.c?id=2240f9376f20f8b6463232b4ca7292569217237f)+++ b/[net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_taprio.c?id=e4369cb6acf6b895ac2453cc1cdf2f4326122c6d)@@ -2374,9 +2374,6 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) struct tc\_mqprio\_qopt opt = { 0 }; struct nlattr \*nest, \*sched\_nest; - oper = rtnl\_dereference(q->oper\_sched);- admin = rtnl\_dereference(q->admin\_sched);- mqprio\_qopt\_reconstruct(dev, &opt);  nest = nla\_nest\_start\_noflag(skb, TCA\_OPTIONS);@@ -2397,18 +2394,23 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) nla\_put\_u32(skb, TCA\_TAPRIO\_ATTR\_TXTIME\_DELAY, q->txtime\_delay)) goto options\_error; + rcu\_read\_lock();++ oper = rtnl\_dereference(q->oper\_sched);+ admin = rtnl\_dereference(q->admin\_sched);+ if (oper && taprio\_dump\_tc\_entries(skb, q, oper))- goto options\_error;+ goto options\_error\_rcu;  if (oper && dump\_schedule(skb, oper))- goto options\_error;+ goto options\_error\_rcu;  if (!admin) goto done;  sched\_nest = nla\_nest\_start\_noflag(skb, TCA\_TAPRIO\_ATTR\_ADMIN\_SCHED); if (!sched\_nest)- goto options\_error;+ goto options\_error\_rcu;  if (dump\_schedule(skb, admin)) goto admin\_error;@@ -2416,11 +2418,15 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) nla\_nest\_end(skb, sched\_nest);  done:+ rcu\_read\_unlock(); return nla\_nest\_end(skb, nest);  admin\_error: nla\_nest\_cancel(skb, sched\_nest); +options\_error\_rcu:+ rcu\_read\_unlock();+ options\_error: nla\_nest\_cancel(skb, nest); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:22:05 +0000



=== Content from git.kernel.org_e091ab0b_20250114_202327.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b911fa9e92ee586e36479ad57b88f20471acaca1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b911fa9e92ee586e36479ad57b88f20471acaca1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b911fa9e92ee586e36479ad57b88f20471acaca1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b911fa9e92ee586e36479ad57b88f20471acaca1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-18 08:13:39 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:15:19 +0100 |
| commit | [b911fa9e92ee586e36479ad57b88f20471acaca1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b911fa9e92ee586e36479ad57b88f20471acaca1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b911fa9e92ee586e36479ad57b88f20471acaca1)) | |
| tree | [47198b5aa06a747e7eac037c58c2d1859050cef3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b911fa9e92ee586e36479ad57b88f20471acaca1) | |
| parent | [7f6c3c7f8d4d81eae58c7516d69dc47866726181](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7f6c3c7f8d4d81eae58c7516d69dc47866726181) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b911fa9e92ee586e36479ad57b88f20471acaca1&id2=7f6c3c7f8d4d81eae58c7516d69dc47866726181)) | |
| download | [linux-b911fa9e92ee586e36479ad57b88f20471acaca1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b911fa9e92ee586e36479ad57b88f20471acaca1.tar.gz) | |

net: sched: use RCU read-side critical section in taprio\_dump()commit b22db8b8befe90b61c98626ca1a2fbb0505e9fe3 upstream.
Fix possible use-after-free in 'taprio\_dump()' by adding RCU
read-side critical section there. Never seen on x86 but
found on a KASAN-enabled arm64 system when investigating
https://syzkaller.appspot.com/bug?extid=b65e0af58423fc8a73aa:
[T15862] BUG: KASAN: slab-use-after-free in taprio\_dump+0xa0c/0xbb0
[T15862] Read of size 4 at addr ffff0000d4bb88f8 by task repro/15862
[T15862]
[T15862] CPU: 0 UID: 0 PID: 15862 Comm: repro Not tainted 6.11.0-rc1-00293-gdefaf1a2113a-dirty #2
[T15862] Hardware name: QEMU QEMU Virtual Machine, BIOS edk2-20240524-5.fc40 05/24/2024
[T15862] Call trace:
[T15862] dump\_backtrace+0x20c/0x220
[T15862] show\_stack+0x2c/0x40
[T15862] dump\_stack\_lvl+0xf8/0x174
[T15862] print\_report+0x170/0x4d8
[T15862] kasan\_report+0xb8/0x1d4
[T15862] \_\_asan\_report\_load4\_noabort+0x20/0x2c
[T15862] taprio\_dump+0xa0c/0xbb0
[T15862] tc\_fill\_qdisc+0x540/0x1020
[T15862] qdisc\_notify.isra.0+0x330/0x3a0
[T15862] tc\_modify\_qdisc+0x7b8/0x1838
[T15862] rtnetlink\_rcv\_msg+0x3c8/0xc20
[T15862] netlink\_rcv\_skb+0x1f8/0x3d4
[T15862] rtnetlink\_rcv+0x28/0x40
[T15862] netlink\_unicast+0x51c/0x790
[T15862] netlink\_sendmsg+0x79c/0xc20
[T15862] \_\_sock\_sendmsg+0xe0/0x1a0
[T15862] \_\_\_\_sys\_sendmsg+0x6c0/0x840
[T15862] \_\_\_sys\_sendmsg+0x1ac/0x1f0
[T15862] \_\_sys\_sendmsg+0x110/0x1d0
[T15862] \_\_arm64\_sys\_sendmsg+0x74/0xb0
[T15862] invoke\_syscall+0x88/0x2e0
[T15862] el0\_svc\_common.constprop.0+0xe4/0x2a0
[T15862] do\_el0\_svc+0x44/0x60
[T15862] el0\_svc+0x50/0x184
[T15862] el0t\_64\_sync\_handler+0x120/0x12c
[T15862] el0t\_64\_sync+0x190/0x194
[T15862]
[T15862] Allocated by task 15857:
[T15862] kasan\_save\_stack+0x3c/0x70
[T15862] kasan\_save\_track+0x20/0x3c
[T15862] kasan\_save\_alloc\_info+0x40/0x60
[T15862] \_\_kasan\_kmalloc+0xd4/0xe0
[T15862] \_\_kmalloc\_cache\_noprof+0x194/0x334
[T15862] taprio\_change+0x45c/0x2fe0
[T15862] tc\_modify\_qdisc+0x6a8/0x1838
[T15862] rtnetlink\_rcv\_msg+0x3c8/0xc20
[T15862] netlink\_rcv\_skb+0x1f8/0x3d4
[T15862] rtnetlink\_rcv+0x28/0x40
[T15862] netlink\_unicast+0x51c/0x790
[T15862] netlink\_sendmsg+0x79c/0xc20
[T15862] \_\_sock\_sendmsg+0xe0/0x1a0
[T15862] \_\_\_\_sys\_sendmsg+0x6c0/0x840
[T15862] \_\_\_sys\_sendmsg+0x1ac/0x1f0
[T15862] \_\_sys\_sendmsg+0x110/0x1d0
[T15862] \_\_arm64\_sys\_sendmsg+0x74/0xb0
[T15862] invoke\_syscall+0x88/0x2e0
[T15862] el0\_svc\_common.constprop.0+0xe4/0x2a0
[T15862] do\_el0\_svc+0x44/0x60
[T15862] el0\_svc+0x50/0x184
[T15862] el0t\_64\_sync\_handler+0x120/0x12c
[T15862] el0t\_64\_sync+0x190/0x194
[T15862]
[T15862] Freed by task 6192:
[T15862] kasan\_save\_stack+0x3c/0x70
[T15862] kasan\_save\_track+0x20/0x3c
[T15862] kasan\_save\_free\_info+0x4c/0x80
[T15862] poison\_slab\_object+0x110/0x160
[T15862] \_\_kasan\_slab\_free+0x3c/0x74
[T15862] kfree+0x134/0x3c0
[T15862] taprio\_free\_sched\_cb+0x18c/0x220
[T15862] rcu\_core+0x920/0x1b7c
[T15862] rcu\_core\_si+0x10/0x1c
[T15862] handle\_softirqs+0x2e8/0xd64
[T15862] \_\_do\_softirq+0x14/0x20
Fixes: 18cdd2f0998a ("net/sched: taprio: taprio\_dump and taprio\_change are protected by rtnl\_mutex")
Acked-by: Vinicius Costa Gomes <vinicius.gomes@intel.com>
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20241018051339.418890-2-dmantipov@yandex.ru](https://patch.msgid.link/20241018051339.418890-2-dmantipov%40yandex.ru)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Lee: Backported from linux-6.6.y to linux-6.1.y and fixed conflicts]
Signed-off-by: Lee Jones <lee@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b911fa9e92ee586e36479ad57b88f20471acaca1)

| -rw-r--r-- | [net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_taprio.c?id=b911fa9e92ee586e36479ad57b88f20471acaca1) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 6 deletions

| diff --git a/net/sched/sch\_taprio.c b/net/sched/sch\_taprio.cindex 212fef2b72f502..1d5cdc987abde4 100644--- a/[net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_taprio.c?id=7f6c3c7f8d4d81eae58c7516d69dc47866726181)+++ b/[net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_taprio.c?id=b911fa9e92ee586e36479ad57b88f20471acaca1)@@ -1995,9 +1995,6 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) struct nlattr \*nest, \*sched\_nest; unsigned int i; - oper = rtnl\_dereference(q->oper\_sched);- admin = rtnl\_dereference(q->admin\_sched);- opt.num\_tc = netdev\_get\_num\_tc(dev); memcpy(opt.prio\_tc\_map, dev->prio\_tc\_map, sizeof(opt.prio\_tc\_map)); @@ -2024,18 +2021,23 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) nla\_put\_u32(skb, TCA\_TAPRIO\_ATTR\_TXTIME\_DELAY, q->txtime\_delay)) goto options\_error; + rcu\_read\_lock();++ oper = rtnl\_dereference(q->oper\_sched);+ admin = rtnl\_dereference(q->admin\_sched);+ if (taprio\_dump\_tc\_entries(q, skb))- goto options\_error;+ goto options\_error\_rcu;  if (oper && dump\_schedule(skb, oper))- goto options\_error;+ goto options\_error\_rcu;  if (!admin) goto done;  sched\_nest = nla\_nest\_start\_noflag(skb, TCA\_TAPRIO\_ATTR\_ADMIN\_SCHED); if (!sched\_nest)- goto options\_error;+ goto options\_error\_rcu;  if (dump\_schedule(skb, admin)) goto admin\_error;@@ -2043,11 +2045,15 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) nla\_nest\_end(skb, sched\_nest);  done:+ rcu\_read\_unlock(); return nla\_nest\_end(skb, nest);  admin\_error: nla\_nest\_cancel(skb, sched\_nest); +options\_error\_rcu:+ rcu\_read\_unlock();+ options\_error: nla\_nest\_cancel(skb, nest); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:22:05 +0000



=== Content from git.kernel.org_8e0cd7c7_20250114_202326.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5d282467245f267c0b9ada3f7f309ff838521536)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d282467245f267c0b9ada3f7f309ff838521536)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d282467245f267c0b9ada3f7f309ff838521536)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d282467245f267c0b9ada3f7f309ff838521536)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-18 08:13:39 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:30 +0100 |
| commit | [5d282467245f267c0b9ada3f7f309ff838521536](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d282467245f267c0b9ada3f7f309ff838521536) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5d282467245f267c0b9ada3f7f309ff838521536)) | |
| tree | [4860bc035ffa52d365b8e7f82a6038b38265d844](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5d282467245f267c0b9ada3f7f309ff838521536) | |
| parent | [0d4c0d2844e4eac3aed647f948fd7e60eea56a61](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d4c0d2844e4eac3aed647f948fd7e60eea56a61) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d282467245f267c0b9ada3f7f309ff838521536&id2=0d4c0d2844e4eac3aed647f948fd7e60eea56a61)) | |
| download | [linux-5d282467245f267c0b9ada3f7f309ff838521536.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5d282467245f267c0b9ada3f7f309ff838521536.tar.gz) | |

net: sched: use RCU read-side critical section in taprio\_dump()[ Upstream commit b22db8b8befe90b61c98626ca1a2fbb0505e9fe3 ]
Fix possible use-after-free in 'taprio\_dump()' by adding RCU
read-side critical section there. Never seen on x86 but
found on a KASAN-enabled arm64 system when investigating
https://syzkaller.appspot.com/bug?extid=b65e0af58423fc8a73aa:
[T15862] BUG: KASAN: slab-use-after-free in taprio\_dump+0xa0c/0xbb0
[T15862] Read of size 4 at addr ffff0000d4bb88f8 by task repro/15862
[T15862]
[T15862] CPU: 0 UID: 0 PID: 15862 Comm: repro Not tainted 6.11.0-rc1-00293-gdefaf1a2113a-dirty #2
[T15862] Hardware name: QEMU QEMU Virtual Machine, BIOS edk2-20240524-5.fc40 05/24/2024
[T15862] Call trace:
[T15862] dump\_backtrace+0x20c/0x220
[T15862] show\_stack+0x2c/0x40
[T15862] dump\_stack\_lvl+0xf8/0x174
[T15862] print\_report+0x170/0x4d8
[T15862] kasan\_report+0xb8/0x1d4
[T15862] \_\_asan\_report\_load4\_noabort+0x20/0x2c
[T15862] taprio\_dump+0xa0c/0xbb0
[T15862] tc\_fill\_qdisc+0x540/0x1020
[T15862] qdisc\_notify.isra.0+0x330/0x3a0
[T15862] tc\_modify\_qdisc+0x7b8/0x1838
[T15862] rtnetlink\_rcv\_msg+0x3c8/0xc20
[T15862] netlink\_rcv\_skb+0x1f8/0x3d4
[T15862] rtnetlink\_rcv+0x28/0x40
[T15862] netlink\_unicast+0x51c/0x790
[T15862] netlink\_sendmsg+0x79c/0xc20
[T15862] \_\_sock\_sendmsg+0xe0/0x1a0
[T15862] \_\_\_\_sys\_sendmsg+0x6c0/0x840
[T15862] \_\_\_sys\_sendmsg+0x1ac/0x1f0
[T15862] \_\_sys\_sendmsg+0x110/0x1d0
[T15862] \_\_arm64\_sys\_sendmsg+0x74/0xb0
[T15862] invoke\_syscall+0x88/0x2e0
[T15862] el0\_svc\_common.constprop.0+0xe4/0x2a0
[T15862] do\_el0\_svc+0x44/0x60
[T15862] el0\_svc+0x50/0x184
[T15862] el0t\_64\_sync\_handler+0x120/0x12c
[T15862] el0t\_64\_sync+0x190/0x194
[T15862]
[T15862] Allocated by task 15857:
[T15862] kasan\_save\_stack+0x3c/0x70
[T15862] kasan\_save\_track+0x20/0x3c
[T15862] kasan\_save\_alloc\_info+0x40/0x60
[T15862] \_\_kasan\_kmalloc+0xd4/0xe0
[T15862] \_\_kmalloc\_cache\_noprof+0x194/0x334
[T15862] taprio\_change+0x45c/0x2fe0
[T15862] tc\_modify\_qdisc+0x6a8/0x1838
[T15862] rtnetlink\_rcv\_msg+0x3c8/0xc20
[T15862] netlink\_rcv\_skb+0x1f8/0x3d4
[T15862] rtnetlink\_rcv+0x28/0x40
[T15862] netlink\_unicast+0x51c/0x790
[T15862] netlink\_sendmsg+0x79c/0xc20
[T15862] \_\_sock\_sendmsg+0xe0/0x1a0
[T15862] \_\_\_\_sys\_sendmsg+0x6c0/0x840
[T15862] \_\_\_sys\_sendmsg+0x1ac/0x1f0
[T15862] \_\_sys\_sendmsg+0x110/0x1d0
[T15862] \_\_arm64\_sys\_sendmsg+0x74/0xb0
[T15862] invoke\_syscall+0x88/0x2e0
[T15862] el0\_svc\_common.constprop.0+0xe4/0x2a0
[T15862] do\_el0\_svc+0x44/0x60
[T15862] el0\_svc+0x50/0x184
[T15862] el0t\_64\_sync\_handler+0x120/0x12c
[T15862] el0t\_64\_sync+0x190/0x194
[T15862]
[T15862] Freed by task 6192:
[T15862] kasan\_save\_stack+0x3c/0x70
[T15862] kasan\_save\_track+0x20/0x3c
[T15862] kasan\_save\_free\_info+0x4c/0x80
[T15862] poison\_slab\_object+0x110/0x160
[T15862] \_\_kasan\_slab\_free+0x3c/0x74
[T15862] kfree+0x134/0x3c0
[T15862] taprio\_free\_sched\_cb+0x18c/0x220
[T15862] rcu\_core+0x920/0x1b7c
[T15862] rcu\_core\_si+0x10/0x1c
[T15862] handle\_softirqs+0x2e8/0xd64
[T15862] \_\_do\_softirq+0x14/0x20
Fixes: 18cdd2f0998a ("net/sched: taprio: taprio\_dump and taprio\_change are protected by rtnl\_mutex")
Acked-by: Vinicius Costa Gomes <vinicius.gomes@intel.com>
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20241018051339.418890-2-dmantipov@yandex.ru](https://patch.msgid.link/20241018051339.418890-2-dmantipov%40yandex.ru)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5d282467245f267c0b9ada3f7f309ff838521536)

| -rw-r--r-- | [net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_taprio.c?id=5d282467245f267c0b9ada3f7f309ff838521536) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 6 deletions

| diff --git a/net/sched/sch\_taprio.c b/net/sched/sch\_taprio.cindex bc8e55c6d63d19..951a87909c2974 100644--- a/[net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_taprio.c?id=0d4c0d2844e4eac3aed647f948fd7e60eea56a61)+++ b/[net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_taprio.c?id=5d282467245f267c0b9ada3f7f309ff838521536)@@ -2397,9 +2397,6 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) struct tc\_mqprio\_qopt opt = { 0 }; struct nlattr \*nest, \*sched\_nest; - oper = rtnl\_dereference(q->oper\_sched);- admin = rtnl\_dereference(q->admin\_sched);- mqprio\_qopt\_reconstruct(dev, &opt);  nest = nla\_nest\_start\_noflag(skb, TCA\_OPTIONS);@@ -2420,18 +2417,23 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) nla\_put\_u32(skb, TCA\_TAPRIO\_ATTR\_TXTIME\_DELAY, q->txtime\_delay)) goto options\_error; + rcu\_read\_lock();++ oper = rtnl\_dereference(q->oper\_sched);+ admin = rtnl\_dereference(q->admin\_sched);+ if (oper && taprio\_dump\_tc\_entries(skb, q, oper))- goto options\_error;+ goto options\_error\_rcu;  if (oper && dump\_schedule(skb, oper))- goto options\_error;+ goto options\_error\_rcu;  if (!admin) goto done;  sched\_nest = nla\_nest\_start\_noflag(skb, TCA\_TAPRIO\_ATTR\_ADMIN\_SCHED); if (!sched\_nest)- goto options\_error;+ goto options\_error\_rcu;  if (dump\_schedule(skb, admin)) goto admin\_error;@@ -2439,11 +2441,15 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) nla\_nest\_end(skb, sched\_nest);  done:+ rcu\_read\_unlock(); return nla\_nest\_end(skb, nest);  admin\_error: nla\_nest\_cancel(skb, sched\_nest); +options\_error\_rcu:+ rcu\_read\_unlock();+ options\_error: nla\_nest\_cancel(skb, nest); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:22:03 +0000



=== Content from git.kernel.org_fbf41b26_20250114_202327.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-10-18 08:13:39 +0300 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-10-23 13:26:15 +0200 |
| commit | [b22db8b8befe90b61c98626ca1a2fbb0505e9fe3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3)) | |
| tree | [7c100af5a7e64ffd22c6fbe4e24bbf2dfe6cc59b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3) | |
| parent | [f504465970aebb2467da548f7c1efbbf36d0f44b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f504465970aebb2467da548f7c1efbbf36d0f44b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3&id2=f504465970aebb2467da548f7c1efbbf36d0f44b)) | |
| download | [linux-b22db8b8befe90b61c98626ca1a2fbb0505e9fe3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b22db8b8befe90b61c98626ca1a2fbb0505e9fe3.tar.gz) | |

net: sched: use RCU read-side critical section in taprio\_dump()Fix possible use-after-free in 'taprio\_dump()' by adding RCU
read-side critical section there. Never seen on x86 but
found on a KASAN-enabled arm64 system when investigating
https://syzkaller.appspot.com/bug?extid=b65e0af58423fc8a73aa:
[T15862] BUG: KASAN: slab-use-after-free in taprio\_dump+0xa0c/0xbb0
[T15862] Read of size 4 at addr ffff0000d4bb88f8 by task repro/15862
[T15862]
[T15862] CPU: 0 UID: 0 PID: 15862 Comm: repro Not tainted 6.11.0-rc1-00293-gdefaf1a2113a-dirty #2
[T15862] Hardware name: QEMU QEMU Virtual Machine, BIOS edk2-20240524-5.fc40 05/24/2024
[T15862] Call trace:
[T15862] dump\_backtrace+0x20c/0x220
[T15862] show\_stack+0x2c/0x40
[T15862] dump\_stack\_lvl+0xf8/0x174
[T15862] print\_report+0x170/0x4d8
[T15862] kasan\_report+0xb8/0x1d4
[T15862] \_\_asan\_report\_load4\_noabort+0x20/0x2c
[T15862] taprio\_dump+0xa0c/0xbb0
[T15862] tc\_fill\_qdisc+0x540/0x1020
[T15862] qdisc\_notify.isra.0+0x330/0x3a0
[T15862] tc\_modify\_qdisc+0x7b8/0x1838
[T15862] rtnetlink\_rcv\_msg+0x3c8/0xc20
[T15862] netlink\_rcv\_skb+0x1f8/0x3d4
[T15862] rtnetlink\_rcv+0x28/0x40
[T15862] netlink\_unicast+0x51c/0x790
[T15862] netlink\_sendmsg+0x79c/0xc20
[T15862] \_\_sock\_sendmsg+0xe0/0x1a0
[T15862] \_\_\_\_sys\_sendmsg+0x6c0/0x840
[T15862] \_\_\_sys\_sendmsg+0x1ac/0x1f0
[T15862] \_\_sys\_sendmsg+0x110/0x1d0
[T15862] \_\_arm64\_sys\_sendmsg+0x74/0xb0
[T15862] invoke\_syscall+0x88/0x2e0
[T15862] el0\_svc\_common.constprop.0+0xe4/0x2a0
[T15862] do\_el0\_svc+0x44/0x60
[T15862] el0\_svc+0x50/0x184
[T15862] el0t\_64\_sync\_handler+0x120/0x12c
[T15862] el0t\_64\_sync+0x190/0x194
[T15862]
[T15862] Allocated by task 15857:
[T15862] kasan\_save\_stack+0x3c/0x70
[T15862] kasan\_save\_track+0x20/0x3c
[T15862] kasan\_save\_alloc\_info+0x40/0x60
[T15862] \_\_kasan\_kmalloc+0xd4/0xe0
[T15862] \_\_kmalloc\_cache\_noprof+0x194/0x334
[T15862] taprio\_change+0x45c/0x2fe0
[T15862] tc\_modify\_qdisc+0x6a8/0x1838
[T15862] rtnetlink\_rcv\_msg+0x3c8/0xc20
[T15862] netlink\_rcv\_skb+0x1f8/0x3d4
[T15862] rtnetlink\_rcv+0x28/0x40
[T15862] netlink\_unicast+0x51c/0x790
[T15862] netlink\_sendmsg+0x79c/0xc20
[T15862] \_\_sock\_sendmsg+0xe0/0x1a0
[T15862] \_\_\_\_sys\_sendmsg+0x6c0/0x840
[T15862] \_\_\_sys\_sendmsg+0x1ac/0x1f0
[T15862] \_\_sys\_sendmsg+0x110/0x1d0
[T15862] \_\_arm64\_sys\_sendmsg+0x74/0xb0
[T15862] invoke\_syscall+0x88/0x2e0
[T15862] el0\_svc\_common.constprop.0+0xe4/0x2a0
[T15862] do\_el0\_svc+0x44/0x60
[T15862] el0\_svc+0x50/0x184
[T15862] el0t\_64\_sync\_handler+0x120/0x12c
[T15862] el0t\_64\_sync+0x190/0x194
[T15862]
[T15862] Freed by task 6192:
[T15862] kasan\_save\_stack+0x3c/0x70
[T15862] kasan\_save\_track+0x20/0x3c
[T15862] kasan\_save\_free\_info+0x4c/0x80
[T15862] poison\_slab\_object+0x110/0x160
[T15862] \_\_kasan\_slab\_free+0x3c/0x74
[T15862] kfree+0x134/0x3c0
[T15862] taprio\_free\_sched\_cb+0x18c/0x220
[T15862] rcu\_core+0x920/0x1b7c
[T15862] rcu\_core\_si+0x10/0x1c
[T15862] handle\_softirqs+0x2e8/0xd64
[T15862] \_\_do\_softirq+0x14/0x20
Fixes: 18cdd2f0998a ("net/sched: taprio: taprio\_dump and taprio\_change are protected by rtnl\_mutex")
Acked-by: Vinicius Costa Gomes <vinicius.gomes@intel.com>
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20241018051339.418890-2-dmantipov@yandex.ru](https://patch.msgid.link/20241018051339.418890-2-dmantipov%40yandex.ru)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3)

| -rw-r--r-- | [net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_taprio.c?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 6 deletions

| diff --git a/net/sched/sch\_taprio.c b/net/sched/sch\_taprio.cindex 9f4e004cdb8be8..8623dc0bafc09b 100644--- a/[net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_taprio.c?id=f504465970aebb2467da548f7c1efbbf36d0f44b)+++ b/[net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_taprio.c?id=b22db8b8befe90b61c98626ca1a2fbb0505e9fe3)@@ -2374,9 +2374,6 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) struct tc\_mqprio\_qopt opt = { 0 }; struct nlattr \*nest, \*sched\_nest; - oper = rtnl\_dereference(q->oper\_sched);- admin = rtnl\_dereference(q->admin\_sched);- mqprio\_qopt\_reconstruct(dev, &opt);  nest = nla\_nest\_start\_noflag(skb, TCA\_OPTIONS);@@ -2397,18 +2394,23 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) nla\_put\_u32(skb, TCA\_TAPRIO\_ATTR\_TXTIME\_DELAY, q->txtime\_delay)) goto options\_error; + rcu\_read\_lock();++ oper = rtnl\_dereference(q->oper\_sched);+ admin = rtnl\_dereference(q->admin\_sched);+ if (oper && taprio\_dump\_tc\_entries(skb, q, oper))- goto options\_error;+ goto options\_error\_rcu;  if (oper && dump\_schedule(skb, oper))- goto options\_error;+ goto options\_error\_rcu;  if (!admin) goto done;  sched\_nest = nla\_nest\_start\_noflag(skb, TCA\_TAPRIO\_ATTR\_ADMIN\_SCHED); if (!sched\_nest)- goto options\_error;+ goto options\_error\_rcu;  if (dump\_schedule(skb, admin)) goto admin\_error;@@ -2416,11 +2418,15 @@ static int taprio\_dump(struct Qdisc \*sch, struct sk\_buff \*skb) nla\_nest\_end(skb, sched\_nest);  done:+ rcu\_read\_unlock(); return nla\_nest\_end(skb, nest);  admin\_error: nla\_nest\_cancel(skb, sched\_nest); +options\_error\_rcu:+ rcu\_read\_unlock();+ options\_error: nla\_nest\_cancel(skb, nest); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:22:04 +0000


