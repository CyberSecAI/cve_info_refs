=== Content from git.kernel.org_f537875c_20250114_221925.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4a74da044ec9ec8679e6beccc4306b936b62873f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a74da044ec9ec8679e6beccc4306b936b62873f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a74da044ec9ec8679e6beccc4306b936b62873f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a74da044ec9ec8679e6beccc4306b936b62873f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-10-08 12:46:39 +0000 |
| --- | --- | --- |
| committer | Jarkko Sakkinen <jarkko@kernel.org> | 2024-11-04 21:24:24 +0200 |
| commit | [4a74da044ec9ec8679e6beccc4306b936b62873f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a74da044ec9ec8679e6beccc4306b936b62873f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4a74da044ec9ec8679e6beccc4306b936b62873f)) | |
| tree | [59b7c91ce48bc18fa94764441f8737c096722d00](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a74da044ec9ec8679e6beccc4306b936b62873f) | |
| parent | [557329bcecc2f55e134db8974953b32b69db9d15](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=557329bcecc2f55e134db8974953b32b69db9d15) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a74da044ec9ec8679e6beccc4306b936b62873f&id2=557329bcecc2f55e134db8974953b32b69db9d15)) | |
| download | [linux-4a74da044ec9ec8679e6beccc4306b936b62873f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4a74da044ec9ec8679e6beccc4306b936b62873f.tar.gz) | |

security/keys: fix slab-out-of-bounds in key\_task\_permissionKASAN reports an out of bounds read:
BUG: KASAN: slab-out-of-bounds in \_\_kuid\_val include/linux/uidgid.h:36
BUG: KASAN: slab-out-of-bounds in uid\_eq include/linux/uidgid.h:63 [inline]
BUG: KASAN: slab-out-of-bounds in key\_task\_permission+0x394/0x410
security/keys/permission.c:54
Read of size 4 at addr ffff88813c3ab618 by task stress-ng/4362
CPU: 2 PID: 4362 Comm: stress-ng Not tainted 5.10.0-14930-gafbffd6c3ede #15
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:82 [inline]
dump\_stack+0x107/0x167 lib/dump\_stack.c:123
print\_address\_description.constprop.0+0x19/0x170 mm/kasan/report.c:400
\_\_kasan\_report.cold+0x6c/0x84 mm/kasan/report.c:560
kasan\_report+0x3a/0x50 mm/kasan/report.c:585
\_\_kuid\_val include/linux/uidgid.h:36 [inline]
uid\_eq include/linux/uidgid.h:63 [inline]
key\_task\_permission+0x394/0x410 security/keys/permission.c:54
search\_nested\_keyrings+0x90e/0xe90 security/keys/keyring.c:793
This issue was also reported by syzbot.
It can be reproduced by following these steps(more details [1]):
1. Obtain more than 32 inputs that have similar hashes, which ends with the
pattern '0xxxxxxxe6'.
2. Reboot and add the keys obtained in step 1.
The reproducer demonstrates how this issue happened:
1. In the search\_nested\_keyrings function, when it iterates through the
slots in a node(below tag ascend\_to\_node), if the slot pointer is meta
and node->back\_pointer != NULL(it means a root), it will proceed to
descend\_to\_node. However, there is an exception. If node is the root,
and one of the slots points to a shortcut, it will be treated as a
keyring.
2. Whether the ptr is keyring decided by keyring\_ptr\_is\_keyring function.
However, KEYRING\_PTR\_SUBTYPE is 0x2UL, the same as
ASSOC\_ARRAY\_PTR\_SUBTYPE\_MASK.
3. When 32 keys with the similar hashes are added to the tree, the ROOT
has keys with hashes that are not similar (e.g. slot 0) and it splits
NODE A without using a shortcut. When NODE A is filled with keys that
all hashes are xxe6, the keys are similar, NODE A will split with a
shortcut. Finally, it forms the tree as shown below, where slot 6 points
to a shortcut.
NODE A
+------>+---+
ROOT | | 0 | xxe6
+---+ | +---+
xxxx | 0 | shortcut : : xxe6
+---+ | +---+
xxe6 : : | | | xxe6
+---+ | +---+
| 6 |---+ : : xxe6
+---+ +---+
xxe6 : : | f | xxe6
+---+ +---+
xxe6 | f |
+---+
4. As mentioned above, If a slot(slot 6) of the root points to a shortcut,
it may be mistakenly transferred to a key\*, leading to a read
out-of-bounds read.
To fix this issue, one should jump to descend\_to\_node if the ptr is a
shortcut, regardless of whether the node is root or not.
[1] https://lore.kernel.org/linux-kernel/1cfa878e-8c7b-4570-8606-21daf5e13ce7@huaweicloud.com/
[jarkko: tweaked the commit message a bit to have an appropriate closes
tag.]
Fixes: b2a4df200d57 ("KEYS: Expand the capacity of a keyring")
Reported-by: syzbot+5b415c07907a2990d1a3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/000000000000cbb7860611f61147@google.com/T/
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a74da044ec9ec8679e6beccc4306b936b62873f)

| -rw-r--r-- | [security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/keys/keyring.c?id=4a74da044ec9ec8679e6beccc4306b936b62873f) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/security/keys/keyring.c b/security/keys/keyring.cindex 4448758f643a57..f331725d5a370d 100644--- a/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=557329bcecc2f55e134db8974953b32b69db9d15)+++ b/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=4a74da044ec9ec8679e6beccc4306b936b62873f)@@ -772,8 +772,11 @@ ascend\_to\_node: for (; slot < ASSOC\_ARRAY\_FAN\_OUT; slot++) { ptr = READ\_ONCE(node->slots[slot]); - if (assoc\_array\_ptr\_is\_meta(ptr) && node->back\_pointer)- goto descend\_to\_node;+ if (assoc\_array\_ptr\_is\_meta(ptr)) {+ if (node->back\_pointer ||+ assoc\_array\_ptr\_is\_shortcut(ptr))+ goto descend\_to\_node;+ }  if (!keyring\_ptr\_is\_keyring(ptr)) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:18:02 +0000



=== Content from git.kernel.org_6e30d9e8_20250114_221924.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-10-08 12:46:39 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:19:30 +0100 |
| commit | [3e79ad156bedf2da0ab909a118d2cec6c9c22b79](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79)) | |
| tree | [40231a39b0622586e880e42da7b6af282c67e1e5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79) | |
| parent | [6173b0bfcea39df4b2b56e020ef72bcde8dd3216](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6173b0bfcea39df4b2b56e020ef72bcde8dd3216) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79&id2=6173b0bfcea39df4b2b56e020ef72bcde8dd3216)) | |
| download | [linux-3e79ad156bedf2da0ab909a118d2cec6c9c22b79.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3e79ad156bedf2da0ab909a118d2cec6c9c22b79.tar.gz) | |

security/keys: fix slab-out-of-bounds in key\_task\_permission[ Upstream commit 4a74da044ec9ec8679e6beccc4306b936b62873f ]
KASAN reports an out of bounds read:
BUG: KASAN: slab-out-of-bounds in \_\_kuid\_val include/linux/uidgid.h:36
BUG: KASAN: slab-out-of-bounds in uid\_eq include/linux/uidgid.h:63 [inline]
BUG: KASAN: slab-out-of-bounds in key\_task\_permission+0x394/0x410
security/keys/permission.c:54
Read of size 4 at addr ffff88813c3ab618 by task stress-ng/4362
CPU: 2 PID: 4362 Comm: stress-ng Not tainted 5.10.0-14930-gafbffd6c3ede #15
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:82 [inline]
dump\_stack+0x107/0x167 lib/dump\_stack.c:123
print\_address\_description.constprop.0+0x19/0x170 mm/kasan/report.c:400
\_\_kasan\_report.cold+0x6c/0x84 mm/kasan/report.c:560
kasan\_report+0x3a/0x50 mm/kasan/report.c:585
\_\_kuid\_val include/linux/uidgid.h:36 [inline]
uid\_eq include/linux/uidgid.h:63 [inline]
key\_task\_permission+0x394/0x410 security/keys/permission.c:54
search\_nested\_keyrings+0x90e/0xe90 security/keys/keyring.c:793
This issue was also reported by syzbot.
It can be reproduced by following these steps(more details [1]):
1. Obtain more than 32 inputs that have similar hashes, which ends with the
pattern '0xxxxxxxe6'.
2. Reboot and add the keys obtained in step 1.
The reproducer demonstrates how this issue happened:
1. In the search\_nested\_keyrings function, when it iterates through the
slots in a node(below tag ascend\_to\_node), if the slot pointer is meta
and node->back\_pointer != NULL(it means a root), it will proceed to
descend\_to\_node. However, there is an exception. If node is the root,
and one of the slots points to a shortcut, it will be treated as a
keyring.
2. Whether the ptr is keyring decided by keyring\_ptr\_is\_keyring function.
However, KEYRING\_PTR\_SUBTYPE is 0x2UL, the same as
ASSOC\_ARRAY\_PTR\_SUBTYPE\_MASK.
3. When 32 keys with the similar hashes are added to the tree, the ROOT
has keys with hashes that are not similar (e.g. slot 0) and it splits
NODE A without using a shortcut. When NODE A is filled with keys that
all hashes are xxe6, the keys are similar, NODE A will split with a
shortcut. Finally, it forms the tree as shown below, where slot 6 points
to a shortcut.
NODE A
+------>+---+
ROOT | | 0 | xxe6
+---+ | +---+
xxxx | 0 | shortcut : : xxe6
+---+ | +---+
xxe6 : : | | | xxe6
+---+ | +---+
| 6 |---+ : : xxe6
+---+ +---+
xxe6 : : | f | xxe6
+---+ +---+
xxe6 | f |
+---+
4. As mentioned above, If a slot(slot 6) of the root points to a shortcut,
it may be mistakenly transferred to a key\*, leading to a read
out-of-bounds read.
To fix this issue, one should jump to descend\_to\_node if the ptr is a
shortcut, regardless of whether the node is root or not.
[1] https://lore.kernel.org/linux-kernel/1cfa878e-8c7b-4570-8606-21daf5e13ce7@huaweicloud.com/
[jarkko: tweaked the commit message a bit to have an appropriate closes
tag.]
Fixes: b2a4df200d57 ("KEYS: Expand the capacity of a keyring")
Reported-by: syzbot+5b415c07907a2990d1a3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/000000000000cbb7860611f61147@google.com/T/
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79)

| -rw-r--r-- | [security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/keys/keyring.c?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/security/keys/keyring.c b/security/keys/keyring.cindex 4448758f643a57..f331725d5a370d 100644--- a/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=6173b0bfcea39df4b2b56e020ef72bcde8dd3216)+++ b/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=3e79ad156bedf2da0ab909a118d2cec6c9c22b79)@@ -772,8 +772,11 @@ ascend\_to\_node: for (; slot < ASSOC\_ARRAY\_FAN\_OUT; slot++) { ptr = READ\_ONCE(node->slots[slot]); - if (assoc\_array\_ptr\_is\_meta(ptr) && node->back\_pointer)- goto descend\_to\_node;+ if (assoc\_array\_ptr\_is\_meta(ptr)) {+ if (node->back\_pointer ||+ assoc\_array\_ptr\_is\_shortcut(ptr))+ goto descend\_to\_node;+ }  if (!keyring\_ptr\_is\_keyring(ptr)) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:18:01 +0000



=== Content from git.kernel.org_987c8f3f_20250114_221927.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-10-08 12:46:39 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:15:11 +0100 |
| commit | [bbad2d5b6c99db468d8f88b6ba6a56ed409b4881](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881)) | |
| tree | [26f043442db9a2b5807c498354ff5eb41f7b0a6f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881) | |
| parent | [99659d23459cb7a887ce0901c37de23117e76a74](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99659d23459cb7a887ce0901c37de23117e76a74) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881&id2=99659d23459cb7a887ce0901c37de23117e76a74)) | |
| download | [linux-bbad2d5b6c99db468d8f88b6ba6a56ed409b4881.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bbad2d5b6c99db468d8f88b6ba6a56ed409b4881.tar.gz) | |

security/keys: fix slab-out-of-bounds in key\_task\_permission[ Upstream commit 4a74da044ec9ec8679e6beccc4306b936b62873f ]
KASAN reports an out of bounds read:
BUG: KASAN: slab-out-of-bounds in \_\_kuid\_val include/linux/uidgid.h:36
BUG: KASAN: slab-out-of-bounds in uid\_eq include/linux/uidgid.h:63 [inline]
BUG: KASAN: slab-out-of-bounds in key\_task\_permission+0x394/0x410
security/keys/permission.c:54
Read of size 4 at addr ffff88813c3ab618 by task stress-ng/4362
CPU: 2 PID: 4362 Comm: stress-ng Not tainted 5.10.0-14930-gafbffd6c3ede #15
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:82 [inline]
dump\_stack+0x107/0x167 lib/dump\_stack.c:123
print\_address\_description.constprop.0+0x19/0x170 mm/kasan/report.c:400
\_\_kasan\_report.cold+0x6c/0x84 mm/kasan/report.c:560
kasan\_report+0x3a/0x50 mm/kasan/report.c:585
\_\_kuid\_val include/linux/uidgid.h:36 [inline]
uid\_eq include/linux/uidgid.h:63 [inline]
key\_task\_permission+0x394/0x410 security/keys/permission.c:54
search\_nested\_keyrings+0x90e/0xe90 security/keys/keyring.c:793
This issue was also reported by syzbot.
It can be reproduced by following these steps(more details [1]):
1. Obtain more than 32 inputs that have similar hashes, which ends with the
pattern '0xxxxxxxe6'.
2. Reboot and add the keys obtained in step 1.
The reproducer demonstrates how this issue happened:
1. In the search\_nested\_keyrings function, when it iterates through the
slots in a node(below tag ascend\_to\_node), if the slot pointer is meta
and node->back\_pointer != NULL(it means a root), it will proceed to
descend\_to\_node. However, there is an exception. If node is the root,
and one of the slots points to a shortcut, it will be treated as a
keyring.
2. Whether the ptr is keyring decided by keyring\_ptr\_is\_keyring function.
However, KEYRING\_PTR\_SUBTYPE is 0x2UL, the same as
ASSOC\_ARRAY\_PTR\_SUBTYPE\_MASK.
3. When 32 keys with the similar hashes are added to the tree, the ROOT
has keys with hashes that are not similar (e.g. slot 0) and it splits
NODE A without using a shortcut. When NODE A is filled with keys that
all hashes are xxe6, the keys are similar, NODE A will split with a
shortcut. Finally, it forms the tree as shown below, where slot 6 points
to a shortcut.
NODE A
+------>+---+
ROOT | | 0 | xxe6
+---+ | +---+
xxxx | 0 | shortcut : : xxe6
+---+ | +---+
xxe6 : : | | | xxe6
+---+ | +---+
| 6 |---+ : : xxe6
+---+ +---+
xxe6 : : | f | xxe6
+---+ +---+
xxe6 | f |
+---+
4. As mentioned above, If a slot(slot 6) of the root points to a shortcut,
it may be mistakenly transferred to a key\*, leading to a read
out-of-bounds read.
To fix this issue, one should jump to descend\_to\_node if the ptr is a
shortcut, regardless of whether the node is root or not.
[1] https://lore.kernel.org/linux-kernel/1cfa878e-8c7b-4570-8606-21daf5e13ce7@huaweicloud.com/
[jarkko: tweaked the commit message a bit to have an appropriate closes
tag.]
Fixes: b2a4df200d57 ("KEYS: Expand the capacity of a keyring")
Reported-by: syzbot+5b415c07907a2990d1a3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/000000000000cbb7860611f61147@google.com/T/
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881)

| -rw-r--r-- | [security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/keys/keyring.c?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/security/keys/keyring.c b/security/keys/keyring.cindex 4448758f643a57..f331725d5a370d 100644--- a/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=99659d23459cb7a887ce0901c37de23117e76a74)+++ b/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=bbad2d5b6c99db468d8f88b6ba6a56ed409b4881)@@ -772,8 +772,11 @@ ascend\_to\_node: for (; slot < ASSOC\_ARRAY\_FAN\_OUT; slot++) { ptr = READ\_ONCE(node->slots[slot]); - if (assoc\_array\_ptr\_is\_meta(ptr) && node->back\_pointer)- goto descend\_to\_node;+ if (assoc\_array\_ptr\_is\_meta(ptr)) {+ if (node->back\_pointer ||+ assoc\_array\_ptr\_is\_shortcut(ptr))+ goto descend\_to\_node;+ }  if (!keyring\_ptr\_is\_keyring(ptr)) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:18:04 +0000



=== Content from git.kernel.org_83ff9cd4_20250114_221923.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-10-08 12:46:39 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:13:36 +0100 |
| commit | [199c20fb7499c79557a075dc24e9a7dae7d9f1ce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce)) | |
| tree | [6c3a815cefbd13aad1ea1310aaf6ffd48878f9e7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce) | |
| parent | [4a8cab88ce77bd843107d0cb6780ee916c457ee5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a8cab88ce77bd843107d0cb6780ee916c457ee5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce&id2=4a8cab88ce77bd843107d0cb6780ee916c457ee5)) | |
| download | [linux-199c20fb7499c79557a075dc24e9a7dae7d9f1ce.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-199c20fb7499c79557a075dc24e9a7dae7d9f1ce.tar.gz) | |

security/keys: fix slab-out-of-bounds in key\_task\_permission[ Upstream commit 4a74da044ec9ec8679e6beccc4306b936b62873f ]
KASAN reports an out of bounds read:
BUG: KASAN: slab-out-of-bounds in \_\_kuid\_val include/linux/uidgid.h:36
BUG: KASAN: slab-out-of-bounds in uid\_eq include/linux/uidgid.h:63 [inline]
BUG: KASAN: slab-out-of-bounds in key\_task\_permission+0x394/0x410
security/keys/permission.c:54
Read of size 4 at addr ffff88813c3ab618 by task stress-ng/4362
CPU: 2 PID: 4362 Comm: stress-ng Not tainted 5.10.0-14930-gafbffd6c3ede #15
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:82 [inline]
dump\_stack+0x107/0x167 lib/dump\_stack.c:123
print\_address\_description.constprop.0+0x19/0x170 mm/kasan/report.c:400
\_\_kasan\_report.cold+0x6c/0x84 mm/kasan/report.c:560
kasan\_report+0x3a/0x50 mm/kasan/report.c:585
\_\_kuid\_val include/linux/uidgid.h:36 [inline]
uid\_eq include/linux/uidgid.h:63 [inline]
key\_task\_permission+0x394/0x410 security/keys/permission.c:54
search\_nested\_keyrings+0x90e/0xe90 security/keys/keyring.c:793
This issue was also reported by syzbot.
It can be reproduced by following these steps(more details [1]):
1. Obtain more than 32 inputs that have similar hashes, which ends with the
pattern '0xxxxxxxe6'.
2. Reboot and add the keys obtained in step 1.
The reproducer demonstrates how this issue happened:
1. In the search\_nested\_keyrings function, when it iterates through the
slots in a node(below tag ascend\_to\_node), if the slot pointer is meta
and node->back\_pointer != NULL(it means a root), it will proceed to
descend\_to\_node. However, there is an exception. If node is the root,
and one of the slots points to a shortcut, it will be treated as a
keyring.
2. Whether the ptr is keyring decided by keyring\_ptr\_is\_keyring function.
However, KEYRING\_PTR\_SUBTYPE is 0x2UL, the same as
ASSOC\_ARRAY\_PTR\_SUBTYPE\_MASK.
3. When 32 keys with the similar hashes are added to the tree, the ROOT
has keys with hashes that are not similar (e.g. slot 0) and it splits
NODE A without using a shortcut. When NODE A is filled with keys that
all hashes are xxe6, the keys are similar, NODE A will split with a
shortcut. Finally, it forms the tree as shown below, where slot 6 points
to a shortcut.
NODE A
+------>+---+
ROOT | | 0 | xxe6
+---+ | +---+
xxxx | 0 | shortcut : : xxe6
+---+ | +---+
xxe6 : : | | | xxe6
+---+ | +---+
| 6 |---+ : : xxe6
+---+ +---+
xxe6 : : | f | xxe6
+---+ +---+
xxe6 | f |
+---+
4. As mentioned above, If a slot(slot 6) of the root points to a shortcut,
it may be mistakenly transferred to a key\*, leading to a read
out-of-bounds read.
To fix this issue, one should jump to descend\_to\_node if the ptr is a
shortcut, regardless of whether the node is root or not.
[1] https://lore.kernel.org/linux-kernel/1cfa878e-8c7b-4570-8606-21daf5e13ce7@huaweicloud.com/
[jarkko: tweaked the commit message a bit to have an appropriate closes
tag.]
Fixes: b2a4df200d57 ("KEYS: Expand the capacity of a keyring")
Reported-by: syzbot+5b415c07907a2990d1a3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/000000000000cbb7860611f61147@google.com/T/
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce)

| -rw-r--r-- | [security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/keys/keyring.c?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/security/keys/keyring.c b/security/keys/keyring.cindex 5e6a907607530e..1febc2a8abcf66 100644--- a/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=4a8cab88ce77bd843107d0cb6780ee916c457ee5)+++ b/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=199c20fb7499c79557a075dc24e9a7dae7d9f1ce)@@ -772,8 +772,11 @@ ascend\_to\_node: for (; slot < ASSOC\_ARRAY\_FAN\_OUT; slot++) { ptr = READ\_ONCE(node->slots[slot]); - if (assoc\_array\_ptr\_is\_meta(ptr) && node->back\_pointer)- goto descend\_to\_node;+ if (assoc\_array\_ptr\_is\_meta(ptr)) {+ if (node->back\_pointer ||+ assoc\_array\_ptr\_is\_shortcut(ptr))+ goto descend\_to\_node;+ }  if (!keyring\_ptr\_is\_keyring(ptr)) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:18:00 +0000



=== Content from git.kernel.org_f0d08f72_20250114_221926.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-10-08 12:46:39 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:50 +0100 |
| commit | [4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d)) | |
| tree | [29cc139343962a9c943beb3788ff85516a6c002e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d) | |
| parent | [3f9e88f2672c4635960570ee9741778d4135ecf5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f9e88f2672c4635960570ee9741778d4135ecf5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d&id2=3f9e88f2672c4635960570ee9741778d4135ecf5)) | |
| download | [linux-4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d.tar.gz) | |

security/keys: fix slab-out-of-bounds in key\_task\_permission[ Upstream commit 4a74da044ec9ec8679e6beccc4306b936b62873f ]
KASAN reports an out of bounds read:
BUG: KASAN: slab-out-of-bounds in \_\_kuid\_val include/linux/uidgid.h:36
BUG: KASAN: slab-out-of-bounds in uid\_eq include/linux/uidgid.h:63 [inline]
BUG: KASAN: slab-out-of-bounds in key\_task\_permission+0x394/0x410
security/keys/permission.c:54
Read of size 4 at addr ffff88813c3ab618 by task stress-ng/4362
CPU: 2 PID: 4362 Comm: stress-ng Not tainted 5.10.0-14930-gafbffd6c3ede #15
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:82 [inline]
dump\_stack+0x107/0x167 lib/dump\_stack.c:123
print\_address\_description.constprop.0+0x19/0x170 mm/kasan/report.c:400
\_\_kasan\_report.cold+0x6c/0x84 mm/kasan/report.c:560
kasan\_report+0x3a/0x50 mm/kasan/report.c:585
\_\_kuid\_val include/linux/uidgid.h:36 [inline]
uid\_eq include/linux/uidgid.h:63 [inline]
key\_task\_permission+0x394/0x410 security/keys/permission.c:54
search\_nested\_keyrings+0x90e/0xe90 security/keys/keyring.c:793
This issue was also reported by syzbot.
It can be reproduced by following these steps(more details [1]):
1. Obtain more than 32 inputs that have similar hashes, which ends with the
pattern '0xxxxxxxe6'.
2. Reboot and add the keys obtained in step 1.
The reproducer demonstrates how this issue happened:
1. In the search\_nested\_keyrings function, when it iterates through the
slots in a node(below tag ascend\_to\_node), if the slot pointer is meta
and node->back\_pointer != NULL(it means a root), it will proceed to
descend\_to\_node. However, there is an exception. If node is the root,
and one of the slots points to a shortcut, it will be treated as a
keyring.
2. Whether the ptr is keyring decided by keyring\_ptr\_is\_keyring function.
However, KEYRING\_PTR\_SUBTYPE is 0x2UL, the same as
ASSOC\_ARRAY\_PTR\_SUBTYPE\_MASK.
3. When 32 keys with the similar hashes are added to the tree, the ROOT
has keys with hashes that are not similar (e.g. slot 0) and it splits
NODE A without using a shortcut. When NODE A is filled with keys that
all hashes are xxe6, the keys are similar, NODE A will split with a
shortcut. Finally, it forms the tree as shown below, where slot 6 points
to a shortcut.
NODE A
+------>+---+
ROOT | | 0 | xxe6
+---+ | +---+
xxxx | 0 | shortcut : : xxe6
+---+ | +---+
xxe6 : : | | | xxe6
+---+ | +---+
| 6 |---+ : : xxe6
+---+ +---+
xxe6 : : | f | xxe6
+---+ +---+
xxe6 | f |
+---+
4. As mentioned above, If a slot(slot 6) of the root points to a shortcut,
it may be mistakenly transferred to a key\*, leading to a read
out-of-bounds read.
To fix this issue, one should jump to descend\_to\_node if the ptr is a
shortcut, regardless of whether the node is root or not.
[1] https://lore.kernel.org/linux-kernel/1cfa878e-8c7b-4570-8606-21daf5e13ce7@huaweicloud.com/
[jarkko: tweaked the commit message a bit to have an appropriate closes
tag.]
Fixes: b2a4df200d57 ("KEYS: Expand the capacity of a keyring")
Reported-by: syzbot+5b415c07907a2990d1a3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/000000000000cbb7860611f61147@google.com/T/
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d)

| -rw-r--r-- | [security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/keys/keyring.c?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/security/keys/keyring.c b/security/keys/keyring.cindex 5ca620d31cd308..5ec89db5a7c1b3 100644--- a/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=3f9e88f2672c4635960570ee9741778d4135ecf5)+++ b/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=4efb69a0e294ef201bcdf7ce3d6202cd0a545a5d)@@ -772,8 +772,11 @@ ascend\_to\_node: for (; slot < ASSOC\_ARRAY\_FAN\_OUT; slot++) { ptr = READ\_ONCE(node->slots[slot]); - if (assoc\_array\_ptr\_is\_meta(ptr) && node->back\_pointer)- goto descend\_to\_node;+ if (assoc\_array\_ptr\_is\_meta(ptr)) {+ if (node->back\_pointer ||+ assoc\_array\_ptr\_is\_shortcut(ptr))+ goto descend\_to\_node;+ }  if (!keyring\_ptr\_is\_keyring(ptr)) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:18:02 +0000



=== Content from git.kernel.org_9dbc43ea_20250114_221924.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-10-08 12:46:39 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:59:35 +0100 |
| commit | [1e4332581cd4eed75aea77af6f66cdcdda8b49b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9)) | |
| tree | [352067faf4b0c3f4b9282e9edd92d85379331ab9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9) | |
| parent | [d7dc68d82ab3fcfc3f65322465da3d7031d4ab46](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d7dc68d82ab3fcfc3f65322465da3d7031d4ab46) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9&id2=d7dc68d82ab3fcfc3f65322465da3d7031d4ab46)) | |
| download | [linux-1e4332581cd4eed75aea77af6f66cdcdda8b49b9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1e4332581cd4eed75aea77af6f66cdcdda8b49b9.tar.gz) | |

security/keys: fix slab-out-of-bounds in key\_task\_permission[ Upstream commit 4a74da044ec9ec8679e6beccc4306b936b62873f ]
KASAN reports an out of bounds read:
BUG: KASAN: slab-out-of-bounds in \_\_kuid\_val include/linux/uidgid.h:36
BUG: KASAN: slab-out-of-bounds in uid\_eq include/linux/uidgid.h:63 [inline]
BUG: KASAN: slab-out-of-bounds in key\_task\_permission+0x394/0x410
security/keys/permission.c:54
Read of size 4 at addr ffff88813c3ab618 by task stress-ng/4362
CPU: 2 PID: 4362 Comm: stress-ng Not tainted 5.10.0-14930-gafbffd6c3ede #15
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:82 [inline]
dump\_stack+0x107/0x167 lib/dump\_stack.c:123
print\_address\_description.constprop.0+0x19/0x170 mm/kasan/report.c:400
\_\_kasan\_report.cold+0x6c/0x84 mm/kasan/report.c:560
kasan\_report+0x3a/0x50 mm/kasan/report.c:585
\_\_kuid\_val include/linux/uidgid.h:36 [inline]
uid\_eq include/linux/uidgid.h:63 [inline]
key\_task\_permission+0x394/0x410 security/keys/permission.c:54
search\_nested\_keyrings+0x90e/0xe90 security/keys/keyring.c:793
This issue was also reported by syzbot.
It can be reproduced by following these steps(more details [1]):
1. Obtain more than 32 inputs that have similar hashes, which ends with the
pattern '0xxxxxxxe6'.
2. Reboot and add the keys obtained in step 1.
The reproducer demonstrates how this issue happened:
1. In the search\_nested\_keyrings function, when it iterates through the
slots in a node(below tag ascend\_to\_node), if the slot pointer is meta
and node->back\_pointer != NULL(it means a root), it will proceed to
descend\_to\_node. However, there is an exception. If node is the root,
and one of the slots points to a shortcut, it will be treated as a
keyring.
2. Whether the ptr is keyring decided by keyring\_ptr\_is\_keyring function.
However, KEYRING\_PTR\_SUBTYPE is 0x2UL, the same as
ASSOC\_ARRAY\_PTR\_SUBTYPE\_MASK.
3. When 32 keys with the similar hashes are added to the tree, the ROOT
has keys with hashes that are not similar (e.g. slot 0) and it splits
NODE A without using a shortcut. When NODE A is filled with keys that
all hashes are xxe6, the keys are similar, NODE A will split with a
shortcut. Finally, it forms the tree as shown below, where slot 6 points
to a shortcut.
NODE A
+------>+---+
ROOT | | 0 | xxe6
+---+ | +---+
xxxx | 0 | shortcut : : xxe6
+---+ | +---+
xxe6 : : | | | xxe6
+---+ | +---+
| 6 |---+ : : xxe6
+---+ +---+
xxe6 : : | f | xxe6
+---+ +---+
xxe6 | f |
+---+
4. As mentioned above, If a slot(slot 6) of the root points to a shortcut,
it may be mistakenly transferred to a key\*, leading to a read
out-of-bounds read.
To fix this issue, one should jump to descend\_to\_node if the ptr is a
shortcut, regardless of whether the node is root or not.
[1] https://lore.kernel.org/linux-kernel/1cfa878e-8c7b-4570-8606-21daf5e13ce7@huaweicloud.com/
[jarkko: tweaked the commit message a bit to have an appropriate closes
tag.]
Fixes: b2a4df200d57 ("KEYS: Expand the capacity of a keyring")
Reported-by: syzbot+5b415c07907a2990d1a3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/000000000000cbb7860611f61147@google.com/T/
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9)

| -rw-r--r-- | [security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/keys/keyring.c?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/security/keys/keyring.c b/security/keys/keyring.cindex 14abfe765b7e78..9f0fc81a3a7b95 100644--- a/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=d7dc68d82ab3fcfc3f65322465da3d7031d4ab46)+++ b/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=1e4332581cd4eed75aea77af6f66cdcdda8b49b9)@@ -772,8 +772,11 @@ ascend\_to\_node: for (; slot < ASSOC\_ARRAY\_FAN\_OUT; slot++) { ptr = READ\_ONCE(node->slots[slot]); - if (assoc\_array\_ptr\_is\_meta(ptr) && node->back\_pointer)- goto descend\_to\_node;+ if (assoc\_array\_ptr\_is\_meta(ptr)) {+ if (node->back\_pointer ||+ assoc\_array\_ptr\_is\_shortcut(ptr))+ goto descend\_to\_node;+ }  if (!keyring\_ptr\_is\_keyring(ptr)) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:18:01 +0000



=== Content from git.kernel.org_10f8d343_20250114_221928.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-10-08 12:46:39 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:05 +0100 |
| commit | [c3ce634ad953ce48c75c39bdfd8b711dd95f346f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f)) | |
| tree | [a884ffc80c621accec253e8fe78eb6c3dbd9b781](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f) | |
| parent | [e7ea60184e1e88a3c9e437b3265cbb6439aa7e26](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7ea60184e1e88a3c9e437b3265cbb6439aa7e26) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f&id2=e7ea60184e1e88a3c9e437b3265cbb6439aa7e26)) | |
| download | [linux-c3ce634ad953ce48c75c39bdfd8b711dd95f346f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c3ce634ad953ce48c75c39bdfd8b711dd95f346f.tar.gz) | |

security/keys: fix slab-out-of-bounds in key\_task\_permission[ Upstream commit 4a74da044ec9ec8679e6beccc4306b936b62873f ]
KASAN reports an out of bounds read:
BUG: KASAN: slab-out-of-bounds in \_\_kuid\_val include/linux/uidgid.h:36
BUG: KASAN: slab-out-of-bounds in uid\_eq include/linux/uidgid.h:63 [inline]
BUG: KASAN: slab-out-of-bounds in key\_task\_permission+0x394/0x410
security/keys/permission.c:54
Read of size 4 at addr ffff88813c3ab618 by task stress-ng/4362
CPU: 2 PID: 4362 Comm: stress-ng Not tainted 5.10.0-14930-gafbffd6c3ede #15
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:82 [inline]
dump\_stack+0x107/0x167 lib/dump\_stack.c:123
print\_address\_description.constprop.0+0x19/0x170 mm/kasan/report.c:400
\_\_kasan\_report.cold+0x6c/0x84 mm/kasan/report.c:560
kasan\_report+0x3a/0x50 mm/kasan/report.c:585
\_\_kuid\_val include/linux/uidgid.h:36 [inline]
uid\_eq include/linux/uidgid.h:63 [inline]
key\_task\_permission+0x394/0x410 security/keys/permission.c:54
search\_nested\_keyrings+0x90e/0xe90 security/keys/keyring.c:793
This issue was also reported by syzbot.
It can be reproduced by following these steps(more details [1]):
1. Obtain more than 32 inputs that have similar hashes, which ends with the
pattern '0xxxxxxxe6'.
2. Reboot and add the keys obtained in step 1.
The reproducer demonstrates how this issue happened:
1. In the search\_nested\_keyrings function, when it iterates through the
slots in a node(below tag ascend\_to\_node), if the slot pointer is meta
and node->back\_pointer != NULL(it means a root), it will proceed to
descend\_to\_node. However, there is an exception. If node is the root,
and one of the slots points to a shortcut, it will be treated as a
keyring.
2. Whether the ptr is keyring decided by keyring\_ptr\_is\_keyring function.
However, KEYRING\_PTR\_SUBTYPE is 0x2UL, the same as
ASSOC\_ARRAY\_PTR\_SUBTYPE\_MASK.
3. When 32 keys with the similar hashes are added to the tree, the ROOT
has keys with hashes that are not similar (e.g. slot 0) and it splits
NODE A without using a shortcut. When NODE A is filled with keys that
all hashes are xxe6, the keys are similar, NODE A will split with a
shortcut. Finally, it forms the tree as shown below, where slot 6 points
to a shortcut.
NODE A
+------>+---+
ROOT | | 0 | xxe6
+---+ | +---+
xxxx | 0 | shortcut : : xxe6
+---+ | +---+
xxe6 : : | | | xxe6
+---+ | +---+
| 6 |---+ : : xxe6
+---+ +---+
xxe6 : : | f | xxe6
+---+ +---+
xxe6 | f |
+---+
4. As mentioned above, If a slot(slot 6) of the root points to a shortcut,
it may be mistakenly transferred to a key\*, leading to a read
out-of-bounds read.
To fix this issue, one should jump to descend\_to\_node if the ptr is a
shortcut, regardless of whether the node is root or not.
[1] https://lore.kernel.org/linux-kernel/1cfa878e-8c7b-4570-8606-21daf5e13ce7@huaweicloud.com/
[jarkko: tweaked the commit message a bit to have an appropriate closes
tag.]
Fixes: b2a4df200d57 ("KEYS: Expand the capacity of a keyring")
Reported-by: syzbot+5b415c07907a2990d1a3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/000000000000cbb7860611f61147@google.com/T/
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f)

| -rw-r--r-- | [security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/keys/keyring.c?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/security/keys/keyring.c b/security/keys/keyring.cindex e8f2366021ea3e..0f414a114729ab 100644--- a/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=e7ea60184e1e88a3c9e437b3265cbb6439aa7e26)+++ b/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=c3ce634ad953ce48c75c39bdfd8b711dd95f346f)@@ -739,8 +739,11 @@ ascend\_to\_node: for (; slot < ASSOC\_ARRAY\_FAN\_OUT; slot++) { ptr = READ\_ONCE(node->slots[slot]); - if (assoc\_array\_ptr\_is\_meta(ptr) && node->back\_pointer)- goto descend\_to\_node;+ if (assoc\_array\_ptr\_is\_meta(ptr)) {+ if (node->back\_pointer ||+ assoc\_array\_ptr\_is\_shortcut(ptr))+ goto descend\_to\_node;+ }  if (!keyring\_ptr\_is\_keyring(ptr)) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:18:05 +0000



=== Content from git.kernel.org_4322cee1_20250114_221930.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-10-08 12:46:39 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:20:58 +0100 |
| commit | [e0a317ad68e4ea48a0158187238c5407e4fdec8b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b)) | |
| tree | [864924c5d8d0f9c478e37cbf0b3f6a5900cacdb7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b) | |
| parent | [08d75968bfc7d2e49643ba37f0f57dabd693e455](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08d75968bfc7d2e49643ba37f0f57dabd693e455) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b&id2=08d75968bfc7d2e49643ba37f0f57dabd693e455)) | |
| download | [linux-e0a317ad68e4ea48a0158187238c5407e4fdec8b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e0a317ad68e4ea48a0158187238c5407e4fdec8b.tar.gz) | |

security/keys: fix slab-out-of-bounds in key\_task\_permission[ Upstream commit 4a74da044ec9ec8679e6beccc4306b936b62873f ]
KASAN reports an out of bounds read:
BUG: KASAN: slab-out-of-bounds in \_\_kuid\_val include/linux/uidgid.h:36
BUG: KASAN: slab-out-of-bounds in uid\_eq include/linux/uidgid.h:63 [inline]
BUG: KASAN: slab-out-of-bounds in key\_task\_permission+0x394/0x410
security/keys/permission.c:54
Read of size 4 at addr ffff88813c3ab618 by task stress-ng/4362
CPU: 2 PID: 4362 Comm: stress-ng Not tainted 5.10.0-14930-gafbffd6c3ede #15
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:82 [inline]
dump\_stack+0x107/0x167 lib/dump\_stack.c:123
print\_address\_description.constprop.0+0x19/0x170 mm/kasan/report.c:400
\_\_kasan\_report.cold+0x6c/0x84 mm/kasan/report.c:560
kasan\_report+0x3a/0x50 mm/kasan/report.c:585
\_\_kuid\_val include/linux/uidgid.h:36 [inline]
uid\_eq include/linux/uidgid.h:63 [inline]
key\_task\_permission+0x394/0x410 security/keys/permission.c:54
search\_nested\_keyrings+0x90e/0xe90 security/keys/keyring.c:793
This issue was also reported by syzbot.
It can be reproduced by following these steps(more details [1]):
1. Obtain more than 32 inputs that have similar hashes, which ends with the
pattern '0xxxxxxxe6'.
2. Reboot and add the keys obtained in step 1.
The reproducer demonstrates how this issue happened:
1. In the search\_nested\_keyrings function, when it iterates through the
slots in a node(below tag ascend\_to\_node), if the slot pointer is meta
and node->back\_pointer != NULL(it means a root), it will proceed to
descend\_to\_node. However, there is an exception. If node is the root,
and one of the slots points to a shortcut, it will be treated as a
keyring.
2. Whether the ptr is keyring decided by keyring\_ptr\_is\_keyring function.
However, KEYRING\_PTR\_SUBTYPE is 0x2UL, the same as
ASSOC\_ARRAY\_PTR\_SUBTYPE\_MASK.
3. When 32 keys with the similar hashes are added to the tree, the ROOT
has keys with hashes that are not similar (e.g. slot 0) and it splits
NODE A without using a shortcut. When NODE A is filled with keys that
all hashes are xxe6, the keys are similar, NODE A will split with a
shortcut. Finally, it forms the tree as shown below, where slot 6 points
to a shortcut.
NODE A
+------>+---+
ROOT | | 0 | xxe6
+---+ | +---+
xxxx | 0 | shortcut : : xxe6
+---+ | +---+
xxe6 : : | | | xxe6
+---+ | +---+
| 6 |---+ : : xxe6
+---+ +---+
xxe6 : : | f | xxe6
+---+ +---+
xxe6 | f |
+---+
4. As mentioned above, If a slot(slot 6) of the root points to a shortcut,
it may be mistakenly transferred to a key\*, leading to a read
out-of-bounds read.
To fix this issue, one should jump to descend\_to\_node if the ptr is a
shortcut, regardless of whether the node is root or not.
[1] https://lore.kernel.org/linux-kernel/1cfa878e-8c7b-4570-8606-21daf5e13ce7@huaweicloud.com/
[jarkko: tweaked the commit message a bit to have an appropriate closes
tag.]
Fixes: b2a4df200d57 ("KEYS: Expand the capacity of a keyring")
Reported-by: syzbot+5b415c07907a2990d1a3@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/000000000000cbb7860611f61147@google.com/T/
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b)

| -rw-r--r-- | [security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/keys/keyring.c?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/security/keys/keyring.c b/security/keys/keyring.cindex 4448758f643a57..f331725d5a370d 100644--- a/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=08d75968bfc7d2e49643ba37f0f57dabd693e455)+++ b/[security/keys/keyring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/keyring.c?id=e0a317ad68e4ea48a0158187238c5407e4fdec8b)@@ -772,8 +772,11 @@ ascend\_to\_node: for (; slot < ASSOC\_ARRAY\_FAN\_OUT; slot++) { ptr = READ\_ONCE(node->slots[slot]); - if (assoc\_array\_ptr\_is\_meta(ptr) && node->back\_pointer)- goto descend\_to\_node;+ if (assoc\_array\_ptr\_is\_meta(ptr)) {+ if (node->back\_pointer ||+ assoc\_array\_ptr\_is\_shortcut(ptr))+ goto descend\_to\_node;+ }  if (!keyring\_ptr\_is\_keyring(ptr)) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:18:06 +0000


