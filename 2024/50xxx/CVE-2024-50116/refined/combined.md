=== Content from git.kernel.org_aa627f6c_20250115_092709.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-16 06:32:07 +0900 |
| --- | --- | --- |
| committer | Christian Brauner <brauner@kernel.org> | 2024-10-16 15:05:32 +0200 |
| commit | [6ed469df0bfbef3e4b44fca954a781919db9f7ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab)) | |
| tree | [283a2688635cf13abc510f97f44c118a8154484c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab) | |
| parent | [f92f0a1b05698340836229d791b3ffecc71b265a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f92f0a1b05698340836229d791b3ffecc71b265a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab&id2=f92f0a1b05698340836229d791b3ffecc71b265a)) | |
| download | [linux-6ed469df0bfbef3e4b44fca954a781919db9f7ab.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6ed469df0bfbef3e4b44fca954a781919db9f7ab.tar.gz) | |

nilfs2: fix kernel bug due to missing clearing of buffer delay flagSyzbot reported that after nilfs2 reads a corrupted file system image
and degrades to read-only, the BUG\_ON check for the buffer delay flag
in submit\_bh\_wbc() may fail, causing a kernel bug.
This is because the buffer delay flag is not cleared when clearing the
buffer state flags to discard a page/folio or a buffer head. So, fix
this.
This became necessary when the use of nilfs2's own page clear routine
was expanded. This state inconsistency does not occur if the buffer
is written normally by log writing.
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Link: [https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke@gmail.com](https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke%40gmail.com)
Fixes: 8c26c4e2694a ("nilfs2: fix issue with flush kernel thread after remount in RO mode because of driver's internal error or metadata corruption")
Reported-by: syzbot+985ada84bf055a575c07@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=985ada84bf055a575c07
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab)

| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 9c0b7cddeaaeed..5436eb0424bd15 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=f92f0a1b05698340836229d791b3ffecc71b265a)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=6ed469df0bfbef3e4b44fca954a781919db9f7ab)@@ -77,7 +77,8 @@ void nilfs\_forget\_buffer(struct buffer\_head \*bh) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  lock\_buffer(bh); set\_mask\_bits(&bh->b\_state, clear\_bits, 0);@@ -406,7 +407,8 @@ void nilfs\_clear\_folio\_dirty(struct folio \*folio) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  bh = head; do { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:25:46 +0000



=== Content from git.kernel.org_4e2bc855_20250115_092714.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-16 06:32:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:40 +0100 |
| commit | [c6f58ff2d4c552927fe9a187774e668ebba6c7aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa)) | |
| tree | [28adda8a5eff962e5b1fabc3c390d9cfcc87ffef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa) | |
| parent | [978301009be1d34fc30180dd66aa29dd2573b2a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=978301009be1d34fc30180dd66aa29dd2573b2a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa&id2=978301009be1d34fc30180dd66aa29dd2573b2a6)) | |
| download | [linux-c6f58ff2d4c552927fe9a187774e668ebba6c7aa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c6f58ff2d4c552927fe9a187774e668ebba6c7aa.tar.gz) | |

nilfs2: fix kernel bug due to missing clearing of buffer delay flagcommit 6ed469df0bfbef3e4b44fca954a781919db9f7ab upstream.
Syzbot reported that after nilfs2 reads a corrupted file system image
and degrades to read-only, the BUG\_ON check for the buffer delay flag
in submit\_bh\_wbc() may fail, causing a kernel bug.
This is because the buffer delay flag is not cleared when clearing the
buffer state flags to discard a page/folio or a buffer head. So, fix
this.
This became necessary when the use of nilfs2's own page clear routine
was expanded. This state inconsistency does not occur if the buffer
is written normally by log writing.
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Link: [https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke@gmail.com](https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke%40gmail.com)
Fixes: 8c26c4e2694a ("nilfs2: fix issue with flush kernel thread after remount in RO mode because of driver's internal error or metadata corruption")
Reported-by: syzbot+985ada84bf055a575c07@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=985ada84bf055a575c07
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa)

| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 14e470fb88706a..7f9073d5c5a567 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=978301009be1d34fc30180dd66aa29dd2573b2a6)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=c6f58ff2d4c552927fe9a187774e668ebba6c7aa)@@ -77,7 +77,8 @@ void nilfs\_forget\_buffer(struct buffer\_head \*bh) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  lock\_buffer(bh); set\_mask\_bits(&bh->b\_state, clear\_bits, 0);@@ -414,7 +415,8 @@ void nilfs\_clear\_folio\_dirty(struct folio \*folio, bool silent) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  bh = head; do { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:25:51 +0000



=== Content from git.kernel.org_3f71d189_20250115_092712.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-16 06:32:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:22:00 +0100 |
| commit | [9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1)) | |
| tree | [cebde8a163b1e38734a3bbbad74cbafcfa7542a5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1) | |
| parent | [1f440403be1fa951118b84142b22d53c6a666cc5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f440403be1fa951118b84142b22d53c6a666cc5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1&id2=1f440403be1fa951118b84142b22d53c6a666cc5)) | |
| download | [linux-9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1.tar.gz) | |

nilfs2: fix kernel bug due to missing clearing of buffer delay flagcommit 6ed469df0bfbef3e4b44fca954a781919db9f7ab upstream.
Syzbot reported that after nilfs2 reads a corrupted file system image
and degrades to read-only, the BUG\_ON check for the buffer delay flag
in submit\_bh\_wbc() may fail, causing a kernel bug.
This is because the buffer delay flag is not cleared when clearing the
buffer state flags to discard a page/folio or a buffer head. So, fix
this.
This became necessary when the use of nilfs2's own page clear routine
was expanded. This state inconsistency does not occur if the buffer
is written normally by log writing.
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Link: [https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke@gmail.com](https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke%40gmail.com)
Fixes: 8c26c4e2694a ("nilfs2: fix issue with flush kernel thread after remount in RO mode because of driver's internal error or metadata corruption")
Reported-by: syzbot+985ada84bf055a575c07@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=985ada84bf055a575c07
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1)

| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 81992b9a219b21..98be72e93b401b 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=1f440403be1fa951118b84142b22d53c6a666cc5)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=9f2ab98371c2f2488bf3bf3f9b2a73510545e9c1)@@ -77,7 +77,8 @@ void nilfs\_forget\_buffer(struct buffer\_head \*bh) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  lock\_buffer(bh); set\_mask\_bits(&bh->b\_state, clear\_bits, 0);@@ -409,7 +410,8 @@ void nilfs\_clear\_dirty\_page(struct page \*page, bool silent) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  bh = head = page\_buffers(page); do { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:25:49 +0000



=== Content from git.kernel.org_f7c1620a_20250115_092711.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=822203f6355f4b322d21e7115419f6b98284be25)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=822203f6355f4b322d21e7115419f6b98284be25)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=822203f6355f4b322d21e7115419f6b98284be25)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=822203f6355f4b322d21e7115419f6b98284be25)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-16 06:32:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:52:37 +0100 |
| commit | [822203f6355f4b322d21e7115419f6b98284be25](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=822203f6355f4b322d21e7115419f6b98284be25) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=822203f6355f4b322d21e7115419f6b98284be25)) | |
| tree | [ef0e56b66c0e4d84954c8d3b3bed6a079050185a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=822203f6355f4b322d21e7115419f6b98284be25) | |
| parent | [681c99175bb8763bce346a4d743adbe63e114ea1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=681c99175bb8763bce346a4d743adbe63e114ea1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=822203f6355f4b322d21e7115419f6b98284be25&id2=681c99175bb8763bce346a4d743adbe63e114ea1)) | |
| download | [linux-822203f6355f4b322d21e7115419f6b98284be25.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-822203f6355f4b322d21e7115419f6b98284be25.tar.gz) | |

nilfs2: fix kernel bug due to missing clearing of buffer delay flagcommit 6ed469df0bfbef3e4b44fca954a781919db9f7ab upstream.
Syzbot reported that after nilfs2 reads a corrupted file system image
and degrades to read-only, the BUG\_ON check for the buffer delay flag
in submit\_bh\_wbc() may fail, causing a kernel bug.
This is because the buffer delay flag is not cleared when clearing the
buffer state flags to discard a page/folio or a buffer head. So, fix
this.
This became necessary when the use of nilfs2's own page clear routine
was expanded. This state inconsistency does not occur if the buffer
is written normally by log writing.
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Link: [https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke@gmail.com](https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke%40gmail.com)
Fixes: 8c26c4e2694a ("nilfs2: fix issue with flush kernel thread after remount in RO mode because of driver's internal error or metadata corruption")
Reported-by: syzbot+985ada84bf055a575c07@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=985ada84bf055a575c07
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=822203f6355f4b322d21e7115419f6b98284be25)

| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=822203f6355f4b322d21e7115419f6b98284be25) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 81992b9a219b21..98be72e93b401b 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=681c99175bb8763bce346a4d743adbe63e114ea1)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=822203f6355f4b322d21e7115419f6b98284be25)@@ -77,7 +77,8 @@ void nilfs\_forget\_buffer(struct buffer\_head \*bh) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  lock\_buffer(bh); set\_mask\_bits(&bh->b\_state, clear\_bits, 0);@@ -409,7 +410,8 @@ void nilfs\_clear\_dirty\_page(struct page \*page, bool silent) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  bh = head = page\_buffers(page); do { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:25:48 +0000



=== Content from git.kernel.org_7cd399d4_20250115_092707.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=27524f65621f490184f2ace44cd8e5f3685af4a3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27524f65621f490184f2ace44cd8e5f3685af4a3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27524f65621f490184f2ace44cd8e5f3685af4a3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27524f65621f490184f2ace44cd8e5f3685af4a3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-16 06:32:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:56:06 +0100 |
| commit | [27524f65621f490184f2ace44cd8e5f3685af4a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27524f65621f490184f2ace44cd8e5f3685af4a3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=27524f65621f490184f2ace44cd8e5f3685af4a3)) | |
| tree | [efd5d1da153dd506d298cd23505345d4ac87adad](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27524f65621f490184f2ace44cd8e5f3685af4a3) | |
| parent | [71edf620e3354d2c6b5cdd8aad9814059952155a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=71edf620e3354d2c6b5cdd8aad9814059952155a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27524f65621f490184f2ace44cd8e5f3685af4a3&id2=71edf620e3354d2c6b5cdd8aad9814059952155a)) | |
| download | [linux-27524f65621f490184f2ace44cd8e5f3685af4a3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-27524f65621f490184f2ace44cd8e5f3685af4a3.tar.gz) | |

nilfs2: fix kernel bug due to missing clearing of buffer delay flagcommit 6ed469df0bfbef3e4b44fca954a781919db9f7ab upstream.
Syzbot reported that after nilfs2 reads a corrupted file system image
and degrades to read-only, the BUG\_ON check for the buffer delay flag
in submit\_bh\_wbc() may fail, causing a kernel bug.
This is because the buffer delay flag is not cleared when clearing the
buffer state flags to discard a page/folio or a buffer head. So, fix
this.
This became necessary when the use of nilfs2's own page clear routine
was expanded. This state inconsistency does not occur if the buffer
is written normally by log writing.
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Link: [https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke@gmail.com](https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke%40gmail.com)
Fixes: 8c26c4e2694a ("nilfs2: fix issue with flush kernel thread after remount in RO mode because of driver's internal error or metadata corruption")
Reported-by: syzbot+985ada84bf055a575c07@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=985ada84bf055a575c07
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27524f65621f490184f2ace44cd8e5f3685af4a3)

| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=27524f65621f490184f2ace44cd8e5f3685af4a3) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 7d31833e68d1fb..19bc8eea2b3599 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=71edf620e3354d2c6b5cdd8aad9814059952155a)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=27524f65621f490184f2ace44cd8e5f3685af4a3)@@ -77,7 +77,8 @@ void nilfs\_forget\_buffer(struct buffer\_head \*bh) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  lock\_buffer(bh); set\_mask\_bits(&bh->b\_state, clear\_bits, 0);@@ -409,7 +410,8 @@ void nilfs\_clear\_dirty\_page(struct page \*page, bool silent) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  bh = head = page\_buffers(page); do { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:25:44 +0000



=== Content from git.kernel.org_6baf7fa8_20250115_092708.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=412a30b1b28d6073ba29c46a2b0f324c5936293f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=412a30b1b28d6073ba29c46a2b0f324c5936293f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=412a30b1b28d6073ba29c46a2b0f324c5936293f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=412a30b1b28d6073ba29c46a2b0f324c5936293f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-16 06:32:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:51 +0100 |
| commit | [412a30b1b28d6073ba29c46a2b0f324c5936293f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=412a30b1b28d6073ba29c46a2b0f324c5936293f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=412a30b1b28d6073ba29c46a2b0f324c5936293f)) | |
| tree | [77780721b75afc374f22e5f0eb4c15eb72cccbbc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=412a30b1b28d6073ba29c46a2b0f324c5936293f) | |
| parent | [507f393403ccf312683defb43704dc84326678b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=507f393403ccf312683defb43704dc84326678b1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=412a30b1b28d6073ba29c46a2b0f324c5936293f&id2=507f393403ccf312683defb43704dc84326678b1)) | |
| download | [linux-412a30b1b28d6073ba29c46a2b0f324c5936293f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-412a30b1b28d6073ba29c46a2b0f324c5936293f.tar.gz) | |

nilfs2: fix kernel bug due to missing clearing of buffer delay flagcommit 6ed469df0bfbef3e4b44fca954a781919db9f7ab upstream.
Syzbot reported that after nilfs2 reads a corrupted file system image
and degrades to read-only, the BUG\_ON check for the buffer delay flag
in submit\_bh\_wbc() may fail, causing a kernel bug.
This is because the buffer delay flag is not cleared when clearing the
buffer state flags to discard a page/folio or a buffer head. So, fix
this.
This became necessary when the use of nilfs2's own page clear routine
was expanded. This state inconsistency does not occur if the buffer
is written normally by log writing.
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Link: [https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke@gmail.com](https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke%40gmail.com)
Fixes: 8c26c4e2694a ("nilfs2: fix issue with flush kernel thread after remount in RO mode because of driver's internal error or metadata corruption")
Reported-by: syzbot+985ada84bf055a575c07@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=985ada84bf055a575c07
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=412a30b1b28d6073ba29c46a2b0f324c5936293f)

| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=412a30b1b28d6073ba29c46a2b0f324c5936293f) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex fc86cc7a26d724..bb693931f9823e 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=507f393403ccf312683defb43704dc84326678b1)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=412a30b1b28d6073ba29c46a2b0f324c5936293f)@@ -78,7 +78,8 @@ void nilfs\_forget\_buffer(struct buffer\_head \*bh) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  lock\_buffer(bh); set\_mask\_bits(&bh->b\_state, clear\_bits, 0);@@ -410,7 +411,8 @@ void nilfs\_clear\_dirty\_page(struct page \*page, bool silent) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  bh = head = page\_buffers(page); do { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:25:45 +0000



=== Content from git.kernel.org_733c98b3_20250115_092710.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=743c78d455e784097011ea958b27396001181567)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=743c78d455e784097011ea958b27396001181567)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=743c78d455e784097011ea958b27396001181567)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=743c78d455e784097011ea958b27396001181567)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-16 06:32:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:32 +0100 |
| commit | [743c78d455e784097011ea958b27396001181567](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=743c78d455e784097011ea958b27396001181567) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=743c78d455e784097011ea958b27396001181567)) | |
| tree | [8271b1b41115f1bc106a9ce96543a07363294070](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=743c78d455e784097011ea958b27396001181567) | |
| parent | [a299d415dd3788f7d82e4910dafd65426077e504](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a299d415dd3788f7d82e4910dafd65426077e504) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=743c78d455e784097011ea958b27396001181567&id2=a299d415dd3788f7d82e4910dafd65426077e504)) | |
| download | [linux-743c78d455e784097011ea958b27396001181567.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-743c78d455e784097011ea958b27396001181567.tar.gz) | |

nilfs2: fix kernel bug due to missing clearing of buffer delay flagcommit 6ed469df0bfbef3e4b44fca954a781919db9f7ab upstream.
Syzbot reported that after nilfs2 reads a corrupted file system image
and degrades to read-only, the BUG\_ON check for the buffer delay flag
in submit\_bh\_wbc() may fail, causing a kernel bug.
This is because the buffer delay flag is not cleared when clearing the
buffer state flags to discard a page/folio or a buffer head. So, fix
this.
This became necessary when the use of nilfs2's own page clear routine
was expanded. This state inconsistency does not occur if the buffer
is written normally by log writing.
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Link: [https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke@gmail.com](https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke%40gmail.com)
Fixes: 8c26c4e2694a ("nilfs2: fix issue with flush kernel thread after remount in RO mode because of driver's internal error or metadata corruption")
Reported-by: syzbot+985ada84bf055a575c07@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=985ada84bf055a575c07
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=743c78d455e784097011ea958b27396001181567)

| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=743c78d455e784097011ea958b27396001181567) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex b4e54d079b7d03..36d29c183bb7fa 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=a299d415dd3788f7d82e4910dafd65426077e504)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=743c78d455e784097011ea958b27396001181567)@@ -77,7 +77,8 @@ void nilfs\_forget\_buffer(struct buffer\_head \*bh) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  lock\_buffer(bh); set\_mask\_bits(&bh->b\_state, clear\_bits, 0);@@ -410,7 +411,8 @@ void nilfs\_clear\_dirty\_page(struct page \*page, bool silent) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  bh = head = page\_buffers(page); do { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:25:47 +0000



=== Content from git.kernel.org_287f36ae_20250115_092705.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-16 06:32:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:22 +0100 |
| commit | [033bc52f35868c2493a2d95c56ece7fc155d7cb3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3)) | |
| tree | [d7c41573bb2909cf303e38203b65922467d70c3f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3) | |
| parent | [437885ab7c980a5ef0badcb4d7a5f36a20fd4bf5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=437885ab7c980a5ef0badcb4d7a5f36a20fd4bf5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3&id2=437885ab7c980a5ef0badcb4d7a5f36a20fd4bf5)) | |
| download | [linux-033bc52f35868c2493a2d95c56ece7fc155d7cb3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-033bc52f35868c2493a2d95c56ece7fc155d7cb3.tar.gz) | |

nilfs2: fix kernel bug due to missing clearing of buffer delay flagcommit 6ed469df0bfbef3e4b44fca954a781919db9f7ab upstream.
Syzbot reported that after nilfs2 reads a corrupted file system image
and degrades to read-only, the BUG\_ON check for the buffer delay flag
in submit\_bh\_wbc() may fail, causing a kernel bug.
This is because the buffer delay flag is not cleared when clearing the
buffer state flags to discard a page/folio or a buffer head. So, fix
this.
This became necessary when the use of nilfs2's own page clear routine
was expanded. This state inconsistency does not occur if the buffer
is written normally by log writing.
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Link: [https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke@gmail.com](https://lore.kernel.org/r/20241015213300.7114-1-konishi.ryusuke%40gmail.com)
Fixes: 8c26c4e2694a ("nilfs2: fix issue with flush kernel thread after remount in RO mode because of driver's internal error or metadata corruption")
Reported-by: syzbot+985ada84bf055a575c07@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=985ada84bf055a575c07
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3)

| -rw-r--r-- | [fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/page.c?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/fs/nilfs2/page.c b/fs/nilfs2/page.cindex 762dd277099eb7..4233358bd979d0 100644--- a/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=437885ab7c980a5ef0badcb4d7a5f36a20fd4bf5)+++ b/[fs/nilfs2/page.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/page.c?id=033bc52f35868c2493a2d95c56ece7fc155d7cb3)@@ -78,7 +78,8 @@ void nilfs\_forget\_buffer(struct buffer\_head \*bh) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  lock\_buffer(bh); set\_mask\_bits(&bh->b\_state, clear\_bits, 0);@@ -412,7 +413,8 @@ void nilfs\_clear\_dirty\_page(struct page \*page, bool silent) const unsigned long clear\_bits = (BIT(BH\_Uptodate) | BIT(BH\_Dirty) | BIT(BH\_Mapped) | BIT(BH\_Async\_Write) | BIT(BH\_NILFS\_Volatile) |- BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected));+ BIT(BH\_NILFS\_Checked) | BIT(BH\_NILFS\_Redirected) |+ BIT(BH\_Delay));  bh = head = page\_buffers(page); do { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:25:42 +0000


