=== Content from git.kernel.org_bde00049_20250114_191928.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Cosmin Ratiu <cratiu@nvidia.com> | 2024-10-15 12:32:07 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:24 +0100 |
| commit | [9f2ccb6f3888bec45c00121ee43e4e72423b12c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1)) | |
| tree | [9552474d7190090201c110093dae654d45be7d20](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1) | |
| parent | [d88564c79d1cedaf2655f12261eca0d2796bde4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d88564c79d1cedaf2655f12261eca0d2796bde4e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1&id2=d88564c79d1cedaf2655f12261eca0d2796bde4e)) | |
| download | [linux-9f2ccb6f3888bec45c00121ee43e4e72423b12c1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f2ccb6f3888bec45c00121ee43e4e72423b12c1.tar.gz) | |

net/mlx5: Unregister notifier on eswitch init failure[ Upstream commit 1da9cfd6c41c2e6bbe624d0568644e1521c33e12 ]
It otherwise remains registered and a subsequent attempt at eswitch
enabling might trigger warnings of the sort:
[ 682.589148] ------------[ cut here ]------------
[ 682.590204] notifier callback eswitch\_vport\_event [mlx5\_core] already registered
[ 682.590256] WARNING: CPU: 13 PID: 2660 at kernel/notifier.c:31 notifier\_chain\_register+0x3e/0x90
[...snipped]
[ 682.610052] Call Trace:
[ 682.610369] <TASK>
[ 682.610663] ? \_\_warn+0x7c/0x110
[ 682.611050] ? notifier\_chain\_register+0x3e/0x90
[ 682.611556] ? report\_bug+0x148/0x170
[ 682.611977] ? handle\_bug+0x36/0x70
[ 682.612384] ? exc\_invalid\_op+0x13/0x60
[ 682.612817] ? asm\_exc\_invalid\_op+0x16/0x20
[ 682.613284] ? notifier\_chain\_register+0x3e/0x90
[ 682.613789] atomic\_notifier\_chain\_register+0x25/0x40
[ 682.614322] mlx5\_eswitch\_enable\_locked+0x1d4/0x3b0 [mlx5\_core]
[ 682.614965] mlx5\_eswitch\_enable+0xc9/0x100 [mlx5\_core]
[ 682.615551] mlx5\_device\_enable\_sriov+0x25/0x340 [mlx5\_core]
[ 682.616170] mlx5\_core\_sriov\_configure+0x50/0x170 [mlx5\_core]
[ 682.616789] sriov\_numvfs\_store+0xb0/0x1b0
[ 682.617248] kernfs\_fop\_write\_iter+0x117/0x1a0
[ 682.617734] vfs\_write+0x231/0x3f0
[ 682.618138] ksys\_write+0x63/0xe0
[ 682.618536] do\_syscall\_64+0x4c/0x100
[ 682.618958] entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Fixes: 7624e58a8b3a ("net/mlx5: E-switch, register event handler before arming the event")
Signed-off-by: Cosmin Ratiu <cratiu@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.cindex 1789800faaeb62..f6022c135ec023 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=d88564c79d1cedaf2655f12261eca0d2796bde4e)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=9f2ccb6f3888bec45c00121ee43e4e72423b12c1)@@ -1489,7 +1489,7 @@ int mlx5\_eswitch\_enable\_locked(struct mlx5\_eswitch \*esw, int num\_vfs) }  if (err)- goto abort;+ goto err\_esw\_enable;  esw->fdb\_table.flags |= MLX5\_ESW\_FDB\_CREATED; @@ -1503,7 +1503,8 @@ int mlx5\_eswitch\_enable\_locked(struct mlx5\_eswitch \*esw, int num\_vfs)  return 0; -abort:+err\_esw\_enable:+ mlx5\_eq\_notifier\_unregister(esw->dev, &esw->nb); mlx5\_esw\_acls\_ns\_cleanup(esw); return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:18:05 +0000



=== Content from git.kernel.org_112bd9c0_20250114_191927.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=599147722c5778c96292e2fbff4103abbdb45b1f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=599147722c5778c96292e2fbff4103abbdb45b1f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=599147722c5778c96292e2fbff4103abbdb45b1f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=599147722c5778c96292e2fbff4103abbdb45b1f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Cosmin Ratiu <cratiu@nvidia.com> | 2024-10-15 12:32:07 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:31 +0100 |
| commit | [599147722c5778c96292e2fbff4103abbdb45b1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=599147722c5778c96292e2fbff4103abbdb45b1f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=599147722c5778c96292e2fbff4103abbdb45b1f)) | |
| tree | [16ccbd2725ec5ecbdb544f043468cc84e0e7d3a3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=599147722c5778c96292e2fbff4103abbdb45b1f) | |
| parent | [2feac1e562be0efc621a6722644a90f355d53473](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2feac1e562be0efc621a6722644a90f355d53473) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=599147722c5778c96292e2fbff4103abbdb45b1f&id2=2feac1e562be0efc621a6722644a90f355d53473)) | |
| download | [linux-599147722c5778c96292e2fbff4103abbdb45b1f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-599147722c5778c96292e2fbff4103abbdb45b1f.tar.gz) | |

net/mlx5: Unregister notifier on eswitch init failure[ Upstream commit 1da9cfd6c41c2e6bbe624d0568644e1521c33e12 ]
It otherwise remains registered and a subsequent attempt at eswitch
enabling might trigger warnings of the sort:
[ 682.589148] ------------[ cut here ]------------
[ 682.590204] notifier callback eswitch\_vport\_event [mlx5\_core] already registered
[ 682.590256] WARNING: CPU: 13 PID: 2660 at kernel/notifier.c:31 notifier\_chain\_register+0x3e/0x90
[...snipped]
[ 682.610052] Call Trace:
[ 682.610369] <TASK>
[ 682.610663] ? \_\_warn+0x7c/0x110
[ 682.611050] ? notifier\_chain\_register+0x3e/0x90
[ 682.611556] ? report\_bug+0x148/0x170
[ 682.611977] ? handle\_bug+0x36/0x70
[ 682.612384] ? exc\_invalid\_op+0x13/0x60
[ 682.612817] ? asm\_exc\_invalid\_op+0x16/0x20
[ 682.613284] ? notifier\_chain\_register+0x3e/0x90
[ 682.613789] atomic\_notifier\_chain\_register+0x25/0x40
[ 682.614322] mlx5\_eswitch\_enable\_locked+0x1d4/0x3b0 [mlx5\_core]
[ 682.614965] mlx5\_eswitch\_enable+0xc9/0x100 [mlx5\_core]
[ 682.615551] mlx5\_device\_enable\_sriov+0x25/0x340 [mlx5\_core]
[ 682.616170] mlx5\_core\_sriov\_configure+0x50/0x170 [mlx5\_core]
[ 682.616789] sriov\_numvfs\_store+0xb0/0x1b0
[ 682.617248] kernfs\_fop\_write\_iter+0x117/0x1a0
[ 682.617734] vfs\_write+0x231/0x3f0
[ 682.618138] ksys\_write+0x63/0xe0
[ 682.618536] do\_syscall\_64+0x4c/0x100
[ 682.618958] entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Fixes: 7624e58a8b3a ("net/mlx5: E-switch, register event handler before arming the event")
Signed-off-by: Cosmin Ratiu <cratiu@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=599147722c5778c96292e2fbff4103abbdb45b1f)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=599147722c5778c96292e2fbff4103abbdb45b1f) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.cindex 17f78091ad30ef..7aef30dbd82d6c 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=2feac1e562be0efc621a6722644a90f355d53473)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=599147722c5778c96292e2fbff4103abbdb45b1f)@@ -1489,7 +1489,7 @@ int mlx5\_eswitch\_enable\_locked(struct mlx5\_eswitch \*esw, int num\_vfs) }  if (err)- goto abort;+ goto err\_esw\_enable;  esw->fdb\_table.flags |= MLX5\_ESW\_FDB\_CREATED; @@ -1503,7 +1503,8 @@ int mlx5\_eswitch\_enable\_locked(struct mlx5\_eswitch \*esw, int num\_vfs)  return 0; -abort:+err\_esw\_enable:+ mlx5\_eq\_notifier\_unregister(esw->dev, &esw->nb); mlx5\_esw\_acls\_ns\_cleanup(esw); return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:18:04 +0000



=== Content from git.kernel.org_9666639f_20250114_191927.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Cosmin Ratiu <cratiu@nvidia.com> | 2024-10-15 12:32:07 +0300 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-10-17 12:14:07 +0200 |
| commit | [1da9cfd6c41c2e6bbe624d0568644e1521c33e12](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12)) | |
| tree | [0af14a1de3d4b8fd57dc1c52e09fa2297433611a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12) | |
| parent | [d62b14045c6511a7b2d4948d1a83a4e592deeb05](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12&id2=d62b14045c6511a7b2d4948d1a83a4e592deeb05)) | |
| download | [linux-1da9cfd6c41c2e6bbe624d0568644e1521c33e12.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1da9cfd6c41c2e6bbe624d0568644e1521c33e12.tar.gz) | |

net/mlx5: Unregister notifier on eswitch init failureIt otherwise remains registered and a subsequent attempt at eswitch
enabling might trigger warnings of the sort:
[ 682.589148] ------------[ cut here ]------------
[ 682.590204] notifier callback eswitch\_vport\_event [mlx5\_core] already registered
[ 682.590256] WARNING: CPU: 13 PID: 2660 at kernel/notifier.c:31 notifier\_chain\_register+0x3e/0x90
[...snipped]
[ 682.610052] Call Trace:
[ 682.610369] <TASK>
[ 682.610663] ? \_\_warn+0x7c/0x110
[ 682.611050] ? notifier\_chain\_register+0x3e/0x90
[ 682.611556] ? report\_bug+0x148/0x170
[ 682.611977] ? handle\_bug+0x36/0x70
[ 682.612384] ? exc\_invalid\_op+0x13/0x60
[ 682.612817] ? asm\_exc\_invalid\_op+0x16/0x20
[ 682.613284] ? notifier\_chain\_register+0x3e/0x90
[ 682.613789] atomic\_notifier\_chain\_register+0x25/0x40
[ 682.614322] mlx5\_eswitch\_enable\_locked+0x1d4/0x3b0 [mlx5\_core]
[ 682.614965] mlx5\_eswitch\_enable+0xc9/0x100 [mlx5\_core]
[ 682.615551] mlx5\_device\_enable\_sriov+0x25/0x340 [mlx5\_core]
[ 682.616170] mlx5\_core\_sriov\_configure+0x50/0x170 [mlx5\_core]
[ 682.616789] sriov\_numvfs\_store+0xb0/0x1b0
[ 682.617248] kernfs\_fop\_write\_iter+0x117/0x1a0
[ 682.617734] vfs\_write+0x231/0x3f0
[ 682.618138] ksys\_write+0x63/0xe0
[ 682.618536] do\_syscall\_64+0x4c/0x100
[ 682.618958] entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Fixes: 7624e58a8b3a ("net/mlx5: E-switch, register event handler before arming the event")
Signed-off-by: Cosmin Ratiu <cratiu@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.cindex 17f78091ad30ef..7aef30dbd82d6c 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=d62b14045c6511a7b2d4948d1a83a4e592deeb05)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=1da9cfd6c41c2e6bbe624d0568644e1521c33e12)@@ -1489,7 +1489,7 @@ int mlx5\_eswitch\_enable\_locked(struct mlx5\_eswitch \*esw, int num\_vfs) }  if (err)- goto abort;+ goto err\_esw\_enable;  esw->fdb\_table.flags |= MLX5\_ESW\_FDB\_CREATED; @@ -1503,7 +1503,8 @@ int mlx5\_eswitch\_enable\_locked(struct mlx5\_eswitch \*esw, int num\_vfs)  return 0; -abort:+err\_esw\_enable:+ mlx5\_eq\_notifier\_unregister(esw->dev, &esw->nb); mlx5\_esw\_acls\_ns\_cleanup(esw); return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:18:03 +0000



=== Content from git.kernel.org_7fd31e34_20250114_191928.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e58fb7ddbab6635191c26dea1af26b91cce00866)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e58fb7ddbab6635191c26dea1af26b91cce00866)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e58fb7ddbab6635191c26dea1af26b91cce00866)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e58fb7ddbab6635191c26dea1af26b91cce00866)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Cosmin Ratiu <cratiu@nvidia.com> | 2024-10-15 12:32:07 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:56:01 +0100 |
| commit | [e58fb7ddbab6635191c26dea1af26b91cce00866](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e58fb7ddbab6635191c26dea1af26b91cce00866) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e58fb7ddbab6635191c26dea1af26b91cce00866)) | |
| tree | [fca3387e4774e302d72ab0beb6511177573cd1eb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e58fb7ddbab6635191c26dea1af26b91cce00866) | |
| parent | [d1606090bb294cecb7de3c4ed177f5aa0abd4c4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e58fb7ddbab6635191c26dea1af26b91cce00866&id2=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e)) | |
| download | [linux-e58fb7ddbab6635191c26dea1af26b91cce00866.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e58fb7ddbab6635191c26dea1af26b91cce00866.tar.gz) | |

net/mlx5: Unregister notifier on eswitch init failure[ Upstream commit 1da9cfd6c41c2e6bbe624d0568644e1521c33e12 ]
It otherwise remains registered and a subsequent attempt at eswitch
enabling might trigger warnings of the sort:
[ 682.589148] ------------[ cut here ]------------
[ 682.590204] notifier callback eswitch\_vport\_event [mlx5\_core] already registered
[ 682.590256] WARNING: CPU: 13 PID: 2660 at kernel/notifier.c:31 notifier\_chain\_register+0x3e/0x90
[...snipped]
[ 682.610052] Call Trace:
[ 682.610369] <TASK>
[ 682.610663] ? \_\_warn+0x7c/0x110
[ 682.611050] ? notifier\_chain\_register+0x3e/0x90
[ 682.611556] ? report\_bug+0x148/0x170
[ 682.611977] ? handle\_bug+0x36/0x70
[ 682.612384] ? exc\_invalid\_op+0x13/0x60
[ 682.612817] ? asm\_exc\_invalid\_op+0x16/0x20
[ 682.613284] ? notifier\_chain\_register+0x3e/0x90
[ 682.613789] atomic\_notifier\_chain\_register+0x25/0x40
[ 682.614322] mlx5\_eswitch\_enable\_locked+0x1d4/0x3b0 [mlx5\_core]
[ 682.614965] mlx5\_eswitch\_enable+0xc9/0x100 [mlx5\_core]
[ 682.615551] mlx5\_device\_enable\_sriov+0x25/0x340 [mlx5\_core]
[ 682.616170] mlx5\_core\_sriov\_configure+0x50/0x170 [mlx5\_core]
[ 682.616789] sriov\_numvfs\_store+0xb0/0x1b0
[ 682.617248] kernfs\_fop\_write\_iter+0x117/0x1a0
[ 682.617734] vfs\_write+0x231/0x3f0
[ 682.618138] ksys\_write+0x63/0xe0
[ 682.618536] do\_syscall\_64+0x4c/0x100
[ 682.618958] entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
Fixes: 7624e58a8b3a ("net/mlx5: E-switch, register event handler before arming the event")
Signed-off-by: Cosmin Ratiu <cratiu@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e58fb7ddbab6635191c26dea1af26b91cce00866)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=e58fb7ddbab6635191c26dea1af26b91cce00866) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.cindex 48939c72b59251..9ba825df9be0e3 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=d1606090bb294cecb7de3c4ed177f5aa0abd4c4e)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/eswitch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c?id=e58fb7ddbab6635191c26dea1af26b91cce00866)@@ -1279,7 +1279,7 @@ int mlx5\_eswitch\_enable\_locked(struct mlx5\_eswitch \*esw, int num\_vfs) }  if (err)- goto abort;+ goto err\_esw\_enable;  esw->fdb\_table.flags |= MLX5\_ESW\_FDB\_CREATED; @@ -1293,7 +1293,8 @@ int mlx5\_eswitch\_enable\_locked(struct mlx5\_eswitch \*esw, int num\_vfs)  return 0; -abort:+err\_esw\_enable:+ mlx5\_eq\_notifier\_unregister(esw->dev, &esw->nb); mlx5\_esw\_acls\_ns\_cleanup(esw); return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:18:05 +0000


