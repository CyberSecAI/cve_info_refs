=== Content from git.kernel.org_7cc5b613_20250114_232200.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c1d0476885d708a932980b0f28cd90d9bd71db39)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c1d0476885d708a932980b0f28cd90d9bd71db39)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1d0476885d708a932980b0f28cd90d9bd71db39)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1d0476885d708a932980b0f28cd90d9bd71db39)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-04 12:35:31 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:39:30 +0200 |
| commit | [c1d0476885d708a932980b0f28cd90d9bd71db39](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1d0476885d708a932980b0f28cd90d9bd71db39) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c1d0476885d708a932980b0f28cd90d9bd71db39)) | |
| tree | [67878efd20407ccdbe5927c849c2d9ddbf250f28](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c1d0476885d708a932980b0f28cd90d9bd71db39) | |
| parent | [c38add9ac0e4d4f418e6443a688491499021add9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c38add9ac0e4d4f418e6443a688491499021add9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1d0476885d708a932980b0f28cd90d9bd71db39&id2=c38add9ac0e4d4f418e6443a688491499021add9)) | |
| download | [linux-c1d0476885d708a932980b0f28cd90d9bd71db39.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c1d0476885d708a932980b0f28cd90d9bd71db39.tar.gz) | |

nilfs2: propagate directory read errors from nilfs\_find\_entry()commit 08cfa12adf888db98879dbd735bc741360a34168 upstream.
Syzbot reported that a task hang occurs in vcs\_open() during a fuzzing
test for nilfs2.
The root cause of this problem is that in nilfs\_find\_entry(), which
searches for directory entries, ignores errors when loading a directory
page/folio via nilfs\_get\_folio() fails.
If the filesystem images is corrupted, and the i\_size of the directory
inode is large, and the directory page/folio is successfully read but
fails the sanity check, for example when it is zero-filled,
nilfs\_check\_folio() may continue to spit out error messages in bursts.
Fix this issue by propagating the error to the callers when loading a
page/folio fails in nilfs\_find\_entry().
The current interface of nilfs\_find\_entry() and its callers is outdated
and cannot propagate error codes such as -EIO and -ENOMEM returned via
nilfs\_find\_entry(), so fix it together.
Link: [https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke%40gmail.com)
Fixes: 2ba466d74ed7 ("nilfs2: directory entry operations")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: Lizhi Xu <lizhi.xu@windriver.com>
Closes: https://lkml.kernel.org/r/20240927013806.3577931-1-lizhi.xu@windriver.com
Reported-by: syzbot+8a192e8d090fa9a31135@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=8a192e8d090fa9a31135
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1d0476885d708a932980b0f28cd90d9bd71db39)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=c1d0476885d708a932980b0f28cd90d9bd71db39) | 50 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/namei.c?id=c1d0476885d708a932980b0f28cd90d9bd71db39) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=c1d0476885d708a932980b0f28cd90d9bd71db39) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 54 insertions, 37 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 5c0e280c83eeae..365cae5c3e3519 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=c38add9ac0e4d4f418e6443a688491499021add9)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=c1d0476885d708a932980b0f28cd90d9bd71db39)@@ -331,6 +331,8 @@ static int nilfs\_readdir(struct file \*file, struct dir\_context \*ctx) \* returns the page in which the entry was found, and the entry itself \* (as a parameter - res\_dir). Page is returned mapped and unlocked. \* Entry is guaranteed to be valid.+ \*+ \* On failure, returns an error pointer and the caller should ignore res\_page. \*/ struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr,@@ -358,22 +360,24 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, do { char \*kaddr = nilfs\_get\_page(dir, n, &page); - if (!IS\_ERR(kaddr)) {- de = (struct nilfs\_dir\_entry \*)kaddr;- kaddr += nilfs\_last\_byte(dir, n) - reclen;- while ((char \*) de <= kaddr) {- if (de->rec\_len == 0) {- nilfs\_error(dir->i\_sb,- "zero-length directory entry");- nilfs\_put\_page(page);- goto out;- }- if (nilfs\_match(namelen, name, de))- goto found;- de = nilfs\_next\_entry(de);+ if (IS\_ERR(kaddr))+ return ERR\_CAST(kaddr);++ de = (struct nilfs\_dir\_entry \*)kaddr;+ kaddr += nilfs\_last\_byte(dir, n) - reclen;+ while ((char \*)de <= kaddr) {+ if (de->rec\_len == 0) {+ nilfs\_error(dir->i\_sb,+ "zero-length directory entry");+ nilfs\_put\_page(page);+ goto out; }- nilfs\_put\_page(page);+ if (nilfs\_match(namelen, name, de))+ goto found;+ de = nilfs\_next\_entry(de); }+ nilfs\_put\_page(page);+ if (++n >= npages) n = 0; /\* next page is past the blocks we've got \*/@@ -386,7 +390,7 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, } } while (n != start); out:- return NULL;+ return ERR\_PTR(-ENOENT);  found: \*res\_page = page;@@ -431,19 +435,19 @@ fail: return NULL; } -ino\_t nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr)+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino) {- ino\_t res = 0; struct nilfs\_dir\_entry \*de; struct page \*page;  de = nilfs\_find\_entry(dir, qstr, &page);- if (de) {- res = le64\_to\_cpu(de->inode);- kunmap(page);- put\_page(page);- }- return res;+ if (IS\_ERR(de))+ return PTR\_ERR(de);++ \*ino = le64\_to\_cpu(de->inode);+ kunmap(page);+ put\_page(page);+ return 0; }  /\* Releases the page \*/diff --git a/fs/nilfs2/namei.c b/fs/nilfs2/namei.cindex a6ec7961d4f5af..08c6d985edeb6f 100644--- a/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=c38add9ac0e4d4f418e6443a688491499021add9)+++ b/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=c1d0476885d708a932980b0f28cd90d9bd71db39)@@ -55,12 +55,20 @@ nilfs\_lookup(struct inode \*dir, struct dentry \*dentry, unsigned int flags) { struct inode \*inode; ino\_t ino;+ int res;  if (dentry->d\_name.len > NILFS\_NAME\_LEN) return ERR\_PTR(-ENAMETOOLONG); - ino = nilfs\_inode\_by\_name(dir, &dentry->d\_name);- inode = ino ? nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino) : NULL;+ res = nilfs\_inode\_by\_name(dir, &dentry->d\_name, &ino);+ if (res) {+ if (res != -ENOENT)+ return ERR\_PTR(res);+ inode = NULL;+ } else {+ inode = nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino);+ }+ return d\_splice\_alias(inode, dentry); } @@ -261,10 +269,11 @@ static int nilfs\_do\_unlink(struct inode \*dir, struct dentry \*dentry) struct page \*page; int err; - err = -ENOENT; de = nilfs\_find\_entry(dir, &dentry->d\_name, &page);- if (!de)+ if (IS\_ERR(de)) {+ err = PTR\_ERR(de); goto out;+ }  inode = d\_inode(dentry); err = -EIO;@@ -358,10 +367,11 @@ static int nilfs\_rename(struct inode \*old\_dir, struct dentry \*old\_dentry, if (unlikely(err)) return err; - err = -ENOENT; old\_de = nilfs\_find\_entry(old\_dir, &old\_dentry->d\_name, &old\_page);- if (!old\_de)+ if (IS\_ERR(old\_de)) {+ err = PTR\_ERR(old\_de); goto out;+ }  if (S\_ISDIR(old\_inode->i\_mode)) { err = -EIO;@@ -378,10 +388,12 @@ static int nilfs\_rename(struct inode \*old\_dir, struct dentry \*old\_dentry, if (dir\_de && !nilfs\_empty\_dir(new\_inode)) goto out\_dir; - err = -ENOENT;- new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name, &new\_page);- if (!new\_de)+ new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name,+ &new\_page);+ if (IS\_ERR(new\_de)) {+ err = PTR\_ERR(new\_de); goto out\_dir;+ } nilfs\_set\_link(new\_dir, new\_de, new\_page, old\_inode); nilfs\_mark\_inode\_dirty(new\_dir); new\_inode->i\_ctime = current\_time(new\_inode);@@ -435,14 +447,15 @@ out: \*/ static struct dentry \*nilfs\_get\_parent(struct dentry \*child) {- unsigned long ino;+ ino\_t ino;+ int res; struct inode \*inode; struct qstr dotdot = QSTR\_INIT("..", 2); struct nilfs\_root \*root; - ino = nilfs\_inode\_by\_name(d\_inode(child), &dotdot);- if (!ino)- return ERR\_PTR(-ENOENT);+ res = nilfs\_inode\_by\_name(d\_inode(child), &dotdot, &ino);+ if (res)+ return ERR\_PTR(res);  root = NILFS\_I(d\_inode(child))->i\_root; diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 3f3971e0292daf..e1b230a5011a04 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=c38add9ac0e4d4f418e6443a688491499021add9)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=c1d0476885d708a932980b0f28cd90d9bd71db39)@@ -233,7 +233,7 @@ static inline \_\_u32 nilfs\_mask\_flags(umode\_t mode, \_\_u32 flags)  /\* dir.c \*/ extern int nilfs\_add\_link(struct dentry \*, struct inode \*);-extern ino\_t nilfs\_inode\_by\_name(struct inode \*, const struct qstr \*);+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino); extern int nilfs\_make\_empty(struct inode \*, struct inode \*); extern struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*, const struct qstr \*, struct page \*\*); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:20:37 +0000



=== Content from git.kernel.org_ef8717c4_20250114_232156.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9698088ac7704e260f492d9c254e29ed7dd8729a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9698088ac7704e260f492d9c254e29ed7dd8729a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9698088ac7704e260f492d9c254e29ed7dd8729a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9698088ac7704e260f492d9c254e29ed7dd8729a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-04 12:35:31 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:46:36 +0200 |
| commit | [9698088ac7704e260f492d9c254e29ed7dd8729a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9698088ac7704e260f492d9c254e29ed7dd8729a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9698088ac7704e260f492d9c254e29ed7dd8729a)) | |
| tree | [375905a83456931788f1fb91b6802cf6e1abe5a5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9698088ac7704e260f492d9c254e29ed7dd8729a) | |
| parent | [87cb3f6e0c047f9320889e68140f46b1f4ca9eca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87cb3f6e0c047f9320889e68140f46b1f4ca9eca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9698088ac7704e260f492d9c254e29ed7dd8729a&id2=87cb3f6e0c047f9320889e68140f46b1f4ca9eca)) | |
| download | [linux-9698088ac7704e260f492d9c254e29ed7dd8729a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9698088ac7704e260f492d9c254e29ed7dd8729a.tar.gz) | |

nilfs2: propagate directory read errors from nilfs\_find\_entry()commit 08cfa12adf888db98879dbd735bc741360a34168 upstream.
Syzbot reported that a task hang occurs in vcs\_open() during a fuzzing
test for nilfs2.
The root cause of this problem is that in nilfs\_find\_entry(), which
searches for directory entries, ignores errors when loading a directory
page/folio via nilfs\_get\_folio() fails.
If the filesystem images is corrupted, and the i\_size of the directory
inode is large, and the directory page/folio is successfully read but
fails the sanity check, for example when it is zero-filled,
nilfs\_check\_folio() may continue to spit out error messages in bursts.
Fix this issue by propagating the error to the callers when loading a
page/folio fails in nilfs\_find\_entry().
The current interface of nilfs\_find\_entry() and its callers is outdated
and cannot propagate error codes such as -EIO and -ENOMEM returned via
nilfs\_find\_entry(), so fix it together.
Link: [https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke%40gmail.com)
Fixes: 2ba466d74ed7 ("nilfs2: directory entry operations")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: Lizhi Xu <lizhi.xu@windriver.com>
Closes: https://lkml.kernel.org/r/20240927013806.3577931-1-lizhi.xu@windriver.com
Reported-by: syzbot+8a192e8d090fa9a31135@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=8a192e8d090fa9a31135
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9698088ac7704e260f492d9c254e29ed7dd8729a)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=9698088ac7704e260f492d9c254e29ed7dd8729a) | 50 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/namei.c?id=9698088ac7704e260f492d9c254e29ed7dd8729a) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=9698088ac7704e260f492d9c254e29ed7dd8729a) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 54 insertions, 37 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 53e4e63c607e7c..ddf8e575e489ca 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=87cb3f6e0c047f9320889e68140f46b1f4ca9eca)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=9698088ac7704e260f492d9c254e29ed7dd8729a)@@ -331,6 +331,8 @@ static int nilfs\_readdir(struct file \*file, struct dir\_context \*ctx) \* returns the page in which the entry was found, and the entry itself \* (as a parameter - res\_dir). Page is returned mapped and unlocked. \* Entry is guaranteed to be valid.+ \*+ \* On failure, returns an error pointer and the caller should ignore res\_page. \*/ struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr,@@ -358,22 +360,24 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, do { char \*kaddr = nilfs\_get\_page(dir, n, &page); - if (!IS\_ERR(kaddr)) {- de = (struct nilfs\_dir\_entry \*)kaddr;- kaddr += nilfs\_last\_byte(dir, n) - reclen;- while ((char \*) de <= kaddr) {- if (de->rec\_len == 0) {- nilfs\_error(dir->i\_sb,- "zero-length directory entry");- nilfs\_put\_page(page);- goto out;- }- if (nilfs\_match(namelen, name, de))- goto found;- de = nilfs\_next\_entry(de);+ if (IS\_ERR(kaddr))+ return ERR\_CAST(kaddr);++ de = (struct nilfs\_dir\_entry \*)kaddr;+ kaddr += nilfs\_last\_byte(dir, n) - reclen;+ while ((char \*)de <= kaddr) {+ if (de->rec\_len == 0) {+ nilfs\_error(dir->i\_sb,+ "zero-length directory entry");+ nilfs\_put\_page(page);+ goto out; }- nilfs\_put\_page(page);+ if (nilfs\_match(namelen, name, de))+ goto found;+ de = nilfs\_next\_entry(de); }+ nilfs\_put\_page(page);+ if (++n >= npages) n = 0; /\* next page is past the blocks we've got \*/@@ -386,7 +390,7 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, } } while (n != start); out:- return NULL;+ return ERR\_PTR(-ENOENT);  found: \*res\_page = page;@@ -431,19 +435,19 @@ fail: return NULL; } -ino\_t nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr)+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino) {- ino\_t res = 0; struct nilfs\_dir\_entry \*de; struct page \*page;  de = nilfs\_find\_entry(dir, qstr, &page);- if (de) {- res = le64\_to\_cpu(de->inode);- kunmap(page);- put\_page(page);- }- return res;+ if (IS\_ERR(de))+ return PTR\_ERR(de);++ \*ino = le64\_to\_cpu(de->inode);+ kunmap(page);+ put\_page(page);+ return 0; }  /\* Releases the page \*/diff --git a/fs/nilfs2/namei.c b/fs/nilfs2/namei.cindex 2a4e7f4a8102f6..9f9b0762ff6901 100644--- a/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=87cb3f6e0c047f9320889e68140f46b1f4ca9eca)+++ b/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=9698088ac7704e260f492d9c254e29ed7dd8729a)@@ -55,12 +55,20 @@ nilfs\_lookup(struct inode \*dir, struct dentry \*dentry, unsigned int flags) { struct inode \*inode; ino\_t ino;+ int res;  if (dentry->d\_name.len > NILFS\_NAME\_LEN) return ERR\_PTR(-ENAMETOOLONG); - ino = nilfs\_inode\_by\_name(dir, &dentry->d\_name);- inode = ino ? nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino) : NULL;+ res = nilfs\_inode\_by\_name(dir, &dentry->d\_name, &ino);+ if (res) {+ if (res != -ENOENT)+ return ERR\_PTR(res);+ inode = NULL;+ } else {+ inode = nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino);+ }+ return d\_splice\_alias(inode, dentry); } @@ -263,10 +271,11 @@ static int nilfs\_do\_unlink(struct inode \*dir, struct dentry \*dentry) struct page \*page; int err; - err = -ENOENT; de = nilfs\_find\_entry(dir, &dentry->d\_name, &page);- if (!de)+ if (IS\_ERR(de)) {+ err = PTR\_ERR(de); goto out;+ }  inode = d\_inode(dentry); err = -EIO;@@ -361,10 +370,11 @@ static int nilfs\_rename(struct mnt\_idmap \*idmap, if (unlikely(err)) return err; - err = -ENOENT; old\_de = nilfs\_find\_entry(old\_dir, &old\_dentry->d\_name, &old\_page);- if (!old\_de)+ if (IS\_ERR(old\_de)) {+ err = PTR\_ERR(old\_de); goto out;+ }  if (S\_ISDIR(old\_inode->i\_mode)) { err = -EIO;@@ -381,10 +391,12 @@ static int nilfs\_rename(struct mnt\_idmap \*idmap, if (dir\_de && !nilfs\_empty\_dir(new\_inode)) goto out\_dir; - err = -ENOENT;- new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name, &new\_page);- if (!new\_de)+ new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name,+ &new\_page);+ if (IS\_ERR(new\_de)) {+ err = PTR\_ERR(new\_de); goto out\_dir;+ } nilfs\_set\_link(new\_dir, new\_de, new\_page, old\_inode); nilfs\_mark\_inode\_dirty(new\_dir); inode\_set\_ctime\_current(new\_inode);@@ -438,13 +450,14 @@ out: \*/ static struct dentry \*nilfs\_get\_parent(struct dentry \*child) {- unsigned long ino;+ ino\_t ino;+ int res; struct inode \*inode; struct nilfs\_root \*root; - ino = nilfs\_inode\_by\_name(d\_inode(child), &dotdot\_name);- if (!ino)- return ERR\_PTR(-ENOENT);+ res = nilfs\_inode\_by\_name(d\_inode(child), &dotdot\_name, &ino);+ if (res)+ return ERR\_PTR(res);  root = NILFS\_I(d\_inode(child))->i\_root; diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 9a157e5051d0c4..ad13e74af65f92 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=87cb3f6e0c047f9320889e68140f46b1f4ca9eca)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=9698088ac7704e260f492d9c254e29ed7dd8729a)@@ -233,7 +233,7 @@ static inline \_\_u32 nilfs\_mask\_flags(umode\_t mode, \_\_u32 flags)  /\* dir.c \*/ extern int nilfs\_add\_link(struct dentry \*, struct inode \*);-extern ino\_t nilfs\_inode\_by\_name(struct inode \*, const struct qstr \*);+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino); extern int nilfs\_make\_empty(struct inode \*, struct inode \*); extern struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*, const struct qstr \*, struct page \*\*); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:20:33 +0000



=== Content from git.kernel.org_22328b5e_20250114_232154.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-04 12:35:31 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:56:51 +0200 |
| commit | [270a6f9df35fa2aea01ec23770dc9b3fc9a12989](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989)) | |
| tree | [4d0a0d4d206c9c992e49fca2c08269060c888a3f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989) | |
| parent | [6999328f2aa803aecb9de800c4f08e5fbb21b299](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6999328f2aa803aecb9de800c4f08e5fbb21b299) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989&id2=6999328f2aa803aecb9de800c4f08e5fbb21b299)) | |
| download | [linux-270a6f9df35fa2aea01ec23770dc9b3fc9a12989.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-270a6f9df35fa2aea01ec23770dc9b3fc9a12989.tar.gz) | |

nilfs2: propagate directory read errors from nilfs\_find\_entry()commit 08cfa12adf888db98879dbd735bc741360a34168 upstream.
Syzbot reported that a task hang occurs in vcs\_open() during a fuzzing
test for nilfs2.
The root cause of this problem is that in nilfs\_find\_entry(), which
searches for directory entries, ignores errors when loading a directory
page/folio via nilfs\_get\_folio() fails.
If the filesystem images is corrupted, and the i\_size of the directory
inode is large, and the directory page/folio is successfully read but
fails the sanity check, for example when it is zero-filled,
nilfs\_check\_folio() may continue to spit out error messages in bursts.
Fix this issue by propagating the error to the callers when loading a
page/folio fails in nilfs\_find\_entry().
The current interface of nilfs\_find\_entry() and its callers is outdated
and cannot propagate error codes such as -EIO and -ENOMEM returned via
nilfs\_find\_entry(), so fix it together.
Link: [https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke%40gmail.com)
Fixes: 2ba466d74ed7 ("nilfs2: directory entry operations")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: Lizhi Xu <lizhi.xu@windriver.com>
Closes: https://lkml.kernel.org/r/20240927013806.3577931-1-lizhi.xu@windriver.com
Reported-by: syzbot+8a192e8d090fa9a31135@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=8a192e8d090fa9a31135
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989) | 50 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/namei.c?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 54 insertions, 37 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 36438834a0c733..b60f4fb9a40539 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=6999328f2aa803aecb9de800c4f08e5fbb21b299)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989)@@ -331,6 +331,8 @@ static int nilfs\_readdir(struct file \*file, struct dir\_context \*ctx) \* returns the page in which the entry was found, and the entry itself \* (as a parameter - res\_dir). Page is returned mapped and unlocked. \* Entry is guaranteed to be valid.+ \*+ \* On failure, returns an error pointer and the caller should ignore res\_page. \*/ struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr,@@ -358,22 +360,24 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, do { char \*kaddr = nilfs\_get\_page(dir, n, &page); - if (!IS\_ERR(kaddr)) {- de = (struct nilfs\_dir\_entry \*)kaddr;- kaddr += nilfs\_last\_byte(dir, n) - reclen;- while ((char \*) de <= kaddr) {- if (de->rec\_len == 0) {- nilfs\_error(dir->i\_sb,- "zero-length directory entry");- nilfs\_put\_page(page);- goto out;- }- if (nilfs\_match(namelen, name, de))- goto found;- de = nilfs\_next\_entry(de);+ if (IS\_ERR(kaddr))+ return ERR\_CAST(kaddr);++ de = (struct nilfs\_dir\_entry \*)kaddr;+ kaddr += nilfs\_last\_byte(dir, n) - reclen;+ while ((char \*)de <= kaddr) {+ if (de->rec\_len == 0) {+ nilfs\_error(dir->i\_sb,+ "zero-length directory entry");+ nilfs\_put\_page(page);+ goto out; }- nilfs\_put\_page(page);+ if (nilfs\_match(namelen, name, de))+ goto found;+ de = nilfs\_next\_entry(de); }+ nilfs\_put\_page(page);+ if (++n >= npages) n = 0; /\* next page is past the blocks we've got \*/@@ -386,7 +390,7 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, } } while (n != start); out:- return NULL;+ return ERR\_PTR(-ENOENT);  found: \*res\_page = page;@@ -431,19 +435,19 @@ fail: return NULL; } -ino\_t nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr)+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino) {- ino\_t res = 0; struct nilfs\_dir\_entry \*de; struct page \*page;  de = nilfs\_find\_entry(dir, qstr, &page);- if (de) {- res = le64\_to\_cpu(de->inode);- kunmap(page);- put\_page(page);- }- return res;+ if (IS\_ERR(de))+ return PTR\_ERR(de);++ \*ino = le64\_to\_cpu(de->inode);+ kunmap(page);+ put\_page(page);+ return 0; }  /\* Releases the page \*/diff --git a/fs/nilfs2/namei.c b/fs/nilfs2/namei.cindex 23899e0ae85091..180e1ce42d21ea 100644--- a/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=6999328f2aa803aecb9de800c4f08e5fbb21b299)+++ b/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989)@@ -55,12 +55,20 @@ nilfs\_lookup(struct inode \*dir, struct dentry \*dentry, unsigned int flags) { struct inode \*inode; ino\_t ino;+ int res;  if (dentry->d\_name.len > NILFS\_NAME\_LEN) return ERR\_PTR(-ENAMETOOLONG); - ino = nilfs\_inode\_by\_name(dir, &dentry->d\_name);- inode = ino ? nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino) : NULL;+ res = nilfs\_inode\_by\_name(dir, &dentry->d\_name, &ino);+ if (res) {+ if (res != -ENOENT)+ return ERR\_PTR(res);+ inode = NULL;+ } else {+ inode = nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino);+ }+ return d\_splice\_alias(inode, dentry); } @@ -263,10 +271,11 @@ static int nilfs\_do\_unlink(struct inode \*dir, struct dentry \*dentry) struct page \*page; int err; - err = -ENOENT; de = nilfs\_find\_entry(dir, &dentry->d\_name, &page);- if (!de)+ if (IS\_ERR(de)) {+ err = PTR\_ERR(de); goto out;+ }  inode = d\_inode(dentry); err = -EIO;@@ -361,10 +370,11 @@ static int nilfs\_rename(struct user\_namespace \*mnt\_userns, if (unlikely(err)) return err; - err = -ENOENT; old\_de = nilfs\_find\_entry(old\_dir, &old\_dentry->d\_name, &old\_page);- if (!old\_de)+ if (IS\_ERR(old\_de)) {+ err = PTR\_ERR(old\_de); goto out;+ }  if (S\_ISDIR(old\_inode->i\_mode)) { err = -EIO;@@ -381,10 +391,12 @@ static int nilfs\_rename(struct user\_namespace \*mnt\_userns, if (dir\_de && !nilfs\_empty\_dir(new\_inode)) goto out\_dir; - err = -ENOENT;- new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name, &new\_page);- if (!new\_de)+ new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name,+ &new\_page);+ if (IS\_ERR(new\_de)) {+ err = PTR\_ERR(new\_de); goto out\_dir;+ } nilfs\_set\_link(new\_dir, new\_de, new\_page, old\_inode); nilfs\_mark\_inode\_dirty(new\_dir); new\_inode->i\_ctime = current\_time(new\_inode);@@ -438,13 +450,14 @@ out: \*/ static struct dentry \*nilfs\_get\_parent(struct dentry \*child) {- unsigned long ino;+ ino\_t ino;+ int res; struct inode \*inode; struct nilfs\_root \*root; - ino = nilfs\_inode\_by\_name(d\_inode(child), &dotdot\_name);- if (!ino)- return ERR\_PTR(-ENOENT);+ res = nilfs\_inode\_by\_name(d\_inode(child), &dotdot\_name, &ino);+ if (res)+ return ERR\_PTR(res);  root = NILFS\_I(d\_inode(child))->i\_root; diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex a1ff52265e1b02..ee27bb370d776d 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=6999328f2aa803aecb9de800c4f08e5fbb21b299)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=270a6f9df35fa2aea01ec23770dc9b3fc9a12989)@@ -233,7 +233,7 @@ static inline \_\_u32 nilfs\_mask\_flags(umode\_t mode, \_\_u32 flags)  /\* dir.c \*/ extern int nilfs\_add\_link(struct dentry \*, struct inode \*);-extern ino\_t nilfs\_inode\_by\_name(struct inode \*, const struct qstr \*);+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino); extern int nilfs\_make\_empty(struct inode \*, struct inode \*); extern struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*, const struct qstr \*, struct page \*\*); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:20:31 +0000



=== Content from git.kernel.org_df566eef_20250114_232159.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bb857ae1efd3138c653239ed1e7aef14e1242c81)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb857ae1efd3138c653239ed1e7aef14e1242c81)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb857ae1efd3138c653239ed1e7aef14e1242c81)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb857ae1efd3138c653239ed1e7aef14e1242c81)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-04 12:35:31 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:20 +0100 |
| commit | [bb857ae1efd3138c653239ed1e7aef14e1242c81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb857ae1efd3138c653239ed1e7aef14e1242c81) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bb857ae1efd3138c653239ed1e7aef14e1242c81)) | |
| tree | [2c7589bda65a3bc1780b476d41a0ca0279633043](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb857ae1efd3138c653239ed1e7aef14e1242c81) | |
| parent | [e75562346cac53c7e933373a004b1829e861123a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e75562346cac53c7e933373a004b1829e861123a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb857ae1efd3138c653239ed1e7aef14e1242c81&id2=e75562346cac53c7e933373a004b1829e861123a)) | |
| download | [linux-bb857ae1efd3138c653239ed1e7aef14e1242c81.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bb857ae1efd3138c653239ed1e7aef14e1242c81.tar.gz) | |

nilfs2: propagate directory read errors from nilfs\_find\_entry()commit 08cfa12adf888db98879dbd735bc741360a34168 upstream.
Syzbot reported that a task hang occurs in vcs\_open() during a fuzzing
test for nilfs2.
The root cause of this problem is that in nilfs\_find\_entry(), which
searches for directory entries, ignores errors when loading a directory
page/folio via nilfs\_get\_folio() fails.
If the filesystem images is corrupted, and the i\_size of the directory
inode is large, and the directory page/folio is successfully read but
fails the sanity check, for example when it is zero-filled,
nilfs\_check\_folio() may continue to spit out error messages in bursts.
Fix this issue by propagating the error to the callers when loading a
page/folio fails in nilfs\_find\_entry().
The current interface of nilfs\_find\_entry() and its callers is outdated
and cannot propagate error codes such as -EIO and -ENOMEM returned via
nilfs\_find\_entry(), so fix it together.
Link: [https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke%40gmail.com)
Fixes: 2ba466d74ed7 ("nilfs2: directory entry operations")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: Lizhi Xu <lizhi.xu@windriver.com>
Closes: https://lkml.kernel.org/r/20240927013806.3577931-1-lizhi.xu@windriver.com
Reported-by: syzbot+8a192e8d090fa9a31135@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=8a192e8d090fa9a31135
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb857ae1efd3138c653239ed1e7aef14e1242c81)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=bb857ae1efd3138c653239ed1e7aef14e1242c81) | 50 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/namei.c?id=bb857ae1efd3138c653239ed1e7aef14e1242c81) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=bb857ae1efd3138c653239ed1e7aef14e1242c81) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 54 insertions, 37 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 5c0e280c83eeae..365cae5c3e3519 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=e75562346cac53c7e933373a004b1829e861123a)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=bb857ae1efd3138c653239ed1e7aef14e1242c81)@@ -331,6 +331,8 @@ static int nilfs\_readdir(struct file \*file, struct dir\_context \*ctx) \* returns the page in which the entry was found, and the entry itself \* (as a parameter - res\_dir). Page is returned mapped and unlocked. \* Entry is guaranteed to be valid.+ \*+ \* On failure, returns an error pointer and the caller should ignore res\_page. \*/ struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr,@@ -358,22 +360,24 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, do { char \*kaddr = nilfs\_get\_page(dir, n, &page); - if (!IS\_ERR(kaddr)) {- de = (struct nilfs\_dir\_entry \*)kaddr;- kaddr += nilfs\_last\_byte(dir, n) - reclen;- while ((char \*) de <= kaddr) {- if (de->rec\_len == 0) {- nilfs\_error(dir->i\_sb,- "zero-length directory entry");- nilfs\_put\_page(page);- goto out;- }- if (nilfs\_match(namelen, name, de))- goto found;- de = nilfs\_next\_entry(de);+ if (IS\_ERR(kaddr))+ return ERR\_CAST(kaddr);++ de = (struct nilfs\_dir\_entry \*)kaddr;+ kaddr += nilfs\_last\_byte(dir, n) - reclen;+ while ((char \*)de <= kaddr) {+ if (de->rec\_len == 0) {+ nilfs\_error(dir->i\_sb,+ "zero-length directory entry");+ nilfs\_put\_page(page);+ goto out; }- nilfs\_put\_page(page);+ if (nilfs\_match(namelen, name, de))+ goto found;+ de = nilfs\_next\_entry(de); }+ nilfs\_put\_page(page);+ if (++n >= npages) n = 0; /\* next page is past the blocks we've got \*/@@ -386,7 +390,7 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, } } while (n != start); out:- return NULL;+ return ERR\_PTR(-ENOENT);  found: \*res\_page = page;@@ -431,19 +435,19 @@ fail: return NULL; } -ino\_t nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr)+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino) {- ino\_t res = 0; struct nilfs\_dir\_entry \*de; struct page \*page;  de = nilfs\_find\_entry(dir, qstr, &page);- if (de) {- res = le64\_to\_cpu(de->inode);- kunmap(page);- put\_page(page);- }- return res;+ if (IS\_ERR(de))+ return PTR\_ERR(de);++ \*ino = le64\_to\_cpu(de->inode);+ kunmap(page);+ put\_page(page);+ return 0; }  /\* Releases the page \*/diff --git a/fs/nilfs2/namei.c b/fs/nilfs2/namei.cindex a6ec7961d4f5af..08c6d985edeb6f 100644--- a/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=e75562346cac53c7e933373a004b1829e861123a)+++ b/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=bb857ae1efd3138c653239ed1e7aef14e1242c81)@@ -55,12 +55,20 @@ nilfs\_lookup(struct inode \*dir, struct dentry \*dentry, unsigned int flags) { struct inode \*inode; ino\_t ino;+ int res;  if (dentry->d\_name.len > NILFS\_NAME\_LEN) return ERR\_PTR(-ENAMETOOLONG); - ino = nilfs\_inode\_by\_name(dir, &dentry->d\_name);- inode = ino ? nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino) : NULL;+ res = nilfs\_inode\_by\_name(dir, &dentry->d\_name, &ino);+ if (res) {+ if (res != -ENOENT)+ return ERR\_PTR(res);+ inode = NULL;+ } else {+ inode = nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino);+ }+ return d\_splice\_alias(inode, dentry); } @@ -261,10 +269,11 @@ static int nilfs\_do\_unlink(struct inode \*dir, struct dentry \*dentry) struct page \*page; int err; - err = -ENOENT; de = nilfs\_find\_entry(dir, &dentry->d\_name, &page);- if (!de)+ if (IS\_ERR(de)) {+ err = PTR\_ERR(de); goto out;+ }  inode = d\_inode(dentry); err = -EIO;@@ -358,10 +367,11 @@ static int nilfs\_rename(struct inode \*old\_dir, struct dentry \*old\_dentry, if (unlikely(err)) return err; - err = -ENOENT; old\_de = nilfs\_find\_entry(old\_dir, &old\_dentry->d\_name, &old\_page);- if (!old\_de)+ if (IS\_ERR(old\_de)) {+ err = PTR\_ERR(old\_de); goto out;+ }  if (S\_ISDIR(old\_inode->i\_mode)) { err = -EIO;@@ -378,10 +388,12 @@ static int nilfs\_rename(struct inode \*old\_dir, struct dentry \*old\_dentry, if (dir\_de && !nilfs\_empty\_dir(new\_inode)) goto out\_dir; - err = -ENOENT;- new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name, &new\_page);- if (!new\_de)+ new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name,+ &new\_page);+ if (IS\_ERR(new\_de)) {+ err = PTR\_ERR(new\_de); goto out\_dir;+ } nilfs\_set\_link(new\_dir, new\_de, new\_page, old\_inode); nilfs\_mark\_inode\_dirty(new\_dir); new\_inode->i\_ctime = current\_time(new\_inode);@@ -435,14 +447,15 @@ out: \*/ static struct dentry \*nilfs\_get\_parent(struct dentry \*child) {- unsigned long ino;+ ino\_t ino;+ int res; struct inode \*inode; struct qstr dotdot = QSTR\_INIT("..", 2); struct nilfs\_root \*root; - ino = nilfs\_inode\_by\_name(d\_inode(child), &dotdot);- if (!ino)- return ERR\_PTR(-ENOENT);+ res = nilfs\_inode\_by\_name(d\_inode(child), &dotdot, &ino);+ if (res)+ return ERR\_PTR(res);  root = NILFS\_I(d\_inode(child))->i\_root; diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex f7e2032f4ecff6..65254027366b6c 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=e75562346cac53c7e933373a004b1829e861123a)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=bb857ae1efd3138c653239ed1e7aef14e1242c81)@@ -233,7 +233,7 @@ static inline \_\_u32 nilfs\_mask\_flags(umode\_t mode, \_\_u32 flags)  /\* dir.c \*/ extern int nilfs\_add\_link(struct dentry \*, struct inode \*);-extern ino\_t nilfs\_inode\_by\_name(struct inode \*, const struct qstr \*);+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino); extern int nilfs\_make\_empty(struct inode \*, struct inode \*); extern struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*, const struct qstr \*, struct page \*\*); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:20:36 +0000



=== Content from git.kernel.org_a6213c7e_20250114_232201.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=edf8146057264191d5bfe5b91773f13d936dadd3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=edf8146057264191d5bfe5b91773f13d936dadd3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=edf8146057264191d5bfe5b91773f13d936dadd3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=edf8146057264191d5bfe5b91773f13d936dadd3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-04 12:35:31 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:40:47 +0200 |
| commit | [edf8146057264191d5bfe5b91773f13d936dadd3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=edf8146057264191d5bfe5b91773f13d936dadd3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=edf8146057264191d5bfe5b91773f13d936dadd3)) | |
| tree | [af2f00c28967fd28bc23f264f04d72205453c3ad](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=edf8146057264191d5bfe5b91773f13d936dadd3) | |
| parent | [5b88612ea5de1ce853321fdcd324fcab51e29d58](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b88612ea5de1ce853321fdcd324fcab51e29d58) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=edf8146057264191d5bfe5b91773f13d936dadd3&id2=5b88612ea5de1ce853321fdcd324fcab51e29d58)) | |
| download | [linux-edf8146057264191d5bfe5b91773f13d936dadd3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-edf8146057264191d5bfe5b91773f13d936dadd3.tar.gz) | |

nilfs2: propagate directory read errors from nilfs\_find\_entry()commit 08cfa12adf888db98879dbd735bc741360a34168 upstream.
Syzbot reported that a task hang occurs in vcs\_open() during a fuzzing
test for nilfs2.
The root cause of this problem is that in nilfs\_find\_entry(), which
searches for directory entries, ignores errors when loading a directory
page/folio via nilfs\_get\_folio() fails.
If the filesystem images is corrupted, and the i\_size of the directory
inode is large, and the directory page/folio is successfully read but
fails the sanity check, for example when it is zero-filled,
nilfs\_check\_folio() may continue to spit out error messages in bursts.
Fix this issue by propagating the error to the callers when loading a
page/folio fails in nilfs\_find\_entry().
The current interface of nilfs\_find\_entry() and its callers is outdated
and cannot propagate error codes such as -EIO and -ENOMEM returned via
nilfs\_find\_entry(), so fix it together.
Link: [https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke%40gmail.com)
Fixes: 2ba466d74ed7 ("nilfs2: directory entry operations")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: Lizhi Xu <lizhi.xu@windriver.com>
Closes: https://lkml.kernel.org/r/20240927013806.3577931-1-lizhi.xu@windriver.com
Reported-by: syzbot+8a192e8d090fa9a31135@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=8a192e8d090fa9a31135
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=edf8146057264191d5bfe5b91773f13d936dadd3)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=edf8146057264191d5bfe5b91773f13d936dadd3) | 50 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/namei.c?id=edf8146057264191d5bfe5b91773f13d936dadd3) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=edf8146057264191d5bfe5b91773f13d936dadd3) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 54 insertions, 37 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 5c0e280c83eeae..365cae5c3e3519 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=5b88612ea5de1ce853321fdcd324fcab51e29d58)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=edf8146057264191d5bfe5b91773f13d936dadd3)@@ -331,6 +331,8 @@ static int nilfs\_readdir(struct file \*file, struct dir\_context \*ctx) \* returns the page in which the entry was found, and the entry itself \* (as a parameter - res\_dir). Page is returned mapped and unlocked. \* Entry is guaranteed to be valid.+ \*+ \* On failure, returns an error pointer and the caller should ignore res\_page. \*/ struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr,@@ -358,22 +360,24 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, do { char \*kaddr = nilfs\_get\_page(dir, n, &page); - if (!IS\_ERR(kaddr)) {- de = (struct nilfs\_dir\_entry \*)kaddr;- kaddr += nilfs\_last\_byte(dir, n) - reclen;- while ((char \*) de <= kaddr) {- if (de->rec\_len == 0) {- nilfs\_error(dir->i\_sb,- "zero-length directory entry");- nilfs\_put\_page(page);- goto out;- }- if (nilfs\_match(namelen, name, de))- goto found;- de = nilfs\_next\_entry(de);+ if (IS\_ERR(kaddr))+ return ERR\_CAST(kaddr);++ de = (struct nilfs\_dir\_entry \*)kaddr;+ kaddr += nilfs\_last\_byte(dir, n) - reclen;+ while ((char \*)de <= kaddr) {+ if (de->rec\_len == 0) {+ nilfs\_error(dir->i\_sb,+ "zero-length directory entry");+ nilfs\_put\_page(page);+ goto out; }- nilfs\_put\_page(page);+ if (nilfs\_match(namelen, name, de))+ goto found;+ de = nilfs\_next\_entry(de); }+ nilfs\_put\_page(page);+ if (++n >= npages) n = 0; /\* next page is past the blocks we've got \*/@@ -386,7 +390,7 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, } } while (n != start); out:- return NULL;+ return ERR\_PTR(-ENOENT);  found: \*res\_page = page;@@ -431,19 +435,19 @@ fail: return NULL; } -ino\_t nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr)+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino) {- ino\_t res = 0; struct nilfs\_dir\_entry \*de; struct page \*page;  de = nilfs\_find\_entry(dir, qstr, &page);- if (de) {- res = le64\_to\_cpu(de->inode);- kunmap(page);- put\_page(page);- }- return res;+ if (IS\_ERR(de))+ return PTR\_ERR(de);++ \*ino = le64\_to\_cpu(de->inode);+ kunmap(page);+ put\_page(page);+ return 0; }  /\* Releases the page \*/diff --git a/fs/nilfs2/namei.c b/fs/nilfs2/namei.cindex 91eebeb0c48b4c..af3a74bd0fbd48 100644--- a/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=5b88612ea5de1ce853321fdcd324fcab51e29d58)+++ b/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=edf8146057264191d5bfe5b91773f13d936dadd3)@@ -55,12 +55,20 @@ nilfs\_lookup(struct inode \*dir, struct dentry \*dentry, unsigned int flags) { struct inode \*inode; ino\_t ino;+ int res;  if (dentry->d\_name.len > NILFS\_NAME\_LEN) return ERR\_PTR(-ENAMETOOLONG); - ino = nilfs\_inode\_by\_name(dir, &dentry->d\_name);- inode = ino ? nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino) : NULL;+ res = nilfs\_inode\_by\_name(dir, &dentry->d\_name, &ino);+ if (res) {+ if (res != -ENOENT)+ return ERR\_PTR(res);+ inode = NULL;+ } else {+ inode = nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino);+ }+ return d\_splice\_alias(inode, dentry); } @@ -263,10 +271,11 @@ static int nilfs\_do\_unlink(struct inode \*dir, struct dentry \*dentry) struct page \*page; int err; - err = -ENOENT; de = nilfs\_find\_entry(dir, &dentry->d\_name, &page);- if (!de)+ if (IS\_ERR(de)) {+ err = PTR\_ERR(de); goto out;+ }  inode = d\_inode(dentry); err = -EIO;@@ -361,10 +370,11 @@ static int nilfs\_rename(struct user\_namespace \*mnt\_userns, if (unlikely(err)) return err; - err = -ENOENT; old\_de = nilfs\_find\_entry(old\_dir, &old\_dentry->d\_name, &old\_page);- if (!old\_de)+ if (IS\_ERR(old\_de)) {+ err = PTR\_ERR(old\_de); goto out;+ }  if (S\_ISDIR(old\_inode->i\_mode)) { err = -EIO;@@ -381,10 +391,12 @@ static int nilfs\_rename(struct user\_namespace \*mnt\_userns, if (dir\_de && !nilfs\_empty\_dir(new\_inode)) goto out\_dir; - err = -ENOENT;- new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name, &new\_page);- if (!new\_de)+ new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name,+ &new\_page);+ if (IS\_ERR(new\_de)) {+ err = PTR\_ERR(new\_de); goto out\_dir;+ } nilfs\_set\_link(new\_dir, new\_de, new\_page, old\_inode); nilfs\_mark\_inode\_dirty(new\_dir); new\_inode->i\_ctime = current\_time(new\_inode);@@ -438,13 +450,14 @@ out: \*/ static struct dentry \*nilfs\_get\_parent(struct dentry \*child) {- unsigned long ino;+ ino\_t ino;+ int res; struct inode \*inode; struct nilfs\_root \*root; - ino = nilfs\_inode\_by\_name(d\_inode(child), &dotdot\_name);- if (!ino)- return ERR\_PTR(-ENOENT);+ res = nilfs\_inode\_by\_name(d\_inode(child), &dotdot\_name, &ino);+ if (res)+ return ERR\_PTR(res);  root = NILFS\_I(d\_inode(child))->i\_root; diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex a4491d29ad5705..935fb5234c24d5 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=5b88612ea5de1ce853321fdcd324fcab51e29d58)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=edf8146057264191d5bfe5b91773f13d936dadd3)@@ -233,7 +233,7 @@ static inline \_\_u32 nilfs\_mask\_flags(umode\_t mode, \_\_u32 flags)  /\* dir.c \*/ extern int nilfs\_add\_link(struct dentry \*, struct inode \*);-extern ino\_t nilfs\_inode\_by\_name(struct inode \*, const struct qstr \*);+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino); extern int nilfs\_make\_empty(struct inode \*, struct inode \*); extern struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*, const struct qstr \*, struct page \*\*); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:20:38 +0000



=== Content from git.kernel.org_efe0a0c9_20250114_232201.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=efa810b15a25531cbc2f527330947b9fe16916e7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=efa810b15a25531cbc2f527330947b9fe16916e7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=efa810b15a25531cbc2f527330947b9fe16916e7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=efa810b15a25531cbc2f527330947b9fe16916e7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-04 12:35:31 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:51:20 +0200 |
| commit | [efa810b15a25531cbc2f527330947b9fe16916e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=efa810b15a25531cbc2f527330947b9fe16916e7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=efa810b15a25531cbc2f527330947b9fe16916e7)) | |
| tree | [ff969d9b68551fb725bc4a5c64d479612e09a4c1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=efa810b15a25531cbc2f527330947b9fe16916e7) | |
| parent | [982dd0d26d1f015ed34866579480d2be5250b0ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=982dd0d26d1f015ed34866579480d2be5250b0ef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=efa810b15a25531cbc2f527330947b9fe16916e7&id2=982dd0d26d1f015ed34866579480d2be5250b0ef)) | |
| download | [linux-efa810b15a25531cbc2f527330947b9fe16916e7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-efa810b15a25531cbc2f527330947b9fe16916e7.tar.gz) | |

nilfs2: propagate directory read errors from nilfs\_find\_entry()commit 08cfa12adf888db98879dbd735bc741360a34168 upstream.
Syzbot reported that a task hang occurs in vcs\_open() during a fuzzing
test for nilfs2.
The root cause of this problem is that in nilfs\_find\_entry(), which
searches for directory entries, ignores errors when loading a directory
page/folio via nilfs\_get\_folio() fails.
If the filesystem images is corrupted, and the i\_size of the directory
inode is large, and the directory page/folio is successfully read but
fails the sanity check, for example when it is zero-filled,
nilfs\_check\_folio() may continue to spit out error messages in bursts.
Fix this issue by propagating the error to the callers when loading a
page/folio fails in nilfs\_find\_entry().
The current interface of nilfs\_find\_entry() and its callers is outdated
and cannot propagate error codes such as -EIO and -ENOMEM returned via
nilfs\_find\_entry(), so fix it together.
Link: [https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke%40gmail.com)
Fixes: 2ba466d74ed7 ("nilfs2: directory entry operations")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: Lizhi Xu <lizhi.xu@windriver.com>
Closes: https://lkml.kernel.org/r/20240927013806.3577931-1-lizhi.xu@windriver.com
Reported-by: syzbot+8a192e8d090fa9a31135@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=8a192e8d090fa9a31135
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=efa810b15a25531cbc2f527330947b9fe16916e7)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=efa810b15a25531cbc2f527330947b9fe16916e7) | 48 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/namei.c?id=efa810b15a25531cbc2f527330947b9fe16916e7) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=efa810b15a25531cbc2f527330947b9fe16916e7) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 52 insertions, 37 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 4a29b0138d75f5..87f59b748b0ba6 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=982dd0d26d1f015ed34866579480d2be5250b0ef)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=efa810b15a25531cbc2f527330947b9fe16916e7)@@ -323,7 +323,7 @@ static int nilfs\_readdir(struct file \*file, struct dir\_context \*ctx) \* The folio is mapped and unlocked. When the caller is finished with \* the entry, it should call folio\_release\_kmap(). \*- \* On failure, returns NULL and the caller should ignore foliop.+ \* On failure, returns an error pointer and the caller should ignore foliop. \*/ struct nilfs\_dir\_entry \*nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, struct folio \*\*foliop)@@ -346,22 +346,24 @@ struct nilfs\_dir\_entry \*nilfs\_find\_entry(struct inode \*dir, do { char \*kaddr = nilfs\_get\_folio(dir, n, foliop); - if (!IS\_ERR(kaddr)) {- de = (struct nilfs\_dir\_entry \*)kaddr;- kaddr += nilfs\_last\_byte(dir, n) - reclen;- while ((char \*) de <= kaddr) {- if (de->rec\_len == 0) {- nilfs\_error(dir->i\_sb,- "zero-length directory entry");- folio\_release\_kmap(\*foliop, kaddr);- goto out;- }- if (nilfs\_match(namelen, name, de))- goto found;- de = nilfs\_next\_entry(de);+ if (IS\_ERR(kaddr))+ return ERR\_CAST(kaddr);++ de = (struct nilfs\_dir\_entry \*)kaddr;+ kaddr += nilfs\_last\_byte(dir, n) - reclen;+ while ((char \*)de <= kaddr) {+ if (de->rec\_len == 0) {+ nilfs\_error(dir->i\_sb,+ "zero-length directory entry");+ folio\_release\_kmap(\*foliop, kaddr);+ goto out; }- folio\_release\_kmap(\*foliop, kaddr);+ if (nilfs\_match(namelen, name, de))+ goto found;+ de = nilfs\_next\_entry(de); }+ folio\_release\_kmap(\*foliop, kaddr);+ if (++n >= npages) n = 0; /\* next folio is past the blocks we've got \*/@@ -374,7 +376,7 @@ struct nilfs\_dir\_entry \*nilfs\_find\_entry(struct inode \*dir, } } while (n != start); out:- return NULL;+ return ERR\_PTR(-ENOENT);  found: ei->i\_dir\_start\_lookup = n;@@ -418,18 +420,18 @@ fail: return NULL; } -ino\_t nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr)+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino) {- ino\_t res = 0; struct nilfs\_dir\_entry \*de; struct folio \*folio;  de = nilfs\_find\_entry(dir, qstr, &folio);- if (de) {- res = le64\_to\_cpu(de->inode);- folio\_release\_kmap(folio, de);- }- return res;+ if (IS\_ERR(de))+ return PTR\_ERR(de);++ \*ino = le64\_to\_cpu(de->inode);+ folio\_release\_kmap(folio, de);+ return 0; }  void nilfs\_set\_link(struct inode \*dir, struct nilfs\_dir\_entry \*de,diff --git a/fs/nilfs2/namei.c b/fs/nilfs2/namei.cindex c950139db6ef0d..4905063790c578 100644--- a/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=982dd0d26d1f015ed34866579480d2be5250b0ef)+++ b/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=efa810b15a25531cbc2f527330947b9fe16916e7)@@ -55,12 +55,20 @@ nilfs\_lookup(struct inode \*dir, struct dentry \*dentry, unsigned int flags) { struct inode \*inode; ino\_t ino;+ int res;  if (dentry->d\_name.len > NILFS\_NAME\_LEN) return ERR\_PTR(-ENAMETOOLONG); - ino = nilfs\_inode\_by\_name(dir, &dentry->d\_name);- inode = ino ? nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino) : NULL;+ res = nilfs\_inode\_by\_name(dir, &dentry->d\_name, &ino);+ if (res) {+ if (res != -ENOENT)+ return ERR\_PTR(res);+ inode = NULL;+ } else {+ inode = nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino);+ }+ return d\_splice\_alias(inode, dentry); } @@ -263,10 +271,11 @@ static int nilfs\_do\_unlink(struct inode \*dir, struct dentry \*dentry) struct folio \*folio; int err; - err = -ENOENT; de = nilfs\_find\_entry(dir, &dentry->d\_name, &folio);- if (!de)+ if (IS\_ERR(de)) {+ err = PTR\_ERR(de); goto out;+ }  inode = d\_inode(dentry); err = -EIO;@@ -362,10 +371,11 @@ static int nilfs\_rename(struct mnt\_idmap \*idmap, if (unlikely(err)) return err; - err = -ENOENT; old\_de = nilfs\_find\_entry(old\_dir, &old\_dentry->d\_name, &old\_folio);- if (!old\_de)+ if (IS\_ERR(old\_de)) {+ err = PTR\_ERR(old\_de); goto out;+ }  if (S\_ISDIR(old\_inode->i\_mode)) { err = -EIO;@@ -382,10 +392,12 @@ static int nilfs\_rename(struct mnt\_idmap \*idmap, if (dir\_de && !nilfs\_empty\_dir(new\_inode)) goto out\_dir; - err = -ENOENT;- new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name, &new\_folio);- if (!new\_de)+ new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name,+ &new\_folio);+ if (IS\_ERR(new\_de)) {+ err = PTR\_ERR(new\_de); goto out\_dir;+ } nilfs\_set\_link(new\_dir, new\_de, new\_folio, old\_inode); folio\_release\_kmap(new\_folio, new\_de); nilfs\_mark\_inode\_dirty(new\_dir);@@ -440,12 +452,13 @@ out: \*/ static struct dentry \*nilfs\_get\_parent(struct dentry \*child) {- unsigned long ino;+ ino\_t ino;+ int res; struct nilfs\_root \*root; - ino = nilfs\_inode\_by\_name(d\_inode(child), &dotdot\_name);- if (!ino)- return ERR\_PTR(-ENOENT);+ res = nilfs\_inode\_by\_name(d\_inode(child), &dotdot\_name, &ino);+ if (res)+ return ERR\_PTR(res);  root = NILFS\_I(d\_inode(child))->i\_root; diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 4017f78564405a..0a80dc39a3aa46 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=982dd0d26d1f015ed34866579480d2be5250b0ef)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=efa810b15a25531cbc2f527330947b9fe16916e7)@@ -233,7 +233,7 @@ static inline \_\_u32 nilfs\_mask\_flags(umode\_t mode, \_\_u32 flags)  /\* dir.c \*/ int nilfs\_add\_link(struct dentry \*, struct inode \*);-ino\_t nilfs\_inode\_by\_name(struct inode \*, const struct qstr \*);+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino); int nilfs\_make\_empty(struct inode \*, struct inode \*); struct nilfs\_dir\_entry \*nilfs\_find\_entry(struct inode \*, const struct qstr \*, struct folio \*\*); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:20:38 +0000



=== Content from git.kernel.org_d774db7f_20250114_232157.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-04 12:35:31 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:49 +0100 |
| commit | [b4b3dc9e7e604be98a222e9f941f5e93798ca475](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475)) | |
| tree | [b876be1520aa729fa78928b0f2f035c39f95ed66](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475) | |
| parent | [4aa8948673dc395262301386aecda9f9b11af8f0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4aa8948673dc395262301386aecda9f9b11af8f0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475&id2=4aa8948673dc395262301386aecda9f9b11af8f0)) | |
| download | [linux-b4b3dc9e7e604be98a222e9f941f5e93798ca475.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b4b3dc9e7e604be98a222e9f941f5e93798ca475.tar.gz) | |

nilfs2: propagate directory read errors from nilfs\_find\_entry()commit 08cfa12adf888db98879dbd735bc741360a34168 upstream.
Syzbot reported that a task hang occurs in vcs\_open() during a fuzzing
test for nilfs2.
The root cause of this problem is that in nilfs\_find\_entry(), which
searches for directory entries, ignores errors when loading a directory
page/folio via nilfs\_get\_folio() fails.
If the filesystem images is corrupted, and the i\_size of the directory
inode is large, and the directory page/folio is successfully read but
fails the sanity check, for example when it is zero-filled,
nilfs\_check\_folio() may continue to spit out error messages in bursts.
Fix this issue by propagating the error to the callers when loading a
page/folio fails in nilfs\_find\_entry().
The current interface of nilfs\_find\_entry() and its callers is outdated
and cannot propagate error codes such as -EIO and -ENOMEM returned via
nilfs\_find\_entry(), so fix it together.
Link: [https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke%40gmail.com)
Fixes: 2ba466d74ed7 ("nilfs2: directory entry operations")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: Lizhi Xu <lizhi.xu@windriver.com>
Closes: https://lkml.kernel.org/r/20240927013806.3577931-1-lizhi.xu@windriver.com
Reported-by: syzbot+8a192e8d090fa9a31135@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=8a192e8d090fa9a31135
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475) | 50 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/namei.c?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 54 insertions, 37 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 5c0e280c83eeae..365cae5c3e3519 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=4aa8948673dc395262301386aecda9f9b11af8f0)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475)@@ -331,6 +331,8 @@ static int nilfs\_readdir(struct file \*file, struct dir\_context \*ctx) \* returns the page in which the entry was found, and the entry itself \* (as a parameter - res\_dir). Page is returned mapped and unlocked. \* Entry is guaranteed to be valid.+ \*+ \* On failure, returns an error pointer and the caller should ignore res\_page. \*/ struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr,@@ -358,22 +360,24 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, do { char \*kaddr = nilfs\_get\_page(dir, n, &page); - if (!IS\_ERR(kaddr)) {- de = (struct nilfs\_dir\_entry \*)kaddr;- kaddr += nilfs\_last\_byte(dir, n) - reclen;- while ((char \*) de <= kaddr) {- if (de->rec\_len == 0) {- nilfs\_error(dir->i\_sb,- "zero-length directory entry");- nilfs\_put\_page(page);- goto out;- }- if (nilfs\_match(namelen, name, de))- goto found;- de = nilfs\_next\_entry(de);+ if (IS\_ERR(kaddr))+ return ERR\_CAST(kaddr);++ de = (struct nilfs\_dir\_entry \*)kaddr;+ kaddr += nilfs\_last\_byte(dir, n) - reclen;+ while ((char \*)de <= kaddr) {+ if (de->rec\_len == 0) {+ nilfs\_error(dir->i\_sb,+ "zero-length directory entry");+ nilfs\_put\_page(page);+ goto out; }- nilfs\_put\_page(page);+ if (nilfs\_match(namelen, name, de))+ goto found;+ de = nilfs\_next\_entry(de); }+ nilfs\_put\_page(page);+ if (++n >= npages) n = 0; /\* next page is past the blocks we've got \*/@@ -386,7 +390,7 @@ nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, } } while (n != start); out:- return NULL;+ return ERR\_PTR(-ENOENT);  found: \*res\_page = page;@@ -431,19 +435,19 @@ fail: return NULL; } -ino\_t nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr)+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino) {- ino\_t res = 0; struct nilfs\_dir\_entry \*de; struct page \*page;  de = nilfs\_find\_entry(dir, qstr, &page);- if (de) {- res = le64\_to\_cpu(de->inode);- kunmap(page);- put\_page(page);- }- return res;+ if (IS\_ERR(de))+ return PTR\_ERR(de);++ \*ino = le64\_to\_cpu(de->inode);+ kunmap(page);+ put\_page(page);+ return 0; }  /\* Releases the page \*/diff --git a/fs/nilfs2/namei.c b/fs/nilfs2/namei.cindex a6ec7961d4f5af..08c6d985edeb6f 100644--- a/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=4aa8948673dc395262301386aecda9f9b11af8f0)+++ b/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475)@@ -55,12 +55,20 @@ nilfs\_lookup(struct inode \*dir, struct dentry \*dentry, unsigned int flags) { struct inode \*inode; ino\_t ino;+ int res;  if (dentry->d\_name.len > NILFS\_NAME\_LEN) return ERR\_PTR(-ENAMETOOLONG); - ino = nilfs\_inode\_by\_name(dir, &dentry->d\_name);- inode = ino ? nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino) : NULL;+ res = nilfs\_inode\_by\_name(dir, &dentry->d\_name, &ino);+ if (res) {+ if (res != -ENOENT)+ return ERR\_PTR(res);+ inode = NULL;+ } else {+ inode = nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino);+ }+ return d\_splice\_alias(inode, dentry); } @@ -261,10 +269,11 @@ static int nilfs\_do\_unlink(struct inode \*dir, struct dentry \*dentry) struct page \*page; int err; - err = -ENOENT; de = nilfs\_find\_entry(dir, &dentry->d\_name, &page);- if (!de)+ if (IS\_ERR(de)) {+ err = PTR\_ERR(de); goto out;+ }  inode = d\_inode(dentry); err = -EIO;@@ -358,10 +367,11 @@ static int nilfs\_rename(struct inode \*old\_dir, struct dentry \*old\_dentry, if (unlikely(err)) return err; - err = -ENOENT; old\_de = nilfs\_find\_entry(old\_dir, &old\_dentry->d\_name, &old\_page);- if (!old\_de)+ if (IS\_ERR(old\_de)) {+ err = PTR\_ERR(old\_de); goto out;+ }  if (S\_ISDIR(old\_inode->i\_mode)) { err = -EIO;@@ -378,10 +388,12 @@ static int nilfs\_rename(struct inode \*old\_dir, struct dentry \*old\_dentry, if (dir\_de && !nilfs\_empty\_dir(new\_inode)) goto out\_dir; - err = -ENOENT;- new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name, &new\_page);- if (!new\_de)+ new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name,+ &new\_page);+ if (IS\_ERR(new\_de)) {+ err = PTR\_ERR(new\_de); goto out\_dir;+ } nilfs\_set\_link(new\_dir, new\_de, new\_page, old\_inode); nilfs\_mark\_inode\_dirty(new\_dir); new\_inode->i\_ctime = current\_time(new\_inode);@@ -435,14 +447,15 @@ out: \*/ static struct dentry \*nilfs\_get\_parent(struct dentry \*child) {- unsigned long ino;+ ino\_t ino;+ int res; struct inode \*inode; struct qstr dotdot = QSTR\_INIT("..", 2); struct nilfs\_root \*root; - ino = nilfs\_inode\_by\_name(d\_inode(child), &dotdot);- if (!ino)- return ERR\_PTR(-ENOENT);+ res = nilfs\_inode\_by\_name(d\_inode(child), &dotdot, &ino);+ if (res)+ return ERR\_PTR(res);  root = NILFS\_I(d\_inode(child))->i\_root; diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 7a1243c7a74a95..973231603ff6ba 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=4aa8948673dc395262301386aecda9f9b11af8f0)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=b4b3dc9e7e604be98a222e9f941f5e93798ca475)@@ -233,7 +233,7 @@ static inline \_\_u32 nilfs\_mask\_flags(umode\_t mode, \_\_u32 flags)  /\* dir.c \*/ extern int nilfs\_add\_link(struct dentry \*, struct inode \*);-extern ino\_t nilfs\_inode\_by\_name(struct inode \*, const struct qstr \*);+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino); extern int nilfs\_make\_empty(struct inode \*, struct inode \*); extern struct nilfs\_dir\_entry \* nilfs\_find\_entry(struct inode \*, const struct qstr \*, struct page \*\*); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:20:34 +0000



=== Content from git.kernel.org_72bc8d28_20250114_232153.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=08cfa12adf888db98879dbd735bc741360a34168)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08cfa12adf888db98879dbd735bc741360a34168)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08cfa12adf888db98879dbd735bc741360a34168)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08cfa12adf888db98879dbd735bc741360a34168)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-10-04 12:35:31 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-10-17 00:28:06 -0700 |
| commit | [08cfa12adf888db98879dbd735bc741360a34168](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08cfa12adf888db98879dbd735bc741360a34168) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=08cfa12adf888db98879dbd735bc741360a34168)) | |
| tree | [070ef5d743a73de2b72d91ad3059983ad7d03126](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08cfa12adf888db98879dbd735bc741360a34168) | |
| parent | [74874c57939444b19993fe3dd6c0b70aba4f468c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74874c57939444b19993fe3dd6c0b70aba4f468c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08cfa12adf888db98879dbd735bc741360a34168&id2=74874c57939444b19993fe3dd6c0b70aba4f468c)) | |
| download | [linux-08cfa12adf888db98879dbd735bc741360a34168.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-08cfa12adf888db98879dbd735bc741360a34168.tar.gz) | |

nilfs2: propagate directory read errors from nilfs\_find\_entry()Syzbot reported that a task hang occurs in vcs\_open() during a fuzzing
test for nilfs2.
The root cause of this problem is that in nilfs\_find\_entry(), which
searches for directory entries, ignores errors when loading a directory
page/folio via nilfs\_get\_folio() fails.
If the filesystem images is corrupted, and the i\_size of the directory
inode is large, and the directory page/folio is successfully read but
fails the sanity check, for example when it is zero-filled,
nilfs\_check\_folio() may continue to spit out error messages in bursts.
Fix this issue by propagating the error to the callers when loading a
page/folio fails in nilfs\_find\_entry().
The current interface of nilfs\_find\_entry() and its callers is outdated
and cannot propagate error codes such as -EIO and -ENOMEM returned via
nilfs\_find\_entry(), so fix it together.
Link: [https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20241004033640.6841-1-konishi.ryusuke%40gmail.com)
Fixes: 2ba466d74ed7 ("nilfs2: directory entry operations")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: Lizhi Xu <lizhi.xu@windriver.com>
Closes: https://lkml.kernel.org/r/20240927013806.3577931-1-lizhi.xu@windriver.com
Reported-by: syzbot+8a192e8d090fa9a31135@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=8a192e8d090fa9a31135
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08cfa12adf888db98879dbd735bc741360a34168)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=08cfa12adf888db98879dbd735bc741360a34168) | 48 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/namei.c?id=08cfa12adf888db98879dbd735bc741360a34168) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=08cfa12adf888db98879dbd735bc741360a34168) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 52 insertions, 37 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex fe5b1a30c509db..a8602729586ab7 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=74874c57939444b19993fe3dd6c0b70aba4f468c)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=08cfa12adf888db98879dbd735bc741360a34168)@@ -289,7 +289,7 @@ static int nilfs\_readdir(struct file \*file, struct dir\_context \*ctx) \* The folio is mapped and unlocked. When the caller is finished with \* the entry, it should call folio\_release\_kmap(). \*- \* On failure, returns NULL and the caller should ignore foliop.+ \* On failure, returns an error pointer and the caller should ignore foliop. \*/ struct nilfs\_dir\_entry \*nilfs\_find\_entry(struct inode \*dir, const struct qstr \*qstr, struct folio \*\*foliop)@@ -312,22 +312,24 @@ struct nilfs\_dir\_entry \*nilfs\_find\_entry(struct inode \*dir, do { char \*kaddr = nilfs\_get\_folio(dir, n, foliop); - if (!IS\_ERR(kaddr)) {- de = (struct nilfs\_dir\_entry \*)kaddr;- kaddr += nilfs\_last\_byte(dir, n) - reclen;- while ((char \*) de <= kaddr) {- if (de->rec\_len == 0) {- nilfs\_error(dir->i\_sb,- "zero-length directory entry");- folio\_release\_kmap(\*foliop, kaddr);- goto out;- }- if (nilfs\_match(namelen, name, de))- goto found;- de = nilfs\_next\_entry(de);+ if (IS\_ERR(kaddr))+ return ERR\_CAST(kaddr);++ de = (struct nilfs\_dir\_entry \*)kaddr;+ kaddr += nilfs\_last\_byte(dir, n) - reclen;+ while ((char \*)de <= kaddr) {+ if (de->rec\_len == 0) {+ nilfs\_error(dir->i\_sb,+ "zero-length directory entry");+ folio\_release\_kmap(\*foliop, kaddr);+ goto out; }- folio\_release\_kmap(\*foliop, kaddr);+ if (nilfs\_match(namelen, name, de))+ goto found;+ de = nilfs\_next\_entry(de); }+ folio\_release\_kmap(\*foliop, kaddr);+ if (++n >= npages) n = 0; /\* next folio is past the blocks we've got \*/@@ -340,7 +342,7 @@ struct nilfs\_dir\_entry \*nilfs\_find\_entry(struct inode \*dir, } } while (n != start); out:- return NULL;+ return ERR\_PTR(-ENOENT);  found: ei->i\_dir\_start\_lookup = n;@@ -384,18 +386,18 @@ fail: return NULL; } -ino\_t nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr)+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino) {- ino\_t res = 0; struct nilfs\_dir\_entry \*de; struct folio \*folio;  de = nilfs\_find\_entry(dir, qstr, &folio);- if (de) {- res = le64\_to\_cpu(de->inode);- folio\_release\_kmap(folio, de);- }- return res;+ if (IS\_ERR(de))+ return PTR\_ERR(de);++ \*ino = le64\_to\_cpu(de->inode);+ folio\_release\_kmap(folio, de);+ return 0; }  void nilfs\_set\_link(struct inode \*dir, struct nilfs\_dir\_entry \*de,diff --git a/fs/nilfs2/namei.c b/fs/nilfs2/namei.cindex c950139db6ef0d..4905063790c578 100644--- a/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=74874c57939444b19993fe3dd6c0b70aba4f468c)+++ b/[fs/nilfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/namei.c?id=08cfa12adf888db98879dbd735bc741360a34168)@@ -55,12 +55,20 @@ nilfs\_lookup(struct inode \*dir, struct dentry \*dentry, unsigned int flags) { struct inode \*inode; ino\_t ino;+ int res;  if (dentry->d\_name.len > NILFS\_NAME\_LEN) return ERR\_PTR(-ENAMETOOLONG); - ino = nilfs\_inode\_by\_name(dir, &dentry->d\_name);- inode = ino ? nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino) : NULL;+ res = nilfs\_inode\_by\_name(dir, &dentry->d\_name, &ino);+ if (res) {+ if (res != -ENOENT)+ return ERR\_PTR(res);+ inode = NULL;+ } else {+ inode = nilfs\_iget(dir->i\_sb, NILFS\_I(dir)->i\_root, ino);+ }+ return d\_splice\_alias(inode, dentry); } @@ -263,10 +271,11 @@ static int nilfs\_do\_unlink(struct inode \*dir, struct dentry \*dentry) struct folio \*folio; int err; - err = -ENOENT; de = nilfs\_find\_entry(dir, &dentry->d\_name, &folio);- if (!de)+ if (IS\_ERR(de)) {+ err = PTR\_ERR(de); goto out;+ }  inode = d\_inode(dentry); err = -EIO;@@ -362,10 +371,11 @@ static int nilfs\_rename(struct mnt\_idmap \*idmap, if (unlikely(err)) return err; - err = -ENOENT; old\_de = nilfs\_find\_entry(old\_dir, &old\_dentry->d\_name, &old\_folio);- if (!old\_de)+ if (IS\_ERR(old\_de)) {+ err = PTR\_ERR(old\_de); goto out;+ }  if (S\_ISDIR(old\_inode->i\_mode)) { err = -EIO;@@ -382,10 +392,12 @@ static int nilfs\_rename(struct mnt\_idmap \*idmap, if (dir\_de && !nilfs\_empty\_dir(new\_inode)) goto out\_dir; - err = -ENOENT;- new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name, &new\_folio);- if (!new\_de)+ new\_de = nilfs\_find\_entry(new\_dir, &new\_dentry->d\_name,+ &new\_folio);+ if (IS\_ERR(new\_de)) {+ err = PTR\_ERR(new\_de); goto out\_dir;+ } nilfs\_set\_link(new\_dir, new\_de, new\_folio, old\_inode); folio\_release\_kmap(new\_folio, new\_de); nilfs\_mark\_inode\_dirty(new\_dir);@@ -440,12 +452,13 @@ out: \*/ static struct dentry \*nilfs\_get\_parent(struct dentry \*child) {- unsigned long ino;+ ino\_t ino;+ int res; struct nilfs\_root \*root; - ino = nilfs\_inode\_by\_name(d\_inode(child), &dotdot\_name);- if (!ino)- return ERR\_PTR(-ENOENT);+ res = nilfs\_inode\_by\_name(d\_inode(child), &dotdot\_name, &ino);+ if (res)+ return ERR\_PTR(res);  root = NILFS\_I(d\_inode(child))->i\_root; diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex fb1c4c5bae7c11..45d03826eaf157 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=74874c57939444b19993fe3dd6c0b70aba4f468c)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=08cfa12adf888db98879dbd735bc741360a34168)@@ -254,7 +254,7 @@ static inline \_\_u32 nilfs\_mask\_flags(umode\_t mode, \_\_u32 flags)  /\* dir.c \*/ int nilfs\_add\_link(struct dentry \*, struct inode \*);-ino\_t nilfs\_inode\_by\_name(struct inode \*, const struct qstr \*);+int nilfs\_inode\_by\_name(struct inode \*dir, const struct qstr \*qstr, ino\_t \*ino); int nilfs\_make\_empty(struct inode \*, struct inode \*); struct nilfs\_dir\_entry \*nilfs\_find\_entry(struct inode \*, const struct qstr \*, struct folio \*\*); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:20:30 +0000


