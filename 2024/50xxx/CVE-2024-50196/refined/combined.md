=== Content from git.kernel.org_915270f2_20250115_080346.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4a81800ef05bea5a9896f199677f7b7f5020776a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a81800ef05bea5a9896f199677f7b7f5020776a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a81800ef05bea5a9896f199677f7b7f5020776a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a81800ef05bea5a9896f199677f7b7f5020776a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sergey Matsievskiy <matsievskiysv@gmail.com> | 2024-10-12 13:57:43 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:56:50 +0200 |
| commit | [4a81800ef05bea5a9896f199677f7b7f5020776a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a81800ef05bea5a9896f199677f7b7f5020776a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4a81800ef05bea5a9896f199677f7b7f5020776a)) | |
| tree | [f1f5fbc1ba2fcf7b20d59b126df460867580207c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a81800ef05bea5a9896f199677f7b7f5020776a) | |
| parent | [bf171b5e86e41de4c1cf32fb7aefa275c3d7de49](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf171b5e86e41de4c1cf32fb7aefa275c3d7de49) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a81800ef05bea5a9896f199677f7b7f5020776a&id2=bf171b5e86e41de4c1cf32fb7aefa275c3d7de49)) | |
| download | [linux-4a81800ef05bea5a9896f199677f7b7f5020776a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4a81800ef05bea5a9896f199677f7b7f5020776a.tar.gz) | |

pinctrl: ocelot: fix system hang on level based interruptscommit 93b8ddc54507a227087c60a0013ed833b6ae7d3c upstream.
The current implementation only calls chained\_irq\_enter() and
chained\_irq\_exit() if it detects pending interrupts.
```
for (i = 0; i < info->stride; i++) {
uregmap\_read(info->map, id\_reg + 4 \* i, &reg);
if (!reg)
continue;
chained\_irq\_enter(parent\_chip, desc);
```
However, in case of GPIO pin configured in level mode and the parent
controller configured in edge mode, GPIO interrupt might be lowered by the
hardware. In the result, if the interrupt is short enough, the parent
interrupt is still pending while the GPIO interrupt is cleared;
chained\_irq\_enter() never gets called and the system hangs trying to
service the parent interrupt.
Moving chained\_irq\_enter() and chained\_irq\_exit() outside the for loop
ensures that they are called even when GPIO interrupt is lowered by the
hardware.
The similar code with chained\_irq\_enter() / chained\_irq\_exit() functions
wrapping interrupt checking loop may be found in many other drivers:
```
grep -r -A 10 chained\_irq\_enter drivers/pinctrl
```
Cc: stable@vger.kernel.org
Signed-off-by: Sergey Matsievskiy <matsievskiysv@gmail.com>
Reviewed-by: Alexandre Belloni <alexandre.belloni@bootlin.com>
Link: [https://lore.kernel.org/20241012105743.12450-2-matsievskiysv@gmail.com](https://lore.kernel.org/20241012105743.12450-2-matsievskiysv%40gmail.com)
Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a81800ef05bea5a9896f199677f7b7f5020776a)

| -rw-r--r-- | [drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pinctrl/pinctrl-ocelot.c?id=4a81800ef05bea5a9896f199677f7b7f5020776a) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/pinctrl/pinctrl-ocelot.c b/drivers/pinctrl/pinctrl-ocelot.cindex c1d58939dd89ad..83b415e1cec164 100644--- a/[drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pinctrl/pinctrl-ocelot.c?id=bf171b5e86e41de4c1cf32fb7aefa275c3d7de49)+++ b/[drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pinctrl/pinctrl-ocelot.c?id=4a81800ef05bea5a9896f199677f7b7f5020776a)@@ -1962,21 +1962,21 @@ static void ocelot\_irq\_handler(struct irq\_desc \*desc) unsigned int reg = 0, irq, i; unsigned long irqs; + chained\_irq\_enter(parent\_chip, desc);+ for (i = 0; i < info->stride; i++) { regmap\_read(info->map, id\_reg + 4 \* i, &reg); if (!reg) continue; - chained\_irq\_enter(parent\_chip, desc);- irqs = reg;  for\_each\_set\_bit(irq, &irqs, min(32U, info->desc->npins - 32 \* i)) generic\_handle\_domain\_irq(chip->irq.domain, irq + 32 \* i);-- chained\_irq\_exit(parent\_chip, desc); }++ chained\_irq\_exit(parent\_chip, desc); }  static int ocelot\_gpiochip\_register(struct platform\_device \*pdev, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:02:24 +0000



=== Content from git.kernel.org_15601334_20250115_080349.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dcbe9954634807ec54e22bde278b5b269f921381)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dcbe9954634807ec54e22bde278b5b269f921381)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcbe9954634807ec54e22bde278b5b269f921381)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcbe9954634807ec54e22bde278b5b269f921381)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sergey Matsievskiy <matsievskiysv@gmail.com> | 2024-10-12 13:57:43 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:51:35 +0200 |
| commit | [dcbe9954634807ec54e22bde278b5b269f921381](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcbe9954634807ec54e22bde278b5b269f921381) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dcbe9954634807ec54e22bde278b5b269f921381)) | |
| tree | [b7707492688c01ce2fe115ff1c78bf6cf8702f4a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dcbe9954634807ec54e22bde278b5b269f921381) | |
| parent | [be3f7b9f995a6c2ee02767a0319929a2a98adf69](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be3f7b9f995a6c2ee02767a0319929a2a98adf69) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcbe9954634807ec54e22bde278b5b269f921381&id2=be3f7b9f995a6c2ee02767a0319929a2a98adf69)) | |
| download | [linux-dcbe9954634807ec54e22bde278b5b269f921381.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dcbe9954634807ec54e22bde278b5b269f921381.tar.gz) | |

pinctrl: ocelot: fix system hang on level based interruptscommit 93b8ddc54507a227087c60a0013ed833b6ae7d3c upstream.
The current implementation only calls chained\_irq\_enter() and
chained\_irq\_exit() if it detects pending interrupts.
```
for (i = 0; i < info->stride; i++) {
uregmap\_read(info->map, id\_reg + 4 \* i, &reg);
if (!reg)
continue;
chained\_irq\_enter(parent\_chip, desc);
```
However, in case of GPIO pin configured in level mode and the parent
controller configured in edge mode, GPIO interrupt might be lowered by the
hardware. In the result, if the interrupt is short enough, the parent
interrupt is still pending while the GPIO interrupt is cleared;
chained\_irq\_enter() never gets called and the system hangs trying to
service the parent interrupt.
Moving chained\_irq\_enter() and chained\_irq\_exit() outside the for loop
ensures that they are called even when GPIO interrupt is lowered by the
hardware.
The similar code with chained\_irq\_enter() / chained\_irq\_exit() functions
wrapping interrupt checking loop may be found in many other drivers:
```
grep -r -A 10 chained\_irq\_enter drivers/pinctrl
```
Cc: stable@vger.kernel.org
Signed-off-by: Sergey Matsievskiy <matsievskiysv@gmail.com>
Reviewed-by: Alexandre Belloni <alexandre.belloni@bootlin.com>
Link: [https://lore.kernel.org/20241012105743.12450-2-matsievskiysv@gmail.com](https://lore.kernel.org/20241012105743.12450-2-matsievskiysv%40gmail.com)
Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcbe9954634807ec54e22bde278b5b269f921381)

| -rw-r--r-- | [drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pinctrl/pinctrl-ocelot.c?id=dcbe9954634807ec54e22bde278b5b269f921381) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/pinctrl/pinctrl-ocelot.c b/drivers/pinctrl/pinctrl-ocelot.cindex be9b8c01016708..d1ab8450ea93eb 100644--- a/[drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pinctrl/pinctrl-ocelot.c?id=be3f7b9f995a6c2ee02767a0319929a2a98adf69)+++ b/[drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pinctrl/pinctrl-ocelot.c?id=dcbe9954634807ec54e22bde278b5b269f921381)@@ -1955,21 +1955,21 @@ static void ocelot\_irq\_handler(struct irq\_desc \*desc) unsigned int reg = 0, irq, i; unsigned long irqs; + chained\_irq\_enter(parent\_chip, desc);+ for (i = 0; i < info->stride; i++) { regmap\_read(info->map, id\_reg + 4 \* i, &reg); if (!reg) continue; - chained\_irq\_enter(parent\_chip, desc);- irqs = reg;  for\_each\_set\_bit(irq, &irqs, min(32U, info->desc->npins - 32 \* i)) generic\_handle\_domain\_irq(chip->irq.domain, irq + 32 \* i);-- chained\_irq\_exit(parent\_chip, desc); }++ chained\_irq\_exit(parent\_chip, desc); }  static int ocelot\_gpiochip\_register(struct platform\_device \*pdev, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:02:26 +0000



=== Content from git.kernel.org_9a9cab77_20250115_080348.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sergey Matsievskiy <matsievskiysv@gmail.com> | 2024-10-12 13:57:43 +0300 |
| --- | --- | --- |
| committer | Linus Walleij <linus.walleij@linaro.org> | 2024-10-12 22:04:38 +0200 |
| commit | [93b8ddc54507a227087c60a0013ed833b6ae7d3c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c)) | |
| tree | [69ba3bf37f0eed038765f9b27e2ee0858c5da781](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c) | |
| parent | [3fd976afe9743110f20a23f93b7ff9693f2be4bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3fd976afe9743110f20a23f93b7ff9693f2be4bf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c&id2=3fd976afe9743110f20a23f93b7ff9693f2be4bf)) | |
| download | [linux-93b8ddc54507a227087c60a0013ed833b6ae7d3c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-93b8ddc54507a227087c60a0013ed833b6ae7d3c.tar.gz) | |

pinctrl: ocelot: fix system hang on level based interruptsThe current implementation only calls chained\_irq\_enter() and
chained\_irq\_exit() if it detects pending interrupts.
```
for (i = 0; i < info->stride; i++) {
uregmap\_read(info->map, id\_reg + 4 \* i, &reg);
if (!reg)
continue;
chained\_irq\_enter(parent\_chip, desc);
```
However, in case of GPIO pin configured in level mode and the parent
controller configured in edge mode, GPIO interrupt might be lowered by the
hardware. In the result, if the interrupt is short enough, the parent
interrupt is still pending while the GPIO interrupt is cleared;
chained\_irq\_enter() never gets called and the system hangs trying to
service the parent interrupt.
Moving chained\_irq\_enter() and chained\_irq\_exit() outside the for loop
ensures that they are called even when GPIO interrupt is lowered by the
hardware.
The similar code with chained\_irq\_enter() / chained\_irq\_exit() functions
wrapping interrupt checking loop may be found in many other drivers:
```
grep -r -A 10 chained\_irq\_enter drivers/pinctrl
```
Cc: stable@vger.kernel.org
Signed-off-by: Sergey Matsievskiy <matsievskiysv@gmail.com>
Reviewed-by: Alexandre Belloni <alexandre.belloni@bootlin.com>
Link: [https://lore.kernel.org/20241012105743.12450-2-matsievskiysv@gmail.com](https://lore.kernel.org/20241012105743.12450-2-matsievskiysv%40gmail.com)
Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c)

| -rw-r--r-- | [drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pinctrl/pinctrl-ocelot.c?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/pinctrl/pinctrl-ocelot.c b/drivers/pinctrl/pinctrl-ocelot.cindex be9b8c01016708..d1ab8450ea93eb 100644--- a/[drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pinctrl/pinctrl-ocelot.c?id=3fd976afe9743110f20a23f93b7ff9693f2be4bf)+++ b/[drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pinctrl/pinctrl-ocelot.c?id=93b8ddc54507a227087c60a0013ed833b6ae7d3c)@@ -1955,21 +1955,21 @@ static void ocelot\_irq\_handler(struct irq\_desc \*desc) unsigned int reg = 0, irq, i; unsigned long irqs; + chained\_irq\_enter(parent\_chip, desc);+ for (i = 0; i < info->stride; i++) { regmap\_read(info->map, id\_reg + 4 \* i, &reg); if (!reg) continue; - chained\_irq\_enter(parent\_chip, desc);- irqs = reg;  for\_each\_set\_bit(irq, &irqs, min(32U, info->desc->npins - 32 \* i)) generic\_handle\_domain\_irq(chip->irq.domain, irq + 32 \* i);-- chained\_irq\_exit(parent\_chip, desc); }++ chained\_irq\_exit(parent\_chip, desc); }  static int ocelot\_gpiochip\_register(struct platform\_device \*pdev, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:02:26 +0000



=== Content from git.kernel.org_6df1b796_20250115_080346.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=20728e86289ab463b99b7ab4425515bd26aba417)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20728e86289ab463b99b7ab4425515bd26aba417)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20728e86289ab463b99b7ab4425515bd26aba417)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20728e86289ab463b99b7ab4425515bd26aba417)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sergey Matsievskiy <matsievskiysv@gmail.com> | 2024-10-12 13:57:43 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:46:34 +0200 |
| commit | [20728e86289ab463b99b7ab4425515bd26aba417](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20728e86289ab463b99b7ab4425515bd26aba417) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=20728e86289ab463b99b7ab4425515bd26aba417)) | |
| tree | [c817e5f39b102d6f7610a80c577c82774f401b64](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20728e86289ab463b99b7ab4425515bd26aba417) | |
| parent | [481b477ab63c7245715a3e57ba79eb87c2dc0d02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=481b477ab63c7245715a3e57ba79eb87c2dc0d02) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20728e86289ab463b99b7ab4425515bd26aba417&id2=481b477ab63c7245715a3e57ba79eb87c2dc0d02)) | |
| download | [linux-20728e86289ab463b99b7ab4425515bd26aba417.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-20728e86289ab463b99b7ab4425515bd26aba417.tar.gz) | |

pinctrl: ocelot: fix system hang on level based interruptscommit 93b8ddc54507a227087c60a0013ed833b6ae7d3c upstream.
The current implementation only calls chained\_irq\_enter() and
chained\_irq\_exit() if it detects pending interrupts.
```
for (i = 0; i < info->stride; i++) {
uregmap\_read(info->map, id\_reg + 4 \* i, &reg);
if (!reg)
continue;
chained\_irq\_enter(parent\_chip, desc);
```
However, in case of GPIO pin configured in level mode and the parent
controller configured in edge mode, GPIO interrupt might be lowered by the
hardware. In the result, if the interrupt is short enough, the parent
interrupt is still pending while the GPIO interrupt is cleared;
chained\_irq\_enter() never gets called and the system hangs trying to
service the parent interrupt.
Moving chained\_irq\_enter() and chained\_irq\_exit() outside the for loop
ensures that they are called even when GPIO interrupt is lowered by the
hardware.
The similar code with chained\_irq\_enter() / chained\_irq\_exit() functions
wrapping interrupt checking loop may be found in many other drivers:
```
grep -r -A 10 chained\_irq\_enter drivers/pinctrl
```
Cc: stable@vger.kernel.org
Signed-off-by: Sergey Matsievskiy <matsievskiysv@gmail.com>
Reviewed-by: Alexandre Belloni <alexandre.belloni@bootlin.com>
Link: [https://lore.kernel.org/20241012105743.12450-2-matsievskiysv@gmail.com](https://lore.kernel.org/20241012105743.12450-2-matsievskiysv%40gmail.com)
Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20728e86289ab463b99b7ab4425515bd26aba417)

| -rw-r--r-- | [drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pinctrl/pinctrl-ocelot.c?id=20728e86289ab463b99b7ab4425515bd26aba417) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/pinctrl/pinctrl-ocelot.c b/drivers/pinctrl/pinctrl-ocelot.cindex f8ae2e9742217c..8d26c8061c77eb 100644--- a/[drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pinctrl/pinctrl-ocelot.c?id=481b477ab63c7245715a3e57ba79eb87c2dc0d02)+++ b/[drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pinctrl/pinctrl-ocelot.c?id=20728e86289ab463b99b7ab4425515bd26aba417)@@ -1962,21 +1962,21 @@ static void ocelot\_irq\_handler(struct irq\_desc \*desc) unsigned int reg = 0, irq, i; unsigned long irqs; + chained\_irq\_enter(parent\_chip, desc);+ for (i = 0; i < info->stride; i++) { regmap\_read(info->map, id\_reg + 4 \* i, &reg); if (!reg) continue; - chained\_irq\_enter(parent\_chip, desc);- irqs = reg;  for\_each\_set\_bit(irq, &irqs, min(32U, info->desc->npins - 32 \* i)) generic\_handle\_domain\_irq(chip->irq.domain, irq + 32 \* i);-- chained\_irq\_exit(parent\_chip, desc); }++ chained\_irq\_exit(parent\_chip, desc); }  static int ocelot\_gpiochip\_register(struct platform\_device \*pdev, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:02:24 +0000



=== Content from git.kernel.org_d5a8539a_20250115_080348.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=655f5d4662b958122b260be05aa6dfdf8768efe6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=655f5d4662b958122b260be05aa6dfdf8768efe6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=655f5d4662b958122b260be05aa6dfdf8768efe6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=655f5d4662b958122b260be05aa6dfdf8768efe6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sergey Matsievskiy <matsievskiysv@gmail.com> | 2024-10-12 13:57:43 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:40:46 +0200 |
| commit | [655f5d4662b958122b260be05aa6dfdf8768efe6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=655f5d4662b958122b260be05aa6dfdf8768efe6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=655f5d4662b958122b260be05aa6dfdf8768efe6)) | |
| tree | [a93a9f05834789f4fba199c19a12af7a9a6aa44a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=655f5d4662b958122b260be05aa6dfdf8768efe6) | |
| parent | [b6400eb0b347821efc57760221f8fb6d63b9548a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6400eb0b347821efc57760221f8fb6d63b9548a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=655f5d4662b958122b260be05aa6dfdf8768efe6&id2=b6400eb0b347821efc57760221f8fb6d63b9548a)) | |
| download | [linux-655f5d4662b958122b260be05aa6dfdf8768efe6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-655f5d4662b958122b260be05aa6dfdf8768efe6.tar.gz) | |

pinctrl: ocelot: fix system hang on level based interruptscommit 93b8ddc54507a227087c60a0013ed833b6ae7d3c upstream.
The current implementation only calls chained\_irq\_enter() and
chained\_irq\_exit() if it detects pending interrupts.
```
for (i = 0; i < info->stride; i++) {
uregmap\_read(info->map, id\_reg + 4 \* i, &reg);
if (!reg)
continue;
chained\_irq\_enter(parent\_chip, desc);
```
However, in case of GPIO pin configured in level mode and the parent
controller configured in edge mode, GPIO interrupt might be lowered by the
hardware. In the result, if the interrupt is short enough, the parent
interrupt is still pending while the GPIO interrupt is cleared;
chained\_irq\_enter() never gets called and the system hangs trying to
service the parent interrupt.
Moving chained\_irq\_enter() and chained\_irq\_exit() outside the for loop
ensures that they are called even when GPIO interrupt is lowered by the
hardware.
The similar code with chained\_irq\_enter() / chained\_irq\_exit() functions
wrapping interrupt checking loop may be found in many other drivers:
```
grep -r -A 10 chained\_irq\_enter drivers/pinctrl
```
Cc: stable@vger.kernel.org
Signed-off-by: Sergey Matsievskiy <matsievskiysv@gmail.com>
Reviewed-by: Alexandre Belloni <alexandre.belloni@bootlin.com>
Link: [https://lore.kernel.org/20241012105743.12450-2-matsievskiysv@gmail.com](https://lore.kernel.org/20241012105743.12450-2-matsievskiysv%40gmail.com)
Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=655f5d4662b958122b260be05aa6dfdf8768efe6)

| -rw-r--r-- | [drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pinctrl/pinctrl-ocelot.c?id=655f5d4662b958122b260be05aa6dfdf8768efe6) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/pinctrl/pinctrl-ocelot.c b/drivers/pinctrl/pinctrl-ocelot.cindex b14f1b7a625ec2..9f1b88fa33b47d 100644--- a/[drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pinctrl/pinctrl-ocelot.c?id=b6400eb0b347821efc57760221f8fb6d63b9548a)+++ b/[drivers/pinctrl/pinctrl-ocelot.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pinctrl/pinctrl-ocelot.c?id=655f5d4662b958122b260be05aa6dfdf8768efe6)@@ -1279,21 +1279,21 @@ static void ocelot\_irq\_handler(struct irq\_desc \*desc) unsigned int reg = 0, irq, i; unsigned long irqs; + chained\_irq\_enter(parent\_chip, desc);+ for (i = 0; i < info->stride; i++) { regmap\_read(info->map, id\_reg + 4 \* i, &reg); if (!reg) continue; - chained\_irq\_enter(parent\_chip, desc);- irqs = reg;  for\_each\_set\_bit(irq, &irqs, min(32U, info->desc->npins - 32 \* i)) generic\_handle\_domain\_irq(chip->irq.domain, irq + 32 \* i);-- chained\_irq\_exit(parent\_chip, desc); }++ chained\_irq\_exit(parent\_chip, desc); }  static int ocelot\_gpiochip\_register(struct platform\_device \*pdev, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:02:25 +0000


