=== Content from git.kernel.org_e27fd043_20250115_093603.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2024-11-04 13:43:06 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:19:35 +0100 |
| commit | [1f993777275cbd8f74765c4f9d9285cb907c9be5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f993777275cbd8f74765c4f9d9285cb907c9be5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)) | |
| tree | [0ba78fe342f85c4552b46a76713dbcd7768818d2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f993777275cbd8f74765c4f9d9285cb907c9be5) | |
| parent | [e923503a56b3385b64ae492e3225e4623f560c5b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e923503a56b3385b64ae492e3225e4623f560c5b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f993777275cbd8f74765c4f9d9285cb907c9be5&id2=e923503a56b3385b64ae492e3225e4623f560c5b)) | |
| download | [linux-1f993777275cbd8f74765c4f9d9285cb907c9be5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1f993777275cbd8f74765c4f9d9285cb907c9be5.tar.gz) | |

ksmbd: check outstanding simultaneous SMB operationscommit 0a77d947f599b1f39065015bec99390d0c0022ee upstream.
If Client send simultaneous SMB operations to ksmbd, It exhausts too much
memory through the "ksmbd\_work\_cache‚Äù. It will cause OOM issue.
ksmbd has a credit mechanism but it can't handle this problem. This patch
add the check if it exceeds max credits to prevent this problem by assuming
that one smb request consumes at least one credit.
Cc: stable@vger.kernel.org # v5.15+
Reported-by: Norbert Szetei <norbert@doyensec.com>
Tested-by: Norbert Szetei <norbert@doyensec.com>
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)

| -rw-r--r-- | [fs/smb/server/connection.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/connection.c?id=1f993777275cbd8f74765c4f9d9285cb907c9be5) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/server/connection.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/connection.h?id=1f993777275cbd8f74765c4f9d9285cb907c9be5) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/smb/server/server.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/server.c?id=1f993777275cbd8f74765c4f9d9285cb907c9be5) | 16 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/smb/server/smb\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb_common.c?id=1f993777275cbd8f74765c4f9d9285cb907c9be5) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/smb/server/smb\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb_common.h?id=1f993777275cbd8f74765c4f9d9285cb907c9be5) | 2 | |  |  |  | | --- | --- | --- | |

5 files changed, 20 insertions, 10 deletions

| diff --git a/fs/smb/server/connection.c b/fs/smb/server/connection.cindex cac80e7bfefc74..a751793c4512af 100644--- a/[fs/smb/server/connection.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.c?id=e923503a56b3385b64ae492e3225e4623f560c5b)+++ b/[fs/smb/server/connection.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.c?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)@@ -70,6 +70,7 @@ struct ksmbd\_conn \*ksmbd\_conn\_alloc(void) atomic\_set(&conn->req\_running, 0); atomic\_set(&conn->r\_count, 0); atomic\_set(&conn->refcnt, 1);+ atomic\_set(&conn->mux\_smb\_requests, 0); conn->total\_credits = 1; conn->outstanding\_credits = 0; diff --git a/fs/smb/server/connection.h b/fs/smb/server/connection.hindex 82343afc8d0499..368295fb18a70c 100644--- a/[fs/smb/server/connection.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.h?id=e923503a56b3385b64ae492e3225e4623f560c5b)+++ b/[fs/smb/server/connection.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.h?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)@@ -107,6 +107,7 @@ struct ksmbd\_conn { \_\_le16 signing\_algorithm; bool binding; atomic\_t refcnt;+ atomic\_t mux\_smb\_requests; };  struct ksmbd\_conn\_ops {diff --git a/fs/smb/server/server.c b/fs/smb/server/server.cindex d5d85300560d03..f098dd17ae9a5a 100644--- a/[fs/smb/server/server.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/server.c?id=e923503a56b3385b64ae492e3225e4623f560c5b)+++ b/[fs/smb/server/server.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/server.c?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)@@ -270,6 +270,7 @@ static void handle\_ksmbd\_work(struct work\_struct \*wk)  ksmbd\_conn\_try\_dequeue\_request(work); ksmbd\_free\_work\_struct(work);+ atomic\_dec(&conn->mux\_smb\_requests); /\* \* Checking waitqueue to dropping pending requests on \* disconnection. waitqueue\_active is safe because it@@ -291,6 +292,15 @@ static int queue\_ksmbd\_work(struct ksmbd\_conn \*conn) struct ksmbd\_work \*work; int err; + err = ksmbd\_init\_smb\_server(conn);+ if (err)+ return 0;++ if (atomic\_inc\_return(&conn->mux\_smb\_requests) >= conn->vals->max\_credits) {+ atomic\_dec\_return(&conn->mux\_smb\_requests);+ return -ENOSPC;+ }+ work = ksmbd\_alloc\_work\_struct(); if (!work) { pr\_err("allocation for work failed\n");@@ -301,12 +311,6 @@ static int queue\_ksmbd\_work(struct ksmbd\_conn \*conn) work->request\_buf = conn->request\_buf; conn->request\_buf = NULL; - err = ksmbd\_init\_smb\_server(work);- if (err) {- ksmbd\_free\_work\_struct(work);- return 0;- }- ksmbd\_conn\_enqueue\_request(work); atomic\_inc(&conn->r\_count); /\* update activity on connection \*/diff --git a/fs/smb/server/smb\_common.c b/fs/smb/server/smb\_common.cindex 13818ecb6e1b2f..663b014b9d1886 100644--- a/[fs/smb/server/smb\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.c?id=e923503a56b3385b64ae492e3225e4623f560c5b)+++ b/[fs/smb/server/smb\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.c?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)@@ -388,6 +388,10 @@ static struct smb\_version\_ops smb1\_server\_ops = { .set\_rsp\_status = set\_smb1\_rsp\_status, }; +static struct smb\_version\_values smb1\_server\_values = {+ .max\_credits = SMB2\_MAX\_CREDITS,+};+ static int smb1\_negotiate(struct ksmbd\_work \*work) { return ksmbd\_smb\_negotiate\_common(work, SMB\_COM\_NEGOTIATE);@@ -399,18 +403,18 @@ static struct smb\_version\_cmds smb1\_server\_cmds[1] = {  static int init\_smb1\_server(struct ksmbd\_conn \*conn) {+ conn->vals = &smb1\_server\_values; conn->ops = &smb1\_server\_ops; conn->cmds = smb1\_server\_cmds; conn->max\_cmds = ARRAY\_SIZE(smb1\_server\_cmds); return 0; } -int ksmbd\_init\_smb\_server(struct ksmbd\_work \*work)+int ksmbd\_init\_smb\_server(struct ksmbd\_conn \*conn) {- struct ksmbd\_conn \*conn = work->conn; \_\_le32 proto; - proto = \*(\_\_le32 \*)((struct smb\_hdr \*)work->request\_buf)->Protocol;+ proto = \*(\_\_le32 \*)((struct smb\_hdr \*)conn->request\_buf)->Protocol; if (conn->need\_neg == false) { if (proto == SMB1\_PROTO\_NUMBER) return -EINVAL;diff --git a/fs/smb/server/smb\_common.h b/fs/smb/server/smb\_common.hindex 4a3148b0167f54..bc832fa9a82c87 100644--- a/[fs/smb/server/smb\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.h?id=e923503a56b3385b64ae492e3225e4623f560c5b)+++ b/[fs/smb/server/smb\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.h?id=1f993777275cbd8f74765c4f9d9285cb907c9be5)@@ -427,7 +427,7 @@ bool ksmbd\_smb\_request(struct ksmbd\_conn \*conn);  int ksmbd\_lookup\_dialect\_by\_id(\_\_le16 \*cli\_dialects, \_\_le16 dialects\_count); -int ksmbd\_init\_smb\_server(struct ksmbd\_work \*work);+int ksmbd\_init\_smb\_server(struct ksmbd\_conn \*conn);  struct ksmbd\_kstat; int ksmbd\_populate\_dot\_dotdot\_entries(struct ksmbd\_work \*work, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:41 +0000



=== Content from git.kernel.org_25e978d6_20250115_093603.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0a77d947f599b1f39065015bec99390d0c0022ee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a77d947f599b1f39065015bec99390d0c0022ee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a77d947f599b1f39065015bec99390d0c0022ee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a77d947f599b1f39065015bec99390d0c0022ee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2024-11-04 13:43:06 +0900 |
| --- | --- | --- |
| committer | Namjae Jeon <linkinjeon@kernel.org> | 2024-11-05 09:26:38 +0900 |
| commit | [0a77d947f599b1f39065015bec99390d0c0022ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a77d947f599b1f39065015bec99390d0c0022ee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0a77d947f599b1f39065015bec99390d0c0022ee)) | |
| tree | [e39c5f6dca528bba8c67d2cec3c2ba9e99a7c4cb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a77d947f599b1f39065015bec99390d0c0022ee) | |
| parent | [b8fc56fbca7482c1e5c0e3351c6ae78982e25ada](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8fc56fbca7482c1e5c0e3351c6ae78982e25ada) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a77d947f599b1f39065015bec99390d0c0022ee&id2=b8fc56fbca7482c1e5c0e3351c6ae78982e25ada)) | |
| download | [linux-0a77d947f599b1f39065015bec99390d0c0022ee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0a77d947f599b1f39065015bec99390d0c0022ee.tar.gz) | |

ksmbd: check outstanding simultaneous SMB operationsIf Client send simultaneous SMB operations to ksmbd, It exhausts too much
memory through the "ksmbd\_work\_cache‚Äù. It will cause OOM issue.
ksmbd has a credit mechanism but it can't handle this problem. This patch
add the check if it exceeds max credits to prevent this problem by assuming
that one smb request consumes at least one credit.
Cc: stable@vger.kernel.org # v5.15+
Reported-by: Norbert Szetei <norbert@doyensec.com>
Tested-by: Norbert Szetei <norbert@doyensec.com>
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a77d947f599b1f39065015bec99390d0c0022ee)

| -rw-r--r-- | [fs/smb/server/connection.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/connection.c?id=0a77d947f599b1f39065015bec99390d0c0022ee) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/server/connection.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/connection.h?id=0a77d947f599b1f39065015bec99390d0c0022ee) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/smb/server/server.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/server.c?id=0a77d947f599b1f39065015bec99390d0c0022ee) | 16 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/smb/server/smb\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb_common.c?id=0a77d947f599b1f39065015bec99390d0c0022ee) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/smb/server/smb\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb_common.h?id=0a77d947f599b1f39065015bec99390d0c0022ee) | 2 | |  |  |  | | --- | --- | --- | |

5 files changed, 20 insertions, 10 deletions

| diff --git a/fs/smb/server/connection.c b/fs/smb/server/connection.cindex aa2a37a7ce847c..e6a72f75ab94ba 100644--- a/[fs/smb/server/connection.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.c?id=b8fc56fbca7482c1e5c0e3351c6ae78982e25ada)+++ b/[fs/smb/server/connection.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.c?id=0a77d947f599b1f39065015bec99390d0c0022ee)@@ -70,6 +70,7 @@ struct ksmbd\_conn \*ksmbd\_conn\_alloc(void) atomic\_set(&conn->req\_running, 0); atomic\_set(&conn->r\_count, 0); atomic\_set(&conn->refcnt, 1);+ atomic\_set(&conn->mux\_smb\_requests, 0); conn->total\_credits = 1; conn->outstanding\_credits = 0; diff --git a/fs/smb/server/connection.h b/fs/smb/server/connection.hindex b379ae4fdcdffa..8ddd5a3c7bafb6 100644--- a/[fs/smb/server/connection.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.h?id=b8fc56fbca7482c1e5c0e3351c6ae78982e25ada)+++ b/[fs/smb/server/connection.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.h?id=0a77d947f599b1f39065015bec99390d0c0022ee)@@ -107,6 +107,7 @@ struct ksmbd\_conn { \_\_le16 signing\_algorithm; bool binding; atomic\_t refcnt;+ atomic\_t mux\_smb\_requests; };  struct ksmbd\_conn\_ops {diff --git a/fs/smb/server/server.c b/fs/smb/server/server.cindex e7f14f8df943e2..e6cfedba999232 100644--- a/[fs/smb/server/server.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/server.c?id=b8fc56fbca7482c1e5c0e3351c6ae78982e25ada)+++ b/[fs/smb/server/server.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/server.c?id=0a77d947f599b1f39065015bec99390d0c0022ee)@@ -270,6 +270,7 @@ static void handle\_ksmbd\_work(struct work\_struct \*wk)  ksmbd\_conn\_try\_dequeue\_request(work); ksmbd\_free\_work\_struct(work);+ atomic\_dec(&conn->mux\_smb\_requests); /\* \* Checking waitqueue to dropping pending requests on \* disconnection. waitqueue\_active is safe because it@@ -291,6 +292,15 @@ static int queue\_ksmbd\_work(struct ksmbd\_conn \*conn) struct ksmbd\_work \*work; int err; + err = ksmbd\_init\_smb\_server(conn);+ if (err)+ return 0;++ if (atomic\_inc\_return(&conn->mux\_smb\_requests) >= conn->vals->max\_credits) {+ atomic\_dec\_return(&conn->mux\_smb\_requests);+ return -ENOSPC;+ }+ work = ksmbd\_alloc\_work\_struct(); if (!work) { pr\_err("allocation for work failed\n");@@ -301,12 +311,6 @@ static int queue\_ksmbd\_work(struct ksmbd\_conn \*conn) work->request\_buf = conn->request\_buf; conn->request\_buf = NULL; - err = ksmbd\_init\_smb\_server(work);- if (err) {- ksmbd\_free\_work\_struct(work);- return 0;- }- ksmbd\_conn\_enqueue\_request(work); atomic\_inc(&conn->r\_count); /\* update activity on connection \*/diff --git a/fs/smb/server/smb\_common.c b/fs/smb/server/smb\_common.cindex a2ebbe604c8c7c..75b4eb856d32f7 100644--- a/[fs/smb/server/smb\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.c?id=b8fc56fbca7482c1e5c0e3351c6ae78982e25ada)+++ b/[fs/smb/server/smb\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.c?id=0a77d947f599b1f39065015bec99390d0c0022ee)@@ -388,6 +388,10 @@ static struct smb\_version\_ops smb1\_server\_ops = { .set\_rsp\_status = set\_smb1\_rsp\_status, }; +static struct smb\_version\_values smb1\_server\_values = {+ .max\_credits = SMB2\_MAX\_CREDITS,+};+ static int smb1\_negotiate(struct ksmbd\_work \*work) { return ksmbd\_smb\_negotiate\_common(work, SMB\_COM\_NEGOTIATE);@@ -399,18 +403,18 @@ static struct smb\_version\_cmds smb1\_server\_cmds[1] = {  static int init\_smb1\_server(struct ksmbd\_conn \*conn) {+ conn->vals = &smb1\_server\_values; conn->ops = &smb1\_server\_ops; conn->cmds = smb1\_server\_cmds; conn->max\_cmds = ARRAY\_SIZE(smb1\_server\_cmds); return 0; } -int ksmbd\_init\_smb\_server(struct ksmbd\_work \*work)+int ksmbd\_init\_smb\_server(struct ksmbd\_conn \*conn) {- struct ksmbd\_conn \*conn = work->conn; \_\_le32 proto; - proto = \*(\_\_le32 \*)((struct smb\_hdr \*)work->request\_buf)->Protocol;+ proto = \*(\_\_le32 \*)((struct smb\_hdr \*)conn->request\_buf)->Protocol; if (conn->need\_neg == false) { if (proto == SMB1\_PROTO\_NUMBER) return -EINVAL;diff --git a/fs/smb/server/smb\_common.h b/fs/smb/server/smb\_common.hindex cc1d6dfe29d565..a3d8a905b07e07 100644--- a/[fs/smb/server/smb\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.h?id=b8fc56fbca7482c1e5c0e3351c6ae78982e25ada)+++ b/[fs/smb/server/smb\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.h?id=0a77d947f599b1f39065015bec99390d0c0022ee)@@ -427,7 +427,7 @@ bool ksmbd\_smb\_request(struct ksmbd\_conn \*conn);  int ksmbd\_lookup\_dialect\_by\_id(\_\_le16 \*cli\_dialects, \_\_le16 dialects\_count); -int ksmbd\_init\_smb\_server(struct ksmbd\_work \*work);+int ksmbd\_init\_smb\_server(struct ksmbd\_conn \*conn);  struct ksmbd\_kstat; int ksmbd\_populate\_dot\_dotdot\_entries(struct ksmbd\_work \*work, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:40 +0000



=== Content from git.kernel.org_5b2eb65d_20250115_093604.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e257ac6fe138623cf59fca8898abdf659dbc8356)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e257ac6fe138623cf59fca8898abdf659dbc8356)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e257ac6fe138623cf59fca8898abdf659dbc8356)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e257ac6fe138623cf59fca8898abdf659dbc8356)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2024-11-04 13:43:06 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:04 +0100 |
| commit | [e257ac6fe138623cf59fca8898abdf659dbc8356](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e257ac6fe138623cf59fca8898abdf659dbc8356) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e257ac6fe138623cf59fca8898abdf659dbc8356)) | |
| tree | [d767ebe86907f56f1278f084b8a3a0a421860012](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e257ac6fe138623cf59fca8898abdf659dbc8356) | |
| parent | [e7a2ad2044377853cf8c59528dac808a08a99c72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7a2ad2044377853cf8c59528dac808a08a99c72) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e257ac6fe138623cf59fca8898abdf659dbc8356&id2=e7a2ad2044377853cf8c59528dac808a08a99c72)) | |
| download | [linux-e257ac6fe138623cf59fca8898abdf659dbc8356.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e257ac6fe138623cf59fca8898abdf659dbc8356.tar.gz) | |

ksmbd: check outstanding simultaneous SMB operationscommit 0a77d947f599b1f39065015bec99390d0c0022ee upstream.
If Client send simultaneous SMB operations to ksmbd, It exhausts too much
memory through the "ksmbd\_work\_cache‚Äù. It will cause OOM issue.
ksmbd has a credit mechanism but it can't handle this problem. This patch
add the check if it exceeds max credits to prevent this problem by assuming
that one smb request consumes at least one credit.
Cc: stable@vger.kernel.org # v5.15+
Reported-by: Norbert Szetei <norbert@doyensec.com>
Tested-by: Norbert Szetei <norbert@doyensec.com>
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e257ac6fe138623cf59fca8898abdf659dbc8356)

| -rw-r--r-- | [fs/smb/server/connection.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/connection.c?id=e257ac6fe138623cf59fca8898abdf659dbc8356) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/server/connection.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/connection.h?id=e257ac6fe138623cf59fca8898abdf659dbc8356) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/smb/server/server.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/server.c?id=e257ac6fe138623cf59fca8898abdf659dbc8356) | 16 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/smb/server/smb\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb_common.c?id=e257ac6fe138623cf59fca8898abdf659dbc8356) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/smb/server/smb\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb_common.h?id=e257ac6fe138623cf59fca8898abdf659dbc8356) | 2 | |  |  |  | | --- | --- | --- | |

5 files changed, 20 insertions, 10 deletions

| diff --git a/fs/smb/server/connection.c b/fs/smb/server/connection.cindex cac80e7bfefc74..a751793c4512af 100644--- a/[fs/smb/server/connection.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.c?id=e7a2ad2044377853cf8c59528dac808a08a99c72)+++ b/[fs/smb/server/connection.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.c?id=e257ac6fe138623cf59fca8898abdf659dbc8356)@@ -70,6 +70,7 @@ struct ksmbd\_conn \*ksmbd\_conn\_alloc(void) atomic\_set(&conn->req\_running, 0); atomic\_set(&conn->r\_count, 0); atomic\_set(&conn->refcnt, 1);+ atomic\_set(&conn->mux\_smb\_requests, 0); conn->total\_credits = 1; conn->outstanding\_credits = 0; diff --git a/fs/smb/server/connection.h b/fs/smb/server/connection.hindex b379ae4fdcdffa..8ddd5a3c7bafb6 100644--- a/[fs/smb/server/connection.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.h?id=e7a2ad2044377853cf8c59528dac808a08a99c72)+++ b/[fs/smb/server/connection.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/connection.h?id=e257ac6fe138623cf59fca8898abdf659dbc8356)@@ -107,6 +107,7 @@ struct ksmbd\_conn { \_\_le16 signing\_algorithm; bool binding; atomic\_t refcnt;+ atomic\_t mux\_smb\_requests; };  struct ksmbd\_conn\_ops {diff --git a/fs/smb/server/server.c b/fs/smb/server/server.cindex bb3e7b09201a88..5244fc6d97bcbc 100644--- a/[fs/smb/server/server.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/server.c?id=e7a2ad2044377853cf8c59528dac808a08a99c72)+++ b/[fs/smb/server/server.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/server.c?id=e257ac6fe138623cf59fca8898abdf659dbc8356)@@ -270,6 +270,7 @@ static void handle\_ksmbd\_work(struct work\_struct \*wk)  ksmbd\_conn\_try\_dequeue\_request(work); ksmbd\_free\_work\_struct(work);+ atomic\_dec(&conn->mux\_smb\_requests); /\* \* Checking waitqueue to dropping pending requests on \* disconnection. waitqueue\_active is safe because it@@ -291,6 +292,15 @@ static int queue\_ksmbd\_work(struct ksmbd\_conn \*conn) struct ksmbd\_work \*work; int err; + err = ksmbd\_init\_smb\_server(conn);+ if (err)+ return 0;++ if (atomic\_inc\_return(&conn->mux\_smb\_requests) >= conn->vals->max\_credits) {+ atomic\_dec\_return(&conn->mux\_smb\_requests);+ return -ENOSPC;+ }+ work = ksmbd\_alloc\_work\_struct(); if (!work) { pr\_err("allocation for work failed\n");@@ -301,12 +311,6 @@ static int queue\_ksmbd\_work(struct ksmbd\_conn \*conn) work->request\_buf = conn->request\_buf; conn->request\_buf = NULL; - err = ksmbd\_init\_smb\_server(work);- if (err) {- ksmbd\_free\_work\_struct(work);- return 0;- }- ksmbd\_conn\_enqueue\_request(work); atomic\_inc(&conn->r\_count); /\* update activity on connection \*/diff --git a/fs/smb/server/smb\_common.c b/fs/smb/server/smb\_common.cindex 13818ecb6e1b2f..663b014b9d1886 100644--- a/[fs/smb/server/smb\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.c?id=e7a2ad2044377853cf8c59528dac808a08a99c72)+++ b/[fs/smb/server/smb\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.c?id=e257ac6fe138623cf59fca8898abdf659dbc8356)@@ -388,6 +388,10 @@ static struct smb\_version\_ops smb1\_server\_ops = { .set\_rsp\_status = set\_smb1\_rsp\_status, }; +static struct smb\_version\_values smb1\_server\_values = {+ .max\_credits = SMB2\_MAX\_CREDITS,+};+ static int smb1\_negotiate(struct ksmbd\_work \*work) { return ksmbd\_smb\_negotiate\_common(work, SMB\_COM\_NEGOTIATE);@@ -399,18 +403,18 @@ static struct smb\_version\_cmds smb1\_server\_cmds[1] = {  static int init\_smb1\_server(struct ksmbd\_conn \*conn) {+ conn->vals = &smb1\_server\_values; conn->ops = &smb1\_server\_ops; conn->cmds = smb1\_server\_cmds; conn->max\_cmds = ARRAY\_SIZE(smb1\_server\_cmds); return 0; } -int ksmbd\_init\_smb\_server(struct ksmbd\_work \*work)+int ksmbd\_init\_smb\_server(struct ksmbd\_conn \*conn) {- struct ksmbd\_conn \*conn = work->conn; \_\_le32 proto; - proto = \*(\_\_le32 \*)((struct smb\_hdr \*)work->request\_buf)->Protocol;+ proto = \*(\_\_le32 \*)((struct smb\_hdr \*)conn->request\_buf)->Protocol; if (conn->need\_neg == false) { if (proto == SMB1\_PROTO\_NUMBER) return -EINVAL;diff --git a/fs/smb/server/smb\_common.h b/fs/smb/server/smb\_common.hindex cc1d6dfe29d565..a3d8a905b07e07 100644--- a/[fs/smb/server/smb\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.h?id=e7a2ad2044377853cf8c59528dac808a08a99c72)+++ b/[fs/smb/server/smb\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb_common.h?id=e257ac6fe138623cf59fca8898abdf659dbc8356)@@ -427,7 +427,7 @@ bool ksmbd\_smb\_request(struct ksmbd\_conn \*conn);  int ksmbd\_lookup\_dialect\_by\_id(\_\_le16 \*cli\_dialects, \_\_le16 dialects\_count); -int ksmbd\_init\_smb\_server(struct ksmbd\_work \*work);+int ksmbd\_init\_smb\_server(struct ksmbd\_conn \*conn);  struct ksmbd\_kstat; int ksmbd\_populate\_dot\_dotdot\_entries(struct ksmbd\_work \*work, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:41 +0000


