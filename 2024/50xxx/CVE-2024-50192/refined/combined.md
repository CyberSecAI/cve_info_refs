=== Content from git.kernel.org_2a6cb597_20250114_214023.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d960505a869e66184fff97fb334980a5b797c7c6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d960505a869e66184fff97fb334980a5b797c7c6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d960505a869e66184fff97fb334980a5b797c7c6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d960505a869e66184fff97fb334980a5b797c7c6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marc Zyngier <maz@kernel.org> | 2024-10-02 21:49:59 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:51:36 +0200 |
| commit | [d960505a869e66184fff97fb334980a5b797c7c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d960505a869e66184fff97fb334980a5b797c7c6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d960505a869e66184fff97fb334980a5b797c7c6)) | |
| tree | [f22a83b4148f96f9f58c7d3b339254fefacf71d5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d960505a869e66184fff97fb334980a5b797c7c6) | |
| parent | [4d2296fb7c80fdc9925d29a8e85d617cad08731a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d2296fb7c80fdc9925d29a8e85d617cad08731a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d960505a869e66184fff97fb334980a5b797c7c6&id2=4d2296fb7c80fdc9925d29a8e85d617cad08731a)) | |
| download | [linux-d960505a869e66184fff97fb334980a5b797c7c6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d960505a869e66184fff97fb334980a5b797c7c6.tar.gz) | |

irqchip/gic-v4: Don't allow a VMOVP on a dying VPEcommit 1442ee0011983f0c5c4b92380e6853afb513841a upstream.
Kunkun Jiang reported that there is a small window of opportunity for
userspace to force a change of affinity for a VPE while the VPE has already
been unmapped, but the corresponding doorbell interrupt still visible in
/proc/irq/.
Plug the race by checking the value of vmapp\_count, which tracks whether
the VPE is mapped ot not, and returning an error in this case.
This involves making vmapp\_count common to both GICv4.1 and its v4.0
ancestor.
Fixes: 64edfaa9a234 ("irqchip/gic-v4.1: Implement the v4.1 flavour of VMAPP")
Reported-by: Kunkun Jiang <jiangkunkun@huawei.com>
Signed-off-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52@huawei.com](https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52%40huawei.com)
Link: [https://lore.kernel.org/all/20241002204959.2051709-1-maz@kernel.org](https://lore.kernel.org/all/20241002204959.2051709-1-maz%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d960505a869e66184fff97fb334980a5b797c7c6)

| -rw-r--r-- | [drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/irqchip/irq-gic-v3-its.c?id=d960505a869e66184fff97fb334980a5b797c7c6) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/irqchip/arm-gic-v4.h?id=d960505a869e66184fff97fb334980a5b797c7c6) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 7 deletions

| diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.cindex fdec478ba5e70a..ab597e74ba08ef 100644--- a/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=4d2296fb7c80fdc9925d29a8e85d617cad08731a)+++ b/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=d960505a869e66184fff97fb334980a5b797c7c6)@@ -797,8 +797,8 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_valid(cmd, desc->its\_vmapp\_cmd.valid);  if (!desc->its\_vmapp\_cmd.valid) {+ alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); if (is\_v4\_1(its)) {- alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); its\_encode\_alloc(cmd, alloc); /\* \* Unmapping a VPE is self-synchronizing on GICv4.1,@@ -817,13 +817,13 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_vpt\_addr(cmd, vpt\_addr); its\_encode\_vpt\_size(cmd, LPI\_NRBITS - 1); + alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);+ if (!is\_v4\_1(its)) goto out;  vconf\_addr = virt\_to\_phys(page\_address(desc->its\_vmapp\_cmd.vpe->its\_vm->vprop\_page)); - alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);- its\_encode\_alloc(cmd, alloc);  /\*@@ -3807,6 +3807,13 @@ static int its\_vpe\_set\_affinity(struct irq\_data \*d, unsigned long flags;  /\*+ \* Check if we're racing against a VPE being destroyed, for+ \* which we don't want to allow a VMOVP.+ \*/+ if (!atomic\_read(&vpe->vmapp\_count))+ return -EINVAL;++ /\* \* Changing affinity is mega expensive, so let's be as lazy as \* we can and only do it if we really have to. Also, if mapped \* into the proxy device, we need to move the doorbell@@ -4463,9 +4470,8 @@ static int its\_vpe\_init(struct its\_vpe \*vpe) raw\_spin\_lock\_init(&vpe->vpe\_lock); vpe->vpe\_id = vpe\_id; vpe->vpt\_page = vpt\_page;- if (gic\_rdists->has\_rvpeid)- atomic\_set(&vpe->vmapp\_count, 0);- else+ atomic\_set(&vpe->vmapp\_count, 0);+ if (!gic\_rdists->has\_rvpeid) vpe->vpe\_proxy\_event = -1;  return 0;diff --git a/include/linux/irqchip/arm-gic-v4.h b/include/linux/irqchip/arm-gic-v4.hindex ecabed6d330752..7f1f11a5e4e44b 100644--- a/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=4d2296fb7c80fdc9925d29a8e85d617cad08731a)+++ b/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=d960505a869e66184fff97fb334980a5b797c7c6)@@ -66,10 +66,12 @@ struct its\_vpe { bool enabled; bool group; } sgi\_config[16];- atomic\_t vmapp\_count; }; }; + /\* Track the VPE being mapped \*/+ atomic\_t vmapp\_count;+ /\* \* Ensures mutual exclusion between affinity setting of the \* vPE and vLPI operations using vpe->col\_idx. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:39:00 +0000



=== Content from git.kernel.org_1aec09d7_20250114_214018.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1442ee0011983f0c5c4b92380e6853afb513841a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1442ee0011983f0c5c4b92380e6853afb513841a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1442ee0011983f0c5c4b92380e6853afb513841a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1442ee0011983f0c5c4b92380e6853afb513841a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marc Zyngier <maz@kernel.org> | 2024-10-02 21:49:59 +0100 |
| --- | --- | --- |
| committer | Thomas Gleixner <tglx@linutronix.de> | 2024-10-08 17:44:27 +0200 |
| commit | [1442ee0011983f0c5c4b92380e6853afb513841a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1442ee0011983f0c5c4b92380e6853afb513841a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1442ee0011983f0c5c4b92380e6853afb513841a)) | |
| tree | [78f047d12e66129a3021e639081e7974e020fe22](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1442ee0011983f0c5c4b92380e6853afb513841a) | |
| parent | [6eabf656048d904d961584de2e1d45bc0854f9fb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6eabf656048d904d961584de2e1d45bc0854f9fb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1442ee0011983f0c5c4b92380e6853afb513841a&id2=6eabf656048d904d961584de2e1d45bc0854f9fb)) | |
| download | [linux-1442ee0011983f0c5c4b92380e6853afb513841a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1442ee0011983f0c5c4b92380e6853afb513841a.tar.gz) | |

irqchip/gic-v4: Don't allow a VMOVP on a dying VPEKunkun Jiang reported that there is a small window of opportunity for
userspace to force a change of affinity for a VPE while the VPE has already
been unmapped, but the corresponding doorbell interrupt still visible in
/proc/irq/.
Plug the race by checking the value of vmapp\_count, which tracks whether
the VPE is mapped ot not, and returning an error in this case.
This involves making vmapp\_count common to both GICv4.1 and its v4.0
ancestor.
Fixes: 64edfaa9a234 ("irqchip/gic-v4.1: Implement the v4.1 flavour of VMAPP")
Reported-by: Kunkun Jiang <jiangkunkun@huawei.com>
Signed-off-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52@huawei.com](https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52%40huawei.com)
Link: [https://lore.kernel.org/all/20241002204959.2051709-1-maz@kernel.org](https://lore.kernel.org/all/20241002204959.2051709-1-maz%40kernel.org)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1442ee0011983f0c5c4b92380e6853afb513841a)

| -rw-r--r-- | [drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/irqchip/irq-gic-v3-its.c?id=1442ee0011983f0c5c4b92380e6853afb513841a) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/irqchip/arm-gic-v4.h?id=1442ee0011983f0c5c4b92380e6853afb513841a) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 7 deletions

| diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.cindex fdec478ba5e70a..ab597e74ba08ef 100644--- a/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=6eabf656048d904d961584de2e1d45bc0854f9fb)+++ b/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=1442ee0011983f0c5c4b92380e6853afb513841a)@@ -797,8 +797,8 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_valid(cmd, desc->its\_vmapp\_cmd.valid);  if (!desc->its\_vmapp\_cmd.valid) {+ alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); if (is\_v4\_1(its)) {- alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); its\_encode\_alloc(cmd, alloc); /\* \* Unmapping a VPE is self-synchronizing on GICv4.1,@@ -817,13 +817,13 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_vpt\_addr(cmd, vpt\_addr); its\_encode\_vpt\_size(cmd, LPI\_NRBITS - 1); + alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);+ if (!is\_v4\_1(its)) goto out;  vconf\_addr = virt\_to\_phys(page\_address(desc->its\_vmapp\_cmd.vpe->its\_vm->vprop\_page)); - alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);- its\_encode\_alloc(cmd, alloc);  /\*@@ -3807,6 +3807,13 @@ static int its\_vpe\_set\_affinity(struct irq\_data \*d, unsigned long flags;  /\*+ \* Check if we're racing against a VPE being destroyed, for+ \* which we don't want to allow a VMOVP.+ \*/+ if (!atomic\_read(&vpe->vmapp\_count))+ return -EINVAL;++ /\* \* Changing affinity is mega expensive, so let's be as lazy as \* we can and only do it if we really have to. Also, if mapped \* into the proxy device, we need to move the doorbell@@ -4463,9 +4470,8 @@ static int its\_vpe\_init(struct its\_vpe \*vpe) raw\_spin\_lock\_init(&vpe->vpe\_lock); vpe->vpe\_id = vpe\_id; vpe->vpt\_page = vpt\_page;- if (gic\_rdists->has\_rvpeid)- atomic\_set(&vpe->vmapp\_count, 0);- else+ atomic\_set(&vpe->vmapp\_count, 0);+ if (!gic\_rdists->has\_rvpeid) vpe->vpe\_proxy\_event = -1;  return 0;diff --git a/include/linux/irqchip/arm-gic-v4.h b/include/linux/irqchip/arm-gic-v4.hindex ecabed6d330752..7f1f11a5e4e44b 100644--- a/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=6eabf656048d904d961584de2e1d45bc0854f9fb)+++ b/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=1442ee0011983f0c5c4b92380e6853afb513841a)@@ -66,10 +66,12 @@ struct its\_vpe { bool enabled; bool group; } sgi\_config[16];- atomic\_t vmapp\_count; }; }; + /\* Track the VPE being mapped \*/+ atomic\_t vmapp\_count;+ /\* \* Ensures mutual exclusion between affinity setting of the \* vPE and vLPI operations using vpe->col\_idx. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:45:41 +0000



=== Content from git.kernel.org_b74a19cf_20250114_214022.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marc Zyngier <maz@kernel.org> | 2024-10-02 21:49:59 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:39:29 +0200 |
| commit | [b7d7b7fc876f836f40bf48a87e07ea18756ba196](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196)) | |
| tree | [6c2c608000a1e2dd08067f69c7cc0977fc503512](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196) | |
| parent | [6f44a5fc15b5cece0785bc07453db77d99b0a6de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f44a5fc15b5cece0785bc07453db77d99b0a6de) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196&id2=6f44a5fc15b5cece0785bc07453db77d99b0a6de)) | |
| download | [linux-b7d7b7fc876f836f40bf48a87e07ea18756ba196.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b7d7b7fc876f836f40bf48a87e07ea18756ba196.tar.gz) | |

irqchip/gic-v4: Don't allow a VMOVP on a dying VPEcommit 1442ee0011983f0c5c4b92380e6853afb513841a upstream.
Kunkun Jiang reported that there is a small window of opportunity for
userspace to force a change of affinity for a VPE while the VPE has already
been unmapped, but the corresponding doorbell interrupt still visible in
/proc/irq/.
Plug the race by checking the value of vmapp\_count, which tracks whether
the VPE is mapped ot not, and returning an error in this case.
This involves making vmapp\_count common to both GICv4.1 and its v4.0
ancestor.
Fixes: 64edfaa9a234 ("irqchip/gic-v4.1: Implement the v4.1 flavour of VMAPP")
Reported-by: Kunkun Jiang <jiangkunkun@huawei.com>
Signed-off-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52@huawei.com](https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52%40huawei.com)
Link: [https://lore.kernel.org/all/20241002204959.2051709-1-maz@kernel.org](https://lore.kernel.org/all/20241002204959.2051709-1-maz%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196)

| -rw-r--r-- | [drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/irqchip/irq-gic-v3-its.c?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/irqchip/arm-gic-v4.h?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 7 deletions

| diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.cindex 6680cb3cd43749..d8d3d0af988e3b 100644--- a/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=6f44a5fc15b5cece0785bc07453db77d99b0a6de)+++ b/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196)@@ -789,8 +789,8 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_valid(cmd, desc->its\_vmapp\_cmd.valid);  if (!desc->its\_vmapp\_cmd.valid) {+ alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); if (is\_v4\_1(its)) {- alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); its\_encode\_alloc(cmd, alloc); /\* \* Unmapping a VPE is self-synchronizing on GICv4.1,@@ -809,13 +809,13 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_vpt\_addr(cmd, vpt\_addr); its\_encode\_vpt\_size(cmd, LPI\_NRBITS - 1); + alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);+ if (!is\_v4\_1(its)) goto out;  vconf\_addr = virt\_to\_phys(page\_address(desc->its\_vmapp\_cmd.vpe->its\_vm->vprop\_page)); - alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);- its\_encode\_alloc(cmd, alloc);  /\* We can only signal PTZ when alloc==1. Why do we have two bits? \*/@@ -3793,6 +3793,13 @@ static int its\_vpe\_set\_affinity(struct irq\_data \*d, int from, cpu;  /\*+ \* Check if we're racing against a VPE being destroyed, for+ \* which we don't want to allow a VMOVP.+ \*/+ if (!atomic\_read(&vpe->vmapp\_count))+ return -EINVAL;++ /\* \* Changing affinity is mega expensive, so let's be as lazy as \* we can and only do it if we really have to. Also, if mapped \* into the proxy device, we need to move the doorbell@@ -4424,9 +4431,8 @@ static int its\_vpe\_init(struct its\_vpe \*vpe) raw\_spin\_lock\_init(&vpe->vpe\_lock); vpe->vpe\_id = vpe\_id; vpe->vpt\_page = vpt\_page;- if (gic\_rdists->has\_rvpeid)- atomic\_set(&vpe->vmapp\_count, 0);- else+ atomic\_set(&vpe->vmapp\_count, 0);+ if (!gic\_rdists->has\_rvpeid) vpe->vpe\_proxy\_event = -1;  return 0;diff --git a/include/linux/irqchip/arm-gic-v4.h b/include/linux/irqchip/arm-gic-v4.hindex 6976b8331b6043..74e11617b86139 100644--- a/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=6f44a5fc15b5cece0785bc07453db77d99b0a6de)+++ b/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=b7d7b7fc876f836f40bf48a87e07ea18756ba196)@@ -56,10 +56,12 @@ struct its\_vpe { bool enabled; bool group; } sgi\_config[16];- atomic\_t vmapp\_count; }; }; + /\* Track the VPE being mapped \*/+ atomic\_t vmapp\_count;+ /\* \* Ensures mutual exclusion between affinity setting of the \* vPE and vLPI operations using vpe->col\_idx. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:59 +0000



=== Content from git.kernel.org_afdef3ca_20250114_214017.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=01282ab5182f85e42234df2ff42f0ce790f465ff)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01282ab5182f85e42234df2ff42f0ce790f465ff)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01282ab5182f85e42234df2ff42f0ce790f465ff)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01282ab5182f85e42234df2ff42f0ce790f465ff)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marc Zyngier <maz@kernel.org> | 2024-10-02 21:49:59 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:46:35 +0200 |
| commit | [01282ab5182f85e42234df2ff42f0ce790f465ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01282ab5182f85e42234df2ff42f0ce790f465ff) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=01282ab5182f85e42234df2ff42f0ce790f465ff)) | |
| tree | [13f7ae5d8a2272586d24c3b56f037c3bbc801c8a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01282ab5182f85e42234df2ff42f0ce790f465ff) | |
| parent | [fad940e2dd789155f99ecafa71a7baf6f96530bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fad940e2dd789155f99ecafa71a7baf6f96530bc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01282ab5182f85e42234df2ff42f0ce790f465ff&id2=fad940e2dd789155f99ecafa71a7baf6f96530bc)) | |
| download | [linux-01282ab5182f85e42234df2ff42f0ce790f465ff.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-01282ab5182f85e42234df2ff42f0ce790f465ff.tar.gz) | |

irqchip/gic-v4: Don't allow a VMOVP on a dying VPEcommit 1442ee0011983f0c5c4b92380e6853afb513841a upstream.
Kunkun Jiang reported that there is a small window of opportunity for
userspace to force a change of affinity for a VPE while the VPE has already
been unmapped, but the corresponding doorbell interrupt still visible in
/proc/irq/.
Plug the race by checking the value of vmapp\_count, which tracks whether
the VPE is mapped ot not, and returning an error in this case.
This involves making vmapp\_count common to both GICv4.1 and its v4.0
ancestor.
Fixes: 64edfaa9a234 ("irqchip/gic-v4.1: Implement the v4.1 flavour of VMAPP")
Reported-by: Kunkun Jiang <jiangkunkun@huawei.com>
Signed-off-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52@huawei.com](https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52%40huawei.com)
Link: [https://lore.kernel.org/all/20241002204959.2051709-1-maz@kernel.org](https://lore.kernel.org/all/20241002204959.2051709-1-maz%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01282ab5182f85e42234df2ff42f0ce790f465ff)

| -rw-r--r-- | [drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/irqchip/irq-gic-v3-its.c?id=01282ab5182f85e42234df2ff42f0ce790f465ff) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/irqchip/arm-gic-v4.h?id=01282ab5182f85e42234df2ff42f0ce790f465ff) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 7 deletions

| diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.cindex f04a2c3a45e16c..b1e60c13c1e1e7 100644--- a/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=fad940e2dd789155f99ecafa71a7baf6f96530bc)+++ b/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=01282ab5182f85e42234df2ff42f0ce790f465ff)@@ -796,8 +796,8 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_valid(cmd, desc->its\_vmapp\_cmd.valid);  if (!desc->its\_vmapp\_cmd.valid) {+ alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); if (is\_v4\_1(its)) {- alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); its\_encode\_alloc(cmd, alloc); /\* \* Unmapping a VPE is self-synchronizing on GICv4.1,@@ -816,13 +816,13 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_vpt\_addr(cmd, vpt\_addr); its\_encode\_vpt\_size(cmd, LPI\_NRBITS - 1); + alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);+ if (!is\_v4\_1(its)) goto out;  vconf\_addr = virt\_to\_phys(page\_address(desc->its\_vmapp\_cmd.vpe->its\_vm->vprop\_page)); - alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);- its\_encode\_alloc(cmd, alloc);  /\*@@ -3817,6 +3817,13 @@ static int its\_vpe\_set\_affinity(struct irq\_data \*d, int from, cpu;  /\*+ \* Check if we're racing against a VPE being destroyed, for+ \* which we don't want to allow a VMOVP.+ \*/+ if (!atomic\_read(&vpe->vmapp\_count))+ return -EINVAL;++ /\* \* Changing affinity is mega expensive, so let's be as lazy as \* we can and only do it if we really have to. Also, if mapped \* into the proxy device, we need to move the doorbell@@ -4456,9 +4463,8 @@ static int its\_vpe\_init(struct its\_vpe \*vpe) raw\_spin\_lock\_init(&vpe->vpe\_lock); vpe->vpe\_id = vpe\_id; vpe->vpt\_page = vpt\_page;- if (gic\_rdists->has\_rvpeid)- atomic\_set(&vpe->vmapp\_count, 0);- else+ atomic\_set(&vpe->vmapp\_count, 0);+ if (!gic\_rdists->has\_rvpeid) vpe->vpe\_proxy\_event = -1;  return 0;diff --git a/include/linux/irqchip/arm-gic-v4.h b/include/linux/irqchip/arm-gic-v4.hindex 2c63375bbd43f4..bf9e0640288d1d 100644--- a/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=fad940e2dd789155f99ecafa71a7baf6f96530bc)+++ b/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=01282ab5182f85e42234df2ff42f0ce790f465ff)@@ -58,10 +58,12 @@ struct its\_vpe { bool enabled; bool group; } sgi\_config[16];- atomic\_t vmapp\_count; }; }; + /\* Track the VPE being mapped \*/+ atomic\_t vmapp\_count;+ /\* \* Ensures mutual exclusion between affinity setting of the \* vPE and vLPI operations using vpe->col\_idx. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:53 +0000



=== Content from git.kernel.org_367747ef_20250114_214021.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=755b9532c885b8761fb135fedcd705e21e61cccb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=755b9532c885b8761fb135fedcd705e21e61cccb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=755b9532c885b8761fb135fedcd705e21e61cccb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=755b9532c885b8761fb135fedcd705e21e61cccb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marc Zyngier <maz@kernel.org> | 2024-10-02 21:49:59 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:40:46 +0200 |
| commit | [755b9532c885b8761fb135fedcd705e21e61cccb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=755b9532c885b8761fb135fedcd705e21e61cccb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=755b9532c885b8761fb135fedcd705e21e61cccb)) | |
| tree | [5c80b146f7fe71645f57943dc89d66d1ebfdef42](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=755b9532c885b8761fb135fedcd705e21e61cccb) | |
| parent | [655f5d4662b958122b260be05aa6dfdf8768efe6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=655f5d4662b958122b260be05aa6dfdf8768efe6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=755b9532c885b8761fb135fedcd705e21e61cccb&id2=655f5d4662b958122b260be05aa6dfdf8768efe6)) | |
| download | [linux-755b9532c885b8761fb135fedcd705e21e61cccb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-755b9532c885b8761fb135fedcd705e21e61cccb.tar.gz) | |

irqchip/gic-v4: Don't allow a VMOVP on a dying VPEcommit 1442ee0011983f0c5c4b92380e6853afb513841a upstream.
Kunkun Jiang reported that there is a small window of opportunity for
userspace to force a change of affinity for a VPE while the VPE has already
been unmapped, but the corresponding doorbell interrupt still visible in
/proc/irq/.
Plug the race by checking the value of vmapp\_count, which tracks whether
the VPE is mapped ot not, and returning an error in this case.
This involves making vmapp\_count common to both GICv4.1 and its v4.0
ancestor.
Fixes: 64edfaa9a234 ("irqchip/gic-v4.1: Implement the v4.1 flavour of VMAPP")
Reported-by: Kunkun Jiang <jiangkunkun@huawei.com>
Signed-off-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52@huawei.com](https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52%40huawei.com)
Link: [https://lore.kernel.org/all/20241002204959.2051709-1-maz@kernel.org](https://lore.kernel.org/all/20241002204959.2051709-1-maz%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=755b9532c885b8761fb135fedcd705e21e61cccb)

| -rw-r--r-- | [drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/irqchip/irq-gic-v3-its.c?id=755b9532c885b8761fb135fedcd705e21e61cccb) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/irqchip/arm-gic-v4.h?id=755b9532c885b8761fb135fedcd705e21e61cccb) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 7 deletions

| diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.cindex ff9b7090326de2..567d758503fbc8 100644--- a/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=655f5d4662b958122b260be05aa6dfdf8768efe6)+++ b/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=755b9532c885b8761fb135fedcd705e21e61cccb)@@ -789,8 +789,8 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_valid(cmd, desc->its\_vmapp\_cmd.valid);  if (!desc->its\_vmapp\_cmd.valid) {+ alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); if (is\_v4\_1(its)) {- alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); its\_encode\_alloc(cmd, alloc); /\* \* Unmapping a VPE is self-synchronizing on GICv4.1,@@ -809,13 +809,13 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_vpt\_addr(cmd, vpt\_addr); its\_encode\_vpt\_size(cmd, LPI\_NRBITS - 1); + alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);+ if (!is\_v4\_1(its)) goto out;  vconf\_addr = virt\_to\_phys(page\_address(desc->its\_vmapp\_cmd.vpe->its\_vm->vprop\_page)); - alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);- its\_encode\_alloc(cmd, alloc);  /\*@@ -3811,6 +3811,13 @@ static int its\_vpe\_set\_affinity(struct irq\_data \*d, int from, cpu;  /\*+ \* Check if we're racing against a VPE being destroyed, for+ \* which we don't want to allow a VMOVP.+ \*/+ if (!atomic\_read(&vpe->vmapp\_count))+ return -EINVAL;++ /\* \* Changing affinity is mega expensive, so let's be as lazy as \* we can and only do it if we really have to. Also, if mapped \* into the proxy device, we need to move the doorbell@@ -4446,9 +4453,8 @@ static int its\_vpe\_init(struct its\_vpe \*vpe) raw\_spin\_lock\_init(&vpe->vpe\_lock); vpe->vpe\_id = vpe\_id; vpe->vpt\_page = vpt\_page;- if (gic\_rdists->has\_rvpeid)- atomic\_set(&vpe->vmapp\_count, 0);- else+ atomic\_set(&vpe->vmapp\_count, 0);+ if (!gic\_rdists->has\_rvpeid) vpe->vpe\_proxy\_event = -1;  return 0;diff --git a/include/linux/irqchip/arm-gic-v4.h b/include/linux/irqchip/arm-gic-v4.hindex 2c63375bbd43f4..bf9e0640288d1d 100644--- a/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=655f5d4662b958122b260be05aa6dfdf8768efe6)+++ b/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=755b9532c885b8761fb135fedcd705e21e61cccb)@@ -58,10 +58,12 @@ struct its\_vpe { bool enabled; bool group; } sgi\_config[16];- atomic\_t vmapp\_count; }; }; + /\* Track the VPE being mapped \*/+ atomic\_t vmapp\_count;+ /\* \* Ensures mutual exclusion between affinity setting of the \* vPE and vLPI operations using vpe->col\_idx. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:58 +0000



=== Content from git.kernel.org_2000b94e_20250114_214020.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marc Zyngier <maz@kernel.org> | 2024-10-02 21:49:59 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:56:51 +0200 |
| commit | [64b12b061c5488e2d69e67c4eaae5da64fd30bfe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe)) | |
| tree | [3158fb86239e28b61a5acc0c827eade0917df124](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe) | |
| parent | [0a4d4dbef622ac8796a6665e0080da2685f9220a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a4d4dbef622ac8796a6665e0080da2685f9220a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe&id2=0a4d4dbef622ac8796a6665e0080da2685f9220a)) | |
| download | [linux-64b12b061c5488e2d69e67c4eaae5da64fd30bfe.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-64b12b061c5488e2d69e67c4eaae5da64fd30bfe.tar.gz) | |

irqchip/gic-v4: Don't allow a VMOVP on a dying VPEcommit 1442ee0011983f0c5c4b92380e6853afb513841a upstream.
Kunkun Jiang reported that there is a small window of opportunity for
userspace to force a change of affinity for a VPE while the VPE has already
been unmapped, but the corresponding doorbell interrupt still visible in
/proc/irq/.
Plug the race by checking the value of vmapp\_count, which tracks whether
the VPE is mapped ot not, and returning an error in this case.
This involves making vmapp\_count common to both GICv4.1 and its v4.0
ancestor.
Fixes: 64edfaa9a234 ("irqchip/gic-v4.1: Implement the v4.1 flavour of VMAPP")
Reported-by: Kunkun Jiang <jiangkunkun@huawei.com>
Signed-off-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52@huawei.com](https://lore.kernel.org/r/c182ece6-2ba0-ce4f-3404-dba7a3ab6c52%40huawei.com)
Link: [https://lore.kernel.org/all/20241002204959.2051709-1-maz@kernel.org](https://lore.kernel.org/all/20241002204959.2051709-1-maz%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe)

| -rw-r--r-- | [drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/irqchip/irq-gic-v3-its.c?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/irqchip/arm-gic-v4.h?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 7 deletions

| diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.cindex 8a102d094d68c7..30e60bcc3b4e0b 100644--- a/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=0a4d4dbef622ac8796a6665e0080da2685f9220a)+++ b/[drivers/irqchip/irq-gic-v3-its.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3-its.c?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe)@@ -793,8 +793,8 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_valid(cmd, desc->its\_vmapp\_cmd.valid);  if (!desc->its\_vmapp\_cmd.valid) {+ alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); if (is\_v4\_1(its)) {- alloc = !atomic\_dec\_return(&desc->its\_vmapp\_cmd.vpe->vmapp\_count); its\_encode\_alloc(cmd, alloc); /\* \* Unmapping a VPE is self-synchronizing on GICv4.1,@@ -813,13 +813,13 @@ static struct its\_vpe \*its\_build\_vmapp\_cmd(struct its\_node \*its, its\_encode\_vpt\_addr(cmd, vpt\_addr); its\_encode\_vpt\_size(cmd, LPI\_NRBITS - 1); + alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);+ if (!is\_v4\_1(its)) goto out;  vconf\_addr = virt\_to\_phys(page\_address(desc->its\_vmapp\_cmd.vpe->its\_vm->vprop\_page)); - alloc = !atomic\_fetch\_inc(&desc->its\_vmapp\_cmd.vpe->vmapp\_count);- its\_encode\_alloc(cmd, alloc);  /\*@@ -3796,6 +3796,13 @@ static int its\_vpe\_set\_affinity(struct irq\_data \*d, int from, cpu;  /\*+ \* Check if we're racing against a VPE being destroyed, for+ \* which we don't want to allow a VMOVP.+ \*/+ if (!atomic\_read(&vpe->vmapp\_count))+ return -EINVAL;++ /\* \* Changing affinity is mega expensive, so let's be as lazy as \* we can and only do it if we really have to. Also, if mapped \* into the proxy device, we need to move the doorbell@@ -4431,9 +4438,8 @@ static int its\_vpe\_init(struct its\_vpe \*vpe) raw\_spin\_lock\_init(&vpe->vpe\_lock); vpe->vpe\_id = vpe\_id; vpe->vpt\_page = vpt\_page;- if (gic\_rdists->has\_rvpeid)- atomic\_set(&vpe->vmapp\_count, 0);- else+ atomic\_set(&vpe->vmapp\_count, 0);+ if (!gic\_rdists->has\_rvpeid) vpe->vpe\_proxy\_event = -1;  return 0;diff --git a/include/linux/irqchip/arm-gic-v4.h b/include/linux/irqchip/arm-gic-v4.hindex 2c63375bbd43f4..bf9e0640288d1d 100644--- a/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=0a4d4dbef622ac8796a6665e0080da2685f9220a)+++ b/[include/linux/irqchip/arm-gic-v4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/irqchip/arm-gic-v4.h?id=64b12b061c5488e2d69e67c4eaae5da64fd30bfe)@@ -58,10 +58,12 @@ struct its\_vpe { bool enabled; bool group; } sgi\_config[16];- atomic\_t vmapp\_count; }; }; + /\* Track the VPE being mapped \*/+ atomic\_t vmapp\_count;+ /\* \* Ensures mutual exclusion between affinity setting of the \* vPE and vLPI operations using vpe->col\_idx. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:38:56 +0000


