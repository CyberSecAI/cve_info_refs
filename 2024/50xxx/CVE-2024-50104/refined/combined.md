=== Content from git.kernel.org_2b36c7e8_20250115_092837.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d0e806b0cc6260b59c65e606034a63145169c04c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0e806b0cc6260b59c65e606034a63145169c04c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0e806b0cc6260b59c65e606034a63145169c04c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0e806b0cc6260b59c65e606034a63145169c04c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexey Klimov <alexey.klimov@linaro.org> | 2024-10-09 22:39:22 +0100 |
| --- | --- | --- |
| committer | Mark Brown <broonie@kernel.org> | 2024-10-10 12:15:00 +0100 |
| commit | [d0e806b0cc6260b59c65e606034a63145169c04c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0e806b0cc6260b59c65e606034a63145169c04c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d0e806b0cc6260b59c65e606034a63145169c04c)) | |
| tree | [aa662f0029b8d8bcebf4831427e0146b9e1acc6e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0e806b0cc6260b59c65e606034a63145169c04c) | |
| parent | [a6134e7b4d4a14e0942f113a6df1d518baa2a0a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6134e7b4d4a14e0942f113a6df1d518baa2a0a4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0e806b0cc6260b59c65e606034a63145169c04c&id2=a6134e7b4d4a14e0942f113a6df1d518baa2a0a4)) | |
| download | [linux-d0e806b0cc6260b59c65e606034a63145169c04c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d0e806b0cc6260b59c65e606034a63145169c04c.tar.gz) | |

ASoC: qcom: sdm845: add missing soundwire runtime stream allocDuring the migration of Soundwire runtime stream allocation from
the Qualcomm Soundwire controller to SoC's soundcard drivers the sdm845
soundcard was forgotten.
At this point any playback attempt or audio daemon startup, for instance
on sdm845-db845c (Qualcomm RB3 board), will result in stream pointer
NULL dereference:
Unable to handle kernel NULL pointer dereference at virtual
address 0000000000000020
Mem abort info:
ESR = 0x0000000096000004
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
FSC = 0x04: level 0 translation fault
Data abort info:
ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
CM = 0, WnR = 0, TnD = 0, TagAccess = 0
GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
user pgtable: 4k pages, 48-bit VAs, pgdp=0000000101ecf000
[0000000000000020] pgd=0000000000000000, p4d=0000000000000000
Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
Modules linked in: ...
CPU: 5 UID: 0 PID: 1198 Comm: aplay
Not tainted 6.12.0-rc2-qcomlt-arm64-00059-g9d78f315a362-dirty #18
Hardware name: Thundercomm Dragonboard 845c (DT)
pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : sdw\_stream\_add\_slave+0x44/0x380 [soundwire\_bus]
lr : sdw\_stream\_add\_slave+0x44/0x380 [soundwire\_bus]
sp : ffff80008a2035c0
x29: ffff80008a2035c0 x28: ffff80008a203978 x27: 0000000000000000
x26: 00000000000000c0 x25: 0000000000000000 x24: ffff1676025f4800
x23: ffff167600ff1cb8 x22: ffff167600ff1c98 x21: 0000000000000003
x20: ffff167607316000 x19: ffff167604e64e80 x18: 0000000000000000
x17: 0000000000000000 x16: ffffcec265074160 x15: 0000000000000000
x14: 0000000000000000 x13: 0000000000000000 x12: 0000000000000000
x11: 0000000000000000 x10: 0000000000000000 x9 : 0000000000000000
x8 : 0000000000000000 x7 : 0000000000000000 x6 : ffff167600ff1cec
x5 : ffffcec22cfa2010 x4 : 0000000000000000 x3 : 0000000000000003
x2 : ffff167613f836c0 x1 : 0000000000000000 x0 : ffff16761feb60b8
Call trace:
sdw\_stream\_add\_slave+0x44/0x380 [soundwire\_bus]
wsa881x\_hw\_params+0x68/0x80 [snd\_soc\_wsa881x]
snd\_soc\_dai\_hw\_params+0x3c/0xa4
\_\_soc\_pcm\_hw\_params+0x230/0x660
dpcm\_be\_dai\_hw\_params+0x1d0/0x3f8
dpcm\_fe\_dai\_hw\_params+0x98/0x268
snd\_pcm\_hw\_params+0x124/0x460
snd\_pcm\_common\_ioctl+0x998/0x16e8
snd\_pcm\_ioctl+0x34/0x58
\_\_arm64\_sys\_ioctl+0xac/0xf8
invoke\_syscall+0x48/0x104
el0\_svc\_common.constprop.0+0x40/0xe0
do\_el0\_svc+0x1c/0x28
el0\_svc+0x34/0xe0
el0t\_64\_sync\_handler+0x120/0x12c
el0t\_64\_sync+0x190/0x194
Code: aa0403fb f9418400 9100e000 9400102f (f8420f22)
---[ end trace 0000000000000000 ]---
0000000000006108 <sdw\_stream\_add\_slave>:
6108: d503233f paciasp
610c: a9b97bfd stp x29, x30, [sp, #-112]!
6110: 910003fd mov x29, sp
6114: a90153f3 stp x19, x20, [sp, #16]
6118: a9025bf5 stp x21, x22, [sp, #32]
611c: aa0103f6 mov x22, x1
6120: 2a0303f5 mov w21, w3
6124: a90363f7 stp x23, x24, [sp, #48]
6128: aa0003f8 mov x24, x0
612c: aa0203f7 mov x23, x2
6130: a9046bf9 stp x25, x26, [sp, #64]
6134: aa0403f9 mov x25, x4 <-- x4 copied to x25
6138: a90573fb stp x27, x28, [sp, #80]
613c: aa0403fb mov x27, x4
6140: f9418400 ldr x0, [x0, #776]
6144: 9100e000 add x0, x0, #0x38
6148: 94000000 bl 0 <mutex\_lock>
614c: f8420f22 ldr x2, [x25, #32]! <-- offset 0x44
^^^
This is 0x6108 + offset 0x44 from the beginning of sdw\_stream\_add\_slave()
where data abort happens.
wsa881x\_hw\_params() is called with stream = NULL and passes it further
in register x4 (5th argument) to sdw\_stream\_add\_slave() without any checks.
Value from x4 is copied to x25 and finally it aborts on trying to load
a value from address in x25 plus offset 32 (in dec) which corresponds
to master\_list member in struct sdw\_stream\_runtime:
struct sdw\_stream\_runtime {
const char \* name; /\* 0 8 \*/
struct sdw\_stream\_params params; /\* 8 12 \*/
enum sdw\_stream\_state state; /\* 20 4 \*/
enum sdw\_stream\_type type; /\* 24 4 \*/
/\* XXX 4 bytes hole, try to pack \*/
here-> struct list\_head master\_list; /\* 32 16 \*/
int m\_rt\_count; /\* 48 4 \*/
/\* size: 56, cachelines: 1, members: 6 \*/
/\* sum members: 48, holes: 1, sum holes: 4 \*/
/\* padding: 4 \*/
/\* last cacheline: 56 bytes \*/
Fix this by adding required calls to qcom\_snd\_sdw\_startup() and
sdw\_release\_stream() to startup and shutdown routines which restores
the previous correct behaviour when ->set\_stream() method is called to
set a valid stream runtime pointer on playback startup.
Reproduced and then fix was tested on db845c RB3 board.
Reported-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Cc: stable@vger.kernel.org
Fixes: 15c7fab0e047 ("ASoC: qcom: Move Soundwire runtime stream alloc to soundcards")
Cc: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
Cc: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Cc: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
Cc: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Signed-off-by: Alexey Klimov <alexey.klimov@linaro.org>
Tested-by: Steev Klimaszewski <steev@kali.org> # Lenovo Yoga C630
Reviewed-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
Reviewed-by: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
Link: [https://patch.msgid.link/20241009213922.999355-1-alexey.klimov@linaro.org](https://patch.msgid.link/20241009213922.999355-1-alexey.klimov%40linaro.org)
Signed-off-by: Mark Brown <broonie@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0e806b0cc6260b59c65e606034a63145169c04c)

| -rw-r--r-- | [sound/soc/qcom/sdm845.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/qcom/sdm845.c?id=d0e806b0cc6260b59c65e606034a63145169c04c) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/sound/soc/qcom/sdm845.c b/sound/soc/qcom/sdm845.cindex 75701546b6ea8b..a479d7e5b7fbdc 100644--- a/[sound/soc/qcom/sdm845.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/qcom/sdm845.c?id=a6134e7b4d4a14e0942f113a6df1d518baa2a0a4)+++ b/[sound/soc/qcom/sdm845.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/qcom/sdm845.c?id=d0e806b0cc6260b59c65e606034a63145169c04c)@@ -15,6 +15,7 @@ #include <uapi/linux/input-event-codes.h> #include "common.h" #include "qdsp6/q6afe.h"+#include "sdw.h" #include "../codecs/rt5663.h"  #define DRIVER\_NAME "sdm845"@@ -416,7 +417,7 @@ static int sdm845\_snd\_startup(struct snd\_pcm\_substream \*substream) pr\_err("%s: invalid dai id 0x%x\n", \_\_func\_\_, cpu\_dai->id); break; }- return 0;+ return qcom\_snd\_sdw\_startup(substream); }  static void sdm845\_snd\_shutdown(struct snd\_pcm\_substream \*substream)@@ -425,6 +426,7 @@ static void sdm845\_snd\_shutdown(struct snd\_pcm\_substream \*substream) struct snd\_soc\_card \*card = rtd->card; struct sdm845\_snd\_data \*data = snd\_soc\_card\_get\_drvdata(card); struct snd\_soc\_dai \*cpu\_dai = snd\_soc\_rtd\_to\_cpu(rtd, 0);+ struct sdw\_stream\_runtime \*sruntime = data->sruntime[cpu\_dai->id];  switch (cpu\_dai->id) { case PRIMARY\_MI2S\_RX:@@ -463,6 +465,9 @@ static void sdm845\_snd\_shutdown(struct snd\_pcm\_substream \*substream) pr\_err("%s: invalid dai id 0x%x\n", \_\_func\_\_, cpu\_dai->id); break; }++ data->sruntime[cpu\_dai->id] = NULL;+ sdw\_release\_stream(sruntime); }  static int sdm845\_snd\_prepare(struct snd\_pcm\_substream \*substream) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:27:14 +0000



=== Content from git.kernel.org_9523e2b9_20250115_092838.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexey Klimov <alexey.klimov@linaro.org> | 2024-10-09 22:39:22 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:43 +0100 |
| commit | [fc34d36879f87e5a3813fb66655b8bdb90c7b0d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8)) | |
| tree | [03ff1f8789e1fd8f81532c55284f92c3bec574af](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8) | |
| parent | [176a41ebec42a921277cd34e8c0c2e776a9dd6c4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=176a41ebec42a921277cd34e8c0c2e776a9dd6c4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8&id2=176a41ebec42a921277cd34e8c0c2e776a9dd6c4)) | |
| download | [linux-fc34d36879f87e5a3813fb66655b8bdb90c7b0d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fc34d36879f87e5a3813fb66655b8bdb90c7b0d8.tar.gz) | |

ASoC: qcom: sdm845: add missing soundwire runtime stream alloccommit d0e806b0cc6260b59c65e606034a63145169c04c upstream.
During the migration of Soundwire runtime stream allocation from
the Qualcomm Soundwire controller to SoC's soundcard drivers the sdm845
soundcard was forgotten.
At this point any playback attempt or audio daemon startup, for instance
on sdm845-db845c (Qualcomm RB3 board), will result in stream pointer
NULL dereference:
Unable to handle kernel NULL pointer dereference at virtual
address 0000000000000020
Mem abort info:
ESR = 0x0000000096000004
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
FSC = 0x04: level 0 translation fault
Data abort info:
ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
CM = 0, WnR = 0, TnD = 0, TagAccess = 0
GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
user pgtable: 4k pages, 48-bit VAs, pgdp=0000000101ecf000
[0000000000000020] pgd=0000000000000000, p4d=0000000000000000
Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
Modules linked in: ...
CPU: 5 UID: 0 PID: 1198 Comm: aplay
Not tainted 6.12.0-rc2-qcomlt-arm64-00059-g9d78f315a362-dirty #18
Hardware name: Thundercomm Dragonboard 845c (DT)
pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : sdw\_stream\_add\_slave+0x44/0x380 [soundwire\_bus]
lr : sdw\_stream\_add\_slave+0x44/0x380 [soundwire\_bus]
sp : ffff80008a2035c0
x29: ffff80008a2035c0 x28: ffff80008a203978 x27: 0000000000000000
x26: 00000000000000c0 x25: 0000000000000000 x24: ffff1676025f4800
x23: ffff167600ff1cb8 x22: ffff167600ff1c98 x21: 0000000000000003
x20: ffff167607316000 x19: ffff167604e64e80 x18: 0000000000000000
x17: 0000000000000000 x16: ffffcec265074160 x15: 0000000000000000
x14: 0000000000000000 x13: 0000000000000000 x12: 0000000000000000
x11: 0000000000000000 x10: 0000000000000000 x9 : 0000000000000000
x8 : 0000000000000000 x7 : 0000000000000000 x6 : ffff167600ff1cec
x5 : ffffcec22cfa2010 x4 : 0000000000000000 x3 : 0000000000000003
x2 : ffff167613f836c0 x1 : 0000000000000000 x0 : ffff16761feb60b8
Call trace:
sdw\_stream\_add\_slave+0x44/0x380 [soundwire\_bus]
wsa881x\_hw\_params+0x68/0x80 [snd\_soc\_wsa881x]
snd\_soc\_dai\_hw\_params+0x3c/0xa4
\_\_soc\_pcm\_hw\_params+0x230/0x660
dpcm\_be\_dai\_hw\_params+0x1d0/0x3f8
dpcm\_fe\_dai\_hw\_params+0x98/0x268
snd\_pcm\_hw\_params+0x124/0x460
snd\_pcm\_common\_ioctl+0x998/0x16e8
snd\_pcm\_ioctl+0x34/0x58
\_\_arm64\_sys\_ioctl+0xac/0xf8
invoke\_syscall+0x48/0x104
el0\_svc\_common.constprop.0+0x40/0xe0
do\_el0\_svc+0x1c/0x28
el0\_svc+0x34/0xe0
el0t\_64\_sync\_handler+0x120/0x12c
el0t\_64\_sync+0x190/0x194
Code: aa0403fb f9418400 9100e000 9400102f (f8420f22)
---[ end trace 0000000000000000 ]---
0000000000006108 <sdw\_stream\_add\_slave>:
6108: d503233f paciasp
610c: a9b97bfd stp x29, x30, [sp, #-112]!
6110: 910003fd mov x29, sp
6114: a90153f3 stp x19, x20, [sp, #16]
6118: a9025bf5 stp x21, x22, [sp, #32]
611c: aa0103f6 mov x22, x1
6120: 2a0303f5 mov w21, w3
6124: a90363f7 stp x23, x24, [sp, #48]
6128: aa0003f8 mov x24, x0
612c: aa0203f7 mov x23, x2
6130: a9046bf9 stp x25, x26, [sp, #64]
6134: aa0403f9 mov x25, x4 <-- x4 copied to x25
6138: a90573fb stp x27, x28, [sp, #80]
613c: aa0403fb mov x27, x4
6140: f9418400 ldr x0, [x0, #776]
6144: 9100e000 add x0, x0, #0x38
6148: 94000000 bl 0 <mutex\_lock>
614c: f8420f22 ldr x2, [x25, #32]! <-- offset 0x44
^^^
This is 0x6108 + offset 0x44 from the beginning of sdw\_stream\_add\_slave()
where data abort happens.
wsa881x\_hw\_params() is called with stream = NULL and passes it further
in register x4 (5th argument) to sdw\_stream\_add\_slave() without any checks.
Value from x4 is copied to x25 and finally it aborts on trying to load
a value from address in x25 plus offset 32 (in dec) which corresponds
to master\_list member in struct sdw\_stream\_runtime:
struct sdw\_stream\_runtime {
const char \* name; /\* 0 8 \*/
struct sdw\_stream\_params params; /\* 8 12 \*/
enum sdw\_stream\_state state; /\* 20 4 \*/
enum sdw\_stream\_type type; /\* 24 4 \*/
/\* XXX 4 bytes hole, try to pack \*/
here-> struct list\_head master\_list; /\* 32 16 \*/
int m\_rt\_count; /\* 48 4 \*/
/\* size: 56, cachelines: 1, members: 6 \*/
/\* sum members: 48, holes: 1, sum holes: 4 \*/
/\* padding: 4 \*/
/\* last cacheline: 56 bytes \*/
Fix this by adding required calls to qcom\_snd\_sdw\_startup() and
sdw\_release\_stream() to startup and shutdown routines which restores
the previous correct behaviour when ->set\_stream() method is called to
set a valid stream runtime pointer on playback startup.
Reproduced and then fix was tested on db845c RB3 board.
Reported-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Cc: stable@vger.kernel.org
Fixes: 15c7fab0e047 ("ASoC: qcom: Move Soundwire runtime stream alloc to soundcards")
Cc: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
Cc: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Cc: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
Cc: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Signed-off-by: Alexey Klimov <alexey.klimov@linaro.org>
Tested-by: Steev Klimaszewski <steev@kali.org> # Lenovo Yoga C630
Reviewed-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
Reviewed-by: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
Link: [https://patch.msgid.link/20241009213922.999355-1-alexey.klimov@linaro.org](https://patch.msgid.link/20241009213922.999355-1-alexey.klimov%40linaro.org)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8)

| -rw-r--r-- | [sound/soc/qcom/sdm845.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/qcom/sdm845.c?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/sound/soc/qcom/sdm845.c b/sound/soc/qcom/sdm845.cindex 75701546b6ea8b..a479d7e5b7fbdc 100644--- a/[sound/soc/qcom/sdm845.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/qcom/sdm845.c?id=176a41ebec42a921277cd34e8c0c2e776a9dd6c4)+++ b/[sound/soc/qcom/sdm845.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/qcom/sdm845.c?id=fc34d36879f87e5a3813fb66655b8bdb90c7b0d8)@@ -15,6 +15,7 @@ #include <uapi/linux/input-event-codes.h> #include "common.h" #include "qdsp6/q6afe.h"+#include "sdw.h" #include "../codecs/rt5663.h"  #define DRIVER\_NAME "sdm845"@@ -416,7 +417,7 @@ static int sdm845\_snd\_startup(struct snd\_pcm\_substream \*substream) pr\_err("%s: invalid dai id 0x%x\n", \_\_func\_\_, cpu\_dai->id); break; }- return 0;+ return qcom\_snd\_sdw\_startup(substream); }  static void sdm845\_snd\_shutdown(struct snd\_pcm\_substream \*substream)@@ -425,6 +426,7 @@ static void sdm845\_snd\_shutdown(struct snd\_pcm\_substream \*substream) struct snd\_soc\_card \*card = rtd->card; struct sdm845\_snd\_data \*data = snd\_soc\_card\_get\_drvdata(card); struct snd\_soc\_dai \*cpu\_dai = snd\_soc\_rtd\_to\_cpu(rtd, 0);+ struct sdw\_stream\_runtime \*sruntime = data->sruntime[cpu\_dai->id];  switch (cpu\_dai->id) { case PRIMARY\_MI2S\_RX:@@ -463,6 +465,9 @@ static void sdm845\_snd\_shutdown(struct snd\_pcm\_substream \*substream) pr\_err("%s: invalid dai id 0x%x\n", \_\_func\_\_, cpu\_dai->id); break; }++ data->sruntime[cpu\_dai->id] = NULL;+ sdw\_release\_stream(sruntime); }  static int sdm845\_snd\_prepare(struct snd\_pcm\_substream \*substream) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:27:15 +0000


