=== Content from git.kernel.org_5cb5724b_20250114_185912.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Brown <broonie@kernel.org> | 2024-10-30 20:23:50 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:19:38 +0100 |
| commit | [51d11ea0250d6ee461987403bbfd4b2abb5613a7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7)) | |
| tree | [519490b424646982b68487d5b4f782d0bf31aa23](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7) | |
| parent | [30db2a6485502d963de6cb867ca4cef2903d08ad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30db2a6485502d963de6cb867ca4cef2903d08ad) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7&id2=30db2a6485502d963de6cb867ca4cef2903d08ad)) | |
| download | [linux-51d11ea0250d6ee461987403bbfd4b2abb5613a7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-51d11ea0250d6ee461987403bbfd4b2abb5613a7.tar.gz) | |

arm64/sve: Discard stale CPU state when handling SVE trapscommit 751ecf6afd6568adc98f2a6052315552c0483d18 upstream.
The logic for handling SVE traps manipulates saved FPSIMD/SVE state
incorrectly, and a race with preemption can result in a task having
TIF\_SVE set and TIF\_FOREIGN\_FPSTATE clear even though the live CPU state
is stale (e.g. with SVE traps enabled). This has been observed to result
in warnings from do\_sve\_acc() where SVE traps are not expected while
TIF\_SVE is set:
| if (test\_and\_set\_thread\_flag(TIF\_SVE))
| WARN\_ON(1); /\* SVE access shouldn't have trapped \*/
Warnings of this form have been reported intermittently, e.g.
https://lore.kernel.org/linux-arm-kernel/CA+G9fYtEGe\_DhY2Ms7+L7NKsLYUomGsgqpdBj+QwDLeSg=JhGg@mail.gmail.com/
https://lore.kernel.org/linux-arm-kernel/000000000000511e9a060ce5a45c@google.com/
The race can occur when the SVE trap handler is preempted before and
after manipulating the saved FPSIMD/SVE state, starting and ending on
the same CPU, e.g.
| void do\_sve\_acc(unsigned long esr, struct pt\_regs \*regs)
| {
| // Trap on CPU 0 with TIF\_SVE clear, SVE traps enabled
| // task->fpsimd\_cpu is 0.
| // per\_cpu\_ptr(&fpsimd\_last\_state, 0) is task.
|
| ...
|
| // Preempted; migrated from CPU 0 to CPU 1.
| // TIF\_FOREIGN\_FPSTATE is set.
|
| get\_cpu\_fpsimd\_context();
|
| if (test\_and\_set\_thread\_flag(TIF\_SVE))
| WARN\_ON(1); /\* SVE access shouldn't have trapped \*/
|
| sve\_init\_regs() {
| if (!test\_thread\_flag(TIF\_FOREIGN\_FPSTATE)) {
| ...
| } else {
| fpsimd\_to\_sve(current);
| current->thread.fp\_type = FP\_STATE\_SVE;
| }
| }
|
| put\_cpu\_fpsimd\_context();
|
| // Preempted; migrated from CPU 1 to CPU 0.
| // task->fpsimd\_cpu is still 0
| // If per\_cpu\_ptr(&fpsimd\_last\_state, 0) is still task then:
| // - Stale HW state is reused (with SVE traps enabled)
| // - TIF\_FOREIGN\_FPSTATE is cleared
| // - A return to userspace skips HW state restore
| }
Fix the case where the state is not live and TIF\_FOREIGN\_FPSTATE is set
by calling fpsimd\_flush\_task\_state() to detach from the saved CPU
state. This ensures that a subsequent context switch will not reuse the
stale CPU state, and will instead set TIF\_FOREIGN\_FPSTATE, forcing the
new state to be reloaded from memory prior to a return to userspace.
Fixes: cccb78ce89c4 ("arm64/sve: Rework SVE access trap to convert state in registers")
Reported-by: Mark Rutland <mark.rutland@arm.com>
Signed-off-by: Mark Brown <broonie@kernel.org>
Cc: stable@vger.kernel.org
Reviewed-by: Mark Rutland <mark.rutland@arm.com>
Link: [https://lore.kernel.org/r/20241030-arm64-fpsimd-foreign-flush-v1-1-bd7bd66905a2@kernel.org](https://lore.kernel.org/r/20241030-arm64-fpsimd-foreign-flush-v1-1-bd7bd66905a2%40kernel.org)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7)

| -rw-r--r-- | [arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/fpsimd.c?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/arch/arm64/kernel/fpsimd.c b/arch/arm64/kernel/fpsimd.cindex 5cdfcc9e3e54b9..0137d987631e08 100644--- a/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=30db2a6485502d963de6cb867ca4cef2903d08ad)+++ b/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=51d11ea0250d6ee461987403bbfd4b2abb5613a7)@@ -1445,6 +1445,7 @@ static void sve\_init\_regs(void) } else { fpsimd\_to\_sve(current); current->thread.fp\_type = FP\_STATE\_SVE;+ fpsimd\_flush\_task\_state(current); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:57:49 +0000



=== Content from git.kernel.org_65f7c07f_20250114_185916.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Brown <broonie@kernel.org> | 2024-10-30 20:23:50 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:09 +0100 |
| commit | [fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9)) | |
| tree | [989ebb28eb902227fac80c20c1f81576fb0894f7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9) | |
| parent | [1451b74e6f8d2631679085fd3663e55e166e68d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1451b74e6f8d2631679085fd3663e55e166e68d2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9&id2=1451b74e6f8d2631679085fd3663e55e166e68d2)) | |
| download | [linux-fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9.tar.gz) | |

arm64/sve: Discard stale CPU state when handling SVE trapscommit 751ecf6afd6568adc98f2a6052315552c0483d18 upstream.
The logic for handling SVE traps manipulates saved FPSIMD/SVE state
incorrectly, and a race with preemption can result in a task having
TIF\_SVE set and TIF\_FOREIGN\_FPSTATE clear even though the live CPU state
is stale (e.g. with SVE traps enabled). This has been observed to result
in warnings from do\_sve\_acc() where SVE traps are not expected while
TIF\_SVE is set:
| if (test\_and\_set\_thread\_flag(TIF\_SVE))
| WARN\_ON(1); /\* SVE access shouldn't have trapped \*/
Warnings of this form have been reported intermittently, e.g.
https://lore.kernel.org/linux-arm-kernel/CA+G9fYtEGe\_DhY2Ms7+L7NKsLYUomGsgqpdBj+QwDLeSg=JhGg@mail.gmail.com/
https://lore.kernel.org/linux-arm-kernel/000000000000511e9a060ce5a45c@google.com/
The race can occur when the SVE trap handler is preempted before and
after manipulating the saved FPSIMD/SVE state, starting and ending on
the same CPU, e.g.
| void do\_sve\_acc(unsigned long esr, struct pt\_regs \*regs)
| {
| // Trap on CPU 0 with TIF\_SVE clear, SVE traps enabled
| // task->fpsimd\_cpu is 0.
| // per\_cpu\_ptr(&fpsimd\_last\_state, 0) is task.
|
| ...
|
| // Preempted; migrated from CPU 0 to CPU 1.
| // TIF\_FOREIGN\_FPSTATE is set.
|
| get\_cpu\_fpsimd\_context();
|
| if (test\_and\_set\_thread\_flag(TIF\_SVE))
| WARN\_ON(1); /\* SVE access shouldn't have trapped \*/
|
| sve\_init\_regs() {
| if (!test\_thread\_flag(TIF\_FOREIGN\_FPSTATE)) {
| ...
| } else {
| fpsimd\_to\_sve(current);
| current->thread.fp\_type = FP\_STATE\_SVE;
| }
| }
|
| put\_cpu\_fpsimd\_context();
|
| // Preempted; migrated from CPU 1 to CPU 0.
| // task->fpsimd\_cpu is still 0
| // If per\_cpu\_ptr(&fpsimd\_last\_state, 0) is still task then:
| // - Stale HW state is reused (with SVE traps enabled)
| // - TIF\_FOREIGN\_FPSTATE is cleared
| // - A return to userspace skips HW state restore
| }
Fix the case where the state is not live and TIF\_FOREIGN\_FPSTATE is set
by calling fpsimd\_flush\_task\_state() to detach from the saved CPU
state. This ensures that a subsequent context switch will not reuse the
stale CPU state, and will instead set TIF\_FOREIGN\_FPSTATE, forcing the
new state to be reloaded from memory prior to a return to userspace.
Fixes: cccb78ce89c4 ("arm64/sve: Rework SVE access trap to convert state in registers")
Reported-by: Mark Rutland <mark.rutland@arm.com>
Signed-off-by: Mark Brown <broonie@kernel.org>
Cc: stable@vger.kernel.org
Reviewed-by: Mark Rutland <mark.rutland@arm.com>
Link: [https://lore.kernel.org/r/20241030-arm64-fpsimd-foreign-flush-v1-1-bd7bd66905a2@kernel.org](https://lore.kernel.org/r/20241030-arm64-fpsimd-foreign-flush-v1-1-bd7bd66905a2%40kernel.org)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9)

| -rw-r--r-- | [arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/fpsimd.c?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/arch/arm64/kernel/fpsimd.c b/arch/arm64/kernel/fpsimd.cindex 77006df20a75ae..6d21971ae5594f 100644--- a/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=1451b74e6f8d2631679085fd3663e55e166e68d2)+++ b/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=fa9ce027b3ce37a2bb173bf2553b5caa438fd8c9)@@ -1367,6 +1367,7 @@ static void sve\_init\_regs(void) } else { fpsimd\_to\_sve(current); current->thread.fp\_type = FP\_STATE\_SVE;+ fpsimd\_flush\_task\_state(current); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:57:52 +0000



=== Content from git.kernel.org_28368dff_20250114_185914.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=de529504b3274d57caf8f66800b714b0d3ee235a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de529504b3274d57caf8f66800b714b0d3ee235a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de529504b3274d57caf8f66800b714b0d3ee235a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de529504b3274d57caf8f66800b714b0d3ee235a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Brown <broonie@kernel.org> | 2024-10-30 20:23:50 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:54:53 +0100 |
| commit | [de529504b3274d57caf8f66800b714b0d3ee235a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de529504b3274d57caf8f66800b714b0d3ee235a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=de529504b3274d57caf8f66800b714b0d3ee235a)) | |
| tree | [dc2c2a65ac52d61bd08289a9cfc4cd3a1f4d804d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de529504b3274d57caf8f66800b714b0d3ee235a) | |
| parent | [7d687b98747eb016d26f6504db401eb9d18c241e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d687b98747eb016d26f6504db401eb9d18c241e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de529504b3274d57caf8f66800b714b0d3ee235a&id2=7d687b98747eb016d26f6504db401eb9d18c241e)) | |
| download | [linux-de529504b3274d57caf8f66800b714b0d3ee235a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-de529504b3274d57caf8f66800b714b0d3ee235a.tar.gz) | |

arm64/sve: Discard stale CPU state when handling SVE trapscommit 751ecf6afd6568adc98f2a6052315552c0483d18 upstream.
The logic for handling SVE traps manipulates saved FPSIMD/SVE state
incorrectly, and a race with preemption can result in a task having
TIF\_SVE set and TIF\_FOREIGN\_FPSTATE clear even though the live CPU state
is stale (e.g. with SVE traps enabled). This has been observed to result
in warnings from do\_sve\_acc() where SVE traps are not expected while
TIF\_SVE is set:
| if (test\_and\_set\_thread\_flag(TIF\_SVE))
| WARN\_ON(1); /\* SVE access shouldn't have trapped \*/
Warnings of this form have been reported intermittently, e.g.
https://lore.kernel.org/linux-arm-kernel/CA+G9fYtEGe\_DhY2Ms7+L7NKsLYUomGsgqpdBj+QwDLeSg=JhGg@mail.gmail.com/
https://lore.kernel.org/linux-arm-kernel/000000000000511e9a060ce5a45c@google.com/
The race can occur when the SVE trap handler is preempted before and
after manipulating the saved FPSIMD/SVE state, starting and ending on
the same CPU, e.g.
| void do\_sve\_acc(unsigned long esr, struct pt\_regs \*regs)
| {
| // Trap on CPU 0 with TIF\_SVE clear, SVE traps enabled
| // task->fpsimd\_cpu is 0.
| // per\_cpu\_ptr(&fpsimd\_last\_state, 0) is task.
|
| ...
|
| // Preempted; migrated from CPU 0 to CPU 1.
| // TIF\_FOREIGN\_FPSTATE is set.
|
| get\_cpu\_fpsimd\_context();
|
| if (test\_and\_set\_thread\_flag(TIF\_SVE))
| WARN\_ON(1); /\* SVE access shouldn't have trapped \*/
|
| sve\_init\_regs() {
| if (!test\_thread\_flag(TIF\_FOREIGN\_FPSTATE)) {
| ...
| } else {
| fpsimd\_to\_sve(current);
| current->thread.fp\_type = FP\_STATE\_SVE;
| }
| }
|
| put\_cpu\_fpsimd\_context();
|
| // Preempted; migrated from CPU 1 to CPU 0.
| // task->fpsimd\_cpu is still 0
| // If per\_cpu\_ptr(&fpsimd\_last\_state, 0) is still task then:
| // - Stale HW state is reused (with SVE traps enabled)
| // - TIF\_FOREIGN\_FPSTATE is cleared
| // - A return to userspace skips HW state restore
| }
Fix the case where the state is not live and TIF\_FOREIGN\_FPSTATE is set
by calling fpsimd\_flush\_task\_state() to detach from the saved CPU
state. This ensures that a subsequent context switch will not reuse the
stale CPU state, and will instead set TIF\_FOREIGN\_FPSTATE, forcing the
new state to be reloaded from memory prior to a return to userspace.
Fixes: cccb78ce89c4 ("arm64/sve: Rework SVE access trap to convert state in registers")
Reported-by: Mark Rutland <mark.rutland@arm.com>
Signed-off-by: Mark Brown <broonie@kernel.org>
Cc: stable@vger.kernel.org
Reviewed-by: Mark Rutland <mark.rutland@arm.com>
Link: [https://lore.kernel.org/r/20241030-arm64-fpsimd-foreign-flush-v1-1-bd7bd66905a2@kernel.org](https://lore.kernel.org/r/20241030-arm64-fpsimd-foreign-flush-v1-1-bd7bd66905a2%40kernel.org)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de529504b3274d57caf8f66800b714b0d3ee235a)

| -rw-r--r-- | [arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/fpsimd.c?id=de529504b3274d57caf8f66800b714b0d3ee235a) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/arch/arm64/kernel/fpsimd.c b/arch/arm64/kernel/fpsimd.cindex 59b5a16bab5d6b..43afe07c74fdf8 100644--- a/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=7d687b98747eb016d26f6504db401eb9d18c241e)+++ b/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=de529504b3274d57caf8f66800b714b0d3ee235a)@@ -1383,6 +1383,7 @@ static void sve\_init\_regs(void) fpsimd\_bind\_task\_to\_cpu(); } else { fpsimd\_to\_sve(current);+ fpsimd\_flush\_task\_state(current); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:57:52 +0000



=== Content from git.kernel.org_6a04730c_20250114_185913.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Brown <broonie@kernel.org> | 2024-10-30 20:23:50 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:46 +0100 |
| commit | [51d3d80a6dc314982a9a0aeb0961085922a1aa15](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15)) | |
| tree | [2d4eeebbacc171877dd8dba74f750409f61806ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15) | |
| parent | [221a2c898962aa29773613be7fea8a7aedcc31ae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=221a2c898962aa29773613be7fea8a7aedcc31ae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15&id2=221a2c898962aa29773613be7fea8a7aedcc31ae)) | |
| download | [linux-51d3d80a6dc314982a9a0aeb0961085922a1aa15.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-51d3d80a6dc314982a9a0aeb0961085922a1aa15.tar.gz) | |

arm64/sve: Discard stale CPU state when handling SVE trapscommit 751ecf6afd6568adc98f2a6052315552c0483d18 upstream.
The logic for handling SVE traps manipulates saved FPSIMD/SVE state
incorrectly, and a race with preemption can result in a task having
TIF\_SVE set and TIF\_FOREIGN\_FPSTATE clear even though the live CPU state
is stale (e.g. with SVE traps enabled). This has been observed to result
in warnings from do\_sve\_acc() where SVE traps are not expected while
TIF\_SVE is set:
| if (test\_and\_set\_thread\_flag(TIF\_SVE))
| WARN\_ON(1); /\* SVE access shouldn't have trapped \*/
Warnings of this form have been reported intermittently, e.g.
https://lore.kernel.org/linux-arm-kernel/CA+G9fYtEGe\_DhY2Ms7+L7NKsLYUomGsgqpdBj+QwDLeSg=JhGg@mail.gmail.com/
https://lore.kernel.org/linux-arm-kernel/000000000000511e9a060ce5a45c@google.com/
The race can occur when the SVE trap handler is preempted before and
after manipulating the saved FPSIMD/SVE state, starting and ending on
the same CPU, e.g.
| void do\_sve\_acc(unsigned long esr, struct pt\_regs \*regs)
| {
| // Trap on CPU 0 with TIF\_SVE clear, SVE traps enabled
| // task->fpsimd\_cpu is 0.
| // per\_cpu\_ptr(&fpsimd\_last\_state, 0) is task.
|
| ...
|
| // Preempted; migrated from CPU 0 to CPU 1.
| // TIF\_FOREIGN\_FPSTATE is set.
|
| get\_cpu\_fpsimd\_context();
|
| if (test\_and\_set\_thread\_flag(TIF\_SVE))
| WARN\_ON(1); /\* SVE access shouldn't have trapped \*/
|
| sve\_init\_regs() {
| if (!test\_thread\_flag(TIF\_FOREIGN\_FPSTATE)) {
| ...
| } else {
| fpsimd\_to\_sve(current);
| current->thread.fp\_type = FP\_STATE\_SVE;
| }
| }
|
| put\_cpu\_fpsimd\_context();
|
| // Preempted; migrated from CPU 1 to CPU 0.
| // task->fpsimd\_cpu is still 0
| // If per\_cpu\_ptr(&fpsimd\_last\_state, 0) is still task then:
| // - Stale HW state is reused (with SVE traps enabled)
| // - TIF\_FOREIGN\_FPSTATE is cleared
| // - A return to userspace skips HW state restore
| }
Fix the case where the state is not live and TIF\_FOREIGN\_FPSTATE is set
by calling fpsimd\_flush\_task\_state() to detach from the saved CPU
state. This ensures that a subsequent context switch will not reuse the
stale CPU state, and will instead set TIF\_FOREIGN\_FPSTATE, forcing the
new state to be reloaded from memory prior to a return to userspace.
Fixes: cccb78ce89c4 ("arm64/sve: Rework SVE access trap to convert state in registers")
Reported-by: Mark Rutland <mark.rutland@arm.com>
Signed-off-by: Mark Brown <broonie@kernel.org>
Cc: stable@vger.kernel.org
Reviewed-by: Mark Rutland <mark.rutland@arm.com>
Link: [https://lore.kernel.org/r/20241030-arm64-fpsimd-foreign-flush-v1-1-bd7bd66905a2@kernel.org](https://lore.kernel.org/r/20241030-arm64-fpsimd-foreign-flush-v1-1-bd7bd66905a2%40kernel.org)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15)

| -rw-r--r-- | [arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/fpsimd.c?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/arch/arm64/kernel/fpsimd.c b/arch/arm64/kernel/fpsimd.cindex 7a3fcf21b18a73..e22571e57ae1ec 100644--- a/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=221a2c898962aa29773613be7fea8a7aedcc31ae)+++ b/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=51d3d80a6dc314982a9a0aeb0961085922a1aa15)@@ -964,6 +964,7 @@ void do\_sve\_acc(unsigned long esr, struct pt\_regs \*regs) fpsimd\_bind\_task\_to\_cpu(); } else { fpsimd\_to\_sve(current);+ fpsimd\_flush\_task\_state(current); }  put\_cpu\_fpsimd\_context(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:57:50 +0000



=== Content from git.kernel.org_9d818b07_20250114_185914.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=751ecf6afd6568adc98f2a6052315552c0483d18)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=751ecf6afd6568adc98f2a6052315552c0483d18)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=751ecf6afd6568adc98f2a6052315552c0483d18)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=751ecf6afd6568adc98f2a6052315552c0483d18)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mark Brown <broonie@kernel.org> | 2024-10-30 20:23:50 +0000 |
| --- | --- | --- |
| committer | Will Deacon <will@kernel.org> | 2024-11-06 13:49:39 +0000 |
| commit | [751ecf6afd6568adc98f2a6052315552c0483d18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=751ecf6afd6568adc98f2a6052315552c0483d18) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=751ecf6afd6568adc98f2a6052315552c0483d18)) | |
| tree | [2df4b6259102df6441960ef36c3928e1095d6e14](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=751ecf6afd6568adc98f2a6052315552c0483d18) | |
| parent | [2e8a1acea8597ff42189ea94f0a63fa58640223d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e8a1acea8597ff42189ea94f0a63fa58640223d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=751ecf6afd6568adc98f2a6052315552c0483d18&id2=2e8a1acea8597ff42189ea94f0a63fa58640223d)) | |
| download | [linux-751ecf6afd6568adc98f2a6052315552c0483d18.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-751ecf6afd6568adc98f2a6052315552c0483d18.tar.gz) | |

arm64/sve: Discard stale CPU state when handling SVE trapsThe logic for handling SVE traps manipulates saved FPSIMD/SVE state
incorrectly, and a race with preemption can result in a task having
TIF\_SVE set and TIF\_FOREIGN\_FPSTATE clear even though the live CPU state
is stale (e.g. with SVE traps enabled). This has been observed to result
in warnings from do\_sve\_acc() where SVE traps are not expected while
TIF\_SVE is set:
| if (test\_and\_set\_thread\_flag(TIF\_SVE))
| WARN\_ON(1); /\* SVE access shouldn't have trapped \*/
Warnings of this form have been reported intermittently, e.g.
https://lore.kernel.org/linux-arm-kernel/CA+G9fYtEGe\_DhY2Ms7+L7NKsLYUomGsgqpdBj+QwDLeSg=JhGg@mail.gmail.com/
https://lore.kernel.org/linux-arm-kernel/000000000000511e9a060ce5a45c@google.com/
The race can occur when the SVE trap handler is preempted before and
after manipulating the saved FPSIMD/SVE state, starting and ending on
the same CPU, e.g.
| void do\_sve\_acc(unsigned long esr, struct pt\_regs \*regs)
| {
| // Trap on CPU 0 with TIF\_SVE clear, SVE traps enabled
| // task->fpsimd\_cpu is 0.
| // per\_cpu\_ptr(&fpsimd\_last\_state, 0) is task.
|
| ...
|
| // Preempted; migrated from CPU 0 to CPU 1.
| // TIF\_FOREIGN\_FPSTATE is set.
|
| get\_cpu\_fpsimd\_context();
|
| if (test\_and\_set\_thread\_flag(TIF\_SVE))
| WARN\_ON(1); /\* SVE access shouldn't have trapped \*/
|
| sve\_init\_regs() {
| if (!test\_thread\_flag(TIF\_FOREIGN\_FPSTATE)) {
| ...
| } else {
| fpsimd\_to\_sve(current);
| current->thread.fp\_type = FP\_STATE\_SVE;
| }
| }
|
| put\_cpu\_fpsimd\_context();
|
| // Preempted; migrated from CPU 1 to CPU 0.
| // task->fpsimd\_cpu is still 0
| // If per\_cpu\_ptr(&fpsimd\_last\_state, 0) is still task then:
| // - Stale HW state is reused (with SVE traps enabled)
| // - TIF\_FOREIGN\_FPSTATE is cleared
| // - A return to userspace skips HW state restore
| }
Fix the case where the state is not live and TIF\_FOREIGN\_FPSTATE is set
by calling fpsimd\_flush\_task\_state() to detach from the saved CPU
state. This ensures that a subsequent context switch will not reuse the
stale CPU state, and will instead set TIF\_FOREIGN\_FPSTATE, forcing the
new state to be reloaded from memory prior to a return to userspace.
Fixes: cccb78ce89c4 ("arm64/sve: Rework SVE access trap to convert state in registers")
Reported-by: Mark Rutland <mark.rutland@arm.com>
Signed-off-by: Mark Brown <broonie@kernel.org>
Cc: stable@vger.kernel.org
Reviewed-by: Mark Rutland <mark.rutland@arm.com>
Link: [https://lore.kernel.org/r/20241030-arm64-fpsimd-foreign-flush-v1-1-bd7bd66905a2@kernel.org](https://lore.kernel.org/r/20241030-arm64-fpsimd-foreign-flush-v1-1-bd7bd66905a2%40kernel.org)
Signed-off-by: Will Deacon <will@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=751ecf6afd6568adc98f2a6052315552c0483d18)

| -rw-r--r-- | [arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kernel/fpsimd.c?id=751ecf6afd6568adc98f2a6052315552c0483d18) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/arch/arm64/kernel/fpsimd.c b/arch/arm64/kernel/fpsimd.cindex 77006df20a75ae..6d21971ae5594f 100644--- a/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=2e8a1acea8597ff42189ea94f0a63fa58640223d)+++ b/[arch/arm64/kernel/fpsimd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kernel/fpsimd.c?id=751ecf6afd6568adc98f2a6052315552c0483d18)@@ -1367,6 +1367,7 @@ static void sve\_init\_regs(void) } else { fpsimd\_to\_sve(current); current->thread.fp\_type = FP\_STATE\_SVE;+ fpsimd\_flush\_task\_state(current); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:57:51 +0000


