=== Content from git.kernel.org_f421ea63_20250114_183612.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shawn Wang <shawnwang@linux.alibaba.com> | 2024-10-25 10:22:08 +0800 |
| --- | --- | --- |
| committer | Peter Zijlstra <peterz@infradead.org> | 2024-10-26 09:28:37 +0200 |
| commit | [9c70b2a33cd2aa6a5a59c5523ef053bd42265209](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209)) | |
| tree | [dfcb12a6010e0c5cc986861834ab3582d435ccf6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209) | |
| parent | [b55945c500c5723992504aa03b362fab416863a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b55945c500c5723992504aa03b362fab416863a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209&id2=b55945c500c5723992504aa03b362fab416863a6)) | |
| download | [linux-9c70b2a33cd2aa6a5a59c5523ef053bd42265209.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9c70b2a33cd2aa6a5a59c5523ef053bd42265209.tar.gz) | |

sched/numa: Fix the potential null pointer dereference in task\_numa\_work()When running stress-ng-vm-segv test, we found a null pointer dereference
error in task\_numa\_work(). Here is the backtrace:
[323676.066985] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
......
[323676.067108] CPU: 35 PID: 2694524 Comm: stress-ng-vm-se
......
[323676.067113] pstate: 23401009 (nzCv daif +PAN -UAO +TCO +DIT +SSBS BTYPE=--)
[323676.067115] pc : vma\_migratable+0x1c/0xd0
[323676.067122] lr : task\_numa\_work+0x1ec/0x4e0
[323676.067127] sp : ffff8000ada73d20
[323676.067128] x29: ffff8000ada73d20 x28: 0000000000000000 x27: 000000003e89f010
[323676.067130] x26: 0000000000080000 x25: ffff800081b5c0d8 x24: ffff800081b27000
[323676.067133] x23: 0000000000010000 x22: 0000000104d18cc0 x21: ffff0009f7158000
[323676.067135] x20: 0000000000000000 x19: 0000000000000000 x18: ffff8000ada73db8
[323676.067138] x17: 0001400000000000 x16: ffff800080df40b0 x15: 0000000000000035
[323676.067140] x14: ffff8000ada73cc8 x13: 1fffe0017cc72001 x12: ffff8000ada73cc8
[323676.067142] x11: ffff80008001160c x10: ffff000be639000c x9 : ffff8000800f4ba4
[323676.067145] x8 : ffff000810375000 x7 : ffff8000ada73974 x6 : 0000000000000001
[323676.067147] x5 : 0068000b33e26707 x4 : 0000000000000001 x3 : ffff0009f7158000
[323676.067149] x2 : 0000000000000041 x1 : 0000000000004400 x0 : 0000000000000000
[323676.067152] Call trace:
[323676.067153] vma\_migratable+0x1c/0xd0
[323676.067155] task\_numa\_work+0x1ec/0x4e0
[323676.067157] task\_work\_run+0x78/0xd8
[323676.067161] do\_notify\_resume+0x1ec/0x290
[323676.067163] el0\_svc+0x150/0x160
[323676.067167] el0t\_64\_sync\_handler+0xf8/0x128
[323676.067170] el0t\_64\_sync+0x17c/0x180
[323676.067173] Code: d2888001 910003fd f9000bf3 aa0003f3 (f9401000)
[323676.067177] SMP: stopping secondary CPUs
[323676.070184] Starting crashdump kernel...
stress-ng-vm-segv in stress-ng is used to stress test the SIGSEGV error
handling function of the system, which tries to cause a SIGSEGV error on
return from unmapping the whole address space of the child process.
Normally this program will not cause kernel crashes. But before the
munmap system call returns to user mode, a potential task\_numa\_work()
for numa balancing could be added and executed. In this scenario, since the
child process has no vma after munmap, the vma\_next() in task\_numa\_work()
will return a null pointer even if the vma iterator restarts from 0.
Recheck the vma pointer before dereferencing it in task\_numa\_work().
Fixes: 214dbc428137 ("sched: convert to vma iterator")
Signed-off-by: Shawn Wang <shawnwang@linux.alibaba.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Cc: stable@vger.kernel.org # v6.2+
Link: [https://lkml.kernel.org/r/20241025022208.125527-1-shawnwang@linux.alibaba.com](https://lkml.kernel.org/r/20241025022208.125527-1-shawnwang%40linux.alibaba.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209)

| -rw-r--r-- | [kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/sched/fair.c?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/kernel/sched/fair.c b/kernel/sched/fair.cindex 879614686188d3..2d16c8545c71ed 100644--- a/[kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/fair.c?id=b55945c500c5723992504aa03b362fab416863a6)+++ b/[kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/fair.c?id=9c70b2a33cd2aa6a5a59c5523ef053bd42265209)@@ -3369,7 +3369,7 @@ retry\_pids: vma = vma\_next(&vmi); } - do {+ for (; vma; vma = vma\_next(&vmi)) { if (!vma\_migratable(vma) || !vma\_policy\_mof(vma) || is\_vm\_hugetlb\_page(vma) || (vma->vm\_flags & VM\_MIXEDMAP)) { trace\_sched\_skip\_vma\_numa(mm, vma, NUMAB\_SKIP\_UNSUITABLE);@@ -3491,7 +3491,7 @@ retry\_pids: \*/ if (vma\_pids\_forced) break;- } for\_each\_vma(vmi, vma);+ }  /\* \* If no VMAs are remaining and VMAs were skipped due to the PID |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:34:49 +0000



=== Content from git.kernel.org_d90fb42d_20250114_183612.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ade91f6e9848b370add44d89c976e070ccb492ef)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ade91f6e9848b370add44d89c976e070ccb492ef)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ade91f6e9848b370add44d89c976e070ccb492ef)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ade91f6e9848b370add44d89c976e070ccb492ef)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shawn Wang <shawnwang@linux.alibaba.com> | 2024-10-25 10:22:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:25 +0100 |
| commit | [ade91f6e9848b370add44d89c976e070ccb492ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ade91f6e9848b370add44d89c976e070ccb492ef) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ade91f6e9848b370add44d89c976e070ccb492ef)) | |
| tree | [a2bdde9a678e7fce3c7cc6a9a52fee67f32fe4a6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ade91f6e9848b370add44d89c976e070ccb492ef) | |
| parent | [8c9a1ec39c698cbc38f4efa9113185f885137f8b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c9a1ec39c698cbc38f4efa9113185f885137f8b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ade91f6e9848b370add44d89c976e070ccb492ef&id2=8c9a1ec39c698cbc38f4efa9113185f885137f8b)) | |
| download | [linux-ade91f6e9848b370add44d89c976e070ccb492ef.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ade91f6e9848b370add44d89c976e070ccb492ef.tar.gz) | |

sched/numa: Fix the potential null pointer dereference in task\_numa\_work()[ Upstream commit 9c70b2a33cd2aa6a5a59c5523ef053bd42265209 ]
When running stress-ng-vm-segv test, we found a null pointer dereference
error in task\_numa\_work(). Here is the backtrace:
[323676.066985] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
......
[323676.067108] CPU: 35 PID: 2694524 Comm: stress-ng-vm-se
......
[323676.067113] pstate: 23401009 (nzCv daif +PAN -UAO +TCO +DIT +SSBS BTYPE=--)
[323676.067115] pc : vma\_migratable+0x1c/0xd0
[323676.067122] lr : task\_numa\_work+0x1ec/0x4e0
[323676.067127] sp : ffff8000ada73d20
[323676.067128] x29: ffff8000ada73d20 x28: 0000000000000000 x27: 000000003e89f010
[323676.067130] x26: 0000000000080000 x25: ffff800081b5c0d8 x24: ffff800081b27000
[323676.067133] x23: 0000000000010000 x22: 0000000104d18cc0 x21: ffff0009f7158000
[323676.067135] x20: 0000000000000000 x19: 0000000000000000 x18: ffff8000ada73db8
[323676.067138] x17: 0001400000000000 x16: ffff800080df40b0 x15: 0000000000000035
[323676.067140] x14: ffff8000ada73cc8 x13: 1fffe0017cc72001 x12: ffff8000ada73cc8
[323676.067142] x11: ffff80008001160c x10: ffff000be639000c x9 : ffff8000800f4ba4
[323676.067145] x8 : ffff000810375000 x7 : ffff8000ada73974 x6 : 0000000000000001
[323676.067147] x5 : 0068000b33e26707 x4 : 0000000000000001 x3 : ffff0009f7158000
[323676.067149] x2 : 0000000000000041 x1 : 0000000000004400 x0 : 0000000000000000
[323676.067152] Call trace:
[323676.067153] vma\_migratable+0x1c/0xd0
[323676.067155] task\_numa\_work+0x1ec/0x4e0
[323676.067157] task\_work\_run+0x78/0xd8
[323676.067161] do\_notify\_resume+0x1ec/0x290
[323676.067163] el0\_svc+0x150/0x160
[323676.067167] el0t\_64\_sync\_handler+0xf8/0x128
[323676.067170] el0t\_64\_sync+0x17c/0x180
[323676.067173] Code: d2888001 910003fd f9000bf3 aa0003f3 (f9401000)
[323676.067177] SMP: stopping secondary CPUs
[323676.070184] Starting crashdump kernel...
stress-ng-vm-segv in stress-ng is used to stress test the SIGSEGV error
handling function of the system, which tries to cause a SIGSEGV error on
return from unmapping the whole address space of the child process.
Normally this program will not cause kernel crashes. But before the
munmap system call returns to user mode, a potential task\_numa\_work()
for numa balancing could be added and executed. In this scenario, since the
child process has no vma after munmap, the vma\_next() in task\_numa\_work()
will return a null pointer even if the vma iterator restarts from 0.
Recheck the vma pointer before dereferencing it in task\_numa\_work().
Fixes: 214dbc428137 ("sched: convert to vma iterator")
Signed-off-by: Shawn Wang <shawnwang@linux.alibaba.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Cc: stable@vger.kernel.org # v6.2+
Link: [https://lkml.kernel.org/r/20241025022208.125527-1-shawnwang@linux.alibaba.com](https://lkml.kernel.org/r/20241025022208.125527-1-shawnwang%40linux.alibaba.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ade91f6e9848b370add44d89c976e070ccb492ef)

| -rw-r--r-- | [kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/sched/fair.c?id=ade91f6e9848b370add44d89c976e070ccb492ef) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/kernel/sched/fair.c b/kernel/sched/fair.cindex 5eb4807bad209c..db59bf549c644b 100644--- a/[kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/fair.c?id=8c9a1ec39c698cbc38f4efa9113185f885137f8b)+++ b/[kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/fair.c?id=ade91f6e9848b370add44d89c976e070ccb492ef)@@ -3314,7 +3314,7 @@ retry\_pids: vma = vma\_next(&vmi); } - do {+ for (; vma; vma = vma\_next(&vmi)) { if (!vma\_migratable(vma) || !vma\_policy\_mof(vma) || is\_vm\_hugetlb\_page(vma) || (vma->vm\_flags & VM\_MIXEDMAP)) { trace\_sched\_skip\_vma\_numa(mm, vma, NUMAB\_SKIP\_UNSUITABLE);@@ -3434,7 +3434,7 @@ retry\_pids: \*/ if (vma\_pids\_forced) break;- } for\_each\_vma(vmi, vma);+ }  /\* \* If no VMAs are remaining and VMAs were skipped due to the PID |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:34:50 +0000



=== Content from git.kernel.org_abb89d96_20250114_183613.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shawn Wang <shawnwang@linux.alibaba.com> | 2024-10-25 10:22:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:57 +0100 |
| commit | [c60d98ef7078fc3e22b48e98eae7a897d88494ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee)) | |
| tree | [e83314fac1ad4dfe909fa78c8fb8be443643ca1d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee) | |
| parent | [ed28e3ef03954a8f507aa0755c3818570a9c9daf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed28e3ef03954a8f507aa0755c3818570a9c9daf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee&id2=ed28e3ef03954a8f507aa0755c3818570a9c9daf)) | |
| download | [linux-c60d98ef7078fc3e22b48e98eae7a897d88494ee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c60d98ef7078fc3e22b48e98eae7a897d88494ee.tar.gz) | |

sched/numa: Fix the potential null pointer dereference in task\_numa\_work()[ Upstream commit 9c70b2a33cd2aa6a5a59c5523ef053bd42265209 ]
When running stress-ng-vm-segv test, we found a null pointer dereference
error in task\_numa\_work(). Here is the backtrace:
[323676.066985] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000020
......
[323676.067108] CPU: 35 PID: 2694524 Comm: stress-ng-vm-se
......
[323676.067113] pstate: 23401009 (nzCv daif +PAN -UAO +TCO +DIT +SSBS BTYPE=--)
[323676.067115] pc : vma\_migratable+0x1c/0xd0
[323676.067122] lr : task\_numa\_work+0x1ec/0x4e0
[323676.067127] sp : ffff8000ada73d20
[323676.067128] x29: ffff8000ada73d20 x28: 0000000000000000 x27: 000000003e89f010
[323676.067130] x26: 0000000000080000 x25: ffff800081b5c0d8 x24: ffff800081b27000
[323676.067133] x23: 0000000000010000 x22: 0000000104d18cc0 x21: ffff0009f7158000
[323676.067135] x20: 0000000000000000 x19: 0000000000000000 x18: ffff8000ada73db8
[323676.067138] x17: 0001400000000000 x16: ffff800080df40b0 x15: 0000000000000035
[323676.067140] x14: ffff8000ada73cc8 x13: 1fffe0017cc72001 x12: ffff8000ada73cc8
[323676.067142] x11: ffff80008001160c x10: ffff000be639000c x9 : ffff8000800f4ba4
[323676.067145] x8 : ffff000810375000 x7 : ffff8000ada73974 x6 : 0000000000000001
[323676.067147] x5 : 0068000b33e26707 x4 : 0000000000000001 x3 : ffff0009f7158000
[323676.067149] x2 : 0000000000000041 x1 : 0000000000004400 x0 : 0000000000000000
[323676.067152] Call trace:
[323676.067153] vma\_migratable+0x1c/0xd0
[323676.067155] task\_numa\_work+0x1ec/0x4e0
[323676.067157] task\_work\_run+0x78/0xd8
[323676.067161] do\_notify\_resume+0x1ec/0x290
[323676.067163] el0\_svc+0x150/0x160
[323676.067167] el0t\_64\_sync\_handler+0xf8/0x128
[323676.067170] el0t\_64\_sync+0x17c/0x180
[323676.067173] Code: d2888001 910003fd f9000bf3 aa0003f3 (f9401000)
[323676.067177] SMP: stopping secondary CPUs
[323676.070184] Starting crashdump kernel...
stress-ng-vm-segv in stress-ng is used to stress test the SIGSEGV error
handling function of the system, which tries to cause a SIGSEGV error on
return from unmapping the whole address space of the child process.
Normally this program will not cause kernel crashes. But before the
munmap system call returns to user mode, a potential task\_numa\_work()
for numa balancing could be added and executed. In this scenario, since the
child process has no vma after munmap, the vma\_next() in task\_numa\_work()
will return a null pointer even if the vma iterator restarts from 0.
Recheck the vma pointer before dereferencing it in task\_numa\_work().
Fixes: 214dbc428137 ("sched: convert to vma iterator")
Signed-off-by: Shawn Wang <shawnwang@linux.alibaba.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Cc: stable@vger.kernel.org # v6.2+
Link: [https://lkml.kernel.org/r/20241025022208.125527-1-shawnwang@linux.alibaba.com](https://lkml.kernel.org/r/20241025022208.125527-1-shawnwang%40linux.alibaba.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee)

| -rw-r--r-- | [kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/sched/fair.c?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/kernel/sched/fair.c b/kernel/sched/fair.cindex 1d2cbdb162a67d..425348b8d9eb38 100644--- a/[kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/fair.c?id=ed28e3ef03954a8f507aa0755c3818570a9c9daf)+++ b/[kernel/sched/fair.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/fair.c?id=c60d98ef7078fc3e22b48e98eae7a897d88494ee)@@ -3289,7 +3289,7 @@ retry\_pids: vma = vma\_next(&vmi); } - do {+ for (; vma; vma = vma\_next(&vmi)) { if (!vma\_migratable(vma) || !vma\_policy\_mof(vma) || is\_vm\_hugetlb\_page(vma) || (vma->vm\_flags & VM\_MIXEDMAP)) { trace\_sched\_skip\_vma\_numa(mm, vma, NUMAB\_SKIP\_UNSUITABLE);@@ -3411,7 +3411,7 @@ retry\_pids: \*/ if (vma\_pids\_forced) break;- } for\_each\_vma(vmi, vma);+ }  /\* \* If no VMAs are remaining and VMAs were skipped due to the PID |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:34:50 +0000


