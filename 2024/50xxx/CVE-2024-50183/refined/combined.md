=== Content from git.kernel.org_c9220472_20250115_081323.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0a3c84f71680684c1d41abb92db05f95c09111e8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a3c84f71680684c1d41abb92db05f95c09111e8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a3c84f71680684c1d41abb92db05f95c09111e8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a3c84f71680684c1d41abb92db05f95c09111e8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Justin Tee <justin.tee@broadcom.com> | 2024-09-12 16:24:44 -0700 |
| --- | --- | --- |
| committer | Martin K. Petersen <martin.petersen@oracle.com> | 2024-09-12 21:21:19 -0400 |
| commit | [0a3c84f71680684c1d41abb92db05f95c09111e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a3c84f71680684c1d41abb92db05f95c09111e8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0a3c84f71680684c1d41abb92db05f95c09111e8)) | |
| tree | [89b79fc270479f37783f362e45c80b89cee02200](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0a3c84f71680684c1d41abb92db05f95c09111e8) | |
| parent | [d1a2ef63fc8b3e3dc5b74b7e08636896b32acbdc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1a2ef63fc8b3e3dc5b74b7e08636896b32acbdc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a3c84f71680684c1d41abb92db05f95c09111e8&id2=d1a2ef63fc8b3e3dc5b74b7e08636896b32acbdc)) | |
| download | [linux-0a3c84f71680684c1d41abb92db05f95c09111e8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0a3c84f71680684c1d41abb92db05f95c09111e8.tar.gz) | |

scsi: lpfc: Ensure DA\_ID handling completion before deleting an NPIV instanceDeleting an NPIV instance requires all fabric ndlps to be released before
an NPIV's resources can be torn down. Failure to release fabric ndlps
beforehand opens kref imbalance race conditions. Fix by forcing the DA\_ID
to complete synchronously with usage of wait\_queue.
Signed-off-by: Justin Tee <justin.tee@broadcom.com>
Link: [https://lore.kernel.org/r/20240912232447.45607-6-justintee8345@gmail.com](https://lore.kernel.org/r/20240912232447.45607-6-justintee8345%40gmail.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0a3c84f71680684c1d41abb92db05f95c09111e8)

| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_ct.c?id=0a3c84f71680684c1d41abb92db05f95c09111e8) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_disc.h?id=0a3c84f71680684c1d41abb92db05f95c09111e8) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_vport.c?id=0a3c84f71680684c1d41abb92db05f95c09111e8) | 43 | |  |  |  | | --- | --- | --- | |

3 files changed, 55 insertions, 7 deletions

| diff --git a/drivers/scsi/lpfc/lpfc\_ct.c b/drivers/scsi/lpfc/lpfc\_ct.cindex 2dedd1493e5bae..1e5db489a00c5b 100644--- a/[drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_ct.c?id=d1a2ef63fc8b3e3dc5b74b7e08636896b32acbdc)+++ b/[drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_ct.c?id=0a3c84f71680684c1d41abb92db05f95c09111e8)@@ -1647,6 +1647,18 @@ lpfc\_cmpl\_ct(struct lpfc\_hba \*phba, struct lpfc\_iocbq \*cmdiocb, }  out:+ /\* If the caller wanted a synchronous DA\_ID completion, signal the+ \* wait obj and clear flag to reset the vport.+ \*/+ if (ndlp->save\_flags & NLP\_WAIT\_FOR\_DA\_ID) {+ if (ndlp->da\_id\_waitq)+ wake\_up(ndlp->da\_id\_waitq);+ }++ spin\_lock\_irq(&ndlp->lock);+ ndlp->save\_flags &= ~NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock);+ lpfc\_ct\_free\_iocb(phba, cmdiocb); lpfc\_nlp\_put(ndlp); return;diff --git a/drivers/scsi/lpfc/lpfc\_disc.h b/drivers/scsi/lpfc/lpfc\_disc.hindex f82615d87c4bbb..f5ae8cc158205c 100644--- a/[drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_disc.h?id=d1a2ef63fc8b3e3dc5b74b7e08636896b32acbdc)+++ b/[drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_disc.h?id=0a3c84f71680684c1d41abb92db05f95c09111e8)@@ -90,6 +90,8 @@ enum lpfc\_nlp\_save\_flags { NLP\_IN\_RECOV\_POST\_DEV\_LOSS = 0x1, /\* wait for outstanding LOGO to cmpl \*/ NLP\_WAIT\_FOR\_LOGO = 0x2,+ /\* wait for outstanding DA\_ID to finish \*/+ NLP\_WAIT\_FOR\_DA\_ID = 0x4 };  struct lpfc\_nodelist {@@ -159,7 +161,12 @@ struct lpfc\_nodelist { uint32\_t nvme\_fb\_size; /\* NVME target's supported byte cnt \*/ #define NVME\_FB\_BIT\_SHIFT 9 /\* PRLI Rsp first burst in 512B units. \*/ uint32\_t nlp\_defer\_did;++ /\* These wait objects are NPIV specific. These IOs must complete+ \* synchronously.+ \*/ wait\_queue\_head\_t \*logo\_waitq;+ wait\_queue\_head\_t \*da\_id\_waitq; };  struct lpfc\_node\_rrq {diff --git a/drivers/scsi/lpfc/lpfc\_vport.c b/drivers/scsi/lpfc/lpfc\_vport.cindex 4439167a51882d..7a4d4d8e2ad55f 100644--- a/[drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_vport.c?id=d1a2ef63fc8b3e3dc5b74b7e08636896b32acbdc)+++ b/[drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_vport.c?id=0a3c84f71680684c1d41abb92db05f95c09111e8)@@ -626,6 +626,7 @@ lpfc\_vport\_delete(struct fc\_vport \*fc\_vport) struct Scsi\_Host \*shost = lpfc\_shost\_from\_vport(vport); struct lpfc\_hba \*phba = vport->phba; int rc;+ DECLARE\_WAIT\_QUEUE\_HEAD\_ONSTACK(waitq);  if (vport->port\_type == LPFC\_PHYSICAL\_PORT) { lpfc\_printf\_vlog(vport, KERN\_ERR, LOG\_TRACE\_EVENT,@@ -679,21 +680,49 @@ lpfc\_vport\_delete(struct fc\_vport \*fc\_vport) if (!ndlp) goto skip\_logo; + /\* Send the DA\_ID and Fabric LOGO to cleanup the NPIV fabric entries. \*/ if (ndlp && ndlp->nlp\_state == NLP\_STE\_UNMAPPED\_NODE && phba->link\_state >= LPFC\_LINK\_UP && phba->fc\_topology != LPFC\_TOPOLOGY\_LOOP) { if (vport->cfg\_enable\_da\_id) {- /\* Send DA\_ID and wait for a completion. \*/+ /\* Send DA\_ID and wait for a completion. This is best+ \* effort. If the DA\_ID fails, likely the fabric will+ \* "leak" NportIDs but at least the driver issued the+ \* command.+ \*/+ ndlp = lpfc\_findnode\_did(vport, NameServer\_DID);+ if (!ndlp)+ goto issue\_logo;++ spin\_lock\_irq(&ndlp->lock);+ ndlp->da\_id\_waitq = &waitq;+ ndlp->save\_flags |= NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock);+ rc = lpfc\_ns\_cmd(vport, SLI\_CTNS\_DA\_ID, 0, 0);- if (rc) {- lpfc\_printf\_log(vport->phba, KERN\_WARNING,- LOG\_VPORT,- "1829 CT command failed to "- "delete objects on fabric, "- "rc %d\n", rc);+ if (!rc) {+ wait\_event\_timeout(waitq,+ !(ndlp->save\_flags & NLP\_WAIT\_FOR\_DA\_ID),+ msecs\_to\_jiffies(phba->fc\_ratov \* 2000)); }++ lpfc\_printf\_vlog(vport, KERN\_INFO, LOG\_VPORT | LOG\_ELS,+ "1829 DA\_ID issue status %d. "+ "SFlag x%x NState x%x, NFlag x%x "+ "Rpi x%x\n",+ rc, ndlp->save\_flags, ndlp->nlp\_state,+ ndlp->nlp\_flag, ndlp->nlp\_rpi);++ /\* Remove the waitq and save\_flags. It no+ \* longer matters if the wake happened.+ \*/+ spin\_lock\_irq(&ndlp->lock);+ ndlp->da\_id\_waitq = NULL;+ ndlp->save\_flags &= ~NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock); } +issue\_logo: /\* \* If the vpi is not registered, then a valid FDISC doesn't \* exist and there is no need for a ELS LOGO. Just cleanup |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:01 +0000



=== Content from git.kernel.org_dc772967_20250115_081323.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0857b1c573c0b095aa778bb26d8b3378172471b6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0857b1c573c0b095aa778bb26d8b3378172471b6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0857b1c573c0b095aa778bb26d8b3378172471b6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0857b1c573c0b095aa778bb26d8b3378172471b6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Justin Tee <justin.tee@broadcom.com> | 2024-09-12 16:24:44 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:17 +0200 |
| commit | [0857b1c573c0b095aa778bb26d8b3378172471b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0857b1c573c0b095aa778bb26d8b3378172471b6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0857b1c573c0b095aa778bb26d8b3378172471b6)) | |
| tree | [eb06649866fcf99025b1cd91274db0ae0a91d76b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0857b1c573c0b095aa778bb26d8b3378172471b6) | |
| parent | [78fa420e23f29952dc85e23bd3a0a2ad631bd209](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78fa420e23f29952dc85e23bd3a0a2ad631bd209) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0857b1c573c0b095aa778bb26d8b3378172471b6&id2=78fa420e23f29952dc85e23bd3a0a2ad631bd209)) | |
| download | [linux-0857b1c573c0b095aa778bb26d8b3378172471b6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0857b1c573c0b095aa778bb26d8b3378172471b6.tar.gz) | |

scsi: lpfc: Ensure DA\_ID handling completion before deleting an NPIV instance[ Upstream commit 0a3c84f71680684c1d41abb92db05f95c09111e8 ]
Deleting an NPIV instance requires all fabric ndlps to be released before
an NPIV's resources can be torn down. Failure to release fabric ndlps
beforehand opens kref imbalance race conditions. Fix by forcing the DA\_ID
to complete synchronously with usage of wait\_queue.
Signed-off-by: Justin Tee <justin.tee@broadcom.com>
Link: [https://lore.kernel.org/r/20240912232447.45607-6-justintee8345@gmail.com](https://lore.kernel.org/r/20240912232447.45607-6-justintee8345%40gmail.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0857b1c573c0b095aa778bb26d8b3378172471b6)

| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_ct.c?id=0857b1c573c0b095aa778bb26d8b3378172471b6) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_disc.h?id=0857b1c573c0b095aa778bb26d8b3378172471b6) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_vport.c?id=0857b1c573c0b095aa778bb26d8b3378172471b6) | 43 | |  |  |  | | --- | --- | --- | |

3 files changed, 55 insertions, 7 deletions

| diff --git a/drivers/scsi/lpfc/lpfc\_ct.c b/drivers/scsi/lpfc/lpfc\_ct.cindex e941a99aa96592..8006b0eea3fbda 100644--- a/[drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_ct.c?id=78fa420e23f29952dc85e23bd3a0a2ad631bd209)+++ b/[drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_ct.c?id=0857b1c573c0b095aa778bb26d8b3378172471b6)@@ -1663,6 +1663,18 @@ lpfc\_cmpl\_ct(struct lpfc\_hba \*phba, struct lpfc\_iocbq \*cmdiocb, }  out:+ /\* If the caller wanted a synchronous DA\_ID completion, signal the+ \* wait obj and clear flag to reset the vport.+ \*/+ if (ndlp->save\_flags & NLP\_WAIT\_FOR\_DA\_ID) {+ if (ndlp->da\_id\_waitq)+ wake\_up(ndlp->da\_id\_waitq);+ }++ spin\_lock\_irq(&ndlp->lock);+ ndlp->save\_flags &= ~NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock);+ lpfc\_ct\_free\_iocb(phba, cmdiocb); lpfc\_nlp\_put(ndlp); return;diff --git a/drivers/scsi/lpfc/lpfc\_disc.h b/drivers/scsi/lpfc/lpfc\_disc.hindex f82615d87c4bbb..f5ae8cc158205c 100644--- a/[drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_disc.h?id=78fa420e23f29952dc85e23bd3a0a2ad631bd209)+++ b/[drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_disc.h?id=0857b1c573c0b095aa778bb26d8b3378172471b6)@@ -90,6 +90,8 @@ enum lpfc\_nlp\_save\_flags { NLP\_IN\_RECOV\_POST\_DEV\_LOSS = 0x1, /\* wait for outstanding LOGO to cmpl \*/ NLP\_WAIT\_FOR\_LOGO = 0x2,+ /\* wait for outstanding DA\_ID to finish \*/+ NLP\_WAIT\_FOR\_DA\_ID = 0x4 };  struct lpfc\_nodelist {@@ -159,7 +161,12 @@ struct lpfc\_nodelist { uint32\_t nvme\_fb\_size; /\* NVME target's supported byte cnt \*/ #define NVME\_FB\_BIT\_SHIFT 9 /\* PRLI Rsp first burst in 512B units. \*/ uint32\_t nlp\_defer\_did;++ /\* These wait objects are NPIV specific. These IOs must complete+ \* synchronously.+ \*/ wait\_queue\_head\_t \*logo\_waitq;+ wait\_queue\_head\_t \*da\_id\_waitq; };  struct lpfc\_node\_rrq {diff --git a/drivers/scsi/lpfc/lpfc\_vport.c b/drivers/scsi/lpfc/lpfc\_vport.cindex 6b4259894584f3..fe7c3064c097ad 100644--- a/[drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_vport.c?id=78fa420e23f29952dc85e23bd3a0a2ad631bd209)+++ b/[drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_vport.c?id=0857b1c573c0b095aa778bb26d8b3378172471b6)@@ -643,6 +643,7 @@ lpfc\_vport\_delete(struct fc\_vport \*fc\_vport) struct Scsi\_Host \*shost = lpfc\_shost\_from\_vport(vport); struct lpfc\_hba \*phba = vport->phba; int rc;+ DECLARE\_WAIT\_QUEUE\_HEAD\_ONSTACK(waitq);  if (vport->port\_type == LPFC\_PHYSICAL\_PORT) { lpfc\_printf\_vlog(vport, KERN\_ERR, LOG\_TRACE\_EVENT,@@ -698,21 +699,49 @@ lpfc\_vport\_delete(struct fc\_vport \*fc\_vport) if (!ndlp) goto skip\_logo; + /\* Send the DA\_ID and Fabric LOGO to cleanup the NPIV fabric entries. \*/ if (ndlp && ndlp->nlp\_state == NLP\_STE\_UNMAPPED\_NODE && phba->link\_state >= LPFC\_LINK\_UP && phba->fc\_topology != LPFC\_TOPOLOGY\_LOOP) { if (vport->cfg\_enable\_da\_id) {- /\* Send DA\_ID and wait for a completion. \*/+ /\* Send DA\_ID and wait for a completion. This is best+ \* effort. If the DA\_ID fails, likely the fabric will+ \* "leak" NportIDs but at least the driver issued the+ \* command.+ \*/+ ndlp = lpfc\_findnode\_did(vport, NameServer\_DID);+ if (!ndlp)+ goto issue\_logo;++ spin\_lock\_irq(&ndlp->lock);+ ndlp->da\_id\_waitq = &waitq;+ ndlp->save\_flags |= NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock);+ rc = lpfc\_ns\_cmd(vport, SLI\_CTNS\_DA\_ID, 0, 0);- if (rc) {- lpfc\_printf\_log(vport->phba, KERN\_WARNING,- LOG\_VPORT,- "1829 CT command failed to "- "delete objects on fabric, "- "rc %d\n", rc);+ if (!rc) {+ wait\_event\_timeout(waitq,+ !(ndlp->save\_flags & NLP\_WAIT\_FOR\_DA\_ID),+ msecs\_to\_jiffies(phba->fc\_ratov \* 2000)); }++ lpfc\_printf\_vlog(vport, KERN\_INFO, LOG\_VPORT | LOG\_ELS,+ "1829 DA\_ID issue status %d. "+ "SFlag x%x NState x%x, NFlag x%x "+ "Rpi x%x\n",+ rc, ndlp->save\_flags, ndlp->nlp\_state,+ ndlp->nlp\_flag, ndlp->nlp\_rpi);++ /\* Remove the waitq and save\_flags. It no+ \* longer matters if the wake happened.+ \*/+ spin\_lock\_irq(&ndlp->lock);+ ndlp->da\_id\_waitq = NULL;+ ndlp->save\_flags &= ~NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock); } +issue\_logo: /\* \* If the vpi is not registered, then a valid FDISC doesn't \* exist and there is no need for a ELS LOGO. Just cleanup |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:00 +0000



=== Content from git.kernel.org_6df95100_20250115_081325.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Justin Tee <justin.tee@broadcom.com> | 2024-09-12 16:24:44 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:26:41 +0200 |
| commit | [bbc525409bfe8e5bff12f5d18d550ab3e52cdbef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef)) | |
| tree | [c3a1736a2ff42592b76533bb23a61380015ebd09](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef) | |
| parent | [96031ec8d14c552433efd4520e6b493d8892ebe3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96031ec8d14c552433efd4520e6b493d8892ebe3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef&id2=96031ec8d14c552433efd4520e6b493d8892ebe3)) | |
| download | [linux-bbc525409bfe8e5bff12f5d18d550ab3e52cdbef.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bbc525409bfe8e5bff12f5d18d550ab3e52cdbef.tar.gz) | |

scsi: lpfc: Ensure DA\_ID handling completion before deleting an NPIV instance[ Upstream commit 0a3c84f71680684c1d41abb92db05f95c09111e8 ]
Deleting an NPIV instance requires all fabric ndlps to be released before
an NPIV's resources can be torn down. Failure to release fabric ndlps
beforehand opens kref imbalance race conditions. Fix by forcing the DA\_ID
to complete synchronously with usage of wait\_queue.
Signed-off-by: Justin Tee <justin.tee@broadcom.com>
Link: [https://lore.kernel.org/r/20240912232447.45607-6-justintee8345@gmail.com](https://lore.kernel.org/r/20240912232447.45607-6-justintee8345%40gmail.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef)

| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_ct.c?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_disc.h?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_vport.c?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef) | 43 | |  |  |  | | --- | --- | --- | |

3 files changed, 55 insertions, 7 deletions

| diff --git a/drivers/scsi/lpfc/lpfc\_ct.c b/drivers/scsi/lpfc/lpfc\_ct.cindex 2dedd1493e5bae..1e5db489a00c5b 100644--- a/[drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_ct.c?id=96031ec8d14c552433efd4520e6b493d8892ebe3)+++ b/[drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_ct.c?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef)@@ -1647,6 +1647,18 @@ lpfc\_cmpl\_ct(struct lpfc\_hba \*phba, struct lpfc\_iocbq \*cmdiocb, }  out:+ /\* If the caller wanted a synchronous DA\_ID completion, signal the+ \* wait obj and clear flag to reset the vport.+ \*/+ if (ndlp->save\_flags & NLP\_WAIT\_FOR\_DA\_ID) {+ if (ndlp->da\_id\_waitq)+ wake\_up(ndlp->da\_id\_waitq);+ }++ spin\_lock\_irq(&ndlp->lock);+ ndlp->save\_flags &= ~NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock);+ lpfc\_ct\_free\_iocb(phba, cmdiocb); lpfc\_nlp\_put(ndlp); return;diff --git a/drivers/scsi/lpfc/lpfc\_disc.h b/drivers/scsi/lpfc/lpfc\_disc.hindex f82615d87c4bbb..f5ae8cc158205c 100644--- a/[drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_disc.h?id=96031ec8d14c552433efd4520e6b493d8892ebe3)+++ b/[drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_disc.h?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef)@@ -90,6 +90,8 @@ enum lpfc\_nlp\_save\_flags { NLP\_IN\_RECOV\_POST\_DEV\_LOSS = 0x1, /\* wait for outstanding LOGO to cmpl \*/ NLP\_WAIT\_FOR\_LOGO = 0x2,+ /\* wait for outstanding DA\_ID to finish \*/+ NLP\_WAIT\_FOR\_DA\_ID = 0x4 };  struct lpfc\_nodelist {@@ -159,7 +161,12 @@ struct lpfc\_nodelist { uint32\_t nvme\_fb\_size; /\* NVME target's supported byte cnt \*/ #define NVME\_FB\_BIT\_SHIFT 9 /\* PRLI Rsp first burst in 512B units. \*/ uint32\_t nlp\_defer\_did;++ /\* These wait objects are NPIV specific. These IOs must complete+ \* synchronously.+ \*/ wait\_queue\_head\_t \*logo\_waitq;+ wait\_queue\_head\_t \*da\_id\_waitq; };  struct lpfc\_node\_rrq {diff --git a/drivers/scsi/lpfc/lpfc\_vport.c b/drivers/scsi/lpfc/lpfc\_vport.cindex 4439167a51882d..7a4d4d8e2ad55f 100644--- a/[drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_vport.c?id=96031ec8d14c552433efd4520e6b493d8892ebe3)+++ b/[drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_vport.c?id=bbc525409bfe8e5bff12f5d18d550ab3e52cdbef)@@ -626,6 +626,7 @@ lpfc\_vport\_delete(struct fc\_vport \*fc\_vport) struct Scsi\_Host \*shost = lpfc\_shost\_from\_vport(vport); struct lpfc\_hba \*phba = vport->phba; int rc;+ DECLARE\_WAIT\_QUEUE\_HEAD\_ONSTACK(waitq);  if (vport->port\_type == LPFC\_PHYSICAL\_PORT) { lpfc\_printf\_vlog(vport, KERN\_ERR, LOG\_TRACE\_EVENT,@@ -679,21 +680,49 @@ lpfc\_vport\_delete(struct fc\_vport \*fc\_vport) if (!ndlp) goto skip\_logo; + /\* Send the DA\_ID and Fabric LOGO to cleanup the NPIV fabric entries. \*/ if (ndlp && ndlp->nlp\_state == NLP\_STE\_UNMAPPED\_NODE && phba->link\_state >= LPFC\_LINK\_UP && phba->fc\_topology != LPFC\_TOPOLOGY\_LOOP) { if (vport->cfg\_enable\_da\_id) {- /\* Send DA\_ID and wait for a completion. \*/+ /\* Send DA\_ID and wait for a completion. This is best+ \* effort. If the DA\_ID fails, likely the fabric will+ \* "leak" NportIDs but at least the driver issued the+ \* command.+ \*/+ ndlp = lpfc\_findnode\_did(vport, NameServer\_DID);+ if (!ndlp)+ goto issue\_logo;++ spin\_lock\_irq(&ndlp->lock);+ ndlp->da\_id\_waitq = &waitq;+ ndlp->save\_flags |= NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock);+ rc = lpfc\_ns\_cmd(vport, SLI\_CTNS\_DA\_ID, 0, 0);- if (rc) {- lpfc\_printf\_log(vport->phba, KERN\_WARNING,- LOG\_VPORT,- "1829 CT command failed to "- "delete objects on fabric, "- "rc %d\n", rc);+ if (!rc) {+ wait\_event\_timeout(waitq,+ !(ndlp->save\_flags & NLP\_WAIT\_FOR\_DA\_ID),+ msecs\_to\_jiffies(phba->fc\_ratov \* 2000)); }++ lpfc\_printf\_vlog(vport, KERN\_INFO, LOG\_VPORT | LOG\_ELS,+ "1829 DA\_ID issue status %d. "+ "SFlag x%x NState x%x, NFlag x%x "+ "Rpi x%x\n",+ rc, ndlp->save\_flags, ndlp->nlp\_state,+ ndlp->nlp\_flag, ndlp->nlp\_rpi);++ /\* Remove the waitq and save\_flags. It no+ \* longer matters if the wake happened.+ \*/+ spin\_lock\_irq(&ndlp->lock);+ ndlp->da\_id\_waitq = NULL;+ ndlp->save\_flags &= ~NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock); } +issue\_logo: /\* \* If the vpi is not registered, then a valid FDISC doesn't \* exist and there is no need for a ELS LOGO. Just cleanup |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:02 +0000



=== Content from git.kernel.org_1f441fd3_20250115_081324.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Justin Tee <justin.tee@broadcom.com> | 2024-09-12 16:24:44 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:24:21 +0200 |
| commit | [0ef6e016eb53fad6dc44c3253945efb43a3486b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9)) | |
| tree | [9a4435475fb95c422034a9a0b370aad1cd087d4f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9) | |
| parent | [ab88c77894aab61c4a9532cd068d2cd4b3721191](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ab88c77894aab61c4a9532cd068d2cd4b3721191) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9&id2=ab88c77894aab61c4a9532cd068d2cd4b3721191)) | |
| download | [linux-0ef6e016eb53fad6dc44c3253945efb43a3486b9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0ef6e016eb53fad6dc44c3253945efb43a3486b9.tar.gz) | |

scsi: lpfc: Ensure DA\_ID handling completion before deleting an NPIV instance[ Upstream commit 0a3c84f71680684c1d41abb92db05f95c09111e8 ]
Deleting an NPIV instance requires all fabric ndlps to be released before
an NPIV's resources can be torn down. Failure to release fabric ndlps
beforehand opens kref imbalance race conditions. Fix by forcing the DA\_ID
to complete synchronously with usage of wait\_queue.
Signed-off-by: Justin Tee <justin.tee@broadcom.com>
Link: [https://lore.kernel.org/r/20240912232447.45607-6-justintee8345@gmail.com](https://lore.kernel.org/r/20240912232447.45607-6-justintee8345%40gmail.com)
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9)

| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_ct.c?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_disc.h?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/lpfc/lpfc_vport.c?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9) | 43 | |  |  |  | | --- | --- | --- | |

3 files changed, 55 insertions, 7 deletions

| diff --git a/drivers/scsi/lpfc/lpfc\_ct.c b/drivers/scsi/lpfc/lpfc\_ct.cindex baae1f8279e0cb..1775115239860b 100644--- a/[drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_ct.c?id=ab88c77894aab61c4a9532cd068d2cd4b3721191)+++ b/[drivers/scsi/lpfc/lpfc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_ct.c?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9)@@ -1671,6 +1671,18 @@ lpfc\_cmpl\_ct(struct lpfc\_hba \*phba, struct lpfc\_iocbq \*cmdiocb, }  out:+ /\* If the caller wanted a synchronous DA\_ID completion, signal the+ \* wait obj and clear flag to reset the vport.+ \*/+ if (ndlp->save\_flags & NLP\_WAIT\_FOR\_DA\_ID) {+ if (ndlp->da\_id\_waitq)+ wake\_up(ndlp->da\_id\_waitq);+ }++ spin\_lock\_irq(&ndlp->lock);+ ndlp->save\_flags &= ~NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock);+ lpfc\_ct\_free\_iocb(phba, cmdiocb); lpfc\_nlp\_put(ndlp); return;diff --git a/drivers/scsi/lpfc/lpfc\_disc.h b/drivers/scsi/lpfc/lpfc\_disc.hindex f82615d87c4bbb..f5ae8cc158205c 100644--- a/[drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_disc.h?id=ab88c77894aab61c4a9532cd068d2cd4b3721191)+++ b/[drivers/scsi/lpfc/lpfc\_disc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_disc.h?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9)@@ -90,6 +90,8 @@ enum lpfc\_nlp\_save\_flags { NLP\_IN\_RECOV\_POST\_DEV\_LOSS = 0x1, /\* wait for outstanding LOGO to cmpl \*/ NLP\_WAIT\_FOR\_LOGO = 0x2,+ /\* wait for outstanding DA\_ID to finish \*/+ NLP\_WAIT\_FOR\_DA\_ID = 0x4 };  struct lpfc\_nodelist {@@ -159,7 +161,12 @@ struct lpfc\_nodelist { uint32\_t nvme\_fb\_size; /\* NVME target's supported byte cnt \*/ #define NVME\_FB\_BIT\_SHIFT 9 /\* PRLI Rsp first burst in 512B units. \*/ uint32\_t nlp\_defer\_did;++ /\* These wait objects are NPIV specific. These IOs must complete+ \* synchronously.+ \*/ wait\_queue\_head\_t \*logo\_waitq;+ wait\_queue\_head\_t \*da\_id\_waitq; };  struct lpfc\_node\_rrq {diff --git a/drivers/scsi/lpfc/lpfc\_vport.c b/drivers/scsi/lpfc/lpfc\_vport.cindex 9e0e9e02d2c473..256ee797adb306 100644--- a/[drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_vport.c?id=ab88c77894aab61c4a9532cd068d2cd4b3721191)+++ b/[drivers/scsi/lpfc/lpfc\_vport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/lpfc/lpfc_vport.c?id=0ef6e016eb53fad6dc44c3253945efb43a3486b9)@@ -633,6 +633,7 @@ lpfc\_vport\_delete(struct fc\_vport \*fc\_vport) struct Scsi\_Host \*shost = lpfc\_shost\_from\_vport(vport); struct lpfc\_hba \*phba = vport->phba; int rc;+ DECLARE\_WAIT\_QUEUE\_HEAD\_ONSTACK(waitq);  if (vport->port\_type == LPFC\_PHYSICAL\_PORT) { lpfc\_printf\_vlog(vport, KERN\_ERR, LOG\_TRACE\_EVENT,@@ -688,21 +689,49 @@ lpfc\_vport\_delete(struct fc\_vport \*fc\_vport) if (!ndlp) goto skip\_logo; + /\* Send the DA\_ID and Fabric LOGO to cleanup the NPIV fabric entries. \*/ if (ndlp && ndlp->nlp\_state == NLP\_STE\_UNMAPPED\_NODE && phba->link\_state >= LPFC\_LINK\_UP && phba->fc\_topology != LPFC\_TOPOLOGY\_LOOP) { if (vport->cfg\_enable\_da\_id) {- /\* Send DA\_ID and wait for a completion. \*/+ /\* Send DA\_ID and wait for a completion. This is best+ \* effort. If the DA\_ID fails, likely the fabric will+ \* "leak" NportIDs but at least the driver issued the+ \* command.+ \*/+ ndlp = lpfc\_findnode\_did(vport, NameServer\_DID);+ if (!ndlp)+ goto issue\_logo;++ spin\_lock\_irq(&ndlp->lock);+ ndlp->da\_id\_waitq = &waitq;+ ndlp->save\_flags |= NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock);+ rc = lpfc\_ns\_cmd(vport, SLI\_CTNS\_DA\_ID, 0, 0);- if (rc) {- lpfc\_printf\_log(vport->phba, KERN\_WARNING,- LOG\_VPORT,- "1829 CT command failed to "- "delete objects on fabric, "- "rc %d\n", rc);+ if (!rc) {+ wait\_event\_timeout(waitq,+ !(ndlp->save\_flags & NLP\_WAIT\_FOR\_DA\_ID),+ msecs\_to\_jiffies(phba->fc\_ratov \* 2000)); }++ lpfc\_printf\_vlog(vport, KERN\_INFO, LOG\_VPORT | LOG\_ELS,+ "1829 DA\_ID issue status %d. "+ "SFlag x%x NState x%x, NFlag x%x "+ "Rpi x%x\n",+ rc, ndlp->save\_flags, ndlp->nlp\_state,+ ndlp->nlp\_flag, ndlp->nlp\_rpi);++ /\* Remove the waitq and save\_flags. It no+ \* longer matters if the wake happened.+ \*/+ spin\_lock\_irq(&ndlp->lock);+ ndlp->da\_id\_waitq = NULL;+ ndlp->save\_flags &= ~NLP\_WAIT\_FOR\_DA\_ID;+ spin\_unlock\_irq(&ndlp->lock); } +issue\_logo: /\* \* If the vpi is not registered, then a valid FDISC doesn't \* exist and there is no need for a ELS LOGO. Just cleanup |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:12:02 +0000


