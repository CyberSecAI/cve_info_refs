=== Content from git.kernel.org_881c9458_20250114_230632.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2b5369528ee63c88371816178a05b5e664c87386)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b5369528ee63c88371816178a05b5e664c87386)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b5369528ee63c88371816178a05b5e664c87386)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b5369528ee63c88371816178a05b5e664c87386)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrew Kanner <andrew.kanner@gmail.com> | 2024-11-03 20:38:45 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:21:14 +0100 |
| commit | [2b5369528ee63c88371816178a05b5e664c87386](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b5369528ee63c88371816178a05b5e664c87386) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2b5369528ee63c88371816178a05b5e664c87386)) | |
| tree | [a2fb1a71d61486a0a6b33a8134b8eafb60d07e82](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b5369528ee63c88371816178a05b5e664c87386) | |
| parent | [8e8ab8e554e8cf6a1fc762774147516c0d16eed7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e8ab8e554e8cf6a1fc762774147516c0d16eed7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b5369528ee63c88371816178a05b5e664c87386&id2=8e8ab8e554e8cf6a1fc762774147516c0d16eed7)) | |
| download | [linux-2b5369528ee63c88371816178a05b5e664c87386.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2b5369528ee63c88371816178a05b5e664c87386.tar.gz) | |

ocfs2: remove entry once instead of null-ptr-dereference in ocfs2\_xa\_remove()commit 0b63c0e01fba40e3992bc627272ec7b618ccaef7 upstream.
Syzkaller is able to provoke null-ptr-dereference in ocfs2\_xa\_remove():
[ 57.319872] (a.out,1161,7):ocfs2\_xa\_remove:2028 ERROR: status = -12
[ 57.320420] (a.out,1161,7):ocfs2\_xa\_cleanup\_value\_truncate:1999 ERROR: Partial truncate while removing xattr overlay.upper. Leaking 1 clusters and removing the entry
[ 57.321727] BUG: kernel NULL pointer dereference, address: 0000000000000004
[...]
[ 57.325727] RIP: 0010:ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[...]
[ 57.331328] Call Trace:
[ 57.331477] <TASK>
[...]
[ 57.333511] ? do\_user\_addr\_fault+0x3e5/0x740
[ 57.333778] ? exc\_page\_fault+0x70/0x170
[ 57.334016] ? asm\_exc\_page\_fault+0x2b/0x30
[ 57.334263] ? \_\_pfx\_ocfs2\_xa\_block\_wipe\_namevalue+0x10/0x10
[ 57.334596] ? ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[ 57.334913] ocfs2\_xa\_remove\_entry+0x23/0xc0
[ 57.335164] ocfs2\_xa\_set+0x704/0xcf0
[ 57.335381] ? \_raw\_spin\_unlock+0x1a/0x40
[ 57.335620] ? ocfs2\_inode\_cache\_unlock+0x16/0x20
[ 57.335915] ? trace\_preempt\_on+0x1e/0x70
[ 57.336153] ? start\_this\_handle+0x16c/0x500
[ 57.336410] ? preempt\_count\_sub+0x50/0x80
[ 57.336656] ? \_raw\_read\_unlock+0x20/0x40
[ 57.336906] ? start\_this\_handle+0x16c/0x500
[ 57.337162] ocfs2\_xattr\_block\_set+0xa6/0x1e0
[ 57.337424] \_\_ocfs2\_xattr\_set\_handle+0x1fd/0x5d0
[ 57.337706] ? ocfs2\_start\_trans+0x13d/0x290
[ 57.337971] ocfs2\_xattr\_set+0xb13/0xfb0
[ 57.338207] ? dput+0x46/0x1c0
[ 57.338393] ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338665] ? ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338948] \_\_vfs\_removexattr+0x92/0xc0
[ 57.339182] \_\_vfs\_removexattr\_locked+0xd5/0x190
[ 57.339456] ? preempt\_count\_sub+0x50/0x80
[ 57.339705] vfs\_removexattr+0x5f/0x100
[...]
Reproducer uses faultinject facility to fail ocfs2\_xa\_remove() ->
ocfs2\_xa\_value\_truncate() with -ENOMEM.
In this case the comment mentions that we can return 0 if
ocfs2\_xa\_cleanup\_value\_truncate() is going to wipe the entry
anyway. But the following 'rc' check is wrong and execution flow do
'ocfs2\_xa\_remove\_entry(loc);' twice:
\* 1st: in ocfs2\_xa\_cleanup\_value\_truncate();
\* 2nd: returning back to ocfs2\_xa\_remove() instead of going to 'out'.
Fix this by skipping the 2nd removal of the same entry and making
syzkaller repro happy.
Link: [https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner@gmail.com](https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner%40gmail.com)
Fixes: 399ff3a748cf ("ocfs2: Handle errors while setting external xattr values.")
Signed-off-by: Andrew Kanner <andrew.kanner@gmail.com>
Reported-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/671e13ab.050a0220.2b8c0f.01d0.GAE@google.com/T/
Tested-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b5369528ee63c88371816178a05b5e664c87386)

| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=2b5369528ee63c88371816178a05b5e664c87386) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex fb1140c52f07cb..f8b7770d1fbba8 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=8e8ab8e554e8cf6a1fc762774147516c0d16eed7)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=2b5369528ee63c88371816178a05b5e664c87386)@@ -2036,8 +2036,7 @@ static int ocfs2\_xa\_remove(struct ocfs2\_xa\_loc \*loc, rc = 0; ocfs2\_xa\_cleanup\_value\_truncate(loc, "removing", orig\_clusters);- if (rc)- goto out;+ goto out; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:05:09 +0000



=== Content from git.kernel.org_f90b6d19_20250114_230631.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrew Kanner <andrew.kanner@gmail.com> | 2024-11-03 20:38:45 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:52 +0100 |
| commit | [168a9b8303fcb0317db4c06b23ce1c0ce2af4e10](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10)) | |
| tree | [30decdd224b382aa593385ea3e269fc7c2c0b1e7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10) | |
| parent | [8cdb2d0796bcd7792ff2be52c47465702011d426](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8cdb2d0796bcd7792ff2be52c47465702011d426) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10&id2=8cdb2d0796bcd7792ff2be52c47465702011d426)) | |
| download | [linux-168a9b8303fcb0317db4c06b23ce1c0ce2af4e10.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-168a9b8303fcb0317db4c06b23ce1c0ce2af4e10.tar.gz) | |

ocfs2: remove entry once instead of null-ptr-dereference in ocfs2\_xa\_remove()commit 0b63c0e01fba40e3992bc627272ec7b618ccaef7 upstream.
Syzkaller is able to provoke null-ptr-dereference in ocfs2\_xa\_remove():
[ 57.319872] (a.out,1161,7):ocfs2\_xa\_remove:2028 ERROR: status = -12
[ 57.320420] (a.out,1161,7):ocfs2\_xa\_cleanup\_value\_truncate:1999 ERROR: Partial truncate while removing xattr overlay.upper. Leaking 1 clusters and removing the entry
[ 57.321727] BUG: kernel NULL pointer dereference, address: 0000000000000004
[...]
[ 57.325727] RIP: 0010:ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[...]
[ 57.331328] Call Trace:
[ 57.331477] <TASK>
[...]
[ 57.333511] ? do\_user\_addr\_fault+0x3e5/0x740
[ 57.333778] ? exc\_page\_fault+0x70/0x170
[ 57.334016] ? asm\_exc\_page\_fault+0x2b/0x30
[ 57.334263] ? \_\_pfx\_ocfs2\_xa\_block\_wipe\_namevalue+0x10/0x10
[ 57.334596] ? ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[ 57.334913] ocfs2\_xa\_remove\_entry+0x23/0xc0
[ 57.335164] ocfs2\_xa\_set+0x704/0xcf0
[ 57.335381] ? \_raw\_spin\_unlock+0x1a/0x40
[ 57.335620] ? ocfs2\_inode\_cache\_unlock+0x16/0x20
[ 57.335915] ? trace\_preempt\_on+0x1e/0x70
[ 57.336153] ? start\_this\_handle+0x16c/0x500
[ 57.336410] ? preempt\_count\_sub+0x50/0x80
[ 57.336656] ? \_raw\_read\_unlock+0x20/0x40
[ 57.336906] ? start\_this\_handle+0x16c/0x500
[ 57.337162] ocfs2\_xattr\_block\_set+0xa6/0x1e0
[ 57.337424] \_\_ocfs2\_xattr\_set\_handle+0x1fd/0x5d0
[ 57.337706] ? ocfs2\_start\_trans+0x13d/0x290
[ 57.337971] ocfs2\_xattr\_set+0xb13/0xfb0
[ 57.338207] ? dput+0x46/0x1c0
[ 57.338393] ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338665] ? ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338948] \_\_vfs\_removexattr+0x92/0xc0
[ 57.339182] \_\_vfs\_removexattr\_locked+0xd5/0x190
[ 57.339456] ? preempt\_count\_sub+0x50/0x80
[ 57.339705] vfs\_removexattr+0x5f/0x100
[...]
Reproducer uses faultinject facility to fail ocfs2\_xa\_remove() ->
ocfs2\_xa\_value\_truncate() with -ENOMEM.
In this case the comment mentions that we can return 0 if
ocfs2\_xa\_cleanup\_value\_truncate() is going to wipe the entry
anyway. But the following 'rc' check is wrong and execution flow do
'ocfs2\_xa\_remove\_entry(loc);' twice:
\* 1st: in ocfs2\_xa\_cleanup\_value\_truncate();
\* 2nd: returning back to ocfs2\_xa\_remove() instead of going to 'out'.
Fix this by skipping the 2nd removal of the same entry and making
syzkaller repro happy.
Link: [https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner@gmail.com](https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner%40gmail.com)
Fixes: 399ff3a748cf ("ocfs2: Handle errors while setting external xattr values.")
Signed-off-by: Andrew Kanner <andrew.kanner@gmail.com>
Reported-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/671e13ab.050a0220.2b8c0f.01d0.GAE@google.com/T/
Tested-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10)

| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex 42368577786e85..5b56e10e510bee 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=8cdb2d0796bcd7792ff2be52c47465702011d426)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=168a9b8303fcb0317db4c06b23ce1c0ce2af4e10)@@ -2042,8 +2042,7 @@ static int ocfs2\_xa\_remove(struct ocfs2\_xa\_loc \*loc, rc = 0; ocfs2\_xa\_cleanup\_value\_truncate(loc, "removing", orig\_clusters);- if (rc)- goto out;+ goto out; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:05:08 +0000



=== Content from git.kernel.org_1ba76c2f_20250114_230630.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrew Kanner <andrew.kanner@gmail.com> | 2024-11-03 20:38:45 +0100 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-11-07 14:14:59 -0800 |
| commit | [0b63c0e01fba40e3992bc627272ec7b618ccaef7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7)) | |
| tree | [65e88d96a140621fdd3fb9107582eb2deb6ced3e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7) | |
| parent | [9e05e5c7ee8758141d2db7e8fea2cab34500c6ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e05e5c7ee8758141d2db7e8fea2cab34500c6ed) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7&id2=9e05e5c7ee8758141d2db7e8fea2cab34500c6ed)) | |
| download | [linux-0b63c0e01fba40e3992bc627272ec7b618ccaef7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0b63c0e01fba40e3992bc627272ec7b618ccaef7.tar.gz) | |

ocfs2: remove entry once instead of null-ptr-dereference in ocfs2\_xa\_remove()Syzkaller is able to provoke null-ptr-dereference in ocfs2\_xa\_remove():
[ 57.319872] (a.out,1161,7):ocfs2\_xa\_remove:2028 ERROR: status = -12
[ 57.320420] (a.out,1161,7):ocfs2\_xa\_cleanup\_value\_truncate:1999 ERROR: Partial truncate while removing xattr overlay.upper. Leaking 1 clusters and removing the entry
[ 57.321727] BUG: kernel NULL pointer dereference, address: 0000000000000004
[...]
[ 57.325727] RIP: 0010:ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[...]
[ 57.331328] Call Trace:
[ 57.331477] <TASK>
[...]
[ 57.333511] ? do\_user\_addr\_fault+0x3e5/0x740
[ 57.333778] ? exc\_page\_fault+0x70/0x170
[ 57.334016] ? asm\_exc\_page\_fault+0x2b/0x30
[ 57.334263] ? \_\_pfx\_ocfs2\_xa\_block\_wipe\_namevalue+0x10/0x10
[ 57.334596] ? ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[ 57.334913] ocfs2\_xa\_remove\_entry+0x23/0xc0
[ 57.335164] ocfs2\_xa\_set+0x704/0xcf0
[ 57.335381] ? \_raw\_spin\_unlock+0x1a/0x40
[ 57.335620] ? ocfs2\_inode\_cache\_unlock+0x16/0x20
[ 57.335915] ? trace\_preempt\_on+0x1e/0x70
[ 57.336153] ? start\_this\_handle+0x16c/0x500
[ 57.336410] ? preempt\_count\_sub+0x50/0x80
[ 57.336656] ? \_raw\_read\_unlock+0x20/0x40
[ 57.336906] ? start\_this\_handle+0x16c/0x500
[ 57.337162] ocfs2\_xattr\_block\_set+0xa6/0x1e0
[ 57.337424] \_\_ocfs2\_xattr\_set\_handle+0x1fd/0x5d0
[ 57.337706] ? ocfs2\_start\_trans+0x13d/0x290
[ 57.337971] ocfs2\_xattr\_set+0xb13/0xfb0
[ 57.338207] ? dput+0x46/0x1c0
[ 57.338393] ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338665] ? ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338948] \_\_vfs\_removexattr+0x92/0xc0
[ 57.339182] \_\_vfs\_removexattr\_locked+0xd5/0x190
[ 57.339456] ? preempt\_count\_sub+0x50/0x80
[ 57.339705] vfs\_removexattr+0x5f/0x100
[...]
Reproducer uses faultinject facility to fail ocfs2\_xa\_remove() ->
ocfs2\_xa\_value\_truncate() with -ENOMEM.
In this case the comment mentions that we can return 0 if
ocfs2\_xa\_cleanup\_value\_truncate() is going to wipe the entry
anyway. But the following 'rc' check is wrong and execution flow do
'ocfs2\_xa\_remove\_entry(loc);' twice:
\* 1st: in ocfs2\_xa\_cleanup\_value\_truncate();
\* 2nd: returning back to ocfs2\_xa\_remove() instead of going to 'out'.
Fix this by skipping the 2nd removal of the same entry and making
syzkaller repro happy.
Link: [https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner@gmail.com](https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner%40gmail.com)
Fixes: 399ff3a748cf ("ocfs2: Handle errors while setting external xattr values.")
Signed-off-by: Andrew Kanner <andrew.kanner@gmail.com>
Reported-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/671e13ab.050a0220.2b8c0f.01d0.GAE@google.com/T/
Tested-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7)

| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex dd0a05365e795e..73a6f6fd8a8ef5 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=9e05e5c7ee8758141d2db7e8fea2cab34500c6ed)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=0b63c0e01fba40e3992bc627272ec7b618ccaef7)@@ -2036,8 +2036,7 @@ static int ocfs2\_xa\_remove(struct ocfs2\_xa\_loc \*loc, rc = 0; ocfs2\_xa\_cleanup\_value\_truncate(loc, "removing", orig\_clusters);- if (rc)- goto out;+ goto out; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:05:07 +0000



=== Content from git.kernel.org_007bd114_20250114_230634.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=86dd0e8d42828923c68ad506933336bcd6f2317d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=86dd0e8d42828923c68ad506933336bcd6f2317d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86dd0e8d42828923c68ad506933336bcd6f2317d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=86dd0e8d42828923c68ad506933336bcd6f2317d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrew Kanner <andrew.kanner@gmail.com> | 2024-11-03 20:38:45 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:15:19 +0100 |
| commit | [86dd0e8d42828923c68ad506933336bcd6f2317d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86dd0e8d42828923c68ad506933336bcd6f2317d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=86dd0e8d42828923c68ad506933336bcd6f2317d)) | |
| tree | [5f7557c082c4ca39aff27da55a3d2ea179dc8be6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=86dd0e8d42828923c68ad506933336bcd6f2317d) | |
| parent | [8525160ea2ab58dfd8dac7151723e0a105176901](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8525160ea2ab58dfd8dac7151723e0a105176901) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=86dd0e8d42828923c68ad506933336bcd6f2317d&id2=8525160ea2ab58dfd8dac7151723e0a105176901)) | |
| download | [linux-86dd0e8d42828923c68ad506933336bcd6f2317d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-86dd0e8d42828923c68ad506933336bcd6f2317d.tar.gz) | |

ocfs2: remove entry once instead of null-ptr-dereference in ocfs2\_xa\_remove()commit 0b63c0e01fba40e3992bc627272ec7b618ccaef7 upstream.
Syzkaller is able to provoke null-ptr-dereference in ocfs2\_xa\_remove():
[ 57.319872] (a.out,1161,7):ocfs2\_xa\_remove:2028 ERROR: status = -12
[ 57.320420] (a.out,1161,7):ocfs2\_xa\_cleanup\_value\_truncate:1999 ERROR: Partial truncate while removing xattr overlay.upper. Leaking 1 clusters and removing the entry
[ 57.321727] BUG: kernel NULL pointer dereference, address: 0000000000000004
[...]
[ 57.325727] RIP: 0010:ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[...]
[ 57.331328] Call Trace:
[ 57.331477] <TASK>
[...]
[ 57.333511] ? do\_user\_addr\_fault+0x3e5/0x740
[ 57.333778] ? exc\_page\_fault+0x70/0x170
[ 57.334016] ? asm\_exc\_page\_fault+0x2b/0x30
[ 57.334263] ? \_\_pfx\_ocfs2\_xa\_block\_wipe\_namevalue+0x10/0x10
[ 57.334596] ? ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[ 57.334913] ocfs2\_xa\_remove\_entry+0x23/0xc0
[ 57.335164] ocfs2\_xa\_set+0x704/0xcf0
[ 57.335381] ? \_raw\_spin\_unlock+0x1a/0x40
[ 57.335620] ? ocfs2\_inode\_cache\_unlock+0x16/0x20
[ 57.335915] ? trace\_preempt\_on+0x1e/0x70
[ 57.336153] ? start\_this\_handle+0x16c/0x500
[ 57.336410] ? preempt\_count\_sub+0x50/0x80
[ 57.336656] ? \_raw\_read\_unlock+0x20/0x40
[ 57.336906] ? start\_this\_handle+0x16c/0x500
[ 57.337162] ocfs2\_xattr\_block\_set+0xa6/0x1e0
[ 57.337424] \_\_ocfs2\_xattr\_set\_handle+0x1fd/0x5d0
[ 57.337706] ? ocfs2\_start\_trans+0x13d/0x290
[ 57.337971] ocfs2\_xattr\_set+0xb13/0xfb0
[ 57.338207] ? dput+0x46/0x1c0
[ 57.338393] ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338665] ? ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338948] \_\_vfs\_removexattr+0x92/0xc0
[ 57.339182] \_\_vfs\_removexattr\_locked+0xd5/0x190
[ 57.339456] ? preempt\_count\_sub+0x50/0x80
[ 57.339705] vfs\_removexattr+0x5f/0x100
[...]
Reproducer uses faultinject facility to fail ocfs2\_xa\_remove() ->
ocfs2\_xa\_value\_truncate() with -ENOMEM.
In this case the comment mentions that we can return 0 if
ocfs2\_xa\_cleanup\_value\_truncate() is going to wipe the entry
anyway. But the following 'rc' check is wrong and execution flow do
'ocfs2\_xa\_remove\_entry(loc);' twice:
\* 1st: in ocfs2\_xa\_cleanup\_value\_truncate();
\* 2nd: returning back to ocfs2\_xa\_remove() instead of going to 'out'.
Fix this by skipping the 2nd removal of the same entry and making
syzkaller repro happy.
Link: [https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner@gmail.com](https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner%40gmail.com)
Fixes: 399ff3a748cf ("ocfs2: Handle errors while setting external xattr values.")
Signed-off-by: Andrew Kanner <andrew.kanner@gmail.com>
Reported-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/671e13ab.050a0220.2b8c0f.01d0.GAE@google.com/T/
Tested-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=86dd0e8d42828923c68ad506933336bcd6f2317d)

| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=86dd0e8d42828923c68ad506933336bcd6f2317d) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex eec2ead5df6d2f..69fab4e5bc2aa0 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=8525160ea2ab58dfd8dac7151723e0a105176901)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=86dd0e8d42828923c68ad506933336bcd6f2317d)@@ -2040,8 +2040,7 @@ static int ocfs2\_xa\_remove(struct ocfs2\_xa\_loc \*loc, rc = 0; ocfs2\_xa\_cleanup\_value\_truncate(loc, "removing", orig\_clusters);- if (rc)- goto out;+ goto out; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:05:11 +0000



=== Content from git.kernel.org_e13167d4_20250114_230635.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrew Kanner <andrew.kanner@gmail.com> | 2024-11-03 20:38:45 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:13:42 +0100 |
| commit | [dcc8fe8c83145041cb6c80cac21f6173a3ff0204](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204)) | |
| tree | [d9ddc6e0a40724b65ae66ac16250fcebe86d008b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204) | |
| parent | [2e1546ff199bbe5c67c89689f27032504397617d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e1546ff199bbe5c67c89689f27032504397617d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204&id2=2e1546ff199bbe5c67c89689f27032504397617d)) | |
| download | [linux-dcc8fe8c83145041cb6c80cac21f6173a3ff0204.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dcc8fe8c83145041cb6c80cac21f6173a3ff0204.tar.gz) | |

ocfs2: remove entry once instead of null-ptr-dereference in ocfs2\_xa\_remove()commit 0b63c0e01fba40e3992bc627272ec7b618ccaef7 upstream.
Syzkaller is able to provoke null-ptr-dereference in ocfs2\_xa\_remove():
[ 57.319872] (a.out,1161,7):ocfs2\_xa\_remove:2028 ERROR: status = -12
[ 57.320420] (a.out,1161,7):ocfs2\_xa\_cleanup\_value\_truncate:1999 ERROR: Partial truncate while removing xattr overlay.upper. Leaking 1 clusters and removing the entry
[ 57.321727] BUG: kernel NULL pointer dereference, address: 0000000000000004
[...]
[ 57.325727] RIP: 0010:ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[...]
[ 57.331328] Call Trace:
[ 57.331477] <TASK>
[...]
[ 57.333511] ? do\_user\_addr\_fault+0x3e5/0x740
[ 57.333778] ? exc\_page\_fault+0x70/0x170
[ 57.334016] ? asm\_exc\_page\_fault+0x2b/0x30
[ 57.334263] ? \_\_pfx\_ocfs2\_xa\_block\_wipe\_namevalue+0x10/0x10
[ 57.334596] ? ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[ 57.334913] ocfs2\_xa\_remove\_entry+0x23/0xc0
[ 57.335164] ocfs2\_xa\_set+0x704/0xcf0
[ 57.335381] ? \_raw\_spin\_unlock+0x1a/0x40
[ 57.335620] ? ocfs2\_inode\_cache\_unlock+0x16/0x20
[ 57.335915] ? trace\_preempt\_on+0x1e/0x70
[ 57.336153] ? start\_this\_handle+0x16c/0x500
[ 57.336410] ? preempt\_count\_sub+0x50/0x80
[ 57.336656] ? \_raw\_read\_unlock+0x20/0x40
[ 57.336906] ? start\_this\_handle+0x16c/0x500
[ 57.337162] ocfs2\_xattr\_block\_set+0xa6/0x1e0
[ 57.337424] \_\_ocfs2\_xattr\_set\_handle+0x1fd/0x5d0
[ 57.337706] ? ocfs2\_start\_trans+0x13d/0x290
[ 57.337971] ocfs2\_xattr\_set+0xb13/0xfb0
[ 57.338207] ? dput+0x46/0x1c0
[ 57.338393] ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338665] ? ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338948] \_\_vfs\_removexattr+0x92/0xc0
[ 57.339182] \_\_vfs\_removexattr\_locked+0xd5/0x190
[ 57.339456] ? preempt\_count\_sub+0x50/0x80
[ 57.339705] vfs\_removexattr+0x5f/0x100
[...]
Reproducer uses faultinject facility to fail ocfs2\_xa\_remove() ->
ocfs2\_xa\_value\_truncate() with -ENOMEM.
In this case the comment mentions that we can return 0 if
ocfs2\_xa\_cleanup\_value\_truncate() is going to wipe the entry
anyway. But the following 'rc' check is wrong and execution flow do
'ocfs2\_xa\_remove\_entry(loc);' twice:
\* 1st: in ocfs2\_xa\_cleanup\_value\_truncate();
\* 2nd: returning back to ocfs2\_xa\_remove() instead of going to 'out'.
Fix this by skipping the 2nd removal of the same entry and making
syzkaller repro happy.
Link: [https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner@gmail.com](https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner%40gmail.com)
Fixes: 399ff3a748cf ("ocfs2: Handle errors while setting external xattr values.")
Signed-off-by: Andrew Kanner <andrew.kanner@gmail.com>
Reported-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/671e13ab.050a0220.2b8c0f.01d0.GAE@google.com/T/
Tested-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204)

| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex c7643409606676..7e097da448cc0f 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=2e1546ff199bbe5c67c89689f27032504397617d)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=dcc8fe8c83145041cb6c80cac21f6173a3ff0204)@@ -2040,8 +2040,7 @@ static int ocfs2\_xa\_remove(struct ocfs2\_xa\_loc \*loc, rc = 0; ocfs2\_xa\_cleanup\_value\_truncate(loc, "removing", orig\_clusters);- if (rc)- goto out;+ goto out; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:05:12 +0000



=== Content from git.kernel.org_e2caae4b_20250114_230637.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dd73c942eed76a014c7a5597e6926435274d2c4c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dd73c942eed76a014c7a5597e6926435274d2c4c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd73c942eed76a014c7a5597e6926435274d2c4c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd73c942eed76a014c7a5597e6926435274d2c4c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrew Kanner <andrew.kanner@gmail.com> | 2024-11-03 20:38:45 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-14 13:19:40 +0100 |
| commit | [dd73c942eed76a014c7a5597e6926435274d2c4c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd73c942eed76a014c7a5597e6926435274d2c4c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dd73c942eed76a014c7a5597e6926435274d2c4c)) | |
| tree | [4938c4c6ad0ba735bb9be16c961eb762f86a0a63](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dd73c942eed76a014c7a5597e6926435274d2c4c) | |
| parent | [c8fe8c223297b7cd65caff9818e69f224ac8f2c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c8fe8c223297b7cd65caff9818e69f224ac8f2c5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd73c942eed76a014c7a5597e6926435274d2c4c&id2=c8fe8c223297b7cd65caff9818e69f224ac8f2c5)) | |
| download | [linux-dd73c942eed76a014c7a5597e6926435274d2c4c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dd73c942eed76a014c7a5597e6926435274d2c4c.tar.gz) | |

ocfs2: remove entry once instead of null-ptr-dereference in ocfs2\_xa\_remove()commit 0b63c0e01fba40e3992bc627272ec7b618ccaef7 upstream.
Syzkaller is able to provoke null-ptr-dereference in ocfs2\_xa\_remove():
[ 57.319872] (a.out,1161,7):ocfs2\_xa\_remove:2028 ERROR: status = -12
[ 57.320420] (a.out,1161,7):ocfs2\_xa\_cleanup\_value\_truncate:1999 ERROR: Partial truncate while removing xattr overlay.upper. Leaking 1 clusters and removing the entry
[ 57.321727] BUG: kernel NULL pointer dereference, address: 0000000000000004
[...]
[ 57.325727] RIP: 0010:ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[...]
[ 57.331328] Call Trace:
[ 57.331477] <TASK>
[...]
[ 57.333511] ? do\_user\_addr\_fault+0x3e5/0x740
[ 57.333778] ? exc\_page\_fault+0x70/0x170
[ 57.334016] ? asm\_exc\_page\_fault+0x2b/0x30
[ 57.334263] ? \_\_pfx\_ocfs2\_xa\_block\_wipe\_namevalue+0x10/0x10
[ 57.334596] ? ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[ 57.334913] ocfs2\_xa\_remove\_entry+0x23/0xc0
[ 57.335164] ocfs2\_xa\_set+0x704/0xcf0
[ 57.335381] ? \_raw\_spin\_unlock+0x1a/0x40
[ 57.335620] ? ocfs2\_inode\_cache\_unlock+0x16/0x20
[ 57.335915] ? trace\_preempt\_on+0x1e/0x70
[ 57.336153] ? start\_this\_handle+0x16c/0x500
[ 57.336410] ? preempt\_count\_sub+0x50/0x80
[ 57.336656] ? \_raw\_read\_unlock+0x20/0x40
[ 57.336906] ? start\_this\_handle+0x16c/0x500
[ 57.337162] ocfs2\_xattr\_block\_set+0xa6/0x1e0
[ 57.337424] \_\_ocfs2\_xattr\_set\_handle+0x1fd/0x5d0
[ 57.337706] ? ocfs2\_start\_trans+0x13d/0x290
[ 57.337971] ocfs2\_xattr\_set+0xb13/0xfb0
[ 57.338207] ? dput+0x46/0x1c0
[ 57.338393] ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338665] ? ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338948] \_\_vfs\_removexattr+0x92/0xc0
[ 57.339182] \_\_vfs\_removexattr\_locked+0xd5/0x190
[ 57.339456] ? preempt\_count\_sub+0x50/0x80
[ 57.339705] vfs\_removexattr+0x5f/0x100
[...]
Reproducer uses faultinject facility to fail ocfs2\_xa\_remove() ->
ocfs2\_xa\_value\_truncate() with -ENOMEM.
In this case the comment mentions that we can return 0 if
ocfs2\_xa\_cleanup\_value\_truncate() is going to wipe the entry
anyway. But the following 'rc' check is wrong and execution flow do
'ocfs2\_xa\_remove\_entry(loc);' twice:
\* 1st: in ocfs2\_xa\_cleanup\_value\_truncate();
\* 2nd: returning back to ocfs2\_xa\_remove() instead of going to 'out'.
Fix this by skipping the 2nd removal of the same entry and making
syzkaller repro happy.
Link: [https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner@gmail.com](https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner%40gmail.com)
Fixes: 399ff3a748cf ("ocfs2: Handle errors while setting external xattr values.")
Signed-off-by: Andrew Kanner <andrew.kanner@gmail.com>
Reported-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/671e13ab.050a0220.2b8c0f.01d0.GAE@google.com/T/
Tested-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dd73c942eed76a014c7a5597e6926435274d2c4c)

| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=dd73c942eed76a014c7a5597e6926435274d2c4c) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex 1cc28891807154..c2268b9e20a6d3 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=c8fe8c223297b7cd65caff9818e69f224ac8f2c5)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=dd73c942eed76a014c7a5597e6926435274d2c4c)@@ -2036,8 +2036,7 @@ static int ocfs2\_xa\_remove(struct ocfs2\_xa\_loc \*loc, rc = 0; ocfs2\_xa\_cleanup\_value\_truncate(loc, "removing", orig\_clusters);- if (rc)- goto out;+ goto out; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:05:13 +0000



=== Content from git.kernel.org_5a0d07d3_20250114_230634.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrew Kanner <andrew.kanner@gmail.com> | 2024-11-03 20:38:45 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:59:38 +0100 |
| commit | [6a7e6dcf90fe7721d0863067b6ca9a9442134692](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692)) | |
| tree | [5af1d061bc0ebec2248faaa42bc3c4c4306e7d3e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692) | |
| parent | [e068a87cf25e50d896a09b73b37841b6438fab50](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e068a87cf25e50d896a09b73b37841b6438fab50) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692&id2=e068a87cf25e50d896a09b73b37841b6438fab50)) | |
| download | [linux-6a7e6dcf90fe7721d0863067b6ca9a9442134692.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6a7e6dcf90fe7721d0863067b6ca9a9442134692.tar.gz) | |

ocfs2: remove entry once instead of null-ptr-dereference in ocfs2\_xa\_remove()commit 0b63c0e01fba40e3992bc627272ec7b618ccaef7 upstream.
Syzkaller is able to provoke null-ptr-dereference in ocfs2\_xa\_remove():
[ 57.319872] (a.out,1161,7):ocfs2\_xa\_remove:2028 ERROR: status = -12
[ 57.320420] (a.out,1161,7):ocfs2\_xa\_cleanup\_value\_truncate:1999 ERROR: Partial truncate while removing xattr overlay.upper. Leaking 1 clusters and removing the entry
[ 57.321727] BUG: kernel NULL pointer dereference, address: 0000000000000004
[...]
[ 57.325727] RIP: 0010:ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[...]
[ 57.331328] Call Trace:
[ 57.331477] <TASK>
[...]
[ 57.333511] ? do\_user\_addr\_fault+0x3e5/0x740
[ 57.333778] ? exc\_page\_fault+0x70/0x170
[ 57.334016] ? asm\_exc\_page\_fault+0x2b/0x30
[ 57.334263] ? \_\_pfx\_ocfs2\_xa\_block\_wipe\_namevalue+0x10/0x10
[ 57.334596] ? ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[ 57.334913] ocfs2\_xa\_remove\_entry+0x23/0xc0
[ 57.335164] ocfs2\_xa\_set+0x704/0xcf0
[ 57.335381] ? \_raw\_spin\_unlock+0x1a/0x40
[ 57.335620] ? ocfs2\_inode\_cache\_unlock+0x16/0x20
[ 57.335915] ? trace\_preempt\_on+0x1e/0x70
[ 57.336153] ? start\_this\_handle+0x16c/0x500
[ 57.336410] ? preempt\_count\_sub+0x50/0x80
[ 57.336656] ? \_raw\_read\_unlock+0x20/0x40
[ 57.336906] ? start\_this\_handle+0x16c/0x500
[ 57.337162] ocfs2\_xattr\_block\_set+0xa6/0x1e0
[ 57.337424] \_\_ocfs2\_xattr\_set\_handle+0x1fd/0x5d0
[ 57.337706] ? ocfs2\_start\_trans+0x13d/0x290
[ 57.337971] ocfs2\_xattr\_set+0xb13/0xfb0
[ 57.338207] ? dput+0x46/0x1c0
[ 57.338393] ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338665] ? ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338948] \_\_vfs\_removexattr+0x92/0xc0
[ 57.339182] \_\_vfs\_removexattr\_locked+0xd5/0x190
[ 57.339456] ? preempt\_count\_sub+0x50/0x80
[ 57.339705] vfs\_removexattr+0x5f/0x100
[...]
Reproducer uses faultinject facility to fail ocfs2\_xa\_remove() ->
ocfs2\_xa\_value\_truncate() with -ENOMEM.
In this case the comment mentions that we can return 0 if
ocfs2\_xa\_cleanup\_value\_truncate() is going to wipe the entry
anyway. But the following 'rc' check is wrong and execution flow do
'ocfs2\_xa\_remove\_entry(loc);' twice:
\* 1st: in ocfs2\_xa\_cleanup\_value\_truncate();
\* 2nd: returning back to ocfs2\_xa\_remove() instead of going to 'out'.
Fix this by skipping the 2nd removal of the same entry and making
syzkaller repro happy.
Link: [https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner@gmail.com](https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner%40gmail.com)
Fixes: 399ff3a748cf ("ocfs2: Handle errors while setting external xattr values.")
Signed-off-by: Andrew Kanner <andrew.kanner@gmail.com>
Reported-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/671e13ab.050a0220.2b8c0f.01d0.GAE@google.com/T/
Tested-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692)

| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex 00ede36aeec951..051d91e230c454 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=e068a87cf25e50d896a09b73b37841b6438fab50)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=6a7e6dcf90fe7721d0863067b6ca9a9442134692)@@ -2042,8 +2042,7 @@ static int ocfs2\_xa\_remove(struct ocfs2\_xa\_loc \*loc, rc = 0; ocfs2\_xa\_cleanup\_value\_truncate(loc, "removing", orig\_clusters);- if (rc)- goto out;+ goto out; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:05:11 +0000



=== Content from git.kernel.org_c58c43bf_20250114_230633.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrew Kanner <andrew.kanner@gmail.com> | 2024-11-03 20:38:45 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:07 +0100 |
| commit | [38cbf13b2e7a31362babe411f7c2c3c52cd2734b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b)) | |
| tree | [74e21258adb3c0cae0a2819ebaedc715326f254c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b) | |
| parent | [a27da2fa0b02e0b5521d6c22fbf5eb8e6944ec56](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a27da2fa0b02e0b5521d6c22fbf5eb8e6944ec56) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b&id2=a27da2fa0b02e0b5521d6c22fbf5eb8e6944ec56)) | |
| download | [linux-38cbf13b2e7a31362babe411f7c2c3c52cd2734b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-38cbf13b2e7a31362babe411f7c2c3c52cd2734b.tar.gz) | |

ocfs2: remove entry once instead of null-ptr-dereference in ocfs2\_xa\_remove()commit 0b63c0e01fba40e3992bc627272ec7b618ccaef7 upstream.
Syzkaller is able to provoke null-ptr-dereference in ocfs2\_xa\_remove():
[ 57.319872] (a.out,1161,7):ocfs2\_xa\_remove:2028 ERROR: status = -12
[ 57.320420] (a.out,1161,7):ocfs2\_xa\_cleanup\_value\_truncate:1999 ERROR: Partial truncate while removing xattr overlay.upper. Leaking 1 clusters and removing the entry
[ 57.321727] BUG: kernel NULL pointer dereference, address: 0000000000000004
[...]
[ 57.325727] RIP: 0010:ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[...]
[ 57.331328] Call Trace:
[ 57.331477] <TASK>
[...]
[ 57.333511] ? do\_user\_addr\_fault+0x3e5/0x740
[ 57.333778] ? exc\_page\_fault+0x70/0x170
[ 57.334016] ? asm\_exc\_page\_fault+0x2b/0x30
[ 57.334263] ? \_\_pfx\_ocfs2\_xa\_block\_wipe\_namevalue+0x10/0x10
[ 57.334596] ? ocfs2\_xa\_block\_wipe\_namevalue+0x2a/0xc0
[ 57.334913] ocfs2\_xa\_remove\_entry+0x23/0xc0
[ 57.335164] ocfs2\_xa\_set+0x704/0xcf0
[ 57.335381] ? \_raw\_spin\_unlock+0x1a/0x40
[ 57.335620] ? ocfs2\_inode\_cache\_unlock+0x16/0x20
[ 57.335915] ? trace\_preempt\_on+0x1e/0x70
[ 57.336153] ? start\_this\_handle+0x16c/0x500
[ 57.336410] ? preempt\_count\_sub+0x50/0x80
[ 57.336656] ? \_raw\_read\_unlock+0x20/0x40
[ 57.336906] ? start\_this\_handle+0x16c/0x500
[ 57.337162] ocfs2\_xattr\_block\_set+0xa6/0x1e0
[ 57.337424] \_\_ocfs2\_xattr\_set\_handle+0x1fd/0x5d0
[ 57.337706] ? ocfs2\_start\_trans+0x13d/0x290
[ 57.337971] ocfs2\_xattr\_set+0xb13/0xfb0
[ 57.338207] ? dput+0x46/0x1c0
[ 57.338393] ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338665] ? ocfs2\_xattr\_trusted\_set+0x28/0x30
[ 57.338948] \_\_vfs\_removexattr+0x92/0xc0
[ 57.339182] \_\_vfs\_removexattr\_locked+0xd5/0x190
[ 57.339456] ? preempt\_count\_sub+0x50/0x80
[ 57.339705] vfs\_removexattr+0x5f/0x100
[...]
Reproducer uses faultinject facility to fail ocfs2\_xa\_remove() ->
ocfs2\_xa\_value\_truncate() with -ENOMEM.
In this case the comment mentions that we can return 0 if
ocfs2\_xa\_cleanup\_value\_truncate() is going to wipe the entry
anyway. But the following 'rc' check is wrong and execution flow do
'ocfs2\_xa\_remove\_entry(loc);' twice:
\* 1st: in ocfs2\_xa\_cleanup\_value\_truncate();
\* 2nd: returning back to ocfs2\_xa\_remove() instead of going to 'out'.
Fix this by skipping the 2nd removal of the same entry and making
syzkaller repro happy.
Link: [https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner@gmail.com](https://lkml.kernel.org/r/20241103193845.2940988-1-andrew.kanner%40gmail.com)
Fixes: 399ff3a748cf ("ocfs2: Handle errors while setting external xattr values.")
Signed-off-by: Andrew Kanner <andrew.kanner@gmail.com>
Reported-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/671e13ab.050a0220.2b8c0f.01d0.GAE@google.com/T/
Tested-by: syzbot+386ce9e60fa1b18aac5b@syzkaller.appspotmail.com
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b)

| -rw-r--r-- | [fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/xattr.c?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/fs/ocfs2/xattr.c b/fs/ocfs2/xattr.cindex b9dfac2a564907..34358d88b481bc 100644--- a/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=a27da2fa0b02e0b5521d6c22fbf5eb8e6944ec56)+++ b/[fs/ocfs2/xattr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/xattr.c?id=38cbf13b2e7a31362babe411f7c2c3c52cd2734b)@@ -2050,8 +2050,7 @@ static int ocfs2\_xa\_remove(struct ocfs2\_xa\_loc \*loc, rc = 0; ocfs2\_xa\_cleanup\_value\_truncate(loc, "removing", orig\_clusters);- if (rc)- goto out;+ goto out; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:05:10 +0000


