=== Content from git.kernel.org_2f99cbce_20250114_213547.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ville Syrjälä <ville.syrjala@linux.intel.com> | 2024-10-01 23:07:45 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:23 +0100 |
| commit | [cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73)) | |
| tree | [7442341cc476d0520b2759274769664145ad6245](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73) | |
| parent | [6c44abb2d4c3262737d5d67832daebc8cf48b8c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c44abb2d4c3262737d5d67832daebc8cf48b8c9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73&id2=6c44abb2d4c3262737d5d67832daebc8cf48b8c9)) | |
| download | [linux-cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73.tar.gz) | |

wifi: iwlegacy: Clear stale interrupts before resuming devicecommit 07c90acb071b9954e1fecb1e4f4f13d12c544b34 upstream.
iwl4965 fails upon resume from hibernation on my laptop. The reason
seems to be a stale interrupt which isn't being cleared out before
interrupts are enabled. We end up with a race beween the resume
trying to bring things back up, and the restart work (queued form
the interrupt handler) trying to bring things down. Eventually
the whole thing blows up.
Fix the problem by clearing out any stale interrupts before
interrupts get enabled during resume.
Here's a debug log of the indicent:
[ 12.042589] ieee80211 phy0: il\_isr ISR inta 0x00000080, enabled 0xaa00008b, fh 0x00000000
[ 12.042625] ieee80211 phy0: il4965\_irq\_tasklet inta 0x00000080, enabled 0x00000000, fh 0x00000000
[ 12.042651] iwl4965 0000:10:00.0: RF\_KILL bit toggled to enable radio.
[ 12.042653] iwl4965 0000:10:00.0: On demand firmware reload
[ 12.042690] ieee80211 phy0: il4965\_irq\_tasklet End inta 0x00000000, enabled 0xaa00008b, fh 0x00000000, flags 0x00000282
[ 12.052207] ieee80211 phy0: il4965\_mac\_start enter
[ 12.052212] ieee80211 phy0: il\_prep\_station Add STA to driver ID 31: ff:ff:ff:ff:ff:ff
[ 12.052244] ieee80211 phy0: il4965\_set\_hw\_ready hardware ready
[ 12.052324] ieee80211 phy0: il\_apm\_init Init card's basic functions
[ 12.052348] ieee80211 phy0: il\_apm\_init L1 Enabled; Disabling L0S
[ 12.055727] ieee80211 phy0: il4965\_load\_bsm Begin load bsm
[ 12.056140] ieee80211 phy0: il4965\_verify\_bsm Begin verify bsm
[ 12.058642] ieee80211 phy0: il4965\_verify\_bsm BSM bootstrap uCode image OK
[ 12.058721] ieee80211 phy0: il4965\_load\_bsm BSM write complete, poll 1 iterations
[ 12.058734] ieee80211 phy0: \_\_il4965\_up iwl4965 is coming up
[ 12.058737] ieee80211 phy0: il4965\_mac\_start Start UP work done.
[ 12.058757] ieee80211 phy0: \_\_il4965\_down iwl4965 is going down
[ 12.058761] ieee80211 phy0: il\_scan\_cancel\_timeout Scan cancel timeout
[ 12.058762] ieee80211 phy0: il\_do\_scan\_abort Not performing scan to abort
[ 12.058765] ieee80211 phy0: il\_clear\_ucode\_stations Clearing ucode stations in driver
[ 12.058767] ieee80211 phy0: il\_clear\_ucode\_stations No active stations found to be cleared
[ 12.058819] ieee80211 phy0: \_il\_apm\_stop Stop card, put in low power state
[ 12.058827] ieee80211 phy0: \_il\_apm\_stop\_master stop master
[ 12.058864] ieee80211 phy0: il4965\_clear\_free\_frames 0 frames on pre-allocated heap on clear.
[ 12.058869] ieee80211 phy0: Hardware restart was requested
[ 16.132299] iwl4965 0000:10:00.0: START\_ALIVE timeout after 4000ms.
[ 16.132303] ------------[ cut here ]------------
[ 16.132304] Hardware became unavailable upon resume. This could be a software issue prior to suspend or a hardware issue.
[ 16.132338] WARNING: CPU: 0 PID: 181 at net/mac80211/util.c:1826 ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132390] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.132456] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Not tainted 6.11.0-cl+ #143
[ 16.132460] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.132463] Workqueue: async async\_run\_entry\_fn
[ 16.132469] RIP: 0010:ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132501] Code: da 02 00 00 c6 83 ad 05 00 00 00 48 89 df e8 98 1b fc ff 85 c0 41 89 c7 0f 84 e9 02 00 00 48 c7 c7 a0 e6 48 a0 e8 d1 77 c4 e0 <0f> 0b eb 2d 84 c0 0f 85 8b 01 00 00 c6 87 ad 05 00 00 00 e8 69 1b
[ 16.132504] RSP: 0018:ffffc9000029fcf0 EFLAGS: 00010282
[ 16.132507] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: 0000000000000001
[ 16.132509] RDX: ffffffff81f21a18 RSI: 0000000000000086 RDI: 0000000000000001
[ 16.132510] RBP: ffff8880072003c0 R08: 0000000000000000 R09: 0000000000000003
[ 16.132512] R10: 0000000000000000 R11: ffff88807e5b0000 R12: 0000000000000001
[ 16.132514] R13: 0000000000000000 R14: 0000000000000000 R15: 00000000ffffff92
[ 16.132515] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.132517] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.132519] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.132521] Call Trace:
[ 16.132525] <TASK>
[ 16.132526] ? \_\_warn+0x77/0x120
[ 16.132532] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132564] ? report\_bug+0x15c/0x190
[ 16.132568] ? handle\_bug+0x36/0x70
[ 16.132571] ? exc\_invalid\_op+0x13/0x60
[ 16.132573] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.132579] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132611] ? snd\_hdac\_bus\_init\_cmd\_io+0x24/0x200 [snd\_hda\_core]
[ 16.132617] ? pick\_eevdf+0x133/0x1c0
[ 16.132622] ? check\_preempt\_wakeup\_fair+0x70/0x90
[ 16.132626] ? wakeup\_preempt+0x4a/0x60
[ 16.132628] ? ttwu\_do\_activate.isra.0+0x5a/0x190
[ 16.132632] wiphy\_resume+0x79/0x1a0 [cfg80211]
[ 16.132675] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.132697] dpm\_run\_callback+0x75/0x1b0
[ 16.132703] device\_resume+0x97/0x200
[ 16.132707] async\_resume+0x14/0x20
[ 16.132711] async\_run\_entry\_fn+0x1b/0xa0
[ 16.132714] process\_one\_work+0x13d/0x350
[ 16.132718] worker\_thread+0x2be/0x3d0
[ 16.132722] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.132725] kthread+0xc0/0xf0
[ 16.132729] ? kthread\_park+0x80/0x80
[ 16.132732] ret\_from\_fork+0x28/0x40
[ 16.132735] ? kthread\_park+0x80/0x80
[ 16.132738] ret\_from\_fork\_asm+0x11/0x20
[ 16.132741] </TASK>
[ 16.132742] ---[ end trace 0000000000000000 ]---
[ 16.132930] ------------[ cut here ]------------
[ 16.132932] WARNING: CPU: 0 PID: 181 at net/mac80211/driver-ops.c:41 drv\_stop+0xe7/0xf0 [mac80211]
[ 16.132957] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.133014] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Tainted: G W 6.11.0-cl+ #143
[ 16.133018] Tainted: [W]=WARN
[ 16.133019] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.133021] Workqueue: async async\_run\_entry\_fn
[ 16.133025] RIP: 0010:drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133048] Code: 48 85 c0 74 0e 48 8b 78 08 89 ea 48 89 de e8 e0 87 04 00 65 ff 0d d1 de c4 5f 0f 85 42 ff ff ff e8 be 52 c2 e0 e9 38 ff ff ff <0f> 0b 5b 5d c3 0f 1f 40 00 41 54 49 89 fc 55 53 48 89 f3 2e 2e 2e
[ 16.133050] RSP: 0018:ffffc9000029fc50 EFLAGS: 00010246
[ 16.133053] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: ffff88800377f6c0
[ 16.133054] RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff8880072008e0
[ 16.133056] RBP: 0000000000000000 R08: ffffffff81f238d8 R09: 0000000000000000
[ 16.133058] R10: ffff8880080520f0 R11: 0000000000000000 R12: ffff888008051c60
[ 16.133060] R13: ffff8880072008e0 R14: 0000000000000000 R15: ffff8880072011d8
[ 16.133061] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.133063] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.133065] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.133067] Call Trace:
[ 16.133069] <TASK>
[ 16.133070] ? \_\_warn+0x77/0x120
[ 16.133075] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133098] ? report\_bug+0x15c/0x190
[ 16.133100] ? handle\_bug+0x36/0x70
[ 16.133103] ? exc\_invalid\_op+0x13/0x60
[ 16.133105] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.133109] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133132] ieee80211\_do\_stop+0x55a/0x810 [mac80211]
[ 16.133161] ? fq\_codel\_reset+0xa5/0xc0 [sch\_fq\_codel]
[ 16.133164] ieee80211\_stop+0x4f/0x180 [mac80211]
[ 16.133192] \_\_dev\_close\_many+0xa2/0x120
[ 16.133195] dev\_close\_many+0x90/0x150
[ 16.133198] dev\_close+0x5d/0x80
[ 16.133200] cfg80211\_shutdown\_all\_interfaces+0x40/0xe0 [cfg80211]
[ 16.133223] wiphy\_resume+0xb2/0x1a0 [cfg80211]
[ 16.133247] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.133269] dpm\_run\_callback+0x75/0x1b0
[ 16.133273] device\_resume+0x97/0x200
[ 16.133277] async\_resume+0x14/0x20
[ 16.133280] async\_run\_entry\_fn+0x1b/0xa0
[ 16.133283] process\_one\_work+0x13d/0x350
[ 16.133287] worker\_thread+0x2be/0x3d0
[ 16.133290] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.133294] kthread+0xc0/0xf0
[ 16.133296] ? kthread\_park+0x80/0x80
[ 16.133299] ret\_from\_fork+0x28/0x40
[ 16.133302] ? kthread\_park+0x80/0x80
[ 16.133304] ret\_from\_fork\_asm+0x11/0x20
[ 16.133307] </TASK>
[ 16.133308] ---[ end trace 0000000000000000 ]---
[ 16.133335] ieee80211 phy0: PM: dpm\_run\_callback(): wiphy\_resume [cfg80211] returns -110
[ 16.133360] ieee80211 phy0: PM: failed to restore async: error -110
Cc: stable@vger.kernel.org
Cc: Stanislaw Gruszka <stf\_xl@wp.pl>
Cc: Kalle Valo <kvalo@kernel.org>
Cc: linux-wireless@vger.kernel.org
Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Acked-by: Stanislaw Gruszka <stf\_xl@wp.pl>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241001200745.8276-1-ville.syrjala@linux.intel.com](https://patch.msgid.link/20241001200745.8276-1-ville.syrjala%40linux.intel.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlegacy/common.c?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlegacy/common.c b/drivers/net/wireless/intel/iwlegacy/common.cindex 9fa38221c43116..1810b12645a02f 100644--- a/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=6c44abb2d4c3262737d5d67832daebc8cf48b8c9)+++ b/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=cedf0f1db8d5f3524339c2c6e35a8505b0f1ab73)@@ -4972,6 +4972,8 @@ il\_pci\_resume(struct device \*device) \*/ pci\_write\_config\_byte(pdev, PCI\_CFG\_RETRY\_TIMEOUT, 0x00); + \_il\_wr(il, CSR\_INT, 0xffffffff);+ \_il\_wr(il, CSR\_FH\_INT\_STATUS, 0xffffffff); il\_enable\_interrupts(il);  if (!(\_il\_rd(il, CSR\_GP\_CNTRL) & CSR\_GP\_CNTRL\_REG\_FLAG\_HW\_RF\_KILL\_SW)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:34:24 +0000



=== Content from git.kernel.org_8d535e76_20250114_213547.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d0231f43df473e2f80372d0ca150eb3619932ef9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0231f43df473e2f80372d0ca150eb3619932ef9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0231f43df473e2f80372d0ca150eb3619932ef9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0231f43df473e2f80372d0ca150eb3619932ef9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ville Syrjälä <ville.syrjala@linux.intel.com> | 2024-10-01 23:07:45 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:22:03 +0100 |
| commit | [d0231f43df473e2f80372d0ca150eb3619932ef9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0231f43df473e2f80372d0ca150eb3619932ef9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d0231f43df473e2f80372d0ca150eb3619932ef9)) | |
| tree | [eb4c413640312e27594ccc08b140eb073d2d8e34](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0231f43df473e2f80372d0ca150eb3619932ef9) | |
| parent | [4112450da7d67b59ccedc2208bae622db17dbcb8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4112450da7d67b59ccedc2208bae622db17dbcb8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0231f43df473e2f80372d0ca150eb3619932ef9&id2=4112450da7d67b59ccedc2208bae622db17dbcb8)) | |
| download | [linux-d0231f43df473e2f80372d0ca150eb3619932ef9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d0231f43df473e2f80372d0ca150eb3619932ef9.tar.gz) | |

wifi: iwlegacy: Clear stale interrupts before resuming devicecommit 07c90acb071b9954e1fecb1e4f4f13d12c544b34 upstream.
iwl4965 fails upon resume from hibernation on my laptop. The reason
seems to be a stale interrupt which isn't being cleared out before
interrupts are enabled. We end up with a race beween the resume
trying to bring things back up, and the restart work (queued form
the interrupt handler) trying to bring things down. Eventually
the whole thing blows up.
Fix the problem by clearing out any stale interrupts before
interrupts get enabled during resume.
Here's a debug log of the indicent:
[ 12.042589] ieee80211 phy0: il\_isr ISR inta 0x00000080, enabled 0xaa00008b, fh 0x00000000
[ 12.042625] ieee80211 phy0: il4965\_irq\_tasklet inta 0x00000080, enabled 0x00000000, fh 0x00000000
[ 12.042651] iwl4965 0000:10:00.0: RF\_KILL bit toggled to enable radio.
[ 12.042653] iwl4965 0000:10:00.0: On demand firmware reload
[ 12.042690] ieee80211 phy0: il4965\_irq\_tasklet End inta 0x00000000, enabled 0xaa00008b, fh 0x00000000, flags 0x00000282
[ 12.052207] ieee80211 phy0: il4965\_mac\_start enter
[ 12.052212] ieee80211 phy0: il\_prep\_station Add STA to driver ID 31: ff:ff:ff:ff:ff:ff
[ 12.052244] ieee80211 phy0: il4965\_set\_hw\_ready hardware ready
[ 12.052324] ieee80211 phy0: il\_apm\_init Init card's basic functions
[ 12.052348] ieee80211 phy0: il\_apm\_init L1 Enabled; Disabling L0S
[ 12.055727] ieee80211 phy0: il4965\_load\_bsm Begin load bsm
[ 12.056140] ieee80211 phy0: il4965\_verify\_bsm Begin verify bsm
[ 12.058642] ieee80211 phy0: il4965\_verify\_bsm BSM bootstrap uCode image OK
[ 12.058721] ieee80211 phy0: il4965\_load\_bsm BSM write complete, poll 1 iterations
[ 12.058734] ieee80211 phy0: \_\_il4965\_up iwl4965 is coming up
[ 12.058737] ieee80211 phy0: il4965\_mac\_start Start UP work done.
[ 12.058757] ieee80211 phy0: \_\_il4965\_down iwl4965 is going down
[ 12.058761] ieee80211 phy0: il\_scan\_cancel\_timeout Scan cancel timeout
[ 12.058762] ieee80211 phy0: il\_do\_scan\_abort Not performing scan to abort
[ 12.058765] ieee80211 phy0: il\_clear\_ucode\_stations Clearing ucode stations in driver
[ 12.058767] ieee80211 phy0: il\_clear\_ucode\_stations No active stations found to be cleared
[ 12.058819] ieee80211 phy0: \_il\_apm\_stop Stop card, put in low power state
[ 12.058827] ieee80211 phy0: \_il\_apm\_stop\_master stop master
[ 12.058864] ieee80211 phy0: il4965\_clear\_free\_frames 0 frames on pre-allocated heap on clear.
[ 12.058869] ieee80211 phy0: Hardware restart was requested
[ 16.132299] iwl4965 0000:10:00.0: START\_ALIVE timeout after 4000ms.
[ 16.132303] ------------[ cut here ]------------
[ 16.132304] Hardware became unavailable upon resume. This could be a software issue prior to suspend or a hardware issue.
[ 16.132338] WARNING: CPU: 0 PID: 181 at net/mac80211/util.c:1826 ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132390] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.132456] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Not tainted 6.11.0-cl+ #143
[ 16.132460] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.132463] Workqueue: async async\_run\_entry\_fn
[ 16.132469] RIP: 0010:ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132501] Code: da 02 00 00 c6 83 ad 05 00 00 00 48 89 df e8 98 1b fc ff 85 c0 41 89 c7 0f 84 e9 02 00 00 48 c7 c7 a0 e6 48 a0 e8 d1 77 c4 e0 <0f> 0b eb 2d 84 c0 0f 85 8b 01 00 00 c6 87 ad 05 00 00 00 e8 69 1b
[ 16.132504] RSP: 0018:ffffc9000029fcf0 EFLAGS: 00010282
[ 16.132507] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: 0000000000000001
[ 16.132509] RDX: ffffffff81f21a18 RSI: 0000000000000086 RDI: 0000000000000001
[ 16.132510] RBP: ffff8880072003c0 R08: 0000000000000000 R09: 0000000000000003
[ 16.132512] R10: 0000000000000000 R11: ffff88807e5b0000 R12: 0000000000000001
[ 16.132514] R13: 0000000000000000 R14: 0000000000000000 R15: 00000000ffffff92
[ 16.132515] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.132517] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.132519] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.132521] Call Trace:
[ 16.132525] <TASK>
[ 16.132526] ? \_\_warn+0x77/0x120
[ 16.132532] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132564] ? report\_bug+0x15c/0x190
[ 16.132568] ? handle\_bug+0x36/0x70
[ 16.132571] ? exc\_invalid\_op+0x13/0x60
[ 16.132573] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.132579] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132611] ? snd\_hdac\_bus\_init\_cmd\_io+0x24/0x200 [snd\_hda\_core]
[ 16.132617] ? pick\_eevdf+0x133/0x1c0
[ 16.132622] ? check\_preempt\_wakeup\_fair+0x70/0x90
[ 16.132626] ? wakeup\_preempt+0x4a/0x60
[ 16.132628] ? ttwu\_do\_activate.isra.0+0x5a/0x190
[ 16.132632] wiphy\_resume+0x79/0x1a0 [cfg80211]
[ 16.132675] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.132697] dpm\_run\_callback+0x75/0x1b0
[ 16.132703] device\_resume+0x97/0x200
[ 16.132707] async\_resume+0x14/0x20
[ 16.132711] async\_run\_entry\_fn+0x1b/0xa0
[ 16.132714] process\_one\_work+0x13d/0x350
[ 16.132718] worker\_thread+0x2be/0x3d0
[ 16.132722] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.132725] kthread+0xc0/0xf0
[ 16.132729] ? kthread\_park+0x80/0x80
[ 16.132732] ret\_from\_fork+0x28/0x40
[ 16.132735] ? kthread\_park+0x80/0x80
[ 16.132738] ret\_from\_fork\_asm+0x11/0x20
[ 16.132741] </TASK>
[ 16.132742] ---[ end trace 0000000000000000 ]---
[ 16.132930] ------------[ cut here ]------------
[ 16.132932] WARNING: CPU: 0 PID: 181 at net/mac80211/driver-ops.c:41 drv\_stop+0xe7/0xf0 [mac80211]
[ 16.132957] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.133014] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Tainted: G W 6.11.0-cl+ #143
[ 16.133018] Tainted: [W]=WARN
[ 16.133019] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.133021] Workqueue: async async\_run\_entry\_fn
[ 16.133025] RIP: 0010:drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133048] Code: 48 85 c0 74 0e 48 8b 78 08 89 ea 48 89 de e8 e0 87 04 00 65 ff 0d d1 de c4 5f 0f 85 42 ff ff ff e8 be 52 c2 e0 e9 38 ff ff ff <0f> 0b 5b 5d c3 0f 1f 40 00 41 54 49 89 fc 55 53 48 89 f3 2e 2e 2e
[ 16.133050] RSP: 0018:ffffc9000029fc50 EFLAGS: 00010246
[ 16.133053] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: ffff88800377f6c0
[ 16.133054] RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff8880072008e0
[ 16.133056] RBP: 0000000000000000 R08: ffffffff81f238d8 R09: 0000000000000000
[ 16.133058] R10: ffff8880080520f0 R11: 0000000000000000 R12: ffff888008051c60
[ 16.133060] R13: ffff8880072008e0 R14: 0000000000000000 R15: ffff8880072011d8
[ 16.133061] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.133063] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.133065] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.133067] Call Trace:
[ 16.133069] <TASK>
[ 16.133070] ? \_\_warn+0x77/0x120
[ 16.133075] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133098] ? report\_bug+0x15c/0x190
[ 16.133100] ? handle\_bug+0x36/0x70
[ 16.133103] ? exc\_invalid\_op+0x13/0x60
[ 16.133105] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.133109] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133132] ieee80211\_do\_stop+0x55a/0x810 [mac80211]
[ 16.133161] ? fq\_codel\_reset+0xa5/0xc0 [sch\_fq\_codel]
[ 16.133164] ieee80211\_stop+0x4f/0x180 [mac80211]
[ 16.133192] \_\_dev\_close\_many+0xa2/0x120
[ 16.133195] dev\_close\_many+0x90/0x150
[ 16.133198] dev\_close+0x5d/0x80
[ 16.133200] cfg80211\_shutdown\_all\_interfaces+0x40/0xe0 [cfg80211]
[ 16.133223] wiphy\_resume+0xb2/0x1a0 [cfg80211]
[ 16.133247] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.133269] dpm\_run\_callback+0x75/0x1b0
[ 16.133273] device\_resume+0x97/0x200
[ 16.133277] async\_resume+0x14/0x20
[ 16.133280] async\_run\_entry\_fn+0x1b/0xa0
[ 16.133283] process\_one\_work+0x13d/0x350
[ 16.133287] worker\_thread+0x2be/0x3d0
[ 16.133290] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.133294] kthread+0xc0/0xf0
[ 16.133296] ? kthread\_park+0x80/0x80
[ 16.133299] ret\_from\_fork+0x28/0x40
[ 16.133302] ? kthread\_park+0x80/0x80
[ 16.133304] ret\_from\_fork\_asm+0x11/0x20
[ 16.133307] </TASK>
[ 16.133308] ---[ end trace 0000000000000000 ]---
[ 16.133335] ieee80211 phy0: PM: dpm\_run\_callback(): wiphy\_resume [cfg80211] returns -110
[ 16.133360] ieee80211 phy0: PM: failed to restore async: error -110
Cc: stable@vger.kernel.org
Cc: Stanislaw Gruszka <stf\_xl@wp.pl>
Cc: Kalle Valo <kvalo@kernel.org>
Cc: linux-wireless@vger.kernel.org
Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Acked-by: Stanislaw Gruszka <stf\_xl@wp.pl>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241001200745.8276-1-ville.syrjala@linux.intel.com](https://patch.msgid.link/20241001200745.8276-1-ville.syrjala%40linux.intel.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0231f43df473e2f80372d0ca150eb3619932ef9)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlegacy/common.c?id=d0231f43df473e2f80372d0ca150eb3619932ef9) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlegacy/common.c b/drivers/net/wireless/intel/iwlegacy/common.cindex 4b55779de00a98..3bcb85fcbe19e6 100644--- a/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=4112450da7d67b59ccedc2208bae622db17dbcb8)+++ b/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=d0231f43df473e2f80372d0ca150eb3619932ef9)@@ -4963,6 +4963,8 @@ il\_pci\_resume(struct device \*device) \*/ pci\_write\_config\_byte(pdev, PCI\_CFG\_RETRY\_TIMEOUT, 0x00); + \_il\_wr(il, CSR\_INT, 0xffffffff);+ \_il\_wr(il, CSR\_FH\_INT\_STATUS, 0xffffffff); il\_enable\_interrupts(il);  if (!(\_il\_rd(il, CSR\_GP\_CNTRL) & CSR\_GP\_CNTRL\_REG\_FLAG\_HW\_RF\_KILL\_SW)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:34:24 +0000



=== Content from git.kernel.org_1199fe21_20250114_213545.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ville Syrjälä <ville.syrjala@linux.intel.com> | 2024-10-01 23:07:45 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:54 +0100 |
| commit | [8af8294d369a871cdbcdbb4d13b87d2d6e490a1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f)) | |
| tree | [562938b27a00f6341bf0f3b507020315f6347c8c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f) | |
| parent | [64e4c45d23cd7f6167f69cc2d2877bc7f54292e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64e4c45d23cd7f6167f69cc2d2877bc7f54292e5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f&id2=64e4c45d23cd7f6167f69cc2d2877bc7f54292e5)) | |
| download | [linux-8af8294d369a871cdbcdbb4d13b87d2d6e490a1f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8af8294d369a871cdbcdbb4d13b87d2d6e490a1f.tar.gz) | |

wifi: iwlegacy: Clear stale interrupts before resuming devicecommit 07c90acb071b9954e1fecb1e4f4f13d12c544b34 upstream.
iwl4965 fails upon resume from hibernation on my laptop. The reason
seems to be a stale interrupt which isn't being cleared out before
interrupts are enabled. We end up with a race beween the resume
trying to bring things back up, and the restart work (queued form
the interrupt handler) trying to bring things down. Eventually
the whole thing blows up.
Fix the problem by clearing out any stale interrupts before
interrupts get enabled during resume.
Here's a debug log of the indicent:
[ 12.042589] ieee80211 phy0: il\_isr ISR inta 0x00000080, enabled 0xaa00008b, fh 0x00000000
[ 12.042625] ieee80211 phy0: il4965\_irq\_tasklet inta 0x00000080, enabled 0x00000000, fh 0x00000000
[ 12.042651] iwl4965 0000:10:00.0: RF\_KILL bit toggled to enable radio.
[ 12.042653] iwl4965 0000:10:00.0: On demand firmware reload
[ 12.042690] ieee80211 phy0: il4965\_irq\_tasklet End inta 0x00000000, enabled 0xaa00008b, fh 0x00000000, flags 0x00000282
[ 12.052207] ieee80211 phy0: il4965\_mac\_start enter
[ 12.052212] ieee80211 phy0: il\_prep\_station Add STA to driver ID 31: ff:ff:ff:ff:ff:ff
[ 12.052244] ieee80211 phy0: il4965\_set\_hw\_ready hardware ready
[ 12.052324] ieee80211 phy0: il\_apm\_init Init card's basic functions
[ 12.052348] ieee80211 phy0: il\_apm\_init L1 Enabled; Disabling L0S
[ 12.055727] ieee80211 phy0: il4965\_load\_bsm Begin load bsm
[ 12.056140] ieee80211 phy0: il4965\_verify\_bsm Begin verify bsm
[ 12.058642] ieee80211 phy0: il4965\_verify\_bsm BSM bootstrap uCode image OK
[ 12.058721] ieee80211 phy0: il4965\_load\_bsm BSM write complete, poll 1 iterations
[ 12.058734] ieee80211 phy0: \_\_il4965\_up iwl4965 is coming up
[ 12.058737] ieee80211 phy0: il4965\_mac\_start Start UP work done.
[ 12.058757] ieee80211 phy0: \_\_il4965\_down iwl4965 is going down
[ 12.058761] ieee80211 phy0: il\_scan\_cancel\_timeout Scan cancel timeout
[ 12.058762] ieee80211 phy0: il\_do\_scan\_abort Not performing scan to abort
[ 12.058765] ieee80211 phy0: il\_clear\_ucode\_stations Clearing ucode stations in driver
[ 12.058767] ieee80211 phy0: il\_clear\_ucode\_stations No active stations found to be cleared
[ 12.058819] ieee80211 phy0: \_il\_apm\_stop Stop card, put in low power state
[ 12.058827] ieee80211 phy0: \_il\_apm\_stop\_master stop master
[ 12.058864] ieee80211 phy0: il4965\_clear\_free\_frames 0 frames on pre-allocated heap on clear.
[ 12.058869] ieee80211 phy0: Hardware restart was requested
[ 16.132299] iwl4965 0000:10:00.0: START\_ALIVE timeout after 4000ms.
[ 16.132303] ------------[ cut here ]------------
[ 16.132304] Hardware became unavailable upon resume. This could be a software issue prior to suspend or a hardware issue.
[ 16.132338] WARNING: CPU: 0 PID: 181 at net/mac80211/util.c:1826 ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132390] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.132456] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Not tainted 6.11.0-cl+ #143
[ 16.132460] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.132463] Workqueue: async async\_run\_entry\_fn
[ 16.132469] RIP: 0010:ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132501] Code: da 02 00 00 c6 83 ad 05 00 00 00 48 89 df e8 98 1b fc ff 85 c0 41 89 c7 0f 84 e9 02 00 00 48 c7 c7 a0 e6 48 a0 e8 d1 77 c4 e0 <0f> 0b eb 2d 84 c0 0f 85 8b 01 00 00 c6 87 ad 05 00 00 00 e8 69 1b
[ 16.132504] RSP: 0018:ffffc9000029fcf0 EFLAGS: 00010282
[ 16.132507] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: 0000000000000001
[ 16.132509] RDX: ffffffff81f21a18 RSI: 0000000000000086 RDI: 0000000000000001
[ 16.132510] RBP: ffff8880072003c0 R08: 0000000000000000 R09: 0000000000000003
[ 16.132512] R10: 0000000000000000 R11: ffff88807e5b0000 R12: 0000000000000001
[ 16.132514] R13: 0000000000000000 R14: 0000000000000000 R15: 00000000ffffff92
[ 16.132515] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.132517] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.132519] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.132521] Call Trace:
[ 16.132525] <TASK>
[ 16.132526] ? \_\_warn+0x77/0x120
[ 16.132532] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132564] ? report\_bug+0x15c/0x190
[ 16.132568] ? handle\_bug+0x36/0x70
[ 16.132571] ? exc\_invalid\_op+0x13/0x60
[ 16.132573] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.132579] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132611] ? snd\_hdac\_bus\_init\_cmd\_io+0x24/0x200 [snd\_hda\_core]
[ 16.132617] ? pick\_eevdf+0x133/0x1c0
[ 16.132622] ? check\_preempt\_wakeup\_fair+0x70/0x90
[ 16.132626] ? wakeup\_preempt+0x4a/0x60
[ 16.132628] ? ttwu\_do\_activate.isra.0+0x5a/0x190
[ 16.132632] wiphy\_resume+0x79/0x1a0 [cfg80211]
[ 16.132675] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.132697] dpm\_run\_callback+0x75/0x1b0
[ 16.132703] device\_resume+0x97/0x200
[ 16.132707] async\_resume+0x14/0x20
[ 16.132711] async\_run\_entry\_fn+0x1b/0xa0
[ 16.132714] process\_one\_work+0x13d/0x350
[ 16.132718] worker\_thread+0x2be/0x3d0
[ 16.132722] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.132725] kthread+0xc0/0xf0
[ 16.132729] ? kthread\_park+0x80/0x80
[ 16.132732] ret\_from\_fork+0x28/0x40
[ 16.132735] ? kthread\_park+0x80/0x80
[ 16.132738] ret\_from\_fork\_asm+0x11/0x20
[ 16.132741] </TASK>
[ 16.132742] ---[ end trace 0000000000000000 ]---
[ 16.132930] ------------[ cut here ]------------
[ 16.132932] WARNING: CPU: 0 PID: 181 at net/mac80211/driver-ops.c:41 drv\_stop+0xe7/0xf0 [mac80211]
[ 16.132957] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.133014] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Tainted: G W 6.11.0-cl+ #143
[ 16.133018] Tainted: [W]=WARN
[ 16.133019] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.133021] Workqueue: async async\_run\_entry\_fn
[ 16.133025] RIP: 0010:drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133048] Code: 48 85 c0 74 0e 48 8b 78 08 89 ea 48 89 de e8 e0 87 04 00 65 ff 0d d1 de c4 5f 0f 85 42 ff ff ff e8 be 52 c2 e0 e9 38 ff ff ff <0f> 0b 5b 5d c3 0f 1f 40 00 41 54 49 89 fc 55 53 48 89 f3 2e 2e 2e
[ 16.133050] RSP: 0018:ffffc9000029fc50 EFLAGS: 00010246
[ 16.133053] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: ffff88800377f6c0
[ 16.133054] RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff8880072008e0
[ 16.133056] RBP: 0000000000000000 R08: ffffffff81f238d8 R09: 0000000000000000
[ 16.133058] R10: ffff8880080520f0 R11: 0000000000000000 R12: ffff888008051c60
[ 16.133060] R13: ffff8880072008e0 R14: 0000000000000000 R15: ffff8880072011d8
[ 16.133061] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.133063] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.133065] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.133067] Call Trace:
[ 16.133069] <TASK>
[ 16.133070] ? \_\_warn+0x77/0x120
[ 16.133075] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133098] ? report\_bug+0x15c/0x190
[ 16.133100] ? handle\_bug+0x36/0x70
[ 16.133103] ? exc\_invalid\_op+0x13/0x60
[ 16.133105] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.133109] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133132] ieee80211\_do\_stop+0x55a/0x810 [mac80211]
[ 16.133161] ? fq\_codel\_reset+0xa5/0xc0 [sch\_fq\_codel]
[ 16.133164] ieee80211\_stop+0x4f/0x180 [mac80211]
[ 16.133192] \_\_dev\_close\_many+0xa2/0x120
[ 16.133195] dev\_close\_many+0x90/0x150
[ 16.133198] dev\_close+0x5d/0x80
[ 16.133200] cfg80211\_shutdown\_all\_interfaces+0x40/0xe0 [cfg80211]
[ 16.133223] wiphy\_resume+0xb2/0x1a0 [cfg80211]
[ 16.133247] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.133269] dpm\_run\_callback+0x75/0x1b0
[ 16.133273] device\_resume+0x97/0x200
[ 16.133277] async\_resume+0x14/0x20
[ 16.133280] async\_run\_entry\_fn+0x1b/0xa0
[ 16.133283] process\_one\_work+0x13d/0x350
[ 16.133287] worker\_thread+0x2be/0x3d0
[ 16.133290] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.133294] kthread+0xc0/0xf0
[ 16.133296] ? kthread\_park+0x80/0x80
[ 16.133299] ret\_from\_fork+0x28/0x40
[ 16.133302] ? kthread\_park+0x80/0x80
[ 16.133304] ret\_from\_fork\_asm+0x11/0x20
[ 16.133307] </TASK>
[ 16.133308] ---[ end trace 0000000000000000 ]---
[ 16.133335] ieee80211 phy0: PM: dpm\_run\_callback(): wiphy\_resume [cfg80211] returns -110
[ 16.133360] ieee80211 phy0: PM: failed to restore async: error -110
Cc: stable@vger.kernel.org
Cc: Stanislaw Gruszka <stf\_xl@wp.pl>
Cc: Kalle Valo <kvalo@kernel.org>
Cc: linux-wireless@vger.kernel.org
Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Acked-by: Stanislaw Gruszka <stf\_xl@wp.pl>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241001200745.8276-1-ville.syrjala@linux.intel.com](https://patch.msgid.link/20241001200745.8276-1-ville.syrjala%40linux.intel.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlegacy/common.c?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlegacy/common.c b/drivers/net/wireless/intel/iwlegacy/common.cindex 4616293ec0cf41..958dd4f9bc6920 100644--- a/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=64e4c45d23cd7f6167f69cc2d2877bc7f54292e5)+++ b/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=8af8294d369a871cdbcdbb4d13b87d2d6e490a1f)@@ -4973,6 +4973,8 @@ il\_pci\_resume(struct device \*device) \*/ pci\_write\_config\_byte(pdev, PCI\_CFG\_RETRY\_TIMEOUT, 0x00); + \_il\_wr(il, CSR\_INT, 0xffffffff);+ \_il\_wr(il, CSR\_FH\_INT\_STATUS, 0xffffffff); il\_enable\_interrupts(il);  if (!(\_il\_rd(il, CSR\_GP\_CNTRL) & CSR\_GP\_CNTRL\_REG\_FLAG\_HW\_RF\_KILL\_SW)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:34:22 +0000



=== Content from git.kernel.org_d09473be_20250114_213546.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ville Syrjälä <ville.syrjala@linux.intel.com> | 2024-10-01 23:07:45 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:53 +0100 |
| commit | [9d89941e51259c2b0b8e9c10c6f1f74200d7444f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f)) | |
| tree | [af1f43cd3b363e5b1e2728e0a43c6ad18065f7c5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f) | |
| parent | [6fc9af3df6ca7f3c94774d20f62dc7b49616026d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f&id2=6fc9af3df6ca7f3c94774d20f62dc7b49616026d)) | |
| download | [linux-9d89941e51259c2b0b8e9c10c6f1f74200d7444f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9d89941e51259c2b0b8e9c10c6f1f74200d7444f.tar.gz) | |

wifi: iwlegacy: Clear stale interrupts before resuming devicecommit 07c90acb071b9954e1fecb1e4f4f13d12c544b34 upstream.
iwl4965 fails upon resume from hibernation on my laptop. The reason
seems to be a stale interrupt which isn't being cleared out before
interrupts are enabled. We end up with a race beween the resume
trying to bring things back up, and the restart work (queued form
the interrupt handler) trying to bring things down. Eventually
the whole thing blows up.
Fix the problem by clearing out any stale interrupts before
interrupts get enabled during resume.
Here's a debug log of the indicent:
[ 12.042589] ieee80211 phy0: il\_isr ISR inta 0x00000080, enabled 0xaa00008b, fh 0x00000000
[ 12.042625] ieee80211 phy0: il4965\_irq\_tasklet inta 0x00000080, enabled 0x00000000, fh 0x00000000
[ 12.042651] iwl4965 0000:10:00.0: RF\_KILL bit toggled to enable radio.
[ 12.042653] iwl4965 0000:10:00.0: On demand firmware reload
[ 12.042690] ieee80211 phy0: il4965\_irq\_tasklet End inta 0x00000000, enabled 0xaa00008b, fh 0x00000000, flags 0x00000282
[ 12.052207] ieee80211 phy0: il4965\_mac\_start enter
[ 12.052212] ieee80211 phy0: il\_prep\_station Add STA to driver ID 31: ff:ff:ff:ff:ff:ff
[ 12.052244] ieee80211 phy0: il4965\_set\_hw\_ready hardware ready
[ 12.052324] ieee80211 phy0: il\_apm\_init Init card's basic functions
[ 12.052348] ieee80211 phy0: il\_apm\_init L1 Enabled; Disabling L0S
[ 12.055727] ieee80211 phy0: il4965\_load\_bsm Begin load bsm
[ 12.056140] ieee80211 phy0: il4965\_verify\_bsm Begin verify bsm
[ 12.058642] ieee80211 phy0: il4965\_verify\_bsm BSM bootstrap uCode image OK
[ 12.058721] ieee80211 phy0: il4965\_load\_bsm BSM write complete, poll 1 iterations
[ 12.058734] ieee80211 phy0: \_\_il4965\_up iwl4965 is coming up
[ 12.058737] ieee80211 phy0: il4965\_mac\_start Start UP work done.
[ 12.058757] ieee80211 phy0: \_\_il4965\_down iwl4965 is going down
[ 12.058761] ieee80211 phy0: il\_scan\_cancel\_timeout Scan cancel timeout
[ 12.058762] ieee80211 phy0: il\_do\_scan\_abort Not performing scan to abort
[ 12.058765] ieee80211 phy0: il\_clear\_ucode\_stations Clearing ucode stations in driver
[ 12.058767] ieee80211 phy0: il\_clear\_ucode\_stations No active stations found to be cleared
[ 12.058819] ieee80211 phy0: \_il\_apm\_stop Stop card, put in low power state
[ 12.058827] ieee80211 phy0: \_il\_apm\_stop\_master stop master
[ 12.058864] ieee80211 phy0: il4965\_clear\_free\_frames 0 frames on pre-allocated heap on clear.
[ 12.058869] ieee80211 phy0: Hardware restart was requested
[ 16.132299] iwl4965 0000:10:00.0: START\_ALIVE timeout after 4000ms.
[ 16.132303] ------------[ cut here ]------------
[ 16.132304] Hardware became unavailable upon resume. This could be a software issue prior to suspend or a hardware issue.
[ 16.132338] WARNING: CPU: 0 PID: 181 at net/mac80211/util.c:1826 ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132390] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.132456] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Not tainted 6.11.0-cl+ #143
[ 16.132460] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.132463] Workqueue: async async\_run\_entry\_fn
[ 16.132469] RIP: 0010:ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132501] Code: da 02 00 00 c6 83 ad 05 00 00 00 48 89 df e8 98 1b fc ff 85 c0 41 89 c7 0f 84 e9 02 00 00 48 c7 c7 a0 e6 48 a0 e8 d1 77 c4 e0 <0f> 0b eb 2d 84 c0 0f 85 8b 01 00 00 c6 87 ad 05 00 00 00 e8 69 1b
[ 16.132504] RSP: 0018:ffffc9000029fcf0 EFLAGS: 00010282
[ 16.132507] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: 0000000000000001
[ 16.132509] RDX: ffffffff81f21a18 RSI: 0000000000000086 RDI: 0000000000000001
[ 16.132510] RBP: ffff8880072003c0 R08: 0000000000000000 R09: 0000000000000003
[ 16.132512] R10: 0000000000000000 R11: ffff88807e5b0000 R12: 0000000000000001
[ 16.132514] R13: 0000000000000000 R14: 0000000000000000 R15: 00000000ffffff92
[ 16.132515] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.132517] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.132519] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.132521] Call Trace:
[ 16.132525] <TASK>
[ 16.132526] ? \_\_warn+0x77/0x120
[ 16.132532] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132564] ? report\_bug+0x15c/0x190
[ 16.132568] ? handle\_bug+0x36/0x70
[ 16.132571] ? exc\_invalid\_op+0x13/0x60
[ 16.132573] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.132579] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132611] ? snd\_hdac\_bus\_init\_cmd\_io+0x24/0x200 [snd\_hda\_core]
[ 16.132617] ? pick\_eevdf+0x133/0x1c0
[ 16.132622] ? check\_preempt\_wakeup\_fair+0x70/0x90
[ 16.132626] ? wakeup\_preempt+0x4a/0x60
[ 16.132628] ? ttwu\_do\_activate.isra.0+0x5a/0x190
[ 16.132632] wiphy\_resume+0x79/0x1a0 [cfg80211]
[ 16.132675] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.132697] dpm\_run\_callback+0x75/0x1b0
[ 16.132703] device\_resume+0x97/0x200
[ 16.132707] async\_resume+0x14/0x20
[ 16.132711] async\_run\_entry\_fn+0x1b/0xa0
[ 16.132714] process\_one\_work+0x13d/0x350
[ 16.132718] worker\_thread+0x2be/0x3d0
[ 16.132722] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.132725] kthread+0xc0/0xf0
[ 16.132729] ? kthread\_park+0x80/0x80
[ 16.132732] ret\_from\_fork+0x28/0x40
[ 16.132735] ? kthread\_park+0x80/0x80
[ 16.132738] ret\_from\_fork\_asm+0x11/0x20
[ 16.132741] </TASK>
[ 16.132742] ---[ end trace 0000000000000000 ]---
[ 16.132930] ------------[ cut here ]------------
[ 16.132932] WARNING: CPU: 0 PID: 181 at net/mac80211/driver-ops.c:41 drv\_stop+0xe7/0xf0 [mac80211]
[ 16.132957] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.133014] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Tainted: G W 6.11.0-cl+ #143
[ 16.133018] Tainted: [W]=WARN
[ 16.133019] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.133021] Workqueue: async async\_run\_entry\_fn
[ 16.133025] RIP: 0010:drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133048] Code: 48 85 c0 74 0e 48 8b 78 08 89 ea 48 89 de e8 e0 87 04 00 65 ff 0d d1 de c4 5f 0f 85 42 ff ff ff e8 be 52 c2 e0 e9 38 ff ff ff <0f> 0b 5b 5d c3 0f 1f 40 00 41 54 49 89 fc 55 53 48 89 f3 2e 2e 2e
[ 16.133050] RSP: 0018:ffffc9000029fc50 EFLAGS: 00010246
[ 16.133053] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: ffff88800377f6c0
[ 16.133054] RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff8880072008e0
[ 16.133056] RBP: 0000000000000000 R08: ffffffff81f238d8 R09: 0000000000000000
[ 16.133058] R10: ffff8880080520f0 R11: 0000000000000000 R12: ffff888008051c60
[ 16.133060] R13: ffff8880072008e0 R14: 0000000000000000 R15: ffff8880072011d8
[ 16.133061] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.133063] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.133065] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.133067] Call Trace:
[ 16.133069] <TASK>
[ 16.133070] ? \_\_warn+0x77/0x120
[ 16.133075] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133098] ? report\_bug+0x15c/0x190
[ 16.133100] ? handle\_bug+0x36/0x70
[ 16.133103] ? exc\_invalid\_op+0x13/0x60
[ 16.133105] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.133109] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133132] ieee80211\_do\_stop+0x55a/0x810 [mac80211]
[ 16.133161] ? fq\_codel\_reset+0xa5/0xc0 [sch\_fq\_codel]
[ 16.133164] ieee80211\_stop+0x4f/0x180 [mac80211]
[ 16.133192] \_\_dev\_close\_many+0xa2/0x120
[ 16.133195] dev\_close\_many+0x90/0x150
[ 16.133198] dev\_close+0x5d/0x80
[ 16.133200] cfg80211\_shutdown\_all\_interfaces+0x40/0xe0 [cfg80211]
[ 16.133223] wiphy\_resume+0xb2/0x1a0 [cfg80211]
[ 16.133247] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.133269] dpm\_run\_callback+0x75/0x1b0
[ 16.133273] device\_resume+0x97/0x200
[ 16.133277] async\_resume+0x14/0x20
[ 16.133280] async\_run\_entry\_fn+0x1b/0xa0
[ 16.133283] process\_one\_work+0x13d/0x350
[ 16.133287] worker\_thread+0x2be/0x3d0
[ 16.133290] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.133294] kthread+0xc0/0xf0
[ 16.133296] ? kthread\_park+0x80/0x80
[ 16.133299] ret\_from\_fork+0x28/0x40
[ 16.133302] ? kthread\_park+0x80/0x80
[ 16.133304] ret\_from\_fork\_asm+0x11/0x20
[ 16.133307] </TASK>
[ 16.133308] ---[ end trace 0000000000000000 ]---
[ 16.133335] ieee80211 phy0: PM: dpm\_run\_callback(): wiphy\_resume [cfg80211] returns -110
[ 16.133360] ieee80211 phy0: PM: failed to restore async: error -110
Cc: stable@vger.kernel.org
Cc: Stanislaw Gruszka <stf\_xl@wp.pl>
Cc: Kalle Valo <kvalo@kernel.org>
Cc: linux-wireless@vger.kernel.org
Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Acked-by: Stanislaw Gruszka <stf\_xl@wp.pl>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241001200745.8276-1-ville.syrjala@linux.intel.com](https://patch.msgid.link/20241001200745.8276-1-ville.syrjala%40linux.intel.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlegacy/common.c?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlegacy/common.c b/drivers/net/wireless/intel/iwlegacy/common.cindex 7cfd80d40a6535..6f66f85d0cc3f7 100644--- a/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=6fc9af3df6ca7f3c94774d20f62dc7b49616026d)+++ b/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=9d89941e51259c2b0b8e9c10c6f1f74200d7444f)@@ -4969,6 +4969,8 @@ il\_pci\_resume(struct device \*device) \*/ pci\_write\_config\_byte(pdev, PCI\_CFG\_RETRY\_TIMEOUT, 0x00); + \_il\_wr(il, CSR\_INT, 0xffffffff);+ \_il\_wr(il, CSR\_FH\_INT\_STATUS, 0xffffffff); il\_enable\_interrupts(il);  if (!(\_il\_rd(il, CSR\_GP\_CNTRL) & CSR\_GP\_CNTRL\_REG\_FLAG\_HW\_RF\_KILL\_SW)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:34:23 +0000



=== Content from git.kernel.org_3cc5b101_20250114_213543.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ville Syrjälä <ville.syrjala@linux.intel.com> | 2024-10-01 23:07:45 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:45 +0100 |
| commit | [23f9cef17ee315777dbe88d5c11ff6166e4d0699](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699)) | |
| tree | [3c4991322e7d86f07b8737e7c98be59582c684c1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699) | |
| parent | [ba392e1355ba74b1d4fa11b85f71ab6ed7ecc058](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba392e1355ba74b1d4fa11b85f71ab6ed7ecc058) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699&id2=ba392e1355ba74b1d4fa11b85f71ab6ed7ecc058)) | |
| download | [linux-23f9cef17ee315777dbe88d5c11ff6166e4d0699.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-23f9cef17ee315777dbe88d5c11ff6166e4d0699.tar.gz) | |

wifi: iwlegacy: Clear stale interrupts before resuming devicecommit 07c90acb071b9954e1fecb1e4f4f13d12c544b34 upstream.
iwl4965 fails upon resume from hibernation on my laptop. The reason
seems to be a stale interrupt which isn't being cleared out before
interrupts are enabled. We end up with a race beween the resume
trying to bring things back up, and the restart work (queued form
the interrupt handler) trying to bring things down. Eventually
the whole thing blows up.
Fix the problem by clearing out any stale interrupts before
interrupts get enabled during resume.
Here's a debug log of the indicent:
[ 12.042589] ieee80211 phy0: il\_isr ISR inta 0x00000080, enabled 0xaa00008b, fh 0x00000000
[ 12.042625] ieee80211 phy0: il4965\_irq\_tasklet inta 0x00000080, enabled 0x00000000, fh 0x00000000
[ 12.042651] iwl4965 0000:10:00.0: RF\_KILL bit toggled to enable radio.
[ 12.042653] iwl4965 0000:10:00.0: On demand firmware reload
[ 12.042690] ieee80211 phy0: il4965\_irq\_tasklet End inta 0x00000000, enabled 0xaa00008b, fh 0x00000000, flags 0x00000282
[ 12.052207] ieee80211 phy0: il4965\_mac\_start enter
[ 12.052212] ieee80211 phy0: il\_prep\_station Add STA to driver ID 31: ff:ff:ff:ff:ff:ff
[ 12.052244] ieee80211 phy0: il4965\_set\_hw\_ready hardware ready
[ 12.052324] ieee80211 phy0: il\_apm\_init Init card's basic functions
[ 12.052348] ieee80211 phy0: il\_apm\_init L1 Enabled; Disabling L0S
[ 12.055727] ieee80211 phy0: il4965\_load\_bsm Begin load bsm
[ 12.056140] ieee80211 phy0: il4965\_verify\_bsm Begin verify bsm
[ 12.058642] ieee80211 phy0: il4965\_verify\_bsm BSM bootstrap uCode image OK
[ 12.058721] ieee80211 phy0: il4965\_load\_bsm BSM write complete, poll 1 iterations
[ 12.058734] ieee80211 phy0: \_\_il4965\_up iwl4965 is coming up
[ 12.058737] ieee80211 phy0: il4965\_mac\_start Start UP work done.
[ 12.058757] ieee80211 phy0: \_\_il4965\_down iwl4965 is going down
[ 12.058761] ieee80211 phy0: il\_scan\_cancel\_timeout Scan cancel timeout
[ 12.058762] ieee80211 phy0: il\_do\_scan\_abort Not performing scan to abort
[ 12.058765] ieee80211 phy0: il\_clear\_ucode\_stations Clearing ucode stations in driver
[ 12.058767] ieee80211 phy0: il\_clear\_ucode\_stations No active stations found to be cleared
[ 12.058819] ieee80211 phy0: \_il\_apm\_stop Stop card, put in low power state
[ 12.058827] ieee80211 phy0: \_il\_apm\_stop\_master stop master
[ 12.058864] ieee80211 phy0: il4965\_clear\_free\_frames 0 frames on pre-allocated heap on clear.
[ 12.058869] ieee80211 phy0: Hardware restart was requested
[ 16.132299] iwl4965 0000:10:00.0: START\_ALIVE timeout after 4000ms.
[ 16.132303] ------------[ cut here ]------------
[ 16.132304] Hardware became unavailable upon resume. This could be a software issue prior to suspend or a hardware issue.
[ 16.132338] WARNING: CPU: 0 PID: 181 at net/mac80211/util.c:1826 ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132390] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.132456] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Not tainted 6.11.0-cl+ #143
[ 16.132460] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.132463] Workqueue: async async\_run\_entry\_fn
[ 16.132469] RIP: 0010:ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132501] Code: da 02 00 00 c6 83 ad 05 00 00 00 48 89 df e8 98 1b fc ff 85 c0 41 89 c7 0f 84 e9 02 00 00 48 c7 c7 a0 e6 48 a0 e8 d1 77 c4 e0 <0f> 0b eb 2d 84 c0 0f 85 8b 01 00 00 c6 87 ad 05 00 00 00 e8 69 1b
[ 16.132504] RSP: 0018:ffffc9000029fcf0 EFLAGS: 00010282
[ 16.132507] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: 0000000000000001
[ 16.132509] RDX: ffffffff81f21a18 RSI: 0000000000000086 RDI: 0000000000000001
[ 16.132510] RBP: ffff8880072003c0 R08: 0000000000000000 R09: 0000000000000003
[ 16.132512] R10: 0000000000000000 R11: ffff88807e5b0000 R12: 0000000000000001
[ 16.132514] R13: 0000000000000000 R14: 0000000000000000 R15: 00000000ffffff92
[ 16.132515] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.132517] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.132519] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.132521] Call Trace:
[ 16.132525] <TASK>
[ 16.132526] ? \_\_warn+0x77/0x120
[ 16.132532] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132564] ? report\_bug+0x15c/0x190
[ 16.132568] ? handle\_bug+0x36/0x70
[ 16.132571] ? exc\_invalid\_op+0x13/0x60
[ 16.132573] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.132579] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132611] ? snd\_hdac\_bus\_init\_cmd\_io+0x24/0x200 [snd\_hda\_core]
[ 16.132617] ? pick\_eevdf+0x133/0x1c0
[ 16.132622] ? check\_preempt\_wakeup\_fair+0x70/0x90
[ 16.132626] ? wakeup\_preempt+0x4a/0x60
[ 16.132628] ? ttwu\_do\_activate.isra.0+0x5a/0x190
[ 16.132632] wiphy\_resume+0x79/0x1a0 [cfg80211]
[ 16.132675] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.132697] dpm\_run\_callback+0x75/0x1b0
[ 16.132703] device\_resume+0x97/0x200
[ 16.132707] async\_resume+0x14/0x20
[ 16.132711] async\_run\_entry\_fn+0x1b/0xa0
[ 16.132714] process\_one\_work+0x13d/0x350
[ 16.132718] worker\_thread+0x2be/0x3d0
[ 16.132722] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.132725] kthread+0xc0/0xf0
[ 16.132729] ? kthread\_park+0x80/0x80
[ 16.132732] ret\_from\_fork+0x28/0x40
[ 16.132735] ? kthread\_park+0x80/0x80
[ 16.132738] ret\_from\_fork\_asm+0x11/0x20
[ 16.132741] </TASK>
[ 16.132742] ---[ end trace 0000000000000000 ]---
[ 16.132930] ------------[ cut here ]------------
[ 16.132932] WARNING: CPU: 0 PID: 181 at net/mac80211/driver-ops.c:41 drv\_stop+0xe7/0xf0 [mac80211]
[ 16.132957] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.133014] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Tainted: G W 6.11.0-cl+ #143
[ 16.133018] Tainted: [W]=WARN
[ 16.133019] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.133021] Workqueue: async async\_run\_entry\_fn
[ 16.133025] RIP: 0010:drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133048] Code: 48 85 c0 74 0e 48 8b 78 08 89 ea 48 89 de e8 e0 87 04 00 65 ff 0d d1 de c4 5f 0f 85 42 ff ff ff e8 be 52 c2 e0 e9 38 ff ff ff <0f> 0b 5b 5d c3 0f 1f 40 00 41 54 49 89 fc 55 53 48 89 f3 2e 2e 2e
[ 16.133050] RSP: 0018:ffffc9000029fc50 EFLAGS: 00010246
[ 16.133053] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: ffff88800377f6c0
[ 16.133054] RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff8880072008e0
[ 16.133056] RBP: 0000000000000000 R08: ffffffff81f238d8 R09: 0000000000000000
[ 16.133058] R10: ffff8880080520f0 R11: 0000000000000000 R12: ffff888008051c60
[ 16.133060] R13: ffff8880072008e0 R14: 0000000000000000 R15: ffff8880072011d8
[ 16.133061] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.133063] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.133065] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.133067] Call Trace:
[ 16.133069] <TASK>
[ 16.133070] ? \_\_warn+0x77/0x120
[ 16.133075] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133098] ? report\_bug+0x15c/0x190
[ 16.133100] ? handle\_bug+0x36/0x70
[ 16.133103] ? exc\_invalid\_op+0x13/0x60
[ 16.133105] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.133109] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133132] ieee80211\_do\_stop+0x55a/0x810 [mac80211]
[ 16.133161] ? fq\_codel\_reset+0xa5/0xc0 [sch\_fq\_codel]
[ 16.133164] ieee80211\_stop+0x4f/0x180 [mac80211]
[ 16.133192] \_\_dev\_close\_many+0xa2/0x120
[ 16.133195] dev\_close\_many+0x90/0x150
[ 16.133198] dev\_close+0x5d/0x80
[ 16.133200] cfg80211\_shutdown\_all\_interfaces+0x40/0xe0 [cfg80211]
[ 16.133223] wiphy\_resume+0xb2/0x1a0 [cfg80211]
[ 16.133247] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.133269] dpm\_run\_callback+0x75/0x1b0
[ 16.133273] device\_resume+0x97/0x200
[ 16.133277] async\_resume+0x14/0x20
[ 16.133280] async\_run\_entry\_fn+0x1b/0xa0
[ 16.133283] process\_one\_work+0x13d/0x350
[ 16.133287] worker\_thread+0x2be/0x3d0
[ 16.133290] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.133294] kthread+0xc0/0xf0
[ 16.133296] ? kthread\_park+0x80/0x80
[ 16.133299] ret\_from\_fork+0x28/0x40
[ 16.133302] ? kthread\_park+0x80/0x80
[ 16.133304] ret\_from\_fork\_asm+0x11/0x20
[ 16.133307] </TASK>
[ 16.133308] ---[ end trace 0000000000000000 ]---
[ 16.133335] ieee80211 phy0: PM: dpm\_run\_callback(): wiphy\_resume [cfg80211] returns -110
[ 16.133360] ieee80211 phy0: PM: failed to restore async: error -110
Cc: stable@vger.kernel.org
Cc: Stanislaw Gruszka <stf\_xl@wp.pl>
Cc: Kalle Valo <kvalo@kernel.org>
Cc: linux-wireless@vger.kernel.org
Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Acked-by: Stanislaw Gruszka <stf\_xl@wp.pl>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241001200745.8276-1-ville.syrjala@linux.intel.com](https://patch.msgid.link/20241001200745.8276-1-ville.syrjala%40linux.intel.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlegacy/common.c?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlegacy/common.c b/drivers/net/wireless/intel/iwlegacy/common.cindex 9fa38221c43116..1810b12645a02f 100644--- a/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=ba392e1355ba74b1d4fa11b85f71ab6ed7ecc058)+++ b/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=23f9cef17ee315777dbe88d5c11ff6166e4d0699)@@ -4972,6 +4972,8 @@ il\_pci\_resume(struct device \*device) \*/ pci\_write\_config\_byte(pdev, PCI\_CFG\_RETRY\_TIMEOUT, 0x00); + \_il\_wr(il, CSR\_INT, 0xffffffff);+ \_il\_wr(il, CSR\_FH\_INT\_STATUS, 0xffffffff); il\_enable\_interrupts(il);  if (!(\_il\_rd(il, CSR\_GP\_CNTRL) & CSR\_GP\_CNTRL\_REG\_FLAG\_HW\_RF\_KILL\_SW)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:34:20 +0000



=== Content from git.kernel.org_f54804b8_20250114_213544.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ville Syrjälä <ville.syrjala@linux.intel.com> | 2024-10-01 23:07:45 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:25:54 +0100 |
| commit | [8ac22fe1e2b104c37e4fecd97735f64bd6349ebc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc)) | |
| tree | [6fe41a2bc01571e572ff1025d1f4f481772d8568](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc) | |
| parent | [705be2dc45c7f852e211e16bc41a916fab741983](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=705be2dc45c7f852e211e16bc41a916fab741983) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc&id2=705be2dc45c7f852e211e16bc41a916fab741983)) | |
| download | [linux-8ac22fe1e2b104c37e4fecd97735f64bd6349ebc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8ac22fe1e2b104c37e4fecd97735f64bd6349ebc.tar.gz) | |

wifi: iwlegacy: Clear stale interrupts before resuming devicecommit 07c90acb071b9954e1fecb1e4f4f13d12c544b34 upstream.
iwl4965 fails upon resume from hibernation on my laptop. The reason
seems to be a stale interrupt which isn't being cleared out before
interrupts are enabled. We end up with a race beween the resume
trying to bring things back up, and the restart work (queued form
the interrupt handler) trying to bring things down. Eventually
the whole thing blows up.
Fix the problem by clearing out any stale interrupts before
interrupts get enabled during resume.
Here's a debug log of the indicent:
[ 12.042589] ieee80211 phy0: il\_isr ISR inta 0x00000080, enabled 0xaa00008b, fh 0x00000000
[ 12.042625] ieee80211 phy0: il4965\_irq\_tasklet inta 0x00000080, enabled 0x00000000, fh 0x00000000
[ 12.042651] iwl4965 0000:10:00.0: RF\_KILL bit toggled to enable radio.
[ 12.042653] iwl4965 0000:10:00.0: On demand firmware reload
[ 12.042690] ieee80211 phy0: il4965\_irq\_tasklet End inta 0x00000000, enabled 0xaa00008b, fh 0x00000000, flags 0x00000282
[ 12.052207] ieee80211 phy0: il4965\_mac\_start enter
[ 12.052212] ieee80211 phy0: il\_prep\_station Add STA to driver ID 31: ff:ff:ff:ff:ff:ff
[ 12.052244] ieee80211 phy0: il4965\_set\_hw\_ready hardware ready
[ 12.052324] ieee80211 phy0: il\_apm\_init Init card's basic functions
[ 12.052348] ieee80211 phy0: il\_apm\_init L1 Enabled; Disabling L0S
[ 12.055727] ieee80211 phy0: il4965\_load\_bsm Begin load bsm
[ 12.056140] ieee80211 phy0: il4965\_verify\_bsm Begin verify bsm
[ 12.058642] ieee80211 phy0: il4965\_verify\_bsm BSM bootstrap uCode image OK
[ 12.058721] ieee80211 phy0: il4965\_load\_bsm BSM write complete, poll 1 iterations
[ 12.058734] ieee80211 phy0: \_\_il4965\_up iwl4965 is coming up
[ 12.058737] ieee80211 phy0: il4965\_mac\_start Start UP work done.
[ 12.058757] ieee80211 phy0: \_\_il4965\_down iwl4965 is going down
[ 12.058761] ieee80211 phy0: il\_scan\_cancel\_timeout Scan cancel timeout
[ 12.058762] ieee80211 phy0: il\_do\_scan\_abort Not performing scan to abort
[ 12.058765] ieee80211 phy0: il\_clear\_ucode\_stations Clearing ucode stations in driver
[ 12.058767] ieee80211 phy0: il\_clear\_ucode\_stations No active stations found to be cleared
[ 12.058819] ieee80211 phy0: \_il\_apm\_stop Stop card, put in low power state
[ 12.058827] ieee80211 phy0: \_il\_apm\_stop\_master stop master
[ 12.058864] ieee80211 phy0: il4965\_clear\_free\_frames 0 frames on pre-allocated heap on clear.
[ 12.058869] ieee80211 phy0: Hardware restart was requested
[ 16.132299] iwl4965 0000:10:00.0: START\_ALIVE timeout after 4000ms.
[ 16.132303] ------------[ cut here ]------------
[ 16.132304] Hardware became unavailable upon resume. This could be a software issue prior to suspend or a hardware issue.
[ 16.132338] WARNING: CPU: 0 PID: 181 at net/mac80211/util.c:1826 ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132390] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.132456] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Not tainted 6.11.0-cl+ #143
[ 16.132460] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.132463] Workqueue: async async\_run\_entry\_fn
[ 16.132469] RIP: 0010:ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132501] Code: da 02 00 00 c6 83 ad 05 00 00 00 48 89 df e8 98 1b fc ff 85 c0 41 89 c7 0f 84 e9 02 00 00 48 c7 c7 a0 e6 48 a0 e8 d1 77 c4 e0 <0f> 0b eb 2d 84 c0 0f 85 8b 01 00 00 c6 87 ad 05 00 00 00 e8 69 1b
[ 16.132504] RSP: 0018:ffffc9000029fcf0 EFLAGS: 00010282
[ 16.132507] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: 0000000000000001
[ 16.132509] RDX: ffffffff81f21a18 RSI: 0000000000000086 RDI: 0000000000000001
[ 16.132510] RBP: ffff8880072003c0 R08: 0000000000000000 R09: 0000000000000003
[ 16.132512] R10: 0000000000000000 R11: ffff88807e5b0000 R12: 0000000000000001
[ 16.132514] R13: 0000000000000000 R14: 0000000000000000 R15: 00000000ffffff92
[ 16.132515] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.132517] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.132519] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.132521] Call Trace:
[ 16.132525] <TASK>
[ 16.132526] ? \_\_warn+0x77/0x120
[ 16.132532] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132564] ? report\_bug+0x15c/0x190
[ 16.132568] ? handle\_bug+0x36/0x70
[ 16.132571] ? exc\_invalid\_op+0x13/0x60
[ 16.132573] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.132579] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132611] ? snd\_hdac\_bus\_init\_cmd\_io+0x24/0x200 [snd\_hda\_core]
[ 16.132617] ? pick\_eevdf+0x133/0x1c0
[ 16.132622] ? check\_preempt\_wakeup\_fair+0x70/0x90
[ 16.132626] ? wakeup\_preempt+0x4a/0x60
[ 16.132628] ? ttwu\_do\_activate.isra.0+0x5a/0x190
[ 16.132632] wiphy\_resume+0x79/0x1a0 [cfg80211]
[ 16.132675] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.132697] dpm\_run\_callback+0x75/0x1b0
[ 16.132703] device\_resume+0x97/0x200
[ 16.132707] async\_resume+0x14/0x20
[ 16.132711] async\_run\_entry\_fn+0x1b/0xa0
[ 16.132714] process\_one\_work+0x13d/0x350
[ 16.132718] worker\_thread+0x2be/0x3d0
[ 16.132722] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.132725] kthread+0xc0/0xf0
[ 16.132729] ? kthread\_park+0x80/0x80
[ 16.132732] ret\_from\_fork+0x28/0x40
[ 16.132735] ? kthread\_park+0x80/0x80
[ 16.132738] ret\_from\_fork\_asm+0x11/0x20
[ 16.132741] </TASK>
[ 16.132742] ---[ end trace 0000000000000000 ]---
[ 16.132930] ------------[ cut here ]------------
[ 16.132932] WARNING: CPU: 0 PID: 181 at net/mac80211/driver-ops.c:41 drv\_stop+0xe7/0xf0 [mac80211]
[ 16.132957] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.133014] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Tainted: G W 6.11.0-cl+ #143
[ 16.133018] Tainted: [W]=WARN
[ 16.133019] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.133021] Workqueue: async async\_run\_entry\_fn
[ 16.133025] RIP: 0010:drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133048] Code: 48 85 c0 74 0e 48 8b 78 08 89 ea 48 89 de e8 e0 87 04 00 65 ff 0d d1 de c4 5f 0f 85 42 ff ff ff e8 be 52 c2 e0 e9 38 ff ff ff <0f> 0b 5b 5d c3 0f 1f 40 00 41 54 49 89 fc 55 53 48 89 f3 2e 2e 2e
[ 16.133050] RSP: 0018:ffffc9000029fc50 EFLAGS: 00010246
[ 16.133053] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: ffff88800377f6c0
[ 16.133054] RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff8880072008e0
[ 16.133056] RBP: 0000000000000000 R08: ffffffff81f238d8 R09: 0000000000000000
[ 16.133058] R10: ffff8880080520f0 R11: 0000000000000000 R12: ffff888008051c60
[ 16.133060] R13: ffff8880072008e0 R14: 0000000000000000 R15: ffff8880072011d8
[ 16.133061] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.133063] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.133065] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.133067] Call Trace:
[ 16.133069] <TASK>
[ 16.133070] ? \_\_warn+0x77/0x120
[ 16.133075] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133098] ? report\_bug+0x15c/0x190
[ 16.133100] ? handle\_bug+0x36/0x70
[ 16.133103] ? exc\_invalid\_op+0x13/0x60
[ 16.133105] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.133109] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133132] ieee80211\_do\_stop+0x55a/0x810 [mac80211]
[ 16.133161] ? fq\_codel\_reset+0xa5/0xc0 [sch\_fq\_codel]
[ 16.133164] ieee80211\_stop+0x4f/0x180 [mac80211]
[ 16.133192] \_\_dev\_close\_many+0xa2/0x120
[ 16.133195] dev\_close\_many+0x90/0x150
[ 16.133198] dev\_close+0x5d/0x80
[ 16.133200] cfg80211\_shutdown\_all\_interfaces+0x40/0xe0 [cfg80211]
[ 16.133223] wiphy\_resume+0xb2/0x1a0 [cfg80211]
[ 16.133247] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.133269] dpm\_run\_callback+0x75/0x1b0
[ 16.133273] device\_resume+0x97/0x200
[ 16.133277] async\_resume+0x14/0x20
[ 16.133280] async\_run\_entry\_fn+0x1b/0xa0
[ 16.133283] process\_one\_work+0x13d/0x350
[ 16.133287] worker\_thread+0x2be/0x3d0
[ 16.133290] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.133294] kthread+0xc0/0xf0
[ 16.133296] ? kthread\_park+0x80/0x80
[ 16.133299] ret\_from\_fork+0x28/0x40
[ 16.133302] ? kthread\_park+0x80/0x80
[ 16.133304] ret\_from\_fork\_asm+0x11/0x20
[ 16.133307] </TASK>
[ 16.133308] ---[ end trace 0000000000000000 ]---
[ 16.133335] ieee80211 phy0: PM: dpm\_run\_callback(): wiphy\_resume [cfg80211] returns -110
[ 16.133360] ieee80211 phy0: PM: failed to restore async: error -110
Cc: stable@vger.kernel.org
Cc: Stanislaw Gruszka <stf\_xl@wp.pl>
Cc: Kalle Valo <kvalo@kernel.org>
Cc: linux-wireless@vger.kernel.org
Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Acked-by: Stanislaw Gruszka <stf\_xl@wp.pl>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241001200745.8276-1-ville.syrjala@linux.intel.com](https://patch.msgid.link/20241001200745.8276-1-ville.syrjala%40linux.intel.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlegacy/common.c?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlegacy/common.c b/drivers/net/wireless/intel/iwlegacy/common.cindex 83c1ff0d660f7d..8c6c153c455b3a 100644--- a/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=705be2dc45c7f852e211e16bc41a916fab741983)+++ b/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=8ac22fe1e2b104c37e4fecd97735f64bd6349ebc)@@ -4960,6 +4960,8 @@ il\_pci\_resume(struct device \*device) \*/ pci\_write\_config\_byte(pdev, PCI\_CFG\_RETRY\_TIMEOUT, 0x00); + \_il\_wr(il, CSR\_INT, 0xffffffff);+ \_il\_wr(il, CSR\_FH\_INT\_STATUS, 0xffffffff); il\_enable\_interrupts(il);  if (!(\_il\_rd(il, CSR\_GP\_CNTRL) & CSR\_GP\_CNTRL\_REG\_FLAG\_HW\_RF\_KILL\_SW)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:34:21 +0000



=== Content from git.kernel.org_d66d3064_20250114_213541.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ville Syrjälä <ville.syrjala@linux.intel.com> | 2024-10-01 23:07:45 +0300 |
| --- | --- | --- |
| committer | Kalle Valo <kvalo@kernel.org> | 2024-10-08 21:51:24 +0300 |
| commit | [07c90acb071b9954e1fecb1e4f4f13d12c544b34](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34)) | |
| tree | [192b1c70563063d8e9cca6b5c82f6dd33da1f88a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34) | |
| parent | [d4cdc46ca16a5c78b36c5b9b6ad8cac09d6130a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4cdc46ca16a5c78b36c5b9b6ad8cac09d6130a0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34&id2=d4cdc46ca16a5c78b36c5b9b6ad8cac09d6130a0)) | |
| download | [linux-07c90acb071b9954e1fecb1e4f4f13d12c544b34.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-07c90acb071b9954e1fecb1e4f4f13d12c544b34.tar.gz) | |

wifi: iwlegacy: Clear stale interrupts before resuming deviceiwl4965 fails upon resume from hibernation on my laptop. The reason
seems to be a stale interrupt which isn't being cleared out before
interrupts are enabled. We end up with a race beween the resume
trying to bring things back up, and the restart work (queued form
the interrupt handler) trying to bring things down. Eventually
the whole thing blows up.
Fix the problem by clearing out any stale interrupts before
interrupts get enabled during resume.
Here's a debug log of the indicent:
[ 12.042589] ieee80211 phy0: il\_isr ISR inta 0x00000080, enabled 0xaa00008b, fh 0x00000000
[ 12.042625] ieee80211 phy0: il4965\_irq\_tasklet inta 0x00000080, enabled 0x00000000, fh 0x00000000
[ 12.042651] iwl4965 0000:10:00.0: RF\_KILL bit toggled to enable radio.
[ 12.042653] iwl4965 0000:10:00.0: On demand firmware reload
[ 12.042690] ieee80211 phy0: il4965\_irq\_tasklet End inta 0x00000000, enabled 0xaa00008b, fh 0x00000000, flags 0x00000282
[ 12.052207] ieee80211 phy0: il4965\_mac\_start enter
[ 12.052212] ieee80211 phy0: il\_prep\_station Add STA to driver ID 31: ff:ff:ff:ff:ff:ff
[ 12.052244] ieee80211 phy0: il4965\_set\_hw\_ready hardware ready
[ 12.052324] ieee80211 phy0: il\_apm\_init Init card's basic functions
[ 12.052348] ieee80211 phy0: il\_apm\_init L1 Enabled; Disabling L0S
[ 12.055727] ieee80211 phy0: il4965\_load\_bsm Begin load bsm
[ 12.056140] ieee80211 phy0: il4965\_verify\_bsm Begin verify bsm
[ 12.058642] ieee80211 phy0: il4965\_verify\_bsm BSM bootstrap uCode image OK
[ 12.058721] ieee80211 phy0: il4965\_load\_bsm BSM write complete, poll 1 iterations
[ 12.058734] ieee80211 phy0: \_\_il4965\_up iwl4965 is coming up
[ 12.058737] ieee80211 phy0: il4965\_mac\_start Start UP work done.
[ 12.058757] ieee80211 phy0: \_\_il4965\_down iwl4965 is going down
[ 12.058761] ieee80211 phy0: il\_scan\_cancel\_timeout Scan cancel timeout
[ 12.058762] ieee80211 phy0: il\_do\_scan\_abort Not performing scan to abort
[ 12.058765] ieee80211 phy0: il\_clear\_ucode\_stations Clearing ucode stations in driver
[ 12.058767] ieee80211 phy0: il\_clear\_ucode\_stations No active stations found to be cleared
[ 12.058819] ieee80211 phy0: \_il\_apm\_stop Stop card, put in low power state
[ 12.058827] ieee80211 phy0: \_il\_apm\_stop\_master stop master
[ 12.058864] ieee80211 phy0: il4965\_clear\_free\_frames 0 frames on pre-allocated heap on clear.
[ 12.058869] ieee80211 phy0: Hardware restart was requested
[ 16.132299] iwl4965 0000:10:00.0: START\_ALIVE timeout after 4000ms.
[ 16.132303] ------------[ cut here ]------------
[ 16.132304] Hardware became unavailable upon resume. This could be a software issue prior to suspend or a hardware issue.
[ 16.132338] WARNING: CPU: 0 PID: 181 at net/mac80211/util.c:1826 ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132390] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.132456] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Not tainted 6.11.0-cl+ #143
[ 16.132460] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.132463] Workqueue: async async\_run\_entry\_fn
[ 16.132469] RIP: 0010:ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132501] Code: da 02 00 00 c6 83 ad 05 00 00 00 48 89 df e8 98 1b fc ff 85 c0 41 89 c7 0f 84 e9 02 00 00 48 c7 c7 a0 e6 48 a0 e8 d1 77 c4 e0 <0f> 0b eb 2d 84 c0 0f 85 8b 01 00 00 c6 87 ad 05 00 00 00 e8 69 1b
[ 16.132504] RSP: 0018:ffffc9000029fcf0 EFLAGS: 00010282
[ 16.132507] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: 0000000000000001
[ 16.132509] RDX: ffffffff81f21a18 RSI: 0000000000000086 RDI: 0000000000000001
[ 16.132510] RBP: ffff8880072003c0 R08: 0000000000000000 R09: 0000000000000003
[ 16.132512] R10: 0000000000000000 R11: ffff88807e5b0000 R12: 0000000000000001
[ 16.132514] R13: 0000000000000000 R14: 0000000000000000 R15: 00000000ffffff92
[ 16.132515] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.132517] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.132519] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.132521] Call Trace:
[ 16.132525] <TASK>
[ 16.132526] ? \_\_warn+0x77/0x120
[ 16.132532] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132564] ? report\_bug+0x15c/0x190
[ 16.132568] ? handle\_bug+0x36/0x70
[ 16.132571] ? exc\_invalid\_op+0x13/0x60
[ 16.132573] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.132579] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132611] ? snd\_hdac\_bus\_init\_cmd\_io+0x24/0x200 [snd\_hda\_core]
[ 16.132617] ? pick\_eevdf+0x133/0x1c0
[ 16.132622] ? check\_preempt\_wakeup\_fair+0x70/0x90
[ 16.132626] ? wakeup\_preempt+0x4a/0x60
[ 16.132628] ? ttwu\_do\_activate.isra.0+0x5a/0x190
[ 16.132632] wiphy\_resume+0x79/0x1a0 [cfg80211]
[ 16.132675] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.132697] dpm\_run\_callback+0x75/0x1b0
[ 16.132703] device\_resume+0x97/0x200
[ 16.132707] async\_resume+0x14/0x20
[ 16.132711] async\_run\_entry\_fn+0x1b/0xa0
[ 16.132714] process\_one\_work+0x13d/0x350
[ 16.132718] worker\_thread+0x2be/0x3d0
[ 16.132722] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.132725] kthread+0xc0/0xf0
[ 16.132729] ? kthread\_park+0x80/0x80
[ 16.132732] ret\_from\_fork+0x28/0x40
[ 16.132735] ? kthread\_park+0x80/0x80
[ 16.132738] ret\_from\_fork\_asm+0x11/0x20
[ 16.132741] </TASK>
[ 16.132742] ---[ end trace 0000000000000000 ]---
[ 16.132930] ------------[ cut here ]------------
[ 16.132932] WARNING: CPU: 0 PID: 181 at net/mac80211/driver-ops.c:41 drv\_stop+0xe7/0xf0 [mac80211]
[ 16.132957] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.133014] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Tainted: G W 6.11.0-cl+ #143
[ 16.133018] Tainted: [W]=WARN
[ 16.133019] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.133021] Workqueue: async async\_run\_entry\_fn
[ 16.133025] RIP: 0010:drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133048] Code: 48 85 c0 74 0e 48 8b 78 08 89 ea 48 89 de e8 e0 87 04 00 65 ff 0d d1 de c4 5f 0f 85 42 ff ff ff e8 be 52 c2 e0 e9 38 ff ff ff <0f> 0b 5b 5d c3 0f 1f 40 00 41 54 49 89 fc 55 53 48 89 f3 2e 2e 2e
[ 16.133050] RSP: 0018:ffffc9000029fc50 EFLAGS: 00010246
[ 16.133053] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: ffff88800377f6c0
[ 16.133054] RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff8880072008e0
[ 16.133056] RBP: 0000000000000000 R08: ffffffff81f238d8 R09: 0000000000000000
[ 16.133058] R10: ffff8880080520f0 R11: 0000000000000000 R12: ffff888008051c60
[ 16.133060] R13: ffff8880072008e0 R14: 0000000000000000 R15: ffff8880072011d8
[ 16.133061] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.133063] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.133065] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.133067] Call Trace:
[ 16.133069] <TASK>
[ 16.133070] ? \_\_warn+0x77/0x120
[ 16.133075] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133098] ? report\_bug+0x15c/0x190
[ 16.133100] ? handle\_bug+0x36/0x70
[ 16.133103] ? exc\_invalid\_op+0x13/0x60
[ 16.133105] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.133109] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133132] ieee80211\_do\_stop+0x55a/0x810 [mac80211]
[ 16.133161] ? fq\_codel\_reset+0xa5/0xc0 [sch\_fq\_codel]
[ 16.133164] ieee80211\_stop+0x4f/0x180 [mac80211]
[ 16.133192] \_\_dev\_close\_many+0xa2/0x120
[ 16.133195] dev\_close\_many+0x90/0x150
[ 16.133198] dev\_close+0x5d/0x80
[ 16.133200] cfg80211\_shutdown\_all\_interfaces+0x40/0xe0 [cfg80211]
[ 16.133223] wiphy\_resume+0xb2/0x1a0 [cfg80211]
[ 16.133247] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.133269] dpm\_run\_callback+0x75/0x1b0
[ 16.133273] device\_resume+0x97/0x200
[ 16.133277] async\_resume+0x14/0x20
[ 16.133280] async\_run\_entry\_fn+0x1b/0xa0
[ 16.133283] process\_one\_work+0x13d/0x350
[ 16.133287] worker\_thread+0x2be/0x3d0
[ 16.133290] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.133294] kthread+0xc0/0xf0
[ 16.133296] ? kthread\_park+0x80/0x80
[ 16.133299] ret\_from\_fork+0x28/0x40
[ 16.133302] ? kthread\_park+0x80/0x80
[ 16.133304] ret\_from\_fork\_asm+0x11/0x20
[ 16.133307] </TASK>
[ 16.133308] ---[ end trace 0000000000000000 ]---
[ 16.133335] ieee80211 phy0: PM: dpm\_run\_callback(): wiphy\_resume [cfg80211] returns -110
[ 16.133360] ieee80211 phy0: PM: failed to restore async: error -110
Cc: stable@vger.kernel.org
Cc: Stanislaw Gruszka <stf\_xl@wp.pl>
Cc: Kalle Valo <kvalo@kernel.org>
Cc: linux-wireless@vger.kernel.org
Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Acked-by: Stanislaw Gruszka <stf\_xl@wp.pl>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241001200745.8276-1-ville.syrjala@linux.intel.com](https://patch.msgid.link/20241001200745.8276-1-ville.syrjala%40linux.intel.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlegacy/common.c?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlegacy/common.c b/drivers/net/wireless/intel/iwlegacy/common.cindex 4616293ec0cf41..958dd4f9bc6920 100644--- a/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=d4cdc46ca16a5c78b36c5b9b6ad8cac09d6130a0)+++ b/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=07c90acb071b9954e1fecb1e4f4f13d12c544b34)@@ -4973,6 +4973,8 @@ il\_pci\_resume(struct device \*device) \*/ pci\_write\_config\_byte(pdev, PCI\_CFG\_RETRY\_TIMEOUT, 0x00); + \_il\_wr(il, CSR\_INT, 0xffffffff);+ \_il\_wr(il, CSR\_FH\_INT\_STATUS, 0xffffffff); il\_enable\_interrupts(il);  if (!(\_il\_rd(il, CSR\_GP\_CNTRL) & CSR\_GP\_CNTRL\_REG\_FLAG\_HW\_RF\_KILL\_SW)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:34:18 +0000



=== Content from git.kernel.org_e5be2f73_20250114_213543.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ville Syrjälä <ville.syrjala@linux.intel.com> | 2024-10-01 23:07:45 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:23 +0100 |
| commit | [271d282ecc15d7012e71ca82c89a6c0e13a063dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd)) | |
| tree | [b23d677377935c199b32b96fe149034c04a9b692](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd) | |
| parent | [eff818238bedb9c2484c251ec46f9f160911cdc0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eff818238bedb9c2484c251ec46f9f160911cdc0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd&id2=eff818238bedb9c2484c251ec46f9f160911cdc0)) | |
| download | [linux-271d282ecc15d7012e71ca82c89a6c0e13a063dd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-271d282ecc15d7012e71ca82c89a6c0e13a063dd.tar.gz) | |

wifi: iwlegacy: Clear stale interrupts before resuming devicecommit 07c90acb071b9954e1fecb1e4f4f13d12c544b34 upstream.
iwl4965 fails upon resume from hibernation on my laptop. The reason
seems to be a stale interrupt which isn't being cleared out before
interrupts are enabled. We end up with a race beween the resume
trying to bring things back up, and the restart work (queued form
the interrupt handler) trying to bring things down. Eventually
the whole thing blows up.
Fix the problem by clearing out any stale interrupts before
interrupts get enabled during resume.
Here's a debug log of the indicent:
[ 12.042589] ieee80211 phy0: il\_isr ISR inta 0x00000080, enabled 0xaa00008b, fh 0x00000000
[ 12.042625] ieee80211 phy0: il4965\_irq\_tasklet inta 0x00000080, enabled 0x00000000, fh 0x00000000
[ 12.042651] iwl4965 0000:10:00.0: RF\_KILL bit toggled to enable radio.
[ 12.042653] iwl4965 0000:10:00.0: On demand firmware reload
[ 12.042690] ieee80211 phy0: il4965\_irq\_tasklet End inta 0x00000000, enabled 0xaa00008b, fh 0x00000000, flags 0x00000282
[ 12.052207] ieee80211 phy0: il4965\_mac\_start enter
[ 12.052212] ieee80211 phy0: il\_prep\_station Add STA to driver ID 31: ff:ff:ff:ff:ff:ff
[ 12.052244] ieee80211 phy0: il4965\_set\_hw\_ready hardware ready
[ 12.052324] ieee80211 phy0: il\_apm\_init Init card's basic functions
[ 12.052348] ieee80211 phy0: il\_apm\_init L1 Enabled; Disabling L0S
[ 12.055727] ieee80211 phy0: il4965\_load\_bsm Begin load bsm
[ 12.056140] ieee80211 phy0: il4965\_verify\_bsm Begin verify bsm
[ 12.058642] ieee80211 phy0: il4965\_verify\_bsm BSM bootstrap uCode image OK
[ 12.058721] ieee80211 phy0: il4965\_load\_bsm BSM write complete, poll 1 iterations
[ 12.058734] ieee80211 phy0: \_\_il4965\_up iwl4965 is coming up
[ 12.058737] ieee80211 phy0: il4965\_mac\_start Start UP work done.
[ 12.058757] ieee80211 phy0: \_\_il4965\_down iwl4965 is going down
[ 12.058761] ieee80211 phy0: il\_scan\_cancel\_timeout Scan cancel timeout
[ 12.058762] ieee80211 phy0: il\_do\_scan\_abort Not performing scan to abort
[ 12.058765] ieee80211 phy0: il\_clear\_ucode\_stations Clearing ucode stations in driver
[ 12.058767] ieee80211 phy0: il\_clear\_ucode\_stations No active stations found to be cleared
[ 12.058819] ieee80211 phy0: \_il\_apm\_stop Stop card, put in low power state
[ 12.058827] ieee80211 phy0: \_il\_apm\_stop\_master stop master
[ 12.058864] ieee80211 phy0: il4965\_clear\_free\_frames 0 frames on pre-allocated heap on clear.
[ 12.058869] ieee80211 phy0: Hardware restart was requested
[ 16.132299] iwl4965 0000:10:00.0: START\_ALIVE timeout after 4000ms.
[ 16.132303] ------------[ cut here ]------------
[ 16.132304] Hardware became unavailable upon resume. This could be a software issue prior to suspend or a hardware issue.
[ 16.132338] WARNING: CPU: 0 PID: 181 at net/mac80211/util.c:1826 ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132390] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.132456] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Not tainted 6.11.0-cl+ #143
[ 16.132460] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.132463] Workqueue: async async\_run\_entry\_fn
[ 16.132469] RIP: 0010:ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132501] Code: da 02 00 00 c6 83 ad 05 00 00 00 48 89 df e8 98 1b fc ff 85 c0 41 89 c7 0f 84 e9 02 00 00 48 c7 c7 a0 e6 48 a0 e8 d1 77 c4 e0 <0f> 0b eb 2d 84 c0 0f 85 8b 01 00 00 c6 87 ad 05 00 00 00 e8 69 1b
[ 16.132504] RSP: 0018:ffffc9000029fcf0 EFLAGS: 00010282
[ 16.132507] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: 0000000000000001
[ 16.132509] RDX: ffffffff81f21a18 RSI: 0000000000000086 RDI: 0000000000000001
[ 16.132510] RBP: ffff8880072003c0 R08: 0000000000000000 R09: 0000000000000003
[ 16.132512] R10: 0000000000000000 R11: ffff88807e5b0000 R12: 0000000000000001
[ 16.132514] R13: 0000000000000000 R14: 0000000000000000 R15: 00000000ffffff92
[ 16.132515] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.132517] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.132519] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.132521] Call Trace:
[ 16.132525] <TASK>
[ 16.132526] ? \_\_warn+0x77/0x120
[ 16.132532] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132564] ? report\_bug+0x15c/0x190
[ 16.132568] ? handle\_bug+0x36/0x70
[ 16.132571] ? exc\_invalid\_op+0x13/0x60
[ 16.132573] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.132579] ? ieee80211\_reconfig+0x8f/0x14b0 [mac80211]
[ 16.132611] ? snd\_hdac\_bus\_init\_cmd\_io+0x24/0x200 [snd\_hda\_core]
[ 16.132617] ? pick\_eevdf+0x133/0x1c0
[ 16.132622] ? check\_preempt\_wakeup\_fair+0x70/0x90
[ 16.132626] ? wakeup\_preempt+0x4a/0x60
[ 16.132628] ? ttwu\_do\_activate.isra.0+0x5a/0x190
[ 16.132632] wiphy\_resume+0x79/0x1a0 [cfg80211]
[ 16.132675] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.132697] dpm\_run\_callback+0x75/0x1b0
[ 16.132703] device\_resume+0x97/0x200
[ 16.132707] async\_resume+0x14/0x20
[ 16.132711] async\_run\_entry\_fn+0x1b/0xa0
[ 16.132714] process\_one\_work+0x13d/0x350
[ 16.132718] worker\_thread+0x2be/0x3d0
[ 16.132722] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.132725] kthread+0xc0/0xf0
[ 16.132729] ? kthread\_park+0x80/0x80
[ 16.132732] ret\_from\_fork+0x28/0x40
[ 16.132735] ? kthread\_park+0x80/0x80
[ 16.132738] ret\_from\_fork\_asm+0x11/0x20
[ 16.132741] </TASK>
[ 16.132742] ---[ end trace 0000000000000000 ]---
[ 16.132930] ------------[ cut here ]------------
[ 16.132932] WARNING: CPU: 0 PID: 181 at net/mac80211/driver-ops.c:41 drv\_stop+0xe7/0xf0 [mac80211]
[ 16.132957] Modules linked in: ctr ccm sch\_fq\_codel xt\_tcpudp xt\_multiport xt\_state iptable\_filter iptable\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv4 ip\_tables x\_tables binfmt\_misc joydev mousedev btusb btrtl btintel btbcm bluetooth ecdh\_generic ecc iTCO\_wdt i2c\_dev iwl4965 iwlegacy coretemp snd\_hda\_codec\_analog pcspkr psmouse mac80211 snd\_hda\_codec\_generic libarc4 sdhci\_pci cqhci sha256\_generic sdhci libsha256 firewire\_ohci snd\_hda\_intel snd\_intel\_dspcfg mmc\_core snd\_hda\_codec snd\_hwdep firewire\_core led\_class iosf\_mbi snd\_hda\_core uhci\_hcd lpc\_ich crc\_itu\_t cfg80211 ehci\_pci ehci\_hcd snd\_pcm usbcore mfd\_core rfkill snd\_timer snd usb\_common soundcore video parport\_pc parport intel\_agp wmi intel\_gtt backlight e1000e agpgart evdev
[ 16.133014] CPU: 0 UID: 0 PID: 181 Comm: kworker/u8:6 Tainted: G W 6.11.0-cl+ #143
[ 16.133018] Tainted: [W]=WARN
[ 16.133019] Hardware name: Hewlett-Packard HP Compaq 6910p/30BE, BIOS 68MCU Ver. F.19 07/06/2010
[ 16.133021] Workqueue: async async\_run\_entry\_fn
[ 16.133025] RIP: 0010:drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133048] Code: 48 85 c0 74 0e 48 8b 78 08 89 ea 48 89 de e8 e0 87 04 00 65 ff 0d d1 de c4 5f 0f 85 42 ff ff ff e8 be 52 c2 e0 e9 38 ff ff ff <0f> 0b 5b 5d c3 0f 1f 40 00 41 54 49 89 fc 55 53 48 89 f3 2e 2e 2e
[ 16.133050] RSP: 0018:ffffc9000029fc50 EFLAGS: 00010246
[ 16.133053] RAX: 0000000000000000 RBX: ffff8880072008e0 RCX: ffff88800377f6c0
[ 16.133054] RDX: 0000000000000001 RSI: 0000000000000000 RDI: ffff8880072008e0
[ 16.133056] RBP: 0000000000000000 R08: ffffffff81f238d8 R09: 0000000000000000
[ 16.133058] R10: ffff8880080520f0 R11: 0000000000000000 R12: ffff888008051c60
[ 16.133060] R13: ffff8880072008e0 R14: 0000000000000000 R15: ffff8880072011d8
[ 16.133061] FS: 0000000000000000(0000) GS:ffff88807c200000(0000) knlGS:0000000000000000
[ 16.133063] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 16.133065] CR2: 000055dd43786c08 CR3: 000000000978f000 CR4: 00000000000006f0
[ 16.133067] Call Trace:
[ 16.133069] <TASK>
[ 16.133070] ? \_\_warn+0x77/0x120
[ 16.133075] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133098] ? report\_bug+0x15c/0x190
[ 16.133100] ? handle\_bug+0x36/0x70
[ 16.133103] ? exc\_invalid\_op+0x13/0x60
[ 16.133105] ? asm\_exc\_invalid\_op+0x16/0x20
[ 16.133109] ? drv\_stop+0xe7/0xf0 [mac80211]
[ 16.133132] ieee80211\_do\_stop+0x55a/0x810 [mac80211]
[ 16.133161] ? fq\_codel\_reset+0xa5/0xc0 [sch\_fq\_codel]
[ 16.133164] ieee80211\_stop+0x4f/0x180 [mac80211]
[ 16.133192] \_\_dev\_close\_many+0xa2/0x120
[ 16.133195] dev\_close\_many+0x90/0x150
[ 16.133198] dev\_close+0x5d/0x80
[ 16.133200] cfg80211\_shutdown\_all\_interfaces+0x40/0xe0 [cfg80211]
[ 16.133223] wiphy\_resume+0xb2/0x1a0 [cfg80211]
[ 16.133247] ? wiphy\_suspend+0x2a0/0x2a0 [cfg80211]
[ 16.133269] dpm\_run\_callback+0x75/0x1b0
[ 16.133273] device\_resume+0x97/0x200
[ 16.133277] async\_resume+0x14/0x20
[ 16.133280] async\_run\_entry\_fn+0x1b/0xa0
[ 16.133283] process\_one\_work+0x13d/0x350
[ 16.133287] worker\_thread+0x2be/0x3d0
[ 16.133290] ? cancel\_delayed\_work\_sync+0x70/0x70
[ 16.133294] kthread+0xc0/0xf0
[ 16.133296] ? kthread\_park+0x80/0x80
[ 16.133299] ret\_from\_fork+0x28/0x40
[ 16.133302] ? kthread\_park+0x80/0x80
[ 16.133304] ret\_from\_fork\_asm+0x11/0x20
[ 16.133307] </TASK>
[ 16.133308] ---[ end trace 0000000000000000 ]---
[ 16.133335] ieee80211 phy0: PM: dpm\_run\_callback(): wiphy\_resume [cfg80211] returns -110
[ 16.133360] ieee80211 phy0: PM: failed to restore async: error -110
Cc: stable@vger.kernel.org
Cc: Stanislaw Gruszka <stf\_xl@wp.pl>
Cc: Kalle Valo <kvalo@kernel.org>
Cc: linux-wireless@vger.kernel.org
Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Acked-by: Stanislaw Gruszka <stf\_xl@wp.pl>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://patch.msgid.link/20241001200745.8276-1-ville.syrjala@linux.intel.com](https://patch.msgid.link/20241001200745.8276-1-ville.syrjala%40linux.intel.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlegacy/common.c?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlegacy/common.c b/drivers/net/wireless/intel/iwlegacy/common.cindex c1c1cf330de7fd..de3988deb4d0da 100644--- a/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=eff818238bedb9c2484c251ec46f9f160911cdc0)+++ b/[drivers/net/wireless/intel/iwlegacy/common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlegacy/common.c?id=271d282ecc15d7012e71ca82c89a6c0e13a063dd)@@ -4986,6 +4986,8 @@ il\_pci\_resume(struct device \*device) \*/ pci\_write\_config\_byte(pdev, PCI\_CFG\_RETRY\_TIMEOUT, 0x00); + \_il\_wr(il, CSR\_INT, 0xffffffff);+ \_il\_wr(il, CSR\_FH\_INT\_STATUS, 0xffffffff); il\_enable\_interrupts(il);  if (!(\_il\_rd(il, CSR\_GP\_CNTRL) & CSR\_GP\_CNTRL\_REG\_FLAG\_HW\_RF\_KILL\_SW)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:34:20 +0000


