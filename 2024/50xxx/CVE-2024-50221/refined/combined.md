=== Content from git.kernel.org_c93b1584_20250114_213221.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tvrtko Ursulin <tvrtko.ursulin@igalia.com> | 2024-10-25 15:56:39 +0100 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2024-10-28 17:14:08 -0400 |
| commit | [4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8)) | |
| tree | [36c2dd635bed35d2a6dcae2cec07eb437f3596ad](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8) | |
| parent | [1b6063a57754eae5705753c01e78dc268b989038](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b6063a57754eae5705753c01e78dc268b989038) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8&id2=1b6063a57754eae5705753c01e78dc268b989038)) | |
| download | [linux-4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8.tar.gz) | |

drm/amd/pm: Vangogh: Fix kernel memory out of bounds writeKASAN reports that the GPU metrics table allocated in
vangogh\_tables\_init() is not large enough for the memset done in
smu\_cmn\_init\_soft\_gpu\_metrics(). Condensed report follows:
[ 33.861314] BUG: KASAN: slab-out-of-bounds in smu\_cmn\_init\_soft\_gpu\_metrics+0x73/0x200 [amdgpu]
[ 33.861799] Write of size 168 at addr ffff888129f59500 by task mangoapp/1067
...
[ 33.861808] CPU: 6 UID: 1000 PID: 1067 Comm: mangoapp Tainted: G W 6.12.0-rc4 #356 1a56f59a8b5182eeaf67eb7cb8b13594dd23b544
[ 33.861816] Tainted: [W]=WARN
[ 33.861818] Hardware name: Valve Galileo/Galileo, BIOS F7G0107 12/01/2023
[ 33.861822] Call Trace:
[ 33.861826] <TASK>
[ 33.861829] dump\_stack\_lvl+0x66/0x90
[ 33.861838] print\_report+0xce/0x620
[ 33.861853] kasan\_report+0xda/0x110
[ 33.862794] kasan\_check\_range+0xfd/0x1a0
[ 33.862799] \_\_asan\_memset+0x23/0x40
[ 33.862803] smu\_cmn\_init\_soft\_gpu\_metrics+0x73/0x200 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.863306] vangogh\_get\_gpu\_metrics\_v2\_4+0x123/0xad0 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.864257] vangogh\_common\_get\_gpu\_metrics+0xb0c/0xbc0 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.865682] amdgpu\_dpm\_get\_gpu\_metrics+0xcc/0x110 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.866160] amdgpu\_get\_gpu\_metrics+0x154/0x2d0 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.867135] dev\_attr\_show+0x43/0xc0
[ 33.867147] sysfs\_kf\_seq\_show+0x1f1/0x3b0
[ 33.867155] seq\_read\_iter+0x3f8/0x1140
[ 33.867173] vfs\_read+0x76c/0xc50
[ 33.867198] ksys\_read+0xfb/0x1d0
[ 33.867214] do\_syscall\_64+0x90/0x160
...
[ 33.867353] Allocated by task 378 on cpu 7 at 22.794876s:
[ 33.867358] kasan\_save\_stack+0x33/0x50
[ 33.867364] kasan\_save\_track+0x17/0x60
[ 33.867367] \_\_kasan\_kmalloc+0x87/0x90
[ 33.867371] vangogh\_init\_smc\_tables+0x3f9/0x840 [amdgpu]
[ 33.867835] smu\_sw\_init+0xa32/0x1850 [amdgpu]
[ 33.868299] amdgpu\_device\_init+0x467b/0x8d90 [amdgpu]
[ 33.868733] amdgpu\_driver\_load\_kms+0x19/0xf0 [amdgpu]
[ 33.869167] amdgpu\_pci\_probe+0x2d6/0xcd0 [amdgpu]
[ 33.869608] local\_pci\_probe+0xda/0x180
[ 33.869614] pci\_device\_probe+0x43f/0x6b0
Empirically we can confirm that the former allocates 152 bytes for the
table, while the latter memsets the 168 large block.
Root cause appears that when GPU metrics tables for v2\_4 parts were added
it was not considered to enlarge the table to fit.
The fix in this patch is rather "brute force" and perhaps later should be
done in a smarter way, by extracting and consolidating the part version to
size logic to a common helper, instead of brute forcing the largest
possible allocation. Nevertheless, for now this works and fixes the out of
bounds write.
v2:
\* Drop impossible v3\_0 case. (Mario)
Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@igalia.com>
Fixes: 41cec40bc9ba ("drm/amd/pm: Vangogh: Add new gpu\_metrics\_v2\_4 to acquire gpu\_metrics")
Cc: Mario Limonciello <mario.limonciello@amd.com>
Cc: Evan Quan <evan.quan@amd.com>
Cc: Wenyou Yang <WenYou.Yang@amd.com>
Cc: Alex Deucher <alexander.deucher@amd.com>
Reviewed-by: Mario Limonciello <mario.limonciello@amd.com>
Link: [https://lore.kernel.org/r/20241025145639.19124-1-tursulin@igalia.com](https://lore.kernel.org/r/20241025145639.19124-1-tursulin%40igalia.com)
Signed-off-by: Mario Limonciello <mario.limonciello@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 0880f58f9609f0200483a49429af0f050d281703)
Cc: stable@vger.kernel.org # v6.6+
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8)

| -rw-r--r-- | [drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh_ppt.c?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c b/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.cindex 22737b11b1bfb1..1fe020f1f4dbe2 100644--- a/[drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh_ppt.c?id=1b6063a57754eae5705753c01e78dc268b989038)+++ b/[drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh_ppt.c?id=4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8)@@ -242,7 +242,9 @@ static int vangogh\_tables\_init(struct smu\_context \*smu) goto err0\_out; smu\_table->metrics\_time = 0; - smu\_table->gpu\_metrics\_table\_size = max(sizeof(struct gpu\_metrics\_v2\_3), sizeof(struct gpu\_metrics\_v2\_2));+ smu\_table->gpu\_metrics\_table\_size = sizeof(struct gpu\_metrics\_v2\_2);+ smu\_table->gpu\_metrics\_table\_size = max(smu\_table->gpu\_metrics\_table\_size, sizeof(struct gpu\_metrics\_v2\_3));+ smu\_table->gpu\_metrics\_table\_size = max(smu\_table->gpu\_metrics\_table\_size, sizeof(struct gpu\_metrics\_v2\_4)); smu\_table->gpu\_metrics\_table = kzalloc(smu\_table->gpu\_metrics\_table\_size, GFP\_KERNEL); if (!smu\_table->gpu\_metrics\_table) goto err1\_out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:30:58 +0000



=== Content from git.kernel.org_85904ac9_20250114_213223.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tvrtko Ursulin <tvrtko.ursulin@igalia.com> | 2024-10-25 15:56:39 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:58 +0100 |
| commit | [f8fd9f0d57af4f8f48b383ec28287af85b47cb9f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f)) | |
| tree | [025d2bbdc15338fccbd62403c73056c7dfc77f8d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f) | |
| parent | [294984ce51c19c2af3d0d71e1c8bd589bc86b8e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=294984ce51c19c2af3d0d71e1c8bd589bc86b8e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f&id2=294984ce51c19c2af3d0d71e1c8bd589bc86b8e2)) | |
| download | [linux-f8fd9f0d57af4f8f48b383ec28287af85b47cb9f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f8fd9f0d57af4f8f48b383ec28287af85b47cb9f.tar.gz) | |

drm/amd/pm: Vangogh: Fix kernel memory out of bounds write[ Upstream commit 4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8 ]
KASAN reports that the GPU metrics table allocated in
vangogh\_tables\_init() is not large enough for the memset done in
smu\_cmn\_init\_soft\_gpu\_metrics(). Condensed report follows:
[ 33.861314] BUG: KASAN: slab-out-of-bounds in smu\_cmn\_init\_soft\_gpu\_metrics+0x73/0x200 [amdgpu]
[ 33.861799] Write of size 168 at addr ffff888129f59500 by task mangoapp/1067
...
[ 33.861808] CPU: 6 UID: 1000 PID: 1067 Comm: mangoapp Tainted: G W 6.12.0-rc4 #356 1a56f59a8b5182eeaf67eb7cb8b13594dd23b544
[ 33.861816] Tainted: [W]=WARN
[ 33.861818] Hardware name: Valve Galileo/Galileo, BIOS F7G0107 12/01/2023
[ 33.861822] Call Trace:
[ 33.861826] <TASK>
[ 33.861829] dump\_stack\_lvl+0x66/0x90
[ 33.861838] print\_report+0xce/0x620
[ 33.861853] kasan\_report+0xda/0x110
[ 33.862794] kasan\_check\_range+0xfd/0x1a0
[ 33.862799] \_\_asan\_memset+0x23/0x40
[ 33.862803] smu\_cmn\_init\_soft\_gpu\_metrics+0x73/0x200 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.863306] vangogh\_get\_gpu\_metrics\_v2\_4+0x123/0xad0 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.864257] vangogh\_common\_get\_gpu\_metrics+0xb0c/0xbc0 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.865682] amdgpu\_dpm\_get\_gpu\_metrics+0xcc/0x110 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.866160] amdgpu\_get\_gpu\_metrics+0x154/0x2d0 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.867135] dev\_attr\_show+0x43/0xc0
[ 33.867147] sysfs\_kf\_seq\_show+0x1f1/0x3b0
[ 33.867155] seq\_read\_iter+0x3f8/0x1140
[ 33.867173] vfs\_read+0x76c/0xc50
[ 33.867198] ksys\_read+0xfb/0x1d0
[ 33.867214] do\_syscall\_64+0x90/0x160
...
[ 33.867353] Allocated by task 378 on cpu 7 at 22.794876s:
[ 33.867358] kasan\_save\_stack+0x33/0x50
[ 33.867364] kasan\_save\_track+0x17/0x60
[ 33.867367] \_\_kasan\_kmalloc+0x87/0x90
[ 33.867371] vangogh\_init\_smc\_tables+0x3f9/0x840 [amdgpu]
[ 33.867835] smu\_sw\_init+0xa32/0x1850 [amdgpu]
[ 33.868299] amdgpu\_device\_init+0x467b/0x8d90 [amdgpu]
[ 33.868733] amdgpu\_driver\_load\_kms+0x19/0xf0 [amdgpu]
[ 33.869167] amdgpu\_pci\_probe+0x2d6/0xcd0 [amdgpu]
[ 33.869608] local\_pci\_probe+0xda/0x180
[ 33.869614] pci\_device\_probe+0x43f/0x6b0
Empirically we can confirm that the former allocates 152 bytes for the
table, while the latter memsets the 168 large block.
Root cause appears that when GPU metrics tables for v2\_4 parts were added
it was not considered to enlarge the table to fit.
The fix in this patch is rather "brute force" and perhaps later should be
done in a smarter way, by extracting and consolidating the part version to
size logic to a common helper, instead of brute forcing the largest
possible allocation. Nevertheless, for now this works and fixes the out of
bounds write.
v2:
\* Drop impossible v3\_0 case. (Mario)
Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@igalia.com>
Fixes: 41cec40bc9ba ("drm/amd/pm: Vangogh: Add new gpu\_metrics\_v2\_4 to acquire gpu\_metrics")
Cc: Mario Limonciello <mario.limonciello@amd.com>
Cc: Evan Quan <evan.quan@amd.com>
Cc: Wenyou Yang <WenYou.Yang@amd.com>
Cc: Alex Deucher <alexander.deucher@amd.com>
Reviewed-by: Mario Limonciello <mario.limonciello@amd.com>
Link: [https://lore.kernel.org/r/20241025145639.19124-1-tursulin@igalia.com](https://lore.kernel.org/r/20241025145639.19124-1-tursulin%40igalia.com)
Signed-off-by: Mario Limonciello <mario.limonciello@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 0880f58f9609f0200483a49429af0f050d281703)
Cc: stable@vger.kernel.org # v6.6+
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f)

| -rw-r--r-- | [drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh_ppt.c?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c b/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.cindex 22737b11b1bfb1..1fe020f1f4dbe2 100644--- a/[drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh_ppt.c?id=294984ce51c19c2af3d0d71e1c8bd589bc86b8e2)+++ b/[drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh_ppt.c?id=f8fd9f0d57af4f8f48b383ec28287af85b47cb9f)@@ -242,7 +242,9 @@ static int vangogh\_tables\_init(struct smu\_context \*smu) goto err0\_out; smu\_table->metrics\_time = 0; - smu\_table->gpu\_metrics\_table\_size = max(sizeof(struct gpu\_metrics\_v2\_3), sizeof(struct gpu\_metrics\_v2\_2));+ smu\_table->gpu\_metrics\_table\_size = sizeof(struct gpu\_metrics\_v2\_2);+ smu\_table->gpu\_metrics\_table\_size = max(smu\_table->gpu\_metrics\_table\_size, sizeof(struct gpu\_metrics\_v2\_3));+ smu\_table->gpu\_metrics\_table\_size = max(smu\_table->gpu\_metrics\_table\_size, sizeof(struct gpu\_metrics\_v2\_4)); smu\_table->gpu\_metrics\_table = kzalloc(smu\_table->gpu\_metrics\_table\_size, GFP\_KERNEL); if (!smu\_table->gpu\_metrics\_table) goto err1\_out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:31:00 +0000



=== Content from git.kernel.org_8bcc2b9c_20250114_213222.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tvrtko Ursulin <tvrtko.ursulin@igalia.com> | 2024-10-25 15:56:39 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:38:36 +0100 |
| commit | [f111de0f010308949254ee1cc45df8e6b8e1d7d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4)) | |
| tree | [509732a99c75b6f1db41fa1700790d06657c43bd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4) | |
| parent | [3bc4569a727d776819c2fd413098882798974aae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3bc4569a727d776819c2fd413098882798974aae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4&id2=3bc4569a727d776819c2fd413098882798974aae)) | |
| download | [linux-f111de0f010308949254ee1cc45df8e6b8e1d7d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f111de0f010308949254ee1cc45df8e6b8e1d7d4.tar.gz) | |

drm/amd/pm: Vangogh: Fix kernel memory out of bounds writecommit 4aa923a6e6406b43566ef6ac35a3d9a3197fa3e8 upstream.
KASAN reports that the GPU metrics table allocated in
vangogh\_tables\_init() is not large enough for the memset done in
smu\_cmn\_init\_soft\_gpu\_metrics(). Condensed report follows:
[ 33.861314] BUG: KASAN: slab-out-of-bounds in smu\_cmn\_init\_soft\_gpu\_metrics+0x73/0x200 [amdgpu]
[ 33.861799] Write of size 168 at addr ffff888129f59500 by task mangoapp/1067
...
[ 33.861808] CPU: 6 UID: 1000 PID: 1067 Comm: mangoapp Tainted: G W 6.12.0-rc4 #356 1a56f59a8b5182eeaf67eb7cb8b13594dd23b544
[ 33.861816] Tainted: [W]=WARN
[ 33.861818] Hardware name: Valve Galileo/Galileo, BIOS F7G0107 12/01/2023
[ 33.861822] Call Trace:
[ 33.861826] <TASK>
[ 33.861829] dump\_stack\_lvl+0x66/0x90
[ 33.861838] print\_report+0xce/0x620
[ 33.861853] kasan\_report+0xda/0x110
[ 33.862794] kasan\_check\_range+0xfd/0x1a0
[ 33.862799] \_\_asan\_memset+0x23/0x40
[ 33.862803] smu\_cmn\_init\_soft\_gpu\_metrics+0x73/0x200 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.863306] vangogh\_get\_gpu\_metrics\_v2\_4+0x123/0xad0 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.864257] vangogh\_common\_get\_gpu\_metrics+0xb0c/0xbc0 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.865682] amdgpu\_dpm\_get\_gpu\_metrics+0xcc/0x110 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.866160] amdgpu\_get\_gpu\_metrics+0x154/0x2d0 [amdgpu 13b1bc364ec578808f676eba412c20eaab792779]
[ 33.867135] dev\_attr\_show+0x43/0xc0
[ 33.867147] sysfs\_kf\_seq\_show+0x1f1/0x3b0
[ 33.867155] seq\_read\_iter+0x3f8/0x1140
[ 33.867173] vfs\_read+0x76c/0xc50
[ 33.867198] ksys\_read+0xfb/0x1d0
[ 33.867214] do\_syscall\_64+0x90/0x160
...
[ 33.867353] Allocated by task 378 on cpu 7 at 22.794876s:
[ 33.867358] kasan\_save\_stack+0x33/0x50
[ 33.867364] kasan\_save\_track+0x17/0x60
[ 33.867367] \_\_kasan\_kmalloc+0x87/0x90
[ 33.867371] vangogh\_init\_smc\_tables+0x3f9/0x840 [amdgpu]
[ 33.867835] smu\_sw\_init+0xa32/0x1850 [amdgpu]
[ 33.868299] amdgpu\_device\_init+0x467b/0x8d90 [amdgpu]
[ 33.868733] amdgpu\_driver\_load\_kms+0x19/0xf0 [amdgpu]
[ 33.869167] amdgpu\_pci\_probe+0x2d6/0xcd0 [amdgpu]
[ 33.869608] local\_pci\_probe+0xda/0x180
[ 33.869614] pci\_device\_probe+0x43f/0x6b0
Empirically we can confirm that the former allocates 152 bytes for the
table, while the latter memsets the 168 large block.
Root cause appears that when GPU metrics tables for v2\_4 parts were added
it was not considered to enlarge the table to fit.
The fix in this patch is rather "brute force" and perhaps later should be
done in a smarter way, by extracting and consolidating the part version to
size logic to a common helper, instead of brute forcing the largest
possible allocation. Nevertheless, for now this works and fixes the out of
bounds write.
v2:
\* Drop impossible v3\_0 case. (Mario)
Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@igalia.com>
Fixes: 41cec40bc9ba ("drm/amd/pm: Vangogh: Add new gpu\_metrics\_v2\_4 to acquire gpu\_metrics")
Cc: Mario Limonciello <mario.limonciello@amd.com>
Cc: Evan Quan <evan.quan@amd.com>
Cc: Wenyou Yang <WenYou.Yang@amd.com>
Cc: Alex Deucher <alexander.deucher@amd.com>
Reviewed-by: Mario Limonciello <mario.limonciello@amd.com>
Link: [https://lore.kernel.org/r/20241025145639.19124-1-tursulin@igalia.com](https://lore.kernel.org/r/20241025145639.19124-1-tursulin%40igalia.com)
Signed-off-by: Mario Limonciello <mario.limonciello@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 0880f58f9609f0200483a49429af0f050d281703)
Cc: stable@vger.kernel.org # v6.6+
Signed-off-by: Bin Lan <bin.lan.cn@windriver.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4)

| -rw-r--r-- | [drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh_ppt.c?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c b/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.cindex f46cda88948312..454216bd6f1dd2 100644--- a/[drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh_ppt.c?id=3bc4569a727d776819c2fd413098882798974aae)+++ b/[drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh\_ppt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/pm/swsmu/smu11/vangogh_ppt.c?id=f111de0f010308949254ee1cc45df8e6b8e1d7d4)@@ -256,10 +256,9 @@ static int vangogh\_tables\_init(struct smu\_context \*smu) goto err0\_out; smu\_table->metrics\_time = 0; - if (smu\_version >= 0x043F3E00)- smu\_table->gpu\_metrics\_table\_size = sizeof(struct gpu\_metrics\_v2\_3);- else- smu\_table->gpu\_metrics\_table\_size = sizeof(struct gpu\_metrics\_v2\_2);+ smu\_table->gpu\_metrics\_table\_size = sizeof(struct gpu\_metrics\_v2\_2);+ smu\_table->gpu\_metrics\_table\_size = max(smu\_table->gpu\_metrics\_table\_size, sizeof(struct gpu\_metrics\_v2\_3));+ smu\_table->gpu\_metrics\_table\_size = max(smu\_table->gpu\_metrics\_table\_size, sizeof(struct gpu\_metrics\_v2\_4)); smu\_table->gpu\_metrics\_table = kzalloc(smu\_table->gpu\_metrics\_table\_size, GFP\_KERNEL); if (!smu\_table->gpu\_metrics\_table) goto err1\_out; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:30:59 +0000


