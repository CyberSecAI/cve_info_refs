=== Content from git.kernel.org_75dd863a_20250114_194640.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-10-15 19:04:04 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:52:34 +0100 |
| commit | [e07d05b7f5ad9a503d9cab0afde2ab867bb65470](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470)) | |
| tree | [b857e1844eaf5626cbdf9ee4a7fb254b4c7176d2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470) | |
| parent | [39e02fa90323243187c91bb3e8f2f5f6a9aacfc7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39e02fa90323243187c91bb3e8f2f5f6a9aacfc7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470&id2=39e02fa90323243187c91bb3e8f2f5f6a9aacfc7)) | |
| download | [linux-e07d05b7f5ad9a503d9cab0afde2ab867bb65470.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e07d05b7f5ad9a503d9cab0afde2ab867bb65470.tar.gz) | |

smb: client: fix OOBs when building SMB2\_IOCTL request[ Upstream commit 1ab60323c5201bef25f2a3dc0ccc404d9aca77f1 ]
When using encryption, either enforced by the server or when using
'seal' mount option, the client will squash all compound request buffers
down for encryption into a single iov in smb2\_set\_next\_command().
SMB2\_ioctl\_init() allocates a small buffer (448 bytes) to hold the
SMB2\_IOCTL request in the first iov, and if the user passes an input
buffer that is greater than 328 bytes, smb2\_set\_next\_command() will
end up writing off the end of @rqst->iov[0].iov\_base as shown below:
mount.cifs //srv/share /mnt -o ...,seal
ln -s $(perl -e "print('a')for 1..1024") /mnt/link
BUG: KASAN: slab-out-of-bounds in
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
Write of size 4116 at addr ffff8881148fcab8 by task ln/859
CPU: 1 UID: 0 PID: 859 Comm: ln Not tainted 6.12.0-rc3 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS
1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
print\_report+0x156/0x4d9
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
? \_\_virt\_addr\_valid+0x145/0x310
? \_\_phys\_addr+0x46/0x90
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_report+0xda/0x110
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_check\_range+0x10f/0x1f0
\_\_asan\_memcpy+0x3c/0x60
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
smb2\_compound\_op+0x238c/0x3840 [cifs]
? kasan\_save\_track+0x14/0x30
? kasan\_save\_free\_info+0x3b/0x70
? vfs\_symlink+0x1a1/0x2c0
? do\_symlinkat+0x108/0x1c0
? \_\_pfx\_smb2\_compound\_op+0x10/0x10 [cifs]
? kmem\_cache\_free+0x118/0x3e0
? cifs\_get\_writable\_path+0xeb/0x1a0 [cifs]
smb2\_get\_reparse\_inode+0x423/0x540 [cifs]
? \_\_pfx\_smb2\_get\_reparse\_inode+0x10/0x10 [cifs]
? rcu\_is\_watching+0x20/0x50
? \_\_kmalloc\_noprof+0x37c/0x480
? smb2\_create\_reparse\_symlink+0x257/0x490 [cifs]
? smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
? \_\_pfx\_smb2\_create\_reparse\_symlink+0x10/0x10 [cifs]
? find\_held\_lock+0x8a/0xa0
? hlock\_class+0x32/0xb0
? \_\_build\_path\_from\_dentry\_optional\_prefix+0x19d/0x2e0 [cifs]
cifs\_symlink+0x24f/0x960 [cifs]
? \_\_pfx\_make\_vfsuid+0x10/0x10
? \_\_pfx\_cifs\_symlink+0x10/0x10 [cifs]
? make\_vfsgid+0x6b/0xc0
? generic\_permission+0x96/0x2d0
vfs\_symlink+0x1a1/0x2c0
do\_symlinkat+0x108/0x1c0
? \_\_pfx\_do\_symlinkat+0x10/0x10
? strncpy\_from\_user+0xaa/0x160
\_\_x64\_sys\_symlinkat+0xb9/0xf0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f08d75c13bb
Reported-by: David Howells <dhowells@redhat.com>
Fixes: e77fe73c7e38 ("cifs: we can not use small padding iovs together with encryption")
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470)

| -rw-r--r-- | [fs/cifs/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cifs/smb2pdu.c?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 0 deletions

| diff --git a/fs/cifs/smb2pdu.c b/fs/cifs/smb2pdu.cindex 61b18f802048ff..bd7aeb4dcacfc4 100644--- a/[fs/cifs/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2pdu.c?id=39e02fa90323243187c91bb3e8f2f5f6a9aacfc7)+++ b/[fs/cifs/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2pdu.c?id=e07d05b7f5ad9a503d9cab0afde2ab867bb65470)@@ -3028,6 +3028,15 @@ SMB2\_ioctl\_init(struct cifs\_tcon \*tcon, struct TCP\_Server\_Info \*server, return rc;  if (indatalen) {+ unsigned int len;++ if (WARN\_ON\_ONCE(smb3\_encryption\_required(tcon) &&+ (check\_add\_overflow(total\_len - 1,+ ALIGN(indatalen, 8), &len) ||+ len > MAX\_CIFS\_SMALL\_BUFFER\_SIZE))) {+ cifs\_small\_buf\_release(req);+ return -EIO;+ } /\* \* indatalen is usually small at a couple of bytes max, so \* just allocate through generic pool |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:45:16 +0000



=== Content from git.kernel.org_6ed2e20f_20250114_194636.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6f0516ef1290da24b85461ed08a0938af7415e49)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6f0516ef1290da24b85461ed08a0938af7415e49)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f0516ef1290da24b85461ed08a0938af7415e49)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f0516ef1290da24b85461ed08a0938af7415e49)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-10-15 19:04:04 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:50 +0100 |
| commit | [6f0516ef1290da24b85461ed08a0938af7415e49](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f0516ef1290da24b85461ed08a0938af7415e49) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6f0516ef1290da24b85461ed08a0938af7415e49)) | |
| tree | [58ed531e8f9dc14152dee3287abbf8f79c180325](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6f0516ef1290da24b85461ed08a0938af7415e49) | |
| parent | [0d2bd44bfe06885762bbe89d0555204acdd9b84a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d2bd44bfe06885762bbe89d0555204acdd9b84a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f0516ef1290da24b85461ed08a0938af7415e49&id2=0d2bd44bfe06885762bbe89d0555204acdd9b84a)) | |
| download | [linux-6f0516ef1290da24b85461ed08a0938af7415e49.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6f0516ef1290da24b85461ed08a0938af7415e49.tar.gz) | |

smb: client: fix OOBs when building SMB2\_IOCTL request[ Upstream commit 1ab60323c5201bef25f2a3dc0ccc404d9aca77f1 ]
When using encryption, either enforced by the server or when using
'seal' mount option, the client will squash all compound request buffers
down for encryption into a single iov in smb2\_set\_next\_command().
SMB2\_ioctl\_init() allocates a small buffer (448 bytes) to hold the
SMB2\_IOCTL request in the first iov, and if the user passes an input
buffer that is greater than 328 bytes, smb2\_set\_next\_command() will
end up writing off the end of @rqst->iov[0].iov\_base as shown below:
mount.cifs //srv/share /mnt -o ...,seal
ln -s $(perl -e "print('a')for 1..1024") /mnt/link
BUG: KASAN: slab-out-of-bounds in
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
Write of size 4116 at addr ffff8881148fcab8 by task ln/859
CPU: 1 UID: 0 PID: 859 Comm: ln Not tainted 6.12.0-rc3 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS
1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
print\_report+0x156/0x4d9
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
? \_\_virt\_addr\_valid+0x145/0x310
? \_\_phys\_addr+0x46/0x90
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_report+0xda/0x110
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_check\_range+0x10f/0x1f0
\_\_asan\_memcpy+0x3c/0x60
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
smb2\_compound\_op+0x238c/0x3840 [cifs]
? kasan\_save\_track+0x14/0x30
? kasan\_save\_free\_info+0x3b/0x70
? vfs\_symlink+0x1a1/0x2c0
? do\_symlinkat+0x108/0x1c0
? \_\_pfx\_smb2\_compound\_op+0x10/0x10 [cifs]
? kmem\_cache\_free+0x118/0x3e0
? cifs\_get\_writable\_path+0xeb/0x1a0 [cifs]
smb2\_get\_reparse\_inode+0x423/0x540 [cifs]
? \_\_pfx\_smb2\_get\_reparse\_inode+0x10/0x10 [cifs]
? rcu\_is\_watching+0x20/0x50
? \_\_kmalloc\_noprof+0x37c/0x480
? smb2\_create\_reparse\_symlink+0x257/0x490 [cifs]
? smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
? \_\_pfx\_smb2\_create\_reparse\_symlink+0x10/0x10 [cifs]
? find\_held\_lock+0x8a/0xa0
? hlock\_class+0x32/0xb0
? \_\_build\_path\_from\_dentry\_optional\_prefix+0x19d/0x2e0 [cifs]
cifs\_symlink+0x24f/0x960 [cifs]
? \_\_pfx\_make\_vfsuid+0x10/0x10
? \_\_pfx\_cifs\_symlink+0x10/0x10 [cifs]
? make\_vfsgid+0x6b/0xc0
? generic\_permission+0x96/0x2d0
vfs\_symlink+0x1a1/0x2c0
do\_symlinkat+0x108/0x1c0
? \_\_pfx\_do\_symlinkat+0x10/0x10
? strncpy\_from\_user+0xaa/0x160
\_\_x64\_sys\_symlinkat+0xb9/0xf0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f08d75c13bb
Reported-by: David Howells <dhowells@redhat.com>
Fixes: e77fe73c7e38 ("cifs: we can not use small padding iovs together with encryption")
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f0516ef1290da24b85461ed08a0938af7415e49)

| -rw-r--r-- | [fs/cifs/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cifs/smb2pdu.c?id=6f0516ef1290da24b85461ed08a0938af7415e49) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 0 deletions

| diff --git a/fs/cifs/smb2pdu.c b/fs/cifs/smb2pdu.cindex 667528132b692c..cc5555636ed072 100644--- a/[fs/cifs/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2pdu.c?id=0d2bd44bfe06885762bbe89d0555204acdd9b84a)+++ b/[fs/cifs/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2pdu.c?id=6f0516ef1290da24b85461ed08a0938af7415e49)@@ -2730,6 +2730,15 @@ SMB2\_ioctl\_init(struct cifs\_tcon \*tcon, struct smb\_rqst \*rqst, return rc;  if (indatalen) {+ unsigned int len;++ if (WARN\_ON\_ONCE(smb3\_encryption\_required(tcon) &&+ (check\_add\_overflow(total\_len - 1,+ ALIGN(indatalen, 8), &len) ||+ len > MAX\_CIFS\_SMALL\_BUFFER\_SIZE))) {+ cifs\_small\_buf\_release(req);+ return -EIO;+ } /\* \* indatalen is usually small at a couple of bytes max, so \* just allocate through generic pool |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:45:13 +0000



=== Content from git.kernel.org_87999775_20250114_194641.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-10-15 19:04:04 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:30 +0100 |
| commit | [fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec)) | |
| tree | [8f6440be8ba7cf1d037fd82c76f5485415f30b54](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec) | |
| parent | [c9f758ecf2562dfdd4adf12c22921b5de8366123](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9f758ecf2562dfdd4adf12c22921b5de8366123) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec&id2=c9f758ecf2562dfdd4adf12c22921b5de8366123)) | |
| download | [linux-fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec.tar.gz) | |

smb: client: fix OOBs when building SMB2\_IOCTL request[ Upstream commit 1ab60323c5201bef25f2a3dc0ccc404d9aca77f1 ]
When using encryption, either enforced by the server or when using
'seal' mount option, the client will squash all compound request buffers
down for encryption into a single iov in smb2\_set\_next\_command().
SMB2\_ioctl\_init() allocates a small buffer (448 bytes) to hold the
SMB2\_IOCTL request in the first iov, and if the user passes an input
buffer that is greater than 328 bytes, smb2\_set\_next\_command() will
end up writing off the end of @rqst->iov[0].iov\_base as shown below:
mount.cifs //srv/share /mnt -o ...,seal
ln -s $(perl -e "print('a')for 1..1024") /mnt/link
BUG: KASAN: slab-out-of-bounds in
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
Write of size 4116 at addr ffff8881148fcab8 by task ln/859
CPU: 1 UID: 0 PID: 859 Comm: ln Not tainted 6.12.0-rc3 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS
1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
print\_report+0x156/0x4d9
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
? \_\_virt\_addr\_valid+0x145/0x310
? \_\_phys\_addr+0x46/0x90
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_report+0xda/0x110
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_check\_range+0x10f/0x1f0
\_\_asan\_memcpy+0x3c/0x60
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
smb2\_compound\_op+0x238c/0x3840 [cifs]
? kasan\_save\_track+0x14/0x30
? kasan\_save\_free\_info+0x3b/0x70
? vfs\_symlink+0x1a1/0x2c0
? do\_symlinkat+0x108/0x1c0
? \_\_pfx\_smb2\_compound\_op+0x10/0x10 [cifs]
? kmem\_cache\_free+0x118/0x3e0
? cifs\_get\_writable\_path+0xeb/0x1a0 [cifs]
smb2\_get\_reparse\_inode+0x423/0x540 [cifs]
? \_\_pfx\_smb2\_get\_reparse\_inode+0x10/0x10 [cifs]
? rcu\_is\_watching+0x20/0x50
? \_\_kmalloc\_noprof+0x37c/0x480
? smb2\_create\_reparse\_symlink+0x257/0x490 [cifs]
? smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
? \_\_pfx\_smb2\_create\_reparse\_symlink+0x10/0x10 [cifs]
? find\_held\_lock+0x8a/0xa0
? hlock\_class+0x32/0xb0
? \_\_build\_path\_from\_dentry\_optional\_prefix+0x19d/0x2e0 [cifs]
cifs\_symlink+0x24f/0x960 [cifs]
? \_\_pfx\_make\_vfsuid+0x10/0x10
? \_\_pfx\_cifs\_symlink+0x10/0x10 [cifs]
? make\_vfsgid+0x6b/0xc0
? generic\_permission+0x96/0x2d0
vfs\_symlink+0x1a1/0x2c0
do\_symlinkat+0x108/0x1c0
? \_\_pfx\_do\_symlinkat+0x10/0x10
? strncpy\_from\_user+0xaa/0x160
\_\_x64\_sys\_symlinkat+0xb9/0xf0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f08d75c13bb
Reported-by: David Howells <dhowells@redhat.com>
Fixes: e77fe73c7e38 ("cifs: we can not use small padding iovs together with encryption")
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec)

| -rw-r--r-- | [fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2pdu.c?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 0 deletions

| diff --git a/fs/smb/client/smb2pdu.c b/fs/smb/client/smb2pdu.cindex 3d9e6e15dd900a..194a4262d57a09 100644--- a/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=c9f758ecf2562dfdd4adf12c22921b5de8366123)+++ b/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=fe92ddc1c32d4474e605e3a31a4afcd0e7d765ec)@@ -3308,6 +3308,15 @@ SMB2\_ioctl\_init(struct cifs\_tcon \*tcon, struct TCP\_Server\_Info \*server, return rc;  if (indatalen) {+ unsigned int len;++ if (WARN\_ON\_ONCE(smb3\_encryption\_required(tcon) &&+ (check\_add\_overflow(total\_len - 1,+ ALIGN(indatalen, 8), &len) ||+ len > MAX\_CIFS\_SMALL\_BUFFER\_SIZE))) {+ cifs\_small\_buf\_release(req);+ return -EIO;+ } /\* \* indatalen is usually small at a couple of bytes max, so \* just allocate through generic pool |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:45:18 +0000



=== Content from git.kernel.org_e2ab6e3d_20250114_194640.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-10-15 19:04:04 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:21:58 +0100 |
| commit | [ed31aba8ce93472d9e16f5cff844ae7c94e9601d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d)) | |
| tree | [b2fc200fc0dec3d787dfb933dda89aaf84bfdba2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d) | |
| parent | [8c1e6717f60d31f8af3937c23c4f1498529584e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c1e6717f60d31f8af3937c23c4f1498529584e1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d&id2=8c1e6717f60d31f8af3937c23c4f1498529584e1)) | |
| download | [linux-ed31aba8ce93472d9e16f5cff844ae7c94e9601d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ed31aba8ce93472d9e16f5cff844ae7c94e9601d.tar.gz) | |

smb: client: fix OOBs when building SMB2\_IOCTL request[ Upstream commit 1ab60323c5201bef25f2a3dc0ccc404d9aca77f1 ]
When using encryption, either enforced by the server or when using
'seal' mount option, the client will squash all compound request buffers
down for encryption into a single iov in smb2\_set\_next\_command().
SMB2\_ioctl\_init() allocates a small buffer (448 bytes) to hold the
SMB2\_IOCTL request in the first iov, and if the user passes an input
buffer that is greater than 328 bytes, smb2\_set\_next\_command() will
end up writing off the end of @rqst->iov[0].iov\_base as shown below:
mount.cifs //srv/share /mnt -o ...,seal
ln -s $(perl -e "print('a')for 1..1024") /mnt/link
BUG: KASAN: slab-out-of-bounds in
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
Write of size 4116 at addr ffff8881148fcab8 by task ln/859
CPU: 1 UID: 0 PID: 859 Comm: ln Not tainted 6.12.0-rc3 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS
1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
print\_report+0x156/0x4d9
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
? \_\_virt\_addr\_valid+0x145/0x310
? \_\_phys\_addr+0x46/0x90
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_report+0xda/0x110
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_check\_range+0x10f/0x1f0
\_\_asan\_memcpy+0x3c/0x60
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
smb2\_compound\_op+0x238c/0x3840 [cifs]
? kasan\_save\_track+0x14/0x30
? kasan\_save\_free\_info+0x3b/0x70
? vfs\_symlink+0x1a1/0x2c0
? do\_symlinkat+0x108/0x1c0
? \_\_pfx\_smb2\_compound\_op+0x10/0x10 [cifs]
? kmem\_cache\_free+0x118/0x3e0
? cifs\_get\_writable\_path+0xeb/0x1a0 [cifs]
smb2\_get\_reparse\_inode+0x423/0x540 [cifs]
? \_\_pfx\_smb2\_get\_reparse\_inode+0x10/0x10 [cifs]
? rcu\_is\_watching+0x20/0x50
? \_\_kmalloc\_noprof+0x37c/0x480
? smb2\_create\_reparse\_symlink+0x257/0x490 [cifs]
? smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
? \_\_pfx\_smb2\_create\_reparse\_symlink+0x10/0x10 [cifs]
? find\_held\_lock+0x8a/0xa0
? hlock\_class+0x32/0xb0
? \_\_build\_path\_from\_dentry\_optional\_prefix+0x19d/0x2e0 [cifs]
cifs\_symlink+0x24f/0x960 [cifs]
? \_\_pfx\_make\_vfsuid+0x10/0x10
? \_\_pfx\_cifs\_symlink+0x10/0x10 [cifs]
? make\_vfsgid+0x6b/0xc0
? generic\_permission+0x96/0x2d0
vfs\_symlink+0x1a1/0x2c0
do\_symlinkat+0x108/0x1c0
? \_\_pfx\_do\_symlinkat+0x10/0x10
? strncpy\_from\_user+0xaa/0x160
\_\_x64\_sys\_symlinkat+0xb9/0xf0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f08d75c13bb
Reported-by: David Howells <dhowells@redhat.com>
Fixes: e77fe73c7e38 ("cifs: we can not use small padding iovs together with encryption")
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d)

| -rw-r--r-- | [fs/cifs/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cifs/smb2pdu.c?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 0 deletions

| diff --git a/fs/cifs/smb2pdu.c b/fs/cifs/smb2pdu.cindex aa3211d8cce3bd..03651cc6b7a5b6 100644--- a/[fs/cifs/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2pdu.c?id=8c1e6717f60d31f8af3937c23c4f1498529584e1)+++ b/[fs/cifs/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/smb2pdu.c?id=ed31aba8ce93472d9e16f5cff844ae7c94e9601d)@@ -2961,6 +2961,15 @@ SMB2\_ioctl\_init(struct cifs\_tcon \*tcon, struct TCP\_Server\_Info \*server, return rc;  if (indatalen) {+ unsigned int len;++ if (WARN\_ON\_ONCE(smb3\_encryption\_required(tcon) &&+ (check\_add\_overflow(total\_len - 1,+ ALIGN(indatalen, 8), &len) ||+ len > MAX\_CIFS\_SMALL\_BUFFER\_SIZE))) {+ cifs\_small\_buf\_release(req);+ return -EIO;+ } /\* \* indatalen is usually small at a couple of bytes max, so \* just allocate through generic pool |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:45:17 +0000



=== Content from git.kernel.org_b70763bb_20250114_194638.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-10-15 19:04:04 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:24 +0100 |
| commit | [b209c3a0bc3ac172265c7fa8309e5d00654f2510](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510)) | |
| tree | [c8427e79f7024b65cc6f536ff34cb33d5e925f7d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510) | |
| parent | [b1813c220b76f60b1727984794377c4aa849d4c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1813c220b76f60b1727984794377c4aa849d4c1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510&id2=b1813c220b76f60b1727984794377c4aa849d4c1)) | |
| download | [linux-b209c3a0bc3ac172265c7fa8309e5d00654f2510.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b209c3a0bc3ac172265c7fa8309e5d00654f2510.tar.gz) | |

smb: client: fix OOBs when building SMB2\_IOCTL request[ Upstream commit 1ab60323c5201bef25f2a3dc0ccc404d9aca77f1 ]
When using encryption, either enforced by the server or when using
'seal' mount option, the client will squash all compound request buffers
down for encryption into a single iov in smb2\_set\_next\_command().
SMB2\_ioctl\_init() allocates a small buffer (448 bytes) to hold the
SMB2\_IOCTL request in the first iov, and if the user passes an input
buffer that is greater than 328 bytes, smb2\_set\_next\_command() will
end up writing off the end of @rqst->iov[0].iov\_base as shown below:
mount.cifs //srv/share /mnt -o ...,seal
ln -s $(perl -e "print('a')for 1..1024") /mnt/link
BUG: KASAN: slab-out-of-bounds in
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
Write of size 4116 at addr ffff8881148fcab8 by task ln/859
CPU: 1 UID: 0 PID: 859 Comm: ln Not tainted 6.12.0-rc3 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS
1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
print\_report+0x156/0x4d9
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
? \_\_virt\_addr\_valid+0x145/0x310
? \_\_phys\_addr+0x46/0x90
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_report+0xda/0x110
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_check\_range+0x10f/0x1f0
\_\_asan\_memcpy+0x3c/0x60
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
smb2\_compound\_op+0x238c/0x3840 [cifs]
? kasan\_save\_track+0x14/0x30
? kasan\_save\_free\_info+0x3b/0x70
? vfs\_symlink+0x1a1/0x2c0
? do\_symlinkat+0x108/0x1c0
? \_\_pfx\_smb2\_compound\_op+0x10/0x10 [cifs]
? kmem\_cache\_free+0x118/0x3e0
? cifs\_get\_writable\_path+0xeb/0x1a0 [cifs]
smb2\_get\_reparse\_inode+0x423/0x540 [cifs]
? \_\_pfx\_smb2\_get\_reparse\_inode+0x10/0x10 [cifs]
? rcu\_is\_watching+0x20/0x50
? \_\_kmalloc\_noprof+0x37c/0x480
? smb2\_create\_reparse\_symlink+0x257/0x490 [cifs]
? smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
? \_\_pfx\_smb2\_create\_reparse\_symlink+0x10/0x10 [cifs]
? find\_held\_lock+0x8a/0xa0
? hlock\_class+0x32/0xb0
? \_\_build\_path\_from\_dentry\_optional\_prefix+0x19d/0x2e0 [cifs]
cifs\_symlink+0x24f/0x960 [cifs]
? \_\_pfx\_make\_vfsuid+0x10/0x10
? \_\_pfx\_cifs\_symlink+0x10/0x10 [cifs]
? make\_vfsgid+0x6b/0xc0
? generic\_permission+0x96/0x2d0
vfs\_symlink+0x1a1/0x2c0
do\_symlinkat+0x108/0x1c0
? \_\_pfx\_do\_symlinkat+0x10/0x10
? strncpy\_from\_user+0xaa/0x160
\_\_x64\_sys\_symlinkat+0xb9/0xf0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f08d75c13bb
Reported-by: David Howells <dhowells@redhat.com>
Fixes: e77fe73c7e38 ("cifs: we can not use small padding iovs together with encryption")
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510)

| -rw-r--r-- | [fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2pdu.c?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 0 deletions

| diff --git a/fs/smb/client/smb2pdu.c b/fs/smb/client/smb2pdu.cindex 83a03201bb8628..a86a3fbfb5a49c 100644--- a/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=b1813c220b76f60b1727984794377c4aa849d4c1)+++ b/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=b209c3a0bc3ac172265c7fa8309e5d00654f2510)@@ -3300,6 +3300,15 @@ SMB2\_ioctl\_init(struct cifs\_tcon \*tcon, struct TCP\_Server\_Info \*server, return rc;  if (indatalen) {+ unsigned int len;++ if (WARN\_ON\_ONCE(smb3\_encryption\_required(tcon) &&+ (check\_add\_overflow(total\_len - 1,+ ALIGN(indatalen, 8), &len) ||+ len > MAX\_CIFS\_SMALL\_BUFFER\_SIZE))) {+ cifs\_small\_buf\_release(req);+ return -EIO;+ } /\* \* indatalen is usually small at a couple of bytes max, so \* just allocate through generic pool |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:45:14 +0000



=== Content from git.kernel.org_8c5f80d5_20250114_194635.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2ef632bfb888d1a14f81c1703817951e0bec5531)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ef632bfb888d1a14f81c1703817951e0bec5531)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ef632bfb888d1a14f81c1703817951e0bec5531)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ef632bfb888d1a14f81c1703817951e0bec5531)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paulo Alcantara <pc@manguebit.com> | 2024-10-15 19:04:04 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:56:00 +0100 |
| commit | [2ef632bfb888d1a14f81c1703817951e0bec5531](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ef632bfb888d1a14f81c1703817951e0bec5531) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2ef632bfb888d1a14f81c1703817951e0bec5531)) | |
| tree | [3dcb12df20a6085d6b6ac51ed70e32ea7e9f2ebb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ef632bfb888d1a14f81c1703817951e0bec5531) | |
| parent | [895ab729425ef9bf3b6d2f8d0853abe64896f314](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=895ab729425ef9bf3b6d2f8d0853abe64896f314) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ef632bfb888d1a14f81c1703817951e0bec5531&id2=895ab729425ef9bf3b6d2f8d0853abe64896f314)) | |
| download | [linux-2ef632bfb888d1a14f81c1703817951e0bec5531.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2ef632bfb888d1a14f81c1703817951e0bec5531.tar.gz) | |

smb: client: fix OOBs when building SMB2\_IOCTL request[ Upstream commit 1ab60323c5201bef25f2a3dc0ccc404d9aca77f1 ]
When using encryption, either enforced by the server or when using
'seal' mount option, the client will squash all compound request buffers
down for encryption into a single iov in smb2\_set\_next\_command().
SMB2\_ioctl\_init() allocates a small buffer (448 bytes) to hold the
SMB2\_IOCTL request in the first iov, and if the user passes an input
buffer that is greater than 328 bytes, smb2\_set\_next\_command() will
end up writing off the end of @rqst->iov[0].iov\_base as shown below:
mount.cifs //srv/share /mnt -o ...,seal
ln -s $(perl -e "print('a')for 1..1024") /mnt/link
BUG: KASAN: slab-out-of-bounds in
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
Write of size 4116 at addr ffff8881148fcab8 by task ln/859
CPU: 1 UID: 0 PID: 859 Comm: ln Not tainted 6.12.0-rc3 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS
1.16.3-2.fc40 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x5d/0x80
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
print\_report+0x156/0x4d9
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
? \_\_virt\_addr\_valid+0x145/0x310
? \_\_phys\_addr+0x46/0x90
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_report+0xda/0x110
? smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
kasan\_check\_range+0x10f/0x1f0
\_\_asan\_memcpy+0x3c/0x60
smb2\_set\_next\_command.cold+0x1d6/0x24c [cifs]
smb2\_compound\_op+0x238c/0x3840 [cifs]
? kasan\_save\_track+0x14/0x30
? kasan\_save\_free\_info+0x3b/0x70
? vfs\_symlink+0x1a1/0x2c0
? do\_symlinkat+0x108/0x1c0
? \_\_pfx\_smb2\_compound\_op+0x10/0x10 [cifs]
? kmem\_cache\_free+0x118/0x3e0
? cifs\_get\_writable\_path+0xeb/0x1a0 [cifs]
smb2\_get\_reparse\_inode+0x423/0x540 [cifs]
? \_\_pfx\_smb2\_get\_reparse\_inode+0x10/0x10 [cifs]
? rcu\_is\_watching+0x20/0x50
? \_\_kmalloc\_noprof+0x37c/0x480
? smb2\_create\_reparse\_symlink+0x257/0x490 [cifs]
? smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
smb2\_create\_reparse\_symlink+0x38f/0x490 [cifs]
? \_\_pfx\_smb2\_create\_reparse\_symlink+0x10/0x10 [cifs]
? find\_held\_lock+0x8a/0xa0
? hlock\_class+0x32/0xb0
? \_\_build\_path\_from\_dentry\_optional\_prefix+0x19d/0x2e0 [cifs]
cifs\_symlink+0x24f/0x960 [cifs]
? \_\_pfx\_make\_vfsuid+0x10/0x10
? \_\_pfx\_cifs\_symlink+0x10/0x10 [cifs]
? make\_vfsgid+0x6b/0xc0
? generic\_permission+0x96/0x2d0
vfs\_symlink+0x1a1/0x2c0
do\_symlinkat+0x108/0x1c0
? \_\_pfx\_do\_symlinkat+0x10/0x10
? strncpy\_from\_user+0xaa/0x160
\_\_x64\_sys\_symlinkat+0xb9/0xf0
do\_syscall\_64+0xbb/0x1d0
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f08d75c13bb
Reported-by: David Howells <dhowells@redhat.com>
Fixes: e77fe73c7e38 ("cifs: we can not use small padding iovs together with encryption")
Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ef632bfb888d1a14f81c1703817951e0bec5531)

| -rw-r--r-- | [fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/smb2pdu.c?id=2ef632bfb888d1a14f81c1703817951e0bec5531) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 0 deletions

| diff --git a/fs/smb/client/smb2pdu.c b/fs/smb/client/smb2pdu.cindex 992ac7d20e5ebd..9975711236b26c 100644--- a/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=895ab729425ef9bf3b6d2f8d0853abe64896f314)+++ b/[fs/smb/client/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/smb2pdu.c?id=2ef632bfb888d1a14f81c1703817951e0bec5531)@@ -3131,6 +3131,15 @@ SMB2\_ioctl\_init(struct cifs\_tcon \*tcon, struct TCP\_Server\_Info \*server, return rc;  if (indatalen) {+ unsigned int len;++ if (WARN\_ON\_ONCE(smb3\_encryption\_required(tcon) &&+ (check\_add\_overflow(total\_len - 1,+ ALIGN(indatalen, 8), &len) ||+ len > MAX\_CIFS\_SMALL\_BUFFER\_SIZE))) {+ cifs\_small\_buf\_release(req);+ return -EIO;+ } /\* \* indatalen is usually small at a couple of bytes max, so \* just allocate through generic pool |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:45:12 +0000


