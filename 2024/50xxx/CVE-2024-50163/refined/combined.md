=== Content from git.kernel.org_14b9cb99_20250114_190810.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4e1e428533845d48828bd3875c0e92e8565b9962)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e1e428533845d48828bd3875c0e92e8565b9962)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e1e428533845d48828bd3875c0e92e8565b9962)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e1e428533845d48828bd3875c0e92e8565b9962)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Toke Høiland-Jørgensen <toke@redhat.com> | 2024-09-20 14:56:24 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:52:31 +0100 |
| commit | [4e1e428533845d48828bd3875c0e92e8565b9962](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e1e428533845d48828bd3875c0e92e8565b9962) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4e1e428533845d48828bd3875c0e92e8565b9962)) | |
| tree | [4358f9477b8d5c085b3100a5ef7847ddf31301d5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e1e428533845d48828bd3875c0e92e8565b9962) | |
| parent | [74cdd62cb4706515b454ce5bacb73b566c1d1bcf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=74cdd62cb4706515b454ce5bacb73b566c1d1bcf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e1e428533845d48828bd3875c0e92e8565b9962&id2=74cdd62cb4706515b454ce5bacb73b566c1d1bcf)) | |
| download | [linux-4e1e428533845d48828bd3875c0e92e8565b9962.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4e1e428533845d48828bd3875c0e92e8565b9962.tar.gz) | |

bpf: Make sure internal and UAPI bpf\_redirect flags don't overlap[ Upstream commit 09d88791c7cd888d5195c84733caf9183dcfbd16 ]
The bpf\_redirect\_info is shared between the SKB and XDP redirect paths,
and the two paths use the same numeric flag values in the ri->flags
field (specifically, BPF\_F\_BROADCAST == BPF\_F\_NEXTHOP). This means that
if skb bpf\_redirect\_neigh() is used with a non-NULL params argument and,
subsequently, an XDP redirect is performed using the same
bpf\_redirect\_info struct, the XDP path will get confused and end up
crashing, which syzbot managed to trigger.
With the stack-allocated bpf\_redirect\_info, the structure is no longer
shared between the SKB and XDP paths, so the crash doesn't happen
anymore. However, different code paths using identically-numbered flag
values in the same struct field still seems like a bit of a mess, so
this patch cleans that up by moving the flag definitions together and
redefining the three flags in BPF\_F\_REDIRECT\_INTERNAL to not overlap
with the flags used for XDP. It also adds a BUILD\_BUG\_ON() check to make
sure the overlap is not re-introduced by mistake.
Fixes: e624d4ed4aa8 ("xdp: Extend xdp\_redirect\_map with broadcast support")
Reported-by: syzbot+cca39e6e84a367a7e6f6@syzkaller.appspotmail.com
Signed-off-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://syzkaller.appspot.com/bug?extid=cca39e6e84a367a7e6f6
Link: [https://lore.kernel.org/bpf/20240920125625.59465-1-toke@redhat.com](https://lore.kernel.org/bpf/20240920125625.59465-1-toke%40redhat.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e1e428533845d48828bd3875c0e92e8565b9962)

| -rw-r--r-- | [include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/uapi/linux/bpf.h?id=4e1e428533845d48828bd3875c0e92e8565b9962) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=4e1e428533845d48828bd3875c0e92e8565b9962) | 8 | |  |  |  | | --- | --- | --- | |

2 files changed, 10 insertions, 11 deletions

| diff --git a/include/uapi/linux/bpf.h b/include/uapi/linux/bpf.hindex 6bfb510656abe1..0bdeeabbc5a843 100644--- a/[include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/bpf.h?id=74cdd62cb4706515b454ce5bacb73b566c1d1bcf)+++ b/[include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/bpf.h?id=4e1e428533845d48828bd3875c0e92e8565b9962)@@ -5108,11 +5108,6 @@ enum { BPF\_F\_MARK\_ENFORCE = (1ULL << 6), }; -/\* BPF\_FUNC\_clone\_redirect and BPF\_FUNC\_redirect flags. \*/-enum {- BPF\_F\_INGRESS = (1ULL << 0),-};- /\* BPF\_FUNC\_skb\_set\_tunnel\_key and BPF\_FUNC\_skb\_get\_tunnel\_key flags. \*/ enum { BPF\_F\_TUNINFO\_IPV6 = (1ULL << 0),@@ -5251,10 +5246,12 @@ enum { BPF\_F\_BPRM\_SECUREEXEC = (1ULL << 0), }; -/\* Flags for bpf\_redirect\_map helper \*/+/\* Flags for bpf\_redirect and bpf\_redirect\_map helpers \*/ enum {- BPF\_F\_BROADCAST = (1ULL << 3),- BPF\_F\_EXCLUDE\_INGRESS = (1ULL << 4),+ BPF\_F\_INGRESS = (1ULL << 0), /\* used for skb path \*/+ BPF\_F\_BROADCAST = (1ULL << 3), /\* used for XDP path \*/+ BPF\_F\_EXCLUDE\_INGRESS = (1ULL << 4), /\* used for XDP path \*/+#define BPF\_F\_REDIRECT\_FLAGS (BPF\_F\_INGRESS | BPF\_F\_BROADCAST | BPF\_F\_EXCLUDE\_INGRESS) };  #define \_\_bpf\_md\_ptr(type, name) \diff --git a/net/core/filter.c b/net/core/filter.cindex a92a35c0f1e72e..b5e1e087a2b92a 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=74cdd62cb4706515b454ce5bacb73b566c1d1bcf)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=4e1e428533845d48828bd3875c0e92e8565b9962)@@ -2405,9 +2405,9 @@ out:  /\* Internal, non-exposed redirect flags. \*/ enum {- BPF\_F\_NEIGH = (1ULL << 1),- BPF\_F\_PEER = (1ULL << 2),- BPF\_F\_NEXTHOP = (1ULL << 3),+ BPF\_F\_NEIGH = (1ULL << 16),+ BPF\_F\_PEER = (1ULL << 17),+ BPF\_F\_NEXTHOP = (1ULL << 18), #define BPF\_F\_REDIRECT\_INTERNAL (BPF\_F\_NEIGH | BPF\_F\_PEER | BPF\_F\_NEXTHOP) }; @@ -2417,6 +2417,8 @@ BPF\_CALL\_3(bpf\_clone\_redirect, struct sk\_buff \*, skb, u32, ifindex, u64, flags) struct sk\_buff \*clone; int ret; + BUILD\_BUG\_ON(BPF\_F\_REDIRECT\_INTERNAL & BPF\_F\_REDIRECT\_FLAGS);+ if (unlikely(flags & (~(BPF\_F\_INGRESS) | BPF\_F\_REDIRECT\_INTERNAL))) return -EINVAL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:47 +0000



=== Content from git.kernel.org_9af6dba1_20250114_190808.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=09d88791c7cd888d5195c84733caf9183dcfbd16)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=09d88791c7cd888d5195c84733caf9183dcfbd16)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09d88791c7cd888d5195c84733caf9183dcfbd16)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09d88791c7cd888d5195c84733caf9183dcfbd16)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Toke Høiland-Jørgensen <toke@redhat.com> | 2024-09-20 14:56:24 +0200 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2024-10-01 21:40:12 +0200 |
| commit | [09d88791c7cd888d5195c84733caf9183dcfbd16](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09d88791c7cd888d5195c84733caf9183dcfbd16) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=09d88791c7cd888d5195c84733caf9183dcfbd16)) | |
| tree | [36db622740d93e9437fb97d49cc371b795550543](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=09d88791c7cd888d5195c84733caf9183dcfbd16) | |
| parent | [a41b3828ec056a631ad22413d4560017fed5c3bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a41b3828ec056a631ad22413d4560017fed5c3bd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09d88791c7cd888d5195c84733caf9183dcfbd16&id2=a41b3828ec056a631ad22413d4560017fed5c3bd)) | |
| download | [linux-09d88791c7cd888d5195c84733caf9183dcfbd16.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-09d88791c7cd888d5195c84733caf9183dcfbd16.tar.gz) | |

bpf: Make sure internal and UAPI bpf\_redirect flags don't overlapThe bpf\_redirect\_info is shared between the SKB and XDP redirect paths,
and the two paths use the same numeric flag values in the ri->flags
field (specifically, BPF\_F\_BROADCAST == BPF\_F\_NEXTHOP). This means that
if skb bpf\_redirect\_neigh() is used with a non-NULL params argument and,
subsequently, an XDP redirect is performed using the same
bpf\_redirect\_info struct, the XDP path will get confused and end up
crashing, which syzbot managed to trigger.
With the stack-allocated bpf\_redirect\_info, the structure is no longer
shared between the SKB and XDP paths, so the crash doesn't happen
anymore. However, different code paths using identically-numbered flag
values in the same struct field still seems like a bit of a mess, so
this patch cleans that up by moving the flag definitions together and
redefining the three flags in BPF\_F\_REDIRECT\_INTERNAL to not overlap
with the flags used for XDP. It also adds a BUILD\_BUG\_ON() check to make
sure the overlap is not re-introduced by mistake.
Fixes: e624d4ed4aa8 ("xdp: Extend xdp\_redirect\_map with broadcast support")
Reported-by: syzbot+cca39e6e84a367a7e6f6@syzkaller.appspotmail.com
Signed-off-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://syzkaller.appspot.com/bug?extid=cca39e6e84a367a7e6f6
Link: [https://lore.kernel.org/bpf/20240920125625.59465-1-toke@redhat.com](https://lore.kernel.org/bpf/20240920125625.59465-1-toke%40redhat.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09d88791c7cd888d5195c84733caf9183dcfbd16)

| -rw-r--r-- | [include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/uapi/linux/bpf.h?id=09d88791c7cd888d5195c84733caf9183dcfbd16) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=09d88791c7cd888d5195c84733caf9183dcfbd16) | 8 | |  |  |  | | --- | --- | --- | |

2 files changed, 10 insertions, 11 deletions

| diff --git a/include/uapi/linux/bpf.h b/include/uapi/linux/bpf.hindex c6cd7c7aeeee94..e8241b320c6d9a 100644--- a/[include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/bpf.h?id=a41b3828ec056a631ad22413d4560017fed5c3bd)+++ b/[include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/bpf.h?id=09d88791c7cd888d5195c84733caf9183dcfbd16)@@ -6047,11 +6047,6 @@ enum { BPF\_F\_MARK\_ENFORCE = (1ULL << 6), }; -/\* BPF\_FUNC\_clone\_redirect and BPF\_FUNC\_redirect flags. \*/-enum {- BPF\_F\_INGRESS = (1ULL << 0),-};- /\* BPF\_FUNC\_skb\_set\_tunnel\_key and BPF\_FUNC\_skb\_get\_tunnel\_key flags. \*/ enum { BPF\_F\_TUNINFO\_IPV6 = (1ULL << 0),@@ -6198,10 +6193,12 @@ enum { BPF\_F\_BPRM\_SECUREEXEC = (1ULL << 0), }; -/\* Flags for bpf\_redirect\_map helper \*/+/\* Flags for bpf\_redirect and bpf\_redirect\_map helpers \*/ enum {- BPF\_F\_BROADCAST = (1ULL << 3),- BPF\_F\_EXCLUDE\_INGRESS = (1ULL << 4),+ BPF\_F\_INGRESS = (1ULL << 0), /\* used for skb path \*/+ BPF\_F\_BROADCAST = (1ULL << 3), /\* used for XDP path \*/+ BPF\_F\_EXCLUDE\_INGRESS = (1ULL << 4), /\* used for XDP path \*/+#define BPF\_F\_REDIRECT\_FLAGS (BPF\_F\_INGRESS | BPF\_F\_BROADCAST | BPF\_F\_EXCLUDE\_INGRESS) };  #define \_\_bpf\_md\_ptr(type, name) \diff --git a/net/core/filter.c b/net/core/filter.cindex cd3524cb326b0e..4e3f42cc661199 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=a41b3828ec056a631ad22413d4560017fed5c3bd)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=09d88791c7cd888d5195c84733caf9183dcfbd16)@@ -2438,9 +2438,9 @@ out:  /\* Internal, non-exposed redirect flags. \*/ enum {- BPF\_F\_NEIGH = (1ULL << 1),- BPF\_F\_PEER = (1ULL << 2),- BPF\_F\_NEXTHOP = (1ULL << 3),+ BPF\_F\_NEIGH = (1ULL << 16),+ BPF\_F\_PEER = (1ULL << 17),+ BPF\_F\_NEXTHOP = (1ULL << 18), #define BPF\_F\_REDIRECT\_INTERNAL (BPF\_F\_NEIGH | BPF\_F\_PEER | BPF\_F\_NEXTHOP) }; @@ -2450,6 +2450,8 @@ BPF\_CALL\_3(bpf\_clone\_redirect, struct sk\_buff \*, skb, u32, ifindex, u64, flags) struct sk\_buff \*clone; int ret; + BUILD\_BUG\_ON(BPF\_F\_REDIRECT\_INTERNAL & BPF\_F\_REDIRECT\_FLAGS);+ if (unlikely(flags & (~(BPF\_F\_INGRESS) | BPF\_F\_REDIRECT\_INTERNAL))) return -EINVAL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:45 +0000



=== Content from git.kernel.org_d6a58fbd_20250114_190810.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cec288e05ceac9a0d3a3a1fd279534b11844c826)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cec288e05ceac9a0d3a3a1fd279534b11844c826)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cec288e05ceac9a0d3a3a1fd279534b11844c826)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cec288e05ceac9a0d3a3a1fd279534b11844c826)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Toke Høiland-Jørgensen <toke@redhat.com> | 2024-09-20 14:56:24 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 02:02:23 +0100 |
| commit | [cec288e05ceac9a0d3a3a1fd279534b11844c826](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cec288e05ceac9a0d3a3a1fd279534b11844c826) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cec288e05ceac9a0d3a3a1fd279534b11844c826)) | |
| tree | [8951e575cfaf24cf18715ba1a3fbca3fd72d7767](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cec288e05ceac9a0d3a3a1fd279534b11844c826) | |
| parent | [e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cec288e05ceac9a0d3a3a1fd279534b11844c826&id2=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0)) | |
| download | [linux-cec288e05ceac9a0d3a3a1fd279534b11844c826.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cec288e05ceac9a0d3a3a1fd279534b11844c826.tar.gz) | |

bpf: Make sure internal and UAPI bpf\_redirect flags don't overlap[ Upstream commit 09d88791c7cd888d5195c84733caf9183dcfbd16 ]
The bpf\_redirect\_info is shared between the SKB and XDP redirect paths,
and the two paths use the same numeric flag values in the ri->flags
field (specifically, BPF\_F\_BROADCAST == BPF\_F\_NEXTHOP). This means that
if skb bpf\_redirect\_neigh() is used with a non-NULL params argument and,
subsequently, an XDP redirect is performed using the same
bpf\_redirect\_info struct, the XDP path will get confused and end up
crashing, which syzbot managed to trigger.
With the stack-allocated bpf\_redirect\_info, the structure is no longer
shared between the SKB and XDP paths, so the crash doesn't happen
anymore. However, different code paths using identically-numbered flag
values in the same struct field still seems like a bit of a mess, so
this patch cleans that up by moving the flag definitions together and
redefining the three flags in BPF\_F\_REDIRECT\_INTERNAL to not overlap
with the flags used for XDP. It also adds a BUILD\_BUG\_ON() check to make
sure the overlap is not re-introduced by mistake.
Fixes: e624d4ed4aa8 ("xdp: Extend xdp\_redirect\_map with broadcast support")
Reported-by: syzbot+cca39e6e84a367a7e6f6@syzkaller.appspotmail.com
Signed-off-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://syzkaller.appspot.com/bug?extid=cca39e6e84a367a7e6f6
Link: [https://lore.kernel.org/bpf/20240920125625.59465-1-toke@redhat.com](https://lore.kernel.org/bpf/20240920125625.59465-1-toke%40redhat.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cec288e05ceac9a0d3a3a1fd279534b11844c826)

| -rw-r--r-- | [include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/uapi/linux/bpf.h?id=cec288e05ceac9a0d3a3a1fd279534b11844c826) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=cec288e05ceac9a0d3a3a1fd279534b11844c826) | 8 | |  |  |  | | --- | --- | --- | |

2 files changed, 10 insertions, 11 deletions

| diff --git a/include/uapi/linux/bpf.h b/include/uapi/linux/bpf.hindex 35bcf52dbc6526..fea4bca4066c1b 100644--- a/[include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/bpf.h?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0)+++ b/[include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/bpf.h?id=cec288e05ceac9a0d3a3a1fd279534b11844c826)@@ -6046,11 +6046,6 @@ enum { BPF\_F\_MARK\_ENFORCE = (1ULL << 6), }; -/\* BPF\_FUNC\_clone\_redirect and BPF\_FUNC\_redirect flags. \*/-enum {- BPF\_F\_INGRESS = (1ULL << 0),-};- /\* BPF\_FUNC\_skb\_set\_tunnel\_key and BPF\_FUNC\_skb\_get\_tunnel\_key flags. \*/ enum { BPF\_F\_TUNINFO\_IPV6 = (1ULL << 0),@@ -6197,10 +6192,12 @@ enum { BPF\_F\_BPRM\_SECUREEXEC = (1ULL << 0), }; -/\* Flags for bpf\_redirect\_map helper \*/+/\* Flags for bpf\_redirect and bpf\_redirect\_map helpers \*/ enum {- BPF\_F\_BROADCAST = (1ULL << 3),- BPF\_F\_EXCLUDE\_INGRESS = (1ULL << 4),+ BPF\_F\_INGRESS = (1ULL << 0), /\* used for skb path \*/+ BPF\_F\_BROADCAST = (1ULL << 3), /\* used for XDP path \*/+ BPF\_F\_EXCLUDE\_INGRESS = (1ULL << 4), /\* used for XDP path \*/+#define BPF\_F\_REDIRECT\_FLAGS (BPF\_F\_INGRESS | BPF\_F\_BROADCAST | BPF\_F\_EXCLUDE\_INGRESS) };  #define \_\_bpf\_md\_ptr(type, name) \diff --git a/net/core/filter.c b/net/core/filter.cindex 0e719c7c43bb7f..b7a5f525e65b8d 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=e2ef0f317a52e678fe8fa84b94d6a15b466d6ff0)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=cec288e05ceac9a0d3a3a1fd279534b11844c826)@@ -2437,9 +2437,9 @@ out:  /\* Internal, non-exposed redirect flags. \*/ enum {- BPF\_F\_NEIGH = (1ULL << 1),- BPF\_F\_PEER = (1ULL << 2),- BPF\_F\_NEXTHOP = (1ULL << 3),+ BPF\_F\_NEIGH = (1ULL << 16),+ BPF\_F\_PEER = (1ULL << 17),+ BPF\_F\_NEXTHOP = (1ULL << 18), #define BPF\_F\_REDIRECT\_INTERNAL (BPF\_F\_NEIGH | BPF\_F\_PEER | BPF\_F\_NEXTHOP) }; @@ -2449,6 +2449,8 @@ BPF\_CALL\_3(bpf\_clone\_redirect, struct sk\_buff \*, skb, u32, ifindex, u64, flags) struct sk\_buff \*clone; int ret; + BUILD\_BUG\_ON(BPF\_F\_REDIRECT\_INTERNAL & BPF\_F\_REDIRECT\_FLAGS);+ if (unlikely(flags & (~(BPF\_F\_INGRESS) | BPF\_F\_REDIRECT\_INTERNAL))) return -EINVAL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:48 +0000



=== Content from git.kernel.org_3cddbad4_20250114_190809.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=314dbee9fe4f5cee36435465de52c988d7caa466)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=314dbee9fe4f5cee36435465de52c988d7caa466)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=314dbee9fe4f5cee36435465de52c988d7caa466)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=314dbee9fe4f5cee36435465de52c988d7caa466)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Toke Høiland-Jørgensen <toke@redhat.com> | 2024-09-20 14:56:24 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:55:56 +0100 |
| commit | [314dbee9fe4f5cee36435465de52c988d7caa466](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=314dbee9fe4f5cee36435465de52c988d7caa466) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=314dbee9fe4f5cee36435465de52c988d7caa466)) | |
| tree | [e376152c9e674866346bce4eb2a88767ecb6cf34](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=314dbee9fe4f5cee36435465de52c988d7caa466) | |
| parent | [64f3b66c99ce1955f98b851219e21415afa9c7ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64f3b66c99ce1955f98b851219e21415afa9c7ee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=314dbee9fe4f5cee36435465de52c988d7caa466&id2=64f3b66c99ce1955f98b851219e21415afa9c7ee)) | |
| download | [linux-314dbee9fe4f5cee36435465de52c988d7caa466.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-314dbee9fe4f5cee36435465de52c988d7caa466.tar.gz) | |

bpf: Make sure internal and UAPI bpf\_redirect flags don't overlap[ Upstream commit 09d88791c7cd888d5195c84733caf9183dcfbd16 ]
The bpf\_redirect\_info is shared between the SKB and XDP redirect paths,
and the two paths use the same numeric flag values in the ri->flags
field (specifically, BPF\_F\_BROADCAST == BPF\_F\_NEXTHOP). This means that
if skb bpf\_redirect\_neigh() is used with a non-NULL params argument and,
subsequently, an XDP redirect is performed using the same
bpf\_redirect\_info struct, the XDP path will get confused and end up
crashing, which syzbot managed to trigger.
With the stack-allocated bpf\_redirect\_info, the structure is no longer
shared between the SKB and XDP paths, so the crash doesn't happen
anymore. However, different code paths using identically-numbered flag
values in the same struct field still seems like a bit of a mess, so
this patch cleans that up by moving the flag definitions together and
redefining the three flags in BPF\_F\_REDIRECT\_INTERNAL to not overlap
with the flags used for XDP. It also adds a BUILD\_BUG\_ON() check to make
sure the overlap is not re-introduced by mistake.
Fixes: e624d4ed4aa8 ("xdp: Extend xdp\_redirect\_map with broadcast support")
Reported-by: syzbot+cca39e6e84a367a7e6f6@syzkaller.appspotmail.com
Signed-off-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://syzkaller.appspot.com/bug?extid=cca39e6e84a367a7e6f6
Link: [https://lore.kernel.org/bpf/20240920125625.59465-1-toke@redhat.com](https://lore.kernel.org/bpf/20240920125625.59465-1-toke%40redhat.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=314dbee9fe4f5cee36435465de52c988d7caa466)

| -rw-r--r-- | [include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/uapi/linux/bpf.h?id=314dbee9fe4f5cee36435465de52c988d7caa466) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=314dbee9fe4f5cee36435465de52c988d7caa466) | 8 | |  |  |  | | --- | --- | --- | |

2 files changed, 10 insertions, 11 deletions

| diff --git a/include/uapi/linux/bpf.h b/include/uapi/linux/bpf.hindex 58c7fc75da7524..667f49a64a50b1 100644--- a/[include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/bpf.h?id=64f3b66c99ce1955f98b851219e21415afa9c7ee)+++ b/[include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/bpf.h?id=314dbee9fe4f5cee36435465de52c988d7caa466)@@ -5717,11 +5717,6 @@ enum { BPF\_F\_MARK\_ENFORCE = (1ULL << 6), }; -/\* BPF\_FUNC\_clone\_redirect and BPF\_FUNC\_redirect flags. \*/-enum {- BPF\_F\_INGRESS = (1ULL << 0),-};- /\* BPF\_FUNC\_skb\_set\_tunnel\_key and BPF\_FUNC\_skb\_get\_tunnel\_key flags. \*/ enum { BPF\_F\_TUNINFO\_IPV6 = (1ULL << 0),@@ -5865,10 +5860,12 @@ enum { BPF\_F\_BPRM\_SECUREEXEC = (1ULL << 0), }; -/\* Flags for bpf\_redirect\_map helper \*/+/\* Flags for bpf\_redirect and bpf\_redirect\_map helpers \*/ enum {- BPF\_F\_BROADCAST = (1ULL << 3),- BPF\_F\_EXCLUDE\_INGRESS = (1ULL << 4),+ BPF\_F\_INGRESS = (1ULL << 0), /\* used for skb path \*/+ BPF\_F\_BROADCAST = (1ULL << 3), /\* used for XDP path \*/+ BPF\_F\_EXCLUDE\_INGRESS = (1ULL << 4), /\* used for XDP path \*/+#define BPF\_F\_REDIRECT\_FLAGS (BPF\_F\_INGRESS | BPF\_F\_BROADCAST | BPF\_F\_EXCLUDE\_INGRESS) };  #define \_\_bpf\_md\_ptr(type, name) \diff --git a/net/core/filter.c b/net/core/filter.cindex 6f65c6eb0d90d7..3f3286cf438e7d 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=64f3b66c99ce1955f98b851219e21415afa9c7ee)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=314dbee9fe4f5cee36435465de52c988d7caa466)@@ -2416,9 +2416,9 @@ out:  /\* Internal, non-exposed redirect flags. \*/ enum {- BPF\_F\_NEIGH = (1ULL << 1),- BPF\_F\_PEER = (1ULL << 2),- BPF\_F\_NEXTHOP = (1ULL << 3),+ BPF\_F\_NEIGH = (1ULL << 16),+ BPF\_F\_PEER = (1ULL << 17),+ BPF\_F\_NEXTHOP = (1ULL << 18), #define BPF\_F\_REDIRECT\_INTERNAL (BPF\_F\_NEIGH | BPF\_F\_PEER | BPF\_F\_NEXTHOP) }; @@ -2428,6 +2428,8 @@ BPF\_CALL\_3(bpf\_clone\_redirect, struct sk\_buff \*, skb, u32, ifindex, u64, flags) struct sk\_buff \*clone; int ret; + BUILD\_BUG\_ON(BPF\_F\_REDIRECT\_INTERNAL & BPF\_F\_REDIRECT\_FLAGS);+ if (unlikely(flags & (~(BPF\_F\_INGRESS) | BPF\_F\_REDIRECT\_INTERNAL))) return -EINVAL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:46 +0000



=== Content from git.kernel.org_7ffe50db_20250114_190809.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Toke Høiland-Jørgensen <toke@redhat.com> | 2024-09-20 14:56:24 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-01 01:58:17 +0100 |
| commit | [0fca5ed4be8e8bfbfb9bd97845af596bab7192d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3)) | |
| tree | [2b6e5f01efd3fe9b36601fd87c8d21f5e327ff53](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3) | |
| parent | [de1f0ab13915ddc55519b47b6daba6cc2fff7908](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de1f0ab13915ddc55519b47b6daba6cc2fff7908) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3&id2=de1f0ab13915ddc55519b47b6daba6cc2fff7908)) | |
| download | [linux-0fca5ed4be8e8bfbfb9bd97845af596bab7192d3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0fca5ed4be8e8bfbfb9bd97845af596bab7192d3.tar.gz) | |

bpf: Make sure internal and UAPI bpf\_redirect flags don't overlap[ Upstream commit 09d88791c7cd888d5195c84733caf9183dcfbd16 ]
The bpf\_redirect\_info is shared between the SKB and XDP redirect paths,
and the two paths use the same numeric flag values in the ri->flags
field (specifically, BPF\_F\_BROADCAST == BPF\_F\_NEXTHOP). This means that
if skb bpf\_redirect\_neigh() is used with a non-NULL params argument and,
subsequently, an XDP redirect is performed using the same
bpf\_redirect\_info struct, the XDP path will get confused and end up
crashing, which syzbot managed to trigger.
With the stack-allocated bpf\_redirect\_info, the structure is no longer
shared between the SKB and XDP paths, so the crash doesn't happen
anymore. However, different code paths using identically-numbered flag
values in the same struct field still seems like a bit of a mess, so
this patch cleans that up by moving the flag definitions together and
redefining the three flags in BPF\_F\_REDIRECT\_INTERNAL to not overlap
with the flags used for XDP. It also adds a BUILD\_BUG\_ON() check to make
sure the overlap is not re-introduced by mistake.
Fixes: e624d4ed4aa8 ("xdp: Extend xdp\_redirect\_map with broadcast support")
Reported-by: syzbot+cca39e6e84a367a7e6f6@syzkaller.appspotmail.com
Signed-off-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Closes: https://syzkaller.appspot.com/bug?extid=cca39e6e84a367a7e6f6
Link: [https://lore.kernel.org/bpf/20240920125625.59465-1-toke@redhat.com](https://lore.kernel.org/bpf/20240920125625.59465-1-toke%40redhat.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3)

| -rw-r--r-- | [include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/uapi/linux/bpf.h?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3) | 8 | |  |  |  | | --- | --- | --- | |

2 files changed, 10 insertions, 11 deletions

| diff --git a/include/uapi/linux/bpf.h b/include/uapi/linux/bpf.hindex ba6e346c8d669a..4bb38409b26ad5 100644--- a/[include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/bpf.h?id=de1f0ab13915ddc55519b47b6daba6cc2fff7908)+++ b/[include/uapi/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/uapi/linux/bpf.h?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3)@@ -5921,11 +5921,6 @@ enum { BPF\_F\_MARK\_ENFORCE = (1ULL << 6), }; -/\* BPF\_FUNC\_clone\_redirect and BPF\_FUNC\_redirect flags. \*/-enum {- BPF\_F\_INGRESS = (1ULL << 0),-};- /\* BPF\_FUNC\_skb\_set\_tunnel\_key and BPF\_FUNC\_skb\_get\_tunnel\_key flags. \*/ enum { BPF\_F\_TUNINFO\_IPV6 = (1ULL << 0),@@ -6072,10 +6067,12 @@ enum { BPF\_F\_BPRM\_SECUREEXEC = (1ULL << 0), }; -/\* Flags for bpf\_redirect\_map helper \*/+/\* Flags for bpf\_redirect and bpf\_redirect\_map helpers \*/ enum {- BPF\_F\_BROADCAST = (1ULL << 3),- BPF\_F\_EXCLUDE\_INGRESS = (1ULL << 4),+ BPF\_F\_INGRESS = (1ULL << 0), /\* used for skb path \*/+ BPF\_F\_BROADCAST = (1ULL << 3), /\* used for XDP path \*/+ BPF\_F\_EXCLUDE\_INGRESS = (1ULL << 4), /\* used for XDP path \*/+#define BPF\_F\_REDIRECT\_FLAGS (BPF\_F\_INGRESS | BPF\_F\_BROADCAST | BPF\_F\_EXCLUDE\_INGRESS) };  #define \_\_bpf\_md\_ptr(type, name) \diff --git a/net/core/filter.c b/net/core/filter.cindex 8bfd46a070c167..bbb1432488430c 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=de1f0ab13915ddc55519b47b6daba6cc2fff7908)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=0fca5ed4be8e8bfbfb9bd97845af596bab7192d3)@@ -2423,9 +2423,9 @@ out:  /\* Internal, non-exposed redirect flags. \*/ enum {- BPF\_F\_NEIGH = (1ULL << 1),- BPF\_F\_PEER = (1ULL << 2),- BPF\_F\_NEXTHOP = (1ULL << 3),+ BPF\_F\_NEIGH = (1ULL << 16),+ BPF\_F\_PEER = (1ULL << 17),+ BPF\_F\_NEXTHOP = (1ULL << 18), #define BPF\_F\_REDIRECT\_INTERNAL (BPF\_F\_NEIGH | BPF\_F\_PEER | BPF\_F\_NEXTHOP) }; @@ -2435,6 +2435,8 @@ BPF\_CALL\_3(bpf\_clone\_redirect, struct sk\_buff \*, skb, u32, ifindex, u64, flags) struct sk\_buff \*clone; int ret; + BUILD\_BUG\_ON(BPF\_F\_REDIRECT\_INTERNAL & BPF\_F\_REDIRECT\_FLAGS);+ if (unlikely(flags & (~(BPF\_F\_INGRESS) | BPF\_F\_REDIRECT\_INTERNAL))) return -EINVAL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:06:46 +0000


