=== Content from git.kernel.org_32282be3_20250114_231902.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3a303409f271dfe0987b8f79595138340497a32d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3a303409f271dfe0987b8f79595138340497a32d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3a303409f271dfe0987b8f79595138340497a32d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a303409f271dfe0987b8f79595138340497a32d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hugh Dickins <hughd@google.com> | 2024-10-27 15:23:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:57 +0100 |
| commit | [3a303409f271dfe0987b8f79595138340497a32d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3a303409f271dfe0987b8f79595138340497a32d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3a303409f271dfe0987b8f79595138340497a32d)) | |
| tree | [01ff803b32507d27eedcd61144462d077e04a6c1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3a303409f271dfe0987b8f79595138340497a32d) | |
| parent | [b9cdd9b11916de92221e85379e14882f7f0bfefb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9cdd9b11916de92221e85379e14882f7f0bfefb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a303409f271dfe0987b8f79595138340497a32d&id2=b9cdd9b11916de92221e85379e14882f7f0bfefb)) | |
| download | [linux-3a303409f271dfe0987b8f79595138340497a32d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3a303409f271dfe0987b8f79595138340497a32d.tar.gz) | |

iov\_iter: fix copy\_page\_from\_iter\_atomic() if KMAP\_LOCAL\_FORCE\_MAP[ Upstream commit c749d9b7ebbc5716af7a95f7768634b30d9446ec ]
generic/077 on x86\_32 CONFIG\_DEBUG\_KMAP\_LOCAL\_FORCE\_MAP=y with highmem,
on huge=always tmpfs, issues a warning and then hangs (interruptibly):
WARNING: CPU: 5 PID: 3517 at mm/highmem.c:622 kunmap\_local\_indexed+0x62/0xc9
CPU: 5 UID: 0 PID: 3517 Comm: cp Not tainted 6.12.0-rc4 #2
...
copy\_page\_from\_iter\_atomic+0xa6/0x5ec
generic\_perform\_write+0xf6/0x1b4
shmem\_file\_write\_iter+0x54/0x67
Fix copy\_page\_from\_iter\_atomic() by limiting it in that case
(include/linux/skbuff.h skb\_frag\_must\_loop() does similar).
But going forward, perhaps CONFIG\_DEBUG\_KMAP\_LOCAL\_FORCE\_MAP is too
surprising, has outlived its usefulness, and should just be removed?
Fixes: 908a1ad89466 ("iov\_iter: Handle compound highmem pages in copy\_page\_from\_iter\_atomic()")
Signed-off-by: Hugh Dickins <hughd@google.com>
Link: [https://lore.kernel.org/r/dd5f0c89-186e-18e1-4f43-19a60f5a9774@google.com](https://lore.kernel.org/r/dd5f0c89-186e-18e1-4f43-19a60f5a9774%40google.com)
Reviewed-by: Christoph Hellwig <hch@lst.de>
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a303409f271dfe0987b8f79595138340497a32d)

| -rw-r--r-- | [lib/iov\_iter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/iov_iter.c?id=3a303409f271dfe0987b8f79595138340497a32d) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/lib/iov\_iter.c b/lib/iov\_iter.cindex 4a6a9f419bd7eb..b892894228b03e 100644--- a/[lib/iov\_iter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/iov_iter.c?id=b9cdd9b11916de92221e85379e14882f7f0bfefb)+++ b/[lib/iov\_iter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/iov_iter.c?id=3a303409f271dfe0987b8f79595138340497a32d)@@ -461,6 +461,8 @@ size\_t copy\_page\_from\_iter\_atomic(struct page \*page, size\_t offset, size\_t bytes, struct iov\_iter \*i) { size\_t n, copied = 0;+ bool uses\_kmap = IS\_ENABLED(CONFIG\_DEBUG\_KMAP\_LOCAL\_FORCE\_MAP) ||+ PageHighMem(page);  if (!page\_copy\_sane(page, offset, bytes)) return 0;@@ -471,7 +473,7 @@ size\_t copy\_page\_from\_iter\_atomic(struct page \*page, size\_t offset, char \*p;  n = bytes - copied;- if (PageHighMem(page)) {+ if (uses\_kmap) { page += offset / PAGE\_SIZE; offset %= PAGE\_SIZE; n = min\_t(size\_t, n, PAGE\_SIZE - offset);@@ -482,7 +484,7 @@ size\_t copy\_page\_from\_iter\_atomic(struct page \*page, size\_t offset, kunmap\_atomic(p); copied += n; offset += n;- } while (PageHighMem(page) && copied != bytes && n > 0);+ } while (uses\_kmap && copied != bytes && n > 0);  return copied; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:17:39 +0000



=== Content from git.kernel.org_194ce9c3_20250114_231905.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hugh Dickins <hughd@google.com> | 2024-10-27 15:23:23 -0700 |
| --- | --- | --- |
| committer | Christian Brauner <brauner@kernel.org> | 2024-10-28 13:39:35 +0100 |
| commit | [c749d9b7ebbc5716af7a95f7768634b30d9446ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec)) | |
| tree | [21dfcaa2e437f49e3b26f5faaf10ccadac91e888](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec) | |
| parent | [f19910006effbd08398de79ca0233ea7e480616a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f19910006effbd08398de79ca0233ea7e480616a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec&id2=f19910006effbd08398de79ca0233ea7e480616a)) | |
| download | [linux-c749d9b7ebbc5716af7a95f7768634b30d9446ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c749d9b7ebbc5716af7a95f7768634b30d9446ec.tar.gz) | |

iov\_iter: fix copy\_page\_from\_iter\_atomic() if KMAP\_LOCAL\_FORCE\_MAPgeneric/077 on x86\_32 CONFIG\_DEBUG\_KMAP\_LOCAL\_FORCE\_MAP=y with highmem,
on huge=always tmpfs, issues a warning and then hangs (interruptibly):
WARNING: CPU: 5 PID: 3517 at mm/highmem.c:622 kunmap\_local\_indexed+0x62/0xc9
CPU: 5 UID: 0 PID: 3517 Comm: cp Not tainted 6.12.0-rc4 #2
...
copy\_page\_from\_iter\_atomic+0xa6/0x5ec
generic\_perform\_write+0xf6/0x1b4
shmem\_file\_write\_iter+0x54/0x67
Fix copy\_page\_from\_iter\_atomic() by limiting it in that case
(include/linux/skbuff.h skb\_frag\_must\_loop() does similar).
But going forward, perhaps CONFIG\_DEBUG\_KMAP\_LOCAL\_FORCE\_MAP is too
surprising, has outlived its usefulness, and should just be removed?
Fixes: 908a1ad89466 ("iov\_iter: Handle compound highmem pages in copy\_page\_from\_iter\_atomic()")
Signed-off-by: Hugh Dickins <hughd@google.com>
Link: [https://lore.kernel.org/r/dd5f0c89-186e-18e1-4f43-19a60f5a9774@google.com](https://lore.kernel.org/r/dd5f0c89-186e-18e1-4f43-19a60f5a9774%40google.com)
Reviewed-by: Christoph Hellwig <hch@lst.de>
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec)

| -rw-r--r-- | [lib/iov\_iter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/iov_iter.c?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/lib/iov\_iter.c b/lib/iov\_iter.cindex cc4b5541eef8bd..908e75a28d90bd 100644--- a/[lib/iov\_iter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/iov_iter.c?id=f19910006effbd08398de79ca0233ea7e480616a)+++ b/[lib/iov\_iter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/iov_iter.c?id=c749d9b7ebbc5716af7a95f7768634b30d9446ec)@@ -461,6 +461,8 @@ size\_t copy\_page\_from\_iter\_atomic(struct page \*page, size\_t offset, size\_t bytes, struct iov\_iter \*i) { size\_t n, copied = 0;+ bool uses\_kmap = IS\_ENABLED(CONFIG\_DEBUG\_KMAP\_LOCAL\_FORCE\_MAP) ||+ PageHighMem(page);  if (!page\_copy\_sane(page, offset, bytes)) return 0;@@ -471,7 +473,7 @@ size\_t copy\_page\_from\_iter\_atomic(struct page \*page, size\_t offset, char \*p;  n = bytes - copied;- if (PageHighMem(page)) {+ if (uses\_kmap) { page += offset / PAGE\_SIZE; offset %= PAGE\_SIZE; n = min\_t(size\_t, n, PAGE\_SIZE - offset);@@ -482,7 +484,7 @@ size\_t copy\_page\_from\_iter\_atomic(struct page \*page, size\_t offset, kunmap\_atomic(p); copied += n; offset += n;- } while (PageHighMem(page) && copied != bytes && n > 0);+ } while (uses\_kmap && copied != bytes && n > 0);  return copied; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:17:42 +0000



=== Content from git.kernel.org_7dcae431_20250114_231904.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hugh Dickins <hughd@google.com> | 2024-10-27 15:23:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:25 +0100 |
| commit | [4f7ffa83fa79dd52efbaef366c850aaaae06a469](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469)) | |
| tree | [5f3d8ba810ab65e452e6e1ecb54ba6d70b5653b0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469) | |
| parent | [ade91f6e9848b370add44d89c976e070ccb492ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ade91f6e9848b370add44d89c976e070ccb492ef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469&id2=ade91f6e9848b370add44d89c976e070ccb492ef)) | |
| download | [linux-4f7ffa83fa79dd52efbaef366c850aaaae06a469.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4f7ffa83fa79dd52efbaef366c850aaaae06a469.tar.gz) | |

iov\_iter: fix copy\_page\_from\_iter\_atomic() if KMAP\_LOCAL\_FORCE\_MAP[ Upstream commit c749d9b7ebbc5716af7a95f7768634b30d9446ec ]
generic/077 on x86\_32 CONFIG\_DEBUG\_KMAP\_LOCAL\_FORCE\_MAP=y with highmem,
on huge=always tmpfs, issues a warning and then hangs (interruptibly):
WARNING: CPU: 5 PID: 3517 at mm/highmem.c:622 kunmap\_local\_indexed+0x62/0xc9
CPU: 5 UID: 0 PID: 3517 Comm: cp Not tainted 6.12.0-rc4 #2
...
copy\_page\_from\_iter\_atomic+0xa6/0x5ec
generic\_perform\_write+0xf6/0x1b4
shmem\_file\_write\_iter+0x54/0x67
Fix copy\_page\_from\_iter\_atomic() by limiting it in that case
(include/linux/skbuff.h skb\_frag\_must\_loop() does similar).
But going forward, perhaps CONFIG\_DEBUG\_KMAP\_LOCAL\_FORCE\_MAP is too
surprising, has outlived its usefulness, and should just be removed?
Fixes: 908a1ad89466 ("iov\_iter: Handle compound highmem pages in copy\_page\_from\_iter\_atomic()")
Signed-off-by: Hugh Dickins <hughd@google.com>
Link: [https://lore.kernel.org/r/dd5f0c89-186e-18e1-4f43-19a60f5a9774@google.com](https://lore.kernel.org/r/dd5f0c89-186e-18e1-4f43-19a60f5a9774%40google.com)
Reviewed-by: Christoph Hellwig <hch@lst.de>
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469)

| -rw-r--r-- | [lib/iov\_iter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/iov_iter.c?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/lib/iov\_iter.c b/lib/iov\_iter.cindex 27234a820eeb39..a4bb47efafe37d 100644--- a/[lib/iov\_iter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/iov_iter.c?id=ade91f6e9848b370add44d89c976e070ccb492ef)+++ b/[lib/iov\_iter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/iov_iter.c?id=4f7ffa83fa79dd52efbaef366c850aaaae06a469)@@ -570,6 +570,8 @@ size\_t copy\_page\_from\_iter\_atomic(struct page \*page, size\_t offset, size\_t bytes, struct iov\_iter \*i) { size\_t n, copied = 0;+ bool uses\_kmap = IS\_ENABLED(CONFIG\_DEBUG\_KMAP\_LOCAL\_FORCE\_MAP) ||+ PageHighMem(page);  if (!page\_copy\_sane(page, offset, bytes)) return 0;@@ -580,7 +582,7 @@ size\_t copy\_page\_from\_iter\_atomic(struct page \*page, size\_t offset, char \*p;  n = bytes - copied;- if (PageHighMem(page)) {+ if (uses\_kmap) { page += offset / PAGE\_SIZE; offset %= PAGE\_SIZE; n = min\_t(size\_t, n, PAGE\_SIZE - offset);@@ -594,7 +596,7 @@ size\_t copy\_page\_from\_iter\_atomic(struct page \*page, size\_t offset, kunmap\_atomic(p); copied += n; offset += n;- } while (PageHighMem(page) && copied != bytes && n > 0);+ } while (uses\_kmap && copied != bytes && n > 0);  return copied; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:17:40 +0000


