=== Content from git.kernel.org_351d4727_20250115_081553.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=25f00a13dccf8e45441265768de46c8bf58e08f6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=25f00a13dccf8e45441265768de46c8bf58e08f6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25f00a13dccf8e45441265768de46c8bf58e08f6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25f00a13dccf8e45441265768de46c8bf58e08f6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Frank Li <Frank.Li@nxp.com> | 2024-10-23 16:30:32 -0400 |
| --- | --- | --- |
| committer | Mark Brown <broonie@kernel.org> | 2024-10-23 22:37:54 +0100 |
| commit | [25f00a13dccf8e45441265768de46c8bf58e08f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25f00a13dccf8e45441265768de46c8bf58e08f6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=25f00a13dccf8e45441265768de46c8bf58e08f6)) | |
| tree | [df60024d5abf0a4becad6bcd607162fbc2fb928d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=25f00a13dccf8e45441265768de46c8bf58e08f6) | |
| parent | [d0ccf760a405d243a49485be0a43bd5b66ed17e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0ccf760a405d243a49485be0a43bd5b66ed17e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25f00a13dccf8e45441265768de46c8bf58e08f6&id2=d0ccf760a405d243a49485be0a43bd5b66ed17e2)) | |
| download | [linux-25f00a13dccf8e45441265768de46c8bf58e08f6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-25f00a13dccf8e45441265768de46c8bf58e08f6.tar.gz) | |

spi: spi-fsl-dspi: Fix crash when not using GPIO chip selectAdd check for the return value of spi\_get\_csgpiod() to avoid passing a NULL
pointer to gpiod\_direction\_output(), preventing a crash when GPIO chip
select is not used.
Fix below crash:
[ 4.251960] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
[ 4.260762] Mem abort info:
[ 4.263556] ESR = 0x0000000096000004
[ 4.267308] EC = 0x25: DABT (current EL), IL = 32 bits
[ 4.272624] SET = 0, FnV = 0
[ 4.275681] EA = 0, S1PTW = 0
[ 4.278822] FSC = 0x04: level 0 translation fault
[ 4.283704] Data abort info:
[ 4.286583] ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
[ 4.292074] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 4.297130] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 4.302445] [0000000000000000] user address but active\_mm is swapper
[ 4.308805] Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
[ 4.315072] Modules linked in:
[ 4.318124] CPU: 2 UID: 0 PID: 1 Comm: swapper/0 Not tainted 6.12.0-rc4-next-20241023-00008-ga20ec42c5fc1 #359
[ 4.328130] Hardware name: LS1046A QDS Board (DT)
[ 4.332832] pstate: 40000005 (nZcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 4.339794] pc : gpiod\_direction\_output+0x34/0x5c
[ 4.344505] lr : gpiod\_direction\_output+0x18/0x5c
[ 4.349208] sp : ffff80008003b8f0
[ 4.352517] x29: ffff80008003b8f0 x28: 0000000000000000 x27: ffffc96bcc7e9068
[ 4.359659] x26: ffffc96bcc6e00b0 x25: ffffc96bcc598398 x24: ffff447400132810
[ 4.366800] x23: 0000000000000000 x22: 0000000011e1a300 x21: 0000000000020002
[ 4.373940] x20: 0000000000000000 x19: 0000000000000000 x18: ffffffffffffffff
[ 4.381081] x17: ffff44740016e600 x16: 0000000500000003 x15: 0000000000000007
[ 4.388221] x14: 0000000000989680 x13: 0000000000020000 x12: 000000000000001e
[ 4.395362] x11: 0044b82fa09b5a53 x10: 0000000000000019 x9 : 0000000000000008
[ 4.402502] x8 : 0000000000000002 x7 : 0000000000000007 x6 : 0000000000000000
[ 4.409641] x5 : 0000000000000200 x4 : 0000000002000000 x3 : 0000000000000000
[ 4.416781] x2 : 0000000000022202 x1 : 0000000000000000 x0 : 0000000000000000
[ 4.423921] Call trace:
[ 4.426362] gpiod\_direction\_output+0x34/0x5c (P)
[ 4.431067] gpiod\_direction\_output+0x18/0x5c (L)
[ 4.435771] dspi\_setup+0x220/0x334
Fixes: 9e264f3f85a5 ("spi: Replace all spi->chip\_select and spi->cs\_gpiod references with function call")
Cc: stable@vger.kernel.org
Signed-off-by: Frank Li <Frank.Li@nxp.com>
Link: [https://patch.msgid.link/20241023203032.1388491-1-Frank.Li@nxp.com](https://patch.msgid.link/20241023203032.1388491-1-Frank.Li%40nxp.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25f00a13dccf8e45441265768de46c8bf58e08f6)

| -rw-r--r-- | [drivers/spi/spi-fsl-dspi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/spi/spi-fsl-dspi.c?id=25f00a13dccf8e45441265768de46c8bf58e08f6) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/spi/spi-fsl-dspi.c b/drivers/spi/spi-fsl-dspi.cindex 191de1917f8316..3fa990fb59c78b 100644--- a/[drivers/spi/spi-fsl-dspi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-fsl-dspi.c?id=d0ccf760a405d243a49485be0a43bd5b66ed17e2)+++ b/[drivers/spi/spi-fsl-dspi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-fsl-dspi.c?id=25f00a13dccf8e45441265768de46c8bf58e08f6)@@ -1003,6 +1003,7 @@ static int dspi\_setup(struct spi\_device \*spi) u32 cs\_sck\_delay = 0, sck\_cs\_delay = 0; struct fsl\_dspi\_platform\_data \*pdata; unsigned char pasc = 0, asc = 0;+ struct gpio\_desc \*gpio\_cs; struct chip\_data \*chip; unsigned long clkrate; bool cs = true;@@ -1077,7 +1078,10 @@ static int dspi\_setup(struct spi\_device \*spi) chip->ctar\_val |= SPI\_CTAR\_LSBFE; } - gpiod\_direction\_output(spi\_get\_csgpiod(spi, 0), false);+ gpio\_cs = spi\_get\_csgpiod(spi, 0);+ if (gpio\_cs)+ gpiod\_direction\_output(gpio\_cs, false);+ dspi\_deassert\_cs(spi, &cs);  spi\_set\_ctldata(spi, chip); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:14:31 +0000



=== Content from git.kernel.org_1e1ee0d0_20250115_081553.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=89f74c968319d040739d6238e1c3a4caa16a5a00)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89f74c968319d040739d6238e1c3a4caa16a5a00)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89f74c968319d040739d6238e1c3a4caa16a5a00)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89f74c968319d040739d6238e1c3a4caa16a5a00)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Frank Li <Frank.Li@nxp.com> | 2024-10-23 16:30:32 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:56 +0100 |
| commit | [89f74c968319d040739d6238e1c3a4caa16a5a00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89f74c968319d040739d6238e1c3a4caa16a5a00) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=89f74c968319d040739d6238e1c3a4caa16a5a00)) | |
| tree | [b07bdc173f19955504a5b2ca19897c5015683ec2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89f74c968319d040739d6238e1c3a4caa16a5a00) | |
| parent | [22833d89b780ba0f9f66e19c477e7decf638edce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22833d89b780ba0f9f66e19c477e7decf638edce) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89f74c968319d040739d6238e1c3a4caa16a5a00&id2=22833d89b780ba0f9f66e19c477e7decf638edce)) | |
| download | [linux-89f74c968319d040739d6238e1c3a4caa16a5a00.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-89f74c968319d040739d6238e1c3a4caa16a5a00.tar.gz) | |

spi: spi-fsl-dspi: Fix crash when not using GPIO chip select[ Upstream commit 25f00a13dccf8e45441265768de46c8bf58e08f6 ]
Add check for the return value of spi\_get\_csgpiod() to avoid passing a NULL
pointer to gpiod\_direction\_output(), preventing a crash when GPIO chip
select is not used.
Fix below crash:
[ 4.251960] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
[ 4.260762] Mem abort info:
[ 4.263556] ESR = 0x0000000096000004
[ 4.267308] EC = 0x25: DABT (current EL), IL = 32 bits
[ 4.272624] SET = 0, FnV = 0
[ 4.275681] EA = 0, S1PTW = 0
[ 4.278822] FSC = 0x04: level 0 translation fault
[ 4.283704] Data abort info:
[ 4.286583] ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
[ 4.292074] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 4.297130] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 4.302445] [0000000000000000] user address but active\_mm is swapper
[ 4.308805] Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
[ 4.315072] Modules linked in:
[ 4.318124] CPU: 2 UID: 0 PID: 1 Comm: swapper/0 Not tainted 6.12.0-rc4-next-20241023-00008-ga20ec42c5fc1 #359
[ 4.328130] Hardware name: LS1046A QDS Board (DT)
[ 4.332832] pstate: 40000005 (nZcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 4.339794] pc : gpiod\_direction\_output+0x34/0x5c
[ 4.344505] lr : gpiod\_direction\_output+0x18/0x5c
[ 4.349208] sp : ffff80008003b8f0
[ 4.352517] x29: ffff80008003b8f0 x28: 0000000000000000 x27: ffffc96bcc7e9068
[ 4.359659] x26: ffffc96bcc6e00b0 x25: ffffc96bcc598398 x24: ffff447400132810
[ 4.366800] x23: 0000000000000000 x22: 0000000011e1a300 x21: 0000000000020002
[ 4.373940] x20: 0000000000000000 x19: 0000000000000000 x18: ffffffffffffffff
[ 4.381081] x17: ffff44740016e600 x16: 0000000500000003 x15: 0000000000000007
[ 4.388221] x14: 0000000000989680 x13: 0000000000020000 x12: 000000000000001e
[ 4.395362] x11: 0044b82fa09b5a53 x10: 0000000000000019 x9 : 0000000000000008
[ 4.402502] x8 : 0000000000000002 x7 : 0000000000000007 x6 : 0000000000000000
[ 4.409641] x5 : 0000000000000200 x4 : 0000000002000000 x3 : 0000000000000000
[ 4.416781] x2 : 0000000000022202 x1 : 0000000000000000 x0 : 0000000000000000
[ 4.423921] Call trace:
[ 4.426362] gpiod\_direction\_output+0x34/0x5c (P)
[ 4.431067] gpiod\_direction\_output+0x18/0x5c (L)
[ 4.435771] dspi\_setup+0x220/0x334
Fixes: 9e264f3f85a5 ("spi: Replace all spi->chip\_select and spi->cs\_gpiod references with function call")
Cc: stable@vger.kernel.org
Signed-off-by: Frank Li <Frank.Li@nxp.com>
Link: [https://patch.msgid.link/20241023203032.1388491-1-Frank.Li@nxp.com](https://patch.msgid.link/20241023203032.1388491-1-Frank.Li%40nxp.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89f74c968319d040739d6238e1c3a4caa16a5a00)

| -rw-r--r-- | [drivers/spi/spi-fsl-dspi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/spi/spi-fsl-dspi.c?id=89f74c968319d040739d6238e1c3a4caa16a5a00) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/spi/spi-fsl-dspi.c b/drivers/spi/spi-fsl-dspi.cindex 191de1917f8316..3fa990fb59c78b 100644--- a/[drivers/spi/spi-fsl-dspi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-fsl-dspi.c?id=22833d89b780ba0f9f66e19c477e7decf638edce)+++ b/[drivers/spi/spi-fsl-dspi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-fsl-dspi.c?id=89f74c968319d040739d6238e1c3a4caa16a5a00)@@ -1003,6 +1003,7 @@ static int dspi\_setup(struct spi\_device \*spi) u32 cs\_sck\_delay = 0, sck\_cs\_delay = 0; struct fsl\_dspi\_platform\_data \*pdata; unsigned char pasc = 0, asc = 0;+ struct gpio\_desc \*gpio\_cs; struct chip\_data \*chip; unsigned long clkrate; bool cs = true;@@ -1077,7 +1078,10 @@ static int dspi\_setup(struct spi\_device \*spi) chip->ctar\_val |= SPI\_CTAR\_LSBFE; } - gpiod\_direction\_output(spi\_get\_csgpiod(spi, 0), false);+ gpio\_cs = spi\_get\_csgpiod(spi, 0);+ if (gpio\_cs)+ gpiod\_direction\_output(gpio\_cs, false);+ dspi\_deassert\_cs(spi, &cs);  spi\_set\_ctldata(spi, chip); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:14:31 +0000



=== Content from git.kernel.org_2b5c13ff_20250115_081554.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Frank Li <Frank.Li@nxp.com> | 2024-10-23 16:30:32 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:25 +0100 |
| commit | [e79c1f1c9100b4adc91c6512985db2cc961aafaa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa)) | |
| tree | [7f3ebc2427f56b77a1b209f2b6572150763d9d40](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa) | |
| parent | [163e6323799bdf6074bc8a5825dba40fbdf63597](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=163e6323799bdf6074bc8a5825dba40fbdf63597) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa&id2=163e6323799bdf6074bc8a5825dba40fbdf63597)) | |
| download | [linux-e79c1f1c9100b4adc91c6512985db2cc961aafaa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e79c1f1c9100b4adc91c6512985db2cc961aafaa.tar.gz) | |

spi: spi-fsl-dspi: Fix crash when not using GPIO chip select[ Upstream commit 25f00a13dccf8e45441265768de46c8bf58e08f6 ]
Add check for the return value of spi\_get\_csgpiod() to avoid passing a NULL
pointer to gpiod\_direction\_output(), preventing a crash when GPIO chip
select is not used.
Fix below crash:
[ 4.251960] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
[ 4.260762] Mem abort info:
[ 4.263556] ESR = 0x0000000096000004
[ 4.267308] EC = 0x25: DABT (current EL), IL = 32 bits
[ 4.272624] SET = 0, FnV = 0
[ 4.275681] EA = 0, S1PTW = 0
[ 4.278822] FSC = 0x04: level 0 translation fault
[ 4.283704] Data abort info:
[ 4.286583] ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
[ 4.292074] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 4.297130] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 4.302445] [0000000000000000] user address but active\_mm is swapper
[ 4.308805] Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
[ 4.315072] Modules linked in:
[ 4.318124] CPU: 2 UID: 0 PID: 1 Comm: swapper/0 Not tainted 6.12.0-rc4-next-20241023-00008-ga20ec42c5fc1 #359
[ 4.328130] Hardware name: LS1046A QDS Board (DT)
[ 4.332832] pstate: 40000005 (nZcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 4.339794] pc : gpiod\_direction\_output+0x34/0x5c
[ 4.344505] lr : gpiod\_direction\_output+0x18/0x5c
[ 4.349208] sp : ffff80008003b8f0
[ 4.352517] x29: ffff80008003b8f0 x28: 0000000000000000 x27: ffffc96bcc7e9068
[ 4.359659] x26: ffffc96bcc6e00b0 x25: ffffc96bcc598398 x24: ffff447400132810
[ 4.366800] x23: 0000000000000000 x22: 0000000011e1a300 x21: 0000000000020002
[ 4.373940] x20: 0000000000000000 x19: 0000000000000000 x18: ffffffffffffffff
[ 4.381081] x17: ffff44740016e600 x16: 0000000500000003 x15: 0000000000000007
[ 4.388221] x14: 0000000000989680 x13: 0000000000020000 x12: 000000000000001e
[ 4.395362] x11: 0044b82fa09b5a53 x10: 0000000000000019 x9 : 0000000000000008
[ 4.402502] x8 : 0000000000000002 x7 : 0000000000000007 x6 : 0000000000000000
[ 4.409641] x5 : 0000000000000200 x4 : 0000000002000000 x3 : 0000000000000000
[ 4.416781] x2 : 0000000000022202 x1 : 0000000000000000 x0 : 0000000000000000
[ 4.423921] Call trace:
[ 4.426362] gpiod\_direction\_output+0x34/0x5c (P)
[ 4.431067] gpiod\_direction\_output+0x18/0x5c (L)
[ 4.435771] dspi\_setup+0x220/0x334
Fixes: 9e264f3f85a5 ("spi: Replace all spi->chip\_select and spi->cs\_gpiod references with function call")
Cc: stable@vger.kernel.org
Signed-off-by: Frank Li <Frank.Li@nxp.com>
Link: [https://patch.msgid.link/20241023203032.1388491-1-Frank.Li@nxp.com](https://patch.msgid.link/20241023203032.1388491-1-Frank.Li%40nxp.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa)

| -rw-r--r-- | [drivers/spi/spi-fsl-dspi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/spi/spi-fsl-dspi.c?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/spi/spi-fsl-dspi.c b/drivers/spi/spi-fsl-dspi.cindex 8318249f8a1f9b..bcb0de864d34db 100644--- a/[drivers/spi/spi-fsl-dspi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-fsl-dspi.c?id=163e6323799bdf6074bc8a5825dba40fbdf63597)+++ b/[drivers/spi/spi-fsl-dspi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-fsl-dspi.c?id=e79c1f1c9100b4adc91c6512985db2cc961aafaa)@@ -1008,6 +1008,7 @@ static int dspi\_setup(struct spi\_device \*spi) u32 cs\_sck\_delay = 0, sck\_cs\_delay = 0; struct fsl\_dspi\_platform\_data \*pdata; unsigned char pasc = 0, asc = 0;+ struct gpio\_desc \*gpio\_cs; struct chip\_data \*chip; unsigned long clkrate; bool cs = true;@@ -1073,7 +1074,10 @@ static int dspi\_setup(struct spi\_device \*spi) chip->ctar\_val |= SPI\_CTAR\_LSBFE; } - gpiod\_direction\_output(spi\_get\_csgpiod(spi, 0), false);+ gpio\_cs = spi\_get\_csgpiod(spi, 0);+ if (gpio\_cs)+ gpiod\_direction\_output(gpio\_cs, false);+ dspi\_deassert\_cs(spi, &cs);  spi\_set\_ctldata(spi, chip); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:14:32 +0000


