=== Content from git.kernel.org_b63337d4_20250115_084505.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lorenzo Stoakes <lorenzo.stoakes@oracle.com> | 2024-10-15 18:56:06 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:58 +0100 |
| commit | [3b85aa0da8cd01173b9afd1f70080fbb9576c4b0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0)) | |
| tree | [896475ae80cc377fc5801393e6305d189049c549](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0) | |
| parent | [92b472945dbf8abc020e9259c0088026f7027dfc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92b472945dbf8abc020e9259c0088026f7027dfc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0&id2=92b472945dbf8abc020e9259c0088026f7027dfc)) | |
| download | [linux-3b85aa0da8cd01173b9afd1f70080fbb9576c4b0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3b85aa0da8cd01173b9afd1f70080fbb9576c4b0.tar.gz) | |

fork: only invoke khugepaged, ksm hooks if no error[ Upstream commit 985da552a98e27096444508ce5d853244019111f ]
There is no reason to invoke these hooks early against an mm that is in an
incomplete state.
The change in commit d24062914837 ("fork: use \_\_mt\_dup() to duplicate
maple tree in dup\_mmap()") makes this more pertinent as we may be in a
state where entries in the maple tree are not yet consistent.
Their placement early in dup\_mmap() only appears to have been meaningful
for early error checking, and since functionally it'd require a very small
allocation to fail (in practice 'too small to fail') that'd only occur in
the most dire circumstances, meaning the fork would fail or be OOM'd in
any case.
Since both khugepaged and KSM tracking are there to provide optimisations
to memory performance rather than critical functionality, it doesn't
really matter all that much if, under such dire memory pressure, we fail
to register an mm with these.
As a result, we follow the example of commit d2081b2bf819 ("mm:
khugepaged: make khugepaged\_enter() void function") and make ksm\_fork() a
void function also.
We only expose the mm to these functions once we are done with them and
only if no error occurred in the fork operation.
Link: [https://lkml.kernel.org/r/e0cb8b840c9d1d5a6e84d4f8eff5f3f2022aa10c.1729014377.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/e0cb8b840c9d1d5a6e84d4f8eff5f3f2022aa10c.1729014377.git.lorenzo.stoakes%40oracle.com)
Fixes: d24062914837 ("fork: use \_\_mt\_dup() to duplicate maple tree in dup\_mmap()")
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Reported-by: Jann Horn <jannh@google.com>
Reviewed-by: Liam R. Howlett <Liam.Howlett@Oracle.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Reviewed-by: Jann Horn <jannh@google.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Cc: Jan Kara <jack@suse.cz>
Cc: Linus Torvalds <torvalds@linuxfoundation.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0)

| -rw-r--r-- | [include/linux/ksm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/ksm.h?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/fork.c?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 11 deletions

| diff --git a/include/linux/ksm.h b/include/linux/ksm.hindex 11690dacd98684..ec9c05044d4fed 100644--- a/[include/linux/ksm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/ksm.h?id=92b472945dbf8abc020e9259c0088026f7027dfc)+++ b/[include/linux/ksm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/ksm.h?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0)@@ -54,12 +54,11 @@ static inline long mm\_ksm\_zero\_pages(struct mm\_struct \*mm) return atomic\_long\_read(&mm->ksm\_zero\_pages); } -static inline int ksm\_fork(struct mm\_struct \*mm, struct mm\_struct \*oldmm)+static inline void ksm\_fork(struct mm\_struct \*mm, struct mm\_struct \*oldmm) {+ /\* Adding mm to ksm is best effort on fork. \*/ if (test\_bit(MMF\_VM\_MERGEABLE, &oldmm->flags))- return \_\_ksm\_enter(mm);-- return 0;+ \_\_ksm\_enter(mm); }  static inline int ksm\_execve(struct mm\_struct \*mm)@@ -107,9 +106,8 @@ static inline int ksm\_disable(struct mm\_struct \*mm) return 0; } -static inline int ksm\_fork(struct mm\_struct \*mm, struct mm\_struct \*oldmm)+static inline void ksm\_fork(struct mm\_struct \*mm, struct mm\_struct \*oldmm) {- return 0; }  static inline int ksm\_execve(struct mm\_struct \*mm)diff --git a/kernel/fork.c b/kernel/fork.cindex 6423ce60b8f97c..dc08a23747338c 100644--- a/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=92b472945dbf8abc020e9259c0088026f7027dfc)+++ b/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=3b85aa0da8cd01173b9afd1f70080fbb9576c4b0)@@ -653,11 +653,6 @@ static \_\_latent\_entropy int dup\_mmap(struct mm\_struct \*mm, mm->exec\_vm = oldmm->exec\_vm; mm->stack\_vm = oldmm->stack\_vm; - retval = ksm\_fork(mm, oldmm);- if (retval)- goto out;- khugepaged\_fork(mm, oldmm);- /\* Use \_\_mt\_dup() to efficiently build an identical maple tree. \*/ retval = \_\_mt\_dup(&oldmm->mm\_mt, &mm->mm\_mt, GFP\_KERNEL); if (unlikely(retval))@@ -760,6 +755,8 @@ loop\_out: vma\_iter\_free(&vmi); if (!retval) { mt\_set\_in\_rcu(vmi.mas.tree);+ ksm\_fork(mm, oldmm);+ khugepaged\_fork(mm, oldmm); } else if (mpnt) { /\* \* The entire maple tree has already been duplicated. If the |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:43:42 +0000



=== Content from git.kernel.org_790630da_20250115_084506.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=985da552a98e27096444508ce5d853244019111f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=985da552a98e27096444508ce5d853244019111f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=985da552a98e27096444508ce5d853244019111f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=985da552a98e27096444508ce5d853244019111f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lorenzo Stoakes <lorenzo.stoakes@oracle.com> | 2024-10-15 18:56:06 +0100 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-10-28 21:40:39 -0700 |
| commit | [985da552a98e27096444508ce5d853244019111f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=985da552a98e27096444508ce5d853244019111f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=985da552a98e27096444508ce5d853244019111f)) | |
| tree | [b9170f78051dc49521c14c7be08a2bf9b1d0a81f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=985da552a98e27096444508ce5d853244019111f) | |
| parent | [f64e67e5d3a45a4a04286c47afade4b518acd47b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f64e67e5d3a45a4a04286c47afade4b518acd47b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=985da552a98e27096444508ce5d853244019111f&id2=f64e67e5d3a45a4a04286c47afade4b518acd47b)) | |
| download | [linux-985da552a98e27096444508ce5d853244019111f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-985da552a98e27096444508ce5d853244019111f.tar.gz) | |

fork: only invoke khugepaged, ksm hooks if no errorThere is no reason to invoke these hooks early against an mm that is in an
incomplete state.
The change in commit d24062914837 ("fork: use \_\_mt\_dup() to duplicate
maple tree in dup\_mmap()") makes this more pertinent as we may be in a
state where entries in the maple tree are not yet consistent.
Their placement early in dup\_mmap() only appears to have been meaningful
for early error checking, and since functionally it'd require a very small
allocation to fail (in practice 'too small to fail') that'd only occur in
the most dire circumstances, meaning the fork would fail or be OOM'd in
any case.
Since both khugepaged and KSM tracking are there to provide optimisations
to memory performance rather than critical functionality, it doesn't
really matter all that much if, under such dire memory pressure, we fail
to register an mm with these.
As a result, we follow the example of commit d2081b2bf819 ("mm:
khugepaged: make khugepaged\_enter() void function") and make ksm\_fork() a
void function also.
We only expose the mm to these functions once we are done with them and
only if no error occurred in the fork operation.
Link: [https://lkml.kernel.org/r/e0cb8b840c9d1d5a6e84d4f8eff5f3f2022aa10c.1729014377.git.lorenzo.stoakes@oracle.com](https://lkml.kernel.org/r/e0cb8b840c9d1d5a6e84d4f8eff5f3f2022aa10c.1729014377.git.lorenzo.stoakes%40oracle.com)
Fixes: d24062914837 ("fork: use \_\_mt\_dup() to duplicate maple tree in dup\_mmap()")
Signed-off-by: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Reported-by: Jann Horn <jannh@google.com>
Reviewed-by: Liam R. Howlett <Liam.Howlett@Oracle.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Reviewed-by: Jann Horn <jannh@google.com>
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: Christian Brauner <brauner@kernel.org>
Cc: Jan Kara <jack@suse.cz>
Cc: Linus Torvalds <torvalds@linuxfoundation.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=985da552a98e27096444508ce5d853244019111f)

| -rw-r--r-- | [include/linux/ksm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/ksm.h?id=985da552a98e27096444508ce5d853244019111f) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/fork.c?id=985da552a98e27096444508ce5d853244019111f) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 11 deletions

| diff --git a/include/linux/ksm.h b/include/linux/ksm.hindex 11690dacd98684..ec9c05044d4fed 100644--- a/[include/linux/ksm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/ksm.h?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)+++ b/[include/linux/ksm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/ksm.h?id=985da552a98e27096444508ce5d853244019111f)@@ -54,12 +54,11 @@ static inline long mm\_ksm\_zero\_pages(struct mm\_struct \*mm) return atomic\_long\_read(&mm->ksm\_zero\_pages); } -static inline int ksm\_fork(struct mm\_struct \*mm, struct mm\_struct \*oldmm)+static inline void ksm\_fork(struct mm\_struct \*mm, struct mm\_struct \*oldmm) {+ /\* Adding mm to ksm is best effort on fork. \*/ if (test\_bit(MMF\_VM\_MERGEABLE, &oldmm->flags))- return \_\_ksm\_enter(mm);-- return 0;+ \_\_ksm\_enter(mm); }  static inline int ksm\_execve(struct mm\_struct \*mm)@@ -107,9 +106,8 @@ static inline int ksm\_disable(struct mm\_struct \*mm) return 0; } -static inline int ksm\_fork(struct mm\_struct \*mm, struct mm\_struct \*oldmm)+static inline void ksm\_fork(struct mm\_struct \*mm, struct mm\_struct \*oldmm) {- return 0; }  static inline int ksm\_execve(struct mm\_struct \*mm)diff --git a/kernel/fork.c b/kernel/fork.cindex 597b477dd491f6..3bf38d260cb391 100644--- a/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=f64e67e5d3a45a4a04286c47afade4b518acd47b)+++ b/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=985da552a98e27096444508ce5d853244019111f)@@ -653,11 +653,6 @@ static \_\_latent\_entropy int dup\_mmap(struct mm\_struct \*mm, mm->exec\_vm = oldmm->exec\_vm; mm->stack\_vm = oldmm->stack\_vm; - retval = ksm\_fork(mm, oldmm);- if (retval)- goto out;- khugepaged\_fork(mm, oldmm);- /\* Use \_\_mt\_dup() to efficiently build an identical maple tree. \*/ retval = \_\_mt\_dup(&oldmm->mm\_mt, &mm->mm\_mt, GFP\_KERNEL); if (unlikely(retval))@@ -760,6 +755,8 @@ loop\_out: vma\_iter\_free(&vmi); if (!retval) { mt\_set\_in\_rcu(vmi.mas.tree);+ ksm\_fork(mm, oldmm);+ khugepaged\_fork(mm, oldmm); } else if (mpnt) { /\* \* The entire maple tree has already been duplicated. If the |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:43:43 +0000



=== Content from project-zero.issues.chromium.org_53456ee5_20250115_084508.html ===
[Sign in](https://accounts.google.com/ServiceLogin?passive=1209600&osid=1&continue=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F373391951&followup=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F373391951&ec=GAZAkwI)
