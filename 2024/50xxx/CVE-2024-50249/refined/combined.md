=== Content from git.kernel.org_0510ec7c_20250115_092231.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c46d6b02588000c27b7b869388c2c0278bd0d173)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c46d6b02588000c27b7b869388c2c0278bd0d173)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c46d6b02588000c27b7b869388c2c0278bd0d173)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c46d6b02588000c27b7b869388c2c0278bd0d173)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pierre Gondois <pierre.gondois@arm.com> | 2024-10-28 13:56:56 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:25:53 +0100 |
| commit | [c46d6b02588000c27b7b869388c2c0278bd0d173](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c46d6b02588000c27b7b869388c2c0278bd0d173) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c46d6b02588000c27b7b869388c2c0278bd0d173)) | |
| tree | [acd4488419e9981bbd0137c8a68e2db648171c62](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c46d6b02588000c27b7b869388c2c0278bd0d173) | |
| parent | [564caf173b867bdaef37c4f4ee4948bf9e21b41e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=564caf173b867bdaef37c4f4ee4948bf9e21b41e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c46d6b02588000c27b7b869388c2c0278bd0d173&id2=564caf173b867bdaef37c4f4ee4948bf9e21b41e)) | |
| download | [linux-c46d6b02588000c27b7b869388c2c0278bd0d173.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c46d6b02588000c27b7b869388c2c0278bd0d173.tar.gz) | |

ACPI: CPPC: Make rmw\_lock a raw\_spin\_lock[ Upstream commit 1c10941e34c5fdc0357e46a25bd130d9cf40b925 ]
The following BUG was triggered:
=============================
[ BUG: Invalid wait context ]
6.12.0-rc2-XXX #406 Not tainted
-----------------------------
kworker/1:1/62 is trying to lock:
ffffff8801593030 (&cpc\_ptr->rmw\_lock){+.+.}-{3:3}, at: cpc\_write+0xcc/0x370
other info that might help us debug this:
context-{5:5}
2 locks held by kworker/1:1/62:
#0: ffffff897ef5ec98 (&rq->\_\_lock){-.-.}-{2:2}, at: raw\_spin\_rq\_lock\_nested+0x2c/0x50
#1: ffffff880154e238 (&sg\_policy->update\_lock){....}-{2:2}, at: sugov\_update\_shared+0x3c/0x280
stack backtrace:
CPU: 1 UID: 0 PID: 62 Comm: kworker/1:1 Not tainted 6.12.0-rc2-g9654bd3e8806 #406
Workqueue: 0x0 (events)
Call trace:
dump\_backtrace+0xa4/0x130
show\_stack+0x20/0x38
dump\_stack\_lvl+0x90/0xd0
dump\_stack+0x18/0x28
\_\_lock\_acquire+0x480/0x1ad8
lock\_acquire+0x114/0x310
\_raw\_spin\_lock+0x50/0x70
cpc\_write+0xcc/0x370
cppc\_set\_perf+0xa0/0x3a8
cppc\_cpufreq\_fast\_switch+0x40/0xc0
cpufreq\_driver\_fast\_switch+0x4c/0x218
sugov\_update\_shared+0x234/0x280
update\_load\_avg+0x6ec/0x7b8
dequeue\_entities+0x108/0x830
dequeue\_task\_fair+0x58/0x408
\_\_schedule+0x4f0/0x1070
schedule+0x54/0x130
worker\_thread+0xc0/0x2e8
kthread+0x130/0x148
ret\_from\_fork+0x10/0x20
sugov\_update\_shared() locks a raw\_spinlock while cpc\_write() locks a
spinlock.
To have a correct wait-type order, update rmw\_lock to a raw spinlock and
ensure that interrupts will be disabled on the CPU holding it.
Fixes: 60949b7b8054 ("ACPI: CPPC: Fix MASK\_VAL() usage")
Signed-off-by: Pierre Gondois <pierre.gondois@arm.com>
Link: [https://patch.msgid.link/20241028125657.1271512-1-pierre.gondois@arm.com](https://patch.msgid.link/20241028125657.1271512-1-pierre.gondois%40arm.com)
[ rjw: Changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c46d6b02588000c27b7b869388c2c0278bd0d173)

| -rw-r--r-- | [drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/cppc_acpi.c?id=c46d6b02588000c27b7b869388c2c0278bd0d173) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/acpi/cppc_acpi.h?id=c46d6b02588000c27b7b869388c2c0278bd0d173) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 5 deletions

| diff --git a/drivers/acpi/cppc\_acpi.c b/drivers/acpi/cppc\_acpi.cindex 8d14e6c7053571..0e9ccedb08dab2 100644--- a/[drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/cppc_acpi.c?id=564caf173b867bdaef37c4f4ee4948bf9e21b41e)+++ b/[drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/cppc_acpi.c?id=c46d6b02588000c27b7b869388c2c0278bd0d173)@@ -813,7 +813,7 @@ int acpi\_cppc\_processor\_probe(struct acpi\_processor \*pr)  /\* Store CPU Logical ID \*/ cpc\_ptr->cpu\_id = pr->id;- spin\_lock\_init(&cpc\_ptr->rmw\_lock);+ raw\_spin\_lock\_init(&cpc\_ptr->rmw\_lock);  /\* Parse PSD data for this CPU \*/ ret = acpi\_get\_psd(cpc\_ptr, handle);@@ -1020,6 +1020,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) int pcc\_ss\_id = per\_cpu(cpu\_pcc\_subspace\_idx, cpu); struct cpc\_reg \*reg = &reg\_res->cpc\_entry.reg; struct cpc\_desc \*cpc\_desc;+ unsigned long flags;  size = GET\_BIT\_WIDTH(reg); @@ -1047,7 +1048,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) return -ENODEV; } - spin\_lock(&cpc\_desc->rmw\_lock);+ raw\_spin\_lock\_irqsave(&cpc\_desc->rmw\_lock, flags); switch (size) { case 8: prev\_val = readb\_relaxed(vaddr);@@ -1062,7 +1063,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) prev\_val = readq\_relaxed(vaddr); break; default:- spin\_unlock(&cpc\_desc->rmw\_lock);+ raw\_spin\_unlock\_irqrestore(&cpc\_desc->rmw\_lock, flags); return -EFAULT; } val = MASK\_VAL\_WRITE(reg, prev\_val, val);@@ -1095,7 +1096,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) }  if (reg->space\_id == ACPI\_ADR\_SPACE\_SYSTEM\_MEMORY)- spin\_unlock(&cpc\_desc->rmw\_lock);+ raw\_spin\_unlock\_irqrestore(&cpc\_desc->rmw\_lock, flags);  return ret\_val; }diff --git a/include/acpi/cppc\_acpi.h b/include/acpi/cppc\_acpi.hindex 0fed87e2a8959f..28179bb794b2f7 100644--- a/[include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/acpi/cppc_acpi.h?id=564caf173b867bdaef37c4f4ee4948bf9e21b41e)+++ b/[include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/acpi/cppc_acpi.h?id=c46d6b02588000c27b7b869388c2c0278bd0d173)@@ -65,7 +65,7 @@ struct cpc\_desc { int write\_cmd\_status; int write\_cmd\_id; /\* Lock used for RMW operations in cpc\_write() \*/- spinlock\_t rmw\_lock;+ raw\_spinlock\_t rmw\_lock; struct cpc\_register\_resource cpc\_regs[MAX\_CPC\_REG\_ENT]; struct acpi\_psd\_package domain\_info; struct kobject kobj; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:09 +0000



=== Content from git.kernel.org_96f7ce22_20250115_092231.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pierre Gondois <pierre.gondois@arm.com> | 2024-10-28 13:56:56 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:30:49 +0100 |
| commit | [43b1df48d1e7000a214acd1a81b8012ca8a929c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8)) | |
| tree | [70b41281138df1a7e71f3e99457fc7fcdc4d7ae4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8) | |
| parent | [8e134e7ff818964df5c5dc615ac12871ea4b6e2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e134e7ff818964df5c5dc615ac12871ea4b6e2f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8&id2=8e134e7ff818964df5c5dc615ac12871ea4b6e2f)) | |
| download | [linux-43b1df48d1e7000a214acd1a81b8012ca8a929c8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-43b1df48d1e7000a214acd1a81b8012ca8a929c8.tar.gz) | |

ACPI: CPPC: Make rmw\_lock a raw\_spin\_lock[ Upstream commit 1c10941e34c5fdc0357e46a25bd130d9cf40b925 ]
The following BUG was triggered:
=============================
[ BUG: Invalid wait context ]
6.12.0-rc2-XXX #406 Not tainted
-----------------------------
kworker/1:1/62 is trying to lock:
ffffff8801593030 (&cpc\_ptr->rmw\_lock){+.+.}-{3:3}, at: cpc\_write+0xcc/0x370
other info that might help us debug this:
context-{5:5}
2 locks held by kworker/1:1/62:
#0: ffffff897ef5ec98 (&rq->\_\_lock){-.-.}-{2:2}, at: raw\_spin\_rq\_lock\_nested+0x2c/0x50
#1: ffffff880154e238 (&sg\_policy->update\_lock){....}-{2:2}, at: sugov\_update\_shared+0x3c/0x280
stack backtrace:
CPU: 1 UID: 0 PID: 62 Comm: kworker/1:1 Not tainted 6.12.0-rc2-g9654bd3e8806 #406
Workqueue: 0x0 (events)
Call trace:
dump\_backtrace+0xa4/0x130
show\_stack+0x20/0x38
dump\_stack\_lvl+0x90/0xd0
dump\_stack+0x18/0x28
\_\_lock\_acquire+0x480/0x1ad8
lock\_acquire+0x114/0x310
\_raw\_spin\_lock+0x50/0x70
cpc\_write+0xcc/0x370
cppc\_set\_perf+0xa0/0x3a8
cppc\_cpufreq\_fast\_switch+0x40/0xc0
cpufreq\_driver\_fast\_switch+0x4c/0x218
sugov\_update\_shared+0x234/0x280
update\_load\_avg+0x6ec/0x7b8
dequeue\_entities+0x108/0x830
dequeue\_task\_fair+0x58/0x408
\_\_schedule+0x4f0/0x1070
schedule+0x54/0x130
worker\_thread+0xc0/0x2e8
kthread+0x130/0x148
ret\_from\_fork+0x10/0x20
sugov\_update\_shared() locks a raw\_spinlock while cpc\_write() locks a
spinlock.
To have a correct wait-type order, update rmw\_lock to a raw spinlock and
ensure that interrupts will be disabled on the CPU holding it.
Fixes: 60949b7b8054 ("ACPI: CPPC: Fix MASK\_VAL() usage")
Signed-off-by: Pierre Gondois <pierre.gondois@arm.com>
Link: [https://patch.msgid.link/20241028125657.1271512-1-pierre.gondois@arm.com](https://patch.msgid.link/20241028125657.1271512-1-pierre.gondois%40arm.com)
[ rjw: Changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8)

| -rw-r--r-- | [drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/cppc_acpi.c?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/acpi/cppc_acpi.h?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 5 deletions

| diff --git a/drivers/acpi/cppc\_acpi.c b/drivers/acpi/cppc\_acpi.cindex ed91dfd4fdca7e..544f53ae9cc0c3 100644--- a/[drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/cppc_acpi.c?id=8e134e7ff818964df5c5dc615ac12871ea4b6e2f)+++ b/[drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/cppc_acpi.c?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8)@@ -867,7 +867,7 @@ int acpi\_cppc\_processor\_probe(struct acpi\_processor \*pr)  /\* Store CPU Logical ID \*/ cpc\_ptr->cpu\_id = pr->id;- spin\_lock\_init(&cpc\_ptr->rmw\_lock);+ raw\_spin\_lock\_init(&cpc\_ptr->rmw\_lock);  /\* Parse PSD data for this CPU \*/ ret = acpi\_get\_psd(cpc\_ptr, handle);@@ -1087,6 +1087,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) int pcc\_ss\_id = per\_cpu(cpu\_pcc\_subspace\_idx, cpu); struct cpc\_reg \*reg = &reg\_res->cpc\_entry.reg; struct cpc\_desc \*cpc\_desc;+ unsigned long flags;  size = GET\_BIT\_WIDTH(reg); @@ -1126,7 +1127,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) return -ENODEV; } - spin\_lock(&cpc\_desc->rmw\_lock);+ raw\_spin\_lock\_irqsave(&cpc\_desc->rmw\_lock, flags); switch (size) { case 8: prev\_val = readb\_relaxed(vaddr);@@ -1141,7 +1142,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) prev\_val = readq\_relaxed(vaddr); break; default:- spin\_unlock(&cpc\_desc->rmw\_lock);+ raw\_spin\_unlock\_irqrestore(&cpc\_desc->rmw\_lock, flags); return -EFAULT; } val = MASK\_VAL\_WRITE(reg, prev\_val, val);@@ -1174,7 +1175,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) }  if (reg->space\_id == ACPI\_ADR\_SPACE\_SYSTEM\_MEMORY)- spin\_unlock(&cpc\_desc->rmw\_lock);+ raw\_spin\_unlock\_irqrestore(&cpc\_desc->rmw\_lock, flags);  return ret\_val; }diff --git a/include/acpi/cppc\_acpi.h b/include/acpi/cppc\_acpi.hindex e1720d93066695..a451ca4c207bbe 100644--- a/[include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/acpi/cppc_acpi.h?id=8e134e7ff818964df5c5dc615ac12871ea4b6e2f)+++ b/[include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/acpi/cppc_acpi.h?id=43b1df48d1e7000a214acd1a81b8012ca8a929c8)@@ -65,7 +65,7 @@ struct cpc\_desc { int write\_cmd\_status; int write\_cmd\_id; /\* Lock used for RMW operations in cpc\_write() \*/- spinlock\_t rmw\_lock;+ raw\_spinlock\_t rmw\_lock; struct cpc\_register\_resource cpc\_regs[MAX\_CPC\_REG\_ENT]; struct acpi\_psd\_package domain\_info; struct kobject kobj; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:08 +0000



=== Content from git.kernel.org_1f88f31a_20250115_092230.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=23039b4aaf1e82e0feea1060834d4ec34262e453)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23039b4aaf1e82e0feea1060834d4ec34262e453)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23039b4aaf1e82e0feea1060834d4ec34262e453)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23039b4aaf1e82e0feea1060834d4ec34262e453)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pierre Gondois <pierre.gondois@arm.com> | 2024-10-28 13:56:56 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:26:43 +0100 |
| commit | [23039b4aaf1e82e0feea1060834d4ec34262e453](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23039b4aaf1e82e0feea1060834d4ec34262e453) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=23039b4aaf1e82e0feea1060834d4ec34262e453)) | |
| tree | [521dcde7917af07811975be084eae41413020ae1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23039b4aaf1e82e0feea1060834d4ec34262e453) | |
| parent | [bc795bc1aa24d84d4b0a4549459f6ecf7838ec02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc795bc1aa24d84d4b0a4549459f6ecf7838ec02) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23039b4aaf1e82e0feea1060834d4ec34262e453&id2=bc795bc1aa24d84d4b0a4549459f6ecf7838ec02)) | |
| download | [linux-23039b4aaf1e82e0feea1060834d4ec34262e453.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-23039b4aaf1e82e0feea1060834d4ec34262e453.tar.gz) | |

ACPI: CPPC: Make rmw\_lock a raw\_spin\_lock[ Upstream commit 1c10941e34c5fdc0357e46a25bd130d9cf40b925 ]
The following BUG was triggered:
=============================
[ BUG: Invalid wait context ]
6.12.0-rc2-XXX #406 Not tainted
-----------------------------
kworker/1:1/62 is trying to lock:
ffffff8801593030 (&cpc\_ptr->rmw\_lock){+.+.}-{3:3}, at: cpc\_write+0xcc/0x370
other info that might help us debug this:
context-{5:5}
2 locks held by kworker/1:1/62:
#0: ffffff897ef5ec98 (&rq->\_\_lock){-.-.}-{2:2}, at: raw\_spin\_rq\_lock\_nested+0x2c/0x50
#1: ffffff880154e238 (&sg\_policy->update\_lock){....}-{2:2}, at: sugov\_update\_shared+0x3c/0x280
stack backtrace:
CPU: 1 UID: 0 PID: 62 Comm: kworker/1:1 Not tainted 6.12.0-rc2-g9654bd3e8806 #406
Workqueue: 0x0 (events)
Call trace:
dump\_backtrace+0xa4/0x130
show\_stack+0x20/0x38
dump\_stack\_lvl+0x90/0xd0
dump\_stack+0x18/0x28
\_\_lock\_acquire+0x480/0x1ad8
lock\_acquire+0x114/0x310
\_raw\_spin\_lock+0x50/0x70
cpc\_write+0xcc/0x370
cppc\_set\_perf+0xa0/0x3a8
cppc\_cpufreq\_fast\_switch+0x40/0xc0
cpufreq\_driver\_fast\_switch+0x4c/0x218
sugov\_update\_shared+0x234/0x280
update\_load\_avg+0x6ec/0x7b8
dequeue\_entities+0x108/0x830
dequeue\_task\_fair+0x58/0x408
\_\_schedule+0x4f0/0x1070
schedule+0x54/0x130
worker\_thread+0xc0/0x2e8
kthread+0x130/0x148
ret\_from\_fork+0x10/0x20
sugov\_update\_shared() locks a raw\_spinlock while cpc\_write() locks a
spinlock.
To have a correct wait-type order, update rmw\_lock to a raw spinlock and
ensure that interrupts will be disabled on the CPU holding it.
Fixes: 60949b7b8054 ("ACPI: CPPC: Fix MASK\_VAL() usage")
Signed-off-by: Pierre Gondois <pierre.gondois@arm.com>
Link: [https://patch.msgid.link/20241028125657.1271512-1-pierre.gondois@arm.com](https://patch.msgid.link/20241028125657.1271512-1-pierre.gondois%40arm.com)
[ rjw: Changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23039b4aaf1e82e0feea1060834d4ec34262e453)

| -rw-r--r-- | [drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/cppc_acpi.c?id=23039b4aaf1e82e0feea1060834d4ec34262e453) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/acpi/cppc_acpi.h?id=23039b4aaf1e82e0feea1060834d4ec34262e453) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 5 deletions

| diff --git a/drivers/acpi/cppc\_acpi.c b/drivers/acpi/cppc\_acpi.cindex 3d9326172af497..31ea76b6fa0459 100644--- a/[drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/cppc_acpi.c?id=bc795bc1aa24d84d4b0a4549459f6ecf7838ec02)+++ b/[drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/cppc_acpi.c?id=23039b4aaf1e82e0feea1060834d4ec34262e453)@@ -857,7 +857,7 @@ int acpi\_cppc\_processor\_probe(struct acpi\_processor \*pr)  /\* Store CPU Logical ID \*/ cpc\_ptr->cpu\_id = pr->id;- spin\_lock\_init(&cpc\_ptr->rmw\_lock);+ raw\_spin\_lock\_init(&cpc\_ptr->rmw\_lock);  /\* Parse PSD data for this CPU \*/ ret = acpi\_get\_psd(cpc\_ptr, handle);@@ -1077,6 +1077,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) int pcc\_ss\_id = per\_cpu(cpu\_pcc\_subspace\_idx, cpu); struct cpc\_reg \*reg = &reg\_res->cpc\_entry.reg; struct cpc\_desc \*cpc\_desc;+ unsigned long flags;  size = GET\_BIT\_WIDTH(reg); @@ -1116,7 +1117,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) return -ENODEV; } - spin\_lock(&cpc\_desc->rmw\_lock);+ raw\_spin\_lock\_irqsave(&cpc\_desc->rmw\_lock, flags); switch (size) { case 8: prev\_val = readb\_relaxed(vaddr);@@ -1131,7 +1132,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) prev\_val = readq\_relaxed(vaddr); break; default:- spin\_unlock(&cpc\_desc->rmw\_lock);+ raw\_spin\_unlock\_irqrestore(&cpc\_desc->rmw\_lock, flags); return -EFAULT; } val = MASK\_VAL\_WRITE(reg, prev\_val, val);@@ -1164,7 +1165,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) }  if (reg->space\_id == ACPI\_ADR\_SPACE\_SYSTEM\_MEMORY)- spin\_unlock(&cpc\_desc->rmw\_lock);+ raw\_spin\_unlock\_irqrestore(&cpc\_desc->rmw\_lock, flags);  return ret\_val; }diff --git a/include/acpi/cppc\_acpi.h b/include/acpi/cppc\_acpi.hindex 2d1ec0e6ee0188..de3bda334abfc1 100644--- a/[include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/acpi/cppc_acpi.h?id=bc795bc1aa24d84d4b0a4549459f6ecf7838ec02)+++ b/[include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/acpi/cppc_acpi.h?id=23039b4aaf1e82e0feea1060834d4ec34262e453)@@ -65,7 +65,7 @@ struct cpc\_desc { int write\_cmd\_status; int write\_cmd\_id; /\* Lock used for RMW operations in cpc\_write() \*/- spinlock\_t rmw\_lock;+ raw\_spinlock\_t rmw\_lock; struct cpc\_register\_resource cpc\_regs[MAX\_CPC\_REG\_ENT]; struct acpi\_psd\_package domain\_info; struct kobject kobj; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:07 +0000



=== Content from git.kernel.org_7cd4dfd4_20250115_092229.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pierre Gondois <pierre.gondois@arm.com> | 2024-10-28 13:56:56 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:28:20 +0100 |
| commit | [0eb2b767c42fac61ab23c4063eb456baa4c2c262](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262)) | |
| tree | [38543ee94e6336068dc956823e0e42046534312a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262) | |
| parent | [790dc90b96481c95f320bcb3e32950e1117a3da2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=790dc90b96481c95f320bcb3e32950e1117a3da2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262&id2=790dc90b96481c95f320bcb3e32950e1117a3da2)) | |
| download | [linux-0eb2b767c42fac61ab23c4063eb456baa4c2c262.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0eb2b767c42fac61ab23c4063eb456baa4c2c262.tar.gz) | |

ACPI: CPPC: Make rmw\_lock a raw\_spin\_lock[ Upstream commit 1c10941e34c5fdc0357e46a25bd130d9cf40b925 ]
The following BUG was triggered:
=============================
[ BUG: Invalid wait context ]
6.12.0-rc2-XXX #406 Not tainted
-----------------------------
kworker/1:1/62 is trying to lock:
ffffff8801593030 (&cpc\_ptr->rmw\_lock){+.+.}-{3:3}, at: cpc\_write+0xcc/0x370
other info that might help us debug this:
context-{5:5}
2 locks held by kworker/1:1/62:
#0: ffffff897ef5ec98 (&rq->\_\_lock){-.-.}-{2:2}, at: raw\_spin\_rq\_lock\_nested+0x2c/0x50
#1: ffffff880154e238 (&sg\_policy->update\_lock){....}-{2:2}, at: sugov\_update\_shared+0x3c/0x280
stack backtrace:
CPU: 1 UID: 0 PID: 62 Comm: kworker/1:1 Not tainted 6.12.0-rc2-g9654bd3e8806 #406
Workqueue: 0x0 (events)
Call trace:
dump\_backtrace+0xa4/0x130
show\_stack+0x20/0x38
dump\_stack\_lvl+0x90/0xd0
dump\_stack+0x18/0x28
\_\_lock\_acquire+0x480/0x1ad8
lock\_acquire+0x114/0x310
\_raw\_spin\_lock+0x50/0x70
cpc\_write+0xcc/0x370
cppc\_set\_perf+0xa0/0x3a8
cppc\_cpufreq\_fast\_switch+0x40/0xc0
cpufreq\_driver\_fast\_switch+0x4c/0x218
sugov\_update\_shared+0x234/0x280
update\_load\_avg+0x6ec/0x7b8
dequeue\_entities+0x108/0x830
dequeue\_task\_fair+0x58/0x408
\_\_schedule+0x4f0/0x1070
schedule+0x54/0x130
worker\_thread+0xc0/0x2e8
kthread+0x130/0x148
ret\_from\_fork+0x10/0x20
sugov\_update\_shared() locks a raw\_spinlock while cpc\_write() locks a
spinlock.
To have a correct wait-type order, update rmw\_lock to a raw spinlock and
ensure that interrupts will be disabled on the CPU holding it.
Fixes: 60949b7b8054 ("ACPI: CPPC: Fix MASK\_VAL() usage")
Signed-off-by: Pierre Gondois <pierre.gondois@arm.com>
Link: [https://patch.msgid.link/20241028125657.1271512-1-pierre.gondois@arm.com](https://patch.msgid.link/20241028125657.1271512-1-pierre.gondois%40arm.com)
[ rjw: Changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262)

| -rw-r--r-- | [drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/cppc_acpi.c?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/acpi/cppc_acpi.h?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 5 deletions

| diff --git a/drivers/acpi/cppc\_acpi.c b/drivers/acpi/cppc\_acpi.cindex 5df417626fd109..26d1beec99137e 100644--- a/[drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/cppc_acpi.c?id=790dc90b96481c95f320bcb3e32950e1117a3da2)+++ b/[drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/cppc_acpi.c?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262)@@ -863,7 +863,7 @@ int acpi\_cppc\_processor\_probe(struct acpi\_processor \*pr)  /\* Store CPU Logical ID \*/ cpc\_ptr->cpu\_id = pr->id;- spin\_lock\_init(&cpc\_ptr->rmw\_lock);+ raw\_spin\_lock\_init(&cpc\_ptr->rmw\_lock);  /\* Parse PSD data for this CPU \*/ ret = acpi\_get\_psd(cpc\_ptr, handle);@@ -1083,6 +1083,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) int pcc\_ss\_id = per\_cpu(cpu\_pcc\_subspace\_idx, cpu); struct cpc\_reg \*reg = &reg\_res->cpc\_entry.reg; struct cpc\_desc \*cpc\_desc;+ unsigned long flags;  size = GET\_BIT\_WIDTH(reg); @@ -1122,7 +1123,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) return -ENODEV; } - spin\_lock(&cpc\_desc->rmw\_lock);+ raw\_spin\_lock\_irqsave(&cpc\_desc->rmw\_lock, flags); switch (size) { case 8: prev\_val = readb\_relaxed(vaddr);@@ -1137,7 +1138,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) prev\_val = readq\_relaxed(vaddr); break; default:- spin\_unlock(&cpc\_desc->rmw\_lock);+ raw\_spin\_unlock\_irqrestore(&cpc\_desc->rmw\_lock, flags); return -EFAULT; } val = MASK\_VAL\_WRITE(reg, prev\_val, val);@@ -1170,7 +1171,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) }  if (reg->space\_id == ACPI\_ADR\_SPACE\_SYSTEM\_MEMORY)- spin\_unlock(&cpc\_desc->rmw\_lock);+ raw\_spin\_unlock\_irqrestore(&cpc\_desc->rmw\_lock, flags);  return ret\_val; }diff --git a/include/acpi/cppc\_acpi.h b/include/acpi/cppc\_acpi.hindex e1720d93066695..a451ca4c207bbe 100644--- a/[include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/acpi/cppc_acpi.h?id=790dc90b96481c95f320bcb3e32950e1117a3da2)+++ b/[include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/acpi/cppc_acpi.h?id=0eb2b767c42fac61ab23c4063eb456baa4c2c262)@@ -65,7 +65,7 @@ struct cpc\_desc { int write\_cmd\_status; int write\_cmd\_id; /\* Lock used for RMW operations in cpc\_write() \*/- spinlock\_t rmw\_lock;+ raw\_spinlock\_t rmw\_lock; struct cpc\_register\_resource cpc\_regs[MAX\_CPC\_REG\_ENT]; struct acpi\_psd\_package domain\_info; struct kobject kobj; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:06 +0000



=== Content from git.kernel.org_c51b72ce_20250115_092230.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pierre Gondois <pierre.gondois@arm.com> | 2024-10-28 13:56:56 +0100 |
| --- | --- | --- |
| committer | Rafael J. Wysocki <rafael.j.wysocki@intel.com> | 2024-10-29 12:56:19 +0100 |
| commit | [1c10941e34c5fdc0357e46a25bd130d9cf40b925](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925)) | |
| tree | [3aff2fae586d032bf9b95ae7c0396df5ea70587c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925) | |
| parent | [81983758430957d9a5cb3333fe324fd70cf63e7e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81983758430957d9a5cb3333fe324fd70cf63e7e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925&id2=81983758430957d9a5cb3333fe324fd70cf63e7e)) | |
| download | [linux-1c10941e34c5fdc0357e46a25bd130d9cf40b925.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c10941e34c5fdc0357e46a25bd130d9cf40b925.tar.gz) | |

ACPI: CPPC: Make rmw\_lock a raw\_spin\_lockThe following BUG was triggered:
=============================
[ BUG: Invalid wait context ]
6.12.0-rc2-XXX #406 Not tainted
-----------------------------
kworker/1:1/62 is trying to lock:
ffffff8801593030 (&cpc\_ptr->rmw\_lock){+.+.}-{3:3}, at: cpc\_write+0xcc/0x370
other info that might help us debug this:
context-{5:5}
2 locks held by kworker/1:1/62:
#0: ffffff897ef5ec98 (&rq->\_\_lock){-.-.}-{2:2}, at: raw\_spin\_rq\_lock\_nested+0x2c/0x50
#1: ffffff880154e238 (&sg\_policy->update\_lock){....}-{2:2}, at: sugov\_update\_shared+0x3c/0x280
stack backtrace:
CPU: 1 UID: 0 PID: 62 Comm: kworker/1:1 Not tainted 6.12.0-rc2-g9654bd3e8806 #406
Workqueue: 0x0 (events)
Call trace:
dump\_backtrace+0xa4/0x130
show\_stack+0x20/0x38
dump\_stack\_lvl+0x90/0xd0
dump\_stack+0x18/0x28
\_\_lock\_acquire+0x480/0x1ad8
lock\_acquire+0x114/0x310
\_raw\_spin\_lock+0x50/0x70
cpc\_write+0xcc/0x370
cppc\_set\_perf+0xa0/0x3a8
cppc\_cpufreq\_fast\_switch+0x40/0xc0
cpufreq\_driver\_fast\_switch+0x4c/0x218
sugov\_update\_shared+0x234/0x280
update\_load\_avg+0x6ec/0x7b8
dequeue\_entities+0x108/0x830
dequeue\_task\_fair+0x58/0x408
\_\_schedule+0x4f0/0x1070
schedule+0x54/0x130
worker\_thread+0xc0/0x2e8
kthread+0x130/0x148
ret\_from\_fork+0x10/0x20
sugov\_update\_shared() locks a raw\_spinlock while cpc\_write() locks a
spinlock.
To have a correct wait-type order, update rmw\_lock to a raw spinlock and
ensure that interrupts will be disabled on the CPU holding it.
Fixes: 60949b7b8054 ("ACPI: CPPC: Fix MASK\_VAL() usage")
Signed-off-by: Pierre Gondois <pierre.gondois@arm.com>
Link: [https://patch.msgid.link/20241028125657.1271512-1-pierre.gondois@arm.com](https://patch.msgid.link/20241028125657.1271512-1-pierre.gondois%40arm.com)
[ rjw: Changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925)

| -rw-r--r-- | [drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/cppc_acpi.c?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/acpi/cppc_acpi.h?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 5 deletions

| diff --git a/drivers/acpi/cppc\_acpi.c b/drivers/acpi/cppc\_acpi.cindex c3fc2c05d8687e..1a40f0514eaa36 100644--- a/[drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/cppc_acpi.c?id=81983758430957d9a5cb3333fe324fd70cf63e7e)+++ b/[drivers/acpi/cppc\_acpi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/cppc_acpi.c?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925)@@ -867,7 +867,7 @@ int acpi\_cppc\_processor\_probe(struct acpi\_processor \*pr)  /\* Store CPU Logical ID \*/ cpc\_ptr->cpu\_id = pr->id;- spin\_lock\_init(&cpc\_ptr->rmw\_lock);+ raw\_spin\_lock\_init(&cpc\_ptr->rmw\_lock);  /\* Parse PSD data for this CPU \*/ ret = acpi\_get\_psd(cpc\_ptr, handle);@@ -1087,6 +1087,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) int pcc\_ss\_id = per\_cpu(cpu\_pcc\_subspace\_idx, cpu); struct cpc\_reg \*reg = &reg\_res->cpc\_entry.reg; struct cpc\_desc \*cpc\_desc;+ unsigned long flags;  size = GET\_BIT\_WIDTH(reg); @@ -1126,7 +1127,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) return -ENODEV; } - spin\_lock(&cpc\_desc->rmw\_lock);+ raw\_spin\_lock\_irqsave(&cpc\_desc->rmw\_lock, flags); switch (size) { case 8: prev\_val = readb\_relaxed(vaddr);@@ -1141,7 +1142,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) prev\_val = readq\_relaxed(vaddr); break; default:- spin\_unlock(&cpc\_desc->rmw\_lock);+ raw\_spin\_unlock\_irqrestore(&cpc\_desc->rmw\_lock, flags); return -EFAULT; } val = MASK\_VAL\_WRITE(reg, prev\_val, val);@@ -1174,7 +1175,7 @@ static int cpc\_write(int cpu, struct cpc\_register\_resource \*reg\_res, u64 val) }  if (reg->space\_id == ACPI\_ADR\_SPACE\_SYSTEM\_MEMORY)- spin\_unlock(&cpc\_desc->rmw\_lock);+ raw\_spin\_unlock\_irqrestore(&cpc\_desc->rmw\_lock, flags);  return ret\_val; }diff --git a/include/acpi/cppc\_acpi.h b/include/acpi/cppc\_acpi.hindex 76e44e102780e4..62d368bcd9eca5 100644--- a/[include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/acpi/cppc_acpi.h?id=81983758430957d9a5cb3333fe324fd70cf63e7e)+++ b/[include/acpi/cppc\_acpi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/acpi/cppc_acpi.h?id=1c10941e34c5fdc0357e46a25bd130d9cf40b925)@@ -65,7 +65,7 @@ struct cpc\_desc { int write\_cmd\_status; int write\_cmd\_id; /\* Lock used for RMW operations in cpc\_write() \*/- spinlock\_t rmw\_lock;+ raw\_spinlock\_t rmw\_lock; struct cpc\_register\_resource cpc\_regs[MAX\_CPC\_REG\_ENT]; struct acpi\_psd\_package domain\_info; struct kobject kobj; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:21:07 +0000


